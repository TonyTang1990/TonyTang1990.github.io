
 <!DOCTYPE HTML>
<html >
<head>
  <meta charset="UTF-8">
  
    <title>Data-Config-Automation | 走停人生路</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="Tony Tang">
    

    
    <meta name="description" content="Introduction游戏开发过程中，避免不了和数据打交道，数据是游戏最基础也是很重要的一部分。本篇文章正式为了学习了解游戏开发过程中关于数据配置自动化导表生成代码等一系列自动化相关的知识而写。
Data ConfigWhat数据配置 — 策划通过类似Excel或者其他方式配置出游戏里需要的数据，程序通过读取这些数据让游戏根据数据驱动运行起来，这正是我们所谓的数据配置。
Why那么为什么需要数据">
<meta property="og:type" content="article">
<meta property="og:title" content="Data-Config-Automation">
<meta property="og:url" content="http://tonytang1990.github.io/2018/03/18/Data-Config-Automation/index.html">
<meta property="og:site_name" content="走停人生路">
<meta property="og:description" content="Introduction游戏开发过程中，避免不了和数据打交道，数据是游戏最基础也是很重要的一部分。本篇文章正式为了学习了解游戏开发过程中关于数据配置自动化导表生成代码等一系列自动化相关的知识而写。
Data ConfigWhat数据配置 — 策划通过类似Excel或者其他方式配置出游戏里需要的数据，程序通过读取这些数据让游戏根据数据驱动运行起来，这正是我们所谓的数据配置。
Why那么为什么需要数据">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/ExcelDataConfig.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/DataConfigScriptDll.dll">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/DataConfigData.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/DataConfigResult.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/CustomSerializationPerformance.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/DefaultSerializationPerformance.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/ProtocolBufferMessageValueType.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/ProtobufSerializerSerialize.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/ProtobufSerializerWrite.PNG">
<meta property="og:updated_time" content="2018-04-29T02:57:43.930Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Data-Config-Automation">
<meta name="twitter:description" content="Introduction游戏开发过程中，避免不了和数据打交道，数据是游戏最基础也是很重要的一部分。本篇文章正式为了学习了解游戏开发过程中关于数据配置自动化导表生成代码等一系列自动化相关的知识而写。
Data ConfigWhat数据配置 — 策划通过类似Excel或者其他方式配置出游戏里需要的数据，程序通过读取这些数据让游戏根据数据驱动运行起来，这正是我们所谓的数据配置。
Why那么为什么需要数据">

    
    <link rel="alternative" href="/atom.xml" title="走停人生路" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/jacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/jacman.jpg">
    
    <link rel="stylesheet" href="/css/style.css" type="text/css">
</head>

  <body>
    <header>
      
<div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.jpg" alt="走停人生路" title="走停人生路"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="走停人生路">走停人生路</a></h1>
				<h2 class="blog-motto">有时候不是习惯了一个人，而是在没有认可自己之前选择了一个人</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜單">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">Home</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
						<li><a href="/about">About</a></li>
					
					<li>
 					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="search" id="search" name="q" autocomplete="off" maxlength="20" placeholder="搜索" />
						<input type="hidden" name="q" value="site:tonytang1990.github.io">
					</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
  
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2018/03/18/Data-Config-Automation/" title="Data-Config-Automation" itemprop="url">Data-Config-Automation</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Tony Tang" target="_blank" itemprop="author">Tony Tang</a>
		
  <p class="article-time">
    <time datetime="2018-03-18T04:30:52.000Z" itemprop="datePublished"> 發表於 2018-03-18</time>
    
  </p>
</header>
	<div class="article-content">
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">文章目錄</strong>
		
			<ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Introduction"><span class="toc-number">1.</span> <span class="toc-text">Introduction</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Data_Config"><span class="toc-number">2.</span> <span class="toc-text">Data Config</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#What"><span class="toc-number">2.1.</span> <span class="toc-text">What</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Why"><span class="toc-number">2.2.</span> <span class="toc-text">Why</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#How"><span class="toc-number">2.3.</span> <span class="toc-text">How</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Functional_Requirement(功能需求)"><span class="toc-number">2.3.1.</span> <span class="toc-text">Functional Requirement(功能需求)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#原理思考"><span class="toc-number">2.3.2.</span> <span class="toc-text">原理思考</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#方案选择"><span class="toc-number">2.3.3.</span> <span class="toc-text">方案选择</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#C#_-Net_BinaryFormatter"><span class="toc-number">2.3.3.1.</span> <span class="toc-text">C# .Net BinaryFormatter</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#问题"><span class="toc-number">2.3.3.1.1.</span> <span class="toc-text">问题</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ProtoBuff"><span class="toc-number">2.3.3.2.</span> <span class="toc-text">ProtoBuff</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#ProtoBuff学习了解"><span class="toc-number">2.3.3.2.1.</span> <span class="toc-text">ProtoBuff学习了解</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#ProtoBuff导表工具"><span class="toc-number">2.3.3.2.2.</span> <span class="toc-text">ProtoBuff导表工具</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#FlatBuff"><span class="toc-number">2.3.3.3.</span> <span class="toc-text">FlatBuff</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#方案比较"><span class="toc-number">2.3.4.</span> <span class="toc-text">方案比较</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#实战"><span class="toc-number">2.4.</span> <span class="toc-text">实战</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#总结"><span class="toc-number">2.5.</span> <span class="toc-text">总结</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Reference"><span class="toc-number">3.</span> <span class="toc-text">Reference</span></a></li></ol>
		
		</div>
		
		<h1 id="Introduction">Introduction</h1><p>游戏开发过程中，避免不了和数据打交道，数据是游戏最基础也是很重要的一部分。本篇文章正式为了学习了解游戏开发过程中关于数据配置自动化导表生成代码等一系列自动化相关的知识而写。</p>
<h1 id="Data_Config">Data Config</h1><h2 id="What">What</h2><p>数据配置 — 策划通过类似Excel或者其他方式配置出游戏里需要的数据，程序通过读取这些数据让游戏根据数据驱动运行起来，这正是我们所谓的数据配置。</p>
<h2 id="Why">Why</h2><p>那么为什么需要数据配置了？</p>
<ol>
<li>数据是游戏最基本的单位 — 无论是炫酷的特效还是惊人的AI都是通过读取底层数据最终得出结论的。</li>
<li>协同工作 — 这里说的数据配置更多的是游戏逻辑层的数据，即类似游戏里的对话显示，背包单位格子数量上限等配置。有了数据配置，程序和策划很容易协同工作，程序负责数据读取实现功能，策划负责具体的数据配置实现想要的效果。</li>
<li>多语言显示 — 数据配置用于语言包显示也帮助我们很方便的实现多语言的版本(读取不同语言版本的数据配置即可)。</li>
</ol>
<h2 id="How">How</h2><p>实现数据配置读取原理上是把数据序列化导出保存在本地(.xml, .json .bytes……)，然后通过反序列化读取回来。<br>这里我们不单单是针对个别数据进行序列化反序列化。这里要实现的是一个针对表格配置，可以动态生成支持反序列化读取(非反射机制)读取到程序里的工具。</p>
<p>序列化相关知识学习参考<a href="http://tonytang1990.github.io/2015/08/15/CSharp-Study/#Runtime_Serialization">Runtime Serialization</a><br>PC端Excel读取库选择参考:<a href="http://tonytang1990.github.io/2015/07/15/Unity-Study/#Excel数据读取">Excel数据读取</a></p>
<p>Note:<br>这里注意反射和反序列化不是一回事，反序列化可以用反射也可以不用反射来实现。</p>
<h3 id="Functional_Requirement(功能需求)">Functional Requirement(功能需求)</h3><ol>
<li>支持int，float，string基础数据配置</li>
<li>支持列表数据(多余一个的数据)快速读取(比如配置:1;2;3;4分别代表物体随机的生命值选项)(这个算是<strong>基础需求功能</strong>)</li>
<li>支持列表数据自定义数据结构快速读取(<strong>高阶功能需求</strong>，方便列表数据复杂的时候能够抽象成数据结构快速读取。)<br>实际需求举列:<br>我们配置一个道具不同等级的属性加成数据：1+200|2+300;3+400|4+500|5+600 表示第一级加属性id为1的属性加200并且，属性id为2的加300。第二季加属性id为3,4,5的分别加400,500,600)<br>如果我们不能动态创建自定义结构数据，那么我们就需要在代码里写string.split()这种形式的分割数据去判定读取，不论是从性能开销还是代码编写都是很不划算的。<br>如果我们能自动创建自定义结构，生成如下代码:<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title">Property</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> Id</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">set</span>;        </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> Value</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Property[0].Length : 2</span></span><br><span class="line"><span class="comment">// Proeprty[1].Length : 3</span></span><br><span class="line">Property[<span class="number">2</span>][] mPropertyArray;   <span class="comment">// 存储表格数据的成员</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>那么我们就能方便的编写代码去访问特定等级所加成的属性了：<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//快速访问特定等级所加成的属性值</span></span><br><span class="line">mPropertyArray[<span class="number">1</span>][<span class="number">2</span>]表示第二级所加成的第二个属性数据</span><br></pre></td></tr></table></figure></p>
<p>扩展内嵌多层的话(这样的需求应该很少，这里暂时就不考虑了)，此方案需要扩展多维数组来支持，并不是很友好</p>
<ol>
<li>支持自动生成读表相关代码</li>
<li>内存开销要控制，读取速度要快</li>
<li>跨平台</li>
<li>跨语言</li>
<li>独立于Unity的工具(后期优化部分)</li>
<li>前后端表格数据区分(后期优化部分)(因为前后端往往是读不同的数据，并不需要导同一套表格数据)</li>
</ol>
<h3 id="原理思考">原理思考</h3><p>流程：</p>
<ol>
<li>定义excel表格格式规则(这一步会影响后面所有步骤)</li>
<li>读取excel数据</li>
<li>生成可跨平台跨语言的序列化代码</li>
<li>序列化写入excel数据(这一步涉及跨语言问题)</li>
<li>反序列化读取数据</li>
</ol>
<ul>
<li><p>定义excel表格格式规则<br>这一步要决定我们excel长什么样子，决定不同数据不同的行号字段代表什么。</p>
</li>
<li><p>读取excel数据<br>通过第三方库(比如PC端跨平台的<a href="http://exceldatareader.codeplex.com/" target="_blank" rel="external">ExcelRead</a>)可以解决读取问题。</p>
</li>
<li><p>生成跨平台跨语言的序列化反序列化代码<br>这一步的重点在于跨平台和跨语言。</p>
</li>
</ul>
<p>跨平台这一点肯定不用说，要想在PC端序列化的数据在移动端使用，这一点是必须的也并不是难点。</p>
<p><strong>跨语言</strong>这一点上，试想如果前后端用的语言不同，但前后端想共用一份导表工具来生成需要的表格数据，那么跨语言这一点就是必须的了。</p>
<p>序列化数据和反序列化数据时，我们需要考虑跨语言的问题，后续的方案中就会强调这一点。</p>
<ul>
<li><p>序列化写入excel数据<br>写入数据也就是序列化的过程，解决了前面提到的跨语言生成序列化代码问题后，这个问题也就迎刃而解。</p>
</li>
<li><p>反序列化读取数据<br>读数据就是反序列化的过程，同理序列化，解决了跨语言生成序列化代码的问题，这个问题依然不是问题。</p>
</li>
</ul>
<h3 id="方案选择">方案选择</h3><ol>
<li>C# .Net BinaryFormatter(不夸语言，序列化后数据相对大，反序列化费时且内存开销大)</li>
<li>ProtoBuff(跨语言，序列化数据相对小，反序列化费时和内存开销相对好点。工具成熟，社区完善，自定义数据结构方便)</li>
<li>FlatBuff(跨语言，序列化数据小，反序列化费时少，编写自定义序列化和反序列化数据结构不方便)</li>
</ol>
<h4 id="C#_-Net_BinaryFormatter">C# .Net BinaryFormatter</h4><p>参考这篇文章：<a href="blog.csdn.net/qq_14903317/article/details/78637440">Unity C#配置表工具</a></p>
<p>我们可以看到，我们需要做的事情有以下几步：</p>
<ol>
<li>定义excel表格格式规则</li>
<li>从excel中读取数据</li>
<li>根据数据类型，动态生成每个表的C#类(用于反序列化读取数据)</li>
<li>动态编译C#类，输出一个动态库以及相关代码</li>
<li>实例化C#类，并且把数据填入到实例化对象中，序列化数据，保存在Untiy本地Resources目录中</li>
<li>运行时，通过生成的C#类反序列化加载并创建对应实例化对象去存储数据</li>
</ol>
<p>Utilities.cs<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Diagnostics;</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> System.Runtime.Serialization.Formatters.Binary;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="xmlDocTag">///</span> 工具静态类</span></span><br><span class="line"><span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">Utilities</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> 本机打开特定目录(暂时只用于Windows)</span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="folderPath"&gt;</span><span class="xmlDocTag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">OpenFolder</span>(<span class="params"><span class="keyword">string</span> folderPath</span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (Directory.Exists(folderPath))</span><br><span class="line">        &#123;</span><br><span class="line">            ProcessStartInfo startInfo = <span class="keyword">new</span> ProcessStartInfo(folderPath, <span class="string">"explorer.exe"</span>);</span><br><span class="line">            Process.Start(startInfo);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            UnityEngine.Debug.LogError(<span class="keyword">string</span>.Format(<span class="string">"&#123;0&#125; Directory does not exist!"</span>, folderPath));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> 检查指定目录是否存在，不存在创建一个</span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">checkOrCreateSpecificFolder</span>(<span class="params"><span class="keyword">string</span> folderpath</span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!Directory.Exists(folderpath))</span><br><span class="line">        &#123;</span><br><span class="line">            Directory.CreateDirectory(folderpath);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> 无论目录是否存在都删除所有文件重新创建一个目录</span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">recreateSpecificFolder</span>(<span class="params"><span class="keyword">string</span> folderpath</span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (Directory.Exists(folderpath))</span><br><span class="line">        &#123;</span><br><span class="line">            Directory.Delete(folderpath, <span class="keyword">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        Directory.CreateDirectory(folderpath);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> 获取文件的目录名字</span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="filepath"&gt;</span><span class="xmlDocTag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;returns&gt;</span><span class="xmlDocTag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">string</span> <span class="title">getFileFolderName</span>(<span class="params"><span class="keyword">string</span> filepath</span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Path.GetFileName(Path.GetDirectoryName(filepath));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>PathUtilites.cs<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="xmlDocTag">///</span> 路径静态工具类</span></span><br><span class="line"><span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">PathUtilties</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="preprocessor">#<span class="keyword">region</span> Excel Data</span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> Excel数据文件夹目录路径</span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">string</span> ExcelFileFolderPath = Application.dataPath + <span class="string">"/../ExcelDatas/Game/"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> Excel数据生成的对应代码目录</span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> Note:</span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> 因为序列化反序列化时要求Assemble信息一致，所以如果反序列化使用Unity 编译后的C#无法成功反序列化</span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> BinderToType低版本.Net可以用但BinderToName要求.Net 4.0</span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> 所以这里放弃了直接生成新的cs表代码通过Unity编译使用的方案，选择依然采用直接编译表代码成dll来使用</span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> 表代码依然生成，但放到Asset外部作为非有效代码存储方便查看</span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> 参考:</span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> https://stackoverflow.com/questions/505611/binary-deserialization-with-different-assembly-version</span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> https://www.codeproject.com/Tips/1101106/How-to-serialize-across-assemblies-with-the-Binary</span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">string</span> ExcelScriptOutputFolderPath = Application.dataPath + <span class="string">"/../DataConfigScripts/"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> Excel数据序列化后的文件名</span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">string</span> ExcelDataFileName = <span class="string">"dataconfig.byte"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> Excel数据序列化后的数据文件存储目录</span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">string</span> ExcelDataFileOutputFolderPath = Application.dataPath + <span class="string">"/Resources/DataConfig/"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> Excel数据序列化后的数据文件相对于Resource目录的相对目录</span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">string</span> ExcelDataFileOutputFolderRelativePath = <span class="string">"DataConfig/"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> Excel数据生成的对应Assembly&amp;Script临时文件临时目录</span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">string</span> ExcelScriptAssemblyFilePath = Application.dataPath + <span class="string">"/Scripts/Core/DataConfig/"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> Excel数据生成的对应Assembly临时文件名</span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">string</span> ExcelScriptAssemblyFileName = <span class="string">"dataconfig.dll"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> 表格代码文件后缀</span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">string</span> ExcelScriptFilePostFix = <span class="string">".cs"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> 表格生成数据管理读取代码文件名</span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">string</span> ExcelScriptDataManagerFileName = <span class="string">"DataManager.cs"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> 表代码Container后缀名</span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">string</span> ExcelTableContainerPostfix = <span class="string">"Container"</span>;</span><br><span class="line">    <span class="preprocessor">#<span class="keyword">endregion</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>ExportExcelData.cs<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> UnityEditor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> Excel;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> System.Data;</span><br><span class="line"><span class="keyword">using</span> System.Reflection;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"><span class="keyword">using</span> Microsoft.CSharp;</span><br><span class="line"><span class="keyword">using</span> System.CodeDom.Compiler;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Runtime.Serialization.Formatters.Binary;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="xmlDocTag">///</span> 表格数据抽象</span></span><br><span class="line"><span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ConfigData</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> 数据类型</span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">string</span> Type;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> 字段名字</span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">string</span> Name;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> 数据</span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">string</span> Data;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="xmlDocTag">///</span> 导表工具</span></span><br><span class="line"><span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ExportExcelData</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> 字段名行号</span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">const</span> <span class="keyword">int</span> NameLineNumber = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> 字段类型行号</span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">const</span> <span class="keyword">int</span> TypeLineNumber = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> 数据开始行号</span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">const</span> <span class="keyword">int</span> DataLineNumber = <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> 有效的数据类型</span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> List&lt;<span class="keyword">string</span>&gt; ValideTypesList =  <span class="keyword">new</span> List&lt;<span class="keyword">string</span>&gt;(<span class="keyword">new</span> <span class="keyword">string</span>[]&#123;<span class="string">"int"</span>, <span class="string">"float"</span>, <span class="string">"string"</span>&#125;);</span><br><span class="line"></span><br><span class="line">    [MenuItem(<span class="string">"Tools/DataConfig/导出所有表格数据"</span>, <span class="keyword">false</span>, <span class="number">100</span>)]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">exportAllExcelData</span>(<span class="params"></span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">string</span>[] excelfiles = Directory.GetFiles(PathUtilties.ExcelFileFolderPath, <span class="string">"*.xlsx"</span>);</span><br><span class="line">        <span class="comment">// 表格数据映射Map</span></span><br><span class="line">        <span class="comment">// Key为表格名字</span></span><br><span class="line">        <span class="comment">// Value为表格对应的数据列表，List的每一个元素代表一行的数据数组</span></span><br><span class="line">        Dictionary&lt;<span class="keyword">string</span>, List&lt;ConfigData[]&gt;&gt; datadic = <span class="keyword">new</span> Dictionary&lt;<span class="keyword">string</span>, List&lt;ConfigData[]&gt;&gt;();</span><br><span class="line">        <span class="comment">// 字段信息map</span></span><br><span class="line">        <span class="comment">// Key为表格名字</span></span><br><span class="line">        <span class="comment">// Value为对应表格的字段数据</span></span><br><span class="line">        Dictionary&lt;<span class="keyword">string</span>, <span class="keyword">string</span>[]&gt; namedic = <span class="keyword">new</span> Dictionary&lt;<span class="keyword">string</span>, <span class="keyword">string</span>[]&gt;();</span><br><span class="line">        <span class="comment">// 字段类型信息map</span></span><br><span class="line">        <span class="comment">// Key为表格名字</span></span><br><span class="line">        <span class="comment">// Value为对应表格的字段类型数据</span></span><br><span class="line">        Dictionary&lt;<span class="keyword">string</span>, <span class="keyword">string</span>[]&gt; typedic = <span class="keyword">new</span> Dictionary&lt;<span class="keyword">string</span>, <span class="keyword">string</span>[]&gt;();</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> excelfile <span class="keyword">in</span> excelfiles)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(!readAllDataFromExcelFile(excelfile, <span class="keyword">ref</span> datadic, <span class="keyword">ref</span> typedic, <span class="keyword">ref</span> namedic))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 表格代码映射map</span></span><br><span class="line">        <span class="comment">// Key为类名字，Value为对应代码数据</span></span><br><span class="line">        Dictionary&lt;<span class="keyword">string</span>, <span class="keyword">string</span>&gt; codemap = <span class="keyword">new</span> Dictionary&lt;<span class="keyword">string</span>, <span class="keyword">string</span>&gt;();</span><br><span class="line">        <span class="comment">//根据刚才记录的每一张表格数据生成对应代码数据</span></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> data <span class="keyword">in</span> datadic)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">string</span> classname = data.Key;</span><br><span class="line">            DataConfigScriptGenerator dcsg = <span class="keyword">new</span> DataConfigScriptGenerator(classname, typedic[classname], namedic[classname]);</span><br><span class="line">            codemap.Add(classname, dcsg.generateCode());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//删除前一次所有相关文件</span></span><br><span class="line">        Utilities.recreateSpecificFolder(PathUtilties.ExcelScriptOutputFolderPath);</span><br><span class="line">        Utilities.recreateSpecificFolder(PathUtilties.ExcelDataFileOutputFolderPath);</span><br><span class="line">        Utilities.recreateSpecificFolder(PathUtilties.ExcelScriptAssemblyFilePath);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//生成dll，Assemble文件用于序列化数据</span></span><br><span class="line">        <span class="keyword">string</span>[] scripts = <span class="keyword">new</span> <span class="keyword">string</span>[codemap.Values.Count];</span><br><span class="line">        codemap.Values.CopyTo(scripts, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">var</span> assemblyfilepath = PathUtilties.ExcelScriptAssemblyFilePath + PathUtilties.ExcelScriptAssemblyFileName;</span><br><span class="line">        Assembly assembly = compileCode(scripts, assemblyfilepath);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (assembly == <span class="keyword">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">"编译dll失败！"</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//使用Assemble序列化数据</span></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> data <span class="keyword">in</span> datadic)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">object</span> container = assembly.CreateInstance(data.Key + <span class="string">"Container"</span>);</span><br><span class="line">            Type classtype = assembly.GetType(data.Key);</span><br><span class="line">            <span class="keyword">if</span> (!serialize(container, classtype, data.Value, PathUtilties.ExcelDataFileOutputFolderPath))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 生成对应Manager加载管理的cs代码文件</span></span><br><span class="line">        createDataManager(assembly, PathUtilties.ExcelScriptAssemblyFilePath);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 生成对应cs代码文件(如果删除dll，使用cs编译的Assembly-CSharp.dll会导致反序列化出问题。猜测是因为Assemly名字改变后，默认的序列化和反序列化的部分信息(e.g. 比如assembly name)对不上。)</span></span><br><span class="line">        <span class="comment">// 所以这里生成的代码仅供查看，释放到Asset上层目录的</span></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> code <span class="keyword">in</span> codemap)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">using</span> (FileStream fs = File.Create(PathUtilties.ExcelScriptOutputFolderPath + code.Key + PathUtilties.ExcelScriptFilePostFix))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">byte</span>[] info = <span class="keyword">new</span> UTF8Encoding(<span class="keyword">true</span>).GetBytes(code.Value);</span><br><span class="line">                fs.Write(info, <span class="number">0</span>, info.Length);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//删除Assemble文件</span></span><br><span class="line">        <span class="comment">//File.Delete(assemblyfilepath);</span></span><br><span class="line"></span><br><span class="line">        AssetDatabase.Refresh();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> 读取excel里所有数据</span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="excelfile"&gt;</span>excel文件<span class="xmlDocTag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="datadic"&gt;</span>表格数据<span class="xmlDocTag">&lt;/param&gt;</span>]</span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="names"&gt;</span>字段数据<span class="xmlDocTag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="typs"&gt;</span>类型数据<span class="xmlDocTag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;returns&gt;</span><span class="xmlDocTag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">readAllDataFromExcelFile</span>(<span class="params"><span class="keyword">string</span> excelfile, <span class="keyword">ref</span> Dictionary&lt;<span class="keyword">string</span>, List&lt;ConfigData[]&gt;&gt; datadic, <span class="keyword">ref</span> Dictionary&lt;<span class="keyword">string</span>, <span class="keyword">string</span>[]&gt; typesmap, <span class="keyword">ref</span> Dictionary&lt;<span class="keyword">string</span>, <span class="keyword">string</span>[]&gt; namesmap</span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        Debug.Log(<span class="keyword">string</span>.Format(<span class="string">"excelfile: &#123;0&#125;"</span>, excelfile));</span><br><span class="line">        FileStream fs = File.Open(excelfile, FileMode.Open, FileAccess.Read);</span><br><span class="line">        IExcelDataReader excelreader = ExcelReaderFactory.CreateOpenXmlReader(fs);</span><br><span class="line">        <span class="keyword">if</span> (!excelreader.IsValid)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="keyword">string</span>.Format(<span class="string">"Excel文件:&#123;0&#125;读取失败！"</span>, excelfile));</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            Debug.Log(<span class="keyword">string</span>.Format(<span class="string">"Excel文件.Name:&#123;0&#125;"</span>, excelreader.Name));</span><br><span class="line">            <span class="keyword">var</span> dataset = excelreader.AsDataSet();</span><br><span class="line">            <span class="keyword">if</span> (dataset.Tables.Count &gt; <span class="number">1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                Debug.LogError(<span class="keyword">string</span>.Format(<span class="string">"Excel文件:&#123;0&#125;,不允许一个Excel多张Table!"</span>, excelreader.Name));</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="function"><span class="keyword">else</span> <span class="title">if</span> (<span class="params">datadic.ContainsKey(excelreader.Name</span>))</span><br><span class="line">            </span>&#123;</span><br><span class="line">                Debug.LogError(<span class="keyword">string</span>.Format(<span class="string">"有同名的Excel Table存在!同名Excel:&#123;0&#125;!"</span>, excelreader.Name));</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">int</span> currentlinenumber = <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">string</span>[] types = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">string</span>[] names = <span class="keyword">null</span>;</span><br><span class="line">                datadic.Add(excelreader.Name, <span class="keyword">new</span> List&lt;ConfigData[]&gt;());</span><br><span class="line">                <span class="keyword">while</span>(excelreader.Read())</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//读取每一行的数据</span></span><br><span class="line">                    <span class="keyword">string</span>[] datas = <span class="keyword">new</span> <span class="keyword">string</span>[excelreader.FieldCount];</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; excelreader.FieldCount; i++)</span><br><span class="line">                    &#123;</span><br><span class="line">                        datas[i] = excelreader.GetString(i);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 字段信息</span></span><br><span class="line">                    <span class="keyword">if</span> (currentlinenumber == NameLineNumber)</span><br><span class="line">                    &#123;</span><br><span class="line">                        names = datas;</span><br><span class="line">                        <span class="keyword">if</span>(checkRepeatedNameString(names))</span><br><span class="line">                        &#123;</span><br><span class="line">                            Debug.LogError(<span class="keyword">string</span>.Format(<span class="string">"Excel Table:&#123;0&#125;"</span>, excelreader.Name));</span><br><span class="line">                            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        namesmap.Add(excelreader.Name, names);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// 字段类型信息</span></span><br><span class="line">                    <span class="function"><span class="keyword">else</span> <span class="title">if</span>(<span class="params">currentlinenumber == TypeLineNumber</span>)</span><br><span class="line">                    </span>&#123;</span><br><span class="line">                        types = datas;</span><br><span class="line">                        <span class="keyword">if</span> (checkInvalideType(types))</span><br><span class="line">                        &#123;</span><br><span class="line">                            Debug.LogError(<span class="keyword">string</span>.Format(<span class="string">"Excel Table:&#123;0&#125;"</span>, excelreader.Name));</span><br><span class="line">                            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        typesmap.Add(excelreader.Name, types);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="function"><span class="keyword">else</span> <span class="title">if</span>(<span class="params">currentlinenumber &gt;= DataLineNumber</span>)</span><br><span class="line">                    </span>&#123;</span><br><span class="line">                        <span class="comment">// 记录每一行所有数据的字段名，字段类型，字段数据</span></span><br><span class="line">                        ConfigData[] configdatas = <span class="keyword">new</span> ConfigData[datas.Length];</span><br><span class="line">                        <span class="keyword">for</span>(<span class="keyword">int</span> m = <span class="number">0</span>; m &lt; datas.Length; m++)</span><br><span class="line">                        &#123;</span><br><span class="line">                            ConfigData cd = <span class="keyword">new</span> ConfigData();</span><br><span class="line">                            cd.Type = types[m];</span><br><span class="line">                            cd.Name = names[m];</span><br><span class="line">                            cd.Data = datas[m];</span><br><span class="line">                            <span class="keyword">if</span>(<span class="keyword">string</span>.IsNullOrEmpty(cd.Type))</span><br><span class="line">                            &#123;</span><br><span class="line">                                Debug.LogError(<span class="keyword">string</span>.Format(<span class="string">"数据第&#123;0&#125;行，第&#123;1&#125;列字段类型不能为空!"</span>, currentlinenumber, m));</span><br><span class="line">                                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="function"><span class="keyword">else</span> <span class="title">if</span>(<span class="params"><span class="keyword">string</span>.IsNullOrEmpty(cd.Name</span>))</span><br><span class="line">                            </span>&#123;</span><br><span class="line">                                Debug.LogError(<span class="keyword">string</span>.Format(<span class="string">"数据第&#123;0&#125;行，第&#123;1&#125;列字段名字不能为空!"</span>, currentlinenumber, m));</span><br><span class="line">                                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                            configdatas[m] = cd;</span><br><span class="line">                        &#125;</span><br><span class="line">                        datadic[excelreader.Name].Add(configdatas);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        Debug.LogError(<span class="keyword">string</span>.Format(<span class="string">"无效的行号:&#123;0&#125;"</span>, currentlinenumber));</span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    currentlinenumber++;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> 检查是否有重复的字段名</span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="names"&gt;</span><span class="xmlDocTag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;returns&gt;</span><span class="xmlDocTag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">checkRepeatedNameString</span>(<span class="params"><span class="keyword">string</span>[] names</span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> tempdic = <span class="keyword">new</span> Dictionary&lt;<span class="keyword">string</span>, <span class="keyword">string</span>&gt;();</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> name <span class="keyword">in</span> names)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (tempdic.ContainsKey(name))</span><br><span class="line">            &#123;</span><br><span class="line">                Debug.LogError(<span class="keyword">string</span>.Format(<span class="string">"同名字段:&#123;0&#125;!"</span>, name));</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                tempdic.Add(name, name);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> 检查是否有无效的字段类型</span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="types"&gt;</span><span class="xmlDocTag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;returns&gt;</span><span class="xmlDocTag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">checkInvalideType</span>(<span class="params"><span class="keyword">string</span>[] types</span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">foreach</span>(<span class="keyword">var</span> type <span class="keyword">in</span> types)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(!ValideTypesList.Contains(type))</span><br><span class="line">            &#123;</span><br><span class="line">                Debug.LogError(<span class="keyword">string</span>.Format(<span class="string">"无效类型:&#123;0&#125;"</span>, type));</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> 编译代码到dll</span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="scripts"&gt;</span><span class="xmlDocTag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="outputfile"&gt;</span><span class="xmlDocTag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;returns&gt;</span>返回Assembly<span class="xmlDocTag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Assembly <span class="title">compileCode</span>(<span class="params"><span class="keyword">string</span>[] scripts, <span class="keyword">string</span> outputfile</span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="comment">//编译参数</span></span><br><span class="line">        CSharpCodeProvider codeprovider = <span class="keyword">new</span> CSharpCodeProvider();</span><br><span class="line">        CompilerParameters objcompilerparameters = <span class="keyword">new</span> CompilerParameters();</span><br><span class="line">        objcompilerparameters.ReferencedAssemblies.AddRange(<span class="keyword">new</span> <span class="keyword">string</span>[] &#123; <span class="string">"System.dll"</span> &#125;);</span><br><span class="line">        objcompilerparameters.OutputAssembly = outputfile;</span><br><span class="line">        objcompilerparameters.GenerateExecutable = <span class="keyword">false</span>;</span><br><span class="line">        objcompilerparameters.GenerateInMemory = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//开始编译脚本</span></span><br><span class="line">        CompilerResults cr = codeprovider.CompileAssemblyFromSource(objcompilerparameters, scripts);</span><br><span class="line">        <span class="keyword">if</span> (cr.Errors.HasErrors)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">"编译错误："</span>);</span><br><span class="line">            <span class="keyword">foreach</span> (CompilerError err <span class="keyword">in</span> cr.Errors)</span><br><span class="line">                Debug.LogError(err.ErrorText);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> cr.CompiledAssembly;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> 序列化数据</span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="container"&gt;</span>数据容器对象<span class="xmlDocTag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="type"&gt;</span>数据Class类型<span class="xmlDocTag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="datalist"&gt;</span>数据列表<span class="xmlDocTag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="outputpath"&gt;</span>输出目录<span class="xmlDocTag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">serialize</span>(<span class="params"><span class="keyword">object</span> container, Type type, List&lt;ConfigData[]&gt; datalist, <span class="keyword">string</span> outputpath</span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        FieldInfo dictInfo = container.GetType().GetField(<span class="string">"Dict"</span>);</span><br><span class="line">        <span class="keyword">object</span> dict = dictInfo.GetValue(container);</span><br><span class="line">        <span class="comment">//读取每一行数据并填充到实例对象里</span></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> datas <span class="keyword">in</span> datalist)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">object</span> instance = type.Assembly.CreateInstance(type.FullName);</span><br><span class="line">            <span class="comment">//填充实例对象数据</span></span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">var</span> data <span class="keyword">in</span> datas)</span><br><span class="line">            &#123;</span><br><span class="line">                FieldInfo fieldinfo = type.GetField(data.Name);</span><br><span class="line">                fieldinfo.SetValue(instance, parseValue(data.Type, data.Data));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//将实例对象数据添加到Container Map里，后续用于序列化数据</span></span><br><span class="line">            <span class="keyword">object</span> id = type.GetField(<span class="string">"id"</span>).GetValue(instance);</span><br><span class="line">            <span class="keyword">bool</span> isExist = (<span class="keyword">bool</span>)dict.GetType().GetMethod(<span class="string">"ContainsKey"</span>).Invoke(dict, <span class="keyword">new</span> <span class="keyword">object</span>[] &#123; id &#125;);</span><br><span class="line">            <span class="keyword">if</span> (isExist)</span><br><span class="line">            &#123;</span><br><span class="line">                Debug.LogError(<span class="string">"Repetitive key "</span> + id + <span class="string">" in "</span> + container.GetType().Name);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            dict.GetType().GetMethod(<span class="string">"Add"</span>).Invoke(dict, <span class="keyword">new</span> <span class="keyword">object</span>[] &#123; id, instance &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//将数据序列化到本地文件</span></span><br><span class="line">        <span class="keyword">var</span> bf = <span class="keyword">new</span> BinaryFormatter();</span><br><span class="line">        <span class="keyword">var</span> s = <span class="keyword">new</span> FileStream(outputpath + type.Name + <span class="string">".bytes"</span>, FileMode.CreateNew, FileAccess.Write);</span><br><span class="line">        bf.Serialize(s, container);</span><br><span class="line">        s.Close();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> 创建生成反序列化加载接口代码</span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="assembly"&gt;</span><span class="xmlDocTag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="outputpath"&gt;</span>输出路径<span class="xmlDocTag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;returns&gt;</span><span class="xmlDocTag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">createDataManager</span>(<span class="params">Assembly assembly, <span class="keyword">string</span> outputpath</span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        StringBuilder source = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        source.Append(<span class="string">"/*\n"</span>);</span><br><span class="line">        source.Append(<span class="string">"\tAuto create\n"</span>);</span><br><span class="line">        source.Append(<span class="string">"\tDon't Edit it\n"</span>);</span><br><span class="line">        source.Append(<span class="string">"*/\n"</span>);</span><br><span class="line">        source.Append(<span class="string">"\n"</span>);</span><br><span class="line"></span><br><span class="line">        source.Append(<span class="string">"using System;\n"</span>);</span><br><span class="line">        source.Append(<span class="string">"using UnityEngine;\n"</span>);</span><br><span class="line">        source.Append(<span class="string">"using System.Runtime.Serialization;\n"</span>);</span><br><span class="line">        source.Append(<span class="string">"using System.Runtime.Serialization.Formatters.Binary;\n"</span>);</span><br><span class="line">        source.Append(<span class="string">"using System.IO;\n\n"</span>);</span><br><span class="line">        source.Append(<span class="string">"[Serializable]\n"</span>);</span><br><span class="line">        source.Append(<span class="string">"public class DataManager : SingletonTemplate&lt;DataManager&gt;\n"</span>);</span><br><span class="line">        source.Append(<span class="string">"&#123;\n"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//定义所有Container的成员变量</span></span><br><span class="line">        <span class="keyword">var</span> types = assembly.GetTypes();</span><br><span class="line">        <span class="keyword">foreach</span>(<span class="keyword">var</span> type <span class="keyword">in</span> types)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(!type.Name.EndsWith(PathUtilties.ExcelTableContainerPostfix))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            source.Append(<span class="string">"\tpublic "</span> + type.Name + <span class="string">" "</span> + type.Name.Remove(<span class="number">0</span>, <span class="number">2</span>) + <span class="string">";\n"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        source.Append(<span class="string">"\n"</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//加载所有配置表</span></span><br><span class="line">        source.Append(<span class="string">"\tpublic void loadAll()\n"</span>);</span><br><span class="line">        source.Append(<span class="string">"\t&#123;\n"</span>);</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> type <span class="keyword">in</span> types)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (!type.Name.EndsWith(<span class="string">"Container"</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">string</span> typeName = type.Name.Remove(type.Name.IndexOf(<span class="string">"Container"</span>));</span><br><span class="line">            source.Append(<span class="string">"\t\t"</span> + type.Name.Remove(<span class="number">0</span>, <span class="number">2</span>) + <span class="string">" = Load("</span> + <span class="string">'"'</span> + typeName + <span class="string">'"'</span> + <span class="string">") as "</span> + type.Name + <span class="string">";\n"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        source.Append(<span class="string">"\t&#125;\n\n"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//反序列化接口方法</span></span><br><span class="line">        source.Append(<span class="string">"\tprivate System.Object Load(string name)\n"</span>);</span><br><span class="line">        source.Append(<span class="string">"\t&#123;\n"</span>);</span><br><span class="line">        source.Append(<span class="string">"\t\tvar bf = new BinaryFormatter();\n"</span>);</span><br><span class="line">        source.Append(<span class="string">"\t\tTextAsset text = Resources.Load&lt;TextAsset&gt;("</span> + <span class="string">'"'</span> + PathUtilties.ExcelDataFileOutputFolderRelativePath + <span class="string">'"'</span> + <span class="string">" + name);\n"</span>);</span><br><span class="line">        source.Append(<span class="string">"\t\tStream s = new MemoryStream(text.bytes);\n"</span>);</span><br><span class="line">        source.Append(<span class="string">"\t\tSystem.Object obj = bf.Deserialize(s);\n"</span>);</span><br><span class="line">        source.Append(<span class="string">"\t\ts.Close();\n"</span>);</span><br><span class="line">        source.Append(<span class="string">"\t\treturn obj;\n"</span>);</span><br><span class="line">        source.Append(<span class="string">"\t&#125;\n"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 数据加载接口</span></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> type <span class="keyword">in</span> types)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (type.Name.EndsWith(<span class="string">"Container"</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">var</span> classname = type.Name;</span><br><span class="line">            source.Append(<span class="string">"\t\n"</span>);</span><br><span class="line">            source.Append(<span class="string">"\tpublic "</span> + classname + <span class="string">" get"</span> + classname.Substring(<span class="number">2</span>) + <span class="string">"Data(int id)\n"</span>);</span><br><span class="line">            source.Append(<span class="string">"\t&#123;\n"</span>);</span><br><span class="line">            source.Append(<span class="string">"\t\t"</span> + classname + <span class="string">" data = null;\n"</span>);</span><br><span class="line">            source.Append(<span class="string">"\t\t"</span> + classname.Substring(<span class="number">2</span>) + <span class="string">"Container.getMap().TryGetValue(id, out data);\n"</span>);</span><br><span class="line">            source.Append(<span class="string">"\t\tif(data == null)\n"</span>);</span><br><span class="line">            source.Append(<span class="string">"\t\t&#123;\n"</span>);</span><br><span class="line">            source.Append(<span class="string">"\t\t\tDebug.LogError(string.Format(\"表格:&#123; 0&#125;找不到id: &#123; 1&#125;的数据!\", data.GetType().ToString(), id));\n"</span>);</span><br><span class="line">            source.Append(<span class="string">"\t\t&#125;\n"</span>);</span><br><span class="line">            source.Append(<span class="string">"\t\treturn data;\n"</span>);</span><br><span class="line">            source.Append(<span class="string">"\t&#125;\n"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        source.Append(<span class="string">"&#125;\n"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//保存脚本</span></span><br><span class="line">        StreamWriter sw = <span class="keyword">new</span> StreamWriter(outputpath + PathUtilties.ExcelScriptDataManagerFileName);</span><br><span class="line">        sw.WriteLine(source.ToString());</span><br><span class="line">        sw.Close();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> 根据字符串解析类型(暂时只支持基础类型)</span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="type"&gt;</span><span class="xmlDocTag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="data"&gt;</span><span class="xmlDocTag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;returns&gt;</span><span class="xmlDocTag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">object</span> <span class="title">parseValue</span>(<span class="params"><span class="keyword">string</span> type, <span class="keyword">string</span> data</span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (type.Equals(<span class="string">"string"</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> data;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">else</span> <span class="title">if</span>(<span class="params">type.Equals(<span class="string">"int"</span></span>))</span><br><span class="line">        </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">int</span>.Parse(data);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">else</span> <span class="title">if</span>(<span class="params">type.Equals(<span class="string">"float"</span></span>))</span><br><span class="line">        </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">float</span>.Parse(data);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="keyword">string</span>.Format(<span class="string">"类型字符串:&#123;0&#125;不支持该类型数据解析!"</span>, type));</span><br><span class="line">            <span class="keyword">return</span> data;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>DataConfigScriptGenerator.cs<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="xmlDocTag">///</span> 导表代码生成工具</span></span><br><span class="line"><span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">DataConfigScriptGenerator</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> 类名</span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">string</span> ClassName</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> 成员字段类型数据</span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">string</span>[] TypeDatas</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> 成员字段名字数据</span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">string</span>[] TypeNameDatas</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DataConfigScriptGenerator</span>(<span class="params"><span class="keyword">string</span> classname, <span class="keyword">string</span>[] typedatas, <span class="keyword">string</span>[] typenamedatas</span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        ClassName = classname;</span><br><span class="line">        TypeDatas = typedatas;</span><br><span class="line">        TypeNameDatas = typenamedatas;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> 生成对应表代码外部接口</span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;returns&gt;</span><span class="xmlDocTag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">string</span> <span class="title">generateCode</span>(<span class="params"></span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">string</span>.IsNullOrEmpty(ClassName) || TypeDatas == <span class="keyword">null</span> || TypeNameDatas == <span class="keyword">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> generateRealCode();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> 生成表代码</span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;returns&gt;</span><span class="xmlDocTag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">string</span> <span class="title">generateRealCode</span>(<span class="params"></span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="comment">//生成类文件头</span></span><br><span class="line">        StringBuilder classsource = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        classsource.Append(<span class="string">"/*\n"</span>);</span><br><span class="line">        classsource.Append(<span class="string">"\tAuto create\n"</span>);</span><br><span class="line">        classsource.Append(<span class="string">"\tDon't Edit it\n"</span>);</span><br><span class="line">        classsource.Append(<span class="string">"*/\n"</span>);</span><br><span class="line">        classsource.Append(<span class="string">"\n"</span>);</span><br><span class="line">        classsource.Append(<span class="string">"using System;\n"</span>);</span><br><span class="line">        classsource.Append(<span class="string">"using System.Reflection;\n"</span>);</span><br><span class="line">        classsource.Append(<span class="string">"using System.Collections.Generic;\n"</span>);</span><br><span class="line">        classsource.Append(<span class="string">"\n"</span>);</span><br><span class="line">        classsource.Append(<span class="string">"[Serializable]\n"</span>);</span><br><span class="line">        classsource.Append(<span class="string">"public class "</span> + ClassName + <span class="string">"\n"</span>);</span><br><span class="line">        classsource.Append(<span class="string">"&#123;\n"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//生成成员声明数据</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; TypeDatas.Length; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            classsource.Append(filedString(TypeDatas[i], TypeNameDatas[i]));</span><br><span class="line">        &#125;</span><br><span class="line">        classsource.Append(<span class="string">"&#125;\n"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//生成Container</span></span><br><span class="line">        classsource.Append(<span class="string">"\n"</span>);</span><br><span class="line">        classsource.Append(<span class="string">"[Serializable]\n"</span>);</span><br><span class="line">        classsource.Append(<span class="string">"public class "</span> + ClassName + PathUtilties.ExcelTableContainerPostfix + <span class="string">"\n"</span>);</span><br><span class="line">        classsource.Append(<span class="string">"&#123;\n"</span>);</span><br><span class="line">        classsource.Append(<span class="string">"\tpublic "</span> + <span class="string">"Dictionary&lt;int, "</span> + ClassName + <span class="string">"&gt;"</span> + <span class="string">" Dict"</span> + <span class="string">" = new Dictionary&lt;int, "</span> + ClassName + <span class="string">"&gt;();\n"</span>);</span><br><span class="line">        classsource.Append(<span class="string">"\tpublic "</span> + <span class="string">"Dictionary&lt;int, "</span> + ClassName + <span class="string">"&gt;"</span> + <span class="string">" getMap()\n"</span>);</span><br><span class="line">        classsource.Append(<span class="string">"\t&#123;\n"</span>);</span><br><span class="line">        classsource.Append(<span class="string">"\t\treturn Dict;\n"</span>);</span><br><span class="line">        classsource.Append(<span class="string">"\t&#125;\n"</span>);</span><br><span class="line">        classsource.Append(<span class="string">"&#125;\n"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> classsource.ToString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> 成员声明数据</span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="type"&gt;</span>成员类型<span class="xmlDocTag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="field"&gt;</span>成员名<span class="xmlDocTag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;returns&gt;</span><span class="xmlDocTag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">string</span> <span class="title">filedString</span>(<span class="params"><span class="keyword">string</span> type, <span class="keyword">string</span> field</span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">string</span>.IsNullOrEmpty(type) || <span class="keyword">string</span>.IsNullOrEmpty(field))</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        StringBuilder sbProperty = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        sbProperty.Append(<span class="string">"\tpublic "</span> + type + <span class="string">" "</span> + field + <span class="string">";\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> sbProperty.ToString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>让我们来看看最终的结果：<br>game.xlsx<br><img src="/img/Unity/ExcelDataConfig.PNG" alt="ExcelDataConfig"></p>
<p><img src="/img/Unity/DataConfigScriptDll.dll" alt="DataConfigScriptDll"></p>
<p><img src="/img/Unity/DataConfigData.PNG" alt="DataConfigData"></p>
<p>t_game.cs<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span><br><span class="line">    Auto create</span><br><span class="line">    Don't Edit it</span><br><span class="line">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Reflection;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"></span><br><span class="line">[Serializable]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">t_game</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> id;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">string</span> author;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">string</span> sex;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> age;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">float</span> money;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[Serializable]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">t_gameContainer</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> Dictionary&lt;<span class="keyword">int</span>, t_game&gt; Dict = <span class="keyword">new</span> Dictionary&lt;<span class="keyword">int</span>, t_game&gt;();</span><br><span class="line">    <span class="keyword">public</span> Dictionary&lt;<span class="keyword">int</span>, t_game&gt; getMap()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> Dict;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>DataManager.cs<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line">    Auto create</span><br><span class="line">    Don't Edit it</span><br><span class="line">*/</span><br><span class="line"></span><br><span class="line">using System;</span><br><span class="line">using UnityEngine;</span><br><span class="line">using System.Runtime.Serialization;</span><br><span class="line">using System.Runtime.Serialization.Formatters.Binary;</span><br><span class="line">using System.IO;</span><br><span class="line"></span><br><span class="line">[Serializable]</span><br><span class="line">public class DataManager : SingletonTemplate&lt;DataManager&gt;</span><br><span class="line">&#123;</span><br><span class="line">    public t_gameContainer gameContainer;</span><br><span class="line"></span><br><span class="line">    public void loadAll()</span><br><span class="line">    &#123;</span><br><span class="line">        gameContainer = Load("t_game") as t_gameContainer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private System.Object Load(string name)</span><br><span class="line">    &#123;</span><br><span class="line">        var bf = new BinaryFormatter();</span><br><span class="line">        TextAsset text = Resources.Load&lt;TextAsset&gt;("DataConfig/" + name);</span><br><span class="line">        Stream s = new MemoryStream(text.bytes);</span><br><span class="line">        System.Object obj = bf.Deserialize(s);</span><br><span class="line">        s.Close();</span><br><span class="line">        return obj;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public t_game getgameData(int id)</span><br><span class="line">    &#123;</span><br><span class="line">        t_game data = null;</span><br><span class="line">        gameContainer.getMap().TryGetValue(id, out data);</span><br><span class="line">        if(data == null)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(string.Format("表格:&#123; 0&#125;找不到id: &#123; 1&#125;的数据!", data.GetType().ToString(), id));</span><br><span class="line">        &#125;</span><br><span class="line">        return data;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>最后在Unity里测试读取和打印:<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">GUILayout.BeginHorizontal();</span><br><span class="line"><span class="keyword">if</span> (GUILayout.Button(<span class="string">"加载所有表格数据"</span>, GUILayout.MaxWidth(<span class="number">250.0</span>f), GUILayout.MaxHeight(<span class="number">50.0</span>f)))</span><br><span class="line">&#123;</span><br><span class="line">    Debug.Log(<span class="string">"加载所有表格数据"</span>);</span><br><span class="line">    DataManager.Singleton.loadAll();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (GUILayout.Button(<span class="string">"打印所有表格数据"</span>, GUILayout.MaxWidth(<span class="number">250.0</span>f), GUILayout.MinHeight(<span class="number">50.0</span>f)))</span><br><span class="line">&#123;</span><br><span class="line">    Debug.Log(<span class="string">"打印所有表格数据"</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= DataManager.Singleton.gameContainer.Dict.Count; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> data = DataManager.Singleton.getgameData(i);</span><br><span class="line">        Debug.Log(<span class="keyword">string</span>.Format(<span class="string">"data.id : &#123;0&#125;, data.author : &#123;1&#125;, data.age : &#123;2&#125;, data.sex : &#123;3&#125;, data.money : &#123;4&#125;"</span>, data.id, data.author, data.age, data.sex, data.money));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">GUILayout.EndHorizontal();</span><br></pre></td></tr></table></figure></p>
<p><img src="/img/Unity/DataConfigResult.PNG" alt="DataConfigResult"></p>
<p>就这样我们成功的通过读取表格数据，生成对应代码，序列化数据，然后通过生成的对应表代码反序列化读取出数据就基本完成了。</p>
<p>遇到的问题:<br>第三步动态编译dll进行序列化反序列化，这一步本来想最终不使用dll而是跟着Unity参与编译的代码来反序列化，但是反序列化出现了问题。</p>
<p>错误信息:<br>SerializationExeption: could not find type ‘System.Collections.Generic.Dictionary’ **</p>
<p>个人猜测因为序列化反序列化时要求Assemble信息一致，所以如果反序列化使用Unity 编译后的C#无法成功反序列化</p>
<p>网上相关问题:<br><a href="https://stackoverflow.com/questions/505611/binary-deserialization-with-different-assembly-version" target="_blank" rel="external">SerializationException: Could not find type ‘System.Collections.Generic.List’1 in c# untiy3d</a><br><a href="https://www.codeproject.com/Tips/1101106/How-to-serialize-across-assemblies-with-the-Binary" target="_blank" rel="external">How to Serialize Across Assemblies with the BinaryFormatter</a></p>
<p>但考虑到BinderToType低版本.Net可以用但BinderToName要求.Net 4.0，所以这里放弃了直接生成新的cs表代码通过Unity编译使用的方案，选择依然采用直接编译表代码成dll来使用。<br>表代码依然生成，但放到Asset外部作为非有效代码存储方便查看</p>
<h5 id="问题">问题</h5><ol>
<li>C#反序列化默认是反射实现的，速度会比较慢，可以考虑实现自定义反序列化加快读取速度，参考：<a href="http://tonytang1990.github.io/2015/08/15/CSharp-Study/#Runtime_Serialization">Runtime_Serialization</a><br>Note:<br><strong>实际测试以后发现，自定义并没有加快反序列化的速度，反而增加了内存开销</strong></li>
</ol>
<p>测试方式:</p>
<ul>
<li>序列化同一个类型对象500次并反序列化500次</li>
<li>打印记录反序列化的内存和时间开销</li>
</ul>
<p>测试代码:<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">long</span> mHeapMemorySize;</span><br><span class="line"><span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="xmlDocTag">///</span> 显示堆内存使用准备工作(在调用ShowHeapMemoryUsing打印堆内存分配之前调用此方法确保计算显示的堆内存数据申请正确)</span></span><br><span class="line"><span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">TonyTangShowHeapMemoryUsingPrepration</span>(<span class="params"></span>)</span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">// 确保得到正确的起始Heap Memory Size</span></span><br><span class="line">    GC.Collect();</span><br><span class="line">    mHeapMemorySize = GC.GetTotalMemory(<span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="xmlDocTag">///</span> 显示堆内存使用情况</span></span><br><span class="line"><span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="postfix"&gt;</span><span class="xmlDocTag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">TonyTangShowHeapMemoryUsing</span>(<span class="params"><span class="keyword">string</span> postfix</span>)</span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> newestheapmemorysize = GC.GetTotalMemory(<span class="keyword">false</span>);</span><br><span class="line">    <span class="keyword">var</span> heapmemoryoffset = newestheapmemorysize - mHeapMemorySize;</span><br><span class="line">    Console.WriteLine(<span class="keyword">string</span>.Format(<span class="string">"Heap Memory Size = &#123;0&#125; Pre Memory Size = &#123;1&#125; Memory Offset = &#123;2&#125; -- &#123;3&#125;"</span>, newestheapmemorysize, mHeapMemorySize, heapmemoryoffset, postfix));</span><br><span class="line">    mHeapMemorySize = newestheapmemorysize;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Note:</span></span><br><span class="line"><span class="comment">//注释掉的部分就是自定义序列化和反序列化的代码部分</span></span><br><span class="line">[Serializable]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Map</span> <span class="comment">//: ISerializable, IDeserializationCallback</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//Special construct(required by ISerializable) to control deserialization</span></span><br><span class="line">    <span class="comment">//[SecurityPermissionAttribute(SecurityAction.Demand, SerializationFormatter = true)]</span></span><br><span class="line">    <span class="comment">//protected Map(SerializationInfo info, StreamingContext context)</span></span><br><span class="line">    <span class="comment">//&#123;</span></span><br><span class="line">    <span class="comment">//    m_SiInfo = info;</span></span><br><span class="line">    <span class="comment">//&#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//[SecurityPermissionAttribute(SecurityAction.Demand, SerializationFormatter = true)]</span></span><br><span class="line">    <span class="comment">//public virtual void GetObjectData(SerializationInfo info, StreamingContext context)</span></span><br><span class="line">    <span class="comment">//&#123;</span></span><br><span class="line">    <span class="comment">//    info.AddValue("mID", mID);</span></span><br><span class="line">    <span class="comment">//    info.AddValue("mMapName", mMapName);</span></span><br><span class="line">    <span class="comment">//&#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//void IDeserializationCallback.OnDeserialization(Object sender)</span></span><br><span class="line">    <span class="comment">//&#123;</span></span><br><span class="line">    <span class="comment">//    if (m_SiInfo == null)</span></span><br><span class="line">    <span class="comment">//    &#123;</span></span><br><span class="line">    <span class="comment">//        return;</span></span><br><span class="line">    <span class="comment">//    &#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//    mID = m_SiInfo.GetInt32("mID");</span></span><br><span class="line">    <span class="comment">//    mMapName = m_SiInfo.GetString("mMapName");</span></span><br><span class="line">    <span class="comment">//&#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//private SerializationInfo m_SiInfo;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Map</span>(<span class="params"></span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        mID = <span class="number">0</span>;</span><br><span class="line">        mMapName = <span class="string">"DefaultMap"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> ID</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> mID;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">set</span></span><br><span class="line">        &#123;</span><br><span class="line">            mID = <span class="keyword">value</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mID;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">string</span> MapName</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> mMapName;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">set</span></span><br><span class="line">        &#123;</span><br><span class="line">            mMapName = <span class="keyword">value</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">string</span> mMapName;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Serialization</span></span><br><span class="line"><span class="keyword">string</span> mMapSavePath = <span class="string">"./mapInfo.dat"</span>;</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> id = <span class="number">0</span>; id &lt; <span class="number">500</span>; id++)</span><br><span class="line">&#123;</span><br><span class="line">    Map map = <span class="keyword">new</span> Map();</span><br><span class="line">    map.ID = id;</span><br><span class="line">    map.MapName = id.ToString();</span><br><span class="line">    BinaryFormatter bf = <span class="keyword">new</span> BinaryFormatter();</span><br><span class="line">    <span class="keyword">var</span> mapsavepath = mMapSavePath + id;</span><br><span class="line">    <span class="keyword">if</span> (!File.Exists(mapsavepath))</span><br><span class="line">    &#123;</span><br><span class="line">        FileStream fsc = File.Create(mapsavepath);</span><br><span class="line">        fsc.Close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    FileStream fs = File.Open(mapsavepath, FileMode.Open);</span><br><span class="line">    bf.Serialize(fs, map);</span><br><span class="line">    fs.Close();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Deserialization</span></span><br><span class="line">ShowHeapMemoryUsingPrepration();</span><br><span class="line">TimeCounter.Singleton.Restart(<span class="string">"Deserialization"</span>);</span><br><span class="line">Map mDSMap;</span><br><span class="line">BinaryFormatter dsbf = <span class="keyword">new</span> BinaryFormatter ();</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> id = <span class="number">0</span>; id &lt; <span class="number">500</span>; id++)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> mapsavepath = mMapSavePath + id;</span><br><span class="line">    <span class="keyword">if</span> (File.Exists(mapsavepath))</span><br><span class="line">    &#123;</span><br><span class="line">        FileStream dsfs = File.Open(mapsavepath, FileMode.Open);</span><br><span class="line">        mDSMap = (Map)dsbf.Deserialize(dsfs);</span><br><span class="line">        dsfs.Close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">TimeCounter.Singleton.End();</span><br><span class="line">ShowHeapMemoryUsing(<span class="string">"Serialization"</span>);</span><br></pre></td></tr></table></figure></p>
<p>自定义序列化反序列化开销:<br><img src="/img/Unity/CustomSerializationPerformance.PNG" alt="CustomSerializationPerformance"></p>
<p>默认序列化开销:<br><img src="/img/Unity/DefaultSerializationPerformance.PNG" alt="DefaultSerializationPerformance"></p>
<p>从上面的测试可以看出反序列化的速度没有加快，反倒是反序列化的内存开销增加了。<br>这里的测试结果也和<a href="https://theburningwork.com/2011/08/performance-test-binaryformatter-vs-protobuf-net/" target="_blank" rel="external">Performance Test - BinaryFormatter vs Protobuf-Net</a>里的结论一致了。<strong>但至于为什么反序列化速度没有提升，这里不太明白，理论上避免了反射应该是有所提升才对。希望知道的朋友忘告知。</strong></p>
<ol>
<li>序列化的数据仅仅是通过C#自身可以反序列化出来，不支持跨语言(比如服务器端使用Java的话，并不能直接使用同样的序列化数据)。</li>
</ol>
<h4 id="ProtoBuff">ProtoBuff</h4><h5 id="ProtoBuff学习了解">ProtoBuff学习了解</h5><p>Protocol Buffers是Google发布出来的开源项目。<br><a href="https://developers.google.com/protocol-buffers/docs/overview" target="_blank" rel="external">Protocol Buffers - a language-neutral, platform-neutral, extensible way of serializing structured data for use in communications protocols, data storage, and more. </a><br>从官网介绍可以看出Google Protocol Buffers(平台无关，语言无关)是针对序列化数据的存储和传输协议等。<br>既然都是用于数据存储，那么Protocol buffers相比传统的二进制和XML序列化有什么优势了？<br>相比XML序列化，Protocol buffers更高效，更灵活，更快，更小，更简单。<br>更方便简单在于 — PB只需定义一次data的数据结构就能自动生成对应语言的解析该数据结构的代码类。<br>更高效更小在于 — XML存储的数据量大，XML在解析的时候，空间开销大，内容多速度慢。(XML的好处 — 具有可读性)<br>更灵活在于 — 只需更新数据结构定义然后编译出对应语言的代码就能无缝衔接以前的版本。<br>既然Protocol buffers这么好，那么让我们看看他是怎么工作的？</p>
<ol>
<li>定义出我们需要序列化的数据结构，保存在.proto文件里。</li>
<li><p>运用Protocol buffer编译器编译出我们对应语言的解析该数据结构的代码类。<br>首先下载对应语言的<a href="https://github.com/google/protobuf/releases/tag/v3.0.0" target="_blank" rel="external">Protocol buffer编译器</a><br>“There are two NuGet packages: Google.Protobuf (the support library) and Google.Protobuf.Tools (containing protoc)”<br>根据上面写的，C#现在貌似有两个版本支持Protocol Buffer，但原生的Protobuf版本支持的.NET版本很高，所以不适合Unity(Unity是基于Mono的，Mono现在对.NET的支持还停留在.NET 2.0和.NET 2.0 subset)。<br>所以通过Google，我找到了以下两个开源项目：</p>
<ol>
<li><a href="https://github.com/jskeet/protobuf-csharp-port" target="_blank" rel="external">Protobuf-csharp-port</a></li>
<li><p><a href="https://github.com/mgravell/protobuf-net" target="_blank" rel="external">Protobuf-net</a><br>前者在Git上的描述不多，所以这里就以下面引用的话来了解两者之间的区别。<br><a href="http://www.ben-morris.com/protocol-buffers-protobuf-net-vs-protobuf-csharp-port/" target="_blank" rel="external">Protobuf-csharp-port is written by Jon Skeet and is a faithful port of Google’s java implementation that uses similar command-line tooling. You create the data definitions in text-based .proto files and use a code generation tool to create the C# classes.</a><br>Protobuf-csharp-port是由Jon Skeet编写，利用原生工具去port的版本。在编译创建上都沿用了Protocol buffer的原始方式(通过编译.proto文件生成解析定义的Message数据结构的C#代码类)<br><a href="http://www.ben-morris.com/protocol-buffers-protobuf-net-vs-protobuf-csharp-port/" target="_blank" rel="external">Protobuf-net is written by Marc Gravell and will be more familiar to .Net developers. The implementation uses .Net classes and attributes to define data rather than .proto files. Overall, the code resembles existing .Net serializers such as the DataContractSerializer.</a><br>Protobuf-net是由Marc Gravell编写，支持.NET的类和attributes去定义数据结构，也支持.proto文件预编译生成对应代码类。可以说是.NET风格的Protobuf。<br>同时Github写明了支持：<br>.net 2.0/3.0/3.5/4.0<br>Mono 2.x<br>所以这里就决定使用Protobuf-net作为Unity C#序列化数据的存储和协议传输的库来学习。</p>
<ol>
<li><p>安装Protobuf-net<br>VS -&gt; Tools -&gt; Nuget Package Manager -&gt; Package Manager Console<br>在Package Manager Console窗口输入下列命令就会自动去下载Protobuf-net包并安装了。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Install-Package protobuf-net</span><br></pre></td></tr></table></figure>
<p>也可以直接下载<a href="https://code.google.com/archive/p/protobuf-net/downloads" target="_blank" rel="external">Down load link of Protobuf-net</a><br>把Protobuf-net.dll放到Assets/Plugins目录下</p>
</li>
<li>定义可序列化的类<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> ProtoBuf;</span><br><span class="line"></span><br><span class="line">[ProtoContract]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PlayerData</span> &#123;</span><br><span class="line">    [ProtoMember(<span class="number">1</span>)]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">string</span> SceneName</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [ProtoMember(<span class="number">2</span>)]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> Scores</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [ProtoMember(<span class="number">3</span>)]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> SpeedLevel</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
</li>
</ol>
</li>
<li><p>通过C#(对应语言)protocol buffer API去读写存储的数据。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Awake</span>(<span class="params"></span>)</span><br><span class="line"></span>&#123;</span><br><span class="line">   ......</span><br><span class="line"></span><br><span class="line">    mPlayerData = <span class="keyword">new</span> PlayerData();</span><br><span class="line"></span><br><span class="line">    mProfilePath =  Application.persistentDataPath + <span class="string">"/PlayerProile.bin"</span>;</span><br><span class="line">    Debug.Log(<span class="string">"mProfilePath = "</span> + mProfilePath);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SavePlayerData</span>(<span class="params"></span>)</span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">//Do serialization for player data</span></span><br><span class="line">    FileStream profile;</span><br><span class="line">    <span class="keyword">if</span>(File.Exists(mProfilePath))</span><br><span class="line">    &#123;</span><br><span class="line">        profile = File.Open(mProfilePath, FileMode.Open);</span><br><span class="line">        Serializer.Serialize(profile, mPlayerData);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        profile = File.Create(mProfilePath);</span><br><span class="line">        Serializer.Serialize(profile, mPlayerData);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">LoadPlayerData</span>(<span class="params"></span>)</span><br><span class="line"></span>&#123;</span><br><span class="line">    FileStream profile;</span><br><span class="line">    <span class="keyword">if</span>(File.Exists(mProfilePath))</span><br><span class="line">    &#123;</span><br><span class="line">        profile = File.OpenRead(mProfilePath);</span><br><span class="line">        mPlayerData = Serializer.Deserialize&lt;PlayerData&gt;(profile);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        mPlayerData = <span class="keyword">new</span> PlayerData();</span><br><span class="line">        mPlayerData.SceneName = Application.productName;</span><br><span class="line">        mPlayerData.Scores = <span class="number">0</span>;</span><br><span class="line">        mPlayerData.SpeedLevel = <span class="number">1</span>;</span><br><span class="line">        SavePlayerData();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>但只是这样的话，会报如下错误：<br>NotSupportException： …… System.Reflection.Emit is not supported<br>这里出现了Emit类的使用，显然是用到了动态生成代码，根据我们之前讲到的IOS是在Full-AOT模式下运行不允许动态生成代码的。<br>所以直接使用.NET风格的Attribute会触发动态代码生成，那么我们就需要想办法提前生成，这里就需要使用.proto文件然后通过预编译的方式生成对应的代码类。<br>所以现在我们需要先定义.proto文件(Protobuf-net只支持Proto2)，所以编写<a href="https://developers.google.com/protocol-buffers/docs/proto" target="_blank" rel="external">proto2参考</a><br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//PlayerData.proto</span></span><br><span class="line">syntax = <span class="string">"proto2"</span>;</span><br><span class="line"></span><br><span class="line">package NGUI2DGame;</span><br><span class="line"></span><br><span class="line">message PlayerData&#123;</span><br><span class="line">    optional <span class="keyword">string</span> SceneName = <span class="number">1</span>;</span><br><span class="line">    optional int32 Scores = <span class="number">2</span>;</span><br><span class="line">    optional int32 SpeedLevel = <span class="number">3</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>然后通过Protogen.exe帮我们生成对应解析该数据结构所需要的代码类<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">protogen -i:PlayerData.proto -o:PlayerData.cs -ns:NGUI2DGame</span><br></pre></td></tr></table></figure></p>
<p>-i是指明输入，这里可以通过-i指定多个输入proto文件。-o是指定输出文件，最终生成的对应信息的代码类。-ns是指定namespace<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">//PlayerData.cs</span><br><span class="line">//------------------------------------------------------------------------------</span><br><span class="line">// &lt;auto-generated&gt;</span><br><span class="line">//     This code was generated by a tool.</span><br><span class="line">//</span><br><span class="line">//     Changes to this file may cause incorrect behavior and will be lost if</span><br><span class="line">//     the code is regenerated.</span><br><span class="line">// &lt;/auto-generated&gt;</span><br><span class="line">//------------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">// Generated from: PlayerData.proto</span><br><span class="line">namespace NGUI2DGame</span><br><span class="line">&#123;</span><br><span class="line">  [global::System.Serializable, global::ProtoBuf.ProtoContract(Name=@"PlayerData")]</span><br><span class="line">  public partial class PlayerData : global::ProtoBuf.IExtensible</span><br><span class="line">  &#123;</span><br><span class="line">    public PlayerData() &#123;&#125;</span><br><span class="line">    </span><br><span class="line">    private string _SceneName = "";</span><br><span class="line">    [global::ProtoBuf.ProtoMember(1, IsRequired = false, Name=@"SceneName", DataFormat = global::ProtoBuf.DataFormat.Default)]</span><br><span class="line">    [global::System.ComponentModel.DefaultValue("")]</span><br><span class="line">    public string SceneName</span><br><span class="line">    &#123;</span><br><span class="line">      get &#123; return _SceneName; &#125;</span><br><span class="line">      set &#123; _SceneName = value; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    private int _Scores = default(int);</span><br><span class="line">    [global::ProtoBuf.ProtoMember(2, IsRequired = false, Name=@"Scores", DataFormat = global::ProtoBuf.DataFormat.TwosComplement)]</span><br><span class="line">    [global::System.ComponentModel.DefaultValue(default(int))]</span><br><span class="line">    public int Scores</span><br><span class="line">    &#123;</span><br><span class="line">      get &#123; return _Scores; &#125;</span><br><span class="line">      set &#123; _Scores = value; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    private int _SpeedLevel = default(int);</span><br><span class="line">    [global::ProtoBuf.ProtoMember(3, IsRequired = false, Name=@"SpeedLevel", DataFormat = global::ProtoBuf.DataFormat.TwosComplement)]</span><br><span class="line">    [global::System.ComponentModel.DefaultValue(default(int))]</span><br><span class="line">    public int SpeedLevel</span><br><span class="line">    &#123;</span><br><span class="line">      get &#123; return _SpeedLevel; &#125;</span><br><span class="line">      set &#123; _SpeedLevel = value; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    private global::ProtoBuf.IExtension extensionObject;</span><br><span class="line">    global::ProtoBuf.IExtension global::ProtoBuf.IExtensible.GetExtensionObject(bool createIfMissing)</span><br><span class="line">      &#123; return global::ProtoBuf.Extensible.GetExtensionObject(ref extensionObject, createIfMissing); &#125;</span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>接下来把我们生成的代码通过VS编译成DLL</p>
<ol>
<li>新建C# Library工程</li>
<li>删掉原始cs添加刚才生成的PlayerData.cs</li>
<li>添加Protobuf-net库引用(用CoreOnly/ios/protobuf-net.dll)</li>
<li>编译出dll<br>最后我们需要通过上一步生成的信息类dll来编译出专门序列化该信息的类库。(添加precompile.exe的路径到环境变量确保找得到，这里要注意的是dll项目的.NET target设置成2.0，因为Unity Mono现在只支持到2.0)<br>在之前生成的PlayerData.dll目录下执行下列命令：<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">precompile PlayerData.dll -o:ProtobufSerializer.dll -t:com.TonyTang.ProtobufSerializer</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>-o指明输出文件 -t指明生成的序列化类的类名<br>最后利用生成的PlayerData.dll和ProtobufSerializer.dll到Unity里进行测试，编写对应代码即可，写法和之前的区别就是用我们生成好的类来完成序列化和反序列化。<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Serialization</span></span><br><span class="line">ProtobufSerializer serializer = <span class="keyword">new</span> ProtobufSerializer();       </span><br><span class="line">profile = File.Open(mProfilePath, FileMode.Open);</span><br><span class="line">serializer.Serialize(profile, mPlayerData);</span><br><span class="line"><span class="comment">//Deserialization</span></span><br><span class="line">profile = File.OpenRead(mProfilePath);</span><br><span class="line">mPlayerData = serializer.Deserialize(profile,<span class="keyword">null</span>,<span class="keyword">typeof</span>(PlayerData)) <span class="keyword">as</span> PlayerData;</span><br></pre></td></tr></table></figure></p>
<p>因为需要编写.proto文件后编译生成对应的Serialization类的dll，所以最好通过shell脚本写成自动化。<br>还有一种方式是使用Probobuf-net源码的形式(貌似需要设定-unsafe和.NET 2 subset)，这里我没有尝试，下面给出链接：<br><a href="http://www.ceeger.com/forum/read.php?tid=14359&amp;fid=27" target="_blank" rel="external">在ios android设备上使用 Protobuf (使用源码方式) </a></p>
<p>了解了什么(What)是Protobuf，如何(How)使用Protobuf，那么我们也应该大概了解下为什么(Why)Protobuf高效，更小，更快，更简单…..<br>参考下面两篇文章：<br><a href="https://www.ibm.com/developerworks/cn/linux/l-cn-gpb/" target="_blank" rel="external">Google Protocol Buffer 的使用和原理</a><br><a href="https://developers.google.com/protocol-buffers/docs/encoding" target="_blank" rel="external">官网讲到的Protocol buffer的Encode技术</a><br>从上面可以看出，更小更快是因为Protocol buffer采用了巧妙的Encoding方法。<br>而这个Encoding方法利用了Varint技术，那么什么是Varint了？<br>“Varints are a method of serializing integers using one or more bytes. Smaller numbers take a smaller number of bytes. “<br>Varints通过更少的字节来表达准确的数据，比如0-127只需要1个字节就能表示。<br>当需要多个字节表达的时候，通过利用1byte里的first bit来区分，如果first bit是1表示后续的7个bit都表示数据，如果first bit是0表示这是最后一个字节用于表示数据。<br>同时Protocol buffer在Encode的时候通过key和value来存储数据。key只包含filed的名字和类型，value包含数据。<br>类型数据映射<br><img src="/img/Unity/ProtocolBufferMessageValueType.PNG" alt="ProtocolBufferMessageValueType"><br>当Decode的时候，如果遇到不识别的key值，只需要skip即可，保证了程序的老版本兼容。<br>更方便在于，我们只需通过编写简单易懂的.proto文件然后通过ProtoGen，Precompile工具就能生成对应的Message，Encode和Decode类。<br>结合前面的事例，让我们窥探一下到底Protocol-net是如何实现编写.proto文件结合编译生成Message类和序列化类来实现数据的Encode和Decode的。<br>首先反编译的ProtovufSerializer.dll，查看Serialize方法<br><img src="/img/Unity/ProtobufSerializerSerialize.PNG" alt="ProtobufSerializerSerialize"><br>可以看到ProtobufSerializer调用了Write方法，接下来查看Write方法<br><img src="/img/Unity/ProtobufSerializerWrite.PNG" alt="ProtobufSerializerWrite"><br>可以看到我们ProtobufSerializer实际是通过调用ProtoBuf.ProtoWriter::WriteFieldHeader(Protobuf-net库)实现数据的Encode的。同时因为ProtobufSerializer是根据PlayerData.dll编译而成，所以Write方法里的实现针对每一个需要Encode的Message成员进行数据Encode写入。<br>这样一来就完成了通过编写.proto文件定义Message，然后生成对应的Message类和序列化类再结合Protocol-net库实现了自定义Message的Encode和Decode了，而最终数据的Encode，Decode实现就落实到Protocol-net的实现了。</p>
<p>那么为什么要用Protocol buffer了？<br>参考文章：<br><a href="http://www.oschina.net/translate/choose-protocol-buffers" target="_blank" rel="external">使用 Protocol Buffers 代替 JSON 的五个原因</a><br>Protocol buffer因为是存储在二进制文件，相比XML，Jason等技术不具可读性。</p>
<p>Note:<br>最初的Protocol Buffers只开发了针对Java,C++,Python的版本。后来开园后有了C#，Go等语言的支持。<br>Protocol Buffer存储的数据是以二进制的形式。<br>Protocol-net只支持<a href="https://developers.google.com/protocol-buffers/docs/proto" target="_blank" rel="external">proto2的语言编写规范</a>。</p>
<p>从之前的学习可以知道的是，ProtoBuf通过自定义了Encode和Decode，使用Varint技术，把数据成功压缩更小，实现了更小的数据量存储。</p>
<p>———————————————-2018/04/22—————————————————-<br>关于ProtoBuf原理深度解析，这里找到一篇好文:<a href="https://www.jianshu.com/p/30ef9b3780d9" target="_blank" rel="external">Protocol Buffer 序列化原理大揭秘 - 为什么Protocol Buffer性能这么好？</a>———————————————-2018/04/22—————————————————-</p>
<h5 id="ProtoBuff导表工具">ProtoBuff导表工具</h5><p>相关语言及工具：<br>Python(独立于Unity，跨平台，方便写工具)<br>openpyxl(Python读取Excel的库)<br>ProtoBuff(解决了跨语言序列化反序列化的问题)<br>C#(Unity客户端使用的语言)</p>
<p>流程：</p>
<ol>
<li>定义excel表格格式规则</li>
<li>从excel中读取数据</li>
<li>根据数据类型，动态生成Python版和C#版的Proto文件</li>
<li>使用Python版的Proto文件生成序列化代码</li>
<li>利用Python的Proto代码序列化数据</li>
<li>运行时，通过生成的C#版序列化代码反序列化创建对应实例化对象</li>
</ol>
<p>好处:</p>
<ol>
<li>ProtoBuff解决了跨语言序列化反序列化的问题</li>
<li>使用Python解决了工具独立于Unity的问题，同时工具跨平台</li>
<li>ProtoBuff相比BinaryFormat速度更快，内存开销更小。(待验证)</li>
</ol>
<p>Note:<br>跨平台跨语言通信，很适合网络通信定义数据结构。(待学习)</p>
<h4 id="FlatBuff">FlatBuff</h4><p><a href="https://google.github.io/flatbuffers/" target="_blank" rel="external">官网FlatBuffer</a><br><a href="google.github.io/flatbuffers">Represents hierachical data in a flat binary buffer in such a way that it can still be acecssed directly without parsing/unpacking, while also still supporting data structure evolution(forwards/backwards compatibility)</a></p>
<p>Difference from Protocol Buffer?<br><a href="google.github.io/flatbuffers">FlatBuffers does not need a parsing/unpacking step to a secondary representation before you can access data, often coupled with per-object memory allocation.</a></p>
<p>先按教程学习使用一波，再来看看底层的实现和优缺点：</p>
<ol>
<li>编译Flatc<br>待续……</li>
</ol>
<h3 id="方案比较">方案比较</h3><p>不同的序列化反序列化库的优劣比较:</p>
<ol>
<li>自定义数据填充和读取<br>优点：</li>
</ol>
<p>缺点:</p>
<ol>
<li>ProtoBuff<br>优点：</li>
</ol>
<p>缺点:</p>
<ol>
<li>FlatBuff<br>优点：</li>
</ol>
<p>缺点:</p>
<p>待续…..</p>
<h2 id="实战">实战</h2><h2 id="总结">总结</h2><h1 id="Reference">Reference</h1><p><a href="blog.csdn.net/qq_14903317/article/details/78637440">Unity C#配置表工具</a><br><a href="https://github.com/ExcelDataReader/ExcelDataReader" target="_blank" rel="external">ExcelReader</a><br><a href="http://www.mamicode.com/info-detail-494944.html" target="_blank" rel="external">Unity3D游戏开发之当游戏开发遇上Excel</a><br><a href="http://www.xuanyusong.com/archives/2429" target="_blank" rel="external">Unity3D研究院之MAC&amp;Windows跨平台解析Excel（六十五）</a><br><a href="https://www.jianshu.com/p/30ef9b3780d9" target="_blank" rel="external">Protocol Buffer 序列化原理大揭秘 - 为什么Protocol Buffer性能这么好？</a></p>
  
	</div>
		<footer class="article-footer clearfix">
<div class="article-catetags">


</div>



	<div class="article-share" id="share">
	
	  <div data-url="http://tonytang1990.github.io/2018/03/18/Data-Config-Automation/" data-title="Data-Config-Automation | 走停人生路" data-tsina="null" class="share clearfix">
	  </div>
	
	</div>


</footer>

   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/2018/04/01/Unity-Tips/" title="Unity-Tips">
  <strong>上一篇：</strong><br/>
  <span>
  Unity-Tips</span>
</a>
</div>


<div class="next">
<a href="/2017/08/14/Lua-In-Unity/"  title="Lua_In_Unity">
 <strong>下一篇：</strong><br/> 
 <span>Lua_In_Unity
</span>
</a>
</div>

</nav>

	
<section id="comments" class="comment">
	<div class="ds-thread" data-thread-key="2018/03/18/Data-Config-Automation/" data-title="Data-Config-Automation" data-url="http://tonytang1990.github.io/2018/03/18/Data-Config-Automation/"></div>
</section>


</div>  
      <div class="openaside"><a class="navbutton" href="#" title="顯示側邊欄"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">文章目錄</strong>
 
 <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Introduction"><span class="toc-number">1.</span> <span class="toc-text">Introduction</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Data_Config"><span class="toc-number">2.</span> <span class="toc-text">Data Config</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#What"><span class="toc-number">2.1.</span> <span class="toc-text">What</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Why"><span class="toc-number">2.2.</span> <span class="toc-text">Why</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#How"><span class="toc-number">2.3.</span> <span class="toc-text">How</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Functional_Requirement(功能需求)"><span class="toc-number">2.3.1.</span> <span class="toc-text">Functional Requirement(功能需求)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#原理思考"><span class="toc-number">2.3.2.</span> <span class="toc-text">原理思考</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#方案选择"><span class="toc-number">2.3.3.</span> <span class="toc-text">方案选择</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#C#_-Net_BinaryFormatter"><span class="toc-number">2.3.3.1.</span> <span class="toc-text">C# .Net BinaryFormatter</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#问题"><span class="toc-number">2.3.3.1.1.</span> <span class="toc-text">问题</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ProtoBuff"><span class="toc-number">2.3.3.2.</span> <span class="toc-text">ProtoBuff</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#ProtoBuff学习了解"><span class="toc-number">2.3.3.2.1.</span> <span class="toc-text">ProtoBuff学习了解</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#ProtoBuff导表工具"><span class="toc-number">2.3.3.2.2.</span> <span class="toc-text">ProtoBuff导表工具</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#FlatBuff"><span class="toc-number">2.3.3.3.</span> <span class="toc-text">FlatBuff</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#方案比较"><span class="toc-number">2.3.4.</span> <span class="toc-text">方案比较</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#实战"><span class="toc-number">2.4.</span> <span class="toc-text">实战</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#总结"><span class="toc-number">2.5.</span> <span class="toc-text">总结</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Reference"><span class="toc-number">3.</span> <span class="toc-text">Reference</span></a></li></ol>
 
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隱藏側邊欄"></a></div>
<aside class="clearfix">

  
<div class="categorieslist">
	<p class="asidetitle">分類</p>
		<ul>
		
		  
			<li><a href="/categories/Algorithm/" title="Algorithm">Algorithm<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Android/" title="Android">Android<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Automation/" title="Automation">Automation<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Editor/" title="Editor">Editor<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Game-Engine/" title="Game_Engine">Game_Engine<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/Programming-Language/" title="Programming Language">Programming Language<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/Rendering/" title="Rendering">Rendering<sup>3</sup></a></li>
		  
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">標簽</p>
		<ul class="clearfix">
		
			
				<li><a href="/tags/Unity/" title="Unity">Unity<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/OpenGL/" title="OpenGL">OpenGL<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/Shader/" title="Shader">Shader<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Resource/" title="Resource">Resource<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Sort/" title="Sort">Sort<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Android/" title="Android">Android<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Python/" title="Python">Python<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Rendering/" title="Rendering">Rendering<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Editor/" title="Editor">Editor<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Programming/" title="Programming">Programming<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/AI/" title="AI">AI<sup>1</sup></a></li>
			
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">友情鏈接</p>
    <ul>
        
          <li>
            
            	<a href="https://coderq.com" target="_blank" title="一个面向程序员交流分享的新一代社区">码农圈</a>
            
          </li>
        
          <li>
            
            	<a href="http://wuchong.me" target="_blank" title="Jark&#39;s Blog">Jark&#39;s Blog</a>
            
          </li>
        
    </ul>
</div>

  


  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS 訂閱</a>
</div>

</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> Hello ,I&#39;m Tony Tang. <br/>
			This is my new blog.</p>
	</section>
	 
	<div class="social-font" class="clearfix">
		
		
		
		
		
		
		
		
		
		
	</div>
			
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Jacman">Jacman</a> © 2018 
		
		<a href="/about" target="_blank" title="Tony Tang">Tony Tang</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery.qrcode-0.12.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  c.click(function(){
    ta.css('display', 'block').addClass('fadeIn');
  });
  o.click(function(){
    ta.css('display', 'none');
  });
  $(window).scroll(function(){
    ta.css("top",Math.max(140,320-$(this).scrollTop()));
  });
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina'),
      description = $this.attr('description');
  var html = [
  '<div class="hoverqrcode clearfix"></div>',
  '<a class="overlay" id="qrcode"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="微信"></a>',
  '<a href="http://widget.renren.com/dialog/share?resourceUrl=' + encodedUrl + '&srcUrl=' + encodedUrl + '&title=' + title +'" class="article-share-renren" target="_blank" title="人人"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="微博"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);

  $('.hoverqrcode').hide();

  var myWidth = 0;
  function updatehoverqrcode(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
    var qrsize = myWidth > 1024 ? 200:100;
    var options = {render: 'image', size: qrsize, fill: '#2ca6cb', text: url, radius: 0.5, quiet: 1};
    var p = $('.article-share-qrcode').position();
    $('.hoverqrcode').empty().css('width', qrsize).css('height', qrsize)
                          .css('left', p.left-qrsize/2+20).css('top', p.top-qrsize-10)
                          .qrcode(options);
  };
  $(window).resize(function(){
    $('.hoverqrcode').hide();
  });
  $('.article-share-qrcode').click(function(){
    updatehoverqrcode();
    $('.hoverqrcode').toggle();
  });
  $('.article-share-qrcode').hover(function(){}, function(){
      $('.hoverqrcode').hide();
  });
});   
</script>



<script type="text/javascript">
  var duoshuoQuery = {short_name:"TonyTang1990"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
    || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
</script> 







<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->





<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="返回頂部"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
</html>
