
 <!DOCTYPE HTML>
<html >
<head>
  <meta charset="UTF-8">
  
    <title>Data-Config-Automation | 走停人生路</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="Tony Tang">
    

    
    <meta name="description" content="Introduction游戏开发过程中，避免不了和数据打交道，数据是游戏最基础也是很重要的一部分。本篇文章正式为了学习了解游戏开发过程中关于数据配置自动化导表生成代码等一系列自动化相关的知识而写。
Data ConfigWhat数据配置 — 策划通过类似Excel或者其他方式配置出游戏里需要的数据，程序通过读取这些数据让游戏根据数据驱动运行起来，这正是我们所谓的数据配置。
Why那么为什么需要数据">
<meta property="og:type" content="article">
<meta property="og:title" content="Data-Config-Automation">
<meta property="og:url" content="http://tonytang1990.github.io/2018/03/18/Data-Config-Automation/index.html">
<meta property="og:site_name" content="走停人生路">
<meta property="og:description" content="Introduction游戏开发过程中，避免不了和数据打交道，数据是游戏最基础也是很重要的一部分。本篇文章正式为了学习了解游戏开发过程中关于数据配置自动化导表生成代码等一系列自动化相关的知识而写。
Data ConfigWhat数据配置 — 策划通过类似Excel或者其他方式配置出游戏里需要的数据，程序通过读取这些数据让游戏根据数据驱动运行起来，这正是我们所谓的数据配置。
Why那么为什么需要数据">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/ExcelDataConfig.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/DataConfigData.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/DataConfigResult.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/CustomSerializationPerformance.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/DefaultSerializationPerformance.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/UntiyDotNetVersion.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/Unity2017DotNetVersion.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/ProtocolBufferMessageValueType.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/ProtobufSerializerSerialize.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/ProtobufSerializerWrite.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/Data-Config-Automation/Protobuf3DotNetTargetNumber.png">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/Unity2017DotNetVersion.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/Data-Config-Automation/CompileProtobufCsharpForDoNet35.png">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/Data-Config-Automation/DoNet35ProtobufCsharpDll.png">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/Data-Config-Automation/ProtobufSerialization.png">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/Data-Config-Automation/ProtobufSerializationAndroidPlatform.png">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/Data-Config-Automation/InstallProtobuf3EnviromentForPython.png">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/Data-Config-Automation/PythonPB3DeserilizationFileStructure.png">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/Data-Config-Automation/PythonPB3Deserialization.png">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/Data-Config-Automation/CSharpPB3DeserilizationFileStructure.png">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/Data-Config-Automation/CSharpPB3Deserialization.png">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/Data-Config-Automation/SerializationPerformanceComparision.png">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/Data-Config-Automation/FlatBuffPerformanceBenchmark.png">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/Data-Config-Automation/FlatBuffGameConfigDataOutput.png">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/Data-Config-Automation/FlatBuffOutput.png">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/Data-Config-Automation/FlatBufferBytesStructure.png">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/Data-Config-Automation/SerializationPerformanceComparision.png">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/Data-Config-Automation/XbufferData.png">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/Data-Config-Automation/XbufferOutput.png">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/Data-Config-Automation/LoadXMLConfig.png">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/Data-Config-Automation/ExcelDatOutput.png">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/Data-Config-Automation/IntegrateXbuffer.png">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/Data-Config-Automation/ModifyXbufferOutputPath.png">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/Data-Config-Automation/CompileXbufferCSProjects.png">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/Data-Config-Automation/ExcelDataLoadAndPrint.png">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/Data-Config-Automation/AndroidDeviceExcelDataLoadAndPrint.png">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/Data-Config-Automation/XbufferExcelToDataTimeConsume.png">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/Data-Config-Automation/Profiler_GetMonoUsedSizeLong_MemoryUsing.png">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/Data-Config-Automation/AndroidDevice_Profiler_GetMonoUsedSizeLong_MemoryUsing.png">
<meta property="og:updated_time" content="2018-09-08T14:35:00.486Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Data-Config-Automation">
<meta name="twitter:description" content="Introduction游戏开发过程中，避免不了和数据打交道，数据是游戏最基础也是很重要的一部分。本篇文章正式为了学习了解游戏开发过程中关于数据配置自动化导表生成代码等一系列自动化相关的知识而写。
Data ConfigWhat数据配置 — 策划通过类似Excel或者其他方式配置出游戏里需要的数据，程序通过读取这些数据让游戏根据数据驱动运行起来，这正是我们所谓的数据配置。
Why那么为什么需要数据">

    
    <link rel="alternative" href="/atom.xml" title="走停人生路" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/jacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/jacman.jpg">
    
    <link rel="stylesheet" href="/css/style.css" type="text/css">
</head>

  <body>
    <header>
      
<div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.jpg" alt="走停人生路" title="走停人生路"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="走停人生路">走停人生路</a></h1>
				<h2 class="blog-motto">有时候不是习惯了一个人，而是在没有认可自己之前选择了一个人</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜單">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">Home</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
						<li><a href="/about">About</a></li>
					
					<li>
 					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="search" id="search" name="q" autocomplete="off" maxlength="20" placeholder="搜索" />
						<input type="hidden" name="q" value="site:tonytang1990.github.io">
					</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
  
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2018/03/18/Data-Config-Automation/" title="Data-Config-Automation" itemprop="url">Data-Config-Automation</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Tony Tang" target="_blank" itemprop="author">Tony Tang</a>
		
  <p class="article-time">
    <time datetime="2018-03-18T04:30:52.000Z" itemprop="datePublished"> 發表於 2018-03-18</time>
    
  </p>
</header>
	<div class="article-content">
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">文章目錄</strong>
		
			<ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Introduction"><span class="toc-number">1.</span> <span class="toc-text">Introduction</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Data_Config"><span class="toc-number">2.</span> <span class="toc-text">Data Config</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#What"><span class="toc-number">2.1.</span> <span class="toc-text">What</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Why"><span class="toc-number">2.2.</span> <span class="toc-text">Why</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#How"><span class="toc-number">2.3.</span> <span class="toc-text">How</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Functional_Requirement(功能需求)"><span class="toc-number">2.3.1.</span> <span class="toc-text">Functional Requirement(功能需求)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#原理思考"><span class="toc-number">2.3.2.</span> <span class="toc-text">原理思考</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#方案比较"><span class="toc-number">2.3.3.</span> <span class="toc-text">方案比较</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#C#_-Net_BinaryFormatter"><span class="toc-number">2.3.3.1.</span> <span class="toc-text">C# .Net BinaryFormatter</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#问题"><span class="toc-number">2.3.3.1.1.</span> <span class="toc-text">问题</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ProtoBuff"><span class="toc-number">2.3.3.2.</span> <span class="toc-text">ProtoBuff</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#ProtoBuff学习了解"><span class="toc-number">2.3.3.2.1.</span> <span class="toc-text">ProtoBuff学习了解</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Protocol_Buffer_3_in_Unity"><span class="toc-number">2.3.3.2.2.</span> <span class="toc-text">Protocol Buffer 3 in Unity</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#FlatBuff"><span class="toc-number">2.3.3.3.</span> <span class="toc-text">FlatBuff</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#介绍"><span class="toc-number">2.3.3.3.1.</span> <span class="toc-text">介绍</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#实战使用"><span class="toc-number">2.3.3.3.2.</span> <span class="toc-text">实战使用</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#深入探究"><span class="toc-number">2.3.3.3.3.</span> <span class="toc-text">深入探究</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Xbuffer"><span class="toc-number">2.3.3.4.</span> <span class="toc-text">Xbuffer</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#实战使用-1"><span class="toc-number">2.3.3.4.1.</span> <span class="toc-text">实战使用</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#深入探究-1"><span class="toc-number">2.3.3.4.2.</span> <span class="toc-text">深入探究</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#xbuffer_parser"><span class="toc-number">2.3.3.4.2.1.</span> <span class="toc-text">xbuffer_parser</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#xbuffer_runtime"><span class="toc-number">2.3.3.4.2.2.</span> <span class="toc-text">xbuffer_runtime</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#方案比较-1"><span class="toc-number">2.3.4.</span> <span class="toc-text">方案比较</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#实战"><span class="toc-number">2.4.</span> <span class="toc-text">实战</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#方案选择"><span class="toc-number">2.4.1.</span> <span class="toc-text">方案选择</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#基于Xbuffer的导表工具"><span class="toc-number">2.4.2.</span> <span class="toc-text">基于Xbuffer的导表工具</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#导表功能需求"><span class="toc-number">2.4.2.1.</span> <span class="toc-text">导表功能需求</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#支持导表路径配置"><span class="toc-number">2.4.2.2.</span> <span class="toc-text">支持导表路径配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#定义表格规则"><span class="toc-number">2.4.2.3.</span> <span class="toc-text">定义表格规则</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#读取excel数据"><span class="toc-number">2.4.2.4.</span> <span class="toc-text">读取excel数据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#创建对应数据结构文件"><span class="toc-number">2.4.2.5.</span> <span class="toc-text">创建对应数据结构文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#生成序列化所需文件"><span class="toc-number">2.4.2.6.</span> <span class="toc-text">生成序列化所需文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#序列化数据"><span class="toc-number">2.4.2.7.</span> <span class="toc-text">序列化数据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#统一表格数据加载和读取"><span class="toc-number">2.4.2.8.</span> <span class="toc-text">统一表格数据加载和读取</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#读取序列化数据"><span class="toc-number">2.4.2.9.</span> <span class="toc-text">读取序列化数据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#性能和内存开销"><span class="toc-number">2.4.2.10.</span> <span class="toc-text">性能和内存开销</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#优化点"><span class="toc-number">2.4.2.11.</span> <span class="toc-text">优化点</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Github"><span class="toc-number">2.4.2.12.</span> <span class="toc-text">Github</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#学习总结"><span class="toc-number">2.4.2.13.</span> <span class="toc-text">学习总结</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#总结"><span class="toc-number">2.5.</span> <span class="toc-text">总结</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Reference"><span class="toc-number">3.</span> <span class="toc-text">Reference</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Conception_Part"><span class="toc-number">3.1.</span> <span class="toc-text">Conception Part</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Knowlodge_Part"><span class="toc-number">3.2.</span> <span class="toc-text">Knowlodge Part</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Other_Part"><span class="toc-number">3.3.</span> <span class="toc-text">Other Part</span></a></li></ol></li></ol>
		
		</div>
		
		<h1 id="Introduction">Introduction</h1><p>游戏开发过程中，避免不了和数据打交道，数据是游戏最基础也是很重要的一部分。本篇文章正式为了学习了解游戏开发过程中关于数据配置自动化导表生成代码等一系列自动化相关的知识而写。</p>
<h1 id="Data_Config">Data Config</h1><h2 id="What">What</h2><p>数据配置 — 策划通过类似Excel或者其他方式配置出游戏里需要的数据，程序通过读取这些数据让游戏根据数据驱动运行起来，这正是我们所谓的数据配置。</p>
<h2 id="Why">Why</h2><p>那么为什么需要数据配置了？</p>
<ol>
<li>数据是游戏最基本的单位 — 无论是炫酷的特效还是惊人的AI都是通过读取底层数据最终得出结论的。</li>
<li>协同工作 — 这里说的数据配置更多的是游戏逻辑层的数据，即类似游戏里的对话显示，背包单位格子数量上限等配置。有了数据配置，程序和策划很容易协同工作，程序负责数据读取实现功能，策划负责具体的数据配置实现想要的效果。</li>
<li>多语言显示 — 数据配置用于语言包显示也帮助我们很方便的实现多语言的版本(读取不同语言版本的数据配置即可)。</li>
</ol>
<h2 id="How">How</h2><p>实现数据配置读取原理上是把数据序列化导出保存在本地(.xml, .json .bytes……)，然后通过反序列化读取回来。<br>这里我们不单单是针对个别数据进行序列化反序列化。这里要实现的是一个针对表格配置，可以动态生成支持反序列化读取(非反射机制)读取到程序里的工具。</p>
<p>序列化相关知识学习参考<a href="http://tonytang1990.github.io/2015/08/15/CSharp-Study/#Runtime_Serialization">Runtime Serialization</a><br>PC端Excel读取库选择参考:<a href="http://tonytang1990.github.io/2015/07/15/Unity-Study/#Excel数据读取">Excel数据读取</a></p>
<p>Note:<br>这里注意反射和反序列化不是一回事，反序列化可以用反射也可以不用反射来实现。</p>
<h3 id="Functional_Requirement(功能需求)">Functional Requirement(功能需求)</h3><ol>
<li>支持int，float，string基础数据配置</li>
<li>支持大于一个维度的数据读取(多余一个的数据)快速读取(比如配置:1;2;3;4分别代表物体随机的生命值选项)(这个算是<strong>基础需求功能</strong>)</li>
<li>支持列表数据自定义数据结构快速读取(<strong>高阶功能需求</strong>，方便列表数据复杂的时候能够抽象成数据结构快速读取。)<br>实际需求举列:<br>我们配置一个道具不同等级的属性加成数据：1+200|2+300;3+400|4+500|5+600 表示第一级加属性id为1的属性加200并且，属性id为2的加300。第二季加属性id为3,4,5的分别加400,500,600)<br>如果我们不能动态创建自定义结构数据，那么我们就需要在代码里写string.split()这种形式的分割数据去判定读取，不论是从性能开销还是代码编写都是很不划算的。<br>如果我们能自动创建自定义结构，生成如下代码:<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title">Property</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> Id</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">set</span>;        </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> Value</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Property[0].Length : 2</span></span><br><span class="line"><span class="comment">// Proeprty[1].Length : 3</span></span><br><span class="line">Property[<span class="number">2</span>][] mPropertyArray;   <span class="comment">// 存储表格数据的成员</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>那么我们就能方便的编写代码去访问特定等级所加成的属性了：<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//快速访问特定等级所加成的属性值</span></span><br><span class="line">mPropertyArray[<span class="number">1</span>][<span class="number">2</span>]表示第二级所加成的第二个属性数据</span><br></pre></td></tr></table></figure></p>
<pre><code>扩展内嵌多层的话<span class="comment">(这样的需求应该很少，这里暂时就不考虑了)</span>，此方案需要扩展多维数组来支持，并不是很友好
</code></pre><ol>
<li>支持自动生成读表相关代码</li>
<li>内存开销要控制，读取速度要快</li>
<li>跨平台</li>
<li>跨语言</li>
<li>独立于Unity的工具(后期优化部分)</li>
<li>前后端表格数据区分(后期优化部分)(因为前后端往往是读不同的数据，并不需要导同一套表格数据)</li>
</ol>
<h3 id="原理思考">原理思考</h3><p>流程：</p>
<ol>
<li>定义excel表格格式规则(这一步会影响后面所有步骤)</li>
<li>读取excel数据</li>
<li>生成可跨平台跨语言的序列化代码</li>
<li>序列化写入excel数据(这一步涉及跨语言问题)</li>
<li>反序列化读取数据</li>
</ol>
<ul>
<li><p>定义excel表格格式规则<br>这一步要决定我们excel长什么样子，决定不同数据不同的行号字段代表什么。</p>
</li>
<li><p>读取excel数据<br>通过第三方库(比如PC端跨平台的<a href="http://exceldatareader.codeplex.com/" target="_blank" rel="external">ExcelRead</a>)可以解决读取问题。</p>
</li>
<li><p>生成跨平台跨语言的序列化反序列化代码<br>这一步的重点在于跨平台和<br>跨平台这一点肯定不用说，要想在PC端序列化的数据在移动端使用，这一点是必须的也并不是难点。<br><strong>跨语言</strong>这一点上，试想如果前后端用的语言不同，但前后端想共用一份导表工具来生成需要的表格数据，那么跨语言这一点就是必须的了。<br>序列化数据和反序列化数据时，我们需要考虑跨语言的问题，后续的方案中就会强调这一点。</p>
</li>
<li><p>序列化写入excel数据<br>写入数据也就是序列化的过程，解决了前面提到的跨语言生成序列化代码问题后，这个问题也就迎刃而解。</p>
</li>
<li><p>反序列化读取数据<br>读数据就是反序列化的过程，同理序列化，解决了跨语言生成序列化代码的问题，这个问题依然不是问题。</p>
</li>
</ul>
<h3 id="方案比较">方案比较</h3><ol>
<li>C# .Net BinaryFormatter(不夸语言，序列化后数据相对大，反序列化费时且内存开销大)</li>
<li>ProtoBuff(跨语言，序列化数据相对小，反序列化费时和内存开销相对好点。工具成熟，社区完善，自定义数据结构方便)</li>
<li>FlatBuff(跨语言，序列化数据小，反序列化费时少，编写自定义序列化和反序列化数据结构不方便)</li>
<li>XBuffer(之前一位同事写的基于C#的简化版FlatBuff，高效且高度支持扩展和配置)</li>
</ol>
<p>接下来针对各个方案进行简单学习，理解各自的优缺点。</p>
<h4 id="C#_-Net_BinaryFormatter">C# .Net BinaryFormatter</h4><p>参考这篇文章：<a href="blog.csdn.net/qq_14903317/article/details/78637440">Unity C#配置表工具</a></p>
<p>我们可以看到，我们需要做的事情有以下几步：</p>
<ol>
<li>定义excel表格格式规则</li>
<li>从excel中读取数据</li>
<li>根据数据类型，动态生成每个表的C#类(用于反序列化读取数据)</li>
<li>动态编译C#类，输出一个动态库以及相关代码</li>
<li>实例化C#类，并且把数据填入到实例化对象中，序列化数据，保存在Untiy本地Resources目录中</li>
<li>运行时，通过生成的C#类反序列化加载并创建对应实例化对象去存储数据</li>
</ol>
<p>Utilities.cs<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Diagnostics;</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> System.Runtime.Serialization.Formatters.Binary;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="xmlDocTag">///</span> 工具静态类</span></span><br><span class="line"><span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">Utilities</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> 本机打开特定目录(暂时只用于Windows)</span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="folderPath"&gt;</span><span class="xmlDocTag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">OpenFolder</span>(<span class="params"><span class="keyword">string</span> folderPath</span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (Directory.Exists(folderPath))</span><br><span class="line">        &#123;</span><br><span class="line">            ProcessStartInfo startInfo = <span class="keyword">new</span> ProcessStartInfo(folderPath, <span class="string">"explorer.exe"</span>);</span><br><span class="line">            Process.Start(startInfo);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            UnityEngine.Debug.LogError(<span class="keyword">string</span>.Format(<span class="string">"&#123;0&#125; Directory does not exist!"</span>, folderPath));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> 检查指定目录是否存在，不存在创建一个</span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">checkOrCreateSpecificFolder</span>(<span class="params"><span class="keyword">string</span> folderpath</span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!Directory.Exists(folderpath))</span><br><span class="line">        &#123;</span><br><span class="line">            Directory.CreateDirectory(folderpath);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> 无论目录是否存在都删除所有文件重新创建一个目录</span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">recreateSpecificFolder</span>(<span class="params"><span class="keyword">string</span> folderpath</span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (Directory.Exists(folderpath))</span><br><span class="line">        &#123;</span><br><span class="line">            Directory.Delete(folderpath, <span class="keyword">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        Directory.CreateDirectory(folderpath);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> 获取文件的目录名字</span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="filepath"&gt;</span><span class="xmlDocTag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;returns&gt;</span><span class="xmlDocTag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">string</span> <span class="title">getFileFolderName</span>(<span class="params"><span class="keyword">string</span> filepath</span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Path.GetFileName(Path.GetDirectoryName(filepath));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>PathUtilites.cs<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="xmlDocTag">///</span> 路径静态工具类</span></span><br><span class="line"><span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">PathUtilties</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="preprocessor">#<span class="keyword">region</span> Excel Data</span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> Excel数据文件夹目录路径</span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">string</span> ExcelFileFolderPath = Application.dataPath + <span class="string">"/../ExcelDatas/Game/"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> Excel数据生成的对应代码目录</span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> Note:</span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> 因为序列化反序列化时要求Assemble信息一致，所以如果反序列化使用Unity 编译后的C#无法成功反序列化</span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> BinderToType低版本.Net可以用但BinderToName要求.Net 4.0</span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> 所以这里放弃了直接生成新的cs表代码通过Unity编译使用的方案，选择依然采用直接编译表代码成dll来使用</span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> 表代码依然生成，但放到Asset外部作为非有效代码存储方便查看</span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> 参考:</span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> https://stackoverflow.com/questions/505611/binary-deserialization-with-different-assembly-version</span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> https://www.codeproject.com/Tips/1101106/How-to-serialize-across-assemblies-with-the-Binary</span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">string</span> ExcelScriptOutputFolderPath = Application.dataPath + <span class="string">"/../DataConfigScripts/"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> Excel数据序列化后的文件名</span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">string</span> ExcelDataFileName = <span class="string">"dataconfig.byte"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> Excel数据序列化后的数据文件存储目录</span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">string</span> ExcelDataFileOutputFolderPath = Application.dataPath + <span class="string">"/Resources/DataConfig/"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> Excel数据序列化后的数据文件相对于Resource目录的相对目录</span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">string</span> ExcelDataFileOutputFolderRelativePath = <span class="string">"DataConfig/"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> Excel数据生成的对应Assembly&amp;Script临时文件临时目录</span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">string</span> ExcelScriptAssemblyFilePath = Application.dataPath + <span class="string">"/Scripts/Core/DataConfig/"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> Excel数据生成的对应Assembly临时文件名</span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">string</span> ExcelScriptAssemblyFileName = <span class="string">"dataconfig.dll"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> 表格代码文件后缀</span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">string</span> ExcelScriptFilePostFix = <span class="string">".cs"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> 表格生成数据管理读取代码文件名</span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">string</span> ExcelScriptDataManagerFileName = <span class="string">"DataManager.cs"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> 表代码Container后缀名</span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">string</span> ExcelTableContainerPostfix = <span class="string">"Container"</span>;</span><br><span class="line">    <span class="preprocessor">#<span class="keyword">endregion</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>ExportExcelData.cs<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> UnityEditor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> Excel;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> System.Data;</span><br><span class="line"><span class="keyword">using</span> System.Reflection;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"><span class="keyword">using</span> Microsoft.CSharp;</span><br><span class="line"><span class="keyword">using</span> System.CodeDom.Compiler;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Runtime.Serialization.Formatters.Binary;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="xmlDocTag">///</span> 表格数据抽象</span></span><br><span class="line"><span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ConfigData</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> 数据类型</span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">string</span> Type;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> 字段名字</span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">string</span> Name;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> 数据</span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">string</span> Data;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="xmlDocTag">///</span> 导表工具</span></span><br><span class="line"><span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ExportExcelData</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> 字段名行号</span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">const</span> <span class="keyword">int</span> NameLineNumber = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> 字段类型行号</span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">const</span> <span class="keyword">int</span> TypeLineNumber = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> 数据开始行号</span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">const</span> <span class="keyword">int</span> DataLineNumber = <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> 有效的数据类型</span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> List&lt;<span class="keyword">string</span>&gt; ValideTypesList =  <span class="keyword">new</span> List&lt;<span class="keyword">string</span>&gt;(<span class="keyword">new</span> <span class="keyword">string</span>[]&#123;<span class="string">"int"</span>, <span class="string">"float"</span>, <span class="string">"string"</span>&#125;);</span><br><span class="line"></span><br><span class="line">    [MenuItem(<span class="string">"Tools/DataConfig/导出所有表格数据"</span>, <span class="keyword">false</span>, <span class="number">100</span>)]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">exportAllExcelData</span>(<span class="params"></span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">string</span>[] excelfiles = Directory.GetFiles(PathUtilties.ExcelFileFolderPath, <span class="string">"*.xlsx"</span>);</span><br><span class="line">        <span class="comment">// 表格数据映射Map</span></span><br><span class="line">        <span class="comment">// Key为表格名字</span></span><br><span class="line">        <span class="comment">// Value为表格对应的数据列表，List的每一个元素代表一行的数据数组</span></span><br><span class="line">        Dictionary&lt;<span class="keyword">string</span>, List&lt;ConfigData[]&gt;&gt; datadic = <span class="keyword">new</span> Dictionary&lt;<span class="keyword">string</span>, List&lt;ConfigData[]&gt;&gt;();</span><br><span class="line">        <span class="comment">// 字段信息map</span></span><br><span class="line">        <span class="comment">// Key为表格名字</span></span><br><span class="line">        <span class="comment">// Value为对应表格的字段数据</span></span><br><span class="line">        Dictionary&lt;<span class="keyword">string</span>, <span class="keyword">string</span>[]&gt; namedic = <span class="keyword">new</span> Dictionary&lt;<span class="keyword">string</span>, <span class="keyword">string</span>[]&gt;();</span><br><span class="line">        <span class="comment">// 字段类型信息map</span></span><br><span class="line">        <span class="comment">// Key为表格名字</span></span><br><span class="line">        <span class="comment">// Value为对应表格的字段类型数据</span></span><br><span class="line">        Dictionary&lt;<span class="keyword">string</span>, <span class="keyword">string</span>[]&gt; typedic = <span class="keyword">new</span> Dictionary&lt;<span class="keyword">string</span>, <span class="keyword">string</span>[]&gt;();</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> excelfile <span class="keyword">in</span> excelfiles)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(!readAllDataFromExcelFile(excelfile, <span class="keyword">ref</span> datadic, <span class="keyword">ref</span> typedic, <span class="keyword">ref</span> namedic))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 表格代码映射map</span></span><br><span class="line">        <span class="comment">// Key为类名字，Value为对应代码数据</span></span><br><span class="line">        Dictionary&lt;<span class="keyword">string</span>, <span class="keyword">string</span>&gt; codemap = <span class="keyword">new</span> Dictionary&lt;<span class="keyword">string</span>, <span class="keyword">string</span>&gt;();</span><br><span class="line">        <span class="comment">//根据刚才记录的每一张表格数据生成对应代码数据</span></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> data <span class="keyword">in</span> datadic)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">string</span> classname = data.Key;</span><br><span class="line">            DataConfigScriptGenerator dcsg = <span class="keyword">new</span> DataConfigScriptGenerator(classname, typedic[classname], namedic[classname]);</span><br><span class="line">            codemap.Add(classname, dcsg.generateCode());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//删除前一次所有相关文件</span></span><br><span class="line">        Utilities.recreateSpecificFolder(PathUtilties.ExcelScriptOutputFolderPath);</span><br><span class="line">        Utilities.recreateSpecificFolder(PathUtilties.ExcelDataFileOutputFolderPath);</span><br><span class="line">        Utilities.recreateSpecificFolder(PathUtilties.ExcelScriptAssemblyFilePath);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//生成dll，Assemble文件用于序列化数据</span></span><br><span class="line">        <span class="keyword">string</span>[] scripts = <span class="keyword">new</span> <span class="keyword">string</span>[codemap.Values.Count];</span><br><span class="line">        codemap.Values.CopyTo(scripts, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">var</span> assemblyfilepath = PathUtilties.ExcelScriptAssemblyFilePath + PathUtilties.ExcelScriptAssemblyFileName;</span><br><span class="line">        Assembly assembly = compileCode(scripts, assemblyfilepath);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (assembly == <span class="keyword">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">"编译dll失败！"</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//使用Assemble序列化数据</span></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> data <span class="keyword">in</span> datadic)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">object</span> container = assembly.CreateInstance(data.Key + <span class="string">"Container"</span>);</span><br><span class="line">            Type classtype = assembly.GetType(data.Key);</span><br><span class="line">            <span class="keyword">if</span> (!serialize(container, classtype, data.Value, PathUtilties.ExcelDataFileOutputFolderPath))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 生成对应Manager加载管理的cs代码文件</span></span><br><span class="line">        createDataManager(assembly, PathUtilties.ExcelScriptAssemblyFilePath);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 生成对应cs代码文件(如果删除dll，使用cs编译的Assembly-CSharp.dll会导致反序列化出问题。猜测是因为Assemly名字改变后，默认的序列化和反序列化的部分信息(e.g. 比如assembly name)对不上。)</span></span><br><span class="line">        <span class="comment">// 所以这里生成的代码仅供查看，释放到Asset上层目录的</span></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> code <span class="keyword">in</span> codemap)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">using</span> (FileStream fs = File.Create(PathUtilties.ExcelScriptOutputFolderPath + code.Key + PathUtilties.ExcelScriptFilePostFix))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">byte</span>[] info = <span class="keyword">new</span> UTF8Encoding(<span class="keyword">true</span>).GetBytes(code.Value);</span><br><span class="line">                fs.Write(info, <span class="number">0</span>, info.Length);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//删除Assemble文件</span></span><br><span class="line">        <span class="comment">//File.Delete(assemblyfilepath);</span></span><br><span class="line"></span><br><span class="line">        AssetDatabase.Refresh();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> 读取excel里所有数据</span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="excelfile"&gt;</span>excel文件<span class="xmlDocTag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="datadic"&gt;</span>表格数据<span class="xmlDocTag">&lt;/param&gt;</span>]</span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="names"&gt;</span>字段数据<span class="xmlDocTag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="typs"&gt;</span>类型数据<span class="xmlDocTag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;returns&gt;</span><span class="xmlDocTag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">readAllDataFromExcelFile</span>(<span class="params"><span class="keyword">string</span> excelfile, <span class="keyword">ref</span> Dictionary&lt;<span class="keyword">string</span>, List&lt;ConfigData[]&gt;&gt; datadic, <span class="keyword">ref</span> Dictionary&lt;<span class="keyword">string</span>, <span class="keyword">string</span>[]&gt; typesmap, <span class="keyword">ref</span> Dictionary&lt;<span class="keyword">string</span>, <span class="keyword">string</span>[]&gt; namesmap</span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        Debug.Log(<span class="keyword">string</span>.Format(<span class="string">"excelfile: &#123;0&#125;"</span>, excelfile));</span><br><span class="line">        FileStream fs = File.Open(excelfile, FileMode.Open, FileAccess.Read);</span><br><span class="line">        IExcelDataReader excelreader = ExcelReaderFactory.CreateOpenXmlReader(fs);</span><br><span class="line">        <span class="keyword">if</span> (!excelreader.IsValid)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="keyword">string</span>.Format(<span class="string">"Excel文件:&#123;0&#125;读取失败！"</span>, excelfile));</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            Debug.Log(<span class="keyword">string</span>.Format(<span class="string">"Excel文件.Name:&#123;0&#125;"</span>, excelreader.Name));</span><br><span class="line">            <span class="keyword">var</span> dataset = excelreader.AsDataSet();</span><br><span class="line">            <span class="keyword">if</span> (dataset.Tables.Count &gt; <span class="number">1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                Debug.LogError(<span class="keyword">string</span>.Format(<span class="string">"Excel文件:&#123;0&#125;,不允许一个Excel多张Table!"</span>, excelreader.Name));</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="function"><span class="keyword">else</span> <span class="title">if</span> (<span class="params">datadic.ContainsKey(excelreader.Name</span>))</span><br><span class="line">            </span>&#123;</span><br><span class="line">                Debug.LogError(<span class="keyword">string</span>.Format(<span class="string">"有同名的Excel Table存在!同名Excel:&#123;0&#125;!"</span>, excelreader.Name));</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">int</span> currentlinenumber = <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">string</span>[] types = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">string</span>[] names = <span class="keyword">null</span>;</span><br><span class="line">                datadic.Add(excelreader.Name, <span class="keyword">new</span> List&lt;ConfigData[]&gt;());</span><br><span class="line">                <span class="keyword">while</span>(excelreader.Read())</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//读取每一行的数据</span></span><br><span class="line">                    <span class="keyword">string</span>[] datas = <span class="keyword">new</span> <span class="keyword">string</span>[excelreader.FieldCount];</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; excelreader.FieldCount; i++)</span><br><span class="line">                    &#123;</span><br><span class="line">                        datas[i] = excelreader.GetString(i);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 字段信息</span></span><br><span class="line">                    <span class="keyword">if</span> (currentlinenumber == NameLineNumber)</span><br><span class="line">                    &#123;</span><br><span class="line">                        names = datas;</span><br><span class="line">                        <span class="keyword">if</span>(checkRepeatedNameString(names))</span><br><span class="line">                        &#123;</span><br><span class="line">                            Debug.LogError(<span class="keyword">string</span>.Format(<span class="string">"Excel Table:&#123;0&#125;"</span>, excelreader.Name));</span><br><span class="line">                            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        namesmap.Add(excelreader.Name, names);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// 字段类型信息</span></span><br><span class="line">                    <span class="function"><span class="keyword">else</span> <span class="title">if</span>(<span class="params">currentlinenumber == TypeLineNumber</span>)</span><br><span class="line">                    </span>&#123;</span><br><span class="line">                        types = datas;</span><br><span class="line">                        <span class="keyword">if</span> (checkInvalideType(types))</span><br><span class="line">                        &#123;</span><br><span class="line">                            Debug.LogError(<span class="keyword">string</span>.Format(<span class="string">"Excel Table:&#123;0&#125;"</span>, excelreader.Name));</span><br><span class="line">                            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        typesmap.Add(excelreader.Name, types);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="function"><span class="keyword">else</span> <span class="title">if</span>(<span class="params">currentlinenumber &gt;= DataLineNumber</span>)</span><br><span class="line">                    </span>&#123;</span><br><span class="line">                        <span class="comment">// 记录每一行所有数据的字段名，字段类型，字段数据</span></span><br><span class="line">                        ConfigData[] configdatas = <span class="keyword">new</span> ConfigData[datas.Length];</span><br><span class="line">                        <span class="keyword">for</span>(<span class="keyword">int</span> m = <span class="number">0</span>; m &lt; datas.Length; m++)</span><br><span class="line">                        &#123;</span><br><span class="line">                            ConfigData cd = <span class="keyword">new</span> ConfigData();</span><br><span class="line">                            cd.Type = types[m];</span><br><span class="line">                            cd.Name = names[m];</span><br><span class="line">                            cd.Data = datas[m];</span><br><span class="line">                            <span class="keyword">if</span>(<span class="keyword">string</span>.IsNullOrEmpty(cd.Type))</span><br><span class="line">                            &#123;</span><br><span class="line">                                Debug.LogError(<span class="keyword">string</span>.Format(<span class="string">"数据第&#123;0&#125;行，第&#123;1&#125;列字段类型不能为空!"</span>, currentlinenumber, m));</span><br><span class="line">                                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="function"><span class="keyword">else</span> <span class="title">if</span>(<span class="params"><span class="keyword">string</span>.IsNullOrEmpty(cd.Name</span>))</span><br><span class="line">                            </span>&#123;</span><br><span class="line">                                Debug.LogError(<span class="keyword">string</span>.Format(<span class="string">"数据第&#123;0&#125;行，第&#123;1&#125;列字段名字不能为空!"</span>, currentlinenumber, m));</span><br><span class="line">                                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                            configdatas[m] = cd;</span><br><span class="line">                        &#125;</span><br><span class="line">                        datadic[excelreader.Name].Add(configdatas);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        Debug.LogError(<span class="keyword">string</span>.Format(<span class="string">"无效的行号:&#123;0&#125;"</span>, currentlinenumber));</span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    currentlinenumber++;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> 检查是否有重复的字段名</span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="names"&gt;</span><span class="xmlDocTag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;returns&gt;</span><span class="xmlDocTag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">checkRepeatedNameString</span>(<span class="params"><span class="keyword">string</span>[] names</span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> tempdic = <span class="keyword">new</span> Dictionary&lt;<span class="keyword">string</span>, <span class="keyword">string</span>&gt;();</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> name <span class="keyword">in</span> names)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (tempdic.ContainsKey(name))</span><br><span class="line">            &#123;</span><br><span class="line">                Debug.LogError(<span class="keyword">string</span>.Format(<span class="string">"同名字段:&#123;0&#125;!"</span>, name));</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                tempdic.Add(name, name);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> 检查是否有无效的字段类型</span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="types"&gt;</span><span class="xmlDocTag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;returns&gt;</span><span class="xmlDocTag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">checkInvalideType</span>(<span class="params"><span class="keyword">string</span>[] types</span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">foreach</span>(<span class="keyword">var</span> type <span class="keyword">in</span> types)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(!ValideTypesList.Contains(type))</span><br><span class="line">            &#123;</span><br><span class="line">                Debug.LogError(<span class="keyword">string</span>.Format(<span class="string">"无效类型:&#123;0&#125;"</span>, type));</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> 编译代码到dll</span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="scripts"&gt;</span><span class="xmlDocTag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="outputfile"&gt;</span><span class="xmlDocTag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;returns&gt;</span>返回Assembly<span class="xmlDocTag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Assembly <span class="title">compileCode</span>(<span class="params"><span class="keyword">string</span>[] scripts, <span class="keyword">string</span> outputfile</span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="comment">//编译参数</span></span><br><span class="line">        CSharpCodeProvider codeprovider = <span class="keyword">new</span> CSharpCodeProvider();</span><br><span class="line">        CompilerParameters objcompilerparameters = <span class="keyword">new</span> CompilerParameters();</span><br><span class="line">        objcompilerparameters.ReferencedAssemblies.AddRange(<span class="keyword">new</span> <span class="keyword">string</span>[] &#123; <span class="string">"System.dll"</span> &#125;);</span><br><span class="line">        objcompilerparameters.OutputAssembly = outputfile;</span><br><span class="line">        objcompilerparameters.GenerateExecutable = <span class="keyword">false</span>;</span><br><span class="line">        objcompilerparameters.GenerateInMemory = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//开始编译脚本</span></span><br><span class="line">        CompilerResults cr = codeprovider.CompileAssemblyFromSource(objcompilerparameters, scripts);</span><br><span class="line">        <span class="keyword">if</span> (cr.Errors.HasErrors)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">"编译错误："</span>);</span><br><span class="line">            <span class="keyword">foreach</span> (CompilerError err <span class="keyword">in</span> cr.Errors)</span><br><span class="line">                Debug.LogError(err.ErrorText);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> cr.CompiledAssembly;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> 序列化数据</span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="container"&gt;</span>数据容器对象<span class="xmlDocTag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="type"&gt;</span>数据Class类型<span class="xmlDocTag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="datalist"&gt;</span>数据列表<span class="xmlDocTag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="outputpath"&gt;</span>输出目录<span class="xmlDocTag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">serialize</span>(<span class="params"><span class="keyword">object</span> container, Type type, List&lt;ConfigData[]&gt; datalist, <span class="keyword">string</span> outputpath</span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        FieldInfo dictInfo = container.GetType().GetField(<span class="string">"Dict"</span>);</span><br><span class="line">        <span class="keyword">object</span> dict = dictInfo.GetValue(container);</span><br><span class="line">        <span class="comment">//读取每一行数据并填充到实例对象里</span></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> datas <span class="keyword">in</span> datalist)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">object</span> instance = type.Assembly.CreateInstance(type.FullName);</span><br><span class="line">            <span class="comment">//填充实例对象数据</span></span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">var</span> data <span class="keyword">in</span> datas)</span><br><span class="line">            &#123;</span><br><span class="line">                FieldInfo fieldinfo = type.GetField(data.Name);</span><br><span class="line">                fieldinfo.SetValue(instance, parseValue(data.Type, data.Data));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//将实例对象数据添加到Container Map里，后续用于序列化数据</span></span><br><span class="line">            <span class="keyword">object</span> id = type.GetField(<span class="string">"id"</span>).GetValue(instance);</span><br><span class="line">            <span class="keyword">bool</span> isExist = (<span class="keyword">bool</span>)dict.GetType().GetMethod(<span class="string">"ContainsKey"</span>).Invoke(dict, <span class="keyword">new</span> <span class="keyword">object</span>[] &#123; id &#125;);</span><br><span class="line">            <span class="keyword">if</span> (isExist)</span><br><span class="line">            &#123;</span><br><span class="line">                Debug.LogError(<span class="string">"Repetitive key "</span> + id + <span class="string">" in "</span> + container.GetType().Name);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            dict.GetType().GetMethod(<span class="string">"Add"</span>).Invoke(dict, <span class="keyword">new</span> <span class="keyword">object</span>[] &#123; id, instance &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//将数据序列化到本地文件</span></span><br><span class="line">        <span class="keyword">var</span> bf = <span class="keyword">new</span> BinaryFormatter();</span><br><span class="line">        <span class="keyword">var</span> s = <span class="keyword">new</span> FileStream(outputpath + type.Name + <span class="string">".bytes"</span>, FileMode.CreateNew, FileAccess.Write);</span><br><span class="line">        bf.Serialize(s, container);</span><br><span class="line">        s.Close();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> 创建生成反序列化加载接口代码</span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="assembly"&gt;</span><span class="xmlDocTag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="outputpath"&gt;</span>输出路径<span class="xmlDocTag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;returns&gt;</span><span class="xmlDocTag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">createDataManager</span>(<span class="params">Assembly assembly, <span class="keyword">string</span> outputpath</span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        StringBuilder source = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        source.Append(<span class="string">"/*\n"</span>);</span><br><span class="line">        source.Append(<span class="string">"\tAuto create\n"</span>);</span><br><span class="line">        source.Append(<span class="string">"\tDon't Edit it\n"</span>);</span><br><span class="line">        source.Append(<span class="string">"*/\n"</span>);</span><br><span class="line">        source.Append(<span class="string">"\n"</span>);</span><br><span class="line"></span><br><span class="line">        source.Append(<span class="string">"using System;\n"</span>);</span><br><span class="line">        source.Append(<span class="string">"using UnityEngine;\n"</span>);</span><br><span class="line">        source.Append(<span class="string">"using System.Runtime.Serialization;\n"</span>);</span><br><span class="line">        source.Append(<span class="string">"using System.Runtime.Serialization.Formatters.Binary;\n"</span>);</span><br><span class="line">        source.Append(<span class="string">"using System.IO;\n\n"</span>);</span><br><span class="line">        source.Append(<span class="string">"[Serializable]\n"</span>);</span><br><span class="line">        source.Append(<span class="string">"public class DataManager : SingletonTemplate&lt;DataManager&gt;\n"</span>);</span><br><span class="line">        source.Append(<span class="string">"&#123;\n"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//定义所有Container的成员变量</span></span><br><span class="line">        <span class="keyword">var</span> types = assembly.GetTypes();</span><br><span class="line">        <span class="keyword">foreach</span>(<span class="keyword">var</span> type <span class="keyword">in</span> types)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(!type.Name.EndsWith(PathUtilties.ExcelTableContainerPostfix))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            source.Append(<span class="string">"\tpublic "</span> + type.Name + <span class="string">" "</span> + type.Name.Remove(<span class="number">0</span>, <span class="number">2</span>) + <span class="string">";\n"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        source.Append(<span class="string">"\n"</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//加载所有配置表</span></span><br><span class="line">        source.Append(<span class="string">"\tpublic void loadAll()\n"</span>);</span><br><span class="line">        source.Append(<span class="string">"\t&#123;\n"</span>);</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> type <span class="keyword">in</span> types)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (!type.Name.EndsWith(<span class="string">"Container"</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">string</span> typeName = type.Name.Remove(type.Name.IndexOf(<span class="string">"Container"</span>));</span><br><span class="line">            source.Append(<span class="string">"\t\t"</span> + type.Name.Remove(<span class="number">0</span>, <span class="number">2</span>) + <span class="string">" = Load("</span> + <span class="string">'"'</span> + typeName + <span class="string">'"'</span> + <span class="string">") as "</span> + type.Name + <span class="string">";\n"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        source.Append(<span class="string">"\t&#125;\n\n"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//反序列化接口方法</span></span><br><span class="line">        source.Append(<span class="string">"\tprivate System.Object Load(string name)\n"</span>);</span><br><span class="line">        source.Append(<span class="string">"\t&#123;\n"</span>);</span><br><span class="line">        source.Append(<span class="string">"\t\tvar bf = new BinaryFormatter();\n"</span>);</span><br><span class="line">        source.Append(<span class="string">"\t\tTextAsset text = Resources.Load&lt;TextAsset&gt;("</span> + <span class="string">'"'</span> + PathUtilties.ExcelDataFileOutputFolderRelativePath + <span class="string">'"'</span> + <span class="string">" + name);\n"</span>);</span><br><span class="line">        source.Append(<span class="string">"\t\tStream s = new MemoryStream(text.bytes);\n"</span>);</span><br><span class="line">        source.Append(<span class="string">"\t\tSystem.Object obj = bf.Deserialize(s);\n"</span>);</span><br><span class="line">        source.Append(<span class="string">"\t\ts.Close();\n"</span>);</span><br><span class="line">        source.Append(<span class="string">"\t\treturn obj;\n"</span>);</span><br><span class="line">        source.Append(<span class="string">"\t&#125;\n"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 数据加载接口</span></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> type <span class="keyword">in</span> types)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (type.Name.EndsWith(<span class="string">"Container"</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">var</span> classname = type.Name;</span><br><span class="line">            source.Append(<span class="string">"\t\n"</span>);</span><br><span class="line">            source.Append(<span class="string">"\tpublic "</span> + classname + <span class="string">" get"</span> + classname.Substring(<span class="number">2</span>) + <span class="string">"Data(int id)\n"</span>);</span><br><span class="line">            source.Append(<span class="string">"\t&#123;\n"</span>);</span><br><span class="line">            source.Append(<span class="string">"\t\t"</span> + classname + <span class="string">" data = null;\n"</span>);</span><br><span class="line">            source.Append(<span class="string">"\t\t"</span> + classname.Substring(<span class="number">2</span>) + <span class="string">"Container.getMap().TryGetValue(id, out data);\n"</span>);</span><br><span class="line">            source.Append(<span class="string">"\t\tif(data == null)\n"</span>);</span><br><span class="line">            source.Append(<span class="string">"\t\t&#123;\n"</span>);</span><br><span class="line">            source.Append(<span class="string">"\t\t\tDebug.LogError(string.Format(\"表格:&#123; 0&#125;找不到id: &#123; 1&#125;的数据!\", data.GetType().ToString(), id));\n"</span>);</span><br><span class="line">            source.Append(<span class="string">"\t\t&#125;\n"</span>);</span><br><span class="line">            source.Append(<span class="string">"\t\treturn data;\n"</span>);</span><br><span class="line">            source.Append(<span class="string">"\t&#125;\n"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        source.Append(<span class="string">"&#125;\n"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//保存脚本</span></span><br><span class="line">        StreamWriter sw = <span class="keyword">new</span> StreamWriter(outputpath + PathUtilties.ExcelScriptDataManagerFileName);</span><br><span class="line">        sw.WriteLine(source.ToString());</span><br><span class="line">        sw.Close();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> 根据字符串解析类型(暂时只支持基础类型)</span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="type"&gt;</span><span class="xmlDocTag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="data"&gt;</span><span class="xmlDocTag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;returns&gt;</span><span class="xmlDocTag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">object</span> <span class="title">parseValue</span>(<span class="params"><span class="keyword">string</span> type, <span class="keyword">string</span> data</span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (type.Equals(<span class="string">"string"</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> data;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">else</span> <span class="title">if</span>(<span class="params">type.Equals(<span class="string">"int"</span></span>))</span><br><span class="line">        </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">int</span>.Parse(data);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">else</span> <span class="title">if</span>(<span class="params">type.Equals(<span class="string">"float"</span></span>))</span><br><span class="line">        </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">float</span>.Parse(data);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="keyword">string</span>.Format(<span class="string">"类型字符串:&#123;0&#125;不支持该类型数据解析!"</span>, type));</span><br><span class="line">            <span class="keyword">return</span> data;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>DataConfigScriptGenerator.cs<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="xmlDocTag">///</span> 导表代码生成工具</span></span><br><span class="line"><span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">DataConfigScriptGenerator</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> 类名</span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">string</span> ClassName</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> 成员字段类型数据</span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">string</span>[] TypeDatas</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> 成员字段名字数据</span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">string</span>[] TypeNameDatas</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DataConfigScriptGenerator</span>(<span class="params"><span class="keyword">string</span> classname, <span class="keyword">string</span>[] typedatas, <span class="keyword">string</span>[] typenamedatas</span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        ClassName = classname;</span><br><span class="line">        TypeDatas = typedatas;</span><br><span class="line">        TypeNameDatas = typenamedatas;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> 生成对应表代码外部接口</span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;returns&gt;</span><span class="xmlDocTag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">string</span> <span class="title">generateCode</span>(<span class="params"></span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">string</span>.IsNullOrEmpty(ClassName) || TypeDatas == <span class="keyword">null</span> || TypeNameDatas == <span class="keyword">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> generateRealCode();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> 生成表代码</span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;returns&gt;</span><span class="xmlDocTag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">string</span> <span class="title">generateRealCode</span>(<span class="params"></span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="comment">//生成类文件头</span></span><br><span class="line">        StringBuilder classsource = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        classsource.Append(<span class="string">"/*\n"</span>);</span><br><span class="line">        classsource.Append(<span class="string">"\tAuto create\n"</span>);</span><br><span class="line">        classsource.Append(<span class="string">"\tDon't Edit it\n"</span>);</span><br><span class="line">        classsource.Append(<span class="string">"*/\n"</span>);</span><br><span class="line">        classsource.Append(<span class="string">"\n"</span>);</span><br><span class="line">        classsource.Append(<span class="string">"using System;\n"</span>);</span><br><span class="line">        classsource.Append(<span class="string">"using System.Reflection;\n"</span>);</span><br><span class="line">        classsource.Append(<span class="string">"using System.Collections.Generic;\n"</span>);</span><br><span class="line">        classsource.Append(<span class="string">"\n"</span>);</span><br><span class="line">        classsource.Append(<span class="string">"[Serializable]\n"</span>);</span><br><span class="line">        classsource.Append(<span class="string">"public class "</span> + ClassName + <span class="string">"\n"</span>);</span><br><span class="line">        classsource.Append(<span class="string">"&#123;\n"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//生成成员声明数据</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; TypeDatas.Length; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            classsource.Append(filedString(TypeDatas[i], TypeNameDatas[i]));</span><br><span class="line">        &#125;</span><br><span class="line">        classsource.Append(<span class="string">"&#125;\n"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//生成Container</span></span><br><span class="line">        classsource.Append(<span class="string">"\n"</span>);</span><br><span class="line">        classsource.Append(<span class="string">"[Serializable]\n"</span>);</span><br><span class="line">        classsource.Append(<span class="string">"public class "</span> + ClassName + PathUtilties.ExcelTableContainerPostfix + <span class="string">"\n"</span>);</span><br><span class="line">        classsource.Append(<span class="string">"&#123;\n"</span>);</span><br><span class="line">        classsource.Append(<span class="string">"\tpublic "</span> + <span class="string">"Dictionary&lt;int, "</span> + ClassName + <span class="string">"&gt;"</span> + <span class="string">" Dict"</span> + <span class="string">" = new Dictionary&lt;int, "</span> + ClassName + <span class="string">"&gt;();\n"</span>);</span><br><span class="line">        classsource.Append(<span class="string">"\tpublic "</span> + <span class="string">"Dictionary&lt;int, "</span> + ClassName + <span class="string">"&gt;"</span> + <span class="string">" getMap()\n"</span>);</span><br><span class="line">        classsource.Append(<span class="string">"\t&#123;\n"</span>);</span><br><span class="line">        classsource.Append(<span class="string">"\t\treturn Dict;\n"</span>);</span><br><span class="line">        classsource.Append(<span class="string">"\t&#125;\n"</span>);</span><br><span class="line">        classsource.Append(<span class="string">"&#125;\n"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> classsource.ToString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> 成员声明数据</span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="type"&gt;</span>成员类型<span class="xmlDocTag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="field"&gt;</span>成员名<span class="xmlDocTag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;returns&gt;</span><span class="xmlDocTag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">string</span> <span class="title">filedString</span>(<span class="params"><span class="keyword">string</span> type, <span class="keyword">string</span> field</span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">string</span>.IsNullOrEmpty(type) || <span class="keyword">string</span>.IsNullOrEmpty(field))</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        StringBuilder sbProperty = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        sbProperty.Append(<span class="string">"\tpublic "</span> + type + <span class="string">" "</span> + field + <span class="string">";\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> sbProperty.ToString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>让我们来看看最终的结果：<br>game.xlsx<br><img src="/img/Unity/ExcelDataConfig.PNG" alt="ExcelDataConfig"></p>
<p><img src="/img/Unity/DataConfigData.PNG" alt="DataConfigData"></p>
<p>t_game.cs<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span><br><span class="line">    Auto create</span><br><span class="line">    Don't Edit it</span><br><span class="line">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Reflection;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"></span><br><span class="line">[Serializable]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">t_game</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> id;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">string</span> author;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">string</span> sex;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> age;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">float</span> money;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[Serializable]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">t_gameContainer</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> Dictionary&lt;<span class="keyword">int</span>, t_game&gt; Dict = <span class="keyword">new</span> Dictionary&lt;<span class="keyword">int</span>, t_game&gt;();</span><br><span class="line">    <span class="keyword">public</span> Dictionary&lt;<span class="keyword">int</span>, t_game&gt; getMap()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> Dict;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>DataManager.cs<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line">    Auto create</span><br><span class="line">    Don't Edit it</span><br><span class="line">*/</span><br><span class="line"></span><br><span class="line">using System;</span><br><span class="line">using UnityEngine;</span><br><span class="line">using System.Runtime.Serialization;</span><br><span class="line">using System.Runtime.Serialization.Formatters.Binary;</span><br><span class="line">using System.IO;</span><br><span class="line"></span><br><span class="line">[Serializable]</span><br><span class="line">public class DataManager : SingletonTemplate&lt;DataManager&gt;</span><br><span class="line">&#123;</span><br><span class="line">    public t_gameContainer gameContainer;</span><br><span class="line"></span><br><span class="line">    public void loadAll()</span><br><span class="line">    &#123;</span><br><span class="line">        gameContainer = Load("t_game") as t_gameContainer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private System.Object Load(string name)</span><br><span class="line">    &#123;</span><br><span class="line">        var bf = new BinaryFormatter();</span><br><span class="line">        TextAsset text = Resources.Load&lt;TextAsset&gt;("DataConfig/" + name);</span><br><span class="line">        Stream s = new MemoryStream(text.bytes);</span><br><span class="line">        System.Object obj = bf.Deserialize(s);</span><br><span class="line">        s.Close();</span><br><span class="line">        return obj;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public t_game getgameData(int id)</span><br><span class="line">    &#123;</span><br><span class="line">        t_game data = null;</span><br><span class="line">        gameContainer.getMap().TryGetValue(id, out data);</span><br><span class="line">        if(data == null)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(string.Format("表格:&#123; 0&#125;找不到id: &#123; 1&#125;的数据!", data.GetType().ToString(), id));</span><br><span class="line">        &#125;</span><br><span class="line">        return data;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>最后在Unity里测试读取和打印:<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">GUILayout.BeginHorizontal();</span><br><span class="line"><span class="keyword">if</span> (GUILayout.Button(<span class="string">"加载所有表格数据"</span>, GUILayout.MaxWidth(<span class="number">250.0</span>f), GUILayout.MaxHeight(<span class="number">50.0</span>f)))</span><br><span class="line">&#123;</span><br><span class="line">    Debug.Log(<span class="string">"加载所有表格数据"</span>);</span><br><span class="line">    DataManager.Singleton.loadAll();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (GUILayout.Button(<span class="string">"打印所有表格数据"</span>, GUILayout.MaxWidth(<span class="number">250.0</span>f), GUILayout.MinHeight(<span class="number">50.0</span>f)))</span><br><span class="line">&#123;</span><br><span class="line">    Debug.Log(<span class="string">"打印所有表格数据"</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= DataManager.Singleton.gameContainer.Dict.Count; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> data = DataManager.Singleton.getgameData(i);</span><br><span class="line">        Debug.Log(<span class="keyword">string</span>.Format(<span class="string">"data.id : &#123;0&#125;, data.author : &#123;1&#125;, data.age : &#123;2&#125;, data.sex : &#123;3&#125;, data.money : &#123;4&#125;"</span>, data.id, data.author, data.age, data.sex, data.money));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">GUILayout.EndHorizontal();</span><br></pre></td></tr></table></figure></p>
<p><img src="/img/Unity/DataConfigResult.PNG" alt="DataConfigResult"></p>
<p>就这样我们成功的通过读取表格数据，生成对应代码，序列化数据，然后通过生成的对应表代码反序列化读取出数据就基本完成了。</p>
<p>遇到的问题:<br>第三步动态编译dll进行序列化反序列化，这一步本来想最终不使用dll而是跟着Unity参与编译的代码来反序列化，但是反序列化出现了问题。</p>
<p>错误信息:<br>SerializationExeption: could not find type ‘System.Collections.Generic.Dictionary’ **</p>
<p>个人猜测因为序列化反序列化时要求Assemble信息一致，所以如果反序列化使用Unity 编译后的C#无法成功反序列化</p>
<p>网上相关问题:<br><a href="https://stackoverflow.com/questions/505611/binary-deserialization-with-different-assembly-version" target="_blank" rel="external">SerializationException: Could not find type ‘System.Collections.Generic.List’1 in c# untiy3d</a><br><a href="https://www.codeproject.com/Tips/1101106/How-to-serialize-across-assemblies-with-the-Binary" target="_blank" rel="external">How to Serialize Across Assemblies with the BinaryFormatter</a></p>
<p>但考虑到BinderToType低版本.Net可以用但BinderToName要求.Net 4.0，所以这里放弃了直接生成新的cs表代码通过Unity编译使用的方案，选择依然采用直接编译表代码成dll来使用。<br>表代码依然生成，但放到Asset外部作为非有效代码存储方便查看</p>
<h5 id="问题">问题</h5><ol>
<li>C#反序列化默认是反射实现的，速度会比较慢，可以考虑实现自定义反序列化加快读取速度，参考：<a href="http://tonytang1990.github.io/2015/08/15/CSharp-Study/#Runtime_Serialization">Runtime_Serialization</a><br>测试方式:</li>
</ol>
<ul>
<li>序列化同一个类型对象500次并反序列化500次</li>
<li>打印记录反序列化的内存和时间开销<br>测试代码:<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">long</span> mHeapMemorySize;</span><br><span class="line"><span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="xmlDocTag">///</span> 显示堆内存使用准备工作(在调用ShowHeapMemoryUsing打印堆内存分配之前调用此方法确保计算显示的堆内存数据申请正确)</span></span><br><span class="line"><span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">TonyTangShowHeapMemoryUsingPrepration</span>(<span class="params"></span>)</span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">// 确保得到正确的起始Heap Memory Size</span></span><br><span class="line">    GC.Collect();</span><br><span class="line">    mHeapMemorySize = GC.GetTotalMemory(<span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="xmlDocTag">///</span> 显示堆内存使用情况</span></span><br><span class="line"><span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="postfix"&gt;</span><span class="xmlDocTag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">TonyTangShowHeapMemoryUsing</span>(<span class="params"><span class="keyword">string</span> postfix</span>)</span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> newestheapmemorysize = GC.GetTotalMemory(<span class="keyword">false</span>);</span><br><span class="line">    <span class="keyword">var</span> heapmemoryoffset = newestheapmemorysize - mHeapMemorySize;</span><br><span class="line">    Console.WriteLine(<span class="keyword">string</span>.Format(<span class="string">"Heap Memory Size = &#123;0&#125; Pre Memory Size = &#123;1&#125; Memory Offset = &#123;2&#125; -- &#123;3&#125;"</span>, newestheapmemorysize, mHeapMemorySize, heapmemoryoffset, postfix));</span><br><span class="line">    mHeapMemorySize = newestheapmemorysize;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Note:</span></span><br><span class="line"><span class="comment">//注释掉的部分就是自定义序列化和反序列化的代码部分</span></span><br><span class="line">[Serializable]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Map</span> <span class="comment">//: ISerializable, IDeserializationCallback</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//Special construct(required by ISerializable) to control deserialization</span></span><br><span class="line">    <span class="comment">//[SecurityPermissionAttribute(SecurityAction.Demand, SerializationFormatter = true)]</span></span><br><span class="line">    <span class="comment">//protected Map(SerializationInfo info, StreamingContext context)</span></span><br><span class="line">    <span class="comment">//&#123;</span></span><br><span class="line">    <span class="comment">//    m_SiInfo = info;</span></span><br><span class="line">    <span class="comment">//&#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//[SecurityPermissionAttribute(SecurityAction.Demand, SerializationFormatter = true)]</span></span><br><span class="line">    <span class="comment">//public virtual void GetObjectData(SerializationInfo info, StreamingContext context)</span></span><br><span class="line">    <span class="comment">//&#123;</span></span><br><span class="line">    <span class="comment">//    info.AddValue("mID", mID);</span></span><br><span class="line">    <span class="comment">//    info.AddValue("mMapName", mMapName);</span></span><br><span class="line">    <span class="comment">//&#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//void IDeserializationCallback.OnDeserialization(Object sender)</span></span><br><span class="line">    <span class="comment">//&#123;</span></span><br><span class="line">    <span class="comment">//    if (m_SiInfo == null)</span></span><br><span class="line">    <span class="comment">//    &#123;</span></span><br><span class="line">    <span class="comment">//        return;</span></span><br><span class="line">    <span class="comment">//    &#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//    mID = m_SiInfo.GetInt32("mID");</span></span><br><span class="line">    <span class="comment">//    mMapName = m_SiInfo.GetString("mMapName");</span></span><br><span class="line">    <span class="comment">//&#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//private SerializationInfo m_SiInfo;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Map</span>(<span class="params"></span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        mID = <span class="number">0</span>;</span><br><span class="line">        mMapName = <span class="string">"DefaultMap"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> ID</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> mID;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">set</span></span><br><span class="line">        &#123;</span><br><span class="line">            mID = <span class="keyword">value</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mID;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">string</span> MapName</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> mMapName;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">set</span></span><br><span class="line">        &#123;</span><br><span class="line">            mMapName = <span class="keyword">value</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">string</span> mMapName;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Serialization</span></span><br><span class="line"><span class="keyword">string</span> mMapSavePath = <span class="string">"./mapInfo.dat"</span>;</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> id = <span class="number">0</span>; id &lt; <span class="number">500</span>; id++)</span><br><span class="line">&#123;</span><br><span class="line">    Map map = <span class="keyword">new</span> Map();</span><br><span class="line">    map.ID = id;</span><br><span class="line">    map.MapName = id.ToString();</span><br><span class="line">    BinaryFormatter bf = <span class="keyword">new</span> BinaryFormatter();</span><br><span class="line">    <span class="keyword">var</span> mapsavepath = mMapSavePath + id;</span><br><span class="line">    <span class="keyword">if</span> (!File.Exists(mapsavepath))</span><br><span class="line">    &#123;</span><br><span class="line">        FileStream fsc = File.Create(mapsavepath);</span><br><span class="line">        fsc.Close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    FileStream fs = File.Open(mapsavepath, FileMode.Open);</span><br><span class="line">    bf.Serialize(fs, map);</span><br><span class="line">    fs.Close();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Deserialization</span></span><br><span class="line">ShowHeapMemoryUsingPrepration();</span><br><span class="line">TimeCounter.Singleton.Restart(<span class="string">"Deserialization"</span>);</span><br><span class="line">Map mDSMap;</span><br><span class="line">BinaryFormatter dsbf = <span class="keyword">new</span> BinaryFormatter ();</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> id = <span class="number">0</span>; id &lt; <span class="number">500</span>; id++)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> mapsavepath = mMapSavePath + id;</span><br><span class="line">    <span class="keyword">if</span> (File.Exists(mapsavepath))</span><br><span class="line">    &#123;</span><br><span class="line">        FileStream dsfs = File.Open(mapsavepath, FileMode.Open);</span><br><span class="line">        mDSMap = (Map)dsbf.Deserialize(dsfs);</span><br><span class="line">        dsfs.Close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">TimeCounter.Singleton.End();</span><br><span class="line">ShowHeapMemoryUsing(<span class="string">"Serialization"</span>);</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>自定义序列化反序列化开销:<br><img src="/img/Unity/CustomSerializationPerformance.PNG" alt="CustomSerializationPerformance"><br>默认序列化开销:<br><img src="/img/Unity/DefaultSerializationPerformance.PNG" alt="DefaultSerializationPerformance"><br>Note:<br>    <strong>实际测试以后发现，自定义并没有加快反序列化的速度，反而增加了内存开销</strong><br>    从上面的测试可以看出反序列化的速度没有加快，反倒是反序列化的内存开销增加了。<br>    这里的测试结果也和<a href="https://theburningwork.com/2011/08/performance-test-binaryformatter-vs-protobuf-net/" target="_blank" rel="external">Performance Test - BinaryFormatter vs Protobuf-Net</a>里的结论一致了。<strong>但至于为什么反序列化速度没有提升，这里不太明白，理论上避免了反射应该是有所提升才对。希望知道的朋友忘告知。</strong></p>
<ol>
<li>序列化的数据仅仅是通过C#自身可以反序列化出来，不支持跨语言(比如服务器端使用Java的话，并不能直接使用同样的序列化数据)。</li>
</ol>
<h4 id="ProtoBuff">ProtoBuff</h4><h5 id="ProtoBuff学习了解">ProtoBuff学习了解</h5><p>Protocol Buffers是Google发布出来的开源项目。<br><a href="https://developers.google.com/protocol-buffers/docs/overview" target="_blank" rel="external">Protocol Buffers - a language-neutral, platform-neutral, extensible way of serializing structured data for use in communications protocols, data storage, and more. </a><br>从官网介绍可以看出Google Protocol Buffers(平台无关，语言无关)是针对序列化数据的存储和传输协议等。<br>既然都是用于数据存储，那么Protocol buffers相比传统的二进制和XML序列化有什么优势了？<br>相比XML序列化，Protocol buffers更高效，更灵活，更快，更小，更简单。<br>更方便简单在于 — PB只需定义一次data的数据结构就能自动生成对应语言的解析该数据结构的代码类。<br>更高效更小在于 — XML存储的数据量大，XML在解析的时候，空间开销大，内容多速度慢。(XML的好处 — 具有可读性)<br>更灵活在于 — 只需更新数据结构定义然后编译出对应语言的代码就能无缝衔接以前的版本。<br>既然Protocol buffers这么好，那么让我们看看他是怎么工作的？</p>
<ol>
<li>定义出我们需要序列化的数据结构，保存在.proto文件里。</li>
<li>运用Protocol buffer编译器编译出我们对应语言的解析该数据结构的代码类。<br>首先下载对应语言的<a href="https://github.com/google/protobuf/releases/tag/v3.0.0" target="_blank" rel="external">Protocol buffer编译器</a><br>“There are two NuGet packages: Google.Protobuf (the support library) and Google.Protobuf.Tools (containing protoc)”<br>根据上面写的，C#现在貌似有两个版本支持Protocol Buffer，但原生的Protobuf版本支持的.NET版本很高，所以不适合Unity(Unity是基于Mono的，Mono现在对.NET的支持还停留在.NET 2.0和.NET 2.0 subset)。</li>
</ol>
<p>——————————————-2018/5/6(新增)—————————————————-<br><img src="/img/Unity/UntiyDotNetVersion.PNG" alt="UntiyDotNetVersion"><br>虽然表面上Unity(5.6.4p4)写的.Net 2.0和.Net 2.0 Subnet，其实支持的算是.Net 2.0 + .Net 3.5<br>详情参考<a href="https://blog.csdn.net/myqtmacc/article/details/70500099" target="_blank" rel="external">扒一扒.net、.net framework、mono和Unity</a><br><img src="/img/Unity/Unity2017DotNetVersion.PNG" alt="Unity2017DotNetVersion"><br>到了Unity 2017,Unity已经支持到.Net 3.5和测试版的.Net 4.6了(支持C# 6语法)<br>Mono逐渐被IL2CPP取代，MonoDevelop工具在Unity2018开始也正式废弃不再支持。<a href="https://blogs.unity3d.com/cn/2018/01/05/discontinuing-support-for-monodevelop-unity-starting-in-unity-2018-1/" target="_blank" rel="external">Replacing MonoDevelop-Unity with Visual Studio Community starting in Unity 2018.1</a><br>———————————————2018/5/6(新增)—————————————————-</p>
<p>所以通过Google，我找到了以下两个开源项目：</p>
<pre><code><span class="bullet">1. </span>[<span class="link_label">Protobuf-csharp-port</span>](<span class="link_url">https://github.com/jskeet/protobuf-csharp-port</span>)
<span class="bullet">2. </span>[<span class="link_label">Protobuf-net</span>](<span class="link_url">https://github.com/mgravell/protobuf-net</span>)
前者在Git上的描述不多，所以这里就以下面引用的话来了解两者之间的区别。
[<span class="link_label">Protobuf-csharp-port is written by Jon Skeet and is a faithful port of Google’s java implementation that uses similar command-line tooling. You create the data definitions in text-based .proto files and use a code generation tool to create the C# classes.</span>](<span class="link_url">http://www.ben-morris.com/protocol-buffers-protobuf-net-vs-protobuf-csharp-port/</span>)
Protobuf-csharp-port是由Jon Skeet编写，利用原生工具去port的版本。在编译创建上都沿用了Protocol buffer的原始方式(通过编译.proto文件生成解析定义的Message数据结构的C#代码类)
[<span class="link_label">Protobuf-net is written by Marc Gravell and will be more familiar to .Net developers. The implementation uses .Net classes and attributes to define data rather than .proto files. Overall, the code resembles existing .Net serializers such as the DataContractSerializer.</span>](<span class="link_url">http://www.ben-morris.com/protocol-buffers-protobuf-net-vs-protobuf-csharp-port/</span>)
Protobuf-net是由Marc Gravell编写，支持.NET的类和attributes去定义数据结构，也支持.proto文件预编译生成对应代码类。可以说是.NET风格的Protobuf。
同时Github写明了支持：
.net 2.0/3.0/3.5/4.0
Mono 2.x
所以这里就决定使用Protobuf-net作为Unity C#序列化数据的存储和协议传输的库来学习。
<span class="code">    1. 安装Protobuf-net</span>
<span class="code">    VS -&gt; Tools -&gt; Nuget Package Manager -&gt; Package Manager Console</span>
<span class="code">    在Package Manager Console窗口输入下列命令就会自动去下载Protobuf-net包并安装了。</span>
</code></pre><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Install-Package protobuf-net</span><br></pre></td></tr></table></figure>
<pre><code>也可以直接下载[<span class="link_label">Down load link of Protobuf-net</span>](<span class="link_url">https://code.google.com/archive/p/protobuf-net/downloads</span>)
把Protobuf-net.dll放到Assets/Plugins目录下
<span class="bullet">2. </span>定义可序列化的类
</code></pre><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> ProtoBuf;</span><br><span class="line"></span><br><span class="line">[ProtoContract]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PlayerData</span> &#123;</span><br><span class="line">    [ProtoMember(<span class="number">1</span>)]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">string</span> SceneName</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [ProtoMember(<span class="number">2</span>)]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> Scores</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [ProtoMember(<span class="number">3</span>)]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> SpeedLevel</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>通过C#(对应语言)protocol buffer API去读写存储的数据。<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Awake</span>(<span class="params"></span>)</span><br><span class="line"></span>&#123;</span><br><span class="line">   ......</span><br><span class="line"></span><br><span class="line">    mPlayerData = <span class="keyword">new</span> PlayerData();</span><br><span class="line"></span><br><span class="line">    mProfilePath =  Application.persistentDataPath + <span class="string">"/PlayerProile.bin"</span>;</span><br><span class="line">    Debug.Log(<span class="string">"mProfilePath = "</span> + mProfilePath);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SavePlayerData</span>(<span class="params"></span>)</span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">//Do serialization for player data</span></span><br><span class="line">    FileStream profile;</span><br><span class="line">    <span class="keyword">if</span>(File.Exists(mProfilePath))</span><br><span class="line">    &#123;</span><br><span class="line">        profile = File.Open(mProfilePath, FileMode.Open);</span><br><span class="line">        Serializer.Serialize(profile, mPlayerData);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        profile = File.Create(mProfilePath);</span><br><span class="line">        Serializer.Serialize(profile, mPlayerData);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">LoadPlayerData</span>(<span class="params"></span>)</span><br><span class="line"></span>&#123;</span><br><span class="line">    FileStream profile;</span><br><span class="line">    <span class="keyword">if</span>(File.Exists(mProfilePath))</span><br><span class="line">    &#123;</span><br><span class="line">        profile = File.OpenRead(mProfilePath);</span><br><span class="line">        mPlayerData = Serializer.Deserialize&lt;PlayerData&gt;(profile);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        mPlayerData = <span class="keyword">new</span> PlayerData();</span><br><span class="line">        mPlayerData.SceneName = Application.productName;</span><br><span class="line">        mPlayerData.Scores = <span class="number">0</span>;</span><br><span class="line">        mPlayerData.SpeedLevel = <span class="number">1</span>;</span><br><span class="line">        SavePlayerData();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>但只是这样的话，会报如下错误：<br>NotSupportException： …… System.Reflection.Emit is not supported<br>这里出现了Emit类的使用，显然是用到了动态生成代码，根据我们之前讲到的IOS是在Full-AOT模式下运行不允许动态生成代码的。<br>所以直接使用.NET风格的Attribute会触发动态代码生成，那么我们就需要想办法提前生成，这里就需要使用.proto文件然后通过预编译的方式生成对应的代码类。<br>所以现在我们需要先定义.proto文件(Protobuf-net只支持Proto2)，所以编写<a href="https://developers.google.com/protocol-buffers/docs/proto" target="_blank" rel="external">proto2参考</a><br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//PlayerData.proto</span></span><br><span class="line">syntax = <span class="string">"proto2"</span>;</span><br><span class="line"></span><br><span class="line">package NGUI2DGame;</span><br><span class="line"></span><br><span class="line">message PlayerData&#123;</span><br><span class="line">    optional <span class="keyword">string</span> SceneName = <span class="number">1</span>;</span><br><span class="line">    optional int32 Scores = <span class="number">2</span>;</span><br><span class="line">    optional int32 SpeedLevel = <span class="number">3</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>然后通过Protogen.exe帮我们生成对应解析该数据结构所需要的代码类<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">protogen -i:PlayerData.proto -o:PlayerData.cs -ns:NGUI2DGame</span><br></pre></td></tr></table></figure></p>
<p>-i是指明输入，这里可以通过-i指定多个输入proto文件。-o是指定输出文件，最终生成的对应信息的代码类。-ns是指定namespace<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">//PlayerData.cs</span><br><span class="line">//------------------------------------------------------------------------------</span><br><span class="line">// &lt;auto-generated&gt;</span><br><span class="line">//     This code was generated by a tool.</span><br><span class="line">//</span><br><span class="line">//     Changes to this file may cause incorrect behavior and will be lost if</span><br><span class="line">//     the code is regenerated.</span><br><span class="line">// &lt;/auto-generated&gt;</span><br><span class="line">//------------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">// Generated from: PlayerData.proto</span><br><span class="line">namespace NGUI2DGame</span><br><span class="line">&#123;</span><br><span class="line">  [global::System.Serializable, global::ProtoBuf.ProtoContract(Name=@"PlayerData")]</span><br><span class="line">  public partial class PlayerData : global::ProtoBuf.IExtensible</span><br><span class="line">  &#123;</span><br><span class="line">    public PlayerData() &#123;&#125;</span><br><span class="line">    </span><br><span class="line">    private string _SceneName = "";</span><br><span class="line">    [global::ProtoBuf.ProtoMember(1, IsRequired = false, Name=@"SceneName", DataFormat = global::ProtoBuf.DataFormat.Default)]</span><br><span class="line">    [global::System.ComponentModel.DefaultValue("")]</span><br><span class="line">    public string SceneName</span><br><span class="line">    &#123;</span><br><span class="line">      get &#123; return _SceneName; &#125;</span><br><span class="line">      set &#123; _SceneName = value; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    private int _Scores = default(int);</span><br><span class="line">    [global::ProtoBuf.ProtoMember(2, IsRequired = false, Name=@"Scores", DataFormat = global::ProtoBuf.DataFormat.TwosComplement)]</span><br><span class="line">    [global::System.ComponentModel.DefaultValue(default(int))]</span><br><span class="line">    public int Scores</span><br><span class="line">    &#123;</span><br><span class="line">      get &#123; return _Scores; &#125;</span><br><span class="line">      set &#123; _Scores = value; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    private int _SpeedLevel = default(int);</span><br><span class="line">    [global::ProtoBuf.ProtoMember(3, IsRequired = false, Name=@"SpeedLevel", DataFormat = global::ProtoBuf.DataFormat.TwosComplement)]</span><br><span class="line">    [global::System.ComponentModel.DefaultValue(default(int))]</span><br><span class="line">    public int SpeedLevel</span><br><span class="line">    &#123;</span><br><span class="line">      get &#123; return _SpeedLevel; &#125;</span><br><span class="line">      set &#123; _SpeedLevel = value; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    private global::ProtoBuf.IExtension extensionObject;</span><br><span class="line">    global::ProtoBuf.IExtension global::ProtoBuf.IExtensible.GetExtensionObject(bool createIfMissing)</span><br><span class="line">      &#123; return global::ProtoBuf.Extensible.GetExtensionObject(ref extensionObject, createIfMissing); &#125;</span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>接下来把我们生成的代码通过VS编译成DLL</p>
<ol>
<li>新建C# Library工程</li>
<li>删掉原始cs添加刚才生成的PlayerData.cs</li>
<li>添加Protobuf-net库引用(用CoreOnly/ios/protobuf-net.dll)</li>
<li>编译出dll<br>最后我们需要通过上一步生成的信息类dll来编译出专门序列化该信息的类库。(添加precompile.exe的路径到环境变量确保找得到，这里要注意的是dll项目的.NET target设置成2.0，因为Unity Mono现在只支持到2.0)<br>在之前生成的PlayerData.dll目录下执行下列命令：<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">precompile PlayerData.dll -o:ProtobufSerializer.dll -t:com.TonyTang.ProtobufSerializer</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>-o指明输出文件 -t指明生成的序列化类的类名<br>最后利用生成的PlayerData.dll和ProtobufSerializer.dll到Unity里进行测试，编写对应代码即可，写法和之前的区别就是用我们生成好的类来完成序列化和反序列化。<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Serialization</span></span><br><span class="line">ProtobufSerializer serializer = <span class="keyword">new</span> ProtobufSerializer();       </span><br><span class="line">profile = File.Open(mProfilePath, FileMode.Open);</span><br><span class="line">serializer.Serialize(profile, mPlayerData);</span><br><span class="line"><span class="comment">//Deserialization</span></span><br><span class="line">profile = File.OpenRead(mProfilePath);</span><br><span class="line">mPlayerData = serializer.Deserialize(profile,<span class="keyword">null</span>,<span class="keyword">typeof</span>(PlayerData)) <span class="keyword">as</span> PlayerData;</span><br></pre></td></tr></table></figure></p>
<p>因为需要编写.proto文件后编译生成对应的Serialization类的dll，所以最好通过shell脚本写成自动化。<br>还有一种方式是使用Probobuf-net源码的形式(貌似需要设定-unsafe和.NET 2 subset)，这里我没有尝试，下面给出链接：<br><a href="http://www.ceeger.com/forum/read.php?tid=14359&amp;fid=27" target="_blank" rel="external">在ios android设备上使用 Protobuf (使用源码方式) </a></p>
<p>了解了什么(What)是Protobuf，如何(How)使用Protobuf，那么我们也应该大概了解下为什么(Why)Protobuf高效，更小，更快，更简单…..<br>参考下面两篇文章：<br><a href="https://www.ibm.com/developerworks/cn/linux/l-cn-gpb/" target="_blank" rel="external">Google Protocol Buffer 的使用和原理</a><br><a href="https://developers.google.com/protocol-buffers/docs/encoding" target="_blank" rel="external">官网讲到的Protocol buffer的Encode技术</a><br>从上面可以看出，更小更快是因为Protocol buffer采用了巧妙的Encoding方法。<br>而这个Encoding方法利用了Varint技术，那么什么是Varint了？<br>“Varints are a method of serializing integers using one or more bytes. Smaller numbers take a smaller number of bytes. “<br>Varints通过更少的字节来表达准确的数据，比如0-127只需要1个字节就能表示。<br>当需要多个字节表达的时候，通过利用1byte里的first bit来区分，如果first bit是1表示后续的7个bit都表示数据，如果first bit是0表示这是最后一个字节用于表示数据。<br>同时Protocol buffer在Encode的时候通过key和value来存储数据。key只包含filed的名字和类型，value包含数据。<br>类型数据映射<br><img src="/img/Unity/ProtocolBufferMessageValueType.PNG" alt="ProtocolBufferMessageValueType"><br>当Decode的时候，如果遇到不识别的key值，只需要skip即可，保证了程序的老版本兼容。<br>更方便在于，我们只需通过编写简单易懂的.proto文件然后通过ProtoGen，Precompile工具就能生成对应的Message，Encode和Decode类。<br>结合前面的事例，让我们窥探一下到底Protocol-net是如何实现编写.proto文件结合编译生成Message类和序列化类来实现数据的Encode和Decode的。<br>首先反编译的ProtovufSerializer.dll，查看Serialize方法<br><img src="/img/Unity/ProtobufSerializerSerialize.PNG" alt="ProtobufSerializerSerialize"><br>可以看到ProtobufSerializer调用了Write方法，接下来查看Write方法<br><img src="/img/Unity/ProtobufSerializerWrite.PNG" alt="ProtobufSerializerWrite"><br>可以看到我们ProtobufSerializer实际是通过调用ProtoBuf.ProtoWriter::WriteFieldHeader(Protobuf-net库)实现数据的Encode的。同时因为ProtobufSerializer是根据PlayerData.dll编译而成，所以Write方法里的实现针对每一个需要Encode的Message成员进行数据Encode写入。<br>这样一来就完成了通过编写.proto文件定义Message，然后生成对应的Message类和序列化类再结合Protocol-net库实现了自定义Message的Encode和Decode了，而最终数据的Encode，Decode实现就落实到Protocol-net的实现了。</p>
<p>那么为什么要用Protocol buffer了？<br>参考文章：<br><a href="http://www.oschina.net/translate/choose-protocol-buffers" target="_blank" rel="external">使用 Protocol Buffers 代替 JSON 的五个原因</a><br>Protocol buffer因为是存储在二进制文件，相比XML，Jason等技术不具可读性。</p>
<p>Note:<br>最初的Protocol Buffers只开发了针对Java,C++,Python的版本。后来开园后有了C#，Go等语言的支持。<br>Protocol Buffer存储的数据是以二进制的形式。<br>Protocol-net只支持<a href="https://developers.google.com/protocol-buffers/docs/proto" target="_blank" rel="external">proto2的语言编写规范</a>。</p>
<p>从之前的学习可以知道的是，ProtoBuf通过自定义了Encode和Decode，使用Varint技术，把数据成功压缩更小，实现了更小的数据量存储。</p>
<p>———————————————-2018/04/22—————————————————-<br>关于ProtoBuf原理深度解析，这里找到一篇好文:<a href="https://www.jianshu.com/p/30ef9b3780d9" target="_blank" rel="external">Protocol Buffer 序列化原理大揭秘 - 为什么Protocol Buffer性能这么好？</a>———————————————-2018/04/22—————————————————-</p>
<p>前面提到的是Protocol Buffer 2的使用，那么我们能否集成使用Protocol Buffer 3吗？<br>答案是可以的，接下来我们学习Protocol Bufffer 3的集成使用。</p>
<h5 id="Protocol_Buffer_3_in_Unity">Protocol Buffer 3 in Unity</h5><p>Protocok Buffer(高效的跨语言序列化反序列化数据以及数据结构向后扩展兼容)</p>
<p>问题：</p>
<ol>
<li>PB3对.Net版本的要求？<br>在前面的学习中，我们使用了Protobuf-net版本(支持.Net 2.0,3.0,4.0，但只支持PB2)，这里是学习了解PB3是否能在Unity中使用起来。</li>
</ol>
<p>Probuf官方Git链接：<br><a href="https://github.com/google/protobuf" target="_blank" rel="external">protobuf</a><br>Probuf最新压缩包链接：<br><a href="https://github.com/google/protobuf/releases/tag/v3.6.1" target="_blank" rel="external">protobuf latest</a><br>从Git上下载的最新PB3要求.Net4.5，这是从Git上Protobuf CS源代码工程的Google.Protobuf.csproj文件里看出来的：<br><img src="/img/Unity/Data-Config-Automation/Protobuf3DotNetTargetNumber.png" alt="Protobuf3DotNetTargetNumber"></p>
<ol>
<li><p>Unity支持的.Net版本?<br><img src="/img/Unity/Unity2017DotNetVersion.PNG" alt="Unity2017DotNetVersion"><br>到了Unity 2017,Unity已经支持到.Net 3.5和测试版的.Net 4.6了(支持C# 6语法)</p>
</li>
<li><p>Unity支持的PB版本？<br>通过前面两个问题可以知道，Unity要想支持PB3，我们需要把PB3编译成基于.Net 3.5(因为.Net 4.6还处于测试阶段，所以没选择.Net 4.6)来使用。看网上都有兼容PB3的版本了，理论上Unity是有办法支持PB3的。<br>兼容PB3的版本链接:<br><a href="https://github.com/bitcraftCoLtd/protobuf3-for-unity" target="_blank" rel="external">protobuf3-for-unity</a></p>
</li>
<li><p>Python对应需要的PB版本？<br>选择和前面CS版本相同版本的Python版本的PB3即可(PB3 3.6.1)</p>
</li>
<li><p>Protoc的选择？<br>直接下载编译好的对应版本的Protoc(3.6.1)压缩包即可</p>
</li>
</ol>
<p>流程：<br>Protobuf CSharp篇：</p>
<ol>
<li><a href="https://github.com/google/protobuf/releases/tag/v3.6.1" target="_blank" rel="external">下载新版Protobuf Csharp版</a></li>
<li>自己编译基于.Net 3.5版本Protobuf Csharp版dll(我的理解这一步的dll是Protobuf核心的模块，用于支持对数据编码存储)<br>打开下载的Protobuf Csharp源码里的Google.Protobuf.sln，修改里面Google.Protobuf.csproj工程的TargetFrameworks编译生成我们想要的基于.Net 3.5的Csharp版Protobuf-Csharp.dll<br><img src="/img/Unity/Data-Config-Automation/CompileProtobufCsharpForDoNet35.png" alt="CompileProtobufCsharpForDoNet35"><br><img src="/img/Unity/Data-Config-Automation/DoNet35ProtobufCsharpDll.png" alt="DoNet35ProtobufCsharpDll"><br>复制基于.Net 3.Google.Protobuf.dll到我们的Unity脚本目录下。</li>
</ol>
<p>Note:</p>
<ul>
<li>Protobuf 3.6.1的Google.Protobuf.sln工程需要VS2017才能正确打开，VS2015本人打开显示加载.csproj的C#项目都失败了</li>
</ul>
<ol>
<li>使用Protoc.exe对*.proto文件进行解析生成对应的代码(我的理解，这一步是为了支持指定定义的数据格式的序列化和反序列化相关代码)<br>第一步需要添加Protoc.exe到环境变量里，方便快速访问调用Protoc.exe(这个就不细说了)<br>编写测试GameConfig.proto文件：<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">// &#20351;&#29992;proto3&#10;syntax = &#34;proto3&#34;;&#10;// &#25351;&#26126;namespace&#10;package GameData;&#10;&#10;// &#28216;&#25103;&#37197;&#32622;&#20449;&#24687;&#10;message GameConfig &#123;&#10;  string difficultyLevel = 1;           // &#28216;&#25103;&#38590;&#24230;&#10;  int32 versionNumber = 2;              // &#28216;&#25103;&#29256;&#26412;&#21495;&#10;  int32 resourceNumber = 3;             // &#28216;&#25103;&#36164;&#28304;&#29256;&#26412;&#21495;&#10;&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>使用protoc.exe生成用于序列化反序列化GameConfig的代码:<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">protoc.exe --csharp_out=CsharpCode -I=Proto GameConfig.proto</span><br></pre></td></tr></table></figure></p>
<p>—csharp_out指明CS脚本输出目录<br>-I指明Proto文件查找目录<br>GameConfig.proto表示protoc.exe编译该文件<br>最终得到我们Csharp序列化和反序列化GameConfig所需的代码:<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br></pre></td><td class="code"><pre><span class="line">// &lt;auto-generated&gt;</span><br><span class="line">//     Generated by the protocol buffer compiler.  DO NOT EDIT!</span><br><span class="line">//     source: GameConfig.proto</span><br><span class="line">// &lt;/auto-generated&gt;</span><br><span class="line">#pragma warning disable 1591, 0612, 3021</span><br><span class="line">#region Designer generated code</span><br><span class="line"></span><br><span class="line">using pb = global::Google.Protobuf;</span><br><span class="line">using pbc = global::Google.Protobuf.Collections;</span><br><span class="line">using pbr = global::Google.Protobuf.Reflection;</span><br><span class="line">using scg = global::System.Collections.Generic;</span><br><span class="line">namespace GameData &#123;</span><br><span class="line"></span><br><span class="line">  /// &lt;summary&gt;Holder for reflection information generated from GameConfig.proto&lt;/summary&gt;</span><br><span class="line">  public static partial class GameConfigReflection &#123;</span><br><span class="line"></span><br><span class="line">    #region Descriptor</span><br><span class="line">    /// &lt;summary&gt;File descriptor for GameConfig.proto&lt;/summary&gt;</span><br><span class="line">    public static pbr::FileDescriptor Descriptor &#123;</span><br><span class="line">      get &#123; return descriptor; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    private static pbr::FileDescriptor descriptor;</span><br><span class="line"></span><br><span class="line">    static GameConfigReflection() &#123;</span><br><span class="line">      byte[] descriptorData = global::System.Convert.FromBase64String(</span><br><span class="line">          string.Concat(</span><br><span class="line">            "ChBHYW1lQ29uZmlnLnByb3RvEghHYW1lRGF0YSJUCgpHYW1lQ29uZmlnEhcK",</span><br><span class="line">            "D2RpZmZpY3VsdHlMZXZlbBgBIAEoCRIVCg12ZXJzaW9uTnVtYmVyGAIgASgF",</span><br><span class="line">            "EhYKDnJlc291cmNlTnVtYmVyGAMgASgFYgZwcm90bzM="));</span><br><span class="line">      descriptor = pbr::FileDescriptor.FromGeneratedCode(descriptorData,</span><br><span class="line">          new pbr::FileDescriptor[] &#123; &#125;,</span><br><span class="line">          new pbr::GeneratedClrTypeInfo(null, new pbr::GeneratedClrTypeInfo[] &#123;</span><br><span class="line">            new pbr::GeneratedClrTypeInfo(typeof(global::GameData.GameConfig), global::GameData.GameConfig.Parser, new[]&#123; "DifficultyLevel", "VersionNumber", "ResourceNumber" &#125;, null, null, null)</span><br><span class="line">          &#125;));</span><br><span class="line">    &#125;</span><br><span class="line">    #endregion</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">  #region Messages</span><br><span class="line">  /// &lt;summary&gt;</span><br><span class="line">  /// 游戏配置信息</span><br><span class="line">  /// &lt;/summary&gt;</span><br><span class="line">  public sealed partial class GameConfig : pb::IMessage&lt;GameConfig&gt; &#123;</span><br><span class="line">    private static readonly pb::MessageParser&lt;GameConfig&gt; _parser = new pb::MessageParser&lt;GameConfig&gt;(() =&gt; new GameConfig());</span><br><span class="line">    private pb::UnknownFieldSet _unknownFields;</span><br><span class="line">    [global::System.Diagnostics.DebuggerNonUserCodeAttribute]</span><br><span class="line">    public static pb::MessageParser&lt;GameConfig&gt; Parser &#123; get &#123; return _parser; &#125; &#125;</span><br><span class="line"></span><br><span class="line">    [global::System.Diagnostics.DebuggerNonUserCodeAttribute]</span><br><span class="line">    public static pbr::MessageDescriptor Descriptor &#123;</span><br><span class="line">      get &#123; return global::GameData.GameConfigReflection.Descriptor.MessageTypes[0]; &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [global::System.Diagnostics.DebuggerNonUserCodeAttribute]</span><br><span class="line">    pbr::MessageDescriptor pb::IMessage.Descriptor &#123;</span><br><span class="line">      get &#123; return Descriptor; &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [global::System.Diagnostics.DebuggerNonUserCodeAttribute]</span><br><span class="line">    public GameConfig() &#123;</span><br><span class="line">      OnConstruction();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    partial void OnConstruction();</span><br><span class="line"></span><br><span class="line">    [global::System.Diagnostics.DebuggerNonUserCodeAttribute]</span><br><span class="line">    public GameConfig(GameConfig other) : this() &#123;</span><br><span class="line">      difficultyLevel_ = other.difficultyLevel_;</span><br><span class="line">      versionNumber_ = other.versionNumber_;</span><br><span class="line">      resourceNumber_ = other.resourceNumber_;</span><br><span class="line">      _unknownFields = pb::UnknownFieldSet.Clone(other._unknownFields);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [global::System.Diagnostics.DebuggerNonUserCodeAttribute]</span><br><span class="line">    public GameConfig Clone() &#123;</span><br><span class="line">      return new GameConfig(this);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /// &lt;summary&gt;Field number for the "difficultyLevel" field.&lt;/summary&gt;</span><br><span class="line">    public const int DifficultyLevelFieldNumber = 1;</span><br><span class="line">    private string difficultyLevel_ = "";</span><br><span class="line">    /// &lt;summary&gt;</span><br><span class="line">    /// 游戏难度</span><br><span class="line">    /// &lt;/summary&gt;</span><br><span class="line">    [global::System.Diagnostics.DebuggerNonUserCodeAttribute]</span><br><span class="line">    public string DifficultyLevel &#123;</span><br><span class="line">      get &#123; return difficultyLevel_; &#125;</span><br><span class="line">      set &#123;</span><br><span class="line">        difficultyLevel_ = pb::ProtoPreconditions.CheckNotNull(value, "value");</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /// &lt;summary&gt;Field number for the "versionNumber" field.&lt;/summary&gt;</span><br><span class="line">    public const int VersionNumberFieldNumber = 2;</span><br><span class="line">    private int versionNumber_;</span><br><span class="line">    /// &lt;summary&gt;</span><br><span class="line">    /// 游戏版本号</span><br><span class="line">    /// &lt;/summary&gt;</span><br><span class="line">    [global::System.Diagnostics.DebuggerNonUserCodeAttribute]</span><br><span class="line">    public int VersionNumber &#123;</span><br><span class="line">      get &#123; return versionNumber_; &#125;</span><br><span class="line">      set &#123;</span><br><span class="line">        versionNumber_ = value;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /// &lt;summary&gt;Field number for the "resourceNumber" field.&lt;/summary&gt;</span><br><span class="line">    public const int ResourceNumberFieldNumber = 3;</span><br><span class="line">    private int resourceNumber_;</span><br><span class="line">    /// &lt;summary&gt;</span><br><span class="line">    /// 游戏资源版本号</span><br><span class="line">    /// &lt;/summary&gt;</span><br><span class="line">    [global::System.Diagnostics.DebuggerNonUserCodeAttribute]</span><br><span class="line">    public int ResourceNumber &#123;</span><br><span class="line">      get &#123; return resourceNumber_; &#125;</span><br><span class="line">      set &#123;</span><br><span class="line">        resourceNumber_ = value;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [global::System.Diagnostics.DebuggerNonUserCodeAttribute]</span><br><span class="line">    public override bool Equals(object other) &#123;</span><br><span class="line">      return Equals(other as GameConfig);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [global::System.Diagnostics.DebuggerNonUserCodeAttribute]</span><br><span class="line">    public bool Equals(GameConfig other) &#123;</span><br><span class="line">      if (ReferenceEquals(other, null)) &#123;</span><br><span class="line">        return false;</span><br><span class="line">      &#125;</span><br><span class="line">      if (ReferenceEquals(other, this)) &#123;</span><br><span class="line">        return true;</span><br><span class="line">      &#125;</span><br><span class="line">      if (DifficultyLevel != other.DifficultyLevel) return false;</span><br><span class="line">      if (VersionNumber != other.VersionNumber) return false;</span><br><span class="line">      if (ResourceNumber != other.ResourceNumber) return false;</span><br><span class="line">      return Equals(_unknownFields, other._unknownFields);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [global::System.Diagnostics.DebuggerNonUserCodeAttribute]</span><br><span class="line">    public override int GetHashCode() &#123;</span><br><span class="line">      int hash = 1;</span><br><span class="line">      if (DifficultyLevel.Length != 0) hash ^= DifficultyLevel.GetHashCode();</span><br><span class="line">      if (VersionNumber != 0) hash ^= VersionNumber.GetHashCode();</span><br><span class="line">      if (ResourceNumber != 0) hash ^= ResourceNumber.GetHashCode();</span><br><span class="line">      if (_unknownFields != null) &#123;</span><br><span class="line">        hash ^= _unknownFields.GetHashCode();</span><br><span class="line">      &#125;</span><br><span class="line">      return hash;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [global::System.Diagnostics.DebuggerNonUserCodeAttribute]</span><br><span class="line">    public override string ToString() &#123;</span><br><span class="line">      return pb::JsonFormatter.ToDiagnosticString(this);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [global::System.Diagnostics.DebuggerNonUserCodeAttribute]</span><br><span class="line">    public void WriteTo(pb::CodedOutputStream output) &#123;</span><br><span class="line">      if (DifficultyLevel.Length != 0) &#123;</span><br><span class="line">        output.WriteRawTag(10);</span><br><span class="line">        output.WriteString(DifficultyLevel);</span><br><span class="line">      &#125;</span><br><span class="line">      if (VersionNumber != 0) &#123;</span><br><span class="line">        output.WriteRawTag(16);</span><br><span class="line">        output.WriteInt32(VersionNumber);</span><br><span class="line">      &#125;</span><br><span class="line">      if (ResourceNumber != 0) &#123;</span><br><span class="line">        output.WriteRawTag(24);</span><br><span class="line">        output.WriteInt32(ResourceNumber);</span><br><span class="line">      &#125;</span><br><span class="line">      if (_unknownFields != null) &#123;</span><br><span class="line">        _unknownFields.WriteTo(output);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [global::System.Diagnostics.DebuggerNonUserCodeAttribute]</span><br><span class="line">    public int CalculateSize() &#123;</span><br><span class="line">      int size = 0;</span><br><span class="line">      if (DifficultyLevel.Length != 0) &#123;</span><br><span class="line">        size += 1 + pb::CodedOutputStream.ComputeStringSize(DifficultyLevel);</span><br><span class="line">      &#125;</span><br><span class="line">      if (VersionNumber != 0) &#123;</span><br><span class="line">        size += 1 + pb::CodedOutputStream.ComputeInt32Size(VersionNumber);</span><br><span class="line">      &#125;</span><br><span class="line">      if (ResourceNumber != 0) &#123;</span><br><span class="line">        size += 1 + pb::CodedOutputStream.ComputeInt32Size(ResourceNumber);</span><br><span class="line">      &#125;</span><br><span class="line">      if (_unknownFields != null) &#123;</span><br><span class="line">        size += _unknownFields.CalculateSize();</span><br><span class="line">      &#125;</span><br><span class="line">      return size;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [global::System.Diagnostics.DebuggerNonUserCodeAttribute]</span><br><span class="line">    public void MergeFrom(GameConfig other) &#123;</span><br><span class="line">      if (other == null) &#123;</span><br><span class="line">        return;</span><br><span class="line">      &#125;</span><br><span class="line">      if (other.DifficultyLevel.Length != 0) &#123;</span><br><span class="line">        DifficultyLevel = other.DifficultyLevel;</span><br><span class="line">      &#125;</span><br><span class="line">      if (other.VersionNumber != 0) &#123;</span><br><span class="line">        VersionNumber = other.VersionNumber;</span><br><span class="line">      &#125;</span><br><span class="line">      if (other.ResourceNumber != 0) &#123;</span><br><span class="line">        ResourceNumber = other.ResourceNumber;</span><br><span class="line">      &#125;</span><br><span class="line">      _unknownFields = pb::UnknownFieldSet.MergeFrom(_unknownFields, other._unknownFields);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [global::System.Diagnostics.DebuggerNonUserCodeAttribute]</span><br><span class="line">    public void MergeFrom(pb::CodedInputStream input) &#123;</span><br><span class="line">      uint tag;</span><br><span class="line">      while ((tag = input.ReadTag()) != 0) &#123;</span><br><span class="line">        switch(tag) &#123;</span><br><span class="line">          default:</span><br><span class="line">            _unknownFields = pb::UnknownFieldSet.MergeFieldFrom(_unknownFields, input);</span><br><span class="line">            break;</span><br><span class="line">          case 10: &#123;</span><br><span class="line">            DifficultyLevel = input.ReadString();</span><br><span class="line">            break;</span><br><span class="line">          &#125;</span><br><span class="line">          case 16: &#123;</span><br><span class="line">            VersionNumber = input.ReadInt32();</span><br><span class="line">            break;</span><br><span class="line">          &#125;</span><br><span class="line">          case 24: &#123;</span><br><span class="line">            ResourceNumber = input.ReadInt32();</span><br><span class="line">            break;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  #endregion</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#endregion Designer generated code</span><br></pre></td></tr></table></figure></p>
<ol>
<li>使用生成的代码进行序列化和反序列化数据测试<br>UIDebugMonoScript.cs<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span><br><span class="line"> * Description:             UIDebugMonoScript.cs</span><br><span class="line"> * Author:                  TONYTANG</span><br><span class="line"> * Create Date:             2018/08/19</span><br><span class="line"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> GameData;</span><br><span class="line"><span class="keyword">using</span> Google.Protobuf;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> UnityEngine.UI;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="xmlDocTag">///</span> UIDebugMonoScript.cs</span></span><br><span class="line"><span class="comment"><span class="xmlDocTag">///</span> 快速访问UI组件测试挂在脚本</span></span><br><span class="line"><span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UIDebugMonoScript</span> : <span class="title">MonoBehaviour</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> 创建GameConfig按钮</span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> Button mBtnCreateGameConfig;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> 读取GameConfig按钮</span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> Button mBtnReadGameConfig;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Start</span>(<span class="params"></span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        mBtnCreateGameConfig.onClick.AddListener(onCreateGameConfigClick);</span><br><span class="line">        mBtnReadGameConfig.onClick.AddListener(onReadGameConfigClick);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnDestroy</span>(<span class="params"></span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        mBtnCreateGameConfig.onClick.RemoveAllListeners();</span><br><span class="line">        mBtnReadGameConfig.onClick.RemoveAllListeners();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> 创建GameConfig按钮点击</span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onCreateGameConfigClick</span>(<span class="params"></span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        Debug.Log(<span class="string">"onCreateGameConfigClick()"</span>);</span><br><span class="line">        Debug.Log(<span class="string">"PathUtilities.ProtobufDataFolderPath : "</span> + PathUtilities.ProtobufDataFolderPath);</span><br><span class="line">        PathUtilities.checkAndCreateFolder(PathUtilities.ProtobufDataFolderPath);</span><br><span class="line">        GameConfig gameconfig = <span class="keyword">new</span> GameConfig();</span><br><span class="line">        gameconfig.DifficultyLevel = <span class="string">"Easy"</span>;</span><br><span class="line">        gameconfig.VersionNumber = <span class="number">1</span>;</span><br><span class="line">        gameconfig.ResourceNumber = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">using</span> (<span class="keyword">var</span> output = File.Create(PathUtilities.ProtobufDataFolderPath + <span class="string">"GameConfig.data"</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            gameconfig.WriteTo(output);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> 读取GameConfig按钮点击</span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onReadGameConfigClick</span>(<span class="params"></span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        Debug.Log(<span class="string">"onReadGameConfigClick()"</span>);</span><br><span class="line">        Debug.Log(<span class="string">"PathUtilities.ProtobufDataFolderPath : "</span> + PathUtilities.ProtobufDataFolderPath);</span><br><span class="line">        GameConfig gameconfig;</span><br><span class="line">        <span class="keyword">using</span> (<span class="keyword">var</span> intput = File.OpenRead(PathUtilities.ProtobufDataFolderPath + <span class="string">"GameConfig.data"</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            gameconfig = GameConfig.Parser.ParseFrom(intput);</span><br><span class="line">        &#125;</span><br><span class="line">        Debug.Log(<span class="string">"gameconfig.DifficultyLevel : "</span> + gameconfig.DifficultyLevel);</span><br><span class="line">        Debug.Log(<span class="string">"gameconfig.VersionNumber : "</span> + gameconfig.VersionNumber);</span><br><span class="line">        Debug.Log(<span class="string">"gameconfig.ResourceNumber : "</span> + gameconfig.ResourceNumber);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>PathUtilities.cs<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span><br><span class="line"> * Description:             路径静态工具类</span><br><span class="line"> * Author:                  tanghuan</span><br><span class="line"> * Create Date:             2018/03/12</span><br><span class="line"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="xmlDocTag">///</span> 路径静态工具类</span></span><br><span class="line"><span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">PathUtilities</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//******</span></span><br><span class="line"></span><br><span class="line">    <span class="preprocessor">#<span class="keyword">region</span> Protobuf</span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">if</span> UNITY_EDITOR</span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> Protobuf生成数据目录</span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">string</span> ProtobufDataFolderPath = Application.dataPath + <span class="string">"/Resources/ProtoData/"</span>;</span><br><span class="line"><span class="preprocessor">#<span class="keyword">elif</span> UNITY_ANDROID</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">string</span> ProtobufDataFolderPath = Application.temporaryCachePath + <span class="string">"/ProtoData/"</span>;</span><br><span class="line"><span class="preprocessor">#<span class="keyword">elif</span> UNITY_IOS</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">string</span> ProtobufDataFolderPath = Application.temporaryCachePath + <span class="string">"/ProtoData/"</span>;</span><br><span class="line"><span class="preprocessor">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="preprocessor">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">    <span class="preprocessor">#<span class="keyword">region</span> 公用方法</span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> 检查并确保目录存在</span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="folderpath"&gt;</span><span class="xmlDocTag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">checkAndCreateFolder</span>(<span class="params"><span class="keyword">string</span> folderpath</span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!Directory.Exists(folderpath))</span><br><span class="line">        &#123;</span><br><span class="line">            Directory.CreateDirectory(folderpath);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="preprocessor">#<span class="keyword">endregion</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>PC:<br><img src="/img/Unity/Data-Config-Automation/ProtobufSerialization.png" alt="ProtobufSerialization"><br>Android:<br><img src="/img/Unity/Data-Config-Automation/ProtobufSerializationAndroidPlatform.png" alt="ProtobufSerializationAndroidPlatform"><br>可以看到我们在PC和Android都成功使用Protobuf3进行了数据的序列化和反序列化。<br>接下来我们要完成的是测试同样的二进制序列化文件，通过Python版的Protobuf3是否能够正确的反序列化读取(验证跨语言数据存储读取)。</p>
<p>Protobuf Python篇：</p>
<ol>
<li>安装python</li>
<li>下载<a href="https://github.com/google/protobuf/releases/download/v3.6.1/protoc-3.6.1-win32.zip" target="_blank" rel="external">Protoc.exe</a>用于安装生成python版proto文件对应的解析所需文件</li>
<li>下载对应版本的<a href="https://github.com/google/protobuf/releases/download/v3.6.1/protobuf-python-3.6.1.zip" target="_blank" rel="external">Protobuf 3 Python版本</a>(这里我下的和Csharp版本的Protobuf3一样的版本3.6.1)</li>
<li>安装Protobuf 3 Python所需环境(在下载的Protobuf3 Python的Python原代码下运行python setup.py install)<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python setup.py install</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>安装完成后会发现Protobuf 3 For Python相关的Package环境都被下载到了site-packages目录：<br><img src="/img/Unity/Data-Config-Automation/InstallProtobuf3EnviromentForPython.png" alt="Protobuf3ForPythonSetup"></p>
<ol>
<li>编译Proto文件生成解析所需文件<br>依然使用protoc.exe，但这一次指定的输出代码是针对python的:<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">protoc.exe --python_out=PythonCode -I=Proto GameConfig.proto</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>GameConfig_pb2.py<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Generated by the protocol buffer compiler.  DO NOT EDIT!</span></span><br><span class="line"><span class="comment"># source: GameConfig.proto</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">_b=sys.version_info[<span class="number">0</span>]&lt;<span class="number">3</span> <span class="keyword">and</span> (<span class="keyword">lambda</span> x:x) <span class="keyword">or</span> (<span class="keyword">lambda</span> x:x.encode(<span class="string">'latin1'</span>))</span><br><span class="line"><span class="keyword">from</span> google.protobuf <span class="keyword">import</span> descriptor <span class="keyword">as</span> _descriptor</span><br><span class="line"><span class="keyword">from</span> google.protobuf <span class="keyword">import</span> message <span class="keyword">as</span> _message</span><br><span class="line"><span class="keyword">from</span> google.protobuf <span class="keyword">import</span> reflection <span class="keyword">as</span> _reflection</span><br><span class="line"><span class="keyword">from</span> google.protobuf <span class="keyword">import</span> symbol_database <span class="keyword">as</span> _symbol_database</span><br><span class="line"><span class="comment"># @@protoc_insertion_point(imports)</span></span><br><span class="line"></span><br><span class="line">_sym_db = _symbol_database.Default()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">DESCRIPTOR = _descriptor.FileDescriptor(</span><br><span class="line">  name=<span class="string">'GameConfig.proto'</span>,</span><br><span class="line">  package=<span class="string">'GameData'</span>,</span><br><span class="line">  syntax=<span class="string">'proto3'</span>,</span><br><span class="line">  serialized_options=<span class="keyword">None</span>,</span><br><span class="line">  serialized_pb=_b(<span class="string">'\n\x10GameConfig.proto\x12\x08GameData\"T\n\nGameConfig\x12\x17\n\x0f\x64ifficultyLevel\x18\x01 \x01(\t\x12\x15\n\rversionNumber\x18\x02 \x01(\x05\x12\x16\n\x0eresourceNumber\x18\x03 \x01(\x05\x62\x06proto3'</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">_GAMECONFIG = _descriptor.Descriptor(</span><br><span class="line">  name=<span class="string">'GameConfig'</span>,</span><br><span class="line">  full_name=<span class="string">'GameData.GameConfig'</span>,</span><br><span class="line">  filename=<span class="keyword">None</span>,</span><br><span class="line">  file=DESCRIPTOR,</span><br><span class="line">  containing_type=<span class="keyword">None</span>,</span><br><span class="line">  fields=[</span><br><span class="line">    _descriptor.FieldDescriptor(</span><br><span class="line">      name=<span class="string">'difficultyLevel'</span>, full_name=<span class="string">'GameData.GameConfig.difficultyLevel'</span>, index=<span class="number">0</span>,</span><br><span class="line">      number=<span class="number">1</span>, type=<span class="number">9</span>, cpp_type=<span class="number">9</span>, label=<span class="number">1</span>,</span><br><span class="line">      has_default_value=<span class="keyword">False</span>, default_value=_b(<span class="string">""</span>).decode(<span class="string">'utf-8'</span>),</span><br><span class="line">      message_type=<span class="keyword">None</span>, enum_type=<span class="keyword">None</span>, containing_type=<span class="keyword">None</span>,</span><br><span class="line">      is_extension=<span class="keyword">False</span>, extension_scope=<span class="keyword">None</span>,</span><br><span class="line">      serialized_options=<span class="keyword">None</span>, file=DESCRIPTOR),</span><br><span class="line">    _descriptor.FieldDescriptor(</span><br><span class="line">      name=<span class="string">'versionNumber'</span>, full_name=<span class="string">'GameData.GameConfig.versionNumber'</span>, index=<span class="number">1</span>,</span><br><span class="line">      number=<span class="number">2</span>, type=<span class="number">5</span>, cpp_type=<span class="number">1</span>, label=<span class="number">1</span>,</span><br><span class="line">      has_default_value=<span class="keyword">False</span>, default_value=<span class="number">0</span>,</span><br><span class="line">      message_type=<span class="keyword">None</span>, enum_type=<span class="keyword">None</span>, containing_type=<span class="keyword">None</span>,</span><br><span class="line">      is_extension=<span class="keyword">False</span>, extension_scope=<span class="keyword">None</span>,</span><br><span class="line">      serialized_options=<span class="keyword">None</span>, file=DESCRIPTOR),</span><br><span class="line">    _descriptor.FieldDescriptor(</span><br><span class="line">      name=<span class="string">'resourceNumber'</span>, full_name=<span class="string">'GameData.GameConfig.resourceNumber'</span>, index=<span class="number">2</span>,</span><br><span class="line">      number=<span class="number">3</span>, type=<span class="number">5</span>, cpp_type=<span class="number">1</span>, label=<span class="number">1</span>,</span><br><span class="line">      has_default_value=<span class="keyword">False</span>, default_value=<span class="number">0</span>,</span><br><span class="line">      message_type=<span class="keyword">None</span>, enum_type=<span class="keyword">None</span>, containing_type=<span class="keyword">None</span>,</span><br><span class="line">      is_extension=<span class="keyword">False</span>, extension_scope=<span class="keyword">None</span>,</span><br><span class="line">      serialized_options=<span class="keyword">None</span>, file=DESCRIPTOR),</span><br><span class="line">  ],</span><br><span class="line">  extensions=[</span><br><span class="line">  ],</span><br><span class="line">  nested_types=[],</span><br><span class="line">  enum_types=[</span><br><span class="line">  ],</span><br><span class="line">  serialized_options=<span class="keyword">None</span>,</span><br><span class="line">  is_extendable=<span class="keyword">False</span>,</span><br><span class="line">  syntax=<span class="string">'proto3'</span>,</span><br><span class="line">  extension_ranges=[],</span><br><span class="line">  oneofs=[</span><br><span class="line">  ],</span><br><span class="line">  serialized_start=<span class="number">30</span>,</span><br><span class="line">  serialized_end=<span class="number">114</span>,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">DESCRIPTOR.message_types_by_name[<span class="string">'GameConfig'</span>] = _GAMECONFIG</span><br><span class="line">_sym_db.RegisterFileDescriptor(DESCRIPTOR)</span><br><span class="line"></span><br><span class="line">GameConfig = _reflection.GeneratedProtocolMessageType(<span class="string">'GameConfig'</span>, (_message.Message,), dict(</span><br><span class="line">  DESCRIPTOR = _GAMECONFIG,</span><br><span class="line">  __module__ = <span class="string">'GameConfig_pb2'</span></span><br><span class="line">  <span class="comment"># @@protoc_insertion_point(class_scope:GameData.GameConfig)</span></span><br><span class="line">  ))</span><br><span class="line">_sym_db.RegisterMessage(GameConfig)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># @@protoc_insertion_point(module_scope)</span></span><br></pre></td></tr></table></figure></p>
<ol>
<li>利用Python的Proto代码序列化(或者反序列化C#序列化的)数据<br>反序列化C#序列化的数据事例：<br>GameConfigSerialization.py<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># File Name:        GameConfigSerialization.py</span></span><br><span class="line"><span class="comment"># Description:      This file is used to Serialize GameConfig Data</span></span><br><span class="line"><span class="comment"># Author:           TangHuan</span></span><br><span class="line"><span class="comment"># Create Date:      2018/08/20</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> GameConfig_pb2</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">gameconfig = GameConfig_pb2.GameConfig()</span><br><span class="line"></span><br><span class="line"><span class="comment"># Read the existing GameConfig.data</span></span><br><span class="line">f = open(<span class="string">"GameConfig.data"</span>, <span class="string">"rb"</span>)</span><br><span class="line">gameconfig.ParseFromString(f.read())</span><br><span class="line">f.close()</span><br><span class="line"></span><br><span class="line">print(<span class="string">"gameconfig.difficultyLevel = &#123;&#125;"</span>.format(gameconfig.difficultyLevel))</span><br><span class="line">print(<span class="string">"gameconfig.versionNumber = &#123;&#125;"</span>.format(gameconfig.versionNumber))</span><br><span class="line">print(<span class="string">"gameconfig.resourceNumber = &#123;&#125;"</span>.format(gameconfig.resourceNumber))</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p><img src="/img/Unity/Data-Config-Automation/PythonPB3DeserilizationFileStructure.png" alt="PythonPB3DeserilizationFileStructure"><br><img src="/img/Unity/Data-Config-Automation/PythonPB3Deserialization.png" alt="PythonPB3Deserialization"><br>可以看到我们成功的反序列化了C#序列化的数据(*证明了PB3跨语言的序列化反序列化支持)</p>
<p>Python PB3序列化数据事例:<br>GameConfigSerialization.py<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># File Name:        GameConfigSerialization.py</span></span><br><span class="line"><span class="comment"># Description:      This file is used to Serialize GameConfig Data</span></span><br><span class="line"><span class="comment"># Author:           TangHuan</span></span><br><span class="line"><span class="comment"># Create Date:      2018/08/20</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> GameConfig_pb2</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">gameconfig = GameConfig_pb2.GameConfig()</span><br><span class="line">gameconfig.difficultyLevel = <span class="string">"Hard"</span></span><br><span class="line">gameconfig.versionNumber = <span class="number">2</span></span><br><span class="line">gameconfig.resourceNumber = <span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Write the new GmaeConfig back to disk.</span></span><br><span class="line">f = open(<span class="string">"GameConfig_Py.data"</span>, <span class="string">"wb"</span>)</span><br><span class="line">f.write(gameconfig.SerializeToString())</span><br><span class="line">f.close()</span><br></pre></td></tr></table></figure></p>
<p>CSharp PB3反序列化:<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GameConfig gameconfig;</span><br><span class="line"><span class="keyword">using</span> (<span class="keyword">var</span> intput = File.OpenRead(PathUtilities.ProtobufDataFolderPath + <span class="string">"GameConfig_Py.data"</span>))</span><br><span class="line">&#123;</span><br><span class="line">    gameconfig = GameConfig.Parser.ParseFrom(intput);</span><br><span class="line">&#125;</span><br><span class="line">Debug.Log(<span class="string">"gameconfig.DifficultyLevel : "</span> + gameconfig.DifficultyLevel);</span><br><span class="line">Debug.Log(<span class="string">"gameconfig.VersionNumber : "</span> + gameconfig.VersionNumber);</span><br><span class="line">Debug.Log(<span class="string">"gameconfig.ResourceNumber : "</span> + gameconfig.ResourceNumber);</span><br></pre></td></tr></table></figure></p>
<p><img src="/img/Unity/Data-Config-Automation/CSharpPB3DeserilizationFileStructure.png" alt="CSharpPB3DeserilizationFileStructure"><br><img src="/img/Unity/Data-Config-Automation/CSharpPB3Deserialization.png" alt="CSharpPB3Deserialization"><br>可以看到我们也成功的通过C#的PB3反序列化了Python序列化的数据。这也验证了Protocol Buffer 3<em>跨语言的特性</em>。</p>
<p>Note:<br>Protocol Buffer很适合跨平台跨语言通信，用于网络通信定义数据结构。(待学习)</p>
<h4 id="FlatBuff">FlatBuff</h4><p>在介绍FlatBuff前，让我们来看一张令人惊艳的各序列化方案测试性能对比图：<br><a href="https://github.com/CodeZeg/xbuffer" target="_blank" rel="external">图1来源至XBuffer的性能测试</a>:<br><img src="/img/Unity/Data-Config-Automation/SerializationPerformanceComparision.png" alt="SerializationPerformanceComparision"></p>
<p><a href="https://google.github.io/flatbuffers/flatbuffers_benchmarks.html" target="_blank" rel="external">图2来源至FlatBuff官方性能Benchmark</a>:<br><img src="/img/Unity/Data-Config-Automation/FlatBuffPerformanceBenchmark.png" alt="FlatBuffPerformanceBenchmark"></p>
<p>从上面两张图可以看到，令人惊讶的FlatBuff性能，无论是序列化还是反序列化，FlatBuff都相当高效，反序列化的时间居然几乎为0。</p>
<p>接下来我们深入学习了解FlatBuff，洞察其中的奥妙。</p>
<h5 id="介绍">介绍</h5><p><a href="https://google.github.io/flatbuffers/" target="_blank" rel="external">官网FlatBuffer</a><br><a href="google.github.io/flatbuffers">Represents hierachical data in a flat binary buffer in such a way that it can still be acecssed directly without parsing/unpacking, while also still supporting data structure evolution(forwards/backwards compatibility)</a><br>根据官方的介绍，FlatBuff把数据存储在一个扁平化的二进制Buffer里，这样一来FlatBuff访问和解析数据时可以向访问数据结构一样快速不需要解析或者解包(这应该就是为什么FlatBuff的反序列化时间几乎为0的原因)</p>
<p>这里简单列举下官方给出的FlatBuffer的好处:</p>
<ol>
<li>Access to serialized data without parsing/unpacking(访问序列化数据块)</li>
<li>Memory efficiency and speed(内存和速度都很高效)</li>
<li>Flexible(向前向后兼容)</li>
<li>Tiny code footprint(生成代码量少且无依赖)</li>
<li>Strongly typed</li>
<li>Convenient to use(使用简单？)</li>
<li>Cross platform code with no dependencies(跨平台无依赖)</li>
</ol>
<p><a href="https://google.github.io/flatbuffers/" target="_blank" rel="external">详情参考官网介绍</a></p>
<h5 id="实战使用">实战使用</h5><p>接下来先按教程学习使用一波，再来看看底层的实现和优缺点：<br>使用步骤：</p>
<ol>
<li>编写schema文件(定义数据结构)<br>GameConfigFB.fbs<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">namespace GameData;&#10;&#10;table GameConfigFB&#123;&#10;  difficultyLevel:string;           // &#28216;&#25103;&#38590;&#24230;&#10;  versionNumber:int;                // &#28216;&#25103;&#29256;&#26412;&#21495;&#10;  resourceNumber:int;               // &#28216;&#25103;&#36164;&#28304;&#29256;&#26412;&#21495;&#10;&#125;&#10;&#10;root_type GameConfigFB;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p><a href="https://google.github.io/flatbuffers/flatbuffers_guide_writing_schema.html" target="_blank" rel="external">schema文件编写参考</a></p>
<ol>
<li>使用Flatc.exe(可以自己编译源码，也可以<a href="https://github.com/google/flatbuffers/releases" target="_blank" rel="external">下载现成的</a>)编译解析schema文件生成序列化和反序列化数据所需代码<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./../flatc.exe --csharp .\GameConifgFB.fbs</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>GameConfigFB.cs<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">// &lt;auto-generated&gt;</span><br><span class="line">//  automatically generated by the FlatBuffers compiler, do not modify</span><br><span class="line">// &lt;/auto-generated&gt;</span><br><span class="line"></span><br><span class="line">namespace GameData</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">using global::System;</span><br><span class="line">using global::FlatBuffers;</span><br><span class="line"></span><br><span class="line">public struct GameConfigFB : IFlatbufferObject</span><br><span class="line">&#123;</span><br><span class="line">  private Table __p;</span><br><span class="line">  public ByteBuffer ByteBuffer &#123; get &#123; return __p.bb; &#125; &#125;</span><br><span class="line">  public static GameConfigFB GetRootAsGameConfigFB(ByteBuffer _bb) &#123; return GetRootAsGameConfigFB(_bb, new GameConfigFB()); &#125;</span><br><span class="line">  public static GameConfigFB GetRootAsGameConfigFB(ByteBuffer _bb, GameConfigFB obj) &#123; return (obj.__assign(_bb.GetInt(_bb.Position) + _bb.Position, _bb)); &#125;</span><br><span class="line">  public void __init(int _i, ByteBuffer _bb) &#123; __p.bb_pos = _i; __p.bb = _bb; &#125;</span><br><span class="line">  public GameConfigFB __assign(int _i, ByteBuffer _bb) &#123; __init(_i, _bb); return this; &#125;</span><br><span class="line"></span><br><span class="line">  public string DifficultyLevel &#123; get &#123; int o = __p.__offset(4); return o != 0 ? __p.__string(o + __p.bb_pos) : null; &#125; &#125;</span><br><span class="line">  public ArraySegment&lt;byte&gt;? GetDifficultyLevelBytes() &#123; return __p.__vector_as_arraysegment(4); &#125;</span><br><span class="line">  public int VersionNumber &#123; get &#123; int o = __p.__offset(6); return o != 0 ? __p.bb.GetInt(o + __p.bb_pos) : (int)0; &#125; &#125;</span><br><span class="line">  public int ResourceNumber &#123; get &#123; int o = __p.__offset(8); return o != 0 ? __p.bb.GetInt(o + __p.bb_pos) : (int)0; &#125; &#125;</span><br><span class="line"></span><br><span class="line">  public static Offset&lt;GameConfigFB&gt; CreateGameConfigFB(FlatBufferBuilder builder,</span><br><span class="line">      StringOffset difficultyLevelOffset = default(StringOffset),</span><br><span class="line">      int versionNumber = 0,</span><br><span class="line">      int resourceNumber = 0) &#123;</span><br><span class="line">    builder.StartObject(3);</span><br><span class="line">    GameConfigFB.AddResourceNumber(builder, resourceNumber);</span><br><span class="line">    GameConfigFB.AddVersionNumber(builder, versionNumber);</span><br><span class="line">    GameConfigFB.AddDifficultyLevel(builder, difficultyLevelOffset);</span><br><span class="line">    return GameConfigFB.EndGameConfigFB(builder);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public static void StartGameConfigFB(FlatBufferBuilder builder) &#123; builder.StartObject(3); &#125;</span><br><span class="line">  public static void AddDifficultyLevel(FlatBufferBuilder builder, StringOffset difficultyLevelOffset) &#123; builder.AddOffset(0, difficultyLevelOffset.Value, 0); &#125;</span><br><span class="line">  public static void AddVersionNumber(FlatBufferBuilder builder, int versionNumber) &#123; builder.AddInt(1, versionNumber, 0); &#125;</span><br><span class="line">  public static void AddResourceNumber(FlatBufferBuilder builder, int resourceNumber) &#123; builder.AddInt(2, resourceNumber, 0); &#125;</span><br><span class="line">  public static Offset&lt;GameConfigFB&gt; EndGameConfigFB(FlatBufferBuilder builder) &#123;</span><br><span class="line">    int o = builder.EndObject();</span><br><span class="line">    return new Offset&lt;GameConfigFB&gt;(o);</span><br><span class="line">  &#125;</span><br><span class="line">  public static void FinishGameConfigFBBuffer(FlatBufferBuilder builder, Offset&lt;GameConfigFB&gt; offset) &#123; builder.Finish(offset.Value); &#125;</span><br><span class="line">  public static void FinishSizePrefixedGameConfigFBBuffer(FlatBufferBuilder builder, Offset&lt;GameConfigFB&gt; offset) &#123; builder.FinishSizePrefixed(offset.Value); &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<ol>
<li>使用FlatBufferBuilder(位于FlatBuff源码的/net/FlatBuffers目录下)根据schema生成代码序列化数据到二进制文件<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> FlatBuffers;</span><br><span class="line"><span class="keyword">using</span> GameData;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">FlatBufferStudy</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="xmlDocTag">///</span> GameConfig数据全路径</span></span><br><span class="line">        <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">const</span> <span class="keyword">string</span> GameConfigDataFullPath = <span class="string">"./GameConfig.data"</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="xmlDocTag">///</span> 存储GameConfig数据</span></span><br><span class="line">        <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">SaveGameConfigData</span>(<span class="params"></span>)</span><br><span class="line">        </span>&#123;</span><br><span class="line">            <span class="comment">// Create a `FlatBufferBuilder`, which will be used to create our</span></span><br><span class="line">            <span class="comment">// GameConfigFB' FlatBuffers.</span></span><br><span class="line">            <span class="comment">// 定义FlatBufferBulder对象用于我们构建数据对象</span></span><br><span class="line">            <span class="keyword">var</span> builder = <span class="keyword">new</span> FlatBufferBuilder(<span class="number">4</span>);</span><br><span class="line">            <span class="keyword">var</span> difficultylevel = builder.CreateString(<span class="string">"Hard-困难"</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Use the `CreateGameConfigFB()` helper function to create the GameConfigFB, since we set every field.</span></span><br><span class="line">            <span class="comment">// 往GameConfigFB里填充数据</span></span><br><span class="line">            <span class="keyword">var</span> gameconfig = GameConfigFB.CreateGameConfigFB(builder, difficultylevel, <span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Call `Finish()` to instruct the builder that this GameConfigFB is complete.</span></span><br><span class="line">            <span class="comment">// 指定GameConfigFB数据构建完成</span></span><br><span class="line">            builder.Finish(gameconfig.Value);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// This must be called after `Finish()`.</span></span><br><span class="line">            <span class="comment">// 包含GameConfigFB的二进制数据的数据对象</span></span><br><span class="line">            <span class="keyword">var</span> buf = builder.DataBuffer;</span><br><span class="line">            <span class="comment">// GameConfigFB的二进制数据</span></span><br><span class="line">            <span class="keyword">byte</span>[] bufbytes = builder.SizedByteArray();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//写入GameConfig二进制数据得到本地</span></span><br><span class="line">            <span class="keyword">using</span> (<span class="keyword">var</span> filestream = <span class="keyword">new</span> FileStream(GameConfigDataFullPath, FileMode.Create))</span><br><span class="line">            &#123;</span><br><span class="line">                filestream.Write(bufbytes, <span class="number">0</span>, bufbytes.Length);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="xmlDocTag">///</span> 读取GameConfig数据</span></span><br><span class="line">        <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ReadGameConfigData</span>(<span class="params"></span>)</span><br><span class="line">        </span>&#123;</span><br><span class="line">            <span class="comment">//写入GameConfig二进制数据得到本地</span></span><br><span class="line">            <span class="keyword">using</span> (<span class="keyword">var</span> filestream = <span class="keyword">new</span> FileStream(GameConfigDataFullPath, FileMode.Open))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">byte</span>[] bufbytes = <span class="keyword">new</span> <span class="keyword">byte</span>[filestream.Length];</span><br><span class="line">                filestream.Read(bufbytes, <span class="number">0</span>, bufbytes.Length);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Get an accessor to the root object inside the buffer.</span></span><br><span class="line">                <span class="comment">// 通过字节流数据构建FlatBuff所需的Buf对象，然后使用该Buf对象通过FlatBuff构建GameConfigFB对象</span></span><br><span class="line">                <span class="keyword">var</span> buf = <span class="keyword">new</span> ByteBuffer(bufbytes);</span><br><span class="line">                <span class="keyword">var</span> gameconfig = GameConfigFB.GetRootAsGameConfigFB(buf);</span><br><span class="line"></span><br><span class="line">                Console.WriteLine(<span class="string">"gameconfig.DifficultyLevel : "</span> + gameconfig.DifficultyLevel);</span><br><span class="line">                Console.WriteLine(<span class="string">"gameconfig.VersionNumber : "</span> + gameconfig.VersionNumber);</span><br><span class="line">                Console.WriteLine(<span class="string">"gameconfig.ResourceNumber : "</span> + gameconfig.ResourceNumber);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="keyword">string</span>[] args</span>)</span><br><span class="line">        </span>&#123;</span><br><span class="line">            SaveGameConfigData();</span><br><span class="line"></span><br><span class="line">            ReadGameConfigData();</span><br><span class="line"></span><br><span class="line">            Console.WriteLine(<span class="string">"结束!"</span>);</span><br><span class="line"></span><br><span class="line">            Console.ReadKey();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p><img src="/img/Unity/Data-Config-Automation/FlatBuffGameConfigDataOutput.png" alt="FlatBuffGameConfigDataOutput"><br><img src="/img/Unity/Data-Config-Automation/FlatBuffOutput.png" alt="FlatBuffOutput"><br>可以看到我们成功通过FlatBuff序列化反序列化出了我们想要的数据。</p>
<p>通过上面的使用，可以看出FlatBuff在使用灵活度方面还是比较欠缺，对于数据的填充构建都是通过FlatBufferBuilder按指定填充方式构建数据并填充进去。</p>
<p>这里暂时没有对性能进行测试，具体性能对比参考前面给出过的对比图。</p>
<p>Note：<br>当我把FlatBuffer的.Net代码放进Unity时，我发现里面用到了C# 6.0的高阶语言特性，导致Unity里无法编译通过，所以上面的测试是脱离Unity基于.Net C#工程来测试的。</p>
<h5 id="深入探究">深入探究</h5><p>这一步，让我们结合上面的学习用例来探究下FlatBuffer是如何实现高效的序列化和反序列化读取的。</p>
<p>通过学习了解FlatBuffer下面几个核心的类来理解学习:</p>
<ol>
<li><p>FlatBufferBuilder.cs(FlatBuffer构建填充数据的对外接口)</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="xmlDocTag">///</span> Responsible for building up and accessing a FlatBuffer formatted byte</span></span><br><span class="line"><span class="comment"><span class="xmlDocTag">///</span> array (via ByteBuffer).</span></span><br><span class="line"><span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">FlatBufferBuilder</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> _space;</span><br><span class="line">    <span class="keyword">private</span> ByteBuffer _bb;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> _minAlign = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The vtable for the current table (if _vtableSize &gt;= 0)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span>[] _vtable = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">16</span>];</span><br><span class="line">    <span class="comment">// The size of the vtable. -1 indicates no vtable</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> _vtableSize = -<span class="number">1</span>;</span><br><span class="line">    <span class="comment">// Starting offset of the current struct/table.</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> _objectStart;</span><br><span class="line">    <span class="comment">// List of offsets of all vtables.</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span>[] _vtables = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">16</span>];</span><br><span class="line">    <span class="comment">// Number of entries in `vtables` in use.</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> _numVtables = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// For the current vector being built.</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> _vectorNumElems = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> Create a FlatBufferBuilder with a given initial size.</span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="initialSize"&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> The initial size to use for the internal buffer.</span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">FlatBufferBuilder</span>(<span class="params"><span class="keyword">int</span> initialSize</span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (initialSize &lt;= <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentOutOfRangeException(<span class="string">"initialSize"</span>,</span><br><span class="line">                initialSize, <span class="string">"Must be greater than zero"</span>);</span><br><span class="line">        _space = initialSize;</span><br><span class="line">        _bb = <span class="keyword">new</span> ByteBuffer(initialSize);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">AddInt</span>(<span class="params"><span class="keyword">int</span> o, <span class="keyword">int</span> x, <span class="keyword">int</span> d</span>) </span><br><span class="line">    </span>&#123; </span><br><span class="line">        <span class="keyword">if</span> (ForceDefaults || x != d) </span><br><span class="line">        &#123; </span><br><span class="line">            AddInt(x); Slot(o); </span><br><span class="line">        &#125; </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> 这里只截图了FlatBufferBuilder成员变量定义和部分函数定义。</p>
</li>
<li><p>ByteBuffer.cs(定义不同数据类型的byte数据分配以及填充，读取)</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ByteBuffer</span> : <span class="title">IDisposable</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> ByteBufferAllocator _buffer;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> _pos;  <span class="comment">// Must track start of the buffer.</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ByteBuffer</span>(<span class="params">ByteBufferAllocator allocator, <span class="keyword">int</span> position</span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        _buffer = allocator;</span><br><span class="line">        _pos = position;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ByteBuffer</span>(<span class="params"><span class="keyword">int</span> size</span>) : <span class="title">this</span>(<span class="params">new <span class="keyword">byte</span>[size]</span>) </span>&#123; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ByteBuffer</span>(<span class="params"><span class="keyword">byte</span>[] buffer</span>) : <span class="title">this</span>(<span class="params">buffer, <span class="number">0</span></span>) </span>&#123; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ByteBuffer</span>(<span class="params"><span class="keyword">byte</span>[] buffer, <span class="keyword">int</span> pos</span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        _buffer = <span class="keyword">new</span> ByteArrayAllocator(buffer);</span><br><span class="line">        _pos = pos;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Dispose</span>(<span class="params"></span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (_buffer != <span class="keyword">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            _buffer.Dispose();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> Position &#123;</span><br><span class="line">        <span class="keyword">get</span> &#123; <span class="keyword">return</span> _pos; &#125;</span><br><span class="line">        <span class="keyword">set</span> &#123; _pos = <span class="keyword">value</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> Length &#123; <span class="keyword">get</span> &#123; <span class="keyword">return</span> _buffer.Length; &#125; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Reset</span>(<span class="params"></span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        _pos = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Increases the size of the ByteBuffer, and copies the old data towards</span></span><br><span class="line">    <span class="comment">// the end of the new buffer.</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">GrowFront</span>(<span class="params"><span class="keyword">int</span> newSize</span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        _buffer.GrowFront(newSize);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">PutStringUTF8</span>(<span class="params"><span class="keyword">int</span> offset, <span class="keyword">string</span> <span class="keyword">value</span></span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        AssertOffsetAndLength(offset, <span class="keyword">value</span>.Length);</span><br><span class="line">        Encoding.UTF8.GetBytes(<span class="keyword">value</span>, <span class="number">0</span>, <span class="keyword">value</span>.Length,</span><br><span class="line">            _buffer.ByteArray, offset);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="preprocessor">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">PutInt</span>(<span class="params"><span class="keyword">int</span> offset, <span class="keyword">int</span> <span class="keyword">value</span></span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        PutUint(offset, (<span class="keyword">uint</span>)<span class="keyword">value</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">WriteLittleEndian</span>(<span class="params"><span class="keyword">int</span> offset, <span class="keyword">int</span> count, <span class="keyword">ulong</span> data</span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (BitConverter.IsLittleEndian)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                _buffer.Buffer[offset + i] = (<span class="keyword">byte</span>)(data &gt;&gt; i * <span class="number">8</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                _buffer.Buffer[offset + count - <span class="number">1</span> - i] = (<span class="keyword">byte</span>)(data &gt;&gt; i * <span class="number">8</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>ByteBufferAllocator.cs(抽象二进制byte数据的分配管理)</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title">ByteBufferAllocator</span> : <span class="title">IDisposable</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="preprocessor">#<span class="keyword">if</span> UNSAFE_BYTEBUFFER</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">unsafe</span> <span class="keyword">byte</span>* Buffer</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="preprocessor">#<span class="keyword">else</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">byte</span>[] Buffer</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="preprocessor">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> Length</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">Dispose</span>(<span class="params"></span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">GrowFront</span>(<span class="params"><span class="keyword">int</span> newSize</span>)</span>;</span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#<span class="keyword">if</span> !ENABLE_SPAN_T</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">byte</span>[] ByteArray &#123; <span class="keyword">get</span>; &#125;</span><br><span class="line"><span class="preprocessor">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Table.cs(抽象FlatBuffer自定义结构的数据存储以及读取)</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">struct</span> Table</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> bb_pos;</span><br><span class="line">    <span class="keyword">public</span> ByteBuffer bb;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> ByteBuffer ByteBuffer &#123; <span class="keyword">get</span> &#123; <span class="keyword">return</span> bb; &#125; &#125;</span><br><span class="line"></span><br><span class="line">    *******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>数据序列化存储部分：<br>可以看出我们所有的数据最终都被写入在一个一维的byte数组里，而Flatbuffer通过按指定方式往byte数组里填充数据实现对数据的序列化存储。<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">FlatBufferBuilder</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> ByteBuffer _bb;</span><br><span class="line"></span><br><span class="line">    *******</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ByteBuffer</span> : <span class="title">IDisposable</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> ByteBufferAllocator _buffer;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">PutStringUTF8</span>(<span class="params"><span class="keyword">int</span> offset, <span class="keyword">string</span> <span class="keyword">value</span></span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        ******</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">PutInt</span>(<span class="params"><span class="keyword">int</span> offset, <span class="keyword">int</span> <span class="keyword">value</span></span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        PutUint(offset, (<span class="keyword">uint</span>)<span class="keyword">value</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">WriteLittleEndian</span>(<span class="params"><span class="keyword">int</span> offset, <span class="keyword">int</span> count, <span class="keyword">ulong</span> data</span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        ******</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ByteArrayAllocator</span> : <span class="title">ByteBufferAllocator</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">byte</span>[] _buffer;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">GrowFront</span>(<span class="params"><span class="keyword">int</span> newSize</span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        _buffer.GrowFront(newSize);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>数据反序列化读取部分；<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">struct</span> GameConfigFB : IFlatbufferObject</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> Table __p;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> ByteBuffer ByteBuffer </span><br><span class="line">    &#123; </span><br><span class="line">      <span class="keyword">get</span> &#123; <span class="keyword">return</span> __p.bb; &#125; </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> GameConfigFB <span class="title">GetRootAsGameConfigFB</span>(<span class="params">ByteBuffer _bb</span>) </span><br><span class="line">    </span>&#123; </span><br><span class="line">       <span class="keyword">return</span> GetRootAsGameConfigFB(_bb, <span class="keyword">new</span> GameConfigFB()); </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> GameConfigFB <span class="title">GetRootAsGameConfigFB</span>(<span class="params">ByteBuffer _bb, GameConfigFB obj</span>) </span><br><span class="line">    </span>&#123; </span><br><span class="line">        <span class="keyword">return</span> (obj.__assign(_bb.GetInt(_bb.Position) + _bb.Position, _bb)); </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> __init(<span class="keyword">int</span> _i, ByteBuffer _bb) </span><br><span class="line">    &#123; </span><br><span class="line">        __p.bb_pos = _i; __p.bb = _bb; </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> GameConfigFB __assign(<span class="keyword">int</span> _i, ByteBuffer _bb) </span><br><span class="line">    &#123; </span><br><span class="line">        __init(_i, _bb); <span class="keyword">return</span> <span class="keyword">this</span>; </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">string</span> DifficultyLevel </span><br><span class="line">    &#123; </span><br><span class="line">        <span class="keyword">get</span> &#123; <span class="keyword">int</span> o = __p.__offset(<span class="number">4</span>); <span class="keyword">return</span> o != <span class="number">0</span> ? __p.__string(o + __p.bb_pos) : <span class="keyword">null</span>; &#125; </span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    </span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>可以看到当我们通过以下代码读取二进制数据构建我们自定义的GameConfigFB对象时,我们已经把二进制数据按FlatBuffer存储的方式读取进来:<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> buf = <span class="keyword">new</span> ByteBuffer(bufbytes);</span><br><span class="line"><span class="keyword">var</span> gameconfig = GameConfigFB.GetRootAsGameConfigFB(buf);</span><br></pre></td></tr></table></figure></p>
<p>然后通过Table按自定义的数据结构读取指定的偏移把数据成功读取出来(这应该也是为什么FlatBuffer反序列化读取能这么高效的原因):<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">struct</span> GameConfigFB : IFlatbufferObject</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> ArraySegment&lt;<span class="keyword">byte</span>&gt;? GetDifficultyLevelBytes() </span><br><span class="line">    &#123; </span><br><span class="line">        <span class="keyword">return</span> __p.__vector_as_arraysegment(<span class="number">4</span>); </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> VersionNumber </span><br><span class="line">    &#123; </span><br><span class="line">        <span class="keyword">get</span> &#123; <span class="keyword">int</span> o = __p.__offset(<span class="number">6</span>); <span class="keyword">return</span> o != <span class="number">0</span> ? __p.bb.GetInt(o + __p.bb_pos) : (<span class="keyword">int</span>)<span class="number">0</span>; &#125; </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> ResourceNumber </span><br><span class="line">    &#123; </span><br><span class="line">        <span class="keyword">get</span> &#123; <span class="keyword">int</span> o = __p.__offset(<span class="number">8</span>); <span class="keyword">return</span> o != <span class="number">0</span> ? __p.bb.GetInt(o + __p.bb_pos) : (<span class="keyword">int</span>)<span class="number">0</span>; &#125; </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里放一张其他博客上给出的一张FlatBuffer数据存储图解加深印象，<a href="https://www.race604.com/flatbuffers-intro/" target="_blank" rel="external">下图来源</a>:<br><img src="/img/Unity/Data-Config-Automation/FlatBufferBytesStructure.png" alt="FlatBufferBytesStructure"></p>
<h4 id="Xbuffer">Xbuffer</h4><p>公司一前同事写的基于C#的简化版的Flatbuffer。<br>这里重复再放一次前面放过的性能对比图：<br><img src="/img/Unity/Data-Config-Automation/SerializationPerformanceComparision.png" alt="SerializationPerformanceComparision"><br>可以看到Xbuffer序列化和反序列化性能也相当优秀。</p>
<p>接下来我们通过实战使用和深入探究来学习其中的奥妙。</p>
<h5 id="实战使用-1">实战使用</h5><p>使用流程：</p>
<ol>
<li><p>定义数据结构文件<br>GameConfigXB.xb</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">// &#28216;&#25103;&#29256;&#26412;&#20449;&#24687;&#10;class GameConfigXB&#10;&#123;&#10;    difficultyLevel:string;             // &#28216;&#25103;&#38590;&#24230;&#10;    versionNumber:int;                  // &#28216;&#25103;&#29256;&#26412;&#21495;&#10;    resourceNumber:int;                 // &#28216;&#25103;&#36164;&#28304;&#29256;&#26412;&#21495;&#10;&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用xbuffer_parser.exe根据模板文件解析数据结构文件生成对应类文件以及对应类Xbuffer序列化反序列化所需的代码</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xbuffer_parser.exe input=GameConfigXB.xb template=&#34;templates/csharp_class.ftl&#34; output_dir=&#34;output/csharp/csharp_class/&#34; suffix=&#34;.cs&#34;&#10;xbuffer_parser.exe input=GameConfigXB.xb template=&#34;templates/csharp_buffer.ftl&#34; output_dir=&#34;output/csharp/csharp_buffer/&#34; suffix=&#34;Buffer.cs&#34;&#10;pause</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>GameConfigXB.cs(对应数据结构文件)<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 游戏版本信息</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">partial</span> <span class="keyword">class</span> <span class="title">GameConfigXB</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">string</span> difficultyLevel;              <span class="comment">// 游戏难度</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> versionNumber;               <span class="comment">// 游戏版本号</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> resourceNumber;              <span class="comment">// 游戏资源版本号</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>GameConfigXBBuffer.cs(对应数据结构Xbuffer序列化反序列化所需文件)<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">xbuffer</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">GameConfigXBBuffer</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> GameConfigXB <span class="title">deserialize</span>(<span class="params"><span class="keyword">byte</span>[] buffer, <span class="keyword">ref</span> <span class="keyword">int</span> offset</span>)</span><br><span class="line">        </span>&#123;</span><br><span class="line">            <span class="comment">// null</span></span><br><span class="line">            <span class="keyword">bool</span> _null = boolBuffer.deserialize(buffer, <span class="keyword">ref</span> offset);</span><br><span class="line">            <span class="keyword">if</span> (_null) <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// difficultyLevel</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">string</span> _difficultyLevel = stringBuffer.deserialize(buffer, <span class="keyword">ref</span> offset);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// versionNumber</span></span><br><span class="line">            <span class="keyword">int</span> _versionNumber = intBuffer.deserialize(buffer, <span class="keyword">ref</span> offset);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// resourceNumber</span></span><br><span class="line">            <span class="keyword">int</span> _resourceNumber = intBuffer.deserialize(buffer, <span class="keyword">ref</span> offset);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// value</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> GameConfigXB() &#123;</span><br><span class="line">                difficultyLevel = _difficultyLevel,</span><br><span class="line"></span><br><span class="line">                versionNumber = _versionNumber,</span><br><span class="line"></span><br><span class="line">                resourceNumber = _resourceNumber,</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">serialize</span>(<span class="params">GameConfigXB <span class="keyword">value</span>, XSteam steam</span>)</span><br><span class="line">        </span>&#123;</span><br><span class="line">            <span class="comment">// null</span></span><br><span class="line">            boolBuffer.serialize(<span class="keyword">value</span> == <span class="keyword">null</span>, steam);</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">value</span> == <span class="keyword">null</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// difficultyLevel</span></span><br><span class="line">            stringBuffer.serialize(<span class="keyword">value</span>.difficultyLevel, steam);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// versionNumber</span></span><br><span class="line">            intBuffer.serialize(<span class="keyword">value</span>.versionNumber, steam);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// resourceNumber</span></span><br><span class="line">            intBuffer.serialize(<span class="keyword">value</span>.resourceNumber, steam);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>上面生成默认的模板生成的GameConfigXBBuffer.cs貌似跟源码测试使用的接口对不上，需要把模板改成如下:<br>charp_buffer.ftl<br><figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml">namespace xbuffer</span><br><span class="line"></span><span class="expression">&#123;</span><br><span class="line">    <span class="variable">public</span> <span class="variable">static</span> <span class="variable">class</span> <span class="begin-block">#CLASS</span>_<span class="variable">NAME</span><span class="begin-block">#Buffer</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="variable">public</span> <span class="variable">static</span> <span class="begin-block">#CLASS</span>_<span class="variable">NAME</span><span class="begin-block"># deserialize</span>(<span class="variable">byte</span>[] <span class="variable">buffer</span>, <span class="variable">ref</span> <span class="variable">uint</span> <span class="variable">offset</span>)</span><br><span class="line">        &#123;</span><br><span class="line"><span class="begin-block">#<span class="keyword">IF</span></span>_<span class="variable">DESERIALIZE</span>_<span class="variable">CLASS</span>#</span><br><span class="line">            /<span class="end-block">/ null</span></span><br><span class="line">            <span class="variable">bool</span> _<span class="variable">null</span> = <span class="variable">boolBuffer.deserialize</span>(<span class="variable">buffer</span>, <span class="variable">ref</span> <span class="variable">offset</span>);</span><br><span class="line">            <span class="variable"><span class="keyword">if</span></span> (_<span class="variable">null</span>) <span class="variable">return</span> <span class="variable">null</span>;</span><br><span class="line"><span class="begin-block">#END</span>_<span class="variable">DESERIALIZE</span>_<span class="variable">CLASS</span>#</span><br><span class="line"><span class="begin-block">#DESERIALIZE</span>_<span class="variable">PROCESS</span>#</span><br><span class="line">            /<span class="end-block">/ </span><span class="begin-block">#VAR</span>_<span class="variable">NAME</span>#</span><br><span class="line"><span class="begin-block">#<span class="keyword">IF</span></span>_<span class="variable">SINGLE</span>#</span><br><span class="line">            <span class="begin-block">#VAR</span>_<span class="variable">TYPE</span><span class="begin-block"># </span>_<span class="begin-block">#VAR</span>_<span class="variable">NAME</span><span class="begin-block"># </span>= <span class="begin-block">#VAR</span>_<span class="variable">TYPE</span><span class="begin-block">#Buffer.deserialize</span>(<span class="variable">buffer</span>, <span class="variable">ref</span> <span class="variable">offset</span>);</span><br><span class="line"><span class="begin-block">#END</span>_<span class="variable">SINGLE</span>#</span><br><span class="line"><span class="begin-block">#<span class="keyword">IF</span></span>_<span class="variable">ARRAY</span>#</span><br><span class="line">            <span class="variable">int</span> _<span class="begin-block">#VAR</span>_<span class="variable">NAME</span>#_<span class="variable">length</span> = <span class="variable">intBuffer.deserialize</span>(<span class="variable">buffer</span>, <span class="variable">ref</span> <span class="variable">offset</span>);</span><br><span class="line">            <span class="begin-block">#VAR</span>_<span class="variable">TYPE</span>#[] _<span class="begin-block">#VAR</span>_<span class="variable">NAME</span><span class="begin-block"># </span>= <span class="variable">new</span> <span class="begin-block">#VAR</span>_<span class="variable">TYPE</span>#[_<span class="begin-block">#VAR</span>_<span class="variable">NAME</span>#_<span class="variable">length</span>];</span><br><span class="line">            <span class="variable">for</span> (<span class="variable">int</span> <span class="variable">i</span> = 0; <span class="variable">i</span> &lt; _<span class="begin-block">#VAR</span>_<span class="variable">NAME</span>#_<span class="variable">length</span>; <span class="variable">i</span>++)</span><br><span class="line">            &#123;</span><br><span class="line">                _<span class="begin-block">#VAR</span>_<span class="variable">NAME</span>#[<span class="variable">i</span>] = <span class="begin-block">#VAR</span>_<span class="variable">TYPE</span><span class="begin-block">#Buffer.deserialize</span>(<span class="variable">buffer</span>, <span class="variable">ref</span> <span class="variable">offset</span>);</span><br><span class="line">            &#125;</span><span class="xml"></span><br><span class="line">#END_ARRAY#</span><br><span class="line">#DESERIALIZE_PROCESS#</span><br><span class="line"></span><br><span class="line">            // value</span><br><span class="line">            return new #CLASS_NAME#() </span><span class="expression">&#123;</span><br><span class="line"><span class="begin-block">#DESERIALIZE</span>_<span class="variable">RETURN</span>#</span><br><span class="line">                <span class="begin-block">#VAR</span>_<span class="variable">NAME</span><span class="begin-block"># </span>= _<span class="begin-block">#VAR</span>_<span class="variable">NAME</span>#,</span><br><span class="line"><span class="begin-block">#DESERIALIZE</span>_<span class="variable">RETURN</span>#</span><br><span class="line">            &#125;</span><span class="xml">;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public static void serialize(#CLASS_NAME# value, XSteam steam)</span><br><span class="line">        </span><span class="expression">&#123;</span><br><span class="line"><span class="begin-block">#<span class="keyword">IF</span></span>_<span class="variable">SERIALIZE</span>_<span class="variable">CLASS</span>#</span><br><span class="line">            /<span class="end-block">/ null</span></span><br><span class="line">            <span class="variable">boolBuffer.serialize</span>(<span class="variable">value</span> == <span class="variable">null</span>, <span class="variable">steam</span>);</span><br><span class="line">            <span class="variable"><span class="keyword">if</span></span> (<span class="variable">value</span> == <span class="variable">null</span>) <span class="variable">return</span>;</span><br><span class="line"><span class="begin-block">#END</span>_<span class="variable">SERIALIZE</span>_<span class="variable">CLASS</span>#</span><br><span class="line"><span class="begin-block">#SERIALIZE</span>_<span class="variable">PROCESS</span>#</span><br><span class="line">            /<span class="end-block">/ </span><span class="begin-block">#VAR</span>_<span class="variable">NAME</span>#</span><br><span class="line"><span class="begin-block">#<span class="keyword">IF</span></span>_<span class="variable">SINGLE</span>#</span><br><span class="line">            <span class="begin-block">#VAR</span>_<span class="variable">TYPE</span><span class="begin-block">#Buffer.serialize</span>(<span class="variable">value.</span><span class="begin-block">#VAR</span>_<span class="variable">NAME</span>#, <span class="variable">steam</span>);</span><br><span class="line"><span class="begin-block">#END</span>_<span class="variable">SINGLE</span>#</span><br><span class="line"><span class="begin-block">#<span class="keyword">IF</span></span>_<span class="variable">ARRAY</span>#</span><br><span class="line">            <span class="variable">intBuffer.serialize</span>(<span class="variable">value.</span><span class="begin-block">#VAR</span>_<span class="variable">NAME</span><span class="begin-block">#.Length</span>, <span class="variable">steam</span>);</span><br><span class="line">            <span class="variable">for</span> (<span class="variable">int</span> <span class="variable">i</span> = 0; <span class="variable">i</span> &lt; <span class="variable">value.</span><span class="begin-block">#VAR</span>_<span class="variable">NAME</span><span class="begin-block">#.Length</span>; <span class="variable">i</span>++)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="begin-block">#VAR</span>_<span class="variable">TYPE</span><span class="begin-block">#Buffer.serialize</span>(<span class="variable">value.</span><span class="begin-block">#VAR</span>_<span class="variable">NAME</span>#[<span class="variable">i</span>], <span class="variable">steam</span>);</span><br><span class="line">            &#125;</span><span class="xml"></span><br><span class="line">#END_ARRAY#</span><br><span class="line">#SERIALIZE_PROCESS#</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span></span><br></pre></td></tr></table></figure></p>
<ol>
<li>把Xbuffer核心代码xbuffer_runtime.dll放到项目目录下。</li>
<li>使用Xbuffer生成的对应Buffer类序列化和反序列化数据<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span><br><span class="line"> * Description:             UIDebugMonoScript.cs</span><br><span class="line"> * Author:                  TONYTANG</span><br><span class="line"> * Create Date:             2018/08/19</span><br><span class="line"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> GameData;</span><br><span class="line"><span class="keyword">using</span> Google.Protobuf;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> UnityEngine.UI;</span><br><span class="line"><span class="keyword">using</span> xbuffer;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="xmlDocTag">///</span> UIDebugMonoScript.cs</span></span><br><span class="line"><span class="comment"><span class="xmlDocTag">///</span> 快速访问UI组件测试挂在脚本</span></span><br><span class="line"><span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UIDebugMonoScript</span> : <span class="title">MonoBehaviour</span> &#123;</span><br><span class="line"></span><br><span class="line">    ******</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> Xbuffer内存存储抽象对象</span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> XSteam mXbufferStream;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> 创建GameConfig按钮点击</span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onCreateGameConfigClick</span>(<span class="params"></span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        Debug.Log(<span class="string">"onCreateGameConfigClick()"</span>);</span><br><span class="line">        Debug.Log(<span class="string">"PathUtilities.XbufferDataFolderPath : "</span> + PathUtilities.XbufferDataFolderPath);</span><br><span class="line">        PathUtilities.checkAndCreateFolder(PathUtilities.XbufferDataFolderPath);</span><br><span class="line">        <span class="comment">//固定一个内存分配，把数据往这里面填充，不够的画动态扩展</span></span><br><span class="line">        mXbufferStream = <span class="keyword">new</span> XSteam(<span class="number">1</span>, <span class="number">1024</span> * <span class="number">1024</span> * <span class="number">1000</span>);</span><br><span class="line">        GameConfigXB gameconfigxb = <span class="keyword">new</span> GameConfigXB();</span><br><span class="line">        gameconfigxb.difficultyLevel = <span class="string">"Hard"</span>;</span><br><span class="line">        gameconfigxb.versionNumber = <span class="number">1</span>;</span><br><span class="line">        gameconfigxb.resourceNumber = <span class="number">1</span>;</span><br><span class="line">        GameConfigXBBuffer.serialize(gameconfigxb, mXbufferStream);</span><br><span class="line">        <span class="keyword">var</span> bytes = mXbufferStream.getBytes();</span><br><span class="line">        <span class="keyword">using</span> (<span class="keyword">var</span> output = File.Create(PathUtilities.XbufferDataFolderPath + <span class="string">"GameConfigXB.data"</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            output.Write(bytes, <span class="number">0</span>, bytes.Length);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> 读取GameConfig按钮点击</span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onReadGameConfigClick</span>(<span class="params"></span>) </span><br><span class="line">    </span>&#123;</span><br><span class="line">        Debug.Log(<span class="string">"onReadGameConfigClick()"</span>);</span><br><span class="line">        Debug.Log(<span class="string">"PathUtilities.XbufferDataFolderPath : "</span> + PathUtilities.XbufferDataFolderPath);</span><br><span class="line">        <span class="keyword">using</span> (<span class="keyword">var</span> intput = File.OpenRead(PathUtilities.XbufferDataFolderPath + <span class="string">"GameConfigXB.data"</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> bytes = <span class="keyword">new</span> <span class="keyword">byte</span>[intput.Length];</span><br><span class="line">            intput.Read(bytes, <span class="number">0</span>, bytes.Length);</span><br><span class="line">            <span class="keyword">uint</span> offset = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">var</span> gameconfig = GameConfigXBBuffer.deserialize(bytes, <span class="keyword">ref</span> offset);</span><br><span class="line">            Debug.Log(<span class="string">"gameconfig.difficultyLevel : "</span> + gameconfig.difficultyLevel);</span><br><span class="line">            Debug.Log(<span class="string">"gameconfig.versionNumber : "</span> + gameconfig.versionNumber);</span><br><span class="line">            Debug.Log(<span class="string">"gameconfig.resourceNumber : "</span> + gameconfig.resourceNumber);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p><img src="/img/Unity/Data-Config-Automation/XbufferData.png" alt="XbufferData"><br><img src="/img/Unity/Data-Config-Automation/XbufferOutput.png" alt="XbufferOutput"><br>可以看到我们成功通过Xbuffer序列化反序列了数据。</p>
<h5 id="深入探究-1">深入探究</h5><p>接下来结合源码，让我们深入Xbuffer内部去看看是如何实现高效的序列化和反序列以及挂镀可配置的。<br>Xbuffer提供了一下两个核心的部件：</p>
<ol>
<li>xbuffe_parser.exe</li>
<li>xbuffer_runtime.dll</li>
</ol>
<h6 id="xbuffer_parser">xbuffer_parser</h6><p>xbuffer_parser负责根据模板自动化生成对应类以及Xbuffer序列化反序列化所需文件代码。</p>
<ol>
<li>Config.cs(负责参数的检查 — 这个就不详细介绍了)</li>
<li><p>Proto.cs(抽象数据结构文件的各个组成部分)</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span><br><span class="line"> * File Name:               Proto.cs</span><br><span class="line"> *</span><br><span class="line"> * Description:             原型语法解析工具</span><br><span class="line"> * Author:                  lisiyu &lt;576603306@qq.com&gt;</span><br><span class="line"> * Create Date:             2017/10/25</span><br><span class="line"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System.Text.RegularExpressions;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">xbuffer</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Proto</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> Proto_Class[] class_protos;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Proto</span>(<span class="params"><span class="keyword">string</span> proto</span>)</span><br><span class="line">        </span>&#123;</span><br><span class="line">            <span class="keyword">var</span> matchs = Regex.Matches(proto, <span class="string">@"//\s*(\S*)\s*((class)|(struct))\s*(\w+)\s*&#123;\s*((\w+):([\[|\]|\w]+);\s*//\s*(\S*)\s*)*&#125;"</span>);</span><br><span class="line">            class_protos = <span class="keyword">new</span> Proto_Class[matchs.Count];</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; matchs.Count; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                class_protos[i] = <span class="keyword">new</span> Proto_Class(matchs[i]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> 变量结构</span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Proto_Variable</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">string</span> Var_Type;                             <span class="comment">// 变量类型</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">string</span> Var_Name;                             <span class="comment">// 变量名</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">bool</span> IsArray;                                <span class="comment">// 是否是数组</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">string</span> Var_Comment;                          <span class="comment">// 变量注释</span></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Proto_Variable</span>(<span class="params"><span class="keyword">string</span> name, <span class="keyword">string</span> type, <span class="keyword">string</span> comment</span>)</span><br><span class="line">        </span>&#123;</span><br><span class="line">            Var_Name = name;</span><br><span class="line">            <span class="keyword">if</span> (type.Contains(<span class="string">"["</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                Var_Type = type.Substring(<span class="number">1</span>, type.Length - <span class="number">2</span>);</span><br><span class="line">                IsArray = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                Var_Type = type;</span><br><span class="line">                IsArray = <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            Var_Comment = comment;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> 类结构</span></span><br><span class="line">    <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Proto_Class</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">string</span> Class_Comment;                            <span class="comment">// 注释</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">string</span> Class_Type;                               <span class="comment">// 类型 例如 class struct</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">string</span> Class_Name;                               <span class="comment">// 类名</span></span><br><span class="line">        <span class="keyword">public</span> Proto_Variable[] Class_Variables;                <span class="comment">// 变量列表</span></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Proto_Class</span>(<span class="params">Match match</span>)</span><br><span class="line">        </span>&#123;</span><br><span class="line">            Class_Comment = match.Groups[<span class="number">1</span>].Value;</span><br><span class="line">            Class_Type = match.Groups[<span class="number">2</span>].Value;</span><br><span class="line">            Class_Name = match.Groups[<span class="number">5</span>].Value;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> varNames = match.Groups[<span class="number">7</span>].Captures;</span><br><span class="line">            <span class="keyword">var</span> varTypes = match.Groups[<span class="number">8</span>].Captures;</span><br><span class="line">            <span class="keyword">var</span> varComments = match.Groups[<span class="number">9</span>].Captures;</span><br><span class="line">            Class_Variables = <span class="keyword">new</span> Proto_Variable[varNames.Count];</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; Class_Variables.Length; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                Class_Variables[i] = <span class="keyword">new</span> Proto_Variable(varNames[i].Value, varTypes[i].Value, varComments[i].Value);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> 核心思想是通过正则匹配文本内容后，分别将对应内容填充到抽象的Proto类对象里。</p>
</li>
<li><p>Parser.cs(负责将抽象后的数据结构数据结合模板文件转换成对应代码) &amp; Xtemplate.cs(负责模板与代码生成部分的逻辑处理)</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span><br><span class="line"> * File Name:               Parser.cs</span><br><span class="line"> *</span><br><span class="line"> * Description:             将类对象转化成代码文本</span><br><span class="line"> * Author:                  lisiyu &lt;576603306@qq.com&gt;</span><br><span class="line"> * Create Date:             2017/10/25</span><br><span class="line"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">xbuffer</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Parser</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="xmlDocTag">///</span> 将类对象转化成代码文本</span></span><br><span class="line">        <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="proto_class"&gt;</span>类结构<span class="xmlDocTag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="template_str"&gt;</span>模板文本<span class="xmlDocTag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;returns&gt;</span><span class="xmlDocTag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">string</span> <span class="title">parse</span>(<span class="params">Proto_Class proto_class, <span class="keyword">string</span> template_str, <span class="keyword">bool</span> showHead</span>)</span><br><span class="line">        </span>&#123;</span><br><span class="line">            <span class="keyword">var</span> template = <span class="keyword">new</span> XTemplate(template_str);</span><br><span class="line"></span><br><span class="line">            template.setCondition(<span class="string">"HEAD"</span>, showHead);</span><br><span class="line">            template.setValue(<span class="string">"#CLASS_TYPE#"</span>, proto_class.Class_Type);</span><br><span class="line">            template.setValue(<span class="string">"#CLASS_NAME#"</span>, proto_class.Class_Name);</span><br><span class="line">            template.setValue(<span class="string">"#CLASS_COMMENT#"</span>, proto_class.Class_Comment);</span><br><span class="line"></span><br><span class="line">            template.setCondition(<span class="string">"DESERIALIZE_CLASS"</span>, proto_class.Class_Type == <span class="string">"class"</span>);</span><br><span class="line">            template.setCondition(<span class="string">"SERIALIZE_CLASS"</span>, proto_class.Class_Type == <span class="string">"class"</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (template.beginLoop(<span class="string">"#VARIABLES#"</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">foreach</span> (<span class="keyword">var</span> item <span class="keyword">in</span> proto_class.Class_Variables)</span><br><span class="line">                &#123;</span><br><span class="line">                    template.setCondition(<span class="string">"SINGLE"</span>, !item.IsArray);</span><br><span class="line">                    template.setCondition(<span class="string">"ARRAY"</span>, item.IsArray);</span><br><span class="line">                    template.setValue(<span class="string">"#VAR_TYPE#"</span>, item.Var_Type);</span><br><span class="line">                    template.setValue(<span class="string">"#VAR_NAME#"</span>, item.Var_Name);</span><br><span class="line">                    template.setValue(<span class="string">"#VAR_COMMENT#"</span>, item.Var_Comment);</span><br><span class="line">                    template.nextLoop();</span><br><span class="line">                &#125;</span><br><span class="line">                template.endLoop();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (template.beginLoop(<span class="string">"#DESERIALIZE_PROCESS#"</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">foreach</span> (<span class="keyword">var</span> item <span class="keyword">in</span> proto_class.Class_Variables)</span><br><span class="line">                &#123;</span><br><span class="line">                    template.setCondition(<span class="string">"SINGLE"</span>, !item.IsArray);</span><br><span class="line">                    template.setCondition(<span class="string">"ARRAY"</span>, item.IsArray);</span><br><span class="line">                    template.setValue(<span class="string">"#VAR_TYPE#"</span>, item.Var_Type);</span><br><span class="line">                    template.setValue(<span class="string">"#VAR_NAME#"</span>, item.Var_Name);</span><br><span class="line">                    template.setValue(<span class="string">"#VAR_COMMENT#"</span>, item.Var_Comment);</span><br><span class="line">                    template.nextLoop();</span><br><span class="line">                &#125;</span><br><span class="line">                template.endLoop();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (template.beginLoop(<span class="string">"#DESERIALIZE_RETURN#"</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">foreach</span> (<span class="keyword">var</span> item <span class="keyword">in</span> proto_class.Class_Variables)</span><br><span class="line">                &#123;</span><br><span class="line">                    template.setValue(<span class="string">"#VAR_TYPE#"</span>, item.Var_Type);</span><br><span class="line">                    template.setValue(<span class="string">"#VAR_NAME#"</span>, item.Var_Name);</span><br><span class="line">                    template.setValue(<span class="string">"#VAR_COMMENT#"</span>, item.Var_Comment);</span><br><span class="line">                    template.nextLoop();</span><br><span class="line">                &#125;</span><br><span class="line">                template.endLoop();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (template.beginLoop(<span class="string">"#SERIALIZE_PROCESS#"</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">foreach</span> (<span class="keyword">var</span> item <span class="keyword">in</span> proto_class.Class_Variables)</span><br><span class="line">                &#123;</span><br><span class="line">                    template.setCondition(<span class="string">"SINGLE"</span>, !item.IsArray);</span><br><span class="line">                    template.setCondition(<span class="string">"ARRAY"</span>, item.IsArray);</span><br><span class="line">                    template.setValue(<span class="string">"#VAR_TYPE#"</span>, item.Var_Type);</span><br><span class="line">                    template.setValue(<span class="string">"#VAR_NAME#"</span>, item.Var_Name);</span><br><span class="line">                    template.setValue(<span class="string">"#VAR_COMMENT#"</span>, item.Var_Comment);</span><br><span class="line">                    template.nextLoop();</span><br><span class="line">                &#125;</span><br><span class="line">                template.endLoop();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> template.getContent();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> 核心依然是通过正则匹配替换模板文本内容。<br>上面几个文件就是解析模板文件以及根据数据结构定义文件生成对应Xbuffer所需代码的核心逻辑。可以看到模板的高自由度配置，让Xbuffer具备了对多语言的快速支持以及灵活配置的能力。</p>
</li>
</ol>
<h6 id="xbuffer_runtime">xbuffer_runtime</h6><p>xbuffer_runtime.dll是xbuffer对数据进行序列化和反序列化的核心类。</p>
<ol>
<li><p>XSteam.cs(Xbuffer核心字节流序列化反序列化的关键类)</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span><br><span class="line"> * File Name:               XSteam.cs</span><br><span class="line"> *</span><br><span class="line"> * Description:             一个简单的内存流实现 用于精准的控制内存管理</span><br><span class="line"> * Author:                  lisiyu &lt;576603306@qq.com&gt;</span><br><span class="line"> * Create Date:             2018/04/09</span><br><span class="line"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">xbuffer</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">XSteam</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">uint</span> index_group;            <span class="comment">// 当前组别序号 行</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">uint</span> index_cell;             <span class="comment">// 当前单元序号 列</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">uint</span> capacity_group;         <span class="comment">// 行的数量</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">uint</span> capacity_cell;          <span class="comment">// 列的数量</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">byte</span>[][] contents;           <span class="comment">// 内容列表</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">uint</span>[] wastes;               <span class="comment">// 浪费列表 对应每一行</span></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">XSteam</span>(<span class="params"><span class="keyword">uint</span> capacity_group, <span class="keyword">uint</span> capacity_cell</span>)</span><br><span class="line">        </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.capacity_group = capacity_group;</span><br><span class="line">            <span class="keyword">this</span>.capacity_cell = capacity_cell;</span><br><span class="line"></span><br><span class="line">            contents = <span class="keyword">new</span> <span class="keyword">byte</span>[capacity_group][];</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; capacity_group; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                contents[i] = <span class="keyword">new</span> <span class="keyword">byte</span>[capacity_cell];</span><br><span class="line">            &#125;</span><br><span class="line">            wastes = <span class="keyword">new</span> <span class="keyword">uint</span>[capacity_group];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="xmlDocTag">///</span> 申请空间</span></span><br><span class="line">        <span class="comment"><span class="xmlDocTag">///</span> 基本策略是不够了就申请一倍</span></span><br><span class="line">        <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;param name="size"&gt;</span><span class="xmlDocTag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">applySize</span>(<span class="params"><span class="keyword">uint</span> size</span>)</span><br><span class="line">        </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (index_cell + size &gt; capacity_cell)</span><br><span class="line">            &#123;</span><br><span class="line">                wastes[index_group] = capacity_cell - index_cell;</span><br><span class="line">                index_cell = <span class="number">0</span>;</span><br><span class="line">                index_group++;</span><br><span class="line">                <span class="keyword">if</span> (index_group &gt;= capacity_group)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">var</span> nCapacity_Group = capacity_group + <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">var</span> nContents = <span class="keyword">new</span> <span class="keyword">byte</span>[nCapacity_Group][];</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">uint</span> i = <span class="number">0</span>; i &lt; nCapacity_Group; i++)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">if</span> (i &lt; capacity_group)</span><br><span class="line">                            nContents[i] = contents[i];</span><br><span class="line">                        <span class="keyword">else</span></span><br><span class="line">                            nContents[i] = <span class="keyword">new</span> <span class="keyword">byte</span>[capacity_cell];</span><br><span class="line">                    &#125;</span><br><span class="line">                    contents = nContents;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">var</span> nWastes = <span class="keyword">new</span> <span class="keyword">uint</span>[nCapacity_Group];</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">uint</span> i = <span class="number">0</span>; i &lt; capacity_group; i++)</span><br><span class="line">                    &#123;</span><br><span class="line">                        nWastes[i] = wastes[i];</span><br><span class="line">                    &#125;</span><br><span class="line">                    wastes = nWastes;</span><br><span class="line"></span><br><span class="line">                    capacity_group = nCapacity_Group;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="xmlDocTag">///</span> 返回输出字节流</span></span><br><span class="line">        <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;returns&gt;</span><span class="xmlDocTag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">byte</span>[] getBytes()</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> len = index_group * capacity_cell + index_cell;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; index_group; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                len -= wastes[i];</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> ret = <span class="keyword">new</span> <span class="keyword">byte</span>[len];</span><br><span class="line">            <span class="keyword">var</span> idx = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; index_group; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; capacity_cell - wastes[i]; j++)</span><br><span class="line">                &#123;</span><br><span class="line">                    ret[idx++] = contents[i][j];</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; index_cell; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                ret[idx++] = contents[index_group][i];</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> ret;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> 从上面源码可以看出，Xbuffer是采用了一个二维的byte数组来存储原始数据的(<em>实现固定内存大小的数据分配</em>)。空间容量不够的时候在扩容处理，这一点和Flatbuffer是类似的(Flatbuffer貌似是个一维数组)。当现有定义的空间不足时，Xbuffer采取的是翻倍处理(数据存储上是采用扩展二维数组的第二维度实现扩容)。这里可以想成，</p>
<p> 举个例子，一开始是byte[1][1024]的byte数组容量。当不够的时候，会扩展成byte[2][1024]的容量，然后从byte[2][]开始填充新的数据，而byte[1][]里未填充完的部分，就当做浪费的部分不再使用。</p>
<p> <em>但最后返回Xstream的byte数据时，是返回的一个一维byte数组，并且是剔除了wast部分的byte分配，详情见Xstream的getBytes方法</em></p>
</li>
<li><p>boolBuffer.cs &amp; byteBuffer.cs &amp; floatBuffer.cs &amp; intBuffer.cs &amp; longBuffer.cs &amp; stringBuffer.cs &amp; uintBuffer.cs(负责对各数据类型的数据序列化写入和反序列化读取进行实现)<br>下面以intBuffer.cs为例:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span><br><span class="line"> * File Name:               intBuffer.cs</span><br><span class="line"> *</span><br><span class="line"> * Description:             基本类型处理</span><br><span class="line"> * Author:                  lisiyu &lt;576603306@qq.com&gt;</span><br><span class="line"> * Create Date:             2017/10/25</span><br><span class="line"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">xbuffer</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">intBuffer</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">readonly</span> <span class="keyword">uint</span> size = <span class="keyword">sizeof</span>(<span class="keyword">int</span>);</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">unsafe</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">deserialize</span>(<span class="params"><span class="keyword">byte</span>[] buffer, <span class="keyword">ref</span> <span class="keyword">uint</span> offset</span>)</span><br><span class="line">        </span>&#123;</span><br><span class="line">            <span class="keyword">fixed</span> (<span class="keyword">byte</span>* ptr = buffer)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> <span class="keyword">value</span> = *(<span class="keyword">int</span>*)(ptr + offset);</span><br><span class="line">                offset += size;</span><br><span class="line">                <span class="keyword">return</span> BitConverter.IsLittleEndian ? <span class="keyword">value</span> : (<span class="keyword">int</span>)utils.toLittleEndian((<span class="keyword">uint</span>)<span class="keyword">value</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">unsafe</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">serialize</span>(<span class="params"><span class="keyword">int</span> <span class="keyword">value</span>, XSteam steam</span>)</span><br><span class="line">        </span>&#123;</span><br><span class="line">            steam.applySize(size);</span><br><span class="line">            <span class="keyword">fixed</span> (<span class="keyword">byte</span>* ptr = steam.contents[steam.index_group])</span><br><span class="line">            &#123;</span><br><span class="line">                *(<span class="keyword">int</span>*)(ptr + steam.index_cell) = BitConverter.IsLittleEndian ? <span class="keyword">value</span> : (<span class="keyword">int</span>)utils.toLittleEndian((<span class="keyword">uint</span>)<span class="keyword">value</span>);</span><br><span class="line">                steam.index_cell += size;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> 从上面可以看出，底层的数据写入是根据数据类型大小，通过fixed使用非托管的内存分配方式进行指定内存位置指定数据byte的写入和读取。</p>
<p> 举个例子，一开始分配了byte[1][1024*1024]也就是1M的内存，当我们写入一个int数据时，因为int类型的byte大小是4bytes也就是32bits，也就是说byte[1][0] - byte[1][4]的内存数据时用于存储这个int的值。其他类型同理。</p>
</li>
<li>utils.cs(负责一些细节处理，比如大小端问题，这里就不放源码了)</li>
<li>Serializer.cs(提供模板化的序列化反序列化读取加载接口)</li>
<li><p><em>*</em>Buffer.cs(自动化生成的序列化反序列化所需的类代码)</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">xbuffer</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">GameConfigXBBuffer</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> GameConfigXB <span class="title">deserialize</span>(<span class="params"><span class="keyword">byte</span>[] buffer, <span class="keyword">ref</span> <span class="keyword">uint</span> offset</span>)</span><br><span class="line">        </span>&#123;</span><br><span class="line">            <span class="comment">// null</span></span><br><span class="line">            <span class="keyword">bool</span> _null = boolBuffer.deserialize(buffer, <span class="keyword">ref</span> offset);</span><br><span class="line">            <span class="keyword">if</span> (_null) <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// difficultyLevel</span></span><br><span class="line">            <span class="keyword">string</span> _difficultyLevel = stringBuffer.deserialize(buffer, <span class="keyword">ref</span> offset);            </span><br><span class="line"></span><br><span class="line">            <span class="comment">// versionNumber</span></span><br><span class="line">            <span class="keyword">int</span> _versionNumber = intBuffer.deserialize(buffer, <span class="keyword">ref</span> offset);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// resourceNumber</span></span><br><span class="line">            <span class="keyword">int</span> _resourceNumber = intBuffer.deserialize(buffer, <span class="keyword">ref</span> offset);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// value</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> GameConfigXB()</span><br><span class="line">            &#123;</span><br><span class="line">                difficultyLevel = _difficultyLevel,</span><br><span class="line"></span><br><span class="line">                versionNumber = _versionNumber,</span><br><span class="line"></span><br><span class="line">                resourceNumber = _resourceNumber,</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">serialize</span>(<span class="params">GameConfigXB <span class="keyword">value</span>, XSteam steam</span>)</span><br><span class="line">        </span>&#123;</span><br><span class="line">            <span class="comment">// null</span></span><br><span class="line">            boolBuffer.serialize(<span class="keyword">value</span> == <span class="keyword">null</span>, steam);</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">value</span> == <span class="keyword">null</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// difficultyLevel</span></span><br><span class="line">            stringBuffer.serialize(<span class="keyword">value</span>.difficultyLevel, steam);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// versionNumber</span></span><br><span class="line">            intBuffer.serialize(<span class="keyword">value</span>.versionNumber, steam);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// resourceNumber</span></span><br><span class="line">            intBuffer.serialize(<span class="keyword">value</span>.resourceNumber, steam);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> 从上面可以看到，根据数据结构定义文件生成对应的序列化和反序列化代码核心是通过各成员数据按循序依次以各自类型的写入方式将数据写入XStream里。<br> 反序列化时同理依次从byte数据里读取出来。<br> 不难看出，数据存储确实和Flatbuffer类似，存储在一个固定的内存byte[]数组里，只不过是一维和二维数组的区别(<em>但实际上最后返回Xstream的byte数据时，是剔除了wast部分的一个一维的byte数组</em>)。数据序列化和反序列化都是读取指定内存位置按指定数据类型读取出来即可，这应该就是Xbuffer和Flatbuffer序列化和反序列化高效的原因吧。</p>
</li>
</ol>
<h3 id="方案比较-1">方案比较</h3><p>不同的序列化反序列化库的优劣比较:</p>
<ol>
<li>自定义数据填充和读取<br>优点：</li>
</ol>
<ul>
<li>实现简单<br>缺点:</li>
<li>序列化和反序列化速度慢，内存开销大</li>
<li>不适合数据量大和频繁使用的情况</li>
</ul>
<p><em>适用于数据量不大且不需要跨语言的情况，不适合对性能要求高的场合。</em></p>
<ol>
<li>ProtoBuff<br>优点：</li>
</ol>
<ul>
<li>序列化和反序列化速度和内存开销都很不错</li>
<li>数据定义向后兼容</li>
<li>高度自定义配置数据结构(proto文件)</li>
<li>数据序列化反序列化代码简介，接口简单</li>
<li>社区强大<br>缺点:</li>
<li>相比FlatBuffer和Xbuffer速度和内存开销上不占优势</li>
</ul>
<p><em>很适合作为网络数据传输方案(向后兼容)。</em></p>
<ol>
<li>FlatBuff<br>优点：</li>
</ol>
<ul>
<li>序列化和反序列化速度快，内存开销小</li>
<li>支持自定义配置数据结构(schema文件)<br>缺点:</li>
<li>序列化反序列化代码编写过于面向内存结构，不符合平时面向对象的编写风格，编写复杂(这一层被Xbuffer封装成自动化生成<em>*</em>Buffer.cs的代码类)</li>
</ul>
<ol>
<li>XBuffer<br>优点:</li>
</ol>
<ul>
<li>序列化和反序列化速度快，内存开销小</li>
<li>高度自由配置(基于模板配置且自定义配置文件配置)</li>
<li>接口简单方便使用，支持泛型和非泛型序列化反序列化</li>
<li>根据需求可以快速修改来符合自身需求(比如要做导表工具，只需在上层再封一层即可)<br>缺点:</li>
<li>向后不兼容(因为数据是严格按照数据结构按顺序读取的，所以当已经存储进数据库的数据，在扩展字段内容后是无法正常反序列化读取出来的)</li>
</ul>
<p><em>不适合作为网络序列化数据方案，更适合表格数据序列化反序列化方案。</em></p>
<h2 id="实战">实战</h2><h3 id="方案选择">方案选择</h3><p>学习了解了那么多序列化和反序列化的库，根据我现有的需求是制作一个导表工具(速度和内存开销以及配置灵活度都要求比较高)来看，个人认为基于Xbuffer来编写是比较适合的一种方案。</p>
<p>原因如下:</p>
<ol>
<li>速度快</li>
<li>内存开销小</li>
<li>高度可配置</li>
</ol>
<h3 id="基于Xbuffer的导表工具">基于Xbuffer的导表工具</h3><p>流程：</p>
<ol>
<li>定义导表工具基础功能需求</li>
<li>XML配置导表相关路径数据(比如表格路径配置，输出目录配置等)</li>
<li>定义excel表格格式规则</li>
<li>读取excel数据(Window可以使用ExcelRead库)</li>
<li>创建excel对应Xbuffer数据结构文件(这一步需要自己去写)</li>
<li>使用Xbuffer_parser解析新生成的数据结构文件，生成所需类文件以及序列化相关文件(使用Xbuffer_parser解析即可)</li>
<li>使用生成的代码序列化excel数据到二进制数据流(这一步需要自己去写)</li>
<li>封装一层表格数据读取快速读取管理类，负责统一管理表格数据的加载和读取(这一步需要自己去写)</li>
<li>通过统一管理类使用Xbuffer去加载读取序列化的二进制数据(结合自身代码，使用Xbuffer_runtime.dll里的核心代码去反序列化)</li>
</ol>
<p>相关语言及工具：<br>C#(Unity客户端使用的语言)<br>Xbuffer(第三方序列化反序列化库)</p>
<p>接下将来针对每一步的实现进行实战学习。</p>
<h4 id="导表功能需求">导表功能需求</h4><ol>
<li>支持int，float，long, string, bool基础数据配置</li>
<li>支持一维和多维数据配置(进阶功能，理论上，对于xbuffer而言，数组的维度扩展就能支持多维数据)</li>
<li>自动生成表格数据以及表格读取相关代码</li>
<li>工具独立于Unity存在使用</li>
<li>支持跨语言(xbuffer理论上通过模板生成不同语言版本的相关代码即可)</li>
<li>支持XML配置相关工具配置(比如表格路径配置，输出目录配置等。)</li>
</ol>
<h4 id="支持导表路径配置">支持导表路径配置</h4><p>因为工具是独立于Unity所以不受.Net版本的限制，这里决定使用.Net自身的XML解析库System.XML。</p>
<p>ExportConfig.xml<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="pi">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="title">ExportConfig</span>&gt;</span>  </span><br><span class="line">   <span class="tag">&lt;<span class="title">ExcelInputPath</span>&gt;</span>./Excels/<span class="tag">&lt;/<span class="title">ExcelInputPath</span>&gt;</span>  </span><br><span class="line">   <span class="tag">&lt;<span class="title">TemplatePath</span>&gt;</span>./Templates/<span class="tag">&lt;/<span class="title">TemplatePath</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="title">DesFileOutputPath</span>&gt;</span>./DesFiles/<span class="tag">&lt;/<span class="title">DesFileOutputPath</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="title">ByteDataOutputPath</span>&gt;</span>./../Assets/Resources/DataBytes/<span class="tag">&lt;/<span class="title">ByteDataOutputPath</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="title">CSClassCodeOutputPath</span>&gt;</span>./../Assets/Scripts/Data/CSOutput/ClassCode/<span class="tag">&lt;/<span class="title">CSClassCodeOutputPath</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="title">CSBufferCodeOutputPath</span>&gt;</span>./../Assets/Scripts/Data/CSOutput/BufferCode/<span class="tag">&lt;/<span class="title">CSBufferCodeOutputPath</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="title">CSTemplateOutputPath</span>&gt;</span>./../Assets/Scripts/Data/CSTemplateOutput/<span class="tag">&lt;/<span class="title">CSTemplateOutputPath</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="title">OtherLanguageCodeOutputPath</span>&gt;</span>./OtherOutput/<span class="tag">&lt;/<span class="title">OtherLanguageCodeOutputPath</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">ExportConfig</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>ExportConfig.cs<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span><br><span class="line"> * Description:             导表工具导出配置数据抽象</span><br><span class="line"> * Author:                  tanghuan</span><br><span class="line"> * Create Date:             2018/09/01</span><br><span class="line"> */</span></span><br><span class="line"></span><br><span class="line"> <span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">XbufferExcelToData</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ExportConfig</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="xmlDocTag">///</span> 表格数据路径</span></span><br><span class="line">        <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">string</span> ExcelInputPath &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="xmlDocTag">///</span> Xbuffer模板路径</span></span><br><span class="line">        <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">string</span> TemplatePath &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="xmlDocTag">///</span> 序列化数据输出路径</span></span><br><span class="line">        <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">string</span> ByteDataOutputPath &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="xmlDocTag">///</span> CS代码输出路径</span></span><br><span class="line">        <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">string</span> CSCodeOutputPath &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="xmlDocTag">///</span> 其他语言代码输出路径</span></span><br><span class="line">        <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">string</span> OtherLanguageCodeOutputPath &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="xmlDocTag">///</span> 打印所有信息</span></span><br><span class="line">        <span class="comment"><span class="xmlDocTag">///</span> <span class="xmlDocTag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">printOutAllInfo</span>(<span class="params"></span>)</span><br><span class="line">        </span>&#123;</span><br><span class="line">            Console.WriteLine(<span class="keyword">string</span>.Format(<span class="string">"ExcelInputPath : &#123;0&#125;"</span>, ExcelInputPath));</span><br><span class="line">            Console.WriteLine(<span class="keyword">string</span>.Format(<span class="string">"TemplatePath : &#123;0&#125;"</span>, TemplatePath));</span><br><span class="line">            Console.WriteLine(<span class="keyword">string</span>.Format(<span class="string">"DesFileOutputPath : &#123;0&#125;"</span>, DesFileOutputPath));</span><br><span class="line">            Console.WriteLine(<span class="keyword">string</span>.Format(<span class="string">"ByteDataOutputPath : &#123;0&#125;"</span>, ByteDataOutputPath));</span><br><span class="line">            Console.WriteLine(<span class="keyword">string</span>.Format(<span class="string">"CSCodeOutputPath : &#123;0&#125;"</span>, CSCodeOutputPath));</span><br><span class="line">            Console.WriteLine(<span class="keyword">string</span>.Format(<span class="string">"OtherLanguageCodeOutputPath : &#123;0&#125;"</span>, OtherLanguageCodeOutputPath));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>XbufferExcelToDataConfig.cs<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line"> * Description:             导表工具相关配置单例类</span><br><span class="line"> * Author:                  tanghuan</span><br><span class="line"> * Create Date:             2018/09/01</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">using System;</span><br><span class="line">using System.Collections.Generic;</span><br><span class="line">using System.IO;</span><br><span class="line">using System.Linq;</span><br><span class="line">using System.Text;</span><br><span class="line">using System.Threading.Tasks;</span><br><span class="line">using System.Xml;</span><br><span class="line"></span><br><span class="line">namespace XbufferExcelToData</span><br><span class="line">&#123;</span><br><span class="line">    /// &lt;summary&gt;</span><br><span class="line">    /// 导表工具相关配置单例类</span><br><span class="line">    /// &lt;/summary&gt;</span><br><span class="line">    public class XbufferExcelToDataConfig : SingletonTemplate&lt;XbufferExcelToDataConfig&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        /// &lt;summary&gt;</span><br><span class="line">        /// XML配置文件全路径</span><br><span class="line">        /// &lt;/summary&gt;</span><br><span class="line">        public string XMLConfigFileFullPath &#123; get; private set; &#125;</span><br><span class="line"></span><br><span class="line">        /// &lt;summary&gt;</span><br><span class="line">        /// 导出配置数据</span><br><span class="line">        /// &lt;/summary&gt;</span><br><span class="line">        public ExportConfig ExportConfigInfo &#123; get; private set; &#125;</span><br><span class="line"></span><br><span class="line">        public XbufferExcelToDataConfig()</span><br><span class="line">        &#123;</span><br><span class="line">            XMLConfigFileFullPath = "./ExportConfig.xml";</span><br><span class="line">            ExportConfigInfo = null;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        /// &lt;summary&gt;</span><br><span class="line">        /// 加载导出配置数据</span><br><span class="line">        /// &lt;/summary&gt;</span><br><span class="line">        public bool LoadExportConfigData()</span><br><span class="line">        &#123;</span><br><span class="line">            if(File.Exists(XMLConfigFileFullPath))</span><br><span class="line">            &#123;</span><br><span class="line">                XmlDocument xmldoc = new XmlDocument();</span><br><span class="line">                xmldoc.Load(XMLConfigFileFullPath);</span><br><span class="line">                var rootnode = xmldoc.DocumentElement;</span><br><span class="line">                var rootnodename = rootnode.Name;</span><br><span class="line">                var reflecttype = this.GetType().Assembly.GetType("XbufferExcelToData." + rootnodename);</span><br><span class="line">                if(reflecttype ==  typeof(ExportConfig))</span><br><span class="line">                &#123;</span><br><span class="line">                    ExportConfigInfo = new ExportConfig();</span><br><span class="line">                    var childnodes = rootnode.ChildNodes;</span><br><span class="line">                    for(int i = 0, length = childnodes.Count; i &lt; length; i++)</span><br><span class="line">                    &#123;</span><br><span class="line">                        var property = ExportConfigInfo.GetType().GetProperty(childnodes[i].Name);</span><br><span class="line">                        if(property != null)</span><br><span class="line">                        &#123;</span><br><span class="line">                            property.SetValue(ExportConfigInfo, childnodes[i].InnerText);</span><br><span class="line">                        &#125;</span><br><span class="line">                        else</span><br><span class="line">                        &#123;</span><br><span class="line">                            Console.WriteLine(string.Format("不支持的属性配置 : &#123;0&#125;", childnodes[i].Name));</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;                    </span><br><span class="line">                    ExportConfigInfo.printOutAllInfo();</span><br><span class="line">                    return true;</span><br><span class="line">                &#125;</span><br><span class="line">                else</span><br><span class="line">                &#123;</span><br><span class="line">                    Console.WriteLine(string.Format("找不到配置的类型数据信息 : &#123;0&#125;", rootnodename));</span><br><span class="line">                    Console.WriteLine("当前只支持ExportConfig类型信息配置");</span><br><span class="line">                    return false;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            else</span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine(string.Format("导出配置文件不存在 : &#123;0&#125;", XMLConfigFileFullPath));</span><br><span class="line">                return false;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><img src="/img/Unity/Data-Config-Automation/LoadXMLConfig.png" alt="LoadXMLConfig"><br>可以看到我们成功的读取了XML里配置的信息(后续的导表工具会用到)。</p>
<h4 id="定义表格规则">定义表格规则</h4><ol>
<li>第一行定义字段</li>
<li>第二行写字段注释</li>
<li>第三行定义字段类型</li>
<li>第四行表示分割符(只对一维数组类型有用)</li>
<li>第五和第六行保留为未来扩展使用</li>
<li>第七行及以后正式填写数据(数据不填采用对应类型的默认值，比如int为0，bool为false，int[]为null)</li>
</ol>
<h4 id="读取excel数据">读取excel数据</h4><p>Windows PC端决定使用ExcelRead库来解决excel读取问题。</p>
<p>核心代码是下面两个文件：<br>ExcelDataManager.cs<br>ExcelData.cs</p>
<p>考虑到博客暂时不支持代码折叠，这里就不直接放源代码了，整个工程源代码会在博客最后给出链接。<br>主要实现了以下功能：</p>
<ol>
<li>按表格规则解析</li>
<li>检查表格配置是否正确(1. 不允许同名excel sheet 2. 字段名不允许重复 3. 支持的数据类型检查 4. id第一列必须为int类型且不允许不填且同一个表格id不能重复 5. 支持的分隔符检查配置)</li>
</ol>
<p>这里直接验证下读取Excel数据的结果:<br><img src="/img/Unity/Data-Config-Automation/ExcelDatOutput.png" alt="ExcelDatOutput"></p>
<h4 id="创建对应数据结构文件">创建对应数据结构文件</h4><p>这一步，我们需要自动化生成Xbuffer用于自动化生成相关序列化代码的数据结构定义文件。</p>
<p>还记的我们前面学习Xbuffer时定义的GameConfigXB.xb吗?<br>GameConfigXB.xb<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 游戏版本信息</span></span><br><span class="line"><span class="keyword">class</span> <span class="title">GameConfigXB</span></span><br><span class="line">&#123;</span><br><span class="line">    difficultyLevel:<span class="keyword">string</span>;             <span class="comment">// 游戏难度</span></span><br><span class="line">    versionNumber:<span class="keyword">int</span>;                  <span class="comment">// 游戏版本号</span></span><br><span class="line">    resourceNumber:<span class="keyword">int</span>;                 <span class="comment">// 游戏资源版本号</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>我们现在的目标就是将我们的Excel定义的数据内容转换成对应的数据结构定义文件。</p>
<p>实现方案思考：<br>数据结构定义文件不需要考虑跨平台，真正跨平台的实现是在序列化模板文件那一步完成的，所以这里打算简单的通过字节流形式按顺序文本写入即可。</p>
<p>代码很简单，就是利用之前存储的表格数据信息，一次写入字符串信息，最后通过文件流写入文件，这里就不放源代码了。</p>
<p>核心类是:<br>XbufferExcelToDesFile.cs</p>
<p>直接来看下最终生成的结果:<br>t_AuthorInfo.xb<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// t_AuthorInfo的注释</span></span><br><span class="line"><span class="keyword">class</span> <span class="title">t_AuthorInfo</span></span><br><span class="line">&#123;</span><br><span class="line">    id:<span class="keyword">int</span>;                                      <span class="comment">//唯一id</span></span><br><span class="line">    author:<span class="keyword">string</span>;                                <span class="comment">//作者</span></span><br><span class="line">    age:<span class="keyword">int</span>;                                        <span class="comment">//年龄</span></span><br><span class="line">    money:<span class="keyword">float</span>;                                    <span class="comment">//拥有金钱</span></span><br><span class="line">    hashouse:<span class="keyword">bool</span>;                                <span class="comment">//拥有房子</span></span><br><span class="line">    pbutctime:<span class="keyword">long</span>;                              <span class="comment">//出版utc时间</span></span><br><span class="line">    luckynumber:[<span class="keyword">int</span>];                            <span class="comment">//幸运数字</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这一步，我们成功自动化生成了Xbuffer需要的Excel对应的数据结构定义文件。</p>
<h4 id="生成序列化所需文件">生成序列化所需文件</h4><p>为了便于修改Xbuffer满足我们新的需求，这里直接把Xbuffer的两个核心工程(xbuffer_parser &amp; xbuffer_runtime)集成到我们的导表工具里来：<br><img src="/img/Unity/Data-Config-Automation/IntegrateXbuffer.png" alt="IntegrateXbuffer"></p>
<p>然后修改Xbuffer两个核心工程的输出路径和我们主工程一致(便于主工程使用):<br><img src="/img/Unity/Data-Config-Automation/ModifyXbufferOutputPath.png" alt="ModifyXbufferOutputPath"></p>
<p>然后编译出两个工程各自的核心文件:<br><img src="/img/Unity/Data-Config-Automation/CompileXbufferCSProjects.png" alt="CompileXbufferCSProjects"></p>
<p>为了不修改原有Xbuffer的使用方式，这里采用通过跨程序调用exe的方式来使用Xbuffer。<br>核心类是:<br>XbufferDesFileToCSCode.cs</p>
<p>成功生成序列化相关代码:<br>t_AuthorInfoBuffer.cs<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">xbuffer</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">t_AuthorInfoBuffer</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> t_AuthorInfo <span class="title">deserialize</span>(<span class="params"><span class="keyword">byte</span>[] buffer, <span class="keyword">ref</span> <span class="keyword">uint</span> offset</span>)</span><br><span class="line">        </span>&#123;</span><br><span class="line">            <span class="comment">// null</span></span><br><span class="line">            <span class="keyword">bool</span> _null = boolBuffer.deserialize(buffer, <span class="keyword">ref</span> offset);</span><br><span class="line">            <span class="keyword">if</span> (_null) <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// id</span></span><br><span class="line">            <span class="keyword">int</span> _id = intBuffer.deserialize(buffer, <span class="keyword">ref</span> offset);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// author</span></span><br><span class="line">            <span class="keyword">string</span> _author = stringBuffer.deserialize(buffer, <span class="keyword">ref</span> offset);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// age</span></span><br><span class="line">            <span class="keyword">int</span> _age = intBuffer.deserialize(buffer, <span class="keyword">ref</span> offset);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// money</span></span><br><span class="line">            <span class="keyword">float</span> _money = floatBuffer.deserialize(buffer, <span class="keyword">ref</span> offset);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// hashouse</span></span><br><span class="line">            <span class="keyword">bool</span> _hashouse = boolBuffer.deserialize(buffer, <span class="keyword">ref</span> offset);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// pbutctime</span></span><br><span class="line">            <span class="keyword">long</span> _pbutctime = longBuffer.deserialize(buffer, <span class="keyword">ref</span> offset);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// luckynumber</span></span><br><span class="line">            <span class="keyword">int</span> _luckynumber_length = intBuffer.deserialize(buffer, <span class="keyword">ref</span> offset);</span><br><span class="line">            <span class="keyword">int</span>[] _luckynumber = <span class="keyword">new</span> <span class="keyword">int</span>[_luckynumber_length];</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; _luckynumber_length; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                _luckynumber[i] = intBuffer.deserialize(buffer, <span class="keyword">ref</span> offset);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// value</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> t_AuthorInfo() &#123;</span><br><span class="line">                id = _id,</span><br><span class="line">                author = _author,</span><br><span class="line">                age = _age,</span><br><span class="line">                money = _money,</span><br><span class="line">                hashouse = _hashouse,</span><br><span class="line">                pbutctime = _pbutctime,</span><br><span class="line">                luckynumber = _luckynumber,</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">serialize</span>(<span class="params">t_AuthorInfo <span class="keyword">value</span>, XSteam steam</span>)</span><br><span class="line">        </span>&#123;</span><br><span class="line">            <span class="comment">// null</span></span><br><span class="line">            boolBuffer.serialize(<span class="keyword">value</span> == <span class="keyword">null</span>, steam);</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">value</span> == <span class="keyword">null</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// id</span></span><br><span class="line">            intBuffer.serialize(<span class="keyword">value</span>.id, steam);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// author</span></span><br><span class="line">            stringBuffer.serialize(<span class="keyword">value</span>.author, steam);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// age</span></span><br><span class="line">            intBuffer.serialize(<span class="keyword">value</span>.age, steam);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// money</span></span><br><span class="line">            floatBuffer.serialize(<span class="keyword">value</span>.money, steam);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// hashouse</span></span><br><span class="line">            boolBuffer.serialize(<span class="keyword">value</span>.hashouse, steam);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// pbutctime</span></span><br><span class="line">            longBuffer.serialize(<span class="keyword">value</span>.pbutctime, steam);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// luckynumber</span></span><br><span class="line">            intBuffer.serialize(<span class="keyword">value</span>.luckynumber.Length, steam);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">value</span>.luckynumber.Length; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                intBuffer.serialize(<span class="keyword">value</span>.luckynumber[i], steam);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>t_AuthorInfo.cs<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// t_AuthorInfo的注释</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">partial</span> <span class="keyword">class</span> <span class="title">t_AuthorInfo</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> id;              <span class="comment">// 唯一id</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">string</span> author;               <span class="comment">// 作者</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> age;             <span class="comment">// 年龄</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">float</span> money;             <span class="comment">// 拥有金钱</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">bool</span> hashouse;               <span class="comment">// 拥有房子</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">long</span> pbutctime;              <span class="comment">// 出版utc时间</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span>[] luckynumber;               <span class="comment">// 幸运数字</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Note:<br>因为xbuffer_parser默认只支持一个一个文件解析，保留原始使用方法会导致弹过多的弹窗，所以这里把xbuffer_parser改成指定目录形式的自动化生成。</p>
<h4 id="序列化数据">序列化数据</h4><p>Xbuffer序列化相关的代码自动生成完成后，下一步就是把Excel的数据序列化到我们指定的二进制文件流了。</p>
<p>实现方案思考：</p>
<ul>
<li>这一步主要依赖于最初存储的Excel数据以及前面生成的Xbuffer相关的序列化代码来进行序列化数据。</li>
<li>但序列化的代码是动态生成的没有被编译到工具代码里的，我们无法利用现成的序列化代码来进行数据序列化。</li>
<li>只能根据表格数据以及类型信息通过Xbuffer的基础数据类型写入对应数据，反序列化时再利用反序列化代码进行数据读取。</li>
<li>除了写入数据信息，我们还需要在写入数据信息之前，写入两个关键信息(1. 数据数量(行数) 2. 数据长度(字节数))，用于我们后面去读取加载存储数据时使用，后者如果完全是一个byte对应一个excel数据的话倒是可以不用存储，因为加载后就已经知道总长度了，但如果是所有byte通过zip压缩到一起的话就需要知道每个byte的数据长度。</li>
</ul>
<p>序列化的核心代码文件:<br>XbufferExcelDataToBytes.cs</p>
<p>Note:</p>
<ol>
<li>暂时是一个Excel文件对应一个bytes数据的方式进行存储。</li>
<li>如果想对数据进行压缩或者加密验证，都可以在序列化这一步或者压缩之后写入数据，然后在加载时反向操作判定对比即可。(TODO:优化)</li>
</ol>
<h4 id="统一表格数据加载和读取">统一表格数据加载和读取</h4><p>这一步是属于加载一测的了，是需要运用在Unity里的代码，统一表格加载管理是为了对于表格数据进行快速的访问和管理(一般都会有个GameDataManager之类的单例类负责管理)。<br>因为表格数据是动态生成的，所以加载的代码也需要动态生成。</p>
<p>实现方案思考:</p>
<ul>
<li>这一步因为涉及到自动化的加载代码生成，会涉及到多语言支持问题，所以如果想要支持多语言最好通过模板一类的方式来动态生成代码。</li>
<li>虽然Xbuffer里有一套根据模板生成代码的方案，但想自己尝试实现一下，所以不准备直接拿过来用，准备参考Xbuffer模板替换思路自己模仿写一份(尝试写了这个才发现正则的强大之处)。</li>
</ul>
<p>模板功能需求：</p>
<ul>
<li>支持模板内容基于占位符替换</li>
<li>支持模板内容基于占位符循环替换</li>
</ul>
<p>实现方案跟Xbuffer的一样，支持如下功能：</p>
<ol>
<li>支持两种替换规则(1. 占位符单次替换 2. 限定模板内容多次替换累加)</li>
<li>前者作用范围整个模板(不包含多次替换模板内容部分 — 通过定义不重复的占位符来实现)，后者允许指定局部内容作为模板用于多次替换累加</li>
<li>多次替换模板内容允许跨行</li>
<li>模板占位符可自定义名字，但格式必须是:#名字#</li>
<li>多次替换模板内可定义占位符，支持占位符单次替换</li>
</ol>
<p>比如如下定义方式:<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Auto generated, do not edit it</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">using</span> Xbuffer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Data</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">GameDataManager</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="preprocessor">#循环标签名1#</span></span><br><span class="line">        <span class="keyword">public</span> <span class="preprocessor">#循环占位符名1#Container #循环占位符名1#Container = new #循环占位符名1#Container();</span></span><br><span class="line">        <span class="preprocessor">#循环标签名1#</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadAll</span>(<span class="params"></span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="preprocessor">#循环标签名2#</span></span><br><span class="line">        <span class="preprocessor">#循环占位符名2#Container.loadDataFromBin();</span></span><br><span class="line">        <span class="preprocessor">#循环标签名2#</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">GameDataManager</span>(<span class="params"></span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">readonly</span> GameDataManager Instance = <span class="keyword">new</span> GameDataManager();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>模板文件定义分析:</p>
<ol>
<li>整个文件内容是作为完整的模板内容。</li>
<li>在非循环占位符标签内的#占位符名#会用于作为单次替换占位符</li>
<li>循环标签名1和循环标签名2定义一个局部模板内容作为多次替换的模板(循环标签必须配对使用，且不允许同一个模板里重复使用)</li>
<li>循环占位符名1和循环占位符名2表示多次替换模板里的占位符(注意不能和单次占位符名字重复，不然会被单次替换掉)</li>
</ol>
<p>这里主要需要以下几个文件的模板:<br>先手写一版模板初稿</p>
<ol>
<li><p>GameDataManager.ftl — GameDataManager.cs(表数据统一加载管理类)</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Auto generated, do not edit it</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">using</span> xbuffer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Data</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">GameDataManager</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="preprocessor">#CONTAINER_MEMBER_LOOP#</span></span><br><span class="line">        <span class="keyword">public</span> <span class="preprocessor">#CLASS_NAME#Container #CLASS_NAME#container = new #CLASS_NAME#Container();</span></span><br><span class="line">        <span class="preprocessor">#CONTAINER_MEMBER_LOOP#</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadAll</span>(<span class="params"></span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="preprocessor">#CONTAINER_LOAD_LOOP#</span></span><br><span class="line">        <span class="preprocessor">#LOOP_CLASS_NAME#container.loadDataFromBin();</span></span><br><span class="line">        <span class="preprocessor">#CONTAINER_LOAD_LOOP#</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">GameDataManager</span>(<span class="params"></span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">readonly</span> GameDataManager Instance = <span class="keyword">new</span> GameDataManager();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>excelContainer.ftl — excelContainer.cs(表格数据存储类)</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Auto generated by XbufferExcelToData, do not edit it </span><br><span class="line"> * 表格名字</span><br><span class="line"> */</span><br><span class="line">using System;</span><br><span class="line">using System.Collections.Generic;</span><br><span class="line">using System.IO;</span><br><span class="line">using UnityEngine;</span><br><span class="line">using xbuffer;</span><br><span class="line"></span><br><span class="line">namespace Data</span><br><span class="line">&#123;</span><br><span class="line">    public class #CLASS_NAME#Container</span><br><span class="line">    &#123;</span><br><span class="line">        private List&lt;#CLASS_NAME#&gt; list = null;</span><br><span class="line">        private Dictionary&lt;int, #CLASS_NAME#&gt; map = null;</span><br><span class="line"></span><br><span class="line">        public List&lt;#CLASS_NAME#&gt; getList()</span><br><span class="line">        &#123;</span><br><span class="line">            if (list == null || list.Count &lt;= 0)</span><br><span class="line">                loadDataFromBin();</span><br><span class="line">            return list;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public Dictionary&lt;int, #CLASS_NAME#&gt; getMap()</span><br><span class="line">        &#123;</span><br><span class="line">            if (map == null || map.Count &lt;= 0)</span><br><span class="line">                loadDataFromBin();</span><br><span class="line">            return map;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public void ClearList()</span><br><span class="line">        &#123;</span><br><span class="line">            if (list != null &amp;&amp; list.Count &gt; 0)</span><br><span class="line">                list.Clear();</span><br><span class="line">            if (map != null &amp;&amp; map.Count &gt; 0)</span><br><span class="line">                map.Clear();</span><br><span class="line">        &#125;   </span><br><span class="line"></span><br><span class="line">        public void loadDataFromBin()</span><br><span class="line">        &#123;   </span><br><span class="line">            Stream fs = ConfLoader.Singleton.getStreamByteName(typeof(#CONTAINER_CLASS_NAME#).Name + ".byte");</span><br><span class="line">            if(fs != null)</span><br><span class="line">            &#123;</span><br><span class="line">                BinaryReader br = new BinaryReader(fs);</span><br><span class="line">                uint offset = 0;</span><br><span class="line">                bool frist = true;</span><br><span class="line">                try&#123;</span><br><span class="line">                    while (fs.Length - fs.Position &gt; 0)</span><br><span class="line">                    &#123;</span><br><span class="line">                        if (frist)</span><br><span class="line">                        &#123;</span><br><span class="line">                            frist = false;</span><br><span class="line">                            ClearList();</span><br><span class="line">                            var count = br.ReadInt32();</span><br><span class="line">                            list =  new List&lt;#CLASS_NAME#&gt;(count);</span><br><span class="line">                            map = new Dictionary&lt;int, #CLASS_NAME#&gt;(count);</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        var length = br.ReadInt32();</span><br><span class="line">                        var data = br.ReadBytes(length);</span><br><span class="line">                        var obj= #CLASS_NAME#Buffer.deserialize(data, ref offset);</span><br><span class="line">                        offset = 0;</span><br><span class="line">                        list.Add(obj);</span><br><span class="line">                        map.Add(obj.id, obj); </span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;catch (Exception ex)</span><br><span class="line">                &#123;</span><br><span class="line">                    Debug.LogError("import data error: " + ex.ToString());</span><br><span class="line">                &#125;           </span><br><span class="line">                br.Close();</span><br><span class="line">                fs.Close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>ConfLoader.cs(二进制配置数据文件加载类 - 这个不需要自动化生成)</p>
</li>
</ol>
<p>这里只支持了一维数组维度的配置:<br>来看下自动生成后的相关代码：<br>GameDataManager.cs<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Auto generated, do not edit it</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">using</span> xbuffer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Data</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">GameDataManager</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">readonly</span> GameDataManager Instance = <span class="keyword">new</span> GameDataManager();</span><br><span class="line"></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">public</span> t_AuthorInfoContainer t_AuthorInfocontainer = <span class="keyword">new</span> t_AuthorInfoContainer();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">public</span> t_GlobalContainer t_Globalcontainer = <span class="keyword">new</span> t_GlobalContainer();</span><br><span class="line">        </span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="title">GameDataManager</span>(<span class="params"></span>)</span><br><span class="line">        </span>&#123;</span><br><span class="line">        </span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadAll</span>(<span class="params"></span>)</span><br><span class="line">        </span>&#123;</span><br><span class="line">            </span><br><span class="line">            t_AuthorInfocontainer.loadDataFromBin();</span><br><span class="line">            </span><br><span class="line">            t_Globalcontainer.loadDataFromBin();</span><br><span class="line">            </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>t_AuthorInfoContainer.cs<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Auto generated by XbufferExcelToData, do not edit it </span><br><span class="line"> * 表格名字</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> xbuffer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Data</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">t_AuthorInfoContainer</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> List&lt;t_AuthorInfo&gt; list = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">private</span> Dictionary&lt;<span class="keyword">int</span>, t_AuthorInfo&gt; map = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> List&lt;t_AuthorInfo&gt; <span class="title">getList</span>(<span class="params"></span>)</span><br><span class="line">        </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (list == <span class="keyword">null</span> || list.Count &lt;= <span class="number">0</span>)</span><br><span class="line">                loadDataFromBin();</span><br><span class="line">            <span class="keyword">return</span> list;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> Dictionary&lt;<span class="keyword">int</span>, t_AuthorInfo&gt; getMap()</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (map == <span class="keyword">null</span> || map.Count &lt;= <span class="number">0</span>)</span><br><span class="line">                loadDataFromBin();</span><br><span class="line">            <span class="keyword">return</span> map;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ClearList</span>(<span class="params"></span>)</span><br><span class="line">        </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (list != <span class="keyword">null</span> &amp;&amp; list.Count &gt; <span class="number">0</span>)</span><br><span class="line">                list.Clear();</span><br><span class="line">            <span class="keyword">if</span> (map != <span class="keyword">null</span> &amp;&amp; map.Count &gt; <span class="number">0</span>)</span><br><span class="line">                map.Clear();</span><br><span class="line">        &#125;   </span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadDataFromBin</span>(<span class="params"></span>)</span><br><span class="line">        </span>&#123;   </span><br><span class="line">            Stream fs = ConfLoader.Singleton.getStreamByteName(<span class="keyword">typeof</span>(t_AuthorInfo).Name);</span><br><span class="line">            <span class="keyword">if</span>(fs != <span class="keyword">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                BinaryReader br = <span class="keyword">new</span> BinaryReader(fs);</span><br><span class="line">                <span class="keyword">uint</span> offset = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">bool</span> frist = <span class="keyword">true</span>;</span><br><span class="line">                <span class="keyword">try</span>&#123;</span><br><span class="line">                    <span class="keyword">while</span> (fs.Length - fs.Position &gt; <span class="number">0</span>)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">if</span> (frist)</span><br><span class="line">                        &#123;</span><br><span class="line">                            frist = <span class="keyword">false</span>;</span><br><span class="line">                            ClearList();</span><br><span class="line">                            <span class="keyword">var</span> count = br.ReadInt32();</span><br><span class="line">                            list =  <span class="keyword">new</span> List&lt;t_AuthorInfo&gt;(count);</span><br><span class="line">                            map = <span class="keyword">new</span> Dictionary&lt;<span class="keyword">int</span>, t_AuthorInfo&gt;(count);</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">var</span> length = br.ReadInt32();</span><br><span class="line">                        <span class="keyword">var</span> data = br.ReadBytes(length);</span><br><span class="line">                        <span class="keyword">var</span> obj= t_AuthorInfoBuffer.deserialize(data, <span class="keyword">ref</span> offset);</span><br><span class="line">                        offset = <span class="number">0</span>;</span><br><span class="line">                        list.Add(obj);</span><br><span class="line">                        map.Add(obj.id, obj); </span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;<span class="keyword">catch</span> (Exception ex)</span><br><span class="line">                &#123;</span><br><span class="line">                    Debug.LogError(<span class="string">"import data error: "</span> + ex.ToString());</span><br><span class="line">                &#125;           </span><br><span class="line">                br.Close();</span><br><span class="line">                fs.Close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Note：</p>
<ol>
<li>占时我ConfLoad.cs加载二进制文件是通过放在Resources目录下以TextAsset形式加载进来，所以加载的时候是没带后缀的，具体ConfLoad代码根据不同的存储位置和加载方式会稍作改动。</li>
</ol>
<h4 id="读取序列化数据">读取序列化数据</h4><p>终于走到最后一步了，完成这一步，导表工具的工具链基本就算打通了。</p>
<p>ConfLoader.cs<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line"> * Description:             配置表加载辅助单例类</span><br><span class="line"> * Author:                  tanghuan</span><br><span class="line"> * Create Date:             2018/09/05</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">using System.Collections;</span><br><span class="line">using System.Collections.Generic;</span><br><span class="line">using System.IO;</span><br><span class="line">using UnityEngine;</span><br><span class="line"></span><br><span class="line">/// &lt;summary&gt;</span><br><span class="line">/// 配置表加载辅助单例类</span><br><span class="line">/// &lt;/summary&gt;</span><br><span class="line">public class ConfLoader : SingletonTemplate&lt;ConfLoader&gt; &#123;</span><br><span class="line"></span><br><span class="line">    /// &lt;summary&gt;</span><br><span class="line">    /// Excel表格数据存储目录</span><br><span class="line">    /// &lt;/summary&gt;</span><br><span class="line">    public const string ExcelDataFolderPath = "DataBytes/";</span><br><span class="line"></span><br><span class="line">    public ConfLoader()</span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /// &lt;summary&gt;</span><br><span class="line">    /// 获取表格配置数据的二进制流数据</span><br><span class="line">    /// &lt;/summary&gt;</span><br><span class="line">    /// &lt;param name="bytefilename"&gt;&lt;/param&gt;</span><br><span class="line">    /// &lt;returns&gt;&lt;/returns&gt;</span><br><span class="line">    public Stream getStreamByteName(string bytefilename)</span><br><span class="line">    &#123;</span><br><span class="line">        var textasset = Resources.Load(ExcelDataFolderPath + bytefilename) as TextAsset;</span><br><span class="line">        var memorystream = new MemoryStream(textasset.bytes);</span><br><span class="line">        return memorystream;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>结合前面的GameManager.cs和所有对应的<em>*</em>Container.cs文件，完成我们对于序列化数据的加载。</p>
<p>激动人心的一刻，PC上成功加载表格数据代码并打印出来:<br><img src="/img/Unity/Data-Config-Automation/ExcelDataLoadAndPrint.png" alt="ExcelDataLoadAndPrint"></p>
<p>遇到个严峻的问题，真机上读取float数据时出了空引用:<br>？大写的问号脸，PC成功了但是真机Android报空？<br>问题猜想1:<br>是不是Xbuffer对于float的序列化或者反序列化没写对？<br>猜想1思考:<br>但仔细一想PC都是对的，这个猜测自然不成立了。</p>
<p>问题猜想2:<br>大小端数据存储的问题？<br>猜想2思考:<br>Windows PC(Intel)和Android Mix2手机(ARM)都是小端，同时真机不是数据错误而是报空，这个猜想也不成立。</p>
<p>问题猜想3:<br>根据报错是在var value = <em>(float</em>)(ptr + offset);时报空，那肯定跟字节数据float解析有关。<br>猜想3思考:<br>结合万能的Google，貌似总算找到关键点了。[Google问答](<a href="https://stackoverflow.com/questions/28436327/monotouch-floating-point-pointer-throws-nullreferenceexception-when-not-4-byte-a" target="_blank" rel="external">https://stackoverflow.com/questions/28436327/monotouch-floating-point-pointer-throws-nullreferenceexception-when-not-4-byte-a</a>]</p>
<p>原因:<br>上面那个问题提到了ARM设备上对于浮点数(比如floating，double)的值进行dereference要求内存地址必须是4-bytes对齐的形式才能正确解析。</p>
<p>相关知识储备:<br><a href="http://blog.zhaojie.me/2010/02/byte-order-and-related-library.html" target="_blank" rel="external">浅谈字节序（Byte Order）及其相关操作</a><br><a href="https://www.ibm.com/developerworks/library/pa-dalign/" target="_blank" rel="external">Data alignment: Straighten up and fly right</a></p>
<p>分析当前情况:<br>当前使用Xbuffer对于表格数据的存储只是单纯的按顺序填充数据，没有考虑任何的对齐问题，float数据也是前面的数据填到哪个字节数就在后面填入4bytes的float数据。</p>
<p>解决方案:<br>固定分配一个常驻的byte[4]作为中间缓冲区，在内存地址不满足4byte对齐时进行赋值byte数据然后对满足4byte对齐的常驻byte[4]对象进行解析。</p>
<p>floatBuffer.cs<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">******</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">xbuffer</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">floatBuffer</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">readonly</span> <span class="keyword">uint</span> size = <span class="keyword">sizeof</span>(<span class="keyword">float</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//-------------------------------------------------</span></span><br><span class="line">        <span class="comment">// float在ARM机器上dereferencing浮点数(float,double等)强制要求内存地址4字节对齐，不然会报空</span></span><br><span class="line">        <span class="comment">// 参考链接:</span></span><br><span class="line">        <span class="comment">// https://stackoverflow.com/questions/28436327/monotouch-floating-point-pointer-throws-nullreferenceexception-when-not-4-byte-a</span></span><br><span class="line">        <span class="comment">//-------------------------------------------------</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 修复方案，定义一个全局的4字节byte数组，用于不满足内存地址4字节对齐时赋值用于解析float</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">readonly</span> <span class="keyword">byte</span>[] fourByteAlginedArray = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">4</span>];</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">unsafe</span> <span class="keyword">static</span> <span class="keyword">float</span> <span class="title">deserialize</span>(<span class="params"><span class="keyword">byte</span>[] buffer, <span class="keyword">ref</span> <span class="keyword">uint</span> offset</span>)</span><br><span class="line">        </span>&#123;</span><br><span class="line">            <span class="keyword">fixed</span> (<span class="keyword">byte</span>* ptr = buffer)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">float</span> <span class="keyword">value</span>;</span><br><span class="line">                <span class="keyword">if</span> ((<span class="keyword">int</span>)(ptr + offset) % <span class="number">4</span> == <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">value</span> = *(<span class="keyword">float</span>*)(ptr + offset);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++)</span><br><span class="line">                    &#123;</span><br><span class="line">                        fourByteAlginedArray[i] = (ptr + offset)[i];</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">fixed</span> (<span class="keyword">byte</span>* ptr2 = fourByteAlginedArray)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">value</span> = *(<span class="keyword">float</span>*)(ptr2);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                offset += size;</span><br><span class="line">                <span class="keyword">return</span> BitConverter.IsLittleEndian ? <span class="keyword">value</span> : utils.toLittleEndian((<span class="keyword">uint</span>)<span class="keyword">value</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ******</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>真正激动人心的时刻，真机运行反序列化数据:<br><img src="/img/Unity/Data-Config-Automation/AndroidDeviceExcelDataLoadAndPrint.png" alt="AndroidDeviceExcelDataLoadAndPrint"><br>可以看到我们成功反序列化了表格数据，同时解决了float在真机上dereference问题。</p>
<h4 id="性能和内存开销">性能和内存开销</h4><p>工具链虽然打通了，但是我们我不只是要考虑能不能用，更多的我们还要关心内存开始以及序列化反序列化的速度性能问题。</p>
<p>接下来就是通过大数据配置来测试内存分配和序列化性能问题。</p>
<p>测试用例:<br>两张表（author_info.xlsx和global_config.xlsx），各配置了994行数据，然后复制两张表9次并改名(文件名和Excel内部sheet名都得改)(总计20张表 X 994行数据)。</p>
<p>测试平台：<br>PC Windows</p>
<p>导表耗时:<br><img src="/img/Unity/Data-Config-Automation/XbufferExcelToDataTimeConsume.png" alt="XbuuferExcelToDataTimeConsume"></p>
<p>导表后的二进制文件大小(未压缩):<br>二进制数据总大小我统计了下未压缩是1.3M。</p>
<p>表格数据读取内存以及反序列化时间开销：<br>我通过Unity的Profiler.GetMonoUsedSizeLong()统计计算堆内存的开销：<br>统计类:<br>MonoMeoryProfiler.cs<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line"> * Description:             MemoryProfiler.cs</span><br><span class="line"> * Author:                  TONYTANG</span><br><span class="line"> * Create Date:             2018/08/08</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">using System;</span><br><span class="line">using System.Collections;</span><br><span class="line">using System.Collections.Generic;</span><br><span class="line">using UnityEngine;</span><br><span class="line">using UnityEngine.Profiling;</span><br><span class="line"></span><br><span class="line">/// &lt;summary&gt;</span><br><span class="line">/// MemoryProfiler.cs</span><br><span class="line">/// 简陋的内存统计工具(统计托管的Mono内存)</span><br><span class="line">/// &lt;/summary&gt;</span><br><span class="line">public class MonoMemoryProfiler : SingletonTemplate&lt;MonoMemoryProfiler&gt; &#123;</span><br><span class="line"></span><br><span class="line">    /// &lt;summary&gt;</span><br><span class="line">    /// 内存Profile类型</span><br><span class="line">    /// &lt;/summary&gt;</span><br><span class="line">    public enum MemoryProfilerType</span><br><span class="line">    &#123;</span><br><span class="line">        CSharp_GC = 1,          // CS GC统计</span><br><span class="line">        Unity_Profiler = 2      // Unity Profiler接口统计</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /// &lt;summary&gt;</span><br><span class="line">    /// 当前内存统计类型</span><br><span class="line">    /// &lt;/summary&gt;</span><br><span class="line">    private MemoryProfilerType mCurrentMemoryProfilerType = MemoryProfilerType.Unity_Profiler;</span><br><span class="line"></span><br><span class="line">    /// &lt;summary&gt;</span><br><span class="line">    /// 内存标签名</span><br><span class="line">    /// &lt;/summary&gt;</span><br><span class="line">    private string mTagName;</span><br><span class="line">    </span><br><span class="line">    /// &lt;summary&gt;</span><br><span class="line">    /// 开始统计时总共使用的Mono内存</span><br><span class="line">    /// &lt;/summary&gt;</span><br><span class="line">    private long mTotalUsedMonoMemory_Begin;</span><br><span class="line"></span><br><span class="line">    /// &lt;summary&gt;</span><br><span class="line">    /// 结束统计时总共使用的Mono内存</span><br><span class="line">    /// &lt;/summary&gt;</span><br><span class="line">    private long mTotalUsedMonoMemory_End;</span><br><span class="line"></span><br><span class="line">    /// &lt;summary&gt;</span><br><span class="line">    /// 设置当前内存统计类型</span><br><span class="line">    /// &lt;/summary&gt;</span><br><span class="line">    /// &lt;param name="mpt"&gt;&lt;/param&gt;</span><br><span class="line">    public void setMemoryProfilerType(MemoryProfilerType mpt)</span><br><span class="line">    &#123;</span><br><span class="line">        mCurrentMemoryProfilerType = mpt;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /// &lt;summary&gt;</span><br><span class="line">    /// 开启内存统计Tag</span><br><span class="line">    /// &lt;/summary&gt;</span><br><span class="line">    /// &lt;param name="tag"&gt;&lt;/param&gt;</span><br><span class="line">    public void beginMemorySample(string tag)</span><br><span class="line">    &#123;</span><br><span class="line">        if(!tag.IsNullOrEmpty())</span><br><span class="line">        &#123;</span><br><span class="line">            mTagName = tag;</span><br><span class="line">            if (mCurrentMemoryProfilerType == MemoryProfilerType.CSharp_GC)</span><br><span class="line">            &#123;</span><br><span class="line">                // 确保得到正确的起始Heap Memory Size</span><br><span class="line">                mTotalUsedMonoMemory_Begin = GC.GetTotalMemory(true);</span><br><span class="line">            &#125;</span><br><span class="line">            else if (mCurrentMemoryProfilerType == MemoryProfilerType.Unity_Profiler)</span><br><span class="line">            &#123;</span><br><span class="line">                GC.Collect();</span><br><span class="line">                mTotalUsedMonoMemory_Begin = Profiler.GetMonoUsedSizeLong();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        else</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError("MonoMemoryProfiler的Tag不能为空!");</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /// &lt;summary&gt;</span><br><span class="line">    /// 结束内存统计</span><br><span class="line">    /// &lt;/summary&gt;</span><br><span class="line">    public void endMemorySample()</span><br><span class="line">    &#123;</span><br><span class="line">        if(!mTagName.IsNullOrEmpty())</span><br><span class="line">        &#123;</span><br><span class="line">            if (mCurrentMemoryProfilerType == MemoryProfilerType.CSharp_GC)</span><br><span class="line">            &#123;</span><br><span class="line">                mTotalUsedMonoMemory_End = GC.GetTotalMemory(false);</span><br><span class="line">            &#125;</span><br><span class="line">            else if (mCurrentMemoryProfilerType == MemoryProfilerType.Unity_Profiler)</span><br><span class="line">            &#123;</span><br><span class="line">                GC.Collect();</span><br><span class="line">                mTotalUsedMonoMemory_End = Profiler.GetMonoUsedSizeLong();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            var heapmemoryoffset = mTotalUsedMonoMemory_End - mTotalUsedMonoMemory_Begin;            </span><br><span class="line">            Debug.Log(string.Format("内存统计标签 : &#123;0&#125;", mTagName));</span><br><span class="line">            Debug.Log(string.Format("当前Mono内存大小 = &#123;0&#125; Bytes", mTotalUsedMonoMemory_End));</span><br><span class="line">            Debug.Log(string.Format("之前Mono内存大小 = &#123;0&#125; Bytes", mTotalUsedMonoMemory_Begin));</span><br><span class="line">            Debug.Log(string.Format("总共Mono内存占用 = &#123;0&#125; Bytes == &#123;1&#125; KB == &#123;2&#125; M", heapmemoryoffset, heapmemoryoffset / 1024 , heapmemoryoffset / (1024 * 1024)));</span><br><span class="line">            mTagName = string.Empty;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>PC:<br><img src="/img/Unity/Data-Config-Automation/Profiler_GetMonoUsedSizeLong_MemoryUsing.png" alt="Profiler_GetMonoUsedSizeLong_MemoryUsing"></p>
<p>Android真机:<br><img src="/img/Unity/Data-Config-Automation/AndroidDevice_Profiler_GetMonoUsedSizeLong_MemoryUsing.png" alt="AndroidDevice_Profiler_GetMonoUsedSizeLong_MemoryUsing"></p>
<p>可以看到两种方式统计有不少误差，在5M左右的堆内存开销。<br>时间开销PC在100ms左右,Android真机在200ms左右。</p>
<p>从20张表，每张表大概4-7个字段，各1000行数据来看，内存和序列化，反序列化速度都还是相当可观的。这里因为没有集成支持其他序列化方式，所以没法做详细的对比，详细各序列化库性能对比参考Xbuffer作者在Github上的对比<a href="https://github.com/CodeZeg/xbuffer" target="_blank" rel="external">Xbuffer</a>。</p>
<h4 id="优化点">优化点</h4><p>未来需要支持和优化的工作点：</p>
<ol>
<li>支持多维数据的配置(放弃支持)<br> 方案1：<pre><code><span class="bullet">- </span>扩展到多维不定长数组
</code></pre> 问题：<pre><code>-<span class="ruby"> 每一个维度上的数组长度都是不定长的，用多维数组存储会伴随多维数组的维度以及各维度的数量级增长，导致各维度各数量级上的长度信息存储成指数型增长。
</span>-<span class="ruby"> 同时会需要不定长的多维数组来支持，序列化和反序列化都很复杂
</span>-<span class="ruby"> 需要扩展<span class="constant">Xbuffer</span>的维度支持</span>
</code></pre> 方案2：<pre><code><span class="bullet">- </span>扩展到多维定长数组
</code></pre> 结论：<pre><code>不太可行，空间不浪费，各维度数组长度信息过于复杂，实现过于复杂
</code></pre> 问题：<pre><code>-<span class="ruby"> 只需要存储各个维度上的长度信息，维度长度信息和维度成正比，数量级小易存储
</span>-<span class="ruby"> 在配置复杂的不定长数据时，定长数组存储会造成大量的数据空间浪费
</span>-<span class="ruby"> 序列化代码依然复杂，反序列化代码相对简单
</span>-<span class="ruby"> 需要扩展<span class="constant">Xbuffer</span>的维度支持</span>
</code></pre> 结论：<pre><code>可行，空间比较浪费，多维度数组信息存储简单，实现相对复杂
</code></pre> 方案3：<pre><code><span class="bullet">- </span>多维数据依然存储在一个一维数组里，通过一维数组索引去访问
</code></pre> 问题：<pre><code>-<span class="ruby"> 数据存储空间不存在浪费
</span>-<span class="ruby"> 不需要扩展<span class="constant">Xbuffer</span>多维度支持
</span>-<span class="ruby"> 序列化和反序列化代码简单
</span>-<span class="ruby"> 无法像多维数组形式方便快速索引数据，只能计算好对应索引值去访问索引数据(数据量配置一旦大了，访问复杂度成指数级成长)
</span>-<span class="ruby"> 对于数据配置的抽象不友好们无法快速访问指定部分数据(相当于一维数组的单个字符分割，这样一来没有意义了)</span>
</code></pre> 结论：<pre><code>可行，空间不浪费，实现简单，访问和理解都不友好，配置复杂度影响访问复杂度。但变相成了一维数组的单个字符分割，没有意义了。
</code></pre> 最终结论：<br> 没有想到好的方式支持，最终放弃了支持多维数据的解析和快速访问。<br> 多维数据配置建议:<pre><code>-<span class="ruby"> 可以采用配置多个一维数组映射来支持。
</span>-<span class="ruby"> 获取一维数组配置后，自己去split分割访问解析。</span>
</code></pre></li>
<li>支持单列允许填写notation数据类型作为注释类型，单纯作为excel可查看的注释不序列化到数据里。(<strong>完成</strong>)<ul>
<li>修改导表工具支持notation数据类型配置作为注释类型</li>
<li>修改导表生成二进制数据那里不序列化注释类型数据</li>
</ul>
</li>
<li>支持个数据类型不配置，直接使用各类型默认值的方式(<strong>完成</strong>)<ul>
<li>修改导表公安局二进制数据序列化时判定书否有数据，没有数据用各类型默认数据</li>
</ul>
</li>
<li>二进制数据的压缩(暂时未做)<ul>
<li>对序列化好的二进制数据可以进行一些压缩格式的压缩后然后运行时解压的形式实现数据压缩</li>
</ul>
</li>
</ol>
<h4 id="Github">Github</h4><p>最后给出工具的Github链接:<br><a href="https://github.com/TonyTang1990/XbufferExcellToData" target="_blank" rel="external">XbufferExcelToData</a><br>上面写了导表工具的详细支持和测试信息。</p>
<h4 id="学习总结">学习总结</h4><ol>
<li>高效的数据序列化和反序列化不是语言自带的序列化和反序列化方式(很有可能默认使用了反射之类的)而是直接对于内存的数据的快速访问解析(比如flatbuffer，Xbuffer最终都是采用一个扁平化的字节数组对数据进行存储访问)</li>
<li>更进一步的数据压缩是对于基础数据类型的存储格式与数据解析定义(比如Protobuf里Varint数据存储方式)</li>
<li>跨语言的序列化反序列化只要定义统一的字节流写入和读取即可。</li>
<li>数据向后兼容问题(这里需要向Flatbuffer和Protobuf对于数据的存储做更多的处理才能做到)</li>
<li>完整的工具链要考虑的不仅仅是数据的存储和加载，还要关注自动化相关代码的生成(比如通过模板定义做到对多语言工具链的支持)。</li>
<li>二进制数据的处理需要关注大小端问题(不同CPU数据存储方式不一样)，内存对齐问题(不同架构比如ARM和Intel对于浮点数的dereference就有内存4字节对齐的要求)。</li>
<li>强大的正则表达式在做模板问题处理时，相当优秀。</li>
</ol>
<p>待续…..</p>
<h2 id="总结">总结</h2><h1 id="Reference">Reference</h1><h2 id="Conception_Part">Conception Part</h2><p><a href="https://github.com/google/protobuf" target="_blank" rel="external">protobuf</a><br><a href="https://github.com/google/flatbuffers" target="_blank" rel="external">FlatBuff</a><br><a href="https://github.com/CodeZeg/xbuffer" target="_blank" rel="external">Xbuffer</a></p>
<h2 id="Knowlodge_Part">Knowlodge Part</h2><p><a href="https://www.race604.com/flatbuffers-intro/" target="_blank" rel="external">FlatBuffers 体验</a><br><a href="https://github.com/google/flatbuffers/releases" target="_blank" rel="external">Flatc</a><br><a href="https://www.jianshu.com/p/30ef9b3780d9" target="_blank" rel="external">Protocol Buffer 序列化原理大揭秘 - 为什么Protocol Buffer性能这么好？</a><br><a href="https://www.xcode.me/more/microsoft-net-framework-version-define" target="_blank" rel="external">Microsoft .NET Framework 版本定义</a><br><a href="https://www.ibm.com/developerworks/library/pa-dalign/" target="_blank" rel="external">Data alignment: Straighten up and fly right</a><br><a href="https://blog.csdn.net/ce123_zhouwei/article/details/6971544" target="_blank" rel="external">详解大端模式和小端模式</a><br><a href="http://www.ruanyifeng.com/blog/2016/11/byte-order.html" target="_blank" rel="external">理解字节序</a><br><a href="http://blog.zhaojie.me/2010/02/byte-order-and-related-library.html" target="_blank" rel="external">浅谈字节序（Byte Order）及其相关操作</a></p>
<h2 id="Other_Part">Other Part</h2><p><a href="blog.csdn.net/qq_14903317/article/details/78637440">Unity C#配置表工具</a><br><a href="http://www.mamicode.com/info-detail-494944.html" target="_blank" rel="external">Unity3D游戏开发之当游戏开发遇上Excel</a><br><a href="http://www.xuanyusong.com/archives/2429" target="_blank" rel="external">Unity3D研究院之MAC&amp;Windows跨平台解析Excel（六十五）</a><br><a href="https://github.com/ExcelDataReader/ExcelDataReader" target="_blank" rel="external">ExcelReader</a><br><a href="https://www.race604.com/flatbuffers-intro/" target="_blank" rel="external">FlatBuffers 体验</a></p>
  
	</div>
		<footer class="article-footer clearfix">
<div class="article-catetags">


</div>



	<div class="article-share" id="share">
	
	  <div data-url="http://tonytang1990.github.io/2018/03/18/Data-Config-Automation/" data-title="Data-Config-Automation | 走停人生路" data-tsina="null" class="share clearfix">
	  </div>
	
	</div>


</footer>

   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/2018/04/01/Unity-Tips/" title="Unity-Tips">
  <strong>上一篇：</strong><br/>
  <span>
  Unity-Tips</span>
</a>
</div>


<div class="next">
<a href="/2017/08/14/Lua-In-Unity/"  title="Lua_In_Unity">
 <strong>下一篇：</strong><br/> 
 <span>Lua_In_Unity
</span>
</a>
</div>

</nav>

	
<section id="comments" class="comment">
	<div class="ds-thread" data-thread-key="2018/03/18/Data-Config-Automation/" data-title="Data-Config-Automation" data-url="http://tonytang1990.github.io/2018/03/18/Data-Config-Automation/"></div>
</section>


</div>  
      <div class="openaside"><a class="navbutton" href="#" title="顯示側邊欄"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">文章目錄</strong>
 
 <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Introduction"><span class="toc-number">1.</span> <span class="toc-text">Introduction</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Data_Config"><span class="toc-number">2.</span> <span class="toc-text">Data Config</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#What"><span class="toc-number">2.1.</span> <span class="toc-text">What</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Why"><span class="toc-number">2.2.</span> <span class="toc-text">Why</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#How"><span class="toc-number">2.3.</span> <span class="toc-text">How</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Functional_Requirement(功能需求)"><span class="toc-number">2.3.1.</span> <span class="toc-text">Functional Requirement(功能需求)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#原理思考"><span class="toc-number">2.3.2.</span> <span class="toc-text">原理思考</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#方案比较"><span class="toc-number">2.3.3.</span> <span class="toc-text">方案比较</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#C#_-Net_BinaryFormatter"><span class="toc-number">2.3.3.1.</span> <span class="toc-text">C# .Net BinaryFormatter</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#问题"><span class="toc-number">2.3.3.1.1.</span> <span class="toc-text">问题</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ProtoBuff"><span class="toc-number">2.3.3.2.</span> <span class="toc-text">ProtoBuff</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#ProtoBuff学习了解"><span class="toc-number">2.3.3.2.1.</span> <span class="toc-text">ProtoBuff学习了解</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Protocol_Buffer_3_in_Unity"><span class="toc-number">2.3.3.2.2.</span> <span class="toc-text">Protocol Buffer 3 in Unity</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#FlatBuff"><span class="toc-number">2.3.3.3.</span> <span class="toc-text">FlatBuff</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#介绍"><span class="toc-number">2.3.3.3.1.</span> <span class="toc-text">介绍</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#实战使用"><span class="toc-number">2.3.3.3.2.</span> <span class="toc-text">实战使用</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#深入探究"><span class="toc-number">2.3.3.3.3.</span> <span class="toc-text">深入探究</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Xbuffer"><span class="toc-number">2.3.3.4.</span> <span class="toc-text">Xbuffer</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#实战使用-1"><span class="toc-number">2.3.3.4.1.</span> <span class="toc-text">实战使用</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#深入探究-1"><span class="toc-number">2.3.3.4.2.</span> <span class="toc-text">深入探究</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#xbuffer_parser"><span class="toc-number">2.3.3.4.2.1.</span> <span class="toc-text">xbuffer_parser</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#xbuffer_runtime"><span class="toc-number">2.3.3.4.2.2.</span> <span class="toc-text">xbuffer_runtime</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#方案比较-1"><span class="toc-number">2.3.4.</span> <span class="toc-text">方案比较</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#实战"><span class="toc-number">2.4.</span> <span class="toc-text">实战</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#方案选择"><span class="toc-number">2.4.1.</span> <span class="toc-text">方案选择</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#基于Xbuffer的导表工具"><span class="toc-number">2.4.2.</span> <span class="toc-text">基于Xbuffer的导表工具</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#导表功能需求"><span class="toc-number">2.4.2.1.</span> <span class="toc-text">导表功能需求</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#支持导表路径配置"><span class="toc-number">2.4.2.2.</span> <span class="toc-text">支持导表路径配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#定义表格规则"><span class="toc-number">2.4.2.3.</span> <span class="toc-text">定义表格规则</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#读取excel数据"><span class="toc-number">2.4.2.4.</span> <span class="toc-text">读取excel数据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#创建对应数据结构文件"><span class="toc-number">2.4.2.5.</span> <span class="toc-text">创建对应数据结构文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#生成序列化所需文件"><span class="toc-number">2.4.2.6.</span> <span class="toc-text">生成序列化所需文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#序列化数据"><span class="toc-number">2.4.2.7.</span> <span class="toc-text">序列化数据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#统一表格数据加载和读取"><span class="toc-number">2.4.2.8.</span> <span class="toc-text">统一表格数据加载和读取</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#读取序列化数据"><span class="toc-number">2.4.2.9.</span> <span class="toc-text">读取序列化数据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#性能和内存开销"><span class="toc-number">2.4.2.10.</span> <span class="toc-text">性能和内存开销</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#优化点"><span class="toc-number">2.4.2.11.</span> <span class="toc-text">优化点</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Github"><span class="toc-number">2.4.2.12.</span> <span class="toc-text">Github</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#学习总结"><span class="toc-number">2.4.2.13.</span> <span class="toc-text">学习总结</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#总结"><span class="toc-number">2.5.</span> <span class="toc-text">总结</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Reference"><span class="toc-number">3.</span> <span class="toc-text">Reference</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Conception_Part"><span class="toc-number">3.1.</span> <span class="toc-text">Conception Part</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Knowlodge_Part"><span class="toc-number">3.2.</span> <span class="toc-text">Knowlodge Part</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Other_Part"><span class="toc-number">3.3.</span> <span class="toc-text">Other Part</span></a></li></ol></li></ol>
 
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隱藏側邊欄"></a></div>
<aside class="clearfix">

  
<div class="categorieslist">
	<p class="asidetitle">分類</p>
		<ul>
		
		  
			<li><a href="/categories/Algorithm/" title="Algorithm">Algorithm<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Android/" title="Android">Android<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Automation/" title="Automation">Automation<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Editor/" title="Editor">Editor<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Game-Engine/" title="Game_Engine">Game_Engine<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/Programming-Language/" title="Programming Language">Programming Language<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/Rendering/" title="Rendering">Rendering<sup>3</sup></a></li>
		  
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">標簽</p>
		<ul class="clearfix">
		
			
				<li><a href="/tags/Unity/" title="Unity">Unity<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/OpenGL/" title="OpenGL">OpenGL<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/Python/" title="Python">Python<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Resource/" title="Resource">Resource<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Sort/" title="Sort">Sort<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Shader/" title="Shader">Shader<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Art/" title="Art">Art<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Rendering/" title="Rendering">Rendering<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/GameDesignPattern/" title="GameDesignPattern">GameDesignPattern<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Editor/" title="Editor">Editor<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Programming/" title="Programming">Programming<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/AI/" title="AI">AI<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Android/" title="Android">Android<sup>1</sup></a></li>
			
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">友情鏈接</p>
    <ul>
        
          <li>
            
            	<a href="https://coderq.com" target="_blank" title="一个面向程序员交流分享的新一代社区">码农圈</a>
            
          </li>
        
          <li>
            
            	<a href="http://wuchong.me" target="_blank" title="Jark&#39;s Blog">Jark&#39;s Blog</a>
            
          </li>
        
    </ul>
</div>

  


  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS 訂閱</a>
</div>

</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> Hello ,I&#39;m Tony Tang. <br/>
			This is my new blog.</p>
	</section>
	 
	<div class="social-font" class="clearfix">
		
		
		
		
		
		
		
		
		
		
	</div>
			
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Jacman">Jacman</a> © 2018 
		
		<a href="/about" target="_blank" title="Tony Tang">Tony Tang</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery.qrcode-0.12.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  c.click(function(){
    ta.css('display', 'block').addClass('fadeIn');
  });
  o.click(function(){
    ta.css('display', 'none');
  });
  $(window).scroll(function(){
    ta.css("top",Math.max(140,320-$(this).scrollTop()));
  });
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina'),
      description = $this.attr('description');
  var html = [
  '<div class="hoverqrcode clearfix"></div>',
  '<a class="overlay" id="qrcode"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="微信"></a>',
  '<a href="http://widget.renren.com/dialog/share?resourceUrl=' + encodedUrl + '&srcUrl=' + encodedUrl + '&title=' + title +'" class="article-share-renren" target="_blank" title="人人"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="微博"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);

  $('.hoverqrcode').hide();

  var myWidth = 0;
  function updatehoverqrcode(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
    var qrsize = myWidth > 1024 ? 200:100;
    var options = {render: 'image', size: qrsize, fill: '#2ca6cb', text: url, radius: 0.5, quiet: 1};
    var p = $('.article-share-qrcode').position();
    $('.hoverqrcode').empty().css('width', qrsize).css('height', qrsize)
                          .css('left', p.left-qrsize/2+20).css('top', p.top-qrsize-10)
                          .qrcode(options);
  };
  $(window).resize(function(){
    $('.hoverqrcode').hide();
  });
  $('.article-share-qrcode').click(function(){
    updatehoverqrcode();
    $('.hoverqrcode').toggle();
  });
  $('.article-share-qrcode').hover(function(){}, function(){
      $('.hoverqrcode').hide();
  });
});   
</script>



<script type="text/javascript">
  var duoshuoQuery = {short_name:"TonyTang1990"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
    || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
</script> 







<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->





<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="返回頂部"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
</html>
