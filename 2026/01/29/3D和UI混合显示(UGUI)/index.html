
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  
    <title>3D和UI混合显示(UGUI) | 走停人生路</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="Tony Tang">
    

    
    <meta name="description" content="IntroductionUnity游戏开发过程中，3D游戏经常需要将3D模型和特效要在UI上面展示，解决3D和UI的渲染层级显示问题就是我们必须要解决的问题。本章是为了深入学习理解渲染顺序以及Mask原理相关知识。 Note:  本章节本非深入渲染管线学习，而是理解Unity渲染管线里的一些渲染顺序相关的决定因素设计。  渲染顺序相关概念一个物体的渲染无论3D还是2D都需要经过摄像机的照射，然后通">
<meta property="og:type" content="article">
<meta property="og:title" content="3D和UI混合显示(UGUI)">
<meta property="og:url" content="http://tonytang1990.github.io/2026/01/29/3D%E5%92%8CUI%E6%B7%B7%E5%90%88%E6%98%BE%E7%A4%BA(UGUI)/index.html">
<meta property="og:site_name" content="走停人生路">
<meta property="og:description" content="IntroductionUnity游戏开发过程中，3D游戏经常需要将3D模型和特效要在UI上面展示，解决3D和UI的渲染层级显示问题就是我们必须要解决的问题。本章是为了深入学习理解渲染顺序以及Mask原理相关知识。 Note:  本章节本非深入渲染管线学习，而是理解Unity渲染管线里的一些渲染顺序相关的决定因素设计。  渲染顺序相关概念一个物体的渲染无论3D还是2D都需要经过摄像机的照射，然后通">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/RenderOrder/RenderQueueIntroduction.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/RenderOrder/CameraInspector.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/RenderOrder/MeshRendererInspector.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/RenderOrder/SpriteRendererInspector.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/RenderOrder/SkinnedMeshRendererInspector.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/RenderOrder/MainCameraSetting.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/RenderOrder/UICameraSetting.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/RenderOrder/3DAnd2DMixResultPreview.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/RenderOrder/ZWriteZTestOnRedMaterial.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/RenderOrder/ZWriteZTestOnBlueMaterial.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/RenderOrder/ZWriteZTestOnCubeSceneView.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/RenderOrder/ZWriteZTestOnCubeGameView.PNG.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/RenderOrder/ZWriteZTestOnRedCubePosition.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/RenderOrder/ZWriteZTestOnBlueCubePosition.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/RenderOrder/ZWriteZTestOnWithSameDistanceResult.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/RenderOrder/SortingLayerSetting.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/RenderOrder/ZOn3D1Layer2000RedSetting.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/RenderOrder/ZOnDefaultLayer2500BlueSetting.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/RenderOrder/ZOnDefaultLayer2501GreenSetting.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/RenderOrder/SortingLayerAndRenderQueueResultPreview.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/RenderOrder/AllSortingOrderAndRenderQueueSetting.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/RenderOrder/SortingOrderAndRenderQueueResultPreview1.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/RenderOrder/SortingOrderAndRenderQueueResultPreview2.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/RenderOrder/StencilTestCompareValue.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/RenderOrder/StencilTestReplaceValue.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/RenderOrder/BeforeMaskComponentUsing.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/RenderOrder/MaskComponentUsing.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/RenderOrder/AfterMaskComponentUsing.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/RenderOrder/MaskFrameDebugDrawPreview.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/RenderOrder/AfterMaskGraphRenderStatus.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/RenderOrder/MaskChildGraphicStencilSetting.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/RenderOrder/RenderMaskChildGraphicStatus.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/RenderOrder/UnmaskMaterialStatus.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/RenderOrder/ParticleAdditiveInspector.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/RenderOrder/ParticleAdditiveShowResult.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/RenderOrder/ParticleAdditiveMaskInspector.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/RenderOder/ParticleAdditiveMaskShowResult.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/RenderOrder/ParticleAdditiveMaskFrameDebugger.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/RenderOrder/UIDefaultMatInspector.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/RenderOder/UIDefaultMaskMatInspector.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/RenderOrder/UIDefaultMaskedMatInspector.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/RenderOrder/UIDefaultMaskSceneAndHierachy.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/RenderOrder/UIDefaultMaskGame.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/RenderOrder/UIDefaultMaskFrameDebugger.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/RenderOrder/UIDefaultMaskParticleSystemFrameDebugger.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/RenderOrder/UIDefaultMaskSecondCanvasFrameDebugger.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/RenderOrder/UIDefaultMaskFrontImgFrameDebugger.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/RenderOrder/CreateEmptyUIParticleGameObject.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/RenderOrder/UIParticleRefreshButton.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/RenderOrder/CreateUIParticleFromGameObject.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/RenderOrder/ParticleEffectForUGUIMaskInspector">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/RenderOrder/ParticleEffectForUGUIMaskShowResult.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/RenderOrder/ParticleEffectForUGUIMaskFrameDebugger.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/RenderOrder/ParticleEffectForUGUICancelPSRenderer.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/RenderOrder/ParticleEffectForUGUIRectMask2DInspector.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/RenderOrder/ParticleEffectForUGUIRectMask2DShowResult.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/RenderOrder/ParticleEffectForUGUILayerInspector.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/RenderOrder/ParticleEffectForUGUILayerShowResult.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/RenderOrder/RectMask2DAndParticleClipInspector.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/RenderOrder/ParticleClipAdditiveMaskShaderInspector.PNG">
<meta property="og:image" content="http://tonytang1990.github.io/img/Unity/RenderOrder/RectMask2DAndParticleClipShowResult.PNG">
<meta property="article:published_time" content="2026-01-29T15:00:00.000Z">
<meta property="article:modified_time" content="2026-01-29T14:52:32.064Z">
<meta property="article:author" content="Tony Tang">
<meta property="article:tag" content="Rendering">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://tonytang1990.github.io/img/Unity/RenderOrder/RenderQueueIntroduction.PNG">

    
    <link rel="alternative" href="/atom.xml" title="走停人生路" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/jacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/jacman.jpg">
    
    
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 7.3.0"></head>

  <body>
    <header>
      
<div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.png" alt="走停人生路" title="走停人生路"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="走停人生路">走停人生路</a></h1>
				<h2 class="blog-motto">做着独立游戏梦，坚持走在游戏开发道路上的人</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">Home</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
						<li><a href="/about">About</a></li>
					
					<li>
 					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="search" id="search" name="q" autocomplete="off" maxlength="20" placeholder="搜索" />
						<input type="hidden" name="q" value="site:tonytang1990.github.io">
					</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
  
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2026/01/29/3D和UI混合显示(UGUI)/" title="3D和UI混合显示(UGUI)" itemprop="url">3D和UI混合显示(UGUI)</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Tony Tang" target="_blank" itemprop="author">Tony Tang</a>
		
  <p class="article-time">
    <time datetime="2026-01-29T15:00:00.000Z" itemprop="datePublished"> 发表于 2026-01-29</time>
    
  </p>
</header>
	<div class="article-content">
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">文章目录</strong>
		
			<ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Introduction"><span class="toc-number">1.</span> <span class="toc-text">Introduction</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%B8%B2%E6%9F%93%E9%A1%BA%E5%BA%8F%E7%9B%B8%E5%85%B3%E6%A6%82%E5%BF%B5"><span class="toc-number">2.</span> <span class="toc-text">渲染顺序相关概念</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Camera"><span class="toc-number">2.1.</span> <span class="toc-text">Camera</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#OpaqueSortMode"><span class="toc-number">2.1.1.</span> <span class="toc-text">OpaqueSortMode</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#TransparencySortMode"><span class="toc-number">2.1.2.</span> <span class="toc-text">TransparencySortMode</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Depth"><span class="toc-number">2.1.3.</span> <span class="toc-text">Depth</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#RenderQueue"><span class="toc-number">2.2.</span> <span class="toc-text">RenderQueue</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SortingLayer"><span class="toc-number">2.3.</span> <span class="toc-text">SortingLayer</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SortingOrder"><span class="toc-number">2.4.</span> <span class="toc-text">SortingOrder</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ZTest-ZWrite"><span class="toc-number">2.5.</span> <span class="toc-text">ZTest &amp; ZWrite</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ZWrite-%E6%B7%B1%E5%BA%A6%E5%86%99%E5%85%A5"><span class="toc-number">2.5.1.</span> <span class="toc-text">ZWrite(深度写入)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ZTest-%E6%B7%B1%E5%BA%A6%E6%B5%8B%E8%AF%95"><span class="toc-number">2.5.2.</span> <span class="toc-text">ZTest(深度测试)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Alpha-Blend-%E9%80%8F%E6%98%8E%E5%BA%A6%E6%B7%B7%E5%90%88"><span class="toc-number">2.5.3.</span> <span class="toc-text">Alpha Blend(透明度混合)</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%9E%E6%88%98"><span class="toc-number">3.</span> <span class="toc-text">实战</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Inspecotr%E6%89%A9%E5%B1%95"><span class="toc-number">3.1.</span> <span class="toc-text">Inspecotr扩展</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Camera-Inspector%E6%89%A9%E5%B1%95"><span class="toc-number">3.1.1.</span> <span class="toc-text">Camera Inspector扩展</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MeshRenderer-Inspector%E6%89%A9%E5%B1%95"><span class="toc-number">3.1.2.</span> <span class="toc-text">MeshRenderer Inspector扩展</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SpriteRenderer-Inspector%E6%89%A9%E5%B1%95"><span class="toc-number">3.1.3.</span> <span class="toc-text">SpriteRenderer Inspector扩展</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SkinnedMeshRenderer-Inspector%E6%89%A9%E5%B1%95"><span class="toc-number">3.1.4.</span> <span class="toc-text">SkinnedMeshRenderer Inspector扩展</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Camera-Depth"><span class="toc-number">3.2.</span> <span class="toc-text">Camera Depth</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ZWrite-ZTest-VS-RenderQueue"><span class="toc-number">3.3.</span> <span class="toc-text">(ZWrite &amp; ZTest) VS RenderQueue</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Sorting-Layer-VS-RenderQueue"><span class="toc-number">3.4.</span> <span class="toc-text">Sorting Layer VS RenderQueue</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Sorting-Order-VS-RenderQueue"><span class="toc-number">3.5.</span> <span class="toc-text">Sorting Order VS RenderQueue</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%93%E8%AE%BA"><span class="toc-number">3.6.</span> <span class="toc-text">结论</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Mask"><span class="toc-number">3.7.</span> <span class="toc-text">Mask</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Mask%E7%BB%84%E4%BB%B6"><span class="toc-number">3.7.1.</span> <span class="toc-text">Mask组件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Stencil-Buffer"><span class="toc-number">3.7.1.1.</span> <span class="toc-text">Stencil Buffer</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Mask-UI%E7%BB%84%E4%BB%B6"><span class="toc-number">3.7.1.2.</span> <span class="toc-text">Mask+UI组件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Mask-%E7%B2%92%E5%AD%90%E7%89%B9%E6%95%88"><span class="toc-number">3.7.1.3.</span> <span class="toc-text">Mask+粒子特效</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Mask-%E8%87%AA%E5%B8%A6ParticleAdditive-Shader"><span class="toc-number">3.7.1.3.1.</span> <span class="toc-text">Mask+自带ParticleAdditive Shader</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Mask-%E4%BF%AE%E6%94%B9ParticleAdditive-Mask-Shader"><span class="toc-number">3.7.1.3.2.</span> <span class="toc-text">Mask+修改ParticleAdditive Mask Shader</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BB%85%E4%BD%BF%E7%94%A8%E8%87%AA%E5%B8%A6UI-Default-Shader"><span class="toc-number">3.7.1.3.3.</span> <span class="toc-text">仅使用自带UI Default Shader</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#ParticleEffectForUGUI"><span class="toc-number">3.7.1.3.4.</span> <span class="toc-text">ParticleEffectForUGUI</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#ParticleEffectForUGUI%E5%AF%BC%E5%85%A5"><span class="toc-number">3.7.1.3.4.1.</span> <span class="toc-text">ParticleEffectForUGUI导入</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%89%A9%E5%B1%95%E7%B2%92%E5%AD%90%E7%89%B9%E6%95%88Shader%E6%94%AF%E6%8C%81Stencil%E5%92%8CClip"><span class="toc-number">3.7.1.3.4.2.</span> <span class="toc-text">扩展粒子特效Shader支持Stencil和Clip</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%88%B6%E4%BD%9C%E7%B2%92%E5%AD%90%E7%89%B9%E6%95%88GameObject"><span class="toc-number">3.7.1.3.4.3.</span> <span class="toc-text">制作粒子特效GameObject</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#UIParticle%E9%81%AE%E7%BD%A9"><span class="toc-number">3.7.1.3.4.4.</span> <span class="toc-text">UIParticle遮罩</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#UIParticle%E5%B1%82%E7%BA%A7"><span class="toc-number">3.7.1.3.4.5.</span> <span class="toc-text">UIParticle层级</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RectMask2D%E7%BB%84%E4%BB%B6"><span class="toc-number">3.7.2.</span> <span class="toc-text">RectMask2D组件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B0%86%E7%B2%92%E5%AD%90%E7%89%B9%E6%95%88%E9%87%8D%E5%AE%9A%E5%90%91%E5%88%B0CanvasRenderer%E9%87%8C%E5%8E%BB%E6%B8%B2%E6%9F%93"><span class="toc-number">3.7.2.1.</span> <span class="toc-text">将粒子特效重定向到CanvasRenderer里去渲染</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%8B%E5%8A%A8%E4%BC%A0%E9%80%92RectMask2D%E8%A3%81%E5%89%AA%E5%8C%BA%E5%9F%9F%E5%88%B0%E7%B2%92%E5%AD%90Shader"><span class="toc-number">3.7.2.2.</span> <span class="toc-text">手动传递RectMask2D裁剪区域到粒子Shader</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3D%E5%92%8C2D%E6%B7%B7%E5%90%88%E6%98%BE%E7%A4%BA%E5%8F%8A%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-number">4.</span> <span class="toc-text">3D和2D混合显示及决方案</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Extra-3D-Model-Camera"><span class="toc-number">4.1.</span> <span class="toc-text">Extra 3D Model Camera</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3D-Camera-Render-Texture"><span class="toc-number">4.2.</span> <span class="toc-text">3D Camera + Render Texture</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93"><span class="toc-number">5.</span> <span class="toc-text">学习总结</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Github"><span class="toc-number">6.</span> <span class="toc-text">Github</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Reference"><span class="toc-number">7.</span> <span class="toc-text">Reference</span></a></li></ol>
		
		</div>
		
		<h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>Unity游戏开发过程中，3D游戏经常需要将3D模型和特效要在UI上面展示，解决3D和UI的渲染层级显示问题就是我们必须要解决的问题。本章是为了<strong>深入学习理解渲染顺序以及Mask原理相关知识</strong>。</p>
<p>Note:</p>
<ol>
<li><strong>本章节本非深入渲染管线学习，而是理解Unity渲染管线里的一些渲染顺序相关的决定因素设计。</strong></li>
</ol>
<h1 id="渲染顺序相关概念"><a href="#渲染顺序相关概念" class="headerlink" title="渲染顺序相关概念"></a>渲染顺序相关概念</h1><p>一个物体的渲染无论3D还是2D都需要经过摄像机的照射，然后通过Shader经历渲染管线处理后最终显示在屏幕上。</p>
<p>在正确理解渲染顺序之前，让我们先了解一些相关概念知识：</p>
<ol>
<li><strong>Camera(OpaqueSortMode，TransparencySortMode，Depth)</strong></li>
<li><strong>RenderQueue</strong></li>
<li><strong>SortingLayer</strong></li>
<li><strong>SortingOrder</strong></li>
<li><strong>ZTest &amp; ZWrite</strong></li>
</ol>
<h2 id="Camera"><a href="#Camera" class="headerlink" title="Camera"></a>Camera</h2><h3 id="OpaqueSortMode"><a href="#OpaqueSortMode" class="headerlink" title="OpaqueSortMode"></a>OpaqueSortMode</h3><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/ScriptReference/Rendering.OpaqueSortMode.html">Opaque object sorting mode of a Camera. Opaque objects are sorted by various criteria (sorting layers, shader queues, materials, distance, lightmaps etc.) to maximize both the CPU efficiency (reduce number of state changes and improve draw call batching), and to maximize GPU efficiency (many GPUs prefer rough front-to-back rendering order for faster rejection of invisible surfaces).</a></p>
<p>简单的理解OpaqueSortMode是设置摄像机对<strong>不透明物体的排序顺序的策略标准</strong>。</p>
<p><strong>OpaqueSortMode.FrontToBack</strong>(根据距离排序，<strong>先绘制近的后绘制远的结合ZTest实现正确渲染显示</strong>)</p>
<p><strong>OpaqueSortMode.NoDistanceSort</strong>(不根据距离排序)</p>
<h3 id="TransparencySortMode"><a href="#TransparencySortMode" class="headerlink" title="TransparencySortMode"></a>TransparencySortMode</h3><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/ScriptReference/Camera-transparencySortMode.html">Transparent object sorting mode. By default, perspective Cameras sort objects based on distance from Camera position to the object center; and orthographic Cameras sort based on distance along the view direction.</a></p>
<p>简单的理解TransparencySortMode是设置摄像机对<strong>透明物体的排序顺序的策略标准</strong>。</p>
<p><strong>TransparencySortMode.Perspective</strong>(透视投影–判定物体中心与摄像机距离)</p>
<p><strong>TransparencySortMode.Orthographic</strong>(正交投影–判定物体与摄像机方向距离)</p>
<p><strong>TransparencySortMode.CustomAxis</strong>(轴判定–判定与指定轴距离)</p>
<p>比如纯2D游戏，可能就希望使用正交投影方式。</p>
<h3 id="Depth"><a href="#Depth" class="headerlink" title="Depth"></a>Depth</h3><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/ScriptReference/Camera-depth.html">Camera’s depth in the camera rendering order. Cameras with lower depth are rendered before cameras with higher depth. Use this to control the order in which cameras are drawn if you have multiple cameras and some of them don’t cover the full screen.</a></p>
<p>简单的理解Camera.depth是用于控制多个摄像机之间的渲染顺序，<strong>值越低越先渲染</strong>。</p>
<p>常规的场景摄像机和UI摄像机采用不同摄像机，为了确保UI摄像机在场景摄像机之上，所以一般把UI摄像机的depth设置的更小。</p>
<h2 id="RenderQueue"><a href="#RenderQueue" class="headerlink" title="RenderQueue"></a>RenderQueue</h2><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/ScriptReference/Rendering.RenderQueue.html">Determine in which order objects are renderered. This way for example transparent objects are rendered after opaque objects.</a></p>
<p>从上面的介绍可以看出，RenderQueue决定物体的渲染顺序(e.g. 透明物体在不透明物体之后渲染)</p>
<p>让我们看下不同的RenderQueue的详细介绍:</p>
<p><img src="/img/Unity/RenderOrder/RenderQueueIntroduction.PNG" alt="RenderQueueIntroduction"></p>
<p><strong>RenderQueue越大显示层级越高</strong></p>
<p>Note:</p>
<ol>
<li><strong>不透明物体RenderQueue&lt;&#x3D; 2500，透明物体RenderQueue&gt;2500</strong></li>
</ol>
<h2 id="SortingLayer"><a href="#SortingLayer" class="headerlink" title="SortingLayer"></a>SortingLayer</h2><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/ScriptReference/SortingLayer.html">SortingLayer allows you to set the render order of multiple sprites easily. There is always a default SortingLayer named “Default” which all sprites are added to initially. </a></p>
<p>从上面介绍可以看出，SortingLayer也是决定物体显示顺序优先级，<strong>SortingLayer越大显示层级越高</strong>，至于它和RenderQueu之间的优先级后续会讲到。</p>
<h2 id="SortingOrder"><a href="#SortingOrder" class="headerlink" title="SortingOrder"></a>SortingOrder</h2><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/ScriptReference/Renderer-sortingOrder.html">Renderer’s order within a sorting layer. You can group GameObjects into layers in their SpriteRenderercomponent. This is called the SortingLayer. The sorting order decides what priority each GameObject has to the Renderer within each Sorting Layer. </a></p>
<p>从上面介绍可以看出，SortingOrder是在SortingLayer之后的一个显示优先级设置，(SortingLayer相同前提下)<strong>值越大显示层级越高</strong>。</p>
<h2 id="ZTest-ZWrite"><a href="#ZTest-ZWrite" class="headerlink" title="ZTest &amp; ZWrite"></a>ZTest &amp; ZWrite</h2><h3 id="ZWrite-深度写入"><a href="#ZWrite-深度写入" class="headerlink" title="ZWrite(深度写入)"></a>ZWrite(深度写入)</h3><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/SL-ZWrite.html">Sets whether the <strong>depth buffer</strong> contents are updated during rendering. Normally, ZWrite is enabled for opaque objects and disabled for semi-transparent ones. Disabling ZWrite can lead to incorrect depth ordering. In this case, you need to sort geometry on the CPU.</a></p>
<p>从上面的介绍可以看出ZWrite是决定渲染时是否写入深度信息。<strong>通常情况情况不透明物体的ZWrite是打开的，半透明物体ZWrite是关闭的。</strong></p>
<p>那么什么是深度信息了？</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/lyh916/article/details/45317571"> 深度其实就是该像素点在3d世界中距离摄像机的距离。离摄像机越远，则深度值（Z值）越大。</a></p>
<p>这里需要了解两个渲染管线里的概念:</p>
<ol>
<li><strong>Z-Buffer(深度缓冲区)</strong>(用于记录当前渲染过程中渲染记录的深度信息)</li>
<li><strong>Color-Buff(颜色缓冲区)</strong>(用于记录当前渲染过程中渲染记录的颜色信息)</li>
</ol>
<p>Note:</p>
<ol>
<li><strong>深度信息写入的大前提是通过ZTest(深度测试)</strong></li>
</ol>
<h3 id="ZTest-深度测试"><a href="#ZTest-深度测试" class="headerlink" title="ZTest(深度测试)"></a>ZTest(深度测试)</h3><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/SL-ZTest.html">Sets the conditions under which geometry passes or fails depth testing. Depth testing allows GPUs that have “Early-Z” functionality to reject geometry early in the pipeline, and also ensures correct ordering of the geometry. </a></p>
<p>从上面的介绍可以看出ZTest是设置深度测试判定策略。深度测试可以实现“Early-Z”从而实现提前扔掉不必要的参与渲染的数据，同时ZTest是确保渲染顺序的关键。</p>
<p>ZWrite结合ZTest的逻辑流程如下：</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://www.bzetu.com/207/.html">当<strong>ZTest开启时</strong>，以<strong>深度缓冲</strong>为判断基准，来判断是否满足通过条件,如果<strong>不满足则直接丢弃，如果满足执行2</strong></a></li>
<li><strong>更新颜色缓存</strong>，同时<strong>判断是否可以更新深度缓冲</strong>，(也就是 ZWrite 是On还是 Off)，<strong>如果Off,不更新深度缓冲</strong><strong>(之后如果有同位置的颜色要深度测试，用的还是之前深度缓冲里对应颜色的深度)</strong>，如果满足执行3**</li>
<li><strong>更新深度缓冲</strong></li>
</ol>
<p><strong>ZTest与ZWrite的所有组合关系如下</strong></p>
<ol>
<li>深度测试通过，深度写入开启：更新颜色缓冲区，更新深度缓冲区；</li>
<li>深度测试通过，深度写入关闭：更新颜色缓冲区，不更新深度缓冲区；</li>
<li>深度测试失败，深度写入开启：不更新颜色缓冲区，不更新深度缓冲区；</li>
<li>深度测试失败，深度写入关闭：不更新颜色缓冲区，不更新深度缓冲区。</li>
</ol>
<p>了解了ZWrite和ZTest概念后，这里就会好奇，ZWrite和ZTest和RenderQueue都是用于决定渲染顺序的，那他们之间的优先级是怎样的了？详细测试见后面实战。</p>
<p>Note:</p>
<ol>
<li><strong>只有通过ZTest才会把像素信息写入Color-Buffer(颜色缓冲区)</strong></li>
</ol>
<h3 id="Alpha-Blend-透明度混合"><a href="#Alpha-Blend-透明度混合" class="headerlink" title="Alpha Blend(透明度混合)"></a>Alpha Blend(透明度混合)</h3><p><a target="_blank" rel="noopener" href="https://medium.com/ericzhan-publication/shader%E7%AD%86%E8%A8%98-%E9%80%8F%E6%98%8E%E7%89%A9%E9%AB%94-z-test-z-write-z-buffer-alpha-blending-692c60d9b605">透明度混合使用當前片元的透明度作為混合因子，與已經存儲在顏色緩衝中的顏色進行混合，得到新的顏色，不過透明度混合必須要關閉深度寫入(Zwrite) 需要特別注意的是，透明度混合只會關閉深度寫入不會關閉深度測試(ZTest)，這意味著當透明度混合渲染一個片元時，還是會比較他的深度與深度緩存中的深度值，如果深度值距離相機更遠就不會進行混合操作。</a></p>
<p><strong>正是因为透明度混合只关闭ZWrite不关闭ZTest，所以不透明物体依然可以通过ZTest进行对透明物体的遮挡。</strong></p>
<h1 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h1><p>学习了影响渲染顺序相关的概念后，我们知道了影响物体渲染顺序的东西很多，特别是材质的Shader里的RenderQueue，但Unity有一些数据默认是没有显示在Inspector面板上的，为了方便快速查看或修改渲染相关数据，这里我通过扩展Inspector的方式让相关数据显示出来。</p>
<h2 id="Inspecotr扩展"><a href="#Inspecotr扩展" class="headerlink" title="Inspecotr扩展"></a>Inspecotr扩展</h2><h3 id="Camera-Inspector扩展"><a href="#Camera-Inspector扩展" class="headerlink" title="Camera Inspector扩展"></a>Camera Inspector扩展</h3><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEditor;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> UnityEngine.Rendering;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> CameraInspector.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Camera组件Inspector扩展显示</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">CanEditMultipleObjects</span>]</span><br><span class="line">[<span class="meta">CustomEditor(typeof(Camera))</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CameraInspector</span> : <span class="title">CameraEditor</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Note:</span></span><br><span class="line">    <span class="comment">// opaqueSortMode和TransparentSortMode属性好像不属于Serialized成员，FindProperty得不到</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 目标组件对象</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> Camera mTarget;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Note:</span></span><br><span class="line">    <span class="comment">// 这里不能重写OnEnable，会导致CameraEditor原始部分流程异常</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnInspectorGUI</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">base</span>.OnInspectorGUI();</span><br><span class="line">        <span class="keyword">if</span>(mTarget == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            mTarget = (Camera)target;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (mTarget != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            EditorGUILayout.BeginHorizontal();</span><br><span class="line">            EditorGUILayout.LabelField(<span class="string">&quot;opaqueSortMode&quot;</span>, GUILayout.Width(<span class="number">170f</span>));</span><br><span class="line">            EditorGUI.BeginChangeCheck();</span><br><span class="line">            <span class="keyword">var</span> newOpaqueSortMode = (OpaqueSortMode)EditorGUILayout.EnumPopup(mTarget.opaqueSortMode);</span><br><span class="line">            <span class="keyword">if</span>(EditorGUI.EndChangeCheck())</span><br><span class="line">            &#123;</span><br><span class="line">                mTarget.opaqueSortMode = newOpaqueSortMode;</span><br><span class="line">            &#125;</span><br><span class="line">            EditorGUILayout.EndHorizontal();</span><br><span class="line">            EditorGUILayout.BeginHorizontal();</span><br><span class="line">            EditorGUILayout.LabelField(<span class="string">&quot;transparencySortMode&quot;</span>, GUILayout.Width(<span class="number">170f</span>));</span><br><span class="line">            EditorGUI.BeginChangeCheck();</span><br><span class="line">            <span class="keyword">var</span> newTransparencySortMode = (TransparencySortMode)EditorGUILayout.EnumPopup(mTarget.transparencySortMode);</span><br><span class="line">            <span class="keyword">if</span>(EditorGUI.EndChangeCheck())</span><br><span class="line">            &#123;</span><br><span class="line">                mTarget.transparencySortMode = newTransparencySortMode;</span><br><span class="line">            &#125;</span><br><span class="line">            EditorGUILayout.EndHorizontal();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/img/Unity/RenderOrder/CameraInspector.PNG" alt="CameraInspector"></p>
<p>可以看到通过扩展，我把Camera.opaqueSortMode和Camera.transparencySortMode都在Inspecotr面板显示出来了。</p>
<h3 id="MeshRenderer-Inspector扩展"><a href="#MeshRenderer-Inspector扩展" class="headerlink" title="MeshRenderer Inspector扩展"></a>MeshRenderer Inspector扩展</h3><p>MeshRendererInspector.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> UnityEditor;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> MeshRendererInspector.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> MeshRenderer编辑器扩展</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">CustomEditor(typeof(MeshRenderer))</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MeshRendererInspector</span> : <span class="title">Editor</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> SortingOrder属性</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> SerializedProperty mSortingOrderProperty;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Materials属性</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> SerializedProperty mMaterialsProperty;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 目标组件</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> MeshRenderer mTarget;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> SortingLayer名数组</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">string</span>[] mSortingLayersNameArray;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> SortingLayer索引</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span> mSortingLayerIndex;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnEnable</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mTarget = (MeshRenderer)target;</span><br><span class="line">        mSortingLayersNameArray = SortingLayer.layers.Select(x =&gt; x.name).ToArray();</span><br><span class="line">        mSortingOrderProperty = serializedObject.FindProperty(<span class="string">&quot;m_SortingOrder&quot;</span>);</span><br><span class="line">        mMaterialsProperty = serializedObject.FindProperty(<span class="string">&quot;m_Materials&quot;</span>);</span><br><span class="line">        UpdateSortingLayerIndex();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnInspectorGUI</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">base</span>.OnInspectorGUI();</span><br><span class="line">        serializedObject.Update();</span><br><span class="line">        EditorGUI.BeginChangeCheck();</span><br><span class="line">        <span class="keyword">var</span> selectedIndex = EditorGUILayout.Popup(<span class="string">&quot;SortingLayerName&quot;</span>, mSortingLayerIndex, mSortingLayersNameArray);</span><br><span class="line">        <span class="keyword">if</span>(EditorGUI.EndChangeCheck())</span><br><span class="line">        &#123;</span><br><span class="line">            mTarget.sortingLayerName = SortingLayer.layers[selectedIndex].name;</span><br><span class="line">            UpdateSortingLayerIndex();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(mSortingOrderProperty != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            EditorGUILayout.PropertyField(mSortingOrderProperty);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(mMaterialsProperty != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; mMaterialsProperty.arraySize; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> material = mMaterialsProperty.GetArrayElementAtIndex(i);</span><br><span class="line">                <span class="keyword">if</span>(material != <span class="literal">null</span> &amp;&amp; material.objectReferenceValue != <span class="literal">null</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    EditorGUILayout.BeginHorizontal();</span><br><span class="line">                    EditorGUILayout.LabelField(<span class="string">$&quot;Materials[<span class="subst">&#123;i&#125;</span>]&quot;</span>, GUILayout.Width(<span class="number">170f</span>));</span><br><span class="line">                    EditorGUILayout.BeginVertical();</span><br><span class="line">                    <span class="keyword">var</span> mat = (Material)material.objectReferenceValue;</span><br><span class="line">                    EditorGUILayout.ObjectField(mat, EditorType.MATERIAL_TYPE, <span class="literal">false</span>);</span><br><span class="line">                    EditorGUILayout.BeginHorizontal();</span><br><span class="line">                    EditorGUILayout.LabelField(<span class="string">&quot;RenderQueue&quot;</span>, GUILayout.Width(<span class="number">80f</span>));</span><br><span class="line">                    EditorGUILayout.IntField(mat.renderQueue);</span><br><span class="line">                    EditorGUILayout.EndHorizontal();</span><br><span class="line">                    EditorGUILayout.EndVertical();</span><br><span class="line">                    EditorGUILayout.EndHorizontal();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        serializedObject.ApplyModifiedProperties();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 更新SortingLayer索引</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">UpdateSortingLayerIndex</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mSortingLayerIndex = Array.FindIndex(mSortingLayersNameArray, FindSortingLayerNameIndex);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 查找当前SortingLayerName索引</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;sortingName&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="built_in">bool</span> <span class="title">FindSortingLayerNameIndex</span>(<span class="params"><span class="built_in">string</span> sortingName</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> mTarget.sortingLayerName == sortingName;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/img/Unity/RenderOrder/MeshRendererInspector.PNG" alt="MeshRendererInspector"></p>
<p>可以看到通过扩展，我把MeshRenderer的SortingLayerName和Sorting Order以及材质的RenderQueue值都显示出来了。</p>
<h3 id="SpriteRenderer-Inspector扩展"><a href="#SpriteRenderer-Inspector扩展" class="headerlink" title="SpriteRenderer Inspector扩展"></a>SpriteRenderer Inspector扩展</h3><p>SpriteRendererInspector.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Reflection;</span><br><span class="line"><span class="keyword">using</span> UnityEditor;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> SpriteRendererInspector.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> SpriteRenderer编辑器扩展</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">CustomEditor(typeof(SpriteRenderer))</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">SpriteRendererInspector</span> : <span class="title">Editor</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Materials属性</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> SerializedProperty mMaterialsProperty;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> SpriteRendererEditor类型信息</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> Type mSpriteRendererEditorType;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> SpriteRenderer Editor</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> Editor mSpriteRendererEditor;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> SortingLayer索引</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span> mSortingLayerIndex;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnEnable</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mMaterialsProperty = serializedObject.FindProperty(<span class="string">&quot;m_Materials&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> assembly = Assembly.GetAssembly(<span class="keyword">typeof</span>(Editor));</span><br><span class="line">            mSpriteRendererEditorType = assembly.GetType(<span class="string">&quot;UnityEditor.SpriteRendererEditor&quot;</span>, <span class="literal">true</span>);</span><br><span class="line">        mSpriteRendererEditor = Editor.CreateEditor(target, mSpriteRendererEditorType);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnInspectorGUI</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(mSpriteRendererEditor != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            mSpriteRendererEditor.OnInspectorGUI();</span><br><span class="line">        &#125;</span><br><span class="line">        serializedObject.Update();</span><br><span class="line">        <span class="keyword">if</span>(mMaterialsProperty != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; mMaterialsProperty.arraySize; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> material = mMaterialsProperty.GetArrayElementAtIndex(i);</span><br><span class="line">                <span class="keyword">if</span>(material != <span class="literal">null</span> &amp;&amp; material.objectReferenceValue != <span class="literal">null</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    EditorGUILayout.BeginHorizontal();</span><br><span class="line">                    EditorGUILayout.LabelField(<span class="string">$&quot;Materials[<span class="subst">&#123;i&#125;</span>]&quot;</span>, GUILayout.Width(<span class="number">170f</span>));</span><br><span class="line">                    EditorGUILayout.BeginVertical();</span><br><span class="line">                    <span class="keyword">var</span> mat = (Material)material.objectReferenceValue;</span><br><span class="line">                    EditorGUILayout.ObjectField(mat, EditorType.MATERIAL_TYPE, <span class="literal">false</span>);</span><br><span class="line">                    EditorGUILayout.BeginHorizontal();</span><br><span class="line">                    EditorGUILayout.LabelField(<span class="string">&quot;RenderQueue&quot;</span>, GUILayout.Width(<span class="number">80f</span>));</span><br><span class="line">                    EditorGUILayout.IntField(mat.renderQueue);</span><br><span class="line">                    EditorGUILayout.EndHorizontal();</span><br><span class="line">                    EditorGUILayout.EndVertical();</span><br><span class="line">                    EditorGUILayout.EndHorizontal();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        serializedObject.ApplyModifiedProperties();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/img/Unity/RenderOrder/SpriteRendererInspector.PNG" alt="SpriteRendererInspector"></p>
<p>可以看到通过扩展我把SpriteRenderer材质相关的RenderQueue值显示出来了。</p>
<h3 id="SkinnedMeshRenderer-Inspector扩展"><a href="#SkinnedMeshRenderer-Inspector扩展" class="headerlink" title="SkinnedMeshRenderer Inspector扩展"></a>SkinnedMeshRenderer Inspector扩展</h3><p>SKinnedMeshRendererInspector.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> UnityEditor;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> SkinnedMeshRendererInspector.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> SkinnedMeshRenderer编辑器扩展</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">CustomEditor(typeof(SkinnedMeshRenderer))</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">SkinnedMeshRendererInspector</span> : <span class="title">Editor</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> SortingOrder属性</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> SerializedProperty mSortingOrderProperty;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Materials属性</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> SerializedProperty mMaterialsProperty;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 目标组件</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> SkinnedMeshRenderer mTarget;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> SortingLayer名数组</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">string</span>[] mSortingLayersNameArray;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> SortingLayer索引</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span> mSortingLayerIndex;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnEnable</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mTarget = (SkinnedMeshRenderer)target;</span><br><span class="line">        mSortingLayersNameArray = SortingLayer.layers.Select(x =&gt; x.name).ToArray();</span><br><span class="line">        mSortingOrderProperty = serializedObject.FindProperty(<span class="string">&quot;m_SortingOrder&quot;</span>);</span><br><span class="line">        mMaterialsProperty = serializedObject.FindProperty(<span class="string">&quot;m_Materials&quot;</span>);</span><br><span class="line">        UpdateSortingLayerIndex();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnInspectorGUI</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">base</span>.OnInspectorGUI();</span><br><span class="line">        serializedObject.Update();</span><br><span class="line">        EditorGUI.BeginChangeCheck();</span><br><span class="line">        <span class="keyword">var</span> selectedIndex = EditorGUILayout.Popup(<span class="string">&quot;SortingLayerName&quot;</span>, mSortingLayerIndex, mSortingLayersNameArray);</span><br><span class="line">        <span class="keyword">if</span>(EditorGUI.EndChangeCheck())</span><br><span class="line">        &#123;</span><br><span class="line">            mTarget.sortingLayerName = SortingLayer.layers[selectedIndex].name;</span><br><span class="line">            UpdateSortingLayerIndex();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(mSortingOrderProperty != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            EditorGUILayout.PropertyField(mSortingOrderProperty);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(mMaterialsProperty != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; mMaterialsProperty.arraySize; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> material = mMaterialsProperty.GetArrayElementAtIndex(i);</span><br><span class="line">                <span class="keyword">if</span>(material != <span class="literal">null</span> &amp;&amp; material.objectReferenceValue != <span class="literal">null</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    EditorGUILayout.BeginHorizontal();</span><br><span class="line">                    EditorGUILayout.LabelField(<span class="string">$&quot;Materials[<span class="subst">&#123;i&#125;</span>]&quot;</span>, GUILayout.Width(<span class="number">170f</span>));</span><br><span class="line">                    EditorGUILayout.BeginVertical();</span><br><span class="line">                    <span class="keyword">var</span> mat = (Material)material.objectReferenceValue;</span><br><span class="line">                    EditorGUILayout.ObjectField(mat, EditorType.MATERIAL_TYPE, <span class="literal">false</span>);</span><br><span class="line">                    EditorGUILayout.BeginHorizontal();</span><br><span class="line">                    EditorGUILayout.LabelField(<span class="string">&quot;RenderQueue&quot;</span>, GUILayout.Width(<span class="number">80f</span>));</span><br><span class="line">                    EditorGUILayout.IntField(mat.renderQueue);</span><br><span class="line">                    EditorGUILayout.EndHorizontal();</span><br><span class="line">                    EditorGUILayout.EndVertical();</span><br><span class="line">                    EditorGUILayout.EndHorizontal();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        serializedObject.ApplyModifiedProperties();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 更新SortingLayer索引</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">UpdateSortingLayerIndex</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mSortingLayerIndex = Array.FindIndex(mSortingLayersNameArray, FindSortingLayerNameIndex);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 查找当前SortingLayerName索引</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;sortingName&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="built_in">bool</span> <span class="title">FindSortingLayerNameIndex</span>(<span class="params"><span class="built_in">string</span> sortingName</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> mTarget.sortingLayerName == sortingName;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/img/Unity/RenderOrder/SkinnedMeshRendererInspector.PNG" alt="SkinnedMeshRendererInspector"></p>
<p>可以看到通过扩展我把SkinnedMeshRenderer的SortingLayerName和Sorting Order以及材质设置的RenderQueue值都显示出来了。</p>
<h2 id="Camera-Depth"><a href="#Camera-Depth" class="headerlink" title="Camera Depth"></a>Camera Depth</h2><p><strong>摄像机深度在所有影响渲染排序的因素里排首位</strong></p>
<p>游戏开发过程中我们的UI往往在3D场景之上，为了做不同的渲染合批，我们一般会设置2个摄像机，一个作为3D主摄像机，一个作为UI摄像机。</p>
<p><img src="/img/Unity/RenderOrder/MainCameraSetting.PNG" alt="MainCameraSetting"></p>
<p><img src="/img/Unity/RenderOrder/UICameraSetting.PNG" alt="UICameraSetting"></p>
<p>可以看到为了使UI摄像机渲染结果再3D主摄像机之上，我们把UI摄像机的Depth设置值&gt;3D主摄像机</p>
<p><img src="/img/Unity/RenderOrder/3DAnd2DMixResultPreview.PNG" alt="3DAnd2DMixResultPreview"></p>
<p>可以看到UI摄像机照射的结果显示在了3D主摄像机之上，所以可以得出<strong>Camera.Depth值越大越晚渲染</strong>。</p>
<h2 id="ZWrite-ZTest-VS-RenderQueue"><a href="#ZWrite-ZTest-VS-RenderQueue" class="headerlink" title="(ZWrite &amp; ZTest) VS RenderQueue"></a>(ZWrite &amp; ZTest) VS RenderQueue</h2><p>前面提到过ZWrite&amp;ZTest和RenderQueue都是影响渲染顺序的关键。那么他们之间优先级又是怎样得了？</p>
<p>这里直接说结论:</p>
<p><a target="_blank" rel="noopener" href="https://dev.twsiyuan.com/2018/05/unity-rendering-order.html"><strong>如果开启了ZTest和ZWrite，可不管物件绘制順序 (rendering order)，使得里摄像机越近的物件，永远都绘制在其他离摄像机越远的物件之前 (<code>ZTest LEqual</code>)。</strong></a></p>
<p>首先我们创建一个ZWrite On和ZTest LEqual的Shader:</p>
<p>ZWriteZTestOnSurfaceShader.shader</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Shader <span class="string">&quot;Custom/ZWriteZTestOnSurfaceShader&quot;</span></span><br><span class="line">&#123;</span><br><span class="line">    ******</span><br><span class="line">    </span><br><span class="line">    SubShader</span><br><span class="line">    &#123;</span><br><span class="line">        Tags &#123; <span class="string">&quot;RenderType&quot;</span>=<span class="string">&quot;Opaque&quot;</span> &#125;</span><br><span class="line">        LOD <span class="number">200</span></span><br><span class="line">        ZWrite On</span><br><span class="line">        ZTest LEqual</span><br><span class="line">		</span><br><span class="line">        ******</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从上面可以看到我们指定了ZWrite On和ZTest LEqual表示开始深度写入，且深度比较标准是距离越近或相等的情况通过深度测试。同时我们将默认的RenderQueue设置成Opaque，用于不透明物体的渲染。</p>
<p><img src="/img/Unity/RenderOrder/ZWriteZTestOnRedMaterial.PNG" alt="ZWriteZTestOnRedMaterial"></p>
<p><img src="/img/Unity/RenderOrder/ZWriteZTestOnBlueMaterial.PNG" alt="ZWriteZTestOnBlueMaterial"></p>
<p><img src="/img/Unity/RenderOrder/ZWriteZTestOnCubeSceneView.PNG" alt="ZWriteZTestOnCubeSceneView"></p>
<p><img src="/img/Unity/RenderOrder/ZWriteZTestOnCubeGameView.PNG.PNG" alt="ZWriteZTestOnCubeGameView.PNG"></p>
<p>从上面可以看到我们创建了一个ZWrite On ZTest LEqual且RenderQueue分别为2010(红色)和2000(蓝色)的材质球，分别用于两个Cube渲染显示。</p>
<p>可以看到即使红色小球的RenderQueue值更高，但因为开启了ZWrite On和ZTest LEqual，红色Cube离摄像机更远依然渲染在蓝色Cube背后。</p>
<p>接下来让我们看一下两个Cube距离摄像机位置一致时，RenderQueue不一样，两个Cube是怎么显示的？</p>
<p><img src="/img/Unity/RenderOrder/ZWriteZTestOnRedCubePosition.PNG" alt="ZWriteZTestOnRedCubePosition"></p>
<p><img src="/img/Unity/RenderOrder/ZWriteZTestOnBlueCubePosition.PNG" alt="ZWriteZTestOnBlueCubePosition"></p>
<p><img src="/img/Unity/RenderOrder/ZWriteZTestOnWithSameDistanceResult.PNG" alt="ZWriteZTestOnWithSameDistanceResult"></p>
<p>从上面可以看到，距离摄像机相同距离的前提下，红色Cube拥有更高的RenderQueue(2010)显示在了蓝色Cube RenderQueue(2000)之上。</p>
<p>结论：</p>
<ol>
<li><strong>开启ZWrite和ZTest的情况下，深度优先于RenderQueue，深度一样则比较RenderQueue</strong></li>
</ol>
<h2 id="Sorting-Layer-VS-RenderQueue"><a href="#Sorting-Layer-VS-RenderQueue" class="headerlink" title="Sorting Layer VS RenderQueue"></a>Sorting Layer VS RenderQueue</h2><p>那么Sorting Layer和RenderQueue在渲染顺序里谁的优先级更高了？</p>
<p><strong>不透明物体 &gt; 透明物体</strong></p>
<p><strong>同为不透明物体或透明物体时，Sorting Layer &gt; RenderQueue</strong></p>
<p>在测试之前让我们首先添加几个3D Sorting Layer：</p>
<p><img src="/img/Unity/RenderOrder/SortingLayerSetting.PNG" alt="SortingLayerSetting"></p>
<p>接下来让我们实战测试：</p>
<p>红色方块设置：</p>
<p><img src="/img/Unity/RenderOrder/ZOn3D1Layer2000RedSetting.PNG" alt="ZOn3D1Layer2000RedSetting"></p>
<p>蓝色方块设置：</p>
<p><img src="/img/Unity/RenderOrder/ZOnDefaultLayer2500BlueSetting.PNG" alt="ZOnDefaultLayer2500BlueSetting"></p>
<p>绿色方块设置：</p>
<p><img src="/img/Unity/RenderOrder/ZOnDefaultLayer2501GreenSetting.PNG" alt="ZOnDefaultLayer2501GreenSetting"></p>
<p>Game渲染结果：</p>
<p><img src="/img/Unity/RenderOrder/SortingLayerAndRenderQueueResultPreview.PNG" alt="SortingLayerAndRenderQueueResultPreview"></p>
<p>从上面的测试可以看到:</p>
<ol>
<li><strong>同时开启ZWrite和ZTest，当物体都是不透明物体时Sorting Layer设置优先于RenderQueue</strong></li>
<li><strong>同时开启ZWrite和ZTest，一个为不透明物体一个为透明物体时，透明物体在不透明物体之后渲染，此时RenderQueue的影响优先与Sorting Layer</strong></li>
</ol>
<p>Note:</p>
<ol>
<li><strong>RenderQueue 2500是不透明物体(&lt;&#x3D;2500)和透明物体(&gt;2500)的分界线</strong></li>
</ol>
<h2 id="Sorting-Order-VS-RenderQueue"><a href="#Sorting-Order-VS-RenderQueue" class="headerlink" title="Sorting Order VS RenderQueue"></a>Sorting Order VS RenderQueue</h2><p>那么Sorting Order和RenderQueue在渲染顺序里谁的优先级更高了？</p>
<p>在前面我们了解到RenderQueue会影响物体处于透明或不透明渲染队列里，所以</p>
<p><strong>不透明物体 &gt; 透明物体</strong></p>
<p><strong>同为不透明物体或透明物体时，Sorting Order&gt; RenderQueue</strong></p>
<p>这里我就不一一截图单个物体材质设置了，通过材质球名字就能看出我的测试单元设置:</p>
<p><img src="/img/Unity/RenderOrder/AllSortingOrderAndRenderQueueSetting.PNG" alt="AllSortingOrderAndRenderQueueSetting"></p>
<p><strong>ZOnSortingOrder10GreenMaterial2000</strong> VS <strong>ZOnSortingOder5RedMaterial2005</strong> VS <strong>ZOnSortingOrder1BlueMaterial2009</strong></p>
<p><img src="/img/Unity/RenderOrder/SortingOrderAndRenderQueueResultPreview1.PNG" alt="SortingOrderAndRenderQueueResultPreview1"></p>
<p>从上面测试结果可以看看出:</p>
<ol>
<li><strong>同为不透明物体状态下，Sorting Order &gt; RenderQueue，而不是Sorting Order+RenderQueue的值决定的</strong></li>
</ol>
<p><strong>ZOnSortingOrder6BlueMaterial2100</strong> VS <strong>ZOnSortingOrder7GreenMaterial2000</strong></p>
<p><img src="/img/Unity/RenderOrder/SortingOrderAndRenderQueueResultPreview2.PNG" alt="SortingOrderAndRenderQueueResultPreview2"></p>
<p>从上面测试结果可以看看出:</p>
<ol>
<li><strong>不透明物体 &gt; 透明物体依然适用</strong></li>
</ol>
<h2 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h2><p>综合以上测试，针对渲染顺序影响因素，我们可以得出以下结论：</p>
<p><strong>Camera.depth &gt; Material type((RenderQueue不透明 &gt; RenderQueue透明) ) &gt; SortingLayer&gt; SortingOrder &gt; RenderQueue</strong></p>
<h2 id="Mask"><a href="#Mask" class="headerlink" title="Mask"></a>Mask</h2><p>Mask是指通过遮罩控制可见显示区域的一种遮罩显示。</p>
<p>UGUI里常见的遮罩有两种：</p>
<ol>
<li><strong>Mask</strong></li>
<li><strong>Rect2DMask</strong></li>
</ol>
<p>虽然都是实现Mask效果，但两个组件的底层遮罩实现原理却大不相同，接下来让我们深入Mask和Rect2DMask底层实现，深入理解Mask底层的相关知识，会后续3D和2D混合显示遮罩打下基础。</p>
<h3 id="Mask组件"><a href="#Mask组件" class="headerlink" title="Mask组件"></a>Mask组件</h3><p>在深入了解Mask组件之前，我们需要了解一下什么是Stencil Buffer(模板缓存)，<strong>Stencil Buffer是实现遮罩的底层渲染原理。</strong></p>
<h4 id="Stencil-Buffer"><a href="#Stencil-Buffer" class="headerlink" title="Stencil Buffer"></a>Stencil Buffer</h4><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/SL-Stencil.html">The stencil buffer stores an 8-bit integer value for each <strong>pixel</strong> in the frame buffer. Before executing the fragment <strong>shader</strong> for a given pixel, the GPU can compare the current value in the stencil buffer against a given reference value. This is called a stencil test. If the stencil test passes, the GPU performs the depth test. If the stencil test fails, the GPU skips the rest of the processing for that pixel. This means that you can use the stencil buffer as a mask to tell the GPU which pixels to draw, and which pixels to discard.</a></p>
<p>从上面的介绍可以看出，<strong>Stencil Buffer(模板缓存)不同于深度Buffer和颜色Buffer，不是用来存储深度或颜色信息的，而是一个每个像素分配8bit(0-255)用来存储Stencil比较值的地方。如果一个pixel通不过Stencil Test(类似Depth Test，但是是用来比较Stencil Buffer值的方式)，那么这个pixel将不会再走后续渲染流程(Depth Test)。</strong></p>
<p>Unity Stencil有很多参数，这里调几个重要的参数介绍：</p>
<ul>
<li><p><strong>comparisonOperation(Stencil值比较方式)</strong></p>
<p><img src="/img/Unity/RenderOrder/StencilTestCompareValue.PNG" alt="StencilTestCompareValue"></p>
<p><strong>Stencil Test比较公式:</strong></p>
<p>​        <strong>(ref &amp; readMask) comparisonFunction (stencilBufferValue &amp; readMask)</strong></p>
</li>
<li><p><strong>passOperation(Stencil值通过替换方式)</strong></p>
<p><img src="/img/Unity/RenderOrder/StencilTestReplaceValue.PNG" alt="StencilTestReplaceValue"></p>
</li>
<li><p><strong>ref(引用参考值)</strong></p>
<p><strong>用于Stencil值比较或Stencil Pass后值替换等</strong></p>
</li>
<li><p><strong>ReadMask(Stencil比较掩码)</strong></p>
<p><strong>用于Stencil Test时值比较过滤，从上面的Stencil Test公式可以看到Ref和Stencil Buffer Value值都与ReadMask与之后在进行比较的</strong></p>
</li>
<li><p><strong>WriteMask(Stencil写掩码)</strong></p>
<p><strong>用于Stencil Test通过后passOperation值写入过滤，即与passOperation后的值进行比较过滤再写入Stencil Buffer</strong></p>
</li>
</ul>
<p>更多参数参考官网：</p>
<p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/SL-Stencil.html">ShaderLab command: Stencil</a></p>
<p>Note:</p>
<ol>
<li><strong>Stencil Test发生Depth Test之前，Aplha Test和fragment shader之后。顺序是：Alpha Test -&gt; fragment shader -&gt; Stencil Test -&gt; depth test</strong></li>
<li><strong>模板缓冲可以用来制作物体的遮罩、轮廓描边、阴影、遮挡显示等等效果</strong></li>
</ol>
<h4 id="Mask-UI组件"><a href="#Mask-UI组件" class="headerlink" title="Mask+UI组件"></a>Mask+UI组件</h4><p>先让我们尝试一下Mask组件的使用：</p>
<p>使用Mask组件前：</p>
<p><img src="/img/Unity/RenderOrder/BeforeMaskComponentUsing.PNG" alt="BeforeMaskComponentUsing"></p>
<p>使用Mask组件后：</p>
<p><img src="/img/Unity/RenderOrder/MaskComponentUsing.PNG" alt="MaskComponentUsing"></p>
<p><img src="/img/Unity/RenderOrder/AfterMaskComponentUsing.PNG" alt="AfterMaskComponentUsing"></p>
<p>可以看到通过使用一个圆形遮罩我们成功的将√实现了圆形的遮罩显示，当同时右上角Status数据也可以看到，激活Mask给我们增加了1个Batches和2个SetPass calls，至于原因后续会讲到。</p>
<p>那么第一个疑问，我们想知道的是Mask组件式如何实现遮罩的了？</p>
<p>首先我打开FrameDebug看了下Image是实际绘制流程：</p>
<p><img src="/img/Unity/RenderOrder/MaskFrameDebugDrawPreview.PNG" alt="MaskFrameDebugDrawPreview"></p>
<p>可以看到1个Mask和1张图绘制总共分为3步，绘制了3次Mesh。</p>
<p>打开Mask.cs源码，我们会看到两个跟材质挂钩的代码:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> Stencil calculation time!    </span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Mask</span> : <span class="title">UIBehaviour</span>, <span class="title">ICanvasRaycastFilter</span>, <span class="title">IMaterialModifier</span></span><br><span class="line">   &#123;</span><br><span class="line">       ******</span><br><span class="line"></span><br><span class="line">       [<span class="meta">NonSerialized</span>]</span><br><span class="line">	<span class="keyword">private</span> Material m_MaskMaterial;</span><br><span class="line"></span><br><span class="line">	[<span class="meta">NonSerialized</span>]</span><br><span class="line">	<span class="keyword">private</span> Material m_UnmaskMaterial;</span><br><span class="line">    	</span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> Material <span class="title">GetModifiedMaterial</span>(<span class="params">Material baseMaterial</span>)</span></span><br><span class="line">       &#123;</span><br><span class="line">           <span class="keyword">if</span> (!MaskEnabled())</span><br><span class="line">               <span class="keyword">return</span> baseMaterial;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">var</span> rootSortCanvas = MaskUtilities.FindRootSortOverrideCanvas(transform);</span><br><span class="line">           <span class="keyword">var</span> stencilDepth = MaskUtilities.GetStencilDepth(transform, rootSortCanvas);</span><br><span class="line">           <span class="keyword">if</span> (stencilDepth &gt;= <span class="number">8</span>)</span><br><span class="line">           &#123;</span><br><span class="line">               Debug.LogWarning(<span class="string">&quot;Attempting to use a stencil mask with depth &gt; 8&quot;</span>, gameObject);</span><br><span class="line">               <span class="keyword">return</span> baseMaterial;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="built_in">int</span> desiredStencilBit = <span class="number">1</span> &lt;&lt; stencilDepth;</span><br><span class="line"></span><br><span class="line">           <span class="comment">// if we are at the first level...</span></span><br><span class="line">           <span class="comment">// we want to destroy what is there</span></span><br><span class="line">           <span class="keyword">if</span> (desiredStencilBit == <span class="number">1</span>)</span><br><span class="line">           &#123;</span><br><span class="line">               <span class="keyword">var</span> maskMaterial = StencilMaterial.Add(baseMaterial, <span class="number">1</span>, StencilOp.Replace, CompareFunction.Always, m_ShowMaskGraphic ? ColorWriteMask.All : <span class="number">0</span>);</span><br><span class="line">               StencilMaterial.Remove(m_MaskMaterial);</span><br><span class="line">               m_MaskMaterial = maskMaterial;</span><br><span class="line"></span><br><span class="line">               <span class="keyword">var</span> unmaskMaterial = StencilMaterial.Add(baseMaterial, <span class="number">1</span>, StencilOp.Zero, CompareFunction.Always, <span class="number">0</span>);</span><br><span class="line">               StencilMaterial.Remove(m_UnmaskMaterial);</span><br><span class="line">               m_UnmaskMaterial = unmaskMaterial;</span><br><span class="line">               graphic.canvasRenderer.popMaterialCount = <span class="number">1</span>;</span><br><span class="line">               graphic.canvasRenderer.SetPopMaterial(m_UnmaskMaterial, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">               <span class="keyword">return</span> m_MaskMaterial;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="comment">//otherwise we need to be a bit smarter and set some read / write masks</span></span><br><span class="line">           <span class="keyword">var</span> maskMaterial2 = StencilMaterial.Add(baseMaterial, desiredStencilBit | (desiredStencilBit - <span class="number">1</span>), StencilOp.Replace, CompareFunction.Equal, m_ShowMaskGraphic ? ColorWriteMask.All : <span class="number">0</span>, desiredStencilBit - <span class="number">1</span>, desiredStencilBit | (desiredStencilBit - <span class="number">1</span>));</span><br><span class="line">           StencilMaterial.Remove(m_MaskMaterial);</span><br><span class="line">           m_MaskMaterial = maskMaterial2;</span><br><span class="line"></span><br><span class="line">           graphic.canvasRenderer.hasPopInstruction = <span class="literal">true</span>;</span><br><span class="line">           <span class="keyword">var</span> unmaskMaterial2 = StencilMaterial.Add(baseMaterial, desiredStencilBit - <span class="number">1</span>, StencilOp.Replace, CompareFunction.Equal, <span class="number">0</span>, desiredStencilBit - <span class="number">1</span>, desiredStencilBit | (desiredStencilBit - <span class="number">1</span>));</span><br><span class="line">           StencilMaterial.Remove(m_UnmaskMaterial);</span><br><span class="line">           m_UnmaskMaterial = unmaskMaterial2;</span><br><span class="line">           graphic.canvasRenderer.popMaterialCount = <span class="number">1</span>;</span><br><span class="line">           graphic.canvasRenderer.SetPopMaterial(m_UnmaskMaterial, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">           <span class="keyword">return</span> m_MaskMaterial;</span><br><span class="line">       &#125;</span><br><span class="line">       ******</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>从源码可以看到，Mask组件实现了IMaterialModifier接口。</p>
<p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/2018.1/Documentation/ScriptReference/UI.IMaterialModifier.html">IMaterialModifier is Interface which allows for the modification of the Material used to render a Graphic before they are passed to the CanvasRenderer.</a></p>
<p>UGUI我们是通过Canvas统一进行绘制渲染的，从上面的介绍可以看出要实现IMaterialModifier允许我们在传递给CanvasRenderer绘制渲染UI(Graphic)之前进行材质处理，而IMaterialModifier.GetModifiedMaterial()正是这么个接口。</p>
<p>打开StencilMaterial.cs查看源码StencilMaterials.Add()接口:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Add a new material using the specified base and stencil ID.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Material <span class="title">Add</span>(<span class="params">Material baseMat, <span class="built_in">int</span> stencilID, StencilOp operation, CompareFunction compareFunction, ColorWriteMask colorWriteMask, <span class="built_in">int</span> readMask, <span class="built_in">int</span> writeMask</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> ((stencilID &lt;= <span class="number">0</span> &amp;&amp; colorWriteMask == ColorWriteMask.All) || baseMat == <span class="literal">null</span>)</span><br><span class="line">        <span class="keyword">return</span> baseMat;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!baseMat.HasProperty(<span class="string">&quot;_Stencil&quot;</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        Debug.LogWarning(<span class="string">&quot;Material &quot;</span> + baseMat.name + <span class="string">&quot; doesn&#x27;t have _Stencil property&quot;</span>, baseMat);</span><br><span class="line">        <span class="keyword">return</span> baseMat;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!baseMat.HasProperty(<span class="string">&quot;_StencilOp&quot;</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        Debug.LogWarning(<span class="string">&quot;Material &quot;</span> + baseMat.name + <span class="string">&quot; doesn&#x27;t have _StencilOp property&quot;</span>, baseMat);</span><br><span class="line">        <span class="keyword">return</span> baseMat;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!baseMat.HasProperty(<span class="string">&quot;_StencilComp&quot;</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        Debug.LogWarning(<span class="string">&quot;Material &quot;</span> + baseMat.name + <span class="string">&quot; doesn&#x27;t have _StencilComp property&quot;</span>, baseMat);</span><br><span class="line">        <span class="keyword">return</span> baseMat;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!baseMat.HasProperty(<span class="string">&quot;_StencilReadMask&quot;</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        Debug.LogWarning(<span class="string">&quot;Material &quot;</span> + baseMat.name + <span class="string">&quot; doesn&#x27;t have _StencilReadMask property&quot;</span>, baseMat);</span><br><span class="line">        <span class="keyword">return</span> baseMat;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!baseMat.HasProperty(<span class="string">&quot;_StencilWriteMask&quot;</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        Debug.LogWarning(<span class="string">&quot;Material &quot;</span> + baseMat.name + <span class="string">&quot; doesn&#x27;t have _StencilWriteMask property&quot;</span>, baseMat);</span><br><span class="line">        <span class="keyword">return</span> baseMat;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!baseMat.HasProperty(<span class="string">&quot;_ColorMask&quot;</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        Debug.LogWarning(<span class="string">&quot;Material &quot;</span> + baseMat.name + <span class="string">&quot; doesn&#x27;t have _ColorMask property&quot;</span>, baseMat);</span><br><span class="line">        <span class="keyword">return</span> baseMat;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; m_List.Count; ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        MatEntry ent = m_List[i];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ent.baseMat == baseMat</span><br><span class="line">            &amp;&amp; ent.stencilId == stencilID</span><br><span class="line">            &amp;&amp; ent.operation == operation</span><br><span class="line">            &amp;&amp; ent.compareFunction == compareFunction</span><br><span class="line">            &amp;&amp; ent.readMask == readMask</span><br><span class="line">            &amp;&amp; ent.writeMask == writeMask</span><br><span class="line">            &amp;&amp; ent.colorMask == colorWriteMask)</span><br><span class="line">        &#123;</span><br><span class="line">            ++ent.count;</span><br><span class="line">            <span class="keyword">return</span> ent.customMat;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> newEnt = <span class="keyword">new</span> MatEntry();</span><br><span class="line">    newEnt.count = <span class="number">1</span>;</span><br><span class="line">    newEnt.baseMat = baseMat;</span><br><span class="line">    newEnt.customMat = <span class="keyword">new</span> Material(baseMat);</span><br><span class="line">    newEnt.customMat.hideFlags = HideFlags.HideAndDontSave;</span><br><span class="line">    newEnt.stencilId = stencilID;</span><br><span class="line">    newEnt.operation = operation;</span><br><span class="line">    newEnt.compareFunction = compareFunction;</span><br><span class="line">    newEnt.readMask = readMask;</span><br><span class="line">    newEnt.writeMask = writeMask;</span><br><span class="line">    newEnt.colorMask = colorWriteMask;</span><br><span class="line">    newEnt.useAlphaClip = operation != StencilOp.Keep &amp;&amp; writeMask &gt; <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    newEnt.customMat.name = <span class="built_in">string</span>.Format(<span class="string">&quot;Stencil Id:&#123;0&#125;, Op:&#123;1&#125;, Comp:&#123;2&#125;, WriteMask:&#123;3&#125;, ReadMask:&#123;4&#125;, ColorMask:&#123;5&#125; AlphaClip:&#123;6&#125; (&#123;7&#125;)&quot;</span>, stencilID, operation, compareFunction, writeMask, readMask, colorWriteMask, newEnt.useAlphaClip, baseMat.name);</span><br><span class="line"></span><br><span class="line">    newEnt.customMat.SetInt(<span class="string">&quot;_Stencil&quot;</span>, stencilID);</span><br><span class="line">    newEnt.customMat.SetInt(<span class="string">&quot;_StencilOp&quot;</span>, (<span class="built_in">int</span>)operation);</span><br><span class="line">    newEnt.customMat.SetInt(<span class="string">&quot;_StencilComp&quot;</span>, (<span class="built_in">int</span>)compareFunction);</span><br><span class="line">    newEnt.customMat.SetInt(<span class="string">&quot;_StencilReadMask&quot;</span>, readMask);</span><br><span class="line">    newEnt.customMat.SetInt(<span class="string">&quot;_StencilWriteMask&quot;</span>, writeMask);</span><br><span class="line">    newEnt.customMat.SetInt(<span class="string">&quot;_ColorMask&quot;</span>, (<span class="built_in">int</span>)colorWriteMask);</span><br><span class="line">    newEnt.customMat.SetInt(<span class="string">&quot;_UseUIAlphaClip&quot;</span>, newEnt.useAlphaClip ? <span class="number">1</span> : <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (newEnt.useAlphaClip)</span><br><span class="line">        newEnt.customMat.EnableKeyword(<span class="string">&quot;UNITY_UI_ALPHACLIP&quot;</span>);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        newEnt.customMat.DisableKeyword(<span class="string">&quot;UNITY_UI_ALPHACLIP&quot;</span>);</span><br><span class="line"></span><br><span class="line">    m_List.Add(newEnt);</span><br><span class="line">    <span class="keyword">return</span> newEnt.customMat;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到<strong>Mask在IMaterialModifies.GetModifiedMaterial()接口里是对UI的原始材质进行复制后，对Stencil(模板缓存)进行修改实现的遮罩效果。</strong></p>
<p>结合首层Mask逻辑，我们来理一下遮罩原理：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// if we are at the first level...</span></span><br><span class="line"><span class="comment">// we want to destroy what is there</span></span><br><span class="line"><span class="keyword">if</span> (desiredStencilBit == <span class="number">1</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> maskMaterial = StencilMaterial.Add(baseMaterial, <span class="number">1</span>, StencilOp.Replace, CompareFunction.Always, m_ShowMaskGraphic ? ColorWriteMask.All : <span class="number">0</span>);</span><br><span class="line">    StencilMaterial.Remove(m_MaskMaterial);</span><br><span class="line">    m_MaskMaterial = maskMaterial;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> unmaskMaterial = StencilMaterial.Add(baseMaterial, <span class="number">1</span>, StencilOp.Zero, CompareFunction.Always, <span class="number">0</span>);</span><br><span class="line">    StencilMaterial.Remove(m_UnmaskMaterial);</span><br><span class="line">    m_UnmaskMaterial = unmaskMaterial;</span><br><span class="line">    graphic.canvasRenderer.popMaterialCount = <span class="number">1</span>;</span><br><span class="line">    graphic.canvasRenderer.SetPopMaterial(m_UnmaskMaterial, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> m_MaskMaterial;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果是第一层，stencilDepth值为0，目标模版缓存值(desiredStencilBit)为1。</p>
<ol>
<li><p>Unity Mask先添加了基于baseMaterial(原始配置的材质球)新裁剪材质球maskMaterial，将新材质球的<strong>Stencile(模版参考比较值)值改为1</strong>，将<strong>StencilOp的模板操作设置成Replace(模版缓存比较通过则替换成新的模板参考比较值)</strong>，<strong>CompareFunction(模版比较方式)设置成Always(模板测试总是通过)</strong>，根据是否显示Mask图形将<strong>ColorWriteMask(颜色写入FrameBuffer的Mask值)设置成255(所有颜色值都写入)或0(所有颜色值都不写入)</strong>，至于<strong>Stencile的ReadMask和WriteMask(第一层默认传255)</strong></p>
</li>
<li><p>通过第1步的新增裁剪材质球maskMaterial处理，当我们渲染Mask图形的时候，ColorWriteMask会决定将Mask图形颜色写入，反之不写入(这一步决定了mask图形是否显示)。</p>
</li>
<li><p>通过第1步的新材裁剪质球maskMaterial处理，因为模板比较是Always(总是通过)，结合模版参考值1和模板操作方式Replace，此时<strong>渲染完Mask图形后Stencil Ref值应该为1</strong></p>
<p><img src="/img/Unity/RenderOrder/AfterMaskGraphRenderStatus.PNG" alt="AfterMaskGraphRenderStatus"></p>
</li>
<li><p>接着创建<strong>unmaskMaterial材质球，并将其设置成遮罩Graphic.canvasRendererd的SetPopMaterial(个人理解是后续用于渲染完所有子对象后的额外材质球处理)用于取消Mask的相关设置，这一步发生在Mask图形所有子对象渲染完成时(从结果额外绘制了一个Mesh触发了unmaskMaterial逻辑来猜测的)</strong>，后续详细介绍</p>
</li>
<li><p>接下来渲染遮罩图形的子对象tickImg</p>
<p><img src="/img/Unity/RenderOrder/MaskChildGraphicStencilSetting.PNG" alt="MaskChildGraphicStencilSetting"></p>
<p><img src="/img/Unity/RenderOrder/RenderMaskChildGraphicStatus.PNG" alt="RenderMaskChildGraphicStatus"></p>
<p>可以看到遮罩图形的子对象tickImg的模板相关设置是<strong>Stencil Ref(模版参考比较值)为1</strong>，<strong>StencilOp的模板操作是Keep(保持原模板缓存值)，StencilComp的模板比较操作是Equal(模版值和模板参考值相同才通过模板测试)</strong>，<strong>Stencil Write Mask(模版缓存值写入时的Mask值)值为0(不允许写入模板缓存值)</strong>，<strong>Stencil Read Mask(模版缓存读取时的Mask值)值为1(只允许读取第一位的模板值)</strong>，<strong>ColorMask(颜色写入Mask值，8bit标识，15为所有颜色值写入)值为15</strong>。</p>
<p><strong>我这里使用的是Unity自带的UI&#x2F;Default Shader，这些模板值设置是发生在我给UI挂载对象时或者增删Mask组件时</strong>。</p>
<p><strong>因此子对象渲染时发现模版缓存值为1，且自身设置模板参考比较值也为1，同时模板比较方法是Equal，从而实现只有在Mask图形区域类模板缓存值为1的部分满足显示，从而只有Mask图形区域内的子对象显示部分通过了模板缓存测试，同时通过后因为StencilOp的模板操作是Keep所以模板缓存值不变依然是1</strong></p>
</li>
<li><p>子对象渲染完成后，我们接着看第4步里unmaskMaterial的后续逻辑，<strong>unmaskMaterial的Stencil Ref(模版参考比较值)为1，StencilOp的模板操作是Zero(设置模板值到0)，StencilComp的模板比较操作是Always(总是通过模板缓存测试)，ColorMask为0(不写入任何颜色)</strong></p>
<p><img src="/img/Unity/RenderOrder/UnmaskMaterialStatus.PNG" alt="UnmaskMaterialStatus"></p>
<p>因为maskMaterial和子对象渲染完成后，模版缓存里的值为1，此时<strong>unmaskMaterial的StencilComp是Always，StencilOp的模板操作是Zero</strong>，所以会<strong>将模板缓存里的值更新到0</strong>，同时因为ColorMask为0所以这一次unmaskMaterial的额外Mesh渲染绘制不会显示任何东西。</p>
</li>
</ol>
<p>Note:</p>
<ol start="2">
<li><strong>Mask实现遮罩效果底层原理是通过Stencil(模板缓存)</strong></li>
</ol>
<h4 id="Mask-粒子特效"><a href="#Mask-粒子特效" class="headerlink" title="Mask+粒子特效"></a>Mask+粒子特效</h4><h5 id="Mask-自带ParticleAdditive-Shader"><a href="#Mask-自带ParticleAdditive-Shader" class="headerlink" title="Mask+自带ParticleAdditive Shader"></a>Mask+自带ParticleAdditive Shader</h5><p>在了解完Mask组件的常规UI遮罩原理后，接下来让我们尝试下UI上放入粒子特效</p>
<p><img src="/img/Unity/RenderOrder/ParticleAdditiveInspector.PNG" alt="ParticleAdditiveInspector"></p>
<p>可以看到我将<strong>Unity自带的Particle Additive的Shader</strong>导入工程并创建了一个材质球使用到了粒子系统身上，同时<strong>为了确保粒子特效显示层级在UI上，还专门设置了Sorting Layer ID为Default，Order in Layer为101(因为MainUI节点上挂了Canvas且设置的Sorting Layer为Default，Order in Layer为100)</strong>。</p>
<p>让我们看下Unity自带的Particle Additive的Shader代码:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">Shader <span class="string">&quot;Custom/Legacy Shaders/Particles/Additive&quot;</span> &#123;</span><br><span class="line">Properties &#123;</span><br><span class="line">    _TintColor (<span class="string">&quot;Tint Color&quot;</span>, Color) = (<span class="number">0.5</span>,<span class="number">0.5</span>,<span class="number">0.5</span>,<span class="number">0.5</span>)</span><br><span class="line">    _MainTex (<span class="string">&quot;Particle Texture&quot;</span>, <span class="number">2</span>D) = <span class="string">&quot;white&quot;</span> &#123;&#125;</span><br><span class="line">    _InvFade (<span class="string">&quot;Soft Particles Factor&quot;</span>, Range(<span class="number">0.01</span>,<span class="number">3.0</span>)) = <span class="number">1.0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Category &#123;</span><br><span class="line">    Tags &#123; <span class="string">&quot;Queue&quot;</span>=<span class="string">&quot;Transparent&quot;</span> <span class="string">&quot;IgnoreProjector&quot;</span>=<span class="string">&quot;True&quot;</span> <span class="string">&quot;RenderType&quot;</span>=<span class="string">&quot;Transparent&quot;</span> <span class="string">&quot;PreviewType&quot;</span>=<span class="string">&quot;Plane&quot;</span> &#125;</span><br><span class="line">    Blend SrcAlpha One</span><br><span class="line">    ColorMask RGB</span><br><span class="line">    Cull Off Lighting Off ZWrite Off</span><br><span class="line"></span><br><span class="line">    SubShader &#123;</span><br><span class="line">        Pass &#123;</span><br><span class="line">            ******</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到默认的Particle Additive的Shader是没有带模板缓存相关的Shader代码支持的。渲染结果如下：</p>
<p><img src="/img/Unity/RenderOrder/ParticleAdditiveShowResult.PNG" alt="ParticleAdditiveShowResult"></p>
<p>不出意外Particle Additive的Shader的粒子特效超出了Mask显示范围。</p>
<h5 id="Mask-修改ParticleAdditive-Mask-Shader"><a href="#Mask-修改ParticleAdditive-Mask-Shader" class="headerlink" title="Mask+修改ParticleAdditive Mask Shader"></a>Mask+修改ParticleAdditive Mask Shader</h5><p>接下来我们尝试改造Particle Additive的Shader，复制一份改名Particle Additive Mask同时创建一个对应的材质球(ParticleAdditiveMaskMat)，赋值到particleSystem上。</p>
<p><img src="/img/Unity/RenderOrder/ParticleAdditiveMaskInspector.PNG" alt="ParticleAdditiveMaskInspector"></p>
<p>为了匹配Mask的模版缓存判定，我将<strong>Stencil ID设置成1(模版缓存参考比较值)，Stencil Comparison设置成3(Equal)，Stencil Operation设置成0(Keep)，ColorMask设置成15(所有颜色写入)，这些设置是为了在Mask下去比较模板缓存值1的才通过，从而实现超出Mask区域部分不通过不绘制</strong>。</p>
<p>让我们看看改造后的显示结果：</p>
<p><img src="/img/Unity/RenderOder/ParticleAdditiveMaskShowResult.PNG" alt="ParticleAdditiveMaskShowResult"></p>
<p>结果发现粒子特效啥都没显示，让我们看看FrameDebugger是怎么回事。</p>
<p><img src="/img/Unity/RenderOrder/ParticleAdditiveMaskFrameDebugger.PNG" alt="ParticleAdditiveMaskFrameDebugger"></p>
<p><strong>从FrameDebugger可以看到粒子特效的渲染和常规UI的渲染流程不一样，因为粒子特效是当做3D物体渲染的，所以他的渲染顺序不想UI子节点图形没有在Canvas的渲染流程里，而是Canvas渲染完成后才通过Draw Dynamic的方式绘制的。</strong></p>
<p>还记得我们前面说的<strong>Mask组件在绘制完成后通过unmaskMaterial将模板缓存里的值已经修改成0了吗？</strong></p>
<p><strong>这个模版缓存值0也就是粒子特效不显示的原因，因为粒子特效Particle Additive Mask我们设置的Stencil ID(模版参考比较值)为1，Stencil Comparion为3(Equal)，也就意味着粒子特效通不过模板缓存测试所以什么都不显示了。</strong></p>
<h5 id="仅使用自带UI-Default-Shader"><a href="#仅使用自带UI-Default-Shader" class="headerlink" title="仅使用自带UI Default Shader"></a>仅使用自带UI Default Shader</h5><p><strong>unmaskMaterial这个流程是Mask流程里自带的，不修改源码是无法修改的，所以目前看来想通过粒子特效支持模板缓存功能从而通过Mask遮罩显示的方案是行不通的。</strong></p>
<p><strong>既然我们已经知道模板缓存是Mask实现遮罩的核心原理，那么我们如果不使用Mask组件，直接导入自带的UI Default Shader，通过直接创建一个非Mask的UI Default材质，一个负责Mask的UI Default Mask材质和一个支持被UI Default Mask遮罩后显示的UI Default Masked材质来实现模版遮罩功。</strong></p>
<p><img src="/img/Unity/RenderOrder/UIDefaultMatInspector.PNG" alt="UIDefaultMatInspector"></p>
<p><img src="/img/Unity/RenderOder/UIDefaultMaskMatInspector.PNG" alt="UIDefaultMaskMatInspector"></p>
<p><img src="/img/Unity/RenderOrder/UIDefaultMaskedMatInspector.PNG" alt="UIDefaultMaskedMatInspector"></p>
<p><strong>可以看到三份材质球都是使用功能的UI Default Shader，但为了Mask不同情况下正确显示，分别设置了不同的Stencil ID，Stencil Comparison，Stencil Operation值。UIDefaultMat用于不需要管遮罩时，UIDefaultMaskMat用在当做遮罩(相当于Mask挂载的情况)时，UIDefaultMaskedMat用在在遮罩里需要被遮罩时。</strong></p>
<p><strong>为了方便查看层级显示和遮罩效果，我创建了一个红色的使用UI Default Mat的最底层图和一个黄色的使用UI Default Mat的最顶层图(同时添加了Canvas设置了order高于特效显示order)</strong></p>
<p>来看看图片和特效相关的层级:</p>
<p><img src="/img/Unity/RenderOrder/UIDefaultMaskSceneAndHierachy.PNG" alt="UIDefaultMaskSceneAndHierachy"></p>
<p>来看看运行时的效果:</p>
<p><img src="/img/Unity/RenderOrder/UIDefaultMaskGame.PNG" alt="UIDefaultMaskGame"></p>
<p>可以看到无论是普通背景和前景图还是被遮罩的图还是粒子特效，通过赋予对应的UI Default Shader的材质球成功实现了Mask遮罩效果。</p>
<p>让我们来看看Frame Debugger是什么情况：</p>
<p><img src="/img/Unity/RenderOrder/UIDefaultMaskFrameDebugger.PNG" alt="UIDefaultMaskFrameDebugger"></p>
<p><strong>可以看到带遮罩的相关图形显示在第一个Canvas.RenderSubBatch里，因为使用Mask组件，所以没有产生unmaskMaterial的流程，所以第一个Canvas.RenderSubBatch最后一个Draw Mesh是被遮罩的那个勾选图形，因为设置的是UI Default Masked Mat(Stencil ID为1，Stencil Comparison为3(Equal)，Stencil Operation为0(Keep))所以成功通过了模板缓存并遮罩显示。</strong></p>
<p>接着看看粒子特效显示是什么情况：</p>
<p><img src="/img/Unity/RenderOrder/UIDefaultMaskParticleSystemFrameDebugger.PNG" alt="UIDefaultMaskParticleSystemFrameDebugger"></p>
<p><strong>粒子特效的显示和被遮罩的勾选图形原理和参数一致，紧接着第一个Canvas.RenderSubBatch之后渲染，所以也成功遮罩显示了。</strong></p>
<p>接着看看defaultFrontImg前景图是什么情况：</p>
<p><img src="/img/Unity/RenderOrder/UIDefaultMaskSecondCanvasFrameDebugger.PNG" alt="UIDefaultMaskSecondCanvasFrameDebugger"></p>
<p><strong>可以看到因为我给defaultFrontImg添加了额外的Canvas并设置了比特效Order还高的Order，所以单独进行了一次Canvas.RenderSubBatch绘制，即第二个Canvas.RenderSubBatch绘制通过Stencil Ref值为0和Stencil Comparison为8(Always)成功将第二个Canvas渲染绘制的模板缓存值修改成0了。</strong></p>
<p><img src="/img/Unity/RenderOrder/UIDefaultMaskFrontImgFrameDebugger.PNG" alt="UIDefaultMaskFrontImgFrameDebugger"></p>
<p><strong>可以看到我给defaultFrontImg设置的UI Default Mat(Stencil ID为0，Stencile Comparison为8(Always)，Stencile Operation为0(Keep))完美符合了第二个Canvas.RenderSubBatch将模板值修改成0后的显示逻辑，所以成功绘制出来了。</strong></p>
<p>总结:</p>
<ol>
<li><strong>虽然通过制作不同的UI Default材质球可以实现遮罩不同的使用情况，但游戏开发过程中遮罩情况可能是动态变化，无法提前预知哪些是用于遮罩，哪些是在遮罩内，哪些是在遮罩外，所以这种方案虽然能实现遮罩效果但并没有实战使用价值。</strong></li>
</ol>
<h5 id="ParticleEffectForUGUI"><a href="#ParticleEffectForUGUI" class="headerlink" title="ParticleEffectForUGUI"></a>ParticleEffectForUGUI</h5><p>接下来让我们看看Github上最强特效和UI显示层级解决方案：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/mob-sakai/ParticleEffectForUGUI">ParticleEffectForUGUI</a></p>
<p>特点介绍：</p>
<ul>
<li><strong>Sortable:</strong> Sort particle effects and other UI elements by sibling index.</li>
<li><strong>Maskable:</strong> Supports <code>Mask</code> or <code>RectMask2D</code>.</li>
<li><strong>No extra components required:</strong> No need for an additional <code>Camera</code>, <code>RenderTexture</code>, or <code>Canvas</code>.</li>
<li><strong>Trail module support:</strong> Fully supports the Trail module.</li>
<li><strong>CanvasGroup alpha support:</strong> Integrates with <code>CanvasGroup</code> alpha.</li>
<li><strong>No allocations:</strong> Efficiently renders particles without allocations.</li>
<li><strong>Any canvas render mode support:</strong> Works with overlay, camera space, and world space.</li>
<li><strong>Any Render pipeline support:</strong> Compatible with Universal Render Pipeline (URP) and High Definition Render Pipeline (HDRP).</li>
<li>省略</li>
</ul>
<p>从上面介绍可以看到<strong>ParticleEffectForUGUI能将特效在UI排序显示，无需任何Camera，RenderTexture或者Canvas。支持CanvasGroup的Alpha，支持Canvas的各种Render Mode。兼容URP，HDRP等。</strong></p>
<h6 id="ParticleEffectForUGUI导入"><a href="#ParticleEffectForUGUI导入" class="headerlink" title="ParticleEffectForUGUI导入"></a>ParticleEffectForUGUI导入</h6><p>我们通过Package Manager选择Git地址(<strong>注意#后面的数字是版本号</strong>)导入:</p>
<figure class="highlight latex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/mob-sakai/ParticleEffectForUGUI.git<span class="params">#4</span>.11.4</span><br></pre></td></tr></table></figure>

<p>Note:</p>
<ol>
<li><strong>导入完成后如果想直接使用源码版本，可以直接从Package下拷贝到Asset目录下使用，然后删除Package Manager里的导入库即可。</strong></li>
</ol>
<h6 id="扩展粒子特效Shader支持Stencil和Clip"><a href="#扩展粒子特效Shader支持Stencil和Clip" class="headerlink" title="扩展粒子特效Shader支持Stencil和Clip"></a>扩展粒子特效Shader支持Stencil和Clip</h6><p>粒子特效的Shader要像UI Default Shader一样支持UI的Mask和Clip功能。</p>
<p>Particle Add UI Mask.Shader</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line">Shader <span class="string">&quot;Custom/Legacy Shaders/Particles/Additive UI Mask&quot;</span> &#123;</span><br><span class="line">Properties &#123;</span><br><span class="line"> 	******</span><br><span class="line"></span><br><span class="line">    <span class="comment">// #### required for Mask ####</span></span><br><span class="line">    _StencilComp (<span class="string">&quot;Stencil Comparison&quot;</span>, Float) = <span class="number">8</span></span><br><span class="line">    _Stencil (<span class="string">&quot;Stencil ID&quot;</span>, Float) = <span class="number">0</span></span><br><span class="line">    _StencilOp (<span class="string">&quot;Stencil Operation&quot;</span>, Float) = <span class="number">0</span></span><br><span class="line">    _StencilWriteMask (<span class="string">&quot;Stencil Write Mask&quot;</span>, Float) = <span class="number">255</span></span><br><span class="line">    _StencilReadMask (<span class="string">&quot;Stencil Read Mask&quot;</span>, Float) = <span class="number">255</span></span><br><span class="line"></span><br><span class="line">    _ColorMask (<span class="string">&quot;Color Mask&quot;</span>, Float) = <span class="number">15</span></span><br><span class="line"></span><br><span class="line">    [<span class="meta">Toggle(UNITY_UI_ALPHACLIP)</span>] _UseUIAlphaClip (<span class="string">&quot;Use Alpha Clip&quot;</span>, Float) = <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Category &#123;</span><br><span class="line">    Tags &#123; <span class="string">&quot;Queue&quot;</span>=<span class="string">&quot;Transparent&quot;</span> <span class="string">&quot;IgnoreProjector&quot;</span>=<span class="string">&quot;True&quot;</span> <span class="string">&quot;RenderType&quot;</span>=<span class="string">&quot;Transparent&quot;</span> <span class="string">&quot;PreviewType&quot;</span>=<span class="string">&quot;Plane&quot;</span> &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// #### required for Mask ####</span></span><br><span class="line">    Stencil</span><br><span class="line">    &#123;</span><br><span class="line">        Ref [_Stencil]</span><br><span class="line">        Comp [_StencilComp]</span><br><span class="line">        Pass [_StencilOp]</span><br><span class="line">        ReadMask [_StencilReadMask]</span><br><span class="line">        WriteMask [_StencilWriteMask]</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Blend SrcAlpha One</span><br><span class="line">    <span class="comment">// #### required for Mask ####</span></span><br><span class="line">    ColorMask [_ColorMask]</span><br><span class="line">    Cull Off Lighting Off ZWrite Off</span><br><span class="line"></span><br><span class="line">    SubShader &#123;</span><br><span class="line">        Pass &#123;</span><br><span class="line"></span><br><span class="line">            ******</span><br><span class="line"></span><br><span class="line">            <span class="meta">#include &quot;UnityCG.cginc&quot;</span></span><br><span class="line">            <span class="comment">// #### required for RectMask2D ####</span></span><br><span class="line">            <span class="meta">#include &quot;UnityUI.cginc&quot;</span></span><br><span class="line">            <span class="meta">#<span class="keyword">pragma</span> multi_compile __ UNITY_UI_CLIP_RECT</span></span><br><span class="line">            <span class="meta">#<span class="keyword">pragma</span> multi_compile __ UNITY_UI_ALPHACLIP</span></span><br><span class="line"></span><br><span class="line">            ******</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">struct</span> v2f &#123;</span><br><span class="line">				******</span><br><span class="line"></span><br><span class="line">                <span class="comment">// #### required for RectMask2D ####</span></span><br><span class="line">                float4 worldPosition : TEXCOORD1;</span><br><span class="line"></span><br><span class="line">                UNITY_FOG_COORDS(<span class="number">2</span>)</span><br><span class="line">                <span class="meta">#ifdef SOFTPARTICLES_ON</span></span><br><span class="line">                float4 projPos : TEXCOORD3;</span><br><span class="line">                <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">                UNITY_VERTEX_OUTPUT_STEREO</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            float4 _MainTex_ST;</span><br><span class="line">            <span class="comment">// #### required for RectMask2D ####</span></span><br><span class="line">            float4 _ClipRect;</span><br><span class="line"></span><br><span class="line">            <span class="function">v2f <span class="title">vert</span> (<span class="params">appdata_t v</span>)</span></span><br><span class="line">            &#123;</span><br><span class="line">                ******</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// #### required for RectMask2D ####</span></span><br><span class="line">                o.worldPosition = v.vertex;</span><br><span class="line"></span><br><span class="line">				******</span><br><span class="line">                    </span><br><span class="line">                <span class="keyword">return</span> o;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            UNITY_DECLARE_DEPTH_TEXTURE(_CameraDepthTexture);</span><br><span class="line">            <span class="built_in">float</span> _InvFade;</span><br><span class="line"></span><br><span class="line">            <span class="function">fixed4 <span class="title">frag</span> (<span class="params">v2f i</span>) : SV_Target</span></span><br><span class="line">            &#123;</span><br><span class="line">                ******</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// #### required for RectMask2D ####</span></span><br><span class="line">                <span class="meta">#ifdef UNITY_UI_CLIP_RECT</span></span><br><span class="line">                    col.a *= UnityGet2DClipping(i.worldPosition.xy, _ClipRect);</span><br><span class="line">                <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">                <span class="meta">#ifdef UNITY_UI_ALPHACLIP</span></span><br><span class="line">                    clip(col.a - <span class="number">0.001</span>);</span><br><span class="line">                <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">                col.rgb *= col.a;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> col;</span><br><span class="line">            &#125;</span><br><span class="line">            ENDCG</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​		<strong>核心是像UI Default Shader里加入了UNITY_UI_CLIP_RECT和UNITY_UI_ALPHACLIP以及Stencil模板相关的定义。</strong></p>
<p>Note:</p>
<ol>
<li><strong>注意定义v2f的worldPosition : TEXCOORD1时会占用TEXCOORD1，后续UNITY_FOG_COORDs(2)和projPos:TEXCOORD3都得顺势往后延</strong></li>
</ol>
<h6 id="制作粒子特效GameObject"><a href="#制作粒子特效GameObject" class="headerlink" title="制作粒子特效GameObject"></a>制作粒子特效GameObject</h6><p>第1种情况，从0制作粒子特效：</p>
<ol>
<li><p><strong>创建UIParticle GameObject</strong></p>
<p><img src="/img/Unity/RenderOrder/CreateEmptyUIParticleGameObject.PNG" alt="CreateEmptyUIParticleGameObject"></p>
</li>
<li><p>在UIParticle GameObject节点下只做粒子特效</p>
</li>
<li><p><strong>做完粒子特效后点击UIParticle面板上的Refresh按钮</strong></p>
<p><img src="/img/Unity/RenderOrder/UIParticleRefreshButton.PNG" alt="UIParticleRefreshButton"></p>
</li>
<li><p>保存UIParticle GameObject当做特效使用</p>
</li>
</ol>
<p>第二种情况，在已有的特效GameObject上制作粒子特效：</p>
<ol>
<li><p><strong>对已有粒子特效GameObject右键创建UIParticle</strong></p>
<p><img src="/img/Unity/RenderOrder/CreateUIParticleFromGameObject.PNG" alt="CreateUIParticleFromGameObject"></p>
</li>
<li><p>保存UIParticle GameObject当做特效使用</p>
</li>
</ol>
<p>Note:</p>
<ol>
<li><p><strong>通过ParticleEffectForUGUI制作的粒子特效我们不再需要手动调整Order，我们可以像调整UI节点一样放到对应位置即可</strong></p>
</li>
<li><p><strong>通过调整UIParticle上的Scale来控制粒子特效显示大小</strong></p>
</li>
<li><p><strong>要想UIParticle制作的特效支持Mask需要勾选UIParticle的Maskable</strong></p>
</li>
<li><p><strong>希望制作的粒子特效跟UI在不同分辨率下保持大小一致选择AutoScalingMode.Transform</strong></p>
</li>
</ol>
<h6 id="UIParticle遮罩"><a href="#UIParticle遮罩" class="headerlink" title="UIParticle遮罩"></a>UIParticle遮罩</h6><p><strong>Mask遮罩，就像常规Mask遮罩UI对象一样，将制作的UIParticle GameObject放到对应节点位置即可。</strong></p>
<p><img src="/img/Unity/RenderOrder/ParticleEffectForUGUIMaskInspector" alt="ParticleEffectForUGUIMaskInspector"></p>
<p><img src="/img/Unity/RenderOrder/ParticleEffectForUGUIMaskShowResult.PNG" alt="ParticleEffectForUGUIMaskShowResult"></p>
<p>我们结合Mask遮罩来看看UIParticle是如何实现粒子特效支持Mask显示的。</p>
<p>首先看看粒子特效在FrameDebugger里是如何绘制的：</p>
<p><img src="/img/Unity/RenderOrder/ParticleEffectForUGUIMaskFrameDebugger.PNG" alt="ParticleEffectForUGUIMaskFrameDebugger"></p>
<p><strong>可以看到粒子特效这一次没有在被当做3D对象单独绘制而是在Canvas.RenderSubBatch流程里绘制且绘制时机是在unmaskMaterial清除模板缓存值之前，我想这就就是为什么UIParticle绘制的粒子特效为什么能支持UI Mask和RectMask2D的原因。</strong></p>
<p>那么UIParticle是如何实现将UI粒子特效当做UI对象在Canvas里绘制的了？</p>
<p><strong>首先UIParticle是取消了ParticleSystem的Renderer组件激活(避免3D粒子特效的渲染)</strong></p>
<p><img src="/img/Unity/RenderOrder/ParticleEffectForUGUICancelPSRenderer.PNG" alt="ParticleEffectForUGUICancelPSRenderer"></p>
<p>然后我们来看看UIParticle.cs的代码定义:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Render maskable and sortable particle effect ,without Camera, RenderTexture or Canvas.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">Icon(<span class="string">&quot;Packages/com.coffee.ui-particle/Editor/UIParticleIcon.png&quot;</span>)</span>]</span><br><span class="line">[<span class="meta">ExecuteAlways</span>]</span><br><span class="line">[<span class="meta">RequireComponent(typeof(RectTransform))</span>]</span><br><span class="line">[<span class="meta">RequireComponent(typeof(CanvasRenderer))</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UIParticle</span> : <span class="title">MaskableGraphic</span>, <span class="title">ISerializationCallbackReceiver</span></span><br><span class="line">&#123;</span><br><span class="line">    ******</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> List&lt;UIParticleRenderer&gt; _renderers = <span class="keyword">new</span> List&lt;UIParticleRenderer&gt;();</span><br><span class="line">    <span class="keyword">private</span> Camera _bakeCamera;</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">UpdateMaterial</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Call to update the geometry of the Graphic onto the CanvasRenderer.</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">UpdateGeometry</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到UIParticle组件添加时强制添加了<strong>CanvasRenderer</strong>组件的，同时UIParticle继承了<strong>MaskGraphic</strong>。</p>
<p><strong>CanvasRenderer组件是UIParticle融入到Canvas渲染流程里的必要组件</strong></p>
<p><strong>MaskGraphic是UIParticle获取Canvas UI渲染能力和遮罩支持的关键</strong></p>
<p>UIParticle通过重写MaskGraphic.UpdateMaterial和MaskGraphic.UpdateGeometry方法避免任何渲染和材质相关的逻辑。UIParticle真正的渲染逻辑是通过**UIParticleRenderer(也继承至MaskableGraphic)**类完成的，也就是UIParticle._renders这个成员对象。</p>
<p><strong>核心渲染流程方法是UIParticle.UpdateRenderers()，UIParticle.UpdateRenderers()方法是在UIParticleUpdater.cs里通过注入Canvas.onAfterCanvasRebuild(在Canvas渲染前调用)流程调用的</strong></p>
<p><strong>UIParticle.UpdateRenderers()会先收集之前通过UIParticle面板Refresh按钮搜集到的所有粒子特效，创建相关UIParticleRenderer对象(这里就是UIParticle._renders构建的地方)</strong></p>
<p><strong>然后UIParticle通过GetBakeCamera()方法获取到当前绘制Canvas的UICamera，然后UICamera传递调用UIParticleRenderer.UpdateMesh(BakeCamera)方法</strong></p>
<p><strong>UIParticleRenderer.UpdateMesh()方法里，通过调用ParticleSystemRenderer.BakeMesh()方法传入指定摄像机，将通过该UICamera渲染的Mesh保存到CombineInstance类数据里</strong></p>
<p><strong>然后将所有烘焙得到的CombineInstance的Mesh数据合并到一个mesh里(workerMesh.CombineMeshes())</strong></p>
<p><strong>最后将烘焙的bakeMesh数据设置到UIParticleRenderer.canvasRenderer.SetMesh()的Mesh里，然后UIParticleRenderer通过canvasRenderer参与到Canvas的绘制流程里，从而实现了粒子特效转换成UI Mesh参与到Canvas绘制流程里的过程。</strong></p>
<p>那么UIParticleRenderer是如何实现支持UGUI的Mask和RectMask2D遮罩功能的了？</p>
<p><strong>UIParticleRenderer.GetModifiedMaterial()里调用了base.GetModifiedMaterial()，接下来让我们看看内部的代码实现:</strong></p>
<p>MaskableGraphic.cs</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> See IMaterialModifier.GetModifiedMaterial</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> Material <span class="title">GetModifiedMaterial</span>(<span class="params">Material baseMaterial</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> toUse = baseMaterial;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (m_ShouldRecalculateStencil)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> rootCanvas = MaskUtilities.FindRootSortOverrideCanvas(transform);</span><br><span class="line">        m_StencilValue = maskable ? MaskUtilities.GetStencilDepth(transform, rootCanvas) : <span class="number">0</span>;</span><br><span class="line">        m_ShouldRecalculateStencil = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// if we have a enabled Mask component then it will</span></span><br><span class="line">    <span class="comment">// generate the mask material. This is an optimisation</span></span><br><span class="line">    <span class="comment">// it adds some coupling between components though :(</span></span><br><span class="line">    Mask maskComponent = GetComponent&lt;Mask&gt;();</span><br><span class="line">    <span class="keyword">if</span> (m_StencilValue &gt; <span class="number">0</span> &amp;&amp; (maskComponent == <span class="literal">null</span> || !maskComponent.IsActive()))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> maskMat = StencilMaterial.Add(toUse, (<span class="number">1</span> &lt;&lt; m_StencilValue) - <span class="number">1</span>, StencilOp.Keep, CompareFunction.Equal, ColorWriteMask.All, (<span class="number">1</span> &lt;&lt; m_StencilValue) - <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">        StencilMaterial.Remove(m_MaskMaterial);</span><br><span class="line">        m_MaskMaterial = maskMat;</span><br><span class="line">        toUse = m_MaskMaterial;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> toUse;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，<strong>通过获取当前节点的最上层Canvas获取到最近的m_StencilValue值，然后通过判定是否有Mask组件决定是否要触发StencilMaterial的材质球效果(Stencil ID值为(1&lt;&lt; m_StencilValue) - 1)，StencilOp值为0(Keep)，StencilComparison值为3(Equal)，Stencil ReadMask值为(1 &lt;&lt; m_StencilValue) - 1)，Stencil WriteMask值为0)。也就是与模板Stencil缓存值相比一致就通过模板测试的maskMat。个人认为这也就是UIParticleRenderer支持Mask的原因。</strong></p>
<p>那么UIParticle又是如何实现RectMask2D的遮罩支持的了？</p>
<p>核心是RectMask2D会在RectMask2D.PerformClipping()里遍历访问MaskableGraphic，并调用MaskableGraphic.SetClipRect()，让我们来看看MaskableGraphic.SetClipRect()的代码：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> See IClippable.SetClipRect</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">SetClipRect</span>(<span class="params">Rect clipRect, <span class="built_in">bool</span> validRect</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (validRect)</span><br><span class="line">        canvasRenderer.EnableRectClipping(clipRect);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        canvasRenderer.DisableRectClipping();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>可以看到这里应该是通过canvasRenderer.EnableRectClipping()成功将Shader里的</strong>UNITY_UI_CLIP_RECT<strong>的Shader关键词激活了，后续应该是设置并传入了Shader里_ClipRect变量的裁剪区域值。</strong></p>
<p><strong>RectMask2D遮罩，就像常规RectMask2D遮罩UI对象一样，将制作的UIParticle GameObject放到对应节点位置即可。</strong></p>
<p><img src="/img/Unity/RenderOrder/ParticleEffectForUGUIRectMask2DInspector.PNG" alt="ParticleEffectForUGUIRectMask2DInspector"></p>
<p><img src="/img/Unity/RenderOrder/ParticleEffectForUGUIRectMask2DShowResult.PNG" alt="ParticleEffectForUGUIRectMask2DShowResult"></p>
<p>至此我们成功通关ParticleEffectForUGUI插件实现了特效在UI里的Mask和RectMask2D遮罩显示。</p>
<h6 id="UIParticle层级"><a href="#UIParticle层级" class="headerlink" title="UIParticle层级"></a>UIParticle层级</h6><p><strong>通过ParticleEffectForUGUI制作的特效，在处理UI层级问题时可以直接向处理UI节点一样，只要保证节点顺序就能保证显示层级。</strong></p>
<p><img src="/img/Unity/RenderOrder/ParticleEffectForUGUILayerInspector.PNG" alt="ParticleEffectForUGUILayerInspector"></p>
<p><img src="/img/Unity/RenderOrder/ParticleEffectForUGUILayerShowResult.PNG" alt="ParticleEffectForUGUILayerShowResult"></p>
<p><strong>可以看到我制作的白色粒子特效夹在UI中间显示，绿色粒子特效在最顶层显示正确显示了</strong></p>
<h3 id="RectMask2D组件"><a href="#RectMask2D组件" class="headerlink" title="RectMask2D组件"></a>RectMask2D组件</h3><p><strong><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_33060405/article/details/143782999?spm=1001.2101.3001.6650.2&utm_medium=distribute.pc_relevant.none-task-blog-2~default~baidujs_baidulandingword~Ctr-2-143782999-blog-135170296.235%5Ev43%5Epc_blog_bottom_relevance_base5&depth_1-utm_source=distribute.pc_relevant.none-task-blog-2~default~baidujs_baidulandingword~Ctr-2-143782999-blog-135170296.235%5Ev43%5Epc_blog_bottom_relevance_base5&utm_relevant_index=4">RectMask2D是通过CanvasRenderer的裁剪矩形（ClipRect）实现，底层是CPU裁剪顶点。</a></strong></p>
<p><strong><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_33060405/article/details/143782999?spm=1001.2101.3001.6650.2&utm_medium=distribute.pc_relevant.none-task-blog-2~default~baidujs_baidulandingword~Ctr-2-143782999-blog-135170296.235%5Ev43%5Epc_blog_bottom_relevance_base5&depth_1-utm_source=distribute.pc_relevant.none-task-blog-2~default~baidujs_baidulandingword~Ctr-2-143782999-blog-135170296.235%5Ev43%5Epc_blog_bottom_relevance_base5&utm_relevant_index=4">标准ParticleSystem渲染在Camera空间，走的是Renderer，不是UGUI的CanvasRenderer。</a></strong></p>
<p>从上面的介绍可以看到正常流程粒子特效没走CanvasRenderer，是无法被RectMask2D裁剪的，如果想支持粒子被RectMask2D裁剪，有两种方案：</p>
<ol>
<li><strong>将粒子特效重定向到CanvasRenderer里去渲染</strong></li>
<li><strong>手动写代码将RectMask2D的裁剪区域传递到粒子特效Shader里去，然后写Shader代码去判定裁剪显示</strong></li>
</ol>
<h4 id="将粒子特效重定向到CanvasRenderer里去渲染"><a href="#将粒子特效重定向到CanvasRenderer里去渲染" class="headerlink" title="将粒子特效重定向到CanvasRenderer里去渲染"></a>将粒子特效重定向到CanvasRenderer里去渲染</h4><p>此方案直接学习<a target="_blank" rel="noopener" href="https://github.com/mob-sakai/ParticleEffectForUGUI">ParticleEffectForUGUI</a>组件，参考前面的ParticleEffectForUGUI学习</p>
<h4 id="手动传递RectMask2D裁剪区域到粒子Shader"><a href="#手动传递RectMask2D裁剪区域到粒子Shader" class="headerlink" title="手动传递RectMask2D裁剪区域到粒子Shader"></a>手动传递RectMask2D裁剪区域到粒子Shader</h4><p>第二个方案参考:</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_41995872/article/details/103905945">Rect Mask2D遮住特效</a></p>
<p>Particle Add Mask.shader</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line">Shader <span class="string">&quot;Custom/Legacy Shaders/Particles/Additive Mask&quot;</span> &#123;</span><br><span class="line">Properties &#123;</span><br><span class="line">    ******</span><br><span class="line"></span><br><span class="line">    <span class="comment">// #### required for RectMask2D ####</span></span><br><span class="line">    _ClipRect (<span class="string">&quot;ClipRect&quot;</span>, Vector) = (<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>)</span><br><span class="line">    _UNITY_UI_CLIP_RECT(<span class="string">&quot;UNITY_UI_CLIP_RECT&quot;</span>, <span class="built_in">float</span>) = <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Category &#123;</span><br><span class="line">    ******</span><br><span class="line"></span><br><span class="line">    SubShader &#123;</span><br><span class="line">        Pass &#123;</span><br><span class="line"></span><br><span class="line">            ******</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// #### required for RectMask2D ####</span></span><br><span class="line">            <span class="meta">#include &quot;UnityUI.cginc&quot;</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// #### required for RectMask2D ####</span></span><br><span class="line">            float4 _ClipRect;</span><br><span class="line">            <span class="built_in">float</span> _UNITY_UI_CLIP_RECT;</span><br><span class="line"></span><br><span class="line">            sampler2D _MainTex;</span><br><span class="line">            fixed4 _TintColor;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">struct</span> appdata_t &#123;</span><br><span class="line">                float4 vertex : POSITION;</span><br><span class="line">                fixed4 color : COLOR;</span><br><span class="line">                float2 texcoord : TEXCOORD0;</span><br><span class="line">                UNITY_VERTEX_INPUT_INSTANCE_ID</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">struct</span> v2f &#123;</span><br><span class="line">                ******</span><br><span class="line"></span><br><span class="line">                <span class="comment">// #### required for RectMask2D ####</span></span><br><span class="line">                float4 worldPosition : TEXCOORD1;</span><br><span class="line"></span><br><span class="line">                UNITY_FOG_COORDS(<span class="number">2</span>)</span><br><span class="line">                <span class="meta">#ifdef SOFTPARTICLES_ON</span></span><br><span class="line">                float4 projPos : TEXCOORD3;</span><br><span class="line">                <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">                UNITY_VERTEX_OUTPUT_STEREO</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            float4 _MainTex_ST;</span><br><span class="line"></span><br><span class="line">            <span class="function">v2f <span class="title">vert</span> (<span class="params">appdata_t v</span>)</span></span><br><span class="line">            &#123;</span><br><span class="line">                ******</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// #### required for RectMask2D ####</span></span><br><span class="line">                o.worldPosition = mul(unity_ObjectToWorld, v.vertex);</span><br><span class="line"></span><br><span class="line">                <span class="meta">#ifdef SOFTPARTICLES_ON</span></span><br><span class="line">                o.projPos = ComputeScreenPos (o.vertex);</span><br><span class="line">                COMPUTE_EYEDEPTH(o.projPos.z);</span><br><span class="line">                <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">                o.color = v.color;</span><br><span class="line">                o.texcoord = TRANSFORM_TEX(v.texcoord,_MainTex);</span><br><span class="line">                UNITY_TRANSFER_FOG(o,o.vertex);</span><br><span class="line">                <span class="keyword">return</span> o;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            UNITY_DECLARE_DEPTH_TEXTURE(_CameraDepthTexture);</span><br><span class="line">            <span class="built_in">float</span> _InvFade;</span><br><span class="line"></span><br><span class="line">            <span class="function">fixed4 <span class="title">frag</span> (<span class="params">v2f i</span>) : SV_Target</span></span><br><span class="line">            &#123;</span><br><span class="line">                ******</span><br><span class="line"></span><br><span class="line">                <span class="comment">// #### required for RectMask2D ####</span></span><br><span class="line">                <span class="comment">//等效于 if(_UNITY_UI_CLIP_RECT == 1) col.a *= UnityGet2DClipping(i.worldPosition.xy, _ClipRect);</span></span><br><span class="line">                col.a *= pow(UnityGet2DClipping(i.worldPosition.xy, _ClipRect) + <span class="number">1</span>, _UNITY_UI_CLIP_RECT) - _UNITY_UI_CLIP_RECT;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> col;</span><br><span class="line">            &#125;</span><br><span class="line">            ENDCG</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Note:</p>
<ol>
<li><strong>注意定义v2f的worldPosition : TEXCOORD1时会占用TEXCOORD1，后续UNITY_FOG_COORDs(2)和projPos:TEXCOORD3都得顺势往后延</strong></li>
<li><strong>因为粒子特效默认不是在UI的CanvasRenderer模式下渲染的，所以__ UNITY_UI_CLIP_RECT和__ UNITY_UI_ALPHACLIP宏默认是不是起作用的</strong></li>
</ol>
<p>ParticleClip.cs</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> ParticleClip.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 用于粒子系统遮罩裁剪</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ParticleClip</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> RectMask2D裁剪区域</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;RectMask2D裁剪区域&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> Vector4 ClipRect;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 子Renderer组件列表</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> Renderer[] mChildRenderers;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Start</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> mask = GetComponentInParent&lt;UnityEngine.UI.RectMask2D&gt;();</span><br><span class="line">        <span class="keyword">if</span> (mask == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mChildRenderers = GetComponentsInChildren&lt;Renderer&gt;();</span><br><span class="line">        <span class="keyword">if</span>(mChildRenderers == <span class="literal">null</span> || mChildRenderers.Length == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Vector3[] vector3s = <span class="keyword">new</span> Vector3[<span class="number">4</span>];</span><br><span class="line">        mask.rectTransform.GetWorldCorners(vector3s);</span><br><span class="line">        ClipRect = <span class="keyword">new</span> Vector4(vector3s[<span class="number">0</span>].x, vector3s[<span class="number">0</span>].y, vector3s[<span class="number">2</span>].x, vector3s[<span class="number">2</span>].y);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> renderer <span class="keyword">in</span> mChildRenderers)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> rendererMaterial = renderer.material;</span><br><span class="line">            <span class="keyword">if</span>(rendererMaterial == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(rendererMaterial.HasVector(<span class="string">&quot;_ClipRect&quot;</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                rendererMaterial.SetVector(<span class="string">&quot;_ClipRect&quot;</span>, ClipRect);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(rendererMaterial.HasFloat(<span class="string">&quot;_UNITY_UI_CLIP_RECT&quot;</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                rendererMaterial.SetFloat(<span class="string">&quot;_UNITY_UI_CLIP_RECT&quot;</span>, <span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/img/Unity/RenderOrder/RectMask2DAndParticleClipInspector.PNG" alt="RectMask2DAndParticleClipInspector"></p>
<p><img src="/img/Unity/RenderOrder/ParticleClipAdditiveMaskShaderInspector.PNG" alt="ParticleClipAdditiveMaskShaderInspector"></p>
<p>可以看到通过ParticleClip.cs脚本，我成功将RectMask2D的裁剪区域数据和是否启用UNITY_UI_CLIP_RECT的数据传递到了Particle Add Mask.shader，让我们看看最终效果：</p>
<p><img src="/img/Unity/RenderOrder/RectMask2DAndParticleClipShowResult.PNG" alt="RectMask2DAndParticleClipShowResult"></p>
<p><strong>可以看到通过传递自定义RectMask2D裁剪区域以及粒子特效Shader支持裁剪区域显示判定，我们成功实现了支持RectMask2D的粒子特效遮罩显示</strong></p>
<p>总结:</p>
<ol>
<li><strong>此方案虽然能实现粒子特效的RectMask2D的遮罩效果，但节点挂载情况无时无刻都在变化，此方案不适合放到实战里去运用，只做为学习理解RectMask2D的裁剪原理</strong></li>
</ol>
<h1 id="3D和2D混合显示及决方案"><a href="#3D和2D混合显示及决方案" class="headerlink" title="3D和2D混合显示及决方案"></a>3D和2D混合显示及决方案</h1><p>有了前面的渲染顺序基础知识以及Mask相关知识，现在让我们再来看看游戏开发过程中遇到的3D物体和2D UI需要混合显示的问题该如何解决了？</p>
<p>通过前面的学习，特效和UI混合显示已经有了很好的方案:</p>
<p><a target="_blank" rel="noopener" href="https://github.com/mob-sakai/ParticleEffectForUGUI">ParticleEffectForUGUI</a></p>
<p>但ParticleEffectForUGUI并不支持模型的显示。</p>
<p>结合前面渲染顺序的学习，目前个人想到两种方案:</p>
<ol>
<li><strong>Extra 3D Model Camera</strong></li>
<li><strong>Extra Camera+Render Texture</strong></li>
</ol>
<p>Note:</p>
<ol>
<li><strong>3D在UI混合显示需要在Transparent Renderer Queue</strong></li>
</ol>
<h2 id="Extra-3D-Model-Camera"><a href="#Extra-3D-Model-Camera" class="headerlink" title="Extra 3D Model Camera"></a>Extra 3D Model Camera</h2><p><strong>额外3D模型摄像机照射模型，然后通过预设3D场景摄像机，UI摄像机，3D模型摄像机的Depth值来排序显示。</strong></p>
<p>好处:</p>
<ol>
<li><strong>3D模型只需要计算2D映射到3D摄像机的坐标位置显示即可，然后再处理一下不同分辨率的模型大小动态计算解决分辨率显示大小不同意问题即可</strong></li>
</ol>
<p>坏处：</p>
<ol>
<li><strong>3D模型摄像机只能固定在UI摄像机上或者下显示，如果在UI摄像机下方还会被背景图遮挡，所以理论上3D模型摄像机只能设置在UI摄像机上方显示(会导致UI没法盖住3D模型)</strong></li>
<li><strong>跨UI显示时，老的3D模型需要额外处理，不然会穿透显示</strong></li>
</ol>
<p>坏处1这个问题目前没有解决方案。</p>
<p>针对坏处2的解决方案如下：</p>
<p><strong>通过编写一个UIModelManager来统一管理UI 3D模型的创建和显示管理，将3D模型的显示和UI窗口绑定关联，在打开新UI时，只要绑定的UI不在最顶层，3D模型就统一隐藏不显示(比如把对应3D摄像机直接隐藏)，反之显示</strong></p>
<p><strong>实战TODO</strong></p>
<h2 id="3D-Camera-Render-Texture"><a href="#3D-Camera-Render-Texture" class="headerlink" title="3D Camera + Render Texture"></a>3D Camera + Render Texture</h2><p><strong>此方案思路是将3D摄像机单独照射后渲染到Render Texture上，然后通过UI上显示Render Texture的内容来实现模型在UI上的显示。</strong></p>
<p>好处：</p>
<ol>
<li><strong>3D模型显示的层级问题很好解决，可以像UI一般夹层显示，不用担心任何夹层和跨UI打开问题</strong></li>
</ol>
<p>坏处：</p>
<ol>
<li><strong>Camera+Render Texture会需要额外的纹理贴图开销，其次显示效果经过额外Shader处理不如直接照射效果好</strong></li>
</ol>
<p>这个以前实现过就不再实战了。</p>
<h1 id="学习总结"><a href="#学习总结" class="headerlink" title="学习总结"></a>学习总结</h1><p>渲染顺序优先级：</p>
<p>大的优先级如下：</p>
<p><strong>Camera.depth &gt; Material type((RenderQueue不透明 &gt; RenderQueue透明) ) &gt; SortingLayer&gt; SortingOrder &gt; RenderQueue</strong></p>
<p>其他规则：</p>
<p><strong>如果开启了ZTest和ZWrite，可不管物件绘制順序 (rendering order)，使得里摄像机越近的物件，永远都绘制在其他离摄像机越远的物件之前 (<code>ZTest LEqual</code>)。</strong></p>
<p><strong>同为不透明物体或透明物体时，Sorting Layer &gt; RenderQueue</strong></p>
<h1 id="Github"><a href="#Github" class="headerlink" title="Github"></a>Github</h1><p><a target="_blank" rel="noopener" href="https://github.com/mob-sakai/ParticleEffectForUGUI">ParticleEffectForUGUI</a></p>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a target="_blank" rel="noopener" href="https://dev.twsiyuan.com/2018/05/unity-rendering-order.html">Unity rendering order 整理筆記</a></p>
<p><a target="_blank" rel="noopener" href="https://qxsoftware.github.io/Unity-Rendering-Order.html">Unity 渲染顺序详解</a></p>
<p><a target="_blank" rel="noopener" href="https://www.bzetu.com/207/.html">Unity渲染顺序(Queue,ZWrite,ZTest)</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/lyh916/article/details/45317571">[UnityShader]渲染队列、ZWrite和ZTest</a></p>
<p><a target="_blank" rel="noopener" href="https://medium.com/ericzhan-publication/shader%E7%AD%86%E8%A8%98-%E9%80%8F%E6%98%8E%E7%89%A9%E9%AB%94-z-test-z-write-z-buffer-alpha-blending-692c60d9b605">[Shader筆記]透明物體(Z-Test、Z-Write、Z-Buffer、Alpha Blending)</a></p>
<p><a target="_blank" rel="noopener" href="https://indienova.com/indie-game-development/stencil-buffer-and-stencil-test/">走进 Stencil Buffer 系列 0 : 模板缓冲和模板测试是什么?</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/592341267">模板测试（Stencil Test）基本概念</a></p>
<p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/f79f0da90103">ShaderLab: Stencil Buffer 的理解和应用</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.51cto.com/u_14402/10670234">Unity 粒子特效在模型前面显示 unity ui粒子特效</a></p>
<p><a target="_blank" rel="noopener" href="https://duanyiliang.com/2020/11/05/unity_particlesystem_mask/">UI上的特效的裁剪问题</a></p>
  
	</div>
		<footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Rendering/">Rendering</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Rendering/">Rendering</a>
  </div>

</div>



	<div class="article-share" id="share">
	
	  <div data-url="http://tonytang1990.github.io/2026/01/29/3D%E5%92%8CUI%E6%B7%B7%E5%90%88%E6%98%BE%E7%A4%BA(UGUI)/" data-title="3D和UI混合显示(UGUI) | 走停人生路" data-tsina="" class="share clearfix">
	  </div>
	
	</div>


</footer>

   	       
	</article>
	
<nav class="article-nav clearfix">
 

<div class="next">
<a href="/2026/01/12/Copilot/"  title="Copilot">
 <strong>下一篇：</strong><br/> 
 <span>Copilot
</span>
</a>
</div>

</nav>

	



</div>  
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">文章目录</strong>
 
 <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Introduction"><span class="toc-number">1.</span> <span class="toc-text">Introduction</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%B8%B2%E6%9F%93%E9%A1%BA%E5%BA%8F%E7%9B%B8%E5%85%B3%E6%A6%82%E5%BF%B5"><span class="toc-number">2.</span> <span class="toc-text">渲染顺序相关概念</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Camera"><span class="toc-number">2.1.</span> <span class="toc-text">Camera</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#OpaqueSortMode"><span class="toc-number">2.1.1.</span> <span class="toc-text">OpaqueSortMode</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#TransparencySortMode"><span class="toc-number">2.1.2.</span> <span class="toc-text">TransparencySortMode</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Depth"><span class="toc-number">2.1.3.</span> <span class="toc-text">Depth</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#RenderQueue"><span class="toc-number">2.2.</span> <span class="toc-text">RenderQueue</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SortingLayer"><span class="toc-number">2.3.</span> <span class="toc-text">SortingLayer</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SortingOrder"><span class="toc-number">2.4.</span> <span class="toc-text">SortingOrder</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ZTest-ZWrite"><span class="toc-number">2.5.</span> <span class="toc-text">ZTest &amp; ZWrite</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ZWrite-%E6%B7%B1%E5%BA%A6%E5%86%99%E5%85%A5"><span class="toc-number">2.5.1.</span> <span class="toc-text">ZWrite(深度写入)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ZTest-%E6%B7%B1%E5%BA%A6%E6%B5%8B%E8%AF%95"><span class="toc-number">2.5.2.</span> <span class="toc-text">ZTest(深度测试)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Alpha-Blend-%E9%80%8F%E6%98%8E%E5%BA%A6%E6%B7%B7%E5%90%88"><span class="toc-number">2.5.3.</span> <span class="toc-text">Alpha Blend(透明度混合)</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%9E%E6%88%98"><span class="toc-number">3.</span> <span class="toc-text">实战</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Inspecotr%E6%89%A9%E5%B1%95"><span class="toc-number">3.1.</span> <span class="toc-text">Inspecotr扩展</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Camera-Inspector%E6%89%A9%E5%B1%95"><span class="toc-number">3.1.1.</span> <span class="toc-text">Camera Inspector扩展</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MeshRenderer-Inspector%E6%89%A9%E5%B1%95"><span class="toc-number">3.1.2.</span> <span class="toc-text">MeshRenderer Inspector扩展</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SpriteRenderer-Inspector%E6%89%A9%E5%B1%95"><span class="toc-number">3.1.3.</span> <span class="toc-text">SpriteRenderer Inspector扩展</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SkinnedMeshRenderer-Inspector%E6%89%A9%E5%B1%95"><span class="toc-number">3.1.4.</span> <span class="toc-text">SkinnedMeshRenderer Inspector扩展</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Camera-Depth"><span class="toc-number">3.2.</span> <span class="toc-text">Camera Depth</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ZWrite-ZTest-VS-RenderQueue"><span class="toc-number">3.3.</span> <span class="toc-text">(ZWrite &amp; ZTest) VS RenderQueue</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Sorting-Layer-VS-RenderQueue"><span class="toc-number">3.4.</span> <span class="toc-text">Sorting Layer VS RenderQueue</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Sorting-Order-VS-RenderQueue"><span class="toc-number">3.5.</span> <span class="toc-text">Sorting Order VS RenderQueue</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%93%E8%AE%BA"><span class="toc-number">3.6.</span> <span class="toc-text">结论</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Mask"><span class="toc-number">3.7.</span> <span class="toc-text">Mask</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Mask%E7%BB%84%E4%BB%B6"><span class="toc-number">3.7.1.</span> <span class="toc-text">Mask组件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Stencil-Buffer"><span class="toc-number">3.7.1.1.</span> <span class="toc-text">Stencil Buffer</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Mask-UI%E7%BB%84%E4%BB%B6"><span class="toc-number">3.7.1.2.</span> <span class="toc-text">Mask+UI组件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Mask-%E7%B2%92%E5%AD%90%E7%89%B9%E6%95%88"><span class="toc-number">3.7.1.3.</span> <span class="toc-text">Mask+粒子特效</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Mask-%E8%87%AA%E5%B8%A6ParticleAdditive-Shader"><span class="toc-number">3.7.1.3.1.</span> <span class="toc-text">Mask+自带ParticleAdditive Shader</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Mask-%E4%BF%AE%E6%94%B9ParticleAdditive-Mask-Shader"><span class="toc-number">3.7.1.3.2.</span> <span class="toc-text">Mask+修改ParticleAdditive Mask Shader</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BB%85%E4%BD%BF%E7%94%A8%E8%87%AA%E5%B8%A6UI-Default-Shader"><span class="toc-number">3.7.1.3.3.</span> <span class="toc-text">仅使用自带UI Default Shader</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#ParticleEffectForUGUI"><span class="toc-number">3.7.1.3.4.</span> <span class="toc-text">ParticleEffectForUGUI</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#ParticleEffectForUGUI%E5%AF%BC%E5%85%A5"><span class="toc-number">3.7.1.3.4.1.</span> <span class="toc-text">ParticleEffectForUGUI导入</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%89%A9%E5%B1%95%E7%B2%92%E5%AD%90%E7%89%B9%E6%95%88Shader%E6%94%AF%E6%8C%81Stencil%E5%92%8CClip"><span class="toc-number">3.7.1.3.4.2.</span> <span class="toc-text">扩展粒子特效Shader支持Stencil和Clip</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%88%B6%E4%BD%9C%E7%B2%92%E5%AD%90%E7%89%B9%E6%95%88GameObject"><span class="toc-number">3.7.1.3.4.3.</span> <span class="toc-text">制作粒子特效GameObject</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#UIParticle%E9%81%AE%E7%BD%A9"><span class="toc-number">3.7.1.3.4.4.</span> <span class="toc-text">UIParticle遮罩</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#UIParticle%E5%B1%82%E7%BA%A7"><span class="toc-number">3.7.1.3.4.5.</span> <span class="toc-text">UIParticle层级</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RectMask2D%E7%BB%84%E4%BB%B6"><span class="toc-number">3.7.2.</span> <span class="toc-text">RectMask2D组件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B0%86%E7%B2%92%E5%AD%90%E7%89%B9%E6%95%88%E9%87%8D%E5%AE%9A%E5%90%91%E5%88%B0CanvasRenderer%E9%87%8C%E5%8E%BB%E6%B8%B2%E6%9F%93"><span class="toc-number">3.7.2.1.</span> <span class="toc-text">将粒子特效重定向到CanvasRenderer里去渲染</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%8B%E5%8A%A8%E4%BC%A0%E9%80%92RectMask2D%E8%A3%81%E5%89%AA%E5%8C%BA%E5%9F%9F%E5%88%B0%E7%B2%92%E5%AD%90Shader"><span class="toc-number">3.7.2.2.</span> <span class="toc-text">手动传递RectMask2D裁剪区域到粒子Shader</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3D%E5%92%8C2D%E6%B7%B7%E5%90%88%E6%98%BE%E7%A4%BA%E5%8F%8A%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-number">4.</span> <span class="toc-text">3D和2D混合显示及决方案</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Extra-3D-Model-Camera"><span class="toc-number">4.1.</span> <span class="toc-text">Extra 3D Model Camera</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3D-Camera-Render-Texture"><span class="toc-number">4.2.</span> <span class="toc-text">3D Camera + Render Texture</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93"><span class="toc-number">5.</span> <span class="toc-text">学习总结</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Github"><span class="toc-number">6.</span> <span class="toc-text">Github</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Reference"><span class="toc-number">7.</span> <span class="toc-text">Reference</span></a></li></ol>
 
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  


  
<div class="categorieslist">
	<p class="asidetitle">分类</p>
		<ul>
		
		  
			<li><a href="/categories/AI/" title="AI">AI<sup>5</sup></a></li>
		  
		
		  
			<li><a href="/categories/Algorithm/" title="Algorithm">Algorithm<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/Art/" title="Art">Art<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Automation/" title="Automation">Automation<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Collision/" title="Collision">Collision<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Database/" title="Database">Database<sup>3</sup></a></li>
		  
		
		  
			<li><a href="/categories/Editor/" title="Editor">Editor<sup>5</sup></a></li>
		  
		
		  
			<li><a href="/categories/Excel/" title="Excel">Excel<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Game/" title="Game">Game<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/HotUpdate/" title="HotUpdate">HotUpdate<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Lua/" title="Lua">Lua<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Math/" title="Math">Math<sup>3</sup></a></li>
		  
		
		  
			<li><a href="/categories/Native/" title="Native">Native<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/Network/" title="Network">Network<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Optimization/" title="Optimization">Optimization<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Other/" title="Other">Other<sup>5</sup></a></li>
		  
		
		  
			<li><a href="/categories/Plugin/" title="Plugin">Plugin<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/Programming/" title="Programming">Programming<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/Programming-Language/" title="Programming Language">Programming Language<sup>4</sup></a></li>
		  
		
		  
			<li><a href="/categories/Rendering/" title="Rendering">Rendering<sup>5</sup></a></li>
		  
		
		  
			<li><a href="/categories/Resource/" title="Resource">Resource<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/Unity/" title="Unity">Unity<sup>7</sup></a></li>
		  
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">标签</p>
		<ul class="clearfix">
		
			
				<li><a href="/tags/Unity/" title="Unity">Unity<sup>8</sup></a></li>
			
		
			
				<li><a href="/tags/AI/" title="AI">AI<sup>5</sup></a></li>
			
		
			
				<li><a href="/tags/Editor/" title="Editor">Editor<sup>5</sup></a></li>
			
		
			
				<li><a href="/tags/Other/" title="Other">Other<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/Math/" title="Math">Math<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/Resource/" title="Resource">Resource<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/OpenGL/" title="OpenGL">OpenGL<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/Rendering/" title="Rendering">Rendering<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/Programming/" title="Programming">Programming<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/Art/" title="Art">Art<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Android/" title="Android">Android<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/UI/" title="UI">UI<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/C/" title="C#">C#<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Python/" title="Python">Python<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Database/" title="Database">Database<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Shader/" title="Shader">Shader<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/SubmlineText3/" title="SubmlineText3">SubmlineText3<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Native/" title="Native">Native<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Prefab/" title="Prefab">Prefab<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Plugin/" title="Plugin">Plugin<sup>1</sup></a></li>
			
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">友情链接</p>
    <ul>
        
          <li>
            
            	<a href="https://coderq.com" target="_blank" title="一个面向程序员交流分享的新一代社区">码农圈</a>
            
          </li>
        
          <li>
            
            	<a href="http://wuchong.me" target="_blank" title="Jark&#39;s Blog">Jark&#39;s Blog</a>
            
          </li>
        
    </ul>
</div>

  


  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS 订阅</a>
</div>

  <div class="weiboshow">
  <p class="asidetitle">新浪微博</p>
    <iframe width="100%" height="119" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=119&fansRow=2&ptype=1&speed=0&skin=9&isTitle=1&noborder=1&isWeibo=0&isFans=0&uid=&verifier=b3593ceb&dpc=1"></iframe>
</div>


</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> Hello ,I&#39;m Larry Page in Google. <br/>
			This is my blog,believe it or not.</p>
	</section>
	 
	<div class="social-font" class="clearfix">
		
		<a href="http://weibo.com/2176287895" target="_blank" class="icon-weibo" title="微博"></a>
		
		
		
		
		
		
		
		
		
		
	</div>
			
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Jacman">Jacman</a> © 2026 
		
		<a href="/about" target="_blank" title="Tony Tang">Tony Tang</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery.qrcode-0.12.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  c.click(function(){
    ta.css('display', 'block').addClass('fadeIn');
  });
  o.click(function(){
    ta.css('display', 'none');
  });
  $(window).scroll(function(){
    ta.css("top",Math.max(140,320-$(this).scrollTop()));
  });
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina'),
      description = $this.attr('description');
  var html = [
  '<div class="hoverqrcode clearfix"></div>',
  '<a class="overlay" id="qrcode"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="微信"></a>',
  '<a href="http://widget.renren.com/dialog/share?resourceUrl=' + encodedUrl + '&srcUrl=' + encodedUrl + '&title=' + title +'" class="article-share-renren" target="_blank" title="人人"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="微博"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);

  $('.hoverqrcode').hide();

  var myWidth = 0;
  function updatehoverqrcode(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
    var qrsize = myWidth > 1024 ? 200:100;
    var options = {render: 'image', size: qrsize, fill: '#2ca6cb', text: url, radius: 0.5, quiet: 1};
    var p = $('.article-share-qrcode').position();
    $('.hoverqrcode').empty().css('width', qrsize).css('height', qrsize)
                          .css('left', p.left-qrsize/2+20).css('top', p.top-qrsize-10)
                          .qrcode(options);
  };
  $(window).resize(function(){
    $('.hoverqrcode').hide();
  });
  $('.article-share-qrcode').click(function(){
    updatehoverqrcode();
    $('.hoverqrcode').toggle();
  });
  $('.article-share-qrcode').hover(function(){}, function(){
      $('.hoverqrcode').hide();
  });
});   
</script>











<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->



<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?e6d1f421bbc9962127a50488f9ed37d1";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>



<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="返回顶部"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
</html>
