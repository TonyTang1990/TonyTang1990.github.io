
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  
    <title>走停人生路</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="Tony Tang">
    

    
    <meta property="og:type" content="website">
<meta property="og:title" content="走停人生路">
<meta property="og:url" content="http://tonytang1990.github.io/index.html">
<meta property="og:site_name" content="走停人生路">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Tony Tang">
<meta name="twitter:card" content="summary">

    
    <link rel="alternative" href="/atom.xml" title="走停人生路" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/jacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/jacman.jpg">
    
    
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 7.3.0"></head>

  <body>
    <header>
      
<div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.png" alt="走停人生路" title="走停人生路"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="走停人生路">走停人生路</a></h1>
				<h2 class="blog-motto">做着独立游戏梦，坚持走在游戏开发道路上的人</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">Home</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
						<li><a href="/about">About</a></li>
					
					<li>
 					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="search" id="search" name="q" autocomplete="off" maxlength="20" placeholder="搜索" />
						<input type="hidden" name="q" value="site:tonytang1990.github.io">
					</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main">

   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2025/03/10/博客搭建/" title="博客搭建" itemprop="url">博客搭建</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Tony Tang" target="_blank" itemprop="author">Tony Tang</a>
		
  <p class="article-time">
    <time datetime="2025-03-09T16:47:00.000Z" itemprop="datePublished"> 发表于 2025-03-10</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>基于Hexo搭建的博客用了很多年，最近因为一些原因更新了NodeJs相关导致搭建好的Hexo博客无法正常使用，本章节再次记录从零搭建Hexo在Github上的博客流程，分享和记录Hexo的博客搭建流程。</p>
<h1 id="Hexo"><a href="#Hexo" class="headerlink" title="Hexo"></a>Hexo</h1><p><a target="_blank" rel="noopener" href="https://hexo.io/zh-cn/">Hexo是快速、簡單且強大的網誌框架 · 超級快速. Node.js 帶給您超級快的檔案產生速度，上百個檔案只需幾秒就能建立完成。</a></p>
<p><strong>所以Hexo是我们生成博客网页相关的关键之一。</strong></p>
<h1 id="Github-Pages"><a href="#Github-Pages" class="headerlink" title="Github Pages"></a>Github Pages</h1><p><a target="_blank" rel="noopener" href="https://mini-pi.github.io/2024/02/28/how-to-make-blog-wedsite/">GitHub Pages 是一项静态站点托管服务，它直接从 GitHub 上获取 HTML、CSS 和 JavaScript 文件，通过构建过程运行文件，然后发布网站</a></p>
<p><strong>可以理解GitHub支持我们不熟静态网页的一个功能，所以Github Pages这是我们上传Github搭建博客的关键之一。</strong></p>
<h1 id="博客搭建"><a href="#博客搭建" class="headerlink" title="博客搭建"></a>博客搭建</h1><p>了解了核心的Hexo和Github Pages概念和原理，接下来让我们开始搭建属于我们自己的博客。</p>
<ul>
<li><p>安装Node.js</p>
<p>本人已经安装好了，直接去下载安装<a target="_blank" rel="noopener" href="https://nodejs.org/en/download/">Node.js</a>即可</p>
</li>
<li><p>安装Hexo</p>
<p>打开命令行，输入<a target="_blank" rel="noopener" href="https://hexo.io/zh-cn/">npm install hexo-cli -g</a>，不识别npm的先去处理npm环境</p>
</li>
<li><p>使用Hexo初始化博客</p>
<p>打开空目录，然后打开命令行，输入命令:hexo init blog</p>
<p><img src="/img/Blog/HexoBlogInit.PNG" alt="HexoBlogInit"></p>
</li>
<li><p>生成新博客</p>
<p>Hexo初始化博客所在目录打开命令行，输入hexo new TestBlog，会看到我们成功生成了一片新博客</p>
<p><img src="/img/Blog/HexoNewBlog.PNG" alt="HexoNewBlog"></p>
</li>
<li><p>生成博客静态网页</p>
<p>Hexo初始化博客所在目录打开命令行，输入hexo g，会看到public目录生成了静态网页相关文件</p>
<p><img src="/img/Blog/HexoBlogGenerate.PNG" alt="HexoBlogGenerate"></p>
</li>
<li><p>在Github上创建***.github.io的仓库(使用Github Pages服务)</p>
<p>详情参考<a target="_blank" rel="noopener" href="https://pages.github.com/">Github Pages</a></p>
</li>
<li><p>配置Hexo博客发布到Github的***.github.io仓库</p>
<p>打开Hexo初始化博客所在目录的_config.yml文件，将发布相关配置修改成如下:</p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="params">#</span> Deployment</span><br><span class="line"><span class="params">##</span> Docs: https://hexo.io/docs/one-command-deployment</span><br><span class="line">deploy:</span><br><span class="line">  type: git</span><br><span class="line">  repo: 这里填上面Github生成的博客仓库.github.io</span><br><span class="line">  branch: master</span><br></pre></td></tr></table></figure>
</li>
<li><p>发布博客到***.github.io仓库</p>
<p>Hexo初始化博客所在目录打开命令行，输入hexo d，会发现提示不是被的Deployer not found:git</p>
<p><img src="/img/Blog/HexoDeployGitError.PNG" alt="HexoDeployGitError"></p>
<p>这里我们需要安装git相关的hexo部署插件</p>
<p><strong>注意repo填写的仓库地址要SSH而非HTTPS的地址</strong></p>
</li>
<li><p>安装Hexo git部署插件</p>
<p>Hexo初始化博客所在目录打开命令行，输入npm install hexo-deployer-git –save</p>
<p>让后再次输入hexo d我们就会看到部署提示我们输入Github的密码</p>
<p><img src="/img/Blog/HexoDeployEnterPassword.PNG" alt="HexoDeployEnterPassword"></p>
<p>输入完成后回车即可完成博客上传部署。</p>
</li>
<li><p>默认Hexo的博客主题很简陋，这里我们需要去下一个喜欢的主题</p>
<p><a target="_blank" rel="noopener" href="https://hexo.io/themes/">Hexo Themes</a></p>
<p>这里我下载了一个叫jacman的主题:</p>
<p><a target="_blank" rel="noopener" href="https://github.com/wuchong/jacman">jacman</a></p>
<p>下载完成后，我们需要在_config.yml文件里配置theme使用刚下的主题</p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="params">#</span> Extensions</span><br><span class="line"><span class="params">##</span> Plugins: https://hexo.io/plugins/</span><br><span class="line"><span class="params">##</span> Themes: https://hexo.io/themes/</span><br><span class="line">theme: jacman</span><br></pre></td></tr></table></figure>

<p><strong>下载的主题文件放在themes文件夹下</strong></p>
</li>
<li><p>如果想本地测试查看博客效果</p>
<p>Hexo初始化博客所在目录打开命令行，输入hexo server，然后在网页输入localhost:4000即可查看本地效果</p>
<p><img src="/img/Blog/HexoLocalServerPreview.PNG" alt="HexoLocalServerPreview"></p>
</li>
<li><p><strong>关于博客的一些名字修改，自己打开_config.yml修改对应地方即可</strong></p>
<p>配置说明详细参考:<a target="_blank" rel="noopener" href="https://hexo.io/docs/configuration">configuration</a></p>
</li>
</ul>
<p>Note:</p>
<ol>
<li><strong>关于Git的配置上述略过了</strong></li>
<li><strong>博客编写的图片路径要放在当前使用主题下的source目录</strong></li>
</ol>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/26625249">Github+Hexo搭建个人网站详细教程</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Other/">Other</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Other/">Other</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2024/04/23/地图编辑器/" title="地图编辑器" itemprop="url">地图编辑器</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Tony Tang" target="_blank" itemprop="author">Tony Tang</a>
		
  <p class="article-time">
    <time datetime="2024-04-23T10:27:00.000Z" itemprop="datePublished"> 发表于 2024-04-23</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>游戏开发过程中，我们搭建关卡时需要一个工具去支持摆放场景物件和数据埋点编辑，从而支持快速搭建关卡和策划数据埋点。这一工具正是本章节需要实现的地图编辑器。</p>
<h1 id="地图编辑器"><a href="#地图编辑器" class="headerlink" title="地图编辑器"></a>地图编辑器</h1><h2 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h2><p>实现一个工具，首先第一步，我们还是需要理清需求：</p>
<ol>
<li>纯Editor地图编辑器，用于<strong>场景编辑</strong>和<strong>数据埋点</strong>。</li>
<li>支持自定义场景对象数据和自由摆放场景对象进行场景编辑，场景对象支持<strong>静态摆放</strong>和<strong>动态创建</strong>两种。</li>
<li>支持自定义<strong>埋点数据</strong>和<strong>自由摆放埋点数据</strong>进行数据埋点编辑。</li>
<li>支持自定义调整场景大小以及场景地形指定和大小自动适配。</li>
<li>场景数据和埋点数据支持导出自定义数据格式(比如Lua,Json等)。</li>
<li>同一个场景支持编辑多个场景编辑和数据埋点。</li>
</ol>
<h2 id="设计实现"><a href="#设计实现" class="headerlink" title="设计实现"></a>设计实现</h2><p>接下来针对前面提到的需求，我们一一分析我们应该用什么方案和技术来实现。</p>
<p>实现思路：</p>
<ol>
<li>地图编辑器主要由<strong>地图编辑器配置窗口</strong>和<strong>地图编辑器挂在操作脚本</strong>Inspector组成。</li>
<li>地图编辑器编辑数据分为两大类(1. <strong>地图编辑</strong> 2. <strong>数据埋点</strong>)。</li>
<li>继承EditorWindow实现场景编辑和数据埋点的基础数据配置编辑。</li>
<li>继承Editor自定义Inspector面板实现纯单个场景编辑和数据埋点操作。</li>
<li>地图编辑操作通过挂在脚本(<strong>Map.cs</strong>)的方式作为单个场景编辑和数据埋点单位，从而实现单个场景多个场景编辑和数据埋点支持。</li>
<li>场景对象编辑采用直接创建实体GameObject的方式，从而实现场景编辑完成后的场景可直接用于作为场景使用。</li>
<li>场景对象编辑通过自定义Inspector面板实现快速删除和创建场景对象GameObject实现场景对象的编辑。</li>
<li>数据埋点采用Gizmos(Monobehaviour:OnDrawGizmos())，Handles(Editor.OnSceneGUI())实现可视化编辑对象和相关数据显示，自定义场景大小配置网格显示也是用Gizmos实现。</li>
<li>地图编辑器配置窗口用于配置基础的场景数据和埋点数据配置，<strong>Map.cs</strong>的挂在脚本通过自定义数据结构和自定义面板显示实现自定义数据配置。</li>
<li><strong>场景静态对象</strong>相关数据通过挂在<strong>MapObjectDataMono</strong>脚本存储相关对象数据。</li>
<li>导出前通过<strong>Map.cs</strong>存储的数据构建自定义数据(<strong>MapExport.cs</strong>)实现自定义数据导出</li>
<li><strong>大地图未来有需求可以做成所有静态对象通过导出数据根据逻辑加载的方式实现按需加载。</strong></li>
</ol>
<p>核心思路和技术实现方案都在上面介绍了，这里就不一一介绍代码实现了，这里只放部分关键代码，让我们直接实战看效果，需要源码的直接在文章末尾Github链接去取即可。</p>
<h2 id="配置窗口"><a href="#配置窗口" class="headerlink" title="配置窗口"></a>配置窗口</h2><p>配置窗口主要负责实现对地图编辑对象，地图编辑埋点的基础数据定义，一些相关操作按钮和全局配置。</p>
<h3 id="配置定义"><a href="#配置定义" class="headerlink" title="配置定义"></a>配置定义</h3><p>地图配置数据结构定义:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> MapSetting.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MapSetting</span> : <span class="title">ScriptableObject</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> UNITY_EDITOR</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Editor下的地图配置单例对象</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> MapSetting EditorSingleton;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 获取Editor地图配置单例对象</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> MapSetting <span class="title">GetEditorInstance</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(EditorSingleton == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            EditorSingleton = MapUtilities.LoadOrCreateGameMapSetting();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> EditorSingleton;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 默认地图横向大小</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;默认地图横向大小&quot;</span>)</span>]</span><br><span class="line">    [<span class="meta">Range(1, 1000)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> DefaultMapWidth = MapConst.DefaultMapWidth;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 默认地图纵向大小</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;默认地图纵向大小&quot;</span>)</span>]</span><br><span class="line">    [<span class="meta">Range(1, 1000)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> DefaultMapHeight = MapConst.DefaultMapHeight;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 地图对象配置数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;地图对象配置数据&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> MapObjectSetting ObjectSetting = <span class="keyword">new</span> MapObjectSetting();</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 地图埋点配置数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;地图埋点配置数据&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> MapDataSetting DataSetting = <span class="keyword">new</span> MapDataSetting();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>地图对象配置定义:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> MapObjectType.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 地图对象类型枚举</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="built_in">enum</span> MapObjectType</span><br><span class="line">&#123;</span><br><span class="line">    Scene = <span class="number">0</span>,                  <span class="comment">// 场景</span></span><br><span class="line">    Door = <span class="number">1</span>,                   <span class="comment">// 门</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> MapObjectSetting.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 地图对象设置数据</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">Serializable</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MapObjectSetting</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 所有地图对象类型配置数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;所有地图对象类型配置数据&quot;</span>)</span>]</span><br><span class="line">    [<span class="meta">SerializeReference</span>]</span><br><span class="line">    <span class="keyword">public</span> List&lt;MapObjectTypeConfig&gt; AllMapObjectTypeConfigs = <span class="keyword">new</span> List&lt;MapObjectTypeConfig&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 所有地图对象配置数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;所有地图对象配置数据&quot;</span>)</span>]</span><br><span class="line">    [<span class="meta">SerializeReference</span>]</span><br><span class="line">    <span class="keyword">public</span> List&lt;MapObjectConfig&gt; AllMapObjectConfigs = <span class="keyword">new</span> List&lt;MapObjectConfig&gt;();</span><br><span class="line">    </span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> MapObjectConfig.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 地图对象数据配置</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">Serializable</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MapObjectConfig</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 唯一ID(用于标识地图对象配置唯一)</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;唯一ID&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> UID;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 地图对象类型</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;地图对象类型&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> MapObjectType ObjectType;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 是否是动态地图对象</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;是否是动态地图对象&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">bool</span> IsDynamic;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 关联Id</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;关联Id&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> ConfId;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 资源Asset</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;资源Asset&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> GameObject Asset;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 描述</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;描述&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Des;</span><br><span class="line">    </span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>地图埋点配置定义:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> MapDataType.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 地图数据埋点类型枚举</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="built_in">enum</span> MapDataType</span><br><span class="line">&#123;</span><br><span class="line">    PlayerSpawn = <span class="number">0</span>,           <span class="comment">// 玩家出生点位置数据</span></span><br><span class="line">    Monster = <span class="number">1</span>,               <span class="comment">// 怪物数据</span></span><br><span class="line">    TreasureBox = <span class="number">2</span>,           <span class="comment">// 宝箱数据</span></span><br><span class="line">    Trap = <span class="number">3</span>,                  <span class="comment">// 陷阱数据</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> MapDataSetting.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 地图数据配置数据</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">Serializable</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MapDataSetting</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 所有地图埋点数据配置</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;所有地图埋点数据配置&quot;</span>)</span>]</span><br><span class="line">    [<span class="meta">SerializeReference</span>]</span><br><span class="line">    <span class="keyword">public</span> List&lt;MapDataConfig&gt; AlllMapDataConfigs = <span class="keyword">new</span> List&lt;MapDataConfig&gt;();</span><br><span class="line"></span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> MapDataConfig.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 地图埋点数据配置</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">Serializable</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MapDataConfig</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 唯一ID(用于标识地图埋点配置唯一)</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;唯一ID&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> UID;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 地图数据类型</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;地图数据类型&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> MapDataType DataType;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 关联Id</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;关联Id&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> ConfId;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 场景球体颜色</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;场景球体颜色&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> Color SceneSphereColor = Color.red;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 描述</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;描述&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Des;</span><br><span class="line">    </span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>配置定义设计如下:</p>
<ol>
<li><strong>MapSetting是地图编辑器配置数据结构定义，继承至ScriptableObject，保存到Editor</strong></li>
<li><strong>MapObjectSetting是地图对象的所有编辑器配置结构定义。MapObjectConfig是地图对象编辑器单条配置结构定义。MapObjectType是地图对象类型定义。</strong></li>
<li><strong>MapDataSetting是地图埋点的所有编辑器配置结构定义。MapDataConfig是地图埋点编辑器单条配置结构定义。MapDataType是地图埋点类型定义。</strong></li>
</ol>
<h3 id="配置窗口-1"><a href="#配置窗口-1" class="headerlink" title="配置窗口"></a>配置窗口</h3><p>可以看到在地图编辑器窗口主要分为4个区域：</p>
<ol>
<li><strong>快捷按钮区域</strong></li>
<li><strong>自定义地图基础数据区域(e.g. 默认地图宽高)</strong></li>
<li><strong>地图对象配置区域</strong></li>
<li><strong>地图埋点配置区域</strong></li>
</ol>
<p>以上配置数据会成为我们后面操作编辑Inspector里用户可以添加操作的基础数据来源，详细代码参见<strong>MapEditorWindow.cs</strong>。</p>
<h4 id="快捷按钮区域"><a href="#快捷按钮区域" class="headerlink" title="快捷按钮区域"></a>快捷按钮区域</h4><p>效果图：</p>
<p><img src="/img/Unity/MapEditor/ShortcutOperationArea.PNG" alt="ShortcutOperationArea"></p>
<p>可以看到目前提供了三个快捷按钮：</p>
<ol>
<li><strong>保存地图配置数据</strong> – 用于确保我们在配置窗口的数据配置修改保存到本地ScriptableObject Asset</li>
<li><strong>打开地图编辑场景</strong> – 用于帮助我们快速打开辅助地图编辑的场景</li>
<li><strong>快速选中地图地编对象</strong> – 用于帮助我们快速选中当前场景里第一个带Map.cs脚本的对象，方便快速进入Map.cs的Inspector操作面板操作</li>
<li><strong>一键导出所有地图</strong> – 用于一键导出所有编辑好的地图埋点数据</li>
<li><strong>一键烘焙导出所有地图</strong> – 用于一键烘焙所有场景和导出所有编辑好的地图埋点数据</li>
</ol>
<h4 id="自定义地图数据区域"><a href="#自定义地图数据区域" class="headerlink" title="自定义地图数据区域"></a>自定义地图数据区域</h4><p>效果图：</p>
<p><img src="/img/Unity/MapEditor/CustomDataSettingArea.PNG" alt="CustomDataSettingArea"></p>
<p>自定义数据目前只支持了默认创建地图编辑宽高配置(挂在Map.cs脚本时默认创建的地图横向竖向大小数据来源)。</p>
<p>未来扩展更多基础配置数据在这里添加。</p>
<h4 id="地图对象配置区域"><a href="#地图对象配置区域" class="headerlink" title="地图对象配置区域"></a>地图对象配置区域</h4><p>效果图：</p>
<p><img src="/img/Unity/MapEditor/MapObjectConfigArea.PNG" alt="MapObjectConfigArea"></p>
<p>地图对象配置设计如下:</p>
<ol>
<li><p><strong>以UID作为唯一配置Id标识(不允许重复)，此Id会作为我们编辑器地图对象配置数据读取的依据。</strong></p>
</li>
<li><p><strong>通过MapObjectType指定地图对象类型。</strong></p>
</li>
<li><p><strong>通过定义ConfId(关联配置Id)实现关联游戏内动态对象Id的功能。</strong></p>
</li>
<li><p><strong>地图对象编辑通过定义Asset实现指定自定义预制件Asset作为实体对象的资源对象。</strong></p>
</li>
<li><p><strong>描述用于方便用户自定义取名，方便识别不同的地图对象配置。</strong></p>
</li>
</ol>
<p>Note:</p>
<ol>
<li><strong>需要参与导出的地图基础配置数据如果修改了(比如关联配置Id)，对应用到此基础配置数据的关卡都需要重新导出。</strong></li>
<li><strong>MapObjectType需要代码自定义扩展后，编辑器才有更多选项</strong></li>
</ol>
<h4 id="地图埋点配置区域"><a href="#地图埋点配置区域" class="headerlink" title="地图埋点配置区域"></a>地图埋点配置区域</h4><p>效果图：</p>
<p><img src="/img/Unity/MapEditor/MapDataConfigArea.PNG" alt="MapDataConfigArea"></p>
<p>地图埋点配置设计如下:</p>
<ol>
<li><strong>以UID作为唯一配置Id标识(不允许重复)，此Id会作为我们编辑器地图埋点配置数据读取的依据。</strong></li>
<li><strong>通过MapDataType指定地图埋点类型。</strong></li>
<li><strong>通过定义ConfId(关联配置Id)实现关联游戏内动态对象Id的功能。</strong></li>
<li><strong>场景球体颜色用于配置地图埋点的GUI球体绘制颜色配置。</strong></li>
<li><strong>初始旋转用于配置地图埋点添加时的初始旋转配置(方便自定义大部分用到的初始宣旋转数据)</strong></li>
<li><strong>描述用于方便用户自定义取名，方便识别不同的地图埋点配置。</strong></li>
</ol>
<p>Note:</p>
<ol>
<li><strong>MapDataType需要代码自定义扩展后，编辑器才有更多选项</strong></li>
</ol>
<h2 id="操作编辑Inspector"><a href="#操作编辑Inspector" class="headerlink" title="操作编辑Inspector"></a>操作编辑Inspector</h2><p>操作编辑Inspector主要负责实现对地图编辑对象和地图编辑埋点的一些相关操作面板，可视化GUI数据绘制，地图编辑自定义基础数据配置以及一些快捷操作按钮，详细代码参见<strong>Map.cs和MapEditor.cs</strong>。</p>
<h3 id="基础数据配置区域"><a href="#基础数据配置区域" class="headerlink" title="基础数据配置区域"></a>基础数据配置区域</h3><p>基础数据配置区域用于GUI开关，地图大小，地图起始位置，自定义地形等配置。</p>
<p>效果图:</p>
<p><img src="/img/Unity/MapEditor/BasicDataConfigInspectorArea.PNG" alt="BasicDataConfigInspectorArea"></p>
<p>自定义配置区域介绍：</p>
<ol>
<li><strong>场景GUI总开关</strong> – 所有绘制GUI的总开关</li>
<li><strong>地图线条GUI开关</strong> – 控制地图N*N的线条GUI绘制开关</li>
<li><strong>地图对象场景GUI开关</strong> – 控制地图对象相关的GUI绘制开关</li>
<li><strong>地图埋点场景GUI开关</strong> – 控制地图埋点相关的GUI绘制开关</li>
<li><strong>地图对象创建自动聚焦开关</strong> – 控制地图对象创建后是否需要自动聚焦选中</li>
<li><strong>地图横向大小和地图纵向大小</strong> – 用于控制我们需要编辑的关卡地图的大小，会影响默认地图或自定义地图的大小和平铺</li>
<li><strong>游戏地图起始位置</strong> – 用于控制关卡的起始位置偏移，方便支持自定义不同起始位置的关卡设置</li>
</ol>
<h3 id="快捷操作按钮区域"><a href="#快捷操作按钮区域" class="headerlink" title="快捷操作按钮区域"></a>快捷操作按钮区域</h3><p>快捷操作按钮区域用于支持自定义功能。</p>
<p>效果图:</p>
<p><img src="/img/Unity/MapEditor/ShortcutOperationInspectorArea.PNG" alt="ShortcutOperationInspectorArea"></p>
<p>快捷按钮功能介绍：</p>
<ol start="3">
<li><strong>拷贝NavMesh Asset按钮</strong> – NavMeshSurface默认烘焙Asset保存在对应场景同层目录，此按钮用于快速拷贝对应Asset到对应关卡预制件同层目录</li>
<li><strong>一键重创地图对象按钮</strong> – 用于我们更新了某些已经创建好的静态地图对象(脱离预制件关联)相关资源后一键确保使用最新资源创建</li>
<li><strong>导出地图数据按钮</strong> – 用于完成我们的关卡数据序列化导出</li>
<li><strong>保存关卡数据</strong> – 用于独立保存关卡埋点相关数据(支持自定义名字，默认和预制件同名)</li>
<li><strong>一键烘焙拷贝导出</strong> – 用于一键完成恢复动态对象+烘培寻路+拷贝寻路+清除动态对象+导出地图数据操作</li>
</ol>
<p>Note:</p>
<ol>
<li><strong>场景对象是否参与寻路烘培，通过修改预制件Layer和NavMeshSurface的寻路烘培的Layer决定</strong></li>
<li><strong>大部分操作在实体对象做成预制件后需要进入预制件编辑模式，所以部分操作会根据脚本所在实体对象情况决定是否自动进入预制件编辑模式</strong></li>
</ol>
<h3 id="地图对象编辑区域"><a href="#地图对象编辑区域" class="headerlink" title="地图对象编辑区域"></a>地图对象编辑区域</h3><p>效果图:</p>
<p><img src="/img/Unity/MapEditor/MapObjectConfigInspectorArea.PNG" alt="MapObjectConfigInspectorArea"></p>
<p>地图对象数据定义：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> MapObjectData.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 地图对象数据</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">Serializable</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MapObjectData</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 唯一Id(用于标识地图对象配置唯一)</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;唯一Id&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> UID;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 实体对象</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;实体对象&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> GameObject Go;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 埋点位置(地图对象可能删除还原，所以需要逻辑层面记录位置)</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;埋点位置&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> Vector3 Position;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 旋转(地图对象可能删除还原，所以需要逻辑层面记录旋转)</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;旋转&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> Vector3 Rotation = Vector3.zero;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 本地缩放(地图对象可能删除还原，所以需要逻辑层面记录缩放)</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;缩放&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> Vector3 LocalScale = Vector3.one;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 碰撞器中心点</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;碰撞器中心点&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> Vector3 ColliderCenter = <span class="keyword">new</span> Vector3(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 碰撞器大小</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;碰撞器大小&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> Vector3 ColliderSize = <span class="keyword">new</span> Vector3(<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 碰撞体半径</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;碰撞体半径&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">float</span> ColliderRadius = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 带参构造函数</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;uid&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;go&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MapObjectData</span>(<span class="params"><span class="built_in">int</span> uid, GameObject go</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        UID = uid;</span><br><span class="line">        Go = go;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>地图对象编辑通过选择<strong>地图对象类型</strong>和<strong>地图对象选择</strong>决定要添加的地图对象配置。</p>
<p>地图对象编辑和地图对象选择后面的**+<strong>默认是</strong>添加到地图对象数据列表尾部**。</p>
<p>地图对象数据列表后的操作可以对已经配置的地图对象数据进行相关操作，此处的**+<strong>号是将选择的地图对象类型和地图对象选择</strong>插入的当前数据位置**。</p>
<p>Note:</p>
<ol start="2">
<li><strong>地图对象可以通过地图对象配置面板配置的关联id导出给程序实现动态对象的配置关联</strong></li>
<li><strong>地图对象的数据关联是通过挂在MapObjectDataMono.cs脚本实现</strong></li>
<li><strong>未来如果地图对象要想实现按需加载可以通过导出地图对象数据给程序动态加载实现，相关代码参考MapObjectExport.cs相关代码(不分代码注释着)</strong></li>
</ol>
<h3 id="地图埋点编辑区域"><a href="#地图埋点编辑区域" class="headerlink" title="地图埋点编辑区域"></a>地图埋点编辑区域</h3><p>效果图:</p>
<p><img src="/img/Unity/MapEditor/MapDataConfigInspectorArea.PNG" alt="MapDataConfigInspectorArea"></p>
<p>地图埋点数据定义：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> MapData.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 地图数据买点数据</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">Serializable</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MapData</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 唯一Id(用于标识地图对象配置唯一)</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;唯一Id&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> UID;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 埋点位置</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;埋点位置&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> Vector3 Position;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 埋点旋转</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;埋点旋转&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> Vector3 Rotation;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 批量操作开关</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;批量操作开关&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">bool</span> BatchOperationSwitch;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> GUI关闭开关</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;GUI关闭开关&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">bool</span> GUISwitchOff = <span class="literal">false</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MapData</span>(<span class="params"><span class="built_in">int</span> uid</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        UID = uid;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MapData</span>(<span class="params"><span class="built_in">int</span> uid, Vector3 position, Vector3 rotation</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        UID = uid;</span><br><span class="line">        Position = position;</span><br><span class="line">        Rotation = rotation;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>地图埋点编辑通过选择<strong>地图埋点类型</strong>和<strong>地图埋点选择</strong>决定要添加的地图埋点配置。</p>
<p>地图埋点编辑和地图埋点选择后面的**+<strong>默认是</strong>添加到地图埋点数据列表尾部**。</p>
<p>地图埋点数据列表后的操作可以对已经配置的地图埋点数据进行相关操作，此处的**+<strong>号是将选择的地图埋点类型和地图对象选择</strong>插入的当前数据位置**。</p>
<p><strong>地图埋点支持批量操作位置</strong>，通过勾选批量选项决定哪些地图埋点数据要一起操作位置，然后操作(拖拽或者输入坐标)勾选了批量的地图埋点对象的位置，可以实现一起修改勾选了批量操作的地图埋点位置。</p>
<p><strong>一键清除批量勾选按钮</strong> – 用于快速取消所有已勾选批量的地图埋点数据</p>
<p>Note:</p>
<ol>
<li><strong>地图数据的编辑和导出是按Map.cs脚本为单位。</strong></li>
<li><strong>地图埋点数据时通过Editor GUI(e.g. Handles和Gimoz)绘制的</strong></li>
<li><strong>地图埋点的位置调整需要按住W按键，旋转调整需要按住E按键</strong></li>
<li><strong>地图埋点支持配置自定义数据，这部分可以参考Monster埋点的自定义数据配置</strong></li>
<li><strong>地图埋点通过地图埋点配置面板配置的关联id导出给程序实现地图埋点的配置关联</strong></li>
<li><strong>自定义数据埋点可视化可以通过扩展MapEditor.cs实现自定义绘制</strong></li>
</ol>
<h3 id="寻路烘培"><a href="#寻路烘培" class="headerlink" title="寻路烘培"></a>寻路烘培</h3><p>目前<strong>场景编辑</strong>是以<strong>Map.cs</strong>为单位。所以<strong>寻路烘培</strong>目前也是按<strong>Map.cs所在预制件为单位</strong>。</p>
<p>通过每个Map.cs所在GameObject挂在<strong>NavMeshSurface</strong>组件实现对当前GameObject的寻路烘培。</p>
<p>效果图:</p>
<p><img src="/img/Unity/MapEditor/NavigationBakePreview.PNG" alt="NavigationBakePreview"></p>
<p>Note:</p>
<ol>
<li><strong>NavMeshSurface设置Collect Objects为Children(只有子节点参与烘培)，参与烘培的Include Layers设置成自定义的实现是否参与烘培的Layer规则。</strong></li>
</ol>
<h3 id="数据导出"><a href="#数据导出" class="headerlink" title="数据导出"></a>数据导出</h3><p>数据导出是通过点击<strong>导出地图数据按钮</strong>或者<strong>一键烘培拷贝导出按钮</strong>实现的。</p>
<p><strong>为了支持多种不同数据格式的导出，在数据导出之前我进行导出数据的定义和抽象。</strong></p>
<p><strong>地图导出数据结构</strong>定义:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> MapExport.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 地图导出数据结构定义(统一导出结构定义，方便支持导出不同的数据格式)</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">Serializable</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MapExport</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 地图导出数据成员</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> MapDataExport MapData = <span class="keyword">new</span> MapDataExport();</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 所有怪物导出数据列表</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> List&lt;MonsterMapDataExport&gt; ALlMonsterMapDatas = <span class="keyword">new</span> List&lt;MonsterMapDataExport&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 所有宝箱导出数据列表</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> List&lt;TreasureBoxMapDataExport&gt; AllTreasureBoxMapDatas = <span class="keyword">new</span> List&lt;TreasureBoxMapDataExport&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 所有陷阱导出数据列表</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> List&lt;TrapMapDataExport&gt; AllTrapMapDatas = <span class="keyword">new</span> List&lt;TrapMapDataExport&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 剩余其他地图埋点导出数据成员</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> List&lt;BaseMapDataExport&gt; AllOtherMapDatas = <span class="keyword">new</span> List&lt;BaseMapDataExport&gt;();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>地图对象导出数据基类</strong>定义:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> MapObjectExport.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 地图动态物体数据导出定义</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">Serializable</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MapObjectExport</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 地图对象类型</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> MapObjectType MapObjectType;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 关联配置Id</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> ConfId;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 位置信息</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> Vector3 Position;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 旋转信息</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> Vector3 Rotation;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 缩放信息</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> Vector3 LocalScale;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MapObjectExport</span>(<span class="params">MapObjectType mapObjectType, <span class="built_in">int</span> confId, Vector3 position, Vector3 rotation, Vector3 localScale</span>)</span> </span><br><span class="line">    &#123;</span><br><span class="line">        MapObjectType = mapObjectType;</span><br><span class="line">        ConfId = confId;</span><br><span class="line">        Position = position;</span><br><span class="line">        Rotation = rotation;</span><br><span class="line">        LocalScale = localScale;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>地图埋点导出数据基类</strong>定义:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> BaseMapDataExport.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 地图埋点数据基类导出定义</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">Serializable</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BaseMapDataExport</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 埋点类型</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> MapDataType MapDataType;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 关联Id</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> ConfId;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 位置信息</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> Vector3 Position;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 旋转信息</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> Vector3 Roation;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BaseMapDataExport</span>(<span class="params">MapDataType mapDataType, <span class="built_in">int</span> confId, Vector3 position, Vector3 rotation</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        MapDataType = mapDataType;</span><br><span class="line">        ConfId = confId;</span><br><span class="line">        Position = position;</span><br><span class="line">        Roation = rotation;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>怪物埋点数据导出</strong>定义：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> MonsterMapDataExport.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 怪物地图埋点数据导出</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">Serializable</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MonsterMapDataExport</span> : <span class="title">BaseMapDataExport</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 怪物创建半径</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">float</span> MonsterCreateRadius;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 怪物警戒半径</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">float</span> MonsterActiveRadius;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MonsterMapDataExport</span>(<span class="params">MapDataType mapDataType, <span class="built_in">int</span> confId, Vector3 position,  Vector3 rotation, <span class="built_in">float</span> monsterCreateRadius, <span class="built_in">float</span> monsterActiveRadius</span>)</span></span><br><span class="line"><span class="function">        : <span class="title">base</span>(<span class="params">mapDataType, confId, position, rotation</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            MonsterCreateRadius = monsterCreateRadius;</span><br><span class="line">            MonsterActiveRadius = monsterActiveRadius;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>地图导出数据预览Level1.json:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;MapData&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;Width&quot;</span><span class="punctuation">:</span> <span class="number">8</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;Height&quot;</span><span class="punctuation">:</span> <span class="number">30</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;StartPos&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;BirthPos&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">4.0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="number">2.0</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;AllBaseMapObjectExportDatas&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;MapObjectType&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;ConfId&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Position&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">4.0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">1.0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="number">3.7200000286102297</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Rotation&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;MapObjectType&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;ConfId&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Position&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">4.0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">1.0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="number">11.600000381469727</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Rotation&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;AllColliderMapDynamicExportDatas&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;MapObjectType&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;ConfId&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Position&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">4.0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">0.25</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="number">8.149999618530274</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Rotation&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;ColliderCenter&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;ColliderSize&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;ColliderRiduis&quot;</span><span class="punctuation">:</span> <span class="number">0.5</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;MapObjectType&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;ConfId&quot;</span><span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Position&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">4.0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">0.5</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="number">18.809999465942384</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Rotation&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;ColliderCenter&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;ColliderSize&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">1.0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">1.0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="number">1.0</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;ColliderRiduis&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;MapObjectType&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;ConfId&quot;</span><span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Position&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">4.0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">0.5</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="number">14.899999618530274</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Rotation&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;ColliderCenter&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;ColliderSize&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">1.0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">1.0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="number">1.0</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;ColliderRiduis&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;AllMonsterGroupMapDatas&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;MapDataType&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;ConfId&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Position&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">4.0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="number">8.0</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Roation&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;GroupId&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;MonsterCreateRadius&quot;</span><span class="punctuation">:</span> <span class="number">4.0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;MonsterActiveRadius&quot;</span><span class="punctuation">:</span> <span class="number">3.0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;AllMonsterMapExportDatas&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;MapDataType&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;ConfId&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;Position&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">4.0</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="number">7.0</span></span><br><span class="line">                    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;Roation&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">90.0</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span></span><br><span class="line">                    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;GroupId&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;MapDataType&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;ConfId&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;Position&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">5.0</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="number">9.0</span></span><br><span class="line">                    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;Roation&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">90.0</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span></span><br><span class="line">                    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;GroupId&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;MapDataType&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;ConfId&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;Position&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">6.0</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="number">8.0</span></span><br><span class="line">                    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;Roation&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">90.0</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span></span><br><span class="line">                    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;GroupId&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;MapDataType&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;ConfId&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Position&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">4.0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="number">25.0</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Roation&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;GroupId&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;MonsterCreateRadius&quot;</span><span class="punctuation">:</span> <span class="number">6.0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;MonsterActiveRadius&quot;</span><span class="punctuation">:</span> <span class="number">4.0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;AllMonsterMapExportDatas&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;MapDataType&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;ConfId&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;Position&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">4.0</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="number">26.0</span></span><br><span class="line">                    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;Roation&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">90.0</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span></span><br><span class="line">                    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;GroupId&quot;</span><span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;MapDataType&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;ConfId&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;Position&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">5.0</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="number">26.0</span></span><br><span class="line">                    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;Roation&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">90.0</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span></span><br><span class="line">                    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;GroupId&quot;</span><span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;MapDataType&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;ConfId&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;Position&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">3.0</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="number">25.0</span></span><br><span class="line">                    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;Roation&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">90.0</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span></span><br><span class="line">                    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;GroupId&quot;</span><span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;MapDataType&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;ConfId&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;Position&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">5.0</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="number">23.0</span></span><br><span class="line">                    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;Roation&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">90.0</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span></span><br><span class="line">                    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;GroupId&quot;</span><span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;ALlNoGroupMonsterMapDatas&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;AllOtherMapDatas&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>上面的数据正对应我们导出填充的<strong>MapExport</strong>数据结构。</p>
<p><strong>MapExport导出数据构建是通过GameMapEditorUtilities.GetMapExport()通过Map脚本获取所有相关数据去构建MapExport实现导出数据填充构建的。</strong></p>
<p>Note:</p>
<ol>
<li><strong>因为静态地图对象是跟随预制件一起加载的，所以暂时没导出地图对象数据，有需要可以自行扩展支持动态地图对象导出和加载</strong></li>
<li><strong>扩展自定义配置数据需要自行扩展或继承MapObjectData或MapData和MapEditor.cs面板显示</strong></li>
<li><strong>扩展自定义导出数据需要自行扩展或继承BaseMapDataExportt定义</strong></li>
<li><strong>自定义地图埋点数据导出通过继承BaseMapDataExport定义</strong></li>
</ol>
<h2 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h2><h3 id="新增地图埋点数据"><a href="#新增地图埋点数据" class="headerlink" title="新增地图埋点数据"></a>新增地图埋点数据</h3><p>以新增地图埋点类型MapDataType.Monster为例，怪物有两个DIY属性MonsterCreateRadius (怪物创建半径)和MonsterActiveRadius(怪物警戒半径)</p>
<h4 id="新增地图埋点数据显示"><a href="#新增地图埋点数据显示" class="headerlink" title="新增地图埋点数据显示"></a>新增地图埋点数据显示</h4><ol>
<li><p>增加地图埋点类型定义(MapDataType.cs)</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> MapDataType.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 地图数据埋点类型枚举</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="built_in">enum</span> MapDataType</span><br><span class="line">&#123;</span><br><span class="line">    PlayerSpawn = <span class="number">0</span>,           <span class="comment">// 玩家出生点位置数据</span></span><br><span class="line">    Monster = <span class="number">1</span>,               <span class="comment">// 怪物数据</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>新增地图埋点数据定义(MonsterMapData.cs)</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">MapEditor</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> MonsterMapData.cs</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 怪物地图埋点数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Serializable</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MonsterMapData</span> : <span class="title">MapData</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 怪物创建半径</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        [<span class="meta">Header(<span class="string">&quot;怪物创建半径&quot;</span>)</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">float</span> MonsterCreateRadius = <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 怪物警戒半径</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        [<span class="meta">Header(<span class="string">&quot;怪物警戒半径&quot;</span>)</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">float</span> MonsterActiveRadius = <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">MonsterMapData</span>(<span class="params"><span class="built_in">int</span> uid</span>) : <span class="title">base</span>(<span class="params">uid</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">MonsterMapData</span>(<span class="params"><span class="built_in">int</span> uid, Vector3 position, Vector3 rotation, <span class="built_in">float</span> monsterCreateRadius, <span class="built_in">float</span> monsterActiveRadius</span>)</span></span><br><span class="line"><span class="function">            : <span class="title">base</span>(<span class="params">uid, position, rotation</span>)</span></span><br><span class="line">            &#123;</span><br><span class="line">                MonsterCreateRadius = monsterCreateRadius;</span><br><span class="line">                MonsterActiveRadius = monsterActiveRadius;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 复制自定义数据</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;sourceMapData&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="built_in">bool</span> <span class="title">CopyCustomData</span>(<span class="params">MapData sourceMapData</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(!<span class="keyword">base</span>.CopyCustomData(sourceMapData))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">var</span> realSourceMapData = sourceMapData <span class="keyword">as</span> MonsterMapData;</span><br><span class="line">            MonsterCreateRadius = realSourceMapData.MonsterCreateRadius;</span><br><span class="line">            MonsterActiveRadius = realSourceMapData.MonsterActiveRadius;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>新增编辑器操作添加怪物地图埋点数据(MapUtilities.cs)</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 创建指定地图埋点数据类型，指定uid和指定位置的埋点数据</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;mapDataType&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;uid&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;position&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;rotation&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;monsterCreateRadius&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;monsterActiveRadius&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> MapData <span class="title">CreateMapDataByType</span>(<span class="params">MapDataType mapDataType, <span class="built_in">int</span> uid, Vector3 position, Vector3 rotation, <span class="built_in">float</span> monsterCreateRadius, <span class="built_in">float</span> monsterActiveRadius</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (mapDataType == MapDataType.Monster)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> MonsterMapData(uid, position, rotation, monsterCreateRadius, monsterActiveRadius);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (mapDataType == MapDataType.PlayerSpawn)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> PlayerSpawnMapData(uid, position, rotation);</span><br><span class="line">    &#125;</span><br><span class="line">    ******</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        Debug.LogWarning(<span class="string">$&quot;地图埋点类型:<span class="subst">&#123;mapDataType&#125;</span>没有创建自定义类型数据，可能不方便未来扩展！&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> MapData(uid, position, rotation);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>新增怪物编辑器GUI显示数据定义(MapEditorUtilities.cs)</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 地图埋点类型UI类型显示数据列表</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">readonly</span> List&lt;MapDataTypeDisplayData&gt; MapDataTypeDisplayDatas = <span class="keyword">new</span> List&lt;MapDataTypeDisplayData&gt;()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">new</span> MapDataTypeDisplayData(MapDataType.PlayerSpawn, MapFoldType.PlayerSpawnMapDataFold, <span class="string">&quot;玩家出生点&quot;</span>, Color.yellow),</span><br><span class="line">    <span class="keyword">new</span> MapDataTypeDisplayData(MapDataType.Monster, MapFoldType.MonsterMapDataFold, <span class="string">&quot;怪物&quot;</span>, Color.magenta),</span><br><span class="line">    ******</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
</li>
<li><p>新增怪物自定义数据UI显示数据定义(MapUIType.cs)</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">  <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> MapUIType.cs</span></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> 地图数据UI类型</span></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">  <span class="keyword">public</span> <span class="built_in">enum</span> MapUIType</span><br><span class="line">  &#123;</span><br><span class="line">*******</span><br><span class="line">      MonsterCreateRadius = <span class="number">12</span>,               <span class="comment">// 怪物创建半径UI</span></span><br><span class="line">      MonsterActiveRadius = <span class="number">13</span>,               <span class="comment">// 怪物警戒半径UI</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>新增怪物自定义类型数据UI显示相关数据定义(MapEditorUtilities.cs)</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 地图埋点类型和UI显示类型Map<span class="doctag">&lt;地图埋点类型，&lt;地图UI显示类型，是否显示&gt;</span>&gt;</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Note:</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 所有需要显示的折叠数据都在这里定义相关UI是否显示</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 通用必显示的不同定义在这里，详情参见CommonGameMapUITypeMap</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 所有MapDataType类型必定会自动初始化到MapFoldAndUITypeMap，没有DIY UI显示的可以不定义在这</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Dictionary&lt;MapDataType, Dictionary&lt;MapUIType, <span class="built_in">bool</span>&gt;&gt; MapFoldAndUITypeMap = <span class="keyword">new</span> Dictionary&lt;MapDataType, Dictionary&lt;MapUIType, <span class="built_in">bool</span>&gt;&gt;()</span><br><span class="line">&#123;</span><br><span class="line">    &#123;</span><br><span class="line">        MapDataType.Monster, <span class="keyword">new</span> Dictionary&lt;MapUIType, <span class="built_in">bool</span>&gt;()</span><br><span class="line">        &#123;</span><br><span class="line">            &#123;MapUIType.MonsterCreateRadius, <span class="literal">true</span>&#125;,</span><br><span class="line">            &#123;MapUIType.MonsterActiveRadius, <span class="literal">true</span>&#125;,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 地图UI类型显示数据列表</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Note:</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 标题和属性默认按照这里定义的顺序显示</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">readonly</span> List&lt;MapUITypeDisplayData&gt; MapUITypeDisplayData = <span class="keyword">new</span> List&lt;MapUITypeDisplayData&gt;()</span><br><span class="line">&#123;</span><br><span class="line">    ******</span><br><span class="line">        <span class="keyword">new</span> MapUITypeDisplayData(MapUIType.MonsterCreateRadius, <span class="string">&quot;MonsterCreateRadius&quot;</span>, <span class="string">&quot;创建半径&quot;</span>, MapEditorConst.InspectorDataMonsterCreateRadiusUIWidth, MapStyles.TabMiddleStyle),</span><br><span class="line">    <span class="keyword">new</span> MapUITypeDisplayData(MapUIType.MonsterActiveRadius, <span class="string">&quot;MonsterActiveRadius&quot;</span>, <span class="string">&quot;警戒半径&quot;</span>, MapEditorConst.InspectorDataMonsterActiveRediusUIWidth, MapStyles.TabMiddleStyle),</span><br><span class="line">    ******</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
</li>
<li><p>新增属性GUI显示代码(MapEditor.cs)</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 绘制单个地图埋点属性，索引，地图埋点类型和现实数据的数据</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;mapDataProperty&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;mapDataIndex&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;mapDataType&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;mapUITypeDisplayData&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">DrawOneMapDataPropertyByData</span>(<span class="params">SerializedProperty mapDataProperty, <span class="built_in">int</span> mapDataIndex, MapDataType mapDataType, MapUITypeDisplayData mapUITypeDisplayData</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    ******</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (mapUIType == MapUIType.MonsterCreateRadius)</span><br><span class="line">    &#123;</span><br><span class="line">        DrawFloatChangeMapDataProperty(mapDataIndex, property, propertyName, MapEditorConst.InspectorDataMonsterCreateRadiusUIWidth);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (mapUIType == MapUIType.MonsterActiveRadius)</span><br><span class="line">    &#123;</span><br><span class="line">        DrawFloatChangeMapDataProperty(mapDataIndex, property, propertyName, MapEditorConst.InspectorDataMonsterActiveRediusUIWidth);</span><br><span class="line">    &#125;</span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>至此我们成功添加了自定义埋点数据类型和DIY数据显示，接下来就是数据导出。</p>
<p><img src="/img/Unity/MapEditor/MonsterMapDataUIOperation.PNG" alt="MonsterMapDataUIOperation"></p>
</li>
</ol>
<p>Note:</p>
<ol>
<li><strong>公共UI类型是否显示定义在MapEditorUtilities.CommonMapUITypeMap里，自定义UI类型是否显示定义在MapEditorUtilities.MapFoldAndUITypeMap里</strong></li>
</ol>
<h4 id="新增地图埋点数据导出"><a href="#新增地图埋点数据导出" class="headerlink" title="新增地图埋点数据导出"></a>新增地图埋点数据导出</h4><ol>
<li><p>新增怪物导出数据定义(MonsterMapDataExport.cs)</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> MonsterMapDataExport.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 怪物地图埋点数据导出</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">Serializable</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MonsterMapDataExport</span> : <span class="title">BaseMapDataExport</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 怪物创建半径</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">float</span> MonsterCreateRadius;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 怪物警戒半径</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">float</span> MonsterActiveRadius;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MonsterMapDataExport</span>(<span class="params">MapDataType mapDataType, <span class="built_in">int</span> confId, Vector3 position,  Vector3 rotation, <span class="built_in">float</span> monsterCreateRadius, <span class="built_in">float</span> monsterActiveRadius</span>)</span></span><br><span class="line"><span class="function">        : <span class="title">base</span>(<span class="params">mapDataType, confId, position, rotation</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            MonsterCreateRadius = monsterCreateRadius;</span><br><span class="line">            MonsterActiveRadius = monsterActiveRadius;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>导出数据添加怪物导出数据定义(MapExport.cs)</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> MapExport.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 地图导出数据结构定义(统一导出结构定义，方便支持导出不同的数据格式)</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">Serializable</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MapExport</span></span><br><span class="line">&#123;</span><br><span class="line">    ******</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 所有怪物导出数据列表</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> List&lt;MonsterMapDataExport&gt; ALlMonsterMapDatas = <span class="keyword">new</span> List&lt;MonsterMapDataExport&gt;();</span><br><span class="line">    </span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>构建导出数据并填充到怪物导出数据列表里(MapExportEditorUtilities.cs)</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 指定地图埋点数据列表更新地图导出数据</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;mapExport&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;map&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">UpdateMapExportByMapDatas</span>(<span class="params">MapExport mapExport, Map map</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span>(map?.MapDataList == <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> mapDatas = map.MapDataList;</span><br><span class="line">    <span class="keyword">var</span> mapDataTypeDatasMap = GetMapDataTypeDatas(mapDatas);</span><br><span class="line">    ******</span><br><span class="line">        List&lt;MapData&gt; monsterDatas;</span><br><span class="line">    <span class="keyword">if</span> (mapDataTypeDatasMap.TryGetValue(MapDataType.Monster, <span class="keyword">out</span> monsterDatas))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> monsterData <span class="keyword">in</span> monsterDatas)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> monsterMapDataExport = GetMonsterMapDataExport(monsterData);</span><br><span class="line">            mapExport.ALlMonsterMapDatas.Add(monsterMapDataExport);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 获取指定地图埋点数据的地图埋点怪物导出数据</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;mapData&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> MonsterMapDataExport <span class="title">GetMonsterMapDataExport</span>(<span class="params">MapData mapData</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (mapData == <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        Debug.LogError(<span class="string">&quot;不允许获取空地图埋点数据的地图埋点怪物导出数据失败！&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> mapDataUID = mapData.UID;</span><br><span class="line">    <span class="keyword">var</span> mapDataConfig = MapSetting.GetEditorInstance().DataSetting.GetMapDataConfigByUID(mapDataUID);</span><br><span class="line">    <span class="keyword">if</span> (mapDataConfig == <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        Debug.LogError(<span class="string">$&quot;找不到地图埋点UID:<span class="subst">&#123;mapDataUID&#125;</span>的配置，获取地图埋点怪物导出数据失败！&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> monsterMapData = mapData <span class="keyword">as</span> MonsterMapData;</span><br><span class="line">    <span class="keyword">var</span> monsterCreateRadius = monsterMapData.MonsterCreateRadius;</span><br><span class="line">    <span class="keyword">var</span> monsterActiveRadius = monsterMapData.MonsterActiveRadius;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> MonsterMapDataExport(mapDataConfig.DataType, mapDataConfig.ConfId, mapData.Position, mapData.Rotation, monsterCreateRadius, monsterActiveRadius);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后MapExport导出时，数据就会序列化到Json:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;MapData&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">     <span class="attr">&quot;Width&quot;</span><span class="punctuation">:</span> <span class="number">8</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;Height&quot;</span><span class="punctuation">:</span> <span class="number">40</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;StartPos&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;BirthPos&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">3.0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="number">3.0</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;GameVirtualCameraInitPos&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">3.0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">15.0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="number">-10.0</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;GridSize&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;ALlMonsterMapDatas&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;MapDataType&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;ConfId&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Position&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">3.0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="number">15.0</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Roation&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;MonsterCreateRadius&quot;</span><span class="punctuation">:</span> <span class="number">8.0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;MonsterActiveRadius&quot;</span><span class="punctuation">:</span> <span class="number">5.0</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;MapDataType&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;ConfId&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Position&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">3.0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="number">20.0</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Roation&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;MonsterCreateRadius&quot;</span><span class="punctuation">:</span> <span class="number">8.0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;MonsterActiveRadius&quot;</span><span class="punctuation">:</span> <span class="number">5.0</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    ******</span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h4 id="新增地图埋点数据读取"><a href="#新增地图埋点数据读取" class="headerlink" title="新增地图埋点数据读取"></a>新增地图埋点数据读取</h4><p>完成埋点数据导出后，接下来就是数据读取(MapGameManager.cs)</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 加载关卡配置</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">LoadLevelConfig</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> levelTxtAsset = Resources.Load&lt;TextAsset&gt;(MapGameConst.LevelConfigPath);</span><br><span class="line">    <span class="keyword">if</span> (levelTxtAsset == <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        Debug.LogError(<span class="string">$&quot;关卡配置:<span class="subst">&#123;MapGameConst.LevelConfigPath&#125;</span>加载失败！&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        LevelConfig = JsonUtility.FromJson&lt;MapExport&gt;(levelTxtAsset.text);</span><br><span class="line">    &#125;</span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后通过MapGameManager.Singleton.LevelConfig.ALlMonsterMapDatas即可访问导出的怪物埋点数据了。</p>
<h3 id="摄像机可见范围可视化"><a href="#摄像机可见范围可视化" class="headerlink" title="摄像机可见范围可视化"></a>摄像机可见范围可视化</h3><p>摄像机的可见范围计算原理：</p>
<ul>
<li>不考虑摄像机是正交还是透视，通过将屏幕四个角映射到世界坐标系(屏幕坐标到世界坐标)，得到从摄像机到摄像机四个角的射线数据。</li>
</ul>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 四个角的视口坐标</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Vector3[] ViewPortPoints = <span class="keyword">new</span> Vector3[<span class="number">5</span>]</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">new</span> Vector3(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>),        <span class="comment">// 左下角</span></span><br><span class="line">    <span class="keyword">new</span> Vector3(<span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>),        <span class="comment">// 左上角</span></span><br><span class="line">    <span class="keyword">new</span> Vector3(<span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>),        <span class="comment">// 右上角</span></span><br><span class="line">    <span class="keyword">new</span> Vector3(<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>),        <span class="comment">// 右下角</span></span><br><span class="line">    <span class="keyword">new</span> Vector3(<span class="number">0.5f</span>, <span class="number">0.5f</span>, <span class="number">0</span>),  <span class="comment">// 中心</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 获取指定摄像机的射线数据列表</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;camera&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;rayCastDataList&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">bool</span> <span class="title">GetCameraRayCastDataList</span>(<span class="params">Camera camera, <span class="keyword">ref</span> List&lt;KeyValuePair&lt;Vector3, Vector3&gt;&gt; rayCastDataList</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    rayCastDataList.Clear();</span><br><span class="line">    <span class="keyword">if</span>(camera == <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        Debug.LogError(<span class="string">$&quot;不允许传递空摄像机组件，获取摄像机的射线数据列表失败！&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> cameraNearClipPlane = camera.nearClipPlane;</span><br><span class="line">    ViewPortPoints[<span class="number">0</span>].z = cameraNearClipPlane;</span><br><span class="line">    ViewPortPoints[<span class="number">1</span>].z = cameraNearClipPlane;</span><br><span class="line">    ViewPortPoints[<span class="number">2</span>].z = cameraNearClipPlane;</span><br><span class="line">    ViewPortPoints[<span class="number">3</span>].z = cameraNearClipPlane;</span><br><span class="line">    ViewPortPoints[<span class="number">4</span>].z = cameraNearClipPlane;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> isOrthographic = camera.orthographic;</span><br><span class="line">    <span class="keyword">if</span>(isOrthographic)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 转换为射线</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; ViewPortPoints.Length; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            Ray ray = camera.ViewportPointToRay(ViewPortPoints[i]);</span><br><span class="line">            <span class="keyword">var</span> rayCastToPoint = ray.origin + ray.direction * camera.farClipPlane;</span><br><span class="line">            <span class="keyword">var</span> rayCastData = <span class="keyword">new</span> KeyValuePair&lt;Vector3, Vector3&gt;(ray.origin, rayCastToPoint);</span><br><span class="line">            rayCastDataList.Add(rayCastData);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> radio = camera.farClipPlane / cameraNearClipPlane;</span><br><span class="line">        <span class="keyword">var</span> cameraPosition = camera.transform.position;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取饰扣四个角的屏幕映射世界坐标</span></span><br><span class="line">        <span class="keyword">var</span> lbNearPlaneWorldPoints = camera.ViewportToWorldPoint(ViewPortPoints[<span class="number">0</span>]);</span><br><span class="line">        <span class="keyword">var</span> ltNearPlaneWorldPoints = camera.ViewportToWorldPoint(ViewPortPoints[<span class="number">1</span>]);</span><br><span class="line">        <span class="keyword">var</span> rtNearPlaneWorldPoints = camera.ViewportToWorldPoint(ViewPortPoints[<span class="number">2</span>]);</span><br><span class="line">        <span class="keyword">var</span> rbNearPlaneWorldPoints = camera.ViewportToWorldPoint(ViewPortPoints[<span class="number">3</span>]);</span><br><span class="line">        <span class="keyword">var</span> ctNearPlaneWorldPoints = camera.ViewportToWorldPoint(ViewPortPoints[<span class="number">4</span>]);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> lbNearPlaneCameraWorldPointDir = lbNearPlaneWorldPoints - cameraPosition;</span><br><span class="line">        <span class="keyword">var</span> ltNearPlaneCameraWorldPointDir = ltNearPlaneWorldPoints - cameraPosition;</span><br><span class="line">        <span class="keyword">var</span> rtNearPlaneCameraWorldPointDir = rtNearPlaneWorldPoints - cameraPosition;</span><br><span class="line">        <span class="keyword">var</span> rbNearPlaneCameraWorldPointDir = rbNearPlaneWorldPoints - cameraPosition;</span><br><span class="line">        <span class="keyword">var</span> ctNearPlaneCameraWorldPointDir = ctNearPlaneWorldPoints - cameraPosition;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> lbFarPlaneWorldPoint = cameraPosition + lbNearPlaneCameraWorldPointDir * radio;</span><br><span class="line">        <span class="keyword">var</span> ltFarPlaneWorldPoint = cameraPosition + ltNearPlaneCameraWorldPointDir * radio;</span><br><span class="line">        <span class="keyword">var</span> rtFarPlaneWorldPoint = cameraPosition + rtNearPlaneCameraWorldPointDir * radio;</span><br><span class="line">        <span class="keyword">var</span> rbFarPlaneWorldPoint = cameraPosition + rbNearPlaneCameraWorldPointDir * radio;</span><br><span class="line">        <span class="keyword">var</span> ctFarPlaneWorldPoint = cameraPosition + ctNearPlaneCameraWorldPointDir * radio;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> lbRayCastData = <span class="keyword">new</span> KeyValuePair&lt;Vector3, Vector3&gt;(lbNearPlaneWorldPoints, lbFarPlaneWorldPoint);</span><br><span class="line">        <span class="keyword">var</span> ltRayCastData = <span class="keyword">new</span> KeyValuePair&lt;Vector3, Vector3&gt;(ltNearPlaneWorldPoints, ltFarPlaneWorldPoint);</span><br><span class="line">        <span class="keyword">var</span> rtRayCastData = <span class="keyword">new</span> KeyValuePair&lt;Vector3, Vector3&gt;(rtNearPlaneWorldPoints, rtFarPlaneWorldPoint);</span><br><span class="line">        <span class="keyword">var</span> rbRayCastData = <span class="keyword">new</span> KeyValuePair&lt;Vector3, Vector3&gt;(rbNearPlaneWorldPoints, rbFarPlaneWorldPoint);        </span><br><span class="line">        <span class="keyword">var</span> ctRayCastData = <span class="keyword">new</span> KeyValuePair&lt;Vector3, Vector3&gt;(ctNearPlaneWorldPoints, ctFarPlaneWorldPoint);        </span><br><span class="line">        rayCastDataList.Add(lbRayCastData);</span><br><span class="line">        rayCastDataList.Add(ltRayCastData);</span><br><span class="line">        rayCastDataList.Add(rtRayCastData);</span><br><span class="line">        rayCastDataList.Add(rbRayCastData);</span><br><span class="line">        rayCastDataList.Add(ctRayCastData);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>得到屏幕四个角映射的射线数据后，利用射线和平面的交叉计算得到指定平面交叉的点就能得到我们要的平面照射区域</li>
</ul>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Vector3Utilities.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Vector3静态工具类</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">Vector3Utilities</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 获取指定射线和平面数据的交叉点(返回null表示没有交叉点)</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;rayOrigin&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;rayDirection&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;planePoint&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;planeNormal&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Vector3? GetRayAndPlaneIntersect(Vector3 rayOrigin, Vector3 rayDirection, Vector3 planePoint, Vector3 planeNormal)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 计算法向量和方向向量的点积</span></span><br><span class="line">        <span class="built_in">float</span> ndotu = Vector3.Dot(planeNormal, rayDirection);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 向量几乎平行，可能没有交点或者射线在平面内</span></span><br><span class="line">        <span class="keyword">if</span> (Mathf.Approximately(Math.Abs(ndotu), Mathf.Epsilon))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 计算 t</span></span><br><span class="line">        Vector3 w = rayOrigin - planePoint;</span><br><span class="line">        <span class="built_in">float</span> t = -Vector3.Dot(planeNormal, w) / ndotu;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 交点在射线起点的后面</span></span><br><span class="line">        <span class="keyword">if</span> (t &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 计算交点</span></span><br><span class="line">        Vector3 intersectionPoint = rayOrigin + t * rayDirection;</span><br><span class="line">        <span class="keyword">return</span> intersectionPoint;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 获取指定摄像机指定区域顶点和法线的的可视区域顶点数据</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;camera&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;areaPoint&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;areaNormal&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;areaPointsList&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;rectPointList&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">bool</span> <span class="title">GetCameraVisibleArea</span>(<span class="params">Camera camera, Vector3 areaPoint, Vector3 areaNormal, <span class="keyword">ref</span> List&lt;Vector3&gt; areaPointsList, <span class="keyword">ref</span> List&lt;Vector3&gt; rectPointList</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    areaPointsList.Clear();</span><br><span class="line">    rectPointList.Clear();</span><br><span class="line">    <span class="keyword">if</span> (camera == <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        Debug.LogError(<span class="string">$&quot;不允许传递空摄像机组件，获取摄像机的可视区域顶点数据失败！&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    RayCastDataList.Clear();</span><br><span class="line">    GetCameraRayCastDataList(camera, <span class="keyword">ref</span> RayCastDataList);</span><br><span class="line">    <span class="keyword">foreach</span>(<span class="keyword">var</span> rayCastData <span class="keyword">in</span> RayCastDataList)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> rayCastDirection = rayCastData.Value - rayCastData.Key;</span><br><span class="line">        <span class="keyword">var</span> areaData = Vector3Utilities.GetRayAndPlaneIntersect(rayCastData.Key, rayCastDirection, areaPoint, areaNormal);</span><br><span class="line">        <span class="keyword">if</span>(areaData != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            areaPointsList.Add((Vector3)areaData);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    rectPointList.Add(<span class="keyword">new</span> Vector3(areaPointsList[<span class="number">1</span>].x, areaPointsList[<span class="number">0</span>].y, areaPointsList[<span class="number">0</span>].z));</span><br><span class="line">    rectPointList.Add(<span class="keyword">new</span> Vector3(areaPointsList[<span class="number">1</span>].x, areaPointsList[<span class="number">1</span>].y, areaPointsList[<span class="number">1</span>].z));</span><br><span class="line">    rectPointList.Add(<span class="keyword">new</span> Vector3(areaPointsList[<span class="number">2</span>].x, areaPointsList[<span class="number">2</span>].y, areaPointsList[<span class="number">2</span>].z));</span><br><span class="line">    rectPointList.Add(<span class="keyword">new</span> Vector3(areaPointsList[<span class="number">2</span>].x, areaPointsList[<span class="number">3</span>].y, areaPointsList[<span class="number">3</span>].z));</span><br><span class="line">    rectPointList.Add(areaPointsList[<span class="number">4</span>]);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从上面可以看到无论是areaPointsList还是rectPointList都返回了5个顶点数据，第五个是屏幕中心映射的点。</p>
<p><strong>之所以返回矩形的映射区域，是为了简化后面透视摄像机梯形判定顶点复杂度，简化成AABB和点的交叉判定。</strong></p>
<ul>
<li>得到了屏幕映射的顶点数据，通过构建线条数据，我们就能利用GUI相关接口画出可视化可见区域了</li>
</ul>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 区域顶点</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">Header(<span class="string">&quot;区域顶点&quot;</span>)</span>]</span><br><span class="line"><span class="keyword">public</span> Vector3 AreaPoint = Vector3.zero;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 区域法线</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">Header(<span class="string">&quot;区域法线&quot;</span>)</span>]</span><br><span class="line"><span class="keyword">public</span> Vector3 AreaNormal = Vector3.up;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 更新摄像机指定平面映射区域数据</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">UpdateAreaDatas</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    CameraUtilities.GetCameraRayCastDataList(mCameraComponent, <span class="keyword">ref</span> mRayCastDataList);</span><br><span class="line">    CameraUtilities.GetCameraVisibleArea(mCameraComponent, AreaPoint, AreaNormal, <span class="keyword">ref</span> mAreaPointsList, <span class="keyword">ref</span> mRectAreaPointsList);</span><br><span class="line">    mAreaLinesList.Clear();</span><br><span class="line">    mRectAreaLinesList.Clear();</span><br><span class="line">    <span class="keyword">if</span>(mAreaPointsList.Count &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> lbToLtLine = <span class="keyword">new</span> KeyValuePair&lt;Vector3, Vector3&gt;(mAreaPointsList[<span class="number">0</span>], mAreaPointsList[<span class="number">1</span>]);</span><br><span class="line">        <span class="keyword">var</span> ltToRtLine = <span class="keyword">new</span> KeyValuePair&lt;Vector3, Vector3&gt;(mAreaPointsList[<span class="number">1</span>], mAreaPointsList[<span class="number">2</span>]);</span><br><span class="line">        <span class="keyword">var</span> rtToRbLine = <span class="keyword">new</span> KeyValuePair&lt;Vector3, Vector3&gt;(mAreaPointsList[<span class="number">2</span>], mAreaPointsList[<span class="number">3</span>]);</span><br><span class="line">        <span class="keyword">var</span> rbToLbLine = <span class="keyword">new</span> KeyValuePair&lt;Vector3, Vector3&gt;(mAreaPointsList[<span class="number">3</span>], mAreaPointsList[<span class="number">0</span>]);</span><br><span class="line">        mAreaLinesList.Add(lbToLtLine);</span><br><span class="line">        mAreaLinesList.Add(ltToRtLine);</span><br><span class="line">        mAreaLinesList.Add(rtToRbLine);</span><br><span class="line">        mAreaLinesList.Add(rbToLbLine);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> rectLbToLtLine = <span class="keyword">new</span> KeyValuePair&lt;Vector3, Vector3&gt;(mRectAreaPointsList[<span class="number">0</span>], mRectAreaPointsList[<span class="number">1</span>]);</span><br><span class="line">        <span class="keyword">var</span> rectLtToRtLine = <span class="keyword">new</span> KeyValuePair&lt;Vector3, Vector3&gt;(mRectAreaPointsList[<span class="number">1</span>], mRectAreaPointsList[<span class="number">2</span>]);</span><br><span class="line">        <span class="keyword">var</span> rectRtToRbLine = <span class="keyword">new</span> KeyValuePair&lt;Vector3, Vector3&gt;(mRectAreaPointsList[<span class="number">2</span>], mRectAreaPointsList[<span class="number">3</span>]);</span><br><span class="line">        <span class="keyword">var</span> rectRbToLbLine = <span class="keyword">new</span> KeyValuePair&lt;Vector3, Vector3&gt;(mRectAreaPointsList[<span class="number">3</span>], mRectAreaPointsList[<span class="number">0</span>]);</span><br><span class="line">        mRectAreaLinesList.Add(rectLbToLtLine);</span><br><span class="line">        mRectAreaLinesList.Add(rectLtToRtLine);</span><br><span class="line">        mRectAreaLinesList.Add(rectRtToRbLine);</span><br><span class="line">        mRectAreaLinesList.Add(rectRbToLbLine);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 绘制区域信息Gizmos</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">DrawAreaInfoGUI</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> preGizmosColor = Gizmos.color;</span><br><span class="line">    Gizmos.color = Color.green;</span><br><span class="line">    Gizmos.DrawSphere(AreaPoint, SphereSize);</span><br><span class="line">    <span class="keyword">var</span> areaPointTo = AreaPoint + AreaNormal * <span class="number">5</span>;</span><br><span class="line">    Gizmos.DrawLine(AreaPoint, areaPointTo);</span><br><span class="line">    Gizmos.color = preGizmosColor;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 绘制矩形区域</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">DrawRectAreaGUI</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> preGizmosColor = Gizmos.color;</span><br><span class="line">    Gizmos.color = <span class="keyword">new</span> Color(<span class="number">0</span>, <span class="number">0.5f</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(mRectAreaLinesList.Count &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        Gizmos.DrawLine(mRectAreaLinesList[<span class="number">0</span>].Key, mRectAreaLinesList[<span class="number">0</span>].Value);</span><br><span class="line">        Gizmos.DrawLine(mRectAreaLinesList[<span class="number">1</span>].Key, mRectAreaLinesList[<span class="number">1</span>].Value);</span><br><span class="line">        Gizmos.DrawLine(mRectAreaLinesList[<span class="number">2</span>].Key, mRectAreaLinesList[<span class="number">2</span>].Value);</span><br><span class="line">        Gizmos.DrawLine(mRectAreaLinesList[<span class="number">3</span>].Key, mRectAreaLinesList[<span class="number">3</span>].Value);</span><br><span class="line">    &#125;</span><br><span class="line">    Gizmos.color = preGizmosColor;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 绘制区域Gizmos</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">DrawAreaGUI</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> preGizmosColor = Gizmos.color;</span><br><span class="line">    Gizmos.color = Color.green;</span><br><span class="line">    <span class="keyword">if</span>(mAreaLinesList.Count &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        Gizmos.DrawLine(mAreaLinesList[<span class="number">0</span>].Key, mAreaLinesList[<span class="number">0</span>].Value);</span><br><span class="line">        Gizmos.DrawLine(mAreaLinesList[<span class="number">1</span>].Key, mAreaLinesList[<span class="number">1</span>].Value);</span><br><span class="line">        Gizmos.DrawLine(mAreaLinesList[<span class="number">2</span>].Key, mAreaLinesList[<span class="number">2</span>].Value);</span><br><span class="line">        Gizmos.DrawLine(mAreaLinesList[<span class="number">3</span>].Key, mAreaLinesList[<span class="number">3</span>].Value);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(mAreaPointsList.Count &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        Gizmos.DrawSphere(mAreaPointsList[<span class="number">4</span>], SphereSize);</span><br><span class="line">    &#125;</span><br><span class="line">    Gizmos.color = preGizmosColor;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>摄像机照射区域可视化：</p>
<p><img src="/img/Unity/MapEditor/CameraAreaVisualization.PNG" alt="CameraAreaVisualization"></p>
<p><strong>可以看到黄色是远截面照射区域，深绿色是近截面照射区域，浅绿色是摄像机近截面换算成矩形后的区域，红色线条是摄像机近截面和远截面射线，</strong></p>
<p>Note:</p>
<ol>
<li><strong>屏幕4个顶点计算顺序依次是左下，左上，右上，右下</strong></li>
</ol>
<h3 id="摄像机可见范围动态创建和销毁"><a href="#摄像机可见范围动态创建和销毁" class="headerlink" title="摄像机可见范围动态创建和销毁"></a>摄像机可见范围动态创建和销毁</h3><p>前面我们已经成功得到了摄像机照射范围映射到指定平面映射顶点数据，接下来就是通过埋点对象数据的位置结合摄像机映射数据，通过判定AABB和点的交互决定指定地图埋点数据是否可见，从而决定是否创建或移除相关地图埋点数据的对象数据。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 2D AABB定义</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">Serializable</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">struct</span> AABB2D</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 中心点位置</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;中心点位置&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> Vector2 Center;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 宽和高</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;宽和高&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> Vector2 Extents;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AABB2D</span>(<span class="params">Vector2 center, Vector2 extents</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Center = center;</span><br><span class="line">        Extents = extents;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> MapGameConst.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 游戏常量</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">MapGameConst</span></span><br><span class="line">&#123;</span><br><span class="line">    *******</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 区域顶点</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">readonly</span> Vector3 AreaPoint = Vector3.zero;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 区域法线</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">readonly</span> Vector3 AreaNormal = Vector3.up;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> MapObjectEntitySpawnSystem.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 地图对象Entity生成系统</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MapObjectEntitySpawnSystem</span> : <span class="title">BaseSystem</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 摄像机指定平面映射区域顶点数据列表</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> List&lt;Vector3&gt; mAreaPointsList = <span class="keyword">new</span> List&lt;Vector3&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 摄像机指定平面映射矩形区域顶点数据列表</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> List&lt;Vector3&gt; mRectAreaPointsList = <span class="keyword">new</span> List&lt;Vector3&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 已生成的BaseMapDataExport数据和对应Entity Uuid Map</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> Dictionary&lt;BaseMapDataExport, <span class="built_in">int</span>&gt; mSpawnedMapDataEntityMap = <span class="keyword">new</span> Dictionary&lt;BaseMapDataExport, <span class="built_in">int</span>&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 临时需要移除的地图埋点导出数据列表</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> List&lt;BaseMapDataExport&gt; mTempRemoveSpawnedMapDataExportList = <span class="keyword">new</span> List&lt;BaseMapDataExport&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 摄像机矩形区域</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> AABB2D mCameraRectArea = <span class="keyword">new</span> AABB2D();</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 地图埋点临时Vector2位置数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> Vector2 mTempMapDataExportPos = <span class="keyword">new</span> Vector2();</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 指定MapDataExport数据是否已生成Entity</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;mapDataExport&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="built_in">bool</span> <span class="title">IsMapDataSpawned</span>(<span class="params">BaseMapDataExport mapDataExport</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> mSpawnedMapDataEntityMap.ContainsKey(mapDataExport);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 添加指定地图埋点数据和对应生成Entity Uuid</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;mapDataExport&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;uuid&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="built_in">bool</span> <span class="title">AddMapDataSpawnedEntityUuid</span>(<span class="params">BaseMapDataExport mapDataExport, <span class="built_in">int</span> uuid</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(IsMapDataSpawned(mapDataExport))</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">$&quot;MapDataExport.MapDataType:<span class="subst">&#123;mapDataExport.MapDataType&#125;</span>,MapDataExport.ConfId:<span class="subst">&#123;mapDataExport.ConfId&#125;</span>已生成Entity，添加生成Entity Uuid:<span class="subst">&#123;uuid&#125;</span>失败！&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        mSpawnedMapDataEntityMap.Add(mapDataExport, uuid);</span><br><span class="line">        Debug.Log(<span class="string">$&quot;添加MapDataExport.MapDataType:<span class="subst">&#123;mapDataExport.MapDataType&#125;</span>,MapDataExport.ConfId:<span class="subst">&#123;mapDataExport.ConfId&#125;</span>的生成Entity Uuid:<span class="subst">&#123;uuid&#125;</span>成功！&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 移除指定地图埋点数据的Entity生成数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;mapDataExport&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="built_in">bool</span> <span class="title">RemoveMapDataSpawned</span>(<span class="params">BaseMapDataExport mapDataExport</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">int</span> uuid;</span><br><span class="line">        <span class="keyword">if</span>(mSpawnedMapDataEntityMap.TryGetValue(mapDataExport, <span class="keyword">out</span> uuid))</span><br><span class="line">        &#123;</span><br><span class="line">            mSpawnedMapDataEntityMap.Remove(mapDataExport);</span><br><span class="line">            Debug.Log(<span class="string">$&quot;移除MapDataExport.MapDataType:<span class="subst">&#123;mapDataExport.MapDataType&#125;</span>,MapDataExport.ConfId:<span class="subst">&#123;mapDataExport.ConfId&#125;</span>的生成Entity Uuid:<span class="subst">&#123;uuid&#125;</span>成功！&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        Debug.LogError(<span class="string">$&quot;MapDataExport.MapDataType:<span class="subst">&#123;mapDataExport.MapDataType&#125;</span>,MapDataExport.ConfId:<span class="subst">&#123;mapDataExport.ConfId&#125;</span>未生成对应Entity，移除Entity Uuid:<span class="subst">&#123;uuid&#125;</span>失败！&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Entity过滤</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;entity&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="built_in">bool</span> <span class="title">Filter</span>(<span class="params">BaseEntity entity</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> entityType = entity.EntityType;</span><br><span class="line">        <span class="keyword">return</span> entityType == EntityType.Camera;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Entity处理</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;entity&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;deltaTime&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Process</span>(<span class="params">BaseEntity entity, <span class="built_in">float</span> deltaTime</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">base</span>.Process(entity, deltaTime);</span><br><span class="line">        <span class="keyword">var</span> cameraEntity = entity <span class="keyword">as</span> CameraEntity;</span><br><span class="line">        <span class="keyword">if</span>(!cameraEntity.SyncPosition)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        UpdateCameraDatas();</span><br><span class="line">        CheckAllMapDataExportEntitySpawn();</span><br><span class="line">        CheckAllSpawnEntityRemove();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 更新摄像机数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">UpdateCameraDatas</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> mainCamera = MapGameManager.Singleton.MainCamera;</span><br><span class="line">        CameraUtilities.GetCameraVisibleArea(mainCamera, MapGameConst.AreaPoint, MapGameConst.AreaNormal, <span class="keyword">ref</span> mAreaPointsList, <span class="keyword">ref</span> mRectAreaPointsList);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> minX = Math.Min(mRectAreaPointsList[<span class="number">0</span>].x, mRectAreaPointsList[<span class="number">1</span>].x);</span><br><span class="line">        <span class="keyword">var</span> maxX = Math.Max(mRectAreaPointsList[<span class="number">2</span>].x, mRectAreaPointsList[<span class="number">3</span>].x);</span><br><span class="line">        <span class="keyword">var</span> minZ = Math.Min(mRectAreaPointsList[<span class="number">0</span>].z, mRectAreaPointsList[<span class="number">3</span>].z);</span><br><span class="line">        <span class="keyword">var</span> maxZ = Math.Max(mRectAreaPointsList[<span class="number">1</span>].z, mRectAreaPointsList[<span class="number">2</span>].z);</span><br><span class="line">        <span class="keyword">var</span> width = maxX - minX;</span><br><span class="line">        <span class="keyword">var</span> height = maxZ - minZ;</span><br><span class="line">        <span class="keyword">var</span> centerX = mRectAreaPointsList[<span class="number">1</span>].X + width / <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">var</span> centerZ = mRectAreaPointsList[<span class="number">0</span>].Z + height / <span class="number">2</span>;</span><br><span class="line">        mCameraRectArea.Center.x = centerX;</span><br><span class="line">        mCameraRectArea.Center.y = centerZ;</span><br><span class="line">        mCameraRectArea.Extents.x = width;</span><br><span class="line">        mCameraRectArea.Extents.y = height;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 检查地图埋点导出数据Entity生成</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">CheckAllMapDataExportEntitySpawn</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> allMonsterMapDatas = MapGameManager.Singleton.LevelConfig.ALlMonsterMapDatas;</span><br><span class="line">        <span class="keyword">var</span> allTreasureBoxMapDatas = MapGameManager.Singleton.LevelConfig.AllTreasureBoxMapDatas;</span><br><span class="line">        <span class="keyword">var</span> allTrapMapDatas = MapGameManager.Singleton.LevelConfig.AllTrapMapDatas;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> monsterMapDataExport <span class="keyword">in</span> allMonsterMapDatas)</span><br><span class="line">        &#123;</span><br><span class="line">            CheckAllMapDataExportEntitySpawn(monsterMapDataExport);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> treasureBoxMapDataExport <span class="keyword">in</span> allTreasureBoxMapDatas)</span><br><span class="line">        &#123;</span><br><span class="line">            CheckAllMapDataExportEntitySpawn(treasureBoxMapDataExport);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> trapMapDataExport <span class="keyword">in</span> allTrapMapDatas)</span><br><span class="line">        &#123;</span><br><span class="line">            CheckAllMapDataExportEntitySpawn(trapMapDataExport);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 检查指定地图埋点导出数据Entity生成</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;mapDataExport&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">CheckAllMapDataExportEntitySpawn</span>(<span class="params">BaseMapDataExport mapDataExport</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(IsMapDataSpawned(mapDataExport))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> mapDataExportPosition = mapDataExport.Position;</span><br><span class="line">        mTempMapDataExportPos.x = mapDataExportPosition.x;</span><br><span class="line">        mTempMapDataExportPos.y = mapDataExportPosition.z;</span><br><span class="line">        <span class="keyword">if</span>(Collision2DUtilities.PointInAABB(mCameraRectArea, mTempMapDataExportPos))</span><br><span class="line">        &#123;</span><br><span class="line">            BaseEntity entity = <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">var</span> position = mapDataExport.Position;</span><br><span class="line">            <span class="keyword">if</span>(mapDataExport <span class="keyword">is</span> MonsterMapDataExport)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> monsterEntity = OwnerWorld.CreateEtity&lt;MonsterEntity&gt;(MapGameConst.MonsterPrefabPath);</span><br><span class="line">                entity = monsterEntity;</span><br><span class="line">                monsterEntity.SetPosition(position.x, position.y, position.z);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(mapDataExport <span class="keyword">is</span> TreasureBoxMapDataExport)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> treasureEntity = OwnerWorld.CreateEtity&lt;TreasureBoxEntity&gt;(MapGameConst.TreasureBoxPrefabPath);</span><br><span class="line">                entity = treasureEntity;</span><br><span class="line">                treasureEntity.SetPosition(position.x, position.y, position.z);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(mapDataExport <span class="keyword">is</span> TrapMapDataExport)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> trapEntity = OwnerWorld.CreateEtity&lt;TrapEntity&gt;(MapGameConst.TrapPrefabPath);</span><br><span class="line">                entity = trapEntity;</span><br><span class="line">                trapEntity.SetPosition(position.x, position.y, position.z);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                Debug.LogError(<span class="string">$&quot;不支持的MapDataExport类型:<span class="subst">&#123;mapDataExport.GetType().Name&#125;</span>,检测MapDataEntity创建失败！&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(entity != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                AddMapDataSpawnedEntityUuid(mapDataExport, entity.Uuid);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 检查已经生成的Entity回收</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">CheckAllSpawnEntityRemove</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mTempRemoveSpawnedMapDataExportList.Clear();</span><br><span class="line">        <span class="keyword">foreach</span>(<span class="keyword">var</span> spawnedMapDataEntity <span class="keyword">in</span> mSpawnedMapDataEntityMap)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> entityUuid = spawnedMapDataEntity.Value;</span><br><span class="line">            <span class="keyword">var</span> actorEntity = OwnerWorld.GetEntityByUuid&lt;BaseActorEntity&gt;(entityUuid);</span><br><span class="line">            <span class="keyword">if</span> (actorEntity == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">var</span> entityPosition = actorEntity.Position;</span><br><span class="line">            mTempMapDataExportPos.x = entityPosition.x;</span><br><span class="line">            mTempMapDataExportPos.y = entityPosition.z;</span><br><span class="line">            <span class="keyword">if</span>(!Collision2DUtilities.PointInAABB(mCameraRectArea, mTempMapDataExportPos))</span><br><span class="line">            &#123;</span><br><span class="line">                mTempRemoveSpawnedMapDataExportList.Add(spawnedMapDataEntity.Key);</span><br><span class="line">                OwnerWorld.DestroyEntityByUuid(entityUuid);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">foreach</span>(<span class="keyword">var</span> removeSpawnMapDataExport <span class="keyword">in</span> mTempRemoveSpawnedMapDataExportList)</span><br><span class="line">        &#123;</span><br><span class="line">            RemoveMapDataSpawned(removeSpawnMapDataExport);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面的代码已经成功检测到地图埋点位置在可视域就创建，不在可视域就销毁的逻辑。</p>
<p><img src="/img/Unity/MapEditor/DynamicCreateMapData1.PNG" alt="DynamicCreateMapData1"></p>
<p><img src="/img/Unity/MapEditor/DynamicCreateMapData2.PNG" alt="DynamicCreateMapData2"></p>
<p>从截图可以看到近处的两个红色怪物埋点因为超出了摄像机区域后被销毁了，而远处两个宝箱和陷阱因为进入摄像机照射区域而创建显示了。</p>
<h1 id="学习总结"><a href="#学习总结" class="headerlink" title="学习总结"></a>学习总结</h1><ol>
<li><strong>EditorWindow配置编辑器基础可配置数据，Inspector面板提供地图编辑器操作入口和数据序列化存储</strong></li>
<li><strong>地图对象通过序列化位置+旋转+碰撞等数据可以实现场景编辑后一键更新所有场景对象效果</strong></li>
<li><strong>地图对象数据存储可以挂在Mono脚本或自定义数据导出实现场景对象相关配置数据存储和导出</strong></li>
<li><strong>数据埋点显示和操作通过Gizmo和Handles可以实现自己设计的操作交互和显示</strong></li>
<li><strong>摄像机可视域的计算和判定基本上就是数学上的运算</strong></li>
</ol>
<h1 id="Github"><a href="#Github" class="headerlink" title="Github"></a>Github</h1><p><a target="_blank" rel="noopener" href="https://github.com/TonyTang1990/MapEditor">MapEditor</a></p>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a href="http://tonytang1990.github.io/2021/01/21/%E7%A2%B0%E6%92%9E%E6%A3%80%E6%B5%8B/">碰撞检测</a></p>
<p><a href="http://tonytang1990.github.io/2022/02/20/UnityEditor%E7%9F%A5%E8%AF%86/">UnityEditor知识</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Editor/">Editor</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Editor/">Editor</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2023/05/20/UIToolkit学习/" title="UIToolkit" itemprop="url">UIToolkit</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Tony Tang" target="_blank" itemprop="author">Tony Tang</a>
		
  <p class="article-time">
    <time datetime="2023-05-20T00:43:00.000Z" itemprop="datePublished"> 发表于 2023-05-20</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>之前有一篇学习Unity Editor相关的知识:<a href="http://tonytang1990.github.io/2022/02/20/UnityEditor%E7%9F%A5%E8%AF%86">UnityEditor知识</a></p>
<p>UIToolkit作为Unity最新一代UI系统，这里准备单独用篇来学习记录，通过深入学习UIToolkit，为后续编写一套节点系统做准备(用于剧情系统和引导系统实现)。</p>
<p>Note:</p>
<ol>
<li><strong>本章节重点是UIToolkit在Editor上的学习使用，Runtime目前看来UIToolkit还不够成熟，不适合用到Runtime(2023&#x2F;5&#x2F;20)</strong></li>
</ol>
<h1 id="UIToolkit"><a href="#UIToolkit" class="headerlink" title="UIToolkit"></a>UIToolkit</h1><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/2020.3/Documentation/Manual/UIToolkits.html">UI Toolkit is the newest UI system in Unity. It’s designed to optimize performance across platforms, and is based on standard web technologies. You can use UI Toolkit to create extensions for the Unity Editor, and to create runtime UI for games and applications (when you install the UI Toolkit package.</a></p>
<p>看官方介绍可以看出，UI Toolkit是官方推的新一代UI系统，基于Web技术概念的一套UI系统，可用于Editor和运行时通吃。</p>
<p>UI Toolkit由三大部分组成:</p>
<ol>
<li>UI system(<a target="_blank" rel="noopener" href="https://docs.unity3d.com/2020.3/Documentation/Manual/UIElements.html">Contains the core features and functionality required to create user interfaces.</a>)</li>
<li>UI Assets(<a target="_blank" rel="noopener" href="https://docs.unity3d.com/2020.3/Documentation/Manual/UIElements.html">Asset types inspired by standard web formats. Use them to structure and style UI.</a>)(个人理解类似UI布局文件Asset)</li>
<li>Tools and resources(<a target="_blank" rel="noopener" href="https://docs.unity3d.com/2020.3/Documentation/Manual/UIElements.html">Create and debug your interfaces, and learn how to use UI toolkit.</a>)</li>
</ol>
<h2 id="UI-system"><a href="#UI-system" class="headerlink" title="UI  system"></a>UI  system</h2><p>UI系统由以下部分组成:</p>
<ol>
<li>Visual tree(<a target="_blank" rel="noopener" href="https://docs.unity3d.com/2020.3/Documentation/Manual/UIElements.html">Defines every user interface you build with the UI Toolkit. A visual tree is an object graph, made of lightweight nodes, that holds all the elements in a window or panel.</a>)(定义UI界面的数据，包含了所有组成UI显示的成员节点信息)</li>
<li>Controls(<a target="_blank" rel="noopener" href="https://docs.unity3d.com/2020.3/Documentation/Manual/UIElements.html">A library of standard UI controls such as buttons, popups, list views, and color pickers. You can use them as-is, customize them, or create your own controls.</a>)(UI组件)</li>
<li>Data binding system(<a href="">Links properties to the controls that modify their values.</a>)(关联数据属性到UI组件)</li>
<li>Layout Engine(<a target="_blank" rel="noopener" href="https://docs.unity3d.com/2020.3/Documentation/Manual/UIElements.html">A layout system based on the CSS Flexbox model. It positions elements based on layout and styling properties.</a>)(类似CSS的UI布局系统)</li>
<li>Event System(<a target="_blank" rel="noopener" href="https://docs.unity3d.com/2020.3/Documentation/Manual/UIElements.html">Communicates user interactions to elements; for example, input, touch and pointer interactions, drag and drop operations, and other event types. The system includes a dispatcher, a handler, a synthesizer, and a library of event types.</a>)(UI事件系统，负责事件的分发等)</li>
<li>UI Renderer(<a target="_blank" rel="noopener" href="https://docs.unity3d.com/2020.3/Documentation/Manual/UIElements.html">A <strong>rendering</strong> system built directly on top of Unity’s graphics device layer.</a>)(在Unity基础上设计的UI渲染系统)</li>
<li>UI Toolkit Runtime Support(<a target="_blank" rel="noopener" href="https://docs.unity3d.com/2020.3/Documentation/Manual/UIElements.html">Contains the components required to create runtime UI. The UI Toolkit package is currently in preview.</a>)</li>
</ol>
<h3 id="Visual-tree"><a href="#Visual-tree" class="headerlink" title="Visual tree"></a>Visual tree</h3><p>Visual tree由VisualElement组成，VisualElement是所有UI Toolkit的节点基类，VisualElment包含了所有UI组件，排版，UI风格，UI事件处理等数据信息。</p>
<p>UI元素绘制顺序树广度扩展:</p>
<p><img src="/img/Unity/UIToolkit/UIToolkitDrawingOrder.png" alt="UIToolkitDrawingOrder"></p>
<p>UIToolkit里的坐标系分为两种：</p>
<ol>
<li>Relative(position: relative相对坐标系)</li>
<li>Absolute(position: absolute绝对坐标系)</li>
</ol>
<p>上面两个坐标系和Unity里的相对位置和世界位置的概念差不多。</p>
<p>Note:</p>
<ol>
<li><strong>坐标原点在左上角</strong></li>
<li><strong>VisualElementExtensions的扩展方法里提供了坐标系转换相关的方法和接口</strong></li>
</ol>
<h3 id="Layout-Engine"><a href="#Layout-Engine" class="headerlink" title="Layout Engine"></a>Layout Engine</h3><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/2020.3/Documentation/Manual/UIE-LayoutEngine.html">UI Toolkit includes a layout engine that positions visual elements based on layout and styling properties.</a>(UI Toolkit的排版系统是基于VisualElement的排版和Styling属性设置决定的)</p>
<h3 id="UXML-format"><a href="#UXML-format" class="headerlink" title="UXML format"></a>UXML format</h3><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/2020.3/Documentation/Manual/UIE-UXML.html">Unity Extensible Markup Language (UXML) files are text files that define the structure of the user interface. </a>(Unity支持用UXML来描述UI界面组件数据)</p>
<p><strong>可以使用<a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/UIBuilder.html">UI Builder</a>实现可视化布局编辑。</strong></p>
<p><strong>UXML通过代码动态创建的数据对象类为VisualElementAssets。</strong></p>
<p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/UIE-ElementRef.html">UXML现有可用Element查询</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/UIE-uxml-examples.html">UXML布局构建事例</a></p>
<p>深入使用，待学习……</p>
<p>Note:</p>
<ol>
<li><strong>You can’t generate a VisualTreeAsset from raw UXML at runtime.</strong></li>
</ol>
<h3 id="Uity-style-sheets-USS"><a href="#Uity-style-sheets-USS" class="headerlink" title="Uity style sheets(USS)"></a>Uity style sheets(USS)</h3><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/2020.3/Documentation/Manual/UIE-USS.html">Style properties are either set in C# or from a style sheet. Style properties have their own data structure (<code>IStyle</code> interface). UI Toolkit supports style sheets written in USS (Unity style sheet).</a>(Unity支持定义类似CSS的USS文件来定义UI界面使用的Style属性设置)</p>
<p><strong>USS通过代码动态创建的数据对象类为StyleSheet</strong></p>
<p>USS包含以下部分:</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/UIE-about-uss.html">Style rules that include a selector and a declaration block.</a>(个人理解Style定义包含选择器和内容定义)</li>
<li><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/UIE-about-uss.html">Selectors that identify which visual element the style rule affects.</a>(选择器用于匹配Element的Style使用)</li>
<li><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/UIE-about-uss.html">A declaration block, inside curly braces, that has one or more style declarations. Each style declaration has a property and a value. Each style declaration ends with a semi-colon.</a>(内容定义Style的详细配置)</li>
</ol>
<h4 id="USS-Selector"><a href="#USS-Selector" class="headerlink" title="USS Selector"></a>USS Selector</h4><p>Style选择器分有很多种，简单的选择器有:</p>
<h5 id="Type-selector"><a href="#Type-selector" class="headerlink" title="Type selector"></a>Type selector</h5><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/UIE-USS-Selectors-type.html">type selectors match elements based on their element types.</a>(通过类型名字匹配)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Button &#123;</span><br><span class="line">  border-radius: 8px;</span><br><span class="line">  width: 100px;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;Button name=&quot;Cancel&quot; text=&quot;Cancel&quot; /&gt;</span><br></pre></td></tr></table></figure>

<p>Note:</p>
<ul>
<li><strong>type selector的名字不允许包含命名空间</strong></li>
</ul>
<h5 id="Class-selector"><a href="#Class-selector" class="headerlink" title="Class selector"></a>Class selector</h5><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/UIE-USS-Selectors-class.html">class selectors match elements that have specific USS classes assigned. </a>(通过定义类名匹配)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.yellow &#123;</span><br><span class="line">    background-color: yellow;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;Button name=&quot;OK&quot; class=&quot;yellow&quot; text=&quot;OK&quot; /&gt;</span><br></pre></td></tr></table></figure>

<p>Note:</p>
<ul>
<li><strong>calss selector大小写敏感且不允许带数字</strong></li>
</ul>
<h5 id="Name-selector"><a href="#Name-selector" class="headerlink" title="Name selector"></a>Name selector</h5><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/UIE-USS-Selectors-name.html">name selectors match elements based on the name of an element.</a>(通过名字匹配)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#Cancel &#123;</span><br><span class="line">    border-width: 2px;</span><br><span class="line">    border-color: DarkRed;</span><br><span class="line">    background-color: pink;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;Button name=&quot;Cancel&quot; text=&quot;Cancel&quot; /&gt;</span><br></pre></td></tr></table></figure>

<p>Note:</p>
<ul>
<li><strong>代码里可以通过VisualElement.name修改去匹配Name Selector</strong></li>
</ul>
<h5 id="Universal-selector"><a href="#Universal-selector" class="headerlink" title="Universal selector"></a>Universal selector</h5><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/UIE-USS-Selectors-universal.html">universal selector, also called the wildcard selector, matches any element.</a>(通过通配符(正则)去匹配)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">* &#123;</span><br><span class="line">    background-color: yellow;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;VisualElement name=&quot;container1&quot;&gt;</span><br><span class="line">    &lt;VisualElement name=&quot;container2&quot; class=&quot;yellow&quot;&gt;</span><br><span class="line">      &lt;Button name=&quot;OK&quot; class=&quot;yellow&quot; text=&quot;OK&quot; /&gt;</span><br><span class="line">      &lt;Button name=&quot;Cancel&quot; text=&quot;Cancel&quot; /&gt;</span><br><span class="line">&lt;/VisualElement&gt;</span><br></pre></td></tr></table></figure>

<p>更多复杂的选择器参考:</p>
<p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/UIE-about-uss.html">Complex selectors</a></p>
<h4 id="USS-properties"><a href="#USS-properties" class="headerlink" title="USS properties"></a>USS properties</h4><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/UIE-uss-properties.html">USS property assigns a style or behavior to a VisualElement. </a>(USS的内容属性用于给VisualElement指定具体显示配置)</p>
<h5 id="USS-data-types"><a href="#USS-data-types" class="headerlink" title="USS data types"></a>USS data types</h5><p>Syntax - auto, <legnth>,<color>等。</p>
<p>​	如果一个属性有多个值，可以如下方式表达不同含义：</p>
<ul>
<li><p>Side-by-side表示全部都必须按顺序出现</p>
</li>
<li><p>|表示多个选择里必须出现一个</p>
</li>
<li><p>||表示1个或多个必须按顺序出现</p>
</li>
<li><p>&amp;&amp;表示所有都必须出现</p>
</li>
<li><p>[]表示一个选择组(类似正则里[]的概念)</p>
<p>上面提到的属性多个值都支持类似正则里*,+,?,{A,B}的后缀描述，表达的含义也就是类似正则里的出现次数控制。</p>
</li>
</ul>
<p>Length - 支持像素(px)和百分比(%)两种长度单位</p>
<p>initial - 全局关键词，标识重置属性到初始默认值</p>
<p>Color - 支持16进制(#FFFFFF)和rgb表达方式(rgba(255, 255, 255, 1))</p>
<p>​	Color关键词详情查看:</p>
<p>​	<a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/UIE-uss-color-keywords.html">USS color keywords</a></p>
<p>Assets - 支持引用项目里的资源，resource()(标识使用Resources目录资源)，url()(标识使用项目Asset资源，支持相对USS所在目录的相对路径和项目相对路径)</p>
<h5 id="USS-common-properties"><a href="#USS-common-properties" class="headerlink" title="USS common properties"></a>USS common properties</h5><p>在了解一些常规布局属性概念前，让我们先来看看官网给的一张示意图:</p>
<p><img src="/img/Unity/UIToolkit/USSBoxModel.png" alt="USSBoxModel"></p>
<h6 id="宽高属性"><a href="#宽高属性" class="headerlink" title="宽高属性"></a>宽高属性</h6><p>width(宽度)，height(高度)，min-width(最小宽度)，min-height(最小高度)，max-width(最大宽度)，max-height(最大高度)……</p>
<h6 id="边缘-Margins-属性"><a href="#边缘-Margins-属性" class="headerlink" title="边缘(Margins)属性"></a>边缘(Margins)属性</h6><p>margin-left(左侧边缘)，margin-top(顶部边缘)，margin-right(右侧边缘)，margin-bottom(底部边缘)……</p>
<h6 id="边界-Border-属性"><a href="#边界-Border-属性" class="headerlink" title="边界(Border)属性"></a>边界(Border)属性</h6><p>border-left-width(左侧边界)，border-top-width(顶部边界)，border-right-width(右侧边界)，border-bottom-width(底部边界)，border-color(边界颜色)……</p>
<h6 id="内边距-Padding-属性"><a href="#内边距-Padding-属性" class="headerlink" title="内边距(Padding)属性"></a>内边距(Padding)属性</h6><p>padding-left(左侧内边距)，padding-top(顶部内边距)，padding-right(右侧内边距)，padding-bottom(底部内边距)……</p>
<h6 id="排版属性"><a href="#排版属性" class="headerlink" title="排版属性"></a>排版属性</h6><ul>
<li>Items<ul>
<li>flex-grow(排版放大设置)</li>
<li>flex-shrink(排版缩小设置)</li>
<li>flex-basic(排版大小设置)</li>
<li>align-self(自身对齐设置)</li>
<li>……</li>
</ul>
</li>
<li>Containers<ul>
<li>flex-direction(子成员排版对齐方向)</li>
<li>flex-wrap(子成员放不下是否多行显示排版)</li>
<li>align-content(子成员在排版方向上的对齐方式)</li>
<li>……</li>
</ul>
</li>
</ul>
<h6 id="位置属性"><a href="#位置属性" class="headerlink" title="位置属性"></a>位置属性</h6><p>position(位置坐标系-绝对|相对)，left(距离父容器左测距离)，top(距离父容器顶部距离)，right(距离父容器右侧距离)，bottom(距离父容器底部距离)……</p>
<p>UIToolkit里的坐标属性有两种坐标系:</p>
<ol>
<li>绝对坐标</li>
<li>相对坐标</li>
</ol>
<p>Note:</p>
<ol>
<li><strong>设置了Left,Top,Right,Bottom后，Width属性相关设置会被忽略。</strong></li>
</ol>
<h6 id="背景属性"><a href="#背景属性" class="headerlink" title="背景属性"></a>背景属性</h6><p>background-color(背景颜色)，backtground-image(背景图片)，-unity-background-scale-mode(背景图片缩放模式)，-unity-background-image-tint-color(背景图片色调?)……</p>
<h6 id="九宫属性"><a href="#九宫属性" class="headerlink" title="九宫属性"></a>九宫属性</h6><p>-unity-slice-left(左侧切割数值)，-unity-slice-top(顶部切割数值)，-unity-slice-right(右侧切割数值)，-unity-slice-bottom(底部切割数值)，-unity-slice-scale(九宫缩放值?)……</p>
<h6 id="Appearance-外观-属性"><a href="#Appearance-外观-属性" class="headerlink" title="Appearance(外观)属性"></a>Appearance(外观)属性</h6><p>overflow(溢出显示设置),-unity-overflow-clip-box(溢出裁剪box设置),-unity-paragraph-spacing(段落间隔设置),opacity(透明度显示设置),visibility(可见性设置),display(排版显示设置)……</p>
<h6 id="文本属性"><a href="#文本属性" class="headerlink" title="文本属性"></a>文本属性</h6><p>color(绘制颜色设置),-unity-font(绘制文本字体设置),-unity-font-definition(?),font-size(字体大小设置),-unity-font-style(字体风格设置),-unity-text-align(字体对齐设置),-unity-text-overflow-position(?),white-space(空格处理方式设置),-unity-text-outline-width(描边宽度设置),-unity-text-outline-color(描边颜色设置)……</p>
<p>详细USS properties查看:</p>
<p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/UIE-uss-properties.html">USS properties reference</a></p>
<p>W3C CSS的详细属性效果查看:</p>
<p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/CSS">CSS</a></p>
<p>Note:</p>
<ol>
<li><strong><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/UIE-USS-PropertyTypes.html">USS properties use the same syntax as W3C CSS documents</a>(USS的内容属性采用W3C CSS相关文档规则)</strong></li>
<li><strong><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/UIE-USS-SupportedProperties.html">The USS display property supports only a small subset of the CSS <code>display</code> property’s available keyword values.</a>(USS的属性支持只是CSS的很小部分子集)</strong></li>
</ol>
<h4 id="USS-custom-properties"><a href="#USS-custom-properties" class="headerlink" title="USS custom properties"></a>USS custom properties</h4><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/UIE-USS-variables.html">USS variables, also called custom properties, define values that you can reuse in other USS rules. You can create variables for any type of USS property.</a></p>
<p>可以看到USS支持在USS文件里自定义变量，然后像编程里的变量一样，一处定义多处使用。</p>
<p>USS自定义变量规则如下:</p>
<p><strong>–变量名:值</strong></p>
<p>USS自定义变量在其他USS文件访问规则:</p>
<p><strong>var(–变量名, 默认值(可选))</strong></p>
<p>内置自定义变量查询:</p>
<p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/UIE-uss-built-in-variable-reference.html">USS built-in variable references</a></p>
<h4 id="Best-practices-for-USS"><a href="#Best-practices-for-USS" class="headerlink" title="Best practices for USS"></a>Best practices for USS</h4><p>官方关于使用USS Style的建议:</p>
<ol>
<li><strong>Avoid inline styles(个人理解是使用全局USS File，避免对单个Visual Element设置Styles(会导致耗费更多内存))</strong></li>
<li><strong>Selector architecture consideration(选择合适的selector方案，过多或过于复杂的selector方案会导致运行时选择style开销更大)</strong></li>
</ol>
<p>更多建议参考:</p>
<p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/UIE-USS-WritingStyleSheets.html">Best practices for USS</a></p>
<h4 id="Theme-Style-Sheet-TSS"><a href="#Theme-Style-Sheet-TSS" class="headerlink" title="Theme Style Sheet(TSS)"></a>Theme Style Sheet(TSS)</h4><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/UIE-tss.html">Theme Style Sheet (TSS) files are regular USS files. UI Toolkit treats TSS as a distinct asset type and uses it for management purposes.</a></p>
<p>更多学习，待添加……</p>
<h3 id="Query-Elements"><a href="#Query-Elements" class="headerlink" title="Query Elements"></a>Query Elements</h3><p><strong>Unity提供了Query功能(类似Linq)，方便用户快速从VisualTree或Elements里查找符合条件的Element。</strong></p>
<ul>
<li><p>UQuery</p>
<p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/ScriptReference/UIElements.UQuery.html">UQuery is a set of extension methods allowing you to select individual or collection of visualElements inside a complex hierarchy.</a>(一系列扩展方法用于查询指定VisualElements)</p>
</li>
<li><p>UQueryBuilder</p>
<p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/ScriptReference/UIElements.UQueryBuilder_1.html">Utility Object that contructs a set of selection rules to be ran on a root visual element.</a>(工具类，辅助UQuery构建一系列查询规则)</p>
</li>
<li><p>Q</p>
<p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/UIE-UQuery.html">Q is the shorthand for Query<T>.First(). It returns the first element that matches the selection rules.</a>(Q是查询首个符合规则的Element的缩写)</p>
</li>
</ul>
<h3 id="Event-System"><a href="#Event-System" class="headerlink" title="Event System"></a>Event System</h3><h4 id="Dispatch-Events"><a href="#Dispatch-Events" class="headerlink" title="Dispatch Events"></a>Dispatch Events</h4><p>UIToolkit Event System监听系统事件，然后通过EventDispatcher派发事件给Visual Element。</p>
<p>所有的事件派发都会经历以下三个阶段：</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/UIE-Events-Dispatching.html">Trickles down: Events sent to elements during the trickle down phase.</a>(个人没太理解这个阶段，感觉是一个事件捕获<strong>从上往下</strong>派发事件的过程(<strong>不含响应事件的最里层Visual Element</strong>)</li>
<li><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/UIE-Events-Dispatching.html">Bubbles up: Events sent to elements during the bubble-up phase.</a>(事件从目标节点向上冒泡派发给Visual Element的，即最里层符合的Visual Element最先派发(<strong>从下往上</strong>)(<strong>含响应事件最里层Visual Element</strong>))</li>
<li><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/UIE-Events-Dispatching.html">Cancellable: Events that can have their default action execution cancelled, stopped, or prevented.</a>(事件是可取消的，比如一般的事件冒泡为了不继续想外层冒泡，我们会设置事件阻断防止继续冒泡)</li>
</ol>
<p><img src="/img/Unity/UIToolkit/EventPropagation.png" alt="EventPropagation"></p>
<p><strong>通过上面的介绍可以了解到，事件派发有两个流程(Trickles down &amp; Bubbles up)，在不打断事件派发的前提下，最里层响应Visual Element只会派发一次，其他外层传递路线上的Visual Element会派发两次事件。</strong></p>
<p>事件基类为EventBase，所有相关事件介绍参考:</p>
<p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/UIE-Events-Reference.html">Event reference</a></p>
<p>Note:</p>
<ol>
<li><strong><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/UIE-Events.html">The UI Toolkit event system shares the same terminology and event naming as HTML events</a>(UIToolkit采用和HTML一样的事件名和术语)</strong></li>
</ol>
<h4 id="Handle-Events"><a href="#Handle-Events" class="headerlink" title="Handle Events"></a>Handle Events</h4><p>事件处理顺序如下：</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/UIE-Events-Handling.html">Execute event callbacks on elements from the root element down to the parent of the event target. This is the <strong>trickle-down phase</strong> of the dispatch process.</a>(事件捕获阶段从上往下触发事件)</li>
<li><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/UIE-Events-Handling.html">Execute event callbacks on the event target. This is the <strong>target phase</strong> of the dispatch process.</a>(在目标响应Visual Element上触发事件)</li>
<li><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/UIE-Events-Handling.html">Call ExecuteDefaultActionAtTarget() on the event target.</a>(在目标响应Visual Element上触发ExecuteDefaultActionAtTarget()方法)</li>
<li><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/UIE-Events-Handling.html">Execute event callbacks on elements from the event target parent up to the root. This is the <strong>bubble-up phase</strong> of the dispatch process.</a>(从目标Visual Element开始向上冒泡触发事件)</li>
<li><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/UIE-Events-Handling.html">Call ExecuteDefaultAction() on the event target.</a>(在目标响应Visual Element上触发ExecuteDefaultAction()方法)</li>
</ol>
<p>事件响应里有两个重要的概念:</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/UIE-Events-Dispatching.html">Event.currentTarget is the visual element on which the callback was registered.</a>(当前注册响应事件的Visual Element)</li>
<li><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/UIE-Events-Dispatching.html">Event.target is the element where the event occurs, for example the element directly under the mouse.</a>(当前事件发生的Visual Element)</li>
</ul>
<p><strong><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/UIE-Events-Handling.html">By default, a registered callback executes during the target phase and the bubble-up phase. This default behavior ensures that a parent element reacts after its child element.</a>(默认状态下，我们注册的事件回调是在target phase和bubble-up phase阶段执行。这是为了确保事件回调触发是从下往上)</strong></p>
<p>如果我们想在指定阶段(e.g. tickle-down phase或bubble-up phase)触发注册事件回调，我们需要在注册事件回调处，显示传参说明响应阶段:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">VisualElement myElement = <span class="keyword">new</span> VisualElement();</span><br><span class="line"></span><br><span class="line">myElement.RegisterCallback&lt;MouseDownEvent&gt;(MyCallback, TrickleDown.TrickleDown);</span><br></pre></td></tr></table></figure>

<p>如果我们想事件传递自定义数据，我们需要自定义一个含自带数据的方法回调并监听事件：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">myElement.RegisterCallback&lt;MouseDownEvent, MyType&gt;(MyCallbackWithData, myData);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MyCallbackWithData</span>(<span class="params">MouseDownEvent evt, MyType data</span>)</span> &#123; <span class="comment">/* ... */</span> &#125;</span><br></pre></td></tr></table></figure>

<p>相关事件信息查询:</p>
<p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/UIE-Events-Reference.html">Event Reference</a></p>
<h3 id="SerializedObject-Data-Binding"><a href="#SerializedObject-Data-Binding" class="headerlink" title="SerializedObject Data Binding"></a>SerializedObject Data Binding</h3><p>待添加……</p>
<h2 id="UI-Assets"><a href="#UI-Assets" class="headerlink" title="UI Assets"></a>UI Assets</h2><p>Unity提供了两种Asset用于布局系统</p>
<ol>
<li>UXML documents(<a target="_blank" rel="noopener" href="https://docs.unity3d.com/2020.3/Documentation/Manual/UIElements.html">Unity eXtensible Markup Language (UXML) is an HTML and XML inspired markup language that you use to define the structure of user interfaces and reusable UI templates.</a>)(类似HTML和XML的标记性语言，用于定义UI布局)</li>
<li>Unity Style Sheets(USS)(<a target="_blank" rel="noopener" href="https://docs.unity3d.com/2020.3/Documentation/Manual/UIElements.html">Style sheets allow you to apply visual styles and behaviors to user interfaces. They’re similar to Cascading Style Sheets (CSS) used on the web, and support a subset of standard CSS properties. </a>)(类似CSS用于定义UI风格)</li>
</ol>
<h2 id="UI-Tools-and-resources"><a href="#UI-Tools-and-resources" class="headerlink" title="UI Tools and resources"></a>UI Tools and resources</h2><p>Unity提供了几个辅助工具，帮助我们学习和调试UI Toolkit</p>
<ol>
<li><p><strong>UI Debugger(UI调试器–可视化查看UI节点详细数据)</strong></p>
<p><img src="/img/Unity/UIToolkit/UIToolkitDebuggerPreview.PNG" alt="UIToolkitDebuggerPreview"></p>
</li>
<li><p><strong>UI Builder(UI布局可视化编辑器(预览版本))</strong></p>
<p><img src="/"></p>
</li>
<li><p><strong>UI Samples(UI事例)</strong></p>
<p><img src="/img/Unity/UIToolkit/UIToolkitSampleWindow.PNG" alt="UIToolkitSampleWindow"></p>
</li>
</ol>
<h2 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h2><p>接下来通过实战学习，进一步了解UIToolkit的使用和设计。</p>
<h3 id="基础学习"><a href="#基础学习" class="headerlink" title="基础学习"></a>基础学习</h3><h4 id="代码-USS创建UI"><a href="#代码-USS创建UI" class="headerlink" title="代码+USS创建UI"></a>代码+USS创建UI</h4><h5 id="代码创建UI"><a href="#代码创建UI" class="headerlink" title="代码创建UI"></a>代码创建UI</h5><p>UIToolkit为了帮助我们快速创建Editor UI窗口，提供了快捷创建入口:</p>
<p>Asset-&gt;Create-&gt;UI Toolkit-&gt;Editor Window</p>
<p><img src="/img/Unity/UIToolkit/UIToolkitEditorWindowCreator.PNG" alt="UIToolkitEditorWindowCreator"></p>
<p>考虑到不适用UXML作为UI布局，使用纯代码写Editor UI，这里就不勾选UXML了。</p>
<p>创建完会看到生成一个*.cs文件和一个*.uss文件，这是因为我们勾选了C#和USS，接下来我们打开UICreateUIByCodeEditorWindow.cs开始我们的Editor UI代码编写，后续会讲到如何利用*.uss文件来指定UI风格。</p>
<p>UICreateUIByCodeEditorWindow.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UICreateUIByCodeEditorWindow</span> : <span class="title">EditorWindow</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">MenuItem(<span class="string">&quot;Window/UI Toolkit/UIToolkitStudy/UICreateUIByCodeEditorWindow&quot;</span>)</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ShowUICodeStyleEditorWindow</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        UICreateUIByCodeEditorWindow wnd = GetWindow&lt;UICreateUIByCodeEditorWindow&gt;();</span><br><span class="line">        wnd.titleContent = <span class="keyword">new</span> GUIContent(<span class="string">&quot;UICreateUIByCodeEditorWindow&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> UIToolkit的rootVisualElement绘制方法</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">CreateGUI</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        CreateUIByCode();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 通过代码创建UI</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">CreateUIByCode</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 创建一个ui容器，用于管理我们新增的ui组件</span></span><br><span class="line">        VisualElement uiContainer = <span class="keyword">new</span> VisualElement();</span><br><span class="line">        <span class="comment">// 添加一个标题作为ui容器标题组件显示</span></span><br><span class="line">        Label uiTitleLable = <span class="keyword">new</span> Label(<span class="string">&quot;代码创建UI容器&quot;</span>);</span><br><span class="line">        uiContainer.Add(uiTitleLable);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 添加按钮组件</span></span><br><span class="line">        Button btn1 = <span class="keyword">new</span> Button();</span><br><span class="line">        btn1.text = <span class="string">&quot;代码创建按钮1&quot;</span>;</span><br><span class="line">        uiContainer.Add(btn1);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 必须将需要显示的组件添加到根节点才能显示</span></span><br><span class="line">        <span class="comment">// 将ui容器添加到根节点作为需要显示的UIElement</span></span><br><span class="line">        rootVisualElement.Add(uiContainer);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/img/Unity/UIToolkit/UICreateUIByCodeEditorWindow.PNG" alt="UICreateUIByCodeEditorWindow"></p>
<p>可以看到编写基于UIToolkit的Editor Window还是和以往一样，要继承EditorWindow，但实现GUI绘制的接口不是<strong>OnGUI()<strong>而是</strong>CreateGUI()</strong>。</p>
<p>正如前面提到的UIToolkit里绘制的对象Visual Tree是由Visual Element组成的树状结构。而<strong>EditorWindow.rootVisualElement正是UIToolkit绘制EditorWindow的根VisualElement</strong>，我们所有的UIToolkit元素都是添加到此EditorWindow.rootVisualElement实现排版绘制的。</p>
<h5 id="代码修改USS"><a href="#代码修改USS" class="headerlink" title="代码修改USS"></a>代码修改USS</h5><p>所有的UIToolkit组件都继承至VisualElement，想通过代码修改UIToolkit组件的Style很简单，直接访问VisualElement.style即可。</p>
<p>UIChangeUSSByCodeEditorWindow.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 通过代码修改USS创建UI</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">CreateStyleUIByCode</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    ******</span><br><span class="line">    <span class="comment">// 给Label指定不同的Color Style</span></span><br><span class="line">    uiTitleLable.style.color = Color.red;</span><br><span class="line">    <span class="comment">// 设置Label居中显示Style</span></span><br><span class="line">    uiTitleLable.style.alignSelf = Align.Center;</span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/img/Unity/UIToolkit/UIChangeUSSByCodeEditorWindow.PNG" alt="UIChangeUSSByCodeEditorWindow"></p>
<p>可以看到通过访问style属性并修改其中的color属性，我成功的修改了标题文本的颜色显示风格。更多的属性修改参考文档:</p>
<p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/ScriptReference/UIElements.IStyle.html">IStyle</a></p>
<h5 id="使用USS指定UI风格"><a href="#使用USS指定UI风格" class="headerlink" title="使用USS指定UI风格"></a>使用USS指定UI风格</h5><p>第一步依然是使用Create-&gt;UI Toolkit-&gt;Editor WIndow</p>
<p>去掉UXML勾选，这里依然只通过代码和USS文件创建UI显示。</p>
<p>UIUseUSSEditorWindow.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UIUseUSSEditorWindow</span> : <span class="title">EditorWindow</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">MenuItem(<span class="string">&quot;Window/UI Toolkit/UIToolkitStudy/UIUseUSSEditorWindow&quot;</span>)</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ShowUIUseUSSEditorWidnow</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        UIUseUSSEditorWindow wnd = GetWindow&lt;UIUseUSSEditorWindow&gt;();</span><br><span class="line">        wnd.titleContent = <span class="keyword">new</span> GUIContent(<span class="string">&quot;UIUseUSSEditorWindow&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">CreateGUI</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        CreateUIByUseUSS();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 使用USS创建UI</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">CreateUIByUseUSS</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        VisualElement root = rootVisualElement;</span><br><span class="line">        <span class="comment">// 加载并指定USS的使用</span></span><br><span class="line">        <span class="keyword">var</span> styleSheet = AssetDatabase.LoadAssetAtPath&lt;StyleSheet&gt;(<span class="string">&quot;Assets/Scripts/Editor/UIToolkitStudy/UIUseUSSEditorWindow/UIUseUSSEditorWindow.uss&quot;</span>);</span><br><span class="line">        root.styleSheets.Add(styleSheet);</span><br><span class="line">        </span><br><span class="line">        VisualElement smallLabelWithStyle = <span class="keyword">new</span> Label(<span class="string">&quot;USS Using SmallLabel Class Selector!&quot;</span>);</span><br><span class="line">        smallLabelWithStyle.AddToClassList(<span class="string">&quot;SmallLabel&quot;</span>);</span><br><span class="line">        VisualElement bigLabelWithStyle = <span class="keyword">new</span> Label(<span class="string">&quot;USS Using BigLabel Class Selector!&quot;</span>);</span><br><span class="line">        smallLabelWithStyle.AddToClassList(<span class="string">&quot;BigLabel&quot;</span>);</span><br><span class="line">        VisualElement labelWithStyle = <span class="keyword">new</span> Label(<span class="string">&quot;USS Using Label Type Selector!&quot;</span>);</span><br><span class="line">        VisualElement boldLabelWithStyle = <span class="keyword">new</span> Label(<span class="string">&quot;USS Using BoldLabel Class Selector!&quot;</span>);</span><br><span class="line">        boldLabelWithStyle.AddToClassList(<span class="string">&quot;BoldLabel&quot;</span>);</span><br><span class="line">        root.Add(smallLabelWithStyle);</span><br><span class="line">        root.Add(bigLabelWithStyle);</span><br><span class="line">        root.Add(labelWithStyle);</span><br><span class="line">        root.Add(boldLabelWithStyle);</span><br><span class="line">        </span><br><span class="line">        Button ussCenterButton = <span class="keyword">new</span> Button();</span><br><span class="line">        ussCenterButton.name = <span class="string">&quot;CenterButton&quot;</span>;</span><br><span class="line">        ussCenterButton.text = <span class="string">&quot;Center USS Button Name Selector&quot;</span>;</span><br><span class="line">        root.Add(ussCenterButton);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>UIUseUSSEditorWindow.uss</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">Label &#123;</span><br><span class="line">	font-size: 20px;</span><br><span class="line">	color: rgb(68, 138, 255);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.SmallLabel &#123;</span><br><span class="line">	font-size: 10px;</span><br><span class="line">	color: rgb(68, 138, 255);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.BigLabel &#123;</span><br><span class="line">	font-size: 40px;</span><br><span class="line">	color: rgb(68, 138, 255);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.BoldLabel &#123;</span><br><span class="line">	font-size: 20px;</span><br><span class="line">	-unity-font-style: bold;</span><br><span class="line">	color: rgb(68, 138, 255);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#CenterButton &#123;</span><br><span class="line">	align-self: center;</span><br><span class="line">	-unity-text-align: middle-center;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/img/Unity/UIToolkit/UIUseUSSEditorWindow.PNG" alt="UIUseUSSEditorWindow"></p>
<p>可以看到我们在UIUseUSSEditorWindow.uss里分别定义了，<strong>Type Selector(Label)</strong>，<strong>Class Selector(.SmallLabel, .BigLabel, .BoldLabel)</strong>,<strong>Name Selector(CenterButton)</strong>。</p>
<p>对应的我们在代码里通过以下三种方式分别指定了Selector：</p>
<ol>
<li><p>Type Selector</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">VisualElement labelWithStyle = <span class="keyword">new</span> Label(<span class="string">&quot;USS Using Label Type Selector!&quot;</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>Class Selctor</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">VisualElement smallLabelWithStyle = <span class="keyword">new</span> Label(<span class="string">&quot;USS Using SmallLabel Class Selector!&quot;</span>);</span><br><span class="line">smallLabelWithStyle.AddToClassList(<span class="string">&quot;SmallLabel&quot;</span>);</span><br><span class="line">VisualElement bigLabelWithStyle = <span class="keyword">new</span> Label(<span class="string">&quot;USS Using BigLabel Class Selector!&quot;</span>);</span><br><span class="line">smallLabelWithStyle.AddToClassList(<span class="string">&quot;BigLabel&quot;</span>);</span><br><span class="line">VisualElement labelWithStyle = <span class="keyword">new</span> Label(<span class="string">&quot;USS Using Label Type Selector!&quot;</span>);</span><br><span class="line">VisualElement boldLabelWithStyle = <span class="keyword">new</span> Label(<span class="string">&quot;USS Using BoldLabel Class Selector!&quot;</span>);</span><br><span class="line">boldLabelWithStyle.AddToClassList(<span class="string">&quot;BoldLabel&quot;</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>Name Selector</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Button ussCenterButton = <span class="keyword">new</span> Button();</span><br><span class="line">ussCenterButton.name = <span class="string">&quot;CenterButton&quot;</span>;</span><br><span class="line">ussCenterButton.text = <span class="string">&quot;Center USS Button Name Selector&quot;</span>;</span><br></pre></td></tr></table></figure></li>
</ol>
<h5 id="位置和排版"><a href="#位置和排版" class="headerlink" title="位置和排版"></a>位置和排版</h5><p>第一步依然是使用Create-&gt;UI Toolkit-&gt;Editor WIndow</p>
<p>去掉UXML勾选，这里依然只通过代码和USS文件创建UI显示。</p>
<p>UIPositionAndLayoutEditorWindow.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 位置和排版EditorWindow</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UIPositionAndLayoutEditorWindow</span> : <span class="title">EditorWindow</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 竖向相对位置根组件</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> VisualElement mRootVerticalRelativePosContainer;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">MenuItem(<span class="string">&quot;Window/UI Toolkit/UIToolkitStudy/UIPositionAndLayoutEditorWindow&quot;</span>)</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ShowUIPositionAndLayoutEditorWindow</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        UIPositionAndLayoutEditorWindow wnd = GetWindow&lt;UIPositionAndLayoutEditorWindow&gt;();</span><br><span class="line">        wnd.titleContent = <span class="keyword">new</span> GUIContent(<span class="string">&quot;UIPositionAndLayoutEditorWindow&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">CreateGUI</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        CreatePositionAndLayoutUI();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 创建位置和排版UI</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">CreatePositionAndLayoutUI</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        CreateRootRelativePosVerticalContainer();</span><br><span class="line">        CreateHorizontalRelativePosContainer();</span><br><span class="line">        CreateHorzintalLayoutContainer();</span><br><span class="line">        CreateVerticalAbsolutePosContainer();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 创建竖向相对位置根组件</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">CreateRootRelativePosVerticalContainer</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 竖向相对位置排版容器</span></span><br><span class="line">        mRootVerticalRelativePosContainer = <span class="keyword">new</span> VisualElement();</span><br><span class="line">        <span class="comment">// 设置竖向排版</span></span><br><span class="line">        mRootVerticalRelativePosContainer.style.flexDirection = FlexDirection.Column;</span><br><span class="line">        <span class="comment">// 设置相对位置</span></span><br><span class="line">        mRootVerticalRelativePosContainer.style.position = Position.Relative;</span><br><span class="line">        <span class="comment">// 指定竖向容器Style</span></span><br><span class="line">        mRootVerticalRelativePosContainer.AddToClassList(<span class="string">&quot;unity-box&quot;</span>);</span><br><span class="line">        <span class="comment">// 设置竖向容器大小位置</span></span><br><span class="line">        mRootVerticalRelativePosContainer.style.marginLeft = <span class="number">10</span>;</span><br><span class="line">        mRootVerticalRelativePosContainer.style.marginRight = <span class="number">10</span>;</span><br><span class="line">        mRootVerticalRelativePosContainer.style.marginTop = <span class="number">10</span>;</span><br><span class="line">        mRootVerticalRelativePosContainer.style.marginBottom = <span class="number">10</span>;</span><br><span class="line">        <span class="comment">// 设置竖向容器自适应大小</span></span><br><span class="line">        mRootVerticalRelativePosContainer.style.flexGrow = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 添加竖向排版标签</span></span><br><span class="line">        Label verticalLabel = <span class="keyword">new</span> Label();</span><br><span class="line">        verticalLabel.text = <span class="string">&quot;竖向相对位置排版容器标题&quot;</span>;</span><br><span class="line">        <span class="comment">// 设置文本居中显示</span></span><br><span class="line">        verticalLabel.style.alignSelf = Align.Center;</span><br><span class="line">        mRootVerticalRelativePosContainer.Add(verticalLabel);</span><br><span class="line">        rootVisualElement.Add(mRootVerticalRelativePosContainer);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 创建横向相对位置容器</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">CreateHorizontalRelativePosContainer</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 横向相对位置容器</span></span><br><span class="line">        <span class="keyword">var</span> horizontalRelativePosContainer = <span class="keyword">new</span> VisualElement();</span><br><span class="line">        <span class="comment">// 设置横向排版</span></span><br><span class="line">        horizontalRelativePosContainer.style.flexDirection = FlexDirection.Row;</span><br><span class="line">        <span class="comment">// 设置相对位置</span></span><br><span class="line">        horizontalRelativePosContainer.style.position = Position.Relative;</span><br><span class="line">        <span class="comment">// 指定横向相对位置容器Style</span></span><br><span class="line">        horizontalRelativePosContainer.AddToClassList(<span class="string">&quot;unity-box&quot;</span>);</span><br><span class="line">        <span class="comment">// 添加横向相对位置标签</span></span><br><span class="line">        Label horizontalRelativePosLabel = <span class="keyword">new</span> Label();</span><br><span class="line">        horizontalRelativePosLabel.text = <span class="string">&quot;横向相对位置排版容器标题&quot;</span>;</span><br><span class="line">        <span class="comment">// 设置文本居中显示</span></span><br><span class="line">        horizontalRelativePosLabel.style.alignSelf = Align.Center;</span><br><span class="line">        horizontalRelativePosContainer.Add(horizontalRelativePosLabel);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置横向容器多个按钮</span></span><br><span class="line">        Button horizontalButton1 = <span class="keyword">new</span> Button();</span><br><span class="line">        horizontalButton1.text = <span class="string">&quot;横向按钮1&quot;</span>;</span><br><span class="line">        horizontalButton1.style.marginLeft = <span class="number">25</span>;</span><br><span class="line">        Button horizontalButton2 = <span class="keyword">new</span> Button();</span><br><span class="line">        horizontalButton2.text = <span class="string">&quot;横向按钮2&quot;</span>;</span><br><span class="line">        horizontalButton2.style.marginLeft = <span class="number">50f</span>;</span><br><span class="line">        horizontalRelativePosContainer.Add(horizontalButton1);</span><br><span class="line">        horizontalRelativePosContainer.Add(horizontalButton2);</span><br><span class="line"></span><br><span class="line">        mRootVerticalRelativePosContainer.Add(horizontalRelativePosContainer);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 创建横向排版容器</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">CreateHorzintalLayoutContainer</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 横向排版容器</span></span><br><span class="line">        <span class="keyword">var</span> horizontalLayoutContainer = <span class="keyword">new</span> VisualElement();</span><br><span class="line">        <span class="comment">// 设置横向排版</span></span><br><span class="line">        horizontalLayoutContainer.style.flexDirection = FlexDirection.Row;</span><br><span class="line">        <span class="comment">// 设置内容超出后排版Style</span></span><br><span class="line">        horizontalLayoutContainer.style.flexWrap = Wrap.Wrap;</span><br><span class="line">        <span class="comment">// 指定横向排版容器Style</span></span><br><span class="line">        horizontalLayoutContainer.AddToClassList(<span class="string">&quot;unity-box&quot;</span>);</span><br><span class="line">        <span class="comment">// 添加横向排版标签</span></span><br><span class="line">        Label horizontalLayoutLabel = <span class="keyword">new</span> Label();</span><br><span class="line">        horizontalLayoutLabel.text = <span class="string">&quot;横向排版容器标题&quot;</span>;</span><br><span class="line">        <span class="comment">// 设置文本居中显示</span></span><br><span class="line">        horizontalLayoutLabel.style.alignSelf = Align.Center;</span><br><span class="line">        horizontalLayoutContainer.Add(horizontalLayoutLabel);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置横向容器多个按钮</span></span><br><span class="line">        Button horizontalButton1 = <span class="keyword">new</span> Button();</span><br><span class="line">        horizontalButton1.text = <span class="string">&quot;横向按钮1&quot;</span>;</span><br><span class="line">        <span class="comment">// 设置自动扩展系数</span></span><br><span class="line">        horizontalButton1.style.flexGrow = <span class="number">1</span>;</span><br><span class="line">        Button horizontalButton2 = <span class="keyword">new</span> Button();</span><br><span class="line">        horizontalButton2.text = <span class="string">&quot;横向按钮2&quot;</span>;</span><br><span class="line">        <span class="comment">// 设置自动扩展系数</span></span><br><span class="line">        horizontalButton2.style.flexGrow = <span class="number">2</span>;</span><br><span class="line">        <span class="comment">// 设置偏移间隔</span></span><br><span class="line">        horizontalButton2.style.marginLeft = <span class="number">10</span>;</span><br><span class="line">        Button horizontalButton3 = <span class="keyword">new</span> Button();</span><br><span class="line">        horizontalButton3.text = <span class="string">&quot;横向按钮3&quot;</span>;</span><br><span class="line">        <span class="comment">// 设置自动扩展系数</span></span><br><span class="line">        horizontalButton3.style.flexGrow = <span class="number">3</span>;</span><br><span class="line">        <span class="comment">// 设置偏移间隔</span></span><br><span class="line">        horizontalButton3.style.marginLeft = <span class="number">10</span>;</span><br><span class="line">        Button horizontalButton4 = <span class="keyword">new</span> Button();</span><br><span class="line">        horizontalButton4.text = <span class="string">&quot;横向按钮4&quot;</span>;</span><br><span class="line">        <span class="comment">// 设置自动扩展系数</span></span><br><span class="line">        horizontalButton4.style.flexGrow = <span class="number">4</span>;</span><br><span class="line">        <span class="comment">// 设置偏移间隔</span></span><br><span class="line">        horizontalButton4.style.marginLeft = <span class="number">10</span>;</span><br><span class="line">        horizontalLayoutContainer.Add(horizontalButton1);</span><br><span class="line">        horizontalLayoutContainer.Add(horizontalButton2);</span><br><span class="line">        horizontalLayoutContainer.Add(horizontalButton3);</span><br><span class="line">        horizontalLayoutContainer.Add(horizontalButton4);</span><br><span class="line"></span><br><span class="line">        mRootVerticalRelativePosContainer.Add(horizontalLayoutContainer);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 创建竖向绝对位置容器</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">CreateVerticalAbsolutePosContainer</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 竖向绝对坐标容器</span></span><br><span class="line">        <span class="keyword">var</span> verticalAbsolutePosContainer = <span class="keyword">new</span> VisualElement();</span><br><span class="line">        <span class="comment">// 设置竖向排版</span></span><br><span class="line">        verticalAbsolutePosContainer.style.flexDirection = FlexDirection.Column;</span><br><span class="line">        <span class="comment">// 设置绝对坐标</span></span><br><span class="line">        verticalAbsolutePosContainer.style.position = Position.Absolute;</span><br><span class="line">        <span class="comment">// 指定竖向绝对位置容器Style</span></span><br><span class="line">        verticalAbsolutePosContainer.AddToClassList(<span class="string">&quot;unity-box&quot;</span>);</span><br><span class="line">        <span class="comment">// 设置竖向容器大小位置</span></span><br><span class="line">        verticalAbsolutePosContainer.style.left = <span class="number">100</span>;</span><br><span class="line">        verticalAbsolutePosContainer.style.right = <span class="number">100</span>;</span><br><span class="line">        verticalAbsolutePosContainer.style.top = <span class="number">100</span>;</span><br><span class="line">        verticalAbsolutePosContainer.style.bottom = <span class="number">100</span>;</span><br><span class="line">        <span class="comment">// 设置竖向绝对位置容器自适应</span></span><br><span class="line">        verticalAbsolutePosContainer.style.flexGrow = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 添加竖向排版标签</span></span><br><span class="line">        Label verticalAbsolutePosLabel = <span class="keyword">new</span> Label();</span><br><span class="line">        verticalAbsolutePosLabel.text = <span class="string">&quot;竖向绝对位置标题&quot;</span>;</span><br><span class="line">        <span class="comment">// 设置文本居中显示</span></span><br><span class="line">        verticalAbsolutePosLabel.style.alignSelf = Align.Center;</span><br><span class="line">        verticalAbsolutePosContainer.Add(verticalAbsolutePosLabel);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置竖向容器多个按钮</span></span><br><span class="line">        Button verticalButton1 = <span class="keyword">new</span> Button();</span><br><span class="line">        verticalButton1.text = <span class="string">&quot;竖向按钮1&quot;</span>;</span><br><span class="line">        <span class="comment">// 设置按钮高度和位置</span></span><br><span class="line">        verticalButton1.style.height = <span class="number">20</span>;</span><br><span class="line">        verticalButton1.style.marginLeft = <span class="number">20</span>;</span><br><span class="line">        verticalButton1.style.marginRight = <span class="number">20</span>;</span><br><span class="line">        Button verticalButton2 = <span class="keyword">new</span> Button();</span><br><span class="line">        verticalButton2.text = <span class="string">&quot;竖向按钮2&quot;</span>;</span><br><span class="line">        <span class="comment">// 设置按钮高度</span></span><br><span class="line">        verticalButton2.style.height = <span class="number">20</span>;</span><br><span class="line">        verticalButton2.style.marginLeft = <span class="number">20</span>;</span><br><span class="line">        verticalButton2.style.marginRight = <span class="number">20</span>;</span><br><span class="line">        verticalAbsolutePosContainer.Add(verticalButton1);</span><br><span class="line">        verticalAbsolutePosContainer.Add(verticalButton2);</span><br><span class="line"></span><br><span class="line">        mRootVerticalRelativePosContainer.Add(verticalAbsolutePosContainer);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/img/Unity/UIToolkit/UIPositionAndLayoutEditorWindow.PNG" alt="UIPositionAndLayoutEditorWindow"></p>
<p>可以看到通过不断创建需要排版的容器设置对应排版和大小属性，我们成功的创建出了各种排版方向以及相对位置和绝对位置的显示UI。</p>
<h5 id="自定义USS变量"><a href="#自定义USS变量" class="headerlink" title="自定义USS变量"></a>自定义USS变量</h5><p>在创建USS文件时，我们很多时候会填充相同值给不同的Selector，而修改时并不想一个一个去修改，这个时候就需要用到类似编程上定义变量公用同一个变量的方式。</p>
<p>第一步依然是使用Create-&gt;UI Toolkit-&gt;Editor WIndow</p>
<p>去掉UXML勾选，这里依然只通过代码和USS文件创建UI显示。</p>
<p>UICustomUSSVariableEditorWindow.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 创建自定义USS变量的Editor Window</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UICustomUSSVariableEditorWindow</span> : <span class="title">EditorWindow</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">MenuItem(<span class="string">&quot;Window/UI Toolkit/UIToolkitStudy/UICustomUSSVariableEditorWindow&quot;</span>)</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ShowUICustomUSSVariableEditorWindow</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        UICustomUSSVariableEditorWindow wnd = GetWindow&lt;UICustomUSSVariableEditorWindow&gt;();</span><br><span class="line">        wnd.titleContent = <span class="keyword">new</span> GUIContent(<span class="string">&quot;UICustomUSSVariableEditorWindow&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">CreateGUI</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        CreateCustomUSSVariableUI();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 创建自定义USS变量的UI</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">CreateCustomUSSVariableUI</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 加载并指定USS的使用</span></span><br><span class="line">        <span class="keyword">var</span> customUSSVariable1StyleSheet1 = AssetDatabase.LoadAssetAtPath&lt;StyleSheet&gt;(<span class="string">&quot;Assets/Scripts/Editor/UIToolkitStudy/UICustomUSSVariableEditorWindow/UICustomUSSVariableEditorWindow1.uss&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> customUSSVariable1StyleSheet2 = AssetDatabase.LoadAssetAtPath&lt;StyleSheet&gt;(<span class="string">&quot;Assets/Scripts/Editor/UIToolkitStudy/UICustomUSSVariableEditorWindow/UICustomUSSVariableEditorWindow2.uss&quot;</span>);</span><br><span class="line">        rootVisualElement.styleSheets.Add(customUSSVariable1StyleSheet1);</span><br><span class="line">        rootVisualElement.styleSheets.Add(customUSSVariable1StyleSheet2);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 使用UICustomUSSVariableEditorWindow1里的NormalLabel</span></span><br><span class="line">        Label normalLabel = <span class="keyword">new</span> Label();</span><br><span class="line">        normalLabel.AddToClassList(<span class="string">&quot;NormalLabel&quot;</span>);</span><br><span class="line">        normalLabel.text = <span class="string">&quot;NormalLabel1&quot;</span>;</span><br><span class="line">        normalLabel.style.left = <span class="number">10</span>;</span><br><span class="line">        normalLabel.style.right = <span class="number">10</span>;</span><br><span class="line">        normalLabel.style.height = <span class="number">20</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 使用UICustomUSSVariableEditorWindow2里的NormalLabel2</span></span><br><span class="line">        Label normalLabel2 = <span class="keyword">new</span> Label();</span><br><span class="line">        normalLabel2.AddToClassList(<span class="string">&quot;NormalLabel2&quot;</span>);</span><br><span class="line">        normalLabel2.text = <span class="string">&quot;NormalLabel2&quot;</span>;</span><br><span class="line">        normalLabel2.style.left = <span class="number">10</span>;</span><br><span class="line">        normalLabel2.style.right = <span class="number">10</span>;</span><br><span class="line">        normalLabel2.style.height = <span class="number">20</span>;</span><br><span class="line"></span><br><span class="line">        rootVisualElement.Add(normalLabel);</span><br><span class="line">        rootVisualElement.Add(normalLabel2);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>UICustomUSSVariableEditorWindow1.uss</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">:root &#123;</span><br><span class="line">	--text-color: red;</span><br><span class="line">	--background-color: green;</span><br><span class="line">	--text-color2: yellow;</span><br><span class="line">	--background-color2: blue;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.NormalLabel &#123;</span><br><span class="line">	color: red;</span><br><span class="line">	background-color: var(--background-color);</span><br><span class="line">	align-self: center;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>UICustomUSSVariableEditorWindow2.uss</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">.NormalLabel2 &#123;</span><br><span class="line">	color: var(--text-color2);</span><br><span class="line">	background-color: var(--background-color2);</span><br><span class="line">	align-self: center;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/img/Unity/UIToolkit/UICustomUSSVariableEditorWindow.PNG" alt="UICustomUSSVariableEditorWindow"></p>
<p>可以看到我们在USS文件里自定义了变量并在Class Selector里使用，通过加载多个USS文件，我们实现了跨USS文件的变量定义访问使用。</p>
<h4 id="UXML创建UI"><a href="#UXML创建UI" class="headerlink" title="UXML创建UI"></a>UXML创建UI</h4><p>待添加……</p>
<h4 id="UI事件响应"><a href="#UI事件响应" class="headerlink" title="UI事件响应"></a>UI事件响应</h4><h4 id="数据绑定"><a href="#数据绑定" class="headerlink" title="数据绑定"></a>数据绑定</h4><h4 id="调试"><a href="#调试" class="headerlink" title="调试"></a>调试</h4><h4 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h4><ol>
<li><strong>EditorWindow.CreateGUI()方法是用于UIToolkit创建Editor窗口的rootVisualElement显示方法</strong></li>
<li><strong>Editor.CreateInspectorGUI()方法是用于UIToolkit创建自定义Inspector面板的显示方法</strong></li>
<li><strong><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/UIE-support-for-editor-ui.html">UI Toolkit to create Editor UI and synchronize data between a property and a visual element for the Editor UI.</a>(UIToolkit支持在Editor UI上同步属性数据到Visual Element上)</strong></li>
</ol>
<h3 id="节点编辑器实现"><a href="#节点编辑器实现" class="headerlink" title="节点编辑器实现"></a>节点编辑器实现</h3><h1 id="Github"><a href="#Github" class="headerlink" title="Github"></a>Github</h1><p>个人Github:</p>
<p><a href="http://tonytang1990.github.io/2022/02/20/UnityEditor%E7%9F%A5%E8%AF%86/">UnityEditor知识</a></p>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/UIToolkits.html">Creating user interfaces (UI)</a></p>
<p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/CSS">CSS</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/UIE-uss-properties.html">USS properties reference</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/ScriptReference/UIElements.IStyle.html">IStyle</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/UIE-ElementRef.html">UXML现有可用Element查询</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/UIE-uss-built-in-variable-reference.html">USS built-in variable references</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/UIE-Events-Reference.html">Event Reference</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Editor/">Editor</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Editor/">Editor</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2023/04/09/路点编辑和缓动/" title="路点编辑和缓动" itemprop="url">路点编辑和缓动</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Tony Tang" target="_blank" itemprop="author">Tony Tang</a>
		
  <p class="article-time">
    <time datetime="2023-04-09T13:17:00.000Z" itemprop="datePublished"> 发表于 2023-04-09</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>游戏开发过程中，我们希望角色物体按固定路线移动，我们一般需要通过路点编辑器工具去预先编辑好所有路点，然后导出路点数据通过数学运算去移动角色物体。</p>
<p>结合以前学习的<a href="http://tonytang1990.github.io/2020/05/29/%E6%95%B0%E5%AD%A6%E4%B8%8E%E7%BC%93%E5%8A%A8/">数学缓动</a>和<a href="http://tonytang1990.github.io/2022/02/20/UnityEditor%E7%9F%A5%E8%AF%86/">UnityEditor知识</a></p>
<p>本章节通过编写纯Editor的路点编辑器，从实战角度去利用数学缓动和UnityEditor知识实现我们需要的<strong>路点编辑器工具，以及基于路点编辑器数据的路线插值缓动系统</strong>。</p>
<h1 id="路点编辑和缓动"><a href="#路点编辑和缓动" class="headerlink" title="路点编辑和缓动"></a>路点编辑和缓动</h1><p>实现一个工具，首先第一步，我们还是需要理清需求：</p>
<ol>
<li>纯Editor非运行时路点编辑器。</li>
<li>路点编辑器需要生成可视化编辑对象和路点路线展示(支持纯Editor绘制和LineRenderer组件绘制两种方式)。</li>
<li>路点编辑器要支持指定起始位置和固定位置偏移的路点编辑自动矫正(方便固定单位间隔的路点配置)。</li>
<li>路点编辑器要支持指定路线移动时长，是否循环和是否自动更新朝向等路线缓动模拟设置。</li>
<li>路点编辑器要支持自定义数据导出自定义格式数据。</li>
<li>路点编辑器要支持多种路线类型(e.g. 直线，Bezier，CubicBezier等)。</li>
<li>路线移动支持缓动曲线配置。</li>
<li>路点编辑器要支持纯Editor模拟运行路点移动效果。</li>
<li>路点编辑器编辑完成后的数据要支持运行时使用并模拟路线缓动，同时路线缓动要支持纯运行时构建使用。</li>
<li>实现一个纯Editor的Tile可视化绘制脚本(方便路点编辑位置参考)。</li>
</ol>
<h2 id="Bezier曲线"><a href="#Bezier曲线" class="headerlink" title="Bezier曲线"></a>Bezier曲线</h2><p>我们路点编辑器要支持直线和曲线运动，说到曲线运动，这里就不得不提Bezier曲线。</p>
<p><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/zh-sg/%E8%B2%9D%E8%8C%B2%E6%9B%B2%E7%B7%9A"><strong>贝塞尔曲线</strong>是电脑图形学中相当重要的参数曲线。</a></p>
<p><strong>个人理解Bezier曲线的核心原理就是多个点(N阶)之间的同时递归插值0-1比例值得出的一系列最终插值位置</strong></p>
<h3 id="线性Bezier曲线"><a href="#线性Bezier曲线" class="headerlink" title="线性Bezier曲线"></a>线性Bezier曲线</h3><p>线性Bezier曲线其实就是我们2个点位置的线性插值，公式如下(<strong>P0第一个点，P1第二个点</strong>)：</p>
<p>B(t) &#x3D; P0 + (P1 - P0) * t，t∈[0, 1]</p>
<p>一阶Bezier曲线公式简化后:</p>
<p><strong>B(t) &#x3D; (1 - t) * P0 - t * P1，t∈[0, 1]</strong></p>
<p>从公式可以看出，线性Bezier就是2个点位置通过0-1的比例值插值的过程。</p>
<p><img src="/img/Unity/PathPointTool/LineBezierIntroduction.PNG" alt="LineBezierIntroduction"></p>
<h3 id="二阶Bezier曲线"><a href="#二阶Bezier曲线" class="headerlink" title="二阶Bezier曲线"></a>二阶Bezier曲线</h3><p>同理二阶Beizer曲线是由3个顶点位置递归插值而来的，公式如下(<strong>P0第一个点，P1第二个点，P2第三个点</strong>)：</p>
<p>首先我们先我们先插值P0和P1：</p>
<p>P0P1 &#x3D; (1 - t) * P0 + t * P1，t∈[0, 1]</p>
<p>接下来插值P1和P2：</p>
<p>P1P2 &#x3D; (1 - t) * P1 + t * P2，t∈[0, 1]</p>
<p>三个点之间的插值完成后，接下来我们还要递归插值三个点插值后的两个点(<strong>P0P1和P1P2</strong>)：</p>
<p>p0p1p2 &#x3D; (1 - t) * p0p1 + t * p1p2，t∈[0, 1]</p>
<p>二阶Bezier曲线公式简化后:</p>
<p><strong>B(t) &#x3D; (1 - t)² * P0 + 2 * (1 - t) * t * P1 + t² * P2，t∈[0, 1]</strong></p>
<h3 id="三阶Bezier曲线"><a href="#三阶Bezier曲线" class="headerlink" title="三阶Bezier曲线"></a>三阶Bezier曲线</h3><p>同理三阶Beizer曲线是由3个顶点位置递归插值而来的，公式如下(<strong>P0第一个点，P1第二个点，P2第三个点，P3第四个点</strong>)：</p>
<p>首先我们先我们先插值P0和P1：</p>
<p>P0P1 &#x3D; (1 - t) * P0 + t * P1，t∈[0, 1]</p>
<p>接下来插值P1和P2：</p>
<p>P1P2 &#x3D; (1 - t) * P1 + t * P2，t∈[0, 1]</p>
<p>接下来插值P2和P3：</p>
<p>P2P3 &#x3D; (1 - t) * P2 + t * P3，t∈[0, 1]</p>
<p>以上插值位置动画如下:</p>
<p><img src="/img/Unity/PathPointTool/BezierAnimation.gif" alt="BezierAnimation"></p>
<p><strong>P0P1,P1P2,P2P3分别对应动画中的a,b,c三个插值点</strong></p>
<p>四个点之间的插值完成后，接下来我们还要递归插值四个点插值后的三个点(<strong>P0P1，P1P2和P2P3</strong>)：</p>
<p>插值P0P1和P1P2：</p>
<p>P0P1P2 &#x3D; (1 - t) * P0P1 + t * P1P2，t∈[0, 1]</p>
<p>插值P1P2和P2P3：</p>
<p>P1P2P3 &#x3D; (1 - t) * P1P2 + t * P2P3，t∈[0, 1]</p>
<p>以上插值位置动画如下:</p>
<p><img src="/img/Unity/PathPointTool/BezierAnimation2.gif" alt="BezierAnimation2"></p>
<p><strong>P0P1P2和P1P2P3分别对应动画中的d和e两个插值点</strong></p>
<p>最后一步，我们接着把P0P1P2和P1P2P3进行插值就能得到3阶Bezier曲线的最终插值位置了:</p>
<p>插值P0P1P2和P1P2P3：</p>
<p>P0P1P2P3 &#x3D; (1 - t) * P0P1P2 + t * P1P2P3，t∈[0, 1]</p>
<p>三阶Bezier曲线公式简化后:</p>
<p><strong>B(t) &#x3D; (1 - t)³ * P0 + 3 * (1 - t)² * t * P1 + 3 * t² * (1 - t) * P2 + t³ * P3，t∈[0, 1]</strong></p>
<p>以上插值位置动画如下:</p>
<p><img src="/img/Unity/PathPointTool/BezierAnimation3.gif" alt="BezierAnimation3"></p>
<p>N阶Bezier曲线公式参考:</p>
<p><img src="/img/Unity/PathPointTool/NBezierFormular.PNG" alt="NBezierFormular"></p>
<p>N阶Bezier的代码实现请参考:</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/QO_GQ/article/details/116711205">unity利用高阶贝塞尔曲线进行的轨道移动</a></p>
<p><strong>由于N阶Bezier的计算复杂度过高，一般来说，路点过多的情况下，我们不会直接采用N阶Bezier曲线进行插值计算，而是采用N个3阶Bezier曲线进行拼接组装成一个N阶Bezier曲线</strong></p>
<h3 id="Catmull-Rom-Spline"><a href="#Catmull-Rom-Spline" class="headerlink" title="Catmull-Rom Spline"></a>Catmull-Rom Spline</h3><p>虽然Bezier已经能实现大部分曲线的需求，但Bezier曲线里移动控制点(无论2阶还是3阶)就会导致整个曲线发生变化，即<strong>无法局部控制曲线走向，同时Bezier曲线不能确保通过所有控制点</strong>。</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/i_dovelemon/article/details/47984241"><strong>Catmull-Rom Spline样条线</strong>是一根比较特殊的Bezier曲线，这条Bezier曲线能够保证穿过从控制点的第二个点到控制点的倒数第二点之间的所有点。所以说，Catmull-Rom样条线最少需要4个控制点来进行控制。</a></p>
<p>Catmull-Rom算法保证两点：</p>
<p>1、<a target="_blank" rel="noopener" href="https://blog.csdn.net/wsf09/article/details/103453496">点<strong>Pi</strong> 的一阶导数等于<strong>Pi+1 - Pi-1</strong>，即点<strong>Pi</strong> 的切向量和其相邻两点连线的切向量是平行的</a></p>
<p>2、<a target="_blank" rel="noopener" href="https://blog.csdn.net/wsf09/article/details/103453496">穿过所有<strong>Pi</strong> 点。这是与贝塞尔曲线的最大区别，正因为这样的特性，使得Catmull-Rom算法适于用作<strong>轨迹线算法</strong>。</a></p>
<p><img src="/img/Unity/PathPointTool/CatmullRomSpline.PNG" alt="CatmullRomSpline"></p>
<p>可以看到Catmull-Rom Spline和三阶Bezier曲线一样需要4个点：</p>
<p><img src="/img/Unity/PathPointTool/CatmullRomSpline2.PNG" alt="CatmullRomSpline2"></p>
<p>P1点的切线和P0P2一致，P2点的切线和P1P3一致。</p>
<p><strong>值得注意的是虽然输入点有4个，但我们t(0-1)最终绘制的是P1到P2和P2到P3这部分</strong></p>
<p>那么如何确保所有的控制点都连接绘制了？</p>
<p><strong>利用Catmull-Rom Spline曲线会通过中间两个控制点且中间两个点经过时的切线与前后两个控制点连线平行，那么我可以可以通过模拟构造一个P(-1)&#x3D;2P0-P1(确保P(-1)P1和P0切线平行从而确保从P0处切线平行)，利用P(-1)P0P1P2构造一个CatmullRomSpline曲线即可画出P0开始的P0P1的曲线。最后一段曲线同理，构造一个P(N+1)&#x3D;2P(N)-P(N-1)，然后绘制P(N-2)P(N-1)P(N)P(N+1)即可绘制出P(N-1)P(N)的曲线。</strong></p>
<p>这里直接给出最终推导公式，详细推导过程参考后续其他博主分享：</p>
<p><strong>P &#x3D; _point &#x3D; P0 * (-0.5<em>t</em>t<em>t + t</em>t – 0.5<em>t) + P1 * (1.5</em>t<em>t</em>t - 2.5<em>t</em>t + 1.0) + P2 * (-1.5<em>t</em>t<em>t + 2.0</em>t<em>t + 0.5</em>t) + P3 * (0.5<em>t</em>t<em>t – 0.5</em>t*t);</strong></p>
<p>详细的推导过程博主并没有完全看懂，这里大家可以参考这位博主的推导分析:</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/wsf09/article/details/103453496">Catmull-Rom插值算法</a></p>
<p>理解了Bezier曲线和Catmull-Rom Spline样条线原理，接下来让我们进入路点编辑器实战。</p>
<h2 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h2><p>接下来针对前面提到的需求，我们一一分析我们应该用什么方案和技术来实现。</p>
<p>需求：</p>
<ol>
<li>纯Editor非运行时路点编辑器。</li>
<li>路点编辑器需要生成可视化编辑对象和路点路线展示(支持纯Editor绘制和LineRenderer组件绘制两种方式)。</li>
<li>路点编辑器要支持指定起始位置和固定位置偏移的路点编辑自动矫正(方便固定单位间隔的路点配置)。</li>
<li>路点编辑器要支持指定路线移动时长，是否循环和是否自动更新朝向等路线缓动模拟设置。</li>
<li>路点编辑器要支持自定义数据导出自定义格式数据。</li>
<li>路点编辑器要支持多种路线类型(e.g. 直线，Bezier，CubicBezier等)。</li>
<li>路点编辑器要支持纯Editor模拟运行路点移动效果。</li>
<li>路线移动支持缓动曲线配置。</li>
<li>路点编辑器编辑完成后的数据要支持运行时使用并模拟路线缓动，同时路线缓动要支持纯运行时构建使用。</li>
<li>路线移动支持缓动曲线配置。</li>
<li>实现一个纯Editor的Tile可视化绘制脚本(方便路点编辑位置参考)。</li>
</ol>
<p>实现思路：</p>
<ol>
<li>结合自定义Inspector面板(继承Editor)定义的方式实现纯Editor配置和操作</li>
<li>利用Gizmos(Monobehaviour:OnDrawGizmos())，Handles(Editor.OnSceneGUI())和自定义Inspector(Editor)面板编辑操作实现可视化编辑对象生成和展示。LineRenderer通过挂在指定LinRenderer组件将路点细分的点通过LineRenderer:SetPositions()设置显示。</li>
<li>利用自定义Inspector面板支持起始位置和路点间隔配置，然后通过配置数据进行路点位置矫正操作。</li>
<li>自定义Inspecotr面板支持配置即可。</li>
<li>同上，自定义Inspector面板支持操作分析路点数据进行导出即可。</li>
<li>利用Bezier曲线知识，实现不同路线类型(e.g. 直线，Bezier，CubicBezier等)。</li>
<li>利用InitializeOnLoad，ExecuteInEditMode和InitializeOnLoadMethod标签加EditorApplication.update实现纯Editor初始化和注入Update更新实现纯Editor模拟路点移动效果。</li>
<li>利用缓动曲线去重新计算插值t(0-1)的值作为插值比例即可。</li>
<li>实现一套超级简陋版DoTween支持运行时路线缓动模拟即可(见TPathTweener和TPathTweenerManager)。</li>
<li>利用Gizmos的自定义Mesh绘制+自定义Inspector面板实现Tile网格自定义配置绘制。</li>
</ol>
<p>核心思路和技术实现方案都在上面介绍了，这里就不一一介绍代码实现了，这里只放关于Bezier曲线插值相关的代码，让我们直接实战看效果，需要源码的直接在文章末尾Github链接去取即可。</p>
<p>BezierUtilities.cs(Bezier曲线插值相关)</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> BezierUtilities.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Bezier静态工具类</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">BezierUtilities</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Note：</span></span><br><span class="line">    <span class="comment">// 1. 高阶Bezier曲线计算复杂，推荐用N个3阶Bezier曲线模拟</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 根据t(0-1)计算一阶Bezier曲线上面对应的点</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;p0&quot;&gt;</span>第一个点<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;p1&quot;&gt;</span>第二个点<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;t&quot;&gt;</span>插值(0-1)<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Vector3 <span class="title">CaculateLinerPoint</span>(<span class="params">Vector3 p0, Vector3 p1, <span class="built_in">float</span> t</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        t = Mathf.Clamp01(t);</span><br><span class="line">        <span class="comment">// 原始公式:</span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        return (1 - t) * p0 + t * p1;</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        <span class="keyword">return</span> (<span class="number">1</span> - t) * p0 + t * p1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 根据t(0-1)计算二阶贝塞尔曲线上面对应的点</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;p0&quot;&gt;</span>第一个点<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;p1&quot;&gt;</span>第二个点<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;p2&quot;&gt;</span>第三个点<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;t&quot;&gt;</span>插值(0-1)<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Vector3 <span class="title">CaculateBezierPoint</span>(<span class="params">Vector3 p0, Vector3 p1, Vector3 p2, <span class="built_in">float</span> t</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        t = Mathf.Clamp01(t);</span><br><span class="line">        <span class="comment">// 原始公式:</span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        var p0p1 = (1 - t) * p0 + t * p1;</span></span><br><span class="line"><span class="comment">        var p1p2 = (1 - t) * p1 + t * p2;</span></span><br><span class="line"><span class="comment">        return (1 - t) * p0p1 + t * p1p2;</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        <span class="comment">// 简化运算:</span></span><br><span class="line">        <span class="keyword">var</span> u = <span class="number">1</span> - t;</span><br><span class="line">        <span class="keyword">var</span> tt = t * t;</span><br><span class="line">        <span class="keyword">var</span> uu = u * u;</span><br><span class="line">        <span class="keyword">return</span> uu * p0 + <span class="number">2</span> * u * t * p1 + tt * p2;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 根据t(0-1)计算三阶贝塞尔曲线上面对应的点</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;p0&quot;&gt;</span>第一个点<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;p1&quot;&gt;</span>第二个点<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;p2&quot;&gt;</span>第三个点<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;p3&quot;&gt;</span>第四个点<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;t&quot;&gt;</span>插值(0-1)<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Vector3 <span class="title">CaculateCubicBezierPoint</span>(<span class="params">Vector3 p0, Vector3 p1, Vector3 p2, Vector3 p3, <span class="built_in">float</span> t</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        t = Mathf.Clamp01(t);</span><br><span class="line">        <span class="comment">// 原始公式:</span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        var p0p1 = (1 - t) * p0 + t * p1;</span></span><br><span class="line"><span class="comment">        var p1p2 = (1 - t) * p1 + t * p2;</span></span><br><span class="line"><span class="comment">        var p2p3 = (1 - t) * p2 + t * p3;</span></span><br><span class="line"><span class="comment">        var p0p1p2 = (1 - t) * p0p1 + t * p1p2;</span></span><br><span class="line"><span class="comment">        var p1p2p3 = (1 - t) * p1p2 + t * p2p3;</span></span><br><span class="line"><span class="comment">        return (1 - t) * p0p1p2 + t * p1p2p3;</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        <span class="comment">// 简化运算:</span></span><br><span class="line">        <span class="keyword">var</span> u = <span class="number">1</span> - t;</span><br><span class="line">        <span class="keyword">var</span> tt = t * t;</span><br><span class="line">        <span class="keyword">var</span> uu = u * u;</span><br><span class="line">        <span class="keyword">var</span> ttt = tt * t;</span><br><span class="line">        <span class="keyword">var</span> uuu = uu * u;</span><br><span class="line">        <span class="keyword">return</span> uuu * p0 + <span class="number">3</span> * uu * t * p1 + <span class="number">3</span> * tt * u * p2 + ttt * p3;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 根据t(0-1)计算Cutmull-Roll Spline曲线上面对应的点</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;p0&quot;&gt;</span>第一个点<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;p1&quot;&gt;</span>第二个点<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;p2&quot;&gt;</span>第三个点<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;p3&quot;&gt;</span>第四个点<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;t&quot;&gt;</span>插值(0-1)<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Vector3 <span class="title">CaculateCRSplinePoint</span>(<span class="params">Vector3 p0, Vector3 p1, Vector3 p2, Vector3 p3, <span class="built_in">float</span> t</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        t = Mathf.Clamp01(t);</span><br><span class="line">        <span class="comment">// 原始公式:</span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         Output_point = (-0.5*t*t*t + t*t – 0.5*t) * p0 +</span></span><br><span class="line"><span class="comment">		                (1.5*t*t*t - 2.5*t*t + 1.0) * p1 +</span></span><br><span class="line"><span class="comment">		                (-1.5*t*t*t + 2.0*t*t + 0.5*t) * p2 +</span></span><br><span class="line"><span class="comment">		                (0.5*t*t*t – 0.5*t*t) * p3;</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        <span class="comment">// 简化运算:</span></span><br><span class="line">        <span class="keyword">var</span> tt = t * t;</span><br><span class="line">        <span class="keyword">var</span> ttt = tt * t;</span><br><span class="line">        <span class="keyword">return</span> (<span class="number">-0.5f</span> * ttt + tt - <span class="number">0.5f</span> * t) * p0 +</span><br><span class="line">               (<span class="number">1.5f</span> * ttt - <span class="number">2.5f</span> * tt + <span class="number">1</span>) * p1 +</span><br><span class="line">               (<span class="number">-1.5f</span> * ttt + <span class="number">2</span> * tt + <span class="number">0.5f</span> * t) * p2 +</span><br><span class="line">               (<span class="number">0.5f</span> * ttt - <span class="number">0.5f</span> * tt) * p3;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 获取存储的一阶Bezier曲线细分顶点的数组</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;p0&quot;&gt;</span>第一个点<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;p1&quot;&gt;</span>第二个点<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;segmentNum&quot;&gt;</span>细分段数<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>存储贝塞尔曲线点的数组<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Vector3[] <span class="title">GetLinerList</span>(<span class="params">Vector3 p0, Vector3 p1, <span class="built_in">int</span> segmentNum</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        segmentNum = Mathf.Clamp(segmentNum, <span class="number">1</span>, Int32.MaxValue);</span><br><span class="line">        <span class="keyword">var</span> pathPointNum = segmentNum + <span class="number">1</span>;</span><br><span class="line">        Vector3[] path = <span class="keyword">new</span> Vector3[pathPointNum];</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; pathPointNum; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">float</span> t = i / (<span class="built_in">float</span>)segmentNum;</span><br><span class="line">            Vector3 pathPoint = CaculateLinerPoint(p0, p1, t);</span><br><span class="line">            path[i] = pathPoint;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> path;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 获取存储的二次贝塞尔曲线细分顶点的数组</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;p0&quot;&gt;</span>起始点<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;p1&quot;&gt;</span>控制点<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;p2&quot;&gt;</span>目标点<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;segmentNum&quot;&gt;</span>细分段数<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>存储贝塞尔曲线点的数组<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Vector3[] <span class="title">GetBeizerList</span>(<span class="params">Vector3 p0, Vector3 p1, Vector3 p2, <span class="built_in">int</span> segmentNum</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        segmentNum = Mathf.Clamp(segmentNum, <span class="number">1</span>, Int32.MaxValue);</span><br><span class="line">        <span class="keyword">var</span> pathPointNum = segmentNum + <span class="number">1</span>;</span><br><span class="line">        Vector3[] path = <span class="keyword">new</span> Vector3[pathPointNum];</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; pathPointNum; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">float</span> t = i / (<span class="built_in">float</span>)segmentNum;</span><br><span class="line">            Vector3 pathPoint = CaculateBezierPoint(p0, p1, p2, t);</span><br><span class="line">            path[i] = pathPoint;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> path;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 获取存储的三次贝塞尔曲线细分顶点的数组</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;p0&quot;&gt;</span>起始点<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;p1&quot;&gt;</span>控制点1<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;p2&quot;&gt;</span>控制点2<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;p3&quot;&gt;</span>目标点<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;segmentNum&quot;&gt;</span>细分段数<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>存储贝塞尔曲线点的数组<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Vector3[] <span class="title">GetCubicBeizerList</span>(<span class="params">Vector3 p0, Vector3 p1, Vector3 p2, Vector3 p3, <span class="built_in">int</span> segmentNum</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        segmentNum = Mathf.Clamp(segmentNum, <span class="number">1</span>, Int32.MaxValue);</span><br><span class="line">        <span class="keyword">var</span> pathPointNum = segmentNum + <span class="number">1</span>;</span><br><span class="line">        Vector3[] path = <span class="keyword">new</span> Vector3[pathPointNum];</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; pathPointNum; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">float</span> t = i / (<span class="built_in">float</span>)segmentNum;</span><br><span class="line">            Vector3 pathPoint = CaculateCubicBezierPoint(p0, p1, p2, p3, t);</span><br><span class="line">            path[i] = pathPoint;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> path;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 获取存储的Cutmull-Rom Spline曲线细分顶点的数组</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;p0&quot;&gt;</span>起始点<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;p1&quot;&gt;</span>控制点1<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;p2&quot;&gt;</span>控制点2<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;p3&quot;&gt;</span>目标点<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;segmentNum&quot;&gt;</span>细分段数<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>存储Cutmull-Rom Spline曲线点的数组<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Vector3[] <span class="title">GetCRSplineList</span>(<span class="params">Vector3 p0, Vector3 p1, Vector3 p2, Vector3 p3, <span class="built_in">int</span> segmentNum</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        segmentNum = Mathf.Clamp(segmentNum, <span class="number">1</span>, Int32.MaxValue);</span><br><span class="line">        <span class="keyword">var</span> pathPointNum = segmentNum + <span class="number">1</span>;</span><br><span class="line">        Vector3[] path = <span class="keyword">new</span> Vector3[pathPointNum];</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; pathPointNum; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">float</span> t = i / (<span class="built_in">float</span>)segmentNum;</span><br><span class="line">            Vector3 pathPoint = CaculateCRSplinePoint(p0, p1, p2, p3, t);</span><br><span class="line">            path[i] = pathPoint;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> path;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>TPath.cs(M个点换算成P个N阶Bezier曲线插值)</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 获取线性路线指定比例路点位置</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;t&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> Vector3 <span class="title">GetLinerPoinAt</span>(<span class="params"><span class="built_in">float</span> t</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> pointNum = CaculatePathPointList.Count;</span><br><span class="line">    <span class="keyword">var</span> maxPointIndex = pointNum - <span class="number">1</span>;</span><br><span class="line">    TSegment currentUnderSegment;</span><br><span class="line">    <span class="built_in">float</span> currentUnderSegmentPercent;</span><br><span class="line">    GetRadioSegmentAndPercent(t, <span class="keyword">out</span> currentUnderSegment, <span class="keyword">out</span> currentUnderSegmentPercent);</span><br><span class="line">    <span class="keyword">if</span>(currentUnderSegment == <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> Vector3.zero;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> firstPointIndex = currentUnderSegment.StartPointIndex;</span><br><span class="line">    <span class="keyword">var</span> secondPointIndex = Mathf.Clamp(currentUnderSegment.StartPointIndex + <span class="number">1</span>, <span class="number">0</span>, maxPointIndex);</span><br><span class="line">    <span class="keyword">return</span> BezierUtilities.CaculateLinerPoint(CaculatePathPointList[firstPointIndex], CaculatePathPointList[secondPointIndex], currentUnderSegmentPercent);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 获取二阶贝塞尔路线指定比例路点位置</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;t&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> Vector3 <span class="title">GetBezierPointAt</span>(<span class="params"><span class="built_in">float</span> t</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> pointNum = CaculatePathPointList.Count;</span><br><span class="line">    <span class="keyword">var</span> maxPointIndex = pointNum - <span class="number">1</span>;</span><br><span class="line">    TSegment currentUnderSegment;</span><br><span class="line">    <span class="built_in">float</span> currentUnderSegmentPercent;</span><br><span class="line">    GetRadioSegmentAndPercent(t, <span class="keyword">out</span> currentUnderSegment, <span class="keyword">out</span> currentUnderSegmentPercent);</span><br><span class="line">    <span class="keyword">if</span> (currentUnderSegment == <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> Vector3.zero;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> firstPointIndex = currentUnderSegment.StartPointIndex;</span><br><span class="line">    <span class="keyword">var</span> secondPointIndex = Mathf.Clamp(currentUnderSegment.StartPointIndex + <span class="number">1</span>, <span class="number">0</span>, maxPointIndex);</span><br><span class="line">    <span class="keyword">var</span> thirdPointIndex = Mathf.Clamp(currentUnderSegment.StartPointIndex + <span class="number">2</span>, <span class="number">0</span>, maxPointIndex);</span><br><span class="line">    <span class="keyword">return</span> BezierUtilities.CaculateBezierPoint(CaculatePathPointList[firstPointIndex],</span><br><span class="line">                                               CaculatePathPointList[secondPointIndex],</span><br><span class="line">                                               CaculatePathPointList[thirdPointIndex],</span><br><span class="line">                                               currentUnderSegmentPercent);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 获取三阶贝塞尔路线指定比例路点位置</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;t&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> Vector3 <span class="title">GetCubicBezierPointAt</span>(<span class="params"><span class="built_in">float</span> t</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> pointNum = CaculatePathPointList.Count;</span><br><span class="line">    <span class="keyword">var</span> maxPointIndex = pointNum - <span class="number">1</span>;</span><br><span class="line">    TSegment currentUnderSegment;</span><br><span class="line">    <span class="built_in">float</span> currentUnderSegmentPercent;</span><br><span class="line">    GetRadioSegmentAndPercent(t, <span class="keyword">out</span> currentUnderSegment, <span class="keyword">out</span> currentUnderSegmentPercent);</span><br><span class="line">    <span class="keyword">if</span> (currentUnderSegment == <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> Vector3.zero;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> firstPointIndex = currentUnderSegment.StartPointIndex;</span><br><span class="line">    <span class="keyword">var</span> secondPointIndex = Mathf.Clamp(currentUnderSegment.StartPointIndex + <span class="number">1</span>, <span class="number">0</span>, maxPointIndex);</span><br><span class="line">    <span class="keyword">var</span> thirdPointIndex = Mathf.Clamp(currentUnderSegment.StartPointIndex + <span class="number">2</span>, <span class="number">0</span>, maxPointIndex);</span><br><span class="line">    <span class="keyword">var</span> fourthPointIndex = Mathf.Clamp(currentUnderSegment.StartPointIndex + <span class="number">3</span>, <span class="number">0</span>, maxPointIndex);</span><br><span class="line">    <span class="keyword">return</span> BezierUtilities.CaculateCubicBezierPoint(CaculatePathPointList[firstPointIndex],</span><br><span class="line">                                                    CaculatePathPointList[secondPointIndex],</span><br><span class="line">                                                    CaculatePathPointList[thirdPointIndex],</span><br><span class="line">                                                    CaculatePathPointList[fourthPointIndex],</span><br><span class="line">                                                    currentUnderSegmentPercent);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 获取Cutmull-Roll Spline路线指定比例路点位置</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;t&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> Vector3 <span class="title">GetCRSplinePointAt</span>(<span class="params"><span class="built_in">float</span> t</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> pointNum = CaculatePathPointList.Count;</span><br><span class="line">    <span class="keyword">var</span> maxPointIndex = pointNum - <span class="number">1</span>;</span><br><span class="line">    TSegment currentUnderSegment;</span><br><span class="line">    <span class="built_in">float</span> currentUnderSegmentPercent;</span><br><span class="line">    GetRadioSegmentAndPercent(t, <span class="keyword">out</span> currentUnderSegment, <span class="keyword">out</span> currentUnderSegmentPercent);</span><br><span class="line">    <span class="keyword">if</span> (currentUnderSegment == <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> Vector3.zero;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> firstPointIndex = currentUnderSegment.StartPointIndex;</span><br><span class="line">    <span class="keyword">var</span> secondPointIndex = Mathf.Clamp(currentUnderSegment.StartPointIndex + <span class="number">1</span>, <span class="number">0</span>, maxPointIndex);</span><br><span class="line">    <span class="keyword">var</span> thirdPointIndex = Mathf.Clamp(currentUnderSegment.StartPointIndex + <span class="number">2</span>, <span class="number">0</span>, maxPointIndex);</span><br><span class="line">    <span class="keyword">var</span> fourthPointIndex = Mathf.Clamp(currentUnderSegment.StartPointIndex + <span class="number">3</span>, <span class="number">0</span>, maxPointIndex);</span><br><span class="line">    <span class="keyword">return</span> BezierUtilities.CaculateCRSplinePoint(CaculatePathPointList[firstPointIndex],</span><br><span class="line">                                                 CaculatePathPointList[secondPointIndex],</span><br><span class="line">                                                 CaculatePathPointList[thirdPointIndex],</span><br><span class="line">                                                 CaculatePathPointList[fourthPointIndex],</span><br><span class="line">                                                 currentUnderSegmentPercent);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 获取指定比例路点所处分段和分段所占比例</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;t&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;segment&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;segmentPercent&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">GetRadioSegmentAndPercent</span>(<span class="params"><span class="built_in">float</span> t, <span class="keyword">out</span> TSegment segment, <span class="keyword">out</span> <span class="built_in">float</span> segmentPercent</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> pointNum = PathPointList.Count;</span><br><span class="line">    <span class="keyword">if</span> (pointNum == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        segment = <span class="literal">null</span>;</span><br><span class="line">        segmentPercent = <span class="number">0f</span>;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (pointNum == <span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        segment = SegmentList[<span class="number">0</span>];</span><br><span class="line">        segmentPercent = <span class="number">1f</span>;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    t = Mathf.Clamp01(t);</span><br><span class="line">    <span class="comment">// 缓动公式对路线插值的影响</span></span><br><span class="line">    <span class="keyword">var</span> easeFunc = EasingFunction.GetEasingFunction(Ease);</span><br><span class="line">    t = easeFunc(<span class="number">0</span>, <span class="number">1</span>, t);</span><br><span class="line">    <span class="keyword">var</span> distance = t * Length;</span><br><span class="line">    segment = SegmentList[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>, length = SegmentList.Count - <span class="number">1</span>; i &lt; length; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        distance -= SegmentList[i].Length;</span><br><span class="line">        segment = SegmentList[i];</span><br><span class="line">        <span class="keyword">if</span> (distance &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    segmentPercent = (segment.Length + distance) / segment.Length;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>自定义路点数据编辑面板：</p>
<p><img src="/img/Unity/PathPointTool/CustomPathDataInspector.PNG" alt="CustomPathDataInspector"></p>
<p>自定义Tile绘制配置面板:</p>
<p><img src="/img/Unity/PathPointTool/CustomTileInspector.PNG" alt="CustomTileInspector"></p>
<p>可视化路点路线展示:</p>
<p><img src="/img/Unity/PathPointTool/CubicBezierDraw.PNG" alt="CubicBezierDraw"></p>
<p>自定义路线数据导出：</p>
<p><img src="/img/Unity/PathPointTool/CustomPathDataExport.PNG" alt="CustomPathDataExport"></p>
<p>LineRenderer可视化展示：</p>
<p><img src="/img/Unity/PathPointTool/CutmullRomSplineDraw.PNG" alt="CutmullRomSplineDraw"></p>
<p>Ease插值类型：</p>
<p><img src="/img/Unity/Math/EaseLerpFunction.png" alt="EaseLerpFunction"></p>
<p>M个点的N个3阶Bezier插值计算思路如下：</p>
<ol>
<li><strong>N个3阶Bezier曲线的组合插值是通过将M个点分成N段3阶Bezier，计算出总长度且每段Bezier存储起始点索引和Bezier类型(影响当前Bezier的采样点数)和路段长度</strong></li>
<li><strong>当我们要计算一个插值比例t(0-1)进度插值计算时，首先根据总距离和进度映射计算出在哪一段Bezier路段</strong></li>
<li><strong>映射计算到对应3阶Bezier段后，再进行单个3阶Bezier曲线比例插值从而得到我们M个点的插值比例t(0-1)的最终插值位置</strong></li>
</ol>
<p>Cutmull-Rom Spline曲线经过首尾两个控制点思路：</p>
<ol>
<li><strong>利用Catmull-Rom Spline曲线会通过中间两个控制点且中间两个点经过时的切线与前后两个控制点连线平行，那么我可以可以通过模拟构造一个P(-1)&#x3D;2P0-P1(确保P(-1)P1和P0切线平行从而确保从P0处切线平行)，利用P(-1)P0P1P2构造一个CatmullRomSpline曲线即可画出P0开始的P0P1的曲线。最后一段曲线同理，构造一个P(N+1)&#x3D;2P(N)-P(N-1)，然后绘制P(N-2)P(N-1)P(N)P(N+1)即可绘制出P(N-1)P(N)的曲线。</strong></li>
</ol>
<p>TODO:</p>
<ol>
<li><strong>将运行时使用TPathTweenerManager运动的曲线支持可配置化可视化绘制</strong></li>
</ol>
<h1 id="学习总结"><a href="#学习总结" class="headerlink" title="学习总结"></a>学习总结</h1><ol>
<li><strong>Bezier曲线是一个N个点之间递归插值计算的过程</strong></li>
<li><strong>复杂的很多点路线插值一般不会采用N阶Bezier曲线插值而是采用换算成N个3阶Bezier曲线插值的方式降低计算复杂度</strong></li>
<li><strong>Catmull-Rom Spline确保通过首尾控制点是通过插入头尾两个虚拟点的方式实现的。</strong></li>
<li><strong>缓动结合Bezier曲线的使用主要体现在最后一步插值时对t值的运算替换上</strong></li>
<li><strong>纯Editor模拟更新驱动需要InitializeOnLoad，ExecuteInEditMode和InitializeOnLoadMethod标签加EditorApplication.update实现即使代码编译后也能正确注入和取消EditorApplication.update的流程</strong></li>
<li><strong>LineRenerer默认useWorldSpace为true，表示设置的SetPositions是世界坐标。</strong></li>
<li><strong>LineRenderer有两种朝向显示模式Alignment.View和Alignment.TransformZ，前者是类似BillBoard朝向摄像机，后者是朝向Z轴，一般纯3D路线个人觉得应该是后者加上旋转的方式。</strong></li>
<li><strong>LineRenderer的纹理渲染(Texture Mode)方式有四种，Stretch(使用单次纹理拉伸铺满的方式)，Tile(重复显示，渲染里Tile的概念，基于世界单位长度细分，使用Material.SetTextureScale来设置重复多少次纹理填充)，DistributePerSegment(好像是每个顶点间映射一次纹理，默认假设顶点间间距已经平均好了)，RepeatPerSegment(重复显示纹理，使用Material.SetTextureScale来设置重复多少次纹理填充)。</strong></li>
<li><strong>LineRenderer修改Width后如果细分的点不够多，可能出现即使连接的是直线也在拐角处显示有问题，需要细分更多的点来解决此问题。</strong></li>
</ol>
<h1 id="Github"><a href="#Github" class="headerlink" title="Github"></a>Github</h1><p>个人Github:</p>
<p><a href="http://tonytang1990.github.io/2020/05/29/%E6%95%B0%E5%AD%A6%E4%B8%8E%E7%BC%93%E5%8A%A8/">数学缓动</a></p>
<p><a href="http://tonytang1990.github.io/2022/02/20/UnityEditor%E7%9F%A5%E8%AF%86/">UnityEditor知识</a></p>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a target="_blank" rel="noopener" href="https://developer.aliyun.com/article/803862">Unity 之 贝塞尔曲线介绍和实际使用</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/QO_GQ/article/details/116711205">unity利用高阶贝塞尔曲线进行的轨道移动</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_42139931/article/details/129867962">Bezier Curve 贝塞尔曲线 - 在Unity中实现路径编辑</a></p>
<p><a target="_blank" rel="noopener" href="https://denisrizov.com/2016/06/02/bezier-curves-unity-package-included/">bezier-curves-unity-package-included</a></p>
<p><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/zh-sg/%E8%B2%9D%E8%8C%B2%E6%9B%B2%E7%B7%9A">贝塞尔曲线</a></p>
<p><a target="_blank" rel="noopener" href="https://denisrizov.com/2016/06/02/bezier-curves-unity-package-included/">Bezier Curves</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/wsf09/article/details/103453496">Catmull-Rom插值算法</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/i_dovelemon/article/details/47984241">插值技术之Catmull-Rom Spline Interpolating(2)</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Editor/">Editor</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Editor/">Editor</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2023/03/10/EmmyLua注释生成工具/" title="EmmyLua注释生成工具" itemprop="url">EmmyLua注释生成工具</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Tony Tang" target="_blank" itemprop="author">Tony Tang</a>
		
  <p class="article-time">
    <time datetime="2023-03-09T16:00:30.000Z" itemprop="datePublished"> 发表于 2023-03-10</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>本章节是为了记录Lua开发过程中，关于EmmyLua插件的CSharp注释生成工具的编写和使用介绍。</p>
<p>项目需求需要用到Lua作为开发语言，众所周知Lua是弱类型解析执行语言，所以即使在IDE的加持下，开发和协同效率都会比较低。从而为了提高Lua开发效率，<a target="_blank" rel="noopener" href="https://github.com/EmmyLua">EmmyLua</a>这个第三方插件诞生了，他提供了<strong>Lua调试</strong>以及<strong>Lua注释编写解析后类型推断提示</strong>等功能。</p>
<p>正是因为EmmyLua的类型推断是基于我们的代码注释而来的，所以我们在Lua开发过程中，想要快速得到CSharp等代码类的访问提示，那我们就需要生成对应的CS的Lua注释代码，<strong>此工具正是为了生成项目里CSharp代码的EmmyLua注释而生的。</strong></p>
<ul>
<li><p>目标</p>
<p><strong>高度可配置化的CSharp代码EmmyLua注释生成工具</strong></p>
</li>
</ul>
<h2 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h2><p>自定义配置需求:</p>
<ol>
<li><strong>支持配置不同导出类型输出目录</strong></li>
<li><strong>支持配置指定Assemble不参与导出(加入黑名单)</strong></li>
<li><strong>支持配置指定Assemble的导出分类</strong>**</li>
<li><strong>支持配置指定Assemble，Namespace，Type是否导出EmmyLua注释</strong></li>
<li><strong>支持勾选一键嵌套勾选导出设置</strong></li>
</ol>
<p>CSharp导出需求:</p>
<ol>
<li><strong>类(e.g. 普通类, 抽象类)</strong></li>
<li><strong>接口</strong></li>
<li><strong>值类型(含枚举)</strong></li>
<li><strong>成员，属性，方法，event</strong></li>
</ol>
<p>Note:</p>
<ol>
<li><strong>不支持匿名类，泛型类，代码生成类和代码生成类内部类</strong></li>
<li><strong>不支持泛型成员，泛型属性，泛型方法，泛型</strong>*</li>
</ol>
<h2 id="设计"><a href="#设计" class="headerlink" title="设计"></a>设计</h2><p><strong>基于项目CS代码，通过反射获取访问所有Assemble以及相关类型信息数据统计读取，结合Unity Editor窗口工具实现可视化自定义勾选类型注释导出的高度可配置工具。</strong></p>
<p>知识点主要是反射和简单的EditorGUI编写。</p>
<p>设计代码就不详细讲解了，源代码链接:</p>
<p><a target="_blank" rel="noopener" href="https://github.com/TonyTang1990/EmmyLuaGenerator">EmmyLuaGenerator</a></p>
<p>这里主要提一下在判定哪些类型需要参与导出时的一些核心类型判定代码：</p>
<ul>
<li><p><strong>判定是否是委托</strong></p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 委托类型</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Type DelegateType = <span class="keyword">typeof</span>(Delegate);</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 指定类型是否是委托相关类型</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;type&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">bool</span> <span class="title">IsDelegateAssignableType</span>(<span class="params">Type type</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> DelegateType.IsAssignableFrom(type);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>判定是否是编译生成类型(e.g. 匿名类)</strong></p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 编译类型属性类型</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Type CompilerGeneratedAttributeType = <span class="keyword">typeof</span>(CompilerGeneratedAttribute);</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 指定类型是否是编译生成类型(e.g. 匿名类)</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;type&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">bool</span> <span class="title">IsCompilerType</span>(<span class="params">Type type</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> Attribute.GetCustomAttribute(type, CompilerGeneratedAttributeType) != <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>判定是否是嵌套在编译生成类型里的类型(e.g. 匿名内部类)</strong></p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 指定类型是否是编译生成类型(e.g. 匿名类)</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;type&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">bool</span> <span class="title">IsCompilerType</span>(<span class="params">Type type</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> Attribute.GetCustomAttribute(type, CompilerGeneratedAttributeType) != <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 指定类型是否嵌套在编译生成类型里的类型(e.g. 匿名类)</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;type&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">bool</span> <span class="title">IsNestedCompilerType</span>(<span class="params">Type type</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span>(!type.IsNested || type.DeclaringType == <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(IsCompilerType(type.DeclaringType))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> IsNestedCompilerType(type.DeclaringType);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>判定是否是可空类型</strong></p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 是否是Nullable类型</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;type&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">bool</span> <span class="title">IsNullableType</span>(<span class="params">Type type</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> Nullable.GetUnderlyingType(type) != <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>判定是否是数值类型</strong></p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 数值类型HashSet</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> HashSet&lt;Type&gt; NumericHashSet = <span class="keyword">new</span> HashSet&lt;Type&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">typeof</span>(Byte), <span class="keyword">typeof</span>(SByte), <span class="keyword">typeof</span>(Int16), <span class="keyword">typeof</span>(Int32), <span class="keyword">typeof</span>(Int64),</span><br><span class="line">    <span class="keyword">typeof</span>(<span class="built_in">uint</span>), <span class="keyword">typeof</span>(UInt16), <span class="keyword">typeof</span>(UInt32), <span class="keyword">typeof</span>(UInt64), <span class="keyword">typeof</span>(BigInteger),</span><br><span class="line">    <span class="keyword">typeof</span>(<span class="built_in">float</span>), <span class="keyword">typeof</span>(<span class="built_in">double</span>), <span class="keyword">typeof</span>(<span class="built_in">decimal</span>), <span class="keyword">typeof</span>(Single),</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 是否是数值类型</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;type&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">bool</span> <span class="title">IsNumericType</span>(<span class="params">Type type</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> NumericHashSet.Contains(type);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>判定是否是Unity遗弃数据(类，成员，方法…….)</strong></p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Unity标记遗弃的成员</span></span><br><span class="line"><span class="keyword">var</span> isObsoleteField = Attribute.GetCustomAttribute(fieldInfo, ObsoleteAttributeType);</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="实战使用"><a href="#实战使用" class="headerlink" title="实战使用"></a>实战使用</h2><ul>
<li><p>工具入口</p>
<p><img src="/img/Lua/EmmyLuaGenerator/EmmyLuaGeneratorEntry.PNG" alt="EmmyLuaGeneratorEntry"></p>
</li>
<li><p>EmmyLua注释生成器编辑窗口</p>
<p><img src="/img/Lua/EmmyLuaGenerator/EmmyLuaGeneratorPreview.PNG" alt="EmmyLuaGeneratorPreview"></p>
</li>
<li><p>自定义导出Assemble，Namespace和Class勾选</p>
<p><img src="/img/Lua/EmmyLuaGenerator/CodeExportSetting.PNG" alt="CustomExportSetting"></p>
</li>
<li><p>生成EmmyLua注释</p>
<p><img src="/img/Lua/EmmyLuaGenerator/GenerateEmmyLuaAnnotation.PNG" alt="GenerateEmmyLuaAnnotation"></p>
</li>
</ul>
<p>从上面可以看到，我把项目代码的导出分类，归为5类:</p>
<ol>
<li>Unity代码</li>
<li>DotNet代码</li>
<li>项目代码</li>
<li>FGUI代码</li>
<li>第三方代码</li>
</ol>
<p>通过给每一个Assemble配置导出分类可以实现指定Assemble的EmmyLua注释导出到指定输出目录。</p>
<p>最后让我们来看看导出的EmmyLua代码:</p>
<ul>
<li><p>项目<strong>PathUtilities</strong>注释生成</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">---@class CS.PathUtilities : CS.System.Object</span><br><span class="line">local PathUtilities = &#123;&#125;</span><br><span class="line">---@param path <span class="built_in">string</span> @</span><br><span class="line">---@return <span class="built_in">string</span> @</span><br><span class="line">function PathUtilities.GetRegularPath(path) end</span><br><span class="line"></span><br><span class="line">---@param path <span class="built_in">string</span> @</span><br><span class="line">---@return <span class="built_in">string</span> @</span><br><span class="line">function PathUtilities.GetFolderName(path) end</span><br><span class="line"></span><br><span class="line">---@param folderFullPath <span class="built_in">string</span> @</span><br><span class="line">---@return <span class="built_in">string</span> @</span><br><span class="line">function PathUtilities.GetAssetsRelativeFolderPath(folderFullPath) end</span><br><span class="line"></span><br><span class="line">---@return <span class="built_in">string</span> @</span><br><span class="line">function PathUtilities.GetProjectPath() end</span><br><span class="line"></span><br><span class="line">---@return <span class="built_in">string</span> @</span><br><span class="line">function PathUtilities.GetProjectFullPath() end</span><br><span class="line"></span><br><span class="line">---@param folderfullpath <span class="built_in">string</span> @</span><br><span class="line">---@return <span class="built_in">string</span> @</span><br><span class="line">function PathUtilities.GetProjectRelativeFolderPath(folderfullpath) end</span><br><span class="line"></span><br><span class="line">---@param assetpath <span class="built_in">string</span> @</span><br><span class="line">---@return <span class="built_in">string</span> @</span><br><span class="line">function PathUtilities.GetAssetFullPath(assetpath) end</span><br><span class="line"></span><br><span class="line">---@param path <span class="built_in">string</span> @</span><br><span class="line">---@param postFix <span class="built_in">string</span> @</span><br><span class="line">---@return <span class="built_in">string</span> @</span><br><span class="line">function PathUtilities.GetPathWithoutPostFix(path, postFix) end</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> PathUtilities</span><br></pre></td></tr></table></figure>
</li>
<li><p>C#的<strong>System.Object</strong>注释生成</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">---@class CS.System.Object</span><br><span class="line">local Object = &#123;&#125;</span><br><span class="line">---@param obj CS.System.Object @</span><br><span class="line">---@return boolean @</span><br><span class="line">function Object:Equals(obj) end</span><br><span class="line"></span><br><span class="line">---@return number @</span><br><span class="line">function Object:GetHashCode() end</span><br><span class="line"></span><br><span class="line">---@return CS.System.Type @</span><br><span class="line">function Object:GetType() end</span><br><span class="line"></span><br><span class="line">---@return <span class="built_in">string</span> @</span><br><span class="line">function Object:ToString() end</span><br><span class="line"></span><br><span class="line">---@param objA CS.System.Object @</span><br><span class="line">---@param objB CS.System.Object @</span><br><span class="line">---@return boolean @</span><br><span class="line">function Object.Equals(objA, objB) end</span><br><span class="line"></span><br><span class="line">---@param objA CS.System.Object @</span><br><span class="line">---@param objB CS.System.Object @</span><br><span class="line">---@return boolean @</span><br><span class="line">function Object.ReferenceEquals(objA, objB) end</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> Object</span><br></pre></td></tr></table></figure>
</li>
<li><p>Unity的<strong>UnityEngine.Object</strong>注释生成</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">---@class CS.UnityEngine.Object : CS.System.Object</span><br><span class="line">local Object = &#123;&#125;</span><br><span class="line">---@field <span class="keyword">public</span> name <span class="built_in">string</span> @</span><br><span class="line">---@field <span class="keyword">public</span> hideFlags number @</span><br><span class="line">---@return number @</span><br><span class="line">function Object:GetInstanceID() end</span><br><span class="line"></span><br><span class="line">---@return number @</span><br><span class="line">function Object:GetHashCode() end</span><br><span class="line"></span><br><span class="line">---@param other CS.System.Object @</span><br><span class="line">---@return boolean @</span><br><span class="line">function Object:Equals(other) end</span><br><span class="line"></span><br><span class="line">---@return <span class="built_in">string</span> @</span><br><span class="line">function Object:ToString() end</span><br><span class="line"></span><br><span class="line">---@param original CS.UnityEngine.Object @</span><br><span class="line">---@param position CS.UnityEngine.Vector3 @</span><br><span class="line">---@param rotation CS.UnityEngine.Quaternion @</span><br><span class="line">---@return CS.UnityEngine.Object @</span><br><span class="line">function Object.Instantiate(original, position, rotation) end</span><br><span class="line"></span><br><span class="line">---@param original CS.UnityEngine.Object @</span><br><span class="line">---@param position CS.UnityEngine.Vector3 @</span><br><span class="line">---@param rotation CS.UnityEngine.Quaternion @</span><br><span class="line">---@param parent CS.UnityEngine.Transform @</span><br><span class="line">---@return CS.UnityEngine.Object @</span><br><span class="line">function Object.Instantiate(original, position, rotation, parent) end</span><br><span class="line"></span><br><span class="line">---@param original CS.UnityEngine.Object @</span><br><span class="line">---@return CS.UnityEngine.Object @</span><br><span class="line">function Object.Instantiate(original) end</span><br><span class="line"></span><br><span class="line">---@param original CS.UnityEngine.Object @</span><br><span class="line">---@param parent CS.UnityEngine.Transform @</span><br><span class="line">---@return CS.UnityEngine.Object @</span><br><span class="line">function Object.Instantiate(original, parent) end</span><br><span class="line"></span><br><span class="line">---@param original CS.UnityEngine.Object @</span><br><span class="line">---@param parent CS.UnityEngine.Transform @</span><br><span class="line">---@param instantiateInWorldSpace boolean @</span><br><span class="line">---@return CS.UnityEngine.Object @</span><br><span class="line">function Object.Instantiate(original, parent, instantiateInWorldSpace) end</span><br><span class="line"></span><br><span class="line">---@param obj CS.UnityEngine.Object @</span><br><span class="line">---@param t number @</span><br><span class="line">function Object.Destroy(obj, t) end</span><br><span class="line"></span><br><span class="line">---@param obj CS.UnityEngine.Object @</span><br><span class="line">function Object.Destroy(obj) end</span><br><span class="line"></span><br><span class="line">---@param obj CS.UnityEngine.Object @</span><br><span class="line">---@param allowDestroyingAssets boolean @</span><br><span class="line">function Object.DestroyImmediate(obj, allowDestroyingAssets) end</span><br><span class="line"></span><br><span class="line">---@param obj CS.UnityEngine.Object @</span><br><span class="line">function Object.DestroyImmediate(obj) end</span><br><span class="line"></span><br><span class="line">---@param type CS.System.Type @</span><br><span class="line">---@return CS.UnityEngine.Object[] @</span><br><span class="line">function Object.FindObjectsOfType(type) end</span><br><span class="line"></span><br><span class="line">---@param type CS.System.Type @</span><br><span class="line">---@param includeInactive boolean @</span><br><span class="line">---@return CS.UnityEngine.Object[] @</span><br><span class="line">function Object.FindObjectsOfType(type, includeInactive) end</span><br><span class="line"></span><br><span class="line">---@param target CS.UnityEngine.Object @</span><br><span class="line">function Object.DontDestroyOnLoad(target) end</span><br><span class="line"></span><br><span class="line">---@param type CS.System.Type @</span><br><span class="line">---@return CS.UnityEngine.Object @</span><br><span class="line">function Object.FindObjectOfType(type) end</span><br><span class="line"></span><br><span class="line">---@param type CS.System.Type @</span><br><span class="line">---@param includeInactive boolean @</span><br><span class="line">---@return CS.UnityEngine.Object @</span><br><span class="line">function Object.FindObjectOfType(type, includeInactive) end</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> Object</span><br></pre></td></tr></table></figure>

<p><strong>更多的注释生成就不一一展示了，可以看到通过EmmyLua注释生成工具，我已经成功的实现了导出EmmyLua注释的高度自由的自定义配置，并且基于该配置成功生成了符合EmmyLua注释规则的Lua代码，有了这个工具，我们就可以根据项目的自定义需求快速实现导出相关类型EmmyLua注释代码了。从而实现利用EmmyLua的注释类型推断功能帮助我们高效的编写Lua代码了。</strong></p>
</li>
</ul>
<p>Note:</p>
<ol>
<li><strong>以上我只选了一些常规的Assemble和类型参与导出，需要更多的自定义导出可自行配置。</strong></li>
<li><strong>上述我只支持了5种导出类型分类，想要自定义更多分类可自行修改源码。</strong></li>
<li><strong>为了GUI显示效率，这里最大Assemble分析数量限制了75，大部分项目Assemble数量会远超75，但真正需要导出的Assemble数量一般不会超过75，也就是说设置完Assemble黑名单后，75最大Assemble显示数量是满足使用需求的，不足的话自行修改。</strong></li>
<li><strong>想触发CS脚本代码分析可保存配置后重新打开EmmyLua代码生成窗口即可。</strong></li>
</ol>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a target="_blank" rel="noopener" href="https://emmylua.github.io/annotation.html">EmmyLua注释编写规范</a></p>
<h2 id="GitHub"><a href="#GitHub" class="headerlink" title="GitHub"></a>GitHub</h2><p><a target="_blank" rel="noopener" href="https://github.com/EmmyLua">EmmyLua</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/TonyTang1990/EmmyLuaGenerator">EmmyLuaGenerator</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Lua/">Lua</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Other/">Other</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2022/10/12/异步编程/" title="异步编程" itemprop="url">异步编程</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Tony Tang" target="_blank" itemprop="author">Tony Tang</a>
		
  <p class="article-time">
    <time datetime="2022-10-12T02:43:00.000Z" itemprop="datePublished"> 发表于 2022-10-12</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>游戏开发过程中为了无论资源加载异步还是逻辑异步，异步都是不可或缺的一部分。本章节是为了深入理解C#的异步编程以及Unity里异步编程使用而编写。</p>
<h2 id="异步编程"><a href="#异步编程" class="headerlink" title="异步编程"></a>异步编程</h2><p>Unity里最初的模拟异步编程概念的当之无愧是携程，但携程实际上是单线程通过每帧等待实现异步模拟运行的而非真正的异步编程。</p>
<p>异步编程的过程中我们往往会采用回调式的方式来编写代码，这回导致回调地狱，导致代码理解起来比较困难，有了Task异步编程我们可以实现类似同步式的代码编写来编写异步代码。</p>
<p>而本章节的重点是真正深入了解异步编程，C#里的最新的异步编程主要是通过Task</p>
<h3 id="Task-based-Asynchronous-Pattern-TAP"><a href="#Task-based-Asynchronous-Pattern-TAP" class="headerlink" title="Task-based Asynchronous Pattern(TAP)"></a>Task-based Asynchronous Pattern(TAP)</h3><p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/dotnet/csharp/async">The core of async programming is the <code>Task</code> and <code>Task</code> objects, which model asynchronous operations. They are supported by the <code>async</code> and <code>await</code> keywords. </a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/dotnet/standard/asynchronous-programming-patterns/task-based-asynchronous-pattern-tap">TAP uses a single method to represent the initiation and completion of an asynchronous operation. </a></p>
<p>从上面的介绍可以看出异步编程的核心是Task实现了异步操作，并且支持async和await关键词，其次<strong>TAP</strong>通过方法定义就完成了所有的异步操作初始化和方法定义。</p>
<h3 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h3><ol>
<li><strong>await can only be used inside an async method.(await只能用在async标记的方法内)</strong></li>
<li><strong>async methods need to have an await keyword in their body or they will never yield!(async标记的方法需要一个await关键词在方法定义内，不然这个异步方法不会暂停会同步执行)</strong></li>
</ol>
<h3 id="Task"><a href="#Task" class="headerlink" title="Task"></a>Task</h3><p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/dotnet/api/system.threading.tasks.task?view=net-7.0">The Task class represents a single operation that does not return a value and that usually executes asynchronously. Task objects are one of the central components of the task-based asynchronous pattern first introduced in the .NET Framework 4. Because the work performed by a Task object typically executes asynchronously on a thread pool thread rather than synchronously on the main application thread, you can use the Status property, as well as the IsCanceled, IsCompleted, and IsFaulted properties, to determine the state of a task. </a></p>
<p>从介绍可以看出，异步编程主要是通过Task类的抽象，而Task的异步编程底层伴随着线程池，我们使用的人可以不用关心底层线程池的优化调度问题。通过Task抽象异步编程，Task可以返回异步运行状态IsCanceled,IsCompleted,IsFaulted等来查看异步运行状态。</p>
<p>通过实战使用，了解下Task的基础使用以及底层跨线程的设计:</p>
<h4 id="Task基础使用"><a href="#Task基础使用" class="headerlink" title="Task基础使用"></a>Task基础使用</h4><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 响应基础Task使用按钮点击</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">OnBtnBasicTaskUsingClick</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 创建一个Task1但不开始</span></span><br><span class="line">    Task task1 = <span class="keyword">new</span> Task(mTaskActionDelegate, <span class="string">&quot;Task1&quot;</span>);</span><br><span class="line">    <span class="comment">// 通过Task工厂创建一个Task2并等待完成</span></span><br><span class="line">    Task task2 = Task.Factory.StartNew(mTaskActionDelegate, <span class="string">&quot;Task2&quot;</span>);</span><br><span class="line">    task2.Wait();</span><br><span class="line">    <span class="comment">// Task1开始</span></span><br><span class="line">    task1.Start();</span><br><span class="line">    Debug.Log(<span class="string">$&quot;Task1 has been launched. Main Thread:<span class="subst">&#123;Thread.CurrentThread.ManagedThreadId&#125;</span>&quot;</span>);</span><br><span class="line">    <span class="comment">// 等待Task1完成</span></span><br><span class="line">    task1.Wait();</span><br><span class="line">    <span class="comment">// 通过Task.Run创建Task3并等待完成</span></span><br><span class="line">    Task task3 = Task.Run(()=&gt;</span><br><span class="line">                          &#123;</span><br><span class="line">                              Debug.Log(<span class="string">$&quot;ActionName:Task3&quot;</span>);</span><br><span class="line">                              Debug.Log(<span class="string">$&quot;Task:<span class="subst">&#123;Task.CurrentId&#125;</span> Thread:<span class="subst">&#123;Thread.CurrentThread.ManagedThreadId&#125;</span>&quot;</span>);</span><br><span class="line">                          &#125;);</span><br><span class="line">    Debug.Log(<span class="string">$&quot;Task3 has been launched. Main Thread:<span class="subst">&#123;Thread.CurrentThread.ManagedThreadId&#125;</span>&quot;</span>);</span><br><span class="line">    task3.Wait();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Task使用方法</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;actionName&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">TaskAction</span>(<span class="params"><span class="built_in">object</span> actionName</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    Debug.Log(<span class="string">$&quot;ActionName:<span class="subst">&#123;actionName&#125;</span>&quot;</span>);</span><br><span class="line">    Debug.Log(<span class="string">$&quot;Task:<span class="subst">&#123;Task.CurrentId&#125;</span> Thread:<span class="subst">&#123;Thread.CurrentThread.ManagedThreadId&#125;</span>&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/img/CSharp/Async/TaskBasicUsing.PNG" alt="TaskBasicUsing"></p>
<p>从上面的Task尝试可以看出，Task是在不同线程开启的，其次Task如果是单独的New是不会自动开始的，Task.Run和Task.Factory.StartNew才会直接开始一个Task。</p>
<h4 id="Task使用Async和Await实现异步方法定义和等待"><a href="#Task使用Async和Await实现异步方法定义和等待" class="headerlink" title="Task使用Async和Await实现异步方法定义和等待"></a>Task使用Async和Await实现异步方法定义和等待</h4><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 响应Task等待按钮点击 </span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">async</span> <span class="keyword">void</span> <span class="title">OnBtnAwaitTaskUsingClick</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> awaitTask = Task.Run(AwaitTaskAction);</span><br><span class="line">    Debug.Log(<span class="string">$&quot;AwaitTaskAction has been launched. Main Thread:<span class="subst">&#123;Thread.CurrentThread.ManagedThreadId&#125;</span>&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> sumResult = <span class="keyword">await</span> awaitTask;</span><br><span class="line">    Debug.Log(<span class="string">$&quot;sumResult:<span class="subst">&#123;sumResult&#125;</span>&quot;</span>);</span><br><span class="line">    Debug.Log(<span class="string">$&quot;DateTime.Now.Millisecond:<span class="subst">&#123;DateTime.Now.Millisecond&#125;</span>&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 等待的Task方法</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">async</span> Task&lt;<span class="built_in">int</span>&gt; <span class="title">AwaitTaskAction</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    Debug.Log(<span class="string">$&quot;AwaitTaskAction Start&quot;</span>);</span><br><span class="line">    Debug.Log(<span class="string">$&quot;DateTime.Now.Millisecond:<span class="subst">&#123;DateTime.Now.Millisecond&#125;</span>&quot;</span>);</span><br><span class="line">    <span class="keyword">await</span> Task.Delay(<span class="number">1</span>);</span><br><span class="line">    Debug.Log(<span class="string">$&quot;AwaitTaskAction After Task.Delay(1)&quot;</span>);</span><br><span class="line">    Debug.Log(<span class="string">$&quot;DateTime.Now.Millisecond:<span class="subst">&#123;DateTime.Now.Millisecond&#125;</span>&quot;</span>);</span><br><span class="line">    <span class="built_in">int</span> sum = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; <span class="number">1000000000</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        sum++;</span><br><span class="line">    &#125;</span><br><span class="line">    Debug.Log(<span class="string">$&quot;AwaitTaskAction End&quot;</span>);</span><br><span class="line">    Debug.Log(<span class="string">$&quot;DateTime.Now.Millisecond:<span class="subst">&#123;DateTime.Now.Millisecond&#125;</span>&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> sum;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/img/CSharp/Async/AwaitTaskUsing.PNG" alt="AwaitTaskUsing"></p>
<p>通过Async关键词，我把OnBtnAwaitTaskUsingClick和AwaitTaskAction方法都定义成了异步方法(既可以通过Task异步调用的方法)。然后结合Await关键词实现了等待异步方法AwaitTaskAction执行完后返回运算结果并打印的效果，可以看到这样一来我们的异步代码编写结合Await关键词就跟同步代码一般是一个线性流程，同时异步方法内通过Task.Delay等类似携程的等待方法实现指定时间指定条件的等待。</p>
<p>那么Async和Await关键词是如何实现异步等待效果的了，让我们结合反编译看一下底层实现:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">AsyncStateMachine((Type) typeof(&lt;AwaitTaskAction&gt;d__10)), DebuggerStepThrough</span>]</span><br><span class="line"><span class="function"><span class="keyword">private</span> Task&lt;<span class="built_in">int</span>&gt; <span class="title">AwaitTaskAction</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    &lt;AwaitTaskAction&gt;d__10 stateMachine = <span class="keyword">new</span> &lt;AwaitTaskAction&gt;d__10 &#123;</span><br><span class="line">        &lt;&gt;<span class="number">4</span>__this = <span class="keyword">this</span>,</span><br><span class="line">        &lt;&gt;t__builder = AsyncTaskMethodBuilder&lt;<span class="built_in">int</span>&gt;.Create(),</span><br><span class="line">        &lt;&gt;<span class="number">1</span>__state = <span class="number">-1</span></span><br><span class="line">    &#125;;</span><br><span class="line">    stateMachine.&lt;&gt;t__builder.Start&lt;&lt;AwaitTaskAction&gt;d__10&gt;(<span class="keyword">ref</span> stateMachine);</span><br><span class="line">    <span class="keyword">return</span> stateMachine.&lt;&gt;t__builder.get_Task();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[<span class="meta">CompilerGenerated</span>]</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">sealed</span> <span class="keyword">class</span> &lt;<span class="title">AwaitTaskAction</span>&gt;<span class="title">d__10</span> : <span class="title">IAsyncStateMachine</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Fields</span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> &lt;&gt;<span class="number">1</span>__state;</span><br><span class="line">    <span class="keyword">public</span> AsyncTaskMethodBuilder&lt;<span class="built_in">int</span>&gt; &lt;&gt;t__builder;</span><br><span class="line">    <span class="keyword">public</span> GameLauncher &lt;&gt;<span class="number">4</span>__this;</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span> &lt;sum&gt;<span class="number">5</span>__1;</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span> &lt;i&gt;<span class="number">5</span>__2;</span><br><span class="line">    <span class="keyword">private</span> TaskAwaiter &lt;&gt;u__1;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Methods</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">MoveNext</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">int</span> num = <span class="keyword">this</span>.&lt;&gt;<span class="number">1</span>__state;</span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        &#123;</span><br><span class="line">            TaskAwaiter awaiter;</span><br><span class="line">            GameLauncher.&lt;AwaitTaskAction&gt;d__10 d__;</span><br><span class="line">            TaskAwaiter awaiter2;</span><br><span class="line">            <span class="keyword">if</span> (num == <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                awaiter = <span class="keyword">this</span>.&lt;&gt;u__1;</span><br><span class="line">                <span class="keyword">this</span>.&lt;&gt;u__1 = <span class="keyword">new</span> TaskAwaiter();</span><br><span class="line">                <span class="keyword">this</span>.&lt;&gt;<span class="number">1</span>__state = num = <span class="number">-1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (num == <span class="number">1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                awaiter2 = <span class="keyword">this</span>.&lt;&gt;u__1;</span><br><span class="line">                <span class="keyword">this</span>.&lt;&gt;u__1 = <span class="keyword">new</span> TaskAwaiter();</span><br><span class="line">                <span class="keyword">this</span>.&lt;&gt;<span class="number">1</span>__state = num = <span class="number">-1</span>;</span><br><span class="line">                <span class="keyword">goto</span> TR_0005;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 开始第一个Task并获得awaiter，通过awaiter来观察Task是否完成。</span></span><br><span class="line">                Debug.Log(<span class="string">&quot;AwaitTaskAction Start&quot;</span>);</span><br><span class="line">                Debug.Log(<span class="string">$&quot;DateTime.Now.Millisecond:<span class="subst">&#123;(<span class="built_in">int</span>) DateTime.get_Now().Millisecond&#125;</span>&quot;</span>);</span><br><span class="line">                awaiter = Task.Delay(<span class="number">1</span>).GetAwaiter();</span><br><span class="line">                <span class="keyword">if</span> (!awaiter.IsCompleted)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// 向未完成的Task中注册continuation action;</span></span><br><span class="line">                    <span class="comment">// continuation action会在Task完成时执行;</span></span><br><span class="line">                    <span class="comment">// 等同于awaiter1.onCompleted(() =&gt; this.MoveNext())</span></span><br><span class="line">                    <span class="keyword">this</span>.&lt;&gt;<span class="number">1</span>__state = num = <span class="number">0</span>;</span><br><span class="line">                    <span class="keyword">this</span>.&lt;&gt;u__1 = awaiter;</span><br><span class="line">                    d__ = <span class="keyword">this</span>;</span><br><span class="line">                    <span class="keyword">this</span>.&lt;&gt;t__builder.AwaitUnsafeOnCompleted&lt;TaskAwaiter, GameLauncher.&lt;AwaitTaskAction&gt;d__10&gt;(<span class="keyword">ref</span> awaiter, <span class="keyword">ref</span> d__);</span><br><span class="line">		            <span class="comment">// return（即交出控制权给AwaitTaskAction的调用者）</span></span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 第一个Task完成(即Task.Delay(1)那部分代码)，获取结果</span></span><br><span class="line">            awaiter.GetResult();</span><br><span class="line">            Debug.Log(<span class="string">&quot;AwaitTaskAction After Task.Delay(1)&quot;</span>);</span><br><span class="line">            Debug.Log(<span class="string">$&quot;DateTime.Now.Millisecond:<span class="subst">&#123;(<span class="built_in">int</span>) DateTime.get_Now().Millisecond&#125;</span>&quot;</span>);</span><br><span class="line">            <span class="keyword">this</span>.&lt;sum&gt;<span class="number">5</span>__1 = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">this</span>.&lt;i&gt;<span class="number">5</span>__2 = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">this</span>.&lt;i&gt;<span class="number">5</span>__2 &lt; <span class="number">0x3b9a</span>_ca00)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="built_in">int</span> num3 = <span class="keyword">this</span>.&lt;sum&gt;<span class="number">5</span>__1;</span><br><span class="line">                    <span class="keyword">this</span>.&lt;sum&gt;<span class="number">5</span>__1 = num3 + <span class="number">1</span>;</span><br><span class="line">                    num3 = <span class="keyword">this</span>.&lt;i&gt;<span class="number">5</span>__2;</span><br><span class="line">                    <span class="keyword">this</span>.&lt;i&gt;<span class="number">5</span>__2 = num3 + <span class="number">1</span>;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                awaiter2 = Task.Delay(<span class="number">2</span>).GetAwaiter();</span><br><span class="line">                <span class="keyword">if</span> (awaiter2.IsCompleted)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">goto</span> TR_0005;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">this</span>.&lt;&gt;<span class="number">1</span>__state = num = <span class="number">1</span>;</span><br><span class="line">                    <span class="keyword">this</span>.&lt;&gt;u__1 = awaiter2;</span><br><span class="line">                    d__ = <span class="keyword">this</span>;</span><br><span class="line">                    <span class="keyword">this</span>.&lt;&gt;t__builder.AwaitUnsafeOnCompleted&lt;TaskAwaiter, GameLauncher.&lt;AwaitTaskAction&gt;d__10&gt;(<span class="keyword">ref</span> awaiter2, <span class="keyword">ref</span> d__);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        TR_0005:</span><br><span class="line">            <span class="comment">// 第二个Task完成(即Task.Delay(2)那部分代码)，获取结果</span></span><br><span class="line">            awaiter2.GetResult();</span><br><span class="line">            Debug.Log(<span class="string">&quot;AwaitTaskAction After Task.Delay(2)&quot;</span>);</span><br><span class="line">            Debug.Log(<span class="string">$&quot;DateTime.Now.Millisecond:<span class="subst">&#123;(<span class="built_in">int</span>) DateTime.get_Now().Millisecond&#125;</span>&quot;</span>);</span><br><span class="line">            Debug.Log(<span class="string">&quot;AwaitTaskAction End&quot;</span>);</span><br><span class="line">            Debug.Log(<span class="string">$&quot;DateTime.Now.Millisecond:<span class="subst">&#123;(<span class="built_in">int</span>) DateTime.get_Now().Millisecond&#125;</span>&quot;</span>);</span><br><span class="line">            <span class="built_in">int</span> result = <span class="keyword">this</span>.&lt;sum&gt;<span class="number">5</span>__1;</span><br><span class="line">            <span class="keyword">this</span>.&lt;&gt;<span class="number">1</span>__state = <span class="number">-2</span>;</span><br><span class="line">            <span class="keyword">this</span>.&lt;&gt;t__builder.SetResult(result);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Exception exception)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">this</span>.&lt;&gt;<span class="number">1</span>__state = <span class="number">-2</span>;</span><br><span class="line">            <span class="keyword">this</span>.&lt;&gt;t__builder.SetException(exception);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">DebuggerHidden</span>]</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">SetStateMachine</span>(<span class="params">IAsyncStateMachine stateMachine</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>上面的代码是通过NetReflector才反编译出来的，之前试过ILSpy和DnSpy都得不到<OnBtnAwaitTaskUsingClick>d__9类定义相关反编译代码。</strong></p>
<p>上面的代码只截取了跟AwaitTaskAction这个异步方法相关的部分。通过上面的代码可以看到，通过async定义异步方法后，编译器帮我们生成了继承至IAsyncStateMachine 的AwaitTaskAction&gt;d__10类，这个类正是实现异步的一个关键抽象(个人理解有点像携程里的迭代器封装逻辑代码调用)。通过构建一个AwaitTaskAction&gt;d__10实例类并调用stateMachine.&lt;&gt;t__builder.Start&lt;<AwaitTaskAction>d__10&gt;(ref stateMachine)触发了状态机的MoveNext()的代码执行。</p>
<p>通过代码生成，我们定义的异步线性流程被划分成了状态机里的几个状态(1__state)，首先<strong>状态从-1</strong>进行初始化:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;AwaitTaskAction&gt;d__10 stateMachine = <span class="keyword">new</span> &lt;AwaitTaskAction&gt;d__10 &#123;</span><br><span class="line">        &lt;&gt;<span class="number">4</span>__this = <span class="keyword">this</span>,</span><br><span class="line">        &lt;&gt;t__builder = AsyncTaskMethodBuilder&lt;<span class="built_in">int</span>&gt;.Create(),</span><br><span class="line">        &lt;&gt;<span class="number">1</span>__state = <span class="number">-1</span></span><br><span class="line">    &#125;;</span><br></pre></td></tr></table></figure>

<p>触发状态机开始后，遇到<strong>第一个Awaiter(await Task.Delay(1))<strong>进行异步Task等待完成，同时将</strong>状态机切换到状态0</strong>:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 开始第一个Task并获得awaiter，通过awaiter来观察Task是否完成。</span></span><br><span class="line">    Debug.Log(<span class="string">&quot;AwaitTaskAction Start&quot;</span>);</span><br><span class="line">    Debug.Log(<span class="string">$&quot;DateTime.Now.Millisecond:<span class="subst">&#123;(<span class="built_in">int</span>) DateTime.get_Now().Millisecond&#125;</span>&quot;</span>);</span><br><span class="line">    awaiter = Task.Delay(<span class="number">1</span>).GetAwaiter();</span><br><span class="line">    <span class="keyword">if</span> (!awaiter.IsCompleted)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 向未完成的Task中注册continuation action;</span></span><br><span class="line">        <span class="comment">// continuation action会在Task完成时执行;</span></span><br><span class="line">        <span class="comment">// 等同于awaiter1.onCompleted(() =&gt; this.MoveNext())</span></span><br><span class="line">        <span class="keyword">this</span>.&lt;&gt;<span class="number">1</span>__state = num = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">this</span>.&lt;&gt;u__1 = awaiter;</span><br><span class="line">        d__ = <span class="keyword">this</span>;</span><br><span class="line">        <span class="keyword">this</span>.&lt;&gt;t__builder.AwaitUnsafeOnCompleted&lt;TaskAwaiter, GameLauncher.&lt;AwaitTaskAction&gt;d__10&gt;(<span class="keyword">ref</span> awaiter, <span class="keyword">ref</span> d__);</span><br><span class="line">        <span class="comment">// return（即交出控制权给AwaitTaskAction的调用者）</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第一个Awaiter等待完成后，状态机继续运行直到遇到<strong>第二个Awaiter(await Task.Delay(2))<strong>并将</strong>状态机状态切换到1</strong>:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (num == <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">    awaiter = <span class="keyword">this</span>.&lt;&gt;u__1;</span><br><span class="line">    <span class="keyword">this</span>.&lt;&gt;u__1 = <span class="keyword">new</span> TaskAwaiter();</span><br><span class="line">    <span class="keyword">this</span>.&lt;&gt;<span class="number">1</span>__state = num = <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line">awaiter.GetResult();</span><br><span class="line">Debug.Log(<span class="string">&quot;AwaitTaskAction After Task.Delay(1)&quot;</span>);</span><br><span class="line">Debug.Log(<span class="string">$&quot;DateTime.Now.Millisecond:<span class="subst">&#123;(<span class="built_in">int</span>) DateTime.get_Now().Millisecond&#125;</span>&quot;</span>);</span><br><span class="line"><span class="keyword">this</span>.&lt;sum&gt;<span class="number">5</span>__1 = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">this</span>.&lt;i&gt;<span class="number">5</span>__2 = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.&lt;i&gt;<span class="number">5</span>__2 &lt; <span class="number">0x3b9a</span>_ca00)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">int</span> num3 = <span class="keyword">this</span>.&lt;sum&gt;<span class="number">5</span>__1;</span><br><span class="line">        <span class="keyword">this</span>.&lt;sum&gt;<span class="number">5</span>__1 = num3 + <span class="number">1</span>;</span><br><span class="line">        num3 = <span class="keyword">this</span>.&lt;i&gt;<span class="number">5</span>__2;</span><br><span class="line">        <span class="keyword">this</span>.&lt;i&gt;<span class="number">5</span>__2 = num3 + <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    awaiter2 = Task.Delay(<span class="number">2</span>).GetAwaiter();</span><br><span class="line">    <span class="keyword">if</span> (awaiter2.IsCompleted)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">goto</span> TR_0005;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">this</span>.&lt;&gt;<span class="number">1</span>__state = num = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">this</span>.&lt;&gt;u__1 = awaiter2;</span><br><span class="line">        d__ = <span class="keyword">this</span>;</span><br><span class="line">        <span class="keyword">this</span>.&lt;&gt;t__builder.AwaitUnsafeOnCompleted&lt;TaskAwaiter, GameLauncher.&lt;AwaitTaskAction&gt;d__10&gt;(<span class="keyword">ref</span> awaiter2, <span class="keyword">ref</span> d__);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span>;</span><br></pre></td></tr></table></figure>

<p>等待第二个Awaiter完成后，继续状态机状态1逻辑执行:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (num == <span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        awaiter2 = <span class="keyword">this</span>.&lt;&gt;u__1;</span><br><span class="line">        <span class="keyword">this</span>.&lt;&gt;u__1 = <span class="keyword">new</span> TaskAwaiter();</span><br><span class="line">        <span class="keyword">this</span>.&lt;&gt;<span class="number">1</span>__state = num = <span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">goto</span> TR_0005;</span><br><span class="line">    &#125;</span><br><span class="line">TR_0005:</span><br><span class="line">    <span class="comment">// 第二个Task完成(即Task.Delay(2)那部分代码)，获取结果</span></span><br><span class="line">    awaiter2.GetResult();</span><br><span class="line">    Debug.Log(<span class="string">&quot;AwaitTaskAction After Task.Delay(2)&quot;</span>);</span><br><span class="line">    Debug.Log(<span class="string">$&quot;DateTime.Now.Millisecond:<span class="subst">&#123;(<span class="built_in">int</span>) DateTime.get_Now().Millisecond&#125;</span>&quot;</span>);</span><br><span class="line">    Debug.Log(<span class="string">&quot;AwaitTaskAction End&quot;</span>);</span><br><span class="line">    Debug.Log(<span class="string">$&quot;DateTime.Now.Millisecond:<span class="subst">&#123;(<span class="built_in">int</span>) DateTime.get_Now().Millisecond&#125;</span>&quot;</span>);</span><br><span class="line">    <span class="built_in">int</span> result = <span class="keyword">this</span>.&lt;sum&gt;<span class="number">5</span>__1;</span><br><span class="line">    <span class="keyword">this</span>.&lt;&gt;<span class="number">1</span>__state = <span class="number">-2</span>;</span><br><span class="line">    <span class="keyword">this</span>.&lt;&gt;t__builder.SetResult(result);</span><br></pre></td></tr></table></figure>

<p>就这样我们所有的异步线性流程都通过代码生成状态机运行的方式，变成了一个一个的状态按顺序执行。</p>
<p>可以看到异步线性流程和核心由两部分组成:</p>
<ol>
<li><strong>Task异步运行机制</strong></li>
<li><strong>异步状态机代码生成</strong></li>
</ol>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/dotnet/csharp/async">On the C# side of things, the compiler transforms your code into a state machine that keeps track of things like yielding execution when an <code>await</code> is reached and resuming execution when a background job has finished.</a></p>
<h4 id="Task异步取消"><a href="#Task异步取消" class="headerlink" title="Task异步取消"></a>Task异步取消</h4><p>Task异步的取消是通过<strong>Cancellation Token</strong>来完成的。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 响应开启等待取消Task按钮点击</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">async</span> <span class="keyword">void</span> <span class="title">OnBtnWaitCancelTaskUsingClick</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    mTaskCancelTokenSource = <span class="keyword">new</span> CancellationTokenSource();</span><br><span class="line">    <span class="keyword">var</span> taskToken = mTaskCancelTokenSource.Token;</span><br><span class="line">    <span class="keyword">var</span> awaitTask = Task.Run(() =&gt;</span><br><span class="line">                             &#123;</span><br><span class="line">                                 <span class="keyword">return</span> AwaitCancelTaskAction(taskToken);</span><br><span class="line">                             &#125;, taskToken);</span><br><span class="line">    Debug.Log(<span class="string">$&quot;AwaitCancelTaskAction has been launched. Main Thread:<span class="subst">&#123;Thread.CurrentThread.ManagedThreadId&#125;</span>&quot;</span>);</span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> sumResult = <span class="keyword">await</span> awaitTask;</span><br><span class="line">        Debug.Log(<span class="string">$&quot;AwaitCancelTaskAction sumResult:<span class="subst">&#123;sumResult&#125;</span>&quot;</span>);</span><br><span class="line">        Debug.Log(<span class="string">$&quot;AwaitCancelTaskAction DateTime.Now.Millisecond:<span class="subst">&#123;DateTime.Now.Millisecond&#125;</span>&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (OperationCanceledException e)</span><br><span class="line">    &#123;</span><br><span class="line">        Debug.Log(e);</span><br><span class="line">        Debug.Log(<span class="string">$&quot;e.CancelLlationToken.Equals(taskCancelToken):<span class="subst">&#123;e.CancellationToken.Equals(taskToken&#125;</span>&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">finally</span></span><br><span class="line">    &#123;</span><br><span class="line">        mTaskCancelTokenSource.Dispose();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 等待取消的Task方法</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;taskToken&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">async</span> Task&lt;<span class="built_in">int</span>&gt; <span class="title">AwaitCancelTaskAction</span>(<span class="params">CancellationToken taskToken</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 检测异步Task是否已经取消</span></span><br><span class="line">    taskToken.ThrowIfCancellationRequested();</span><br><span class="line">    Debug.Log(<span class="string">$&quot;AwaitCancelTaskAction Start&quot;</span>);</span><br><span class="line">    Debug.Log(<span class="string">$&quot;DateTime.Now.Millisecond:<span class="subst">&#123;DateTime.Now.Millisecond&#125;</span>  Thread Id:<span class="subst">&#123;Thread.CurrentThread.ManagedThreadId&#125;</span>&quot;</span>);</span><br><span class="line">    <span class="keyword">await</span> Task.Delay(<span class="number">1</span>);</span><br><span class="line">    <span class="comment">// 检测异步Task是否已经取消</span></span><br><span class="line">    taskToken.ThrowIfCancellationRequested();</span><br><span class="line">    Debug.Log(<span class="string">$&quot;AwaitCancelTaskAction After Task.Delay(1)&quot;</span>);</span><br><span class="line">    Debug.Log(<span class="string">$&quot;DateTime.Now.Millisecond:<span class="subst">&#123;DateTime.Now.Millisecond&#125;</span>&quot;</span>);</span><br><span class="line">    <span class="built_in">int</span> sum = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10000000</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        sum++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">await</span> Task.Delay(<span class="number">2</span>);</span><br><span class="line">    <span class="comment">// 检测异步Task是否已经取消</span></span><br><span class="line">    taskToken.ThrowIfCancellationRequested();</span><br><span class="line">    Debug.Log(<span class="string">$&quot;AwaitCancelTaskAction After Task.Delay(2)&quot;</span>);</span><br><span class="line">    Debug.Log(<span class="string">$&quot;DateTime.Now.Millisecond:<span class="subst">&#123;DateTime.Now.Millisecond&#125;</span>&quot;</span>);</span><br><span class="line">    Debug.Log(<span class="string">$&quot;AwaitCancelTaskAction End&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> sum;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 响应Task取消按钮点击</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnBtnCancelTaskUsingClick</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    mTaskCancelTokenSource?.Cancel();</span><br><span class="line">    Debug.Log(<span class="string">$&quot;取消异步Task&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面的代码可以看到，我们在开启一个需要支持取消的异步Task时需要以下步骤:</p>
<ol>
<li><strong>申请创建了一个CancellationTokenSource对象</strong>，这个对象会包含我们异步Task取消所需的token。</li>
<li><strong>将CancellationTokenSource.token传递给需要异步执行的Task(多层调用要一直传递下去，确保Task正确异步取消</strong>)</li>
<li><strong>在需要异步打断的Task里判定token是否已经取消(token.ThrowIfCancellationRequested())</strong></li>
<li><strong>try catch异步await，确保释放token source(CancellationTokenSource.Dispose())</strong></li>
</ol>
<p>在上面的使用中可以看到，<strong>Task异步是多线程</strong>的，通过Task.Run()我们启用了一个新的线程执行任务，所以打印出的Thread Id和Main Thread Id不一样。</p>
<p>为了确保Task取消后异步逻辑能正确停止，我们在异步逻辑里关键地方都在判定taskToken.ThrowIfCancellationRequested()通知Task进入取消状态。</p>
<h4 id="使用体验"><a href="#使用体验" class="headerlink" title="使用体验"></a>使用体验</h4><p>通过上面的学习使用，这里个人讲讲个人Task的使用心得。</p>
<p>好处:</p>
<ol>
<li>通过Task异步我们能将<strong>异步逻辑跟同步逻辑一样方便的线性流程编写</strong>，不再需要编写回调嵌套(<strong>回调地狱</strong>)的代码。</li>
</ol>
<p>不方便处:</p>
<ol>
<li>Task异步需要定义async关键字，导致所有异步方法都需要加上async关键字(<strong>async传染</strong>)</li>
<li>Task异步取消时，使用者在异步逻辑里需要关心 taskToken是否已经取消(<strong>taskToken.ThrowIfCancellationRequested()</strong>)，这样代码写起来还是比较麻烦</li>
<li>开启一个异步Task需要通过Task.Run或者Task.Factory.StartNew方法，这样导致我们<strong>嵌套调用异步方法传递token时被迫用上闭包这种方式</strong></li>
<li><strong>Task异步是多线程，需要考虑数据多线程访问问题，对开发者多线程相关知识要求更高</strong></li>
</ol>
<h3 id="进阶-UniTask"><a href="#进阶-UniTask" class="headerlink" title="进阶(UniTask)"></a>进阶(UniTask)</h3><p>了解Task异步的基础使用和设计，接下来让我们看看UniTask是如何实现Unity内更优的异步框架设计的。</p>
<p>官网介绍:</p>
<p><strong>UniTask的特点</strong></p>
<ul>
<li>为 Unity 提供有效的无GC async&#x2F;await集成。</li>
<li>基于Struct <code>UniTask&lt;T&gt;</code> 的自定义 AsyncMethodBuilder，实现零GC,使所有Unity的异步操作和协程可以await</li>
<li>基于PlayerLoop的Task（ <code>UniTask.Yield</code>、 <code>UniTask.Delay</code>、 <code>UniTask.DelayFrame</code> 等）这使得能够替换所有协程操作</li>
<li>MonoBehaviour 消息事件和 uGUI 事件为可使用Await&#x2F;AsyncEnumerable</li>
<li>完全在 Unity 的 PlayerLoop 上运行，因此不使用线程，可在 WebGL、wasm 等平台上运行。</li>
<li>异步 LINQ，具有Channel和 AsyncReactiveProperty</li>
<li>防止内存泄漏的 TaskTracker (Task追踪器)窗口</li>
<li>与Task&#x2F;ValueTask&#x2F;IValueTaskSource 的行为高度兼容</li>
</ul>
<p>上面提到UniTask没有使用多线程，这一点对于Unity单线程开发理念更加适合。</p>
<p><strong>更多学习使用待添加……(TODO)</strong></p>
<h2 id="重点知识"><a href="#重点知识" class="headerlink" title="重点知识"></a>重点知识</h2><ol>
<li><strong>Unity子线程内不可访问游戏对象或者组件以及相关方法，只用于处理数据或者逻辑，任何要与主线程发生关系的地方都必须进行回调和上下文切换。</strong></li>
<li><strong>await和async关键词并不一定触发多线程，是否多线程是与使用的具体方式而定(比如Task.Run)</strong></li>
</ol>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/dotnet/csharp/async">Asynchronous programming</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/dotnet/standard/asynchronous-programming-patterns/task-based-asynchronous-pattern-tap">Task-based Asynchronous Pattern(TAP)</a></p>
<h2 id="Github"><a href="#Github" class="headerlink" title="Github"></a>Github</h2><p><a target="_blank" rel="noopener" href="https://github.com/Cysharp/UniTask">UniTask</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Programming/">Programming</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Programming/">Programming</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2022/08/12/红点系统/" title="红点系统" itemprop="url">红点系统</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Tony Tang" target="_blank" itemprop="author">Tony Tang</a>
		
  <p class="article-time">
    <time datetime="2022-08-12T14:19:00.000Z" itemprop="datePublished"> 发表于 2022-08-12</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>游戏开发过程中为了提示玩家有可操作数据，往往会采用显示红点的方式，红点会散布到游戏的各个角落，如果项目初期没有一个好的红点系统，后期维护开发中往往会有数不清的红点bug以及不必要的红点刷新开销。本章节真是为了实现一套高效且高度可扩展和可维护的红点系统而编写的。</p>
<h2 id="红点系统"><a href="#红点系统" class="headerlink" title="红点系统"></a>红点系统</h2><h3 id="红点系统需求"><a href="#红点系统需求" class="headerlink" title="红点系统需求"></a>红点系统需求</h3><p>在开始设计和编写我们需要的红点系统前，让我们先理清下红点的需求:</p>
<ol>
<li><strong>单个红点可能受多个游戏逻辑因素影响</strong></li>
<li><strong>内层红点可以影响外层红点可以不影响外层红点</strong></li>
<li><strong>红点显示逻辑会受功能解锁和游戏数据流程影响</strong></li>
<li><strong>红点样式多种多样(e.g. 1. 纯红点 2. 纯数字红点 3. 新红点 4. 混合红点等)</strong></li>
<li><strong>红点结果计算的数据来源可以是客户端计算红点也可以是服务器已经算好的红点结论(有时候为了优化数据通信量，有些功能的详情会按需请求导致客户端无法直接计算红点，采取后端直接通知红点的方式)</strong></li>
<li><strong>红点分静态红点(界面上固定存在的)和动态红点(列表里数量繁多的)</strong></li>
<li><strong>数据变化会触发红点频繁逻辑运算(有时候还会触发重复运算)导致GC和时间占用</strong></li>
<li><strong>红点影响因素比较多，查询的时候缺乏可视化高效的查询手段</strong></li>
</ol>
<h3 id="红点系统设计"><a href="#红点系统设计" class="headerlink" title="红点系统设计"></a>红点系统设计</h3><p>针对上面的红点需求，我通过以下设计来一一解决:</p>
<ol>
<li><strong>采用前缀树数据结构，从红点命名上解决红点父子定义关联问题</strong></li>
<li><strong>红点运算单元采用最小单元化定义，采用组合定义方式组装红点影响因素，从而实现高度自由的红点运算逻辑组装</strong></li>
<li><strong>红点运算单元作为红点影响显示的最小单元，每一个都会对应逻辑层面的一个计算代码，从而实现和逻辑层关联实现自定义解锁和计算方式</strong></li>
<li><strong>红点运算结果按红点运算单元为单位，采用标脏加延迟计算的方式避免重复运算和结果缓存</strong></li>
<li><strong>红点运算单元支持多种显示类型定义(e.g. 1. 纯红点 2. 纯数字红点 3. 新红点 4. 混合红点等)，红点最终显示类型由所有影响他的红点运算单元计算结果组合而成(e.g. 红点运算单元1(新红点类型)+红点运算单元2(数字红点类型)&#x3D;新红点类型)</strong></li>
<li><strong>除了滚动列表里数量过多的红点采用界面上自行计算的方式，其他红点全部采用静态红点预定义的方式，全部提前定义好红点名以及红点运算单元组成和父子关系等数据</strong></li>
<li><strong>编写自定义EditorWindow实现红点数据全面可视化提升红点系统可维护性</strong></li>
</ol>
<h3 id="前缀树"><a href="#前缀树" class="headerlink" title="前缀树"></a>前缀树</h3><p>在真正实战编写红点系统之前，让我们先了解实现一版前缀树，后续会用到红点系统里解决红点父子关联问题。</p>
<p><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Trie"><strong>trie</strong>，又称<strong>前缀树</strong>或<strong>字典树</strong>，是一种有序树，用于保存关联数组，其中的键通常是字符串。与二叉查找树不同，键不是直接保存在节点中，而是由节点在树中的位置决定。一个节点的所有子孙都有相同的前缀，也就是这个节点对应的字符串，而根节点对应空字符串。</a></p>
<p><img src="/img/DataStructure/TrieExample.png" alt="前缀树结构"></p>
<p>从上面可以看出前缀树也是树机构，但不是通常说的二叉树。</p>
<p>前缀树最典型的应用就是<strong>输入法单次推断</strong>，比如我们输入周星两个字，输入法会根据用户输入的周星两个字去查询词库，看有哪些匹配的词语进行人性化引导提示显示。而这个查询词库匹配的过程就要求很高的查询效率，而前缀树正是完美解决了这一问题。前缀树通过先搜索周节点，然后查找到周节点后继续在周节点下搜寻星字节点，查到星字节点后，以星字节点继续往下搜索匹配出所有符合的单词进行显示，从而通过O(N)的方式实现了快速的单词匹配查询。</p>
<h4 id="前缀树实战"><a href="#前缀树实战" class="headerlink" title="前缀树实战"></a>前缀树实战</h4><p>Trie.cs(抽象前缀树)</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 前缀树</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Trie</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 单词分隔符</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">char</span> Separator</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 单词数量</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> WorldCount</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 树深度</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> TrieDeepth</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 根节点</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> TrieNode RootNode</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 单词列表(用于缓存分割结果，优化单个单词判定时重复分割问题)</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> List&lt;<span class="built_in">string</span>&gt; mWordList;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 构造函数</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;separator&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Trie</span>(<span class="params"><span class="built_in">char</span> separator = <span class="string">&#x27;|&#x27;</span></span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Separator = separator;</span><br><span class="line">        WorldCount = <span class="number">0</span>;</span><br><span class="line">        TrieDeepth = <span class="number">0</span>;</span><br><span class="line">        RootNode = ObjectPool.Singleton.pop&lt;TrieNode&gt;();</span><br><span class="line">        RootNode.Init(<span class="string">&quot;Root&quot;</span>, <span class="literal">null</span>, <span class="keyword">this</span>, <span class="number">0</span>, <span class="literal">false</span>);</span><br><span class="line">        mWordList = <span class="keyword">new</span> List&lt;<span class="built_in">string</span>&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 添加单词</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;word&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">AddWord</span>(<span class="params"><span class="built_in">string</span> word</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        mWordList.Clear();</span><br><span class="line">        <span class="keyword">var</span> words = word.Split(Separator);</span><br><span class="line">        mWordList.AddRange(words);</span><br><span class="line">        <span class="keyword">var</span> length = mWordList.Count;</span><br><span class="line">        <span class="keyword">var</span> node = RootNode;</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; length; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> spliteWord = mWordList[i];</span><br><span class="line">            <span class="keyword">var</span> isLast = i == (length - <span class="number">1</span>);</span><br><span class="line">            <span class="keyword">if</span> (!node.ContainWord(spliteWord))</span><br><span class="line">            &#123;</span><br><span class="line">                node = node.AddChildNode(spliteWord, isLast);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                node = node.GetChildNode(spliteWord);</span><br><span class="line">                <span class="keyword">if</span>(isLast)</span><br><span class="line">                &#123;</span><br><span class="line">                    Debug.Log(<span class="string">$&quot;添加重复单词:<span class="subst">&#123;word&#125;</span>&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 移除指定单词</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Note:</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 仅当指定单词存在时才能移除成功</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;word&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">RemoveWord</span>(<span class="params"><span class="built_in">string</span> word</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">string</span>.IsNullOrEmpty(word))</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">$&quot;不允许移除空单词!&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> wordNode = GetWordNode(word);</span><br><span class="line">        <span class="keyword">if</span>(wordNode == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">$&quot;找不到单词:<span class="subst">&#123;word&#125;</span>的节点信息，移除单词失败!&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(wordNode.IsRoot)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">$&quot;不允许删除根节点!&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 从最里层节点开始反向判定更新和删除</span></span><br><span class="line">        <span class="keyword">if</span>(!wordNode.IsTail)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">$&quot;单词:<span class="subst">&#123;word&#125;</span>的节点不是单词节点，移除单词失败!&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 删除的节点是叶子节点时要删除节点并往上递归更新节点数据</span></span><br><span class="line">        <span class="comment">// 反之只更新标记为非单词节点即可结束</span></span><br><span class="line">        <span class="keyword">if</span>(wordNode.ChildCount &gt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            wordNode.IsTail = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        wordNode.RemoveFromParent();</span><br><span class="line">        <span class="comment">// 网上遍历更新节点信息</span></span><br><span class="line">        <span class="keyword">var</span> node = wordNode.Parent;</span><br><span class="line">        <span class="keyword">while</span>(node != <span class="literal">null</span> &amp;&amp; !node.IsRoot)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 没有子节点且不是单词节点则直接删除</span></span><br><span class="line">            <span class="keyword">if</span>(node.ChildCount == <span class="number">0</span> &amp;&amp; !node.IsTail)</span><br><span class="line">            &#123;</span><br><span class="line">                node.RemoveFromParent();</span><br><span class="line">            &#125;</span><br><span class="line">            node = node.Parent;</span><br><span class="line">            <span class="comment">// 有子节点则停止往上更新</span></span><br><span class="line">            <span class="keyword">if</span>(node.ChildCount &gt; <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 获取指定字符串的单词节点</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Note:</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 只有满足每一层且最后一层是单词的节点才算有效单词节点</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;word&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> TrieNode <span class="title">GetWordNode</span>(<span class="params"><span class="built_in">string</span> word</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">string</span>.IsNullOrEmpty(word))</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">$&quot;无法获取空单词的单次节点!&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 从最里层节点开始反向判定更新和删除</span></span><br><span class="line">        <span class="keyword">var</span> wordArray = word.Split(Separator);</span><br><span class="line">        <span class="keyword">var</span> node = RootNode;</span><br><span class="line">        <span class="keyword">foreach</span>(<span class="keyword">var</span> spliteWord <span class="keyword">in</span> wordArray)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> childNode = node.GetChildNode(spliteWord);</span><br><span class="line">            <span class="keyword">if</span> (childNode != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                node = childNode;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(node == <span class="literal">null</span> || !node.IsTail)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.Log(<span class="string">$&quot;找不到单词:<span class="subst">&#123;word&#125;</span>的单词节点!&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> node;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 有按指定单词开头的词语</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;word&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">StartWith</span>(<span class="params"><span class="built_in">string</span> word</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">string</span>.IsNullOrEmpty(word))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        mWordList.Clear();</span><br><span class="line">        <span class="keyword">var</span> wordArray = word.Split(Separator);</span><br><span class="line">        mWordList.AddRange(wordArray);</span><br><span class="line">        <span class="keyword">return</span> FindWord(RootNode, mWordList);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 查找单词</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;trieNode&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;wordList&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="built_in">bool</span> <span class="title">FindWord</span>(<span class="params">TrieNode trieNode, List&lt;<span class="built_in">string</span>&gt; wordList</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (wordList.Count == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> firstWord = wordList[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">if</span> (!trieNode.ContainWord(firstWord))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> childNode = trieNode.GetChildNode(firstWord);</span><br><span class="line">        wordList.RemoveAt(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span> FindWord(childNode, wordList);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 单词是否存在</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;word&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">ContainWord</span>(<span class="params"><span class="built_in">string</span> word</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">string</span>.IsNullOrEmpty(word))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        mWordList.Clear();</span><br><span class="line">        <span class="keyword">var</span> wordArray = word.Split(Separator);</span><br><span class="line">        mWordList.AddRange(wordArray);</span><br><span class="line">        <span class="keyword">return</span> MatchWord(RootNode, mWordList);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 匹配单词(单词必须完美匹配)</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;trieNode&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;wordList&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="built_in">bool</span> <span class="title">MatchWord</span>(<span class="params">TrieNode trieNode, List&lt;<span class="built_in">string</span>&gt; wordList</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (wordList.Count == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> trieNode.IsTail;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> firstWord = wordList[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">if</span> (!trieNode.ContainWord(firstWord))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> childNode = trieNode.GetChildNode(firstWord);</span><br><span class="line">        wordList.RemoveAt(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span> MatchWord(childNode, wordList);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 获取所有单词列表</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;<span class="built_in">string</span>&gt; <span class="title">GetWordList</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> GetNodeWorldList(RootNode, <span class="built_in">string</span>.Empty);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 获取节点单词列表</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;trieNode&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;preFix&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> List&lt;<span class="built_in">string</span>&gt; <span class="title">GetNodeWorldList</span>(<span class="params">TrieNode trieNode, <span class="built_in">string</span> preFix</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> wordList = <span class="keyword">new</span> List&lt;<span class="built_in">string</span>&gt;();</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> childNodeKey <span class="keyword">in</span> trieNode.ChildNodesMap.Keys)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> childNode = trieNode.ChildNodesMap[childNodeKey];</span><br><span class="line">            <span class="built_in">string</span> word;</span><br><span class="line">            <span class="keyword">if</span> (trieNode.IsRoot)</span><br><span class="line">            &#123;</span><br><span class="line">                word = <span class="string">$&quot;<span class="subst">&#123;preFix&#125;</span><span class="subst">&#123;childNodeKey&#125;</span>&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                word = <span class="string">$&quot;<span class="subst">&#123;preFix&#125;</span><span class="subst">&#123;Separator&#125;</span><span class="subst">&#123;childNodeKey&#125;</span>&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (childNode.IsTail)</span><br><span class="line">            &#123;</span><br><span class="line">                wordList.Add(word);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (childNode.ChildNodesMap.Count &gt; <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> childNodeWorldList = GetNodeWorldList(childNode, word);</span><br><span class="line">                wordList.AddRange(childNodeWorldList);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> wordList;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 打印树形节点</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">PrintTreeNodes</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        PrintNodes(RootNode, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 打印节点</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;node&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;depth&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">PrintNodes</span>(<span class="params">TrieNode node, <span class="built_in">int</span> depth = <span class="number">1</span></span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> count = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> childeNode <span class="keyword">in</span> node.ChildNodesMap)</span><br><span class="line">        &#123;</span><br><span class="line">            Console.Write(<span class="string">$&quot;<span class="subst">&#123;childeNode.Key&#125;</span>(<span class="subst">&#123;depth&#125;</span>-<span class="subst">&#123;count&#125;</span>)&quot;</span>);</span><br><span class="line">            count++;</span><br><span class="line">        &#125;</span><br><span class="line">        Console.WriteLine();</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> childeNode <span class="keyword">in</span> node.ChildNodesMap)</span><br><span class="line">        &#123;</span><br><span class="line">            PrintNodes(childeNode.Value, depth + <span class="number">1</span>); </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>TrieNode.cs(前缀树节点)</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> TrieNode.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 前缀树节点类</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TrieNode</span> : <span class="title">IRecycle</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 节点字符串</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> NodeValue</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 父节点</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> TrieNode Parent</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 所属前缀树</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> Trie OwnerTree</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 节点深度(根节点为0)</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> Depth</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 是否是单词节点</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">bool</span> IsTail</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 是否是根节点</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">bool</span> IsRoot</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> Parent == <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 子节点映射Map<span class="doctag">&lt;节点字符串, 节点对象&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> Dictionary&lt;<span class="built_in">string</span>, TrieNode&gt; ChildNodesMap</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 子节点数量</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> ChildCount</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> ChildNodesMap.Count;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TrieNode</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        ChildNodesMap = <span class="keyword">new</span> Dictionary&lt;<span class="built_in">string</span>, TrieNode&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">OnCreate</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        NodeValue = <span class="literal">null</span>;</span><br><span class="line">        Parent = <span class="literal">null</span>;</span><br><span class="line">        OwnerTree = <span class="literal">null</span>;</span><br><span class="line">        Depth = <span class="number">0</span>;</span><br><span class="line">        IsTail = <span class="literal">false</span>;</span><br><span class="line">        ChildNodesMap.Clear();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 初始化数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;value&quot;&gt;</span>字符串<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;parent&quot;&gt;</span>父节点<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;ownerTree&quot;&gt;</span>所属前缀树<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;depth&quot;&gt;</span>节点深度<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;isTail&quot;&gt;</span>是否是单词节点<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Init</span>(<span class="params"><span class="built_in">string</span> <span class="keyword">value</span>, TrieNode parent, Trie ownerTree, <span class="built_in">int</span> depth, <span class="built_in">bool</span> isTail = <span class="literal">false</span></span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        NodeValue = <span class="keyword">value</span>;</span><br><span class="line">        Parent = parent;</span><br><span class="line">        OwnerTree = ownerTree;</span><br><span class="line">        Depth = depth;</span><br><span class="line">        IsTail = isTail;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">OnDispose</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        NodeValue = <span class="literal">null</span>;</span><br><span class="line">        Parent = <span class="literal">null</span>;</span><br><span class="line">        OwnerTree = <span class="literal">null</span>;</span><br><span class="line">        Depth = <span class="number">0</span>;</span><br><span class="line">        IsTail = <span class="literal">false</span>;</span><br><span class="line">        ChildNodesMap.Clear();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 添加子节点</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;nodeWord&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;isTail&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> TrieNode <span class="title">AddChildNode</span>(<span class="params"><span class="built_in">string</span> nodeWord, <span class="built_in">bool</span> isTail</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        TrieNode node;</span><br><span class="line">        <span class="keyword">if</span> (ChildNodesMap.TryGetValue(nodeWord, <span class="keyword">out</span> node))</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.Log(<span class="string">$&quot;节点字符串:<span class="subst">&#123;NodeValue&#125;</span>已存在字符串:<span class="subst">&#123;nodeWord&#125;</span>的子节点,不重复添加子节点!&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> node;</span><br><span class="line">        &#125;</span><br><span class="line">        node = ObjectPool.Singleton.pop&lt;TrieNode&gt;();</span><br><span class="line">        node.Init(nodeWord, <span class="keyword">this</span>, OwnerTree, Depth + <span class="number">1</span>, isTail);</span><br><span class="line">        ChildNodesMap.Add(nodeWord, node);</span><br><span class="line">        <span class="keyword">return</span> node;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 移除指定子节点</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;nodeWord&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">RemoveChildNodeByWord</span>(<span class="params"><span class="built_in">string</span> nodeWord</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> childNode = GetChildNode(nodeWord);</span><br><span class="line">        <span class="keyword">return</span> RemoveChildNode(childNode);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 移除指定子节点</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;childNode&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">RemoveChildNode</span>(<span class="params">TrieNode childNode</span>)</span></span><br><span class="line">    &#123; </span><br><span class="line">        <span class="keyword">if</span>(childNode == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">$&quot;无法移除空节点!&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> realChildNode = GetChildNode(childNode.NodeValue);</span><br><span class="line">        <span class="keyword">if</span>(realChildNode != childNode)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">$&quot;移除的子节点单词:<span class="subst">&#123;childNode.NodeValue&#125;</span>对象不是同一个,移除子节点失败!&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ChildNodesMap.Remove(childNode.NodeValue);</span><br><span class="line">        ObjectPool.Singleton.push&lt;TrieNode&gt;(childNode);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 当前节点从父节点移除</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">RemoveFromParent</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(IsRoot)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">$&quot;当前节点是根节点，不允许从父节点移除，从父节点移除当前节点失败!&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> Parent.RemoveChildNode(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 获取指定字符串的子节点</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> TrieNode <span class="title">GetChildNode</span>(<span class="params"><span class="built_in">string</span> nodeWord</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        TrieNode trieNode;</span><br><span class="line">        <span class="keyword">if</span> (!ChildNodesMap.TryGetValue(nodeWord, <span class="keyword">out</span> trieNode))</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.Log(<span class="string">$&quot;节点字符串:<span class="subst">&#123;NodeValue&#125;</span>找不到子节点字符串:<span class="subst">&#123;nodeWord&#125;</span>,获取子节点失败!&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> trieNode;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 是否包含指定字符串的子节点</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">ContainWord</span>(<span class="params"><span class="built_in">string</span> nodeWord</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> ChildNodesMap.ContainsKey(nodeWord);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 获取当前节点构成的单词</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Note:</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 不管当前节点是否是单词节点,都返回从当前节点回溯到根节点拼接的单词</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 若当前节点为根节点，则返回根节点的字符串(默认为&quot;Root&quot;)</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">GetFullWord</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> trieNodeWord = NodeValue;</span><br><span class="line">        <span class="keyword">var</span> node = Parent;</span><br><span class="line">        <span class="keyword">while</span>(node != <span class="literal">null</span> &amp;&amp; !node.IsRoot)</span><br><span class="line">        &#123;</span><br><span class="line">            trieNodeWord = <span class="string">$&quot;<span class="subst">&#123;node.NodeValue&#125;</span><span class="subst">&#123;OwnerTree.Separator&#125;</span><span class="subst">&#123;trieNodeWord&#125;</span>&quot;</span>;</span><br><span class="line">            node = node.Parent;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> trieNodeWord;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>TrieEditorWindow.cs(前缀树测试窗口)</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> UnityEditor;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> TrieEditorWindow.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 前缀树窗口</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TrieEditorWindow</span> : <span class="title">EditorWindow</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 居中Button GUI Style</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> GUIStyle mButtonMidStyle;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 前缀树</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> Trie mTrie;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 当前滚动位置</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> Vector2 mCurrentScrollPos;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 输入单词</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">string</span> mInputWord;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 节点展开Map<span class="doctag">&lt;节点单词全名, 是否展开&gt;</span> </span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> Dictionary&lt;<span class="built_in">string</span>, <span class="built_in">bool</span>&gt; mTrieNodeUnfoldMap = <span class="keyword">new</span> Dictionary&lt;<span class="built_in">string</span>, <span class="built_in">bool</span>&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 前缀树单词列表</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> List&lt;<span class="built_in">string</span>&gt; mTrieWordList;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">MenuItem(<span class="string">&quot;Tools/前缀树测试窗口&quot;</span>)</span>]</span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Init</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        TrieEditorWindow window = (TrieEditorWindow)EditorWindow.GetWindow(<span class="keyword">typeof</span>(TrieEditorWindow), <span class="literal">false</span>, <span class="string">&quot;前缀树测试窗口&quot;</span>);</span><br><span class="line">        window.Show();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">OnGUI</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        InitGUIStyle();</span><br><span class="line">        InitData();</span><br><span class="line">        mCurrentScrollPos = EditorGUILayout.BeginScrollView(mCurrentScrollPos);</span><br><span class="line">        EditorGUILayout.BeginVertical();</span><br><span class="line">        DisplayTrieOperationArea();</span><br><span class="line">        DisplayTrieContentArea();</span><br><span class="line">        DisplayTrieWordsArea();</span><br><span class="line">        EditorGUILayout.EndVertical();</span><br><span class="line">        EditorGUILayout.EndScrollView();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 初始化GUIStyle</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">InitGUIStyle</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(mButtonMidStyle == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            mButtonMidStyle = <span class="keyword">new</span> GUIStyle(<span class="string">&quot;ButtonMid&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 初始化数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">InitData</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (mTrie == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            mTrie = <span class="keyword">new</span> Trie();</span><br><span class="line">            mTrieWordList = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 更新前缀树单词列表</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">UpdateTrieWordList</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mTrieWordList = mTrie.GetWordList();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 显示前缀树操作区域</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">DisplayTrieOperationArea</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        EditorGUILayout.BeginHorizontal(<span class="string">&quot;box&quot;</span>);</span><br><span class="line">        EditorGUILayout.LabelField(<span class="string">&quot;单词:&quot;</span>, GUILayout.Width(<span class="number">40f</span>), GUILayout.Height(<span class="number">20f</span>));</span><br><span class="line">        mInputWord = EditorGUILayout.TextField(mInputWord, GUILayout.ExpandWidth(<span class="literal">true</span>), GUILayout.Height(<span class="number">20f</span>));</span><br><span class="line">        <span class="keyword">if</span>(GUILayout.Button(<span class="string">&quot;添加&quot;</span>, GUILayout.Width(<span class="number">120f</span>), GUILayout.Height(<span class="number">20f</span>)))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">string</span>.IsNullOrEmpty(mInputWord))</span><br><span class="line">            &#123;</span><br><span class="line">                Debug.LogError(<span class="string">$&quot;不能允许添加空单词!&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                mTrie.AddWord(mInputWord);</span><br><span class="line">                UpdateTrieWordList();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (GUILayout.Button(<span class="string">&quot;删除&quot;</span>, GUILayout.Width(<span class="number">120f</span>), GUILayout.Height(<span class="number">20f</span>)))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="built_in">string</span>.IsNullOrEmpty(mInputWord))</span><br><span class="line">            &#123;</span><br><span class="line">                Debug.LogError(<span class="string">$&quot;不能允许删除空单词!&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                mTrie.RemoveWord(mInputWord);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        EditorGUILayout.EndHorizontal();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 绘制前缀树内容</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">DisplayTrieContentArea</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        EditorGUILayout.BeginVertical(<span class="string">&quot;box&quot;</span>);</span><br><span class="line">        EditorGUILayout.LabelField(<span class="string">&quot;前缀树节点信息&quot;</span>, mButtonMidStyle, GUILayout.ExpandWidth(<span class="literal">true</span>), GUILayout.Height(<span class="number">20f</span>));</span><br><span class="line">        DisplayTrieNode(mTrie.RootNode);</span><br><span class="line">        EditorGUILayout.EndVertical();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 显示一个节点</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;trieNode&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">DisplayTrieNode</span>(<span class="params">TrieNode trieNode</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> nodeFullWord = trieNode.GetFullWord();</span><br><span class="line">        <span class="keyword">if</span>(!mTrieNodeUnfoldMap.ContainsKey(nodeFullWord))</span><br><span class="line">        &#123;</span><br><span class="line">            mTrieNodeUnfoldMap.Add(nodeFullWord, <span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        EditorGUILayout.BeginHorizontal(<span class="string">&quot;box&quot;</span>);</span><br><span class="line">        GUILayout.Space(trieNode.Depth * <span class="number">20</span>);</span><br><span class="line">        <span class="keyword">var</span> displayName = <span class="string">$&quot;<span class="subst">&#123;trieNode.NodeValue&#125;</span>(<span class="subst">&#123;trieNode.Depth&#125;</span>)&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span> (trieNode.ChildCount &gt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            mTrieNodeUnfoldMap[nodeFullWord] = EditorGUILayout.Foldout(mTrieNodeUnfoldMap[nodeFullWord], displayName);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            EditorGUILayout.LabelField(displayName);</span><br><span class="line">        &#125;</span><br><span class="line">        EditorGUILayout.EndHorizontal();</span><br><span class="line">        <span class="keyword">if</span>(mTrieNodeUnfoldMap[nodeFullWord] &amp;&amp; trieNode.ChildCount &gt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> childNodeValueList = trieNode.ChildNodesMap.Keys.ToList();</span><br><span class="line">            <span class="keyword">foreach</span>(<span class="keyword">var</span> childNodeValue <span class="keyword">in</span> childNodeValueList)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> childNode = trieNode.GetChildNode(childNodeValue);</span><br><span class="line">                DisplayTrieNode(childNode);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 显示前缀树单词区域</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">DisplayTrieWordsArea</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        EditorGUILayout.BeginVertical(<span class="string">&quot;box&quot;</span>);</span><br><span class="line">        EditorGUILayout.LabelField(<span class="string">&quot;前缀树单词信息&quot;</span>, mButtonMidStyle, GUILayout.ExpandWidth(<span class="literal">true</span>), GUILayout.Height(<span class="number">20f</span>));</span><br><span class="line">        <span class="keyword">if</span>(mTrieWordList != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">var</span> word <span class="keyword">in</span> mTrieWordList)</span><br><span class="line">            &#123;</span><br><span class="line">                EditorGUILayout.LabelField(word, GUILayout.ExpandWidth(<span class="literal">true</span>), GUILayout.Height(<span class="number">20f</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        EditorGUILayout.EndVertical();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/img/DataStructure/TrieEditorPreview.PNG" alt="TrieEditorPreview"></p>
<p>从上面可以看到我们成功通过字符串+|分割的方式，分析出了我们添加的单词的在前缀树中的关联关系。</p>
<h3 id="红点系统实战"><a href="#红点系统实战" class="headerlink" title="红点系统实战"></a>红点系统实战</h3><h4 id="红点系统类说明"><a href="#红点系统类说明" class="headerlink" title="红点系统类说明"></a>红点系统类说明</h4><p>RedDotName.cs – 红点名定义(通过前缀树表达父子关系，所有静态红点都一开始定义在这里)</p>
<p>RedDotInfo.cs – 红点信息类(<strong>包含红点运算单元组成信息</strong>)</p>
<p>RedDotUnit.cs – 红点运算单元枚举定义(所有静态红点需要参与运算的最小单元都定义在这里)</p>
<p>RedDotUnitInfo.cs – 红点运算单元类(<strong>只是当做刷新机制的无需传递计算回调</strong>)</p>
<p>RedDotType.cs – 红点类型(用于支持上层各类复杂的红点显示方式 e.g. 纯红点，纯数字，新红点等)</p>
<p>RedDotModel.cs – 红点数据层(所有的红点名信息和红点运算单元信息全部在这一层初始化)</p>
<p>RedDotManager.cs – 红点单例管理类(提供统一的红点管理，红点运算单元计算结果缓存，红点绑定回调等流程)</p>
<p>RedDotUtilities.cs – 红点辅助类(一些通用方法还有逻辑层的红点运算方法定义在这里)</p>
<p>GameModel.cs – 逻辑数据层存储模拟</p>
<p>RedDotEditorWindow.cs – 红点系统可视化窗口(方便快速可视化查看红点运行状态和相关信息)</p>
<p>RedDotStyles.cs – 红点Editor显示Style定义</p>
<p>Trie.cs – 前缀树(用于红点名通过字符串的形式表达出层级关系)</p>
<p>TrieNode.cs – 前缀树节点</p>
<h4 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h4><p>由于代码部分比较多，这里就不放源代码了，直接看实战效果图，源码可以在最后的Github链接找到。</p>
<p>初始化后的红点前缀树状态:</p>
<p><img src="/img/RedDotSystem/RedDotTriePreiview.PNG" alt="RedDotTriePreiview"></p>
<p>点击标记功能1新按钮后:</p>
<p><img src="/img/RedDotSystem/RedDotTriePreiviewAfterMarkFunc1New.PNG" alt="RedDotTriePreiviewAfterMarkFunc1New"></p>
<p>点击菜单-&gt;背包-&gt;点击增加1个当前页签的新道具，切换页签并点击操作数据增加:</p>
<p><img src="/img/RedDotSystem/BackpackUIOperation.PNG" alt="BackpackUIOperation"></p>
<p>背包操作完后，主界面状态:</p>
<p><img src="/img/RedDotSystem/MainUIAfterBackpackOperation.PNG" alt="MainUIAfterBackpackOperation"></p>
<p>背包操作完后，红点可视化前缀树:</p>
<p><img src="/img/RedDotSystem/RedDotTrieAfterBackpackUIOperation.PNG" alt="RedDotTrieAfterBackpackUIOperation"></p>
<p>背包增加操作后，MAIN_UI_MENU红点名的红点可视化详情:</p>
<p><img src="/img/RedDotSystem/RedDotDetailAfterBackpackOperation.PNG" alt="RedDotDetailAfterBackpackOperation"></p>
<p>所有红点运算单元详情:</p>
<p><img src="/img/RedDotSystem/AllRedDotUnitInfoPreview.PNG" alt="AllRedDotUnitInfoPreview0"></p>
<p>通过菜单-&gt;背包-&gt;点击减少1个当前页签的新道具，切换页签点击并操作数据减少:</p>
<p><img src="/img/RedDotSystem/BackpackUIOperationAfterReduce.PNG" alt="BackpackUIOperationAfterReduce"></p>
<p>背包减少操作后,红点可视化前缀树:</p>
<p><img src="/img/RedDotSystem/RedDotTriePreviewAfterBackpackReduce.PNG" alt="RedDotTriePreviewAfterBackpackReduce"></p>
<p>从上面的测试可以看到，我们通过定义红点名，红点运算单元相关数据，成功的分析出了红点层级关系(利用前缀树)以及红点名与红点运算单元的组合关系。</p>
<p>通过编写RedDotEditorWindow成功将红点数据详情可视化的显示在了调试窗口上，通过调试窗口我们可以快速的查看所有红点名和红点运算单元的相关数据，从而实现快速的调试和查看功能。</p>
<p>上层逻辑只需关心红点名和红点运算单元的定义以及红点名在逻辑层的绑定刷新即可。</p>
<p>这里我放一部分红点名和红点运算单元的初始化相关代码，详情参考Github源码:</p>
<ul>
<li><p>红点系统的初始化和更新驱动</p>
<p>GameLauncher.cs</p>
</li>
</ul>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Awake</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    mSingleton = <span class="keyword">this</span>;</span><br><span class="line">    RedDotModel.Singleton.Init();</span><br><span class="line">    RedDotManager.Singleton.Init();</span><br><span class="line">    <span class="comment">// 所有数据初始化完成后触发一次红点运算单元计算</span></span><br><span class="line">    RedDotManager.Singleton.DoAllRedDotUnitCaculate();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Update</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    RedDotManager.Singleton.Update();        </span><br><span class="line">&#125;</span><br><span class="line">******</span><br></pre></td></tr></table></figure>

<ul>
<li><p>红点数据定义初始化</p>
<p>RedDotModel.cs</p>
</li>
</ul>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 初始化</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Init</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (IsInitCompelte)</span><br><span class="line">    &#123;</span><br><span class="line">        Debug.LogError(<span class="string">$&quot;请勿重复初始化!&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 优先初始化红点单元，现在改成通过红点名正向配置红点单元组成，而非反向红点单元定义影响红点名组成</span></span><br><span class="line">    InitRedDotUnitInfo();</span><br><span class="line">    InitRedDotInfo();</span><br><span class="line">    InitRedDotTree();</span><br><span class="line">    <span class="comment">// InitRedDotUnitNameMap必须在InitRedDotInfo之后调用，因为用到了前面的数据</span></span><br><span class="line">    UpdateRedDotUnitNameMap();</span><br><span class="line">    IsInitCompelte = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 初始化红点运算单元信息</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">InitRedDotUnitInfo</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 构建添加所有游戏里的红点运算单元信息</span></span><br><span class="line">    AddRedDotUnitInfo(RedDotUnit.NEW_FUNC1, <span class="string">&quot;动态新功能1解锁&quot;</span>, RedDotUtilities.CaculateNewFunc1, RedDotType.NEW);</span><br><span class="line">    AddRedDotUnitInfo(RedDotUnit.NEW_FUNC2, <span class="string">&quot;动态新功能2解锁&quot;</span>, RedDotUtilities.CaculateNewFunc2, RedDotType.NEW);</span><br><span class="line">    AddRedDotUnitInfo(RedDotUnit.NEW_ITEM_NUM, <span class="string">&quot;新道具数&quot;</span>, RedDotUtilities.CaculateNewItemNum, RedDotType.NUMBER);</span><br><span class="line">    AddRedDotUnitInfo(RedDotUnit.NEW_RESOURCE_NUM, <span class="string">&quot;新资源数&quot;</span>, RedDotUtilities.CaculateNewResourceNum, RedDotType.NUMBER);</span><br><span class="line">    AddRedDotUnitInfo(RedDotUnit.NEW_EQUIP_NUM, <span class="string">&quot;新装备数&quot;</span>, RedDotUtilities.CaculateNewEquipNum, RedDotType.NUMBER);</span><br><span class="line">    AddRedDotUnitInfo(RedDotUnit.NEW_PUBLIC_MAIL_NUM, <span class="string">&quot;新公共邮件数&quot;</span>, RedDotUtilities.CaculateNewPublicMailNum, RedDotType.NUMBER);</span><br><span class="line">    AddRedDotUnitInfo(RedDotUnit.NEW_BATTLE_MAIL_NUM, <span class="string">&quot;新战斗邮件数&quot;</span>, RedDotUtilities.CaculateNewBattleMailNum, RedDotType.NUMBER);</span><br><span class="line">    AddRedDotUnitInfo(RedDotUnit.NEW_OTHER_MAIL_NUM, <span class="string">&quot;新其他邮件数&quot;</span>, RedDotUtilities.CaculateNewOtherMailNum, RedDotType.NUMBER);</span><br><span class="line">    AddRedDotUnitInfo(RedDotUnit.PUBLIC_MAIL_REWARD_NUM, <span class="string">&quot;公共邮件可领奖数&quot;</span>, RedDotUtilities.CaculateNewPublicMailRewardNum, RedDotType.NUMBER);</span><br><span class="line">    AddRedDotUnitInfo(RedDotUnit.BATTLE_MAIL_REWARD_NUM, <span class="string">&quot;战斗邮件可领奖数&quot;</span>, RedDotUtilities.CaculateNewBattleMailRewardNum, RedDotType.NUMBER);</span><br><span class="line">    AddRedDotUnitInfo(RedDotUnit.WEARABLE_EQUIP_NUM, <span class="string">&quot;可穿戴装备数&quot;</span>, RedDotUtilities.CaculateWearableEquipNum, RedDotType.NUMBER);</span><br><span class="line">    AddRedDotUnitInfo(RedDotUnit.UPGRADEABLE_EQUIP_NUM, <span class="string">&quot;可升级装备数&quot;</span>, RedDotUtilities.CaculateUpgradeableEquipNum, RedDotType.NUMBER);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 初始化红点信息</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">InitRedDotInfo</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Note:</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 穷举的好处是足够灵活</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 缺点是删除最里层红点运算单元需要把外层所有影响到的红点名相关红点运算单元配置删除</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 调用AddRedDotInfo添加游戏所有静态红点信息</span></span><br><span class="line">    InitMainUIRedDotInfo();</span><br><span class="line">    InitBackpackUIRedDotInfo();</span><br><span class="line">    InitMailUIRedDotInfo();</span><br><span class="line">    InitEquipUIRedDotInfo();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 初始化主界面红点信息</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">InitMainUIRedDotInfo</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    RedDotInfo redDotInfo;</span><br><span class="line">    redDotInfo = AddRedDotInfo(RedDotNames.MAIN_UI_NEW_FUNC1, <span class="string">&quot;主界面新功能1红点&quot;</span>);</span><br><span class="line">    redDotInfo.AddRedDotUnit(RedDotUnit.NEW_FUNC1);</span><br><span class="line"></span><br><span class="line">    redDotInfo = AddRedDotInfo(RedDotNames.MAIN_UI_NEW_FUNC2, <span class="string">&quot;主界面新功能2红点&quot;</span>);</span><br><span class="line">    redDotInfo.AddRedDotUnit(RedDotUnit.NEW_FUNC2);</span><br><span class="line"></span><br><span class="line">    redDotInfo = AddRedDotInfo(RedDotNames.MAIN_UI_MENU, <span class="string">&quot;主界面菜单红点&quot;</span>);</span><br><span class="line">    redDotInfo.AddRedDotUnit(RedDotUnit.NEW_ITEM_NUM);</span><br><span class="line">    redDotInfo.AddRedDotUnit(RedDotUnit.NEW_RESOURCE_NUM);</span><br><span class="line">    redDotInfo.AddRedDotUnit(RedDotUnit.NEW_EQUIP_NUM);</span><br><span class="line"></span><br><span class="line">    redDotInfo = AddRedDotInfo(RedDotNames.MAIN_UI_MAIL, <span class="string">&quot;主界面邮件红点&quot;</span>);</span><br><span class="line">    redDotInfo.AddRedDotUnit(RedDotUnit.NEW_PUBLIC_MAIL_NUM);</span><br><span class="line">    redDotInfo.AddRedDotUnit(RedDotUnit.NEW_BATTLE_MAIL_NUM);</span><br><span class="line">    redDotInfo.AddRedDotUnit(RedDotUnit.NEW_OTHER_MAIL_NUM);</span><br><span class="line">    redDotInfo.AddRedDotUnit(RedDotUnit.PUBLIC_MAIL_REWARD_NUM);</span><br><span class="line"></span><br><span class="line">    redDotInfo = AddRedDotInfo(RedDotNames.MAIN_UI_MENU_EQUIP, <span class="string">&quot;主界面菜单装备红点&quot;</span>);</span><br><span class="line">    redDotInfo.AddRedDotUnit(RedDotUnit.WEARABLE_EQUIP_NUM);</span><br><span class="line">    redDotInfo.AddRedDotUnit(RedDotUnit.UPGRADEABLE_EQUIP_NUM);</span><br><span class="line"></span><br><span class="line">    redDotInfo = AddRedDotInfo(RedDotNames.MAIN_UI_MENU_BACKPACK, <span class="string">&quot;主界面菜单背包红点&quot;</span>);</span><br><span class="line">    redDotInfo.AddRedDotUnit(RedDotUnit.NEW_ITEM_NUM);</span><br><span class="line">    redDotInfo.AddRedDotUnit(RedDotUnit.NEW_RESOURCE_NUM);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 初始化背包界面红点信息</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">InitBackpackUIRedDotInfo</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    RedDotInfo redDotInfo;</span><br><span class="line">    redDotInfo = AddRedDotInfo(RedDotNames.BACKPACK_UI_ITEM_TAG, <span class="string">&quot;背包界面道具页签红点&quot;</span>);</span><br><span class="line">    redDotInfo.AddRedDotUnit(RedDotUnit.NEW_ITEM_NUM);</span><br><span class="line"></span><br><span class="line">    redDotInfo = AddRedDotInfo(RedDotNames.BACKPACK_UI_RESOURCE_TAG, <span class="string">&quot;背包界面资源页签红点&quot;</span>);</span><br><span class="line">    redDotInfo.AddRedDotUnit(RedDotUnit.NEW_RESOURCE_NUM);</span><br><span class="line"></span><br><span class="line">    redDotInfo = AddRedDotInfo(RedDotNames.BACKPACK_UI_EQUIP_TAG, <span class="string">&quot;背包界面装备页签红点&quot;</span>);</span><br><span class="line">    redDotInfo.AddRedDotUnit(RedDotUnit.NEW_EQUIP_NUM);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 初始化邮件界面红点信息</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">InitMailUIRedDotInfo</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    RedDotInfo redDotInfo;</span><br><span class="line">    redDotInfo = AddRedDotInfo(RedDotNames.MAIL_UI_PUBLIC_MAIL, <span class="string">&quot;邮件界面公共邮件红点&quot;</span>);</span><br><span class="line">    redDotInfo.AddRedDotUnit(RedDotUnit.NEW_PUBLIC_MAIL_NUM);</span><br><span class="line">    redDotInfo.AddRedDotUnit(RedDotUnit.PUBLIC_MAIL_REWARD_NUM);</span><br><span class="line"></span><br><span class="line">    redDotInfo = AddRedDotInfo(RedDotNames.MAIL_UI_BATTLE_MAIL, <span class="string">&quot;邮件界面战斗邮件红点&quot;</span>);</span><br><span class="line">    redDotInfo.AddRedDotUnit(RedDotUnit.NEW_BATTLE_MAIL_NUM);</span><br><span class="line">    redDotInfo.AddRedDotUnit(RedDotUnit.BATTLE_MAIL_REWARD_NUM);</span><br><span class="line"></span><br><span class="line">    redDotInfo = AddRedDotInfo(RedDotNames.MAIL_UI_OTHER_MAIL, <span class="string">&quot;邮件界面其他邮件红点&quot;</span>);</span><br><span class="line">    redDotInfo.AddRedDotUnit(RedDotUnit.NEW_OTHER_MAIL_NUM);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 初始化装备界面红点信息</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">InitEquipUIRedDotInfo</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    RedDotInfo redDotInfo;</span><br><span class="line">    redDotInfo = AddRedDotInfo(RedDotNames.EQUIP_UI_WEARABLE, <span class="string">&quot;装备界面可穿戴红点&quot;</span>);</span><br><span class="line">    redDotInfo.AddRedDotUnit(RedDotUnit.WEARABLE_EQUIP_NUM);</span><br><span class="line"></span><br><span class="line">    redDotInfo = AddRedDotInfo(RedDotNames.EQUIP_UI_UPGRADABLE, <span class="string">&quot;装备界面可升级红点&quot;</span>);</span><br><span class="line">    redDotInfo.AddRedDotUnit(RedDotUnit.UPGRADEABLE_EQUIP_NUM);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">******</span><br></pre></td></tr></table></figure>

<ul>
<li><p>上层逻辑代码只关心红点的初始化，绑定和取消</p>
<p>MainUI.cs</p>
</li>
</ul>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 绑定所有红点名</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">BindAllRedDotNames</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    RedDotManager.Singleton.BindRedDotName(RedDotNames.MAIN_UI_MENU, OnRedDotRefresh);</span><br><span class="line">    RedDotManager.Singleton.BindRedDotName(RedDotNames.MAIN_UI_MAIL, OnRedDotRefresh);</span><br><span class="line">    RedDotManager.Singleton.BindRedDotName(RedDotNames.MAIN_UI_MENU_BACKPACK, OnRedDotRefresh);</span><br><span class="line">    RedDotManager.Singleton.BindRedDotName(RedDotNames.MAIN_UI_MENU_EQUIP, OnRedDotRefresh);</span><br><span class="line">    RedDotManager.Singleton.BindRedDotName(RedDotNames.MAIN_UI_NEW_FUNC1, OnRedDotRefresh);</span><br><span class="line">    RedDotManager.Singleton.BindRedDotName(RedDotNames.MAIN_UI_NEW_FUNC2, OnRedDotRefresh);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 响应红点刷新</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;redDotName&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;result&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;redDotType&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnRedDotRefresh</span>(<span class="params"><span class="built_in">string</span> redDotName, <span class="built_in">int</span> result, RedDotType redDotType</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> resultText = RedDotUtilities.GetRedDotResultText(result, redDotType);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">string</span>.Equals(redDotName, RedDotNames.MAIN_UI_MENU))</span><br><span class="line">    &#123;</span><br><span class="line">        MenuRedDot.SetActive(result &gt; <span class="number">0</span>);</span><br><span class="line">        MenuRedDot.SetRedDotTxt(resultText);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">string</span>.Equals(redDotName, RedDotNames.MAIN_UI_MAIL))</span><br><span class="line">    &#123;</span><br><span class="line">        MailRedDot.SetActive(result &gt; <span class="number">0</span>);</span><br><span class="line">        MailRedDot.SetRedDotTxt(resultText);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">string</span>.Equals(redDotName, RedDotNames.MAIN_UI_MENU_BACKPACK))</span><br><span class="line">    &#123;</span><br><span class="line">        BackpackRedDot.SetActive(result &gt; <span class="number">0</span>);</span><br><span class="line">        BackpackRedDot.SetRedDotTxt(resultText);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">string</span>.Equals(redDotName, RedDotNames.MAIN_UI_MENU_EQUIP))</span><br><span class="line">    &#123;</span><br><span class="line">        EquipRedDot.SetActive(result &gt; <span class="number">0</span>);</span><br><span class="line">        EquipRedDot.SetRedDotTxt(resultText);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">string</span>.Equals(redDotName, RedDotNames.MAIN_UI_NEW_FUNC1))</span><br><span class="line">    &#123;</span><br><span class="line">        DynamicFunc1RedDot.SetActive(result &gt; <span class="number">0</span>);</span><br><span class="line">        DynamicFunc1RedDot.SetRedDotTxt(resultText);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">string</span>.Equals(redDotName, RedDotNames.MAIN_UI_NEW_FUNC2))</span><br><span class="line">    &#123;</span><br><span class="line">        DynamicFunc2RedDot.SetActive(result &gt; <span class="number">0</span>);</span><br><span class="line">        DynamicFunc2RedDot.SetRedDotTxt(resultText);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 解绑所有红点名</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">UnbindAllRedDotNames</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        RedDotManager.Singleton.UnbindRedDotName(RedDotNames.MAIN_UI_MENU, OnRedDotRefresh);</span><br><span class="line">        RedDotManager.Singleton.UnbindRedDotName(RedDotNames.MAIN_UI_MAIL, OnRedDotRefresh);</span><br><span class="line">        RedDotManager.Singleton.UnbindRedDotName(RedDotNames.MAIN_UI_MENU_BACKPACK, OnRedDotRefresh);</span><br><span class="line">        RedDotManager.Singleton.UnbindRedDotName(RedDotNames.MAIN_UI_MENU_EQUIP, OnRedDotRefresh);</span><br><span class="line">        RedDotManager.Singleton.UnbindRedDotName(RedDotNames.MAIN_UI_NEW_FUNC1, OnRedDotRefresh);</span><br><span class="line">        RedDotManager.Singleton.UnbindRedDotName(RedDotNames.MAIN_UI_NEW_FUNC2, OnRedDotRefresh);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 刷新红点显示</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">RefreshRedDotView</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    (<span class="built_in">int</span> result, RedDotType redDotType) redDotNameResult;</span><br><span class="line">    redDotNameResult = RedDotManager.Singleton.GetRedDotNameResult(RedDotNames.MAIN_UI_MENU);</span><br><span class="line">    OnRedDotRefresh(RedDotNames.MAIN_UI_MENU, redDotNameResult.result, redDotNameResult.redDotType);</span><br><span class="line"></span><br><span class="line">    redDotNameResult = RedDotManager.Singleton.GetRedDotNameResult(RedDotNames.MAIN_UI_MAIL);</span><br><span class="line">    OnRedDotRefresh(RedDotNames.MAIN_UI_MAIL, redDotNameResult.result, redDotNameResult.redDotType);</span><br><span class="line"></span><br><span class="line">    redDotNameResult = RedDotManager.Singleton.GetRedDotNameResult(RedDotNames.MAIN_UI_MENU_BACKPACK);</span><br><span class="line">    OnRedDotRefresh(RedDotNames.MAIN_UI_MENU_BACKPACK, redDotNameResult.result, redDotNameResult.redDotType);</span><br><span class="line"></span><br><span class="line">    redDotNameResult = RedDotManager.Singleton.GetRedDotNameResult(RedDotNames.MAIN_UI_MENU_EQUIP);</span><br><span class="line">    OnRedDotRefresh(RedDotNames.MAIN_UI_MENU_EQUIP, redDotNameResult.result, redDotNameResult.redDotType);</span><br><span class="line"></span><br><span class="line">    redDotNameResult = RedDotManager.Singleton.GetRedDotNameResult(RedDotNames.MAIN_UI_NEW_FUNC1);</span><br><span class="line">    OnRedDotRefresh(RedDotNames.MAIN_UI_NEW_FUNC1, redDotNameResult.result, redDotNameResult.redDotType);</span><br><span class="line"></span><br><span class="line">    redDotNameResult = RedDotManager.Singleton.GetRedDotNameResult(RedDotNames.MAIN_UI_NEW_FUNC2);</span><br><span class="line">    OnRedDotRefresh(RedDotNames.MAIN_UI_NEW_FUNC2, redDotNameResult.result, redDotNameResult.redDotType);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>有了这一套红点系统，上层逻辑定义红点主要由以下几个步骤组成:</p>
<ol>
<li><strong>定义红点名并初始化</strong></li>
<li><strong>定义红点名的红点运算单元组成并初始化</strong></li>
<li><strong>上层逻辑编写新红点运算单元的逻辑计算回调</strong></li>
<li><strong>上层逻辑绑定红点名刷新</strong></li>
<li><strong>上层逻辑触发红点名或红点运算单元标脏后，等待红点系统统一触发计算并回调</strong></li>
</ol>
<h2 id="重点知识"><a href="#重点知识" class="headerlink" title="重点知识"></a>重点知识</h2><ol>
<li><strong>前缀树用于实现字符串命名定义父子关系(仅仅只是调试信息上复制层级查看的父子关系)</strong></li>
<li><strong>红点名和红点运算单元通过组合的方式可以实现高度的自由组装(没有严格意义上的父子关系)</strong></li>
<li><strong>红点数据的标脏既可以基于红点运算单元也可以基于红点名，从而支持上层逻辑的准确标脏机制</strong></li>
<li><strong>如果没法在进游戏一个准确的实际出发红点运算单元全部计算，可以考虑每一个红点运算单元都通过对应模块触发标脏的方式触发计算</strong></li>
<li><strong>动态红点(比如背包不定数量道具的列表内红点)不再这套红点系统范围内定义，由上层逻辑自行触发计算和显示</strong></li>
</ol>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Trie">Trie</a></p>
<h2 id="Github"><a href="#Github" class="headerlink" title="Github"></a>Github</h2><p><a target="_blank" rel="noopener" href="https://github.com/TonyTang1990/RedDotSystem">RedDotSystem</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Game/">Game</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Game/">Game</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2022/07/16/网络对时/" title="网络对时" itemprop="url">网络对时</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Tony Tang" target="_blank" itemprop="author">Tony Tang</a>
		
  <p class="article-time">
    <time datetime="2022-07-16T12:50:00.000Z" itemprop="datePublished"> 发表于 2022-07-16</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>游戏开发过程中经常会设计到时间的运算判定，比如开服时间，触发时间，倒计时时间等，所有的这些时间都要基于和服务器或网络对时后的网络时间为基准来计算。单纯采用本地客户端时间的话会导致通过修改本地客户端时间就能达到加速和调时间的目的。本章节通过深入学习网络对时，实现一套没有服务器也能正确网络对时的对时框架(<strong>如果有后端的话以后端时间对时为准即可,本人是出于不懂服务器开发所以才采用网络对时的方案</strong>)，为未来自己的独立游戏的网络对时打基础。</p>
<h2 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h2><ol>
<li><strong>通过网络实现对时，确保本地计算用的时间是准确无误不会受本地调时间影响的</strong></li>
</ol>
<h2 id="时间"><a href="#时间" class="headerlink" title="时间"></a>时间</h2><h3 id="UTC时间"><a href="#UTC时间" class="headerlink" title="UTC时间"></a>UTC时间</h3><p>在了解同步时间之前，让我们先来了解下什么是时间。</p>
<p>平时我们说的时间年月日时分秒，这个时间是从哪里来的了？为什么不同的国家有不同的时间了？为什么要区分时区了？</p>
<p>带着这些疑问来看以下这篇文章介绍:</p>
<p><a target="_blank" rel="noopener" href="https://www.zhihu.com/question/21045190">网络时间同步是怎么实现的？怎样消除延迟带来的影响？</a></p>
<p>这里我直接跳到重要的理论知识和结论上来。</p>
<p>世界标准时间:</p>
<ol>
<li><strong>世界时</strong>：基于天文现象 + 钟表计时，永远与地球自转时间相匹配</li>
<li><strong>国际原子时</strong>：基于原子钟计时，每一秒的周期完全等长且固定</li>
</ol>
<p><a target="_blank" rel="noopener" href="https://www.zhihu.com/question/21045190">原子时非常稳定，但世界时随着地球自转变慢，会越来越慢. 科学家通过「闰秒」的方式来矫正这个误差，从而实现世界时+国际原子时混合的方式得到准确的计时。</a></p>
<p>上面说的**基于原子时 + 世界时「协调」**得出的时间就是我们通常说的<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%8D%8F%E8%B0%83%E4%B8%96%E7%95%8C%E6%97%B6">UTC时间</a>。有了UTC标准时间，各个国家的时间就是基于UTC+-*的方式的出来的，也就是我们通常说的时区时间(e.g. 北京时间，巴黎时间……)。<strong>当我们开发多个国家的游戏的时候，为了确保时间的统一，这个时候我们就可以采用UTC时间作为时间标准，每个国家的时间戳计算标准都是统一的(不需要考虑时区问题)。</strong></p>
<p>在了解了UTC(统一标准时间)的来路后，那么接下来就是本文的重点如何同步网络时间。</p>
<h3 id="Unix时间戳"><a href="#Unix时间戳" class="headerlink" title="Unix时间戳"></a>Unix时间戳</h3><p><strong>时间戳适用于表示一个时间从固定时间点到当前时间的总秒数(或微秒数不同编程语言有不同)。</strong></p>
<p>而编程里常用的则是Unix时间戳。</p>
<p><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/UNIX%E6%97%B6%E9%97%B4">Unix时间戳是从UTC1970年1月1日0时0分0秒起至现在的总秒数，不考虑闰秒。</a></p>
<p>Note:</p>
<ol>
<li><strong>时间戳没有时区之分</strong></li>
<li><strong>Unix时间戳是从1970年1月1日0点0分0秒作为基准算起</strong></li>
</ol>
<h2 id="网络对时"><a href="#网络对时" class="headerlink" title="网络对时"></a>网络对时</h2><p>网络对时顾名思义需要通过网络进行对时访问，而网络的访问我们都知道会有网络延时，那么我们如何在网络延时的基础上做到正确的网络对时了？</p>
<p>前人已经为此提供了解决方案，那就是<strong>NTP(Network Time Protocol)(网络对时服务)</strong></p>
<p>这里简单了解下NTP是如何做到网络时间同步的。</p>
<p><a target="_blank" rel="noopener" href="https://www.zhihu.com/question/21045190">通过在网络报文上打「时间戳」的方式，然后配合计算网络延迟，从而修正本机的时间。</a></p>
<p><img src="/img/SyncTime/NTPTimeCaculation.jpg" alt="网络对时请求"></p>
<p><a target="_blank" rel="noopener" href="https://www.zhihu.com/question/21045190">根据图示可以计算出网络「传输延迟」，以及客户端与服务端的「时间差」：</a></p>
<p><a target="_blank" rel="noopener" href="https://www.zhihu.com/question/21045190">网络延时 &#x3D; (t4 - t1) - (t3 - t2)</a></p>
<p><a target="_blank" rel="noopener" href="https://www.zhihu.com/question/21045190">时间差 &#x3D; t2 - t1 - 网络延时 &#x2F; 2</a></p>
<p><a target="_blank" rel="noopener" href="https://www.zhihu.com/question/21045190">这个计算过程假设网络来回路径是对称的，并且时延相同。</a></p>
<p><strong>可以看到通过包含发送，接收，返回和返回接收时间戳的方式，我们可以计算出网络延迟从而做到正确的同步的网络时间</strong></p>
<p>为了确保逻辑正确，时间严格意义上是不允许倒退的。那通过NTP同步的时间会出现时光倒流的情况吗？</p>
<p>NTP为此提供了两种方式:</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://www.zhihu.com/question/21045190"><strong>ntpdate</strong>：一切以服务端时间为准，「强制修改」本机时间</a></li>
<li><a target="_blank" rel="noopener" href="https://www.zhihu.com/question/21045190"><strong>ntpd</strong>：采用「润物细无声」的方式修改本机时间，把时间差均摊到每次小的调整上，避免发生「时光倒流」</a></li>
</ol>
<p>在了解了NTP的对时原理后，接下来让我们通过实战Socket网络请求利用NTP实现网络对时功能。</p>
<h3 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h3><p>在实现通过Socket访问网络请求时，先让我们了解一下NTP的报文格式:</p>
<p><img src="/img/SyncTime/NTPDataContent.png" alt="NTP报文格式"></p>
<p>了解了NTP的报文格式我们就能编写Socket代码请求访问获取对时相关信息:</p>
<p>对时NTP网址，我采用的是阿里云提供的地址:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             NTPHostConfig.cs</span></span><br><span class="line"><span class="comment"> * Author:                  TonyTang</span></span><br><span class="line"><span class="comment"> * Create Date:             2022/07/21</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> NTPHostConfig.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> NTP网址配置</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">NTPHostConfig</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> NTP网址列表</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> List&lt;<span class="built_in">string</span>&gt; NTPHostList = <span class="keyword">new</span> List&lt;<span class="built_in">string</span>&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;ntp2.aliyun.com&quot;</span>,</span><br><span class="line">        <span class="string">&quot;ntp3.aliyun.com&quot;</span>,</span><br><span class="line">        <span class="string">&quot;ntp4.aliyun.com&quot;</span>,</span><br><span class="line">        <span class="string">&quot;ntp5.aliyun.com&quot;</span>,</span><br><span class="line">        <span class="string">&quot;ntp6.aliyun.com&quot;</span>,</span><br><span class="line">        <span class="string">&quot;ntp7.aliyun.com&quot;</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             NTPClient.cs</span></span><br><span class="line"><span class="comment"> * Author:                  TonyTang</span></span><br><span class="line"><span class="comment"> * Create Date:             2022/07/15</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Net;</span><br><span class="line"><span class="keyword">using</span> System.Net.Sockets;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> NTPClient.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> NTP客户端</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">NTPClient</span> : <span class="title">SingletonTemplate</span>&lt;<span class="title">NTPClient</span>&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 对时网络地址(直接传IP地址时无值)</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Host</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 对时IP连接地址</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> IPEndPoint IPEnd</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> NTP连接端口号</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">const</span> <span class="built_in">int</span> PortNumber = <span class="number">123</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> NTP Socket</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> Socket mNTPSocket;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> NTP请求数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">byte</span>[] mNtpSendData;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> NTP接受数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">byte</span>[] mNtpReceiveData;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 服务器接收客户端时间请求时间起始位置</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">const</span> <span class="built_in">int</span> ServerReceivedTimePos = <span class="number">32</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 服务器回复时间起始位置</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">const</span> <span class="built_in">int</span> ServerReplyTimePos = <span class="number">40</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> UTC时间戳基准时间</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> DateTime UTCBaseTime = <span class="keyword">new</span> DateTime(<span class="number">1900</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, DateTimeKind.Utc);</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> NTP网址列表</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> List&lt;<span class="built_in">string</span>&gt; mNTPHostList;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 时间同步是否成功</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">bool</span> IsTimeSyncSuccess;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">NTPClient</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mNtpSendData = <span class="keyword">new</span> <span class="built_in">byte</span>[<span class="number">48</span>];</span><br><span class="line">        <span class="comment">// Setting the Leap Indicator, Version Number and Mode values</span></span><br><span class="line">        <span class="comment">// LI = 0 (no warning), VN = 3 (IPv4 only), Mode = 3 (Client Mode)</span></span><br><span class="line">        mNtpSendData[<span class="number">0</span>] = <span class="number">0x1B</span>;</span><br><span class="line">        mNtpReceiveData = <span class="keyword">new</span> <span class="built_in">byte</span>[<span class="number">48</span>];</span><br><span class="line">        IsTimeSyncSuccess = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 设置NTP网址列表</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;ntpHostList&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">SetHostList</span>(<span class="params">List&lt;<span class="built_in">string</span>&gt; ntpHostList</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        mNTPHostList = ntpHostList;</span><br><span class="line">        <span class="keyword">if</span> (!HasHost())</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">$&quot;请勿设置空NTP网址列表!&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 同步网络时间</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">SyncTime</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 未来有服务器的话，改为和服务器对时</span></span><br><span class="line">        <span class="keyword">if</span>(!HasHost())</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.Log(<span class="string">$&quot;没有有效NTP网址,对时失败!&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        DateTime? syncDateTime = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>, length = mNTPHostList.Count; i &lt; length; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            InitByHost(mNTPHostList[i]);</span><br><span class="line">            <span class="keyword">if</span> (SyncTime(<span class="keyword">out</span> syncDateTime))</span><br><span class="line">            &#123;</span><br><span class="line">                IsTimeSyncSuccess = <span class="literal">true</span>;</span><br><span class="line">                TimeHelper.SetNowUTCTime((DateTime)syncDateTime);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        IsTimeSyncSuccess = <span class="literal">false</span>;</span><br><span class="line">        Debug.LogError(<span class="string">$&quot;所有NTP地址都同步时间失败!&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 网络对时是否成功</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">IsSyncTimeSuccess</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> IsTimeSyncSuccess;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 初始化对时地址</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;host&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="built_in">bool</span> <span class="title">InitByHost</span>(<span class="params"><span class="built_in">string</span> host</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Host = host;</span><br><span class="line">        IPEnd = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">var</span> ipAdresses = Dns.GetHostAddresses(Host);</span><br><span class="line">        <span class="keyword">if</span>(ipAdresses != <span class="literal">null</span> &amp;&amp; ipAdresses.Length &gt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            IPEnd = <span class="keyword">new</span> IPEndPoint(ipAdresses[<span class="number">0</span>], PortNumber);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">$&quot;网络地址:<span class="subst">&#123;host&#125;</span>的IP解析错误!&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 初始化对时IP地址</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;ip&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="built_in">bool</span> <span class="title">InitByIP</span>(<span class="params"><span class="built_in">string</span> ip</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Host = <span class="literal">null</span>;</span><br><span class="line">        IPEnd = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">var</span> ipAdress = IPAddress.Parse(ip);</span><br><span class="line">        <span class="keyword">if</span> (ipAdress != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            IPEnd = <span class="keyword">new</span> IPEndPoint(ipAdress, PortNumber);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">$&quot;IP地址:<span class="subst">&#123;ip&#125;</span>解析错误!&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 网络对时</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;syncDateTime&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="built_in">bool</span> <span class="title">SyncTime</span>(<span class="params"><span class="keyword">out</span> DateTime? syncDateTime</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        syncDateTime = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (IPEnd != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                mNTPSocket = <span class="keyword">new</span> Socket(AddressFamily.InterNetwork, SocketType.Dgram, ProtocolType.Udp);</span><br><span class="line">                Debug.Log(<span class="string">$&quot;网址:<span class="subst">&#123;Host&#125;</span> IP地址:<span class="subst">&#123;IPEnd.ToString()&#125;</span>&quot;</span>);</span><br><span class="line">                mNTPSocket.Connect(IPEnd);</span><br><span class="line">                mNTPSocket.ReceiveTimeout = <span class="number">3000</span>;</span><br><span class="line">                <span class="comment">// 客户端发送时间</span></span><br><span class="line">                <span class="built_in">ulong</span> clientSendTime = (<span class="built_in">ulong</span>)DateTime.UtcNow.Millisecond;</span><br><span class="line">                Debug.Log(<span class="string">$&quot;客户端发送时间:<span class="subst">&#123;clientSendTime&#125;</span>&quot;</span>);</span><br><span class="line">                mNTPSocket.Send(mNtpSendData);</span><br><span class="line">                Array.Clear(mNtpReceiveData, <span class="number">0</span>, mNtpReceiveData.Length);</span><br><span class="line">                <span class="keyword">var</span> recceiveByteNumbers = mNTPSocket.Receive(mNtpReceiveData);</span><br><span class="line">                Debug.Log(<span class="string">$&quot;接受返回字节数:<span class="subst">&#123;recceiveByteNumbers&#125;</span>&quot;</span>);</span><br><span class="line">                <span class="comment">// 客户端接收时间</span></span><br><span class="line">                <span class="built_in">ulong</span> clientReceiveTime = (<span class="built_in">ulong</span>)DateTime.UtcNow.Millisecond;</span><br><span class="line">                Debug.Log(<span class="string">$&quot;客户端接收时间:<span class="subst">&#123;clientReceiveTime&#125;</span>&quot;</span>);</span><br><span class="line">                mNTPSocket.Shutdown(SocketShutdown.Both);</span><br><span class="line">                <span class="comment">// 服务器接受消息时间</span></span><br><span class="line">                <span class="keyword">var</span> serverReceivedTime = GetMilliSeconds(mNtpReceiveData, ServerReceivedTimePos);</span><br><span class="line">                Debug.Log(<span class="string">$&quot;服务器接受消息时间:<span class="subst">&#123;serverReceivedTime&#125;</span>&quot;</span>);</span><br><span class="line">                <span class="comment">// 服务器返回消息时间</span></span><br><span class="line">                <span class="keyword">var</span> serverReplyTime = GetMilliSeconds(mNtpReceiveData, ServerReplyTimePos);</span><br><span class="line">                Debug.Log(<span class="string">$&quot;服务器返回消息时间:<span class="subst">&#123;serverReplyTime&#125;</span>&quot;</span>);</span><br><span class="line">                <span class="comment">// 网路延时 = (客户端接收时间 - 客户端发送时间) - (服务器返回消息时间 - 服务器接受消息时间)</span></span><br><span class="line">                <span class="comment">// 时间差 = 服务器接受消息时间 - 客户端发送时间 - 网络延时 / 2 = ((服务器接受消息时间 - 客户端发送时间) + (服务器返回消息时间 - 客户端接收时间)) / 2</span></span><br><span class="line">                <span class="comment">// 当前同步服务器时间 = 客户端接收时间 + 时间差</span></span><br><span class="line">                <span class="keyword">var</span> offsetTime = ((serverReceivedTime - clientSendTime) + (serverReplyTime - clientReceiveTime)) / <span class="number">2</span>;</span><br><span class="line">                <span class="keyword">var</span> syncTime = clientReceiveTime + offsetTime;</span><br><span class="line">                syncDateTime = UTCBaseTime.AddMilliseconds(syncTime);</span><br><span class="line">                Debug.Log(<span class="string">$&quot;IP地址:<span class="subst">&#123;IPEnd.ToString()&#125;</span>,当前同步UTC时间:<span class="subst">&#123;syncDateTime.ToString()&#125;</span>&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span>(SocketException e)</span><br><span class="line">            &#123;</span><br><span class="line">                Debug.LogError(<span class="string">$&quot;IP地址:<span class="subst">&#123;IPEnd.ToString()&#125;</span>连接异常:<span class="subst">&#123;e.Message&#125;</span>,ErrorCode:<span class="subst">&#123;e.ErrorCode&#125;</span>!&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">finally</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//关闭Socket并释放资源</span></span><br><span class="line">                mNTPSocket.Close();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">$&quot;未初始化IP地址,网络对时失败!&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 是否有NTP网址</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="built_in">bool</span> <span class="title">HasHost</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> mNTPHostList != <span class="literal">null</span> &amp;&amp; mNTPHostList.Count &gt; <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 获取指定偏移的时间戳</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;byteDatas&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;byteOffset&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="built_in">ulong</span> <span class="title">GetMilliSeconds</span>(<span class="params"><span class="built_in">byte</span>[] byteDatas, <span class="built_in">int</span> byteOffset</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">                <span class="comment">// Note:</span></span><br><span class="line">        <span class="comment">// 64bit时间戳，高32bit表示整数部分，低32bit表示小数部分</span></span><br><span class="line">        <span class="comment">// 默认网络获取的时间戳是大端</span></span><br><span class="line">        <span class="built_in">ulong</span> intPart = BitConverter.ToUInt32(mNtpReceiveData, ServerReplyTimePos);</span><br><span class="line">        <span class="built_in">ulong</span> fractPart = BitConverter.ToUInt32(mNtpReceiveData, ServerReplyTimePos + <span class="number">4</span>);</span><br><span class="line">        <span class="comment">// 转换成小端</span></span><br><span class="line">        <span class="keyword">if</span>(ByteUtilities.IsLittleEndian)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 注意只转换64里的低32位</span></span><br><span class="line">            intPart = ByteUtilities.SwapEndianU32(intPart);</span><br><span class="line">            fractPart = ByteUtilities.SwapEndianU32(fractPart);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> (intPart * <span class="number">1000</span>) + ((fractPart * <span class="number">1000</span>) / <span class="number">0x100000000</span>UL);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 二进制辅助静态工具类</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">ByteUtilities</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 是否是小端</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">bool</span> IsLittleEndian = CheckLittleEndian();</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 当前设备是否是小端</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">unsafe</span> <span class="built_in">bool</span> <span class="title">CheckLittleEndian</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">int</span> i = <span class="number">1</span>;</span><br><span class="line">        <span class="built_in">byte</span>* b = (<span class="built_in">byte</span>*)&amp;i;</span><br><span class="line">        <span class="keyword">return</span> b[<span class="number">0</span>] == <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> UInt16大小端转换</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;value&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">ushort</span> <span class="title">SwapEndianU16</span>(<span class="params"><span class="built_in">ushort</span> <span class="keyword">value</span></span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> (<span class="built_in">ushort</span>)((<span class="keyword">value</span> &amp; <span class="number">0xFF</span>U) &lt;&lt; <span class="number">8</span> | (<span class="keyword">value</span> &amp; <span class="number">0xFF00</span>U) &gt;&gt; <span class="number">8</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> UInt32大小端转换</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;value&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">uint</span> <span class="title">SwapEndianU32</span>(<span class="params"><span class="built_in">uint</span> <span class="keyword">value</span></span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">value</span> &amp; <span class="number">0x000000FF</span>U) &lt;&lt; <span class="number">24</span> | (<span class="keyword">value</span> &amp; <span class="number">0x0000FF00</span>U) &lt;&lt; <span class="number">8</span> |</span><br><span class="line">               (<span class="keyword">value</span> &amp; <span class="number">0x00FF0000</span>U) &gt;&gt; <span class="number">8</span> | (<span class="keyword">value</span> &amp; <span class="number">0xFF000000</span>U) &gt;&gt; <span class="number">24</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> UInt64大小端32位转换</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;value&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">ulong</span> <span class="title">SwapEndianU32</span>(<span class="params"><span class="built_in">ulong</span> <span class="keyword">value</span></span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">value</span> &amp; <span class="number">0x000000FF</span>U) &lt;&lt; <span class="number">24</span> | (<span class="keyword">value</span> &amp; <span class="number">0x0000FF00</span>U) &lt;&lt; <span class="number">8</span> |</span><br><span class="line">               (<span class="keyword">value</span> &amp; <span class="number">0x00FF0000</span>U) &gt;&gt; <span class="number">8</span> | (<span class="keyword">value</span> &amp; <span class="number">0xFF000000</span>U) &gt;&gt; <span class="number">24</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> UInt64大小端64位转换</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;value&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">ulong</span> <span class="title">SwapEndianU64</span>(<span class="params"><span class="built_in">ulong</span> <span class="keyword">value</span></span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">value</span> &amp; <span class="number">0x00000000000000FF</span>UL) &lt;&lt; <span class="number">56</span> | (<span class="keyword">value</span> &amp; <span class="number">0x000000000000FF00</span>UL) &lt;&lt; <span class="number">40</span> |</span><br><span class="line">               (<span class="keyword">value</span> &amp; <span class="number">0x0000000000FF0000</span>UL) &lt;&lt; <span class="number">24</span> | (<span class="keyword">value</span> &amp; <span class="number">0x00000000FF000000</span>UL) &lt;&lt; <span class="number">8</span> |</span><br><span class="line">               (<span class="keyword">value</span> &amp; <span class="number">0x000000FF00000000</span>UL) &gt;&gt; <span class="number">8</span> | (<span class="keyword">value</span> &amp; <span class="number">0x0000FF0000000000</span>UL) &gt;&gt; <span class="number">24</span> |</span><br><span class="line">               (<span class="keyword">value</span> &amp; <span class="number">0x00FF000000000000</span>UL) &gt;&gt; <span class="number">40</span> | (<span class="keyword">value</span> &amp; <span class="number">0xFF00000000000000</span>UL) &gt;&gt; <span class="number">56</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>从上面的代码可以看出，我们为了确保对时的快速，选择了UDP而非TCP。</p>
<p>其次通过解析NTP网址返回的NTP报文信息(e.g. 服务器接受消息时间和服务器返回消息时间)，我们可以计算出客户端和服务器的时间差，从而计算出正确的网络UTC时间。</p>
<p><strong>网路延时 &#x3D; (客户端接收时间 - 客户端发送时间) - (服务器返回消息时间 - 服务器接受消息时间)</strong></p>
<p><strong>时间差 &#x3D; 服务器接受消息时间 - 客户端发送时间 - 网络延时 &#x2F; 2 &#x3D; ((服务器接受消息时间 - 客户端发送时间) + (服务器返回消息时间 - 客户端接收时间)) &#x2F; 2</strong></p>
<p><strong>当前同步服务器时间 &#x3D; 客户端接收时间 + 时间差</strong></p>
<p>对时成功后，我们把对时的UTC时间设置到我们本地时间工具类里供访问使用:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             TimeHelper.cs</span></span><br><span class="line"><span class="comment"> * Author:                  TonyTang</span></span><br><span class="line"><span class="comment"> * Create Date:             2022/07/16</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 时间静态类</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">TimeHelper</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 同步网络UTC时间</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> DateTime? mSyncUTCTime;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 同步网络本地时间</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> DateTime? mSyncLocalTime;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 设置当前UTC时间</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;nowDateTime&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">SetNowUTCTime</span>(<span class="params">DateTime? nowDateTime</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        mSyncUTCTime = nowDateTime;</span><br><span class="line">        mSyncLocalTime = nowDateTime != <span class="literal">null</span> ? ((DateTime)nowDateTime).ToLocalTime() : nowDateTime;</span><br><span class="line">        <span class="keyword">if</span> (mSyncUTCTime != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.Log(<span class="string">$&quot;同步当前UTC时间:<span class="subst">&#123;mSyncUTCTime.ToString()&#125;</span>&quot;</span>);</span><br><span class="line">            Debug.Log(<span class="string">$&quot;同步当前时区时间:<span class="subst">&#123;mSyncLocalTime.ToString()&#125;</span>&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            Debug.Log(<span class="string">$&quot;清空当前同步时间!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 获取当前同步UTC时间(没有成功同步返回本地UTC时间)</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> DateTime <span class="title">GetNowUTCTime</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> mSyncUTCTime != <span class="literal">null</span> ? (DateTime)mSyncUTCTime : GetLocalNowUTCTime();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 获取当前同步本地时区时间(没有成功同步返回本地时区时间)</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> DateTime <span class="title">GetNowLocalTime</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> mSyncUTCTime != <span class="literal">null</span> ? ((DateTime)mSyncUTCTime).ToLocalTime() : GetLocalNowTime();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 获取本地当前UTC时间</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> DateTime <span class="title">GetLocalNowUTCTime</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> DateTime.UtcNow;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 获取本地当前时间</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> DateTime <span class="title">GetLocalNowTime</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> DateTime.Now;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>来看看实战效果:</p>
<p><strong>我把本地时间同步关闭，并修改时间从2022&#x2F;07&#x2F;22 00:06到2022&#x2F;07&#x2F;24&#x2F;03:06时间</strong></p>
<p>同步时间前:</p>
<p><img src="/img/SyncTime/BeforeSyncTime.PNG" alt="同步时间前"></p>
<p>同步时间后:</p>
<p><img src="/img/SyncTime/AfterSyncTime.PNG" alt="同步时间后"></p>
<p>从上面可以看到通过NTP的对时后，我们成功获取到了网络的UTC时间。</p>
<p><strong>但上面的代码还有一个问题，对时后的UTC时间是固定的，我们无法向DateTime.Now或DateTime.UtcNow的方式实时访问同步的UTC时间。</strong></p>
<p>这个时候我们需要通过<strong>网络同步时间+本地运行时间&#x3D;本地最新网络同步时间</strong>的方式计算出最新的本地网络同步时间，毕竟我们整个游戏开发过程中并不想一直去通过短连接同步网络时间。</p>
<p>关于<strong>本地运行时间</strong>Unity给我们提供了一个无关Time.scale变化的一个运行时间，那就是<strong>Time.realtimeSinceStartup(标识游戏启动开始算起经历的时间s,不受Time.scale影响)</strong></p>
<p><strong>当前同步网络时间公式:</strong></p>
<p><strong>当前同步网络时间 &#x3D; 网络对时 + (本地运行时长 - 对时时本地运行时长)</strong></p>
<p><img src="/img/SyncTime/AfterSyncAddRealtime.PNG" alt="当前同步网络UTC时间"></p>
<p>最终代码如下:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             TimeHelper.cs</span></span><br><span class="line"><span class="comment"> * Author:                  TonyTang</span></span><br><span class="line"><span class="comment"> * Create Date:             2022/07/16</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 时间静态类</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">TimeHelper</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 同步网络UTC时间</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> DateTime? mSyncUTCTime;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 同步网络本地时间</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> DateTime? mSyncLocalTime;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 同步时间时的本地运行时间</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">float</span> mSyncRealtime;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 设置当前UTC时间</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;nowDateTime&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">SetNowUTCTime</span>(<span class="params">DateTime? nowDateTime</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        mSyncUTCTime = nowDateTime;</span><br><span class="line">        mSyncLocalTime = nowDateTime != <span class="literal">null</span> ? ((DateTime)nowDateTime).ToLocalTime() : nowDateTime;</span><br><span class="line">        <span class="keyword">if</span> (mSyncUTCTime != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            mSyncRealtime = Time.realtimeSinceStartup;</span><br><span class="line">            Debug.Log(<span class="string">$&quot;同步时间时本地运行时间:<span class="subst">&#123;mSyncRealtime&#125;</span>&quot;</span>);</span><br><span class="line">            Debug.Log(<span class="string">$&quot;同步当前UTC时间:<span class="subst">&#123;mSyncUTCTime.ToString()&#125;</span>&quot;</span>);</span><br><span class="line">            Debug.Log(<span class="string">$&quot;同步当前时区时间:<span class="subst">&#123;mSyncLocalTime.ToString()&#125;</span>&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            Debug.Log(<span class="string">$&quot;清空当前同步时间!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 获取当前同步UTC时间(没有成功同步返回本地UTC时间)</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> DateTime <span class="title">GetNowUTCTime</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(mSyncUTCTime != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> syncUTCTime = (DateTime)mSyncUTCTime;</span><br><span class="line">            <span class="keyword">return</span> syncUTCTime.AddSeconds(Time.realtimeSinceStartup - mSyncRealtime);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> GetLocalNowUTCTime();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 获取当前同步本地时区时间(没有成功同步返回本地时区时间)</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> DateTime <span class="title">GetNowLocalTime</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (mSyncLocalTime != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> syncLocalTime = (DateTime)mSyncLocalTime;</span><br><span class="line">            <span class="keyword">return</span> syncLocalTime.AddSeconds(Time.realtimeSinceStartup - mSyncRealtime);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> GetLocalNowTime();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 获取本地当前UTC时间</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> DateTime <span class="title">GetLocalNowUTCTime</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> DateTime.UtcNow;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 获取本地当前时间</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> DateTime <span class="title">GetLocalNowTime</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> DateTime.Now;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>可以看到我们通过记录同步网络时间时的本地真实运行时间，在下一次获取当前网络时间时通过当前真实运行时间 - 同步网络时本地真实运行时间得出同步时间后真实运行的时间，从而计算出当前网络最新时间。</strong></p>
<p>成功同步时间以后，如果我们制作的游戏要支持多个国家的话，我们需要统一游戏里的时间计算，这个时候我们会用到UTC时间和时间戳的概念。结合前面时间戳的介绍，我知道Unix时间戳是基于1970年1月1日0点0分0秒，那么通过网络UTC对时后，我们可以成功计算出网络对时的时间戳:</p>
<p><strong>当前时间戳 &#x3D; 当前同步网络时间 - Unix时间戳基准时间(1970&#x2F;1&#x2F;1)</strong></p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Unix时间戳基准时间</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> DateTime UnixBaseTime = <span class="keyword">new</span> DateTime(<span class="number">1970</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, DateTimeKind.Utc);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> offsetTimeSpan = (DateTime)mSyncUTCTime - UnixBaseTime;</span><br><span class="line">mSyncUTCTimeStamp = (<span class="built_in">long</span>)offsetTimeSpan.TotalSeconds;</span><br><span class="line">Debug.Log(<span class="string">$&quot;同步时间UTC时间戳:<span class="subst">&#123;mSyncUTCTimeStamp&#125;</span>&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 获取当前同步UTC时间戳(没有成功同步返回本地UTC时间戳)</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">long</span> <span class="title">GetNowUTCTimeStamp</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> nowUTCTime = GetNowUTCTime();</span><br><span class="line">    <span class="keyword">var</span> offsetSeconds = nowUTCTime - UnixBaseTime;</span><br><span class="line">    <span class="keyword">return</span> (<span class="built_in">long</span>)offsetSeconds.TotalSeconds;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 获取本地当前UTC时间戳</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">long</span> <span class="title">GetLocalNowUTCTimeStamp</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> DateTimeOffset.UtcNow.ToUnixTimeSeconds();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>同步UTC时间前时间戳:</p>
<p><img src="/img/SyncTime/BeforeSyncUnixTimeStamp.PNG" alt="同步UTC时间前时间戳"></p>
<p>同步UTC时间后时间戳:</p>
<p><img src="/img/SyncTime/AfterSyncUnixTimeStamp.PNG" alt="同步UTC时间后时间戳"></p>
<p><strong>可以看到我们通过和Unix时间戳基准时间(1970年1月1月0时0分0秒)成功计算出了当前对时的UTC时间戳</strong></p>
<h2 id="重点知识"><a href="#重点知识" class="headerlink" title="重点知识"></a>重点知识</h2><ol>
<li><strong>同步网络对网络要求不高，可以采用UDP</strong></li>
<li><strong>NTP报文里有服务器相关获得请求时间和服务求返回请求时间，通过这些数据的解析我们能计算出真实的网络时间</strong></li>
<li><strong>NTP里的时间戳是基于1900年1月1日，而非像Unix时间戳基于1970年1月1日</strong></li>
<li><strong>本地最新网络时间需要通过记录对时时的运行时间来计算最新的当前网络时间</strong></li>
<li><strong>网络时间同步没必要一直同步，可以采用短连接在必要的时候同步一次</strong></li>
</ol>
<h2 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h2><p><a target="_blank" rel="noopener" href="https://www.zhihu.com/question/21045190">网络时间同步是怎么实现的？怎样消除延迟带来的影响？</a></p>
<p><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%8D%8F%E8%B0%83%E4%B8%96%E7%95%8C%E6%97%B6">统一标准时间(UTC)</a></p>
<p><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E7%B6%B2%E8%B7%AF%E6%99%82%E9%96%93%E5%8D%94%E5%AE%9A">网络时间协议(Network Time Protocol, 缩写NTP)</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.51cto.com/u_15061944/4060944">通过NTP协议进行时间同步</a></p>
<p><a target="_blank" rel="noopener" href="https://www.daimajiaoliu.com/daima/4793ea529900404">ntp原理及客户端实现</a></p>
<p><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1358922">客户端秒级时间同步方案</a></p>
<p><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/UNIX%E6%97%B6%E9%97%B4">Unix时间戳</a></p>
<h2 id="Github"><a href="#Github" class="headerlink" title="Github"></a>Github</h2><p><a target="_blank" rel="noopener" href="https://github.com/TonyTang1990/SyncTime">SyncTime</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Database/">Database</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Time/">Time</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2022/07/16/可配置Asset管线系统/" title="可配置Asset管线系统" itemprop="url">可配置Asset管线系统</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Tony Tang" target="_blank" itemprop="author">Tony Tang</a>
		
  <p class="article-time">
    <time datetime="2022-07-16T04:16:00.000Z" itemprop="datePublished"> 发表于 2022-07-16</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>日常项目中，我们对于Unity资源导入会做一些<strong>自动化的设置和检查，确保导入到项目里的资源是正确符合要求的，确保游戏资源最优化</strong>。而这些自动化检查和处理离不开<strong>AssetPostProcess</strong>接口，常规的方式是通过重写AssetPostProcess相关接口进行硬编码的方式实现资源导入自动化检查和设置。但这样的实现方式显得不灵活，当我们需要改变或新增一些资源时，我们需要硬编码去实现需求。</p>
<p><strong>为了寻求高效高度扩展性的Asset管线系统，从而引出了本篇文章实现的可配置化Asset管线系统。</strong></p>
<h2 id="Asset管线设计"><a href="#Asset管线设计" class="headerlink" title="Asset管线设计"></a>Asset管线设计</h2><ol>
<li>使用ScriptableObject实现自定义配置数据存储，结合导出Json实现无需等待配置Asset导入就可读取数据进行Asset管线系统初始化</li>
<li>使用EditorWindow实现自定义配置窗口</li>
<li>使用AssetPostProcess实现Asset后处理系统流程接入</li>
<li>设计AssetPipeline和AssetPipelineSystem实现Asset管线系统流程初始化(利用InitializeOnLoadMethodAttribute标签实现Asset管线提前初始化)</li>
<li>设计AssetProcessorSystem和AssetCheckSystem实现Asset管线的2大系统(Asset处理系统和Asset检查系统)</li>
<li>支持配置多个Asset管线策略以及不同平台选用不同策略来实现平台各异化的管线系统配置</li>
<li>支持Asset管线预处理，后处理，移动处理和删除处理器配置</li>
<li>支持全局和局部两种大的类型处理器和检查器配置</li>
<li>支持Asset管线预检查和后检查检查器配置</li>
<li>支持局部Asset处理器和检查器黑名单目录配置</li>
<li>处理器和检查器支持指定Asset类型级别设置</li>
<li>处理器和检查器支持指定Asset管线处理类型(AssetPostProcess相关流程接口)级别设置</li>
<li>支持所有处理器和检查器UI预览查看</li>
</ol>
<p>Note:</p>
<ol>
<li><strong>Asset管线先执行全局后局部,局部Asset处理由外到内执行(覆盖关系)</strong></li>
<li><strong>Asset管线移动Asset当做重新导入Asset处理，确保Asset移动后得到正确的Asset管线处理</strong></li>
<li><strong>Asset管线不满足条件的不会触发(比如: 1. 不在目标资源目录下 2. 在黑名单列表里)</strong></li>
<li><strong>配置符合的触发顺序如下: 触发Asset导入全局预检查 -&gt; 触发Asset导入局部预检查 -&gt; 触发Asset导入全局预处理 -&gt; 触发Asset导入局部预处理 -&gt; 触发Asset导入全局后处理 -&gt; 触发Asset导入局部后处理 -&gt; 触发Asset导入全局后检查 -&gt; 触发Asset导入局部后检查</strong></li>
<li><strong>处理器和检查器支持指定需要处理的Asset类型组合，但Asset管线处理类型只能选择一个</strong></li>
<li><strong>通用后处理类型包含后处理，移动处理和删除处理</strong></li>
</ol>
<h2 id="类说明"><a href="#类说明" class="headerlink" title="类说明"></a>类说明</h2><p>Asset管线核心框架部分:</p>
<ul>
<li>AssetType – Asset类型定义</li>
<li>AssetProcessType – Asset管线处理类型定义</li>
<li>AssetPipeline – Asset管线入口(负责接入Asset后处理流程以及Asset管线系统初始化)</li>
<li>AssetPipelineSystem – Asset管线系统(负责初始化Asset管线里各系统以及各系统调用)</li>
<li>AssetProcessorSystem – Asset处理系统(负责Asset自动化后处理相关配置)</li>
<li>AssetCheckSystem – Asset检查系统(负责Asset自动化检查相关配置)</li>
<li>AssetPipelineSettingData – Asset管线系统配置相关数据(非ScriptableObject)(比如Asset管线开关，Log开关等配置)</li>
<li>ProcessorSettingData – Asset处理器设置数据(AssetPipelineWindow 窗口配置)</li>
<li>ProcessorConfigData – Asset处理器配置数据(AssetPipelineWindow 窗口配置)</li>
<li>AssetCheckSettingData – Asset检查设置数据(AssetPipelineWindow 窗口配置)</li>
<li>AssetCheckConfigData – Asset检查配置数据(AssetPipelineWindow 窗口配置)</li>
<li>BaseProcessor – Asset处理器抽象类(负责抽象Asset处理器流程和数据，继承至ScriptableObject实现自定义数据配置处理)</li>
<li>BaseProcessorJson – Asset处理器Json抽象类(负责抽象Asset处理器流程和数据定义(和BaseProcessor保持一致用于Json反序列化构造)，实现自定义数据配置处理)</li>
<li>BasePreProcessor – Asset预处理器抽象类(负责抽象Asset预处理器流程和数据，继承至BaseProcessor )</li>
<li>BasePreProcessorJson – Asset预处理器Json抽象类(负责抽象Asset预处理器流程和数据定义(和BasePreProcessor保持一致用于Json反序列化构造)，继承至BaseProcessorJson)</li>
<li>BasePostProcessor – Asset预处理器抽象类(负责抽象Asset后处理器流程和数据，继承至BaseProcessor )</li>
<li>BasePostProcessJson – Asset预处理器Json抽象类(负责抽象Asset后处理器流程和数据定义(和BasePostProcessor保持一致用于Json反序列化构造)，继承至BaseProcessorJson)</li>
<li>BaseCheck – Asset检查抽象类(负责抽象Asset检查器流程和数据，继承至ScriptableObject实现自定义数据配置处理)</li>
<li>BaseCheckJson – Asset检查器Json抽象类(负责抽象Asset检查器流程和数据定义(和BaseCheck保持一致用于Json反序列化构建)，实现自定义数据配置处理)</li>
<li>BasePreCheck – Asset预检查抽象类(负责抽象Asset预检查器流程和数据，继承至BaseCheck )</li>
<li>BasePreCheckJson – Asset预检查器Json抽象类(负责抽象Asset预检查器流程和数据定义(和BasePreCheck保持一致用于Json反序列化构建)，继承至BaseCheckJson)</li>
<li>BasePostCheck – Asset后检查抽象类(负责抽象Asset后检查器流程和数据，继承至BaseCheck )</li>
<li>BasePostCheckJson – Asset后检查器Json抽象类(负责抽象Asset后检查器流程和数据定义(和BasePostCheck保持一致用于Json反序列化构建)，继承至BaseCheckJson)</li>
<li>AssetInfo – 用于记录处理器和检查器相关的路径信息和类型信息(用于后续Json反序列依据)</li>
<li>AssetProcessorInfoData – 所有处理器AssetInfo信息集合(用于后续Json反序列化构造处理器依据)</li>
<li>AssetCheckInfoData – 所有检查器AssetInfo信息集合(用于后续Json反序列化构造检查器依据)</li>
<li>更多的数据定义这里就不一一列举了</li>
</ul>
<p>窗口部分:</p>
<ul>
<li>AssetPipelineWindow – Asset管线可配置化配置窗口</li>
<li>AssetPipelinePanel – Asset管线面板</li>
<li>AssetProcessorPanel – Asset处理器面板</li>
<li>AssetCheckPanel – Asset检查器面板</li>
<li>LocaDetailWindow – Asset管线局部数据详情配置窗口(用于配置局部数据黑名单路径配置)</li>
</ul>
<p>其他部分:</p>
<ul>
<li>AssetPipelineUtilities – Asset管线工具类(负责提供Asset管线相关工具方法)</li>
<li>AssetPipelineStyles – Asset管线用到的GUI显示风格定义</li>
<li>AssetPipelineGUIContent – Asset管线用到的显示图标定义</li>
<li>AssetPipelineConst – Asset管线用到的常量定义</li>
<li>AssetPipelineLog – Asset管线自定义Log</li>
<li>AssetPipelinePrefKey – Asset管线本地存储Key定义</li>
</ul>
<h2 id="实战实现"><a href="#实战实现" class="headerlink" title="实战实现"></a>实战实现</h2><p>在了解详细的细节实现之前，先了解下Asset管线是如何定义Asset类型和Asset管线处理类型的，这个对于后续实战配置理解会有帮助。</p>
<ul>
<li><p><strong>Asset类型定义</strong></p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> AssetType.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Asset类型</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">Flags</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="built_in">enum</span> AssetType : Int32</span><br><span class="line">&#123;</span><br><span class="line">    None = <span class="number">0</span>,                         <span class="comment">// 无效类型</span></span><br><span class="line">    Texture = <span class="number">1</span> &lt;&lt; <span class="number">0</span>,                 <span class="comment">// 图片</span></span><br><span class="line">    Material = <span class="number">1</span> &lt;&lt; <span class="number">1</span>,                <span class="comment">// 材质</span></span><br><span class="line">    SpriteAtlas = <span class="number">1</span> &lt;&lt; <span class="number">2</span>,             <span class="comment">// 图集</span></span><br><span class="line">    FBX = <span class="number">1</span> &lt;&lt; <span class="number">3</span>,                     <span class="comment">// 模型文件</span></span><br><span class="line">    AudioClip = <span class="number">1</span> &lt;&lt; <span class="number">4</span>,               <span class="comment">// 音效</span></span><br><span class="line">    Font = <span class="number">1</span> &lt;&lt; <span class="number">5</span>,                    <span class="comment">// 字体</span></span><br><span class="line">    Shader = <span class="number">1</span> &lt;&lt; <span class="number">6</span>,                  <span class="comment">// Shader</span></span><br><span class="line">    Prefab = <span class="number">1</span> &lt;&lt; <span class="number">7</span>,                  <span class="comment">// 预制件</span></span><br><span class="line">    ScriptableObject = <span class="number">1</span> &lt;&lt; <span class="number">8</span>,        <span class="comment">// ScriptableObject</span></span><br><span class="line">    TextAsset = <span class="number">1</span> &lt;&lt; <span class="number">9</span>,               <span class="comment">// 文本Asset</span></span><br><span class="line">    Scene = <span class="number">1</span> &lt;&lt; <span class="number">10</span>,                  <span class="comment">// 场景</span></span><br><span class="line">    AnimationClip = <span class="number">1</span> &lt;&lt; <span class="number">11</span>,          <span class="comment">// 动画文件</span></span><br><span class="line">    Mesh = <span class="number">1</span> &lt;&lt; <span class="number">12</span>,                   <span class="comment">// Mesh文件</span></span><br><span class="line">    Script = <span class="number">1</span> &lt;&lt; <span class="number">13</span>,                 <span class="comment">// 脚本(e.g. cs, dll等)</span></span><br><span class="line">    Video = <span class="number">1</span> &lt;&lt; <span class="number">14</span>,                  <span class="comment">// 视频</span></span><br><span class="line">    Folder = <span class="number">1</span> &lt;&lt; <span class="number">15</span>,                 <span class="comment">// 文件夹</span></span><br><span class="line">    Other = <span class="number">1</span> &lt;&lt; <span class="number">16</span>,                  <span class="comment">// 其他</span></span><br><span class="line">    All = Int32.MaxValue,             <span class="comment">// 所有类型</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​    <strong>上面的Asset类型只所以定义成Flags是为了处理器和检查器可以定义需要支持的Asset类型组合</strong></p>
</li>
<li><p>Asset管线处理类型定义</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> AssetProcessorType.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Asset管线处理类型</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="built_in">enum</span> AssetProcessType</span><br><span class="line">&#123;</span><br><span class="line">    CommonPreprocess = <span class="number">1</span>,               <span class="comment">// 通用预处理</span></span><br><span class="line">    PreprocessAnimation,                <span class="comment">// 动画预处理</span></span><br><span class="line">    PreprocessAudio,                    <span class="comment">// 音效预处理</span></span><br><span class="line">    PreprocessModel,                    <span class="comment">// 模型预处理</span></span><br><span class="line">    PreprocessTexture,                  <span class="comment">// 纹理预处理</span></span><br><span class="line">    CommonPostprocess,                  <span class="comment">// 通用后处理</span></span><br><span class="line">    PostprocessAnimation,               <span class="comment">// 动画后处理</span></span><br><span class="line">    PostprocessModel,                   <span class="comment">// 模型后处理</span></span><br><span class="line">    PostprocessMaterial,                <span class="comment">// 材质后处理</span></span><br><span class="line">    PostprocessPrefab,                  <span class="comment">// 预制件后处理</span></span><br><span class="line">    PostprocessTexture,                 <span class="comment">// 纹理后处理</span></span><br><span class="line">    PostprocessAudio,                   <span class="comment">// 音效后处理</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面的类型分别对应<strong>AssetPostprocessor</strong>里的Asset处理接口，这里就不详细介绍了，具体看代码。</p>
</li>
</ul>
<h3 id="配置窗口"><a href="#配置窗口" class="headerlink" title="配置窗口"></a>配置窗口</h3><p><img src="/img/Unity/AssetPipeline/AssetPipelineConfigPanel.PNG" alt="Asset管线策略配置面板"></p>
<p>此窗口主要负责配置Asset管线策略以及不同平台Asset管线策略的使用。同时也负责选择当前配置的策略和设置全局的资源处理目录。</p>
<p><img src="/img/Unity/AssetPipeline/AssetGlobalPreProcessorConfigPanel.PNG" alt="Asset管线全局预处理器配置面板"></p>
<p><img src="/img/Unity/AssetPipeline/AssetGlobalPostProcessorConfigPanel.PNG" alt="Asset管线全局后处理器配置面板"></p>
<p><strong>全局后处理器，移动处理器和删除处理器配置面板类似就不一一截图了，他们分别对应通用后处理里的imported，moved和deleted流程。</strong></p>
<p><img src="/img/Unity/AssetPipeline/AssetLocalPreProcessorConfigPanel.PNG" alt="Asset管线局部预处理器配置面板"></p>
<p><strong>从上面可以看到我们对于局部处理器的配置方式，是通过制定目录，选择处理器列表的方式实现的，同时每个处理器还支持制定黑名单目录(用于部分处理器子目录不生效的配置)</strong></p>
<p><strong>通过点击数量(*)我们可以打开指定局部处理器配置指定处理器的黑名单详情设置窗口</strong></p>
<p><img src="/img/Unity/AssetPipeline/AssetLocalBlackListConfigWindow.PNG" alt="Asset管线局部数据黑名单目录配置窗口"></p>
<p>通过上面的黑名单目录配置结合前面的局部预处理配置我们可以看出，我们希望ETC2设置对于Assets&#x2F;Res&#x2F;textures目录生效但不希望对Assets&#x2F;Res&#x2F;textures&#x2F;TestBlackList目录生效，对于TestBlackList目录我们单独设置了ASTC处理器设置。</p>
<p><img src="/img/Unity/AssetPipeline/AssetLocalPostProcessorConfigPanel.PNG" alt="Asset管线局部后处理器配置面板"></p>
<p>关于移动处理器和删除处理器和预处理器和后处理器配置类似的，只是对应不同处理流程，这里就不一一截图举例了。</p>
<p><img src="/img/Unity/AssetPipeline/AssetProcessorPreviewPanel.PNG" alt="Asset管线处理器预览面板"></p>
<p><strong>检查器窗口配置和处理器窗口配置是类似的，只是检查器只支持了预检查器和后检查器，这里我就只简单截一张效果图看看，就不详细说明了</strong></p>
<p><img src="/img/Unity/AssetPipeline/AssetGlobalCheckConfigPanel.PNG" alt="Asset管线全局预检查器配置面板"></p>
<p><img src="/img/Unity/AssetPipeline/AssetCheckPreviewPanel.PNG" alt="Asset管线检查器预览面板"></p>
<p>了解了配置窗口，接下来看看我们是如何在Asset管线框架基础上，实现定义这些自定义的处理器和检查器的。</p>
<h3 id="自定义处理器和检查器"><a href="#自定义处理器和检查器" class="headerlink" title="自定义处理器和检查器"></a>自定义处理器和检查器</h3><p><strong>自定义的检查器需要通过继承BasePreProcessor或BasePostProcessor或BasePreCheck或BasePostCheck来实现的</strong></p>
<p>CheckFileName.cs预检查器ScriptableObject数据定义:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> CheckFileName.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 检查文件名</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">CreateAssetMenu(fileName = <span class="string">&quot;CheckFileName&quot;</span>, menuName = <span class="string">&quot;ScriptableObjects/AssetPipeline/AssetCheck/PreCheck/CheckFileName&quot;</span>, order = 2001)</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CheckFileName</span> : <span class="title">BasePreCheck</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 检查器名</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">override</span> <span class="built_in">string</span> Name</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;检查文件名&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 目标Asset类型</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">override</span> AssetType TargetAssetType</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> AssetType.All;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 目标Asset管线处理类型</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">override</span> AssetProcessType TargetAssetProcessType</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> AssetProcessType.CommonPreprocess;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>CheckFileNameJson.cs预检查器Json处理流程和数据定义:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> CheckFileSizeJson.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 检查文件大小检查器Json</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">Serializable</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CheckFileSizeJson</span> : <span class="title">BasePreCheckJson</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 检查器名</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">override</span> <span class="built_in">string</span> Name</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;检查文件大小&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 目标Asset类型</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">override</span> AssetType TargetAssetType</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> AssetPipelineSystem.GetAllCommonAssetType();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 目标Asset管线处理类型</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">override</span> AssetProcessType TargetAssetProcessType</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> AssetProcessType.CommonPreprocess;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 处理器触发排序Order</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">override</span> <span class="built_in">int</span> Order</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 文件大小限制</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> FileSizeLimit = <span class="number">1024</span> * <span class="number">1024</span> * <span class="number">8</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 执行检查器处理</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;assetPostProcessor&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;paramList&quot;&gt;</span>不定长参数<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="built_in">bool</span> <span class="title">DoCheck</span>(<span class="params">AssetPostprocessor assetPostProcessor, <span class="keyword">params</span> <span class="built_in">object</span>[] paramList</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> DoCheckFileSize(assetPostProcessor.assetPath);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 执行指定路径的检查器处理</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;assetPath&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="built_in">bool</span> <span class="title">DoCheckByPath</span>(<span class="params"><span class="built_in">string</span> assetPath, <span class="keyword">params</span> <span class="built_in">object</span>[] paramList</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> DoCheckFileSize(assetPath);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 执行文件大小检查</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;assetPath&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="built_in">bool</span> <span class="title">DoCheckFileSize</span>(<span class="params"><span class="built_in">string</span> assetPath</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> assetFullPath = PathUtilities.GetAssetFullPath(assetPath);</span><br><span class="line">        <span class="keyword">using</span> (FileStream fs = File.Open(assetFullPath, FileMode.Open))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> overSize = fs.Length &gt; FileSizeLimit;</span><br><span class="line">            <span class="keyword">if</span> (!overSize)</span><br><span class="line">            &#123;</span><br><span class="line">                AssetPipelineLog.Log(<span class="string">$&quot;AssetPath:<span class="subst">&#123;assetPath&#125;</span>文件大小检查,实际大小:<span class="subst">&#123;fs.Length / <span class="number">1024f</span> / <span class="number">1024f</span>&#125;</span>M,限制大小:<span class="subst">&#123;FileSizeLimit / <span class="number">1024f</span> / <span class="number">1024f</span>&#125;</span>M&quot;</span>.WithColor(Color.yellow));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                AssetPipelineLog.LogError(<span class="string">$&quot;AssetPath:<span class="subst">&#123;assetPath&#125;</span>文件大小检查,实际大小:<span class="subst">&#123;fs.Length / <span class="number">1024f</span> / <span class="number">1024f</span>&#125;</span>M,限制大小:<span class="subst">&#123;FileSizeLimit / <span class="number">1024f</span> / <span class="number">1024f</span>&#125;</span>M&quot;</span>.WithColor(Color.yellow));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> !overSize;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>从上面可以看到我们通过CheckFileName继承BasePreCheck表明我们是实现一个预检查器。通过声明AssetType为AssetType.All表明我们要支持的所有的Asset类型处理。通过声明TargetAssetProcessType为AssetProcessType.CommonPreprocess表示我们要支持通用预处理流程。</strong></p>
<p><strong>同时为了支持在InitializeOnLoadMethodAttribute方法里读取非Asset相关类型信息和数据进行初始化(后续会讲到为什么)，我们定义了对应的CheckFileNameJson类来实现处理流程和数据定义。因为CheckFileNameJson和CheckFileName的序列化数据定义一致，所以通过CheckFileName的ScriptableObject导出的Json数据是可以成功反序列化读取的。最终我们使用*Json类实现了对配置数据的反序列化从而填充到我们的Asset管线系统里作为后处理数据依据。</strong></p>
<p>ASTC格式设置预处理器ScriptableObeject数据定义:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> ASTCSet.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> ASTC设置</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">CreateAssetMenu(fileName = <span class="string">&quot;ASTCSet&quot;</span>, menuName = <span class="string">&quot;ScriptableObjects/AssetPipeline/AssetProcessor/PreProcessor/ASTCSet&quot;</span>, order = 1001)</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ASTCSet</span> : <span class="title">BasePreProcessor</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 检查器名</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">override</span> <span class="built_in">string</span> Name</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;ASTC设置&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 目标Asset类型</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">override</span> AssetType TargetAssetType</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> AssetType.Texture;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 目标Asset管线处理类型</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">override</span> AssetProcessType TargetAssetProcessType</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> AssetProcessType.PreprocessTexture;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 目标纹理格式</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;目标纹理格式&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> TextureImporterFormat TargetTextureFormat = TextureImporterFormat.ASTC_4x4;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ASTC格式设置预处理器对应*Json的处理流程和数据定义:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> ASTCSetJson.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> ASTC设置预处理器Json</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">Serializable</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ASTCSetJson</span> : <span class="title">BasePreProcessorJson</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 检查器名</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">override</span> <span class="built_in">string</span> Name</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;ASTC设置&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 目标Asset类型</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">override</span> AssetType TargetAssetType</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> AssetType.Texture;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 目标Asset管线处理类型</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">override</span> AssetProcessType TargetAssetProcessType</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> AssetProcessType.PreprocessTexture;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 处理器触发排序Order</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">override</span> <span class="built_in">int</span> Order</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 目标纹理格式</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> TextureImporterFormat TargetTextureFormat = TextureImporterFormat.ASTC_4x4;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 执行处理器处理</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;assetPostProcessor&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;paramList&quot;&gt;</span>不定长参数列表<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">DoProcessor</span>(<span class="params">AssetPostprocessor assetPostProcessor, <span class="keyword">params</span> <span class="built_in">object</span>[] paramList</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> assetImporter = assetPostProcessor.assetImporter;</span><br><span class="line">        DoASTCSet(assetImporter);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 执行指定路径的处理器处理</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;assetPath&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;paramList&quot;&gt;</span>不定长参数列表<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">DoProcessorByPath</span>(<span class="params"><span class="built_in">string</span> assetPath, <span class="keyword">params</span> <span class="built_in">object</span>[] paramList</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> assetImporter = AssetImporter.GetAtPath(assetPath);</span><br><span class="line">        DoASTCSet(assetImporter);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 执行ASTC设置</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;assetImporter&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">DoASTCSet</span>(<span class="params">AssetImporter assetImporter</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> textureImporter = assetImporter <span class="keyword">as</span> TextureImporter;</span><br><span class="line">        <span class="keyword">var</span> actiivePlatformName = EditorUtilities.GetPlatformNameByTarget(EditorUserBuildSettings.activeBuildTarget);</span><br><span class="line">        <span class="keyword">var</span> platformTextureSettings = textureImporter.GetPlatformTextureSettings(actiivePlatformName);</span><br><span class="line">        <span class="keyword">var</span> automaticFormat = textureImporter.GetAutomaticFormat(actiivePlatformName);</span><br><span class="line">        <span class="keyword">var</span> isAutomaticASTC = ResourceUtilities.IsASTCFormat(automaticFormat);</span><br><span class="line">        <span class="keyword">var</span> textureFormat = isAutomaticASTC ? automaticFormat : TargetTextureFormat;</span><br><span class="line">        platformTextureSettings.overridden = <span class="literal">true</span>;</span><br><span class="line">        platformTextureSettings.format = textureFormat;</span><br><span class="line">        textureImporter.SetPlatformTextureSettings(platformTextureSettings);</span><br><span class="line">        AssetPipelineLog.Log(<span class="string">$&quot;设置AssetPath:<span class="subst">&#123;assetImporter.assetPath&#125;</span>纹理压缩格式:<span class="subst">&#123;textureFormat&#125;</span>&quot;</span>.WithColor(Color.yellow));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ASTC设置预处理器和检查文件名预处理器类似，这里就不一一说明了。</p>
<p>但从上面都可以看到每一个处理器和检查器我们都定义了<strong>CreateAssetMenu和一些自定义序列化属性</strong>，这样我们就可以通过右键创建指定处理器和检查器Asset了。</p>
<p><img src="/img/Unity/AssetPipeline/ProcessorCreateOperation.PNG" alt="自定义处理器Asset创建"></p>
<p><img src="/img/Unity/AssetPipeline/CustomProcessorAsset.PNG" alt="自定义处理器Asset"></p>
<p><img src="/img/Unity/AssetPipeline/ProcessorCustomProperty.PNG" alt="处理器自定义参数设置"></p>
<p><strong>从上面可以看到同一个类型定义的处理器，我们可以通过创建多个然后改变处理器参数实现细节不同处理效果的处理器需求。</strong></p>
<h3 id="Asset管线处理"><a href="#Asset管线处理" class="headerlink" title="Asset管线处理"></a>Asset管线处理</h3><p>接下来让我们看看根据实际Asset管线配置，我们的Asset导入是如何触发一系列配置的。</p>
<p><img src="/img/Unity/AssetPipeline/MixFolderLocalPreProcessorConfig.PNG" alt="Mix文件夹局部预处理器配置"></p>
<p><img src="/img/Unity/AssetPipeline/MixFolderAssetPipelineLog.PNG" alt="Mix文件夹Asset导入纹理Log"></p>
<p><img src="/img/Unity/AssetPipeline/MixFolderTextureSettingAfterImport.PNG" alt="Mix文件夹导入纹理处理设置"></p>
<p><strong>可以看到通过配置好的Asset管线流程，我们导入到Mix文件夹的纹理图片，成功触发了一系列的处理器和检查器配置，并最终实现了可配置化检查和处理Asset后处理设置的需求。</strong></p>
<h2 id="重点知识"><a href="#重点知识" class="headerlink" title="重点知识"></a>重点知识</h2><ol>
<li><strong>在DoProcessor和DoProcessorByPath流程接口里有params object[] paramList参数，这个参数就是为了兼容不同Asset管线处理流程数据传递问题的。指定处理器流程的处理器或检查器可以通过强转paramList得到Asset管线流程一开始传递的原始数据。</strong></li>
<li><strong>Asset类型是通过后缀名和类型映射硬编码实现的，如有不支持的文件后置和文件类型，请自行添加。</strong></li>
<li><strong>检查器只支持了预检查器和后检查器，如果未来有移动和删除检查器的需求也是可以支持的</strong></li>
<li><strong>检查器目前检查不符合只是打印日志警告，未来想做更多的处理(e.g. 不满足检查设置的自动移动到指定目录去)</strong></li>
</ol>
<h2 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h2><ol>
<li><strong>默认Editor&#x2F;AssetPipeline&#x2F;Config&#x2F;AssetProcessors和Editor&#x2F;AssetPipeline&#x2F;Config&#x2F;AssetChecks目录下才会生成预览，请创建在这两个目录下</strong></li>
<li><strong>生成AB名处理器会在后处理设置完成后导致Asset处理未保存状态，导致相同Asset设置AB名会重复触发Post Import流程，暂时通过判定AB名是否相同避免重复设置AB名避免重复进入Post Import流程</strong></li>
</ol>
<h2 id="设计实现难点"><a href="#设计实现难点" class="headerlink" title="设计实现难点"></a>设计实现难点</h2><p>问题：</p>
<ol>
<li><strong>原设计全部是基于ScriptableObejct作为数据存储媒介，导致各电脑同步时配置数据也处于导入状态导致无法正确加载最新的后处理配置(更坏的情况可能加载失败)。(2022&#x2F;8&#x2F;31)</strong></li>
<li><strong>InitializeOnLoadMethodAttribute标记的方法里无法使用跟Asset相关的类型(比如ScriptableObject相关类)信息也不允许加载Asset相关资源，如果加载Asset相关类型信息会在触发后处理接口的时候发现Asset相关的类型信息发生了Type Exception(类型丢失)(2023&#x2F;10&#x2F;19)</strong></li>
<li><strong>InitializeOnLoadMethodAttribute标签只能确保部分流程重新初始化AssetPipeline系统，但只有Asset导入(比如协同更新AssetPipeline配置文件时)时并不会触发InitializeOnLoadMethodAttribute，导致Asset未能按最新的AssetPipeline配置执行后处理(2024&#x2F;12&#x2F;19)</strong></li>
</ol>
<p>解决方案:</p>
<ol>
<li><strong>所有ScriptableObject配置导出一份Json(基于ScritableObject的引用改存AssetPath)，保存时基于ScriptableObject配置生成最新的Json数据。Asset管线系统加载配置数据基于导出的Json，ScriptableObject只作为可视化配置读取的数据来源以及导出Json的数据依据。(2022&#x2F;8&#x2F;31)</strong></li>
<li><strong>通过拆分配置数据(比如ASTCSet相关的ScriptableObject只负责数据定义)和处理流程(比如ASTCSetJson负责定义和ASTCSet一致的数据实现配置数据反序列化构建+处理流程定义)实现在InitializeOnLoadMethodAttribute标记的方法里读取Asset管线配置数据进行Asset管线系统数据初始化，作为我们Asset管线后处理数据依据(2023&#x2F;10&#x2F;19)</strong></li>
<li><strong>通过FileSystemWatcher进行对AssetPipeline配置文件保存目录的json文件变化监听，实现AssetPipeline配置文件协同更新时重新初始化AssetPipeline系统(如果用户更新时直接待在Unity界面提前触发Asset导入会导致部分Asset导入时还未加载最新的AssetPipeline配置文件，这个问题暂时没有好的解决方案，欢迎提供好的解决方案)(InitializeOnLoadMethodAttribute+FileSystemWatcher解决99.99%使用情况)</strong></li>
</ol>
<h2 id="Github地址"><a href="#Github地址" class="headerlink" title="Github地址"></a>Github地址</h2><p><a target="_blank" rel="noopener" href="https://github.com/TonyTang1990/AssetPipeline">AssetPipeline</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Unity/">Unity</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Unity/">Unity</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2022/06/01/Excel深入学习/" title="Excel深入学习" itemprop="url">Excel深入学习</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Tony Tang" target="_blank" itemprop="author">Tony Tang</a>
		
  <p class="article-time">
    <time datetime="2022-06-01T15:00:00.000Z" itemprop="datePublished"> 发表于 2022-06-01</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>游戏开发过程中用到的数据我们通常会采用Excel进行配置，这个归功于Excel强大的数据处理和表达能力。无论是Excel的自带的公式计算还是Excel内嵌支持的VBA自定义编程都使得Excel成为了数据配置的一大利器，用好Excel也是数值策划必备的技能之一。本章节通过深入学习Excel的使用，为未来自己的独立游戏的数据配置数值搭建打好基础。</p>
<h2 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h2><ol>
<li><strong>单表之间数值计算公式编写</strong></li>
<li><strong>跨表数据关联公式计算编写</strong></li>
<li><strong>自定义程序功能VBA编写(e.g. 导表)</strong></li>
</ol>
<h2 id="Excel介绍"><a href="#Excel介绍" class="headerlink" title="Excel介绍"></a>Excel介绍</h2><p><a target="_blank" rel="noopener" href="https://www.w3schools.com/EXCEL/index.php">Excel is the world’s most used spreadsheet program</a></p>
<p><a target="_blank" rel="noopener" href="https://www.w3schools.com/EXCEL/index.php">Excel is a powerful tool to use for mathematical functions</a></p>
<p><a target="_blank" rel="noopener" href="https://www.w3schools.com/EXCEL/excel_introduction.php">Excel is pronounced “Eks - sel” It is a spreadsheet program developed by Microsoft. Excel organizes data in columns and rows and allows you to do mathematical functions. It runs on Windows, macOS, Android and iOS.</a></p>
<p>从上面教程的Excel简单介绍可以看出Excel的强大和运用广泛，<strong>本人用Excel主要用于游戏开发，核心目的是实现数值系统(即数据管理)</strong>。接下来我会跟着教程一步一步深入学习Excel，从基础的Excel使用到Excel公式，甚至自定义VBA编写程序来实现我们在游戏开发过程中的种种需求。</p>
<h2 id="Excel基础学习"><a href="#Excel基础学习" class="headerlink" title="Excel基础学习"></a>Excel基础学习</h2><h3 id="Excel自带功能"><a href="#Excel自带功能" class="headerlink" title="Excel自带功能"></a>Excel自带功能</h3><ul>
<li><p>一个简单的数学运算运用</p>
<p><img src="/img/Excel/BasicExcelFunction.PNG" alt="BasicExcelFunction"></p>
</li>
<li><p>Excel主要由标题栏和Sheet组成</p>
<p><img src="/img/Excel/ExcelComponents.PNG" alt="ExcelComponents"></p>
<p><strong>标题栏为Excel工具栏，可以实现各种Excel操作。而Sheet为Excel数据部分主要有多行多列组成，我们平时编写的行列数据都在Sheet里，一个Excel可以包含多个Sheet。</strong></p>
</li>
<li><p>Excel公式运算</p>
<p>Excel公式用于数学运算，通常由&#x3D;符号开始。</p>
<p>用一个比较现实的问题举例，我们通常用Excel记账时，通过填入物品名称，单价和数量，我们会需要算出总价，这个时候我们可以利用公式实现总价根据前面数据进行自动计算的功能。</p>
<p><img src="/img/Excel/PriceCaculation.PNG" alt="PriceCaculation"></p>
<p>可以看到在总价那一列编写公式:&#x3D;B2*C2我们成功利用商品单价和数量自动计算出了商品总价。</p>
<p>接下来我们利用Excel自带提供的函数计算所有价格，数量以及总价的总数。</p>
<p><img src="/img/Excel/SUMFormular.png" alt="SUMFormular"></p>
</li>
<li><p>Excel引用</p>
<p><strong>Excel的引用分为两种(Relative Reference和Absolute Reference)</strong></p>
<ul>
<li>Relative Reference(相对引用 e.g. A1)<br><a target="_blank" rel="noopener" href="https://www.w3schools.com/excel/excel_rel_ref.php">The relative reference makes the cells reference free. It gives the fill function freedom to continue the order without restrictions.</a><br>从上面的介绍来看，相对引用在拖拽填充时更加自由，会保持原有公式的相对计算规则。<br>好比前面我们通过SUM函数实现了总价总数的计算，然后我通过拖拽填充的方式自动实现了价格总数和数量总数的计算。<br><img src="/img/Excel/RelativeReferenceUsing.png" alt="RelativeReferenceUsing"></li>
<li>Absolute Reference(绝对引用 e.g. $A$1)<br><a target="_blank" rel="noopener" href="https://www.w3schools.com/excel/excel_abs_ref.php">Absolute reference is when a reference has the dollar sign ($). It locks a reference in the formula.</a><br>从上面的介绍来看，绝对引用是通过加$符号标识的，加了$符号的绝对引用不会再拖拽填充的过程中变化，会一直保持原有定义。<br>接下来让我们把价格固定，然后利用绝对引用的方式，实现每个人不同购买数量的总价自动计算。<br><img src="/img/Excel/AbsoluteReferenceUsing.png" alt="AbsoluteReferenceUsing"><br><img src="/img/Excel/AbsoluteReference2Using.png" alt="AbsoluteReference2Using"><br>从上面可以看到，<strong>虽然我们通过拖拽填充的方式填充了C3到C5，但我们单价引用的$B$7是保持不变的，核心原因就是我们用的绝对引用。</strong></li>
</ul>
</li>
<li><p>Excel自带函数<br>Excel的强大不单单是简单的加减乘除运算，更多的是Excel支持类似编程方式的函数库+VBA语言编写，从而使得Excel能实现很多强大的自定义功能。<br>接下来让我们学习几个Excel里常见的自带函数：</p>
<ul>
<li><strong>AND</strong>(<a target="_blank" rel="noopener" href="https://www.w3schools.com/excel/excel_and.php">The AND function is a premade function in Excel, which returns TRUE or FALSE based on two or more conditions.</a>)(可以看出AND类似编程语言Lua里的And运算符，但Excel里的AND运算符区别是用于返回true和false)</li>
<li><strong>IF</strong>(<a target="_blank" rel="noopener" href="https://www.w3schools.com/excel/excel_if.php">The IF function is a premade function in Excel, which returns values based on a true or false condition.</a>)(可以看到IF类似编程语言里的IF，通过我们给出的条件的判定结果返回我们指定的两种情况的值)<br>接下来让我们结合前面的例子，通过Excel自带函数IF和AND实现自动判定总价超过10和(总价超过10+数量超过5)的数据统计。<br><img src="/img/Excel/IFFunctionUsing.png" alt="IFFunctionUsing"><br><img src="/img/Excel/IFFunctionUsing2.png" alt="IFFunctionUsing2"><br>从上面可以看到IF通过编写逻辑判定成功返回了我们自定义的YES和NO,而AND通过编写两个条件成功返回了TRUE和FALSE。</li>
<li><strong>SUMIF</strong>(<a target="_blank" rel="noopener" href="https://www.w3schools.com/excel/excel_sumif.php">The SUMIF function is a premade function in Excel, which calculates the sum of values in a range based on a true or false condition.</a>)(可以看出SUMMIF是一个带范围带条件匹配的总和运算)</li>
<li><strong>COUNTIF</strong>(<a target="_blank" rel="noopener" href="https://www.w3schools.com/excel/excel_countif.php">The COUNTIF function is a premade function in Excel, which counts cells as specified.</a>)(可以看出COUNTIF是一个带条件的统计符合条件数量的函数)<br>需求：<ul>
<li>纵向代表每个人，横向表示每天，✔️表示吃了，✘表示没吃，每天吃了要出3元，不吃要出1.5元，最后统计每个月每人餐饮伙食费<br><img src="/img/Excel/SUMIFUsing.png" alt="SUMIFUsing"><br>可以看到通过SUMIF我们成功统计出了指定单元格到指定单元格里包含✔️和✘的数量，然后乘以对应的单价再相加即得到我们要的统计总和。<br>更多的自带函数学习参考:<a target="_blank" rel="noopener" href="https://www.w3schools.com/excel/excel_functions.php">Excel Function</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="Excel-VBA"><a href="#Excel-VBA" class="headerlink" title="Excel VBA"></a>Excel VBA</h3><p>常规的功能需求，Excel自带的函数和功能就能满足，但涉及到复杂的逻辑运算规则时，Excel自带的函数和功能就力不从心了，这时就需要VBA这样的编程语言的东西出马了。</p>
<p>那么什么是VBA了？<br><a target="_blank" rel="noopener" href="http://www.tutorialspoint.com/vba/">VBA stands for Visual Basic for Applications, an event-driven programming language from Microsoft.</a><br>我个人的理解，VBA就是内嵌到Excel的VB，支持了Excel常规需求的一些API接口，我们可以利用这些API实现自定义功能。</p>
<p>待学习……</p>
<h2 id="重点知识"><a href="#重点知识" class="headerlink" title="重点知识"></a>重点知识</h2><h2 id="学习连接"><a href="#学习连接" class="headerlink" title="学习连接"></a>学习连接</h2><p><a target="_blank" rel="noopener" href="https://www.w3schools.com/EXCEL/index.php">Excel Tutorial</a></p>
<p><a target="_blank" rel="noopener" href="https://www.tutorialspoint.com/vba/index.htm">VBA Tutorial</a></p>
<h2 id="Github"><a href="#Github" class="headerlink" title="Github"></a>Github</h2><p><a target="_blank" rel="noopener" href="https://github.com/TonyTang1990/ExcelStudy">ExcelStudy</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Database/">Database</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Other/">Other</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>







  <nav id="page-nav" class="clearfix">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/2/">Next&lt;span&gt;&lt;&#x2F;span&gt;</a>
  </nav>

</div>
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  


  
<div class="categorieslist">
	<p class="asidetitle">分类</p>
		<ul>
		
		  
			<li><a href="/categories/AI/" title="AI">AI<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/Algorithm/" title="Algorithm">Algorithm<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/Art/" title="Art">Art<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Automation/" title="Automation">Automation<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Collision/" title="Collision">Collision<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Database/" title="Database">Database<sup>3</sup></a></li>
		  
		
		  
			<li><a href="/categories/Editor/" title="Editor">Editor<sup>5</sup></a></li>
		  
		
		  
			<li><a href="/categories/Excel/" title="Excel">Excel<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Game/" title="Game">Game<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/HotUpdate/" title="HotUpdate">HotUpdate<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Lua/" title="Lua">Lua<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Math/" title="Math">Math<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/Native/" title="Native">Native<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/Network/" title="Network">Network<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Optimization/" title="Optimization">Optimization<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Other/" title="Other">Other<sup>5</sup></a></li>
		  
		
		  
			<li><a href="/categories/Plugin/" title="Plugin">Plugin<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/Programming/" title="Programming">Programming<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Programming-Language/" title="Programming Language">Programming Language<sup>4</sup></a></li>
		  
		
		  
			<li><a href="/categories/Rendering/" title="Rendering">Rendering<sup>4</sup></a></li>
		  
		
		  
			<li><a href="/categories/Resource/" title="Resource">Resource<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/Unity/" title="Unity">Unity<sup>7</sup></a></li>
		  
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">标签</p>
		<ul class="clearfix">
		
			
				<li><a href="/tags/Unity/" title="Unity">Unity<sup>8</sup></a></li>
			
		
			
				<li><a href="/tags/Editor/" title="Editor">Editor<sup>5</sup></a></li>
			
		
			
				<li><a href="/tags/Other/" title="Other">Other<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/AI/" title="AI">AI<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/Resource/" title="Resource">Resource<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/OpenGL/" title="OpenGL">OpenGL<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/Math/" title="Math">Math<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/Art/" title="Art">Art<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Android/" title="Android">Android<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/UI/" title="UI">UI<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/C/" title="C#">C#<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Python/" title="Python">Python<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Database/" title="Database">Database<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Shader/" title="Shader">Shader<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/SubmlineText3/" title="SubmlineText3">SubmlineText3<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Rendering/" title="Rendering">Rendering<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Native/" title="Native">Native<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Prefab/" title="Prefab">Prefab<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Plugin/" title="Plugin">Plugin<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Optimization/" title="Optimization">Optimization<sup>1</sup></a></li>
			
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">友情链接</p>
    <ul>
        
          <li>
            
            	<a href="https://coderq.com" target="_blank" title="一个面向程序员交流分享的新一代社区">码农圈</a>
            
          </li>
        
          <li>
            
            	<a href="http://wuchong.me" target="_blank" title="Jark&#39;s Blog">Jark&#39;s Blog</a>
            
          </li>
        
    </ul>
</div>

  


  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS 订阅</a>
</div>

  <div class="weiboshow">
  <p class="asidetitle">新浪微博</p>
    <iframe width="100%" height="119" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=119&fansRow=2&ptype=1&speed=0&skin=9&isTitle=1&noborder=1&isWeibo=0&isFans=0&uid=&verifier=b3593ceb&dpc=1"></iframe>
</div>


</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> Hello ,I&#39;m Larry Page in Google. <br/>
			This is my blog,believe it or not.</p>
	</section>
	 
	<div class="social-font" class="clearfix">
		
		<a href="http://weibo.com/2176287895" target="_blank" class="icon-weibo" title="微博"></a>
		
		
		
		
		
		
		
		
		
		
	</div>
			
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Jacman">Jacman</a> © 2025 
		
		<a href="/about" target="_blank" title="Tony Tang">Tony Tang</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery.qrcode-0.12.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
        
    }
  });
});
</script>












<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->



<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?e6d1f421bbc9962127a50488f9ed37d1";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>



<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="返回顶部"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
 </html>
