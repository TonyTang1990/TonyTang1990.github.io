
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  
    <title>走停人生路</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="Tony Tang">
    

    
    <meta property="og:type" content="website">
<meta property="og:title" content="走停人生路">
<meta property="og:url" content="http://tonytang1990.github.io/index.html">
<meta property="og:site_name" content="走停人生路">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Tony Tang">
<meta name="twitter:card" content="summary">

    
    <link rel="alternative" href="/atom.xml" title="走停人生路" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/jacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/jacman.jpg">
    
    
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 7.3.0"></head>

  <body>
    <header>
      
<div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.png" alt="走停人生路" title="走停人生路"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="走停人生路">走停人生路</a></h1>
				<h2 class="blog-motto">做着独立游戏梦，坚持走在游戏开发道路上的人</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">Home</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
						<li><a href="/about">About</a></li>
					
					<li>
 					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="search" id="search" name="q" autocomplete="off" maxlength="20" placeholder="搜索" />
						<input type="hidden" name="q" value="site:tonytang1990.github.io">
					</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main">

   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2026/01/29/UGUI遮罩原理/" title="UGUI遮罩原理" itemprop="url">UGUI遮罩原理</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Tony Tang" target="_blank" itemprop="author">Tony Tang</a>
		
  <p class="article-time">
    <time datetime="2026-01-29T15:00:00.000Z" itemprop="datePublished"> 发表于 2026-01-29</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>Unity游戏开发过程中，2D UI上常常会通过添加Mask或者RectMask2D组件进行UI遮罩显示。本章是为了<strong>深入学习理解Mask和RectMask2D原理相关知识，思考3D粒子，模型和UI混合显示方案</strong>。</p>
<h1 id="Mask"><a href="#Mask" class="headerlink" title="Mask"></a>Mask</h1><p>Mask是指通过遮罩控制可见显示区域的一种遮罩显示。</p>
<p>UGUI里常见的遮罩有两种：</p>
<ol>
<li><strong>Mask</strong></li>
<li><strong>Rect2DMask</strong></li>
</ol>
<p>虽然都是实现Mask效果，但两个组件的底层遮罩实现原理却大不相同，接下来让我们深入Mask和Rect2DMask底层实现，深入理解Mask底层的相关知识，会后续3D和2D混合显示遮罩打下基础。</p>
<h2 id="Mask组件"><a href="#Mask组件" class="headerlink" title="Mask组件"></a>Mask组件</h2><p>在深入了解Mask组件之前，我们需要了解一下什么是Stencil Buffer(模板缓存)，<strong>Stencil Buffer是实现遮罩的底层渲染原理。</strong></p>
<h3 id="Stencil-Buffer"><a href="#Stencil-Buffer" class="headerlink" title="Stencil Buffer"></a>Stencil Buffer</h3><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/SL-Stencil.html">The stencil buffer stores an 8-bit integer value for each <strong>pixel</strong> in the frame buffer. Before executing the fragment <strong>shader</strong> for a given pixel, the GPU can compare the current value in the stencil buffer against a given reference value. This is called a stencil test. If the stencil test passes, the GPU performs the depth test. If the stencil test fails, the GPU skips the rest of the processing for that pixel. This means that you can use the stencil buffer as a mask to tell the GPU which pixels to draw, and which pixels to discard.</a></p>
<p>从上面的介绍可以看出，<strong>Stencil Buffer(模板缓存)不同于深度Buffer和颜色Buffer，不是用来存储深度或颜色信息的，而是一个每个像素分配8bit(0-255)用来存储Stencil比较值的地方。如果一个pixel通不过Stencil Test(类似Depth Test，但是是用来比较Stencil Buffer值的方式)，那么这个pixel将不会再走后续渲染流程(Depth Test)。</strong></p>
<p>Unity Stencil有很多参数，这里调几个重要的参数介绍：</p>
<ul>
<li><p><strong>comparisonOperation(Stencil值比较方式)</strong></p>
<p><img src="/img/Unity/RenderOrder/StencilTestCompareValue.PNG" alt="StencilTestCompareValue"></p>
<p><strong>Stencil Test比较公式:</strong></p>
<p>​        <strong>(ref &amp; readMask) comparisonFunction (stencilBufferValue &amp; readMask)</strong></p>
</li>
<li><p><strong>passOperation(Stencil值通过替换方式)</strong></p>
<p><img src="/img/Unity/RenderOrder/StencilTestReplaceValue.PNG" alt="StencilTestReplaceValue"></p>
</li>
<li><p><strong>ref(引用参考值)</strong></p>
<p><strong>用于Stencil值比较或Stencil Pass后值替换等</strong></p>
</li>
<li><p><strong>ReadMask(Stencil比较掩码)</strong></p>
<p><strong>用于Stencil Test时值比较过滤，从上面的Stencil Test公式可以看到Ref和Stencil Buffer Value值都与ReadMask与之后在进行比较的</strong></p>
</li>
<li><p><strong>WriteMask(Stencil写掩码)</strong></p>
<p><strong>用于Stencil Test通过后passOperation值写入过滤，即与passOperation后的值进行比较过滤再写入Stencil Buffer</strong></p>
</li>
</ul>
<p>更多参数参考官网：</p>
<p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/SL-Stencil.html">ShaderLab command: Stencil</a></p>
<p>Note:</p>
<ol>
<li><strong>Stencil Test发生Depth Test之前，Aplha Test和fragment shader之后。顺序是：Alpha Test -&gt; fragment shader -&gt; Stencil Test -&gt; depth test</strong></li>
<li><strong>模板缓冲可以用来制作物体的遮罩、轮廓描边、阴影、遮挡显示等等效果</strong></li>
</ol>
<h3 id="Mask-UI组件"><a href="#Mask-UI组件" class="headerlink" title="Mask+UI组件"></a>Mask+UI组件</h3><p>先让我们尝试一下Mask组件的使用：</p>
<p>使用Mask组件前：</p>
<p><img src="/img/Unity/RenderOrder/BeforeMaskComponentUsing.PNG" alt="BeforeMaskComponentUsing"></p>
<p>使用Mask组件后：</p>
<p><img src="/img/Unity/RenderOrder/MaskComponentUsing.PNG" alt="MaskComponentUsing"></p>
<p><img src="/img/Unity/RenderOrder/AfterMaskComponentUsing.PNG" alt="AfterMaskComponentUsing"></p>
<p>可以看到通过使用一个圆形遮罩我们成功的将√实现了圆形的遮罩显示，当同时右上角Status数据也可以看到，激活Mask给我们增加了1个Batches和2个SetPass calls，至于原因后续会讲到。</p>
<p>那么第一个疑问，我们想知道的是Mask组件式如何实现遮罩的了？</p>
<p>首先我打开FrameDebug看了下Image是实际绘制流程：</p>
<p><img src="/img/Unity/RenderOrder/MaskFrameDebugDrawPreview.PNG" alt="MaskFrameDebugDrawPreview"></p>
<p>可以看到1个Mask和1张图绘制总共分为3步，绘制了3次Mesh。</p>
<p>打开Mask.cs源码，我们会看到两个跟材质挂钩的代码:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> Stencil calculation time!    </span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Mask</span> : <span class="title">UIBehaviour</span>, <span class="title">ICanvasRaycastFilter</span>, <span class="title">IMaterialModifier</span></span><br><span class="line">   &#123;</span><br><span class="line">       ******</span><br><span class="line"></span><br><span class="line">       [<span class="meta">NonSerialized</span>]</span><br><span class="line">	<span class="keyword">private</span> Material m_MaskMaterial;</span><br><span class="line"></span><br><span class="line">	[<span class="meta">NonSerialized</span>]</span><br><span class="line">	<span class="keyword">private</span> Material m_UnmaskMaterial;</span><br><span class="line">    	</span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> Material <span class="title">GetModifiedMaterial</span>(<span class="params">Material baseMaterial</span>)</span></span><br><span class="line">       &#123;</span><br><span class="line">           <span class="keyword">if</span> (!MaskEnabled())</span><br><span class="line">               <span class="keyword">return</span> baseMaterial;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">var</span> rootSortCanvas = MaskUtilities.FindRootSortOverrideCanvas(transform);</span><br><span class="line">           <span class="keyword">var</span> stencilDepth = MaskUtilities.GetStencilDepth(transform, rootSortCanvas);</span><br><span class="line">           <span class="keyword">if</span> (stencilDepth &gt;= <span class="number">8</span>)</span><br><span class="line">           &#123;</span><br><span class="line">               Debug.LogWarning(<span class="string">&quot;Attempting to use a stencil mask with depth &gt; 8&quot;</span>, gameObject);</span><br><span class="line">               <span class="keyword">return</span> baseMaterial;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="built_in">int</span> desiredStencilBit = <span class="number">1</span> &lt;&lt; stencilDepth;</span><br><span class="line"></span><br><span class="line">           <span class="comment">// if we are at the first level...</span></span><br><span class="line">           <span class="comment">// we want to destroy what is there</span></span><br><span class="line">           <span class="keyword">if</span> (desiredStencilBit == <span class="number">1</span>)</span><br><span class="line">           &#123;</span><br><span class="line">               <span class="keyword">var</span> maskMaterial = StencilMaterial.Add(baseMaterial, <span class="number">1</span>, StencilOp.Replace, CompareFunction.Always, m_ShowMaskGraphic ? ColorWriteMask.All : <span class="number">0</span>);</span><br><span class="line">               StencilMaterial.Remove(m_MaskMaterial);</span><br><span class="line">               m_MaskMaterial = maskMaterial;</span><br><span class="line"></span><br><span class="line">               <span class="keyword">var</span> unmaskMaterial = StencilMaterial.Add(baseMaterial, <span class="number">1</span>, StencilOp.Zero, CompareFunction.Always, <span class="number">0</span>);</span><br><span class="line">               StencilMaterial.Remove(m_UnmaskMaterial);</span><br><span class="line">               m_UnmaskMaterial = unmaskMaterial;</span><br><span class="line">               graphic.canvasRenderer.popMaterialCount = <span class="number">1</span>;</span><br><span class="line">               graphic.canvasRenderer.SetPopMaterial(m_UnmaskMaterial, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">               <span class="keyword">return</span> m_MaskMaterial;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="comment">//otherwise we need to be a bit smarter and set some read / write masks</span></span><br><span class="line">           <span class="keyword">var</span> maskMaterial2 = StencilMaterial.Add(baseMaterial, desiredStencilBit | (desiredStencilBit - <span class="number">1</span>), StencilOp.Replace, CompareFunction.Equal, m_ShowMaskGraphic ? ColorWriteMask.All : <span class="number">0</span>, desiredStencilBit - <span class="number">1</span>, desiredStencilBit | (desiredStencilBit - <span class="number">1</span>));</span><br><span class="line">           StencilMaterial.Remove(m_MaskMaterial);</span><br><span class="line">           m_MaskMaterial = maskMaterial2;</span><br><span class="line"></span><br><span class="line">           graphic.canvasRenderer.hasPopInstruction = <span class="literal">true</span>;</span><br><span class="line">           <span class="keyword">var</span> unmaskMaterial2 = StencilMaterial.Add(baseMaterial, desiredStencilBit - <span class="number">1</span>, StencilOp.Replace, CompareFunction.Equal, <span class="number">0</span>, desiredStencilBit - <span class="number">1</span>, desiredStencilBit | (desiredStencilBit - <span class="number">1</span>));</span><br><span class="line">           StencilMaterial.Remove(m_UnmaskMaterial);</span><br><span class="line">           m_UnmaskMaterial = unmaskMaterial2;</span><br><span class="line">           graphic.canvasRenderer.popMaterialCount = <span class="number">1</span>;</span><br><span class="line">           graphic.canvasRenderer.SetPopMaterial(m_UnmaskMaterial, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">           <span class="keyword">return</span> m_MaskMaterial;</span><br><span class="line">       &#125;</span><br><span class="line">       ******</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>从源码可以看到，Mask组件实现了IMaterialModifier接口。</p>
<p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/2018.1/Documentation/ScriptReference/UI.IMaterialModifier.html">IMaterialModifier is Interface which allows for the modification of the Material used to render a Graphic before they are passed to the CanvasRenderer.</a></p>
<p>UGUI我们是通过Canvas统一进行绘制渲染的，从上面的介绍可以看出要实现IMaterialModifier允许我们在传递给CanvasRenderer绘制渲染UI(Graphic)之前进行材质处理，而IMaterialModifier.GetModifiedMaterial()正是这么个接口。</p>
<p>打开StencilMaterial.cs查看源码StencilMaterials.Add()接口:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Add a new material using the specified base and stencil ID.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Material <span class="title">Add</span>(<span class="params">Material baseMat, <span class="built_in">int</span> stencilID, StencilOp operation, CompareFunction compareFunction, ColorWriteMask colorWriteMask, <span class="built_in">int</span> readMask, <span class="built_in">int</span> writeMask</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> ((stencilID &lt;= <span class="number">0</span> &amp;&amp; colorWriteMask == ColorWriteMask.All) || baseMat == <span class="literal">null</span>)</span><br><span class="line">        <span class="keyword">return</span> baseMat;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!baseMat.HasProperty(<span class="string">&quot;_Stencil&quot;</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        Debug.LogWarning(<span class="string">&quot;Material &quot;</span> + baseMat.name + <span class="string">&quot; doesn&#x27;t have _Stencil property&quot;</span>, baseMat);</span><br><span class="line">        <span class="keyword">return</span> baseMat;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!baseMat.HasProperty(<span class="string">&quot;_StencilOp&quot;</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        Debug.LogWarning(<span class="string">&quot;Material &quot;</span> + baseMat.name + <span class="string">&quot; doesn&#x27;t have _StencilOp property&quot;</span>, baseMat);</span><br><span class="line">        <span class="keyword">return</span> baseMat;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!baseMat.HasProperty(<span class="string">&quot;_StencilComp&quot;</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        Debug.LogWarning(<span class="string">&quot;Material &quot;</span> + baseMat.name + <span class="string">&quot; doesn&#x27;t have _StencilComp property&quot;</span>, baseMat);</span><br><span class="line">        <span class="keyword">return</span> baseMat;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!baseMat.HasProperty(<span class="string">&quot;_StencilReadMask&quot;</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        Debug.LogWarning(<span class="string">&quot;Material &quot;</span> + baseMat.name + <span class="string">&quot; doesn&#x27;t have _StencilReadMask property&quot;</span>, baseMat);</span><br><span class="line">        <span class="keyword">return</span> baseMat;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!baseMat.HasProperty(<span class="string">&quot;_StencilWriteMask&quot;</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        Debug.LogWarning(<span class="string">&quot;Material &quot;</span> + baseMat.name + <span class="string">&quot; doesn&#x27;t have _StencilWriteMask property&quot;</span>, baseMat);</span><br><span class="line">        <span class="keyword">return</span> baseMat;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!baseMat.HasProperty(<span class="string">&quot;_ColorMask&quot;</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        Debug.LogWarning(<span class="string">&quot;Material &quot;</span> + baseMat.name + <span class="string">&quot; doesn&#x27;t have _ColorMask property&quot;</span>, baseMat);</span><br><span class="line">        <span class="keyword">return</span> baseMat;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; m_List.Count; ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        MatEntry ent = m_List[i];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ent.baseMat == baseMat</span><br><span class="line">            &amp;&amp; ent.stencilId == stencilID</span><br><span class="line">            &amp;&amp; ent.operation == operation</span><br><span class="line">            &amp;&amp; ent.compareFunction == compareFunction</span><br><span class="line">            &amp;&amp; ent.readMask == readMask</span><br><span class="line">            &amp;&amp; ent.writeMask == writeMask</span><br><span class="line">            &amp;&amp; ent.colorMask == colorWriteMask)</span><br><span class="line">        &#123;</span><br><span class="line">            ++ent.count;</span><br><span class="line">            <span class="keyword">return</span> ent.customMat;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> newEnt = <span class="keyword">new</span> MatEntry();</span><br><span class="line">    newEnt.count = <span class="number">1</span>;</span><br><span class="line">    newEnt.baseMat = baseMat;</span><br><span class="line">    newEnt.customMat = <span class="keyword">new</span> Material(baseMat);</span><br><span class="line">    newEnt.customMat.hideFlags = HideFlags.HideAndDontSave;</span><br><span class="line">    newEnt.stencilId = stencilID;</span><br><span class="line">    newEnt.operation = operation;</span><br><span class="line">    newEnt.compareFunction = compareFunction;</span><br><span class="line">    newEnt.readMask = readMask;</span><br><span class="line">    newEnt.writeMask = writeMask;</span><br><span class="line">    newEnt.colorMask = colorWriteMask;</span><br><span class="line">    newEnt.useAlphaClip = operation != StencilOp.Keep &amp;&amp; writeMask &gt; <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    newEnt.customMat.name = <span class="built_in">string</span>.Format(<span class="string">&quot;Stencil Id:&#123;0&#125;, Op:&#123;1&#125;, Comp:&#123;2&#125;, WriteMask:&#123;3&#125;, ReadMask:&#123;4&#125;, ColorMask:&#123;5&#125; AlphaClip:&#123;6&#125; (&#123;7&#125;)&quot;</span>, stencilID, operation, compareFunction, writeMask, readMask, colorWriteMask, newEnt.useAlphaClip, baseMat.name);</span><br><span class="line"></span><br><span class="line">    newEnt.customMat.SetInt(<span class="string">&quot;_Stencil&quot;</span>, stencilID);</span><br><span class="line">    newEnt.customMat.SetInt(<span class="string">&quot;_StencilOp&quot;</span>, (<span class="built_in">int</span>)operation);</span><br><span class="line">    newEnt.customMat.SetInt(<span class="string">&quot;_StencilComp&quot;</span>, (<span class="built_in">int</span>)compareFunction);</span><br><span class="line">    newEnt.customMat.SetInt(<span class="string">&quot;_StencilReadMask&quot;</span>, readMask);</span><br><span class="line">    newEnt.customMat.SetInt(<span class="string">&quot;_StencilWriteMask&quot;</span>, writeMask);</span><br><span class="line">    newEnt.customMat.SetInt(<span class="string">&quot;_ColorMask&quot;</span>, (<span class="built_in">int</span>)colorWriteMask);</span><br><span class="line">    newEnt.customMat.SetInt(<span class="string">&quot;_UseUIAlphaClip&quot;</span>, newEnt.useAlphaClip ? <span class="number">1</span> : <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (newEnt.useAlphaClip)</span><br><span class="line">        newEnt.customMat.EnableKeyword(<span class="string">&quot;UNITY_UI_ALPHACLIP&quot;</span>);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        newEnt.customMat.DisableKeyword(<span class="string">&quot;UNITY_UI_ALPHACLIP&quot;</span>);</span><br><span class="line"></span><br><span class="line">    m_List.Add(newEnt);</span><br><span class="line">    <span class="keyword">return</span> newEnt.customMat;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到<strong>Mask在IMaterialModifies.GetModifiedMaterial()接口里是对UI的原始材质进行复制后，对Stencil(模板缓存)进行修改实现的遮罩效果。</strong></p>
<p>结合首层Mask逻辑，我们来理一下遮罩原理：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// if we are at the first level...</span></span><br><span class="line"><span class="comment">// we want to destroy what is there</span></span><br><span class="line"><span class="keyword">if</span> (desiredStencilBit == <span class="number">1</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> maskMaterial = StencilMaterial.Add(baseMaterial, <span class="number">1</span>, StencilOp.Replace, CompareFunction.Always, m_ShowMaskGraphic ? ColorWriteMask.All : <span class="number">0</span>);</span><br><span class="line">    StencilMaterial.Remove(m_MaskMaterial);</span><br><span class="line">    m_MaskMaterial = maskMaterial;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> unmaskMaterial = StencilMaterial.Add(baseMaterial, <span class="number">1</span>, StencilOp.Zero, CompareFunction.Always, <span class="number">0</span>);</span><br><span class="line">    StencilMaterial.Remove(m_UnmaskMaterial);</span><br><span class="line">    m_UnmaskMaterial = unmaskMaterial;</span><br><span class="line">    graphic.canvasRenderer.popMaterialCount = <span class="number">1</span>;</span><br><span class="line">    graphic.canvasRenderer.SetPopMaterial(m_UnmaskMaterial, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> m_MaskMaterial;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果是第一层，stencilDepth值为0，目标模版缓存值(desiredStencilBit)为1。</p>
<ol>
<li><p>Unity Mask先添加了基于baseMaterial(原始配置的材质球)新裁剪材质球maskMaterial，将新材质球的<strong>Stencile(模版参考比较值)值改为1</strong>，将<strong>StencilOp的模板操作设置成Replace(模版缓存比较通过则替换成新的模板参考比较值)</strong>，<strong>CompareFunction(模版比较方式)设置成Always(模板测试总是通过)</strong>，根据是否显示Mask图形将<strong>ColorWriteMask(颜色写入FrameBuffer的Mask值)设置成255(所有颜色值都写入)或0(所有颜色值都不写入)</strong>，至于<strong>Stencile的ReadMask和WriteMask(第一层默认传255)</strong></p>
</li>
<li><p>通过第1步的新增裁剪材质球maskMaterial处理，当我们渲染Mask图形的时候，ColorWriteMask会决定将Mask图形颜色写入，反之不写入(这一步决定了mask图形是否显示)。</p>
</li>
<li><p>通过第1步的新材裁剪质球maskMaterial处理，因为模板比较是Always(总是通过)，结合模版参考值1和模板操作方式Replace，此时<strong>渲染完Mask图形后Stencil Ref值应该为1</strong></p>
<p><img src="/img/Unity/RenderOrder/AfterMaskGraphRenderStatus.PNG" alt="AfterMaskGraphRenderStatus"></p>
</li>
<li><p>接着创建<strong>unmaskMaterial材质球，并将其设置成遮罩Graphic.canvasRendererd的SetPopMaterial(个人理解是后续用于渲染完所有子对象后的额外材质球处理)用于取消Mask的相关设置，这一步发生在Mask图形所有子对象渲染完成时(从结果额外绘制了一个Mesh触发了unmaskMaterial逻辑来猜测的)</strong>，后续详细介绍</p>
</li>
<li><p>接下来渲染遮罩图形的子对象tickImg</p>
<p><img src="/img/Unity/RenderOrder/MaskChildGraphicStencilSetting.PNG" alt="MaskChildGraphicStencilSetting"></p>
<p><img src="/img/Unity/RenderOrder/RenderMaskChildGraphicStatus.PNG" alt="RenderMaskChildGraphicStatus"></p>
<p>可以看到遮罩图形的子对象tickImg的模板相关设置是<strong>Stencil Ref(模版参考比较值)为1</strong>，<strong>StencilOp的模板操作是Keep(保持原模板缓存值)，StencilComp的模板比较操作是Equal(模版值和模板参考值相同才通过模板测试)</strong>，<strong>Stencil Write Mask(模版缓存值写入时的Mask值)值为0(不允许写入模板缓存值)</strong>，<strong>Stencil Read Mask(模版缓存读取时的Mask值)值为1(只允许读取第一位的模板值)</strong>，<strong>ColorMask(颜色写入Mask值，8bit标识，15为所有颜色值写入)值为15</strong>。</p>
<p><strong>我这里使用的是Unity自带的UI&#x2F;Default Shader，这些模板值设置是发生在我给UI挂载对象时或者增删Mask组件时</strong>。</p>
<p><strong>因此子对象渲染时发现模版缓存值为1，且自身设置模板参考比较值也为1，同时模板比较方法是Equal，从而实现只有在Mask图形区域类模板缓存值为1的部分满足显示，从而只有Mask图形区域内的子对象显示部分通过了模板缓存测试，同时通过后因为StencilOp的模板操作是Keep所以模板缓存值不变依然是1</strong></p>
</li>
<li><p>子对象渲染完成后，我们接着看第4步里unmaskMaterial的后续逻辑，<strong>unmaskMaterial的Stencil Ref(模版参考比较值)为1，StencilOp的模板操作是Zero(设置模板值到0)，StencilComp的模板比较操作是Always(总是通过模板缓存测试)，ColorMask为0(不写入任何颜色)</strong></p>
<p><img src="/img/Unity/RenderOrder/UnmaskMaterialStatus.PNG" alt="UnmaskMaterialStatus"></p>
<p>因为maskMaterial和子对象渲染完成后，模版缓存里的值为1，此时<strong>unmaskMaterial的StencilComp是Always，StencilOp的模板操作是Zero</strong>，所以会<strong>将模板缓存里的值更新到0</strong>，同时因为ColorMask为0所以这一次unmaskMaterial的额外Mesh渲染绘制不会显示任何东西。</p>
</li>
</ol>
<p>Note:</p>
<ol>
<li><strong>Mask实现遮罩效果底层原理是通过Stencil(模板缓存)</strong></li>
</ol>
<h3 id="Mask-粒子特效"><a href="#Mask-粒子特效" class="headerlink" title="Mask+粒子特效"></a>Mask+粒子特效</h3><h4 id="Mask-自带ParticleAdditive-Shader"><a href="#Mask-自带ParticleAdditive-Shader" class="headerlink" title="Mask+自带ParticleAdditive Shader"></a>Mask+自带ParticleAdditive Shader</h4><p>在了解完Mask组件的常规UI遮罩原理后，接下来让我们尝试下UI上放入粒子特效</p>
<p><img src="/img/Unity/RenderOrder/ParticleAdditiveInspector.PNG" alt="ParticleAdditiveInspector"></p>
<p>可以看到我将<strong>Unity自带的Particle Additive的Shader</strong>导入工程并创建了一个材质球使用到了粒子系统身上，同时<strong>为了确保粒子特效显示层级在UI上，还专门设置了Sorting Layer ID为Default，Order in Layer为101(因为MainUI节点上挂了Canvas且设置的Sorting Layer为Default，Order in Layer为100)</strong>。</p>
<p>让我们看下Unity自带的Particle Additive的Shader代码:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">Shader <span class="string">&quot;Custom/Legacy Shaders/Particles/Additive&quot;</span> &#123;</span><br><span class="line">Properties &#123;</span><br><span class="line">    _TintColor (<span class="string">&quot;Tint Color&quot;</span>, Color) = (<span class="number">0.5</span>,<span class="number">0.5</span>,<span class="number">0.5</span>,<span class="number">0.5</span>)</span><br><span class="line">    _MainTex (<span class="string">&quot;Particle Texture&quot;</span>, <span class="number">2</span>D) = <span class="string">&quot;white&quot;</span> &#123;&#125;</span><br><span class="line">    _InvFade (<span class="string">&quot;Soft Particles Factor&quot;</span>, Range(<span class="number">0.01</span>,<span class="number">3.0</span>)) = <span class="number">1.0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Category &#123;</span><br><span class="line">    Tags &#123; <span class="string">&quot;Queue&quot;</span>=<span class="string">&quot;Transparent&quot;</span> <span class="string">&quot;IgnoreProjector&quot;</span>=<span class="string">&quot;True&quot;</span> <span class="string">&quot;RenderType&quot;</span>=<span class="string">&quot;Transparent&quot;</span> <span class="string">&quot;PreviewType&quot;</span>=<span class="string">&quot;Plane&quot;</span> &#125;</span><br><span class="line">    Blend SrcAlpha One</span><br><span class="line">    ColorMask RGB</span><br><span class="line">    Cull Off Lighting Off ZWrite Off</span><br><span class="line"></span><br><span class="line">    SubShader &#123;</span><br><span class="line">        Pass &#123;</span><br><span class="line">            ******</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到默认的Particle Additive的Shader是没有带模板缓存相关的Shader代码支持的。渲染结果如下：</p>
<p><img src="/img/Unity/RenderOrder/ParticleAdditiveShowResult.PNG" alt="ParticleAdditiveShowResult"></p>
<p>不出意外Particle Additive的Shader的粒子特效超出了Mask显示范围。</p>
<h4 id="Mask-修改ParticleAdditive-Mask-Shader"><a href="#Mask-修改ParticleAdditive-Mask-Shader" class="headerlink" title="Mask+修改ParticleAdditive Mask Shader"></a>Mask+修改ParticleAdditive Mask Shader</h4><p>接下来我们尝试改造Particle Additive的Shader，复制一份改名Particle Additive Mask同时创建一个对应的材质球(ParticleAdditiveMaskMat)，赋值到particleSystem上。</p>
<p><img src="/img/Unity/RenderOrder/ParticleAdditiveMaskInspector.PNG" alt="ParticleAdditiveMaskInspector"></p>
<p>为了匹配Mask的模版缓存判定，我将<strong>Stencil ID设置成1(模版缓存参考比较值)，Stencil Comparison设置成3(Equal)，Stencil Operation设置成0(Keep)，ColorMask设置成15(所有颜色写入)，这些设置是为了在Mask下去比较模板缓存值1的才通过，从而实现超出Mask区域部分不通过不绘制</strong>。</p>
<p>让我们看看改造后的显示结果：</p>
<p><img src="/img/Unity/RenderOrder/ParticleAdditiveMaskShowResult.PNG" alt="ParticleAdditiveMaskShowResult"></p>
<p>结果发现粒子特效啥都没显示，让我们看看FrameDebugger是怎么回事。</p>
<p><img src="/img/Unity/RenderOrder/ParticleAdditiveMaskFrameDebugger.PNG" alt="ParticleAdditiveMaskFrameDebugger"></p>
<p><strong>从FrameDebugger可以看到粒子特效的渲染和常规UI的渲染流程不一样，因为粒子特效是当做3D物体渲染的，所以他的渲染顺序不想UI子节点图形没有在Canvas的渲染流程里，而是Canvas渲染完成后才通过Draw Dynamic的方式绘制的。</strong></p>
<p>还记得我们前面说的<strong>Mask组件在绘制完成后通过unmaskMaterial将模板缓存里的值已经修改成0了吗？</strong></p>
<p><strong>这个模版缓存值0也就是粒子特效不显示的原因，因为粒子特效Particle Additive Mask我们设置的Stencil ID(模版参考比较值)为1，Stencil Comparion为3(Equal)，也就意味着粒子特效通不过模板缓存测试所以什么都不显示了。</strong></p>
<h4 id="仅使用自带UI-Default-Shader"><a href="#仅使用自带UI-Default-Shader" class="headerlink" title="仅使用自带UI Default Shader"></a>仅使用自带UI Default Shader</h4><p><strong>unmaskMaterial这个流程是Mask流程里自带的，不修改源码是无法修改的，所以目前看来想通过粒子特效支持模板缓存功能从而通过Mask遮罩显示的方案是行不通的。</strong></p>
<p><strong>既然我们已经知道模板缓存是Mask实现遮罩的核心原理，那么我们如果不使用Mask组件，直接导入自带的UI Default Shader，通过直接创建一个非Mask的UI Default材质，一个负责Mask的UI Default Mask材质和一个支持被UI Default Mask遮罩后显示的UI Default Masked材质来实现模版遮罩功。</strong></p>
<p><img src="/img/Unity/RenderOrder/UIDefaultMatInspector.PNG" alt="UIDefaultMatInspector"></p>
<p><img src="/img/Unity/RenderOrder/UIDefaultMaskMatInspector.PNG" alt="UIDefaultMaskMatInspector"></p>
<p><img src="/img/Unity/RenderOrder/UIDefaultMaskedMatInspector.PNG" alt="UIDefaultMaskedMatInspector"></p>
<p><strong>可以看到三份材质球都是使用功能的UI Default Shader，但为了Mask不同情况下正确显示，分别设置了不同的Stencil ID，Stencil Comparison，Stencil Operation值。UIDefaultMat用于不需要管遮罩时，UIDefaultMaskMat用在当做遮罩(相当于Mask挂载的情况)时，UIDefaultMaskedMat用在在遮罩里需要被遮罩时。</strong></p>
<p><strong>为了方便查看层级显示和遮罩效果，我创建了一个红色的使用UI Default Mat的最底层图和一个黄色的使用UI Default Mat的最顶层图(同时添加了Canvas设置了order高于特效显示order)</strong></p>
<p>来看看图片和特效相关的层级:</p>
<p><img src="/img/Unity/RenderOrder/UIDefaultMaskSceneAndHierachy.PNG" alt="UIDefaultMaskSceneAndHierachy"></p>
<p>来看看运行时的效果:</p>
<p><img src="/img/Unity/RenderOrder/UIDefaultMaskGame.PNG" alt="UIDefaultMaskGame"></p>
<p>可以看到无论是普通背景和前景图还是被遮罩的图还是粒子特效，通过赋予对应的UI Default Shader的材质球成功实现了Mask遮罩效果。</p>
<p>让我们来看看Frame Debugger是什么情况：</p>
<p><img src="/img/Unity/RenderOrder/UIDefaultMaskFrameDebugger.PNG" alt="UIDefaultMaskFrameDebugger"></p>
<p><strong>可以看到带遮罩的相关图形显示在第一个Canvas.RenderSubBatch里，因为使用Mask组件，所以没有产生unmaskMaterial的流程，所以第一个Canvas.RenderSubBatch最后一个Draw Mesh是被遮罩的那个勾选图形，因为设置的是UI Default Masked Mat(Stencil ID为1，Stencil Comparison为3(Equal)，Stencil Operation为0(Keep))所以成功通过了模板缓存并遮罩显示。</strong></p>
<p>接着看看粒子特效显示是什么情况：</p>
<p><img src="/img/Unity/RenderOrder/UIDefaultMaskParticleSystemFrameDebugger.PNG" alt="UIDefaultMaskParticleSystemFrameDebugger"></p>
<p><strong>粒子特效的显示和被遮罩的勾选图形原理和参数一致，紧接着第一个Canvas.RenderSubBatch之后渲染，所以也成功遮罩显示了。</strong></p>
<p>接着看看defaultFrontImg前景图是什么情况：</p>
<p><img src="/img/Unity/RenderOrder/UIDefaultMaskSecondCanvasFrameDebugger.PNG" alt="UIDefaultMaskSecondCanvasFrameDebugger"></p>
<p><strong>可以看到因为我给defaultFrontImg添加了额外的Canvas并设置了比特效Order还高的Order，所以单独进行了一次Canvas.RenderSubBatch绘制，即第二个Canvas.RenderSubBatch绘制通过Stencil Ref值为0和Stencil Comparison为8(Always)成功将第二个Canvas渲染绘制的模板缓存值修改成0了。</strong></p>
<p><img src="/img/Unity/RenderOrder/UIDefaultMaskFrontImgFrameDebugger.PNG" alt="UIDefaultMaskFrontImgFrameDebugger"></p>
<p><strong>可以看到我给defaultFrontImg设置的UI Default Mat(Stencil ID为0，Stencile Comparison为8(Always)，Stencile Operation为0(Keep))完美符合了第二个Canvas.RenderSubBatch将模板值修改成0后的显示逻辑，所以成功绘制出来了。</strong></p>
<p>总结:</p>
<ol>
<li><strong>虽然通过制作不同的UI Default材质球可以实现遮罩不同的使用情况，但游戏开发过程中遮罩情况可能是动态变化，无法提前预知哪些是用于遮罩，哪些是在遮罩内，哪些是在遮罩外，所以这种方案虽然能实现遮罩效果但并没有实战使用价值。</strong></li>
</ol>
<h4 id="ParticleEffectForUGUI"><a href="#ParticleEffectForUGUI" class="headerlink" title="ParticleEffectForUGUI"></a>ParticleEffectForUGUI</h4><p>接下来让我们看看Github上最强特效和UI显示层级解决方案：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/mob-sakai/ParticleEffectForUGUI">ParticleEffectForUGUI</a></p>
<p>特点介绍：</p>
<ul>
<li><strong>Sortable:</strong> Sort particle effects and other UI elements by sibling index.</li>
<li><strong>Maskable:</strong> Supports <code>Mask</code> or <code>RectMask2D</code>.</li>
<li><strong>No extra components required:</strong> No need for an additional <code>Camera</code>, <code>RenderTexture</code>, or <code>Canvas</code>.</li>
<li><strong>Trail module support:</strong> Fully supports the Trail module.</li>
<li><strong>CanvasGroup alpha support:</strong> Integrates with <code>CanvasGroup</code> alpha.</li>
<li><strong>No allocations:</strong> Efficiently renders particles without allocations.</li>
<li><strong>Any canvas render mode support:</strong> Works with overlay, camera space, and world space.</li>
<li><strong>Any Render pipeline support:</strong> Compatible with Universal Render Pipeline (URP) and High Definition Render Pipeline (HDRP).</li>
<li>省略</li>
</ul>
<p>从上面介绍可以看到<strong>ParticleEffectForUGUI能将特效在UI排序显示，无需任何Camera，RenderTexture或者Canvas。支持CanvasGroup的Alpha，支持Canvas的各种Render Mode。兼容URP，HDRP等。</strong></p>
<h5 id="ParticleEffectForUGUI导入"><a href="#ParticleEffectForUGUI导入" class="headerlink" title="ParticleEffectForUGUI导入"></a>ParticleEffectForUGUI导入</h5><p>我们通过Package Manager选择Git地址(<strong>注意#后面的数字是版本号</strong>)导入:</p>
<figure class="highlight latex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/mob-sakai/ParticleEffectForUGUI.git<span class="params">#4</span>.11.4</span><br></pre></td></tr></table></figure>

<p>Note:</p>
<ol>
<li><strong>导入完成后如果想直接使用源码版本，可以直接从Package下拷贝到Asset目录下使用，然后删除Package Manager里的导入库即可。</strong></li>
</ol>
<h5 id="扩展粒子特效Shader支持Stencil和Clip"><a href="#扩展粒子特效Shader支持Stencil和Clip" class="headerlink" title="扩展粒子特效Shader支持Stencil和Clip"></a>扩展粒子特效Shader支持Stencil和Clip</h5><p>粒子特效的Shader要像UI Default Shader一样支持UI的Mask和Clip功能。</p>
<p>Particle Add UI Mask.Shader</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line">Shader <span class="string">&quot;Custom/Legacy Shaders/Particles/Additive UI Mask&quot;</span> &#123;</span><br><span class="line">Properties &#123;</span><br><span class="line"> 	******</span><br><span class="line"></span><br><span class="line">    <span class="comment">// #### required for Mask ####</span></span><br><span class="line">    _StencilComp (<span class="string">&quot;Stencil Comparison&quot;</span>, Float) = <span class="number">8</span></span><br><span class="line">    _Stencil (<span class="string">&quot;Stencil ID&quot;</span>, Float) = <span class="number">0</span></span><br><span class="line">    _StencilOp (<span class="string">&quot;Stencil Operation&quot;</span>, Float) = <span class="number">0</span></span><br><span class="line">    _StencilWriteMask (<span class="string">&quot;Stencil Write Mask&quot;</span>, Float) = <span class="number">255</span></span><br><span class="line">    _StencilReadMask (<span class="string">&quot;Stencil Read Mask&quot;</span>, Float) = <span class="number">255</span></span><br><span class="line"></span><br><span class="line">    _ColorMask (<span class="string">&quot;Color Mask&quot;</span>, Float) = <span class="number">15</span></span><br><span class="line"></span><br><span class="line">    [<span class="meta">Toggle(UNITY_UI_ALPHACLIP)</span>] _UseUIAlphaClip (<span class="string">&quot;Use Alpha Clip&quot;</span>, Float) = <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Category &#123;</span><br><span class="line">    Tags &#123; <span class="string">&quot;Queue&quot;</span>=<span class="string">&quot;Transparent&quot;</span> <span class="string">&quot;IgnoreProjector&quot;</span>=<span class="string">&quot;True&quot;</span> <span class="string">&quot;RenderType&quot;</span>=<span class="string">&quot;Transparent&quot;</span> <span class="string">&quot;PreviewType&quot;</span>=<span class="string">&quot;Plane&quot;</span> &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// #### required for Mask ####</span></span><br><span class="line">    Stencil</span><br><span class="line">    &#123;</span><br><span class="line">        Ref [_Stencil]</span><br><span class="line">        Comp [_StencilComp]</span><br><span class="line">        Pass [_StencilOp]</span><br><span class="line">        ReadMask [_StencilReadMask]</span><br><span class="line">        WriteMask [_StencilWriteMask]</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Blend SrcAlpha One</span><br><span class="line">    <span class="comment">// #### required for Mask ####</span></span><br><span class="line">    ColorMask [_ColorMask]</span><br><span class="line">    Cull Off Lighting Off ZWrite Off</span><br><span class="line"></span><br><span class="line">    SubShader &#123;</span><br><span class="line">        Pass &#123;</span><br><span class="line"></span><br><span class="line">            ******</span><br><span class="line"></span><br><span class="line">            <span class="meta">#include &quot;UnityCG.cginc&quot;</span></span><br><span class="line">            <span class="comment">// #### required for RectMask2D ####</span></span><br><span class="line">            <span class="meta">#include &quot;UnityUI.cginc&quot;</span></span><br><span class="line">            <span class="meta">#<span class="keyword">pragma</span> multi_compile __ UNITY_UI_CLIP_RECT</span></span><br><span class="line">            <span class="meta">#<span class="keyword">pragma</span> multi_compile __ UNITY_UI_ALPHACLIP</span></span><br><span class="line"></span><br><span class="line">            ******</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">struct</span> v2f &#123;</span><br><span class="line">				******</span><br><span class="line"></span><br><span class="line">                <span class="comment">// #### required for RectMask2D ####</span></span><br><span class="line">                float4 worldPosition : TEXCOORD1;</span><br><span class="line"></span><br><span class="line">                UNITY_FOG_COORDS(<span class="number">2</span>)</span><br><span class="line">                <span class="meta">#ifdef SOFTPARTICLES_ON</span></span><br><span class="line">                float4 projPos : TEXCOORD3;</span><br><span class="line">                <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">                UNITY_VERTEX_OUTPUT_STEREO</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            float4 _MainTex_ST;</span><br><span class="line">            <span class="comment">// #### required for RectMask2D ####</span></span><br><span class="line">            float4 _ClipRect;</span><br><span class="line"></span><br><span class="line">            <span class="function">v2f <span class="title">vert</span> (<span class="params">appdata_t v</span>)</span></span><br><span class="line">            &#123;</span><br><span class="line">                ******</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// #### required for RectMask2D ####</span></span><br><span class="line">                o.worldPosition = v.vertex;</span><br><span class="line"></span><br><span class="line">				******</span><br><span class="line">                    </span><br><span class="line">                <span class="keyword">return</span> o;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            UNITY_DECLARE_DEPTH_TEXTURE(_CameraDepthTexture);</span><br><span class="line">            <span class="built_in">float</span> _InvFade;</span><br><span class="line"></span><br><span class="line">            <span class="function">fixed4 <span class="title">frag</span> (<span class="params">v2f i</span>) : SV_Target</span></span><br><span class="line">            &#123;</span><br><span class="line">                ******</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// #### required for RectMask2D ####</span></span><br><span class="line">                <span class="meta">#ifdef UNITY_UI_CLIP_RECT</span></span><br><span class="line">                    col.a *= UnityGet2DClipping(i.worldPosition.xy, _ClipRect);</span><br><span class="line">                <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">                <span class="meta">#ifdef UNITY_UI_ALPHACLIP</span></span><br><span class="line">                    clip(col.a - <span class="number">0.001</span>);</span><br><span class="line">                <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">                col.rgb *= col.a;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> col;</span><br><span class="line">            &#125;</span><br><span class="line">            ENDCG</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​		<strong>核心是像UI Default Shader里加入了UNITY_UI_CLIP_RECT和UNITY_UI_ALPHACLIP以及Stencil模板相关的定义。</strong></p>
<p>Note:</p>
<ol>
<li><strong>注意定义v2f的worldPosition : TEXCOORD1时会占用TEXCOORD1，后续UNITY_FOG_COORDs(2)和projPos:TEXCOORD3都得顺势往后延</strong></li>
</ol>
<h5 id="制作粒子特效GameObject"><a href="#制作粒子特效GameObject" class="headerlink" title="制作粒子特效GameObject"></a>制作粒子特效GameObject</h5><p>第1种情况，从0制作粒子特效：</p>
<ol>
<li><p><strong>创建UIParticle GameObject</strong></p>
<p><img src="/img/Unity/RenderOrder/CreateEmptyUIParticleGameObject.PNG" alt="CreateEmptyUIParticleGameObject"></p>
</li>
<li><p>在UIParticle GameObject节点下只做粒子特效</p>
</li>
<li><p><strong>做完粒子特效后点击UIParticle面板上的Refresh按钮</strong></p>
<p><img src="/img/Unity/RenderOrder/UIParticleRefreshButton.PNG" alt="UIParticleRefreshButton"></p>
</li>
<li><p>保存UIParticle GameObject当做特效使用</p>
</li>
</ol>
<p>第二种情况，在已有的特效GameObject上制作粒子特效：</p>
<ol>
<li><p><strong>对已有粒子特效GameObject右键创建UIParticle</strong></p>
<p><img src="/img/Unity/RenderOrder/CreateUIParticleFromGameObject.PNG" alt="CreateUIParticleFromGameObject"></p>
</li>
<li><p>保存UIParticle GameObject当做特效使用</p>
</li>
</ol>
<p>Note:</p>
<ol>
<li><strong>通过ParticleEffectForUGUI制作的粒子特效我们不再需要手动调整Order，我们可以像调整UI节点一样放到对应位置即可</strong></li>
<li><strong>要想UIParticle制作的特效支持Mask需要勾选UIParticle的Maskable</strong></li>
</ol>
<h5 id="UIParticle缩放"><a href="#UIParticle缩放" class="headerlink" title="UIParticle缩放"></a>UIParticle缩放</h5><p><strong>UIParticle的显示大小根据UIParticle的AutoScalingMode设置不同而决定因素不同。UIParticle.scale是UIParticle提供控制粒子特效显示大小的一个参数。</strong></p>
<p>粒子最终渲染尺寸的计算公式如下：</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/gitblog_00936/article/details/151919289"><strong>最终尺寸 &#x3D; Scale3D值 × Canvas缩放因子 × 粒子系统自身缩放 × 父级UI元素缩放</strong></a></p>
<p><strong>UIParticle.AutoScalingMode是解决Canvas分辨率适配的核心参数</strong>，有三种模式:</p>
<ul>
<li><p><strong>None</strong></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/gitblog_00936/article/details/151919289">行为：完全禁用自动缩放适配</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/gitblog_00936/article/details/151919289">适用场景：固定分辨率的应用（如某些嵌入式设备）</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/gitblog_00936/article/details/151919289">缩放公式：最终尺寸 &#x3D; Scale3D值 × 粒子系统自身缩放</a></p>
</li>
<li><p><strong>Transform</strong></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/gitblog_00936/article/details/151919289">行为：通过调整Transform.localScale适配Canvas缩放</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/gitblog_00936/article/details/151919289">适用场景：需要与其他UI元素保持一致缩放比例的情况</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/gitblog_00936/article/details/151919289">缩放公式：最终尺寸 &#x3D; Scale3D值 × Transform.localScale × 粒子系统自身缩放</a></p>
</li>
<li><p><strong>UIParticle</strong></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/gitblog_00936/article/details/151919289">行为：通过调整UIParticle.scale3DForCalc的计算公式适配Canvas缩放</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/gitblog_00936/article/details/151919289">适用场景：大多数UI粒子效果，尤其是需要保持相对大小的元素</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/gitblog_00936/article/details/151919289">缩放公式：最终尺寸 &#x3D; Scale3D值 × Canvas缩放因子 × 粒子系统自身缩放</a></p>
</li>
</ul>
<p><strong>看网上的说法Position Mode是Absolute或者Relative对于AutoScalingMode.Transform还是AutoScalingMode.UIParticle选择有影响，目前未做测试。</strong></p>
<p>个人目前想法结论如下：</p>
<p><strong>AutoScalingMode推荐UIParticle，制作粒子特效的Simulation Space推荐Local，UIParticle.scale创建时默认是10所有特效制作时基于scale修改成1的标准来做，这样我们设置UIParticle.scale缩放时就是相对1的比例来考虑(这样更符合类似Transform Scale缩放理念的设置)</strong></p>
<p>Note:</p>
<ol>
<li><strong>UIParticle.scale无论在任何模式下都会对粒子特效的最终显示大小都有影响</strong></li>
</ol>
<h5 id="UIParticle遮罩"><a href="#UIParticle遮罩" class="headerlink" title="UIParticle遮罩"></a>UIParticle遮罩</h5><p><strong>Mask遮罩，就像常规Mask遮罩UI对象一样，将制作的UIParticle GameObject放到对应节点位置即可。</strong></p>
<p><img src="/img/Unity/RenderOrder/ParticleEffectForUGUIMaskInspector.PNG" alt="ParticleEffectForUGUIMaskInspector"></p>
<p><img src="/img/Unity/RenderOrder/ParticleEffectForUGUIMaskShowResult.PNG" alt="ParticleEffectForUGUIMaskShowResult"></p>
<p>我们结合Mask遮罩来看看UIParticle是如何实现粒子特效支持Mask显示的。</p>
<p>首先看看粒子特效在FrameDebugger里是如何绘制的：</p>
<p><img src="/img/Unity/RenderOrder/ParticleEffectForUGUIMaskFrameDebugger.PNG" alt="ParticleEffectForUGUIMaskFrameDebugger"></p>
<p><strong>可以看到粒子特效这一次没有在被当做3D对象单独绘制而是在Canvas.RenderSubBatch流程里绘制且绘制时机是在unmaskMaterial清除模板缓存值之前，我想这就就是为什么UIParticle绘制的粒子特效为什么能支持UI Mask和RectMask2D的原因。</strong></p>
<p>那么UIParticle是如何实现将UI粒子特效当做UI对象在Canvas里绘制的了？</p>
<p><strong>首先UIParticle是取消了ParticleSystem的Renderer组件激活(避免3D粒子特效的渲染)</strong></p>
<p><img src="/img/Unity/RenderOrder/ParticleEffectForUGUICancelPSRenderer.PNG" alt="ParticleEffectForUGUICancelPSRenderer"></p>
<p>然后我们来看看UIParticle.cs的代码定义:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Render maskable and sortable particle effect ,without Camera, RenderTexture or Canvas.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">Icon(<span class="string">&quot;Packages/com.coffee.ui-particle/Editor/UIParticleIcon.png&quot;</span>)</span>]</span><br><span class="line">[<span class="meta">ExecuteAlways</span>]</span><br><span class="line">[<span class="meta">RequireComponent(typeof(RectTransform))</span>]</span><br><span class="line">[<span class="meta">RequireComponent(typeof(CanvasRenderer))</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UIParticle</span> : <span class="title">MaskableGraphic</span>, <span class="title">ISerializationCallbackReceiver</span></span><br><span class="line">&#123;</span><br><span class="line">    ******</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> List&lt;UIParticleRenderer&gt; _renderers = <span class="keyword">new</span> List&lt;UIParticleRenderer&gt;();</span><br><span class="line">    <span class="keyword">private</span> Camera _bakeCamera;</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">UpdateMaterial</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Call to update the geometry of the Graphic onto the CanvasRenderer.</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">UpdateGeometry</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到UIParticle组件添加时强制添加了<strong>CanvasRenderer</strong>组件的，同时UIParticle继承了<strong>MaskGraphic</strong>。</p>
<p><strong>CanvasRenderer组件是UIParticle融入到Canvas渲染流程里的必要组件</strong></p>
<p><strong>MaskGraphic是UIParticle获取Canvas UI渲染能力和遮罩支持的关键</strong></p>
<p>UIParticle通过重写MaskGraphic.UpdateMaterial和MaskGraphic.UpdateGeometry方法避免任何渲染和材质相关的逻辑。UIParticle真正的渲染逻辑是通过**UIParticleRenderer(也继承至MaskableGraphic)**类完成的，也就是UIParticle._renders这个成员对象。</p>
<p><strong>核心渲染流程方法是UIParticle.UpdateRenderers()，UIParticle.UpdateRenderers()方法是在UIParticleUpdater.cs里通过注入Canvas.onAfterCanvasRebuild(在Canvas渲染前调用)流程调用的</strong></p>
<p><strong>UIParticle.UpdateRenderers()会先收集之前通过UIParticle面板Refresh按钮搜集到的所有粒子特效，创建相关UIParticleRenderer对象(这里就是UIParticle._renders构建的地方)</strong></p>
<p><strong>然后UIParticle通过GetBakeCamera()方法获取到当前绘制Canvas的UICamera，然后UICamera传递调用UIParticleRenderer.UpdateMesh(BakeCamera)方法</strong></p>
<p><strong>UIParticleRenderer.UpdateMesh()方法里，通过调用ParticleSystemRenderer.BakeMesh()方法传入指定摄像机，将通过该UICamera渲染的Mesh保存到CombineInstance类数据里</strong></p>
<p><strong>然后将所有烘焙得到的CombineInstance的Mesh数据合并到一个mesh里(workerMesh.CombineMeshes())</strong></p>
<p><strong>最后将烘焙的bakeMesh数据设置到UIParticleRenderer.canvasRenderer.SetMesh()的Mesh里，然后UIParticleRenderer通过canvasRenderer参与到Canvas的绘制流程里，从而实现了粒子特效转换成UI Mesh参与到Canvas绘制流程里的过程。</strong></p>
<p>那么UIParticleRenderer是如何实现支持UGUI的Mask和RectMask2D遮罩功能的了？</p>
<p><strong>UIParticleRenderer.GetModifiedMaterial()里调用了base.GetModifiedMaterial()，接下来让我们看看内部的代码实现:</strong></p>
<p>MaskableGraphic.cs</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> See IMaterialModifier.GetModifiedMaterial</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> Material <span class="title">GetModifiedMaterial</span>(<span class="params">Material baseMaterial</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> toUse = baseMaterial;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (m_ShouldRecalculateStencil)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> rootCanvas = MaskUtilities.FindRootSortOverrideCanvas(transform);</span><br><span class="line">        m_StencilValue = maskable ? MaskUtilities.GetStencilDepth(transform, rootCanvas) : <span class="number">0</span>;</span><br><span class="line">        m_ShouldRecalculateStencil = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// if we have a enabled Mask component then it will</span></span><br><span class="line">    <span class="comment">// generate the mask material. This is an optimisation</span></span><br><span class="line">    <span class="comment">// it adds some coupling between components though :(</span></span><br><span class="line">    Mask maskComponent = GetComponent&lt;Mask&gt;();</span><br><span class="line">    <span class="keyword">if</span> (m_StencilValue &gt; <span class="number">0</span> &amp;&amp; (maskComponent == <span class="literal">null</span> || !maskComponent.IsActive()))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> maskMat = StencilMaterial.Add(toUse, (<span class="number">1</span> &lt;&lt; m_StencilValue) - <span class="number">1</span>, StencilOp.Keep, CompareFunction.Equal, ColorWriteMask.All, (<span class="number">1</span> &lt;&lt; m_StencilValue) - <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">        StencilMaterial.Remove(m_MaskMaterial);</span><br><span class="line">        m_MaskMaterial = maskMat;</span><br><span class="line">        toUse = m_MaskMaterial;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> toUse;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，<strong>通过获取当前节点的最上层Canvas获取到最近的m_StencilValue值，然后通过判定是否有Mask组件决定是否要触发StencilMaterial的材质球效果(Stencil ID值为(1&lt;&lt; m_StencilValue) - 1)，StencilOp值为0(Keep)，StencilComparison值为3(Equal)，Stencil ReadMask值为(1 &lt;&lt; m_StencilValue) - 1)，Stencil WriteMask值为0)。也就是与模板Stencil缓存值相比一致就通过模板测试的maskMat。个人认为这也就是UIParticleRenderer支持Mask的原因。</strong></p>
<p>那么UIParticle又是如何实现RectMask2D的遮罩支持的了？</p>
<p>核心是RectMask2D会在RectMask2D.PerformClipping()里遍历访问MaskableGraphic，并调用MaskableGraphic.SetClipRect()，让我们来看看MaskableGraphic.SetClipRect()的代码：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> See IClippable.SetClipRect</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">SetClipRect</span>(<span class="params">Rect clipRect, <span class="built_in">bool</span> validRect</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (validRect)</span><br><span class="line">        canvasRenderer.EnableRectClipping(clipRect);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        canvasRenderer.DisableRectClipping();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>可以看到这里应该是通过canvasRenderer.EnableRectClipping()成功将Shader里的</strong>UNITY_UI_CLIP_RECT<strong>的Shader关键词激活了，后续应该是设置并传入了Shader里_ClipRect变量的裁剪区域值。</strong></p>
<p><strong>RectMask2D遮罩，就像常规RectMask2D遮罩UI对象一样，将制作的UIParticle GameObject放到对应节点位置即可。</strong></p>
<p><img src="/img/Unity/RenderOrder/ParticleEffectForUGUIRectMask2DInspector.PNG" alt="ParticleEffectForUGUIRectMask2DInspector"></p>
<p><img src="/img/Unity/RenderOrder/ParticleEffectForUGUIRectMask2DShowResult.PNG" alt="ParticleEffectForUGUIRectMask2DShowResult"></p>
<p>至此我们成功通关ParticleEffectForUGUI插件实现了特效在UI里的Mask和RectMask2D遮罩显示。</p>
<h5 id="UIParticle层级"><a href="#UIParticle层级" class="headerlink" title="UIParticle层级"></a>UIParticle层级</h5><p><strong>通过ParticleEffectForUGUI制作的特效，在处理UI层级问题时可以直接向处理UI节点一样，只要保证节点顺序就能保证显示层级。</strong></p>
<p><img src="/img/Unity/RenderOrder/ParticleEffectForUGUILayerInspector.PNG" alt="ParticleEffectForUGUILayerInspector"></p>
<p><img src="/img/Unity/RenderOrder/ParticleEffectForUGUILayerShowResult.PNG" alt="ParticleEffectForUGUILayerShowResult"></p>
<p><strong>可以看到我制作的白色粒子特效夹在UI中间显示，绿色粒子特效在最顶层显示正确显示了</strong></p>
<h5 id="UIParticleAttractor"><a href="#UIParticleAttractor" class="headerlink" title="UIParticleAttractor"></a>UIParticleAttractor</h5><p><strong>UIParticleAttractor脚本是ParticleEffectForUGUI提供的一个队粒子做额外动画的组件。</strong></p>
<p>比如指定粒子按半径的方式移动到目标UIParticleAttrctor所在为止。</p>
<p><img src="/img/Unity/RenderOrder/UIParticleAttractorInspector.PNG" alt="UIParticleAttractorInspector"></p>
<p><img src="/img/Unity/RenderOrder/UIParticleAttractorShowResult.PNG" alt="UIParticleAttractorShowResult"></p>
<p><strong>可以看到粒子在运行指定延迟时间后按目标终点以指定路线方式(e.g. 直线，曲线等)移动。</strong></p>
<p>效果挺神奇的，可以看出ParticleEffectForUGUI对粒子的控制做到了单个粒子级别。</p>
<h2 id="RectMask2D组件"><a href="#RectMask2D组件" class="headerlink" title="RectMask2D组件"></a>RectMask2D组件</h2><p><strong><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_33060405/article/details/143782999?spm=1001.2101.3001.6650.2&utm_medium=distribute.pc_relevant.none-task-blog-2~default~baidujs_baidulandingword~Ctr-2-143782999-blog-135170296.235%5Ev43%5Epc_blog_bottom_relevance_base5&depth_1-utm_source=distribute.pc_relevant.none-task-blog-2~default~baidujs_baidulandingword~Ctr-2-143782999-blog-135170296.235%5Ev43%5Epc_blog_bottom_relevance_base5&utm_relevant_index=4">RectMask2D是通过CanvasRenderer的裁剪矩形（ClipRect）实现，底层是CPU裁剪顶点。</a></strong></p>
<p><strong><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_33060405/article/details/143782999?spm=1001.2101.3001.6650.2&utm_medium=distribute.pc_relevant.none-task-blog-2~default~baidujs_baidulandingword~Ctr-2-143782999-blog-135170296.235%5Ev43%5Epc_blog_bottom_relevance_base5&depth_1-utm_source=distribute.pc_relevant.none-task-blog-2~default~baidujs_baidulandingword~Ctr-2-143782999-blog-135170296.235%5Ev43%5Epc_blog_bottom_relevance_base5&utm_relevant_index=4">标准ParticleSystem渲染在Camera空间，走的是Renderer，不是UGUI的CanvasRenderer。</a></strong></p>
<p>从上面的介绍可以看到正常流程粒子特效没走CanvasRenderer，是无法被RectMask2D裁剪的，如果想支持粒子被RectMask2D裁剪，有两种方案：</p>
<ol>
<li><strong>将粒子特效重定向到CanvasRenderer里去渲染</strong></li>
<li><strong>手动写代码将RectMask2D的裁剪区域传递到粒子特效Shader里去，然后写Shader代码去判定裁剪显示</strong></li>
</ol>
<h3 id="将粒子特效重定向到CanvasRenderer里去渲染"><a href="#将粒子特效重定向到CanvasRenderer里去渲染" class="headerlink" title="将粒子特效重定向到CanvasRenderer里去渲染"></a>将粒子特效重定向到CanvasRenderer里去渲染</h3><p>此方案直接学习<a target="_blank" rel="noopener" href="https://github.com/mob-sakai/ParticleEffectForUGUI">ParticleEffectForUGUI</a>组件，参考前面的ParticleEffectForUGUI学习</p>
<h3 id="手动传递RectMask2D裁剪区域到粒子Shader"><a href="#手动传递RectMask2D裁剪区域到粒子Shader" class="headerlink" title="手动传递RectMask2D裁剪区域到粒子Shader"></a>手动传递RectMask2D裁剪区域到粒子Shader</h3><p>第二个方案参考:</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_41995872/article/details/103905945">Rect Mask2D遮住特效</a></p>
<p>Particle Add Mask.shader</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line">Shader <span class="string">&quot;Custom/Legacy Shaders/Particles/Additive Mask&quot;</span> &#123;</span><br><span class="line">Properties &#123;</span><br><span class="line">    ******</span><br><span class="line"></span><br><span class="line">    <span class="comment">// #### required for RectMask2D ####</span></span><br><span class="line">    _ClipRect (<span class="string">&quot;ClipRect&quot;</span>, Vector) = (<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>)</span><br><span class="line">    _UNITY_UI_CLIP_RECT(<span class="string">&quot;UNITY_UI_CLIP_RECT&quot;</span>, <span class="built_in">float</span>) = <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Category &#123;</span><br><span class="line">    ******</span><br><span class="line"></span><br><span class="line">    SubShader &#123;</span><br><span class="line">        Pass &#123;</span><br><span class="line"></span><br><span class="line">            ******</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// #### required for RectMask2D ####</span></span><br><span class="line">            <span class="meta">#include &quot;UnityUI.cginc&quot;</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// #### required for RectMask2D ####</span></span><br><span class="line">            float4 _ClipRect;</span><br><span class="line">            <span class="built_in">float</span> _UNITY_UI_CLIP_RECT;</span><br><span class="line"></span><br><span class="line">            sampler2D _MainTex;</span><br><span class="line">            fixed4 _TintColor;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">struct</span> appdata_t &#123;</span><br><span class="line">                float4 vertex : POSITION;</span><br><span class="line">                fixed4 color : COLOR;</span><br><span class="line">                float2 texcoord : TEXCOORD0;</span><br><span class="line">                UNITY_VERTEX_INPUT_INSTANCE_ID</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">struct</span> v2f &#123;</span><br><span class="line">                ******</span><br><span class="line"></span><br><span class="line">                <span class="comment">// #### required for RectMask2D ####</span></span><br><span class="line">                float4 worldPosition : TEXCOORD1;</span><br><span class="line"></span><br><span class="line">                UNITY_FOG_COORDS(<span class="number">2</span>)</span><br><span class="line">                <span class="meta">#ifdef SOFTPARTICLES_ON</span></span><br><span class="line">                float4 projPos : TEXCOORD3;</span><br><span class="line">                <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">                UNITY_VERTEX_OUTPUT_STEREO</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            float4 _MainTex_ST;</span><br><span class="line"></span><br><span class="line">            <span class="function">v2f <span class="title">vert</span> (<span class="params">appdata_t v</span>)</span></span><br><span class="line">            &#123;</span><br><span class="line">                ******</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// #### required for RectMask2D ####</span></span><br><span class="line">                o.worldPosition = mul(unity_ObjectToWorld, v.vertex);</span><br><span class="line"></span><br><span class="line">                <span class="meta">#ifdef SOFTPARTICLES_ON</span></span><br><span class="line">                o.projPos = ComputeScreenPos (o.vertex);</span><br><span class="line">                COMPUTE_EYEDEPTH(o.projPos.z);</span><br><span class="line">                <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">                o.color = v.color;</span><br><span class="line">                o.texcoord = TRANSFORM_TEX(v.texcoord,_MainTex);</span><br><span class="line">                UNITY_TRANSFER_FOG(o,o.vertex);</span><br><span class="line">                <span class="keyword">return</span> o;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            UNITY_DECLARE_DEPTH_TEXTURE(_CameraDepthTexture);</span><br><span class="line">            <span class="built_in">float</span> _InvFade;</span><br><span class="line"></span><br><span class="line">            <span class="function">fixed4 <span class="title">frag</span> (<span class="params">v2f i</span>) : SV_Target</span></span><br><span class="line">            &#123;</span><br><span class="line">                ******</span><br><span class="line"></span><br><span class="line">                <span class="comment">// #### required for RectMask2D ####</span></span><br><span class="line">                <span class="comment">//等效于 if(_UNITY_UI_CLIP_RECT == 1) col.a *= UnityGet2DClipping(i.worldPosition.xy, _ClipRect);</span></span><br><span class="line">                col.a *= pow(UnityGet2DClipping(i.worldPosition.xy, _ClipRect) + <span class="number">1</span>, _UNITY_UI_CLIP_RECT) - _UNITY_UI_CLIP_RECT;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> col;</span><br><span class="line">            &#125;</span><br><span class="line">            ENDCG</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Note:</p>
<ol>
<li><strong>注意定义v2f的worldPosition : TEXCOORD1时会占用TEXCOORD1，后续UNITY_FOG_COORDs(2)和projPos:TEXCOORD3都得顺势往后延</strong></li>
<li><strong>因为粒子特效默认不是在UI的CanvasRenderer模式下渲染的，所以__ UNITY_UI_CLIP_RECT和__ UNITY_UI_ALPHACLIP宏默认是不是起作用的</strong></li>
</ol>
<p>ParticleClip.cs</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> ParticleClip.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 用于粒子系统遮罩裁剪</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ParticleClip</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> RectMask2D裁剪区域</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;RectMask2D裁剪区域&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> Vector4 ClipRect;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 子Renderer组件列表</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> Renderer[] mChildRenderers;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Start</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> mask = GetComponentInParent&lt;UnityEngine.UI.RectMask2D&gt;();</span><br><span class="line">        <span class="keyword">if</span> (mask == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mChildRenderers = GetComponentsInChildren&lt;Renderer&gt;();</span><br><span class="line">        <span class="keyword">if</span>(mChildRenderers == <span class="literal">null</span> || mChildRenderers.Length == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Vector3[] vector3s = <span class="keyword">new</span> Vector3[<span class="number">4</span>];</span><br><span class="line">        mask.rectTransform.GetWorldCorners(vector3s);</span><br><span class="line">        ClipRect = <span class="keyword">new</span> Vector4(vector3s[<span class="number">0</span>].x, vector3s[<span class="number">0</span>].y, vector3s[<span class="number">2</span>].x, vector3s[<span class="number">2</span>].y);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> renderer <span class="keyword">in</span> mChildRenderers)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> rendererMaterial = renderer.material;</span><br><span class="line">            <span class="keyword">if</span>(rendererMaterial == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(rendererMaterial.HasVector(<span class="string">&quot;_ClipRect&quot;</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                rendererMaterial.SetVector(<span class="string">&quot;_ClipRect&quot;</span>, ClipRect);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(rendererMaterial.HasFloat(<span class="string">&quot;_UNITY_UI_CLIP_RECT&quot;</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                rendererMaterial.SetFloat(<span class="string">&quot;_UNITY_UI_CLIP_RECT&quot;</span>, <span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/img/Unity/RenderOrder/RectMask2DAndParticleClipInspector.PNG" alt="RectMask2DAndParticleClipInspector"></p>
<p><img src="/img/Unity/RenderOrder/ParticleClipAdditiveMaskShaderInspector.PNG" alt="ParticleClipAdditiveMaskShaderInspector"></p>
<p>可以看到通过ParticleClip.cs脚本，我成功将RectMask2D的裁剪区域数据和是否启用UNITY_UI_CLIP_RECT的数据传递到了Particle Add Mask.shader，让我们看看最终效果：</p>
<p><img src="/img/Unity/RenderOrder/RectMask2DAndParticleClipShowResult.PNG" alt="RectMask2DAndParticleClipShowResult"></p>
<p><strong>可以看到通过传递自定义RectMask2D裁剪区域以及粒子特效Shader支持裁剪区域显示判定，我们成功实现了支持RectMask2D的粒子特效遮罩显示</strong></p>
<p>总结:</p>
<ol>
<li><strong>此方案虽然能实现粒子特效的RectMask2D的遮罩效果，但节点挂载情况无时无刻都在变化，此方案不适合放到实战里去运用，只做为学习理解RectMask2D的裁剪原理</strong></li>
</ol>
<h1 id="3D和2D混合显示及决方案"><a href="#3D和2D混合显示及决方案" class="headerlink" title="3D和2D混合显示及决方案"></a>3D和2D混合显示及决方案</h1><p>有了前面的渲染顺序基础知识以及Mask相关知识，现在让我们再来看看游戏开发过程中遇到的3D物体和2D UI需要混合显示的问题该如何解决了？</p>
<p>通过前面的学习，特效和UI混合显示已经有了很好的方案:</p>
<p><a target="_blank" rel="noopener" href="https://github.com/mob-sakai/ParticleEffectForUGUI">ParticleEffectForUGUI</a></p>
<p>但ParticleEffectForUGUI并不支持模型的显示。</p>
<p>结合前面渲染顺序的学习，目前个人想到两种方案:</p>
<ol>
<li><strong>Extra 3D Model Camera</strong></li>
<li><strong>Extra Camera+Render Texture</strong></li>
</ol>
<p>Note:</p>
<ol>
<li><strong>3D在UI混合显示需要在Transparent Renderer Queue</strong></li>
</ol>
<h2 id="Extra-3D-Model-Camera"><a href="#Extra-3D-Model-Camera" class="headerlink" title="Extra 3D Model Camera"></a>Extra 3D Model Camera</h2><p><strong>额外3D模型摄像机照射模型，然后通过预设3D场景摄像机，UI摄像机，3D模型摄像机的Depth值来排序显示。</strong></p>
<p>好处:</p>
<ol>
<li><strong>3D模型只需要计算2D映射到3D摄像机的坐标位置显示即可，然后再处理一下不同分辨率的模型大小动态计算解决分辨率显示大小不同意问题即可</strong></li>
</ol>
<p>坏处：</p>
<ol>
<li><strong>3D模型摄像机只能固定在UI摄像机上或者下显示，如果在UI摄像机下方还会被背景图遮挡，所以理论上3D模型摄像机只能设置在UI摄像机上方显示(会导致UI没法盖住3D模型)</strong></li>
<li><strong>跨UI显示时，老的3D模型需要额外处理，不然会穿透显示</strong></li>
</ol>
<p>坏处1这个问题目前没有解决方案。</p>
<p>针对坏处2的解决方案如下：</p>
<p><strong>通过编写一个UIModelManager来统一管理UI 3D模型的创建和显示管理，将3D模型的显示和UI窗口绑定关联，在打开新UI时，只要绑定的UI不在最顶层，3D模型就统一隐藏不显示(比如把对应3D摄像机直接隐藏)，反之显示</strong></p>
<p><strong>实战TODO</strong></p>
<h2 id="3D-Camera-Render-Texture"><a href="#3D-Camera-Render-Texture" class="headerlink" title="3D Camera + Render Texture"></a>3D Camera + Render Texture</h2><p><strong>此方案思路是将3D摄像机单独照射后渲染到Render Texture上，然后通过UI上显示Render Texture的内容来实现模型在UI上的显示。</strong></p>
<p>好处：</p>
<ol>
<li><strong>3D模型显示的层级问题很好解决，可以像UI一般夹层显示，不用担心任何夹层和跨UI打开问题</strong></li>
</ol>
<p>坏处：</p>
<ol>
<li><strong>Camera+Render Texture会需要额外的纹理贴图开销，其次显示效果经过额外Shader处理不如直接照射效果好</strong></li>
</ol>
<p>这个以前实现过就不再实战了。</p>
<h1 id="学习总结"><a href="#学习总结" class="headerlink" title="学习总结"></a>学习总结</h1><ol>
<li><strong>Mask的底层遮罩原理是使用了模板缓存机制</strong></li>
<li><strong>RectMask2D的底层遮罩原理是利用C#层计算裁剪区域，然后传递给Shader开启UNITY_UI_CLIP_RECT进行裁剪区域显示判定</strong></li>
<li><strong>粒子特效默认是当做3D物体渲染，不参与Canvas Renderer流程，ParticleEffectForUGUI是通过将粒子特效自定义绘制到MaskableGraphic的UIParticleRenderer组件从而实现的粒子特效参与到Canvas Renderer以及支持Mask和RectMask2D遮罩的</strong></li>
</ol>
<h1 id="Github"><a href="#Github" class="headerlink" title="Github"></a>Github</h1><p><a target="_blank" rel="noopener" href="https://github.com/mob-sakai/ParticleEffectForUGUI">ParticleEffectForUGUI</a></p>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a target="_blank" rel="noopener" href="https://indienova.com/indie-game-development/stencil-buffer-and-stencil-test/">走进 Stencil Buffer 系列 0 : 模板缓冲和模板测试是什么?</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/592341267">模板测试（Stencil Test）基本概念</a></p>
<p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/f79f0da90103">ShaderLab: Stencil Buffer 的理解和应用</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.51cto.com/u_14402/10670234">Unity 粒子特效在模型前面显示 unity ui粒子特效</a></p>
<p><a target="_blank" rel="noopener" href="https://duanyiliang.com/2020/11/05/unity_particlesystem_mask/">UI上的特效的裁剪问题</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/gitblog_00936/article/details/151919289">解决Unity UI粒子缩放异常：ParticleEffectForUGUI的Scale参数完全指南</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Rendering/">Rendering</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Rendering/">Rendering</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2026/01/29/渲染顺序/" title="渲染顺序" itemprop="url">渲染顺序</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Tony Tang" target="_blank" itemprop="author">Tony Tang</a>
		
  <p class="article-time">
    <time datetime="2026-01-29T15:00:00.000Z" itemprop="datePublished"> 发表于 2026-01-29</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>Unity游戏开发过程中，无论是UI还是3D物体之间是什么因素决定了它的渲染顺序的了，本章是为了<strong>深入学习理解渲染顺序相关知识而写</strong>。</p>
<p>Note:</p>
<ol>
<li><strong>本章节本非深入渲染管线学习，而是理解Unity渲染管线里的一些渲染顺序相关的决定因素设计。</strong></li>
</ol>
<h1 id="渲染顺序相关概念"><a href="#渲染顺序相关概念" class="headerlink" title="渲染顺序相关概念"></a>渲染顺序相关概念</h1><p>一个物体的渲染无论3D还是2D都需要经过摄像机的照射，然后通过Shader经历渲染管线处理后最终显示在屏幕上。</p>
<p>在正确理解渲染顺序之前，让我们先了解一些相关概念知识：</p>
<ol>
<li><strong>Camera(OpaqueSortMode，TransparencySortMode，Depth)</strong></li>
<li><strong>RenderQueue</strong></li>
<li><strong>SortingLayer</strong></li>
<li><strong>SortingOrder</strong></li>
<li><strong>ZTest &amp; ZWrite</strong></li>
</ol>
<h2 id="Camera"><a href="#Camera" class="headerlink" title="Camera"></a>Camera</h2><h3 id="OpaqueSortMode"><a href="#OpaqueSortMode" class="headerlink" title="OpaqueSortMode"></a>OpaqueSortMode</h3><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/ScriptReference/Rendering.OpaqueSortMode.html">Opaque object sorting mode of a Camera. Opaque objects are sorted by various criteria (sorting layers, shader queues, materials, distance, lightmaps etc.) to maximize both the CPU efficiency (reduce number of state changes and improve draw call batching), and to maximize GPU efficiency (many GPUs prefer rough front-to-back rendering order for faster rejection of invisible surfaces).</a></p>
<p>简单的理解OpaqueSortMode是设置摄像机对<strong>不透明物体的排序顺序的策略标准</strong>。</p>
<p><strong>OpaqueSortMode.FrontToBack</strong>(根据距离排序，<strong>先绘制近的后绘制远的结合ZTest实现正确渲染显示</strong>)</p>
<p><strong>OpaqueSortMode.NoDistanceSort</strong>(不根据距离排序)</p>
<h3 id="TransparencySortMode"><a href="#TransparencySortMode" class="headerlink" title="TransparencySortMode"></a>TransparencySortMode</h3><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/ScriptReference/Camera-transparencySortMode.html">Transparent object sorting mode. By default, perspective Cameras sort objects based on distance from Camera position to the object center; and orthographic Cameras sort based on distance along the view direction.</a></p>
<p>简单的理解TransparencySortMode是设置摄像机对<strong>透明物体的排序顺序的策略标准</strong>。</p>
<p><strong>TransparencySortMode.Perspective</strong>(透视投影–判定物体中心与摄像机距离)</p>
<p><strong>TransparencySortMode.Orthographic</strong>(正交投影–判定物体与摄像机方向距离)</p>
<p><strong>TransparencySortMode.CustomAxis</strong>(轴判定–判定与指定轴距离)</p>
<p>比如纯2D游戏，可能就希望使用正交投影方式。</p>
<h3 id="Depth"><a href="#Depth" class="headerlink" title="Depth"></a>Depth</h3><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/ScriptReference/Camera-depth.html">Camera’s depth in the camera rendering order. Cameras with lower depth are rendered before cameras with higher depth. Use this to control the order in which cameras are drawn if you have multiple cameras and some of them don’t cover the full screen.</a></p>
<p>简单的理解Camera.depth是用于控制多个摄像机之间的渲染顺序，<strong>值越低越先渲染</strong>。</p>
<p>常规的场景摄像机和UI摄像机采用不同摄像机，为了确保UI摄像机在场景摄像机之上，所以一般把UI摄像机的depth设置的更小。</p>
<h2 id="RenderQueue"><a href="#RenderQueue" class="headerlink" title="RenderQueue"></a>RenderQueue</h2><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/ScriptReference/Rendering.RenderQueue.html">Determine in which order objects are renderered. This way for example transparent objects are rendered after opaque objects.</a></p>
<p>从上面的介绍可以看出，RenderQueue决定物体的渲染顺序(e.g. 透明物体在不透明物体之后渲染)</p>
<p>让我们看下不同的RenderQueue的详细介绍:</p>
<p><img src="/img/Unity/RenderOrder/RenderQueueIntroduction.PNG" alt="RenderQueueIntroduction"></p>
<p><strong>RenderQueue越大显示层级越高</strong></p>
<p>Note:</p>
<ol>
<li><strong>不透明物体RenderQueue&lt;&#x3D; 2500，透明物体RenderQueue&gt;2500</strong></li>
</ol>
<h2 id="SortingLayer"><a href="#SortingLayer" class="headerlink" title="SortingLayer"></a>SortingLayer</h2><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/ScriptReference/SortingLayer.html">SortingLayer allows you to set the render order of multiple sprites easily. There is always a default SortingLayer named “Default” which all sprites are added to initially. </a></p>
<p>从上面介绍可以看出，SortingLayer也是决定物体显示顺序优先级，<strong>SortingLayer越大显示层级越高</strong>，至于它和RenderQueu之间的优先级后续会讲到。</p>
<h2 id="SortingOrder"><a href="#SortingOrder" class="headerlink" title="SortingOrder"></a>SortingOrder</h2><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/ScriptReference/Renderer-sortingOrder.html">Renderer’s order within a sorting layer. You can group GameObjects into layers in their SpriteRenderercomponent. This is called the SortingLayer. The sorting order decides what priority each GameObject has to the Renderer within each Sorting Layer. </a></p>
<p>从上面介绍可以看出，SortingOrder是在SortingLayer之后的一个显示优先级设置，(SortingLayer相同前提下)<strong>值越大显示层级越高</strong>。</p>
<h2 id="ZTest-ZWrite"><a href="#ZTest-ZWrite" class="headerlink" title="ZTest &amp; ZWrite"></a>ZTest &amp; ZWrite</h2><h3 id="ZWrite-深度写入"><a href="#ZWrite-深度写入" class="headerlink" title="ZWrite(深度写入)"></a>ZWrite(深度写入)</h3><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/SL-ZWrite.html">Sets whether the <strong>depth buffer</strong> contents are updated during rendering. Normally, ZWrite is enabled for opaque objects and disabled for semi-transparent ones. Disabling ZWrite can lead to incorrect depth ordering. In this case, you need to sort geometry on the CPU.</a></p>
<p>从上面的介绍可以看出ZWrite是决定渲染时是否写入深度信息。<strong>通常情况情况不透明物体的ZWrite是打开的，半透明物体ZWrite是关闭的。</strong></p>
<p>那么什么是深度信息了？</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/lyh916/article/details/45317571"> 深度其实就是该像素点在3d世界中距离摄像机的距离。离摄像机越远，则深度值（Z值）越大。</a></p>
<p>这里需要了解两个渲染管线里的概念:</p>
<ol>
<li><strong>Z-Buffer(深度缓冲区)</strong>(用于记录当前渲染过程中渲染记录的深度信息)</li>
<li><strong>Color-Buff(颜色缓冲区)</strong>(用于记录当前渲染过程中渲染记录的颜色信息)</li>
</ol>
<p>Note:</p>
<ol>
<li><strong>深度信息写入的大前提是通过ZTest(深度测试)</strong></li>
</ol>
<h3 id="ZTest-深度测试"><a href="#ZTest-深度测试" class="headerlink" title="ZTest(深度测试)"></a>ZTest(深度测试)</h3><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/SL-ZTest.html">Sets the conditions under which geometry passes or fails depth testing. Depth testing allows GPUs that have “Early-Z” functionality to reject geometry early in the pipeline, and also ensures correct ordering of the geometry. </a></p>
<p>从上面的介绍可以看出ZTest是设置深度测试判定策略。深度测试可以实现“Early-Z”从而实现提前扔掉不必要的参与渲染的数据，同时ZTest是确保渲染顺序的关键。</p>
<p>ZWrite结合ZTest的逻辑流程如下：</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://www.bzetu.com/207/.html">当<strong>ZTest开启时</strong>，以<strong>深度缓冲</strong>为判断基准，来判断是否满足通过条件,如果<strong>不满足则直接丢弃，如果满足执行2</strong></a></li>
<li><strong>更新颜色缓存</strong>，同时<strong>判断是否可以更新深度缓冲</strong>，(也就是 ZWrite 是On还是 Off)，<strong>如果Off,不更新深度缓冲</strong><strong>(之后如果有同位置的颜色要深度测试，用的还是之前深度缓冲里对应颜色的深度)</strong>，如果满足执行3**</li>
<li><strong>更新深度缓冲</strong></li>
</ol>
<p><strong>ZTest与ZWrite的所有组合关系如下</strong></p>
<ol>
<li>深度测试通过，深度写入开启：更新颜色缓冲区，更新深度缓冲区；</li>
<li>深度测试通过，深度写入关闭：更新颜色缓冲区，不更新深度缓冲区；</li>
<li>深度测试失败，深度写入开启：不更新颜色缓冲区，不更新深度缓冲区；</li>
<li>深度测试失败，深度写入关闭：不更新颜色缓冲区，不更新深度缓冲区。</li>
</ol>
<p>了解了ZWrite和ZTest概念后，这里就会好奇，ZWrite和ZTest和RenderQueue都是用于决定渲染顺序的，那他们之间的优先级是怎样的了？详细测试见后面实战。</p>
<p>Note:</p>
<ol>
<li><strong>只有通过ZTest才会把像素信息写入Color-Buffer(颜色缓冲区)</strong></li>
</ol>
<h3 id="Alpha-Blend-透明度混合"><a href="#Alpha-Blend-透明度混合" class="headerlink" title="Alpha Blend(透明度混合)"></a>Alpha Blend(透明度混合)</h3><p><a target="_blank" rel="noopener" href="https://medium.com/ericzhan-publication/shader%E7%AD%86%E8%A8%98-%E9%80%8F%E6%98%8E%E7%89%A9%E9%AB%94-z-test-z-write-z-buffer-alpha-blending-692c60d9b605">透明度混合使用當前片元的透明度作為混合因子，與已經存儲在顏色緩衝中的顏色進行混合，得到新的顏色，不過透明度混合必須要關閉深度寫入(Zwrite) 需要特別注意的是，透明度混合只會關閉深度寫入不會關閉深度測試(ZTest)，這意味著當透明度混合渲染一個片元時，還是會比較他的深度與深度緩存中的深度值，如果深度值距離相機更遠就不會進行混合操作。</a></p>
<p><strong>正是因为透明度混合只关闭ZWrite不关闭ZTest，所以不透明物体依然可以通过ZTest进行对透明物体的遮挡。</strong></p>
<h1 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h1><p>学习了影响渲染顺序相关的概念后，我们知道了影响物体渲染顺序的东西很多，特别是材质的Shader里的RenderQueue，但Unity有一些数据默认是没有显示在Inspector面板上的，为了方便快速查看或修改渲染相关数据，这里我通过扩展Inspector的方式让相关数据显示出来。</p>
<h2 id="Inspecotr扩展"><a href="#Inspecotr扩展" class="headerlink" title="Inspecotr扩展"></a>Inspecotr扩展</h2><h3 id="Camera-Inspector扩展"><a href="#Camera-Inspector扩展" class="headerlink" title="Camera Inspector扩展"></a>Camera Inspector扩展</h3><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEditor;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> UnityEngine.Rendering;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> CameraInspector.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Camera组件Inspector扩展显示</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">CanEditMultipleObjects</span>]</span><br><span class="line">[<span class="meta">CustomEditor(typeof(Camera))</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CameraInspector</span> : <span class="title">CameraEditor</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Note:</span></span><br><span class="line">    <span class="comment">// opaqueSortMode和TransparentSortMode属性好像不属于Serialized成员，FindProperty得不到</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 目标组件对象</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> Camera mTarget;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Note:</span></span><br><span class="line">    <span class="comment">// 这里不能重写OnEnable，会导致CameraEditor原始部分流程异常</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnInspectorGUI</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">base</span>.OnInspectorGUI();</span><br><span class="line">        <span class="keyword">if</span>(mTarget == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            mTarget = (Camera)target;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (mTarget != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            EditorGUILayout.BeginHorizontal();</span><br><span class="line">            EditorGUILayout.LabelField(<span class="string">&quot;opaqueSortMode&quot;</span>, GUILayout.Width(<span class="number">170f</span>));</span><br><span class="line">            EditorGUI.BeginChangeCheck();</span><br><span class="line">            <span class="keyword">var</span> newOpaqueSortMode = (OpaqueSortMode)EditorGUILayout.EnumPopup(mTarget.opaqueSortMode);</span><br><span class="line">            <span class="keyword">if</span>(EditorGUI.EndChangeCheck())</span><br><span class="line">            &#123;</span><br><span class="line">                mTarget.opaqueSortMode = newOpaqueSortMode;</span><br><span class="line">            &#125;</span><br><span class="line">            EditorGUILayout.EndHorizontal();</span><br><span class="line">            EditorGUILayout.BeginHorizontal();</span><br><span class="line">            EditorGUILayout.LabelField(<span class="string">&quot;transparencySortMode&quot;</span>, GUILayout.Width(<span class="number">170f</span>));</span><br><span class="line">            EditorGUI.BeginChangeCheck();</span><br><span class="line">            <span class="keyword">var</span> newTransparencySortMode = (TransparencySortMode)EditorGUILayout.EnumPopup(mTarget.transparencySortMode);</span><br><span class="line">            <span class="keyword">if</span>(EditorGUI.EndChangeCheck())</span><br><span class="line">            &#123;</span><br><span class="line">                mTarget.transparencySortMode = newTransparencySortMode;</span><br><span class="line">            &#125;</span><br><span class="line">            EditorGUILayout.EndHorizontal();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/img/Unity/RenderOrder/CameraInspector.PNG" alt="CameraInspector"></p>
<p>可以看到通过扩展，我把Camera.opaqueSortMode和Camera.transparencySortMode都在Inspecotr面板显示出来了。</p>
<h3 id="MeshRenderer-Inspector扩展"><a href="#MeshRenderer-Inspector扩展" class="headerlink" title="MeshRenderer Inspector扩展"></a>MeshRenderer Inspector扩展</h3><p>MeshRendererInspector.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> UnityEditor;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> MeshRendererInspector.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> MeshRenderer编辑器扩展</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">CustomEditor(typeof(MeshRenderer))</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MeshRendererInspector</span> : <span class="title">Editor</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> SortingOrder属性</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> SerializedProperty mSortingOrderProperty;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Materials属性</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> SerializedProperty mMaterialsProperty;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 目标组件</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> MeshRenderer mTarget;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> SortingLayer名数组</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">string</span>[] mSortingLayersNameArray;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> SortingLayer索引</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span> mSortingLayerIndex;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnEnable</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mTarget = (MeshRenderer)target;</span><br><span class="line">        mSortingLayersNameArray = SortingLayer.layers.Select(x =&gt; x.name).ToArray();</span><br><span class="line">        mSortingOrderProperty = serializedObject.FindProperty(<span class="string">&quot;m_SortingOrder&quot;</span>);</span><br><span class="line">        mMaterialsProperty = serializedObject.FindProperty(<span class="string">&quot;m_Materials&quot;</span>);</span><br><span class="line">        UpdateSortingLayerIndex();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnInspectorGUI</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">base</span>.OnInspectorGUI();</span><br><span class="line">        serializedObject.Update();</span><br><span class="line">        EditorGUI.BeginChangeCheck();</span><br><span class="line">        <span class="keyword">var</span> selectedIndex = EditorGUILayout.Popup(<span class="string">&quot;SortingLayerName&quot;</span>, mSortingLayerIndex, mSortingLayersNameArray);</span><br><span class="line">        <span class="keyword">if</span>(EditorGUI.EndChangeCheck())</span><br><span class="line">        &#123;</span><br><span class="line">            mTarget.sortingLayerName = SortingLayer.layers[selectedIndex].name;</span><br><span class="line">            UpdateSortingLayerIndex();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(mSortingOrderProperty != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            EditorGUILayout.PropertyField(mSortingOrderProperty);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(mMaterialsProperty != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; mMaterialsProperty.arraySize; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> material = mMaterialsProperty.GetArrayElementAtIndex(i);</span><br><span class="line">                <span class="keyword">if</span>(material != <span class="literal">null</span> &amp;&amp; material.objectReferenceValue != <span class="literal">null</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    EditorGUILayout.BeginHorizontal();</span><br><span class="line">                    EditorGUILayout.LabelField(<span class="string">$&quot;Materials[<span class="subst">&#123;i&#125;</span>]&quot;</span>, GUILayout.Width(<span class="number">170f</span>));</span><br><span class="line">                    EditorGUILayout.BeginVertical();</span><br><span class="line">                    <span class="keyword">var</span> mat = (Material)material.objectReferenceValue;</span><br><span class="line">                    EditorGUILayout.ObjectField(mat, EditorType.MATERIAL_TYPE, <span class="literal">false</span>);</span><br><span class="line">                    EditorGUILayout.BeginHorizontal();</span><br><span class="line">                    EditorGUILayout.LabelField(<span class="string">&quot;RenderQueue&quot;</span>, GUILayout.Width(<span class="number">80f</span>));</span><br><span class="line">                    EditorGUILayout.IntField(mat.renderQueue);</span><br><span class="line">                    EditorGUILayout.EndHorizontal();</span><br><span class="line">                    EditorGUILayout.EndVertical();</span><br><span class="line">                    EditorGUILayout.EndHorizontal();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        serializedObject.ApplyModifiedProperties();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 更新SortingLayer索引</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">UpdateSortingLayerIndex</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mSortingLayerIndex = Array.FindIndex(mSortingLayersNameArray, FindSortingLayerNameIndex);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 查找当前SortingLayerName索引</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;sortingName&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="built_in">bool</span> <span class="title">FindSortingLayerNameIndex</span>(<span class="params"><span class="built_in">string</span> sortingName</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> mTarget.sortingLayerName == sortingName;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/img/Unity/RenderOrder/MeshRendererInspector.PNG" alt="MeshRendererInspector"></p>
<p>可以看到通过扩展，我把MeshRenderer的SortingLayerName和Sorting Order以及材质的RenderQueue值都显示出来了。</p>
<h3 id="SpriteRenderer-Inspector扩展"><a href="#SpriteRenderer-Inspector扩展" class="headerlink" title="SpriteRenderer Inspector扩展"></a>SpriteRenderer Inspector扩展</h3><p>SpriteRendererInspector.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Reflection;</span><br><span class="line"><span class="keyword">using</span> UnityEditor;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> SpriteRendererInspector.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> SpriteRenderer编辑器扩展</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">CustomEditor(typeof(SpriteRenderer))</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">SpriteRendererInspector</span> : <span class="title">Editor</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Materials属性</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> SerializedProperty mMaterialsProperty;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> SpriteRendererEditor类型信息</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> Type mSpriteRendererEditorType;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> SpriteRenderer Editor</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> Editor mSpriteRendererEditor;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> SortingLayer索引</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span> mSortingLayerIndex;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnEnable</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mMaterialsProperty = serializedObject.FindProperty(<span class="string">&quot;m_Materials&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> assembly = Assembly.GetAssembly(<span class="keyword">typeof</span>(Editor));</span><br><span class="line">            mSpriteRendererEditorType = assembly.GetType(<span class="string">&quot;UnityEditor.SpriteRendererEditor&quot;</span>, <span class="literal">true</span>);</span><br><span class="line">        mSpriteRendererEditor = Editor.CreateEditor(target, mSpriteRendererEditorType);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnInspectorGUI</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(mSpriteRendererEditor != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            mSpriteRendererEditor.OnInspectorGUI();</span><br><span class="line">        &#125;</span><br><span class="line">        serializedObject.Update();</span><br><span class="line">        <span class="keyword">if</span>(mMaterialsProperty != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; mMaterialsProperty.arraySize; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> material = mMaterialsProperty.GetArrayElementAtIndex(i);</span><br><span class="line">                <span class="keyword">if</span>(material != <span class="literal">null</span> &amp;&amp; material.objectReferenceValue != <span class="literal">null</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    EditorGUILayout.BeginHorizontal();</span><br><span class="line">                    EditorGUILayout.LabelField(<span class="string">$&quot;Materials[<span class="subst">&#123;i&#125;</span>]&quot;</span>, GUILayout.Width(<span class="number">170f</span>));</span><br><span class="line">                    EditorGUILayout.BeginVertical();</span><br><span class="line">                    <span class="keyword">var</span> mat = (Material)material.objectReferenceValue;</span><br><span class="line">                    EditorGUILayout.ObjectField(mat, EditorType.MATERIAL_TYPE, <span class="literal">false</span>);</span><br><span class="line">                    EditorGUILayout.BeginHorizontal();</span><br><span class="line">                    EditorGUILayout.LabelField(<span class="string">&quot;RenderQueue&quot;</span>, GUILayout.Width(<span class="number">80f</span>));</span><br><span class="line">                    EditorGUILayout.IntField(mat.renderQueue);</span><br><span class="line">                    EditorGUILayout.EndHorizontal();</span><br><span class="line">                    EditorGUILayout.EndVertical();</span><br><span class="line">                    EditorGUILayout.EndHorizontal();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        serializedObject.ApplyModifiedProperties();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/img/Unity/RenderOrder/SpriteRendererInspector.PNG" alt="SpriteRendererInspector"></p>
<p>可以看到通过扩展我把SpriteRenderer材质相关的RenderQueue值显示出来了。</p>
<h3 id="SkinnedMeshRenderer-Inspector扩展"><a href="#SkinnedMeshRenderer-Inspector扩展" class="headerlink" title="SkinnedMeshRenderer Inspector扩展"></a>SkinnedMeshRenderer Inspector扩展</h3><p>SKinnedMeshRendererInspector.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> UnityEditor;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> SkinnedMeshRendererInspector.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> SkinnedMeshRenderer编辑器扩展</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">CustomEditor(typeof(SkinnedMeshRenderer))</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">SkinnedMeshRendererInspector</span> : <span class="title">Editor</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> SortingOrder属性</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> SerializedProperty mSortingOrderProperty;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Materials属性</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> SerializedProperty mMaterialsProperty;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 目标组件</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> SkinnedMeshRenderer mTarget;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> SortingLayer名数组</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">string</span>[] mSortingLayersNameArray;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> SortingLayer索引</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span> mSortingLayerIndex;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnEnable</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mTarget = (SkinnedMeshRenderer)target;</span><br><span class="line">        mSortingLayersNameArray = SortingLayer.layers.Select(x =&gt; x.name).ToArray();</span><br><span class="line">        mSortingOrderProperty = serializedObject.FindProperty(<span class="string">&quot;m_SortingOrder&quot;</span>);</span><br><span class="line">        mMaterialsProperty = serializedObject.FindProperty(<span class="string">&quot;m_Materials&quot;</span>);</span><br><span class="line">        UpdateSortingLayerIndex();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnInspectorGUI</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">base</span>.OnInspectorGUI();</span><br><span class="line">        serializedObject.Update();</span><br><span class="line">        EditorGUI.BeginChangeCheck();</span><br><span class="line">        <span class="keyword">var</span> selectedIndex = EditorGUILayout.Popup(<span class="string">&quot;SortingLayerName&quot;</span>, mSortingLayerIndex, mSortingLayersNameArray);</span><br><span class="line">        <span class="keyword">if</span>(EditorGUI.EndChangeCheck())</span><br><span class="line">        &#123;</span><br><span class="line">            mTarget.sortingLayerName = SortingLayer.layers[selectedIndex].name;</span><br><span class="line">            UpdateSortingLayerIndex();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(mSortingOrderProperty != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            EditorGUILayout.PropertyField(mSortingOrderProperty);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(mMaterialsProperty != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; mMaterialsProperty.arraySize; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> material = mMaterialsProperty.GetArrayElementAtIndex(i);</span><br><span class="line">                <span class="keyword">if</span>(material != <span class="literal">null</span> &amp;&amp; material.objectReferenceValue != <span class="literal">null</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    EditorGUILayout.BeginHorizontal();</span><br><span class="line">                    EditorGUILayout.LabelField(<span class="string">$&quot;Materials[<span class="subst">&#123;i&#125;</span>]&quot;</span>, GUILayout.Width(<span class="number">170f</span>));</span><br><span class="line">                    EditorGUILayout.BeginVertical();</span><br><span class="line">                    <span class="keyword">var</span> mat = (Material)material.objectReferenceValue;</span><br><span class="line">                    EditorGUILayout.ObjectField(mat, EditorType.MATERIAL_TYPE, <span class="literal">false</span>);</span><br><span class="line">                    EditorGUILayout.BeginHorizontal();</span><br><span class="line">                    EditorGUILayout.LabelField(<span class="string">&quot;RenderQueue&quot;</span>, GUILayout.Width(<span class="number">80f</span>));</span><br><span class="line">                    EditorGUILayout.IntField(mat.renderQueue);</span><br><span class="line">                    EditorGUILayout.EndHorizontal();</span><br><span class="line">                    EditorGUILayout.EndVertical();</span><br><span class="line">                    EditorGUILayout.EndHorizontal();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        serializedObject.ApplyModifiedProperties();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 更新SortingLayer索引</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">UpdateSortingLayerIndex</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mSortingLayerIndex = Array.FindIndex(mSortingLayersNameArray, FindSortingLayerNameIndex);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 查找当前SortingLayerName索引</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;sortingName&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="built_in">bool</span> <span class="title">FindSortingLayerNameIndex</span>(<span class="params"><span class="built_in">string</span> sortingName</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> mTarget.sortingLayerName == sortingName;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/img/Unity/RenderOrder/SkinnedMeshRendererInspector.PNG" alt="SkinnedMeshRendererInspector"></p>
<p>可以看到通过扩展我把SkinnedMeshRenderer的SortingLayerName和Sorting Order以及材质设置的RenderQueue值都显示出来了。</p>
<h2 id="Camera-Depth"><a href="#Camera-Depth" class="headerlink" title="Camera Depth"></a>Camera Depth</h2><p><strong>摄像机深度在所有影响渲染排序的因素里排首位</strong></p>
<p>游戏开发过程中我们的UI往往在3D场景之上，为了做不同的渲染合批，我们一般会设置2个摄像机，一个作为3D主摄像机，一个作为UI摄像机。</p>
<p><img src="/img/Unity/RenderOrder/MainCameraSetting.PNG" alt="MainCameraSetting"></p>
<p><img src="/img/Unity/RenderOrder/UICameraSetting.PNG" alt="UICameraSetting"></p>
<p>可以看到为了使UI摄像机渲染结果再3D主摄像机之上，我们把UI摄像机的Depth设置值&gt;3D主摄像机</p>
<p><img src="/img/Unity/RenderOrder/3DAnd2DMixResultPreview.PNG" alt="3DAnd2DMixResultPreview"></p>
<p>可以看到UI摄像机照射的结果显示在了3D主摄像机之上，所以可以得出<strong>Camera.Depth值越大越晚渲染</strong>。</p>
<h2 id="ZWrite-ZTest-VS-RenderQueue"><a href="#ZWrite-ZTest-VS-RenderQueue" class="headerlink" title="(ZWrite &amp; ZTest) VS RenderQueue"></a>(ZWrite &amp; ZTest) VS RenderQueue</h2><p>前面提到过ZWrite&amp;ZTest和RenderQueue都是影响渲染顺序的关键。那么他们之间优先级又是怎样得了？</p>
<p>这里直接说结论:</p>
<p><a target="_blank" rel="noopener" href="https://dev.twsiyuan.com/2018/05/unity-rendering-order.html"><strong>如果开启了ZTest和ZWrite，可不管物件绘制順序 (rendering order)，使得里摄像机越近的物件，永远都绘制在其他离摄像机越远的物件之前 (<code>ZTest LEqual</code>)。</strong></a></p>
<p>首先我们创建一个ZWrite On和ZTest LEqual的Shader:</p>
<p>ZWriteZTestOnSurfaceShader.shader</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Shader <span class="string">&quot;Custom/ZWriteZTestOnSurfaceShader&quot;</span></span><br><span class="line">&#123;</span><br><span class="line">    ******</span><br><span class="line">    </span><br><span class="line">    SubShader</span><br><span class="line">    &#123;</span><br><span class="line">        Tags &#123; <span class="string">&quot;RenderType&quot;</span>=<span class="string">&quot;Opaque&quot;</span> &#125;</span><br><span class="line">        LOD <span class="number">200</span></span><br><span class="line">        ZWrite On</span><br><span class="line">        ZTest LEqual</span><br><span class="line">		</span><br><span class="line">        ******</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从上面可以看到我们指定了ZWrite On和ZTest LEqual表示开始深度写入，且深度比较标准是距离越近或相等的情况通过深度测试。同时我们将默认的RenderQueue设置成Opaque，用于不透明物体的渲染。</p>
<p><img src="/img/Unity/RenderOrder/ZWriteZTestOnRedMaterial.PNG" alt="ZWriteZTestOnRedMaterial"></p>
<p><img src="/img/Unity/RenderOrder/ZWriteZTestOnBlueMaterial.PNG" alt="ZWriteZTestOnBlueMaterial"></p>
<p><img src="/img/Unity/RenderOrder/ZWriteZTestOnCubeSceneView.PNG" alt="ZWriteZTestOnCubeSceneView"></p>
<p><img src="/img/Unity/RenderOrder/ZWriteZTestOnCubeGameView.PNG.PNG" alt="ZWriteZTestOnCubeGameView.PNG"></p>
<p>从上面可以看到我们创建了一个ZWrite On ZTest LEqual且RenderQueue分别为2010(红色)和2000(蓝色)的材质球，分别用于两个Cube渲染显示。</p>
<p>可以看到即使红色小球的RenderQueue值更高，但因为开启了ZWrite On和ZTest LEqual，红色Cube离摄像机更远依然渲染在蓝色Cube背后。</p>
<p>接下来让我们看一下两个Cube距离摄像机位置一致时，RenderQueue不一样，两个Cube是怎么显示的？</p>
<p><img src="/img/Unity/RenderOrder/ZWriteZTestOnRedCubePosition.PNG" alt="ZWriteZTestOnRedCubePosition"></p>
<p><img src="/img/Unity/RenderOrder/ZWriteZTestOnBlueCubePosition.PNG" alt="ZWriteZTestOnBlueCubePosition"></p>
<p><img src="/img/Unity/RenderOrder/ZWriteZTestOnWithSameDistanceResult.PNG" alt="ZWriteZTestOnWithSameDistanceResult"></p>
<p>从上面可以看到，距离摄像机相同距离的前提下，红色Cube拥有更高的RenderQueue(2010)显示在了蓝色Cube RenderQueue(2000)之上。</p>
<p>结论：</p>
<ol>
<li><strong>开启ZWrite和ZTest的情况下，深度优先于RenderQueue，深度一样则比较RenderQueue</strong></li>
</ol>
<h2 id="Sorting-Layer-VS-RenderQueue"><a href="#Sorting-Layer-VS-RenderQueue" class="headerlink" title="Sorting Layer VS RenderQueue"></a>Sorting Layer VS RenderQueue</h2><p>那么Sorting Layer和RenderQueue在渲染顺序里谁的优先级更高了？</p>
<p><strong>不透明物体 &gt; 透明物体</strong></p>
<p><strong>同为不透明物体或透明物体时，Sorting Layer &gt; RenderQueue</strong></p>
<p>在测试之前让我们首先添加几个3D Sorting Layer：</p>
<p><img src="/img/Unity/RenderOrder/SortingLayerSetting.PNG" alt="SortingLayerSetting"></p>
<p>接下来让我们实战测试：</p>
<p>红色方块设置：</p>
<p><img src="/img/Unity/RenderOrder/ZOn3D1Layer2000RedSetting.PNG" alt="ZOn3D1Layer2000RedSetting"></p>
<p>蓝色方块设置：</p>
<p><img src="/img/Unity/RenderOrder/ZOnDefaultLayer2500BlueSetting.PNG" alt="ZOnDefaultLayer2500BlueSetting"></p>
<p>绿色方块设置：</p>
<p><img src="/img/Unity/RenderOrder/ZOnDefaultLayer2501GreenSetting.PNG" alt="ZOnDefaultLayer2501GreenSetting"></p>
<p>Game渲染结果：</p>
<p><img src="/img/Unity/RenderOrder/SortingLayerAndRenderQueueResultPreview.PNG" alt="SortingLayerAndRenderQueueResultPreview"></p>
<p>从上面的测试可以看到:</p>
<ol>
<li><strong>同时开启ZWrite和ZTest，当物体都是不透明物体时Sorting Layer设置优先于RenderQueue</strong></li>
<li><strong>同时开启ZWrite和ZTest，一个为不透明物体一个为透明物体时，透明物体在不透明物体之后渲染，此时RenderQueue的影响优先与Sorting Layer</strong></li>
</ol>
<p>Note:</p>
<ol>
<li><strong>RenderQueue 2500是不透明物体(&lt;&#x3D;2500)和透明物体(&gt;2500)的分界线</strong></li>
</ol>
<h2 id="Sorting-Order-VS-RenderQueue"><a href="#Sorting-Order-VS-RenderQueue" class="headerlink" title="Sorting Order VS RenderQueue"></a>Sorting Order VS RenderQueue</h2><p>那么Sorting Order和RenderQueue在渲染顺序里谁的优先级更高了？</p>
<p>在前面我们了解到RenderQueue会影响物体处于透明或不透明渲染队列里，所以</p>
<p><strong>不透明物体 &gt; 透明物体</strong></p>
<p><strong>同为不透明物体或透明物体时，Sorting Order&gt; RenderQueue</strong></p>
<p>这里我就不一一截图单个物体材质设置了，通过材质球名字就能看出我的测试单元设置:</p>
<p><img src="/img/Unity/RenderOrder/AllSortingOrderAndRenderQueueSetting.PNG" alt="AllSortingOrderAndRenderQueueSetting"></p>
<p><strong>ZOnSortingOrder10GreenMaterial2000</strong> VS <strong>ZOnSortingOder5RedMaterial2005</strong> VS <strong>ZOnSortingOrder1BlueMaterial2009</strong></p>
<p><img src="/img/Unity/RenderOrder/SortingOrderAndRenderQueueResultPreview1.PNG" alt="SortingOrderAndRenderQueueResultPreview1"></p>
<p>从上面测试结果可以看看出:</p>
<ol>
<li><strong>同为不透明物体状态下，Sorting Order &gt; RenderQueue，而不是Sorting Order+RenderQueue的值决定的</strong></li>
</ol>
<p><strong>ZOnSortingOrder6BlueMaterial2100</strong> VS <strong>ZOnSortingOrder7GreenMaterial2000</strong></p>
<p><img src="/img/Unity/RenderOrder/SortingOrderAndRenderQueueResultPreview2.PNG" alt="SortingOrderAndRenderQueueResultPreview2"></p>
<p>从上面测试结果可以看看出:</p>
<ol>
<li><strong>不透明物体 &gt; 透明物体依然适用</strong></li>
</ol>
<h1 id="学习总结"><a href="#学习总结" class="headerlink" title="学习总结"></a>学习总结</h1><p>渲染顺序优先级：</p>
<p>大的优先级如下：</p>
<p><strong>Camera.depth &gt; Material type((RenderQueue不透明 &gt; RenderQueue透明) ) &gt; SortingLayer&gt; SortingOrder &gt; RenderQueue</strong></p>
<p>其他规则：</p>
<p><strong>如果开启了ZTest和ZWrite，可不管物件绘制順序 (rendering order)，使得里摄像机越近的物件，永远都绘制在其他离摄像机越远的物件之前 (<code>ZTest LEqual</code>)。</strong></p>
<p><strong>同为不透明物体或透明物体时，Sorting Layer &gt; RenderQueue</strong></p>
<h1 id="Github"><a href="#Github" class="headerlink" title="Github"></a>Github</h1><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a target="_blank" rel="noopener" href="https://dev.twsiyuan.com/2018/05/unity-rendering-order.html">Unity rendering order 整理筆記</a></p>
<p><a target="_blank" rel="noopener" href="https://qxsoftware.github.io/Unity-Rendering-Order.html">Unity 渲染顺序详解</a></p>
<p><a target="_blank" rel="noopener" href="https://www.bzetu.com/207/.html">Unity渲染顺序(Queue,ZWrite,ZTest)</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/lyh916/article/details/45317571">[UnityShader]渲染队列、ZWrite和ZTest</a></p>
<p><a target="_blank" rel="noopener" href="https://medium.com/ericzhan-publication/shader%E7%AD%86%E8%A8%98-%E9%80%8F%E6%98%8E%E7%89%A9%E9%AB%94-z-test-z-write-z-buffer-alpha-blending-692c60d9b605">[Shader筆記]透明物體(Z-Test、Z-Write、Z-Buffer、Alpha Blending)</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Rendering/">Rendering</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Rendering/">Rendering</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2026/01/12/Copilot/" title="Copilot" itemprop="url">Copilot</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Tony Tang" target="_blank" itemprop="author">Tony Tang</a>
		
  <p class="article-time">
    <time datetime="2026-01-12T04:00:00.000Z" itemprop="datePublished"> 发表于 2026-01-12</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>AI编程工具盛行，学习AI编程工具的使用和底层原理是很有必要的，在<a href="">AI工具</a>通过多方面考量和对比市面上的AI编程工具，决定选择Copilot作为深入AI编程学习的切入口，本章节是为了详细记录AI编程工具的使用和深入学习AI编程相关概念。</p>
<h2 id="Copilot"><a href="#Copilot" class="headerlink" title="Copilot"></a>Copilot</h2><p><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/GitHub_Copilot"><strong>GitHub Copilot</strong>是GitHub和OpenAI合作开发的一个人工智能工具，用户在使用Visual Studio Code、Microsoft Visual Studio、Vim、Cursor或JetBrains集成开发环境时可以通过GitHub Copilot自动补全代码。Copilot的OpenAI Codex接受了一系列英语语言、公共 GitHub 存储库和其他公开可用源代码的训练。这包括来自 5400 万个公共 GitHub 存储库的 159 GB Python 代码的过滤数据集。</a></p>
<p>从介绍可以看出Copilot主打的是基于代码的学习，提供代码AI自动补全的功能。</p>
<p>Copilot是微软旗下的，所以对Visual Studio，VS Code等微软<strong>IDE支持比较完善</strong>，下载VS时就自带集成Copilot。</p>
<p><strong>支持基于Github大量代码学习的代码智能推断补全，支持Agent聊天问答，支持多个模型选择，支持代码Review等功能。</strong></p>
<p>优势：</p>
<ol>
<li><strong>不用切换IDE，直接嵌入各大主流IDE</strong></li>
<li><strong>微软官方支持且基于Github的大量代码知识</strong></li>
</ol>
<p>Note:</p>
<ol>
<li><strong>Copilot基础版免费，Pro版需要付费购买(10美元每月-个人推荐这个)，Pro+(39美元每月)[<a target="_blank" rel="noopener" href="https://visualstudio.microsoft.com/zh-hans/vs/pricing/?tab=paid-subscriptions%5D)%E3%80%82">https://visualstudio.microsoft.com/zh-hans/vs/pricing/?tab=paid-subscriptions])。</a></strong></li>
</ol>
<h2 id="Copilot安装"><a href="#Copilot安装" class="headerlink" title="Copilot安装"></a>Copilot安装</h2><ol>
<li><p>官方下载带Copilot的Visual Studio 2022[<a target="_blank" rel="noopener" href="https://visualstudio.microsoft.com/github-copilot/]">https://visualstudio.microsoft.com/github-copilot/]</a></p>
</li>
<li><p>新建工程</p>
</li>
<li><p>右上角点击Github Copilot-&gt;打开聊天框</p>
</li>
</ol>
<p><img src="/img/AI/AITools/Copilot/CopilotEntry.PNG" alt="CopilotEntry"></p>
<p>Note:</p>
<ol>
<li><strong>Ctrl+Alt+L快捷键打开VSCode Copilot Chat</strong></li>
</ol>
<h2 id="Completions"><a href="#Completions" class="headerlink" title="Completions"></a>Completions</h2><p>敲击代码，Copilot会根据代码智能推断即将编写的代码，敲击tab应用智能推断的代码</p>
<p><img src="/img/AITools/Copilot/IntelligentPrompt.PNG" alt="IntelligentPrompt"></p>
<p>敲击注释，Copilot也会根据注释去推断即将编写的代码，敲击tab应用智能推断的代码</p>
<p><img src="/img/AITools/Copilot/IntelligentPromptFromNotation.PNG" alt="IntelligentPromptFromNotation"></p>
<p>只接受一部分Copilot智能推断的代码，Windows上Ctrl+→按键</p>
<p><img src="/img/AITools/Copilot/AcceptPartOfIntelligentPrompt.PNG" alt="AcceptPartOfIntelligentPrompt"></p>
<p><strong>决定不启用智能推断的代码，点击Esc按键</strong></p>
<h2 id="Prompt"><a href="#Prompt" class="headerlink" title="Prompt"></a>Prompt</h2><p>**Prompt(提示词)**可以帮助AI更加准确的理解我们的需求，给出更更准确的代码推断和需求编写。</p>
<p>前面的Completions提到注释描述给AI提示，以及Chat中提到针对<strong>代码片段的提问(Alt+I)</strong>，在提问时我们通过自然语言准确描述需求比泛化的描述可以更加准确的让AI理解我们给出的指令，得到更准确的目标结果。</p>
<p>泛化的Prompt，比如注释描述”&#x2F;&#x2F; Some Code”</p>
<p>此时无论是AI还是人其实都无法理解我们具体想做什么，所以AI并没与给出任何有效的代码推断</p>
<p><img src="/img/AI/AITools/Copilot/BadPrompt.PNG" alt="BadPrompt"></p>
<p>好的Prompt，比如注释描述”&#x2F;&#x2F; define a function that is used to compare to int value”</p>
<p><img src="/img/AI/AITools/Copilot/GoodPrompt.PNG" alt="GoodPrompt"></p>
<p>可以看到好的提示词成功让AI理解了需求并给出了准确的推断编写代码。</p>
<h2 id="Chat"><a href="#Chat" class="headerlink" title="Chat"></a>Chat</h2><p>聊天模式氛围Ask Mode和Agent Mode</p>
<p>聊天模式切换:</p>
<p><img src="/img/AI/AITools/Copilot/AgentModeChosen.PNG" alt="AgentModeChosen"></p>
<h3 id="Ask-Mode"><a href="#Ask-Mode" class="headerlink" title="Ask Mode"></a>Ask Mode</h3><p>AI提问模式交互，打开Copilot后，右下方有聊天窗口</p>
<p><img src="/img/AI/AITools/Copilot/CopilotInteraction.PNG" alt="CopilotInteraction"></p>
<p>点击代码块右上方的应用则可以将Copilot生成的代码生成到我们的代码里</p>
<p><img src="/img/AI/AITools/Copilot/AICodeApply.PNG" alt="AICodeApply"></p>
<p>在代码区点击**放弃(Alt+Del)**则可以放弃方才应用的代码</p>
<p><img src="/img/AI/AITools/Copilot/AICodeGiveUp.PNG" alt="AICodeGiveUp"></p>
<p>代码块交互聊天，选中需要询问的代码，按Alt+&#x2F;</p>
<p><img src="/img/AI/AITools/Copilot/CodeSnippetChat.PNG" alt="CodeSnippetChat"></p>
<p>交互聊天有一系列的快捷操作指令</p>
<p>输入@会看到几个大方向或内容给AI作为参考</p>
<p><img src="/img/AI/AITools/Copilot/AtQuickCommand.PNG" alt="AtQuickCommand"></p>
<p>输入#会看到可以在询问前添加相关文件作为给AI的参考文件</p>
<p><img src="/img/AI/AITools/Copilot/NumberSighQuickCommand.PNG" alt="NumberSighQuickCommand"></p>
<p>输入&#x2F;会看到有内置支持的快捷代码操作指令(比如fix,optimization……)</p>
<p><img src="/img/AI/AITools/Copilot/SlashQuickCommand.PNG" alt="SlashQuickCommand"></p>
<p>想引入更多复杂类型的资源作为AI参考文件，可以通过+添加:</p>
<p><img src="/img/AI/AITools/Copilot/AddReferenceAttach.PNG" alt="AddReferenceAttach"></p>
<p>自动以快捷交互指令详情参考:</p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/visualstudio/ide/copilot-chat-context?view=vs-2022">Customize chat responses and set context</a></p>
<h3 id="Agent-Mode"><a href="#Agent-Mode" class="headerlink" title="Agent Mode"></a>Agent Mode</h3><p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/visualstudio/ide/copilot-agent-mode?view=vs-2022">With the GitHub Copilot agent mode in Visual Studio, you can use natural language to specify a high-level task. AI creates a plan, makes code edits, runs terminal commands, invokes tools, and applies changes across your codebase. It monitors outcomes, such as build results, unit-test failures, or tool outputs, and iterates as needed.</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/visualstudio/ide/copilot-agent-mode?view=vs-2022">Unlike <em>ask mode</em>, agent mode doesn’t stop after a single response. It continues running and refining steps until you reach the goal in your prompt or more input is required.</a></p>
<p>从介绍可以看出Copilot Agent Mode可以让我们通过自然语言区描述高阶任务需求，让AI使用特定工具自动化完成高阶任务需求。</p>
<p>Agent Mode工具选择:</p>
<p><img src="/img/AI/AITools/Copilot/AgentModeToolsChosen.PNG" alt="AgentModeToolsChosen"></p>
<p>比如指挥Copilot调用指定方法并应用代码。</p>
<p><img src="/img/AI/AITools/Copilot/FirstAgenModeUsing.PNG" alt="FirstAgenModeUsing"></p>
<p><strong>相比Ask Mode生成的代码我们要选择应用，Agent Mode已经通过我的指令自动应用到了Program.cs文件里，同时Agent Mode还通过调用编译进行了生成代码的对错验证(工具自动化的使用是和Ask Mode的最大区别)。</strong></p>
<p>Agent Mode可以通过选择保留和放弃去确认生成代码的去留。</p>
<p>当成功应用后，Copilot通过创建<strong>还原点，可以实现快速的放弃之前的操作</strong></p>
<p><img src="/img/AI/AITools/Copilot/RevertAIAction.PNG" alt="RevertAIAction"></p>
<p>Note:</p>
<ol>
<li><strong>需要使用一些列工具进行自动化的操作推荐用Agent Mode</strong></li>
<li><strong>需要使用MCP Servers功能，必须使用Agent Mode而非Ask Mode</strong></li>
</ol>
<h3 id="MCP"><a href="#MCP" class="headerlink" title="MCP"></a>MCP</h3><p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/visualstudio/ide/mcp-servers?view=vs-2022">Model Context Protocol (MCP) is an open standard that enables AI models to interact with external tools and services through a unified interface.</a></p>
<p><a target="_blank" rel="noopener" href="https://modelcontextprotocol.io/docs/getting-started/intro">Using MCP, AI applications like Claude or ChatGPT can connect to data sources (e.g. local files, databases), tools (e.g. search engines, calculators) and workflows (e.g. specialized prompts)—enabling them to access key information and perform tasks.</a></p>
<p>从介绍可以看出MCP是AI模型和外部工具交互的标准。</p>
<p>如果想通过外部工具扩展Agent Mode工作流，可以通过MCP引入外部工具。</p>
<p><img src="/img/AI/AITools/MCP/MCPWorkFlow.PNG" alt="MCPWorkFlow"></p>
<p>通过调用外部工具和数据，我们就能实现更多的功能，无论是简单的周报总结，自动化测试，2D或3D模型资源生成等都成为了可能。</p>
<p>简单了解下MCP里的核心组成部分：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://modelcontextprotocol.io/docs/learn/architecture"><strong>MCP Host</strong>: The AI application that coordinates and manages one or multiple MCP clients</a>(一个用于管理和协调多个MCP客户端AI宿主程序，比如VSCode，Cursor，CLAUDE CODE等)</li>
<li><a target="_blank" rel="noopener" href="https://modelcontextprotocol.io/docs/learn/architecture"><strong>MCP Client</strong>: A component that maintains a connection to an MCP server and obtains context from an MCP server for the MCP host to use</a>(MCP客户端，一个负责维护MPC服务器连接的组件，通过MCP服务器为MCP宿主用户获取环境上下文等)</li>
<li><a target="_blank" rel="noopener" href="https://modelcontextprotocol.io/docs/learn/architecture"><strong>MCP Server</strong>: A program that provides context to MCP clients</a>(MCP服务器，一个给MCP客户端提供环境上下文的程序)</li>
</ul>
<p>简单了解下MCP的分层设计：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://modelcontextprotocol.io/docs/learn/architecture"><strong>Data layer</strong>: Defines the JSON-RPC based protocol for client-server communication, including lifecycle management, and core primitives, such as tools, resources, prompts and notifications.</a>(数据层，用于定义MCP客户端和MCP服务器的JSON数据远程调用协议相关(比如数据生命周期管理，资源，工具等))</li>
<li><a target="_blank" rel="noopener" href="https://modelcontextprotocol.io/docs/learn/architecture"><strong>Transport layer</strong>: Defines the communication mechanisms and channels that enable data exchange between clients and servers, including transport-specific connection establishment, message framing, and authorization.</a>(传输层，用于定义MCP客户端和MCP服务器的数据交换相关(比如数据传输协议，授权等))</li>
</ul>
<p>MCP的详细设计这里暂时不深入追究，暂时知道MCP是一套通用的AI模型嗯哼外部工具交互的标准即可。</p>
<p>详情参考:</p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/visualstudio/ide/mcp-servers?view=vs-2022">Use MCP servers</a></p>
<p>因为本人只买了Copilot Pro，没有买Claude Code付费版本，所以接下来MCP和Agent Skills都已Copilot使用学习说明。</p>
<h4 id="Extending-Copilot-MCP-Servers"><a href="#Extending-Copilot-MCP-Servers" class="headerlink" title="Extending Copilot MCP Servers"></a>Extending Copilot MCP Servers</h4><p>查看可用的MCP servers repository:</p>
<p><a target="_blank" rel="noopener" href="https://github.com/modelcontextprotocol/servers/tree/main">Model Context Protocol servers</a></p>
<p>支持搜索支持的MCP servers repository:</p>
<p><a target="_blank" rel="noopener" href="https://registry.modelcontextprotocol.io/">Official MCP Registry</a></p>
<p>给VS Codo配置MCP servers要求VS Code版本大于1.99(感觉官方版本写错了，目前最新才1.108–2026&#x2F;1&#x2F;12)</p>
<p>MPC servers配置有两种方式：</p>
<ol>
<li>Using GitHub MCP Registery(<strong>这种方式只有MCP servers在MCP Registery的才能配置</strong>)</li>
<li>Configuring MCP servers manually(<strong>这种方式可以自由配置MCP Server</strong>)</li>
</ol>
<h5 id="Using-GitHub-MCP-Registery"><a href="#Using-GitHub-MCP-Registery" class="headerlink" title="Using GitHub MCP Registery"></a>Using GitHub MCP Registery</h5><p>使用GitHub MCP Registery步骤:</p>
<ol>
<li><p>打开VSCode</p>
</li>
<li><p>ctrl+shift+x打开插件界面</p>
</li>
<li><p>过滤选择里选择MCP Register</p>
<p><img src="/img/AI/AITools/MCP/VSCodeMCPFilter.PNG" alt="VSCodeMCPFilter"></p>
</li>
<li><p>然后直接再搜索里搜索想找的MCP Server，如果是第一次打开还需要先开启MCP Servers MarketPlace</p>
<p><img src="/img/AI/AITools/MCP/EnableMCPServersMarketplace.PNG" alt="EnableMCPServersMarketplace"></p>
</li>
<li><p>接下来搜索一个想找的MCP Server</p>
<p><img src="/img/AI/AITools/MCP/VSCodeCopilotGitHubMCPRegisteryInstall.PNG" alt="VSCodeCopilotGitHubMCPRegisteryInstall"></p>
</li>
<li><p>这里点击Install即可安装对应MCP Server</p>
</li>
</ol>
<p>这里我尝试安装MarkDown MCP Server但运行失败了:</p>
<ul>
<li><p>发现Markitdown MCP Server安装后启动失败了，原因是uvx安装没成功</p>
<p><img src="/img/AI/AITools/MCP/MarkitdownMCPServerInstallFailed.PNG" alt="MarkitdownMCPServerInstallFailed"></p>
</li>
<li><p>我们通过uv官网的教程，在PowerShell里输入一下命令安装uvx:</p>
<p>“powershell -ExecutionPolicy ByPass -c “irm <a target="_blank" rel="noopener" href="https://astral.sh/uv/install.ps1">https://astral.sh/uv/install.ps1</a> | iex””</p>
<p><img src="/img/AI/AITools/MCP/InstallUvxInPowerShell.PNG" alt="InstallUvxInPowerShell"></p>
<p><strong>安装后需要自己设置uvx的环境变量，按安装后的提示输入命令或手动添加环境变量即可，后续VSCode里还是找不到注意重新打开VSCode。</strong></p>
<ul>
<li>安装Uvx成功后，发现Markitdown还是运行不起来，于是我让Copilot Agent帮我分析原因，它通过调用”uvx markitdown –help”命令把所有相关的Python库都下载下来了。</li>
</ul>
<p><img src="/img/AI/AITools/MCP/UvxPythonInstallation.PNG" alt="UvxPythonInstallation"></p>
</li>
<li><p>但最后依然运行不成功Markitdown，Copilot分析的结论是Python版本不对，为避免多个Python版本安装后出问题，这里不再继续了。</p>
<p><img src="/img/AI/AITools/MCP/UvxStartPythonVersionProblem.PNG" alt="UvxStartPythonVersionProblem"></p>
</li>
</ul>
<p>接下来以安装GitHub MCP Server为例:</p>
<ol>
<li><p>打开插件(ctrl+shift+x)</p>
</li>
<li><p>设置过滤为MCP Server</p>
</li>
<li><p>搜索GitHub</p>
</li>
<li><p>点击安装</p>
</li>
<li><p>输入GitHub Authentication token(在Github个人设置页面-&gt;Developer Settings-&gt;Tokens)</p>
<p><img src="/img/AI/AITools/MCP/GitHubPersonalAuthenticationTokenInput.PNG" alt="GitHubPersonalAuthenticationTokenInput"></p>
</li>
<li><p>在Copilot Chat下方打开MCP配置工具查看GitHub MCP Server配置的工具结合</p>
<p><img src="/img/AI/AITools/MCP/CopilotConfigureTools.PNG" alt="CopilotConfigureTools"></p>
<p>可以看到GitHub MCP Server已经添加成功，相关工具也支持在Agent模式下通过GitHub MCP Server选择使用了。</p>
</li>
<li><p>接下来验证下通过Copilot+GitHub MCP Server我们是否能快速通过AI操作Github仓库相关东西</p>
<p><img src="/img/AI/AITools/MCP/CommitReadMeFileByGitHubMCPServer.PNG" alt="CommitReadMeFileByGitHubMCPServer"></p>
<p>可以看到我们成功通过给Copilot输入命令，通过GitHub MCP Server的相关工具将README.md文件成功自动上传到了GitHub对应仓库。</p>
</li>
</ol>
<h5 id="Configuring-MCP-servers-manually"><a href="#Configuring-MCP-servers-manually" class="headerlink" title="Configuring MCP servers manually"></a>Configuring MCP servers manually</h5><p>VSCode支持两种MCP手动配置方式:</p>
<ol>
<li><strong>.vscode&#x2F;mcp.json用于给当前VSCode指定所有人能用的MCP服务器配置信息</strong></li>
<li><strong>%APPDATA%&#x2F;Code&#x2F;User&#x2F;settings.json里配置当前电脑通用的MCP服务器配置信息(但实际上我发现VSCode扩展里安装的好像是配置在%APPDATA%&#x2F;Code&#x2F;User&#x2F;mcp.json文件)</strong></li>
</ol>
<p>这里重点学习下第一种给工程手动配置MCP Server的方式</p>
<ol>
<li><p>在工程.vscode目录下新建mcp.json文件</p>
</li>
<li><p>打开mcp.json文件，点击Add Server按钮(<strong>VSCode提供了几种安装MCP的方式</strong>)</p>
<p><img src="/img/AI/AITools/MCP/WorkspaceMCPServerAdd.PNG" alt="WorkspaceMCPServerAdd"></p>
<p><img src="/img/AI/AITools/MCP/VSCodeMCPInstallationMethods.PNG" alt="VSCodeMCPInstallationMethods"></p>
</li>
<li><p>这里使用手动添加mcp.json描述的方式</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;servers&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;filesystem&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;command&quot;</span><span class="punctuation">:</span> <span class="string">&quot;npx&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;args&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="string">&quot;-y&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;@modelcontextprotocol/server-filesystem&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;$&#123;workspaceFolder&#125;&quot;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>添加配置后会在对应Servers名字上方看到启动MCP Server的按钮</p>
<p><img src="/img/AI/AITools/MCP/StartFileSystemMCPServer" alt="StartFileSystemMCPServer"></p>
</li>
<li><p>打开Copilot的Configure Tools可以看到我们成功运行FileSystem MCP Server后相关工具都被使用了</p>
<p><img src="/img/AI/AITools/MCP/FileSystemTools.PNG" alt="FileSystemTools"></p>
</li>
<li><p>接下来通过Copilot进行验证FileSytem MCP Server被正确安装和使用(将.vscode&#x2F;mcp.json和***&#x2F;User&#x2F;mcp.json作为上下文文件进行提问)</p>
<p><img src="/img/AI/AITools/MCP/CreateMCPServerIntroductionByFileSystem.PNG" alt="CreateMCPServerIntroductionByFileSystem"></p>
<p><img src="/img/AI/AITools/MCP/MCPMarkDown.PNG" alt="MCPMarkDown"></p>
<p><img src="/img/AI/AITools/MCP/MCPServerMarkdownContent.PNG" alt="MCPServerMarkdownContent"></p>
<p><strong>上面这个例子因为有一些默认工具支持了目录的创建和文件的创建读写，导致并没有直接使用FileSystem MCP Server的相关工具</strong></p>
</li>
<li><p>显示指定使用create_directory工具创建一个FileSystemCreatedDirectory目录</p>
<p><img src="/img/AI/AITools/MCP/CreateDirectoryByUsingFileSystemMCPServerTool.PNG" alt="CreateDirectoryByUsingFileSystemMCPServerTool"></p>
<p><img src="/img/AI/AITools/MCP/FileSystemCreatedDirectory.PNG" alt="FileSystemCreatedDirectory"></p>
<p>可以看到通过#显示的指定工具名，我们成功使用了FileSystem MCP Server的create_directory工具创建了名为FileSystemCreatedDirectory目录。</p>
</li>
</ol>
<p>Note:</p>
<ol>
<li><strong>官方推荐相同MCP Server只在全局或本地一处添加，避免冲突</strong></li>
<li><strong>.vscode&#x2F;mcp.json当前VSCode级别的MCP也可以通过浏览扩展里的MCP进行安装</strong></li>
<li><strong>MCP Server无需一开始就启动，当需要触发相关工具时，对应MCP Server会自动启动</strong></li>
<li><strong>Copilot CLI和VS Code Copilot是独立的工具，他们不会共享MCP Server配置</strong></li>
</ol>
<h3 id="Coding-Agent"><a href="#Coding-Agent" class="headerlink" title="Coding Agent"></a>Coding Agent</h3><p><a target="_blank" rel="noopener" href="https://docs.github.com/en/copilot/concepts/agents/coding-agent/about-coding-agent">With Copilot coding agent, GitHub Copilot can work independently in the background to complete tasks, just like a human developer.</a></p>
<p>从介绍可以看出Coding Agent可以用于像人工一样自动化完成任务。</p>
<p><a target="_blank" rel="noopener" href="https://docs.github.com/en/copilot/concepts/agents/coding-agent/about-coding-agent">Copilot coding agent is distinct from the “agent mode” feature available in your IDE. Copilot coding agent works autonomously in a GitHub Actions-powered environment to complete development tasks assigned through GitHub issues or GitHub Copilot Chat prompts, and creates pull requests with the results. In contrast, agent mode in your IDE makes autonomous edits directly in your local development environment.</a></p>
<p>相比Agent Mode，Coding Agent能独立于IDE在Github环境下运行完成任务。</p>
<p>更多了解:</p>
<p>TODO</p>
<p>Note:</p>
<ol>
<li><strong>Coding Agent是付费功能(Pro或Pro+等)</strong></li>
</ol>
<h3 id="Copilot-Skills"><a href="#Copilot-Skills" class="headerlink" title="Copilot Skills"></a>Copilot Skills</h3><p>TODO</p>
<h3 id="多模型选择"><a href="#多模型选择" class="headerlink" title="多模型选择"></a>多模型选择</h3><p>​		打开Copilot聊天框正下方有底层AI模型选择</p>
<p>​		<img src="/img/AI/AITools/Copilot/ChangeAIModel.PNG" alt="ChangeAIModel"></p>
<h3 id="Code-Review"><a href="#Code-Review" class="headerlink" title="Code Review"></a>Code Review</h3><p>通常合作开发时，提交代码时代码review以往都是人工查看的，有了AI工具，Code Review也能实现AI自动化分析。</p>
<p>Visual Studio Code Review步骤:</p>
<ol>
<li><p>Github创建不同分支并推上去</p>
</li>
<li><p>在对应分支进行修改并提交</p>
</li>
<li><p>在Github上或者Git发出Pull Request请求</p>
<p><img src="/img/AI/AITools/Copilot/GithubPullRequestOperation.PNG" alt="GithubPullRequestOperation"></p>
</li>
<li><p>在Github上Pull Request操作发起Copilot Review请求</p>
<p><img src="/img/AI/AITools/Copilot/CopilotReviewRequest.PNG" alt="CopilotReviewRequest"></p>
</li>
<li><p>等待AI Copilot Review完成则可看到AI Review结论</p>
<p><img src="/img/AI/AITools/Copilot/CopilotReviewResult.PNG" alt="CopilotReviewResult"></p>
</li>
</ol>
<p>Note:</p>
<ol>
<li><strong>Code Review是付费功能(Pro或Pro+等)</strong></li>
</ol>
<h3 id="Copilot-CLI"><a href="#Copilot-CLI" class="headerlink" title="Copilot CLI"></a>Copilot CLI</h3><p><a target="_blank" rel="noopener" href="https://docs.github.com/en/copilot/how-tos/use-copilot-agents/use-copilot-cli">The command-line interface (CLI) for GitHub Copilot allows you to use Copilot directly from your terminal.</a></p>
<p>Copilot CLI允许通过命令行界面使用Copilot，这一点很像Claude Code。</p>
<p>Copilot CLI安装:</p>
<ol>
<li><p>打开PowerSheel(Windows)</p>
</li>
<li><p>输入 winget install GitHub.Copilot</p>
<p><img src="/img/AI/AITools/Copilot/CopilotCLIInstallation.PNG" alt="CopilotCLIInstallation"></p>
</li>
</ol>
<p>Copilot CLI使用：</p>
<ol>
<li><p>在需要Copilot CLI访问的目录下打开PowerShell输入Copilot命令</p>
<p><img src="/img/AI/AITools/Copilot/StartCopilotCLI.PNG" alt="StartCopilotCLI"></p>
</li>
<li><p>选择选项1(Yes)–表明信任Copilot CLI对当前目录的修改</p>
</li>
<li><p>输入&#x2F;login(输入后按照操作流程一步一步登录账号即可) – 登录Github账号开始使用Copilot(本人买的Copilot Pro)</p>
<p><img src="/img/AI/AITools/Copilot/LoginCopilotCLI.PNG" alt="LoginCopilotCLI"></p>
</li>
<li><p>在Copilot里输入&#x2F;help就可以像常规命令行一样看到所有可使用的命令介绍了</p>
<p><img src="/img/AI/AITools/Copilot/HelpCommand.PNG" alt="HelpCommand"></p>
</li>
<li><p>可以看到如果AI模型没选对，我们可以输入&#x2F;model进入模型切换(<strong>部分AI模型需要Github Copilot后台开启才能使用</strong>)</p>
<p><img src="/img/AI/AITools/Copilot/ChangeAIModel.PNG" alt="ChangeAIModel"></p>
</li>
<li><p>提交Git采用人类语言描述即可</p>
<p><img src="/img/AI/AITools/Copilot/CopilotCLIGitPush.PNG" alt="CopilotCLIGitPush"></p>
<p>上传失败是因为命令行还没有配置SSH秘钥，这里需要安装<a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-server/administration/openssh/openssh_install_firstuse?tabs=powershell&pivots=windows-10">OpenSSH Client</a></p>
<p>PowerShell里输入”Get-Service ssh-agent”确认开启ssh-agent服务，如果未开启，输入”Start-Service ssh-agent”，如果开启报错，输入”Set-Service ssh-agent -StartupType Automatic”将ssh-agent的开启方式设置成自动，然后输入”ssh-add”输入SSH的秘钥即可</p>
<p><img src="/img/AI/AITools/Copilot/OpenSSHClientAndSshAdd.PNG" alt="OpenSSHClientAndSshAdd"></p>
<p>然后我们再次测试Copilot的Git上传，发现还是上传不了，询问Copilit说是Copilot CLI默认使用的不是SSH KEY而是HTTPS，需要安装GitHub CLI(<strong>输入”winget install –id GitHub.cli -e”命令安装</strong>)然后使用gh相关命令(<strong>输入”gh auth login”命令登录</strong>)登录GitHub授权(<strong>注意网页版通过授权，网页版要求填的码需要Ctrl+R或者Ctrl+O打开Copilot的详情信息才能看到</strong>)</p>
<p><img src="/img/AI/AITools/Copilot/GitHubCLILogin.PNG" alt="GitHubCLILogin"></p>
<p>然后我们再次测试Copilot的Git上传，这次终于通过Copilot上传GitHub成功了</p>
<p><img src="/img/AI/AITools/Copilot/CopilotGitHubCommitAndPush.PNG" alt="CopilotGitHubCommitAndPush"></p>
</li>
</ol>
<p>Copilot CLI使用详情参考:</p>
<p><a target="_blank" rel="noopener" href="https://docs.github.com/en/copilot/how-tos/use-copilot-agents/use-copilot-cli">Using GitHub Copilot CLI</a></p>
<p>命令行查看Token使用情况:</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/context</span><br></pre></td></tr></table></figure>

<p><img src="/img/AI/AITools/Copilot/CopilotContextInfo" alt="CopilotContextInfo"></p>
<p>命令行查看CLI所有操作介绍:</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/help</span><br></pre></td></tr></table></figure>

<p><img src="/img/AI/AITools/Copilot/CopilotHelpInfo" alt="CopilotHelpInfo"></p>
<p>Note:</p>
<ol>
<li><strong>Copilot CLI是付费功能(Pro或Pro+等)</strong></li>
<li><strong>部分功能可能要求PowerShell版本大于6，需要自己去装一个最新的PowerShell版本</strong></li>
<li><strong>OpenSSH Client的安装和SSH配置要用管理员身份打开PowerShell(版本大于6)</strong></li>
<li><strong>Copilot等待操作时，Ctrl+C是退出，Ctrl+R是打开最近输出，Ctrl+O是打开所有输出，Ctrl+T是显示原因</strong></li>
<li><strong>如果不希望Copilot每次关键时候询问是否继续，可以输入–allow-all-tools允许所有工具自动执行，或者–allow-tool允许特定工具执行，或者–deny-tool阻止特定工具执行</strong></li>
</ol>
<h4 id="Copilot-CLI-MCP-Server"><a href="#Copilot-CLI-MCP-Server" class="headerlink" title="Copilot CLI MCP Server"></a>Copilot CLI MCP Server</h4><p><strong>Copilot CLI和VS Code Copilot的MCP Server是独立添加的，但添加MCP Server的逻辑和VSCode Copilot MCP Server添加是相同的，只是保存的目录位置不同(目录C:&#x2F;User&#x2F;UserName&#x2F;.copilot&#x2F;mcp-config.json)</strong></p>
<p>Copilot CLI里添加MCP Server是通过输入”<strong>&#x2F;mcp add</strong>“命令：</p>
<p><img src="/img/AI/AITools/Copilot/CopilotCLIAddMCP.PNG" alt="CopilotCLIAddMCP"></p>
<p><strong>Server Name</strong> – 取一个本地添加MCP Server的对应名字(必填)</p>
<p><strong>Server Type</strong> – MCP Server连接类型(<strong>stdio(Standard I&#x2F;O)多用于本地MCP Server。http(Hypertext Transfer Protocol)多用于网络远程MCP Server。sse(Server-Send Events)http不支持时的一种fallback方案</strong>)</p>
<p><strong>Command</strong> – 启动MCP Server的执行程序命令(<strong>含命令执行参数，本地MCP Server才需要的启动命令</strong>)(最后在mcp.json里会自动拆分成command和args两个变量)</p>
<p><strong>Enviroment Variables</strong> – 传递个MCP Server的环境变量数据(<strong>本地MCP Server才需要</strong>)</p>
<p><strong>URL</strong> – 远程MCP Server的URL地址(<strong>远程MCP Server才需要</strong>)</p>
<p><strong>Http Headers</strong> – 远程MCP Server请求时带的参数数据(比如GitHub秘钥)</p>
<p><strong>Tools</strong> – MCP Server需要激活的工具(本地和远程MCP Server都需要)</p>
<p>参数详细介绍:</p>
<p><a target="_blank" rel="noopener" href="https://docs.github.com/en/copilot/how-tos/use-copilot-agents/coding-agent/extend-coding-agent-with-mcp#writing-a-json-configuration-for-mcp-servers">MCP</a></p>
<ul>
<li><p>添加MicrosoftLearn MCP Server(输入**&#x2F;mcp add**然后填充以下信息)</p>
<p><img src="/img/AI/AITools/Copilot/MicrosoftLearnMCPServerAdd.PNG" alt="MicrosoftLearnMCPServerAdd"></p>
<p>MicrosoftLearn MCP Server使用测试:</p>
<p><img src="/img/AI/AITools/Copilot/MicrosoftLearnMCPServerUsingTest.PNG" alt="MicrosoftLearnMCPServerUsingTest"></p>
</li>
<li><p>添加GitHub MCP Server(输入**&#x2F;mcp add**然后填充以下信息)</p>
<p><img src="/img/AI/AITools/Copilot/GitHubMCPServerAdd.PNG" alt="GitHubMCPServerAdd"></p>
<p>GitHub MCP Server使用测试:</p>
<p><img src="/img/AI/AITools/Copilot/GitHubMCPServerUsingTest.PNG" alt="GitHubMCPServerUsingTest"></p>
</li>
<li><p>添加FileSystem MCP Server(输入**&#x2F;mcp add**然后填充以下信息)</p>
<p><img src="/img/AI/AITools/Copilot/FileSystemMCPServerAdd.PNG" alt="FileSystemMCPServerAdd"></p>
<p>FileSystem MCP Server使用测试(<strong>Copilot CLI里无法通过描述使用stdio本地添加的MCP Server工具，只能直接指明使用</strong>):</p>
<p><img src="/img/AI/AITools/Copilot/FileSystemMCPServerUsingTest.PNG" alt="FileSystemMCPServerUsingTest"></p>
</li>
</ul>
<p>Note:</p>
<ol>
<li><strong>Copilot CLI的MCP Server添加时，不是所有的MCP Server都通过Http方式远程添加，也可以通过stdio本地添加的方式。</strong></li>
<li><strong>stdio本地添加的方式不能直接通过Copilot CLI描述触发，需要直接输入”@MCP名.工具名 参数”的方式直接触发</strong></li>
<li><strong>Copilot CLI里@除了指明用某个文件，还能@MCP名.工具名 参数的方式指定使用MCP的工具</strong></li>
<li><em><em>所有Copilot CLI需要访问的目录必须确保授权访问，除了默认打开所在目录和</em>&#x2F;Local&#x2F;Temp目录默认授权外，其他目录都要通过&#x2F;add-dir进行授权添加</em>*</li>
<li><strong>通过&#x2F;add-dir添加授权访问的目录暂时没有命令清除，只能通过重新开Copilot Session实现重置</strong></li>
</ol>
<h3 id="Copilot付费"><a href="#Copilot付费" class="headerlink" title="Copilot付费"></a>Copilot付费</h3><p>Copilot有多个付费模式：</p>
<p>Free – **只允许使用优先功能(50次Agent Mode或Chat每月，2000次智能代码提示补全每月等)</p>
<p>Pro – <strong>无限次Agent Mode或Chat每月，无限次智能代码补全提示，更多AI模型选择，Code Review，Coding Agent等功能</strong></p>
<p>Pro+ – <strong>相比Pro更多的AI模型选择等</strong></p>
<p>Copilot付费支持的<strong>Visa</strong>卡好像要<strong>要求支持跨境汇款</strong>，<strong>PayPal</strong>这个我个人没有。</p>
<p>不同付费模式功能详情参考:</p>
<p><a target="_blank" rel="noopener" href="https://visualstudio.microsoft.com/github-copilot/">Github-copilot</a></p>
<h2 id="Github地址"><a href="#Github地址" class="headerlink" title="Github地址"></a>Github地址</h2><p>无</p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2>
        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/AI/">AI</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/AI/">AI</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2025/03/24/事件驱动行为树/" title="事件驱动行为树" itemprop="url">事件驱动行为树</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Tony Tang" target="_blank" itemprop="author">Tony Tang</a>
		
  <p class="article-time">
    <time datetime="2025-03-24T07:45:00.000Z" itemprop="datePublished"> 发表于 2025-03-24</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在学习了UIElement相关知识以后，实战实现一套基于事件驱动的行为树(用UIElement开发编辑器)作为目标，深入基于事件驱动的行为树设计和UIElement的深入使用，为未来实现引导节点编辑器等功能需求做准备。</p>
<h2 id="行为树"><a href="#行为树" class="headerlink" title="行为树"></a>行为树</h2><p><strong>行为树主要用于AI开发，将AI逻辑通过树状逻辑进行组装表达，可以方便的制作和调试AI。</strong></p>
<p><strong>常规的行为树中，每帧都要从根节点开始遍历行为树，而目的仅仅是为了得到最近激活的节点，这也是博主之前设计的基于Lua的简易行为树<a target="_blank" rel="noopener" href="https://github.com/TonyTang1990/BehaviourTreeForLua">BehaviourTreeForLua</a>的设计方案。</strong></p>
<p>但此方案会导致每帧大量的逻辑浪费(比如已经运行到很深很远的节点处，第二帧又会从头跑一次前面相关的逻辑判定)，这也是实现一个基于事件驱动的行为树的原因所在。</p>
<p><strong>基于事件的行为树设计是，我们不再每帧都从根节点去遍历行为树，而是维护一个调度器负责保存已激活的节点，当正在执行的行为终止时，由其父节点决定接下来的行为。</strong></p>
<h2 id="行为树节点编辑器"><a href="#行为树节点编辑器" class="headerlink" title="行为树节点编辑器"></a>行为树节点编辑器</h2><p>结合前面学习到关于GraphView的相关知识，在实战前再回顾下几个GraphView相关的重要概念：</p>
<ol>
<li>GraphView – Unity官方推出的一套编写节点边的通用节点编辑器编写的UI组件</li>
<li>Node – GraphView里的节点类型</li>
<li>Port – GraphView里的端口连线</li>
</ol>
<h3 id="节点设计"><a href="#节点设计" class="headerlink" title="节点设计"></a>节点设计</h3><p>设计之初是面向节点编辑器需求，为后续支持行为树编辑器，剧情编辑器，新手引导编辑器细分做准备，<strong>目前是面向事件驱动行为树编辑器来编写的</strong>。</p>
<p>BaseNode.cs(节点基类，标识GUID，根节点以及节点大类型分类)</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> BaseNode.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 节点基类</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BaseNode</span> : <span class="title">ScriptableObject</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 唯一ID</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;唯一ID&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> GUID;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 位置</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;位置&quot;</span>)</span>]</span><br><span class="line">    [<span class="meta">HideInInspector</span>]</span><br><span class="line">    <span class="keyword">public</span> Rect Position;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 节点描述</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;节点描述&quot;</span>)</span>]</span><br><span class="line">    [<span class="meta">HideInInspector</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Des = <span class="string">&quot;节点描述&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 是否是根节点</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">virtual</span> <span class="built_in">bool</span> EntryPoint</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 节点类型(子类重写自定义节点类型)</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">virtual</span> NodeType NodeType</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> NodeType.Composition;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 节点状态</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> NodeState NodeState</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>NodeType.cs(节点大类型，用于分类分列表显示)</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> NodeType.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 节点类型</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="built_in">enum</span> NodeType</span><br><span class="line">&#123;</span><br><span class="line">    Composition,               <span class="comment">// 行为树组合节点</span></span><br><span class="line">    Decoration,                <span class="comment">// 行为树装饰节点</span></span><br><span class="line">    Condition,                 <span class="comment">// 行为树条件节点</span></span><br><span class="line">    Action,                    <span class="comment">// 行为树行为节点</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>BaseCompositionNode.cs(组合节点抽象基类)</p>
<p>BaseDecorationNode.cs(装饰节点抽象基类)</p>
<p>BaseConditionNode.cs(条件节点抽象基类)</p>
<p>BaseActionNode.cs(行为节点抽象基类)</p>
<h3 id="节点选择列表设计"><a href="#节点选择列表设计" class="headerlink" title="节点选择列表设计"></a>节点选择列表设计</h3><p>UIBTGraphEditorWindow.cs(行为树图窗口类，未来扩展不同类型节点编辑器参考此代码即可)</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> UIBTGraphEditorWindow.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 行为树图窗口类</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UIBTGraphEditorWindow</span> : <span class="title">EditorWindow</span></span><br><span class="line">&#123;</span><br><span class="line">    ******    </span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 可用的节点类型列表</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> List&lt;NodeType&gt; mAvailableNodeTypeList;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 可用节点类型Map</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> Dictionary&lt;NodeType, NodeType&gt; mAvailableNodeTypeMap;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 节点类型和对应节点类型信息Map</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> Dictionary&lt;NodeType, List&lt;Type&gt;&gt; mNodeTypeTypeMap;</span><br><span class="line">    </span><br><span class="line">    ******</span><br><span class="line">    </span><br><span class="line">   <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 初始化节点数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">InitNodeDatas</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mAvailableNodeTypeList = GetInitAvalibleNodeTypeList();</span><br><span class="line">        InitNodeTypeDatas();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 获取初始化可用节点类型列表</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="title">List</span>&lt;<span class="title">NodeType</span>&gt; <span class="title">GetInitAvalibleNodeTypeList</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> List&lt;NodeType&gt;()</span><br><span class="line">        &#123;</span><br><span class="line">            NodeType.Dialogue,</span><br><span class="line">            NodeType.Composition,</span><br><span class="line">            NodeType.Decoration,</span><br><span class="line">            NodeType.Condition,</span><br><span class="line">            NodeType.Action,</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 初始化节点类型数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">InitNodeTypeDatas</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        InitAvalibleNodeTypeMapData();</span><br><span class="line">        InitNodeTypeTypeListData();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 初始化节点类型Map数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">InitAvalibleNodeTypeMapData</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mAvailableNodeTypeMap = <span class="keyword">new</span> Dictionary&lt;NodeType, NodeType&gt;();</span><br><span class="line">        <span class="keyword">foreach</span>(<span class="keyword">var</span> availableNodeType <span class="keyword">in</span> mAvailableNodeTypeList)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(!mAvailableNodeTypeMap.ContainsKey(availableNodeType))</span><br><span class="line">            &#123;</span><br><span class="line">                mAvailableNodeTypeMap.Add(availableNodeType, availableNodeType);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 初始化节点类型类型信息列表数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">InitNodeTypeTypeListData</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mNodeTypeTypeMap = <span class="keyword">new</span> Dictionary&lt;NodeType, List&lt;Type&gt;&gt;();</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> availableNodeType <span class="keyword">in</span> mAvailableNodeTypeList)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (!mNodeTypeTypeMap.ContainsKey(availableNodeType))</span><br><span class="line">            &#123;</span><br><span class="line">                mNodeTypeTypeMap.Add(availableNodeType, <span class="keyword">new</span> List&lt;Type&gt;());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> allNodeTypes = CommonGraphConst.BaseNodeAssembly.GetTypes().Where(</span><br><span class="line">            nodeType =&gt; (CommonGraphConst.BaseNodeType.IsAssignableFrom(nodeType) &amp;&amp; !nodeType.IsAbstract &amp;&amp; nodeType != CommonGraphConst.BaseNodeType));</span><br><span class="line">        <span class="keyword">foreach</span>(<span class="keyword">var</span> type <span class="keyword">in</span> allNodeTypes)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> nodeInstance = Activator.CreateInstance(type) <span class="keyword">as</span> BaseNode;</span><br><span class="line">            <span class="keyword">if</span>(IsAvailableNodeType(nodeInstance.NodeType))</span><br><span class="line">            &#123;</span><br><span class="line">                List&lt;Type&gt; typeList;</span><br><span class="line">                <span class="keyword">if</span>(mNodeTypeTypeMap.TryGetValue(nodeInstance.NodeType, <span class="keyword">out</span> typeList))</span><br><span class="line">                &#123;</span><br><span class="line">                    typeList.Add(type);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 创建所有节点类型的UI</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">CreateAllNodeTypeUI</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">foreach</span>(<span class="keyword">var</span> availableNodeType <span class="keyword">in</span> mAvailableNodeTypeList)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> nodeFoldOut = <span class="keyword">new</span> FoldOut();</span><br><span class="line">            <span class="keyword">var</span> nodeTypeTitle = CommonGraphUtilities.GetNodeTypeTitle(availableNodeType);</span><br><span class="line">            nodeFoldOut.name = nodeTypeTitle;</span><br><span class="line">            nodeFoldOut.viewDataKey = CommonGraphUtilities.GetNodeTypeFoldOutViewDataKeyName(availableNodeType);</span><br><span class="line">            nodeFoldOut.text = nodeTypeTitle;</span><br><span class="line">            nodeFoldOut.AddToClassList(<span class="string">&quot;unity-box&quot;</span>);</span><br><span class="line">            <span class="keyword">var</span> typeList = GetTypeListByNodeType(availableNodeType);</span><br><span class="line">            <span class="keyword">var</span> nodeListView = <span class="keyword">new</span> ListView(typeList, <span class="number">20</span>, OnMakeNodeItem, (NodeItemUserData, index) =&gt;</span><br><span class="line">                                            &#123;</span><br><span class="line">                                                OnBindNodeItem(item, index, availableNodeType);</span><br><span class="line">                                            &#125;);</span><br><span class="line">            nodeFoldOut.Add(nodeListView);</span><br><span class="line">            <span class="comment">// 注册节点FoldOut值变化回调</span></span><br><span class="line">            nodeFoldOut.ReigsterValueChangedCallback(OnNodeFoldOutValueChange);</span><br><span class="line">            <span class="keyword">var</span> nodeVerticalContainer = rootVisualElement.Q&lt;VisualElement&gt;(CommonGraphElementNames.NodeVerticalContainerName);</span><br><span class="line">            nodeVerticalContainer.Add(nodeFoldOut);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>节点列表通过以下流程定义和展示:</p>
<ol>
<li><strong>通过GetInitAvalibleNodeTypeList()方法定义节点窗口可用节点类型列表</strong></li>
<li><strong>结合反射InitNodeTypeTypeListData()初始化所有符合的节点类型信息列表</strong></li>
<li><strong>通过CreateAllNodeTypeUI()使用UIElement创建可选节点列表</strong></li>
</ol>
<h3 id="节点操作显示设计"><a href="#节点操作显示设计" class="headerlink" title="节点操作显示设计"></a>节点操作显示设计</h3><h4 id="GraphView设计"><a href="#GraphView设计" class="headerlink" title="GraphView设计"></a>GraphView设计</h4><p>BehaviourTreeGraphView.cs(通用节点编辑器GraphView(继承至GraphView)，不同的节点编辑器继承修改部分接口即可)</p>
<p>继承UIBTGraphEditorWindow修改获取新的GraphView接口GetNewGraphView()即可。</p>
<p>UIBTGraphEditorWindow.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> UIBTGraphEditorWindow.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 通用节点编辑器窗口</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UIBTGraphEditorWindow</span> : <span class="title">EditorWindow</span></span><br><span class="line">&#123;</span><br><span class="line">   ******</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 创建节点编辑器GraphView</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">CreateGraphView</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        ClearGraphView();</span><br><span class="line">        <span class="keyword">var</span> middleGraphViewContainer = rootVisualElement.Q&lt;VisualElement&gt;(BTGraphElementNames.MiddleGraphViewContainerName);</span><br><span class="line">        mGraphView = GetNewGraphView();</span><br><span class="line">        mGraphView.StretchToParentSize();</span><br><span class="line">        middleGraphViewContainer.Add(mGraphView);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 创建新的GraphView</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> BehaviourTreeGraphView <span class="title">GetNewGraphView</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> BehaviourTreeGraphView(mAvailableNodeTypeList, <span class="keyword">this</span>.OnSelectedNodeChange);</span><br><span class="line">    &#125;</span><br><span class="line">        </span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="StyleSheet添加"><a href="#StyleSheet添加" class="headerlink" title="StyleSheet添加"></a>StyleSheet添加</h4><p>创建UIBTGraphEditorWindow.uss文件，编写相关USS</p>
<p>BehaviourTreeGraphView.cs定义StyleSheet路径和加载流程</p>
<p>BehaviourTreeGraphView.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> BehaviourTreeGraphView.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 行为树GraphView</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BehaviourTreeGraphView</span> : <span class="title">GraphView</span></span><br><span class="line">&#123;</span><br><span class="line">   ******</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Style Sheet Asset路径</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="built_in">string</span> StyleSheetAssetPath</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span>  <span class="string">&quot;Assets/Scripts/Editor/UIToolkitStudy/UIBTGraphEditorWindow/DefaultGraphStyleSheet.uss&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BehaviourTreeGraphView</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mAvailableNodeTypeList = <span class="keyword">new</span> List&lt;NodeType&gt;() ;</span><br><span class="line">        mSelectedNodeChangeDelegate = <span class="literal">null</span>;</span><br><span class="line">        Init();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 带参构造函数</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;availableNodeTypeList&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;selectedNodeChangeCB&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BehaviourTreeGraphView</span>(<span class="params">List&lt;NodeType&gt; availableNodeTypeList, Action&lt;NodeView&gt; selectedNodeChangeCB = <span class="literal">null</span></span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        mAvailableNodeTypeList = availableNodeTypeList;</span><br><span class="line">        mSelectedNodeChangeDelegate += selectedNodeChangeCB;</span><br><span class="line">        Init();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 初始化</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Init</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        ******</span><br><span class="line">        LoadStyleSheet();</span><br><span class="line">        ******</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 加载Style Sheet</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">LoadStyleSheet</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> styleSheet = AssetDatabase.LoadAssetAtPath&lt;StyleSheet&gt;(StyleSheetAssetPath);</span><br><span class="line">        styleSheets.Add(styleSheet);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>UICommonGraphEditorWindow.uss</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">GridBackground &#123;</span><br><span class="line">   --grid-background-color: #282828;</span><br><span class="line">   --line-color: rgba(193, 196, 192, 0.1);</span><br><span class="line">   --thick-line-color: rgba(193, 196, 192, 0.1);</span><br><span class="line">   --spacing: 10;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="节点创建添加"><a href="#节点创建添加" class="headerlink" title="节点创建添加"></a>节点创建添加</h4><p>BehaviourTreeGraphView.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> BehaviourTreeGraphView.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 行为树GraphView</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BehaviourTreeGraphView</span> : <span class="title">GraphView</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 节点默认Rect</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">readonly</span> Rect NodeDefaultRect = <span class="keyword">new</span> Rect(<span class="number">100</span>, <span class="number">200</span>, <span class="number">100</span>, <span class="number">150</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 根节点类型(子类重写实现自定义不同根节点类型)</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">readonly</span> Type RootNodeType = BTGraphConstEditor.RootNodeType;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> GraphView朝向</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">virtual</span> Orientation GraphOrientation</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> GraphOrientation.Horizontal;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    *******</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 初始化</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Init</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        ******</span><br><span class="line">        AddEntryPointNode();</span><br><span class="line">        ******</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 添加根节点</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">AddEntryPointNode</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        AddElement(GenerateEntryPointNode());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 生成根节点</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> NodeView <span class="title">GenerateEntryPointNode</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> rootNode = CreateNodeByType(RootNodeType, BTGraphConstEditor.NodeDefaultPos);</span><br><span class="line">        <span class="keyword">return</span> rootNode;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 创建指定节点名的新节点</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;isEntryNode&quot;&gt;</span>是否是根节点<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;addNodeData&quot;&gt;</span>是否添加节点数据<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> NodeView <span class="title">CreateNode</span>&lt;<span class="title">T</span>&gt;(<span class="params"><span class="built_in">bool</span> isEntryNode = <span class="literal">false</span>, <span class="built_in">bool</span> addNodeData = <span class="literal">true</span></span>) <span class="keyword">where</span> T : BaseNode, <span class="keyword">new</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> typeInfo = <span class="keyword">typeof</span>(T);</span><br><span class="line">        <span class="keyword">var</span> nodeView = CreateNodeByType(typeInfo, isEntryNode, addNodeData);</span><br><span class="line">        <span class="keyword">return</span> nodeView;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 创建指定类型信息和节点名的新节点</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;typeInfo&quot;&gt;</span>类型信息<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;position&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;isEntryNode&quot;&gt;</span>是否是根节点<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> NodeView <span class="title">CreateNodeByType</span>(<span class="params">Type typeInfo, Vector2 position</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> newNode = BTGraphUtilitiesEditor.CreateNodeInstance(typeInfo);</span><br><span class="line">        <span class="keyword">var</span> guid = Guid.NewGuid().ToString();</span><br><span class="line">        <span class="keyword">var</span> nodeRect = BTGraphConstEditor.NodeDefaultRect;</span><br><span class="line">        nodeRect.x = position.x;</span><br><span class="line">        nodeRect.y = position.y;</span><br><span class="line">        newNode.Init(guid, nodeRect);</span><br><span class="line">        <span class="keyword">var</span> nodeView = BTGraphUtilitiesEditor.CreateNodeViewInstance(typeInfo);</span><br><span class="line">        nodeView.Init(SourceGraphData, newNode, OnNodeSelected, <span class="literal">null</span>, GraphOrientation);</span><br><span class="line">        AddNodeData(newNode);</span><br><span class="line">        AddElement(nodeView);</span><br><span class="line">        UpdateNodeViewRect(nodeView, nodeRect);</span><br><span class="line">        <span class="keyword">return</span> nodeView;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 更新NodeView的Rect信息(同时自动更新Node节点数据的Rect信息)</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;nodeView&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;position&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="built_in">bool</span> <span class="title">UpdateNodeViewRect</span>(<span class="params">NodeView nodeView, Rect position</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (nodeView == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">$&quot;不允许更新空NodeView的位置数据！&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        nodeView.SetPosition(position);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 添加新节点数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;node&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;enableUndoSystem&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="built_in">bool</span> <span class="title">AddNodeData</span>(<span class="params">BaseNode node, <span class="built_in">bool</span> enableUndoSystem = <span class="literal">true</span></span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (node == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">$&quot;不允许添加空节点数据！&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (enableUndoSystem)</span><br><span class="line">        &#123;</span><br><span class="line">            Undo.RecordObject(SourceGraphData, <span class="string">&quot;AddNodeData&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> result = SourceGraphData.AddNode(node);</span><br><span class="line">        <span class="keyword">if</span> (result)</span><br><span class="line">        &#123;</span><br><span class="line">            OnAddNodeData(node);</span><br><span class="line">            EditorUtility.SetDirty(SourceGraphData);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>BTGraphUtilitiesEditor.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> BTGraphUtilitiesEditor.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 行为树节点编辑器工具类</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">BTGraphUtilitiesEditor</span></span><br><span class="line">&#123;</span><br><span class="line">   ******</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 创建指定Node类型信息实例对象</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;typeInfo&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> BaseNode <span class="title">CreateNodeInstance</span>(<span class="params">Type typeInfo</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(typeInfo == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">$&quot;不支持创建空类型信息的节点对象！&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(typeInfo != CommonGraphConstEditor.BaseNodeType &amp;&amp; !typeInfo.IsSubclassOf(CommonGraphConstEditor.BaseNodeType))</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">$&quot;不允许创建未继承BaseNode的类型:<span class="subst">&#123;typeInfo.Name&#125;</span>信息节点对象！&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> 硬编码类型构建避免反射</span></span><br><span class="line">        <span class="keyword">return</span> ScriptableObject.CreateInstance(typeInfo) <span class="keyword">as</span> BaseNode;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 创建指定Node类型信息的NodeView实例对象</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;typeInfo&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> NodeView <span class="title">CreateNodeViewInstance</span>(<span class="params">Type typeInfo</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (typeInfo == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">$&quot;不支持创建空类型信息的节点View对象！&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> nodeViewType = GetNodeViewType(typeInfo);</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> 硬编码类型构建避免反射</span></span><br><span class="line">        <span class="keyword">if</span> (nodeViewType != CommonGraphConstEditor.NodeViewType &amp;&amp; !nodeViewType.IsSubclassOf(CommonGraphConstEditor.NodeViewType))</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">$&quot;不允许创建未继承BaseNode的类型:<span class="subst">&#123;nodeViewType.Name&#125;</span>信息节点View对象！&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> Activator.CreateInstance(nodeViewType) <span class="keyword">as</span> NodeView;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>BehaviourTreeGraphView.GenerateEntryPointNode()负责创建根节点。</p>
<p>BehaviourTreeGraphView.CreateNode<T>()和CreateNodeByType()负责创建新节点。</p>
<p>BTGraphUtilitiesEditor.CreateNodeInstance()和BTGraphUtilitiesEditor.CreateNodeViewInstance()负责构建节点对象和节点显示对象(TODO:添加非反射版节点实例对象创建实现)。</p>
<p>BehaviourTreeGraphView.UpdateNodeViewRect()负责更新显示节点数据和位置。</p>
<p><img src="/img/Unity/UIToolkit/AddRootNode.PNG" alt="AddRootNode"></p>
<p>Note:</p>
<ol>
<li><strong>GraphView.GetNodeByGuid()获取指定GUID的节点是根据Node.viewDataKey来标识的</strong></li>
</ol>
<h4 id="节点自定义UI添加"><a href="#节点自定义UI添加" class="headerlink" title="节点自定义UI添加"></a>节点自定义UI添加</h4><p>通过style.color根据不同节点类型设置不同节点颜色显示</p>
<p>通过创建插入竖向容器Element添加自定义UI显示</p>
<p>NodeState.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> NodeState.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 节点状态</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="built_in">enum</span> NodeState</span><br><span class="line">&#123;</span><br><span class="line">    Suspend = <span class="number">0</span>,        <span class="comment">// 挂起状态</span></span><br><span class="line">    Running,            <span class="comment">// 运行状态</span></span><br><span class="line">    Abort,              <span class="comment">// 被打断状态</span></span><br><span class="line">    Success,            <span class="comment">// 成功状态</span></span><br><span class="line">    Failed,             <span class="comment">// 失败状态</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>BaseNode.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> BaseNode.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 节点数据基类</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">Serializable</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BaseNode</span> : <span class="title">Node</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 唯一ID</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;唯一ID&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> GUID;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 位置</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;位置&quot;</span>)</span>]</span><br><span class="line">    [<span class="meta">HideInInspector</span>]</span><br><span class="line">    <span class="keyword">public</span> Rect Position;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 节点描述</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;节点描述&quot;</span>)</span>]</span><br><span class="line">    [<span class="meta">HideInInspector</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Des = <span class="string">&quot;节点描述&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 是否是根节点</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">virtual</span> <span class="built_in">bool</span> EntryPoint</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 节点类型(子类重写自定义节点类型)</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">virtual</span> NodeType NodeType</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> NodeType.Composition;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 节点状态</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> NodeState NodeState</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 是否进入过打断(辅助调试信息显示)</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">bool</span> IsEnteredAbort</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 无参构造</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BaseNode</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">		******</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 初始化</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;guid&quot;&gt;</span>唯一ID<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;position&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;nodeState&quot;&gt;</span>节点状态<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Init</span>(<span class="params"><span class="built_in">string</span> guid, Rect position, NodeState nodeState = NodeState.Suspend</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        GUID = guid;</span><br><span class="line">        Position = position;</span><br><span class="line">        NodeState = nodeState;</span><br><span class="line">        IsEnteredAbort = <span class="literal">false</span>;</span><br><span class="line">        name = GetType().Name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>NodeView.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> NodeView.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 节点显示抽象</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">NodeView</span> : <span class="title">Node</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 所属图数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> BehaviourTreeGraphData OwnerGraphData</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 节点数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> BaseNode NodeData</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 入口Port连线数量类型</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">virtual</span> Port.Capacity InPortCapacity</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> Port.Capacity.Single;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 出口Port连线数量类型</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">virtual</span> Port.Capacity OutPortCapacity</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> Port.Capacity.Single;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 节点朝向</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">protected</span> Orientation mOrientation;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 节点选择委托</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">protected</span> Action&lt;NodeView&gt; mNodeSelectedDelegate;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 所有输入端口</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">protected</span> List&lt;Port&gt; mAllInputPorts;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 所有输出端口</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">protected</span> List&lt;Port&gt; mAllOutputPorts;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 无参构造</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">NodeView</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mAllInputPorts = <span class="keyword">new</span> List&lt;Port&gt;();</span><br><span class="line">        mAllOutputPorts = <span class="keyword">new</span> List&lt;Port&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 带参构造</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;ownerGraphData&quot;&gt;</span>所属图数据<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;nodeData&quot;&gt;</span>节点数据<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;nodeSelectedCB&quot;&gt;</span>节点选择委托<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;nodeName&quot;&gt;</span>节点名(默认不传为BaseNode的类型名)<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;orientation&quot;&gt;</span>节点方向<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">NodeView</span>(<span class="params">BehaviourTreeGraphData ownerGraphData, BaseNode nodeData, Action&lt;NodeView&gt; nodeSelectedCB = <span class="literal">null</span>, <span class="built_in">string</span> nodeName = <span class="literal">null</span>, Orientation orientation = Orientation.Horizontal</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Init(ownerGraphData, nodeData, nodeSelectedCB, nodeName, orientation);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">	<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 根据Node数据初始化</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;ownerGraphData&quot;&gt;</span>所属图数据<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;nodeData&quot;&gt;</span>节点数据<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;nodeSelectedCB&quot;&gt;</span>节点选择委托<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;nodeName&quot;&gt;</span>节点名(默认不传为BaseNode的类型名)<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;orientation&quot;&gt;</span>节点方向<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Init</span>(<span class="params">BehaviourTreeGraphData ownerGraphData, BaseNode node, Action&lt;NodeView&gt; nodeSelectedCB = <span class="literal">null</span>, <span class="built_in">string</span> nodeName = <span class="literal">null</span>, Orientation orientation = Orientation.Horizontal</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        OwnerGraphData = ownerGraphData;</span><br><span class="line">        name = node.GUID;</span><br><span class="line">        <span class="comment">// viewDataKey是GraphView.GetNodeByGUID的数据来源</span></span><br><span class="line">        viewDataKey = node.GUID;</span><br><span class="line">        NodeData = node;</span><br><span class="line">        mNodeSelectedDelegate += nodeSelectedCB;</span><br><span class="line">        mOrientation = orientation;</span><br><span class="line">        title = nodeName == <span class="literal">null</span> ? node.GetType().Name : nodeName;</span><br><span class="line">        titleContainer.style.backgroundColor = BTGraphUtilitiesEditor.GetBackgroundColorByNodeData(NodeData);</span><br><span class="line">        <span class="keyword">var</span> titleLabel = titleContainer.Q&lt;Label&gt;(<span class="string">&quot;title-label&quot;</span>);</span><br><span class="line">        titleLabel.style.color = Color.black;</span><br><span class="line">        titleLabel.style.fontSize = BTGraphConstEditor.NormalLabelFontSize;</span><br><span class="line">        CreateNodeUI();</span><br><span class="line">        GenerateAllPort();</span><br><span class="line">        RefreshExpandedState();</span><br><span class="line">        RefreshPorts();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    ******</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 创建节点UI</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">CreateNodeUI</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        CreateNodeContainerUI();</span><br><span class="line">        CreateNodeGUIDUI();</span><br><span class="line">        CreateNodeStateUI();</span><br><span class="line">        CreateCustomUI();</span><br><span class="line">        CreateNodeDesUI();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 创建节点UI</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">CreateNodeContainerUI</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> nodeVerticalUIContainer = UIToolkitUtilities.CreateVerticalContainer(BTGraphElementNames.NodeUIVerticalContainerName,</span><br><span class="line">                                                                                 <span class="number">1</span>, <span class="string">&quot;unity-box&quot;</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>,</span><br><span class="line">                                                                                 BTGraphConstEditor.NodeContainerBGColor);</span><br><span class="line">        <span class="keyword">var</span> nodeContentElement = <span class="keyword">this</span>.Q&lt;VisualElement&gt;(<span class="string">&quot;contents&quot;</span>);</span><br><span class="line">        nodeContentElement.Insert(<span class="number">0</span>, nodeVerticalUIContainer);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 创建节点GUID UI</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">CreateNodeGUIDUI</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> nodeVerticalUIContainer = <span class="keyword">this</span>.Q&lt;VisualElement&gt;(BTGraphElementNames.NodeUIVerticalContainerName);</span><br><span class="line">        <span class="keyword">var</span> nodeGUIDHorizontalUIContainer = UIToolkitUtilities.CreateHorizontalContainer(BTGraphElementNames.NodeGUIDUIHorizontalContainerName);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> nodeGUIDDivider = UIToolkitUtilities.CreateHorizontalDivider(BTGraphConstEditor.DividerColor);</span><br><span class="line">        nodeVerticalUIContainer.Add(nodeGUIDDivider);</span><br><span class="line">        nodeVerticalUIContainer.Add(nodeGUIDHorizontalUIContainer);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> nodeGuidTitleLabel = <span class="keyword">new</span> Label();</span><br><span class="line">        nodeGuidTitleLabel.text = <span class="string">&quot;GUID:&quot;</span>;</span><br><span class="line">        nodeGuidTitleLabel.style.height = BTGraphConstEditor.NodeOneLineHeight;</span><br><span class="line">        nodeGuidTitleLabel.style.fontSize = BTGraphConstEditor.NormalLabelFontSize;</span><br><span class="line">        nodeGuidTitleLabel.style.unityTextAlign = TextAnchor.MiddleCenter;</span><br><span class="line">        nodeGuidTitleLabel.style.alignSelf = Align.Center;</span><br><span class="line">        nodeGUIDHorizontalUIContainer.Add(nodeGuidTitleLabel);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> nodeGuidLabel = <span class="keyword">new</span> TextField();</span><br><span class="line">        nodeGuidLabel.isReadOnly = <span class="literal">true</span>;</span><br><span class="line">        nodeGuidLabel.<span class="keyword">value</span> = NodeData.GUID;</span><br><span class="line">        nodeGuidLabel.style.height = BTGraphConstEditor.NodeOneLineHeight;</span><br><span class="line">        nodeGuidLabel.style.fontSize = BTGraphConstEditor.NormalLabelFontSize;</span><br><span class="line">        nodeGuidLabel.style.unityTextAlign = TextAnchor.MiddleCenter;</span><br><span class="line">        nodeGuidLabel.style.alignSelf = Align.Center;</span><br><span class="line">        <span class="comment">//nodeGuidLabel.style.color = Color.white;</span></span><br><span class="line">        nodeGUIDHorizontalUIContainer.Add(nodeGuidLabel);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 创建节点状态UI</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">CreateNodeStateUI</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> nodeVerticalUIContainer = <span class="keyword">this</span>.Q&lt;VisualElement&gt;(BTGraphElementNames.NodeUIVerticalContainerName);</span><br><span class="line">        <span class="keyword">var</span> nodeStateHorizontalUIContainer = UIToolkitUtilities.CreateHorizontalContainer(BTGraphElementNames.NodeStateUIHorizontalContainerName);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> nodeStateDivider = UIToolkitUtilities.CreateHorizontalDivider(BTGraphConstEditor.DividerColor);</span><br><span class="line">        nodeVerticalUIContainer.Add(nodeStateDivider);</span><br><span class="line">        nodeVerticalUIContainer.Add(nodeStateHorizontalUIContainer);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> nodeStateTitleLabel = <span class="keyword">new</span> Label();</span><br><span class="line">        nodeStateTitleLabel.style.width = <span class="number">40f</span>;</span><br><span class="line">        nodeStateTitleLabel.style.height = BTGraphConstEditor.NodeOneLineHeight;</span><br><span class="line">        nodeStateTitleLabel.text = <span class="string">&quot;状态:&quot;</span>;</span><br><span class="line">        nodeStateTitleLabel.style.fontSize = BTGraphConstEditor.NormalLabelFontSize;</span><br><span class="line">        nodeStateTitleLabel.style.color = Color.black;</span><br><span class="line">        nodeStateTitleLabel.style.unityTextAlign = TextAnchor.MiddleCenter;</span><br><span class="line">        nodeStateTitleLabel.style.alignSelf = Align.Center;</span><br><span class="line">        nodeStateHorizontalUIContainer.Add(nodeStateTitleLabel);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> nodeStateLabel = <span class="keyword">new</span> Label();</span><br><span class="line">        nodeStateLabel.name = BTGraphElementNames.NodeStateLabelName;</span><br><span class="line">        nodeStateLabel.style.width = <span class="number">40f</span>;</span><br><span class="line">        nodeStateLabel.style.unityTextAlign = TextAnchor.MiddleCenter;</span><br><span class="line">        nodeStateLabel.style.alignSelf = Align.Center;</span><br><span class="line">        nodeStateLabel.style.height = BTGraphConstEditor.NodeOneLineHeight;</span><br><span class="line">        nodeStateLabel.style.fontSize = BTGraphConstEditor.NormalLabelFontSize;</span><br><span class="line">        nodeStateLabel.style.color = Color.black;</span><br><span class="line">        nodeStateLabel.style.flexGrow = <span class="number">1</span>;</span><br><span class="line">        nodeStateHorizontalUIContainer.Add(nodeStateLabel);</span><br><span class="line">        UpdateNodeStateBackgroundColor();</span><br><span class="line">        UpdateNodeStateLabel();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 创建节点自定义UI</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">CreateCustomUI</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 更新节点状态背景颜色</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">UpdateNodeStateBackgroundColor</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> nodeStateHorizontalUIContainer = <span class="keyword">this</span>.Q&lt;VisualElement&gt;(BTGraphElementNames.NodeStateUIHorizontalContainerName);</span><br><span class="line">        <span class="keyword">if</span>(nodeStateHorizontalUIContainer != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            nodeStateHorizontalUIContainer.style.backgroundColor = BTGraphUtilitiesEditor.GetColorByNodeState(NodeData.NodeState);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 更新节点状态Label</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">UpdateNodeStateLabel</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> nodeStateLabel = <span class="keyword">this</span>.Q&lt;Label&gt;(BTGraphElementNames.NodeStateLabelName);</span><br><span class="line">        <span class="keyword">if</span> (nodeStateLabel != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> stateDes = NodeData.NodeState.ToString();</span><br><span class="line">            <span class="keyword">if</span>(NodeData.IsEnteredAbort)</span><br><span class="line">            &#123;</span><br><span class="line">                stateDes = <span class="string">$&quot;<span class="subst">&#123;stateDes&#125;</span>(打断)&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            nodeStateLabel.text = stateDes;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 创建节点描述UI</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">CreateNodeDesUI</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> nodeVerticalUIContainer = <span class="keyword">this</span>.Q&lt;VisualElement&gt;(BTGraphElementNames.NodeUIVerticalContainerName);</span><br><span class="line">        <span class="keyword">var</span> nodeDesHorizontalUIContainer = UIToolkitUtilities.CreateHorizontalContainer(BTGraphElementNames.NodeDesUIHorizontalContainerName);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> nodeDesDivider = UIToolkitUtilities.CreateHorizontalDivider(BTGraphConstEditor.DividerColor);</span><br><span class="line">        nodeVerticalUIContainer.Add(nodeDesDivider);</span><br><span class="line">        nodeVerticalUIContainer.Add(nodeDesHorizontalUIContainer);</span><br><span class="line"></span><br><span class="line">        UIToolkitUtilities.CreateBindSOTextField(nodeDesHorizontalUIContainer, NodeData,</span><br><span class="line">                                                 BTGraphConstEditor.NodeDesPropertyName, <span class="number">1</span>,</span><br><span class="line">                                                 BTGraphConstEditor.NodeOneLineHeight,</span><br><span class="line">                                                 BTGraphConstEditor.NormalLabelFontSize);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 创建节点自定义UI</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">CreateCustomUI</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>BTGraphUtilitiesEditor.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> BTGraphUtilitiesEditor.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 行为树节点编辑器工具类</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">BTGraphUtilitiesEditor</span></span><br><span class="line">&#123;</span><br><span class="line">    ******</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 节点类型和颜色背景Map</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Dictionary&lt;NodeType, Color&gt; NodeTypeBackgroundColorMap = <span class="keyword">new</span> Dictionary&lt;NodeType, Color&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        &#123;NodeType.Composition, Color.blue&#125;,</span><br><span class="line">        &#123;NodeType.Decoration, Color.cyan&#125;,</span><br><span class="line">        &#123;NodeType.Condition, Color.yellow&#125;,</span><br><span class="line">        &#123;NodeType.Action, Color.red&#125;,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 节点状态和颜色背景Map</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">readonly</span> Dictionary&lt;NodeState, Color&gt; NodeStateColorMap = <span class="keyword">new</span> Dictionary&lt;NodeState, Color&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        &#123;NodeState.Suspend, Color.grey&#125;,</span><br><span class="line">        &#123;NodeState.Running, Color.yellow&#125;,</span><br><span class="line">        &#123;NodeState.Abort, Color.magenta&#125;,</span><br><span class="line">        &#123;NodeState.Success, Color.green&#125;,</span><br><span class="line">        &#123;NodeState.Failed, Color.red&#125;,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    ******</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 获取指定节点类型的背景颜色</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;nodeType&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Color <span class="title">GetBackgroundColorByNodeType</span>(<span class="params">NodeType nodeType</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Color nodeTypeBackgroundColor;</span><br><span class="line">        <span class="keyword">if</span> (NodeTypeBackgroundColorMap.TryGetValue(nodeType, <span class="keyword">out</span> nodeTypeBackgroundColor))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> nodeTypeBackgroundColor;</span><br><span class="line">        &#125;</span><br><span class="line">        Debug.LogError(<span class="string">$&quot;未配置节点类型:<span class="subst">&#123;nodeType&#125;</span>的背景颜色！&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> Color.grey;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 获取指定节点类型的背景颜色</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;nodeState&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Color <span class="title">GetColorByNodeState</span>(<span class="params">NodeState nodeState</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Color nodeStateColor;</span><br><span class="line">        <span class="keyword">if</span> (NodeStateColorMap.TryGetValue(nodeState, <span class="keyword">out</span> nodeStateColor))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> nodeStateColor;</span><br><span class="line">        &#125;</span><br><span class="line">        Debug.LogError(<span class="string">$&quot;未配置节点状态:<span class="subst">&#123;nodeState&#125;</span>的颜色！&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> Color.grey;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>UIToolkitUtilities.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> UIToolkitUtilities.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> UIToolkit工具类</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">UIToolkitUtilities</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 创建一个指定名字指定相关设置的横向容器</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;containerName&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;flexGrow&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;classList&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;styleLeft&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;styleRight&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;styleTop&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;styleBottom&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;styleColor&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> VisualElement <span class="title">CreateHorizontalContainer</span>(<span class="params"><span class="built_in">string</span> containerName, <span class="built_in">float</span> flexGrow = <span class="number">1f</span>, <span class="built_in">string</span> classList = <span class="literal">null</span>, <span class="built_in">float</span> styleLeft = <span class="number">0</span>, <span class="built_in">float</span> styleRight = <span class="number">0</span>, <span class="built_in">float</span> styleTop = <span class="number">0</span>, <span class="built_in">float</span> styleBottom = <span class="number">0</span>, StyleColor styleColor = <span class="literal">default</span>(StyleColor</span>))</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> nodeHorizontalUIContainer = <span class="keyword">new</span> VisualElement();</span><br><span class="line">        nodeHorizontalUIContainer.name = containerName;</span><br><span class="line">        nodeHorizontalUIContainer.style.left = styleLeft;</span><br><span class="line">        nodeHorizontalUIContainer.style.right = styleRight;</span><br><span class="line">        nodeHorizontalUIContainer.style.flexGrow = flexGrow;</span><br><span class="line">        nodeHorizontalUIContainer.style.top = styleTop;</span><br><span class="line">        nodeHorizontalUIContainer.style.bottom = styleBottom;</span><br><span class="line">        nodeHorizontalUIContainer.style.flexDirection = FlexDirection.Row;</span><br><span class="line">        nodeHorizontalUIContainer.style.backgroundColor = styleColor;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="built_in">string</span>.IsNullOrEmpty(classList))</span><br><span class="line">        &#123;</span><br><span class="line">            nodeHorizontalUIContainer.AddToClassList(classList);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> nodeHorizontalUIContainer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 创建一个指定名字指定相关设置的竖向容器</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;containerName&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;flexGrow&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;classList&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;styleLeft&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;styleRight&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;styleTop&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;styleBottom&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;styleColor&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> VisualElement <span class="title">CreateVerticalContainer</span>(<span class="params"><span class="built_in">string</span> containerName, <span class="built_in">float</span> flexGrow = <span class="number">1f</span>, <span class="built_in">string</span> classList = <span class="literal">null</span>, <span class="built_in">float</span> styleLeft = <span class="number">0</span>, <span class="built_in">float</span> styleRight = <span class="number">0</span>, <span class="built_in">float</span> styleTop = <span class="number">0</span>, <span class="built_in">float</span> styleBottom = <span class="number">0</span>, StyleColor styleColor = <span class="literal">default</span>(StyleColor</span>))</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> nodeHorizontalUIContainer = <span class="keyword">new</span> VisualElement();</span><br><span class="line">        nodeHorizontalUIContainer.name = containerName;</span><br><span class="line">        nodeHorizontalUIContainer.style.left = styleLeft;</span><br><span class="line">        nodeHorizontalUIContainer.style.right = styleRight;</span><br><span class="line">        nodeHorizontalUIContainer.style.flexGrow = flexGrow;</span><br><span class="line">        nodeHorizontalUIContainer.style.top = styleTop;</span><br><span class="line">        nodeHorizontalUIContainer.style.bottom = styleBottom;</span><br><span class="line">        nodeHorizontalUIContainer.style.flexDirection = FlexDirection.Column;</span><br><span class="line">        nodeHorizontalUIContainer.style.backgroundColor = styleColor;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">string</span>.IsNullOrEmpty(classList))</span><br><span class="line">        &#123;</span><br><span class="line">            nodeHorizontalUIContainer.AddToClassList(classList);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> nodeHorizontalUIContainer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 创建一个横向分割线</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;color&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> VisualElement <span class="title">CreateHorizontalDivider</span>(<span class="params">Color color, <span class="built_in">float</span> height = <span class="number">1f</span></span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> horizontalDivider = <span class="keyword">new</span> VisualElement();</span><br><span class="line">        horizontalDivider.style.height = height;</span><br><span class="line">        horizontalDivider.style.flexGrow = <span class="number">1</span>;</span><br><span class="line">        horizontalDivider.style.backgroundColor = color;</span><br><span class="line">        <span class="keyword">return</span> horizontalDivider;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 创建一个竖向分割线</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;color&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> VisualElement <span class="title">CreateVerticalDivider</span>(<span class="params">Color color</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> horizontalDivider = <span class="keyword">new</span> VisualElement();</span><br><span class="line">        horizontalDivider.style.width = <span class="number">1</span>;</span><br><span class="line">        horizontalDivider.style.flexGrow = <span class="number">1</span>;</span><br><span class="line">        horizontalDivider.style.backgroundColor = color;</span><br><span class="line">        <span class="keyword">return</span> horizontalDivider;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 指定容器创建指定对象的可视化Inspector</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;scriptableObject&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;propertyBindDataMap&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> VisualElement <span class="title">CreateBindSOInspector</span>(<span class="params">ScriptableObject scriptableObject, Dictionary&lt;<span class="built_in">string</span>, PropertyBindData&gt; propertyBindDataMap = <span class="literal">null</span></span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(scriptableObject == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">$&quot;不允许给空ScriptableObject创建可视化Inspector！&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> container = CreateVerticalContainer(<span class="literal">null</span>, <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">var</span> serializedObject = <span class="keyword">new</span> SerializedObject(scriptableObject);</span><br><span class="line">        <span class="keyword">var</span> propertyIterator = serializedObject.GetIterator();</span><br><span class="line">        propertyIterator.NextVisible(<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">while</span>(propertyIterator.NextVisible(<span class="literal">false</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> propertyField = <span class="keyword">new</span> PropertyField();</span><br><span class="line">            <span class="keyword">var</span> propertyName = propertyIterator.name;</span><br><span class="line">            <span class="keyword">var</span> property = serializedObject.FindProperty(propertyName);</span><br><span class="line">            propertyField.name = propertyName;</span><br><span class="line">            propertyField.BindProperty(property);</span><br><span class="line">            container.Add(propertyField);</span><br><span class="line">            <span class="keyword">if</span>(propertyBindDataMap != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> propertyBindData = <span class="keyword">new</span> PropertyBindData(serializedObject, property, propertyField);</span><br><span class="line">                propertyBindDataMap.Add(propertyName, propertyBindData);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> container;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 指定容器创建指定对象指定属性名的绑定PropertyField</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;container&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;scriptableObject&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;propertyName&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;flexGrow&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;height&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> PropertyBindData <span class="title">CreateBindSOPropertyField</span>(<span class="params">VisualElement container, ScriptableObject scriptableObject, <span class="built_in">string</span> propertyName, <span class="built_in">float</span> flexGrow = <span class="number">0</span>, <span class="built_in">float</span> height = <span class="number">25f</span></span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (container == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">$&quot;不允许给空容器创建绑定PropertyField！&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (scriptableObject == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">$&quot;不允许给空ScriptableObject创建绑定PropertyField！&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> serializedObject = <span class="keyword">new</span> SerializedObject(scriptableObject);</span><br><span class="line">        <span class="keyword">var</span> property = serializedObject.FindProperty(propertyName);</span><br><span class="line">        <span class="keyword">if</span>(property == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">$&quot;ScriptableObject:<span class="subst">&#123;scriptableObject.name&#125;</span>没找到属性名:<span class="subst">&#123;propertyName&#125;</span>的属性，创建绑定PropertyField失败！&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> propertyField = <span class="keyword">new</span> PropertyField();</span><br><span class="line">        propertyField.name = propertyName;</span><br><span class="line">        propertyField.BindProperty(property);</span><br><span class="line">        propertyField.style.height = height;</span><br><span class="line">        propertyField.style.flexGrow = flexGrow;</span><br><span class="line">        container.Add(propertyField);</span><br><span class="line">        <span class="keyword">var</span> propertyBindData = <span class="keyword">new</span> PropertyBindData(serializedObject, property, propertyField);</span><br><span class="line">        <span class="keyword">return</span> propertyBindData;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 指定容器创建指定对象指定属性名的绑定TextField</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;container&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;scriptableObject&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;propertyName&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;flexGrow&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;height&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;fontSize&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;textAnchor&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> PropertyBindData <span class="title">CreateBindSOTextField</span>(<span class="params">VisualElement container, ScriptableObject scriptableObject, <span class="built_in">string</span> propertyName, <span class="built_in">float</span> flexGrow = <span class="number">0</span>, <span class="built_in">float</span> height = <span class="number">25f</span>, <span class="built_in">float</span> fontSize = <span class="number">15f</span>, TextAnchor textAnchor = TextAnchor.MiddleCenter</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (container == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">$&quot;不允许给空容器创建绑定TextField！&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (scriptableObject == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">$&quot;不允许给空ScriptableObject创建绑定TextField！&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> serializedObject = <span class="keyword">new</span> SerializedObject(scriptableObject);</span><br><span class="line">        <span class="keyword">var</span> property = serializedObject.FindProperty(propertyName);</span><br><span class="line">        <span class="keyword">if</span> (property == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">$&quot;ScriptableObject:<span class="subst">&#123;scriptableObject.name&#125;</span>没找到属性名:<span class="subst">&#123;propertyName&#125;</span>的属性，创建绑定TextField失败！&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> textField = <span class="keyword">new</span> TextField();</span><br><span class="line">        textField.name = propertyName;</span><br><span class="line">        textField.BindProperty(property);</span><br><span class="line">        textField.style.height = height;</span><br><span class="line">        textField.style.fontSize = fontSize;</span><br><span class="line">        textField.style.flexGrow = flexGrow;</span><br><span class="line">        textField.style.unityTextAlign = textAnchor;</span><br><span class="line">        container.Add(textField);</span><br><span class="line">        <span class="keyword">var</span> propertyBindData = <span class="keyword">new</span> PropertyBindData(serializedObject, property, textField);</span><br><span class="line">        <span class="keyword">return</span> propertyBindData;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/img/Unity/UIToolkit/CustomNodeViewUI.PNG" alt="CustomNodeViewUI"></p>
<p>Note:</p>
<ol>
<li><strong>子类重写CreateCustomUI()自定义节点UI显示</strong></li>
</ol>
<h4 id="节点Port创建添加"><a href="#节点Port创建添加" class="headerlink" title="节点Port创建添加"></a>节点Port创建添加</h4><p>NodeView.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> NodeView.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 节点显示抽象</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">NodeView</span> : <span class="title">Node</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 所属图数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> BehaviourTreeGraphData OwnerGraphData</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 节点数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> BaseNode NodeData</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 入口Port连线数量类型</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">virtual</span> Port.Capacity InPortCapacity</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> Port.Capacity.Single;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 出口Port连线数量类型</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">virtual</span> Port.Capacity OutPortCapacity</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> Port.Capacity.Single;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 节点朝向</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">protected</span> Orientation mOrientation;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 节点选择委托</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">protected</span> Action&lt;NodeView&gt; mNodeSelectedDelegate;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 所有输入端口</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">protected</span> List&lt;Port&gt; mAllInputPorts;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 所有输出端口</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">protected</span> List&lt;Port&gt; mAllOutputPorts;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 无参构造</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">NodeView</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">		mAllInputPorts = <span class="keyword">new</span> List&lt;Port&gt;();</span><br><span class="line">        mAllOutputPorts = <span class="keyword">new</span> List&lt;Port&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 带参构造</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;ownerGraphData&quot;&gt;</span>所属图数据<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;nodeData&quot;&gt;</span>节点数据<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;nodeSelectedCB&quot;&gt;</span>节点选择委托<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;nodeName&quot;&gt;</span>节点名(默认不传为BaseNode的类型名)<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;orientation&quot;&gt;</span>节点方向<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">NodeView</span>(<span class="params">BehaviourTreeGraphData ownerGraphData, BaseNode nodeData, Action&lt;NodeView&gt; nodeSelectedCB = <span class="literal">null</span>, <span class="built_in">string</span> nodeName = <span class="literal">null</span>, Orientation orientation = Orientation.Horizontal</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Init(ownerGraphData, nodeData, nodeSelectedCB, nodeName, orientation);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 根据Node数据初始化</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;ownerGraphData&quot;&gt;</span>所属图数据<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;nodeData&quot;&gt;</span>节点数据<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;nodeSelectedCB&quot;&gt;</span>节点选择委托<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;nodeName&quot;&gt;</span>节点名(默认不传为BaseNode的类型名)<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;orientation&quot;&gt;</span>节点方向<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Init</span>(<span class="params">BehaviourTreeGraphData ownerGraphData, BaseNode node, Action&lt;NodeView&gt; nodeSelectedCB = <span class="literal">null</span>, <span class="built_in">string</span> nodeName = <span class="literal">null</span>, Orientation orientation = Orientation.Horizontal</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        OwnerGraphData = ownerGraphData;</span><br><span class="line">        name = node.GUID;</span><br><span class="line">        <span class="comment">// viewDataKey是GraphView.GetNodeByGUID的数据来源</span></span><br><span class="line">        viewDataKey = node.GUID;</span><br><span class="line">        NodeData = node;</span><br><span class="line">        mNodeSelectedDelegate += nodeSelectedCB;</span><br><span class="line">        mOrientation = orientation;</span><br><span class="line">        title = nodeName == <span class="literal">null</span> ? node.GetType().Name : nodeName;</span><br><span class="line">        titleContainer.style.backgroundColor = BTGraphUtilitiesEditor.GetBackgroundColorByNodeData(NodeData);</span><br><span class="line">        <span class="keyword">var</span> titleLabel = titleContainer.Q&lt;Label&gt;(<span class="string">&quot;title-label&quot;</span>);</span><br><span class="line">        titleLabel.style.color = Color.black;</span><br><span class="line">        titleLabel.style.fontSize = BTGraphConstEditor.NormalLabelFontSize;</span><br><span class="line">        CreateNodeUI();</span><br><span class="line">        GenerateAllPort();</span><br><span class="line">        RefreshExpandedState();</span><br><span class="line">        RefreshPorts();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 创建自定义输入Port</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;portName&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;type&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Port <span class="title">InstantiateCustomInputPort</span>(<span class="params"><span class="built_in">string</span> portName, System.Type type</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> port = InstantiateCustomPort(portName, Direction.Input, InPortCapacity, type);</span><br><span class="line">        inputContainer.Add(port);</span><br><span class="line">        mAllInputPorts.Add(port);</span><br><span class="line">        <span class="keyword">return</span> port;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 创建自定义输出Port</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;portName&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;type&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Port <span class="title">InstantiateCustomOutputPort</span>(<span class="params"><span class="built_in">string</span> portName, System.Type type</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> port = InstantiateCustomPort(portName, Direction.Output, OutPortCapacity, type);</span><br><span class="line">        outputContainer.Add(port);</span><br><span class="line">        mAllOutputPorts.Add(port);</span><br><span class="line">        <span class="keyword">return</span> port;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 获取所有Input端口</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Port&gt; <span class="title">GetAllInputPorts</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> mAllInputPorts;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 获取所有Output端口</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Port&gt; <span class="title">GetAllOutputPorts</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> mAllOutputPorts;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 创建自定义Port</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Note:</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 不含添加到容器</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;portName&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;direction&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;capacity&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;type&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> Port <span class="title">InstantiateCustomPort</span>(<span class="params"><span class="built_in">string</span> portName, Direction direction, Port.Capacity capacity, System.Type type</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> port = InstantiatePort(mOrientation, direction, capacity, type);</span><br><span class="line">        port.name = portName;</span><br><span class="line">        port.portName = portName;</span><br><span class="line">        <span class="keyword">return</span> port;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 实例化Port(自定义Port创建接口用于支持创建自定义EdgeView)</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;orientation&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;direction&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;capacity&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;type&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> Port <span class="title">InstantiatePort</span>(<span class="params">Orientation orientation, Direction direction, Port.Capacity capacity, Type type</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> Port.Create&lt;EdgeView&gt;(orientation, direction, capacity, type);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ******</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 创建所有Port</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">GenerateAllPort</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        GenerateAllInputPort();</span><br><span class="line">        GenerateAllOutputPort();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 生成节点所有Input Port</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">GenerateAllInputPort</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        InstantiateCustomInputPort(BTGraphConstEditor.DefaultInputPortName, BTGraphConstEditor.FloatType);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 生成节点所有Output Port</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">GenerateAllOutputPort</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        InstantiateCustomOutputPort(BTGraphConstEditor.DefaultOutputPortName, BTGraphConstEditor.FloatType);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>BaseParentNode.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> BaseParentNode.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 父节点基类抽象(所有有子节点的类型都继承这个)</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title">BaseParentNode</span> : <span class="title">BaseNode</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 子节点数量</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> ChildNodeCount</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> mChildNodeList != <span class="literal">null</span> ? mChildNodeList.Count : <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 子节点列表</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">protected</span> List&lt;BaseNode&gt; mChildNodeList;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 设置子节点列表</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;childNodeList&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">SetChildNodeList</span>(<span class="params">List&lt;BaseNode&gt; childNodeList</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        mChildNodeList = childNodeList;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>BaseCompositionNode.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> BaseCompositionNode.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 行为树组合节点基类</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">Serializable</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title">BaseCompositionNode</span> : <span class="title">BaseParentNode</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 节点类型</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">override</span> NodeType NodeType</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> NodeType.Composition;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>SequnceNode.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> SequenceNode.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 行为树顺序节点(多个节点按顺序执行直到遇到返回失败的节点)</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">Serializable</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">SequenceNode</span> : <span class="title">BaseCompositionNode</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从上面代码可以看到节点Port创建流程如下：</p>
<ol>
<li><strong>NodeView.GenerateAllPort()，NodeView.GenerateAllInputPort()和NodeView.GenerateAllOutputPort()负责节点Port的初始化创建流程</strong></li>
<li><strong>NodeView.InstantiateCustomInputPort()和NodeView.InstantiateCustomOutputPort()方法分别负责创建输入和输出节点Port</strong></li>
<li><strong>NodeView.inputContainer和NodeView.outputContainer分别对应输入和输出节点容器通过*Container.Add(port)方法给对应节点容器添加创建节点</strong></li>
<li><strong>调用RefreshExpandedState()和RefreshPorts()触发节点输出节点排版刷新显示</strong></li>
</ol>
<p><img src="/img/Unity/UIToolkit/PortConnectPreview.PNG" alt="PortConnectPreview"></p>
<p>Note:</p>
<ol>
<li><strong>InPortCapacity或OutPortCapacity实现自定义节点的输入输出Port连线数量定义</strong></li>
<li><strong>GenerateAllInputPort()或GenerateAllOutputPort()实现自定义输入输出节点Port创建</strong></li>
</ol>
<h4 id="节点Port连线功能添加"><a href="#节点Port连线功能添加" class="headerlink" title="节点Port连线功能添加"></a>节点Port连线功能添加</h4><p><strong>节点的连线规则是通过GraphView:GetCompatiblePorts()接口返回决定的</strong></p>
<p>BehaviourTreeGraphView.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> BehaviourTreeGraphView.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 行为树GraphView</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BehaviourTreeGraphView</span> : <span class="title">GraphView</span></span><br><span class="line">&#123;</span><br><span class="line">    ******</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Port可连接节点类型Map<span class="doctag">&lt;节点类型, &lt;可连接节点类型, 可连接节点类型&gt;</span>&gt;</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">protected</span> Dictionary&lt;NodeType, Dictionary&lt;NodeType, NodeType&gt;&gt; mPortAvailableConnectNodeTypeMap;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Port不可连接节点类型信息Map<span class="doctag">&lt;节点类型, &lt;不可连接节点类型信息, 不可连接节点类型信息&gt;</span>&gt;</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">protected</span> Dictionary&lt;NodeType, Dictionary&lt;Type, Type&gt;&gt; mPortUnavailableConnectTypeMap;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 可连接的Port列表</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">protected</span> List&lt;Port&gt; mCompatiblePortList;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Init</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        ******</span><br><span class="line">        </span><br><span class="line">        InitPortConnectRuleData();</span><br><span class="line"></span><br><span class="line">        ******</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 初始化Port连接规则数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">InitPortConnectRuleData</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mCompatiblePortList = <span class="keyword">new</span> List&lt;Port&gt;();</span><br><span class="line">        InitPortAvalibleConnectNodeTypeData();</span><br><span class="line">        InitPortUnavalibleConnectTypeData();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 初始化Port连接规则数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">InitPortConnectRuleData</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mCompatiblePortList = <span class="keyword">new</span> List&lt;Port&gt;();</span><br><span class="line">        InitPortAvalibleConnectNodeTypeData();</span><br><span class="line">        InitPortUnavalibleConnectTypeData();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 初始化Port可连接节点类型数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">InitPortAvalibleConnectNodeTypeData</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mPortAvailableConnectNodeTypeMap = <span class="keyword">new</span> Dictionary&lt;NodeType, Dictionary&lt;NodeType, NodeType&gt;&gt;();</span><br><span class="line">        AddPortAvalibleConnectNodeType(NodeType.Composition, NodeType.Composition);</span><br><span class="line">        AddPortAvalibleConnectNodeType(NodeType.Composition, NodeType.Decoration);</span><br><span class="line">        AddPortAvalibleConnectNodeType(NodeType.Composition, NodeType.Condition);</span><br><span class="line">        AddPortAvalibleConnectNodeType(NodeType.Composition, NodeType.Action);</span><br><span class="line"></span><br><span class="line">        AddPortAvalibleConnectNodeType(NodeType.Decoration, NodeType.Composition);</span><br><span class="line">        AddPortAvalibleConnectNodeType(NodeType.Decoration, NodeType.Decoration);</span><br><span class="line">        AddPortAvalibleConnectNodeType(NodeType.Decoration, NodeType.Condition);</span><br><span class="line">        AddPortAvalibleConnectNodeType(NodeType.Decoration, NodeType.Action);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 添加Port指定节点类型可连接节点类型</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;sourceNodeType&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;targetNodeType&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="built_in">bool</span> <span class="title">AddPortAvalibleConnectNodeType</span>(<span class="params">NodeType sourceNodeType, NodeType targetNodeType</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Dictionary&lt;NodeType, NodeType&gt; portAvalibleConnectNodeTypeMap;</span><br><span class="line">        <span class="keyword">if</span> (!mPortAvailableConnectNodeTypeMap.TryGetValue(sourceNodeType, <span class="keyword">out</span> portAvalibleConnectNodeTypeMap))</span><br><span class="line">        &#123;</span><br><span class="line">            portAvalibleConnectNodeTypeMap = <span class="keyword">new</span> Dictionary&lt;NodeType, NodeType&gt;();</span><br><span class="line">            mPortAvailableConnectNodeTypeMap.Add(sourceNodeType, portAvalibleConnectNodeTypeMap);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (portAvalibleConnectNodeTypeMap.ContainsKey(targetNodeType))</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">$&quot;重复添加节点类型:<span class="subst">&#123;sourceNodeType&#125;</span>的Port可连接节点类型:<span class="subst">&#123;targetNodeType&#125;</span>&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        portAvalibleConnectNodeTypeMap.Add(targetNodeType, targetNodeType);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 初始化Port不可连接类型信息数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">InitPortUnavalibleConnectTypeData</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mPortUnavailableConnectTypeMap = <span class="keyword">new</span> Dictionary&lt;NodeType, Dictionary&lt;Type, Type&gt;&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ******</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 获取可连接的Port</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;startPort&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;nodeAdapter&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> List&lt;Port&gt; <span class="title">GetCompatiblePorts</span>(<span class="params">Port startPort, NodeAdapter nodeAdapter</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        mCompatiblePortList.Clear();</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> port <span class="keyword">in</span> ports)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 不允许连接自身Port || 不允许连接自身节点 || 不允许连接相同In or Out Port</span></span><br><span class="line">            <span class="keyword">if</span> (startPort == port || startPort.node == port.node || startPort.direction == port.direction)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">var</span> startNode = startPort.node <span class="keyword">as</span> NodeView;</span><br><span class="line">            <span class="keyword">var</span> portNode = port.node <span class="keyword">as</span> NodeView;</span><br><span class="line">            <span class="keyword">if</span> (!IsPortAvalibleConnectNodeType(startNode.NodeData.NodeType, portNode.NodeData.NodeType))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">var</span> portNodeType = port.node.GetType();</span><br><span class="line">            <span class="keyword">if</span> (IsPortUnavalibleConnectType(startNode.NodeData.NodeType, portNodeType))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 不允许连接根节点的InputPort</span></span><br><span class="line">            <span class="keyword">if</span> (portNode.NodeData.EntryPoint &amp;&amp; port.direction == Direction.Input)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 根节点的InputPort不允许连接任何OutputPort</span></span><br><span class="line">            <span class="keyword">if</span> (startNode.NodeData.EntryPoint &amp;&amp; port.direction == Direction.Output)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            mCompatiblePortList.Add(port);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> mCompatiblePortList;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>InitPortAvalibleConnectNodeTypeData()实现自定义节点类型和哪些节点类型可连</strong></p>
<p><strong>IsPortUnavalibleConnectType()实现自定义节点类型哪些节点类型信息不可连</strong></p>
<p><img src="/img/Unity/UIToolkit/AvalibleConnectPortPreview.PNG" alt="AvalibleConnectPortPreview"></p>
<p>通过GraphView:GetCompatiblePorts()返回所有可连接Port，我们可以看到当我们点击需要连接Port后，所有可连接Port会处于高亮状态(表示可连接)。</p>
<h4 id="节点Port连线还原"><a href="#节点Port连线还原" class="headerlink" title="节点Port连线还原"></a>节点Port连线还原</h4><p>前面我们实现了自定义Port连接操作，在端口连接后，我们重新加载图数据后如何还原Port连线了？</p>
<p>Port的连接是通过Edge(边)来实现的。</p>
<p>BehaviourTreeGraphView.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> BehaviourTreeGraphView.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 行为树GraphView</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BehaviourTreeGraphView</span> : <span class="title">GraphView</span></span><br><span class="line">&#123;</span><br><span class="line">    ******</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 创建指定图数据的所有边</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;graphData&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;addEdgeData&quot;&gt;</span>是否添加边数据<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;enableUndoSystem&quot;&gt;</span>是否开启Undo系统<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">CreateGraphAllEdges</span>(<span class="params">BehaviourTreeGraphData graphData, <span class="built_in">bool</span> addEdgeData = <span class="literal">true</span>, <span class="built_in">bool</span> enableUndoSystem = <span class="literal">true</span></span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (graphData == <span class="literal">null</span> || graphData.AllEdgeDataList == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> edgeData <span class="keyword">in</span> graphData.AllEdgeDataList)</span><br><span class="line">        &#123;</span><br><span class="line">            CreateEdgeByEdgeData(graphData, edgeData, addEdgeData, enableUndoSystem);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 指定节点View获取或创建指定名字和类型的输入端口</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;nodeView&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;portName&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;portTypeFullName&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Port <span class="title">GetOrCreateInputPort</span>(<span class="params">NodeView nodeView, <span class="built_in">string</span> portName, <span class="built_in">string</span> portTypeFullName</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (nodeView == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">$&quot;不允许给空节点View创建输入端口，创建端口名:<span class="subst">&#123;portName&#125;</span>类型:<span class="subst">&#123;portTypeFullName&#125;</span>的输入节点端口失败！&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> port = nodeView.inputContainer.Q&lt;Port&gt;(portName);</span><br><span class="line">        <span class="keyword">if</span> (port == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> portType = TypeCache.GetType(portTypeFullName);</span><br><span class="line">            <span class="keyword">if</span> (portType == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                Debug.LogError(<span class="string">$&quot;找不到类型全名:<span class="subst">&#123;portTypeFullName&#125;</span>的类型信息，创建端口名:<span class="subst">&#123;portName&#125;</span>的输入节点端口失败！&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            port = nodeView.InstantiateCustomInputPort(portName, portType);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> port;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 指定节点View获取或创建指定名字和类型的输出端口</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;nodeView&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;portName&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;portTypeFullName&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Port <span class="title">GetOrCreateOutputPort</span>(<span class="params">NodeView nodeView, <span class="built_in">string</span> portName, <span class="built_in">string</span> portTypeFullName</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (nodeView == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">$&quot;不允许给空节点View创建输出端口，创建端口名:<span class="subst">&#123;portName&#125;</span>类型:<span class="subst">&#123;portTypeFullName&#125;</span>的输出节点端口失败！&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> port = nodeView.outputContainer.Q&lt;Port&gt;(portName);</span><br><span class="line">        <span class="keyword">if</span> (port == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> portType = TypeCache.GetType(portTypeFullName);</span><br><span class="line">            <span class="keyword">if</span> (portType == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                Debug.LogError(<span class="string">$&quot;找不到类型全名:<span class="subst">&#123;portTypeFullName&#125;</span>的类型信息，创建端口名:<span class="subst">&#123;portName&#125;</span>的输出节点端口失败！&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            port = nodeView.InstantiateCustomOutputPort(portName, portType);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> port;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 添加显示边</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;edgeData&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;inputPort&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;outputPort&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Edge <span class="title">AddEdgeView</span>(<span class="params">EdgeData edgeData, Port inputPort, Port outputPort</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (edgeData == <span class="literal">null</span> || inputPort == <span class="literal">null</span> || outputPort == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">$&quot;不允许创建空边数据或空输入端口或空输出端口的显示边，创建显示边失败！&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> edgeView = CreateEdgeView(edgeData, inputPort, outputPort);</span><br><span class="line">        outputPort.Connect(edgeView);</span><br><span class="line">        inputPort.Connect(edgeView);</span><br><span class="line">        Add(edgeView);</span><br><span class="line">        OnEdgeViewUpdate(edgeView);</span><br><span class="line">        <span class="keyword">return</span> edgeView;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 创建显示边</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;edgeData&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;inputPort&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;outputPort&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> EdgeView <span class="title">CreateEdgeView</span>(<span class="params">EdgeData edgeData, Port inputPort, Port outputPort</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> edgeView = <span class="keyword">new</span> EdgeView()</span><br><span class="line">        &#123;</span><br><span class="line">            input = inputPort,</span><br><span class="line">            output = outputPort,</span><br><span class="line">        &#125;;</span><br><span class="line">        edgeView.Init(SourceGraphData, edgeData);</span><br><span class="line">        edgeView.UpdateEdgeControlStateColor();</span><br><span class="line">        <span class="keyword">return</span> edgeView;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 创建显示边</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;edgeData&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;inputPort&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;outputPort&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> EdgeView <span class="title">CreateEdgeView</span>(<span class="params">EdgeData edgeData, Port inputPort, Port outputPort</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> edgeView = <span class="keyword">new</span> EdgeView()</span><br><span class="line">        &#123;</span><br><span class="line">            input = inputPort,</span><br><span class="line">            output = outputPort,</span><br><span class="line">        &#125;;</span><br><span class="line">        edgeView.Init(SourceGraphData, edgeData);</span><br><span class="line">        edgeView.UpdateEdgeControlStateColor();</span><br><span class="line">        <span class="keyword">return</span> edgeView;</span><br><span class="line">    &#125;</span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>NodeView.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> NodeView.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 节点显示抽象</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">NodeView</span> : <span class="title">Node</span></span><br><span class="line">&#123;</span><br><span class="line">    ******</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 创建自定义输入Port</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;portName&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;type&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Port <span class="title">InstantiateCustomInputPort</span>(<span class="params"><span class="built_in">string</span> portName, System.Type type</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> port = InstantiateCustomPort(portName, Direction.Input, InPortCapacity, type);</span><br><span class="line">        inputContainer.Add(port);</span><br><span class="line">        mAllInputPorts.Add(port);</span><br><span class="line">        <span class="keyword">return</span> port;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 创建自定义输出Port</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;portName&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;type&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Port <span class="title">InstantiateCustomOutputPort</span>(<span class="params"><span class="built_in">string</span> portName, System.Type type</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> port = InstantiateCustomPort(portName, Direction.Output, OutPortCapacity, type);</span><br><span class="line">        outputContainer.Add(port);</span><br><span class="line">        mAllOutputPorts.Add(port);</span><br><span class="line">        <span class="keyword">return</span> port;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>EdgeView.cs</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> EdgeView.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 显示边基类</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">EdgeView</span> : <span class="title">Edge</span></span><br><span class="line">&#123;</span><br><span class="line">    ******</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 更新显示边线状态颜色</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">UpdateEdgeControlStateColor</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> edgeInputNode = OwnerGraphData.GetNodeByGUID(EdgeData.InputNodeGUID);</span><br><span class="line">        <span class="keyword">var</span> edgeInputColor = BTGraphUtilitiesEditor.GetEdgeColorByNodeState(edgeInputNode.NodeState);</span><br><span class="line">        <span class="keyword">var</span> edgeOutputColor = BTGraphUtilitiesEditor.GetEdgeColorByNodeState(edgeInputNode.NodeState);</span><br><span class="line">        edgeControl.inputColor = edgeInputColor;</span><br><span class="line">        edgeControl.outputColor = edgeOutputColor;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li><p>在创建完所有NodeView(BehaviourTreeGraphView.CreateGraphAllNodes())后，我们根据BehaviourTreeGraphData.AllEdgeDataList的所有边数据，通过边数据EdgeData.OutputNodeGUID和EdgeData.InputNodeGUID获得边所对应的输入输出NodeView。</p>
</li>
<li><p>得到边所对应的NodeView后，我们通过EdgeData边数据的端口信息给NodeView创建对应的输入和输出端口(GetOrCreateOutputPort()和GetOrCreateInputPort())。</p>
</li>
<li><p>创建好NodeView的对应输入和输出端口后，我们通过创建自定义EdgeView(CreateEdgeView())将创建的输入和输出端口传入作为边的对应连接端口，最后初始化EdgeView对应图和边数据(EdgeData.Init(<em>))并添加到GraphView</em>(Add(edgeView))则成功创建并还原了连接NodeView之间的EdgeView显示。</p>
</li>
</ol>
<p><img src="/img/Unity/UIToolkit/CreateEdgeViewFromEdgeData.PNG" alt="CreateEdgeViewFromEdgeData"></p>
<p>Note:</p>
<ol>
<li><strong>Edge(边)的输入Port是被连线的一侧，输出Port是开始连线的一侧。</strong></li>
<li><strong>Node(节点)的输入端口是Edge连入的一侧，输出端口是Edge连出的一侧。</strong></li>
</ol>
<h4 id="节点参数面板添加"><a href="#节点参数面板添加" class="headerlink" title="节点参数面板添加"></a>节点参数面板添加</h4><p>不同的节点有不同的数据需要展示和配置，节点数据的配置面板在节点编辑器中是必不可少的。</p>
<p>显示节点参数面板步骤如下：</p>
<ol>
<li>创建节点参数面板容器</li>
<li>检测节点选中</li>
<li>创建节点参数显示UI并添加到参数面板容器显示</li>
</ol>
<p>UIBTGraphEditorWindow.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> UIBTGraphEditorWindow.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 行为树图窗口类</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UIBTGraphEditorWindow</span> : <span class="title">EditorWindow</span></span><br><span class="line">&#123;</span><br><span class="line">   ******</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 临时绑定属性Map<span class="doctag">&lt;属性名, 属性绑定数据&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> Dictionary&lt;<span class="built_in">string</span>, PropertyBindData&gt; mTempBindPropertyDataMap = <span class="keyword">new</span> Dictionary&lt;<span class="built_in">string</span>, PropertyBindData&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 创建右侧内容UI显示</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">CreateRightContentUI</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> rightVerticalContentContainer = <span class="keyword">new</span> VisualElement();</span><br><span class="line">        rightVerticalContentContainer.name = BTGraphElementNames.RightVerticalContentContainerName;</span><br><span class="line">        rightVerticalContentContainer.style.left = <span class="number">0</span>;</span><br><span class="line">        rightVerticalContentContainer.style.width = <span class="number">300f</span>;</span><br><span class="line">        rightVerticalContentContainer.style.top = <span class="number">0</span>;</span><br><span class="line">        rightVerticalContentContainer.style.bottom = <span class="number">0</span>;</span><br><span class="line">        rightVerticalContentContainer.style.flexDirection = FlexDirection.Column;</span><br><span class="line">        rightVerticalContentContainer.AddToClassList(<span class="string">&quot;unity-rect-field&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> toolbarMenu = <span class="keyword">new</span> Toolbar();</span><br><span class="line">        toolbarMenu.name = BTGraphElementNames.RightToolbarMenuName;</span><br><span class="line">        toolbarMenu.style.flexDirection = FlexDirection.Row;</span><br><span class="line">        toolbarMenu.style.height = <span class="number">25f</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> rightNodeConfigMenuButton = <span class="keyword">new</span> Button(OnNodeConfigMenuClick);</span><br><span class="line">        rightNodeConfigMenuButton.name = BTGraphElementNames.RightNodeConfigMenuButtonName;</span><br><span class="line">        rightNodeConfigMenuButton.text = <span class="string">&quot;节点参数&quot;</span>;</span><br><span class="line">        rightNodeConfigMenuButton.style.flexGrow = <span class="number">1f</span>;</span><br><span class="line">        rightNodeConfigMenuButton.AddToClassList(<span class="string">&quot;unity-toggle&quot;</span>);</span><br><span class="line">        toolbarMenu.Add(rightNodeConfigMenuButton);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> rightBlackboardMenuButton = <span class="keyword">new</span> Button(OnBlackboardMenuClick);</span><br><span class="line">        rightBlackboardMenuButton.name = BTGraphElementNames.RightBlackboardMenuButtonName;</span><br><span class="line">        rightBlackboardMenuButton.text = <span class="string">&quot;黑板&quot;</span>;</span><br><span class="line">        rightBlackboardMenuButton.style.flexGrow = <span class="number">1f</span>;</span><br><span class="line">        rightBlackboardMenuButton.AddToClassList(<span class="string">&quot;unity-toggle&quot;</span>);</span><br><span class="line">        toolbarMenu.Add(rightBlackboardMenuButton);</span><br><span class="line"></span><br><span class="line">        rightVerticalContentContainer.Add(toolbarMenu);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> rightPanelVerticalContainer = UIToolkitUtilities.CreateVerticalContainer(BTGraphElementNames.RightPanelVerticalContainerName, <span class="number">1f</span>, <span class="string">&quot;unity-rect-field&quot;</span>);</span><br><span class="line">        rightVerticalContentContainer.Add(rightPanelVerticalContainer);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> horizontalContentContainer = rootVisualElement.Q&lt;VisualElement&gt;(BTGraphElementNames.HorizontalContentContainerName);</span><br><span class="line">        horizontalContentContainer.Add(rightVerticalContentContainer);</span><br><span class="line"></span><br><span class="line">        UpdateSelectedPanelUI();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 更新选中面板类型</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;panelType&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">UpdateSelectedPanel</span>(<span class="params">PanelType panelType</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        mCurrentSelectedPanelType = panelType;</span><br><span class="line">        UpdateSelectedPanelUI();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 更新选中面板显示UI</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">UpdateSelectedPanelUI</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> rightPanelVerticalContainer = rootVisualElement.Q&lt;VisualElement&gt;(BTGraphElementNames.RightPanelVerticalContainerName);</span><br><span class="line">        rightPanelVerticalContainer.Clear();</span><br><span class="line">        <span class="keyword">if</span> (mCurrentSelectedPanelType == PanelType.NODE_CONFIG_PANEL)</span><br><span class="line">        &#123;</span><br><span class="line">            CreateSelectionNodeConfigUI();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (mCurrentSelectedPanelType == PanelType.BLACKBOARD_PANEL)</span><br><span class="line">        &#123;</span><br><span class="line">            CreateBlackboardUI();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            CreateNotSupportPanelTypeUI();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 创建选择节点配置UI</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">CreateSelectionNodeConfigUI</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> rightPanelVerticalContainer = rootVisualElement.Q&lt;VisualElement&gt;(BTGraphElementNames.RightPanelVerticalContainerName);</span><br><span class="line">        <span class="keyword">var</span> rightNodeConfigVerticalContainer = UIToolkitUtilities.CreateVerticalContainer(BTGraphElementNames.RightNodeConfigVerticalContainerName);</span><br><span class="line">        rightPanelVerticalContainer.Add(rightNodeConfigVerticalContainer);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> rightVerticalContentLableTitle = <span class="keyword">new</span> Label();</span><br><span class="line">        rightVerticalContentLableTitle.text = <span class="string">&quot;参数面板&quot;</span>;</span><br><span class="line">        rightVerticalContentLableTitle.style.height = <span class="number">20f</span>;</span><br><span class="line">        rightVerticalContentLableTitle.style.alignSelf = Align.Center;</span><br><span class="line">        rightNodeConfigVerticalContainer.Add(rightVerticalContentLableTitle);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mGraphView.SelectedNode != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            CreateSelectedNodeInspector(rightNodeConfigVerticalContainer, mGraphView.SelectedNode);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> rightSelectedNodeTipLabelTitle = <span class="keyword">new</span> Label();</span><br><span class="line">            rightSelectedNodeTipLabelTitle.text = <span class="string">&quot;无选中节点&quot;</span>;</span><br><span class="line">            rightSelectedNodeTipLabelTitle.style.height = <span class="number">20</span>;</span><br><span class="line">            rightSelectedNodeTipLabelTitle.style.alignSelf = Align.Center;</span><br><span class="line">            rightNodeConfigVerticalContainer.Add(rightSelectedNodeTipLabelTitle);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 给指定面板添加选中节点GUI显示</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;nodeInspectorContainer&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;selectedNodeView&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">CreateSelectedNodeInspector</span>(<span class="params">VisualElement nodeInspectorContainer, NodeView selectedNodeView</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(nodeInspectorContainer == <span class="literal">null</span> || selectedNodeView == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.Log(<span class="string">$&quot;不允许给空容器或空显示节点创建选中节点GUI显示！&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        mTempBindPropertyDataMap.Clear();</span><br><span class="line">        <span class="keyword">var</span> inspectorUIElement = selectedNodeView.CreateInspectorGUIElement(mTempBindPropertyDataMap);</span><br><span class="line">        nodeInspectorContainer.Add(inspectorUIElement);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 响应节点根节点设置变化</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;nodeView&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">OnNodeEntryPointValueChange</span>(<span class="params">NodeView nodeView</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> nodeData = nodeView.NodeData;</span><br><span class="line">        Debug.Log(<span class="string">$&quot;响应节点GUID:<span class="subst">&#123;nodeData.GUID&#125;</span>的根节点设置变化到:<span class="subst">&#123;nodeData.EntryPoint&#125;</span>&quot;</span>);</span><br><span class="line">        nodeView.style.backgroundColor = BTGraphUtilitiesEditor.GetBackgroundColorByNodeData(nodeData);</span><br><span class="line">        <span class="comment">// 根节点不允许输入端连接任何节点</span></span><br><span class="line">        <span class="keyword">if</span> (nodeData.EntryPoint)</span><br><span class="line">        &#123;</span><br><span class="line">            DisconnectAllInputPort(nodeView);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 创建新的GraphView</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> BehaviourTreeGraphView <span class="title">GetNewGraphView</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> BehaviourTreeGraphView(mAvailableNodeTypeList, <span class="keyword">this</span>.OnSelectedNodeChange);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ******</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>PropertyBindData.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 属性绑定数据</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PropertyBindData</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 绑定属性名</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> BindPropertyName</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 绑定SerializedObject</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> SerializedObject BindSerializedObject</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 绑定属性</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> SerializedProperty BindSerializedProperty</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 绑定属性显示组件</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> PropertyField BindVisualElement</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 构造函数</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;bindSerializedObject&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;bindSerializedProperty&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;bindVisualElement&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PropertyBindData</span>(<span class="params">SerializedObject bindSerializedObject, SerializedProperty bindSerializedProperty, PropertyField bindVisualElement</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        BindSerializedObject = bindSerializedObject;</span><br><span class="line">        BindSerializedProperty = bindSerializedProperty;</span><br><span class="line">        BindVisualElement = bindVisualElement;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>UIToolkitUtilities.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> UIToolkitUtilities.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> UIToolkit工具类</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">UIToolkitUtilities</span></span><br><span class="line">&#123;</span><br><span class="line">    ******</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 指定容器创建指定对象的可视化Inspector</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;scriptableObject&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;propertyBindDataMap&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> VisualElement <span class="title">CreateBindSOInspector</span>(<span class="params">ScriptableObject scriptableObject, Dictionary&lt;<span class="built_in">string</span>, PropertyBindData&gt; propertyBindDataMap = <span class="literal">null</span></span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(scriptableObject == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">$&quot;不允许给空ScriptableObject创建可视化Inspector！&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> container = CreateVerticalContainer(<span class="literal">null</span>, <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">var</span> serializedObject = <span class="keyword">new</span> SerializedObject(scriptableObject);</span><br><span class="line">        <span class="keyword">var</span> propertyIterator = serializedObject.GetIterator();</span><br><span class="line">        propertyIterator.NextVisible(<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">while</span>(propertyIterator.NextVisible(<span class="literal">false</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> propertyField = <span class="keyword">new</span> PropertyField();</span><br><span class="line">            <span class="keyword">var</span> propertyName = propertyIterator.name;</span><br><span class="line">            <span class="keyword">var</span> property = serializedObject.FindProperty(propertyName);</span><br><span class="line">            propertyField.name = propertyName;</span><br><span class="line">            propertyField.BindProperty(property);</span><br><span class="line">            container.Add(propertyField);</span><br><span class="line">            <span class="keyword">if</span>(propertyBindDataMap != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> propertyBindData = <span class="keyword">new</span> PropertyBindData(serializedObject, property, propertyField);</span><br><span class="line">                propertyBindDataMap.Add(propertyName, propertyBindData);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> container;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>NodeView.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> NodeView.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 节点显示抽象</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">NodeView</span> : <span class="title">Node</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 节点选择委托</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">protected</span> Action&lt;NodeView&gt; mNodeSelectedDelegate;</span><br><span class="line"></span><br><span class="line">    ******</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 根据Node数据初始化</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;nodeData&quot;&gt;</span>节点数据<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;nodeSelectedCB&quot;&gt;</span>节点选择委托<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;nodeName&quot;&gt;</span>节点名(默认不传为BaseNode的类型名)<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;orientation&quot;&gt;</span>节点方向<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Init</span>(<span class="params">BaseNode node, Action&lt;NodeView&gt; nodeSelectedCB = <span class="literal">null</span>, <span class="built_in">string</span> nodeName = <span class="literal">null</span>, Orientation orientation = Orientation.Horizontal</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        ******</span><br><span class="line">        mNodeSelectedDelegate += nodeSelectedCB;</span><br><span class="line">        ******</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ******</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 响应节点选择</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnSelected</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">base</span>.OnSelected();</span><br><span class="line">        Debug.Log(<span class="string">$&quot;节点GUID:<span class="subst">&#123;NodeData.GUID&#125;</span>,节点类型:<span class="subst">&#123;NodeData.NodeType&#125;</span>，节点名:<span class="subst">&#123;NodeData.GetType().Name&#125;</span>被选中！&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (mNodeSelectedDelegate != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            mNodeSelectedDelegate(<span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>BehaviourTreeGraphView.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> BehaviourTreeGraphView.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 行为树GraphView</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BehaviourTreeGraphView</span> : <span class="title">GraphView</span></span><br><span class="line">&#123;</span><br><span class="line">    ******</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 创建指定类型信息和节点名的新节点</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;typeInfo&quot;&gt;</span>类型信息<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;position&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;isEntryNode&quot;&gt;</span>是否是根节点<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> NodeView <span class="title">CreateNodeByType</span>(<span class="params">Type typeInfo, Vector2 position</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> newNode = BTGraphUtilitiesEditor.CreateNodeInstance(typeInfo);</span><br><span class="line">        <span class="keyword">var</span> guid = Guid.NewGuid().ToString();</span><br><span class="line">        <span class="keyword">var</span> nodeRect = BTGraphConstEditor.NodeDefaultRect;</span><br><span class="line">        nodeRect.x = position.x;</span><br><span class="line">        nodeRect.y = position.y;</span><br><span class="line">        newNode.Init(guid, nodeRect);</span><br><span class="line">        <span class="keyword">var</span> nodeView = BTGraphUtilitiesEditor.CreateNodeViewInstance(typeInfo);</span><br><span class="line">        nodeView.Init(SourceGraphData, newNode, OnNodeSelected, <span class="literal">null</span>, GraphOrientation);</span><br><span class="line">        AddNodeData(newNode);</span><br><span class="line">        AddElement(nodeView);</span><br><span class="line">        UpdateNodeViewRect(nodeView, nodeRect);</span><br><span class="line">        <span class="keyword">return</span> nodeView;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 相应节点选择</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;selectedNode&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">OnNodeSelected</span>(<span class="params">NodeView selectedNode</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Debug.Log(<span class="string">$&quot;CommonGraphView:OnNodeSelected()&quot;</span>);</span><br><span class="line">        UpdateSelectedNode(selectedNode);</span><br><span class="line">    &#125;</span><br><span class="line">        </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 更新选择节点</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;selectedNode&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">UpdateSelectedNode</span>(<span class="params">NodeView selectedNode</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        SelectedNode = selectedNode;</span><br><span class="line">        <span class="keyword">if</span> (mSelectedNodeChangeDelegate != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            mSelectedNodeChangeDelegate(SelectedNode);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/img/Unity/UIToolkit/NodeDIYParamsDisplay.PNG" alt="NodeDIYParamsDisplay"></p>
<p>从上面可以看到，我们通过创建BehaviourTreeGraphView时传入节点选择回调，然后创建节点时有把这个回调传给节点，最后在Node.OnSelected()里响应选中，最终成功实现选中节点的逻辑回调。</p>
<p>得到选中节点后，我们把UIBTGraphEditorWindow.CreateSelectionNodeConfigUI()实现参数面板的动态创建。</p>
<p><strong>为了监听节点的EntryPoint属性变化做出节点刷新显示，在UIToolkitUtilities.CreateBindSOInspector()方法里，我支持了传递绑定数据Map返回所有属性绑定Map的方式，实现对指定属性的自定义变化监听绑定。</strong></p>
<p>Note:</p>
<ol>
<li><strong>为了使用PropertyField快速实现属性绑定展示，这里图和节点数据都继承至ScriptableObject，存储成Asset和SubAsset的方式，最后通过UIToolkitUtilities.CreateBindSOInspector()方法创建通用的节点属性绑定显示</strong></li>
</ol>
<h4 id="节点右键操作添加"><a href="#节点右键操作添加" class="headerlink" title="节点右键操作添加"></a>节点右键操作添加</h4><p>除了通过操作面板选择节点进行节点创建操作，我们还可以给节点实现右键打开附属菜单的方式实现快捷节点操作功能。</p>
<p>BehaviourTreeGraphView.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> BehaviourTreeGraphView.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 行为树GraphView</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BehaviourTreeGraphView</span> : <span class="title">GraphView</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 菜单操作类型</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">enum</span> MenuOperationType</span><br><span class="line">    &#123;</span><br><span class="line">        CreateNode = <span class="number">1</span>,             <span class="comment">// 创建节点</span></span><br><span class="line">        DeleteNodeOnly,             <span class="comment">// 删除节点自身</span></span><br><span class="line">        DeleteNodeRecusive,         <span class="comment">// 递归删除节点</span></span><br><span class="line">        DuplicatedNodeOnly,         <span class="comment">// 复制粘贴节点(非递归)</span></span><br><span class="line">        DuplicateNodeRecusive,      <span class="comment">// 复制粘贴节点(递归)</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 菜单自定义数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MenuUserData</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 菜单操作类型</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> MenuOperationType OperationType</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span>;</span><br><span class="line">            <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 菜单操作VisualElement</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> VisualElement OperationElement</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span>;</span><br><span class="line">            <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 自定义数据</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> System.Object CustomData</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span>;</span><br><span class="line">            <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">MenuUserData</span>(<span class="params">MenuOperationType operationType, VisualElement operationElement, System.Object customData</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            OperationType = operationType;</span><br><span class="line">            OperationElement = operationElement;</span><br><span class="line">            CustomData = customData;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ******</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 节点类型可用通用菜单操作类型列表Map<span class="doctag">&lt;节点类型, 可用通用菜单操作类型列表&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">protected</span> Dictionary&lt;NodeType, List&lt;MenuOperationType&gt;&gt; mNodeCommonOperationTypesMap;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 节点类型可用菜单节点类型信息列表Map<span class="doctag">&lt;节点类型, &lt;节点类型, 可用节点类型信息列表&gt;</span>&gt;</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">protected</span> Dictionary&lt;NodeType, Dictionary&lt;NodeType, List&lt;Type&gt;&gt;&gt; mNodeTypeMenuTypesMap;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 带参构造函数</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;availableNodeTypeList&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;selectedNodeChangeCB&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BehaviourTreeGraphView</span>(<span class="params">List&lt;NodeType&gt; availableNodeTypeList, Action&lt;NodeView&gt; selectedNodeChangeCB = <span class="literal">null</span></span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        mAvailableNodeTypeList = availableNodeTypeList;</span><br><span class="line">        mSelectedNodeChangeDelegate += selectedNodeChangeCB;</span><br><span class="line">        Init();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 初始化</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Init</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">      	******</span><br><span class="line">        InitMenuData();</span><br><span class="line">      	******</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 初始化节点菜单数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">InitMenuData</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        InitNodeCommonMenuOperationDatas();</span><br><span class="line">        InitNodeMenuTypesData();</span><br><span class="line">        InitGraphViewMenuTypesData();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 初始化节点通用菜单操作数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">InitNodeCommonMenuOperationDatas</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mNodeCommonOperationTypesMap = <span class="keyword">new</span> Dictionary&lt;NodeType, List&lt;MenuOperationType&gt;&gt;();</span><br><span class="line">        <span class="keyword">var</span> nodeTypeValues = Enum.GetValues(<span class="keyword">typeof</span>(NodeType));</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> nodeTypeValue <span class="keyword">in</span> nodeTypeValues)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> commonMenuOperationTypeList = <span class="keyword">new</span> List&lt;MenuOperationType&gt;();</span><br><span class="line">            mNodeCommonOperationTypesMap.Add((NodeType)nodeTypeValue, commonMenuOperationTypeList);</span><br><span class="line">            commonMenuOperationTypeList.Add(MenuOperationType.DeleteNodeOnly);</span><br><span class="line">            commonMenuOperationTypeList.Add(MenuOperationType.DeleteNodeRecusive);</span><br><span class="line">            commonMenuOperationTypeList.Add(MenuOperationType.DuplicatedNodeOnly);</span><br><span class="line">            commonMenuOperationTypeList.Add(MenuOperationType.DuplicateNodeRecusive);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 初始化节点菜单类型信息数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">InitNodeMenuTypesData</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mNodeTypeMenuTypesMap = <span class="keyword">new</span> Dictionary&lt;NodeType, Dictionary&lt;NodeType, List&lt;Type&gt;&gt;&gt;();</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> portAvalibleConnectNodeTypeInfo <span class="keyword">in</span> mPortAvailableConnectNodeTypeMap)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (portAvalibleConnectNodeTypeInfo.Value.Count == <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">var</span> nodeTypeMenuTypeMap = <span class="keyword">new</span> Dictionary&lt;NodeType, List&lt;Type&gt;&gt;();</span><br><span class="line">            mNodeTypeMenuTypesMap.Add(portAvalibleConnectNodeTypeInfo.Key, nodeTypeMenuTypeMap);</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">var</span> portAvalibleConnectNodeTypeMap <span class="keyword">in</span> portAvalibleConnectNodeTypeInfo.Value)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> targetNodeType = portAvalibleConnectNodeTypeMap.Key;</span><br><span class="line">                <span class="keyword">var</span> targetNodeBaseType = GetBaseTypeByNodeType(targetNodeType);</span><br><span class="line">                <span class="keyword">if</span> (targetNodeBaseType == <span class="literal">null</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">var</span> menuTypeList = <span class="keyword">new</span> List&lt;Type&gt;();</span><br><span class="line">                nodeTypeMenuTypeMap.Add(targetNodeType, menuTypeList);</span><br><span class="line">                <span class="keyword">var</span> allSubTypeList = TypeUtilities.GetAllSubTypes(targetNodeBaseType);</span><br><span class="line">                <span class="keyword">foreach</span> (<span class="keyword">var</span> subType <span class="keyword">in</span> allSubTypeList)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">if</span> (subType.IsAbstract || IsPortUnavalibleConnectType(targetNodeType, subType))</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    menuTypeList.Add(subType);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 移除没有任何一个有效类型的节点类型数据</span></span><br><span class="line">                <span class="keyword">if</span> (menuTypeList.Count == <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    nodeTypeMenuTypeMap.Remove(targetNodeType);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 初始化GraphView菜单数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">InitGraphViewMenuTypesData</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mGraphViewMenuTypesMap = <span class="keyword">new</span> Dictionary&lt;NodeType, List&lt;Type&gt;&gt;();</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> availableNodeType <span class="keyword">in</span> mAvailableNodeTypeList)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> targetNodeBaseType = GetBaseTypeByNodeType(availableNodeType);</span><br><span class="line">            <span class="keyword">if</span> (targetNodeBaseType == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">var</span> menuTypeList = <span class="keyword">new</span> List&lt;Type&gt;();</span><br><span class="line">            mGraphViewMenuTypesMap.Add(availableNodeType, menuTypeList);</span><br><span class="line">            <span class="keyword">var</span> allSubTypeList = TypeUtilities.GetAllSubTypes(targetNodeBaseType);</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">var</span> subType <span class="keyword">in</span> allSubTypeList)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (subType.IsAbstract)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                menuTypeList.Add(subType);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 移除没有任何一个有效类型的节点类型数据</span></span><br><span class="line">            <span class="keyword">if</span> (menuTypeList.Count == <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                mGraphViewMenuTypesMap.Remove(availableNodeType);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 获取制定通用菜单操作类型的子菜单名</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 子菜单名组成 = 菜单操作类型名</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;menuOperationType&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="built_in">string</span> <span class="title">GetMenuOperationName</span>(<span class="params">MenuOperationType menuOperationType</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">$&quot;<span class="subst">&#123;menuOperationType.ToString()&#125;</span>&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 获取指定节点类型信息的子菜单名</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 子菜单名组成 = 节点类型/节点类型名</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;nodeType&quot;&gt;</span>节点类型<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;type&quot;&gt;</span>节点类型信息<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="built_in">string</span> <span class="title">GetNodeTypeSubMenuName</span>(<span class="params">NodeType nodeType, Type type</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(type == <span class="literal">null</span> || type == BTGraphConstEditor.BaseNodeType</span><br><span class="line">            || !type.IsSubclassOf(BTGraphConstEditor.BaseNodeType))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">$&quot;<span class="subst">&#123;nodeType.ToString()&#125;</span>/<span class="subst">&#123;type.Name&#125;</span>&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 响应菜单栏添加</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;evt&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">BuildContextualMenu</span>(<span class="params">ContextualMenuPopulateEvent evt</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//base.BuildContextualMenu(evt);</span></span><br><span class="line">        BuildNodeContextualMenu(evt);</span><br><span class="line">        BuildGraphContextualMenu(evt);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 构建节点菜单栏</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;evt&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">BuildNodeContextualMenu</span>(<span class="params">ContextualMenuPopulateEvent evt</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> target = evt.target;</span><br><span class="line">        <span class="keyword">var</span> targetNodeView = target <span class="keyword">as</span> NodeView;</span><br><span class="line">        <span class="keyword">if</span> (targetNodeView == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> nodeType = targetNodeView.NodeData.NodeType;</span><br><span class="line">        <span class="keyword">var</span> allCommonMenuOperationTypes = GetNodeCommonMenuOperationTypes(nodeType);</span><br><span class="line">        <span class="keyword">if</span> (allCommonMenuOperationTypes != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">var</span> commonOperationType <span class="keyword">in</span> allCommonMenuOperationTypes)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> menuOperationName = GetMenuOperationName(commonOperationType);</span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">string</span>.IsNullOrEmpty(menuOperationName))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">var</span> menuUserData = <span class="keyword">new</span> MenuUserData(commonOperationType, targetNodeView, commonOperationType);</span><br><span class="line">                evt.menu.AppendAction(menuOperationName, OnNodeViewCommonMenuOperationNode, OnSubMenuStatus, menuUserData);</span><br><span class="line">                <span class="comment">//Debug.Log($&quot;添加子菜单:&#123;menuOperationName&#125;&quot;);</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> allSubMenuTypesMap = GetNodeTypeMenuTypesMap(nodeType);</span><br><span class="line">        <span class="keyword">if</span> (allSubMenuTypesMap != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">var</span> subMenuTypesMap <span class="keyword">in</span> allSubMenuTypesMap)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> targetNodeType = subMenuTypesMap.Key;</span><br><span class="line">                <span class="keyword">foreach</span> (<span class="keyword">var</span> subMenuType <span class="keyword">in</span> subMenuTypesMap.Value)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">if</span> (subMenuType.IsAbstract)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">var</span> subMenuName = GetNodeTypeSubMenuName(targetNodeType, subMenuType);</span><br><span class="line">                    <span class="keyword">if</span> (<span class="built_in">string</span>.IsNullOrEmpty(subMenuName))</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">var</span> menuUserData = <span class="keyword">new</span> MenuUserData(MenuOperationType.CreateNode, targetNodeView, subMenuType);</span><br><span class="line">                    evt.menu.AppendAction(subMenuName, OnNodeViewSubMenuCreateNode, OnSubMenuStatus, menuUserData);</span><br><span class="line">                    <span class="comment">//Debug.Log($&quot;添加子菜单:&#123;subMenuName&#125;&quot;);</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 响应NodeView节点通用菜单操作</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;menuAction&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">OnNodeViewCommonMenuOperationNode</span>(<span class="params">DropdownMenuAction menuAction</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> menuUserData = menuAction.userData <span class="keyword">as</span> MenuUserData;</span><br><span class="line">        <span class="keyword">var</span> targetNodeView = menuUserData.OperationElement <span class="keyword">as</span> NodeView;</span><br><span class="line">        <span class="keyword">var</span> menuOperationType = menuUserData.OperationType;</span><br><span class="line">        <span class="keyword">if</span> (menuOperationType == MenuOperationType.DeleteNodeOnly)</span><br><span class="line">        &#123;</span><br><span class="line">            RemoveNodeView(targetNodeView, <span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (menuOperationType == MenuOperationType.DeleteNodeRecusive)</span><br><span class="line">        &#123;</span><br><span class="line">            RemoveNodeView(targetNodeView, <span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (menuOperationType == MenuOperationType.DuplicatedNodeOnly)</span><br><span class="line">        &#123;</span><br><span class="line">            DuplicateNodeView(targetNodeView, <span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(menuOperationType == MenuOperationType.DuplicateNodeRecusive)</span><br><span class="line">        &#123;</span><br><span class="line">            DuplicateNodeView(targetNodeView, <span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 响应NodeView子菜单栏创建节点</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;menuAction&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">OnNodeViewSubMenuCreateNode</span>(<span class="params">DropdownMenuAction menuAction</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> menuUserData = menuAction.userData <span class="keyword">as</span> MenuUserData;</span><br><span class="line">        <span class="keyword">var</span> nodeType = menuUserData.CustomData <span class="keyword">as</span> Type;</span><br><span class="line">        Vector2 actualGraphPosition = TransformGridLocalMousePosToGraphPos(menuAction.eventInfo.localMousePosition);</span><br><span class="line">        <span class="keyword">var</span> nodeView = CreateNodeByType(nodeType, actualGraphPosition);</span><br><span class="line">        <span class="keyword">var</span> nodeViewPosition = nodeView.GetPosition();</span><br><span class="line">        nodeViewPosition.position = actualGraphPosition;</span><br><span class="line">        UpdateNodeViewRect(nodeView, nodeViewPosition);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Debug.Log($&quot;CommonGraphView:OnNodeViewSubMenuCreateNode() NodeType:&#123;menuUserData.SourceNodeView.NodeData.NodeType&#125;&quot;);</span></span><br><span class="line">        <span class="comment">//Debug.Log($&quot;localMousePosition:&#123;menuAction.eventInfo.localMousePosition.ToString()&#125;&quot;);</span></span><br><span class="line">        <span class="comment">//Debug.Log($&quot;mousePosition:&#123;menuAction.eventInfo.mousePosition.ToString()&#125;&quot;);</span></span><br><span class="line">        <span class="comment">//Debug.Log($&quot;actualGraphPosition:&#123;actualGraphPosition.ToString()&#125;&quot;);</span></span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> 创建节点Port链接</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 响应节点子菜单栏Item状态</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;menuAction&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="keyword">protected</span> DropdownMenuAction.<span class="function">Status <span class="title">OnSubMenuStatus</span>(<span class="params">DropdownMenuAction menuAction</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        MenuUserData menuUserData = menuAction.userData <span class="keyword">as</span> MenuUserData;</span><br><span class="line">        NodeView nodeView = menuUserData.OperationElement <span class="keyword">as</span> NodeView;</span><br><span class="line">        <span class="keyword">if</span> (nodeView != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (nodeView.NodeData.EntryPoint)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">bool</span> isDeleteNodeOnlyType = menuUserData.OperationType == MenuOperationType.DeleteNodeOnly;</span><br><span class="line">                <span class="built_in">bool</span> isDeleteNodeRecusiveType = menuUserData.OperationType == MenuOperationType.DeleteNodeRecusive;</span><br><span class="line">                <span class="built_in">bool</span> isDuplicatedNodeOperationType = menuUserData.OperationType == MenuOperationType.DuplicatedNodeOnly;</span><br><span class="line">                <span class="built_in">bool</span> isDuplicateNodeRecusiveOperation = menuUserData.OperationType == MenuOperationType.DuplicateNodeRecusive;</span><br><span class="line">                <span class="keyword">if</span> (isDeleteNodeOnlyType || isDeleteNodeRecusiveType || isDuplicatedNodeOperationType || isDuplicateNodeRecusiveOperation)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">return</span> DropdownMenuAction.Status.Disabled;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> DropdownMenuAction.Status.Normal;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> DropdownMenuAction.Status.Disabled;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 构建GraphView菜单栏</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;evt&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">BuildGraphContextualMenu</span>(<span class="params">ContextualMenuPopulateEvent evt</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> target = evt.target;</span><br><span class="line">        <span class="keyword">var</span> targetGraphView = target <span class="keyword">as</span> GraphView;</span><br><span class="line">        <span class="keyword">if</span> (targetGraphView == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> graphViewTypesMap <span class="keyword">in</span> mGraphViewMenuTypesMap)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> nodeType = graphViewTypesMap.Key;</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">var</span> graphViewType <span class="keyword">in</span> graphViewTypesMap.Value)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (graphViewType.IsAbstract)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">var</span> subMenuName = GetNodeTypeSubMenuName(nodeType, graphViewType);</span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">string</span>.IsNullOrEmpty(subMenuName))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">var</span> menuUserData = <span class="keyword">new</span> MenuUserData(MenuOperationType.CreateNode, <span class="literal">null</span>, graphViewType);</span><br><span class="line">                evt.menu.AppendAction(subMenuName, OnGraphViewSubMenuCreateNode, OnGraphSubMenuStatus, menuUserData);</span><br><span class="line">                <span class="comment">//Debug.Log($&quot;添加子菜单:&#123;subMenuName&#125;&quot;);</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 响应GraphView子菜单创建节点</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;menuAction&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">OnGraphViewSubMenuCreateNode</span>(<span class="params">DropdownMenuAction menuAction</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> menuUserData = menuAction.userData <span class="keyword">as</span> MenuUserData;</span><br><span class="line">        <span class="keyword">var</span> nodeType = menuUserData.CustomData <span class="keyword">as</span> Type;</span><br><span class="line">        Vector2 actualGraphPosition = TransformGridLocalMousePosToGraphPos(menuAction.eventInfo.localMousePosition);</span><br><span class="line">        <span class="keyword">var</span> nodeView = CreateNodeByType(nodeType, actualGraphPosition);</span><br><span class="line">        <span class="keyword">var</span> nodeViewPosition = nodeView.GetPosition();</span><br><span class="line">        nodeViewPosition.position = actualGraphPosition;</span><br><span class="line">        UpdateNodeViewRect(nodeView, nodeViewPosition);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Debug.Log($&quot;CommonGraphView:OnGraphViewSubMenuCreateNode()&quot;);</span></span><br><span class="line">        <span class="comment">//Debug.Log($&quot;localMousePosition:&#123;menuAction.eventInfo.localMousePosition.ToString()&#125;&quot;);</span></span><br><span class="line">        <span class="comment">//Debug.Log($&quot;mousePosition:&#123;menuAction.eventInfo.mousePosition.ToString()&#125;&quot;);</span></span><br><span class="line">        <span class="comment">//Debug.Log($&quot;actualGraphPosition:&#123;actualGraphPosition.ToString()&#125;&quot;);</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 响应图子菜单栏Item状态</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;menuAction&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="keyword">protected</span> DropdownMenuAction.<span class="function">Status <span class="title">OnGraphSubMenuStatus</span>(<span class="params">DropdownMenuAction menuAction</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> DropdownMenuAction.Status.Normal;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 移除指定节点View</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;nodeView&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;recusive&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;enableUndoSystem&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="built_in">bool</span> <span class="title">RemoveNodeView</span>(<span class="params">NodeView nodeView, <span class="built_in">bool</span> recusive = <span class="literal">false</span>, <span class="built_in">bool</span> enableUndoSystem = <span class="literal">true</span></span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (nodeView == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">$&quot;不允许移除空NodeView，删除节点View失败！&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!Contains(nodeView))</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">$&quot;未包含NodeView GUID:<span class="subst">&#123;nodeView.NodeData.GUID&#125;</span>的节点View，删除节点View失败！&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(enableUndoSystem)</span><br><span class="line">        &#123;</span><br><span class="line">        	Undo.RecordObject(SourceGraphData, <span class="string">$&quot;RemoveNodeView(<span class="subst">&#123;recusive&#125;</span>)&quot;</span>);            </span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!recusive)</span><br><span class="line">        &#123;</span><br><span class="line">            RemoveNodeViewWithAllEdge(nodeView);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> allChildNodeViews = GetAllChildNodeViews(nodeView);</span><br><span class="line">        <span class="keyword">if</span> (allChildNodeViews != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">var</span> childNodeView <span class="keyword">in</span> allChildNodeViews)</span><br><span class="line">            &#123;</span><br><span class="line">                RemoveNodeView(childNodeView, recusive);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        RemoveNodeViewWithAllEdge(nodeView);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 移除指定节点View和其所有边</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;nodeView&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="built_in">bool</span> <span class="title">RemoveNodeViewWithAllEdge</span>(<span class="params">NodeView nodeView</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (nodeView == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">$&quot;不允许移除空NodeView，删除节点View和其所有边失败！&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mDeleteElementTempList.Clear();</span><br><span class="line">        <span class="keyword">var</span> allInputPorts = nodeView.inputContainer.Query&lt;Port&gt;().ToList();</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> inputPort <span class="keyword">in</span> allInputPorts)</span><br><span class="line">        &#123;</span><br><span class="line">            mDeleteElementTempList.AddRange(inputPort.connections);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> allOutputPorts = nodeView.outputContainer.Query&lt;Port&gt;().ToList();</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> outputPort <span class="keyword">in</span> allOutputPorts)</span><br><span class="line">        &#123;</span><br><span class="line">            mDeleteElementTempList.AddRange(outputPort.connections);</span><br><span class="line">        &#125;</span><br><span class="line">        mDeleteElementTempList.Add(nodeView);</span><br><span class="line">        DeleteElements(mDeleteElementTempList);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 复制指定节点View</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;nodeView&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;recusive&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">DuplicateNodeView</span>(<span class="params">NodeView nodeView, <span class="built_in">bool</span> recusive = <span class="literal">false</span></span>)</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/img/Unity/UIToolkit/NodeRightClickMenu.PNG" alt="NodeRightClickMenu"></p>
<p>从上面可以看到，GraphView.BuildContextualMenu()方法是响应添加菜单的接口，我们通过初始化BehaviourTreeGraphView.InitMenuData()所有节点相关菜单数据，在GraphView.BuildContextualMenu()里通过获取可用菜单的方式动态构建节点对应菜单，从而实现节点自定义右键菜单操作。</p>
<p>这里简单介绍下插入菜单的参数:</p>
<p>DropdownMenuAction.menu.AppendAction(string actionName, Action<DropdownMenuAction> action, Func&lt;DropdownMenuAction,Status&gt; actionStatusCallback, object userData)</p>
<ul>
<li><p>actionName</p>
<p>菜单名，二级菜单通过&#x2F;分割</p>
</li>
<li><p>action</p>
<p>菜单选中执行回调</p>
</li>
<li><p>actionStatusCallback</p>
<p>菜单选项显示状态返回回调</p>
</li>
<li><p>userData</p>
<p>菜单自定义传递数据，传递后可以在action点击回调里通过DropdownMenuAction.userData获取访问</p>
</li>
</ul>
<h4 id="输出端口节点边顺序索引数据排序显示"><a href="#输出端口节点边顺序索引数据排序显示" class="headerlink" title="输出端口节点边顺序索引数据排序显示"></a>输出端口节点边顺序索引数据排序显示</h4><p><strong>无论是横向GraphView还是纵向GraphView，常规定义节点顺序都是通过横向(竖向GraphView)或则纵向(横向GraphView)位置大小来判定的</strong></p>
<p>为了方便和快速看出节点顺序的正确性，我通过对端口各条边的位置大小进行排序并显示。</p>
<p>BehaviourTreeGraphView.cs</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> BehaviourTreeGraphView.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 行为树GraphView</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BehaviourTreeGraphView</span> : <span class="title">GraphView</span></span><br><span class="line">&#123;</span><br><span class="line">	******</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 响应GraphView变化</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;graphViewChange&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> GraphViewChange <span class="title">OnGraphViewChanged</span>(<span class="params">GraphViewChange graphViewChange</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Debug.Log(<span class="string">$&quot;CommonGraphVIew:OnGraphViewChanged()&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (graphViewChange.elementsToRemove != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">var</span> elementToRemove <span class="keyword">in</span> graphViewChange.elementsToRemove)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (elementToRemove <span class="keyword">is</span> NodeView removeNodeView)</span><br><span class="line">                &#123;</span><br><span class="line">                    Debug.Log(<span class="string">$&quot;删除节点GUID:<span class="subst">&#123;removeNodeView.NodeData.GUID&#125;</span>，节点数据类型:<span class="subst">&#123;removeNodeView.NodeData.GetType().Name&#125;</span>&quot;</span>);</span><br><span class="line">                    RemoveNodeData(removeNodeView.NodeData);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (elementToRemove <span class="keyword">is</span> Edge removeEdge)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">var</span> inputNodeView = removeEdge.input.node <span class="keyword">as</span> NodeView;</span><br><span class="line">                    <span class="keyword">var</span> outputNodeView = removeEdge.output.node <span class="keyword">as</span> NodeView;</span><br><span class="line">                    <span class="keyword">var</span> inputNodeViewName = inputNodeView != <span class="literal">null</span> ? inputNodeView.NodeData.GetType().Name : <span class="built_in">string</span>.Empty;</span><br><span class="line">                    <span class="keyword">var</span> outputNodeViewName = outputNodeView != <span class="literal">null</span> ? outputNodeView.NodeData.GetType().Name : <span class="built_in">string</span>.Empty;</span><br><span class="line">                    Debug.Log(<span class="string">$&quot;删除边，Input节点名:<span class="subst">&#123;inputNodeViewName&#125;</span>，Input端口名:<span class="subst">&#123;removeEdge.input.portName&#125;</span>，Output节点名:<span class="subst">&#123;outputNodeViewName&#125;</span>，Output端口名:<span class="subst">&#123;removeEdge.output.portName&#125;</span>&quot;</span>);</span><br><span class="line">                    RemoveEdgeData(outputNodeView.NodeData.GUID, removeEdge.output.portName, inputNodeView.NodeData.GUID, removeEdge.input.portName);</span><br><span class="line">                    OnEdgeViewUpdate(removeEdge);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    Debug.Log(<span class="string">$&quot;TODO:删除其他Element类型:<span class="subst">&#123;elementToRemove.GetType().Name&#125;</span>！&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (graphViewChange.edgesToCreate != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">var</span> edgeToCreate <span class="keyword">in</span> graphViewChange.edgesToCreate)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> edgeView = edgeToCreate <span class="keyword">as</span> EdgeView;</span><br><span class="line">                <span class="keyword">var</span> inputNodeView = edgeToCreate.input.node <span class="keyword">as</span> NodeView;</span><br><span class="line">                <span class="keyword">var</span> outputNodeView = edgeToCreate.output.node <span class="keyword">as</span> NodeView;</span><br><span class="line">                <span class="keyword">var</span> inputNodeViewName = inputNodeView != <span class="literal">null</span> ? inputNodeView.NodeData.GetType().Name : <span class="built_in">string</span>.Empty;</span><br><span class="line">                <span class="keyword">var</span> outputNodeViewName = outputNodeView != <span class="literal">null</span> ? outputNodeView.NodeData.GetType().Name : <span class="built_in">string</span>.Empty;</span><br><span class="line">                <span class="keyword">var</span> ouputNodeGUID = outputNodeView.NodeData.GUID;</span><br><span class="line">                <span class="keyword">var</span> outputPortName = edgeToCreate.output.portName;</span><br><span class="line">                <span class="keyword">var</span> outputPortTypeFullName = edgeToCreate.output.portType.FullName;</span><br><span class="line">                <span class="keyword">var</span> inputNodeGUID = inputNodeView.NodeData.GUID;</span><br><span class="line">                <span class="keyword">var</span> intputPortName = edgeToCreate.input.portName;</span><br><span class="line">                <span class="keyword">var</span> intputPortTypeFullName = edgeToCreate.input.portType.FullName;</span><br><span class="line">                <span class="keyword">var</span> guid = Guid.NewGuid().ToString();</span><br><span class="line">                EdgeData edgeData = <span class="keyword">new</span> EdgeData(guid, ouputNodeGUID, outputPortName, outputPortTypeFullName, inputNodeGUID, intputPortName, intputPortTypeFullName);</span><br><span class="line">                Debug.Log(<span class="string">$&quot;创建边，Input节点名:<span class="subst">&#123;inputNodeViewName&#125;</span>，Input端口名:<span class="subst">&#123;edgeToCreate.input.portName&#125;</span>，Output节点名:<span class="subst">&#123;outputNodeViewName&#125;</span>，Output端口名:<span class="subst">&#123;edgeToCreate.output.portName&#125;</span>&quot;</span>);</span><br><span class="line">                AddEdgeData(edgeData);</span><br><span class="line">                OnEdgeViewUpdate(edgeView);</span><br><span class="line">                <span class="comment">// 新增边不知道为什么在OnGraphViewChanged里触发时还未添加到connections里</span></span><br><span class="line">                <span class="comment">// 这里采取手动更新新增显示边的索引显示数据</span></span><br><span class="line">                UpdateEdgeViewIndex(edgeView);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (graphViewChange.movedElements != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">var</span> moveElement <span class="keyword">in</span> graphViewChange.movedElements)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (moveElement <span class="keyword">is</span> NodeView moveNodeView)</span><br><span class="line">                &#123;</span><br><span class="line">                    Debug.Log(<span class="string">$&quot;更新节点GUID:<span class="subst">&#123;moveNodeView.NodeData.GUID&#125;</span>，节点数据类型:<span class="subst">&#123;moveNodeView.NodeData.GetType().Name&#125;</span>的位置X:<span class="subst">&#123;moveNodeView.NodeData.Position.x&#125;</span> Y:<span class="subst">&#123;moveNodeView.NodeData.Position.y&#125;</span>&quot;</span>);</span><br><span class="line">                    UpdateNodeRectByNodeView(moveNodeView);</span><br><span class="line">                    OnNodeViewMove(moveNodeView);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    Debug.Log(<span class="string">$&quot;TODO:移动Element类型:<span class="subst">&#123;moveElement.GetType().Name&#125;</span>！&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> graphViewChange;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"> 	******   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>BehaviourTreeGraphData.cs</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> BehaviourTreeGraphData.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 行为树图数据</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BehaviourTreeGraphData</span> : <span class="title">ScriptableObject</span></span><br><span class="line">&#123;</span><br><span class="line"> 	******</span><br><span class="line">        </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 响应边数据更新</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;edgeData&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnEdgeDataUpdate</span>(<span class="params">EdgeData edgeData</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (edgeData == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">$&quot;不应该更新空边数据，请检查代码！&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        UpdateNodeOutputPortEdgeIndex(edgeData.OutputNodeGUID, edgeData.OutputPortName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 更新指定节点和指定输出端口名的边索引数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;nodeGUID&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;outputPortName&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">UpdateNodeOutputPortEdgeIndex</span>(<span class="params"><span class="built_in">string</span> nodeGUID, <span class="built_in">string</span> outputPortName</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        mTempEdgeDataList.Clear();</span><br><span class="line">        GetOutputNodePortEdgeDatas(nodeGUID, outputPortName, <span class="keyword">ref</span> mTempEdgeDataList);</span><br><span class="line">        <span class="keyword">if</span> (mTempEdgeDataList.Count == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//Debug.Log($&quot;找不到节点GUID:&#123;nodeGUID&#125;和输出端口名:&#123;outputPortName&#125;的边数据列表，更新边索引数据失败！&quot;);</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        mTempEdgeDataList.Sort(SortPortEdgeDataIndex);</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> index = <span class="number">0</span>, length = mTempEdgeDataList.Count; index &lt; length; index++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> edgeData = mTempEdgeDataList[index];</span><br><span class="line">            edgeData.UpdateEdgeOutputPortIndex(index);</span><br><span class="line">        &#125;</span><br><span class="line">        Debug.Log(<span class="string">$&quot;更新节点GUID:<span class="subst">&#123;nodeGUID&#125;</span>的输出端口明:<span class="subst">&#123;outputPortName&#125;</span>的边索引数据！&quot;</span>);</span><br><span class="line">        AllEdgeDataList.Sort(SortAllEdgeDataIndex);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从上面可以看到实现对节点顺序排序流程如下:</p>
<ol>
<li>监听OnGraphViewChanged的EdgeView变化(<strong>增(BehaviourTreeGraphView.AddEdgeData())，删(BehaviourTreeGraphView.RemoveEdgeData())和移动(BehaviourTreeGraphView.OnNodeViewMove())</strong>)对EdgeData的输出端口边索引数据(EdgeData.OutputPortEdgeIndex)进行了根据位置大小的排序(<strong>BehaviourTreeGraphData.UpdateNodeOutputPortEdgeIndex()和BehaviourTreeGraphData.SortPortEdgeDataIndex()</strong>)。</li>
<li>EdgeData输出端口边索引数据的排序原理是通过边输出端口节点GUID和输出端口名得到对应所有连接的边数据(EdgeData)列表，然后通过遍历所有边数据列表所连接的输入节点GUID得到所有对应的输入节点数据(BaseNode)，最后根据图朝向(BehaviourTreeGraphData.GraphOrientation)去比较所有输入节点(BaseNode)的横向或纵向位置大小进行排序得出所有边对应的顺序并保存在边数据(EdgeData.OutputPortEdgeIndex)里。</li>
</ol>
<p><img src="/img/Unity/UIToolkit/ShowNodeEdgeIndex.PNG" alt="ShowNodeEdgeIndex"></p>
<p>Note:</p>
<ol>
<li><strong>新增边EdgeView在OnGraphViewChange里访问时不存在，此时通过强制更新指定EdgeView索引的方式更新显示(BehaviourTreeGraphView.UpdateEdgeViewIndex())</strong></li>
<li><strong>删除边EdgeView时OnGraphViewChange里访问时还依然存在，所以通过判定逻辑边数据(EdgeData)不存在来避免问题(BehaviourTreeGraphView.UpdateEdgeViewIndex())</strong></li>
</ol>
<h4 id="背景网格添加"><a href="#背景网格添加" class="headerlink" title="背景网格添加"></a>背景网格添加</h4><p>前面讲到我们加载了自定义的UICommonGraphEditorWindow.uss的StyleSheet，那么在代码里我们直接创建GridBackground即可使用对应GridBackground的StyleSheet设置了。</p>
<p>BehaviourTreeGraphView.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">BehaviourTreeGraphView</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    ******</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 添加网格背景</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">AddGridBackground</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> grid = <span class="keyword">new</span> GridBackground();</span><br><span class="line">        grid.name = BTGraphElementNames.GridBackgroundName;</span><br><span class="line">        Insert(<span class="number">0</span>, grid);</span><br><span class="line">        grid.StretchToParentSize();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/img/Unity/UIToolkit/CreateGridDisplay.PNG" alt="CreateGridDisplay"></p>
<h4 id="图数据拖拽重用"><a href="#图数据拖拽重用" class="headerlink" title="图数据拖拽重用"></a>图数据拖拽重用</h4><p>数据拖拽我们可以监听DragExitedEvent</p>
<p>CommonGraphView.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> BehaviourTreeGraphView.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 行为树GraphView</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BehaviourTreeGraphView</span> : <span class="title">GraphView</span></span><br><span class="line">&#123;</span><br><span class="line">    ******</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 初始化</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Init</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        ******</span><br><span class="line">        AddAllEvents();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ******</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 添加所有监听</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">AddAllEvents</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        graphViewChanged += OnGraphViewChanged;</span><br><span class="line">        RegisterCallback&lt;DragExitedEvent&gt;(OnDragExistedEvent);</span><br><span class="line">        </span><br><span class="line">        ******</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 移除所有监听</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">RemoveAllEvents</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        graphViewChanged -= OnGraphViewChanged;</span><br><span class="line">        UnregisterCallback&lt;DragExitedEvent&gt;(OnDragExistedEvent);</span><br><span class="line">        </span><br><span class="line">        ******</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ******</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 转换图ContentContainer组件鼠标局部坐标到GraphView本地坐标</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;localMousePosition&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Vector2 <span class="title">TransformContentLocalMousePosToGraphPos</span>(<span class="params">Vector2 localMousePosition</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Vector2 worldMousePosition = contentContainer.LocalToWorld(localMousePosition);</span><br><span class="line">        Vector2 actualGraphPosition = contentViewContainer.WorldToLocal(worldMousePosition);</span><br><span class="line">        <span class="keyword">return</span> actualGraphPosition;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 响应拖拽结束事件</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;dragExitedEvent&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">OnDragExistedEvent</span>(<span class="params">DragExitedEvent dragExitedEvent</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Debug.Log(<span class="string">$&quot;响应拖拽结束！&quot;</span>);</span><br><span class="line">        <span class="comment">// dragExistEvent.localMousePosition的坐标系貌似就是ContentViewContainer，所以不需要转换</span></span><br><span class="line">        Debug.Log(<span class="string">$&quot;拖拽结束位置:<span class="subst">&#123;dragExitedEvent.localMousePosition&#125;</span>&quot;</span>);</span><br><span class="line">        Debug.Log(<span class="string">$&quot;当前拖拽物体数量:<span class="subst">&#123;DragAndDrop.objectReferences.Length&#125;</span>&quot;</span>);</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> objectReference <span class="keyword">in</span> DragAndDrop.objectReferences)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.Log(<span class="string">$&quot;拖拽物体名:<span class="subst">&#123;objectReference.name&#125;</span>&quot;</span>);</span><br><span class="line">            <span class="keyword">var</span> graphData = objectReference <span class="keyword">as</span> BehaviourTreeGraphData;</span><br><span class="line">            <span class="keyword">if</span> (graphData != <span class="literal">null</span> &amp;&amp; AssetDatabase.Contains(graphData))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> graphDataAssetPath = AssetDatabase.GetAssetPath(graphData);</span><br><span class="line">                Debug.Log(<span class="string">$&quot;拖拽的图数据Asset路径:<span class="subst">&#123;graphDataAssetPath&#125;</span>&quot;</span>);</span><br><span class="line">                <span class="keyword">var</span> cloneGraphData = graphData.CloneSelf();</span><br><span class="line">                <span class="comment">// 这里Drag响应的目标组件貌似是Graph的ContentContainer,</span></span><br><span class="line">                <span class="comment">// 所以要采用ContentContainer作为基础坐标系转换</span></span><br><span class="line">                Vector2 actualGraphPosition = TransformContentLocalMousePosToGraphPos(dragExitedEvent.localMousePosition);</span><br><span class="line">                AddGraphData(cloneGraphData, actualGraphPosition);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 指定位置添加图数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;graphData&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;targetPos&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">AddGraphData</span>(<span class="params">BehaviourTreeGraphData graphData, Vector2? targetPos = <span class="literal">null</span></span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (graphData == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">$&quot;不允许添加空图数据，添加图数据失败！&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        graphData.RegenerateAllNodeGUID();</span><br><span class="line">        <span class="keyword">if</span> (targetPos != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            graphData.MoveToTargetPosition((Vector2)targetPos);</span><br><span class="line">        &#125;</span><br><span class="line">        CreateGraphAllNodes(graphData, <span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line">        CreateGraphAllEdges(graphData, <span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line">        Debug.Log(<span class="string">$&quot;添加指定Graph:<span class="subst">&#123;graphData.name&#125;</span>数据到指定位置成功！&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    *****</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>GraphData.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> BehaviourTreeGraphData.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 行为树图数据</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BehaviourTreeGraphData</span> : <span class="title">ScriptableObject</span></span><br><span class="line">&#123;</span><br><span class="line">    ******</span><br><span class="line">        </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 克隆自身</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Note:</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 此方法会实现嵌套存储的SO Asset也会全部Clone</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> BehaviourTreeGraphData <span class="title">CloneSelf</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> cloneGraphData = <span class="keyword">this</span>.Clone();</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> index = <span class="number">0</span>, length = AllNodeList.Count; index &lt; length; index++)</span><br><span class="line">        &#123;</span><br><span class="line">            cloneGraphData.AllNodeList[index] = AllNodeList[index].CloneSelf();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> cloneGraphData;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>BaseNode.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> BaseNode.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 节点数据基类</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">Serializable</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title">BaseNode</span> : <span class="title">ScriptableObject</span></span><br><span class="line">&#123;</span><br><span class="line">    ******</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 克隆自身</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Note:</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 此方法实现嵌套存储的SO Asset也全部Clone</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> BaseNode <span class="title">CloneSelf</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.Clone();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ScriptableObjectExtension.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> ScriptableObjectExtension.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> ScriptableObject扩展类</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">ScriptableObjectExtension</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 泛型ScriptableObject克隆扩展方法</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> T <span class="title">Clone</span>&lt;<span class="title">T</span>&gt;(<span class="params"><span class="keyword">this</span> T scriptableObject</span>) <span class="keyword">where</span> T : ScriptableObject</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (scriptableObject == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">$&quot;ScriptableObject is null. Returning default <span class="subst">&#123;<span class="keyword">typeof</span>(T)&#125;</span> object.&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> (T)ScriptableObject.CreateInstance(<span class="keyword">typeof</span>(T));</span><br><span class="line">        &#125;</span><br><span class="line">        T instance = Object.Instantiate(scriptableObject);</span><br><span class="line">        <span class="comment">// remove (Clone) from name</span></span><br><span class="line">        instance.name = scriptableObject.name;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/img/Unity/UIToolkit/GraphDataReusing.PNG" alt="GraphDataReusing"></p>
<p>这里就不展示所有代码了，核心就是通过DragExitedEvent监听拖拽到图上的Asset判定是否是支持的图Asset，是的话直接读取图Asset然后通过Clone的方式实现深拷贝一个图Asset数据进行动态图数据添加。</p>
<p>实现ScriptableObject深拷贝的核心是通过扩展ScriptableObjectClone泛型方法实现通用的ScriptableObject克隆。</p>
<p>克隆之后的图Asset数据进行所有节点GUID的重新生成避免GUID重复问题。</p>
<p>潜在设计和可优化点:</p>
<ol>
<li><strong>目前的克隆实现是图数据实例化克隆，克隆后的数据跟原始图数据没有任何关系了，既无法直接通过修改克隆数据修改原始图数据，果想做像BehaviorDesginer图数据直接重用，需要支持一个图数据节点类型，然后在运行时读取图数据节点原始指向数据进行真是图数据克隆(注意排除重复的根节点)。图数据节点的调试可以分为Editor只查看图数据节点，而运行时查看真是图数据克隆还原后的树结构。</strong></li>
</ol>
<p>Note:</p>
<ol>
<li><strong>目前克隆图数据是连带根节点也复制了，如果不需要请自行删除根节点</strong></li>
</ol>
<h4 id="节点数据复制"><a href="#节点数据复制" class="headerlink" title="节点数据复制"></a>节点数据复制</h4><p><strong>前面已经实现了图数据的重用，节点数据的复制重用原理是类似的，核心就是将所有的节点数据(NodeData)通过克隆并重新生成新的GUID再添加并创建对应NodeView显示(为了避免新复制的节点重叠，会添加一定的位置偏移)，然后将所有的边数据(EdgeData)克隆并按照新生成的节点GUID重新修改边数据相关的节点GUID数据并创建对应EdgeView显示即可。</strong></p>
<p>BehaviourTreeGraphView.cs</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> BehaviourTreeGraphView.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 行为树GraphView</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BehaviourTreeGraphView</span> : <span class="title">GraphView</span></span><br><span class="line">&#123;</span><br><span class="line">    ******</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 复制指定节点View</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;duplicateNodeView&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;recusive&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">DuplicateNodeView</span>(<span class="params">NodeView duplicateNodeView, <span class="built_in">bool</span> recusive = <span class="literal">false</span></span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Undo.RecordObject(SourceGraphData, <span class="string">$&quot;DuplicateNodeView(<span class="subst">&#123;recusive&#125;</span>)&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> allNodeViews = <span class="keyword">new</span> List&lt;NodeView&gt;();</span><br><span class="line">        allNodeViews.Add(duplicateNodeView);</span><br><span class="line">        <span class="keyword">var</span> allNodeOuputEdgeViews = <span class="keyword">new</span> List&lt;EdgeView&gt;();</span><br><span class="line">        <span class="keyword">if</span>(recusive)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> allChildNodeViews = GetAllChildNodeViews(duplicateNodeView, recusive);</span><br><span class="line">            allNodeViews.AddRange(allChildNodeViews);</span><br><span class="line">            <span class="keyword">var</span> allChildOutputEdgeViews = GetAllChildOutputEdgeViews(duplicateNodeView, recusive);</span><br><span class="line">            allNodeOuputEdgeViews.AddRange(allChildOutputEdgeViews);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> allNewNodeDatas = <span class="keyword">new</span> List&lt;BaseNode&gt;();</span><br><span class="line">        <span class="keyword">foreach</span>(<span class="keyword">var</span> nodeView <span class="keyword">in</span> allNodeViews)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> oldNodeData = nodeView.NodeData;</span><br><span class="line">            <span class="keyword">var</span> newNodeData = oldNodeData.CloneSelf();</span><br><span class="line">            allNewNodeDatas.Add(newNodeData);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// EdgeData是靠Serializable序列化而非ScriptableObject</span></span><br><span class="line">        <span class="comment">// 所以EdgeData无法直接通过ScriptableObject.CloneSelf()的方式复制</span></span><br><span class="line">        <span class="comment">// 这里只能EdgeData自身实现CloneSelf()的方式去复制EdgeData</span></span><br><span class="line">        <span class="keyword">var</span> allNewEdgeDatas = <span class="keyword">new</span> List&lt;EdgeData&gt;();</span><br><span class="line">        <span class="keyword">foreach</span>(<span class="keyword">var</span> edgeView <span class="keyword">in</span> allNodeOuputEdgeViews)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> oldEdgeData = edgeView.EdgeData;</span><br><span class="line">            <span class="keyword">var</span> newEdgeData = oldEdgeData.CloneSelf();</span><br><span class="line">            allNewEdgeDatas.Add(newEdgeData);</span><br><span class="line">        &#125;</span><br><span class="line">        CommonUtilities.RegenerateAllNodeGUID(allNewNodeDatas, allNewEdgeDatas);</span><br><span class="line">        CommonUtilities.MoveAllNodePosByOffset(allNewNodeDatas, BTGraphConstEditor.DumplicateNodePositionOffset);</span><br><span class="line">        <span class="comment">// 添加并创建所有新的NodeView和EdgeView</span></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> newNodeData <span class="keyword">in</span> allNewNodeDatas)</span><br><span class="line">        &#123;</span><br><span class="line">            CreateNodeByNodeData(SourceGraphData, newNodeData, <span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> newEdgeData <span class="keyword">in</span> allNewEdgeDatas)</span><br><span class="line">        &#123;</span><br><span class="line">            CreateEdgeByEdgeData(SourceGraphData, newEdgeData, <span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 获取指定NodeView的所有子节点View</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Note:</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 不含节点View自身</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;nodeView&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;recusive&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;NodeView&gt; <span class="title">GetAllChildNodeViews</span>(<span class="params">NodeView nodeView, <span class="built_in">bool</span> recusive = <span class="literal">true</span></span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (nodeView == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> allChildNodeViews = <span class="keyword">new</span> List&lt;NodeView&gt;();</span><br><span class="line">        GetAllChildNodeViewsRecusive(nodeView, <span class="keyword">ref</span> allChildNodeViews, recusive);</span><br><span class="line">        <span class="keyword">return</span> allChildNodeViews;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 获取指定NodeView的所有子节点View</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;nodeView&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;allChildNodeView&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;recusive&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">GetAllChildNodeViewsRecusive</span>(<span class="params">NodeView nodeView, <span class="keyword">ref</span> List&lt;NodeView&gt; allChildNodeView, <span class="built_in">bool</span> recusive = <span class="literal">true</span></span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(nodeView == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> allOuputPortList = nodeView.outputContainer.Query&lt;Port&gt;().ToList();</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> outputPort <span class="keyword">in</span> allOuputPortList)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">var</span> edge <span class="keyword">in</span> outputPort.connections)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> outputNodeView = edge.input.node <span class="keyword">as</span> NodeView;</span><br><span class="line">                <span class="comment">// 避免搜索循环</span></span><br><span class="line">                <span class="keyword">if</span> (outputNodeView != <span class="literal">null</span> &amp;&amp; !allChildNodeView.Contains(outputNodeView))</span><br><span class="line">                &#123;</span><br><span class="line">                    allChildNodeView.Add(outputNodeView);</span><br><span class="line">                    <span class="keyword">if</span> (recusive)</span><br><span class="line">                    &#123;</span><br><span class="line">                        GetAllChildNodeViewsRecusive(outputNodeView, <span class="keyword">ref</span> allChildNodeView, recusive);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 获取指定NodeView的所有输出端口边EdgeView</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Note:</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 1. 只有递归时会包含传入NodeView的所有输出端口边EdgeView</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;nodeView&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;recusive&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;EdgeView&gt; <span class="title">GetAllChildOutputEdgeViews</span>(<span class="params">NodeView nodeView, <span class="built_in">bool</span> recusive = <span class="literal">true</span></span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> allChildOutputEdgeViews = <span class="keyword">new</span> List&lt;EdgeView&gt;();</span><br><span class="line">        <span class="keyword">if</span>(recusive)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> nodeAllDirectOutputEdgeViews = GetAllDirectChildOutputEdgeViews(nodeView);</span><br><span class="line">            allChildOutputEdgeViews.AddRange(nodeAllDirectOutputEdgeViews);</span><br><span class="line">            <span class="keyword">var</span> allChildNodeViews = GetAllChildNodeViews(nodeView, recusive);</span><br><span class="line">            <span class="keyword">foreach</span>(<span class="keyword">var</span> childNodeView <span class="keyword">in</span> allChildNodeViews)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> childAllDirectChildOutputEdgeViews = GetAllDirectChildOutputEdgeViews(childNodeView);</span><br><span class="line">                allChildOutputEdgeViews.AddRange(childAllDirectChildOutputEdgeViews);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> allChildOutputEdgeViews;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 创建指定NodeData的NodeView</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;graphData&quot;&gt;</span>所属图数据<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;nodeData&quot;&gt;</span>自定义节点数据(传这个时不创建新节点Node)<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;addNodeData&quot;&gt;</span>是否添加节点数据<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;enableUndoSystem&quot;&gt;</span>是否开启Undo系统<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> NodeView <span class="title">CreateNodeByNodeData</span>(<span class="params">BehaviourTreeGraphData graphData, BaseNode nodeData, <span class="built_in">bool</span> addNodeData = <span class="literal">true</span>, <span class="built_in">bool</span> enableUndoSystem = <span class="literal">true</span></span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (graphData == <span class="literal">null</span> || nodeData == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">$&quot;不允许传递空图数据或空节点数据创建显示节点！&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        BaseNode newNode = <span class="literal">null</span>;</span><br><span class="line">        newNode = nodeData;</span><br><span class="line">        nodeData.Init(nodeData.GUID, nodeData.Position, nodeData.NodeState, nodeData.IsEnteredAbort);</span><br><span class="line">        <span class="keyword">var</span> typeInfo = nodeData.GetType();</span><br><span class="line">        <span class="keyword">var</span> nodeView = BTGraphUtilitiesEditor.CreateNodeViewInstance(typeInfo);</span><br><span class="line">        nodeView.Init(graphData, newNode, OnNodeSelected, <span class="literal">null</span>, GraphOrientation);</span><br><span class="line">        <span class="keyword">if</span> (addNodeData)</span><br><span class="line">        &#123;</span><br><span class="line">            AddNodeData(nodeData, enableUndoSystem);</span><br><span class="line">        &#125;</span><br><span class="line">        AddElement(nodeView);</span><br><span class="line">        UpdateNodeViewRect(nodeView, nodeData.Position);</span><br><span class="line">        <span class="keyword">return</span> nodeView;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 创建指定EdgeData的EdgeView</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;graphData&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;edgeData&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;addEdgeData&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;enableUndoSystem&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> EdgeView <span class="title">CreateEdgeByEdgeData</span>(<span class="params">BehaviourTreeGraphData graphData, EdgeData edgeData, <span class="built_in">bool</span> addEdgeData = <span class="literal">true</span>, <span class="built_in">bool</span> enableUndoSystem = <span class="literal">true</span></span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (graphData == <span class="literal">null</span> || edgeData == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">$&quot;不允许传递空图数据或空边点数据创建显示边！&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (addEdgeData)</span><br><span class="line">        &#123;</span><br><span class="line">            AddEdgeData(edgeData, enableUndoSystem);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 为了支持动态边的创建和加载还原</span></span><br><span class="line">        <span class="comment">// 如果不存在的端口和边数据则动态创建并连接</span></span><br><span class="line">        <span class="keyword">var</span> outputNode = GetNodeByGuid(edgeData.OutputNodeGUID) <span class="keyword">as</span> NodeView;</span><br><span class="line">        <span class="keyword">var</span> outputPort = GetOrCreateOutputPort(outputNode, edgeData.OutputPortName, edgeData.OutputPortTypeFullName);</span><br><span class="line">        <span class="keyword">var</span> inputNode = GetNodeByGuid(edgeData.InputNodeGUID) <span class="keyword">as</span> NodeView;</span><br><span class="line">        <span class="keyword">var</span> inputPort = GetOrCreateInputPort(inputNode, edgeData.InputPortName, edgeData.InputPortTypeFullName);</span><br><span class="line">        <span class="keyword">var</span> edgeView = AddEdgeView(edgeData, inputPort, outputPort);</span><br><span class="line">        Debug.Log(<span class="string">$&quot;创建输出节点GUID:<span class="subst">&#123;edgeData.OutputNodeGUID&#125;</span>的端口名:<span class="subst">&#123;edgeData.OutputPortName&#125;</span>和输入节点GUID:<span class="subst">&#123;edgeData.InputNodeGUID&#125;</span>的端口名:<span class="subst">&#123;edgeData.InputPortName&#125;</span>边！&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> edgeView <span class="keyword">as</span> EdgeView;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>EdgeData.cs</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> EdgeData.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 边数据</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">Serializable</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">EdgeData</span></span><br><span class="line">&#123;</span><br><span class="line">	******</span><br><span class="line">        </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 克隆EdgeData</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> EdgeData <span class="title">CloneSelf</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> newEdgeData = <span class="keyword">new</span> EdgeData(GUID, OutputNodeGUID, OutputPortName, OutputPortTypeFullName, InputNodeGUID, InputPortName, InputPortTypeFullName);</span><br><span class="line">        <span class="keyword">return</span> newEdgeData;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>节点复制流程如下：</p>
<ol>
<li>通过需要复制的NodeView找到所有相关联的NodeView和EdgeView</li>
<li>然后通过找到的NodeView和EdgeView获取到所有对应的BaseNode和EdgeData并调用CloneSelf()进行数据复制</li>
<li>然后通过将复制的BaseNode和EdgeData进行所有节点GUID数据重新随机的方式更新新节点GUID(<strong>CommonUtilities.RegenerateAllNodeGUID()</strong>)</li>
<li>为了避免复制节点重叠，统一将复制的节点数据做位置偏移(<strong>CommonUtilities.MoveAllNodePosByOffset()</strong>)</li>
<li>使用新的节点数据和边数据创建对应新的对应NodeView和EdgeView即完成节点数据复制</li>
</ol>
<p><img src="/img/Unity/UIToolkit/RecusiveCopyNode.PNG" alt="RecusiveCopyNode"></p>
<p>Note:</p>
<ol>
<li><strong>因为节点复制后，第一个节点的父节点不一定支持多个子节点相连(比如修饰节点只允许一个子节点)，所以节点复制会排除第一个节点的输入端口边数据，剩余节点和边数据全部复制。</strong></li>
<li><strong>EdgeData并非继承至ScriptableObejct，所以Clone需要自行实现CloneSelf方法。</strong></li>
</ol>
<h4 id="黑板数据"><a href="#黑板数据" class="headerlink" title="黑板数据"></a>黑板数据</h4><p>黑板数据可以简单的理解成一个共享数据的地方，每棵树可以快速访问修改黑板上的公共数据作为临时数据使用。</p>
<h5 id="黑板数据运行时存储"><a href="#黑板数据运行时存储" class="headerlink" title="黑板数据运行时存储"></a>黑板数据运行时存储</h5><p><strong>黑板数据的核心设计是一个K-V结构的Map容器(结合泛型的设计支持不同类型的数据访问)，通过统一的数据访问方式实现行为树统一的数据访问。</strong></p>
<p>首先我们来看看黑板是如何使用泛型快速支持多种数据类型存储的:</p>
<p>Blackboard.cs</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 黑板数据接口抽象</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">Serializable</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title">BaseBlackboardData</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 黑板数据变量名</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;变量名&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Name;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BaseBlackboardData</span>(<span class="params"><span class="built_in">string</span> name</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Name = name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 黑板数据泛型基类</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">Serializable</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BlackboardData</span>&lt;<span class="title">T</span>&gt; : <span class="title">BaseBlackboardData</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;数据&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> T Data;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BlackboardData</span>(<span class="params"><span class="built_in">string</span> name, T data</span>) : <span class="title">base</span>(<span class="params">name</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Data = data;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 黑板模式，数据共享中心</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Blackboard</span></span><br><span class="line">&#123;</span><br><span class="line">    ******</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 黑板数据集合中心</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> Dictionary&lt;<span class="built_in">string</span>, BaseBlackboardData&gt; mBlackboardDataMap;</span><br><span class="line">    </span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>可以看到首先定义了字符串Key作为黑板数据的唯一标识的BaseBlackboardData基类，然后通过泛型子类BlackboardData<T>支持不同类型的数据泛型支持。</strong></p>
<h5 id="黑板数据运行时驱动和通知"><a href="#黑板数据运行时驱动和通知" class="headerlink" title="黑板数据运行时驱动和通知"></a>黑板数据运行时驱动和通知</h5><p><strong>事件驱动的行为树黑板和常规Update驱动行为树的黑板最大的不同就是Clock(定时器)+监听者模式组成。</strong></p>
<p>为什么事件驱动的行为树黑板也是Clock驱动了？</p>
<ol>
<li><strong>为了避免不必要的Update更新驱动</strong></li>
<li><strong>统一Clock驱动能更好的处理行为树的Update驱动和黑板通知的顺序逻辑</strong></li>
<li><strong>如果行为树在更新中，缓一帧再通知能有效避免通知系统遍历过程中插入删除的情况</strong></li>
</ol>
<p>Blackboard.cs</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 黑板模式，数据共享中心</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Blackboard</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 黑板操作类型</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">enum</span> BBOperationType</span><br><span class="line">    &#123;</span><br><span class="line">        ADD,</span><br><span class="line">        REMOVE,</span><br><span class="line">        CHANGE</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 通知数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">struct</span> Notification</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 操作Key</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> key;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 黑板操作类型</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> BBOperationType type;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 操作值</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">object</span> <span class="keyword">value</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Notification</span>(<span class="params"><span class="built_in">string</span> key, BBOperationType type, <span class="built_in">object</span> <span class="keyword">value</span></span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">this</span>.key = key;</span><br><span class="line">            <span class="keyword">this</span>.type = type;</span><br><span class="line">            <span class="keyword">this</span>.<span class="keyword">value</span> = <span class="keyword">value</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ******</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 更新黑板数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;typeparam name=&quot;T&quot;&gt;</span><span class="doctag">&lt;/typeparam&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;key&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;value&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;noNotification&quot;&gt;</span>是否不通知(默认通知)<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">UpdateData</span>&lt;<span class="title">T</span>&gt;(<span class="params"><span class="built_in">string</span> key, T <span class="keyword">value</span> = <span class="literal">default</span>, <span class="built_in">bool</span> noNotification = <span class="literal">false</span></span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> data = GetBlackboardData(key);</span><br><span class="line">        <span class="keyword">if</span> (data != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> targetData = data <span class="keyword">as</span> BlackboardData&lt;T&gt;;</span><br><span class="line">            <span class="keyword">if</span> (targetData == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                Debug.LogError(<span class="string">$&quot;黑板数据里Key:<span class="subst">&#123;key&#125;</span>的数据类型和更新数据类型:<span class="subst">&#123;<span class="keyword">typeof</span>(T).Name&#125;</span>不匹配，更新数据失败！&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            targetData.Data = <span class="keyword">value</span>;</span><br><span class="line">            <span class="keyword">if</span>(!noNotification)</span><br><span class="line">            &#123;</span><br><span class="line">                mNotifications.Add(<span class="keyword">new</span> Notification(key, BBOperationType.CHANGE, <span class="keyword">value</span>));</span><br><span class="line">                mClock.AddTimer(<span class="number">0f</span>, <span class="number">0</span>, NotifiyObservers);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            BlackboardData&lt;T&gt; targetData = <span class="keyword">new</span> BlackboardData&lt;T&gt;(key, <span class="keyword">value</span>);</span><br><span class="line">            mBlackboardDataMap.Add(key, targetData);</span><br><span class="line">            <span class="keyword">if</span> (!noNotification)</span><br><span class="line">            &#123;</span><br><span class="line">                mNotifications.Add(<span class="keyword">new</span> Notification(key, BBOperationType.ADD, <span class="keyword">value</span>));</span><br><span class="line">                mClock.AddTimer(<span class="number">0f</span>, <span class="number">0</span>, NotifiyObservers);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 通知</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">NotifiyObservers</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (mNotifications.Count == <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            mNotificationsDispatch.Clear();</span><br><span class="line">            mNotificationsDispatch.AddRange(mNotifications);</span><br><span class="line">            mNotifications.Clear();</span><br><span class="line"></span><br><span class="line">            mIsNotifying = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">foreach</span> (Notification notification <span class="keyword">in</span> mNotificationsDispatch)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (!<span class="keyword">this</span>.mObservers.ContainsKey(notification.key))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//                Debug.Log(&quot;1 do not notify for key:&quot; + notification.key + &quot; value: &quot; + notification.value);</span></span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                List&lt;System.Action&lt;BBOperationType, <span class="built_in">object</span>&gt;&gt; observers = GetObserverList(<span class="keyword">this</span>.mObservers, notification.key);</span><br><span class="line">                <span class="keyword">foreach</span> (System.Action&lt;BBOperationType, <span class="built_in">object</span>&gt; observer <span class="keyword">in</span> observers)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">if</span> (<span class="keyword">this</span>.mRemoveObservers.ContainsKey(notification.key) &amp;&amp; <span class="keyword">this</span>.mRemoveObservers[notification.key].Contains(observer))</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    observer(notification.type, notification.<span class="keyword">value</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">foreach</span> (<span class="built_in">string</span> key <span class="keyword">in</span> <span class="keyword">this</span>.mAddObservers.Keys)</span><br><span class="line">            &#123;</span><br><span class="line">                GetObserverList(<span class="keyword">this</span>.mObservers, key).AddRange(<span class="keyword">this</span>.mAddObservers[key]);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="built_in">string</span> key <span class="keyword">in</span> <span class="keyword">this</span>.mRemoveObservers.Keys)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">foreach</span> (System.Action&lt;BBOperationType, <span class="built_in">object</span>&gt; action <span class="keyword">in</span> mRemoveObservers[key])</span><br><span class="line">                &#123;</span><br><span class="line">                    GetObserverList(<span class="keyword">this</span>.mObservers, key).Remove(action);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">this</span>.mAddObservers.Clear();</span><br><span class="line">            <span class="keyword">this</span>.mRemoveObservers.Clear();</span><br><span class="line"></span><br><span class="line">            mIsNotifying = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到对于黑板的增删改操作类型和通知都做了对应类型定义和封装，通过Clock开启数据相关操作(增删改)通知。</p>
<p>黑板作为单棵行为树的公共数据存储的地方，每个行为树构建时都会传入对应的一个黑板对象:</p>
<p>TBehaviourTree.cs</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> TBehaviourTree.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 行为树类</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TBehaviourTree</span> : <span class="title">IRecycle</span></span><br><span class="line">&#123;</span><br><span class="line">    ******</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 运行时的行为树数据(Clone反序列化原始数据BTOriginalGraph而来)</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> BehaviourTreeGraphData BTRunningGraph</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 行为树定时器</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> Clock BehaviourTreeClock</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 初始化</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;bindUID&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Init</span>(<span class="params"><span class="built_in">int</span> bindUID</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        BehaviourTreeClock = <span class="keyword">new</span> Clock();</span><br><span class="line">        UpdateBindUID(bindUID);</span><br><span class="line">        RegisterBehaviourTree();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 加载行为树图数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;assetPath&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">LoadBTGraphData</span>(<span class="params"><span class="built_in">string</span> assetPath</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        ReleaseBTGraphAsset();</span><br><span class="line">        BTOriginalGraph = TBehaviourTreeManager.Singleton.GetCacheBTGraph(assetPath);</span><br><span class="line">        <span class="keyword">if</span>(BTOriginalGraph == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> btGraphAsset = Resources.Load&lt;BehaviourTreeGraphData&gt;(assetPath);</span><br><span class="line">            BTOriginalGraph = btGraphAsset;</span><br><span class="line">            TBehaviourTreeManager.Singleton.CacheBTGraph(assetPath, BTOriginalGraph);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        BTRunningGraph = BTOriginalGraph?.CloneSelf();</span><br><span class="line">        BTRunningGraph?.SetBTOwner(<span class="keyword">this</span>);</span><br><span class="line">        BTRunningGraph?.InitRuntimeDatas(BehaviourTreeClock);</span><br><span class="line">        BTRunningGraph?.Start();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从上面的代码可以看出，每棵行为树(TBehaviourTree)运行时都够建了一个新的Clock(TBehaviourTree.BehaviourTreeClock)用于驱动整棵树的更新。</p>
<h5 id="黑板数据编辑器编辑和存储加载"><a href="#黑板数据编辑器编辑和存储加载" class="headerlink" title="黑板数据编辑器编辑和存储加载"></a>黑板数据编辑器编辑和存储加载</h5><p>前面提到的都是行为树黑板运行时部分，那编辑器的行为树数据是如何存储？编辑器编辑的行为树数据又是如何读取到运行时使用的了？</p>
<p>Dictionary&lt;string, BaseBlackboardData&gt; mBlackboardDataMap是不支持序列化的结构，所以编辑器的黑板数据存储和修改还需要独立定义。</p>
<p>BlackboardData.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> BlackboardDataType.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 黑板数据类型枚举</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="built_in">enum</span> BlackboardDataType</span><br><span class="line">&#123;</span><br><span class="line">    Bool = <span class="number">1</span>,</span><br><span class="line">    Int,</span><br><span class="line">    Float,</span><br><span class="line">    String,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> BlackboardData.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 黑板数据</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">Serializable</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BlackboardData</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 所有Bool变量定义数据列表</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;Bool变量黑板数据&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> List&lt;BlackboardData&lt;<span class="built_in">bool</span>&gt;&gt; AllBoolDataList;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 所有Int变量定义数据列表</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;Int变量黑板数据&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> List&lt;BlackboardData&lt;<span class="built_in">int</span>&gt;&gt; AllIntDataList;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 所有Float变量定义数据列表</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;Float变量黑板数据&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> List&lt;BlackboardData&lt;<span class="built_in">float</span>&gt;&gt; AllFloatDataList;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 所有String变量定义数据列表</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;String变量黑板数据&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> List&lt;BlackboardData&lt;<span class="built_in">string</span>&gt;&gt; AllStringDataList;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 添加指定黑板数据类型和数据名的黑板数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;blackboardDataType&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;key&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">AddDataByType</span>(<span class="params">BlackboardDataType blackboardDataType, <span class="built_in">string</span> key</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (ExistData(key))</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">$&quot;黑板数据里已存在Key:<span class="subst">&#123;key&#125;</span>的数据，添加数据失败！&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (blackboardDataType == BlackboardDataType.Bool)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> AddData&lt;<span class="built_in">bool</span>&gt;(key);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (blackboardDataType == BlackboardDataType.Int)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> AddData&lt;<span class="built_in">int</span>&gt;(key);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (blackboardDataType == BlackboardDataType.Float)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> AddData&lt;<span class="built_in">float</span>&gt;(key);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (blackboardDataType == BlackboardDataType.String)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> AddData&lt;<span class="built_in">string</span>&gt;(key);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">$&quot;不支持的黑板变量类型:<span class="subst">&#123;blackboardDataType&#125;</span>，添加数据名:<span class="subst">&#123;key&#125;</span>数据失败！&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 添加指定变量类型和数据名的黑板数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;key&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;data&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">AddData</span>&lt;<span class="title">T</span>&gt;(<span class="params"><span class="built_in">string</span> key, T <span class="keyword">value</span> = <span class="literal">default</span>(T</span>))</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (ExistData(key))</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">$&quot;黑板数据里已存在Key:<span class="subst">&#123;key&#125;</span>的数据，添加数据失败！&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> dataType = <span class="keyword">typeof</span>(T);</span><br><span class="line">        <span class="keyword">if</span>(dataType == CommonGraphConst.BoolType)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> data = <span class="keyword">new</span> BlackboardData&lt;T&gt;(key, <span class="keyword">value</span>);</span><br><span class="line">            AllBoolDataList.Add(data <span class="keyword">as</span> BlackboardData&lt;<span class="built_in">bool</span>&gt;);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (dataType == CommonGraphConst.IntType)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> data = <span class="keyword">new</span> BlackboardData&lt;T&gt;(key, <span class="keyword">value</span>);</span><br><span class="line">            AllIntDataList.Add(data <span class="keyword">as</span> BlackboardData&lt;<span class="built_in">int</span>&gt;);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (dataType == CommonGraphConst.FloatType)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> data = <span class="keyword">new</span> BlackboardData&lt;T&gt;(key, <span class="keyword">value</span>);</span><br><span class="line">            AllFloatDataList.Add(data <span class="keyword">as</span> BlackboardData&lt;<span class="built_in">float</span>&gt;);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (dataType == CommonGraphConst.StringType)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> data = <span class="keyword">new</span> BlackboardData&lt;T&gt;(key, <span class="keyword">value</span>);</span><br><span class="line">            AllStringDataList.Add(data <span class="keyword">as</span> BlackboardData&lt;<span class="built_in">string</span>&gt;);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">$&quot;不支持的黑板变量类型:<span class="subst">&#123;dataType.Name&#125;</span>，添加数据名:<span class="subst">&#123;key&#125;</span>数据失败！&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>BehaviourTreeGraphData.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> BehaviourTreeGraphData.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 行为树图数据</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BehaviourTreeGraphData</span> : <span class="title">ScriptableObject</span></span><br><span class="line">&#123;</span><br><span class="line">    ******</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 黑板数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;黑板数据&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> BlackboardData BlackboardData;</span><br><span class="line">    </span><br><span class="line">    ******</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BehaviourTreeGraphData</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        AllNodeList = <span class="keyword">new</span> List&lt;BaseNode&gt;();</span><br><span class="line">        AllEdgeDataList = <span class="keyword">new</span> List&lt;EdgeData&gt;();</span><br><span class="line">        OwnerBT = <span class="literal">null</span>;</span><br><span class="line">        TreeDataList = <span class="keyword">new</span> List&lt;TreeData&gt;();</span><br><span class="line">        BlackboardData = <span class="keyword">new</span> BlackboardData();</span><br><span class="line">        Clock = <span class="literal">null</span>;</span><br><span class="line">        Blackboard = <span class="literal">null</span>;</span><br><span class="line">        RootTree = <span class="literal">null</span>;</span><br><span class="line">        mInitRunTimeDataComplete = <span class="literal">false</span>;</span><br><span class="line">        mTempEdgeDataList = <span class="keyword">new</span> List&lt;EdgeData&gt;();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 初始化运行时数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">InitRuntimeDatas</span>(<span class="params">Clock clock</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        InitClock(clock);</span><br><span class="line">        InitBlackboard();</span><br><span class="line">        InitTreeDatas();</span><br><span class="line">        mInitRunTimeDataComplete = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 初始化共享黑板</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">InitBlackboard</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        Blackboard = <span class="keyword">new</span> Blackboard(Clock);</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> boolVariableData <span class="keyword">in</span> BlackboardData.AllBoolDataList)</span><br><span class="line">        &#123;</span><br><span class="line">            UpdateBlackboardData&lt;<span class="built_in">bool</span>&gt;(boolVariableData.Name, boolVariableData.Data, <span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> intVariableData <span class="keyword">in</span> BlackboardData.AllIntDataList)</span><br><span class="line">        &#123;</span><br><span class="line">            UpdateBlackboardData&lt;<span class="built_in">int</span>&gt;(intVariableData.Name, intVariableData.Data, <span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> floatVariableData <span class="keyword">in</span> BlackboardData.AllFloatDataList)</span><br><span class="line">        &#123;</span><br><span class="line">            UpdateBlackboardData&lt;<span class="built_in">float</span>&gt;(floatVariableData.Name, floatVariableData.Data, <span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> stringVariableData <span class="keyword">in</span> BlackboardData.AllStringDataList)</span><br><span class="line">        &#123;</span><br><span class="line">            UpdateBlackboardData&lt;<span class="built_in">string</span>&gt;(stringVariableData.Name, stringVariableData.Data, <span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        Blackboard.PrintAllBlackBoardDatas();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>UIBTGraphEditorWindow.cs</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> UIBTGraphEditorWindow.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 行为树图窗口类</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UIBTGraphEditorWindow</span> : <span class="title">EditorWindow</span></span><br><span class="line">&#123;</span><br><span class="line">    ******</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 创建黑板UI面板</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">CreateBlackboardUI</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> rightPanelVerticalContainer = rootVisualElement.Q&lt;VisualElement&gt;(BTGraphElementNames.RightPanelVerticalContainerName);</span><br><span class="line">        <span class="keyword">var</span> rightVerticalContentLabelTitle = <span class="keyword">new</span> Label();</span><br><span class="line">        rightVerticalContentLabelTitle.text = <span class="string">&quot;黑板面板&quot;</span>;</span><br><span class="line">        rightVerticalContentLabelTitle.style.height = <span class="number">20f</span>;</span><br><span class="line">        rightVerticalContentLabelTitle.style.alignSelf = Align.Center;</span><br><span class="line">        rightPanelVerticalContainer.Add(rightVerticalContentLabelTitle);</span><br><span class="line"></span><br><span class="line">        CreateBlackboardOperationUI();</span><br><span class="line">        CreateBlackboardDataUI();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 创建黑板数据UI</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">CreateBlackboardDataUI</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> rightPanelVerticalContainer = rootVisualElement.Q&lt;VisualElement&gt;(BTGraphElementNames.RightPanelVerticalContainerName);</span><br><span class="line">        <span class="keyword">var</span> blackboardDataVerticalContainer = UIToolkitUtilities.CreateVerticalContainer(BTGraphElementNames.BlackboardDataVerticalContainerName);</span><br><span class="line">        rightPanelVerticalContainer.Add(blackboardDataVerticalContainer);</span><br><span class="line"></span><br><span class="line">        UpdateBlackboardDataUI();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 更新黑板数据UI</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">UpdateBlackboardDataUI</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (mCurrentSelectedPanelType != PanelType.BLACKBOARD_PANEL)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> blackboardDataVerticalContainer = rootVisualElement.Q&lt;VisualElement&gt;(BTGraphElementNames.BlackboardDataVerticalContainerName);</span><br><span class="line">        blackboardDataVerticalContainer.Clear();</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> variabletype <span class="keyword">in</span> mAvalibleVariableTypeList)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> variableTypeFoldOut = <span class="keyword">new</span> Foldout();</span><br><span class="line">            <span class="keyword">var</span> variableTypeTitle = BTGraphUtilitiesEditor.GetVariableTypeFoldTitle(variabletype);</span><br><span class="line">            variableTypeFoldOut.name = variableTypeTitle;</span><br><span class="line">            variableTypeFoldOut.viewDataKey = BTGraphUtilitiesEditor.GetVariableTypeFoldOutViewDataKeyName(variabletype);</span><br><span class="line">            variableTypeFoldOut.text = variableTypeTitle;</span><br><span class="line">            variableTypeFoldOut.AddToClassList(<span class="string">&quot;unity-box&quot;</span>);</span><br><span class="line"></span><br><span class="line">            blackboardDataVerticalContainer.Add(variableTypeFoldOut);</span><br><span class="line">            CreateVariableDataUI(variabletype);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 创建指定变量类型的变量数据UI</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;variableType&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">CreateVariableDataUI</span>(<span class="params">BlackboardDataType variableType</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(!Application.isPlaying)</span><br><span class="line">        &#123;</span><br><span class="line">            CreateEditorVariableDataUI(variableType);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            CreateRuntimeVariableDataUI(variableType);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 响应添加黑板变量数据按钮点击</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;evt&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnBlackboardAddVariableDataClick</span>(<span class="params">ClickEvent evt</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Debug.Log(<span class="string">$&quot;响应黑板添加变量数据按钮点击！&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> blackboardVariableInputText = rootVisualElement.Q&lt;TextField&gt;(BTGraphElementNames.BlackboardInputVariableTextName);</span><br><span class="line">        <span class="keyword">var</span> newVariableName = blackboardVariableInputText.<span class="keyword">value</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">string</span>.IsNullOrEmpty(newVariableName))</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">$&quot;不允许添加空变量名的黑板数据！&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        Undo.RegisterCompleteObjectUndo(mGraphView.SourceGraphData, <span class="string">&quot;AddBlackboardData&quot;</span>);</span><br><span class="line">        PopupField&lt;BlackboardDataType&gt; variableTypePopField = rootVisualElement.Q&lt;PopupField&lt;BlackboardDataType&gt;&gt;(BTGraphElementNames.BlackboardVariableTypePopName);</span><br><span class="line">        <span class="keyword">var</span> newVariableType = variableTypePopField.<span class="keyword">value</span>;</span><br><span class="line">        <span class="keyword">if</span>(mGraphView.SourceGraphData.BlackboardData.AddDataByTyoe(newVariableType, newVariableName))</span><br><span class="line">        &#123;</span><br><span class="line">            UpdateBlackboardDataUI();</span><br><span class="line">            EditorUtility.SetDirty(mGraphView.SourceGraphData);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 更新指定黑板变量和值的编辑器黑板数据值</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;typeparam name=&quot;T&quot;&gt;</span><span class="doctag">&lt;/typeparam&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;variableName&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;newValue&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="built_in">bool</span> <span class="title">UpdateEditorVariableData</span>&lt;<span class="title">T</span>&gt;(<span class="params"><span class="built_in">string</span> variableName, T newValue</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Debug.Log(<span class="string">$&quot;编辑器变量类型:<span class="subst">&#123;<span class="keyword">typeof</span>(T).Name&#125;</span>的变量名:<span class="subst">&#123;variableName&#125;</span>值更新:<span class="subst">&#123;newValue&#125;</span>&quot;</span>);</span><br><span class="line">        Undo.RegisterCompleteObjectUndo(mGraphView.SourceGraphData, <span class="string">&quot;UpdateBlackboardData&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> result = mGraphView.SourceGraphData.BlackboardData.UpdaetValue&lt;T&gt;(variableName, newValue);</span><br><span class="line">        EditorUtility.SetDirty(mGraphView.SourceGraphData);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 移除指定黑板变量编辑器黑板数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;typeparam name=&quot;T&quot;&gt;</span><span class="doctag">&lt;/typeparam&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;variableName&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="built_in">bool</span> <span class="title">RemoveEditorVariableData</span>&lt;<span class="title">T</span>&gt;(<span class="params"><span class="built_in">string</span> variableName</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Debug.Log(<span class="string">$&quot;编辑器删除变量类型:<span class="subst">&#123;<span class="keyword">typeof</span>(T).Name&#125;</span>的变量名:<span class="subst">&#123;variableName&#125;</span>数据！&quot;</span>);</span><br><span class="line">        Undo.RegisterCompleteObjectUndo(mGraphView.SourceGraphData, <span class="string">&quot;RemoveBlackboardData&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> result = mGraphView.SourceGraphData.BlackboardData.RemoveData&lt;T&gt;(variableName);</span><br><span class="line">        UpdateBlackboardDataUI();</span><br><span class="line">        EditorUtility.SetDirty(mGraphView.SourceGraphData);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到针对每一个<strong>行为树图数据(BehaviourTreeGraphData)<strong>都定义了一个</strong>BlackboardData(行为树编辑器黑板数据)</strong></p>
<p><strong>可以看到编辑器和运行时，UIBTGraphEditorWindow.CreateVariableDataUI()通过选择性读取BlackboardData或Blackboard数据进行黑板数据读取显示。</strong></p>
<p>编辑器模式下BehaviourTreeGraphData.BlackboardData支持序列化，然后通过创建UIToolkit的编辑器UI进行读取和修改BehaviourTreeGraphData.BlackboardData数据，从而实现编辑器对黑板数据的编辑和保存。</p>
<p>黑板数据操作UI界面展示:</p>
<p><img src="/"></p>
<p>Note:</p>
<ol>
<li><strong>目前的黑板设计是针对单棵行为树的，所以是局部黑板而非全局黑板(也就是多棵行为树之间无法通过黑板存储公共数据交流)。</strong></li>
</ol>
<h4 id="GraphView操作添加"><a href="#GraphView操作添加" class="headerlink" title="GraphView操作添加"></a>GraphView操作添加</h4><p>给GraphView添加额外操作功能(e.g. 节点拖拽，点击节点选择，方形选框节点选择，滚轮缩放 ……)</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BehaviourTreeGraphView</span> : <span class="title">GraphView</span></span><br><span class="line">&#123;</span><br><span class="line">	******</span><br><span class="line">        </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 添加所有Manipulator</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">AddAllManipulator</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">this</span>.AddManipulator(<span class="keyword">new</span> ContentDragger());</span><br><span class="line">        <span class="keyword">this</span>.AddManipulator(<span class="keyword">new</span> SelectionDragger());</span><br><span class="line">        <span class="keyword">this</span>.AddManipulator(<span class="keyword">new</span> RectangleSelector());</span><br><span class="line">        <span class="keyword">this</span>.AddManipulator(<span class="keyword">new</span> ContentZoomer());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>AddManipulator()是VisualElement的扩展方法，通过添加Manipulator我们可以快速实现对Element添加各种各样的操作功能，GraphView也继承至UIElement，所以通过上述几行代码我们成功的给图添加了框选，缩放等功能。</p>
<p><img src="/img/Unity/UIToolkit/NodeSelectionOperation.PNG" alt="NodeSelectionOperation"></p>
<h4 id="坐标转换"><a href="#坐标转换" class="headerlink" title="坐标转换"></a>坐标转换</h4><p>当我们的GraphView支持放大缩小时，我们点击创建节点的位置需要通过坐标转换才能得到正确的节点位置。</p>
<p>BehaviourTreeGraphView.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> BehaviourTreeGraphView.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 行为树GraphView</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BehaviourTreeGraphView</span> : <span class="title">GraphView</span></span><br><span class="line">&#123;</span><br><span class="line">    ******</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 转换Grid组件鼠标局部坐标到GraphView本地坐标</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;localMousePosition&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Vector2 <span class="title">TransformGridLocalMousePosToGraphPos</span>(<span class="params">Vector2 localMousePosition</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> gridElement = ElementAt(<span class="number">0</span>);</span><br><span class="line">        Vector2 worldMousePosition = contentContainer.ChangeCoordinatesTo(gridElement, localMousePosition);</span><br><span class="line">        Vector2 actualGraphPosition = contentViewContainer.WorldToLocal(worldMousePosition);</span><br><span class="line">        <span class="keyword">return</span> actualGraphPosition;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 响应NodeView子菜单栏创建节点</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;menuAction&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">OnNodeViewSubMenuCreateNode</span>(<span class="params">DropdownMenuAction menuAction</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> menuUserData = menuAction.userData <span class="keyword">as</span> MenuUserData;</span><br><span class="line">        <span class="keyword">var</span> nodeType = menuUserData.CustomData <span class="keyword">as</span> Type;</span><br><span class="line">        Vector2 actualGraphPosition = TransformGridLocalMousePosToGraphPos(menuAction.eventInfo.localMousePosition);</span><br><span class="line">        <span class="keyword">var</span> nodeView = CreateNodeByType(nodeType, actualGraphPosition);</span><br><span class="line">        <span class="keyword">var</span> nodeViewPosition = nodeView.GetPosition();</span><br><span class="line">        nodeViewPosition.position = actualGraphPosition;</span><br><span class="line">        UpdateNodeViewRect(nodeView, nodeViewPosition);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Debug.Log($&quot;CommonGraphView:OnNodeViewSubMenuCreateNode() NodeType:&#123;menuUserData.SourceNodeView.NodeData.NodeType&#125;&quot;);</span></span><br><span class="line">        <span class="comment">//Debug.Log($&quot;localMousePosition:&#123;menuAction.eventInfo.localMousePosition.ToString()&#125;&quot;);</span></span><br><span class="line">        <span class="comment">//Debug.Log($&quot;mousePosition:&#123;menuAction.eventInfo.mousePosition.ToString()&#125;&quot;);</span></span><br><span class="line">        <span class="comment">//Debug.Log($&quot;actualGraphPosition:&#123;actualGraphPosition.ToString()&#125;&quot;);</span></span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> 创建节点Port链接</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">   ******   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先我们通过获取添加到根节点且铺满的Grid UIElement作为转换获取显示区域世界坐标的参考组件。</p>
<p>然后通过VisualElementExtension.ChangeCoordinatesTo()将通过DropdownMenuAction.eventInfo.localMousePosition得到鼠标局部点击坐标转换到网格的局部坐标(个人理解因为网格是铺满显示范围的，所以这里的局部坐标也就等价于世界坐标)。</p>
<p>最后将转换到网格的局部坐标(即世界坐标)通过VisualElementExtension.WorldToLocal()转换到我们节点目标显示父UIElement(contentViewContainer)坐标下得到对应局部坐标。</p>
<h4 id="数据保存和加载添加"><a href="#数据保存和加载添加" class="headerlink" title="数据保存和加载添加"></a>数据保存和加载添加</h4><p>数据保存和加载首先需要两步：</p>
<ol>
<li>创建操作UI</li>
<li>响应操作保存和加载数据</li>
</ol>
<p>UICommonGraphEditorWindow.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> UIBTGraphEditorWindow.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 行为树图窗口类</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UIBTGraphEditorWindow</span> : <span class="title">EditorWindow</span></span><br><span class="line">&#123;</span><br><span class="line">    ******</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 创建左侧操作内容</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">CreateLeftOperationContent</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        CreateSavePathContent();</span><br><span class="line">        CreateNodeOperationContent();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 创建保存路径内容</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">CreateSavePathContent</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> leftVerticalContentContainer = rootVisualElement.Q&lt;VisualElement&gt;(BTGraphElementNames.LeftVerticalContentContainerName);</span><br><span class="line">        <span class="keyword">var</span> savePathHorizontalContainer = <span class="keyword">new</span> VisualElement();</span><br><span class="line">        savePathHorizontalContainer.style.left = <span class="number">0</span>;</span><br><span class="line">        savePathHorizontalContainer.style.right = <span class="number">0</span>;</span><br><span class="line">        savePathHorizontalContainer.style.height = <span class="number">20</span>;</span><br><span class="line">        savePathHorizontalContainer.style.flexDirection = FlexDirection.Row;</span><br><span class="line">        savePathHorizontalContainer.AddToClassList(<span class="string">&quot;unity-box&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> savePathLabelTitle = <span class="keyword">new</span> Label();</span><br><span class="line">        savePathLabelTitle.style.width = <span class="number">70f</span>;</span><br><span class="line">        savePathLabelTitle.style.unityTextAlign = TextAnchor.MiddleLeft;</span><br><span class="line">        savePathLabelTitle.style.alignSelf = Align.Center;</span><br><span class="line">        savePathLabelTitle.text = <span class="string">&quot;保存路径:&quot;</span>;</span><br><span class="line">        savePathHorizontalContainer.Add(savePathLabelTitle);</span><br><span class="line">        <span class="keyword">var</span> savePathTextField = <span class="keyword">new</span> TextField();</span><br><span class="line">        savePathTextField.name = BTGraphElementNames.SavePathTextFieldName;</span><br><span class="line">        savePathTextField.style.flexGrow = <span class="number">1</span>;</span><br><span class="line">        savePathTextField.style.flexShrink = <span class="number">1</span>;</span><br><span class="line">        savePathTextField.<span class="keyword">value</span> = mGraphSaveFolderPath;</span><br><span class="line">        savePathHorizontalContainer.Add(savePathTextField);</span><br><span class="line">        <span class="keyword">var</span> savePathButton = <span class="keyword">new</span> Button();</span><br><span class="line">        savePathButton.style.width = <span class="number">60</span>;</span><br><span class="line">        savePathButton.text = <span class="string">&quot;修改&quot;</span>;</span><br><span class="line">        savePathHorizontalContainer.Add(savePathButton);</span><br><span class="line">        <span class="comment">// 注册按钮点击</span></span><br><span class="line">        savePathButton.RegisterCallback&lt;ClickEvent&gt;(OnSavePathButtonClick);</span><br><span class="line">        leftVerticalContentContainer.Add(savePathHorizontalContainer);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 响应保存路径按钮点击</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;clickEvent&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnSavePathButtonClick</span>(<span class="params">ClickEvent clickEvent</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Debug.Log(<span class="string">$&quot;保存路径按钮点击！&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> newSavePath = EditorUtility.OpenFolderPanel(<span class="string">&quot;保存路径&quot;</span>, mGraphSaveFolderPath, <span class="built_in">string</span>.Empty);</span><br><span class="line">        <span class="keyword">if</span> (!AssetDatabase.IsValidFolder(newSavePath))</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">$&quot;请选择有效的Asset路径，此:<span class="subst">&#123;newSavePath&#125;</span>路径无效，修改保存路径失败！&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">string</span>.IsNullOrEmpty(newSavePath))</span><br><span class="line">        &#123;</span><br><span class="line">            mGraphSaveFolderPath = newSavePath;</span><br><span class="line">            Debug.Log(<span class="string">$&quot;更新保存路径:<span class="subst">&#123;newSavePath&#125;</span>&quot;</span>);</span><br><span class="line">            <span class="keyword">var</span> savePathTextField = rootVisualElement.Q&lt;TextField&gt;(BTGraphElementNames.SavePathTextFieldName);</span><br><span class="line">            savePathTextField.<span class="keyword">value</span> = mGraphSaveFolderPath;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 创建节点操作面板</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">CreateNodeOperationContent</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> leftVerticalContentContainer = rootVisualElement.Q&lt;VisualElement&gt;(BTGraphElementNames.LeftVerticalContentContainerName);</span><br><span class="line">        <span class="keyword">var</span> assetSelectionHorizontalContainer = UIToolkitUtilities.CreateHorizontalContainer(BTGraphElementNames.AssetSelectionHorizontalContainerName,</span><br><span class="line">                                                                                             <span class="number">0f</span>, <span class="literal">null</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="literal">default</span>(StyleColor));</span><br><span class="line">        assetSelectionHorizontalContainer.style.height = <span class="number">20f</span>;</span><br><span class="line">        leftVerticalContentContainer.Add(assetSelectionHorizontalContainer);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> assetSelectionTitleLabel = <span class="keyword">new</span> Label();</span><br><span class="line">        assetSelectionTitleLabel.text = <span class="string">&quot;Asset:&quot;</span>;</span><br><span class="line">        assetSelectionTitleLabel.style.width = <span class="number">70f</span>;</span><br><span class="line">        assetSelectionTitleLabel.style.unityTextAlign = TextAnchor.MiddleLeft;</span><br><span class="line">        assetSelectionTitleLabel.style.alignSelf = Align.Center;</span><br><span class="line">        assetSelectionHorizontalContainer.Add(assetSelectionTitleLabel);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> assetSelectionObjectField = <span class="keyword">new</span> ObjectField();</span><br><span class="line">        assetSelectionObjectField.objectType = GetGraphViewDataType();</span><br><span class="line">        assetSelectionObjectField.name = BTGraphElementNames.AssetSelectionName;</span><br><span class="line">        assetSelectionObjectField.style.flexGrow = <span class="number">1</span>;</span><br><span class="line">        assetSelectionObjectField.style.width = <span class="number">210</span>;</span><br><span class="line">        assetSelectionObjectField.allowSceneObjects = <span class="literal">false</span>;</span><br><span class="line">        assetSelectionObjectField.RegisterValueChangedCallback(OnAssetSelectionValueChange);</span><br><span class="line">        assetSelectionHorizontalContainer.Add(assetSelectionObjectField);</span><br><span class="line">        UpdateAssetSelectionValue();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> newGraphButton = <span class="keyword">new</span> Button();</span><br><span class="line">        newGraphButton.name = BTGraphElementNames.SaveButtonName;</span><br><span class="line">        newGraphButton.text = <span class="string">&quot;新建&quot;</span>;</span><br><span class="line">        newGraphButton.style.height = <span class="number">20</span>;</span><br><span class="line">        leftVerticalContentContainer.Add(newGraphButton);</span><br><span class="line">        <span class="comment">// 注册导出按钮点击</span></span><br><span class="line">        newGraphButton.RegisterCallback&lt;ClickEvent&gt;(OnNewGraphButtonClick);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> saveButton = <span class="keyword">new</span> Button();</span><br><span class="line">        saveButton.name = BTGraphElementNames.SaveButtonName;</span><br><span class="line">        saveButton.text = <span class="string">&quot;保存&quot;</span>;</span><br><span class="line">        saveButton.style.height = <span class="number">20</span>;</span><br><span class="line">        leftVerticalContentContainer.Add(saveButton);</span><br><span class="line">        <span class="comment">// 注册导出按钮点击</span></span><br><span class="line">        saveButton.RegisterCallback&lt;ClickEvent&gt;(OnSaveButtonClick);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 更新选中Asset</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">UpdateAssetSelectionValue</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> assetSelectionObjectField = rootVisualElement.Q&lt;ObjectField&gt;(BTGraphElementNames.AssetSelectionName); ;</span><br><span class="line">        <span class="keyword">if</span> (assetSelectionObjectField != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            assetSelectionObjectField.<span class="keyword">value</span> = mSelectedGraphData;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 响应选中Asset变化</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;assetSelected&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnAssetSelectionValueChange</span>(<span class="params">ChangeEvent&lt;UnityEngine.Object&gt; assetSelected</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> previewAssetName = assetSelected.previousValue != <span class="literal">null</span> ? assetSelected.previousValue.name : <span class="built_in">string</span>.Empty;</span><br><span class="line">        <span class="keyword">var</span> newAssetName = assetSelected.newValue != <span class="literal">null</span> ? assetSelected.newValue.name : <span class="built_in">string</span>.Empty;</span><br><span class="line">        Debug.Log(<span class="string">$&quot;响应Asset选择变化，从:<span class="subst">&#123;previewAssetName&#125;</span>到:<span class="subst">&#123;newAssetName&#125;</span>&quot;</span>);</span><br><span class="line">        UpdateSelectedGraphData(assetSelected.newValue <span class="keyword">as</span> BehaviourTreeGraphData);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 响应保存按钮点击</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;clickEvent&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnSaveButtonClick</span>(<span class="params">ClickEvent clickEvent</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (Application.isPlaying)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogWarning(<span class="string">$&quot;运行时不允许保存操作！&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">string</span>.IsNullOrEmpty(mGraphSaveFileName))</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">$&quot;不允许保存空文件名！&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> graphDataPath = Path.Combine(mGraphSaveFolderPath, mGraphSaveFileName);</span><br><span class="line">        graphDataPath = PathUtilities.GetRegularPath(graphDataPath);</span><br><span class="line">        <span class="keyword">var</span> graphData = mGraphView.SourceGraphData;</span><br><span class="line">        <span class="keyword">if</span> (graphData != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> saveFodlerFullPath = PathUtilities.GetAssetFullPath(mGraphSaveFolderPath);</span><br><span class="line">            FolderUtilities.CheckAndCreateSpecificFolder(saveFodlerFullPath);</span><br><span class="line">            <span class="keyword">var</span> assetSourcePath = AssetDatabase.GetAssetPath(graphData);</span><br><span class="line">            assetSourcePath = PathUtilities.GetRegularPath(assetSourcePath);</span><br><span class="line">            <span class="keyword">if</span> (!<span class="built_in">string</span>.IsNullOrEmpty(assetSourcePath))</span><br><span class="line">            &#123;</span><br><span class="line">                Debug.Log(<span class="string">$&quot;目标Asset:<span class="subst">&#123;assetSourcePath&#125;</span>已存在本地！&quot;</span>);</span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">string</span>.Equals(assetSourcePath, graphDataPath))</span><br><span class="line">                &#123;</span><br><span class="line">                    Debug.Log(<span class="string">$&quot;目标Asset:<span class="subst">&#123;graphDataPath&#125;</span>保存路径相同，直接保存！&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    Debug.Log(<span class="string">$&quot;目标Asset:<span class="subst">&#123;assetSourcePath&#125;</span>保存路径不同，移动到:<span class="subst">&#123;graphDataPath&#125;</span>并保存！&quot;</span>);</span><br><span class="line">                    AssetDatabase.MoveAsset(assetSourcePath, graphDataPath);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> targetPathAsset = AssetDatabase.LoadAssetAtPath&lt;UnityEngine.Object&gt;(graphDataPath);</span><br><span class="line">                <span class="keyword">if</span> (targetPathAsset != <span class="literal">null</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    AssetDatabase.DeleteAsset(graphDataPath);</span><br><span class="line">                    Debug.Log(<span class="string">$&quot;目标Assets不存在，但目标位置:<span class="subst">&#123;graphDataPath&#125;</span>存在同名Asset，删除同名Asset！&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                AssetDatabase.CreateAsset(graphData, graphDataPath);</span><br><span class="line">                Debug.Log(<span class="string">$&quot;目标Asset不存在，创建新Asset！&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// BaseNode是继承至ScriptableObject的</span></span><br><span class="line">            <span class="comment">// 要想数据被正确序列化，需要将所有节点数据作为GraphData的SubAsset存储</span></span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">var</span> node <span class="keyword">in</span> graphData.AllNodeList)</span><br><span class="line">            &#123;</span><br><span class="line">                AssetDatabase.RemoveObjectFromAsset(node);</span><br><span class="line">                AssetDatabase.AddObjectToAsset(node, graphData);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 删除因为Undo系统导致未及时删除的Node Asset</span></span><br><span class="line">            <span class="keyword">var</span> allSubAssets = AssetDatabase.LoadAllAssetsAtPath(graphDataPath);</span><br><span class="line">            <span class="keyword">foreach</span>(<span class="keyword">var</span> subAsset <span class="keyword">in</span> allSubAssets)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> subNode = subAsset <span class="keyword">as</span> BaseNode;</span><br><span class="line">                <span class="keyword">if</span>(subNode != <span class="literal">null</span> &amp;&amp; graphData.GetNodeByGUID(subNode.GUID) == <span class="literal">null</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    Debug.Log(<span class="string">$&quot;节点GUID:<span class="subst">&#123;subNode.GUID&#125;</span>Asset的逻辑对象不存在了，需要删除冗余Node Asset!&quot;</span>);</span><br><span class="line">                    AssetDatabase.RemoveObjectFromAsset(subAsset);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//调用Import更新状态</span></span><br><span class="line">            AssetDatabase.ImportAsset(graphDataPath);</span><br><span class="line">            AssetDatabase.SaveAssets();</span><br><span class="line">            Debug.Log(<span class="string">$&quot;保存图:<span class="subst">&#123;graphDataPath&#125;</span>数据成功！&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">$&quot;不允许保存空图数据，保存图:<span class="subst">&#123;graphDataPath&#125;</span>数据失败！&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 更新选中图数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;graphData&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">UpdateSelectedGraphData</span>(<span class="params">BehaviourTreeGraphData graphData</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(mGraphView == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.Log(<span class="string">$&quot;未创建有效GraphView，清理之前的选中数据！&quot;</span>);</span><br><span class="line">            ClearSelectedGraphData();</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (mSelectedGraphData == graphData)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.Log(<span class="string">$&quot;选中了相同GraphData，不重复加载!&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (graphData != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            mSelectedGraphData = graphData;</span><br><span class="line">            mSelectedGraphAssetPath = mSelectedGraphData == <span class="literal">null</span> ? <span class="literal">null</span> : AssetDatabase.GetAssetPath(mSelectedGraphData);</span><br><span class="line">            mGraphSaveFolderPath = <span class="built_in">string</span>.IsNullOrEmpty(mSelectedGraphAssetPath) ? BTGraphConstEditor.DefaultGraphSaveFolderPath : Path.GetDirectoryName(mSelectedGraphAssetPath);</span><br><span class="line">            mGraphSaveFileName = <span class="built_in">string</span>.IsNullOrEmpty(mSelectedGraphAssetPath) ? BTGraphConstEditor.DefaultGraphSaveFileName : Path.GetFileName(mSelectedGraphAssetPath);</span><br><span class="line">            mGraphView.LoadGraphData(mSelectedGraphData);</span><br><span class="line">            UpdateAssetSelectionValue();</span><br><span class="line">            UpdateSelectedPanelUI();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">               </span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/img/Unity/UIToolkit/SaveAndLoadGraphData.PNG" alt="SaveAndLoadGraphData"></p>
<p>从上面可以看到，我实现以下几个功能:</p>
<ol>
<li>自定义文件名保存设置</li>
<li>自定义文件保存路径设置</li>
<li>自主图数据选择加载还原</li>
</ol>
<p>Note:</p>
<ol>
<li><strong>图数据和节点数据采用的是ScriptableObject方式存储(为了方便通过PropertyField快速绑定ScriptableObject实现属性绑定显示)</strong></li>
<li><strong>ScriptableObject必须存储到本地，所以节点数据是作为子Asset添加到图数据ScriptableObject Asset上的</strong></li>
</ol>
<h4 id="撤销系统"><a href="#撤销系统" class="headerlink" title="撤销系统"></a>撤销系统</h4><p>所有针对ScriptableObject的数据操作，为了方便快速撤销，我们都会使用<strong>Ctrl+Z</strong>的快捷键，但Unity默认对ScriptableObject的修改是不会自动支持修改和快速撤销的，此时我们需要使用<strong>Undo</strong>相关的接口。</p>
<p>在我们对UnityEngine.Object对象(含ScriptableObejct)修改数据前，我们调用Undo.RecordObject()或者Undo.RegisterCompleteObjectUndo()，第一个参数传需要修改的UnityEngine.Object，第二个参数传一个自定义名字的字符串即可。</p>
<p>BehaviourTreeGraphView.cs</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> BehaviourTreeGraphView.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 行为树GraphView</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BehaviourTreeGraphView</span> : <span class="title">GraphView</span></span><br><span class="line">&#123;</span><br><span class="line">    ******</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 响应GraphView变化</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;graphViewChange&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> GraphViewChange <span class="title">OnGraphViewChanged</span>(<span class="params">GraphViewChange graphViewChange</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Debug.Log(<span class="string">$&quot;CommonGraphVIew:OnGraphViewChanged()&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (graphViewChange.elementsToRemove != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">var</span> elementToRemove <span class="keyword">in</span> graphViewChange.elementsToRemove)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (elementToRemove <span class="keyword">is</span> NodeView removeNodeView)</span><br><span class="line">                &#123;</span><br><span class="line">                    Debug.Log(<span class="string">$&quot;删除节点GUID:<span class="subst">&#123;removeNodeView.NodeData.GUID&#125;</span>，节点数据类型:<span class="subst">&#123;removeNodeView.NodeData.GetType().Name&#125;</span>&quot;</span>);</span><br><span class="line">                    RemoveNodeData(removeNodeView.NodeData);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (elementToRemove <span class="keyword">is</span> Edge removeEdge)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">var</span> inputNodeView = removeEdge.input.node <span class="keyword">as</span> NodeView;</span><br><span class="line">                    <span class="keyword">var</span> outputNodeView = removeEdge.output.node <span class="keyword">as</span> NodeView;</span><br><span class="line">                    <span class="keyword">var</span> inputNodeViewName = inputNodeView != <span class="literal">null</span> ? inputNodeView.NodeData.GetType().Name : <span class="built_in">string</span>.Empty;</span><br><span class="line">                    <span class="keyword">var</span> outputNodeViewName = outputNodeView != <span class="literal">null</span> ? outputNodeView.NodeData.GetType().Name : <span class="built_in">string</span>.Empty;</span><br><span class="line">                    Debug.Log(<span class="string">$&quot;删除边，Input节点名:<span class="subst">&#123;inputNodeViewName&#125;</span>，Input端口名:<span class="subst">&#123;removeEdge.input.portName&#125;</span>，Output节点名:<span class="subst">&#123;outputNodeViewName&#125;</span>，Output端口名:<span class="subst">&#123;removeEdge.output.portName&#125;</span>&quot;</span>);</span><br><span class="line">                    RemoveEdgeData(outputNodeView.NodeData.GUID, removeEdge.output.portName, inputNodeView.NodeData.GUID, removeEdge.input.portName);</span><br><span class="line">                    OnEdgeViewUpdate(removeEdge);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    Debug.Log(<span class="string">$&quot;TODO:删除其他Element类型:<span class="subst">&#123;elementToRemove.GetType().Name&#125;</span>！&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (graphViewChange.edgesToCreate != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">var</span> edgeToCreate <span class="keyword">in</span> graphViewChange.edgesToCreate)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> edgeView = edgeToCreate <span class="keyword">as</span> EdgeView;</span><br><span class="line">                <span class="keyword">var</span> inputNodeView = edgeToCreate.input.node <span class="keyword">as</span> NodeView;</span><br><span class="line">                <span class="keyword">var</span> outputNodeView = edgeToCreate.output.node <span class="keyword">as</span> NodeView;</span><br><span class="line">                <span class="keyword">var</span> inputNodeViewName = inputNodeView != <span class="literal">null</span> ? inputNodeView.NodeData.GetType().Name : <span class="built_in">string</span>.Empty;</span><br><span class="line">                <span class="keyword">var</span> outputNodeViewName = outputNodeView != <span class="literal">null</span> ? outputNodeView.NodeData.GetType().Name : <span class="built_in">string</span>.Empty;</span><br><span class="line">                <span class="keyword">var</span> ouputNodeGUID = outputNodeView.NodeData.GUID;</span><br><span class="line">                <span class="keyword">var</span> outputPortName = edgeToCreate.output.portName;</span><br><span class="line">                <span class="keyword">var</span> outputPortTypeFullName = edgeToCreate.output.portType.FullName;</span><br><span class="line">                <span class="keyword">var</span> inputNodeGUID = inputNodeView.NodeData.GUID;</span><br><span class="line">                <span class="keyword">var</span> intputPortName = edgeToCreate.input.portName;</span><br><span class="line">                <span class="keyword">var</span> intputPortTypeFullName = edgeToCreate.input.portType.FullName;</span><br><span class="line">                <span class="keyword">var</span> guid = Guid.NewGuid().ToString();</span><br><span class="line">                EdgeData edgeData = <span class="keyword">new</span> EdgeData(guid, ouputNodeGUID, outputPortName, outputPortTypeFullName, inputNodeGUID, intputPortName, intputPortTypeFullName);</span><br><span class="line">                Debug.Log(<span class="string">$&quot;创建边，Input节点名:<span class="subst">&#123;inputNodeViewName&#125;</span>，Input端口名:<span class="subst">&#123;edgeToCreate.input.portName&#125;</span>，Output节点名:<span class="subst">&#123;outputNodeViewName&#125;</span>，Output端口名:<span class="subst">&#123;edgeToCreate.output.portName&#125;</span>&quot;</span>);</span><br><span class="line">                AddEdgeData(edgeData);</span><br><span class="line">                OnEdgeViewUpdate(edgeView);</span><br><span class="line">                <span class="comment">// 新增边不知道为什么在OnGraphViewChanged里触发时还未添加到connections里</span></span><br><span class="line">                <span class="comment">// 这里采取手动更新新增显示边的索引显示数据</span></span><br><span class="line">                UpdateEdgeViewIndex(edgeView);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (graphViewChange.movedElements != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">var</span> moveElement <span class="keyword">in</span> graphViewChange.movedElements)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (moveElement <span class="keyword">is</span> NodeView moveNodeView)</span><br><span class="line">                &#123;</span><br><span class="line">                    Debug.Log(<span class="string">$&quot;更新节点GUID:<span class="subst">&#123;moveNodeView.NodeData.GUID&#125;</span>，节点数据类型:<span class="subst">&#123;moveNodeView.NodeData.GetType().Name&#125;</span>的位置X:<span class="subst">&#123;moveNodeView.NodeData.Position.x&#125;</span> Y:<span class="subst">&#123;moveNodeView.NodeData.Position.y&#125;</span>&quot;</span>);</span><br><span class="line">                    UpdateNodeRectByNodeView(moveNodeView);</span><br><span class="line">                    OnNodeViewMove(moveNodeView);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    Debug.Log(<span class="string">$&quot;TODO:移动Element类型:<span class="subst">&#123;moveElement.GetType().Name&#125;</span>！&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> graphViewChange;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 添加新节点数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;node&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;enableUndoSystem&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="built_in">bool</span> <span class="title">AddNodeData</span>(<span class="params">BaseNode node, <span class="built_in">bool</span> enableUndoSystem = <span class="literal">true</span></span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (node == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">$&quot;不允许添加空节点数据！&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (enableUndoSystem)</span><br><span class="line">        &#123;</span><br><span class="line">            Undo.RegisterCompleteObjectUndo(SourceGraphData, <span class="string">&quot;AddNodeData&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> result = SourceGraphData.AddNode(node);</span><br><span class="line">        <span class="keyword">if</span> (result)</span><br><span class="line">        &#123;</span><br><span class="line">            OnAddNodeData(node);</span><br><span class="line">            EditorUtility.SetDirty(SourceGraphData);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 移除指定节点数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;node&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;enableUndoSystem&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="built_in">bool</span> <span class="title">RemoveNodeData</span>(<span class="params">BaseNode node, <span class="built_in">bool</span> enableUndoSystem = <span class="literal">true</span></span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (node == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">$&quot;不允许移除空节点数据！&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (enableUndoSystem)</span><br><span class="line">        &#123;</span><br><span class="line">            Undo.RegisterCompleteObjectUndo(SourceGraphData, <span class="string">&quot;RemoveNodeData&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> result = SourceGraphData.RemoveNode(node);</span><br><span class="line">        <span class="keyword">if</span> (result)</span><br><span class="line">        &#123;</span><br><span class="line">            OnRemoveNode(node);</span><br><span class="line">            EditorUtility.SetDirty(SourceGraphData);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 执行移除指定节点View</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;nodeView&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;recusive&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="built_in">bool</span> <span class="title">DoRemoveNodeView</span>(<span class="params">NodeView nodeView, <span class="built_in">bool</span> recusive = <span class="literal">false</span></span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Undo.RegisterCompleteObjectUndo(SourceGraphData, <span class="string">$&quot;RemoveNodeView(<span class="subst">&#123;recusive&#125;</span>)&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> RemoveNodeViewRecusive(nodeView, recusive);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 复制指定节点View</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;duplicateNodeView&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;recusive&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="built_in">bool</span> <span class="title">DoDuplicateNodeView</span>(<span class="params">NodeView duplicateNodeView, <span class="built_in">bool</span> recusive = <span class="literal">false</span></span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Undo.RegisterCompleteObjectUndo(SourceGraphData, <span class="string">$&quot;DuplicateNodeView(<span class="subst">&#123;recusive&#125;</span>)&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> DumplicateNodeViewRecusive(duplicateNodeView, recusive);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从上面可以看到我们无论是主动递归删除节点数据还是递归复制节点数据，又或是主动添加节点View，又或是主动添加边View，我们都通过Undo.RegisterCompleteObjectUndo()对我们的图数据(SourceGraphData继承至ScriptableObject)进行了撤销标记，这样一来我们就能通过Ctrl+Z快速撤销修改并还原正确的图数据Asset了。</p>
<p>递归删除节点操作:</p>
<p><img src="/img/Unity/UIToolkit/DeleteNodeRecusive.PNG" alt="DeleteNodeRecusive"></p>
<p>Ctrl+Z还原递归是删除节点操作:</p>
<p><img src="/img/Unity/UIToolkit/RecoverDeleteNodeRecusiveOperation.PNG" alt="RecoverDeleteNodeRecusiveOperation"></p>
<p>Note:</p>
<ol>
<li><strong>Undo只支持的是继承至UntiyEngine.Object的对象。</strong></li>
<li><strong>Undo.RecordObject只记录增量快照，Undo.RegisterCompleteObjectUndo记录完整的对象数据，为了确保数据操作的撤销正确性，推荐用后者，本人就是在删除嵌套删除节点数据时发现Undo.RecordObejct未能正确还原数据导致报错后使用Undo.RegisterCompleteObjectUndo才正确实现嵌套删除节点功能。</strong></li>
</ol>
<h2 id="事件驱动行为树"><a href="#事件驱动行为树" class="headerlink" title="事件驱动行为树"></a>事件驱动行为树</h2><p><strong>事件驱动的行为树核心是参考<a target="_blank" rel="noopener" href="https://github.com/meniku/NPBehave/blob/master/README_CH.md">NPBehave</a>的设计思路。</strong></p>
<p><a target="_blank" rel="noopener" href="https://github.com/meniku/NPBehave/blob/master/README_CH.md"><strong>基于事件的行为树设计是，我们不再每帧都从根节点去遍历行为树，而是维护一个调度器负责保存已激活的节点，当正在执行的行为终止时，由其父节点决定接下来的行为。</strong></a></p>
<h3 id="事件驱动行为树类图设计"><a href="#事件驱动行为树类图设计" class="headerlink" title="事件驱动行为树类图设计"></a>事件驱动行为树类图设计</h3><p><strong>Clock – 行为树驱动时钟(事件驱动行为树的核心，负责统一调度定时器)</strong></p>
<p><strong>BehaviourTreeGraphData – 树编辑器存储数据(基于ScriptableObject)</strong></p>
<p><strong>BaseNode – 树节点数据(基于ScriptableObject)</strong></p>
<p><strong>EdgeData – 树边数据</strong></p>
<p><strong>NodePortData – 树连接端口数据</strong></p>
<p><strong>NodeState – 树节点状态</strong></p>
<p><strong>NodeType – 树节点类型</strong></p>
<p><strong>Blackboard – 树黑板数据</strong></p>
<p><strong>TBehaviourTree – 行为树执行抽象</strong></p>
<p><strong>TBehaviourTreeManager – 行为树执行统一管理类</strong></p>
<p><strong>TreeData – 行为树树数据抽象</strong></p>
<p><strong>UnityContext – Unity驱动类(驱动全局Clock)</strong></p>
<p><strong>AbortType – 行为树打断类型</strong></p>
<p><strong>BaseActionNode – 行为树行为节点基类</strong></p>
<p><strong>BaseConditionNode – 行为树条件节点基类</strong></p>
<p><strong>BaseParentNode – 行为树父节点基类抽象(带子节点的节点需要继承)</strong></p>
<p><strong>BaseCompositionNode – 行为树复合节点基类</strong></p>
<p><strong>BaseDecorationNode – 行为树装饰节点基类</strong></p>
<p><strong>BaseObservingDecorationNode – 行为树可被观察条件打断的装饰节点基类</strong></p>
<p><strong>BaseCompareShareNode – 行为树黑板比较节点基类</strong></p>
<p><strong>BaseConditionDecorationNode – 行为树条件装饰节点基类</strong></p>
<p><strong>RootNode – 行为树根节点类</strong></p>
<p><strong>SelectorNode – 行为树选择节点</strong></p>
<p><strong>SequenceNode – 行为树顺序节点</strong></p>
<p><strong>ParalNode – 行为树并发节点</strong></p>
<p><strong>RandomSelector – 行为树随机选择节点</strong></p>
<p>更多细节的行为树节点这里就不一一介绍了。</p>
<h3 id="事件驱动行为树数据编辑"><a href="#事件驱动行为树数据编辑" class="headerlink" title="事件驱动行为树数据编辑"></a>事件驱动行为树数据编辑</h3><p>前面通过UIElement，GraphView的相关使用，我们已经成功完成了对树数据(BehaviourTreeGraphData.cs)的树数据编辑。</p>
<h3 id="事件驱动行为树运行时数据构建"><a href="#事件驱动行为树运行时数据构建" class="headerlink" title="事件驱动行为树运行时数据构建"></a>事件驱动行为树运行时数据构建</h3><p>通过编辑的树数据到事件驱动的行为树，我们还需要利用树数据构建TBehaviourTree的过程。</p>
<p>第一步:</p>
<ol>
<li><p>读取BehaviourTreeGraphData.cs数据并克隆数据以备运行时使用</p>
<p>TBehaviourTree.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 加载行为树图数据</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;assetPath&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">LoadBTGraphData</span>(<span class="params"><span class="built_in">string</span> assetPath</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    ReleaseBTGraphAsset();</span><br><span class="line">    BTOriginalGraph = TBehaviourTreeManager.Singleton.GetCacheBTGraph(assetPath);</span><br><span class="line">    <span class="keyword">if</span>(BTOriginalGraph == <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> btGraphAsset = Resources.Load&lt;BehaviourTreeGraphData&gt;(assetPath);</span><br><span class="line">        BTOriginalGraph = btGraphAsset;</span><br><span class="line">        TBehaviourTreeManager.Singleton.CacheBTGraph(assetPath, BTOriginalGraph);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    BTRunningGraph = BTOriginalGraph?.CloneSelf();</span><br><span class="line">    BTRunningGraph?.SetBTOwner(<span class="keyword">this</span>);</span><br><span class="line">    BTRunningGraph?.InitRuntimeDatas();</span><br><span class="line">    BTRunningGraph?.Start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>构建行为树运行时数据</p>
<p>BehaviourTreeGraphData.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 初始化运行时数据</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">InitRuntimeDatas</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    InitClock();</span><br><span class="line">    InitBlackboard();</span><br><span class="line">    InitTreeDatas();</span><br><span class="line">    mInitRunTimeDataComplete = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 初始化树数据</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">InitTreeDatas</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    RecyleAllTreeDatas();</span><br><span class="line">    TreeDataList.Clear();</span><br><span class="line">    <span class="keyword">var</span> rootNodeList = GetAllRootNodes();</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="keyword">var</span> rootNode <span class="keyword">in</span> rootNodeList)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> treeData = ObjectPool.Singleton.Pop&lt;TreeData&gt;();</span><br><span class="line">        treeData.SetData(<span class="keyword">this</span>, rootNode, Blackboard, Clock);</span><br><span class="line">        TreeDataList.Add(treeData);</span><br><span class="line">        <span class="keyword">if</span>(RootTree == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            RootTree = treeData;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(TreeDataList.Count &gt; <span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        Debug.LogError(<span class="string">$&quot;行为树不应该有多个根节点树，请检查配置！&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 获取所有根节点列表</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;BaseNode&gt; <span class="title">GetAllRootNodes</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    List&lt;BaseNode&gt; rootNodeList = <span class="keyword">new</span> List&lt;BaseNode&gt;();</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="keyword">var</span> node <span class="keyword">in</span> AllNodeList)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (node.EntryPoint)</span><br><span class="line">        &#123;</span><br><span class="line">            rootNodeList.Add(node);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (rootNodeList.Count == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        Debug.LogWarning(<span class="string">$&quot;图:<span class="subst">&#123;name&#125;</span>没有根节点，获取所有根节点数量为0！&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> rootNodeList;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到我们通过Clone的树数据(BehaviourTreeGraphData.cs)构建了我们想要的单颗树数据(TreeData.cs)(<strong>这一步的目的是为未来支持多个根节点的编辑器设计的，目前行为树只允许一个根节点</strong>)</p>
<p>TreeData.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 初始化指定图数据</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;graphData&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;rootNode&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;blackboard&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;clock&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SetData</span>(<span class="params">BehaviourTreeGraphData graphData, BaseNode rootNode, Blackboard blackboard, Clock clock</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    OwnerGraphData = graphData;</span><br><span class="line">    RootNode = rootNode;</span><br><span class="line">    Blackboard = blackboard;</span><br><span class="line">    Clock = clock;</span><br><span class="line">    InitAllNodeAndEdgeDatas();</span><br><span class="line">    mInitComplete = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 初始化所有节点和边数据</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">InitAllNodeAndEdgeDatas</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    mAllNodeList.Clear();</span><br><span class="line">    OwnerGraphData.GetAllChildNodeList(<span class="keyword">ref</span> mAllNodeList, RootNode, <span class="literal">true</span>);</span><br><span class="line">    mAllEdgeDataList.Clear();</span><br><span class="line">    OwnerGraphData.GetAllChildEdgeDataList(<span class="keyword">ref</span> mAllEdgeDataList, RootNode, <span class="literal">true</span>);</span><br><span class="line">    InitNodeMapData();</span><br><span class="line">    InitEdgeMapData();</span><br><span class="line">    InitNodesTreeData();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">******</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 初始化节点树数据</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">InitNodesTreeData</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="keyword">var</span> node <span class="keyword">in</span> mAllNodeList)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(node == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        node.SetOwnerTreeData(<span class="keyword">this</span>);</span><br><span class="line">        List&lt;BaseNode&gt; childNodeList = <span class="keyword">new</span> List&lt;BaseNode&gt;();</span><br><span class="line">        OwnerGraphData.GetAllChildNodeList(<span class="keyword">ref</span> childNodeList, node);</span><br><span class="line">        childNodeList.Remove(node);</span><br><span class="line">        <span class="keyword">foreach</span>(<span class="keyword">var</span> childNode <span class="keyword">in</span> childNodeList)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(childNode == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            childNode.SetParentNode(node <span class="keyword">as</span> BaseParentNode);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> childCount = childNodeList.Count;</span><br><span class="line">        <span class="keyword">if</span> (childCount &gt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> parentNode = node <span class="keyword">as</span> BaseParentNode;</span><br><span class="line">            parentNode.SetChildNodeList(childNodeList);</span><br><span class="line">            <span class="keyword">if</span>(node <span class="keyword">is</span> BaseDecorationNode &amp;&amp; childCount &gt; <span class="number">1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                Debug.LogError(<span class="string">$&quot;修饰节点名:<span class="subst">&#123;node.name&#125;</span>,GUID:<span class="subst">&#123;node.GUID&#125;</span>有超过1个数量的子节点，请检查配置！&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        node.SetClock(Clock);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<p>​		通过构建TreeData.cs以及所有相关BaseNode的运行时数据，我们为行为树的执行的数据准备工作就算是完成了。</p>
<ol start="3">
<li><p>行为树启动执行</p>
<p>BehaviourTreeGraphData.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 开始行为树图数据运行</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Start</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span>(!mInitRunTimeDataComplete)</span><br><span class="line">    &#123;</span><br><span class="line">        Debug.LogError(<span class="string">$&quot;未初始化运行时数据，开始行为树图数据失败！&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    Clock?.Enable();</span><br><span class="line">    RootTree?.Start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>TreeData.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 开始运行树数据</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Start</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span>(!mInitComplete)</span><br><span class="line">    &#123;</span><br><span class="line">        Debug.LogError(<span class="string">$&quot;树数据未初始化完成，开始运行树数据失败！&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    RootNode?.Start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>BaseNode.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 节点开始运行</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Start</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    Debug.Log(<span class="string">$&quot;节点GUID:<span class="subst">&#123;GUID&#125;</span>开始运行！&quot;</span>);</span><br><span class="line">    NodeState = NodeState.Running;</span><br><span class="line">    DoStart();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 执行开始运行流程</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">DoStart</span>()</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>RootNode.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 执行开始运行流程</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">DoStart</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">base</span>.DoStart();</span><br><span class="line">    DecorateNode.Start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从上面可以看到我们通过BehaviourTreeGraphData.cs树数据可用并构建TreeData.cs，然后驱动TreeData调用RootNode的Start实现了行为树的执行驱动，。</p>
</li>
</ol>
<h3 id="事件驱动行为树执行设计"><a href="#事件驱动行为树执行设计" class="headerlink" title="事件驱动行为树执行设计"></a>事件驱动行为树执行设计</h3><p>传统行为树和事件驱动行为树在驱动树执行上的区别:</p>
<ol>
<li><strong>传统行为树每帧都要从根节点开始遍历行为树，而目的仅仅是为了得到最近激活的节点进行逻辑驱动。事件驱动的行为树是通过定时器进行驱动实现节点逻辑执行。</strong></li>
<li><strong>传统行为树和事件驱动的行为树还有一大区别节点执行结果的返回方式。传统行为树是子节点执行完成后直接通过return的方式把子节点执行结果直接返回给父节点，然后父节点根据子节点结果决定后续逻辑。而事件驱动行为树子节点结束是通过调用父节点的ChildStop()通知父节点子节点结束，而不同节点类型对于子节点结束的后续处理逻辑是在自身的OnChildStop里</strong></li>
</ol>
<p>事件驱动执行最核心的是<strong>计时器(Clock.cs)</strong></p>
<p>接下来让我们看看事件驱动行为树是如何利用定时器Clock.cs实现执行驱动和事件驱动的。</p>
<p>在了解之前，这里先说明下RootNode.cs的类继承设计，RootNode.cs这里我设计成的是装饰节点，所以<strong>无论行为树的根是驱动顺序执行(SequenceNode.cs)还是选择执行(SelectorNode.cs)，都得连接在RootNode之下。</strong></p>
<p>RootNode.cs继承关系如下:</p>
<p><strong>RootNode : BaseDecorationNode : BaseParentNode : BaseNode</strong></p>
<p>这里我以RootNode连接一个SequenceNode，SequenceNode连接一个WaitTimeNode.cs和LogNode.cs节点为例来说明事件驱动的执行过程。</p>
<p><img src="/"></p>
<ol>
<li><p>RootNode执行Start()</p>
<p>BaseNode.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 节点开始运行</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Start</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    Debug.Log(<span class="string">$&quot;节点GUID:<span class="subst">&#123;GUID&#125;</span>开始运行！&quot;</span>);</span><br><span class="line">    NodeState = NodeState.Running;</span><br><span class="line">    DoStart();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>RootNode驱动子节点SequenceNode执行</p>
<p>RootNode.cs</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 执行开始运行流程</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">DoStart</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">base</span>.DoStart();</span><br><span class="line">    DecorateNode.Start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>SequenceNode执行Start()</p>
<p>SequenceNode.cs</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 响应开始</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">DoStart</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">base</span>.DoStart();</span><br><span class="line">    mCurrentIndex = <span class="number">-1</span>;</span><br><span class="line">    ProcessChildren();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 执行子节点</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">ProcessChildren</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    mCurrentIndex++;</span><br><span class="line">    <span class="keyword">if</span> (mCurrentIndex &lt; ChildNodeCount)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (IsAbort)</span><br><span class="line">        &#123;</span><br><span class="line">            Stop(<span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            mChildNodeList[mCurrentIndex].Start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        Stop(<span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>SequenceNode驱动子节点WaitTimeNode执行Start()</p>
<p>WaitTimeNode.cs</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 执行开始</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">DoStart</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">base</span>.DoStart();</span><br><span class="line">    mOwnerTreeData.Clock.AddTimer(WaitTime, <span class="number">1</span>, OnWaitTimeComplete);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">******</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 执行运行完毕流程</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">DoStop</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">base</span>.DoStop();</span><br><span class="line">    mOwnerTreeData.Clock.RemoveTimer(OnWaitTimeComplete);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 响应等待时长完成</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">OnWaitTimeComplete</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    Debug.Log(<span class="string">$&quot;UID:<span class="subst">&#123;GUID&#125;</span>,WaitTimeNode:OnWaitTimeComplete(),WaitTime:<span class="subst">&#123;WaitTime&#125;</span>&quot;</span>);</span><br><span class="line">    Stop(<span class="literal">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>可以看到WaitTimeNode的等待执行不像传统行为树通过每一次Update进行时间累加，而是通过定时器Clock注入一个等待时长的定时器来驱动等待逻辑判定的。</strong></p>
</li>
<li><p>WaitTimeNode等待执行完毕，通知父节点SequenceNode自身子节点执行完成，SequenceNode.ChildStop()执行然后调用SequenceNode的DoChildStop()</p>
<p>SequenceNode.cs</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 响应子节点停止</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;child&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;success&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">DoChildStop</span>(<span class="params">BaseNode child, <span class="built_in">bool</span> success</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">base</span>.DoChildStop(child, success);</span><br><span class="line">    <span class="keyword">if</span>(success)</span><br><span class="line">    &#123;</span><br><span class="line">        ProcessChildren();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        Stop(<span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 执行子节点</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">ProcessChildren</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    mCurrentIndex++;</span><br><span class="line">    <span class="keyword">if</span> (mCurrentIndex &lt; ChildNodeCount)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (IsAbort)</span><br><span class="line">        &#123;</span><br><span class="line">            Stop(<span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            mChildNodeList[mCurrentIndex].Start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        Stop(<span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>响应WaitTimeNode执行完成成功，所以SequenceNode接着执行下一个节点LogNode</p>
</li>
<li><p>LogNode执行Start()然后标记执行完成</p>
<p>LogNode.cs</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 执行开始</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">DoStart</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">base</span>.DoStart();</span><br><span class="line">    Debug.Log(<span class="string">$&quot;GUID:<span class="subst">&#123;GUID&#125;</span>,LogNode:<span class="subst">&#123;LogContent&#125;</span>&quot;</span>);</span><br><span class="line">    Stop(<span class="literal">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>LogNode执行打印Log完成后，调用Stop(true)表示完成，然后通过调用父节点SequenceNode.ChildStop()，然后调用SequenceNode.DoChildStop()</p>
</li>
<li><p>SequenceNode响应LogNode子节点执行完成，发现所有子节点都执行完成，调用自身节点执行完成Stop(true)</p>
<p>SequenceNode.cs</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 响应子节点停止</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;child&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;success&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">DoChildStop</span>(<span class="params">BaseNode child, <span class="built_in">bool</span> success</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">base</span>.DoChildStop(child, success);</span><br><span class="line">    <span class="keyword">if</span>(success)</span><br><span class="line">    &#123;</span><br><span class="line">        ProcessChildren();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        Stop(<span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 执行子节点</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">ProcessChildren</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    mCurrentIndex++;</span><br><span class="line">    <span class="keyword">if</span> (mCurrentIndex &lt; ChildNodeCount)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (IsAbort)</span><br><span class="line">        &#123;</span><br><span class="line">            Stop(<span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            mChildNodeList[mCurrentIndex].Start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        Stop(<span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>RootNode响应SequenceNode执行完成，执行RootNode.ChildStop()和RootNode.DoChildStop()</p>
<p>RootNode.cs</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 响应子节点运行完毕</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;child&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;success&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">DoChildStop</span>(<span class="params">BaseNode child, <span class="built_in">bool</span> success</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">base</span>.DoChildStop(child, success);</span><br><span class="line">    <span class="comment">// 根节点运行完一遍后</span></span><br><span class="line">    <span class="keyword">if</span> (!IsRunningOnce)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 重置所有节点状态，避免反复运行时，可视化查看到之前的状态</span></span><br><span class="line">        ResetAllNodeState();</span><br><span class="line">        Clock.AddTimer(<span class="number">0</span>, <span class="number">0</span>, Start);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        Stop(success);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>到这里我们的行为树逻辑就算是执行完成一遍了，但<strong>行为树如何实现循环执行，逻辑在RootNode.DoChildStop() 里通过重新注入Clock定时器开启RootNode.Start()从而实现了事件驱动行为树的循环执行。</strong></p>
</li>
</ol>
<p>从上面可以看出<strong>事件驱动行为树无论是节点的执行还是行为树的循环执行，都是通过Clock定时器注入定时器来实现的。</strong></p>
<p>事件驱动的优点：</p>
<ol>
<li><strong>避免每帧从根节点执行一遍所有逻辑，而是在对应节点上通过定时器方式实现对应节点逻辑直接执行的方式，从而避免每帧无用的逻辑更新执行，更加高效。</strong></li>
</ol>
<h3 id="事件驱动行为树条件判定设计"><a href="#事件驱动行为树条件判定设计" class="headerlink" title="事件驱动行为树条件判定设计"></a>事件驱动行为树条件判定设计</h3><p>传统行为树和事件驱动行为树在驱动条件节点判定的区别:</p>
<ol>
<li><strong>传统行为树每帧都要把执行的条件节点执行一次去比较条件是否变化，从而实现监听条件变化的目的。事件驱动的行为树是通过启动定时器实现条件节点逻辑判定执行。</strong></li>
</ol>
<p>接下来让我们看看行为树是如何利用定时器Clock.cs实现条件执行判定的。</p>
<p>在实战理解事件驱动行为树条件判定执行之前，我们需要了解几个主要的类设计：</p>
<ol>
<li><p><strong>BaseObservingDecorationNode.cs – 实现可被观察条件打断的装饰节点基类</strong></p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> BaseObservingDecorationNode.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 可被观察条件打断的装饰节点基类</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">Serializable</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title">BaseObservingDecorationNode</span> : <span class="title">BaseDecorationNode</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 打断类型</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;打断类型&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> AbortType AbortType;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 是否正在观察</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">protected</span> <span class="built_in">bool</span> mIsObserving;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 响应开始</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">DoStart</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">base</span>.DoStart();</span><br><span class="line">        <span class="keyword">if</span> (AbortType != AbortType.NONE)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(!mIsObserving)</span><br><span class="line">            &#123;</span><br><span class="line">                mIsObserving = <span class="literal">true</span>;</span><br><span class="line">                StartObserving();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(!IsConditionMet())</span><br><span class="line">        &#123;</span><br><span class="line">            Stop(<span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            DecorateNode.Start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ******</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 响应子节点停止</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;child&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;success&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">DoChildStop</span>(<span class="params">BaseNode child, <span class="built_in">bool</span> success</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">base</span>.DoChildStop(child, success);</span><br><span class="line">        <span class="keyword">if</span>(AbortType == AbortType.NONE || AbortType == AbortType.SELF)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(mIsObserving)</span><br><span class="line">            &#123;</span><br><span class="line">                mIsObserving = <span class="literal">false</span>;</span><br><span class="line">                StopObserving();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        Stop(success);</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">    ******</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 开始条件监听流程</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">StartObserving</span>()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 停止条件监听观察</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">StopObserving</span>()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 条件是否满足</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="built_in">bool</span> <span class="title">IsConditionMet</span>()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>从上面的代码可以看出BaseObservingDecorationNode.cs实现了节点条件监听（StartObserving()）和取消监听的流程(StopObserving())</strong></p>
</li>
<li><p><strong>BaseConditionDecorationNode.cs – 实现间隔时长判定条件的装饰节点基类</strong></p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> BaseConditionDecorationNode.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 可打断定时检查条件修饰节点基类</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">Serializable</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title">BaseConditionDecorationNode</span> : <span class="title">BaseObservingDecorationNode</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 条件检查时间间隔(秒)</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;条件检查时间间隔(秒)&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">float</span> CheckInterval = <span class="number">0f</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 条件检查时间随机参考值(-0.5* -- 0.5*)</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;条件检查时间随机参考值&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">float</span> CheckVariance = <span class="number">0f</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 开始条件监听</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">StartObserving</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mOwnerTreeData.Clock.AddTimer(CheckInterval, CheckVariance, <span class="number">-1</span>, Evaluate);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 停止条件监听</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">StopObserving</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mOwnerTreeData.Clock.RemoveTimer(Evaluate);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 条件是否满足</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="built_in">bool</span> <span class="title">IsConditionMet</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> ConditionCheck();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 条件检查(子类重写)</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="built_in">bool</span> <span class="title">ConditionCheck</span>()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>从上面代码可以看出BaseConditionDecorationNode.cs实现了定时器间隔的条件判定</strong></p>
</li>
</ol>
<p>这里我以RootNode连接一个SequenceNode，SequenceNode连接一个HelthValueNode，HelthValueNode连接一个SequenceNode，SequenceNode连接一个WaiterTimeNode和LogNode.cs节点为例来说明事件驱动条件节点的判定更新过程。</p>
<p><img src="/"></p>
<ol>
<li><p>RootNode执行Start()</p>
</li>
<li><p>SequenceNode执行Start()</p>
</li>
<li><p>HelthValueNode执行Start()，如果打断类型不为NONE，此时会触发BaseConditionDecorationNode的StartObserving()开启条件定时器监听</p>
<p>HelthValueNode.cs</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> HealthValueNode.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 生命值条件检查修饰节点类</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">Serializable</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">HealthValueNode</span> : <span class="title">BaseConditionDecorationNode</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 比较类型</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;比较类型&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> ComparisonType ComparisonType;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 生命值</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;生命值&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">float</span> HealthValue = <span class="number">0f</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 条件检查</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="built_in">bool</span> <span class="title">ConditionCheck</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> bindUID = mOwnerTreeData.OwnerGraphData.OwnerBT.BindUID;</span><br><span class="line">        <span class="keyword">var</span> bindActor = ActorManager.Singleton.GetActorByUID(bindUID);</span><br><span class="line">        <span class="keyword">if</span>(bindActor == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">$&quot;找不到UID:<span class="subst">&#123;bindUID&#125;</span>对象，生命值检查比较失败！&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(ComparisonType == ComparisonType.LESS)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> bindActor.Health &lt; HealthValue;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (ComparisonType == ComparisonType.GREATER)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> bindActor.Health &gt; HealthValue;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (ComparisonType == ComparisonType.LESS_AND_EQUAL)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> bindActor.Health &lt;= HealthValue;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (ComparisonType == ComparisonType.GREATER_AND_EQUAL)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> bindActor.Health &gt;= HealthValue;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (ComparisonType == ComparisonType.EQUAL)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> bindActor.Health == HealthValue;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">$&quot;不支持的比较运算类型:<span class="subst">&#123;ComparisonType&#125;</span>,比较对象UID:<span class="subst">&#123;bindUID&#125;</span>的生命值失败！&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从上面代码可以看到HelthValueNode.cs实现了ConditionCheck()方法，，结合父类的定时器执行，实现了血量的定时条件判定逻辑。</p>
</li>
<li><p>HelthValueNode条件判定ConditionCheck()通过，执行SequenceNode.cs的Start()</p>
</li>
<li><p>WaitTimeNode执行Start()</p>
</li>
<li><p>在WaitTimeNode执行的过程中HelthValueNode的ConditionCheck()依然在执行</p>
</li>
<li><p>WaitTimeNode执行完毕Stop(true)，SequenceNode执行下一个节点LogNode的Start</p>
</li>
<li><p>LogNode执行Start()触发执行完毕Stop(true)，SequenceNode触发DoChildStop()触发执行完成Stop(true)</p>
</li>
<li><p>SequenceNode执行完成触发HelthValueNode的DoChildStop()，此时如果没有设置打断类型(默认为NONE)，那么此时为调用BaseConditionDecorationNode的StopObserving()取消条件定时器判定</p>
</li>
<li><p>HelthValueNode执行完毕Stop(true)，SequenceNode执行DoChildStop()执行Stop(true)，最后触发RootNode的DoChildStop()完成执行。</p>
</li>
</ol>
<p>Node:</p>
<ol>
<li><strong>事件驱动行为树里，需要支持定时判定和打断的都封装成了装饰节点而非条件节点</strong></li>
<li><strong>目前纯条件节点不支持定时器判定和打断，只支持常规单次条件判定，推荐尽量用装饰节点来定义条件</strong></li>
</ol>
<h3 id="事件驱动行为树黑板"><a href="#事件驱动行为树黑板" class="headerlink" title="事件驱动行为树黑板"></a>事件驱动行为树黑板</h3><p><strong>事件驱动行为树的黑板和传统的行为树黑板有所区别。传统行为树黑板主要作为行为树局部黑板负责存储和修改数据。事件驱动的行为树为了支持黑板数据修改的监听，黑板的设计还考虑了数据监听通知逻辑，而黑板的监听通知逻辑是通过定时器(Clock)来完成的。</strong></p>
<p>接下来直接给我们看下黑板的关键部分代码定义就能知道事件驱动行为树的黑板是如何实现黑板数据监听通知逻辑的，后续在讲解打断篇章会涉及实例理解黑板的数据修改和打断监听设计。</p>
<p>Blackboard.cs</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 黑板模式，数据共享中心</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Blackboard</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 黑板操作类型</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">enum</span> BBOperationType</span><br><span class="line">    &#123;</span><br><span class="line">        ADD,</span><br><span class="line">        REMOVE,</span><br><span class="line">        CHANGE</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 通知数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">struct</span> Notification</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 操作Key</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> key;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 黑板操作类型</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> BBOperationType type;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 操作值</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">object</span> <span class="keyword">value</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Notification</span>(<span class="params"><span class="built_in">string</span> key, BBOperationType type, <span class="built_in">object</span> <span class="keyword">value</span></span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">this</span>.key = key;</span><br><span class="line">            <span class="keyword">this</span>.type = type;</span><br><span class="line">            <span class="keyword">this</span>.<span class="keyword">value</span> = <span class="keyword">value</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 时钟</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> Clock mClock;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 黑板数据集合中心</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> Dictionary&lt;<span class="built_in">string</span>, BaseBlackboardData&gt; mBlackboardDataMap;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 所有Key的监听Map<span class="doctag">&lt;黑板数据Key名, 黑板监听类型回调列表&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> Dictionary&lt;<span class="built_in">string</span>, List&lt;Action&lt;BBOperationType, <span class="built_in">object</span>&gt;&gt;&gt; mObservers;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 是否正在通知</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">bool</span> mIsNotifying;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 所有待添加的监听Key的监听Map<span class="doctag">&lt;黑板数据Key名, 黑板监听类型回调列表&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> Dictionary&lt;<span class="built_in">string</span>, List&lt;Action&lt;BBOperationType, <span class="built_in">object</span>&gt;&gt;&gt; mAddObservers;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 所有等待移除的监听Key的监听Map<span class="doctag">&lt;黑板数据Key名, 黑板监听类型回调列表&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> Dictionary&lt;<span class="built_in">string</span>, List&lt;Action&lt;BBOperationType, <span class="built_in">object</span>&gt;&gt;&gt; mRemoveObservers;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 等待通知列表</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> List&lt;Notification&gt; mNotifications;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 正在通知的通知列表</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> List&lt;Notification&gt; mNotificationsDispatch;</span><br><span class="line"></span><br><span class="line">    ******</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 更新黑板数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;typeparam name=&quot;T&quot;&gt;</span><span class="doctag">&lt;/typeparam&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;key&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;value&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;noNotification&quot;&gt;</span>是否不通知(默认通知)<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">UpdateData</span>&lt;<span class="title">T</span>&gt;(<span class="params"><span class="built_in">string</span> key, T <span class="keyword">value</span> = <span class="literal">default</span>, <span class="built_in">bool</span> noNotification = <span class="literal">false</span></span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> data = GetBlackboardData(key);</span><br><span class="line">        <span class="keyword">if</span> (data != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> targetData = data <span class="keyword">as</span> BlackboardData&lt;T&gt;;</span><br><span class="line">            <span class="keyword">if</span> (targetData == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                Debug.LogError(<span class="string">$&quot;黑板数据里Key:<span class="subst">&#123;key&#125;</span>的数据类型和更新数据类型:<span class="subst">&#123;<span class="keyword">typeof</span>(T).Name&#125;</span>不匹配，更新数据失败！&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            targetData.Data = <span class="keyword">value</span>;</span><br><span class="line">            <span class="keyword">if</span>(!noNotification)</span><br><span class="line">            &#123;</span><br><span class="line">                mNotifications.Add(<span class="keyword">new</span> Notification(key, BBOperationType.CHANGE, <span class="keyword">value</span>));</span><br><span class="line">                mClock.AddTimer(<span class="number">0f</span>, <span class="number">0</span>, NotifiyObservers);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            BlackboardData&lt;T&gt; targetData = <span class="keyword">new</span> BlackboardData&lt;T&gt;(key, <span class="keyword">value</span>);</span><br><span class="line">            mBlackboardDataMap.Add(key, targetData);</span><br><span class="line">            <span class="keyword">if</span> (!noNotification)</span><br><span class="line">            &#123;</span><br><span class="line">                mNotifications.Add(<span class="keyword">new</span> Notification(key, BBOperationType.ADD, <span class="keyword">value</span>));</span><br><span class="line">                mClock.AddTimer(<span class="number">0f</span>, <span class="number">0</span>, NotifiyObservers);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 移除指定数据名的黑板数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;key&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;noNotification&quot;&gt;</span>是否不通知(默认通知)<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">RemoveData</span>(<span class="params"><span class="built_in">string</span> key, <span class="built_in">bool</span> noNotification = <span class="literal">false</span></span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> result = mBlackboardDataMap.Remove(key);</span><br><span class="line">        <span class="keyword">if</span>(result &amp;&amp; !noNotification)</span><br><span class="line">        &#123;</span><br><span class="line">            mNotifications.Add(<span class="keyword">new</span> Notification(key, BBOperationType.REMOVE, <span class="literal">null</span>));</span><br><span class="line">            mClock.AddTimer(<span class="number">0f</span>, <span class="number">0</span>, NotifiyObservers);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ******</span><br><span class="line">        </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 添加黑板数据操作监听</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;key&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;observer&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">AddObserver</span>(<span class="params"><span class="built_in">string</span> key, System.Action&lt;BBOperationType, <span class="built_in">object</span>&gt; observer</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        List&lt;System.Action&lt;BBOperationType, <span class="built_in">object</span>&gt;&gt; observers = GetObserverList(<span class="keyword">this</span>.mObservers, key);</span><br><span class="line">        <span class="keyword">if</span> (!mIsNotifying)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (!observers.Contains(observer))</span><br><span class="line">            &#123;</span><br><span class="line">                observers.Add(observer);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (!observers.Contains(observer))</span><br><span class="line">            &#123;</span><br><span class="line">                List&lt;System.Action&lt;BBOperationType, <span class="built_in">object</span>&gt;&gt; addObservers = GetObserverList(<span class="keyword">this</span>.mAddObservers, key);</span><br><span class="line">                <span class="keyword">if</span> (!addObservers.Contains(observer))</span><br><span class="line">                &#123;</span><br><span class="line">                    addObservers.Add(observer);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            List&lt;System.Action&lt;BBOperationType, <span class="built_in">object</span>&gt;&gt; removeObservers = GetObserverList(<span class="keyword">this</span>.mRemoveObservers, key);</span><br><span class="line">            <span class="keyword">if</span> (removeObservers.Contains(observer))</span><br><span class="line">            &#123;</span><br><span class="line">                removeObservers.Remove(observer);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 通知</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">NotifiyObservers</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (mNotifications.Count == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mNotificationsDispatch.Clear();</span><br><span class="line">        mNotificationsDispatch.AddRange(mNotifications);</span><br><span class="line">        mNotifications.Clear();</span><br><span class="line"></span><br><span class="line">        mIsNotifying = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">foreach</span> (Notification notification <span class="keyword">in</span> mNotificationsDispatch)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="keyword">this</span>.mObservers.ContainsKey(notification.key))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//                Debug.Log(&quot;1 do not notify for key:&quot; + notification.key + &quot; value: &quot; + notification.value);</span></span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            List&lt;System.Action&lt;BBOperationType, <span class="built_in">object</span>&gt;&gt; observers = GetObserverList(<span class="keyword">this</span>.mObservers, notification.key);</span><br><span class="line">            <span class="keyword">foreach</span> (System.Action&lt;BBOperationType, <span class="built_in">object</span>&gt; observer <span class="keyword">in</span> observers)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">this</span>.mRemoveObservers.ContainsKey(notification.key) &amp;&amp; <span class="keyword">this</span>.mRemoveObservers[notification.key].Contains(observer))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                observer(notification.type, notification.<span class="keyword">value</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="built_in">string</span> key <span class="keyword">in</span> <span class="keyword">this</span>.mAddObservers.Keys)</span><br><span class="line">        &#123;</span><br><span class="line">            GetObserverList(<span class="keyword">this</span>.mObservers, key).AddRange(<span class="keyword">this</span>.mAddObservers[key]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="built_in">string</span> key <span class="keyword">in</span> <span class="keyword">this</span>.mRemoveObservers.Keys)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">foreach</span> (System.Action&lt;BBOperationType, <span class="built_in">object</span>&gt; action <span class="keyword">in</span> mRemoveObservers[key])</span><br><span class="line">            &#123;</span><br><span class="line">                GetObserverList(<span class="keyword">this</span>.mObservers, key).Remove(action);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.mAddObservers.Clear();</span><br><span class="line">        <span class="keyword">this</span>.mRemoveObservers.Clear();</span><br><span class="line"></span><br><span class="line">        mIsNotifying = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在Blackboard.UpdateData<T>()和Blackboard.RemoveData()方法里可以看到，Blackboard把黑板数据的操作和操作数据封装成Notification，然后结合定时器(Clock)实现下一帧对黑板相关数据和操作监听的通知。</p>
<h3 id="事件驱动行为树打断"><a href="#事件驱动行为树打断" class="headerlink" title="事件驱动行为树打断"></a>事件驱动行为树打断</h3><p><strong>个人理解行为树打断主要是为了支持因为条件满足已经执行过的逻辑执行条件变了不满足需要打断执行往后执行或者因为条件不满足没有执行过的逻辑因为条件变了满足了希望重新激活执行。</strong></p>
<p>首先我们来理解下事件驱动打断的核心设计原理，之后再针对不同的行为树打断类型进行实战分析和测试。</p>
<p>看下BaseObservingDecorationNode.cs的核心代码设计:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">TCommonGraph</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> BaseObservingDecorationNode.cs</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 可被观察条件打断的装饰节点基类</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Serializable</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title">BaseObservingDecorationNode</span> : <span class="title">BaseDecorationNode</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 打断类型</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        [<span class="meta">Header(<span class="string">&quot;打断类型&quot;</span>)</span>]</span><br><span class="line">        <span class="keyword">public</span> AbortType AbortType;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 是否正在观察</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">protected</span> <span class="built_in">bool</span> mIsObserving;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 响应开始</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">DoStart</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">base</span>.DoStart();</span><br><span class="line">            <span class="keyword">if</span> (AbortType != AbortType.NONE)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span>(!mIsObserving)</span><br><span class="line">                &#123;</span><br><span class="line">                    mIsObserving = <span class="literal">true</span>;</span><br><span class="line">                    StartObserving();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(!IsConditionMet())</span><br><span class="line">            &#123;</span><br><span class="line">                Stop(<span class="literal">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                DecorateNode.Start();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 响应终止</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">DoAbort</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">base</span>.DoAbort();</span><br><span class="line">            DecorateNode.Abort();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 响应子节点停止</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;child&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;success&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">DoChildStop</span>(<span class="params">BaseNode child, <span class="built_in">bool</span> success</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">base</span>.DoChildStop(child, success);</span><br><span class="line">            <span class="keyword">if</span>(AbortType == AbortType.NONE || AbortType == AbortType.SELF)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span>(mIsObserving)</span><br><span class="line">                &#123;</span><br><span class="line">                    mIsObserving = <span class="literal">false</span>;</span><br><span class="line">                    StopObserving();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            Stop(success);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 响应父组合节点停止</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;parentNode&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">DoParentCompositeStop</span>(<span class="params">BaseCompositionNode parentNode</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">base</span>.DoParentCompositeStop(parentNode);</span><br><span class="line">            <span class="keyword">if</span>(mIsObserving)</span><br><span class="line">            &#123;</span><br><span class="line">                mIsObserving = <span class="literal">false</span>;</span><br><span class="line">                StopObserving();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 评估条件流程</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">Evaluate</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            ******</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 开始条件监听流程</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">StartObserving</span>()</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 停止条件监听观察</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">StopObserving</span>()</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 条件是否满足</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="built_in">bool</span> <span class="title">IsConditionMet</span>()</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>事件驱动行为树打断设计：</p>
<ul>
<li><p><strong>事件驱动行为树打断是设计在修饰节点</strong></p>
</li>
<li><p><strong>修饰节点BaseObservingDecorationNode:DoStart()时根据打断类型配置决定是否开启条件监听(打断类型不为NONE就要开启条件监听)</strong></p>
</li>
<li><p><strong>子节点执行完成后BaseObservingDecorationNode:DoChildStop()里根据打断类型决定是否停止条件监听(只有打断类型为NONE或SELF时停止条件监听)</strong></p>
</li>
<li><p><strong>修饰节点在上层父复合节点执行完成后进入BaseObservingDecorationNode:DoParentCompositeStop()决定是否停止监听(无论什么打断类型此刻都要停止条件监听)</strong></p>
</li>
<li><p><strong>没有停止条件监听的装饰节点即使节点逻辑执行完毕也会根据打断类型和条件监听被后续通知进行打断或激活执行，具体条件变化如何打断根据打断类型而定(BaseObservingDecorationNode:Evaluate)</strong></p>
</li>
</ul>
<p>接下来结合BaseConditionDecorationNode.cs和BaseCompareShareNode.cs来理解<strong>条件监听</strong>和<strong>黑板数据监听</strong>是如何实现统一的打断流程的。</p>
<p><strong>BaseConditionDecorationNode.cs(条件监听父类)</strong></p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> BaseConditionDecorationNode.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 可打断定时检查条件修饰节点基类</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">Serializable</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title">BaseConditionDecorationNode</span> : <span class="title">BaseObservingDecorationNode</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 条件检查时间间隔(秒)</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;条件检查时间间隔(秒)&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">float</span> CheckInterval = <span class="number">0f</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 条件检查时间随机参考值(-0.5* -- 0.5*)</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;条件检查时间随机参考值&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">float</span> CheckVariance = <span class="number">0f</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 开始条件监听</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">StartObserving</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mOwnerTreeData.Clock.AddTimer(CheckInterval, CheckVariance, <span class="number">-1</span>, Evaluate);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 停止条件监听</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">StopObserving</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mOwnerTreeData.Clock.RemoveTimer(Evaluate);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 条件是否满足</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="built_in">bool</span> <span class="title">IsConditionMet</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> ConditionCheck();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 条件检查(子类重写)</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="built_in">bool</span> <span class="title">ConditionCheck</span>()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从上面代码可以看到，<strong>BaseConditionDecorationNode.cs通过在StartObserving()里实现可配置间隔时长的定时器，将条件评估(BaseObservingDecorationNode.Evaluate())逻辑实现了定期执行。然后抽象BaseConditionDecorationNode:onditionCheck()接口让子类只关心条件逻辑的编写，真正的打断核心逻辑设计依然在BaseObservingDecorationNode.Evaluate()里。</strong></p>
<p><strong>BaseCompareShareNode.cs(黑板数据监听父类)</strong></p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> BaseCompareShareNode.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 比较黑板数据基类</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title">BaseCompareShareNode</span> : <span class="title">BaseObservingDecorationNode</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 比较类型</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;比较类型&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> OperatorType OperatorType = OperatorType.IS_EQUAL;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 比较变量名</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;比较变量名&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> VariableName = <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 开始监听</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">StartObserving</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mOwnerTreeData.Blackboard.AddObserver(VariableName, OnValueChanged);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 停止监听</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">StopObserving</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mOwnerTreeData.Blackboard.RemoveObserver(VariableName, OnValueChanged);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 响应黑板监听变量名值变化</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;operationType&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;newValue&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnValueChanged</span>(<span class="params">Blackboard.BBOperationType operationType, <span class="built_in">object</span> newValue</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Evaluate();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 条件是否满足</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="built_in">bool</span> <span class="title">IsConditionMet</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (OperatorType == OperatorType.ALWAYS_TRUE)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!mOwnerTreeData.Blackboard.ExistData(VariableName))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> OperatorType == OperatorType.IS_NOT_SET;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (OperatorType)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">case</span> OperatorType.IS_SET:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">case</span> OperatorType.IS_EQUAL:</span><br><span class="line">                <span class="keyword">return</span> IsValueEqual();</span><br><span class="line">            <span class="keyword">case</span> OperatorType.IS_NOT_EQUAL:</span><br><span class="line">                <span class="keyword">return</span> !IsValueEqual();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> OperatorType.IS_GREATER_OR_EQUAL:</span><br><span class="line">                <span class="keyword">return</span> IsValueEqual() || IsValueGreater();</span><br><span class="line">            <span class="keyword">case</span> OperatorType.IS_GREATER:</span><br><span class="line">                <span class="keyword">return</span> IsValueGreater();</span><br><span class="line">            <span class="keyword">case</span> OperatorType.IS_SMALLER_OR_EQUAL:</span><br><span class="line">                <span class="keyword">return</span> IsValueEqual() || !IsValueGreater();</span><br><span class="line">            <span class="keyword">case</span> OperatorType.IS_SMALLER:</span><br><span class="line">                <span class="keyword">return</span> !IsValueEqual() &amp;&amp; !IsValueGreater();</span><br><span class="line">            <span class="literal">default</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 值是否相等</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="built_in">bool</span> <span class="title">IsValueEqual</span>()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 值是否大于</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="built_in">bool</span> <span class="title">IsValueGreater</span>()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 字符串表达</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="built_in">string</span> <span class="title">ToString</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">$&quot;OperatorType:<span class="subst">&#123;OperatorType&#125;</span>,VariableName:<span class="subst">&#123;VariableName&#125;</span>&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>从上面代码可以看到，BaseCompareShareNode.cs通过在StartObserving()里实现对黑板特定黑板变量数据的监听，实现对特定黑板变量数据时变化通知。在监听黑板数据变化时调用Evaluate()实现对监听黑板数据进行再次条件评估，从而实现监听特定黑板变量数据的条件变化重新判定逻辑，最终实现黑板数据变量变化监听的条件打断流程。而针对不同数据结构类型(e.g. int, bool, string, float……)等数据结构的比较逻辑，BaseCompareShareNode.cs抽象了IsValueEqual和IsValueGreater接口，子类比如CompareShareBoolNode.cs,CompareShareIntNode.cs等都只需实现此接口即可实现对应数据类型的黑板变量比较逻辑。</strong></p>
<p>理解了条件监听和黑板数据监听的核心设计，接下来让我们看看不同打断类型的核心设计是如何实现不同打断类型的逻辑执行的。</p>
<p>不同打断类型的核心逻辑设计在BaseObservingDecorationNode:Evaluate()里。</p>
<p>BaseObservingDecorationNode.cs</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> BaseObservingDecorationNode.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 可被观察条件打断的装饰节点基类</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">Serializable</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title">BaseObservingDecorationNode</span> : <span class="title">BaseDecorationNode</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 打断类型</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;打断类型&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> AbortType AbortType;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 是否正在观察</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">protected</span> <span class="built_in">bool</span> mIsObserving;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 响应开始</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">DoStart</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">base</span>.DoStart();</span><br><span class="line">        <span class="keyword">if</span> (AbortType != AbortType.NONE)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(!mIsObserving)</span><br><span class="line">            &#123;</span><br><span class="line">                mIsObserving = <span class="literal">true</span>;</span><br><span class="line">                StartObserving();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(!IsConditionMet())</span><br><span class="line">        &#123;</span><br><span class="line">            Stop(<span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            DecorateNode.Start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 响应终止</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">DoAbort</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">base</span>.DoAbort();</span><br><span class="line">        DecorateNode.Abort();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 响应子节点停止</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;child&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;success&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">DoChildStop</span>(<span class="params">BaseNode child, <span class="built_in">bool</span> success</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">base</span>.DoChildStop(child, success);</span><br><span class="line">        <span class="keyword">if</span>(AbortType == AbortType.NONE || AbortType == AbortType.SELF)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(mIsObserving)</span><br><span class="line">            &#123;</span><br><span class="line">                mIsObserving = <span class="literal">false</span>;</span><br><span class="line">                StopObserving();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        Stop(success);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 响应父组合节点停止</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;parentNode&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">DoParentCompositeStop</span>(<span class="params">BaseCompositionNode parentNode</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">base</span>.DoParentCompositeStop(parentNode);</span><br><span class="line">        <span class="keyword">if</span>(mIsObserving)</span><br><span class="line">        &#123;</span><br><span class="line">            mIsObserving = <span class="literal">false</span>;</span><br><span class="line">            StopObserving();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 评估条件流程</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">Evaluate</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(IsRunning &amp;&amp; !IsConditionMet())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(AbortType == AbortType.SELF ||</span><br><span class="line">               AbortType == AbortType.BOTH ||</span><br><span class="line">               AbortType == AbortType.IMMEDIATE_RESTART)</span><br><span class="line">            &#123;</span><br><span class="line">                Abort();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(!IsRunning &amp;&amp; IsConditionMet())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(AbortType == AbortType.LOWER_PRIORITY ||</span><br><span class="line">               AbortType == AbortType.BOTH ||</span><br><span class="line">               AbortType == AbortType.IMMEDIATE_RESTART ||</span><br><span class="line">               AbortType == AbortType.LOWER_PRIORITY_IMMEDIATE_RESTART)</span><br><span class="line">            &#123;</span><br><span class="line">                BaseParentNode parentNode = ParentNode;</span><br><span class="line">                BaseNode childNode = <span class="keyword">this</span>;</span><br><span class="line">                <span class="keyword">while</span>(parentNode != <span class="literal">null</span> &amp;&amp; !(parentNode <span class="keyword">is</span> BaseCompositionNode))</span><br><span class="line">                &#123;</span><br><span class="line">                    childNode = parentNode;</span><br><span class="line">                    parentNode = parentNode.ParentNode;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span>(parentNode <span class="keyword">is</span> ParalNode)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">if</span>(AbortType != AbortType.NONE &amp;&amp; AbortType != AbortType.IMMEDIATE_RESTART)</span><br><span class="line">                    &#123;</span><br><span class="line">                        Debug.LogError(<span class="string">$&quot;ParalNode的所有子节点优先级一致，不支持配置AbortType.Node和AbortType.IMMEDIATE_RESTART以外打断类型,请检查配置！&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">var</span> isImmediateRestart = AbortType == AbortType.IMMEDIATE_RESTART || AbortType == AbortType.LOWER_PRIORITY_IMMEDIATE_RESTART;</span><br><span class="line">                <span class="keyword">var</span> parentCompositionNode = parentNode <span class="keyword">as</span> BaseCompositionNode;</span><br><span class="line">                parentCompositionNode?.StopLowerPriorityChildrenForChild(childNode, isImmediateRestart);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在了解详细的打断流程设计前，先了解下打断类型设计。</p>
<p>事件驱动行为树打断支持了以下类型:</p>
<ul>
<li><strong>Stops.NONE</strong>：装饰器只会在启动时检查一次它的状态，并且永远不会停止任何正在运行的节点。</li>
<li><strong>Stops.SELF</strong>：装饰器将在启动时检查一次它的条件状态，如果满足，它将继续观察黑板的变化。一旦不再满足该条件，它将终止自身，并让父组合继续处理它的下一个节点。</li>
<li><strong>Stops.LOWER_PRIORITY</strong>：装饰器将在启动时检查它的状态，如果不满足，它将观察黑板的变化。一旦条件满足，它将停止比此结点优先级较低的节点，允许父组合继续处理下一个节点</li>
<li><strong>Stops.BOTH</strong>：装饰器将同时停止:self和优先级较低的节点。</li>
<li><strong>Stops.LOWER_PRIORITY_IMMEDIATE_RESTART</strong>：一旦启动，装饰器将检查它的状态，如果不满足，它将观察黑板的变化。一旦条件满足，它将停止优先级较低的节点，并命令父组合立即重启此装饰器。</li>
<li><strong>Stops.IMMEDIATE_RESTART</strong>：一旦启动，装饰器将检查它的状态，如果不满足，它将观察黑板的变化。一旦条件满足，它将停止优先级较低的节点，并命令父组合立即重启装饰器。正如在这两种情况下，一旦不再满足条件，它也将停止自己。</li>
</ul>
<p><strong>装饰节点常规执行流程设计：</strong></p>
<ol>
<li>在装饰节点开始执行时DoStart()，如果打断类型不为None，节点就会开启条件监听。</li>
<li>如果条件不满足，此装饰节点会直接Stop(false)将此节点停止执行，反之开始执行修饰节点的子节点。</li>
<li>如果装饰节点一开始条件满足，则会触发装饰节点的子节点执行(Start和DoStart)，</li>
</ol>
<p><strong>装饰节点核心打断流程设计：</strong></p>
<ol>
<li><p><strong>装饰节点开始执行，装饰节点未配置打断类型，不开启条件监听，条件满足则执行子节点，条件不满足则直接Stop(false)</strong></p>
</li>
<li><p><strong>装饰节点开始执行，装饰节点配置了打断类型，开启条件监听，一开始不满足条件</strong></p>
<ul>
<li>不满足条件直接Stop(false)，通知父节点(复合节点或修饰节点)执行DoChildStop()，如果父节点是修饰节点则会继续调用此节点的Stop(false)直到找到第一个复合父节点调用OnChildStop()，复合节点根据自身类型和子节点执行结果决定是否Stop()还是继续执行其他子节点，如果第一个复合父节点选择Stop()，则会通知其子节点，复合父节点执行结束调用子节点的ParentCompositeStop()方法，如果子节点是修饰节点则会触发修饰节点的ParentCompositeStop()方法，此时会执行修饰节点的DoParentCompositeStop()和子节点的ParentCompositeStop()，<strong>修饰节点的DoParentCompositeStop()则触发停止条件监听</strong>，子节点的ParentCompositeStop()是为了确保子节点如果依然是修饰节点时把对应条件监听也取消掉。</li>
<li><strong>执行过程中第一个复合父节点一直未执行结束，此时监听的条件由不满足变到满足</strong>，找到第一个父复合节点通知该复合节点执行StopLowerPriorityChildrenForChild(<strong>非SELF打断类型</strong>)，<strong>复合节点根据修饰节点所在分支的对应子节点+修饰节点的打断类型决定是从此修饰节点的所在分支子节点重新开始执行还是打断比修饰节点的所在分支子节点优先级低的节点执行第一个父复合节点后续的节点逻辑(正在执行的子节点会调用Abort进行打断)。</strong></li>
</ul>
 <figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 停止比指定子节点优先级低的节点，并决定是否重新开启组合节点</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;child&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;immediateRestart&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">StopLowerPriorityChildrenForChild</span>(<span class="params">BaseNode child, <span class="built_in">bool</span> immediateRestart</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">int</span> indexForChild = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">bool</span> found = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">foreach</span> (BaseNode currentChild <span class="keyword">in</span> mChildNodeList)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (currentChild == child)</span><br><span class="line">        &#123;</span><br><span class="line">            found = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (!found)</span><br><span class="line">        &#123;</span><br><span class="line">            indexForChild++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (found &amp;&amp; currentChild.IsRunning)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (immediateRestart)</span><br><span class="line">            &#123;</span><br><span class="line">                mCurrentIndex = indexForChild - <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                mCurrentIndex = ChildNodeCount;</span><br><span class="line">            &#125;</span><br><span class="line">            currentChild.Abort();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>装饰节点开始执行，装饰节点配置了打断类型，开启条件监听，一开始满足条件</strong></p>
<ul>
<li>满足条件开始执行子节点Start，子节点执行完毕后通知修饰节点执行DoChildStop()，此时修饰节点会根据根据打断类型决定是否要停止条件监听(<strong>此时如果打断类型是SELF，因为已经满足执行过了，不需要再考虑监听打断，所以就需要停止条件监听</strong>)。</li>
<li><strong>修饰节点子节点持续执行，修饰节点条件定时检查(BaseConditionDecorationNode.cs)和黑板数据监听检查(BaseCompareShareNode.cs)触发定时条件评估(BaseObservingDecorationNode:Evaluate())</strong></li>
<li>如果修饰节点运行中条件由满足变到不满足，此时打断类型SELF，BOTH，IMMEDIATE_RESTART都需要将正在执行的修饰节点打断执行，执行修饰节点的Abort，修饰节点通知其子节点Abort，子节点Abort时通知父修饰节点执行DoChildStop从而实现修饰节点的打断后正确结束Stop流程，<strong>修饰节点此时如果打断类型不是NONE和SELF，则不会停止条件监听，直到第一个父复合节点执行结束时通知修饰节点DoParentCompositeStop才停止条件监听</strong>。</li>
</ul>
</li>
</ol>
<p>Note:</p>
<ol>
<li><strong>事件驱动行为树的打断是支持在装饰节点上的</strong></li>
<li><strong>修饰节点的监听和打断流程核心逻辑在BaseObservingDecorationNode.cs</strong></li>
<li><strong>条件监听(基于定时器)和黑板数据监听(基于定时器+监听者模式)</strong></li>
<li><strong>装饰节点的子节点必须编写DoAbort方法流程，不然其子节点运行时无法因为打断而正确Stop</strong></li>
<li><strong>装饰节点条件从一开始满足的开始条件监听到条件监听取消，核心是由子节点是否执行完成和第一个复合节点执行是否完成决定</strong></li>
<li><strong>装饰节点条件从一开始不满足的开始条件监听到条件监听取消，核心是由装饰节点的第一个父复合节点执行是否完成决定</strong></li>
<li><strong>装饰节点连接的子节点都应该编写DoAbort接口，用于支持装饰节点的相关打断执行逻辑</strong></li>
<li><strong>不同的复合节点的打断处理方式不一样，具体参考代码设计</strong></li>
<li><strong>ParalNode的所有子节点优先级一致，不支持配置AbortType.Node和AbortType.IMMEDIATE_RESTART以外打断类型</strong></li>
<li><strong>所有节点逻辑(e.g 行为节点……)都要基于定时器驱动</strong></li>
</ol>
<h4 id="事件驱动行为树打断单元测试"><a href="#事件驱动行为树打断单元测试" class="headerlink" title="事件驱动行为树打断单元测试"></a>事件驱动行为树打断单元测试</h4><p>这里主要i针对不同打断类型，编写单元测试，验证不同的打断类型的执行逻辑是否正确。</p>
<h5 id="Stops-NONE"><a href="#Stops-NONE" class="headerlink" title="Stops.NONE"></a>Stops.NONE</h5><p><strong>装饰器只会在启动时检查一次它的状态，并且永远不会停止任何正在运行的节点。</strong></p>
<p>测试结果截图:</p>
<p><img src="/img/AI/EventBehaviourTree/RootNodeRunningOnceSetting.PNG" alt="RootNodeRunningOnceSetting"></p>
<p><img src="/img/AI/EventBehaviourTree/BlackBoardStopNone.PNG" alt="BlackBoardStopNone"></p>
<p><img src="/img/AI/EventBehaviourTree/StopNoneBlackBoardInspector.PNG" alt="StopNoneBlackBoardInspector"></p>
<p>上图不清晰，这里我描述下我的行为树设计。</p>
<p>Root-&gt;Selector</p>
<p>​	Selector-&gt;CompareShareFloatNode(打断方式为None)(比较ShareFloat&lt;&#x3D;30)</p>
<p>​		CompareShareFloatNode-&gt;SequenceNode</p>
<p>​			SequenceNode-&gt;LogNode(打印”输出开始执行ShareFloat小于等于30Log”)</p>
<p>​			SequenceNode-&gt;SetShareFloat(设置ShareFloat到100)</p>
<p>​			SequenceNode-&gt;LogNode(打印”输出修改ShareFloat到100完成Log”)</p>
<p>​			SequenceNode-&gt;WaitTimeNode(等待5秒)</p>
<p>​			SequenceNode-&gt;LogNode(打印”输出执行ShareFloat小于等于30完成Log”)</p>
<p><strong>从上面可以看到当执行到设置ShareFloat到100的节点时，第一个CompareShareFloatNode(打断方式为None)(比较ShareFloat&lt;&#x3D;30)的修饰节点并没有被打断而是将SequenceNode完美执行完成，这也就是符合StopNone的不打断设计。</strong></p>
<p>Note:</p>
<ol>
<li><strong>黑板比较数据，只要不是勾选的存在和不存在，那么比较时如果黑板没有设置过基础黑板变量值，那么统一返回失败！</strong></li>
<li><strong>因为为了展示打断机制，所以RootNode根节点勾选了只执行一次的设置</strong></li>
</ol>
<h5 id="Stops-SELF"><a href="#Stops-SELF" class="headerlink" title="Stops.SELF"></a>Stops.SELF</h5><p><strong>装饰器将在启动时检查一次它的条件状态，如果满足，它将继续观察黑板的变化。一旦不再满足该条件，它将终止自身，并让父组合继续处理它的下一个节点。</strong></p>
<p>测试结果截图:</p>
<p><img src="/img/AI/EventBehaviourTree/BlackBoardStopSelf.PNG" alt="BlackBoardStopSelf"></p>
<p><strong>从上图结果可以看到，执行SetShareFloatNode(设置ShareFloat值到100时)后，因为CompareShareFloatNode(比较ShareFloat&lt;&#x3D;30)修饰节点从条件满足变成了条件不满足，同时因为设置的StopSelf打断策略，所以在WaitTimeNode(等待5秒的过程中)，WaitTimeNode直接被打断，让SelectorNode直接执行了第二分支的LogNode打印节点，这也正符合StopSelf的打断策略设计。</strong></p>
<h5 id="Stops-LOWER-PRIORITY"><a href="#Stops-LOWER-PRIORITY" class="headerlink" title="Stops.LOWER_PRIORITY"></a>Stops.LOWER_PRIORITY</h5><p><strong>装饰器将在启动时检查它的状态，如果不满足，它将观察黑板的变化。一旦条件满足，它将停止比此结点优先级较低的节点，允许父组合继续处理下一个节点</strong></p>
<p>测试结果截图:</p>
<p><img src="/img/EventBehaviourTree/BlackBoardStopLowerPriority.PNG" alt="BlackBoardStopLowerPriority"></p>
<p><strong>可以看到第一个CompareShareFloatNode(比较ShareFloat&gt;&#x3D;30，设置打断为LowerPriority)，因为不满足条件所以一开始没有执行，执行到SetShareFloatNode(设置ShareFloat值到100)节点后，WaitTimeNode被打断执行，第二个SelectorNode直接被打断执行，然后第一个SelectorNode直接执行了第一个SelectorNode的第二分支的LogNode节点，这也完美符合了修饰节点LowerPriority从不满足到满足的时候，打断比如LowerPriority低的节点的父组合节点执行，让更上层父节点执行下一个节点的设计。</strong></p>
<h5 id="Stops-BOTH"><a href="#Stops-BOTH" class="headerlink" title="Stops.BOTH"></a>Stops.BOTH</h5><p><strong>装饰器将同时停止:self和优先级较低的节点。</strong></p>
<p>测试结果截图:</p>
<p><img src="/img/AI/EventBehaviourTree/BlackBoardStopBoth.PNG" alt="BlackBoardStopBoth"></p>
<p><strong>通过将第一个CompareShareFloatNode(设置成比较ShareFloat&lt;&#x3D;30且Both打断类型)，我们在后续SequenceNode将ShareFloat设置成100让条件从满足到不满足，从而打断CompareShareFloatNode执行，让第二个SelectorNode接着第二条分支执行，但第二个SelectorNode的第二条分支我又通过将ShareFloat设置成0让CompareShareFloatNode从不满足到满足，从而直接打断第二个SelectorNode的执行，直接进入第二个SelectorNode的第二分支执行打印出最终Log。可以看出这个测试用例完美符合了Both既满足SELF又满足LowerPriority的两个打断机制设计。</strong></p>
<h5 id="Stops-LOWER-PRIORITY-IMMEDIATE-RESTART"><a href="#Stops-LOWER-PRIORITY-IMMEDIATE-RESTART" class="headerlink" title="Stops.LOWER_PRIORITY_IMMEDIATE_RESTART"></a>Stops.LOWER_PRIORITY_IMMEDIATE_RESTART</h5><p><strong>一旦启动，装饰器将检查它的状态，如果不满足，它将观察黑板的变化。一旦条件满足，它将停止优先级较低的节点，并命令父组合立即重启此装饰器。</strong></p>
<p>测试结果截图:</p>
<p><img src="/img/AI/EventBehaviourTree/BlackBoardStopLowerPriorityImmediateRestart.PNG" alt="BlackBoardStopLowerPriorityImmediateRestart"></p>
<p><strong>可以看到SelectorNode的第一个分支的CompareShareFloatNode(设置成比较ShareFloat&gt;&#x3D;30且LowerPriorityImmediateRestart打断类型)，所以一开始就不满足，所以会直接进入SelectorNode的第二个分支，第二个分支里SetShareFloatNode将ShareFloat设置成100，此时第一分支的CompareShareFloatNode从不满足条件到满足条件，因为是LowerPriorityImmediateRestart打断类型的缘故，打断了SelectorNode第二分支的执行，直接重启了SelectorNode第一分支的执行。可以看出这个测试用例完美符合了LowerPriorityImmediateRestart的条件从不满足到满足时打断低优先级分支且从其当前修饰节点所在组合节点的分支设计。</strong></p>
<h5 id="Stops-IMMEDIATE-RESTART"><a href="#Stops-IMMEDIATE-RESTART" class="headerlink" title="Stops.IMMEDIATE_RESTART"></a>Stops.IMMEDIATE_RESTART</h5><p><strong>一旦启动，装饰器将检查它的状态，如果不满足，它将观察黑板的变化。一旦条件满足，它将停止优先级较低的节点，并命令父组合立即重启装饰器。正如在这两种情况下，一旦不再满足条件，它也将停止自己。</strong></p>
<p>测试结果截图:</p>
<p><img src="/img/AI/EventBehaviourTree/BlackBoardStopImmediateRestart.PNG" alt="BlackBoardStopImmediateRestart"></p>
<p><strong>这里测试ImmediateRestart打断类型的测试用例比较复杂，这里简单来说就是先让CompareShareFloatNode(ImmediateRestart打断类型)不满足，然后通过运行其他分支将CompareShareFloatNode从不满足到满足(验证ImmediateRestart的打断低优先级并重启的机制)，然后在CompareShareFloatNode后续流程里将ShareFloat设置成10测试CompareShareFloatNode从条件满足到不满足的自我打断机制，然后借助CompareShareFloatNode(比较ShareFloat值为10)来实现SelectorNode的执行完成流程结束单次运行。可以看出这个测试用例完美验证了ImmediateRestart的从不满足到满足的重启和从满足到不满足的自我打断机制，完美符合ImmediateRestart打断策略。</strong></p>
<h3 id="事件驱动行为树暂停"><a href="#事件驱动行为树暂停" class="headerlink" title="事件驱动行为树暂停"></a>事件驱动行为树暂停</h3><p>通过前面的学习，可以知道，事件驱动行为树的执行核心是<strong>定时器(Clock.cs)</strong></p>
<p><strong>所以要想实现单个行为树逻辑的暂停继续功能，我们必须把定时器(Clock.cs)实现成每个行为树(TBehaviourTree.cs)一个定时器(Clock.cs)</strong></p>
<p><strong>NPBehave的Clock采用的是全局唯一的UnityContext，同时他的Clock设计没有支持暂停继续功能。我这里的设计修改算是我自己的一个改进。</strong></p>
<p>目前设计如下：</p>
<ol>
<li><strong>TBehaviourTreeManager负责管理所有的TBehaviourTree添加，删除和更新</strong></li>
<li><strong>为了确保正确的更新(Update)删除TBehaviourTreeManager采用延迟添加和删除TBehaviourTree的方式</strong></li>
<li><strong>TBehaviourTreeManager的Upadte由外部统一调用传递deltaTime</strong></li>
<li><strong>TBehaviourTree和Clock一对一</strong></li>
</ol>
<p>TBehaviourTreeManager.cs</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> TBehaviourTreeManager.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 行为树单例管理类</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TBehaviourTreeManager</span> : <span class="title">SingletonTemplate</span>&lt;<span class="title">TBehaviourTreeManager</span>&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Node:</span></span><br><span class="line">    <span class="comment">// 通过延迟到下一帧Update里添加和删除的方案，确保行为树Update的正确更新逻辑</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 所有有效的行为树列表</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> List&lt;TBehaviourTree&gt; AllBehaviourTreeList</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 等待添加的行为树Map</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> Dictionary&lt;TBehaviourTree, TBehaviourTree&gt; mWaitAddBehaviourTreeMap;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 等待移除的行为树Map</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> Dictionary&lt;TBehaviourTree, TBehaviourTree&gt; mWaitRemoveBehaviourTreeMap;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 是否暂停所有</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">bool</span> IsPauseAll</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ******</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 注册指定行为树对象</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;behaviourTree&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">RegisterTBehaviourTree</span>(<span class="params">TBehaviourTree behaviourTree</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(behaviourTree == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">$&quot;不允许注册空行为树对象，注册失败！&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(IsWaitRemoveBehaviourTree(behaviourTree))</span><br><span class="line">        &#123;</span><br><span class="line">            RemoveWaitRemoveBehaviourTree(behaviourTree);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> AddWaitAddBehaviourTree(behaviourTree);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 取消注册指定行为树对象</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;behaviourTree&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">UnregisterTBehaviourTree</span>(<span class="params">TBehaviourTree behaviourTree</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(behaviourTree == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">$&quot;不允许取消注册空行为树对象，取消注册失败！&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(IsWaitAddBehaviourTree(behaviourTree))</span><br><span class="line">        &#123;</span><br><span class="line">            RemoveWaitAddBehaviourTree(behaviourTree);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> AddWaitRemoveBehaviourTree(behaviourTree);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 暂停所有行为树</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">PauseAll</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        ******</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 继续所有行为树</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ResumeAll</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        ******</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 打断所有行为树</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">AbortAll</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        ******</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 所有行为树定时器更新驱动</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;deltaTime&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Update</span>(<span class="params"><span class="built_in">float</span> deltaTime</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        DoAllWaitRemoveBehaviourTree();</span><br><span class="line">        DoAllWaitAddBehaviourTree();</span><br><span class="line">        UpdateAllBehaviourTree(deltaTime);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 执行移除所有待移除行为树</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">DoAllWaitRemoveBehaviourTree</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">foreach</span>(<span class="keyword">var</span> waitRemoveBehaviourTree <span class="keyword">in</span> mWaitRemoveBehaviourTreeMap)</span><br><span class="line">        &#123;</span><br><span class="line">            RemoveBehaviourTree(waitRemoveBehaviourTree.Key);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 执行所有待添加行为树</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">DoAllWaitAddBehaviourTree</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> waitAddBehaviourTree <span class="keyword">in</span> mWaitAddBehaviourTreeMap)</span><br><span class="line">        &#123;</span><br><span class="line">            AddBehaviourTree(waitAddBehaviourTree.Key);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 更新所有行为树</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;deltaTime&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">UpdateAllBehaviourTree</span>(<span class="params"><span class="built_in">float</span> deltaTime</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(IsPauseAll)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> index = <span class="number">0</span>, length = AllBehaviourTreeList.Count; index &lt; length; index++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> behaviourTree = AllBehaviourTreeList[index];</span><br><span class="line">            behaviourTree?.Update(deltaTime);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 添加行为树</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;behaviourTree&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="built_in">bool</span> <span class="title">AddBehaviourTree</span>(<span class="params">TBehaviourTree behaviourTree</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        ******</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 移除行为树</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;behaviourTree&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="built_in">bool</span> <span class="title">RemoveBehaviourTree</span>(<span class="params">TBehaviourTree behaviourTree</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        ******</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 是否包含指定行为树</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;behaviourTree&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="built_in">bool</span> <span class="title">IsContainBehaviourTree</span>(<span class="params">TBehaviourTree behaviourTree</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> AllBehaviourTreeList.Contains(behaviourTree);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 添加等待添加行为树</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;behaviourTree&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="built_in">bool</span> <span class="title">AddWaitAddBehaviourTree</span>(<span class="params">TBehaviourTree behaviourTree</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        ******</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 移除等待添加行为树</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;behaviourTree&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="built_in">bool</span> <span class="title">RemoveWaitAddBehaviourTree</span>(<span class="params">TBehaviourTree behaviourTree</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        ******</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 是否包含等待添加行为树</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;behaviourTree&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="built_in">bool</span> <span class="title">IsWaitAddBehaviourTree</span>(<span class="params">TBehaviourTree behaviourTree</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> mWaitAddBehaviourTreeMap.ContainsKey(behaviourTree);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 添加等待移除行为树</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;behaviourTree&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="built_in">bool</span> <span class="title">AddWaitRemoveBehaviourTree</span>(<span class="params">TBehaviourTree behaviourTree</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        ******</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 移除等待移除行为树</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;behaviourTree&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="built_in">bool</span> <span class="title">RemoveWaitRemoveBehaviourTree</span>(<span class="params">TBehaviourTree behaviourTree</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        ******</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 是否包含等待移除行为树</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;behaviourTree&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="built_in">bool</span> <span class="title">IsWaitRemoveBehaviourTree</span>(<span class="params">TBehaviourTree behaviourTree</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> mWaitRemoveBehaviourTreeMap.ContainsKey(behaviourTree);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>TBehaviourTree.cs</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> TBehaviourTree.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 行为树类</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TBehaviourTree</span> : <span class="title">IRecycle</span></span><br><span class="line">&#123;</span><br><span class="line">    ******</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 行为树定时器</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> Clock BehaviourTreeClock</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TBehaviourTree</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 初始化</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;bindUID&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Init</span>(<span class="params"><span class="built_in">int</span> bindUID</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        BehaviourTreeClock = <span class="keyword">new</span> Clock();</span><br><span class="line">        UpdateBindUID(bindUID);</span><br><span class="line">        RegisterBehaviourTree();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ******</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 注册行为树</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">RegisterBehaviourTree</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        TBehaviourTreeManager.Singleton.RegisterTBehaviourTree(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 取消注册行为树</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">UnregisterBehaviourTree</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        TBehaviourTreeManager.Singleton.UnregisterTBehaviourTree(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">	******</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 暂停</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Pause</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        BTRunningGraph?.Clock.Disable();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 继续</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Resume</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        BTRunningGraph?.Clock.Enable();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 打断</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Stop</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        BTRunningGraph?.Stop();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 行为树定时器更新驱动</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;deltaTime&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Update</span>(<span class="params"><span class="built_in">float</span> deltaTime</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        BTRunningGraph?.Clock?.Update(deltaTime);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ****</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Clock.cs</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Clock</span></span><br><span class="line">&#123;</span><br><span class="line">    ******</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 是否激活(影响Update)</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">bool</span> IsEnable</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ******</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 激活</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Enable</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        IsEnable = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 不激活</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Disable</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        IsEnable = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ******</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 更新</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;deltaTime&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Update</span>(<span class="params"><span class="built_in">float</span> deltaTime</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (!IsEnable)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">		******</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面代码设计有几个要点：</p>
<ol>
<li><strong>行为树的注册和取消注册我通过添加到待添加和待删除列表里，将真正的删除和添加延迟到下一帧Update里去执行，确保了Update所有行为树时不会出现遍历的同时触发删除添加等导致更新所有行为树报错问题。</strong></li>
<li><strong>行为树的暂停除了TBehaviourTreeManager的总暂停开关，单个行为树的暂停实际上是通过对每个TBehaviourTree的一对一Clock进行暂停实现的</strong></li>
</ol>
<p>AI暂停和继续截图:</p>
<p><img src="/img/AI/EventBehaviourTree/BehaviourTreePause.PNG" alt="BehaviourTreePause"></p>
<p><img src="/img/AI/EventBehaviourTree/BehaviourTreeResume.PNG" alt="BehaviourTreeResume"></p>
<p>Note:</p>
<ol>
<li><strong>这里我暂时没有对TBehavourTree和Clock做对象池优化，算是一个优化点。</strong></li>
</ol>
<h3 id="事件驱动行为树调试"><a href="#事件驱动行为树调试" class="headerlink" title="事件驱动行为树调试"></a>事件驱动行为树调试</h3><p><strong>行为树调试很重要的一点就是要可视化整个行为树执行过程，行为树编辑器已经实现了行为树数据的可视化绘制，那么剩下的工作就是将行为树运行时的一些数据(比如节点运行状态，节点运行结果等)通过编辑器将数据可视化显示。</strong></p>
<p>目前行为树的调试是通过加载AI(BaseActor.LoadAI())时挂在<strong>BTDebugger</strong>脚本来决定选中对象是否支持数据加载显示调试(<strong>为了区分运行时编辑器就没有采用TBehaviourTree作为调试加载依据</strong>)。</p>
<p>行为树窗口<strong>UIBTGraphEditorWindow.cs</strong>结合<strong>OnSelectionChange</strong>实现对选中对象的<strong>BTDebugger</strong>对应的运行时<strong>BehaviourTreeGraphData</strong>进行数据读取构建显示。</p>
<p>关于为树运行时的一些数据(比如节点运行状态，节点运行结果，是否打断等)数据可视化，通过<strong>BTGraphEditorWindow.cs</strong>，<strong>BehaviourTreeGraphView.cs</strong>，<strong>NodeView.cs</strong>和<strong>EdgeView.cs</strong>相关代码进行数据显示：</p>
<p>BTGraphEditorWindow.cs</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> UIBTGraphEditorWindow.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 行为树图窗口类</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UIBTGraphEditorWindow</span> : <span class="title">EditorWindow</span></span><br><span class="line">&#123;</span><br><span class="line">	******</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 响应EditorWindow的Update</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Update</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mGraphView?.Update();</span><br><span class="line">        <span class="comment">// 运行时黑板数据不是通过属性绑定显示的</span></span><br><span class="line">        <span class="comment">// 所以采用通过更新刷新的方式确保黑板UI实时显示</span></span><br><span class="line">        <span class="keyword">if</span>(Application.isPlaying)</span><br><span class="line">        &#123;</span><br><span class="line">            UpdateBlackboardDataUI();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>BehaviourTreeGraphView.cs</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> BehaviourTreeGraphView.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 行为树GraphView</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BehaviourTreeGraphView</span> : <span class="title">GraphView</span></span><br><span class="line">&#123;</span><br><span class="line">    ******</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> EditorWindow那方驱动过来的Update更新</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Update</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        UpdateAllNodeStateView();</span><br><span class="line">        UpdateAllEdgeViewColors();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 更新所有节点状态显示</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">UpdateAllNodeStateView</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (SourceGraphData == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; SourceGraphData.AllNodeList.Count; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> node = SourceGraphData.AllNodeList[i];</span><br><span class="line">            <span class="keyword">var</span> nodeView = GetNodeByGuid(node.GUID) <span class="keyword">as</span> NodeView;</span><br><span class="line">            nodeView?.UpdateNodeStateBackgroundColor();</span><br><span class="line">            nodeView?.UpdateNodeStateLabel();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 更新所有显示边颜色</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">UpdateAllEdgeViewColors</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (SourceGraphData == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; SourceGraphData.AllEdgeDataList.Count; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> edge = SourceGraphData.AllEdgeDataList[i];</span><br><span class="line">            <span class="keyword">var</span> edgeView = GetEdgeByGuid(edge.GUID) <span class="keyword">as</span> EdgeView;</span><br><span class="line">            edgeView?.UpdateEdgeControlStateColor();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>NodeView.cs</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> NodeView.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 节点显示抽象</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">NodeView</span> : <span class="title">Node</span></span><br><span class="line">&#123;</span><br><span class="line">    ******</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 创建节点状态UI</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">CreateNodeStateUI</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        ******</span><br><span class="line">        UpdateNodeStateBackgroundColor();</span><br><span class="line">        UpdateNodeStateLabel();</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">    ******</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 更新节点状态背景颜色</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">UpdateNodeStateBackgroundColor</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> nodeStateHorizontalUIContainer = <span class="keyword">this</span>.Q&lt;VisualElement&gt;(BTGraphElementNames.NodeStateUIHorizontalContainerName);</span><br><span class="line">        <span class="keyword">if</span>(nodeStateHorizontalUIContainer != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            nodeStateHorizontalUIContainer.style.backgroundColor = BTGraphUtilitiesEditor.GetColorByNodeState(NodeData.NodeState);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 更新节点状态Label</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">UpdateNodeStateLabel</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> nodeStateLabel = <span class="keyword">this</span>.Q&lt;Label&gt;(BTGraphElementNames.NodeStateLabelName);</span><br><span class="line">        <span class="keyword">if</span> (nodeStateLabel != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> stateDes = NodeData.NodeState.ToString();</span><br><span class="line">            <span class="keyword">if</span>(NodeData.IsEnteredAbort)</span><br><span class="line">            &#123;</span><br><span class="line">                stateDes = <span class="string">$&quot;<span class="subst">&#123;stateDes&#125;</span>(打断)&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            nodeStateLabel.text = stateDes;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>EdgeView.cs</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> EdgeView.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 显示边基类</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">EdgeView</span> : <span class="title">Edge</span></span><br><span class="line">&#123;</span><br><span class="line">	******</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 创建显示边</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;edgeData&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;inputPort&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;outputPort&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> EdgeView <span class="title">CreateEdgeView</span>(<span class="params">EdgeData edgeData, Port inputPort, Port outputPort</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> edgeView = <span class="keyword">new</span> EdgeView()</span><br><span class="line">        &#123;</span><br><span class="line">            input = inputPort,</span><br><span class="line">            output = outputPort,</span><br><span class="line">        &#125;;</span><br><span class="line">        edgeView.Init(SourceGraphData, edgeData);</span><br><span class="line">        edgeView.UpdateEdgeControlStateColor();</span><br><span class="line">        <span class="keyword">return</span> edgeView;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ******</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 更新显示边线状态颜色</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">UpdateEdgeControlStateColor</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> edgeInputNode = OwnerGraphData.GetNodeByGUID(EdgeData.InputNodeGUID);</span><br><span class="line">        <span class="keyword">var</span> edgeInputColor = BTGraphUtilitiesEditor.GetEdgeColorByNodeState(edgeInputNode.NodeState);</span><br><span class="line">        <span class="keyword">var</span> edgeOutputColor = BTGraphUtilitiesEditor.GetEdgeColorByNodeState(edgeInputNode.NodeState);</span><br><span class="line">        edgeControl.inputColor = edgeInputColor;</span><br><span class="line">        edgeControl.outputColor = edgeOutputColor;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>BTGraphUtilitiesEditor.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> BTGraphUtilitiesEditor.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 行为树节点编辑器工具类</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">BTGraphUtilitiesEditor</span></span><br><span class="line">&#123;</span><br><span class="line">	******</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 节点状态和颜色背景Map</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">readonly</span> Dictionary&lt;NodeState, Color&gt; NodeStateColorMap = <span class="keyword">new</span> Dictionary&lt;NodeState, Color&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        &#123;NodeState.Suspend, Color.grey&#125;,</span><br><span class="line">        &#123;NodeState.Running, Color.yellow&#125;,</span><br><span class="line">        &#123;NodeState.Abort, Color.magenta&#125;,</span><br><span class="line">        &#123;NodeState.Success, Color.green&#125;,</span><br><span class="line">        &#123;NodeState.Failed, Color.red&#125;,</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    ******</span><br><span class="line"> </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 获取指定节点类型的背景颜色</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;nodeState&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Color <span class="title">GetColorByNodeState</span>(<span class="params">NodeState nodeState</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Color nodeStateColor;</span><br><span class="line">        <span class="keyword">if</span> (NodeStateColorMap.TryGetValue(nodeState, <span class="keyword">out</span> nodeStateColor))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> nodeStateColor;</span><br><span class="line">        &#125;</span><br><span class="line">        Debug.LogError(<span class="string">$&quot;未配置节点状态:<span class="subst">&#123;nodeState&#125;</span>的颜色！&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> Color.grey;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 获取指定节点状态类型对应的边颜色</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;nodeState&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Color <span class="title">GetEdgeColorByNodeState</span>(<span class="params">NodeState nodeState</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 未运行完成按照节点状态颜色显示边颜色，运行完成统一显示绿色</span></span><br><span class="line">        <span class="keyword">if</span>(nodeState == NodeState.Suspend || nodeState == NodeState.Running || nodeState == NodeState.Abort)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> GetColorByNodeState(nodeState);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> Color.green;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>从上面的代码可以看到通过EditorWindow的Update驱动BehaviourTreeGraphView.Update去每帧更新一些运行时动态变化的数据显示</strong></p>
<p>Note:</p>
<ol>
<li><strong>编辑器的运行时数据更新显示(e.g 运行节点，边颜色，打断状态等)是通过Update驱动更新的</strong></li>
<li><strong>运行时黑板数据不是通过属性绑定显示的，所以采用通过更新刷新的方式确保黑板UI实时显示</strong></li>
</ol>
<h3 id="事件驱动行为树实战"><a href="#事件驱动行为树实战" class="headerlink" title="事件驱动行为树实战"></a>事件驱动行为树实战</h3><p>TODO</p>
<h3 id="未来计划"><a href="#未来计划" class="headerlink" title="未来计划"></a>未来计划</h3><ol>
<li><strong>支持行为树引用方式的重用而非复制的方式(这种方式修改原树已经复制的树数据无法跟着变化导致重用性效率大打折扣)</strong></li>
</ol>
<h2 id="个人心得"><a href="#个人心得" class="headerlink" title="个人心得"></a>个人心得</h2><ol>
<li><strong>事件驱动行为树相比传统行为树最大的优势就是树更新的开销，前者基于定时器可以做到通知打断+子节点通知父节点运行结果的单向执行(不用每帧从根节点开始)，后者是每次都从根节点开始的遍历执行，后者每帧都会从根节点再走一遍流程到之前的节点继续运行(同时打断设计不好设计成基于定时器减少更新频率)</strong></li>
<li><strong>UIElement的GraphView把逻辑节点(Node)和边(Edge)数据和节点(NodeView)和边(NodeView)显示抽象分离的很好，可以高度自由的编写显示节点(NodeView)和边(EdgeView)</strong></li>
</ol>
<h2 id="GitHub"><a href="#GitHub" class="headerlink" title="GitHub"></a>GitHub</h2><p><a target="_blank" rel="noopener" href="https://github.com/TonyTang1990/EventBehaviourTree">EventBehaviourTree</a></p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p><a target="_blank" rel="noopener" href="https://github.com/meniku/NPBehave/tree/master">NPBehave</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/UIE-uss-properties.html">USS properties reference</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/ScriptReference/UIElements.IStyle.html">IStyle</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/UIE-ElementRef.html">UXML现有可用Element查询</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/UIE-uss-built-in-variable-reference.html">USS built-in variable references</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/UIE-Events-Reference.html">Event Reference</a></p>
<p><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=7KHGH0fPL84">UNITY DIALOGUE GRAPH TUTORIAL - Setup</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/AI/">AI</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/AI/">AI</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2025/03/12/ECS架构/" title="ECS架构" itemprop="url">ECS架构</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Tony Tang" target="_blank" itemprop="author">Tony Tang</a>
		
  <p class="article-time">
    <time datetime="2025-03-11T16:00:00.000Z" itemprop="datePublished"> 发表于 2025-03-12</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>伴随着守望先锋ECS概念的剔除，以及Unity DOTS里ECS的普及，ECS架构设计被广泛运用到了游戏开发行业，本章节核心是想学习ECS设计理念而非Unity DOTS一整套。学习理解ECS设计理念后，编写一套属于自己的简易版ECS用于常规游戏功能开发框架。</p>
<h1 id="ECS"><a href="#ECS" class="headerlink" title="ECS"></a>ECS</h1><p>首先看一下维基百科的基础介绍:</p>
<p><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Entity_component_system"><strong>Entity–component–system</strong> (<strong>ECS</strong>) is a software architectural pattern mostly used in video game development for the representation of game world objects. An ECS comprises <em>entities</em> composed from <em>components</em> of data, with <em>systems</em> which operate on the components. </a></p>
<p><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Entity_component_system">ECS follows the principle of <strong>composition over inheritance</strong>, meaning that every entity is defined not by a type hierarchy, but by the components that are associated with it. Systems act globally over all entities which have the required components.</a></p>
<p>大概翻译一下就是:</p>
<p>ECS是一种用在游戏开发的架构设计模式。ECS由Entity，Component，System组成。Entity由Component组成，Component由数据组成，System负责处理Enity身上的Component数据。</p>
<p>ECS遵循组合大于继承的设计理念，System负责处理所有符合Component要求的Entity逻辑处理。</p>
<p>放一张Unity ECS的一张架构设计示意图:</p>
<p><img src="/img/Programming/ECS/ECSDesignPatternPreview.png" alt="ECSDesignPatternPreview"></p>
<h2 id="Entity"><a href="#Entity" class="headerlink" title="Entity"></a>Entity</h2><p>​	<a target="_blank" rel="noopener" href="https://docs.unity3d.com/Packages/com.unity.entities@1.3/manual/concepts-entities.html">An entity represents something discrete in your program that has its own set of data, such as a character, visual effect, UI element, or even something abstract like a network transaction. However, an entity acts as an ID which associates individual unique components together, rather than containing any code or serving as a container for its associated components.</a></p>
<p>​	大概理解就是Entity是一个有唯一Id标识由Component组成，可以表达任何程序逻辑对象(比如角色，可视化特效，UI，网络等)的一个逻辑对象。</p>
<h2 id="Component"><a href="#Component" class="headerlink" title="Component"></a>Component</h2><p>​	<a target="_blank" rel="noopener" href="https://docs.unity3d.com/Packages/com.unity.entities@1.3/manual/concepts-components.html"><strong>components</strong> contain entity data that systems can read or write.</a></p>
<p>​	大概理解就是Component包含了Entity的数据，然后由System访问和改写。</p>
<h2 id="System"><a href="#System" class="headerlink" title="System"></a>System</h2><p>​	<a target="_blank" rel="noopener" href="https://docs.unity3d.com/Packages/com.unity.entities@1.3/manual/concepts-systems.html">A <strong>system</strong> provides the logic that transforms component data from its current state to its next state.</a></p>
<p>​	大概理解就是System是负责处理Entity的Component数据逻辑的(比如我们的游戏逻辑)。</p>
<h2 id="World"><a href="#World" class="headerlink" title="World"></a>World</h2><p>​	<a target="_blank" rel="noopener" href="https://docs.unity3d.com/Packages/com.unity.entities@1.3/manual/concepts-worlds.html">A <strong>world</strong> is a collection of entities. An entity’s ID number is only unique within its own world.</a></p>
<p>​	大概理解就是World是所有Entity的集合，每个Entity在World都有唯一标识。</p>
<h2 id="ECS设计"><a href="#ECS设计" class="headerlink" title="ECS设计"></a>ECS设计</h2><p>这里引用其他博主的话讲述ECS之间的关系:</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_14914623/article/details/81451002?spm=1001.2101.3001.6650.17&utm_medium=distribute.pc_relevant.none-task-blog-2~default~BlogCommendFromBaidu~Rate-17-81451002-blog-132397770.235%5Ev43%5Epc_blog_bottom_relevance_base6&depth_1-utm_source=distribute.pc_relevant.none-task-blog-2~default~BlogCommendFromBaidu~Rate-17-81451002-blog-132397770.235%5Ev43%5Epc_blog_bottom_relevance_base6&utm_relevant_index=25">实体(Entity)与组件(Component)是一个一对多的关系，实体(Entity)拥有怎样的能力，完全是取决于拥有哪些组件(Component)，通过动态增加或删除组件，可以在（游戏）运行时改变实体的行为。</a></p>
<p><strong>从上面可以看出，通过把Component(数据)和System(逻辑)分离。同时因为System是由Entity的Component驱动是否生效的，所以Entity的行为是由Component决定的，而Component和System都是可以动态增删的，这样一来我们就能快速的把数据和逻辑都重用起来。</strong></p>
<p>了解了ECS的大概设计，接下来让我们结合别人给Lua设计的<a target="_blank" rel="noopener" href="https://github.com/bakpakin/tiny-ecs">tiny-ecs</a>看看ECS在Lua里是如何运作起来的。</p>
<p>Note:</p>
<ol>
<li><strong>Component只存数据不提供方法接口，System只提供逻辑不存数据</strong></li>
</ol>
<h1 id="tiny-ecs"><a href="#tiny-ecs" class="headerlink" title="tiny-ecs"></a>tiny-ecs</h1><p>Github连接<a target="_blank" rel="noopener" href="https://github.com/bakpakin/tiny-ecs">tiny-ecs</a></p>
<p>tiny-ecs代码不多，感兴趣的自行下载了解，这里直接学习tiny-ecs在lua里的设计理念。</p>
<p><strong>tiny-ecs里依然有World，System，Entity的概念，但弱化了Component的概念，Component的概念在tiny-ecs里就是任何数据字段。</strong></p>
<p><strong>tiny-ecs里World依然有N个System+N个Entity组成，System和Entity的添加和移除在World里设计好了固定的生命周期，上层逻辑通过这些固定流程接口可以实现System过滤特定Entity后进行Entity数据访问逻辑编写修改，从而实现游戏逻辑功能。</strong></p>
<ul>
<li><p>World生命周期</p>
<p>tiny.world(创建一个world)(可直接初始化指定System和Entity)</p>
</li>
<li><p>System生命周期</p>
<p>tiny.processingSystem(定义一个System)</p>
<p>tiny.addSystem(添加一个待添加System)</p>
<p>​    tiny.tiny_manageSystems(第二帧处理System添加和移除)</p>
<p>​        - system.onAddToWorld(响应系统被添加到World)</p>
<p>​        - sytem.onAdd(所有符合条件的Entity响应添加)</p>
</li>
</ul>
<p>​			tiny.tiny_manageEntities(第二帧处理System的Entity添加，移除和变化)</p>
<p>​				- system.onRemove(响应系统相关Entity移除)</p>
<p>​				- system.onAdd(响应系统相关Entity添加)</p>
<p>​		tiny.update(World每帧更新)</p>
<p>​			tiny.tiny_manageSystems(处理System添加和移除))</p>
<p>​			tiny.tiny_manageEntities(处理System的Entity添加，移除和变化))</p>
<p>​			tiny.processingSystemUpdate(System更新流程)</p>
<p>​				- system.preProcess(系统每帧预处理)</p>
<p>​				- system.process(系统每帧处理符合条件的entity)</p>
<p>​				- system.postProcess(系统每帧后处理)</p>
<p>​		tiny.removeSystem(添加一个待移除System)</p>
<p>​				- tiny.tiny_manageSystems(第二帧处理System添加和移除)</p>
<p>​			    - system.onRemove(响应系统已添加Entity移除)</p>
<p>​        		- system.onRemoveFromWorld(响应系统被从World移除)</p>
<p>​		Note:</p>
<p>​			1. <strong>上述流程没包含Entity变化相关流程</strong></p>
<ul>
<li><p>Entity生命周期</p>
<p>tiny.addEntity(给World添加个待添加的Entity)</p>
<p>tiny.update(World每帧更新)</p>
<p>​    tiny.tiny_manageEntities(处理System的Entity添加，移除和变化))</p>
</li>
</ul>
<p>​		tiny.removeEntity(给World添加个待移除的Entity)</p>
<p>​		tiny.update(World每帧更新)</p>
<p>​			tiny.tiny_manageEntities(处理System的Entity添加，移除和变化))</p>
<p>从tiny-ecs的源码可以看出，tiny-ecs对于ECS里Component的概念设计相对较弱，更多的是抽象规范出Enitity和System的统一更新和生命周期流程。</p>
<p>对于tiny-ecs而言，Component就是Entity里的任何数据，并没有考虑Component设计上的重用，以及E和C的一对多设计。</p>
<p>设计要点:</p>
<ol>
<li><strong>tiny-ecs里的System和Entity的添加移除都统一到下一帧去处理，这样有效避免了System和Entity在单帧里数量动态变化的访问问题。</strong></li>
</ol>
<p>疑问点：</p>
<ol>
<li><strong>因为System和Entity都是下一帧才处理添加移除，那么System和Entity从逻辑上来说单帧没有立刻添加到World里，假设上一行代码写添加Entity，下一行去获取这个Entity是得不到的，System同理，或许这也是tiny-ecs没有设计直接获取Entity和System接口的原因吧。</strong></li>
<li><strong>tiny-ecs并没有设计获取特定Entity相关的接口，也没有设计获取System的接口，那么在一个System里如果想访问特定Entity对象时，我们并没有方法可以获取到，这种情况应该如何处理了？（个人觉得应该暴露出获取特定符合条件Entity相关的接口）</strong></li>
</ol>
<h1 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h1><p>了解了ECS基础概念和tiny-ecs的核心设计，接下来实战设计一版简易的C# ECS框架，重点要实现以下几个重要概念：</p>
<ol>
<li>实现Entity唯一对象的概念</li>
<li>实现Entity由Component组成的概念</li>
<li>Component的组合决定了Entity有哪些功能</li>
<li>实现Component只定义数据，System负责逻辑处理的概念</li>
<li><strong>实现Entity的添加和移除能从逻辑上同步判定(这个是tiny-esc所不具备的)</strong></li>
<li><strong>实现System支持一个逻辑帧更新的Update接口(这个是tiny-ecs所不具备的)</strong></li>
<li>实现System更新逻辑支持过滤Component类型概念</li>
<li>实现System支持获取特定Component类型的Entity</li>
<li>实现同一个System可以有无数个相同类型的Entity</li>
<li>实现同一个Entity相同类型Component可以有多个</li>
<li>实现同一个World相同类型System只能有一个</li>
<li>实现World对Entity和System的统一添加和删除流程</li>
<li>相同World名字只能同时存在一个</li>
<li>World实现对Enity实体对象挂在父节点的统一</li>
</ol>
<h2 id="Entity设计"><a href="#Entity设计" class="headerlink" title="Entity设计"></a>Entity设计</h2><p>BaseEntity.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> BaseEntity.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Entity基类(逻辑对象抽象，相当于ECS里的E部分)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title">BaseEntity</span> : <span class="title">IRecycle</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Entity Uuid</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> Uuid</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Entity类型信息</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> Type ClassType</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(mClassType == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                mClassType = GetType();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> mClassType;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">protected</span> Type mClassType;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 组件类型和组件列表映射Map</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> Dictionary&lt;Type, List&lt;BaseComponent&gt;&gt; mComponentTypeMap;</span><br><span class="line"></span><br><span class="line">    *******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上述的数据结构定义主要是针对以下几个需求:</p>
<ol>
<li>实现Entity唯一对象的概念(<strong>Uuid</strong>)</li>
<li>实现Entity由Component组成的概念(<strong>mComponentTypeMap</strong>)</li>
<li>实现同一个Entity相同类型Component可以有多个(<strong>mComponentTypeMap</strong>)</li>
</ol>
<p>上面没有展示Component相关的接口，详情直接参考源代码。</p>
<h2 id="Component设计"><a href="#Component设计" class="headerlink" title="Component设计"></a>Component设计</h2><p>BaseComponent.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> ECS裡Component基类抽象</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title">BaseComponent</span> : <span class="title">IRecycle</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BaseComponent</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 出池</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">OnCreate</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 入池</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">OnDispose</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        ResetDatas();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 重置数据(子类重写)</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">ResetDatas</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上述的数据结构定义主要是针对以下几个需求:</p>
<ol>
<li>实现Component只定义数据</li>
</ol>
<p>可以看到BaseComponent唯一的接口就是逻辑对象的出池入池和数据重置接口(ResetDatas)流程，这也正是符合Component只有数据定义的设计。</p>
<h2 id="System设计"><a href="#System设计" class="headerlink" title="System设计"></a>System设计</h2><p>BaseSystem.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span>/ <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> BaseSystem.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 逻辑系统基类抽象(相当于ECS里的S部分)</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title">BaseSystem</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 所属世界</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> BaseWorld OwnerWorld</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 系统类型信息</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> Type ClassType</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(mClassType == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                mClassType = GetType();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> mClassType;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">protected</span> Type mClassType;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 系统系统激活</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">bool</span> Enable</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 系统相关Entity列表</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> List&lt;BaseEntity&gt; SystemEntityList</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BaseSystem</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        SystemEntityList = <span class="keyword">new</span> List&lt;BaseEntity&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 初始化</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;ownerWorld&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Init</span>(<span class="params">BaseWorld ownerWorld</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        OwnerWorld = ownerWorld;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Entity过滤</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;entity&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="built_in">bool</span> <span class="title">Filter</span>(<span class="params">BaseEntity entity</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ******</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 添加所有事件</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">AddEvents</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 响应系统添加到世界</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">OnAddToWorld</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        Debug.Log(<span class="string">$&quot;世界名:<span class="subst">&#123;OwnerWorld.WorldName&#125;</span>的系统类型:<span class="subst">&#123;ClassType.Name&#125;</span>被添加到世界！&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 响应Entity添加</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;entity&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">OnAdd</span>(<span class="params">BaseEntity entity</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 移除所有事件</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">RemoveEvents</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 响应Entity移除</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;entity&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">OnRemove</span>(<span class="params">BaseEntity entity</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 响应系统从世界移除</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">OnRemoveFromWorld</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        Debug.Log(<span class="string">$&quot;世界名:<span class="subst">&#123;OwnerWorld.WorldName&#125;</span>的系统类型:<span class="subst">&#123;ClassType.Name&#125;</span>被从世界移除！&quot;</span>);</span><br><span class="line">        RemoveSystemAllEntity();</span><br><span class="line">        OwnerWorld = <span class="literal">null</span>;</span><br><span class="line">        mClassType = <span class="literal">null</span>;</span><br><span class="line">        Enable = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> PreUpdate</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;deltaTime&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">PreProcess</span>(<span class="params"><span class="built_in">float</span> deltaTime</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Entity Update</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;entity&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;deltaTime&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Process</span>(<span class="params">BaseEntity entity, <span class="built_in">float</span> deltaTime</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> PostUpdate</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;deltaTime&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">PostProcess</span>(<span class="params"><span class="built_in">float</span> deltaTime</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> LogicUpdate</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;logicFrameTime&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">LogicUpdate</span>(<span class="params"><span class="built_in">float</span> logicFrameTime</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> FixedUpdate</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;fixedDeltaTime&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">FixedUpdate</span>(<span class="params"><span class="built_in">float</span> fixedDeltaTime</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> LateUpdate</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;deltaTime&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">LateUpdate</span>(<span class="params"><span class="built_in">float</span> deltaTime</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上述的数据结构定义主要是针对以下几个需求:</p>
<ol>
<li>System负责逻辑处理的概念(<strong>PreProcess，Process，PostProcess，LogicUpdate，FixedUpdate，LateUpdate等接口支持逻辑编写</strong>)</li>
<li>实现System更新逻辑支持过滤Component类型概念(<strong>Filter接口支持了自定义对Entity的过滤</strong>)</li>
<li>实现System支持获取特定Component类型的Entity(<strong>Filter接口支持了自定义对Entity的过滤</strong>)</li>
<li>实现同一个World相同类型System只能有一个(<strong>ClassType和OwnerWorld设计配合BaseWorld实现1对1</strong>)</li>
<li>实现同一个System可以有无数个相同类型的Entity(<strong>SystemEntityList定义支持无数个Entity</strong>)</li>
</ol>
<p><strong>可以看到System定义了Filter接口用于过滤符合条件的Entity才进入Process(BaseEntity entity, float deltaTime)流程，方便System只处理感兴趣的Entity对象。</strong></p>
<p><strong>同时System抽象了和World相关的流程接口(e.g. AddEvents，OnAddToWorld，OnAdd，RemoveEvents，OnRemove，OnRemoveFromWorld)，方便上层编写系统逻辑</strong></p>
<h2 id="World设计"><a href="#World设计" class="headerlink" title="World设计"></a>World设计</h2><p>BaseWorld.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> BaseWorld.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 逻辑世界基类抽象(相当于tiny里的World)</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title">BaseWorld</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">#<span class="keyword">region</span> World成员定义部分开始</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 世界名(唯一ID)</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> WorldName</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 世界根节点GameObject</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">protected</span> GameObject mWorldRootGo;</span><br><span class="line">    <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="keyword">region</span> System成员定义部分开始</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 所有系统类型和系统Map<span class="doctag">&lt;系统类型，系统&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">protected</span> Dictionary&lt;Type, BaseSystem&gt; mAllSystemTypeAndSystemMap;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 所有系统列表</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Note:</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 用于确保确定性更新顺序</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">protected</span> List&lt;BaseSystem&gt; mAllSystems;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 等待添加的系统列表</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">protected</span> List&lt;BaseSystem&gt; mWaitAddSystems;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 临时等待添加系统列表</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">protected</span> List&lt;BaseSystem&gt; mTempWaitAddSystems;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 等待移除的系统列表</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">protected</span> List&lt;BaseSystem&gt; mWaitRemoveSystems;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 临时等待移除系统列表</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">protected</span> List&lt;BaseSystem&gt; mTempWaitRemoveSystems;</span><br><span class="line">    <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="keyword">region</span> Entity成员定义开始</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 下一个Entity Uuid</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">protected</span> <span class="built_in">int</span> mNextEntityUuid;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Entity根节点GameObject</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">protected</span> GameObject mEntityRootGo;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Entity类型信息父节点Map</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">protected</span> Dictionary&lt;Type, Transform&gt; mEntityClassTypeParentMap;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Entity Uuid Map<span class="doctag">&lt;Entitiy Uuid, Entity&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">protected</span> Dictionary&lt;<span class="built_in">int</span>, BaseEntity&gt; mEntityMap;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 所有的Entity</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Note:</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 用于确保有序访问</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">protected</span> List&lt;BaseEntity&gt; mAllEntity;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Entity类型信息和Entity列表Map<span class="doctag">&lt;Entity类型信息, Entity列表&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">protected</span> Dictionary&lt;Type, List&lt;BaseEntity&gt;&gt; mEntityTypeAndEntitiesMap;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 等待更新的Entity类型信息和Entity列表Map<span class="doctag">&lt;Entity类型信息，Entity列表&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">protected</span> Dictionary&lt;Type, List&lt;BaseEntity&gt;&gt; mUpadteEntityTypeAndEntitiesMap;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 等待添加的Entity列表</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">protected</span> List&lt;BaseEntity&gt; mWaitAddEntities;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 临时等待添加Entity列表</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">protected</span> List&lt;BaseEntity&gt; mTempWaitAddEntities;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 等待移除的Entity列表</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">protected</span> List&lt;BaseEntity&gt; mWaitRemoveEntities;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 临时等待移除Entity列表</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">protected</span> List&lt;BaseEntity&gt; mTempWaitRemoveEntities;</span><br><span class="line">    <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line">        </span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>WorldManager.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> WorldManager.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 世界管理单例类(相当于Tiny)</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">WorldManager</span> : <span class="title">SingletonTemplate</span>&lt;<span class="title">WorldManager</span>&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 所有世界Map<span class="doctag">&lt;世界名, 世界&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> Dictionary&lt;<span class="built_in">string</span>, BaseWorld&gt; mAllWorldMap;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 所有世界列表</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Note:</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 用于确保确定性更新顺序</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> List&lt;BaseWorld&gt; mAllWorlds;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 所有更新的世界名列表</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> List&lt;<span class="built_in">string</span>&gt; mAllUpdateWorldNames;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">WorldManager</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mAllWorldMap = <span class="keyword">new</span> Dictionary&lt;<span class="built_in">string</span>, BaseWorld&gt;();</span><br><span class="line">        mAllWorlds = <span class="keyword">new</span> List&lt;BaseWorld&gt;();</span><br><span class="line">        mAllUpdateWorldNames = <span class="keyword">new</span> List&lt;<span class="built_in">string</span>&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Update</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;deltaTime&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Update</span>(<span class="params"><span class="built_in">float</span> deltaTime</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        UpdateAllUpdateWorldNames();</span><br><span class="line">        <span class="keyword">foreach</span>(<span class="keyword">var</span> updateWorldName <span class="keyword">in</span> mAllUpdateWorldNames)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> world = GetWorld&lt;BaseWorld&gt;(updateWorldName);</span><br><span class="line">            world?.Update(deltaTime);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> LogicUpdate</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;logicFrameTime&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">LogicUpdate</span>(<span class="params"><span class="built_in">float</span> logicFrameTime</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        UpdateAllUpdateWorldNames();</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> updateWorldName <span class="keyword">in</span> mAllUpdateWorldNames)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> world = GetWorld&lt;BaseWorld&gt;(updateWorldName);</span><br><span class="line">            world?.LogicUpdate(logicFrameTime);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> FixedUpdate</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;fixedDeltaTime&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">FixedUpdate</span>(<span class="params"><span class="built_in">float</span> fixedDeltaTime</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        UpdateAllUpdateWorldNames();</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> updateWorldName <span class="keyword">in</span> mAllUpdateWorldNames)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> world = GetWorld&lt;BaseWorld&gt;(updateWorldName);</span><br><span class="line">            world?.FixedUpdate(fixedDeltaTime);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> LateUpdate</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;deltaTime&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">LateUpdate</span>(<span class="params"><span class="built_in">float</span> deltaTime</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        UpdateAllUpdateWorldNames();</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> updateWorldName <span class="keyword">in</span> mAllUpdateWorldNames)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> world = GetWorld&lt;BaseWorld&gt;(updateWorldName);</span><br><span class="line">            world?.LateUpdate(deltaTime);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 创建指定类型和名字的世界</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;typeparam name=&quot;T&quot;&gt;</span><span class="doctag">&lt;/typeparam&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;worldName&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;parameters&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> T <span class="title">CreateWrold</span>&lt;<span class="title">T</span>&gt;(<span class="params"><span class="built_in">string</span> worldName, <span class="keyword">params</span> <span class="built_in">object</span>[] parameters</span>) <span class="keyword">where</span> T : BaseWorld, <span class="keyword">new</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> existWorld = GetWorld&lt;T&gt;(worldName);</span><br><span class="line">        <span class="keyword">if</span>(existWorld != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> worldType = <span class="keyword">typeof</span>(T);</span><br><span class="line">            Debug.LogError(<span class="string">$&quot;已存在世界类型:<span class="subst">&#123;worldType.Name&#125;</span>和世界名:<span class="subst">&#123;worldName&#125;</span>的世界，创建世界失败！&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> newWorld = <span class="keyword">new</span> T();</span><br><span class="line">        newWorld.Init(worldName, parameters);</span><br><span class="line">        <span class="keyword">var</span> result = AddWorld(newWorld);</span><br><span class="line">        <span class="keyword">if</span>(result)</span><br><span class="line">        &#123;</span><br><span class="line">            newWorld.OnCreate();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> newWorld;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上述的数据结构定义主要是针对以下几个需求:</p>
<ol>
<li>实现同一个World相同类型System只能有一个(<strong>BaseWorld.mAllSystemTypeAndSystemMap</strong>)</li>
<li>实现World对Entity和System的统一添加和删除流程(<strong>BaseWorld里无论是System还是Entity都实现了统一延迟添加和删除的逻辑，详情参考ManagerSystems()和ManagerEntities()</strong>)</li>
<li><strong>实现了mAllEntityList和mEntityTypeAndEntitiesMap用于同步添加和移除Enttiy，mUpadteEntityTypeAndEntitiesMap用于记录真正添加到世界需要更新的Entity类型和Entity列表Map信息(这一步解决创建Entity无法单帧获取判定是否存在问题)</strong></li>
<li>相同World名字只能同时存在一个(<strong>WorldManager.mAllWorldMap</strong>)</li>
<li>World实现对Enity实体对象挂在父节点的统一(<strong>BaseWorld.mEntityClassTypeParentMap</strong>)</li>
</ol>
<p><strong>这里没有放完整代码，但BaseWorld核心是实现类似tiny-ecs里tiny的作用(统一规范System和Entity的添加删除以及生命周期流程)</strong></p>
<p>感兴趣的欢迎去地图编辑器对这套ECS的实战使用:</p>
<p><a target="_blank" rel="noopener" href="https://github.com/TonyTang1990/MapEditor">MapEditor</a></p>
<p>这里放个实战效果图：</p>
<p><img src="/img/Unity/MapEditor/DynamicCreateMapData1.PNG" alt="DynamicCreateMapData1"></p>
<h1 id="Github"><a href="#Github" class="headerlink" title="Github"></a>Github</h1><p><a target="_blank" rel="noopener" href="https://github.com/TonyTang1990/MapEditor">MapEditor</a></p>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Entity_component_system">Entity component system</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Packages/com.unity.entities@1.3/manual/concepts-ecs.html">Entity component system introduction</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/bakpakin/tiny-ecs">tiny-ecs</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_14914623/article/details/81451002?spm=1001.2101.3001.6650.17&utm_medium=distribute.pc_relevant.none-task-blog-2~default~BlogCommendFromBaidu~Rate-17-81451002-blog-132397770.235%5Ev43%5Epc_blog_bottom_relevance_base6&depth_1-utm_source=distribute.pc_relevant.none-task-blog-2~default~BlogCommendFromBaidu~Rate-17-81451002-blog-132397770.235%5Ev43%5Epc_blog_bottom_relevance_base6&utm_relevant_index=25">游戏开发中的ECS 架构概述</a></p>
<p><a target="_blank" rel="noopener" href="https://www.lfzxb.top/unity-dots-ecs-burst-complier-jobsystem/">Unity DOTS：入门简介（ECS，Burst Complier，JobSystem）</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Programming/">Programming</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Programming/">Programming</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2025/03/10/博客搭建/" title="博客搭建" itemprop="url">博客搭建</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Tony Tang" target="_blank" itemprop="author">Tony Tang</a>
		
  <p class="article-time">
    <time datetime="2025-03-09T16:47:00.000Z" itemprop="datePublished"> 发表于 2025-03-10</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>基于Hexo搭建的博客用了很多年，最近因为一些原因更新了NodeJs相关导致搭建好的Hexo博客无法正常使用，本章节再次记录从零搭建Hexo在Github上的博客流程，分享和记录Hexo的博客搭建流程。</p>
<h1 id="Hexo"><a href="#Hexo" class="headerlink" title="Hexo"></a>Hexo</h1><p><a target="_blank" rel="noopener" href="https://hexo.io/zh-cn/">Hexo是快速、簡單且強大的網誌框架 · 超級快速. Node.js 帶給您超級快的檔案產生速度，上百個檔案只需幾秒就能建立完成。</a></p>
<p><strong>所以Hexo是我们生成博客网页相关的关键之一。</strong></p>
<h1 id="Github-Pages"><a href="#Github-Pages" class="headerlink" title="Github Pages"></a>Github Pages</h1><p><a target="_blank" rel="noopener" href="https://mini-pi.github.io/2024/02/28/how-to-make-blog-wedsite/">GitHub Pages 是一项静态站点托管服务，它直接从 GitHub 上获取 HTML、CSS 和 JavaScript 文件，通过构建过程运行文件，然后发布网站</a></p>
<p><strong>可以理解GitHub支持我们不熟静态网页的一个功能，所以Github Pages这是我们上传Github搭建博客的关键之一。</strong></p>
<h1 id="博客搭建"><a href="#博客搭建" class="headerlink" title="博客搭建"></a>博客搭建</h1><p>了解了核心的Hexo和Github Pages概念和原理，接下来让我们开始搭建属于我们自己的博客。</p>
<ul>
<li><p>安装Node.js</p>
<p>本人已经安装好了，直接去下载安装<a target="_blank" rel="noopener" href="https://nodejs.org/en/download/">Node.js</a>即可</p>
</li>
<li><p>安装Hexo</p>
<p>打开命令行，输入<a target="_blank" rel="noopener" href="https://hexo.io/zh-cn/">npm install hexo-cli -g</a>，不识别npm的先去处理npm环境</p>
</li>
<li><p>使用Hexo初始化博客</p>
<p>打开空目录，然后打开命令行，输入命令:hexo init blog</p>
<p><img src="/img/Blog/HexoBlogInit.PNG" alt="HexoBlogInit"></p>
</li>
<li><p>生成新博客</p>
<p>Hexo初始化博客所在目录打开命令行，输入hexo new TestBlog，会看到我们成功生成了一片新博客</p>
<p><img src="/img/Blog/HexoNewBlog.PNG" alt="HexoNewBlog"></p>
</li>
<li><p>生成博客静态网页</p>
<p>Hexo初始化博客所在目录打开命令行，输入hexo g，会看到public目录生成了静态网页相关文件</p>
<p><img src="/img/Blog/HexoBlogGenerate.PNG" alt="HexoBlogGenerate"></p>
</li>
<li><p>在Github上创建***.github.io的仓库(使用Github Pages服务)</p>
<p>详情参考<a target="_blank" rel="noopener" href="https://pages.github.com/">Github Pages</a></p>
</li>
<li><p>配置Hexo博客发布到Github的***.github.io仓库</p>
<p>打开Hexo初始化博客所在目录的_config.yml文件，将发布相关配置修改成如下:</p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="params">#</span> Deployment</span><br><span class="line"><span class="params">##</span> Docs: https://hexo.io/docs/one-command-deployment</span><br><span class="line">deploy:</span><br><span class="line">  type: git</span><br><span class="line">  repo: 这里填上面Github生成的博客仓库.github.io</span><br><span class="line">  branch: master</span><br></pre></td></tr></table></figure>
</li>
<li><p>发布博客到***.github.io仓库</p>
<p>Hexo初始化博客所在目录打开命令行，输入hexo d，会发现提示不是被的Deployer not found:git</p>
<p><img src="/img/Blog/HexoDeployGitError.PNG" alt="HexoDeployGitError"></p>
<p>这里我们需要安装git相关的hexo部署插件</p>
<p><strong>注意repo填写的仓库地址要SSH而非HTTPS的地址</strong></p>
</li>
<li><p>安装Hexo git部署插件</p>
<p>Hexo初始化博客所在目录打开命令行，输入npm install hexo-deployer-git –save</p>
<p>让后再次输入hexo d我们就会看到部署提示我们输入Github的密码</p>
<p><img src="/img/Blog/HexoDeployEnterPassword.PNG" alt="HexoDeployEnterPassword"></p>
<p>输入完成后回车即可完成博客上传部署。</p>
</li>
<li><p>默认Hexo的博客主题很简陋，这里我们需要去下一个喜欢的主题</p>
<p><a target="_blank" rel="noopener" href="https://hexo.io/themes/">Hexo Themes</a></p>
<p>这里我下载了一个叫jacman的主题:</p>
<p><a target="_blank" rel="noopener" href="https://github.com/wuchong/jacman">jacman</a></p>
<p>下载完成后，我们需要在_config.yml文件里配置theme使用刚下的主题</p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="params">#</span> Extensions</span><br><span class="line"><span class="params">##</span> Plugins: https://hexo.io/plugins/</span><br><span class="line"><span class="params">##</span> Themes: https://hexo.io/themes/</span><br><span class="line">theme: jacman</span><br></pre></td></tr></table></figure>

<p><strong>下载的主题文件放在themes文件夹下</strong></p>
</li>
<li><p>如果想本地测试查看博客效果</p>
<p>Hexo初始化博客所在目录打开命令行，输入hexo server，然后在网页输入localhost:4000即可查看本地效果</p>
<p><img src="/img/Blog/HexoLocalServerPreview.PNG" alt="HexoLocalServerPreview"></p>
</li>
<li><p><strong>关于博客的一些名字修改，自己打开_config.yml修改对应地方即可</strong></p>
<p>配置说明详细参考:<a target="_blank" rel="noopener" href="https://hexo.io/docs/configuration">configuration</a></p>
</li>
</ul>
<p>Note:</p>
<ol>
<li><strong>关于Git的配置上述略过了</strong></li>
<li><strong>博客编写的图片路径要放在当前使用主题下的source目录</strong></li>
</ol>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/26625249">Github+Hexo搭建个人网站详细教程</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Other/">Other</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Other/">Other</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2025/01/01/AI工具/" title="AI工具" itemprop="url">AI工具</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Tony Tang" target="_blank" itemprop="author">Tony Tang</a>
		
  <p class="article-time">
    <time datetime="2024-12-31T16:00:00.000Z" itemprop="datePublished"> 发表于 2025-01-01</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>伴随着聊天模型ChatGPT的兴起，人工智能潮流爆发。无论是照片生成工具，视频生成工具，写作生成工具，甚至编程AI工具等都热火朝天。此博客主要用于学习了解相关AI工具使用，重点侧重于编程AI工具的深入学习和使用。</p>
<h1 id="聊天AI"><a href="#聊天AI" class="headerlink" title="聊天AI"></a>聊天AI</h1><p>首当其冲的肯定是<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/ChatGPT"><strong>ChatGPT，全称聊天生成预训练转换器</strong>（英语：<strong>Chat</strong> <strong>G</strong>enerative <strong>P</strong>re-trained <strong>T</strong>ransformer），是OpenAI开发的人工智能聊天机器人程序，于2022年12月推出。该程序使用基于GPT-3.5、GPT-4、GPT-4o架构的大型语言模型并以强化学习训练。)</a></p>
<p>ChatGPT的诞生，让<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E9%9B%B2%E7%AB%AF%E6%83%85%E4%BA%BA">Her</a>这部电影仿佛照进了现实。</p>
<p>目前ChatGPT Plus收费，普通版免费。</p>
<p>当我们有问题无法解决时，通常我们除了baidu和google查阅答案，也可以尝试询问周边的人，有了ChatGPT我们每个人都相当于拥有了一个全能的助手，可以通过ChatGPT去尝试获取答案。</p>
<p>比如我们询问:</p>
<p>ChatGPT的人工智能原理是什么？</p>
<p>我们会得到如下回答:</p>
<p><img src="/img/AI/AITools/ChatGPTFirstTry.png" alt="ChatGPTFirstTry"></p>
<p>Note:</p>
<ol>
<li><strong>ChatGPT上限很高的同时，下限也很低，在自主学习回答的过程中有时会给出很多明显错误的答案，可以说在使用ChatGPT时，用户即使学生也是老师，通过边教边问的方式，让ChatGPT给出靠近正确的答案。</strong></li>
</ol>
<h1 id="图片生成AI"><a href="#图片生成AI" class="headerlink" title="图片生成AI"></a>图片生成AI</h1><h2 id="Midjourney"><a href="#Midjourney" class="headerlink" title="Midjourney"></a>Midjourney</h2><p><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Midjourney"><strong>Midjourney</strong>是一个由位于美国加州旧金山的同名研究实验室开发之人工智能程序，可根据文本生成图像，于2022年7月12日进入公开测试阶段</a></p>
<p>Midjourney既可以通过<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Discord">Discord</a>也可以通过Web在线进行使用。</p>
<p>这里以Web在线使用来尝试<strong>文本生成图像</strong>的AI工具。参考文档流程:<a target="_blank" rel="noopener" href="https://docs.midjourney.com/docs/create-page">Midjourney Create-Page</a></p>
<p>用户通过在Midjourney网站上给出prompts(提示词类似关键词)，让AI理解需要生成的图片长什么样，然后点击生成即可，考虑到Midjourney需要付费，这里就不测试使用效果了，感兴趣的可以自行购买使用。这里只截张官方网站的创作展示效果界面:</p>
<p><img src="/img/AI/AITools/Midjourney_Explore.png" alt="Midjourney Explore"></p>
<h2 id="SeaArt"><a href="#SeaArt" class="headerlink" title="SeaArt"></a>SeaArt</h2><p><a target="_blank" rel="noopener" href="https://www.seaart.ai/zhCN">SeaArt一款AI艺术生成器</a></p>
<p>创作文生图或者图生视频等功能需要消耗的一些币(付费)，但因为是博主个人所在公司，所以可以免费使用部分功能。</p>
<p>文生图:</p>
<ol>
<li><p>给DeepSeek描述文生图相关问题生成文生图的提示词</p>
<p>比如:</p>
<p>“帮忙生成文生图，描述一只蓝猫和皮卡丘在森林里对战的图片提示词，要求动漫风格，画面颜色鲜艳。”</p>
<p>“上述提示词翻译成英文版”</p>
<p>最终得到文生图的提示词:</p>
<p>“In a sunlit forest, a blue cat and Pikachu are engaged in an intense battle. The blue cat’s fur glistens in the sunlight, its eyes sharp as it swipes with its claws. Pikachu stands on a rock, its cheeks sparkling with electricity, ready to unleash a powerful thunderbolt. The background features tall trees with sunlight filtering through the leaves, creating a dappled effect. The entire scene is dynamic and full of energy, with vibrant colors and intricate details.”</p>
</li>
<li><p>将生成的提示词放入SeaArt的文生图提示词里，点击生成</p>
<p><img src="/img/AI/AITools/SeaArtTextToImg.png" alt="SeaArtTextToImg"></p>
</li>
</ol>
<h1 id="视频生成AI"><a href="#视频生成AI" class="headerlink" title="视频生成AI"></a>视频生成AI</h1><h2 id="Runway"><a href="#Runway" class="headerlink" title="Runway"></a>Runway</h2><p><a target="_blank" rel="noopener" href="https://runwayml.com/">Runway</a>是一个基于人工智能的，强大的影视创作平台，它为用户提供多样化的视频生成、编辑服务，支持多种风格的视频创作，功能包括文本生成视频、视频转换风格、自动绿幕去除背景等，以及图片生成及编辑、音频编辑、3D 物体编辑等。</p>
<p>因为Runway只免费了100多积分，这里只测试了根据图片+prompts的方式生成视频。</p>
<p>输入数据如下:</p>
<p><img src="/img/AI/AITools/RunwayFirstTry.png" alt="RunwayFirstTry"></p>
<p>效果如下:</p>
<p><img src="/img/AI/AITools/RunwayFirstTryVideo.png" alt="RunwayFirstTryVideo"></p>
<p>可以看到根据输入照片和Prompts确实生成了相关的动态视频效果(不得不感叹AI工具的强大)</p>
<h2 id="SeaArt-1"><a href="#SeaArt-1" class="headerlink" title="SeaArt"></a>SeaArt</h2><p><a target="_blank" rel="noopener" href="https://www.seaart.ai/zhCN">SeaArt一款AI艺术生成器</a></p>
<p>图生视频可以用类似上面文生图的SeaArt流程，这里就不一一展示了。</p>
<h1 id="视频字幕AI"><a href="#视频字幕AI" class="headerlink" title="视频字幕AI"></a>视频字幕AI</h1><p><a target="_blank" rel="noopener" href="https://www.veed.io/">VEED.io</a></p>
<p>支持对视频处理的相关AI功能(比如只能加字幕，智能配音，文字转视频等)</p>
<p>这里本人只测试了智能给带音频的视频加字幕功能，目前来看免费功能有限，长期或深度使用需要付费。</p>
<h1 id="编程AI"><a href="#编程AI" class="headerlink" title="编程AI"></a>编程AI</h1><p>接下来来到本文的重点，作为程序员，我们完全是AI编程工具的目标客户，利用AI来提升开发效率是很有必要的(使用ChatGPT后对AI提升的效率深有感触)。</p>
<p>接下来主要以Copilot和Cursor两个工具进行学习和比较。</p>
<h2 id="Copilot"><a href="#Copilot" class="headerlink" title="Copilot"></a>Copilot</h2><p><strong>综合价格，方便(比如Claude Code要被封)，适配现有工作流(IDE比如VSCode和VS)，准备以VSCode+Copilot和Copilot CLI作为AI编程工具为主去学习AI编程工具相关的知识和使用。</strong></p>
<p>所以会有比较长的内容去学习讲解Copilot的相关使用和知识，这里只给出引用，详细内容在单独的博客篇章里记录。</p>
<p><a href="https://tonytang1990.github.io/2026/01/12/Copilot/">Copilot</a></p>
<h2 id="Cursor"><a href="#Cursor" class="headerlink" title="Cursor"></a>Cursor</h2><p>让我们看下官网的介绍:</p>
<p><a target="_blank" rel="noopener" href="https://www.cursor.com/">The AI Code Editor. Built to make you extraordinarily productive, Cursor is the best way to code with AI.</a></p>
<p><strong>从介绍可以看出与Copilot主打编程辅助不同，Cursor设计之初是作为一款人工智能代码编辑器，是一款为提供更好编程AI体验的IDE工具。</strong></p>
<h3 id="Cursor安装"><a href="#Cursor安装" class="headerlink" title="Cursor安装"></a>Cursor安装</h3><p>接下来我们基于<a target="_blank" rel="noopener" href="https://docs.cursor.com/get-started/migrate-from-vscode">Cursor官方文档</a>，把Cursor的类VS Code使用搭建起来:</p>
<p>首先下载安装<a target="_blank" rel="noopener" href="https://www.cursor.com/">Cursor</a></p>
<p>最快兼容老IDE的使用方式是直接导入VSCode的设置，安装时选择导入VS Code Extension:</p>
<p><img src="/img/AI/AITools/CursorImportVSCodeExtesion.PNG" alt="CursorImportVSCodeExtesion"></p>
<p>Cursor为了更好的共享分析代码，会把代码上传到云端，但对于开发项目来说，项目代码肯定是不允许上传云端的，所以在安装Cursor时，我们一定要选择Privacy Mode:</p>
<p><img src="/img/AI/AITools/CursorPrivacyModeSetting.PNG" alt="CursorPrivacyModeSetting"></p>
<p>最后点击登录Cursor，完成登录，基本的Cursor安装和VS Code扩展同步就完成了。</p>
<p>Cursor安装完成后可以看到，Cursor自动下载了.Net Runtime，这是为了准备好.Net开发需要依赖.Net相关的做准备。</p>
<p><img src="/img/AI/AITools/CursorDotNetDownload.PNG" alt="CursorDotNetDownload"></p>
<p>Cursor是付费的，价格参考如下:</p>
<p><img src="/img/AI/AITools/CursorPrice.PNG" alt="CursorPrice"></p>
<p>虽然价格不便宜，但使用效果真心大大提升开发效率，有条件还是建议人手必备。</p>
<p>Note:</p>
<ol>
<li><strong>Cursor的核心是基于VS Code的，所以对于从VS Code的用户使用比较友好。</strong></li>
<li><strong>免费版功能很有限，付费版Pro+(60美元每月[<a target="_blank" rel="noopener" href="https://cursor.com/pricing]">https://cursor.com/pricing]</a>)</strong></li>
<li><strong>Cursor被微软限制使用原生市场插件</strong></li>
</ol>
<h3 id="Unity"><a href="#Unity" class="headerlink" title="Unity"></a>Unity</h3><p>Unity客户端开发者熟悉的IDE莫过于Visual Studio和VS Code，而Cursor就对于VS Code使用者相当友好，在前面安装的流程里我们已经快速同步了VS Code的扩展设置。</p>
<p><img src="/img/AI/AITools/CursorSyncVSCodeExtension.PNG" alt="CursorSyncVSCodeExtension"></p>
<h4 id="Cursor-Editor-Unity"><a href="#Cursor-Editor-Unity" class="headerlink" title="Cursor Editor+Unity"></a>Cursor Editor+Unity</h4><p>Cursor IDE打开后，我们会看到有一个和VS Code不一样的地方就是多了一个Cursor Setting：</p>
<p><img src="/img/AI/AITools/CursorSetting.PNG" alt="CursorSetting"></p>
<p>从这里我们不仅能看到Cursor账号相关设置信息，也能看到Cursor目前设置使用功能的AI模型配置:</p>
<p><img src="/img/AI/AITools/CursorAIModels.PNG" alt="CursorAIModels"></p>
<p>那么如何将Cursor设置成我们Cursor的默认IDE了？</p>
<p>Edit-&gt;Preference-&gt;External Tools-&gt;External Script Editor-&gt;Cursor</p>
<p><img src="/img/AI/AITools/UnityCursorIDESetting.PNG" alt="UnityCursorIDESetting"></p>
<p>新建一个项目双击CS文件后我们会发现，Cursor仅仅是把当前选中文件当做单文件的方式打开:</p>
<p><img src="/img/AI/AITools/OpenCSFileByCursor.PNG" alt="OpenCSFileByCursor"></p>
<p>在我们Cursor工程目录下会看到压根没生成CS项目相关文件:</p>
<p><img src="/img/AI/AITools/CursorUnityProjectFolder.PNG" alt="CursorUnityProjectFolder"></p>
<p>在这种状态下F5理所当然是无法调试Unity的，所以我们需要安装一个第三方包Cursor Editor帮助我们生成CS相关项目文件:</p>
<p>Window-&gt;Package Manager-&gt;+-&gt;Add Package from Git URL</p>
<p>然后输入地址:<a target="_blank" rel="noopener" href="https://github.com/boxqkrtm/com.unity.ide.cursor.git">https://github.com/boxqkrtm/com.unity.ide.cursor.git</a></p>
<p><img src="/img/AI/AITools/CursorEditorPackageInstall.PNG" alt="CursorEditorPackageInstall"></p>
<p><a target="_blank" rel="noopener" href="https://github.com/boxqkrtm/com.unity.ide.cursor">Cursor Editor Github</a></p>
<p>安装完成Cursor Editor后我们再次双击CS文件就会发现不仅项目工程生成了CS相关项目文件，Cursor也成功以CS工程打开了该文件:</p>
<p><img src="/img/AI/AITools/UnityOpenCSFileByCursor.PNG" alt="UnityOpenCSFileByCursor"></p>
<p><img src="/img/AI/AITools/CursorEditorGenerateCSProjectFiles.PNG" alt="CursorEditorGenerateCSProjectFiles"></p>
<p>这时我们再按F5就会发现已经成功Attach到Unity并断点到了:</p>
<p><img src="/img/AI/AITools/CursorUnityDebug.PNG" alt="CursorUnityDebug"></p>
<p>Note:</p>
<ol>
<li><strong>如果调试不成功请参考博主安装的扩展插件，可能是跟C#相关的扩展需要安装</strong></li>
</ol>
<h4 id="VS-Code-Unity"><a href="#VS-Code-Unity" class="headerlink" title="VS Code+Unity"></a>VS Code+Unity</h4><p>但如果必须安装Cursor Editor Package才能顺利生成C#工程和调试的话，对现有已经通过Visual Studio生成的C#工程就很不友好，所以接下来的目标是搭建Cursor直接打开原始C#工程并调试。</p>
<p>根据Cursor最初的介绍，Cursor的核心是基于VS Code的，所以个人认为Cursor要想调试Unity现有的C#工程，操作流程应该是和VS Code一样的。</p>
<p><a target="_blank" rel="noopener" href="https://code.visualstudio.com/docs/other/unity">Unity Development with VS Code</a></p>
<p>从上面的介绍可以看到条件有如下几个:</p>
<ol>
<li>安装Unity 2021或者更高版本</li>
<li>安装VS Code</li>
<li>VS Code安装Unity for Visual Studio Code插件(这一步会包含C#相关需要的一些东西，比如C# Dev Kit)</li>
<li>Unity安装Visual Studio Editor包(这一步如果无法升级到最新，提示说需要重新登录Unity账号则登出再登录统一相关政策即可)</li>
<li>设置VS Code作为Unity的External Script Editor</li>
</ol>
<p>所有设置完成后，我们双击C#代码文件即可打开VS Code，可以看到项目工程目录下生成了.vscode目录，里面存放了相关VS Code调试C#需要的文件：</p>
<p><img src="/img/AI/AITools/UntiyVScodeAsIdeSetting.PNG" alt="UntiyVScodeAsIdeSetting"></p>
<p>然后直接按F5即可Attach到Unity上：</p>
<p><img src="/img/AI/AITools/VSCodeDebugUnity.PNG" alt="VSCodeDebugUnity"></p>
<p>Note:</p>
<ol>
<li><strong>VS Code导出插件到本地需要通过vsce，详情参考:<a target="_blank" rel="noopener" href="https://code.visualstudio.com/api/working-with-extensions/publishing-extension">Publishing Extensions</a>(如果vsce安装不成功的话，升级Node和Npm版本再次尝试)，本人导出插件遇到一系列问题，真正导出需要符合插件开发的一系列流程，下载到本地的Extension没法直接通过vsce直接导出vsix包，vsix包可以在官方插件网站直接下载<a target="_blank" rel="noopener" href="https://marketplace.visualstudio.com/">Extensions for Visual Studio Code</a></strong></li>
<li><strong>如果遇到打开的工程目录不是被Unity相关类无法自动Quick Fix添加引用等问题，记着通过设置Edit-&gt;Preference-&gt;External Script Editor(VSCode)，然后点击Regenerate project files重新生成工程文件</strong></li>
</ol>
<h4 id="Cursor-Unity"><a href="#Cursor-Unity" class="headerlink" title="Cursor+Unity"></a>Cursor+Unity</h4><p>既然VS Code都调试Unity C#工程成功了，那么接下来让我们看下Cursor参考VSCode是如何成功打开原始C#工程并调试成功的。</p>
<p>参考VSCode的安装流程:</p>
<ol>
<li>安装Unity 2021或者更高版本</li>
<li>安装Cursor</li>
<li>Cursor安装Unity for Visual Studio Code插件(这一步会包含C#相关需要的一些东西，比如C# Dev Kit)</li>
<li>Unity安装Visual Studio Editor包(这一步如果无法升级到最新，提示说需要重新登录Unity账号则登出再登录统一相关政策即可)</li>
<li>设置Cursor作为Unity的External Script Editor</li>
</ol>
<p>按照上述流程弄完后，双击C#文件会发现Cursor IDE只打开了一个文件，而没有把整个项目的工程文件打开，这时我们只能通过Cursor把项目通过文件夹的方式打开。</p>
<p><img src="/img/AI/AITools/CursorOpenProjectByFolder.PNG" alt="CursorOpenProjectByFolder"></p>
<p>通过上述方式打开我们会看到项目里所有的资源文件包含Library目录的文件都显示在了Cursor里，为了避免笔不要的文件显示在Cursor工程里，我们需要再.vscode&#x2F;settings.json里配置排除的文件列表，这个列表我参考复制了Cursor Editor生成的settings.json(这一步通过VSCode流程打开项目也会自动生成):</p>
<p><img src="/img/AI/AITools/CursorExcludeFileSettingsJson.PNG" alt="CursorExcludeFileSettingsJson"></p>
<p>直接使用Cursor打开目录是不会生成.vscode目录的相关配置文件的，这里我们可以自行复制相关文件，也可以在Cursor打开工程目录之前，设置VS Code作为Extebnal IDE然后打开项目代码自动生成.vscode目录。</p>
<p>有了.vscode这个目录的相关配置，我们使用Cursor打开目录后直接F5即可看到调试效果:</p>
<p><img src="/img/AI/AITools/CursorDebugUnityCS.PNG" alt="CursorDebugUnityCS"></p>
<p>Note:</p>
<ol>
<li><strong>Cursor底层核心跟VSCode是一样，所以Cursor调试Unity的流程跟VSCode也几乎是一样的，但设置Cursor作为External IDE并不会帮我们自动生成.vscode这个相关配置目录，所以需要我们通过VSCode流程或者Cursor Editor包辅助生成</strong></li>
<li><strong>Unity里的Visual Studio Editor包一定要更新到最新</strong></li>
<li><strong>Cursor不使用Cursor Editor包的前提下只能通过打开项目目录的方式打开工程</strong></li>
<li><strong>目前个人认为最好的IDE设置方式应该是利用设置VS Code作为External IDE双击打开生成.vscode相关配置文件，然后修改External IDE为Cursor，然后使用Cursor直接打开项目工程目录作为编写代码的IDE，这样通过Console双击报错时也能快速打开Cursor对应文件，也能快速适配C#工程代码调试</strong></li>
</ol>
<h3 id="Cursor进阶使用"><a href="#Cursor进阶使用" class="headerlink" title="Cursor进阶使用"></a>Cursor进阶使用</h3><p>项目文件生成+调试C#成功，接下来就让我们看看Cursor是如何帮助我们提升开发效率的。</p>
<p>Cursor主要有三大功能：</p>
<ol>
<li><strong>人工智能代码补全(理解代码库智能分析即将编写的代码进行智能不全)</strong></li>
<li><strong>自然语言聊天交互(通过打字交流的方式，交互理解代码分析问题)</strong></li>
<li><strong>智能代理(处理复杂开发任务)</strong></li>
</ol>
<h4 id="人工智能代码补全"><a href="#人工智能代码补全" class="headerlink" title="人工智能代码补全"></a>人工智能代码补全</h4><p>Cursor最强大也是最基础就是根据程序员代码编写进行智能代码分析，对接下来的代码编写进行预测，在编写的时候会生成灰色的预测代码，如果程序员选择接受预测的代码只需按tab键即可。</p>
<p>比如我们编写一个主界面打印日志按钮的声明和点击监听代码：</p>
<p><img src="/img/AI/AITools/AutoCompleteFeatureUserCase1.PNG" alt="AutoCompleteFeatureUserCase1"></p>
<p>可以看到我们还没有编写注释，Cursor就根据之前编写的声明代码猜测出我们即将写的注释，此时我们只需按tab键即可接受Cursor的代码推断，自动完成注释编写。</p>
<p><img src="/img/AI/AITools/AutocompleteFeatureUserCase2.PNG" alt="AutocompleteFeatureUserCase2"></p>
<p>从上面可以看到博主刚编写完PrintLogBtn的onClick的监听，Cursor就在下面智能分析提示出了多段即将编写的代码，从预测代码来看，几乎就是博主即将编写的代码，此时只需按tab键接受Cursor的的预测代码，即快速完成了日志打印按钮的响应代码编写。</p>
<p><img src="/img/AI/AITools/AutocompleteFeatureUserCase3.PNG" alt="AutocompleteFeatureUserCase3.PNG"></p>
<p>相比Compilot，Cursor的智能提示有如下优势:</p>
<ol>
<li><p><a target="_blank" rel="noopener" href="https://docs.cursor.com/tab/from-gh-copilot">GitHub Copilot can insert text at your cursor position. It cannot edit the code around your cursor or remove text.</a>(Copilot智能在光标处插入文本，无法在光标附近插入文本或者删除文本)</p>
</li>
<li><p>可以实现自动文件导入补全功能(好比C#里用到某个命名空间下的类，Tab可以实现智能补全using)</p>
</li>
<li><p>Cursor在用户tab接受智能分析代码后预测即将编写的代码地方(方便用户一直通过tab补全相关代码)</p>
<p><img src="/img/AI/AITools/CursorCodePrediction.PNG" alt="CursorCodePrediction"></p>
</li>
<li><p>Cursor可以实现智能分析的代码部分接受(此功能貌似默认关闭的，需要在Cursor Settings-&gt;Features-&gt;Cursor Tab里勾选打开)</p>
<p><img src="/img/AI/AITools/PartialAcceptsSetting.PNG" alt="PartialAcceptsSetting"></p>
<p><strong>部分接受补全的快捷键是:Ctrl+→</strong></p>
<p><img src="/img/AI/AITools/CusorPartialAccept.PNG" alt="CusorPartialAccept"></p>
</li>
</ol>
<h4 id="自然语言聊天交互"><a href="#自然语言聊天交互" class="headerlink" title="自然语言聊天交互"></a>自然语言聊天交互</h4><p><a target="_blank" rel="noopener" href="https://docs.cursor.com/chat/overview">Chat feature that uses AI to answer code questions with smart context and file references in your editor</a>(Chat功能就好比我们常规用的ChatGpt，能够通过聊天交互的方式一步一步向AI提出需求让AI帮我们提出解决方案甚至编写完整代码)</p>
<p><strong>个人理解ChatGpt更加面向通用模型，而Cursor的Chat更面向程序层面，可以结合强大的代码库知识库给我们提出代码层面更加合理的解决方案</strong></p>
<p><strong>打开Chat的快捷键：Ctrl+L</strong></p>
<p>Chat功能类似Composer，也可以通过@的方式提供上下文文件或目录。</p>
<p><img src="/img/AI/AITools/CursorChatUsing.PNG" alt="CursorChatUsing"></p>
<p>可以看到根据我们提出的需求，AI已经成功编写了相关代码，如果选择接受点击右下角apply all即可，如果在此基础上还需要改进，可以继续在Chat聊天框里基于前面生成的代码进行对AI的细节调教来完善代码。</p>
<p>Note:</p>
<ol>
<li><strong>Cusor的代码接受和拒绝有点像Git合并操作，这一点还是比较容易理解的</strong></li>
</ol>
<h4 id="智能代理"><a href="#智能代理" class="headerlink" title="智能代理"></a>智能代理</h4><p><a target="_blank" rel="noopener" href="https://docs.cursor.com/get-started/introduction">Agent is your AI-powered coding partner that helps you tackle larger tasks</a>(智能代理是一个强大的代码编程助手，辅助我们解决复杂的任务)</p>
<p><strong>Composer:<a target="_blank" rel="noopener" href="https://docs.cursor.com/composer">AI coding assistant that helps write and edit code directly in your editor with chat and agent modes</a></strong>(Composer是Cursor提供的通过聊天交互方式的代码助手，快捷键打开是:Ctrl+I，打开新Composer快捷键是:Ctrl+N)</p>
<p>Composer有三种工作模式:</p>
<ol>
<li><strong>Ask:<a target="_blank" rel="noopener" href="https://docs.cursor.com/composer">Ask question about your code, get explanations, and discover your codebase.</a>(询问关于代码的问题，得到解释的模式)</strong></li>
<li><strong><a target="_blank" rel="noopener" href="https://docs.cursor.com/composer">Edit:Make single-turn edits to your code with precision and clarity.</a>(单词精准编辑代码的模式)</strong></li>
<li><strong>Agent:<a target="_blank" rel="noopener" href="https://docs.cursor.com/agent">uses tools and reasoning to perform coding tasks with minimal supervision</a>(利用工具在最小的监督下完成编码任务)</strong></li>
</ol>
<p>目前个人理解<strong>Ask</strong>模式适合针对指定代码上下文询问问题得到解释。</p>
<p><strong>Edit</strong>模式适合指定上下文代码问题给出代码修改方案。</p>
<p><strong>Agent</strong>模式适合需要完成复杂的代码任务(利用了更多的工具(比如<a target="_blank" rel="noopener" href="https://modelcontextprotocol.io/introduction">Model Context Protocol (MCP)</a>实现更加DIY和智能的代码理解和生成)</p>
<p>模式的指定在Composer的左下角:</p>
<p><img src="/img/AI/AITools/ComposerModeChosen.PNG" alt="ComposerModeChosen"></p>
<p>同时关于Composer使用的底层模型(目前代码理解比较火的是<strong>claude-3.7-sonnet-thinking(2025&#x2F;3&#x2F;11)</strong>)指定也在左下角:</p>
<p><img src="/img/AI/AITools/ComposerAIModeChosen.PNG" alt="ComposerAIModeChose"></p>
<p>Composer里我们可以通过@的方式指定要添加的相关上下文代码，然后通过自然语言交互的方式给人工智能提需求编写相关代码。</p>
<p><img src="/img/AI/AITools/CursorComposerAddContext.PNG" alt="CursorComposerAddContext"></p>
<p><img src="/img/AI/AITools/CursorComposerChat.PNG" alt="CursorComposerChat"></p>
<p><img src="/img/AI/AITools/CursorComposerChatGenerateCode.PNG" alt="CursorComposerChatGenerateCode"></p>
<p>可以看到通过添加GameLauncher.cs脚本作为上下文，然后直接描述需求的方式，Cursor帮我们生成了相关代码，就这个简单需求而言，生成的代码几乎完美，代码符合心理预期后，接下来我们只需要点击接受单个或者接受所有即可:</p>
<p><img src="/img/AI/AITools/CursorComposerCodeAccept.PNG" alt="CursorComposerCodeAccept"></p>
<p>如果接受的这一次Composer代码不想要了，Cursor还记录的类似进度点(CheckPoint)的东西，帮助我们快速还原某次Composer记录:</p>
<p><img src="/img/AI/AITools/CursorCheckPointRestore.PNG" alt="CursorCheckPointRestore"></p>
<p>Cursor Composer还提供了历史面板的东西，<strong>快捷键:Ctrl+Alt+L</strong>，可以帮助我们快速查看过去的所有Composer提问以及再次操作过去Composer提问的入口:</p>
<p><img src="/img/AI/AITools/CursorComposerHistory.PNG" alt="CursorComposerHistory"></p>
<p>关于Agent，这里暂不深入学习，未来有需求再深入了解。</p>
<p>Note:</p>
<ol>
<li><strong>Cursor受到微软制裁，导致无法正常使用VSCode的插件，导致相关使用受限(2025&#x2F;07&#x2F;08)</strong></li>
</ol>
<h2 id="Augment-Code"><a href="#Augment-Code" class="headerlink" title="Augment Code"></a>Augment Code</h2><p>借助VSCode插件市场Augment的介绍来了解一下Augment的功能:</p>
<p>“<a target="_blank" rel="noopener" href="https://augmentcode.com/">Augment Code</a> is the AI-powered coding platform built for professional software engineers and large codebases. Powered by a cutting-edge context engine that understands your entire codebase, use Agent, Completions, Chat, and Next Edit to accelerate the way you code.”</p>
<p><strong>Augment Code定位是AI辅助编程工具，和Cursor一样拥有强大的整体代码分析能力以及强大的代码预测快速填充和AI问答辅助编程等功能，但和Cursor最核心不一样的地方是，Augment Code是以插件的形式注入的原始的IDE中，而Cursor是独立的IDE结合AI编程体验。据说Augment Code有更大容量的上下文token，对于大项目团队合作和代码分析更加强大。</strong></p>
<p>Augment Code的开发版价格目前是50美元&#x2F;月，本人采用的是社区免费版本(<strong>50次对话提问，MCP，无限代码预测提示等</strong>):</p>
<p><img src="/img/AI/AugmentCode/CommunityFreePrice.PNG" alt="CommunityFreePrice"></p>
<p><strong>相比Cursor改变IDE，本人更倾向于原始的熟悉的IDE开发(借助原生态的插件等，会有更好的开发体验)，特别是Cursor在受到微软VSCode插件使用限制的情况下，个人更看好插件形式的AI辅助编程环境(e.g. compilot和Augment Code)</strong></p>
<p>安装Augment Code很简单，直接在VSCode插件市场搜索Augment然后点击安装即可:</p>
<p><img src="/img/AI/AugmentCode/VSCodeAugmentInstall.PNG" alt="VSCodeAugmentInstall"></p>
<p>安装完成后我们通过登录Augment账号即可开发体验Augment插件功能:</p>
<p><img src="/img/AI/AugmentCode/VSCodeAugmentLogin.PNG" alt="VSCodeAugmentLogin"></p>
<p>允许Agment所以我们指定的代码库进行代码解释和分析:</p>
<p><img src="/img/AI/AugmentCode/AugmentIndexCodebaseAsk.PNG" alt="AugmentIndexCodebaseAsk"></p>
<p>查看Augment设置的代码库上下文路径配置:</p>
<p>Augment Setting-&gt;Contetx即可看到:</p>
<p><img src="/img/AI/AugmentCode/AugmentViewWorkspaceContext.PNG" alt="AugmentViewWorkspaceContext"></p>
<p>同样的道理，配置Augment规则，方便统一Augment在协作的过程中的一些规范配置(<strong>可以直接用自然语言描述规则</strong>):</p>
<p>Augment Setting-&gt;Rules and User Guidelines即可看到:</p>
<p><img src="/img/AI/AugmentCode/ConfigAugmentRule.PNG" alt="ConfigAugmentRule"></p>
<p>Augment Code和Cursor一样，聊天框分Chat和Agent(<strong>Agent又分为Agent和Agent Auto，后者权限更大，无需询问自动化执行</strong>)模式：</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://docs.augmentcode.com/using-augment/chat">Use Chat to explore your codebase, quickly get up to speed on unfamiliar code, and get help working through a technical problem.</a>(<strong>Chat更适合通过AI对话的方式帮助我们快速熟悉代码和了解解决常规技术问题</strong>)</li>
<li><a target="_blank" rel="noopener" href="https://docs.augmentcode.com/using-augment/agent">Use Agent to complete simple and complex tasks across your workflow–implementing a feature, upgrade a dependency, or writing a pull request.</a>(<strong>Agent更适合完成需要复杂步骤流程完成的功能或任务</strong>)</li>
</ol>
<p>Chat和Agent的切换在对话框左下角:</p>
<p><img src="/img/AI/AugmentCode/AugmentChatAndAgentSwitch.PNG" alt="AugmentChatAndAgentSwitch"></p>
<p>Augment Code聊天空支持了三个工具:</p>
<ol>
<li><strong>Attach(支持添加附加文件作为问题对话内容)</strong></li>
<li><strong>支持输入&#x2F;或点击&#x2F;快速选择行为来帮助我们明确对AI的输入的内容</strong></li>
<li><strong>支持输入@或点击@快速选择对话里需要引用的上下文内容(e.g. 文件或目录等)</strong></li>
</ol>
<p> <img src="/img/AI/AugmentCode/AugmentChatTools.PNG" alt="AugmentChatTools"></p>
<p>Augment Code主要包含四大功能:</p>
<ol>
<li><strong>Chat(这个就好比Cursor的Deepseek问答系统，可以直接对话提问，这个可以帮助我们让AI快速介绍分析代码库设计，对不懂的问题进行提问等)</strong></li>
<li><strong>Next Edit(通过选中代码块给出AI指令，让AI帮忙快速修改建议的功能)</strong></li>
<li><strong>Using instructions(使用自然语言描述让AI把选中的代码模块进行从够或编写代码测试用例等)</strong></li>
<li><strong>Code Completions(这个就是Cursor里基于代码库分析，编码时快速预测提示补全的功能)</strong></li>
</ol>
<h3 id="Chat"><a href="#Chat" class="headerlink" title="Chat"></a>Chat</h3><p>Chat和Agent前面介绍过细节区别，接下来看看使用Agent提问帮助我们理解项目代码设计：</p>
<p><img src="/img/AI/AugmentCode/AugmentCodeAgentUsing.PNG" alt="AugmentCodeAgentUsing"></p>
<p>可以看到同**@符号我们添加了给AI作为思考上下文的核心代码目录**，AI通过分析把每一步思考理解过程都详细讲述出来了，最后给出了分析结论(这一点和Cursor的Chat和Agent没有本质区别)，底层AI用的目前适配编程AI最好的Claude模型(2025&#x2F;07&#x2F;13)。</p>
<p>关于AI给出的代码都会提供复制和创建新文件的快捷操作入口方便我们采纳AI给出的代码建议:</p>
<p><img src="/img/AI/AugmentCode/AugmentCodeOperation.PNG" alt="AugmentCodeOperation"></p>
<p>Augment Code设计了一个AI自动优化提示词的功能(<strong>Rewrite Prompt</strong>)，避免我们问问题的时候不够针对和准确:</p>
<p><img src="/img/AI/AugmentCode/AugmentCodeOptimizaPrompt.PNG" alt="AugmentCodeOptimizaPrompt"></p>
<p>可以看到AI整理后的提示词比我们精准和详细。</p>
<h3 id="Next-Edit"><a href="#Next-Edit" class="headerlink" title="Next Edit"></a>Next Edit</h3><p><a target="_blank" rel="noopener" href="https://docs.augmentcode.com/using-augment/next-edit#windows%2Flinux">Next Edit helps you complete your train of thought by suggesting changes based on your recent work and other context. You can jump to the next edit and quickly accept or reject the suggested change with a single keystroke.</a></p>
<p>从介绍可以看出Next Edit是基于代码库和最近编写的上下文进行代码预测和补全的。</p>
<p>相关操作快捷键如下:</p>
<p><img src="/img/AI/AugmentCode/AugmentCodeNextEditShortcurt.PNG" alt="AugmentCodeNextEditShortcurt"></p>
<p>相关AugmentCode的Next Edit设置在插件-&gt;Augment-&gt;Settings-&gt;Next Edit里:</p>
<p><img src="/img/AI/AugmentCode/AugmentCodeNextEditSetting.PNG" alt="AugmentCodeNextEditSetting"></p>
<h3 id="Using-instructions"><a href="#Using-instructions" class="headerlink" title="Using instructions"></a>Using instructions</h3><p><a target="_blank" rel="noopener" href="https://docs.augmentcode.com/using-augment/instructions">Use Instructions to write or modify blocks of code using natural language. Refactor a function, write unit tests, or craft any prompt to transform your code.</a></p>
<p>从介绍可以看出，Instructions是使用自然语言描述让AI把选中的代码块给出AI指令，让AI帮忙快速修改建议的功能等，<strong>快捷键是Ctrl+I</strong>。</p>
<p>通过选中需要改进的代码，我们给出AI指示，AI会给出修改前后对比让我们选择是佛接受(<strong>Return快捷键</strong>)或取消(<strong>Esc快捷键</strong>)</p>
<p><img src="/img/AI/AugmentCode/AugmentCodeInstructionsUsing.PNG" alt="AugmentCodeInstructionsUsing"></p>
<p>相关快捷键操作:</p>
<p><img src="/img/AI/AugmentCode/AugmentCodeInstructionsShortcut.PNG" alt="AugmentCodeInstructionsShortcut"></p>
<p>Note:</p>
<ol>
<li><strong>上面写的Return快捷键好像是Enter</strong></li>
</ol>
<h3 id="Code-Completions"><a href="#Code-Completions" class="headerlink" title="Code Completions"></a>Code Completions</h3><p><a target="_blank" rel="noopener" href="https://docs.augmentcode.com/using-augment/completions">Augment’s Code Completions integrates with your IDE’s native completions system to give you autocomplete-like suggestions as you type. You can accept all of a suggestion, accept partial suggestions a word or a line at a time, or just keep typing to ignore the suggestion.</a></p>
<p>从介绍可以看出Code Completions就是Cursor里基于代码库和最近编写的代码进行代码编写预测的功能。</p>
<p><img src="/img/AI/AugmentCode/AugmentCodeCompletionsUsing.PNG" alt="AugmentCodeCompletionsUsing"></p>
<p>相关快捷键:</p>
<p><img src="/img/AI/AugmentCode/AugmentCodeCompletionsShortcut.PNG" alt="AugmentCodeCompletionsShortcut"></p>
<p><strong>相对来说Agent比Chat用的更多，常规设置成Agent即可，</strong></p>
<p><strong>Ctrl+L(打开Agment面板)</strong></p>
<p>Note:</p>
<ol>
<li><strong>Augment Code对个人或项目代码安全保护很好，是私有分析不会上传云端</strong></li>
<li><strong>Augment Code的Code Completions反应个人觉得比Cursor慢，具体原因未知(本人是免费用户)</strong></li>
</ol>
<h2 id="Claude-Code"><a href="#Claude-Code" class="headerlink" title="Claude Code"></a>Claude Code</h2><p><a target="_blank" rel="noopener" href="https://www.claude.com/product/claude-code">Unleash Claude’s raw power directly in your terminal. Search million-line codebases instantly. Turn hours-long workflows into a single command. Your tools. Your workflow. Your codebase, evolving at thought speed.</a></p>
<p>从介绍可以看出Claude Code相比前面Copilot，Cursor，Augment Code最大的区别就是是基于命令行的工具，这一点对于服务器开发人员比较友好。</p>
<p>脱离的IDE，可以<strong>便捷轻量</strong>使用AI工具辅助开发。</p>
<p><strong>Claude模型在编程方面很强</strong></p>
<p>Note:</p>
<ol>
<li><strong>Claude Code Pro版本(17美元每月)</strong></li>
</ol>
<h2 id="AI编程工具选择"><a href="#AI编程工具选择" class="headerlink" title="AI编程工具选择"></a>AI编程工具选择</h2><p>了解了主流的几个编程AI工具，个人认为结论大致如下：</p>
<p><strong>Copilot – 适用于对AI编程有基础的智能补全和简单的Agent问答需求，价格不希望太贵的用户。</strong></p>
<p><strong>Cursor – 适用于能接受独立IDE，希望有完美AI深度编程体验，希望AI上下文代码分析能力强一些，同时能支付的起价格的用户。</strong></p>
<p><strong>Augment Code – 适用于不脱离原有IDE，希望有强大的AI上下文代码分析能力，同时能支付的起价格的用户</strong></p>
<p><strong>Claude Code – 适用于习惯命令行工作环境或者当做简易独立AI编程辅助工具的开发人员</strong></p>
<p>综合了解了主流AI编程工具后，博主个人的使用功能需求主要如下：</p>
<ol>
<li><strong>倾向于保留原有熟悉IDE的开发环境</strong></li>
<li><strong>有快速和智能的代码分析补全</strong></li>
<li><strong>支持基础的Agent问答辅助编程开发功能</strong></li>
<li><strong>价格不能太贵</strong></li>
</ol>
<p>最终博主决定选择<strong>Copilot</strong>作为VS+Unity开发的个人AI编程工具。</p>
<p><strong>在公司公司付费了Cursor，所以在公司依然使用Cursor辅助AI编程开发。</strong></p>
<p>未来如果经费允许参与大型项目需要强大的上下文代码分析能力，可以考虑Augment Code。</p>
<h1 id="AI编程发展"><a href="#AI编程发展" class="headerlink" title="AI编程发展"></a>AI编程发展</h1><h2 id="提示词工程师"><a href="#提示词工程师" class="headerlink" title="提示词工程师"></a>提示词工程师</h2><p>核心角色：</p>
<p><strong>人与AI的“翻译”</strong></p>
<p>工作方式:</p>
<p><strong>精心设计提示词，指令驱动AI完成任务</strong></p>
<p>关注焦点：</p>
<p><strong>优化单次交互，追求精准、稳定、可控的输出</strong></p>
<p>AI编程中的作用：</p>
<p><strong>基础能力，让AI正确理解开发意图，生成所需代码或文档。</strong></p>
<p>事例：</p>
<p>链式思考提示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">让我们逐步思考：</span><br><span class="line">1. 首先分析需求的关键要素</span><br><span class="line">2. 然后确定合适的数据结构</span><br><span class="line">3. 接着设计算法逻辑</span><br><span class="line">4. 最后考虑边界情况和优化</span><br></pre></td></tr></table></figure>

<p>角色扮演提示:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">“你是一位资深Python开发者和代码审查专家，</span><br><span class="line">请以这个身份审查以下代码...”</span><br></pre></td></tr></table></figure>

<p>少样本学习提示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">以下是一些良好代码的例子：</span><br><span class="line">[示例1]</span><br><span class="line">[示例2]</span><br><span class="line"></span><br><span class="line">请按照同样的风格和质量标准完成：[新任务]</span><br></pre></td></tr></table></figure>

<p><strong>提示词工程师的价值在于通过系统化的方法（如角色设定、结构化指令、思维链提示等），引导AI生成高质量代码，是高效利用AI的基础。</strong></p>
<h3 id="Copilot-Prompt"><a href="#Copilot-Prompt" class="headerlink" title="Copilot Prompt"></a>Copilot Prompt</h3><p><a target="_blank" rel="noopener" href="https://support.microsoft.com/en-us/topic/learn-about-copilot-prompts-f6c3b467-f07c-4db1-ae54-ffac96184dd5">Copilot prompts are instructions or questions you use to tell Copilot what you want. </a>(Copilot提示词是用于告知Copilot您的需求的指令或问题。)</p>
<p>Copilot prompts由4部分组成：</p>
<ul>
<li><p>Goal</p>
<p>What do you want from Copilot?(想从Copilot这里获得什么？)</p>
</li>
<li><p>Context</p>
<p>Why do you need it and who is involved?(为什么需要？会包含哪些人？)</p>
</li>
<li><p>Expectations</p>
<p>How should Copilot respond to best fullfill you request?(你期望Copilot如何去满足你的请求？)</p>
</li>
<li><p>Source</p>
<p>What information or samples do you want Copilot to use?(你希望Copilot使用什么信息或样例？)</p>
</li>
</ul>
<p>给Copilot编写提示词时，注重上面几点，这样才能让Copilot更加准确的理解任务需求和输出正确的结果。</p>
<p><strong>个人理解提示词强调的是如何让AI更加正确理解需求和输出正确结果。</strong></p>
<h2 id="Vibe-Coding"><a href="#Vibe-Coding" class="headerlink" title="Vibe Coding"></a>Vibe Coding</h2><p>核心角色：</p>
<p><strong>项目“总监”</strong></p>
<p>工作方式:</p>
<p><strong>用自然语言描述高层次需求，<strong>与AI多轮对话迭代</strong>，快速构建原型</strong></p>
<p>关注焦点：</p>
<p><strong>整体实现效率，快速验证想法，让AI处理大量细节</strong></p>
<p>AI编程中的作用：</p>
<p><strong>工作流革新，大幅降低编程门槛，将开发者精力集中在系统设计和逻辑规划上</strong></p>
<p><strong>Vibe Coding代表了一种更自由、更具实验性的工作风格，特别适合快速原型验证、探索性项目或独立开发。但它可能导致开发者对代码库的理解不深，在严肃的、需要长期维护的企业级项目中需谨慎使用。它更适合作为高效实现想法的“加速器”。</strong></p>
<p><strong>个人理解，Vibe Coding是一种从程序开发转变到提需求的甲方，强调的是利用AI全方面开发生成需求产品的过程。Vibe Coding因为是纯依赖AI理解需求生成代码，所以对AI的token消耗可能比较高。</strong></p>
<h2 id="Skill"><a href="#Skill" class="headerlink" title="Skill"></a>Skill</h2><p>核心角色：</p>
<p><strong>系统“架构师”</strong></p>
<p>工作方式:</p>
<p><strong>模块化、可复用的AI能力包，按需动态加载</strong></p>
<p>关注焦点：</p>
<p><strong>工程化与标准化，构建可维护、可扩展、高效率的AI协作体系</strong></p>
<p>AI编程中的作用：</p>
<p><strong>未来范式，将AI能力固化为“即插即用”的标准化工具，是AI工程化协作的关键</strong></p>
<h1 id="AI工作流工具"><a href="#AI工作流工具" class="headerlink" title="AI工作流工具"></a>AI工作流工具</h1><h2 id="Comfyui"><a href="#Comfyui" class="headerlink" title="Comfyui"></a>Comfyui</h2><p><a target="_blank" rel="noopener" href="https://docs.comfy.org/get_started/introduction">ComfyUI is a node based interface and inference engine for generative AI. Users can combine various AI models and operations through nodes to achieve highly customizable and controllable content generation.</a></p>
<p>个人理解ComfyUI是一个基于节点编辑可组合各种AI模型完成指定AI工作流的一个AI工作流引擎。</p>
<p>这是未来的学习方向，目前暂时不做更多了解，TODO。</p>
<h1 id="个人心得"><a href="#个人心得" class="headerlink" title="个人心得"></a>个人心得</h1><ol>
<li><p><strong>现在底层AI模型百花齐放，上层AI工具也百花齐放，AI提升了人的生产力，但提升多少生产力还在于每个人对于AI的使用深度，AI并不能直接替代人，而是作为工具帮助人更高效的完成工作</strong></p>
</li>
<li><p><strong>学会高效使用AI，打通AI工作流是未来我们每一个人必备的一门课。</strong></p>
</li>
</ol>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=KS8QwqfPlQw">Unity+AI:The Game Dev Revolution</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.cursor.com/tab/overview">Cursor Doc</a></p>
<p><a target="_blank" rel="noopener" href="https://code.visualstudio.com/docs/other/unity">Unity Development with VS Code</a> </p>
<p><a target="_blank" rel="noopener" href="https://docs.comfy.org/get_started/introduction">ComfyUI</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/AI/">AI</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/AI/">AI</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2024/05/19/视野范围动态刷新/" title="视野范围动态刷新" itemprop="url">视野范围动态刷新</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Tony Tang" target="_blank" itemprop="author">Tony Tang</a>
		
  <p class="article-time">
    <time datetime="2024-05-19T05:36:00.000Z" itemprop="datePublished"> 发表于 2024-05-19</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>一直以来除了学图形学渲染的时候接触到摄像机的坐标系转换，平时对于摄像机照射范围的原理知之甚少。当我们在做可视区域判定时(比如SLG游戏只会创建可视区域范围内的东西)，我们需要计算出当前摄像机的照射范围，然后动态请求可视化区域内需要新增显示的地图对象。实现可视区域动态请求显示这一步离不开对摄像机可视区域的计算。<strong>本文正是为了深入解决可视区域计算，深入理解摄像机照射原理，实现一套可视化摄像机照射区域和动态可视区域物体动态创建的工具。</strong></p>
<h1 id="摄像机"><a href="#摄像机" class="headerlink" title="摄像机"></a>摄像机</h1><p>摄像机目前分为<strong>透视摄像机</strong>和<strong>正交摄像机</strong>，前者有深度概念有透视效果会近大远小，后者忽略深度类似是把3D投射到2D平面的效果。</p>
<p>首先我们来看一下透视摄像机的投影图：</p>
<p><img src="/img/Unity/Camera/PerspectiveCameraPreview.PNG" alt="PerspectiveCameraPreview"></p>
<p>其中<strong>FOV</strong>是透视摄像机里很重要的一个参数，Fov指的是相机视场（Field of View）张角。</p>
<p><strong>FOV</strong>指的是图中的<strong>DFOV</strong>，即<strong>对角线视场角</strong>。</p>
<p><strong>VFOV</strong>指的是<strong>垂直视场角</strong>，VFOV是受屏幕高度影响</p>
<p><strong>HFOV</strong>指的是<strong>水平视场角</strong>，HFOV是受屏幕宽度影响</p>
<h2 id="摄像机照射区域"><a href="#摄像机照射区域" class="headerlink" title="摄像机照射区域"></a>摄像机照射区域</h2><p>摄像机的可见范围计算原理：</p>
<ul>
<li><strong>不考虑摄像机是正交还是透视，通过将屏幕四个角映射到世界坐标系(屏幕坐标到世界坐标)，得到从摄像机到摄像机四个角的射线数据</strong></li>
<li><strong>计算四条射线到在指定平面的交叉点计算，得出的4个交叉点构成的形状就是我们要的透视摄像机在指定平面上的投影形状</strong></li>
</ul>
<p>仅仅是需要知道透视摄像机四条射线的前提下，我们不需要自己去计算DFOV，VFOV，HFOV等数据。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 四个角的视口坐标</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Vector3[] ViewPortPoints = <span class="keyword">new</span> Vector3[<span class="number">5</span>]</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">new</span> Vector3(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>),        <span class="comment">// 左下角</span></span><br><span class="line">    <span class="keyword">new</span> Vector3(<span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>),        <span class="comment">// 左上角</span></span><br><span class="line">    <span class="keyword">new</span> Vector3(<span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>),        <span class="comment">// 右上角</span></span><br><span class="line">    <span class="keyword">new</span> Vector3(<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>),        <span class="comment">// 右下角</span></span><br><span class="line">    <span class="keyword">new</span> Vector3(<span class="number">0.5f</span>, <span class="number">0.5f</span>, <span class="number">0</span>),  <span class="comment">// 中心</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 获取指定摄像机的射线数据列表</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;camera&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;rayCastDataList&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">bool</span> <span class="title">GetCameraRayCastDataList</span>(<span class="params">Camera camera, <span class="keyword">ref</span> List&lt;KeyValuePair&lt;Vector3, Vector3&gt;&gt; rayCastDataList</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    rayCastDataList.Clear();</span><br><span class="line">    <span class="keyword">if</span>(camera == <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        Debug.LogError(<span class="string">$&quot;不允许传递空摄像机组件，获取摄像机的射线数据列表失败！&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> cameraNearClipPlane = camera.nearClipPlane;</span><br><span class="line">    ViewPortPoints[<span class="number">0</span>].z = cameraNearClipPlane;</span><br><span class="line">    ViewPortPoints[<span class="number">1</span>].z = cameraNearClipPlane;</span><br><span class="line">    ViewPortPoints[<span class="number">2</span>].z = cameraNearClipPlane;</span><br><span class="line">    ViewPortPoints[<span class="number">3</span>].z = cameraNearClipPlane;</span><br><span class="line">    ViewPortPoints[<span class="number">4</span>].z = cameraNearClipPlane;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> isOrthographic = camera.orthographic;</span><br><span class="line">    <span class="keyword">if</span>(isOrthographic)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 转换为射线</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; ViewPortPoints.Length; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            Ray ray = camera.ViewportPointToRay(ViewPortPoints[i]);</span><br><span class="line">            <span class="keyword">var</span> rayCastToPoint = ray.origin + ray.direction * camera.farClipPlane;</span><br><span class="line">            <span class="keyword">var</span> rayCastData = <span class="keyword">new</span> KeyValuePair&lt;Vector3, Vector3&gt;(ray.origin, rayCastToPoint);</span><br><span class="line">            rayCastDataList.Add(rayCastData);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> radio = camera.farClipPlane / cameraNearClipPlane;</span><br><span class="line">        <span class="keyword">var</span> cameraPosition = camera.transform.position;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取饰扣四个角的屏幕映射世界坐标</span></span><br><span class="line">        <span class="keyword">var</span> lbNearPlaneWorldPoints = camera.ViewportToWorldPoint(ViewPortPoints[<span class="number">0</span>]);</span><br><span class="line">        <span class="keyword">var</span> ltNearPlaneWorldPoints = camera.ViewportToWorldPoint(ViewPortPoints[<span class="number">1</span>]);</span><br><span class="line">        <span class="keyword">var</span> rtNearPlaneWorldPoints = camera.ViewportToWorldPoint(ViewPortPoints[<span class="number">2</span>]);</span><br><span class="line">        <span class="keyword">var</span> rbNearPlaneWorldPoints = camera.ViewportToWorldPoint(ViewPortPoints[<span class="number">3</span>]);</span><br><span class="line">        <span class="keyword">var</span> ctNearPlaneWorldPoints = camera.ViewportToWorldPoint(ViewPortPoints[<span class="number">4</span>]);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> lbNearPlaneCameraWorldPointDir = lbNearPlaneWorldPoints - cameraPosition;</span><br><span class="line">        <span class="keyword">var</span> ltNearPlaneCameraWorldPointDir = ltNearPlaneWorldPoints - cameraPosition;</span><br><span class="line">        <span class="keyword">var</span> rtNearPlaneCameraWorldPointDir = rtNearPlaneWorldPoints - cameraPosition;</span><br><span class="line">        <span class="keyword">var</span> rbNearPlaneCameraWorldPointDir = rbNearPlaneWorldPoints - cameraPosition;</span><br><span class="line">        <span class="keyword">var</span> ctNearPlaneCameraWorldPointDir = ctNearPlaneWorldPoints - cameraPosition;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> lbFarPlaneWorldPoint = cameraPosition + lbNearPlaneCameraWorldPointDir * radio;</span><br><span class="line">        <span class="keyword">var</span> ltFarPlaneWorldPoint = cameraPosition + ltNearPlaneCameraWorldPointDir * radio;</span><br><span class="line">        <span class="keyword">var</span> rtFarPlaneWorldPoint = cameraPosition + rtNearPlaneCameraWorldPointDir * radio;</span><br><span class="line">        <span class="keyword">var</span> rbFarPlaneWorldPoint = cameraPosition + rbNearPlaneCameraWorldPointDir * radio;</span><br><span class="line">        <span class="keyword">var</span> ctFarPlaneWorldPoint = cameraPosition + ctNearPlaneCameraWorldPointDir * radio;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> lbRayCastData = <span class="keyword">new</span> KeyValuePair&lt;Vector3, Vector3&gt;(lbNearPlaneWorldPoints, lbFarPlaneWorldPoint);</span><br><span class="line">        <span class="keyword">var</span> ltRayCastData = <span class="keyword">new</span> KeyValuePair&lt;Vector3, Vector3&gt;(ltNearPlaneWorldPoints, ltFarPlaneWorldPoint);</span><br><span class="line">        <span class="keyword">var</span> rtRayCastData = <span class="keyword">new</span> KeyValuePair&lt;Vector3, Vector3&gt;(rtNearPlaneWorldPoints, rtFarPlaneWorldPoint);</span><br><span class="line">        <span class="keyword">var</span> rbRayCastData = <span class="keyword">new</span> KeyValuePair&lt;Vector3, Vector3&gt;(rbNearPlaneWorldPoints, rbFarPlaneWorldPoint);        </span><br><span class="line">        <span class="keyword">var</span> ctRayCastData = <span class="keyword">new</span> KeyValuePair&lt;Vector3, Vector3&gt;(ctNearPlaneWorldPoints, ctFarPlaneWorldPoint);        </span><br><span class="line">        rayCastDataList.Add(lbRayCastData);</span><br><span class="line">        rayCastDataList.Add(ltRayCastData);</span><br><span class="line">        rayCastDataList.Add(rtRayCastData);</span><br><span class="line">        rayCastDataList.Add(rbRayCastData);</span><br><span class="line">        rayCastDataList.Add(ctRayCastData);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>得到屏幕四个角映射的射线数据后，利用射线和平面的交叉计算得到指定平面交叉的点就能得到我们要的平面照射区域</li>
</ul>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Vector3Utilities.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Vector3静态工具类</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">Vector3Utilities</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 获取指定射线和平面数据的交叉点(返回null表示没有交叉点)</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;rayOrigin&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;rayDirection&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;planePoint&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;planeNormal&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Vector3? GetRayAndPlaneIntersect(Vector3 rayOrigin, Vector3 rayDirection, Vector3 planePoint, Vector3 planeNormal)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 计算法向量和方向向量的点积</span></span><br><span class="line">        <span class="built_in">float</span> ndotu = Vector3.Dot(planeNormal, rayDirection);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 向量几乎平行，可能没有交点或者射线在平面内</span></span><br><span class="line">        <span class="keyword">if</span> (Mathf.Approximately(Math.Abs(ndotu), Mathf.Epsilon))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 计算 t</span></span><br><span class="line">        Vector3 w = rayOrigin - planePoint;</span><br><span class="line">        <span class="built_in">float</span> t = -Vector3.Dot(planeNormal, w) / ndotu;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 交点在射线起点的后面</span></span><br><span class="line">        <span class="keyword">if</span> (t &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 计算交点</span></span><br><span class="line">        Vector3 intersectionPoint = rayOrigin + t * rayDirection;</span><br><span class="line">        <span class="keyword">return</span> intersectionPoint;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 获取指定摄像机指定区域顶点和法线的的可视区域顶点数据</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;camera&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;areaPoint&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;areaNormal&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;areaPointsList&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;rectPointList&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">bool</span> <span class="title">GetCameraVisibleArea</span>(<span class="params">Camera camera, Vector3 areaPoint, Vector3 areaNormal, <span class="keyword">ref</span> List&lt;Vector3&gt; areaPointsList, <span class="keyword">ref</span> List&lt;Vector3&gt; rectPointList</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    areaPointsList.Clear();</span><br><span class="line">    rectPointList.Clear();</span><br><span class="line">    <span class="keyword">if</span> (camera == <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        Debug.LogError(<span class="string">$&quot;不允许传递空摄像机组件，获取摄像机的可视区域顶点数据失败！&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    RayCastDataList.Clear();</span><br><span class="line">    GetCameraRayCastDataList(camera, <span class="keyword">ref</span> RayCastDataList);</span><br><span class="line">    <span class="keyword">foreach</span>(<span class="keyword">var</span> rayCastData <span class="keyword">in</span> RayCastDataList)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> rayCastDirection = rayCastData.Value - rayCastData.Key;</span><br><span class="line">        <span class="keyword">var</span> areaData = Vector3Utilities.GetRayAndPlaneIntersect(rayCastData.Key, rayCastDirection, areaPoint, areaNormal);</span><br><span class="line">        <span class="keyword">if</span>(areaData != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            areaPointsList.Add((Vector3)areaData);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    rectPointList.Add(<span class="keyword">new</span> Vector3(areaPointsList[<span class="number">1</span>].x, areaPointsList[<span class="number">0</span>].y, areaPointsList[<span class="number">0</span>].z));</span><br><span class="line">    rectPointList.Add(<span class="keyword">new</span> Vector3(areaPointsList[<span class="number">1</span>].x, areaPointsList[<span class="number">1</span>].y, areaPointsList[<span class="number">1</span>].z));</span><br><span class="line">    rectPointList.Add(<span class="keyword">new</span> Vector3(areaPointsList[<span class="number">2</span>].x, areaPointsList[<span class="number">2</span>].y, areaPointsList[<span class="number">2</span>].z));</span><br><span class="line">    rectPointList.Add(<span class="keyword">new</span> Vector3(areaPointsList[<span class="number">2</span>].x, areaPointsList[<span class="number">3</span>].y, areaPointsList[<span class="number">3</span>].z));</span><br><span class="line">    rectPointList.Add(areaPointsList[<span class="number">4</span>]);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从上面可以看到无论是areaPointsList还是rectPointList都返回了5个顶点数据，第五个是屏幕中心映射的点。</p>
<p><strong>之所以返回矩形的映射区域，是为了简化后面透视摄像机梯形判定顶点复杂度，简化成AABB和点的交叉判定。</strong></p>
<h2 id="摄像机照射区域可视化"><a href="#摄像机照射区域可视化" class="headerlink" title="摄像机照射区域可视化"></a>摄像机照射区域可视化</h2><p>得到了屏幕映射的顶点数据，通过构建线条数据，我们就能利用GUI相关接口画出可视化可见区域了</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 区域顶点</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">Header(<span class="string">&quot;区域顶点&quot;</span>)</span>]</span><br><span class="line"><span class="keyword">public</span> Vector3 AreaPoint = Vector3.zero;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 区域法线</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">Header(<span class="string">&quot;区域法线&quot;</span>)</span>]</span><br><span class="line"><span class="keyword">public</span> Vector3 AreaNormal = Vector3.up;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 更新摄像机指定平面映射区域数据</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">UpdateAreaDatas</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    CameraUtilities.GetCameraRayCastDataList(mCameraComponent, <span class="keyword">ref</span> mRayCastDataList);</span><br><span class="line">    CameraUtilities.GetCameraVisibleArea(mCameraComponent, AreaPoint, AreaNormal, <span class="keyword">ref</span> mAreaPointsList, <span class="keyword">ref</span> mRectAreaPointsList);</span><br><span class="line">    mAreaLinesList.Clear();</span><br><span class="line">    mRectAreaLinesList.Clear();</span><br><span class="line">    <span class="keyword">if</span>(mAreaPointsList.Count &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> lbToLtLine = <span class="keyword">new</span> KeyValuePair&lt;Vector3, Vector3&gt;(mAreaPointsList[<span class="number">0</span>], mAreaPointsList[<span class="number">1</span>]);</span><br><span class="line">        <span class="keyword">var</span> ltToRtLine = <span class="keyword">new</span> KeyValuePair&lt;Vector3, Vector3&gt;(mAreaPointsList[<span class="number">1</span>], mAreaPointsList[<span class="number">2</span>]);</span><br><span class="line">        <span class="keyword">var</span> rtToRbLine = <span class="keyword">new</span> KeyValuePair&lt;Vector3, Vector3&gt;(mAreaPointsList[<span class="number">2</span>], mAreaPointsList[<span class="number">3</span>]);</span><br><span class="line">        <span class="keyword">var</span> rbToLbLine = <span class="keyword">new</span> KeyValuePair&lt;Vector3, Vector3&gt;(mAreaPointsList[<span class="number">3</span>], mAreaPointsList[<span class="number">0</span>]);</span><br><span class="line">        mAreaLinesList.Add(lbToLtLine);</span><br><span class="line">        mAreaLinesList.Add(ltToRtLine);</span><br><span class="line">        mAreaLinesList.Add(rtToRbLine);</span><br><span class="line">        mAreaLinesList.Add(rbToLbLine);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> rectLbToLtLine = <span class="keyword">new</span> KeyValuePair&lt;Vector3, Vector3&gt;(mRectAreaPointsList[<span class="number">0</span>], mRectAreaPointsList[<span class="number">1</span>]);</span><br><span class="line">        <span class="keyword">var</span> rectLtToRtLine = <span class="keyword">new</span> KeyValuePair&lt;Vector3, Vector3&gt;(mRectAreaPointsList[<span class="number">1</span>], mRectAreaPointsList[<span class="number">2</span>]);</span><br><span class="line">        <span class="keyword">var</span> rectRtToRbLine = <span class="keyword">new</span> KeyValuePair&lt;Vector3, Vector3&gt;(mRectAreaPointsList[<span class="number">2</span>], mRectAreaPointsList[<span class="number">3</span>]);</span><br><span class="line">        <span class="keyword">var</span> rectRbToLbLine = <span class="keyword">new</span> KeyValuePair&lt;Vector3, Vector3&gt;(mRectAreaPointsList[<span class="number">3</span>], mRectAreaPointsList[<span class="number">0</span>]);</span><br><span class="line">        mRectAreaLinesList.Add(rectLbToLtLine);</span><br><span class="line">        mRectAreaLinesList.Add(rectLtToRtLine);</span><br><span class="line">        mRectAreaLinesList.Add(rectRtToRbLine);</span><br><span class="line">        mRectAreaLinesList.Add(rectRbToLbLine);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 绘制区域信息Gizmos</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">DrawAreaInfoGUI</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> preGizmosColor = Gizmos.color;</span><br><span class="line">    Gizmos.color = Color.green;</span><br><span class="line">    Gizmos.DrawSphere(AreaPoint, SphereSize);</span><br><span class="line">    <span class="keyword">var</span> areaPointTo = AreaPoint + AreaNormal * <span class="number">5</span>;</span><br><span class="line">    Gizmos.DrawLine(AreaPoint, areaPointTo);</span><br><span class="line">    Gizmos.color = preGizmosColor;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 绘制矩形区域</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">DrawRectAreaGUI</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> preGizmosColor = Gizmos.color;</span><br><span class="line">    Gizmos.color = <span class="keyword">new</span> Color(<span class="number">0</span>, <span class="number">0.5f</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(mRectAreaLinesList.Count &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        Gizmos.DrawLine(mRectAreaLinesList[<span class="number">0</span>].Key, mRectAreaLinesList[<span class="number">0</span>].Value);</span><br><span class="line">        Gizmos.DrawLine(mRectAreaLinesList[<span class="number">1</span>].Key, mRectAreaLinesList[<span class="number">1</span>].Value);</span><br><span class="line">        Gizmos.DrawLine(mRectAreaLinesList[<span class="number">2</span>].Key, mRectAreaLinesList[<span class="number">2</span>].Value);</span><br><span class="line">        Gizmos.DrawLine(mRectAreaLinesList[<span class="number">3</span>].Key, mRectAreaLinesList[<span class="number">3</span>].Value);</span><br><span class="line">    &#125;</span><br><span class="line">    Gizmos.color = preGizmosColor;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 绘制区域Gizmos</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">DrawAreaGUI</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> preGizmosColor = Gizmos.color;</span><br><span class="line">    Gizmos.color = Color.green;</span><br><span class="line">    <span class="keyword">if</span>(mAreaLinesList.Count &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        Gizmos.DrawLine(mAreaLinesList[<span class="number">0</span>].Key, mAreaLinesList[<span class="number">0</span>].Value);</span><br><span class="line">        Gizmos.DrawLine(mAreaLinesList[<span class="number">1</span>].Key, mAreaLinesList[<span class="number">1</span>].Value);</span><br><span class="line">        Gizmos.DrawLine(mAreaLinesList[<span class="number">2</span>].Key, mAreaLinesList[<span class="number">2</span>].Value);</span><br><span class="line">        Gizmos.DrawLine(mAreaLinesList[<span class="number">3</span>].Key, mAreaLinesList[<span class="number">3</span>].Value);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(mAreaPointsList.Count &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        Gizmos.DrawSphere(mAreaPointsList[<span class="number">4</span>], SphereSize);</span><br><span class="line">    &#125;</span><br><span class="line">    Gizmos.color = preGizmosColor;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>摄像机照射区域可视化：</p>
<p><img src="/img/Unity/MapEditor/CameraAreaVisualization.PNG" alt="CameraAreaVisualization"></p>
<p><strong>可以看到黄色是远截面照射区域，深绿色是近截面照射区域，浅绿色是摄像机近截面换算成矩形后的区域，红色线条是摄像机近截面和远截面射线，</strong></p>
<p>透视摄像机效果如下:</p>
<p><img src="/img/Unity/Camera/CameraRayCastVisualization.PNG" alt="CameraRayCastVisualization"></p>
<p>正交摄像机效果如下:</p>
<p><img src="/img/Unity/Camera/OrthographicCameraVisualization.PNG" alt="OrthographicCameraVisualization"></p>
<h2 id="摄像机照射区域动态刷新"><a href="#摄像机照射区域动态刷新" class="headerlink" title="摄像机照射区域动态刷新"></a>摄像机照射区域动态刷新</h2><p>动态区域刷新核心要点:</p>
<ol>
<li><strong>映射屏幕4个点得到四条摄像机照射射线，通过计算4条射线与指定平面的交叉点得到照射区域，简化照射区域形状到矩形，将物体是否在照射区域转换成点与AABB交叉判定</strong></li>
</ol>
<p>实战摄像机照射区域动态刷新参考地图编辑器:</p>
<p><a target="_blank" rel="noopener" href="https://github.com/TonyTang1990/MapEditor">MapEditor</a></p>
<p>实战效果图：</p>
<p><img src="/img/Unity/MapEditor/DynamicCreateMapData1.PNG" alt="DynamicCreateMapData1"></p>
<p><img src="/img/Unity/MapEditor/DynamicCreateMapData2.PNG" alt="DynamicCreateMapData2"></p>
<p>Note:</p>
<ol>
<li><strong>屏幕4个顶点计算顺序依次是左下，左上，右上，右下</strong></li>
</ol>
<h2 id="重点知识"><a href="#重点知识" class="headerlink" title="重点知识"></a>重点知识</h2><ol>
<li><strong>不考虑摄像机是正交还是透视，通过将屏幕四个角映射到世界坐标系(屏幕坐标到世界坐标)，得到从摄像机到摄像机四个角的射线数据，然后将摄像机区域计算转换成计算四条射线到在指定平面的交叉点计算，得出的4个交叉点构成的形状就是我们要的透视摄像机在指定平面上的投影形状</strong></li>
<li><strong>FOV分为DFOV(对角线视场角)，VFOV(垂直视场角，受屏幕高度影响)和HFOV(水平视场角，受屏幕宽度影响)</strong></li>
<li><strong>透视摄像机看多少不仅受FOV影响还受屏幕分辨率影响</strong></li>
<li><strong>摄像机指定位置平面照射形状可以转换成摄像机4个射线和平面的相交检测处理</strong></li>
</ol>
<h1 id="博客"><a href="#博客" class="headerlink" title="博客"></a>博客</h1><p><a href="https://tonytang1990.github.io/2024/04/23/%E5%9C%B0%E5%9B%BE%E7%BC%96%E8%BE%91%E5%99%A8/">地图编辑器</a></p>
<h1 id="GitHub"><a href="#GitHub" class="headerlink" title="GitHub"></a>GitHub</h1><p><a target="_blank" rel="noopener" href="https://github.com/TonyTang1990/MapEditor">MapEditor</a></p>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/679453452">根据相机参数计算视场角（Filed of View, FOV）</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/graphics/archive/2009/10/17/1585281.html">摄像与平面的相交检测(Ray-Plane intersection test)</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/huangkangying/article/details/108393392">浅析相机FOV</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/395006317">Fov数值推荐设置</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Math/">Math</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Math/">Math</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2024/04/23/地图编辑器/" title="地图编辑器" itemprop="url">地图编辑器</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Tony Tang" target="_blank" itemprop="author">Tony Tang</a>
		
  <p class="article-time">
    <time datetime="2024-04-23T10:27:00.000Z" itemprop="datePublished"> 发表于 2024-04-23</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>游戏开发过程中，我们搭建关卡时需要一个工具去支持摆放场景物件和数据埋点编辑，从而支持快速搭建关卡和策划数据埋点。这一工具正是本章节需要实现的地图编辑器。</p>
<h1 id="地图编辑器"><a href="#地图编辑器" class="headerlink" title="地图编辑器"></a>地图编辑器</h1><h2 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h2><p>实现一个工具，首先第一步，我们还是需要理清需求：</p>
<ol>
<li>纯Editor地图编辑器，用于<strong>场景编辑</strong>和<strong>数据埋点</strong>。</li>
<li>支持自定义场景对象数据和自由摆放场景对象进行场景编辑，场景对象支持<strong>静态摆放</strong>和<strong>动态创建</strong>两种。</li>
<li>支持自定义<strong>埋点数据</strong>和<strong>自由摆放埋点数据</strong>进行数据埋点编辑。</li>
<li>支持自定义调整场景大小以及场景地形指定和大小自动适配。</li>
<li>场景数据和埋点数据支持导出自定义数据格式(比如Lua,Json等)。</li>
<li>同一个场景支持编辑多个场景编辑和数据埋点。</li>
</ol>
<h2 id="设计实现"><a href="#设计实现" class="headerlink" title="设计实现"></a>设计实现</h2><p>接下来针对前面提到的需求，我们一一分析我们应该用什么方案和技术来实现。</p>
<p>实现思路：</p>
<ol>
<li>地图编辑器主要由<strong>地图编辑器配置窗口</strong>和<strong>地图编辑器挂在操作脚本</strong>Inspector组成。</li>
<li>地图编辑器编辑数据分为两大类(1. <strong>地图编辑</strong> 2. <strong>数据埋点</strong>)。</li>
<li>继承EditorWindow实现场景编辑和数据埋点的基础数据配置编辑。</li>
<li>继承Editor自定义Inspector面板实现纯单个场景编辑和数据埋点操作。</li>
<li>地图编辑操作通过挂在脚本(<strong>Map.cs</strong>)的方式作为单个场景编辑和数据埋点单位，从而实现单个场景多个场景编辑和数据埋点支持。</li>
<li>场景对象编辑采用直接创建实体GameObject的方式，从而实现场景编辑完成后的场景可直接用于作为场景使用。</li>
<li>场景对象编辑通过自定义Inspector面板实现快速删除和创建场景对象GameObject实现场景对象的编辑。</li>
<li>数据埋点采用Gizmos(Monobehaviour:OnDrawGizmos())，Handles(Editor.OnSceneGUI())实现可视化编辑对象和相关数据显示，自定义场景大小配置网格显示也是用Gizmos实现。</li>
<li>地图编辑器配置窗口用于配置基础的场景数据和埋点数据配置，<strong>Map.cs</strong>的挂在脚本通过自定义数据结构和自定义面板显示实现自定义数据配置。</li>
<li><strong>场景静态对象</strong>相关数据通过挂在<strong>MapObjectDataMono</strong>脚本存储相关对象数据。</li>
<li>导出前通过<strong>Map.cs</strong>存储的数据构建自定义数据(<strong>MapExport.cs</strong>)实现自定义数据导出</li>
<li><strong>大地图未来有需求可以做成所有静态对象通过导出数据根据逻辑加载的方式实现按需加载。</strong></li>
</ol>
<p>核心思路和技术实现方案都在上面介绍了，这里就不一一介绍代码实现了，这里只放部分关键代码，让我们直接实战看效果，需要源码的直接在文章末尾Github链接去取即可。</p>
<h2 id="配置窗口"><a href="#配置窗口" class="headerlink" title="配置窗口"></a>配置窗口</h2><p>配置窗口主要负责实现对地图编辑对象，地图编辑埋点的基础数据定义，一些相关操作按钮和全局配置。</p>
<h3 id="配置定义"><a href="#配置定义" class="headerlink" title="配置定义"></a>配置定义</h3><p>地图配置数据结构定义:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> MapSetting.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MapSetting</span> : <span class="title">ScriptableObject</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> UNITY_EDITOR</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Editor下的地图配置单例对象</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> MapSetting EditorSingleton;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 获取Editor地图配置单例对象</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> MapSetting <span class="title">GetEditorInstance</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(EditorSingleton == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            EditorSingleton = MapUtilities.LoadOrCreateGameMapSetting();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> EditorSingleton;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 默认地图横向大小</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;默认地图横向大小&quot;</span>)</span>]</span><br><span class="line">    [<span class="meta">Range(1, 1000)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> DefaultMapWidth = MapConst.DefaultMapWidth;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 默认地图纵向大小</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;默认地图纵向大小&quot;</span>)</span>]</span><br><span class="line">    [<span class="meta">Range(1, 1000)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> DefaultMapHeight = MapConst.DefaultMapHeight;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 地图对象配置数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;地图对象配置数据&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> MapObjectSetting ObjectSetting = <span class="keyword">new</span> MapObjectSetting();</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 地图埋点配置数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;地图埋点配置数据&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> MapDataSetting DataSetting = <span class="keyword">new</span> MapDataSetting();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>地图对象配置定义:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> MapObjectType.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 地图对象类型枚举</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="built_in">enum</span> MapObjectType</span><br><span class="line">&#123;</span><br><span class="line">    Scene = <span class="number">0</span>,                  <span class="comment">// 场景</span></span><br><span class="line">    Door = <span class="number">1</span>,                   <span class="comment">// 门</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> MapObjectSetting.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 地图对象设置数据</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">Serializable</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MapObjectSetting</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 所有地图对象类型配置数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;所有地图对象类型配置数据&quot;</span>)</span>]</span><br><span class="line">    [<span class="meta">SerializeReference</span>]</span><br><span class="line">    <span class="keyword">public</span> List&lt;MapObjectTypeConfig&gt; AllMapObjectTypeConfigs = <span class="keyword">new</span> List&lt;MapObjectTypeConfig&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 所有地图对象配置数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;所有地图对象配置数据&quot;</span>)</span>]</span><br><span class="line">    [<span class="meta">SerializeReference</span>]</span><br><span class="line">    <span class="keyword">public</span> List&lt;MapObjectConfig&gt; AllMapObjectConfigs = <span class="keyword">new</span> List&lt;MapObjectConfig&gt;();</span><br><span class="line">    </span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> MapObjectConfig.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 地图对象数据配置</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">Serializable</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MapObjectConfig</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 唯一ID(用于标识地图对象配置唯一)</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;唯一ID&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> UID;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 地图对象类型</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;地图对象类型&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> MapObjectType ObjectType;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 是否是动态地图对象</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;是否是动态地图对象&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">bool</span> IsDynamic;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 关联Id</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;关联Id&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> ConfId;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 资源Asset</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;资源Asset&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> GameObject Asset;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 描述</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;描述&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Des;</span><br><span class="line">    </span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>地图埋点配置定义:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> MapDataType.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 地图数据埋点类型枚举</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="built_in">enum</span> MapDataType</span><br><span class="line">&#123;</span><br><span class="line">    PlayerSpawn = <span class="number">0</span>,           <span class="comment">// 玩家出生点位置数据</span></span><br><span class="line">    Monster = <span class="number">1</span>,               <span class="comment">// 怪物数据</span></span><br><span class="line">    TreasureBox = <span class="number">2</span>,           <span class="comment">// 宝箱数据</span></span><br><span class="line">    Trap = <span class="number">3</span>,                  <span class="comment">// 陷阱数据</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> MapDataSetting.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 地图数据配置数据</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">Serializable</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MapDataSetting</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 所有地图埋点数据配置</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;所有地图埋点数据配置&quot;</span>)</span>]</span><br><span class="line">    [<span class="meta">SerializeReference</span>]</span><br><span class="line">    <span class="keyword">public</span> List&lt;MapDataConfig&gt; AlllMapDataConfigs = <span class="keyword">new</span> List&lt;MapDataConfig&gt;();</span><br><span class="line"></span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> MapDataConfig.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 地图埋点数据配置</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">Serializable</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MapDataConfig</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 唯一ID(用于标识地图埋点配置唯一)</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;唯一ID&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> UID;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 地图数据类型</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;地图数据类型&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> MapDataType DataType;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 关联Id</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;关联Id&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> ConfId;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 场景球体颜色</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;场景球体颜色&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> Color SceneSphereColor = Color.red;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 描述</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;描述&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Des;</span><br><span class="line">    </span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>配置定义设计如下:</p>
<ol>
<li><strong>MapSetting是地图编辑器配置数据结构定义，继承至ScriptableObject，保存到Editor</strong></li>
<li><strong>MapObjectSetting是地图对象的所有编辑器配置结构定义。MapObjectConfig是地图对象编辑器单条配置结构定义。MapObjectType是地图对象类型定义。</strong></li>
<li><strong>MapDataSetting是地图埋点的所有编辑器配置结构定义。MapDataConfig是地图埋点编辑器单条配置结构定义。MapDataType是地图埋点类型定义。</strong></li>
</ol>
<h3 id="配置窗口-1"><a href="#配置窗口-1" class="headerlink" title="配置窗口"></a>配置窗口</h3><p>可以看到在地图编辑器窗口主要分为4个区域：</p>
<ol>
<li><strong>快捷按钮区域</strong></li>
<li><strong>自定义地图基础数据区域(e.g. 默认地图宽高)</strong></li>
<li><strong>地图对象配置区域</strong></li>
<li><strong>地图埋点配置区域</strong></li>
</ol>
<p>以上配置数据会成为我们后面操作编辑Inspector里用户可以添加操作的基础数据来源，详细代码参见<strong>MapEditorWindow.cs</strong>。</p>
<h4 id="快捷按钮区域"><a href="#快捷按钮区域" class="headerlink" title="快捷按钮区域"></a>快捷按钮区域</h4><p>效果图：</p>
<p><img src="/img/Unity/MapEditor/ShortcutOperationArea.PNG" alt="ShortcutOperationArea"></p>
<p>可以看到目前提供了三个快捷按钮：</p>
<ol>
<li><strong>保存地图配置数据</strong> – 用于确保我们在配置窗口的数据配置修改保存到本地ScriptableObject Asset</li>
<li><strong>打开地图编辑场景</strong> – 用于帮助我们快速打开辅助地图编辑的场景</li>
<li><strong>快速选中地图地编对象</strong> – 用于帮助我们快速选中当前场景里第一个带Map.cs脚本的对象，方便快速进入Map.cs的Inspector操作面板操作</li>
<li><strong>一键导出所有地图</strong> – 用于一键导出所有编辑好的地图埋点数据</li>
<li><strong>一键烘焙导出所有地图</strong> – 用于一键烘焙所有场景和导出所有编辑好的地图埋点数据</li>
</ol>
<h4 id="自定义地图数据区域"><a href="#自定义地图数据区域" class="headerlink" title="自定义地图数据区域"></a>自定义地图数据区域</h4><p>效果图：</p>
<p><img src="/img/Unity/MapEditor/CustomDataSettingArea.PNG" alt="CustomDataSettingArea"></p>
<p>自定义数据目前只支持了默认创建地图编辑宽高配置(挂在Map.cs脚本时默认创建的地图横向竖向大小数据来源)。</p>
<p>未来扩展更多基础配置数据在这里添加。</p>
<h4 id="地图对象配置区域"><a href="#地图对象配置区域" class="headerlink" title="地图对象配置区域"></a>地图对象配置区域</h4><p>效果图：</p>
<p><img src="/img/Unity/MapEditor/MapObjectConfigArea.PNG" alt="MapObjectConfigArea"></p>
<p>地图对象配置设计如下:</p>
<ol>
<li><p><strong>以UID作为唯一配置Id标识(不允许重复)，此Id会作为我们编辑器地图对象配置数据读取的依据。</strong></p>
</li>
<li><p><strong>通过MapObjectType指定地图对象类型。</strong></p>
</li>
<li><p><strong>通过定义ConfId(关联配置Id)实现关联游戏内动态对象Id的功能。</strong></p>
</li>
<li><p><strong>地图对象编辑通过定义Asset实现指定自定义预制件Asset作为实体对象的资源对象。</strong></p>
</li>
<li><p><strong>描述用于方便用户自定义取名，方便识别不同的地图对象配置。</strong></p>
</li>
</ol>
<p>Note:</p>
<ol>
<li><strong>需要参与导出的地图基础配置数据如果修改了(比如关联配置Id)，对应用到此基础配置数据的关卡都需要重新导出。</strong></li>
<li><strong>MapObjectType需要代码自定义扩展后，编辑器才有更多选项</strong></li>
</ol>
<h4 id="地图埋点配置区域"><a href="#地图埋点配置区域" class="headerlink" title="地图埋点配置区域"></a>地图埋点配置区域</h4><p>效果图：</p>
<p><img src="/img/Unity/MapEditor/MapDataConfigArea.PNG" alt="MapDataConfigArea"></p>
<p>地图埋点配置设计如下:</p>
<ol>
<li><strong>以UID作为唯一配置Id标识(不允许重复)，此Id会作为我们编辑器地图埋点配置数据读取的依据。</strong></li>
<li><strong>通过MapDataType指定地图埋点类型。</strong></li>
<li><strong>通过定义ConfId(关联配置Id)实现关联游戏内动态对象Id的功能。</strong></li>
<li><strong>场景球体颜色用于配置地图埋点的GUI球体绘制颜色配置。</strong></li>
<li><strong>初始旋转用于配置地图埋点添加时的初始旋转配置(方便自定义大部分用到的初始宣旋转数据)</strong></li>
<li><strong>描述用于方便用户自定义取名，方便识别不同的地图埋点配置。</strong></li>
</ol>
<p>Note:</p>
<ol>
<li><strong>MapDataType需要代码自定义扩展后，编辑器才有更多选项</strong></li>
</ol>
<h2 id="操作编辑Inspector"><a href="#操作编辑Inspector" class="headerlink" title="操作编辑Inspector"></a>操作编辑Inspector</h2><p>操作编辑Inspector主要负责实现对地图编辑对象和地图编辑埋点的一些相关操作面板，可视化GUI数据绘制，地图编辑自定义基础数据配置以及一些快捷操作按钮，详细代码参见<strong>Map.cs和MapEditor.cs</strong>。</p>
<h3 id="基础数据配置区域"><a href="#基础数据配置区域" class="headerlink" title="基础数据配置区域"></a>基础数据配置区域</h3><p>基础数据配置区域用于GUI开关，地图大小，地图起始位置，自定义地形等配置。</p>
<p>效果图:</p>
<p><img src="/img/Unity/MapEditor/BasicDataConfigInspectorArea.PNG" alt="BasicDataConfigInspectorArea"></p>
<p>自定义配置区域介绍：</p>
<ol>
<li><strong>场景GUI总开关</strong> – 所有绘制GUI的总开关</li>
<li><strong>地图线条GUI开关</strong> – 控制地图N*N的线条GUI绘制开关</li>
<li><strong>地图对象场景GUI开关</strong> – 控制地图对象相关的GUI绘制开关</li>
<li><strong>地图埋点场景GUI开关</strong> – 控制地图埋点相关的GUI绘制开关</li>
<li><strong>地图对象创建自动聚焦开关</strong> – 控制地图对象创建后是否需要自动聚焦选中</li>
<li><strong>地图横向大小和地图纵向大小</strong> – 用于控制我们需要编辑的关卡地图的大小，会影响默认地图或自定义地图的大小和平铺</li>
<li><strong>游戏地图起始位置</strong> – 用于控制关卡的起始位置偏移，方便支持自定义不同起始位置的关卡设置</li>
</ol>
<h3 id="快捷操作按钮区域"><a href="#快捷操作按钮区域" class="headerlink" title="快捷操作按钮区域"></a>快捷操作按钮区域</h3><p>快捷操作按钮区域用于支持自定义功能。</p>
<p>效果图:</p>
<p><img src="/img/Unity/MapEditor/ShortcutOperationInspectorArea.PNG" alt="ShortcutOperationInspectorArea"></p>
<p>快捷按钮功能介绍：</p>
<ol start="3">
<li><strong>拷贝NavMesh Asset按钮</strong> – NavMeshSurface默认烘焙Asset保存在对应场景同层目录，此按钮用于快速拷贝对应Asset到对应关卡预制件同层目录</li>
<li><strong>一键重创地图对象按钮</strong> – 用于我们更新了某些已经创建好的静态地图对象(脱离预制件关联)相关资源后一键确保使用最新资源创建</li>
<li><strong>导出地图数据按钮</strong> – 用于完成我们的关卡数据序列化导出</li>
<li><strong>保存关卡数据</strong> – 用于独立保存关卡埋点相关数据(支持自定义名字，默认和预制件同名)</li>
<li><strong>一键烘焙拷贝导出</strong> – 用于一键完成恢复动态对象+烘培寻路+拷贝寻路+清除动态对象+导出地图数据操作</li>
</ol>
<p>Note:</p>
<ol>
<li><strong>场景对象是否参与寻路烘培，通过修改预制件Layer和NavMeshSurface的寻路烘培的Layer决定</strong></li>
<li><strong>大部分操作在实体对象做成预制件后需要进入预制件编辑模式，所以部分操作会根据脚本所在实体对象情况决定是否自动进入预制件编辑模式</strong></li>
</ol>
<h3 id="地图对象编辑区域"><a href="#地图对象编辑区域" class="headerlink" title="地图对象编辑区域"></a>地图对象编辑区域</h3><p>效果图:</p>
<p><img src="/img/Unity/MapEditor/MapObjectConfigInspectorArea.PNG" alt="MapObjectConfigInspectorArea"></p>
<p>地图对象数据定义：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> MapObjectData.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 地图对象数据</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">Serializable</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MapObjectData</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 唯一Id(用于标识地图对象配置唯一)</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;唯一Id&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> UID;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 实体对象</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;实体对象&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> GameObject Go;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 埋点位置(地图对象可能删除还原，所以需要逻辑层面记录位置)</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;埋点位置&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> Vector3 Position;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 旋转(地图对象可能删除还原，所以需要逻辑层面记录旋转)</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;旋转&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> Vector3 Rotation = Vector3.zero;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 本地缩放(地图对象可能删除还原，所以需要逻辑层面记录缩放)</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;缩放&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> Vector3 LocalScale = Vector3.one;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 碰撞器中心点</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;碰撞器中心点&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> Vector3 ColliderCenter = <span class="keyword">new</span> Vector3(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 碰撞器大小</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;碰撞器大小&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> Vector3 ColliderSize = <span class="keyword">new</span> Vector3(<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 碰撞体半径</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;碰撞体半径&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">float</span> ColliderRadius = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 带参构造函数</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;uid&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;go&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MapObjectData</span>(<span class="params"><span class="built_in">int</span> uid, GameObject go</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        UID = uid;</span><br><span class="line">        Go = go;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>地图对象编辑通过选择<strong>地图对象类型</strong>和<strong>地图对象选择</strong>决定要添加的地图对象配置。</p>
<p>地图对象编辑和地图对象选择后面的**+<strong>默认是</strong>添加到地图对象数据列表尾部**。</p>
<p>地图对象数据列表后的操作可以对已经配置的地图对象数据进行相关操作，此处的**+<strong>号是将选择的地图对象类型和地图对象选择</strong>插入的当前数据位置**。</p>
<p>Note:</p>
<ol>
<li><p><strong>地图对象可以通过地图对象配置面板配置的关联id导出给程序实现动态对象的配置关联</strong></p>
</li>
<li><p><strong>地图对象的数据关联是通过挂在MapObjectDataMono.cs脚本实现</strong></p>
</li>
<li><p><strong>未来如果地图对象要想实现按需加载可以通过导出地图对象数据给程序动态加载实现，相关代码参考MapObjectExport.cs相关代码(不分代码注释着)</strong></p>
</li>
</ol>
<h3 id="地图埋点编辑区域"><a href="#地图埋点编辑区域" class="headerlink" title="地图埋点编辑区域"></a>地图埋点编辑区域</h3><p>效果图:</p>
<p><img src="/img/Unity/MapEditor/MapDataConfigInspectorArea.PNG" alt="MapDataConfigInspectorArea"></p>
<p>地图埋点数据定义：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> MapData.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 地图数据买点数据</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">Serializable</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MapData</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 唯一Id(用于标识地图对象配置唯一)</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;唯一Id&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> UID;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 埋点位置</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;埋点位置&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> Vector3 Position;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 埋点旋转</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;埋点旋转&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> Vector3 Rotation;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 批量操作开关</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;批量操作开关&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">bool</span> BatchOperationSwitch;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> GUI关闭开关</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;GUI关闭开关&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">bool</span> GUISwitchOff = <span class="literal">false</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MapData</span>(<span class="params"><span class="built_in">int</span> uid</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        UID = uid;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MapData</span>(<span class="params"><span class="built_in">int</span> uid, Vector3 position, Vector3 rotation</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        UID = uid;</span><br><span class="line">        Position = position;</span><br><span class="line">        Rotation = rotation;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>地图埋点编辑通过选择<strong>地图埋点类型</strong>和<strong>地图埋点选择</strong>决定要添加的地图埋点配置。</p>
<p>地图埋点编辑和地图埋点选择后面的**+<strong>默认是</strong>添加到地图埋点数据列表尾部**。</p>
<p>地图埋点数据列表后的操作可以对已经配置的地图埋点数据进行相关操作，此处的**+<strong>号是将选择的地图埋点类型和地图对象选择</strong>插入的当前数据位置**。</p>
<p><strong>地图埋点支持批量操作位置</strong>，通过勾选批量选项决定哪些地图埋点数据要一起操作位置，然后操作(拖拽或者输入坐标)勾选了批量的地图埋点对象的位置，可以实现一起修改勾选了批量操作的地图埋点位置。</p>
<p><strong>一键清除批量勾选按钮</strong> – 用于快速取消所有已勾选批量的地图埋点数据</p>
<p>快捷键操作:</p>
<p><strong>前提:选中挂载Map脚本的GameObject</strong></p>
<p><strong>Scene场景里按住W键会看到埋点数据位置的坐标轴，然后就可以直接拖拽位置。</strong></p>
<p><strong>Scene场景里按住E键会看到埋点数据旋转的坐标轴，然后就可以直接拖拽旋转。</strong></p>
<p>Note:</p>
<ol>
<li><strong>地图数据的编辑和导出是按Map.cs脚本为单位。</strong></li>
<li><strong>地图埋点数据时通过Editor GUI(e.g. Handles和Gimoz)绘制的</strong></li>
<li><strong>地图埋点的位置调整需要按住W按键，旋转调整需要按住E按键</strong></li>
<li><strong>地图埋点支持配置自定义数据，这部分可以参考Monster埋点的自定义数据配置</strong></li>
<li><strong>地图埋点通过地图埋点配置面板配置的关联id导出给程序实现地图埋点的配置关联</strong></li>
<li><strong>自定义数据埋点可视化可以通过扩展MapEditor.cs实现自定义绘制</strong></li>
</ol>
<h3 id="寻路烘培"><a href="#寻路烘培" class="headerlink" title="寻路烘培"></a>寻路烘培</h3><p>目前<strong>场景编辑</strong>是以<strong>Map.cs</strong>为单位。所以<strong>寻路烘培</strong>目前也是按<strong>Map.cs所在预制件为单位</strong>。</p>
<p>通过每个Map.cs所在GameObject挂在<strong>NavMeshSurface</strong>组件实现对当前GameObject的寻路烘培。</p>
<p>效果图:</p>
<p><img src="/img/Unity/MapEditor/NavigationBakePreview.PNG" alt="NavigationBakePreview"></p>
<p>Note:</p>
<ol>
<li><strong>NavMeshSurface设置Collect Objects为Children(只有子节点参与烘培)，参与烘培的Include Layers设置成自定义的实现是否参与烘培的Layer规则。</strong></li>
</ol>
<h3 id="数据导出"><a href="#数据导出" class="headerlink" title="数据导出"></a>数据导出</h3><p>数据导出是通过点击<strong>导出地图数据按钮</strong>或者<strong>一键烘培拷贝导出按钮</strong>实现的。</p>
<p><strong>为了支持多种不同数据格式的导出，在数据导出之前我进行导出数据的定义和抽象。</strong></p>
<p><strong>地图导出数据结构</strong>定义:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> MapExport.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 地图导出数据结构定义(统一导出结构定义，方便支持导出不同的数据格式)</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">Serializable</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MapExport</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 地图导出数据成员</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> MapDataExport MapData = <span class="keyword">new</span> MapDataExport();</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 所有怪物导出数据列表</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> List&lt;MonsterMapDataExport&gt; ALlMonsterMapDatas = <span class="keyword">new</span> List&lt;MonsterMapDataExport&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 所有宝箱导出数据列表</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> List&lt;TreasureBoxMapDataExport&gt; AllTreasureBoxMapDatas = <span class="keyword">new</span> List&lt;TreasureBoxMapDataExport&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 所有陷阱导出数据列表</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> List&lt;TrapMapDataExport&gt; AllTrapMapDatas = <span class="keyword">new</span> List&lt;TrapMapDataExport&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 剩余其他地图埋点导出数据成员</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> List&lt;BaseMapDataExport&gt; AllOtherMapDatas = <span class="keyword">new</span> List&lt;BaseMapDataExport&gt;();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>地图对象导出数据基类</strong>定义:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> MapObjectExport.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 地图动态物体数据导出定义</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">Serializable</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MapObjectExport</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 地图对象类型</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> MapObjectType MapObjectType;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 关联配置Id</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> ConfId;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 位置信息</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> Vector3 Position;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 旋转信息</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> Vector3 Rotation;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 缩放信息</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> Vector3 LocalScale;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MapObjectExport</span>(<span class="params">MapObjectType mapObjectType, <span class="built_in">int</span> confId, Vector3 position, Vector3 rotation, Vector3 localScale</span>)</span> </span><br><span class="line">    &#123;</span><br><span class="line">        MapObjectType = mapObjectType;</span><br><span class="line">        ConfId = confId;</span><br><span class="line">        Position = position;</span><br><span class="line">        Rotation = rotation;</span><br><span class="line">        LocalScale = localScale;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>地图埋点导出数据基类</strong>定义:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> BaseMapDataExport.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 地图埋点数据基类导出定义</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">Serializable</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BaseMapDataExport</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 埋点类型</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> MapDataType MapDataType;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 关联Id</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> ConfId;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 位置信息</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> Vector3 Position;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 旋转信息</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> Vector3 Roation;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BaseMapDataExport</span>(<span class="params">MapDataType mapDataType, <span class="built_in">int</span> confId, Vector3 position, Vector3 rotation</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        MapDataType = mapDataType;</span><br><span class="line">        ConfId = confId;</span><br><span class="line">        Position = position;</span><br><span class="line">        Roation = rotation;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>怪物埋点数据导出</strong>定义：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> MonsterMapDataExport.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 怪物地图埋点数据导出</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">Serializable</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MonsterMapDataExport</span> : <span class="title">BaseMapDataExport</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 怪物创建半径</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">float</span> MonsterCreateRadius;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 怪物警戒半径</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">float</span> MonsterActiveRadius;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MonsterMapDataExport</span>(<span class="params">MapDataType mapDataType, <span class="built_in">int</span> confId, Vector3 position,  Vector3 rotation, <span class="built_in">float</span> monsterCreateRadius, <span class="built_in">float</span> monsterActiveRadius</span>)</span></span><br><span class="line"><span class="function">        : <span class="title">base</span>(<span class="params">mapDataType, confId, position, rotation</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            MonsterCreateRadius = monsterCreateRadius;</span><br><span class="line">            MonsterActiveRadius = monsterActiveRadius;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>地图导出数据预览Level1.json:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;MapData&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;Width&quot;</span><span class="punctuation">:</span> <span class="number">8</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;Height&quot;</span><span class="punctuation">:</span> <span class="number">30</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;StartPos&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;BirthPos&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">4.0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="number">2.0</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;AllBaseMapObjectExportDatas&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;MapObjectType&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;ConfId&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Position&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">4.0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">1.0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="number">3.7200000286102297</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Rotation&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;MapObjectType&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;ConfId&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Position&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">4.0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">1.0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="number">11.600000381469727</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Rotation&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;AllColliderMapDynamicExportDatas&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;MapObjectType&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;ConfId&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Position&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">4.0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">0.25</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="number">8.149999618530274</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Rotation&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;ColliderCenter&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;ColliderSize&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;ColliderRiduis&quot;</span><span class="punctuation">:</span> <span class="number">0.5</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;MapObjectType&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;ConfId&quot;</span><span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Position&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">4.0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">0.5</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="number">18.809999465942384</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Rotation&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;ColliderCenter&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;ColliderSize&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">1.0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">1.0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="number">1.0</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;ColliderRiduis&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;MapObjectType&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;ConfId&quot;</span><span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Position&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">4.0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">0.5</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="number">14.899999618530274</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Rotation&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;ColliderCenter&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;ColliderSize&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">1.0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">1.0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="number">1.0</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;ColliderRiduis&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;AllMonsterGroupMapDatas&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;MapDataType&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;ConfId&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Position&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">4.0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="number">8.0</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Roation&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;GroupId&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;MonsterCreateRadius&quot;</span><span class="punctuation">:</span> <span class="number">4.0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;MonsterActiveRadius&quot;</span><span class="punctuation">:</span> <span class="number">3.0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;AllMonsterMapExportDatas&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;MapDataType&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;ConfId&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;Position&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">4.0</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="number">7.0</span></span><br><span class="line">                    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;Roation&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">90.0</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span></span><br><span class="line">                    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;GroupId&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;MapDataType&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;ConfId&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;Position&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">5.0</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="number">9.0</span></span><br><span class="line">                    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;Roation&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">90.0</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span></span><br><span class="line">                    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;GroupId&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;MapDataType&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;ConfId&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;Position&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">6.0</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="number">8.0</span></span><br><span class="line">                    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;Roation&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">90.0</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span></span><br><span class="line">                    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;GroupId&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;MapDataType&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;ConfId&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Position&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">4.0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="number">25.0</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Roation&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;GroupId&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;MonsterCreateRadius&quot;</span><span class="punctuation">:</span> <span class="number">6.0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;MonsterActiveRadius&quot;</span><span class="punctuation">:</span> <span class="number">4.0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;AllMonsterMapExportDatas&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;MapDataType&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;ConfId&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;Position&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">4.0</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="number">26.0</span></span><br><span class="line">                    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;Roation&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">90.0</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span></span><br><span class="line">                    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;GroupId&quot;</span><span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;MapDataType&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;ConfId&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;Position&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">5.0</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="number">26.0</span></span><br><span class="line">                    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;Roation&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">90.0</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span></span><br><span class="line">                    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;GroupId&quot;</span><span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;MapDataType&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;ConfId&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;Position&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">3.0</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="number">25.0</span></span><br><span class="line">                    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;Roation&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">90.0</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span></span><br><span class="line">                    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;GroupId&quot;</span><span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;MapDataType&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;ConfId&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;Position&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">5.0</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="number">23.0</span></span><br><span class="line">                    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;Roation&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">90.0</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span></span><br><span class="line">                    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;GroupId&quot;</span><span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;ALlNoGroupMonsterMapDatas&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;AllOtherMapDatas&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>上面的数据正对应我们导出填充的<strong>MapExport</strong>数据结构。</p>
<p><strong>MapExport导出数据构建是通过GameMapEditorUtilities.GetMapExport()通过Map脚本获取所有相关数据去构建MapExport实现导出数据填充构建的。</strong></p>
<p>Note:</p>
<ol>
<li><strong>因为静态地图对象是跟随预制件一起加载的，所以暂时没导出地图对象数据，有需要可以自行扩展支持动态地图对象导出和加载</strong></li>
<li><strong>扩展自定义配置数据需要自行扩展或继承MapObjectData或MapData和MapEditor.cs面板显示</strong></li>
<li><strong>扩展自定义导出数据需要自行扩展或继承BaseMapDataExportt定义</strong></li>
<li><strong>自定义地图埋点数据导出通过继承BaseMapDataExport定义</strong></li>
</ol>
<h2 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h2><h3 id="新增地图埋点数据"><a href="#新增地图埋点数据" class="headerlink" title="新增地图埋点数据"></a>新增地图埋点数据</h3><p>以新增地图埋点类型MapDataType.Monster为例，怪物有两个DIY属性MonsterCreateRadius (怪物创建半径)和MonsterActiveRadius(怪物警戒半径)</p>
<h4 id="新增地图埋点数据显示"><a href="#新增地图埋点数据显示" class="headerlink" title="新增地图埋点数据显示"></a>新增地图埋点数据显示</h4><ol>
<li><p>增加地图埋点类型定义(MapDataType.cs)</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> MapDataType.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 地图数据埋点类型枚举</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="built_in">enum</span> MapDataType</span><br><span class="line">&#123;</span><br><span class="line">    PlayerSpawn = <span class="number">0</span>,           <span class="comment">// 玩家出生点位置数据</span></span><br><span class="line">    Monster = <span class="number">1</span>,               <span class="comment">// 怪物数据</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>新增地图埋点数据定义(MonsterMapData.cs)</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">MapEditor</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> MonsterMapData.cs</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 怪物地图埋点数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Serializable</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MonsterMapData</span> : <span class="title">MapData</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 怪物创建半径</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        [<span class="meta">Header(<span class="string">&quot;怪物创建半径&quot;</span>)</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">float</span> MonsterCreateRadius = <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 怪物警戒半径</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        [<span class="meta">Header(<span class="string">&quot;怪物警戒半径&quot;</span>)</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">float</span> MonsterActiveRadius = <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">MonsterMapData</span>(<span class="params"><span class="built_in">int</span> uid</span>) : <span class="title">base</span>(<span class="params">uid</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">MonsterMapData</span>(<span class="params"><span class="built_in">int</span> uid, Vector3 position, Vector3 rotation, <span class="built_in">float</span> monsterCreateRadius, <span class="built_in">float</span> monsterActiveRadius</span>)</span></span><br><span class="line"><span class="function">            : <span class="title">base</span>(<span class="params">uid, position, rotation</span>)</span></span><br><span class="line">            &#123;</span><br><span class="line">                MonsterCreateRadius = monsterCreateRadius;</span><br><span class="line">                MonsterActiveRadius = monsterActiveRadius;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 复制自定义数据</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;sourceMapData&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="built_in">bool</span> <span class="title">CopyCustomData</span>(<span class="params">MapData sourceMapData</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(!<span class="keyword">base</span>.CopyCustomData(sourceMapData))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">var</span> realSourceMapData = sourceMapData <span class="keyword">as</span> MonsterMapData;</span><br><span class="line">            MonsterCreateRadius = realSourceMapData.MonsterCreateRadius;</span><br><span class="line">            MonsterActiveRadius = realSourceMapData.MonsterActiveRadius;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>新增编辑器操作添加怪物地图埋点数据(MapUtilities.cs)</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 创建指定地图埋点数据类型，指定uid和指定位置的埋点数据</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;mapDataType&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;uid&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;position&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;rotation&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;monsterCreateRadius&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;monsterActiveRadius&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> MapData <span class="title">CreateMapDataByType</span>(<span class="params">MapDataType mapDataType, <span class="built_in">int</span> uid, Vector3 position, Vector3 rotation, <span class="built_in">float</span> monsterCreateRadius, <span class="built_in">float</span> monsterActiveRadius</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (mapDataType == MapDataType.Monster)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> MonsterMapData(uid, position, rotation, monsterCreateRadius, monsterActiveRadius);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (mapDataType == MapDataType.PlayerSpawn)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> PlayerSpawnMapData(uid, position, rotation);</span><br><span class="line">    &#125;</span><br><span class="line">    ******</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        Debug.LogWarning(<span class="string">$&quot;地图埋点类型:<span class="subst">&#123;mapDataType&#125;</span>没有创建自定义类型数据，可能不方便未来扩展！&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> MapData(uid, position, rotation);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>新增怪物编辑器GUI显示数据定义(MapEditorUtilities.cs)</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 地图埋点类型UI类型显示数据列表</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">readonly</span> List&lt;MapDataTypeDisplayData&gt; MapDataTypeDisplayDatas = <span class="keyword">new</span> List&lt;MapDataTypeDisplayData&gt;()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">new</span> MapDataTypeDisplayData(MapDataType.PlayerSpawn, MapFoldType.PlayerSpawnMapDataFold, <span class="string">&quot;玩家出生点&quot;</span>, Color.yellow),</span><br><span class="line">    <span class="keyword">new</span> MapDataTypeDisplayData(MapDataType.Monster, MapFoldType.MonsterMapDataFold, <span class="string">&quot;怪物&quot;</span>, Color.magenta),</span><br><span class="line">    ******</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
</li>
<li><p>新增怪物自定义数据UI显示数据定义(MapUIType.cs)</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">  <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> MapUIType.cs</span></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> 地图数据UI类型</span></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">  <span class="keyword">public</span> <span class="built_in">enum</span> MapUIType</span><br><span class="line">  &#123;</span><br><span class="line">*******</span><br><span class="line">      MonsterCreateRadius = <span class="number">12</span>,               <span class="comment">// 怪物创建半径UI</span></span><br><span class="line">      MonsterActiveRadius = <span class="number">13</span>,               <span class="comment">// 怪物警戒半径UI</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>新增怪物自定义类型数据UI显示相关数据定义(MapEditorUtilities.cs)</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 地图埋点类型和UI显示类型Map<span class="doctag">&lt;地图埋点类型，&lt;地图UI显示类型，是否显示&gt;</span>&gt;</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Note:</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 所有需要显示的折叠数据都在这里定义相关UI是否显示</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 通用必显示的不同定义在这里，详情参见CommonGameMapUITypeMap</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 所有MapDataType类型必定会自动初始化到MapFoldAndUITypeMap，没有DIY UI显示的可以不定义在这</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Dictionary&lt;MapDataType, Dictionary&lt;MapUIType, <span class="built_in">bool</span>&gt;&gt; MapFoldAndUITypeMap = <span class="keyword">new</span> Dictionary&lt;MapDataType, Dictionary&lt;MapUIType, <span class="built_in">bool</span>&gt;&gt;()</span><br><span class="line">&#123;</span><br><span class="line">    &#123;</span><br><span class="line">        MapDataType.Monster, <span class="keyword">new</span> Dictionary&lt;MapUIType, <span class="built_in">bool</span>&gt;()</span><br><span class="line">        &#123;</span><br><span class="line">            &#123;MapUIType.MonsterCreateRadius, <span class="literal">true</span>&#125;,</span><br><span class="line">            &#123;MapUIType.MonsterActiveRadius, <span class="literal">true</span>&#125;,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 地图UI类型显示数据列表</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Note:</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 标题和属性默认按照这里定义的顺序显示</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">readonly</span> List&lt;MapUITypeDisplayData&gt; MapUITypeDisplayData = <span class="keyword">new</span> List&lt;MapUITypeDisplayData&gt;()</span><br><span class="line">&#123;</span><br><span class="line">    ******</span><br><span class="line">        <span class="keyword">new</span> MapUITypeDisplayData(MapUIType.MonsterCreateRadius, <span class="string">&quot;MonsterCreateRadius&quot;</span>, <span class="string">&quot;创建半径&quot;</span>, MapEditorConst.InspectorDataMonsterCreateRadiusUIWidth, MapStyles.TabMiddleStyle),</span><br><span class="line">    <span class="keyword">new</span> MapUITypeDisplayData(MapUIType.MonsterActiveRadius, <span class="string">&quot;MonsterActiveRadius&quot;</span>, <span class="string">&quot;警戒半径&quot;</span>, MapEditorConst.InspectorDataMonsterActiveRediusUIWidth, MapStyles.TabMiddleStyle),</span><br><span class="line">    ******</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
</li>
<li><p>新增属性GUI显示代码(MapEditor.cs)</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 绘制单个地图埋点属性，索引，地图埋点类型和现实数据的数据</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;mapDataProperty&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;mapDataIndex&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;mapDataType&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;mapUITypeDisplayData&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">DrawOneMapDataPropertyByData</span>(<span class="params">SerializedProperty mapDataProperty, <span class="built_in">int</span> mapDataIndex, MapDataType mapDataType, MapUITypeDisplayData mapUITypeDisplayData</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    ******</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (mapUIType == MapUIType.MonsterCreateRadius)</span><br><span class="line">    &#123;</span><br><span class="line">        DrawFloatChangeMapDataProperty(mapDataIndex, property, propertyName, MapEditorConst.InspectorDataMonsterCreateRadiusUIWidth);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (mapUIType == MapUIType.MonsterActiveRadius)</span><br><span class="line">    &#123;</span><br><span class="line">        DrawFloatChangeMapDataProperty(mapDataIndex, property, propertyName, MapEditorConst.InspectorDataMonsterActiveRediusUIWidth);</span><br><span class="line">    &#125;</span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>至此我们成功添加了自定义埋点数据类型和DIY数据显示，接下来就是数据导出。</p>
<p><img src="/img/Unity/MapEditor/MonsterMapDataUIOperation.PNG" alt="MonsterMapDataUIOperation"></p>
</li>
</ol>
<p>Note:</p>
<ol>
<li><strong>公共UI类型是否显示定义在MapEditorUtilities.CommonMapUITypeMap里，自定义UI类型是否显示定义在MapEditorUtilities.MapFoldAndUITypeMap里</strong></li>
</ol>
<h4 id="新增地图埋点数据导出"><a href="#新增地图埋点数据导出" class="headerlink" title="新增地图埋点数据导出"></a>新增地图埋点数据导出</h4><ol>
<li><p>新增怪物导出数据定义(MonsterMapDataExport.cs)</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> MonsterMapDataExport.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 怪物地图埋点数据导出</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">Serializable</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MonsterMapDataExport</span> : <span class="title">BaseMapDataExport</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 怪物创建半径</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">float</span> MonsterCreateRadius;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 怪物警戒半径</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">float</span> MonsterActiveRadius;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MonsterMapDataExport</span>(<span class="params">MapDataType mapDataType, <span class="built_in">int</span> confId, Vector3 position,  Vector3 rotation, <span class="built_in">float</span> monsterCreateRadius, <span class="built_in">float</span> monsterActiveRadius</span>)</span></span><br><span class="line"><span class="function">        : <span class="title">base</span>(<span class="params">mapDataType, confId, position, rotation</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            MonsterCreateRadius = monsterCreateRadius;</span><br><span class="line">            MonsterActiveRadius = monsterActiveRadius;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>导出数据添加怪物导出数据定义(MapExport.cs)</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> MapExport.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 地图导出数据结构定义(统一导出结构定义，方便支持导出不同的数据格式)</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">Serializable</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MapExport</span></span><br><span class="line">&#123;</span><br><span class="line">    ******</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 所有怪物导出数据列表</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> List&lt;MonsterMapDataExport&gt; ALlMonsterMapDatas = <span class="keyword">new</span> List&lt;MonsterMapDataExport&gt;();</span><br><span class="line">    </span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>构建导出数据并填充到怪物导出数据列表里(MapExportEditorUtilities.cs)</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 指定地图埋点数据列表更新地图导出数据</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;mapExport&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;map&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">UpdateMapExportByMapDatas</span>(<span class="params">MapExport mapExport, Map map</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span>(map?.MapDataList == <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> mapDatas = map.MapDataList;</span><br><span class="line">    <span class="keyword">var</span> mapDataTypeDatasMap = GetMapDataTypeDatas(mapDatas);</span><br><span class="line">    ******</span><br><span class="line">        List&lt;MapData&gt; monsterDatas;</span><br><span class="line">    <span class="keyword">if</span> (mapDataTypeDatasMap.TryGetValue(MapDataType.Monster, <span class="keyword">out</span> monsterDatas))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> monsterData <span class="keyword">in</span> monsterDatas)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> monsterMapDataExport = GetMonsterMapDataExport(monsterData);</span><br><span class="line">            mapExport.ALlMonsterMapDatas.Add(monsterMapDataExport);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 获取指定地图埋点数据的地图埋点怪物导出数据</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;mapData&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> MonsterMapDataExport <span class="title">GetMonsterMapDataExport</span>(<span class="params">MapData mapData</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (mapData == <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        Debug.LogError(<span class="string">&quot;不允许获取空地图埋点数据的地图埋点怪物导出数据失败！&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> mapDataUID = mapData.UID;</span><br><span class="line">    <span class="keyword">var</span> mapDataConfig = MapSetting.GetEditorInstance().DataSetting.GetMapDataConfigByUID(mapDataUID);</span><br><span class="line">    <span class="keyword">if</span> (mapDataConfig == <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        Debug.LogError(<span class="string">$&quot;找不到地图埋点UID:<span class="subst">&#123;mapDataUID&#125;</span>的配置，获取地图埋点怪物导出数据失败！&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> monsterMapData = mapData <span class="keyword">as</span> MonsterMapData;</span><br><span class="line">    <span class="keyword">var</span> monsterCreateRadius = monsterMapData.MonsterCreateRadius;</span><br><span class="line">    <span class="keyword">var</span> monsterActiveRadius = monsterMapData.MonsterActiveRadius;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> MonsterMapDataExport(mapDataConfig.DataType, mapDataConfig.ConfId, mapData.Position, mapData.Rotation, monsterCreateRadius, monsterActiveRadius);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后MapExport导出时，数据就会序列化到Json:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;MapData&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">     <span class="attr">&quot;Width&quot;</span><span class="punctuation">:</span> <span class="number">8</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;Height&quot;</span><span class="punctuation">:</span> <span class="number">40</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;StartPos&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;BirthPos&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">3.0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="number">3.0</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;GameVirtualCameraInitPos&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">3.0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">15.0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="number">-10.0</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;GridSize&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;ALlMonsterMapDatas&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;MapDataType&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;ConfId&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Position&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">3.0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="number">15.0</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Roation&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;MonsterCreateRadius&quot;</span><span class="punctuation">:</span> <span class="number">8.0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;MonsterActiveRadius&quot;</span><span class="punctuation">:</span> <span class="number">5.0</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;MapDataType&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;ConfId&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Position&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">3.0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="number">20.0</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Roation&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;z&quot;</span><span class="punctuation">:</span> <span class="number">0.0</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;MonsterCreateRadius&quot;</span><span class="punctuation">:</span> <span class="number">8.0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;MonsterActiveRadius&quot;</span><span class="punctuation">:</span> <span class="number">5.0</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    ******</span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h4 id="新增地图埋点数据读取"><a href="#新增地图埋点数据读取" class="headerlink" title="新增地图埋点数据读取"></a>新增地图埋点数据读取</h4><p>完成埋点数据导出后，接下来就是数据读取(MapGameManager.cs)</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 加载关卡配置</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">LoadLevelConfig</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> levelTxtAsset = Resources.Load&lt;TextAsset&gt;(MapGameConst.LevelConfigPath);</span><br><span class="line">    <span class="keyword">if</span> (levelTxtAsset == <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        Debug.LogError(<span class="string">$&quot;关卡配置:<span class="subst">&#123;MapGameConst.LevelConfigPath&#125;</span>加载失败！&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        LevelConfig = JsonUtility.FromJson&lt;MapExport&gt;(levelTxtAsset.text);</span><br><span class="line">    &#125;</span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后通过MapGameManager.Singleton.LevelConfig.ALlMonsterMapDatas即可访问导出的怪物埋点数据了。</p>
<h3 id="摄像机可见范围可视化"><a href="#摄像机可见范围可视化" class="headerlink" title="摄像机可见范围可视化"></a>摄像机可见范围可视化</h3><p>摄像机的可见范围计算原理：</p>
<ul>
<li>不考虑摄像机是正交还是透视，通过将屏幕四个角映射到世界坐标系(屏幕坐标到世界坐标)，得到从摄像机到摄像机四个角的射线数据。</li>
</ul>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 四个角的视口坐标</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Vector3[] ViewPortPoints = <span class="keyword">new</span> Vector3[<span class="number">5</span>]</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">new</span> Vector3(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>),        <span class="comment">// 左下角</span></span><br><span class="line">    <span class="keyword">new</span> Vector3(<span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>),        <span class="comment">// 左上角</span></span><br><span class="line">    <span class="keyword">new</span> Vector3(<span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>),        <span class="comment">// 右上角</span></span><br><span class="line">    <span class="keyword">new</span> Vector3(<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>),        <span class="comment">// 右下角</span></span><br><span class="line">    <span class="keyword">new</span> Vector3(<span class="number">0.5f</span>, <span class="number">0.5f</span>, <span class="number">0</span>),  <span class="comment">// 中心</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 获取指定摄像机的射线数据列表</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;camera&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;rayCastDataList&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">bool</span> <span class="title">GetCameraRayCastDataList</span>(<span class="params">Camera camera, <span class="keyword">ref</span> List&lt;KeyValuePair&lt;Vector3, Vector3&gt;&gt; rayCastDataList</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    rayCastDataList.Clear();</span><br><span class="line">    <span class="keyword">if</span>(camera == <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        Debug.LogError(<span class="string">$&quot;不允许传递空摄像机组件，获取摄像机的射线数据列表失败！&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> cameraNearClipPlane = camera.nearClipPlane;</span><br><span class="line">    ViewPortPoints[<span class="number">0</span>].z = cameraNearClipPlane;</span><br><span class="line">    ViewPortPoints[<span class="number">1</span>].z = cameraNearClipPlane;</span><br><span class="line">    ViewPortPoints[<span class="number">2</span>].z = cameraNearClipPlane;</span><br><span class="line">    ViewPortPoints[<span class="number">3</span>].z = cameraNearClipPlane;</span><br><span class="line">    ViewPortPoints[<span class="number">4</span>].z = cameraNearClipPlane;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> isOrthographic = camera.orthographic;</span><br><span class="line">    <span class="keyword">if</span>(isOrthographic)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 转换为射线</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; ViewPortPoints.Length; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            Ray ray = camera.ViewportPointToRay(ViewPortPoints[i]);</span><br><span class="line">            <span class="keyword">var</span> rayCastToPoint = ray.origin + ray.direction * camera.farClipPlane;</span><br><span class="line">            <span class="keyword">var</span> rayCastData = <span class="keyword">new</span> KeyValuePair&lt;Vector3, Vector3&gt;(ray.origin, rayCastToPoint);</span><br><span class="line">            rayCastDataList.Add(rayCastData);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> radio = camera.farClipPlane / cameraNearClipPlane;</span><br><span class="line">        <span class="keyword">var</span> cameraPosition = camera.transform.position;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取饰扣四个角的屏幕映射世界坐标</span></span><br><span class="line">        <span class="keyword">var</span> lbNearPlaneWorldPoints = camera.ViewportToWorldPoint(ViewPortPoints[<span class="number">0</span>]);</span><br><span class="line">        <span class="keyword">var</span> ltNearPlaneWorldPoints = camera.ViewportToWorldPoint(ViewPortPoints[<span class="number">1</span>]);</span><br><span class="line">        <span class="keyword">var</span> rtNearPlaneWorldPoints = camera.ViewportToWorldPoint(ViewPortPoints[<span class="number">2</span>]);</span><br><span class="line">        <span class="keyword">var</span> rbNearPlaneWorldPoints = camera.ViewportToWorldPoint(ViewPortPoints[<span class="number">3</span>]);</span><br><span class="line">        <span class="keyword">var</span> ctNearPlaneWorldPoints = camera.ViewportToWorldPoint(ViewPortPoints[<span class="number">4</span>]);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> lbNearPlaneCameraWorldPointDir = lbNearPlaneWorldPoints - cameraPosition;</span><br><span class="line">        <span class="keyword">var</span> ltNearPlaneCameraWorldPointDir = ltNearPlaneWorldPoints - cameraPosition;</span><br><span class="line">        <span class="keyword">var</span> rtNearPlaneCameraWorldPointDir = rtNearPlaneWorldPoints - cameraPosition;</span><br><span class="line">        <span class="keyword">var</span> rbNearPlaneCameraWorldPointDir = rbNearPlaneWorldPoints - cameraPosition;</span><br><span class="line">        <span class="keyword">var</span> ctNearPlaneCameraWorldPointDir = ctNearPlaneWorldPoints - cameraPosition;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> lbFarPlaneWorldPoint = cameraPosition + lbNearPlaneCameraWorldPointDir * radio;</span><br><span class="line">        <span class="keyword">var</span> ltFarPlaneWorldPoint = cameraPosition + ltNearPlaneCameraWorldPointDir * radio;</span><br><span class="line">        <span class="keyword">var</span> rtFarPlaneWorldPoint = cameraPosition + rtNearPlaneCameraWorldPointDir * radio;</span><br><span class="line">        <span class="keyword">var</span> rbFarPlaneWorldPoint = cameraPosition + rbNearPlaneCameraWorldPointDir * radio;</span><br><span class="line">        <span class="keyword">var</span> ctFarPlaneWorldPoint = cameraPosition + ctNearPlaneCameraWorldPointDir * radio;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> lbRayCastData = <span class="keyword">new</span> KeyValuePair&lt;Vector3, Vector3&gt;(lbNearPlaneWorldPoints, lbFarPlaneWorldPoint);</span><br><span class="line">        <span class="keyword">var</span> ltRayCastData = <span class="keyword">new</span> KeyValuePair&lt;Vector3, Vector3&gt;(ltNearPlaneWorldPoints, ltFarPlaneWorldPoint);</span><br><span class="line">        <span class="keyword">var</span> rtRayCastData = <span class="keyword">new</span> KeyValuePair&lt;Vector3, Vector3&gt;(rtNearPlaneWorldPoints, rtFarPlaneWorldPoint);</span><br><span class="line">        <span class="keyword">var</span> rbRayCastData = <span class="keyword">new</span> KeyValuePair&lt;Vector3, Vector3&gt;(rbNearPlaneWorldPoints, rbFarPlaneWorldPoint);        </span><br><span class="line">        <span class="keyword">var</span> ctRayCastData = <span class="keyword">new</span> KeyValuePair&lt;Vector3, Vector3&gt;(ctNearPlaneWorldPoints, ctFarPlaneWorldPoint);        </span><br><span class="line">        rayCastDataList.Add(lbRayCastData);</span><br><span class="line">        rayCastDataList.Add(ltRayCastData);</span><br><span class="line">        rayCastDataList.Add(rtRayCastData);</span><br><span class="line">        rayCastDataList.Add(rbRayCastData);</span><br><span class="line">        rayCastDataList.Add(ctRayCastData);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>得到屏幕四个角映射的射线数据后，利用射线和平面的交叉计算得到指定平面交叉的点就能得到我们要的平面照射区域</li>
</ul>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Vector3Utilities.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Vector3静态工具类</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">Vector3Utilities</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 获取指定射线和平面数据的交叉点(返回null表示没有交叉点)</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;rayOrigin&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;rayDirection&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;planePoint&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;planeNormal&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Vector3? GetRayAndPlaneIntersect(Vector3 rayOrigin, Vector3 rayDirection, Vector3 planePoint, Vector3 planeNormal)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 计算法向量和方向向量的点积</span></span><br><span class="line">        <span class="built_in">float</span> ndotu = Vector3.Dot(planeNormal, rayDirection);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 向量几乎平行，可能没有交点或者射线在平面内</span></span><br><span class="line">        <span class="keyword">if</span> (Mathf.Approximately(Math.Abs(ndotu), Mathf.Epsilon))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 计算 t</span></span><br><span class="line">        Vector3 w = rayOrigin - planePoint;</span><br><span class="line">        <span class="built_in">float</span> t = -Vector3.Dot(planeNormal, w) / ndotu;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 交点在射线起点的后面</span></span><br><span class="line">        <span class="keyword">if</span> (t &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 计算交点</span></span><br><span class="line">        Vector3 intersectionPoint = rayOrigin + t * rayDirection;</span><br><span class="line">        <span class="keyword">return</span> intersectionPoint;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 获取指定摄像机指定区域顶点和法线的的可视区域顶点数据</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;camera&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;areaPoint&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;areaNormal&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;areaPointsList&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;rectPointList&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">bool</span> <span class="title">GetCameraVisibleArea</span>(<span class="params">Camera camera, Vector3 areaPoint, Vector3 areaNormal, <span class="keyword">ref</span> List&lt;Vector3&gt; areaPointsList, <span class="keyword">ref</span> List&lt;Vector3&gt; rectPointList</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    areaPointsList.Clear();</span><br><span class="line">    rectPointList.Clear();</span><br><span class="line">    <span class="keyword">if</span> (camera == <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        Debug.LogError(<span class="string">$&quot;不允许传递空摄像机组件，获取摄像机的可视区域顶点数据失败！&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    RayCastDataList.Clear();</span><br><span class="line">    GetCameraRayCastDataList(camera, <span class="keyword">ref</span> RayCastDataList);</span><br><span class="line">    <span class="keyword">foreach</span>(<span class="keyword">var</span> rayCastData <span class="keyword">in</span> RayCastDataList)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> rayCastDirection = rayCastData.Value - rayCastData.Key;</span><br><span class="line">        <span class="keyword">var</span> areaData = Vector3Utilities.GetRayAndPlaneIntersect(rayCastData.Key, rayCastDirection, areaPoint, areaNormal);</span><br><span class="line">        <span class="keyword">if</span>(areaData != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            areaPointsList.Add((Vector3)areaData);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    rectPointList.Add(<span class="keyword">new</span> Vector3(areaPointsList[<span class="number">1</span>].x, areaPointsList[<span class="number">0</span>].y, areaPointsList[<span class="number">0</span>].z));</span><br><span class="line">    rectPointList.Add(<span class="keyword">new</span> Vector3(areaPointsList[<span class="number">1</span>].x, areaPointsList[<span class="number">1</span>].y, areaPointsList[<span class="number">1</span>].z));</span><br><span class="line">    rectPointList.Add(<span class="keyword">new</span> Vector3(areaPointsList[<span class="number">2</span>].x, areaPointsList[<span class="number">2</span>].y, areaPointsList[<span class="number">2</span>].z));</span><br><span class="line">    rectPointList.Add(<span class="keyword">new</span> Vector3(areaPointsList[<span class="number">2</span>].x, areaPointsList[<span class="number">3</span>].y, areaPointsList[<span class="number">3</span>].z));</span><br><span class="line">    rectPointList.Add(areaPointsList[<span class="number">4</span>]);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从上面可以看到无论是areaPointsList还是rectPointList都返回了5个顶点数据，第五个是屏幕中心映射的点。</p>
<p><strong>之所以返回矩形的映射区域，是为了简化后面透视摄像机梯形判定顶点复杂度，简化成AABB和点的交叉判定。</strong></p>
<ul>
<li>得到了屏幕映射的顶点数据，通过构建线条数据，我们就能利用GUI相关接口画出可视化可见区域了</li>
</ul>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 区域顶点</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">Header(<span class="string">&quot;区域顶点&quot;</span>)</span>]</span><br><span class="line"><span class="keyword">public</span> Vector3 AreaPoint = Vector3.zero;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 区域法线</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">Header(<span class="string">&quot;区域法线&quot;</span>)</span>]</span><br><span class="line"><span class="keyword">public</span> Vector3 AreaNormal = Vector3.up;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 更新摄像机指定平面映射区域数据</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">UpdateAreaDatas</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    CameraUtilities.GetCameraRayCastDataList(mCameraComponent, <span class="keyword">ref</span> mRayCastDataList);</span><br><span class="line">    CameraUtilities.GetCameraVisibleArea(mCameraComponent, AreaPoint, AreaNormal, <span class="keyword">ref</span> mAreaPointsList, <span class="keyword">ref</span> mRectAreaPointsList);</span><br><span class="line">    mAreaLinesList.Clear();</span><br><span class="line">    mRectAreaLinesList.Clear();</span><br><span class="line">    <span class="keyword">if</span>(mAreaPointsList.Count &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> lbToLtLine = <span class="keyword">new</span> KeyValuePair&lt;Vector3, Vector3&gt;(mAreaPointsList[<span class="number">0</span>], mAreaPointsList[<span class="number">1</span>]);</span><br><span class="line">        <span class="keyword">var</span> ltToRtLine = <span class="keyword">new</span> KeyValuePair&lt;Vector3, Vector3&gt;(mAreaPointsList[<span class="number">1</span>], mAreaPointsList[<span class="number">2</span>]);</span><br><span class="line">        <span class="keyword">var</span> rtToRbLine = <span class="keyword">new</span> KeyValuePair&lt;Vector3, Vector3&gt;(mAreaPointsList[<span class="number">2</span>], mAreaPointsList[<span class="number">3</span>]);</span><br><span class="line">        <span class="keyword">var</span> rbToLbLine = <span class="keyword">new</span> KeyValuePair&lt;Vector3, Vector3&gt;(mAreaPointsList[<span class="number">3</span>], mAreaPointsList[<span class="number">0</span>]);</span><br><span class="line">        mAreaLinesList.Add(lbToLtLine);</span><br><span class="line">        mAreaLinesList.Add(ltToRtLine);</span><br><span class="line">        mAreaLinesList.Add(rtToRbLine);</span><br><span class="line">        mAreaLinesList.Add(rbToLbLine);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> rectLbToLtLine = <span class="keyword">new</span> KeyValuePair&lt;Vector3, Vector3&gt;(mRectAreaPointsList[<span class="number">0</span>], mRectAreaPointsList[<span class="number">1</span>]);</span><br><span class="line">        <span class="keyword">var</span> rectLtToRtLine = <span class="keyword">new</span> KeyValuePair&lt;Vector3, Vector3&gt;(mRectAreaPointsList[<span class="number">1</span>], mRectAreaPointsList[<span class="number">2</span>]);</span><br><span class="line">        <span class="keyword">var</span> rectRtToRbLine = <span class="keyword">new</span> KeyValuePair&lt;Vector3, Vector3&gt;(mRectAreaPointsList[<span class="number">2</span>], mRectAreaPointsList[<span class="number">3</span>]);</span><br><span class="line">        <span class="keyword">var</span> rectRbToLbLine = <span class="keyword">new</span> KeyValuePair&lt;Vector3, Vector3&gt;(mRectAreaPointsList[<span class="number">3</span>], mRectAreaPointsList[<span class="number">0</span>]);</span><br><span class="line">        mRectAreaLinesList.Add(rectLbToLtLine);</span><br><span class="line">        mRectAreaLinesList.Add(rectLtToRtLine);</span><br><span class="line">        mRectAreaLinesList.Add(rectRtToRbLine);</span><br><span class="line">        mRectAreaLinesList.Add(rectRbToLbLine);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 绘制区域信息Gizmos</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">DrawAreaInfoGUI</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> preGizmosColor = Gizmos.color;</span><br><span class="line">    Gizmos.color = Color.green;</span><br><span class="line">    Gizmos.DrawSphere(AreaPoint, SphereSize);</span><br><span class="line">    <span class="keyword">var</span> areaPointTo = AreaPoint + AreaNormal * <span class="number">5</span>;</span><br><span class="line">    Gizmos.DrawLine(AreaPoint, areaPointTo);</span><br><span class="line">    Gizmos.color = preGizmosColor;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 绘制矩形区域</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">DrawRectAreaGUI</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> preGizmosColor = Gizmos.color;</span><br><span class="line">    Gizmos.color = <span class="keyword">new</span> Color(<span class="number">0</span>, <span class="number">0.5f</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(mRectAreaLinesList.Count &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        Gizmos.DrawLine(mRectAreaLinesList[<span class="number">0</span>].Key, mRectAreaLinesList[<span class="number">0</span>].Value);</span><br><span class="line">        Gizmos.DrawLine(mRectAreaLinesList[<span class="number">1</span>].Key, mRectAreaLinesList[<span class="number">1</span>].Value);</span><br><span class="line">        Gizmos.DrawLine(mRectAreaLinesList[<span class="number">2</span>].Key, mRectAreaLinesList[<span class="number">2</span>].Value);</span><br><span class="line">        Gizmos.DrawLine(mRectAreaLinesList[<span class="number">3</span>].Key, mRectAreaLinesList[<span class="number">3</span>].Value);</span><br><span class="line">    &#125;</span><br><span class="line">    Gizmos.color = preGizmosColor;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 绘制区域Gizmos</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">DrawAreaGUI</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> preGizmosColor = Gizmos.color;</span><br><span class="line">    Gizmos.color = Color.green;</span><br><span class="line">    <span class="keyword">if</span>(mAreaLinesList.Count &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        Gizmos.DrawLine(mAreaLinesList[<span class="number">0</span>].Key, mAreaLinesList[<span class="number">0</span>].Value);</span><br><span class="line">        Gizmos.DrawLine(mAreaLinesList[<span class="number">1</span>].Key, mAreaLinesList[<span class="number">1</span>].Value);</span><br><span class="line">        Gizmos.DrawLine(mAreaLinesList[<span class="number">2</span>].Key, mAreaLinesList[<span class="number">2</span>].Value);</span><br><span class="line">        Gizmos.DrawLine(mAreaLinesList[<span class="number">3</span>].Key, mAreaLinesList[<span class="number">3</span>].Value);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(mAreaPointsList.Count &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        Gizmos.DrawSphere(mAreaPointsList[<span class="number">4</span>], SphereSize);</span><br><span class="line">    &#125;</span><br><span class="line">    Gizmos.color = preGizmosColor;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>摄像机照射区域可视化：</p>
<p><img src="/img/Unity/MapEditor/CameraAreaVisualization.PNG" alt="CameraAreaVisualization"></p>
<p><strong>可以看到黄色是远截面照射区域，深绿色是近截面照射区域，浅绿色是摄像机近截面换算成矩形后的区域，红色线条是摄像机近截面和远截面射线，</strong></p>
<p>Note:</p>
<ol>
<li><strong>屏幕4个顶点计算顺序依次是左下，左上，右上，右下</strong></li>
</ol>
<h3 id="摄像机可见范围动态创建和销毁"><a href="#摄像机可见范围动态创建和销毁" class="headerlink" title="摄像机可见范围动态创建和销毁"></a>摄像机可见范围动态创建和销毁</h3><p>前面我们已经成功得到了摄像机照射范围映射到指定平面映射顶点数据，接下来就是通过埋点对象数据的位置结合摄像机映射数据，通过判定AABB和点的交互决定指定地图埋点数据是否可见，从而决定是否创建或移除相关地图埋点数据的对象数据。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 2D AABB定义</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">Serializable</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">struct</span> AABB2D</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 中心点位置</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;中心点位置&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> Vector2 Center;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 宽和高</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;宽和高&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> Vector2 Extents;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AABB2D</span>(<span class="params">Vector2 center, Vector2 extents</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Center = center;</span><br><span class="line">        Extents = extents;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> MapGameConst.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 游戏常量</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">MapGameConst</span></span><br><span class="line">&#123;</span><br><span class="line">    *******</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 区域顶点</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">readonly</span> Vector3 AreaPoint = Vector3.zero;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 区域法线</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">readonly</span> Vector3 AreaNormal = Vector3.up;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> MapObjectEntitySpawnSystem.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 地图对象Entity生成系统</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MapObjectEntitySpawnSystem</span> : <span class="title">BaseSystem</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 摄像机指定平面映射区域顶点数据列表</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> List&lt;Vector3&gt; mAreaPointsList = <span class="keyword">new</span> List&lt;Vector3&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 摄像机指定平面映射矩形区域顶点数据列表</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> List&lt;Vector3&gt; mRectAreaPointsList = <span class="keyword">new</span> List&lt;Vector3&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 已生成的BaseMapDataExport数据和对应Entity Uuid Map</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> Dictionary&lt;BaseMapDataExport, <span class="built_in">int</span>&gt; mSpawnedMapDataEntityMap = <span class="keyword">new</span> Dictionary&lt;BaseMapDataExport, <span class="built_in">int</span>&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 临时需要移除的地图埋点导出数据列表</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> List&lt;BaseMapDataExport&gt; mTempRemoveSpawnedMapDataExportList = <span class="keyword">new</span> List&lt;BaseMapDataExport&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 摄像机矩形区域</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> AABB2D mCameraRectArea = <span class="keyword">new</span> AABB2D();</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 地图埋点临时Vector2位置数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> Vector2 mTempMapDataExportPos = <span class="keyword">new</span> Vector2();</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 指定MapDataExport数据是否已生成Entity</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;mapDataExport&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="built_in">bool</span> <span class="title">IsMapDataSpawned</span>(<span class="params">BaseMapDataExport mapDataExport</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> mSpawnedMapDataEntityMap.ContainsKey(mapDataExport);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 添加指定地图埋点数据和对应生成Entity Uuid</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;mapDataExport&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;uuid&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="built_in">bool</span> <span class="title">AddMapDataSpawnedEntityUuid</span>(<span class="params">BaseMapDataExport mapDataExport, <span class="built_in">int</span> uuid</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(IsMapDataSpawned(mapDataExport))</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">$&quot;MapDataExport.MapDataType:<span class="subst">&#123;mapDataExport.MapDataType&#125;</span>,MapDataExport.ConfId:<span class="subst">&#123;mapDataExport.ConfId&#125;</span>已生成Entity，添加生成Entity Uuid:<span class="subst">&#123;uuid&#125;</span>失败！&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        mSpawnedMapDataEntityMap.Add(mapDataExport, uuid);</span><br><span class="line">        Debug.Log(<span class="string">$&quot;添加MapDataExport.MapDataType:<span class="subst">&#123;mapDataExport.MapDataType&#125;</span>,MapDataExport.ConfId:<span class="subst">&#123;mapDataExport.ConfId&#125;</span>的生成Entity Uuid:<span class="subst">&#123;uuid&#125;</span>成功！&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 移除指定地图埋点数据的Entity生成数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;mapDataExport&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="built_in">bool</span> <span class="title">RemoveMapDataSpawned</span>(<span class="params">BaseMapDataExport mapDataExport</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">int</span> uuid;</span><br><span class="line">        <span class="keyword">if</span>(mSpawnedMapDataEntityMap.TryGetValue(mapDataExport, <span class="keyword">out</span> uuid))</span><br><span class="line">        &#123;</span><br><span class="line">            mSpawnedMapDataEntityMap.Remove(mapDataExport);</span><br><span class="line">            Debug.Log(<span class="string">$&quot;移除MapDataExport.MapDataType:<span class="subst">&#123;mapDataExport.MapDataType&#125;</span>,MapDataExport.ConfId:<span class="subst">&#123;mapDataExport.ConfId&#125;</span>的生成Entity Uuid:<span class="subst">&#123;uuid&#125;</span>成功！&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        Debug.LogError(<span class="string">$&quot;MapDataExport.MapDataType:<span class="subst">&#123;mapDataExport.MapDataType&#125;</span>,MapDataExport.ConfId:<span class="subst">&#123;mapDataExport.ConfId&#125;</span>未生成对应Entity，移除Entity Uuid:<span class="subst">&#123;uuid&#125;</span>失败！&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Entity过滤</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;entity&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="built_in">bool</span> <span class="title">Filter</span>(<span class="params">BaseEntity entity</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> entityType = entity.EntityType;</span><br><span class="line">        <span class="keyword">return</span> entityType == EntityType.Camera;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Entity处理</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;entity&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;deltaTime&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Process</span>(<span class="params">BaseEntity entity, <span class="built_in">float</span> deltaTime</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">base</span>.Process(entity, deltaTime);</span><br><span class="line">        <span class="keyword">var</span> cameraEntity = entity <span class="keyword">as</span> CameraEntity;</span><br><span class="line">        <span class="keyword">if</span>(!cameraEntity.SyncPosition)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        UpdateCameraDatas();</span><br><span class="line">        CheckAllMapDataExportEntitySpawn();</span><br><span class="line">        CheckAllSpawnEntityRemove();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 更新摄像机数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">UpdateCameraDatas</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> mainCamera = MapGameManager.Singleton.MainCamera;</span><br><span class="line">        CameraUtilities.GetCameraVisibleArea(mainCamera, MapGameConst.AreaPoint, MapGameConst.AreaNormal, <span class="keyword">ref</span> mAreaPointsList, <span class="keyword">ref</span> mRectAreaPointsList);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> minX = Math.Min(mRectAreaPointsList[<span class="number">0</span>].x, mRectAreaPointsList[<span class="number">1</span>].x);</span><br><span class="line">        <span class="keyword">var</span> maxX = Math.Max(mRectAreaPointsList[<span class="number">2</span>].x, mRectAreaPointsList[<span class="number">3</span>].x);</span><br><span class="line">        <span class="keyword">var</span> minZ = Math.Min(mRectAreaPointsList[<span class="number">0</span>].z, mRectAreaPointsList[<span class="number">3</span>].z);</span><br><span class="line">        <span class="keyword">var</span> maxZ = Math.Max(mRectAreaPointsList[<span class="number">1</span>].z, mRectAreaPointsList[<span class="number">2</span>].z);</span><br><span class="line">        <span class="keyword">var</span> width = maxX - minX;</span><br><span class="line">        <span class="keyword">var</span> height = maxZ - minZ;</span><br><span class="line">        <span class="keyword">var</span> centerX = mRectAreaPointsList[<span class="number">1</span>].X + width / <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">var</span> centerZ = mRectAreaPointsList[<span class="number">0</span>].Z + height / <span class="number">2</span>;</span><br><span class="line">        mCameraRectArea.Center.x = centerX;</span><br><span class="line">        mCameraRectArea.Center.y = centerZ;</span><br><span class="line">        mCameraRectArea.Extents.x = width;</span><br><span class="line">        mCameraRectArea.Extents.y = height;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 检查地图埋点导出数据Entity生成</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">CheckAllMapDataExportEntitySpawn</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> allMonsterMapDatas = MapGameManager.Singleton.LevelConfig.ALlMonsterMapDatas;</span><br><span class="line">        <span class="keyword">var</span> allTreasureBoxMapDatas = MapGameManager.Singleton.LevelConfig.AllTreasureBoxMapDatas;</span><br><span class="line">        <span class="keyword">var</span> allTrapMapDatas = MapGameManager.Singleton.LevelConfig.AllTrapMapDatas;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> monsterMapDataExport <span class="keyword">in</span> allMonsterMapDatas)</span><br><span class="line">        &#123;</span><br><span class="line">            CheckAllMapDataExportEntitySpawn(monsterMapDataExport);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> treasureBoxMapDataExport <span class="keyword">in</span> allTreasureBoxMapDatas)</span><br><span class="line">        &#123;</span><br><span class="line">            CheckAllMapDataExportEntitySpawn(treasureBoxMapDataExport);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> trapMapDataExport <span class="keyword">in</span> allTrapMapDatas)</span><br><span class="line">        &#123;</span><br><span class="line">            CheckAllMapDataExportEntitySpawn(trapMapDataExport);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 检查指定地图埋点导出数据Entity生成</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;mapDataExport&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">CheckAllMapDataExportEntitySpawn</span>(<span class="params">BaseMapDataExport mapDataExport</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(IsMapDataSpawned(mapDataExport))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> mapDataExportPosition = mapDataExport.Position;</span><br><span class="line">        mTempMapDataExportPos.x = mapDataExportPosition.x;</span><br><span class="line">        mTempMapDataExportPos.y = mapDataExportPosition.z;</span><br><span class="line">        <span class="keyword">if</span>(Collision2DUtilities.PointInAABB(mCameraRectArea, mTempMapDataExportPos))</span><br><span class="line">        &#123;</span><br><span class="line">            BaseEntity entity = <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">var</span> position = mapDataExport.Position;</span><br><span class="line">            <span class="keyword">if</span>(mapDataExport <span class="keyword">is</span> MonsterMapDataExport)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> monsterEntity = OwnerWorld.CreateEtity&lt;MonsterEntity&gt;(MapGameConst.MonsterPrefabPath);</span><br><span class="line">                entity = monsterEntity;</span><br><span class="line">                monsterEntity.SetPosition(position.x, position.y, position.z);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(mapDataExport <span class="keyword">is</span> TreasureBoxMapDataExport)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> treasureEntity = OwnerWorld.CreateEtity&lt;TreasureBoxEntity&gt;(MapGameConst.TreasureBoxPrefabPath);</span><br><span class="line">                entity = treasureEntity;</span><br><span class="line">                treasureEntity.SetPosition(position.x, position.y, position.z);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(mapDataExport <span class="keyword">is</span> TrapMapDataExport)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> trapEntity = OwnerWorld.CreateEtity&lt;TrapEntity&gt;(MapGameConst.TrapPrefabPath);</span><br><span class="line">                entity = trapEntity;</span><br><span class="line">                trapEntity.SetPosition(position.x, position.y, position.z);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                Debug.LogError(<span class="string">$&quot;不支持的MapDataExport类型:<span class="subst">&#123;mapDataExport.GetType().Name&#125;</span>,检测MapDataEntity创建失败！&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(entity != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                AddMapDataSpawnedEntityUuid(mapDataExport, entity.Uuid);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 检查已经生成的Entity回收</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">CheckAllSpawnEntityRemove</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mTempRemoveSpawnedMapDataExportList.Clear();</span><br><span class="line">        <span class="keyword">foreach</span>(<span class="keyword">var</span> spawnedMapDataEntity <span class="keyword">in</span> mSpawnedMapDataEntityMap)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> entityUuid = spawnedMapDataEntity.Value;</span><br><span class="line">            <span class="keyword">var</span> actorEntity = OwnerWorld.GetEntityByUuid&lt;BaseActorEntity&gt;(entityUuid);</span><br><span class="line">            <span class="keyword">if</span> (actorEntity == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">var</span> entityPosition = actorEntity.Position;</span><br><span class="line">            mTempMapDataExportPos.x = entityPosition.x;</span><br><span class="line">            mTempMapDataExportPos.y = entityPosition.z;</span><br><span class="line">            <span class="keyword">if</span>(!Collision2DUtilities.PointInAABB(mCameraRectArea, mTempMapDataExportPos))</span><br><span class="line">            &#123;</span><br><span class="line">                mTempRemoveSpawnedMapDataExportList.Add(spawnedMapDataEntity.Key);</span><br><span class="line">                OwnerWorld.DestroyEntityByUuid(entityUuid);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">foreach</span>(<span class="keyword">var</span> removeSpawnMapDataExport <span class="keyword">in</span> mTempRemoveSpawnedMapDataExportList)</span><br><span class="line">        &#123;</span><br><span class="line">            RemoveMapDataSpawned(removeSpawnMapDataExport);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面的代码已经成功检测到地图埋点位置在可视域就创建，不在可视域就销毁的逻辑。</p>
<p><img src="/img/Unity/MapEditor/DynamicCreateMapData1.PNG" alt="DynamicCreateMapData1"></p>
<p><img src="/img/Unity/MapEditor/DynamicCreateMapData2.PNG" alt="DynamicCreateMapData2"></p>
<p>从截图可以看到近处的两个红色怪物埋点因为超出了摄像机区域后被销毁了，而远处两个宝箱和陷阱因为进入摄像机照射区域而创建显示了。</p>
<h1 id="学习总结"><a href="#学习总结" class="headerlink" title="学习总结"></a>学习总结</h1><ol>
<li><strong>EditorWindow配置编辑器基础可配置数据，Inspector面板提供地图编辑器操作入口和数据序列化存储</strong></li>
<li><strong>地图对象通过序列化位置+旋转+碰撞等数据可以实现场景编辑后一键更新所有场景对象效果</strong></li>
<li><strong>地图对象数据存储可以挂在Mono脚本或自定义数据导出实现场景对象相关配置数据存储和导出</strong></li>
<li><strong>数据埋点显示和操作通过Gizmo和Handles可以实现自己设计的操作交互和显示</strong></li>
<li><strong>摄像机可视域的计算和判定基本上就是数学上的运算</strong></li>
</ol>
<h1 id="Github"><a href="#Github" class="headerlink" title="Github"></a>Github</h1><p><a target="_blank" rel="noopener" href="https://github.com/TonyTang1990/MapEditor">MapEditor</a></p>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a href="http://tonytang1990.github.io/2021/01/21/%E7%A2%B0%E6%92%9E%E6%A3%80%E6%B5%8B/">碰撞检测</a></p>
<p><a href="http://tonytang1990.github.io/2022/02/20/UnityEditor%E7%9F%A5%E8%AF%86/">UnityEditor知识</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Editor/">Editor</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Editor/">Editor</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2023/05/20/UIToolkit学习/" title="UIToolkit" itemprop="url">UIToolkit</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Tony Tang" target="_blank" itemprop="author">Tony Tang</a>
		
  <p class="article-time">
    <time datetime="2023-05-20T00:43:00.000Z" itemprop="datePublished"> 发表于 2023-05-20</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>之前有一篇学习Unity Editor相关的知识:<a href="http://tonytang1990.github.io/2022/02/20/UnityEditor%E7%9F%A5%E8%AF%86">UnityEditor知识</a></p>
<p>UIToolkit作为Unity最新一代UI系统，这里准备单独用篇来学习记录，通过深入学习UIToolkit，为后续编写一套节点系统做准备(用于AI系统，剧情系统和引导系统实现)。</p>
<p>Note:</p>
<ol>
<li><strong>本章节重点是UIToolkit在Editor上的学习使用，Runtime目前看来UIToolkit还不够成熟，不适合用到Runtime(2023&#x2F;5&#x2F;20)</strong></li>
</ol>
<h1 id="UIToolkit"><a href="#UIToolkit" class="headerlink" title="UIToolkit"></a>UIToolkit</h1><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/2020.3/Documentation/Manual/UIToolkits.html">UI Toolkit is the newest UI system in Unity. It’s designed to optimize performance across platforms, and is based on standard web technologies. You can use UI Toolkit to create extensions for the Unity Editor, and to create runtime UI for games and applications (when you install the UI Toolkit package.</a></p>
<p>看官方介绍可以看出，UI Toolkit是官方推的新一代UI系统，基于Web技术概念的一套UI系统，可用于Editor和运行时通吃。</p>
<p>UI Toolkit由三大部分组成:</p>
<ol>
<li>UI system(<a target="_blank" rel="noopener" href="https://docs.unity3d.com/2020.3/Documentation/Manual/UIElements.html">Contains the core features and functionality required to create user interfaces.</a>)</li>
<li>UI Assets(<a target="_blank" rel="noopener" href="https://docs.unity3d.com/2020.3/Documentation/Manual/UIElements.html">Asset types inspired by standard web formats. Use them to structure and style UI.</a>)(个人理解类似UI布局文件Asset)</li>
<li>Tools and resources(<a target="_blank" rel="noopener" href="https://docs.unity3d.com/2020.3/Documentation/Manual/UIElements.html">Create and debug your interfaces, and learn how to use UI toolkit.</a>)</li>
</ol>
<h2 id="UI-system"><a href="#UI-system" class="headerlink" title="UI  system"></a>UI  system</h2><p>UI系统由以下部分组成:</p>
<ol>
<li>Visual tree(<a target="_blank" rel="noopener" href="https://docs.unity3d.com/2020.3/Documentation/Manual/UIElements.html">Defines every user interface you build with the UI Toolkit. A visual tree is an object graph, made of lightweight nodes, that holds all the elements in a window or panel.</a>)(定义UI界面的数据，包含了所有组成UI显示的成员节点信息)</li>
<li>Controls(<a target="_blank" rel="noopener" href="https://docs.unity3d.com/2020.3/Documentation/Manual/UIElements.html">A library of standard UI controls such as buttons, popups, list views, and color pickers. You can use them as-is, customize them, or create your own controls.</a>)(UI组件)</li>
<li>Data binding system(<a href="">Links properties to the controls that modify their values.</a>)(关联数据属性到UI组件)</li>
<li>Layout Engine(<a target="_blank" rel="noopener" href="https://docs.unity3d.com/2020.3/Documentation/Manual/UIElements.html">A layout system based on the CSS Flexbox model. It positions elements based on layout and styling properties.</a>)(类似CSS的UI布局系统)</li>
<li>Event System(<a target="_blank" rel="noopener" href="https://docs.unity3d.com/2020.3/Documentation/Manual/UIElements.html">Communicates user interactions to elements; for example, input, touch and pointer interactions, drag and drop operations, and other event types. The system includes a dispatcher, a handler, a synthesizer, and a library of event types.</a>)(UI事件系统，负责事件的分发等)</li>
<li>UI Renderer(<a target="_blank" rel="noopener" href="https://docs.unity3d.com/2020.3/Documentation/Manual/UIElements.html">A <strong>rendering</strong> system built directly on top of Unity’s graphics device layer.</a>)(在Unity基础上设计的UI渲染系统)</li>
<li>UI Toolkit Runtime Support(<a target="_blank" rel="noopener" href="https://docs.unity3d.com/2020.3/Documentation/Manual/UIElements.html">Contains the components required to create runtime UI. The UI Toolkit package is currently in preview.</a>)</li>
</ol>
<h3 id="Visual-tree"><a href="#Visual-tree" class="headerlink" title="Visual tree"></a>Visual tree</h3><p>Visual tree由VisualElement组成，VisualElement是所有UI Toolkit的节点基类，VisualElment包含了所有UI组件，排版，UI风格，UI事件处理等数据信息。</p>
<p>UI元素绘制顺序树广度扩展:</p>
<p><img src="/img/Unity/UIToolkit/UIToolkitDrawingOrder.png" alt="UIToolkitDrawingOrder"></p>
<p>UIToolkit里的坐标系分为两种：</p>
<ol>
<li>Relative(position: relative相对坐标系)</li>
<li>Absolute(position: absolute绝对坐标系)</li>
</ol>
<p>上面两个坐标系和Unity里的相对位置和世界位置的概念差不多。</p>
<p>Note:</p>
<ol>
<li><strong>坐标原点在左上角</strong></li>
<li><strong>VisualElementExtensions的扩展方法里提供了坐标系转换相关的方法和接口</strong></li>
</ol>
<h3 id="Layout-Engine"><a href="#Layout-Engine" class="headerlink" title="Layout Engine"></a>Layout Engine</h3><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/2020.3/Documentation/Manual/UIE-LayoutEngine.html">UI Toolkit includes a layout engine that positions visual elements based on layout and styling properties.</a>(UI Toolkit的排版系统是基于VisualElement的排版和Styling属性设置决定的)</p>
<h3 id="UXML-format"><a href="#UXML-format" class="headerlink" title="UXML format"></a>UXML format</h3><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/2020.3/Documentation/Manual/UIE-UXML.html">Unity Extensible Markup Language (UXML) files are text files that define the structure of the user interface. </a>(Unity支持用UXML来描述UI界面组件数据)</p>
<p><strong>可以使用<a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/UIBuilder.html">UI Builder</a>实现可视化布局编辑。</strong></p>
<p><strong>UXML通过代码动态创建的数据对象类为VisualElementAssets。</strong></p>
<p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/UIE-ElementRef.html">UXML现有可用Element查询</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/UIE-uxml-examples.html">UXML布局构建事例</a></p>
<p>深入使用，待学习……</p>
<p>Note:</p>
<ol>
<li><strong>You can’t generate a VisualTreeAsset from raw UXML at runtime.</strong></li>
</ol>
<h3 id="Uity-style-sheets-USS"><a href="#Uity-style-sheets-USS" class="headerlink" title="Uity style sheets(USS)"></a>Uity style sheets(USS)</h3><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/2020.3/Documentation/Manual/UIE-USS.html">Style properties are either set in C# or from a style sheet. Style properties have their own data structure (<code>IStyle</code> interface). UI Toolkit supports style sheets written in USS (Unity style sheet).</a>(Unity支持定义类似CSS的USS文件来定义UI界面使用的Style属性设置)</p>
<p><strong>USS通过代码动态创建的数据对象类为StyleSheet</strong></p>
<p>USS包含以下部分:</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/UIE-about-uss.html">Style rules that include a selector and a declaration block.</a>(个人理解Style定义包含选择器和内容定义)</li>
<li><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/UIE-about-uss.html">Selectors that identify which visual element the style rule affects.</a>(选择器用于匹配Element的Style使用)</li>
<li><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/UIE-about-uss.html">A declaration block, inside curly braces, that has one or more style declarations. Each style declaration has a property and a value. Each style declaration ends with a semi-colon.</a>(内容定义Style的详细配置)</li>
</ol>
<h4 id="USS-Selector"><a href="#USS-Selector" class="headerlink" title="USS Selector"></a>USS Selector</h4><p>Style选择器分有很多种，简单的选择器有:</p>
<h5 id="Type-selector"><a href="#Type-selector" class="headerlink" title="Type selector"></a>Type selector</h5><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/UIE-USS-Selectors-type.html">type selectors match elements based on their element types.</a>(通过类型名字匹配)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Button &#123;</span><br><span class="line">  border-radius: 8px;</span><br><span class="line">  width: 100px;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;Button name=&quot;Cancel&quot; text=&quot;Cancel&quot; /&gt;</span><br></pre></td></tr></table></figure>

<p>Note:</p>
<ul>
<li><strong>type selector的名字不允许包含命名空间</strong></li>
</ul>
<h5 id="Class-selector"><a href="#Class-selector" class="headerlink" title="Class selector"></a>Class selector</h5><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/UIE-USS-Selectors-class.html">class selectors match elements that have specific USS classes assigned. </a>(通过定义类名匹配)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.yellow &#123;</span><br><span class="line">    background-color: yellow;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;Button name=&quot;OK&quot; class=&quot;yellow&quot; text=&quot;OK&quot; /&gt;</span><br></pre></td></tr></table></figure>

<p>Note:</p>
<ul>
<li><strong>calss selector大小写敏感且不允许带数字</strong></li>
</ul>
<h5 id="Name-selector"><a href="#Name-selector" class="headerlink" title="Name selector"></a>Name selector</h5><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/UIE-USS-Selectors-name.html">name selectors match elements based on the name of an element.</a>(通过名字匹配)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#Cancel &#123;</span><br><span class="line">    border-width: 2px;</span><br><span class="line">    border-color: DarkRed;</span><br><span class="line">    background-color: pink;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;Button name=&quot;Cancel&quot; text=&quot;Cancel&quot; /&gt;</span><br></pre></td></tr></table></figure>

<p>Note:</p>
<ul>
<li><strong>代码里可以通过VisualElement.name修改去匹配Name Selector</strong></li>
</ul>
<h5 id="Universal-selector"><a href="#Universal-selector" class="headerlink" title="Universal selector"></a>Universal selector</h5><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/UIE-USS-Selectors-universal.html">universal selector, also called the wildcard selector, matches any element.</a>(通过通配符(正则)去匹配)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">* &#123;</span><br><span class="line">    background-color: yellow;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;VisualElement name=&quot;container1&quot;&gt;</span><br><span class="line">    &lt;VisualElement name=&quot;container2&quot; class=&quot;yellow&quot;&gt;</span><br><span class="line">      &lt;Button name=&quot;OK&quot; class=&quot;yellow&quot; text=&quot;OK&quot; /&gt;</span><br><span class="line">      &lt;Button name=&quot;Cancel&quot; text=&quot;Cancel&quot; /&gt;</span><br><span class="line">&lt;/VisualElement&gt;</span><br></pre></td></tr></table></figure>

<p>更多复杂的选择器参考:</p>
<p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/UIE-about-uss.html">Complex selectors</a></p>
<h4 id="USS-properties"><a href="#USS-properties" class="headerlink" title="USS properties"></a>USS properties</h4><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/UIE-uss-properties.html">USS property assigns a style or behavior to a VisualElement. </a>(USS的内容属性用于给VisualElement指定具体显示配置)</p>
<h5 id="USS-data-types"><a href="#USS-data-types" class="headerlink" title="USS data types"></a>USS data types</h5><p>Syntax - auto, <legnth>,<color>等。</p>
<p>​	如果一个属性有多个值，可以如下方式表达不同含义：</p>
<ul>
<li><p>Side-by-side表示全部都必须按顺序出现</p>
</li>
<li><p>|表示多个选择里必须出现一个</p>
</li>
<li><p>||表示1个或多个必须按顺序出现</p>
</li>
<li><p>&amp;&amp;表示所有都必须出现</p>
</li>
<li><p>[]表示一个选择组(类似正则里[]的概念)</p>
<p>上面提到的属性多个值都支持类似正则里*,+,?,{A,B}的后缀描述，表达的含义也就是类似正则里的出现次数控制。</p>
</li>
</ul>
<p>Length - 支持像素(px)和百分比(%)两种长度单位</p>
<p>initial - 全局关键词，标识重置属性到初始默认值</p>
<p>Color - 支持16进制(#FFFFFF)和rgb表达方式(rgba(255, 255, 255, 1))</p>
<p>​	Color关键词详情查看:</p>
<p>​	<a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/UIE-uss-color-keywords.html">USS color keywords</a></p>
<p>Assets - 支持引用项目里的资源，resource()(标识使用Resources目录资源)，url()(标识使用项目Asset资源，支持相对USS所在目录的相对路径和项目相对路径)</p>
<h5 id="USS-common-properties"><a href="#USS-common-properties" class="headerlink" title="USS common properties"></a>USS common properties</h5><p>在了解一些常规布局属性概念前，让我们先来看看官网给的一张示意图:</p>
<p><img src="/img/Unity/UIToolkit/USSBoxModel.png" alt="USSBoxModel"></p>
<h6 id="宽高属性"><a href="#宽高属性" class="headerlink" title="宽高属性"></a>宽高属性</h6><p>width(宽度)，height(高度)，min-width(最小宽度)，min-height(最小高度)，max-width(最大宽度)，max-height(最大高度)……</p>
<h6 id="边缘-Margins-属性"><a href="#边缘-Margins-属性" class="headerlink" title="边缘(Margins)属性"></a>边缘(Margins)属性</h6><p>margin-left(左侧边缘)，margin-top(顶部边缘)，margin-right(右侧边缘)，margin-bottom(底部边缘)……</p>
<h6 id="边界-Border-属性"><a href="#边界-Border-属性" class="headerlink" title="边界(Border)属性"></a>边界(Border)属性</h6><p>border-left-width(左侧边界)，border-top-width(顶部边界)，border-right-width(右侧边界)，border-bottom-width(底部边界)，border-color(边界颜色)……</p>
<h6 id="内边距-Padding-属性"><a href="#内边距-Padding-属性" class="headerlink" title="内边距(Padding)属性"></a>内边距(Padding)属性</h6><p>padding-left(左侧内边距)，padding-top(顶部内边距)，padding-right(右侧内边距)，padding-bottom(底部内边距)……</p>
<h6 id="排版属性"><a href="#排版属性" class="headerlink" title="排版属性"></a>排版属性</h6><ul>
<li>Items<ul>
<li>flex-grow(排版放大设置)</li>
<li>flex-shrink(排版缩小设置)</li>
<li>flex-basic(排版大小设置)</li>
<li>align-self(自身对齐设置)</li>
<li>……</li>
</ul>
</li>
<li>Containers<ul>
<li>flex-direction(子成员排版对齐方向)</li>
<li>flex-wrap(子成员放不下是否多行显示排版)</li>
<li>align-content(子成员在排版方向上的对齐方式)</li>
<li>……</li>
</ul>
</li>
</ul>
<h6 id="位置属性"><a href="#位置属性" class="headerlink" title="位置属性"></a>位置属性</h6><p>position(位置坐标系-绝对|相对)，left(距离父容器左测距离)，top(距离父容器顶部距离)，right(距离父容器右侧距离)，bottom(距离父容器底部距离)……</p>
<p>UIToolkit里的坐标属性有两种坐标系:</p>
<ol>
<li>绝对坐标</li>
<li>相对坐标</li>
</ol>
<p>Note:</p>
<ol>
<li><strong>设置了Left,Top,Right,Bottom后，Width属性相关设置会被忽略。</strong></li>
<li><strong>绝对坐标适合一些固定位置的弹窗，绝对坐标确定位置后，内部用局部坐标排版UI显示</strong></li>
</ol>
<h6 id="背景属性"><a href="#背景属性" class="headerlink" title="背景属性"></a>背景属性</h6><p>background-color(背景颜色)，backtground-image(背景图片)，-unity-background-scale-mode(背景图片缩放模式)，-unity-background-image-tint-color(背景图片色调?)……</p>
<h6 id="九宫属性"><a href="#九宫属性" class="headerlink" title="九宫属性"></a>九宫属性</h6><p>-unity-slice-left(左侧切割数值)，-unity-slice-top(顶部切割数值)，-unity-slice-right(右侧切割数值)，-unity-slice-bottom(底部切割数值)，-unity-slice-scale(九宫缩放值?)……</p>
<h6 id="Appearance-外观-属性"><a href="#Appearance-外观-属性" class="headerlink" title="Appearance(外观)属性"></a>Appearance(外观)属性</h6><p>overflow(溢出显示设置),-unity-overflow-clip-box(溢出裁剪box设置),-unity-paragraph-spacing(段落间隔设置),opacity(透明度显示设置),visibility(可见性设置),display(排版显示设置)……</p>
<h6 id="文本属性"><a href="#文本属性" class="headerlink" title="文本属性"></a>文本属性</h6><p>color(绘制颜色设置),-unity-font(绘制文本字体设置),-unity-font-definition(?),font-size(字体大小设置),-unity-font-style(字体风格设置),-unity-text-align(字体对齐设置),-unity-text-overflow-position(?),white-space(空格处理方式设置),-unity-text-outline-width(描边宽度设置),-unity-text-outline-color(描边颜色设置)……</p>
<p>详细USS properties查看:</p>
<p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/UIE-uss-properties.html">USS properties reference</a></p>
<p>W3C CSS的详细属性效果查看:</p>
<p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/CSS">CSS</a></p>
<p>Note:</p>
<ol>
<li><strong><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/UIE-USS-PropertyTypes.html">USS properties use the same syntax as W3C CSS documents</a>(USS的内容属性采用W3C CSS相关文档规则)</strong></li>
<li><strong><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/UIE-USS-SupportedProperties.html">The USS display property supports only a small subset of the CSS <code>display</code> property’s available keyword values.</a>(USS的属性支持只是CSS的很小部分子集)</strong></li>
</ol>
<h4 id="USS-custom-properties"><a href="#USS-custom-properties" class="headerlink" title="USS custom properties"></a>USS custom properties</h4><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/UIE-USS-variables.html">USS variables, also called custom properties, define values that you can reuse in other USS rules. You can create variables for any type of USS property.</a></p>
<p>可以看到USS支持在USS文件里自定义变量，然后像编程里的变量一样，一处定义多处使用。</p>
<p>USS自定义变量规则如下:</p>
<p><strong>–变量名:值</strong></p>
<p>USS自定义变量在其他USS文件访问规则:</p>
<p><strong>var(–变量名, 默认值(可选))</strong></p>
<p>内置自定义变量查询:</p>
<p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/UIE-uss-built-in-variable-reference.html">USS built-in variable references</a></p>
<h4 id="Best-practices-for-USS"><a href="#Best-practices-for-USS" class="headerlink" title="Best practices for USS"></a>Best practices for USS</h4><p>官方关于使用USS Style的建议:</p>
<ol>
<li><strong>Avoid inline styles(个人理解是使用全局USS File，避免对单个Visual Element设置Styles(会导致耗费更多内存))</strong></li>
<li><strong>Selector architecture consideration(选择合适的selector方案，过多或过于复杂的selector方案会导致运行时选择style开销更大)</strong></li>
</ol>
<p>更多建议参考:</p>
<p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/UIE-USS-WritingStyleSheets.html">Best practices for USS</a></p>
<h4 id="Theme-Style-Sheet-TSS"><a href="#Theme-Style-Sheet-TSS" class="headerlink" title="Theme Style Sheet(TSS)"></a>Theme Style Sheet(TSS)</h4><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/UIE-tss.html">Theme Style Sheet (TSS) files are regular USS files. UI Toolkit treats TSS as a distinct asset type and uses it for management purposes.</a></p>
<p>更多学习，待添加……</p>
<h3 id="Query-Elements"><a href="#Query-Elements" class="headerlink" title="Query Elements"></a>Query Elements</h3><p><strong>Unity提供了Query功能(类似Linq)，方便用户快速从VisualTree或Elements里查找符合条件的Element。</strong></p>
<ul>
<li><p>UQuery</p>
<p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/ScriptReference/UIElements.UQuery.html">UQuery is a set of extension methods allowing you to select individual or collection of visualElements inside a complex hierarchy.</a>(一系列扩展方法用于查询指定VisualElements)</p>
</li>
<li><p>UQueryBuilder</p>
<p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/ScriptReference/UIElements.UQueryBuilder_1.html">Utility Object that contructs a set of selection rules to be ran on a root visual element.</a>(工具类，辅助UQuery构建一系列查询规则)</p>
</li>
<li><p>Q</p>
<p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/UIE-UQuery.html">Q is the shorthand for Query<T>.First(). It returns the first element that matches the selection rules.</a>(Q是查询首个符合规则的Element的缩写)</p>
</li>
</ul>
<h3 id="Event-System"><a href="#Event-System" class="headerlink" title="Event System"></a>Event System</h3><h4 id="Dispatch-Events"><a href="#Dispatch-Events" class="headerlink" title="Dispatch Events"></a>Dispatch Events</h4><p>UIToolkit Event System监听系统事件，然后通过EventDispatcher派发事件给Visual Element。</p>
<p>所有的事件派发都会经历以下三个阶段：</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/UIE-Events-Dispatching.html">Trickles down: Events sent to elements during the trickle down phase.</a>(个人没太理解这个阶段，感觉是一个事件捕获<strong>从上往下</strong>派发事件的过程(<strong>不含响应事件的最里层Visual Element</strong>)</li>
<li><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/UIE-Events-Dispatching.html">Bubbles up: Events sent to elements during the bubble-up phase.</a>(事件从目标节点向上冒泡派发给Visual Element的，即最里层符合的Visual Element最先派发(<strong>从下往上</strong>)(<strong>含响应事件最里层Visual Element</strong>))</li>
<li><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/UIE-Events-Dispatching.html">Cancellable: Events that can have their default action execution cancelled, stopped, or prevented.</a>(事件是可取消的，比如一般的事件冒泡为了不继续想外层冒泡，我们会设置事件阻断防止继续冒泡)</li>
</ol>
<p><img src="/img/Unity/UIToolkit/EventPropagation.png" alt="EventPropagation"></p>
<p><strong>通过上面的介绍可以了解到，事件派发有两个流程(Trickles down &amp; Bubbles up)，在不打断事件派发的前提下，最里层响应Visual Element只会派发一次，其他外层传递路线上的Visual Element会派发两次事件。</strong></p>
<p>事件基类为EventBase，所有相关事件介绍参考:</p>
<p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/UIE-Events-Reference.html">Event reference</a></p>
<p>Note:</p>
<ol>
<li><strong><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/UIE-Events.html">The UI Toolkit event system shares the same terminology and event naming as HTML events</a>(UIToolkit采用和HTML一样的事件名和术语)</strong></li>
</ol>
<h4 id="Handle-Events"><a href="#Handle-Events" class="headerlink" title="Handle Events"></a>Handle Events</h4><p>事件处理顺序如下：</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/UIE-Events-Handling.html">Execute event callbacks on elements from the root element down to the parent of the event target. This is the <strong>trickle-down phase</strong> of the dispatch process.</a>(事件捕获阶段从上往下触发事件)</li>
<li><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/UIE-Events-Handling.html">Execute event callbacks on the event target. This is the <strong>target phase</strong> of the dispatch process.</a>(在目标响应Visual Element上触发事件)</li>
<li><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/UIE-Events-Handling.html">Call ExecuteDefaultActionAtTarget() on the event target.</a>(在目标响应Visual Element上触发ExecuteDefaultActionAtTarget()方法)</li>
<li><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/UIE-Events-Handling.html">Execute event callbacks on elements from the event target parent up to the root. This is the <strong>bubble-up phase</strong> of the dispatch process.</a>(从目标Visual Element开始向上冒泡触发事件)</li>
<li><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/UIE-Events-Handling.html">Call ExecuteDefaultAction() on the event target.</a>(在目标响应Visual Element上触发ExecuteDefaultAction()方法)</li>
</ol>
<p>事件响应里有两个重要的概念:</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/UIE-Events-Dispatching.html">Event.currentTarget is the visual element on which the callback was registered.</a>(当前注册响应事件的Visual Element)</li>
<li><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/UIE-Events-Dispatching.html">Event.target is the element where the event occurs, for example the element directly under the mouse.</a>(当前事件发生的Visual Element)</li>
</ul>
<p><strong><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/UIE-Events-Handling.html">By default, a registered callback executes during the target phase and the bubble-up phase. This default behavior ensures that a parent element reacts after its child element.</a>(默认状态下，我们注册的事件回调是在target phase和bubble-up phase阶段执行。这是为了确保事件回调触发是从下往上)</strong></p>
<p>如果我们想在指定阶段(e.g. tickle-down phase或bubble-up phase)触发注册事件回调，我们需要在注册事件回调处，显示传参说明响应阶段:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">VisualElement myElement = <span class="keyword">new</span> VisualElement();</span><br><span class="line"></span><br><span class="line">myElement.RegisterCallback&lt;MouseDownEvent&gt;(MyCallback, TrickleDown.TrickleDown);</span><br></pre></td></tr></table></figure>

<p>如果我们想事件传递自定义数据，我们需要自定义一个含自带数据的方法回调并监听事件：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">myElement.RegisterCallback&lt;MouseDownEvent, MyType&gt;(MyCallbackWithData, myData);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MyCallbackWithData</span>(<span class="params">MouseDownEvent evt, MyType data</span>)</span> &#123; <span class="comment">/* ... */</span> &#125;</span><br></pre></td></tr></table></figure>

<p>相关事件信息查询:</p>
<p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/UIE-Events-Reference.html">Event Reference</a></p>
<h3 id="SerializedObject-Data-Binding"><a href="#SerializedObject-Data-Binding" class="headerlink" title="SerializedObject Data Binding"></a>SerializedObject Data Binding</h3><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/UIE-Binding.html">A binding refers to the link between the property and the visual control that modifies it.</a>(数据绑定是用于快速关联UI组件和数据属性，实现UI组件快速修改数据属性)</p>
<p>数据绑定要求:</p>
<ol>
<li><p><strong>数据绑定只支持可序列化的属性或类(e.g. ScriptableObject, MonoBehaviour, int, bool, float, Vector3, Color, Object……)</strong></p>
</li>
<li><p><strong><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/UIE-Binding.html">You can only bind the value property of visual elements that implement the INotifyValueChanged interface.</a> (值绑定Visual Element只在实现了INotifyValueChanged接口的组件允许)</strong></p>
</li>
<li><p><strong><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/UIE-Binding.html">You can bind between an object and any visual element that either derives from BindableElement or implements the IBindable interface.</a>(object绑定Visual Element只在继承BindableElement或实现了IBindable接口的组件允许)</strong></p>
</li>
</ol>
<p>数据绑定接口:</p>
<ol>
<li><p><strong>Bind() - 绑定VisualElement到指定ScriptableObject</strong></p>
<p><strong>调用Bind前需要设置bindingPath指定哪些属性需要绑定</strong></p>
</li>
<li><p><strong>Unbind() - 解绑VisualElement(含子VisualElement)</strong></p>
<p><strong>EditorWindow关闭会自动解绑，我们只需要在绑定不同数据来源时调用Unbind</strong></p>
</li>
<li><p><strong>bindingPath - 给VisualElement指定需要绑定的属性</strong></p>
<p><strong>bindingPath就是绑定属性的名字</strong></p>
</li>
<li><p><strong>BindProperty() - 绑定VisualElement到制定SerializedProperty</strong></p>
<p><strong>需要自定义哪些属性需要绑定显示的时候</strong></p>
</li>
<li><p><strong>TrackPropertyValue() - 检查指定VisualElement绑定的属性是否变化，变化后触发回调通知</strong></p>
</li>
<li><p><strong>TrackSerializedObjectValue() - 任何VisualElement绑定的属性变化时触发回调通知</strong></p>
</li>
</ol>
<p>官方建议:</p>
<ol>
<li><strong>自定义Editor或PropertyDrawer，建议使用bindingPath而非Bind()和BindProperty()</strong></li>
<li><strong>尽量避免多次对相同VisualElement调用Bind()，为性能考虑</strong></li>
</ol>
<p>Note:</p>
<ol>
<li><strong><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/UIE-Binding.html">SerializedObject data binding only works in the Editor, not at runtime.</a>(SerializedObject的数据绑定只支持Editor模式不支持Runtime模式)</strong></li>
<li><strong><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/UIE-Binding.html">bind a visual element to nested properties in the source object</a>(VisualElement支持绑定到嵌套属性)</strong></li>
<li><strong><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/UIE-Binding.html">Don’t call Bind() from the Editor.CreateInspectorGUI() or PropertyDrawer.CreatePropertyGUI() override. These overrides are called automatically on the visual elements that these methods return.</a>(Editor.CreateInspectorGUI()和 PropertyDrawer.CreatePropertyGUI()里要调用Bind，在这两个方法返回后会自动Bind所有返回的Visual Elements)</strong></li>
</ol>
<h2 id="UI-Assets"><a href="#UI-Assets" class="headerlink" title="UI Assets"></a>UI Assets</h2><p>Unity提供了两种Asset用于布局系统</p>
<ol>
<li>UXML documents(<a target="_blank" rel="noopener" href="https://docs.unity3d.com/2020.3/Documentation/Manual/UIElements.html">Unity eXtensible Markup Language (UXML) is an HTML and XML inspired markup language that you use to define the structure of user interfaces and reusable UI templates.</a>)(类似HTML和XML的标记性语言，用于定义UI布局)</li>
<li>Unity Style Sheets(USS)(<a target="_blank" rel="noopener" href="https://docs.unity3d.com/2020.3/Documentation/Manual/UIElements.html">Style sheets allow you to apply visual styles and behaviors to user interfaces. They’re similar to Cascading Style Sheets (CSS) used on the web, and support a subset of standard CSS properties. </a>)(类似CSS用于定义UI风格)</li>
</ol>
<h2 id="UI-Tools-and-resources"><a href="#UI-Tools-and-resources" class="headerlink" title="UI Tools and resources"></a>UI Tools and resources</h2><p>Unity提供了几个辅助工具，帮助我们学习和调试UI Toolkit</p>
<ol>
<li><p><strong>UI Debugger(UI调试器–可视化查看UI节点详细数据)</strong></p>
<p><img src="/img/Unity/UIToolkit/UIToolkitDebuggerPreview.PNG" alt="UIToolkitDebuggerPreview"></p>
</li>
<li><p><strong>UI Builder(UI布局可视化编辑器(预览版本))</strong></p>
<p><img src="/img/Unity/UIToolkit/UIBuilder.PNG" alt="UIBuilder"></p>
</li>
<li><p><strong>UI Samples(UI事例)</strong></p>
<p><img src="/img/Unity/UIToolkit/UIToolkitSampleWindow.PNG" alt="UIToolkitSampleWindow"></p>
</li>
</ol>
<h2 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h2><p>接下来通过实战学习，进一步了解UIToolkit的使用和设计。</p>
<h3 id="基础学习"><a href="#基础学习" class="headerlink" title="基础学习"></a>基础学习</h3><h4 id="代码-USS创建UI"><a href="#代码-USS创建UI" class="headerlink" title="代码+USS创建UI"></a>代码+USS创建UI</h4><h5 id="代码创建UI"><a href="#代码创建UI" class="headerlink" title="代码创建UI"></a>代码创建UI</h5><p>UIToolkit为了帮助我们快速创建Editor UI窗口，提供了快捷创建入口:</p>
<p>Asset-&gt;Create-&gt;UI Toolkit-&gt;Editor Window</p>
<p><img src="/img/Unity/UIToolkit/UIToolkitEditorWindowCreator.PNG" alt="UIToolkitEditorWindowCreator"></p>
<p>考虑到不适用UXML作为UI布局，使用纯代码写Editor UI，这里就不勾选UXML了。</p>
<p>创建完会看到生成一个*.cs文件和一个*.uss文件，这是因为我们勾选了C#和USS，接下来我们打开UICreateUIByCodeEditorWindow.cs开始我们的Editor UI代码编写，后续会讲到如何利用*.uss文件来指定UI风格。</p>
<p>UICreateUIByCodeEditorWindow.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UICreateUIByCodeEditorWindow</span> : <span class="title">EditorWindow</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">MenuItem(<span class="string">&quot;Window/UI Toolkit/UIToolkitStudy/UICreateUIByCodeEditorWindow&quot;</span>)</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ShowUICodeStyleEditorWindow</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        UICreateUIByCodeEditorWindow wnd = GetWindow&lt;UICreateUIByCodeEditorWindow&gt;();</span><br><span class="line">        wnd.titleContent = <span class="keyword">new</span> GUIContent(<span class="string">&quot;UICreateUIByCodeEditorWindow&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> UIToolkit的rootVisualElement绘制方法</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">CreateGUI</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        CreateUIByCode();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 通过代码创建UI</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">CreateUIByCode</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 创建一个ui容器，用于管理我们新增的ui组件</span></span><br><span class="line">        VisualElement uiContainer = <span class="keyword">new</span> VisualElement();</span><br><span class="line">        <span class="comment">// 添加一个标题作为ui容器标题组件显示</span></span><br><span class="line">        Label uiTitleLable = <span class="keyword">new</span> Label(<span class="string">&quot;代码创建UI容器&quot;</span>);</span><br><span class="line">        uiContainer.Add(uiTitleLable);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 添加按钮组件</span></span><br><span class="line">        Button btn1 = <span class="keyword">new</span> Button();</span><br><span class="line">        btn1.text = <span class="string">&quot;代码创建按钮1&quot;</span>;</span><br><span class="line">        uiContainer.Add(btn1);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 必须将需要显示的组件添加到根节点才能显示</span></span><br><span class="line">        <span class="comment">// 将ui容器添加到根节点作为需要显示的UIElement</span></span><br><span class="line">        rootVisualElement.Add(uiContainer);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/img/Unity/UIToolkit/UICreateUIByCodeEditorWindow.PNG" alt="UICreateUIByCodeEditorWindow"></p>
<p>可以看到编写基于UIToolkit的Editor Window还是和以往一样，要继承EditorWindow，但实现GUI绘制的接口不是<strong>OnGUI()<strong>而是</strong>CreateGUI()</strong>。</p>
<p>正如前面提到的UIToolkit里绘制的对象Visual Tree是由Visual Element组成的树状结构。而<strong>EditorWindow.rootVisualElement正是UIToolkit绘制EditorWindow的根VisualElement</strong>，我们所有的UIToolkit元素都是添加到此EditorWindow.rootVisualElement实现排版绘制的。</p>
<h5 id="代码修改USS"><a href="#代码修改USS" class="headerlink" title="代码修改USS"></a>代码修改USS</h5><p>所有的UIToolkit组件都继承至VisualElement，想通过代码修改UIToolkit组件的Style很简单，直接访问VisualElement.style即可。</p>
<p>UIChangeUSSByCodeEditorWindow.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 通过代码修改USS创建UI</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">CreateStyleUIByCode</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    ******</span><br><span class="line">    <span class="comment">// 给Label指定不同的Color Style</span></span><br><span class="line">    uiTitleLable.style.color = Color.red;</span><br><span class="line">    <span class="comment">// 设置Label居中显示Style</span></span><br><span class="line">    uiTitleLable.style.alignSelf = Align.Center;</span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/img/Unity/UIToolkit/UIChangeUSSByCodeEditorWindow.PNG" alt="UIChangeUSSByCodeEditorWindow"></p>
<p>可以看到通过访问style属性并修改其中的color属性，我成功的修改了标题文本的颜色显示风格。更多的属性修改参考文档:</p>
<p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/ScriptReference/UIElements.IStyle.html">IStyle</a></p>
<h5 id="使用USS指定UI风格"><a href="#使用USS指定UI风格" class="headerlink" title="使用USS指定UI风格"></a>使用USS指定UI风格</h5><p>第一步依然是使用Create-&gt;UI Toolkit-&gt;Editor WIndow</p>
<p>去掉UXML勾选，这里依然只通过代码和USS文件创建UI显示。</p>
<p>UIUseUSSEditorWindow.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UIUseUSSEditorWindow</span> : <span class="title">EditorWindow</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">MenuItem(<span class="string">&quot;Window/UI Toolkit/UIToolkitStudy/UIUseUSSEditorWindow&quot;</span>)</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ShowUIUseUSSEditorWidnow</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        UIUseUSSEditorWindow wnd = GetWindow&lt;UIUseUSSEditorWindow&gt;();</span><br><span class="line">        wnd.titleContent = <span class="keyword">new</span> GUIContent(<span class="string">&quot;UIUseUSSEditorWindow&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">CreateGUI</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        CreateUIByUseUSS();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 使用USS创建UI</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">CreateUIByUseUSS</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        VisualElement root = rootVisualElement;</span><br><span class="line">        <span class="comment">// 加载并指定USS的使用</span></span><br><span class="line">        <span class="keyword">var</span> styleSheet = AssetDatabase.LoadAssetAtPath&lt;StyleSheet&gt;(<span class="string">&quot;Assets/Scripts/Editor/UIToolkitStudy/UIUseUSSEditorWindow/UIUseUSSEditorWindow.uss&quot;</span>);</span><br><span class="line">        root.styleSheets.Add(styleSheet);</span><br><span class="line">        </span><br><span class="line">        VisualElement smallLabelWithStyle = <span class="keyword">new</span> Label(<span class="string">&quot;USS Using SmallLabel Class Selector!&quot;</span>);</span><br><span class="line">        smallLabelWithStyle.AddToClassList(<span class="string">&quot;SmallLabel&quot;</span>);</span><br><span class="line">        VisualElement bigLabelWithStyle = <span class="keyword">new</span> Label(<span class="string">&quot;USS Using BigLabel Class Selector!&quot;</span>);</span><br><span class="line">        smallLabelWithStyle.AddToClassList(<span class="string">&quot;BigLabel&quot;</span>);</span><br><span class="line">        VisualElement labelWithStyle = <span class="keyword">new</span> Label(<span class="string">&quot;USS Using Label Type Selector!&quot;</span>);</span><br><span class="line">        VisualElement boldLabelWithStyle = <span class="keyword">new</span> Label(<span class="string">&quot;USS Using BoldLabel Class Selector!&quot;</span>);</span><br><span class="line">        boldLabelWithStyle.AddToClassList(<span class="string">&quot;BoldLabel&quot;</span>);</span><br><span class="line">        root.Add(smallLabelWithStyle);</span><br><span class="line">        root.Add(bigLabelWithStyle);</span><br><span class="line">        root.Add(labelWithStyle);</span><br><span class="line">        root.Add(boldLabelWithStyle);</span><br><span class="line">        </span><br><span class="line">        Button ussCenterButton = <span class="keyword">new</span> Button();</span><br><span class="line">        ussCenterButton.name = <span class="string">&quot;CenterButton&quot;</span>;</span><br><span class="line">        ussCenterButton.text = <span class="string">&quot;Center USS Button Name Selector&quot;</span>;</span><br><span class="line">        root.Add(ussCenterButton);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>UIUseUSSEditorWindow.uss</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">Label &#123;</span><br><span class="line">	font-size: 20px;</span><br><span class="line">	color: rgb(68, 138, 255);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.SmallLabel &#123;</span><br><span class="line">	font-size: 10px;</span><br><span class="line">	color: rgb(68, 138, 255);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.BigLabel &#123;</span><br><span class="line">	font-size: 40px;</span><br><span class="line">	color: rgb(68, 138, 255);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.BoldLabel &#123;</span><br><span class="line">	font-size: 20px;</span><br><span class="line">	-unity-font-style: bold;</span><br><span class="line">	color: rgb(68, 138, 255);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#CenterButton &#123;</span><br><span class="line">	align-self: center;</span><br><span class="line">	-unity-text-align: middle-center;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/img/Unity/UIToolkit/UIUseUSSEditorWindow.PNG" alt="UIUseUSSEditorWindow"></p>
<p>可以看到我们在UIUseUSSEditorWindow.uss里分别定义了，<strong>Type Selector(Label)</strong>，<strong>Class Selector(.SmallLabel, .BigLabel, .BoldLabel)</strong>,<strong>Name Selector(CenterButton)</strong>。</p>
<p>对应的我们在代码里通过以下三种方式分别指定了Selector：</p>
<ol>
<li><p>Type Selector</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">VisualElement labelWithStyle = <span class="keyword">new</span> Label(<span class="string">&quot;USS Using Label Type Selector!&quot;</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>Class Selctor</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">VisualElement smallLabelWithStyle = <span class="keyword">new</span> Label(<span class="string">&quot;USS Using SmallLabel Class Selector!&quot;</span>);</span><br><span class="line">smallLabelWithStyle.AddToClassList(<span class="string">&quot;SmallLabel&quot;</span>);</span><br><span class="line">VisualElement bigLabelWithStyle = <span class="keyword">new</span> Label(<span class="string">&quot;USS Using BigLabel Class Selector!&quot;</span>);</span><br><span class="line">smallLabelWithStyle.AddToClassList(<span class="string">&quot;BigLabel&quot;</span>);</span><br><span class="line">VisualElement labelWithStyle = <span class="keyword">new</span> Label(<span class="string">&quot;USS Using Label Type Selector!&quot;</span>);</span><br><span class="line">VisualElement boldLabelWithStyle = <span class="keyword">new</span> Label(<span class="string">&quot;USS Using BoldLabel Class Selector!&quot;</span>);</span><br><span class="line">boldLabelWithStyle.AddToClassList(<span class="string">&quot;BoldLabel&quot;</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>Name Selector</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Button ussCenterButton = <span class="keyword">new</span> Button();</span><br><span class="line">ussCenterButton.name = <span class="string">&quot;CenterButton&quot;</span>;</span><br><span class="line">ussCenterButton.text = <span class="string">&quot;Center USS Button Name Selector&quot;</span>;</span><br></pre></td></tr></table></figure></li>
</ol>
<h5 id="位置和排版"><a href="#位置和排版" class="headerlink" title="位置和排版"></a>位置和排版</h5><p>第一步依然是使用Create-&gt;UI Toolkit-&gt;Editor WIndow</p>
<p>去掉UXML勾选，这里依然只通过代码和USS文件创建UI显示。</p>
<p>UIPositionAndLayoutEditorWindow.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 位置和排版EditorWindow</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UIPositionAndLayoutEditorWindow</span> : <span class="title">EditorWindow</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 竖向相对位置根组件</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> VisualElement mRootVerticalRelativePosContainer;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">MenuItem(<span class="string">&quot;Window/UI Toolkit/UIToolkitStudy/UIPositionAndLayoutEditorWindow&quot;</span>)</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ShowUIPositionAndLayoutEditorWindow</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        UIPositionAndLayoutEditorWindow wnd = GetWindow&lt;UIPositionAndLayoutEditorWindow&gt;();</span><br><span class="line">        wnd.titleContent = <span class="keyword">new</span> GUIContent(<span class="string">&quot;UIPositionAndLayoutEditorWindow&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">CreateGUI</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        CreatePositionAndLayoutUI();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 创建位置和排版UI</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">CreatePositionAndLayoutUI</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        CreateRootRelativePosVerticalContainer();</span><br><span class="line">        CreateHorizontalRelativePosContainer();</span><br><span class="line">        CreateHorzintalLayoutContainer();</span><br><span class="line">        CreateVerticalAbsolutePosContainer();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 创建竖向相对位置根组件</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">CreateRootRelativePosVerticalContainer</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 竖向相对位置排版容器</span></span><br><span class="line">        mRootVerticalRelativePosContainer = <span class="keyword">new</span> VisualElement();</span><br><span class="line">        <span class="comment">// 设置竖向排版</span></span><br><span class="line">        mRootVerticalRelativePosContainer.style.flexDirection = FlexDirection.Column;</span><br><span class="line">        <span class="comment">// 设置相对位置</span></span><br><span class="line">        mRootVerticalRelativePosContainer.style.position = Position.Relative;</span><br><span class="line">        <span class="comment">// 指定竖向容器Style</span></span><br><span class="line">        mRootVerticalRelativePosContainer.AddToClassList(<span class="string">&quot;unity-box&quot;</span>);</span><br><span class="line">        <span class="comment">// 设置竖向容器大小位置</span></span><br><span class="line">        mRootVerticalRelativePosContainer.style.marginLeft = <span class="number">10</span>;</span><br><span class="line">        mRootVerticalRelativePosContainer.style.marginRight = <span class="number">10</span>;</span><br><span class="line">        mRootVerticalRelativePosContainer.style.marginTop = <span class="number">10</span>;</span><br><span class="line">        mRootVerticalRelativePosContainer.style.marginBottom = <span class="number">10</span>;</span><br><span class="line">        <span class="comment">// 设置竖向容器自适应大小</span></span><br><span class="line">        mRootVerticalRelativePosContainer.style.flexGrow = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 添加竖向排版标签</span></span><br><span class="line">        Label verticalLabel = <span class="keyword">new</span> Label();</span><br><span class="line">        verticalLabel.text = <span class="string">&quot;竖向相对位置排版容器标题&quot;</span>;</span><br><span class="line">        <span class="comment">// 设置文本居中显示</span></span><br><span class="line">        verticalLabel.style.alignSelf = Align.Center;</span><br><span class="line">        mRootVerticalRelativePosContainer.Add(verticalLabel);</span><br><span class="line">        rootVisualElement.Add(mRootVerticalRelativePosContainer);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 创建横向相对位置容器</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">CreateHorizontalRelativePosContainer</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 横向相对位置容器</span></span><br><span class="line">        <span class="keyword">var</span> horizontalRelativePosContainer = <span class="keyword">new</span> VisualElement();</span><br><span class="line">        <span class="comment">// 设置横向排版</span></span><br><span class="line">        horizontalRelativePosContainer.style.flexDirection = FlexDirection.Row;</span><br><span class="line">        <span class="comment">// 设置相对位置</span></span><br><span class="line">        horizontalRelativePosContainer.style.position = Position.Relative;</span><br><span class="line">        <span class="comment">// 指定横向相对位置容器Style</span></span><br><span class="line">        horizontalRelativePosContainer.AddToClassList(<span class="string">&quot;unity-box&quot;</span>);</span><br><span class="line">        <span class="comment">// 添加横向相对位置标签</span></span><br><span class="line">        Label horizontalRelativePosLabel = <span class="keyword">new</span> Label();</span><br><span class="line">        horizontalRelativePosLabel.text = <span class="string">&quot;横向相对位置排版容器标题&quot;</span>;</span><br><span class="line">        <span class="comment">// 设置文本居中显示</span></span><br><span class="line">        horizontalRelativePosLabel.style.alignSelf = Align.Center;</span><br><span class="line">        horizontalRelativePosContainer.Add(horizontalRelativePosLabel);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置横向容器多个按钮</span></span><br><span class="line">        Button horizontalButton1 = <span class="keyword">new</span> Button();</span><br><span class="line">        horizontalButton1.text = <span class="string">&quot;横向按钮1&quot;</span>;</span><br><span class="line">        horizontalButton1.style.marginLeft = <span class="number">25</span>;</span><br><span class="line">        Button horizontalButton2 = <span class="keyword">new</span> Button();</span><br><span class="line">        horizontalButton2.text = <span class="string">&quot;横向按钮2&quot;</span>;</span><br><span class="line">        horizontalButton2.style.marginLeft = <span class="number">50f</span>;</span><br><span class="line">        horizontalRelativePosContainer.Add(horizontalButton1);</span><br><span class="line">        horizontalRelativePosContainer.Add(horizontalButton2);</span><br><span class="line"></span><br><span class="line">        mRootVerticalRelativePosContainer.Add(horizontalRelativePosContainer);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 创建横向排版容器</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">CreateHorzintalLayoutContainer</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 横向排版容器</span></span><br><span class="line">        <span class="keyword">var</span> horizontalLayoutContainer = <span class="keyword">new</span> VisualElement();</span><br><span class="line">        <span class="comment">// 设置横向排版</span></span><br><span class="line">        horizontalLayoutContainer.style.flexDirection = FlexDirection.Row;</span><br><span class="line">        <span class="comment">// 设置内容超出后排版Style</span></span><br><span class="line">        horizontalLayoutContainer.style.flexWrap = Wrap.Wrap;</span><br><span class="line">        <span class="comment">// 指定横向排版容器Style</span></span><br><span class="line">        horizontalLayoutContainer.AddToClassList(<span class="string">&quot;unity-box&quot;</span>);</span><br><span class="line">        <span class="comment">// 添加横向排版标签</span></span><br><span class="line">        Label horizontalLayoutLabel = <span class="keyword">new</span> Label();</span><br><span class="line">        horizontalLayoutLabel.text = <span class="string">&quot;横向排版容器标题&quot;</span>;</span><br><span class="line">        <span class="comment">// 设置文本居中显示</span></span><br><span class="line">        horizontalLayoutLabel.style.alignSelf = Align.Center;</span><br><span class="line">        horizontalLayoutContainer.Add(horizontalLayoutLabel);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置横向容器多个按钮</span></span><br><span class="line">        Button horizontalButton1 = <span class="keyword">new</span> Button();</span><br><span class="line">        horizontalButton1.text = <span class="string">&quot;横向按钮1&quot;</span>;</span><br><span class="line">        <span class="comment">// 设置自动扩展系数</span></span><br><span class="line">        horizontalButton1.style.flexGrow = <span class="number">1</span>;</span><br><span class="line">        Button horizontalButton2 = <span class="keyword">new</span> Button();</span><br><span class="line">        horizontalButton2.text = <span class="string">&quot;横向按钮2&quot;</span>;</span><br><span class="line">        <span class="comment">// 设置自动扩展系数</span></span><br><span class="line">        horizontalButton2.style.flexGrow = <span class="number">2</span>;</span><br><span class="line">        <span class="comment">// 设置偏移间隔</span></span><br><span class="line">        horizontalButton2.style.marginLeft = <span class="number">10</span>;</span><br><span class="line">        Button horizontalButton3 = <span class="keyword">new</span> Button();</span><br><span class="line">        horizontalButton3.text = <span class="string">&quot;横向按钮3&quot;</span>;</span><br><span class="line">        <span class="comment">// 设置自动扩展系数</span></span><br><span class="line">        horizontalButton3.style.flexGrow = <span class="number">3</span>;</span><br><span class="line">        <span class="comment">// 设置偏移间隔</span></span><br><span class="line">        horizontalButton3.style.marginLeft = <span class="number">10</span>;</span><br><span class="line">        Button horizontalButton4 = <span class="keyword">new</span> Button();</span><br><span class="line">        horizontalButton4.text = <span class="string">&quot;横向按钮4&quot;</span>;</span><br><span class="line">        <span class="comment">// 设置自动扩展系数</span></span><br><span class="line">        horizontalButton4.style.flexGrow = <span class="number">4</span>;</span><br><span class="line">        <span class="comment">// 设置偏移间隔</span></span><br><span class="line">        horizontalButton4.style.marginLeft = <span class="number">10</span>;</span><br><span class="line">        horizontalLayoutContainer.Add(horizontalButton1);</span><br><span class="line">        horizontalLayoutContainer.Add(horizontalButton2);</span><br><span class="line">        horizontalLayoutContainer.Add(horizontalButton3);</span><br><span class="line">        horizontalLayoutContainer.Add(horizontalButton4);</span><br><span class="line"></span><br><span class="line">        mRootVerticalRelativePosContainer.Add(horizontalLayoutContainer);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 创建竖向绝对位置容器</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">CreateVerticalAbsolutePosContainer</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 竖向绝对坐标容器</span></span><br><span class="line">        <span class="keyword">var</span> verticalAbsolutePosContainer = <span class="keyword">new</span> VisualElement();</span><br><span class="line">        <span class="comment">// 设置竖向排版</span></span><br><span class="line">        verticalAbsolutePosContainer.style.flexDirection = FlexDirection.Column;</span><br><span class="line">        <span class="comment">// 设置绝对坐标</span></span><br><span class="line">        verticalAbsolutePosContainer.style.position = Position.Absolute;</span><br><span class="line">        <span class="comment">// 指定竖向绝对位置容器Style</span></span><br><span class="line">        verticalAbsolutePosContainer.AddToClassList(<span class="string">&quot;unity-box&quot;</span>);</span><br><span class="line">        <span class="comment">// 设置竖向容器大小位置</span></span><br><span class="line">        verticalAbsolutePosContainer.style.left = <span class="number">100</span>;</span><br><span class="line">        verticalAbsolutePosContainer.style.right = <span class="number">100</span>;</span><br><span class="line">        verticalAbsolutePosContainer.style.top = <span class="number">100</span>;</span><br><span class="line">        verticalAbsolutePosContainer.style.bottom = <span class="number">100</span>;</span><br><span class="line">        <span class="comment">// 设置竖向绝对位置容器自适应</span></span><br><span class="line">        verticalAbsolutePosContainer.style.flexGrow = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 添加竖向排版标签</span></span><br><span class="line">        Label verticalAbsolutePosLabel = <span class="keyword">new</span> Label();</span><br><span class="line">        verticalAbsolutePosLabel.text = <span class="string">&quot;竖向绝对位置标题&quot;</span>;</span><br><span class="line">        <span class="comment">// 设置文本居中显示</span></span><br><span class="line">        verticalAbsolutePosLabel.style.alignSelf = Align.Center;</span><br><span class="line">        verticalAbsolutePosContainer.Add(verticalAbsolutePosLabel);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置竖向容器多个按钮</span></span><br><span class="line">        Button verticalButton1 = <span class="keyword">new</span> Button();</span><br><span class="line">        verticalButton1.text = <span class="string">&quot;竖向按钮1&quot;</span>;</span><br><span class="line">        <span class="comment">// 设置按钮高度和位置</span></span><br><span class="line">        verticalButton1.style.height = <span class="number">20</span>;</span><br><span class="line">        verticalButton1.style.marginLeft = <span class="number">20</span>;</span><br><span class="line">        verticalButton1.style.marginRight = <span class="number">20</span>;</span><br><span class="line">        Button verticalButton2 = <span class="keyword">new</span> Button();</span><br><span class="line">        verticalButton2.text = <span class="string">&quot;竖向按钮2&quot;</span>;</span><br><span class="line">        <span class="comment">// 设置按钮高度</span></span><br><span class="line">        verticalButton2.style.height = <span class="number">20</span>;</span><br><span class="line">        verticalButton2.style.marginLeft = <span class="number">20</span>;</span><br><span class="line">        verticalButton2.style.marginRight = <span class="number">20</span>;</span><br><span class="line">        verticalAbsolutePosContainer.Add(verticalButton1);</span><br><span class="line">        verticalAbsolutePosContainer.Add(verticalButton2);</span><br><span class="line"></span><br><span class="line">        mRootVerticalRelativePosContainer.Add(verticalAbsolutePosContainer);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/img/Unity/UIToolkit/UIPositionAndLayoutEditorWindow.PNG" alt="UIPositionAndLayoutEditorWindow"></p>
<p>可以看到通过不断创建需要排版的容器设置对应排版和大小属性，我们成功的创建出了各种排版方向以及相对位置和绝对位置的显示UI。</p>
<h5 id="自定义USS变量"><a href="#自定义USS变量" class="headerlink" title="自定义USS变量"></a>自定义USS变量</h5><p>在创建USS文件时，我们很多时候会填充相同值给不同的Selector，而修改时并不想一个一个去修改，这个时候就需要用到类似编程上定义变量公用同一个变量的方式。</p>
<p>第一步依然是使用Create-&gt;UI Toolkit-&gt;Editor WIndow</p>
<p>去掉UXML勾选，这里依然只通过代码和USS文件创建UI显示。</p>
<p>UICustomUSSVariableEditorWindow.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 创建自定义USS变量的Editor Window</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UICustomUSSVariableEditorWindow</span> : <span class="title">EditorWindow</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">MenuItem(<span class="string">&quot;Window/UI Toolkit/UIToolkitStudy/UICustomUSSVariableEditorWindow&quot;</span>)</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ShowUICustomUSSVariableEditorWindow</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        UICustomUSSVariableEditorWindow wnd = GetWindow&lt;UICustomUSSVariableEditorWindow&gt;();</span><br><span class="line">        wnd.titleContent = <span class="keyword">new</span> GUIContent(<span class="string">&quot;UICustomUSSVariableEditorWindow&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">CreateGUI</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        CreateCustomUSSVariableUI();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 创建自定义USS变量的UI</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">CreateCustomUSSVariableUI</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 加载并指定USS的使用</span></span><br><span class="line">        <span class="keyword">var</span> customUSSVariable1StyleSheet1 = AssetDatabase.LoadAssetAtPath&lt;StyleSheet&gt;(<span class="string">&quot;Assets/Scripts/Editor/UIToolkitStudy/UICustomUSSVariableEditorWindow/UICustomUSSVariableEditorWindow1.uss&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> customUSSVariable1StyleSheet2 = AssetDatabase.LoadAssetAtPath&lt;StyleSheet&gt;(<span class="string">&quot;Assets/Scripts/Editor/UIToolkitStudy/UICustomUSSVariableEditorWindow/UICustomUSSVariableEditorWindow2.uss&quot;</span>);</span><br><span class="line">        rootVisualElement.styleSheets.Add(customUSSVariable1StyleSheet1);</span><br><span class="line">        rootVisualElement.styleSheets.Add(customUSSVariable1StyleSheet2);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 使用UICustomUSSVariableEditorWindow1里的NormalLabel</span></span><br><span class="line">        Label normalLabel = <span class="keyword">new</span> Label();</span><br><span class="line">        normalLabel.AddToClassList(<span class="string">&quot;NormalLabel&quot;</span>);</span><br><span class="line">        normalLabel.text = <span class="string">&quot;NormalLabel1&quot;</span>;</span><br><span class="line">        normalLabel.style.left = <span class="number">10</span>;</span><br><span class="line">        normalLabel.style.right = <span class="number">10</span>;</span><br><span class="line">        normalLabel.style.height = <span class="number">20</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 使用UICustomUSSVariableEditorWindow2里的NormalLabel2</span></span><br><span class="line">        Label normalLabel2 = <span class="keyword">new</span> Label();</span><br><span class="line">        normalLabel2.AddToClassList(<span class="string">&quot;NormalLabel2&quot;</span>);</span><br><span class="line">        normalLabel2.text = <span class="string">&quot;NormalLabel2&quot;</span>;</span><br><span class="line">        normalLabel2.style.left = <span class="number">10</span>;</span><br><span class="line">        normalLabel2.style.right = <span class="number">10</span>;</span><br><span class="line">        normalLabel2.style.height = <span class="number">20</span>;</span><br><span class="line"></span><br><span class="line">        rootVisualElement.Add(normalLabel);</span><br><span class="line">        rootVisualElement.Add(normalLabel2);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>UICustomUSSVariableEditorWindow1.uss</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">:root &#123;</span><br><span class="line">	--text-color: red;</span><br><span class="line">	--background-color: green;</span><br><span class="line">	--text-color2: yellow;</span><br><span class="line">	--background-color2: blue;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.NormalLabel &#123;</span><br><span class="line">	color: red;</span><br><span class="line">	background-color: var(--background-color);</span><br><span class="line">	align-self: center;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>UICustomUSSVariableEditorWindow2.uss</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">.NormalLabel2 &#123;</span><br><span class="line">	color: var(--text-color2);</span><br><span class="line">	background-color: var(--background-color2);</span><br><span class="line">	align-self: center;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/img/Unity/UIToolkit/UICustomUSSVariableEditorWindow.PNG" alt="UICustomUSSVariableEditorWindow"></p>
<p>可以看到我们在USS文件里自定义了变量并在Class Selector里使用，通过加载多个USS文件，我们实现了跨USS文件的变量定义访问使用。</p>
<h4 id="UXML创建UI"><a href="#UXML创建UI" class="headerlink" title="UXML创建UI"></a>UXML创建UI</h4><p>待添加……</p>
<h4 id="VisualElement-Query"><a href="#VisualElement-Query" class="headerlink" title="VisualElement Query"></a>VisualElement Query</h4><p>VisualElement查询的核心是通过<strong>UQuery和Q相关接口进行对象查询(内部是通过UQueryBuilder构建查询条件)</strong></p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 创建菜单区域</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">CreateToolbarUI</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> menuHorizontalContainer = <span class="keyword">new</span> VisualElement();</span><br><span class="line">    *******</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建toolbar</span></span><br><span class="line">    <span class="keyword">var</span> menuToolbar = <span class="keyword">new</span> Toolbar();</span><br><span class="line">    menuToolbar.name = EventHandleElementNames.MenuToolBarName;</span><br><span class="line">    ******</span><br><span class="line">    menuHorizontalContainer.Add(menuToolbar);</span><br><span class="line">    rootVisualElement.Add(menuHorizontalContainer);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 创建Toolbar菜单UI</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">CreateToolbarMenuUI</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 创建菜单组件</span></span><br><span class="line">    SelectedMenuData = mToolbarMenuDatas[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">var</span> toolbarMenu = <span class="keyword">new</span> ToolbarMenu();</span><br><span class="line">    toolbarMenu.name = EventHandleElementNames.ToolBarMenuName;</span><br><span class="line">    ******</span><br><span class="line">    <span class="keyword">var</span> menuToolbar = rootVisualElement.Q&lt;Toolbar&gt;(EventHandleElementNames.MenuToolBarName);</span><br><span class="line">    menuToolbar.Add(toolbarMenu);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从上面的代码可以看到，我们创建了一个Toolbar并赋值name为EventHandleElementNames.MenuToolBarName，并将Toolbar组件添加到舞台显示。</p>
<p>接着我们创建菜单组件ToolbarMenu，此时想要把ToolbarMenu加到Toolbar里，这个时候我们需要通过rootVisualElement.Q<Toolbar>(EventHandleElementNames.MenuToolBarName);的方式查询到Toolbar组件，然后添加到Toolbar作为子组件显示(Toolbar.Add(ToolbarMenu))即可。</p>
<h4 id="自定义Inspector"><a href="#自定义Inspector" class="headerlink" title="自定义Inspector"></a>自定义Inspector</h4><p>待学习</p>
<p>Note:</p>
<ol>
<li><strong><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/UIE-HowTo-CreateCustomInspector.html">Unity does not support the use of custom property drawers within default inspectors, as Unity makes default inspectors with IMGUI. If you wish to create a custom property drawer, you must also create a custom inspector for the class that uses that property.</a>(Unity不支持自定义属性绘制使用默认Inspector，因为默认Inspector是用得IMGUI实现。如果编写了Custom Property Drawer，那么也必须编写Custom Inspector)</strong></li>
</ol>
<h4 id="UI事件响应"><a href="#UI事件响应" class="headerlink" title="UI事件响应"></a>UI事件响应</h4><p>UI事件监听核心是通过VisualElement.RegisterCallback<T>()方式去监听不同的事件类型来实现事件响应的。</p>
<p>接下来以节点编辑器左侧配置面板的实现为例，让我们看看，我是如何通过构建不同的VisualElement并且监听不同的事件类型来实现不同事件监听响应的。</p>
<p>这里先直接放一张效果图:</p>
<p><img src="/img/Unity/UIToolkit/UIEventHandleEditorWindow.PNG" alt="UIEventHandleEditorWindow"></p>
<h5 id="ToolbarMenu-菜单栏"><a href="#ToolbarMenu-菜单栏" class="headerlink" title="ToolbarMenu(菜单栏)"></a>ToolbarMenu(菜单栏)</h5><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 菜单栏信息数据列表</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">private</span> List&lt;KeyValuePair&lt;<span class="built_in">string</span>, ToolbarMenuType&gt;&gt; mToolbarMenuDatas = <span class="keyword">new</span> List&lt;KeyValuePair&lt;<span class="built_in">string</span>, ToolbarMenuType&gt;&gt;()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">new</span> KeyValuePair&lt;<span class="built_in">string</span>, ToolbarMenuType&gt;(<span class="string">&quot;界面1&quot;</span>, ToolbarMenuType.PANEL1),</span><br><span class="line">    <span class="keyword">new</span> KeyValuePair&lt;<span class="built_in">string</span>, ToolbarMenuType&gt;(<span class="string">&quot;界面2&quot;</span>, ToolbarMenuType.PANEL2),</span><br><span class="line">    <span class="keyword">new</span> KeyValuePair&lt;<span class="built_in">string</span>, ToolbarMenuType&gt;(<span class="string">&quot;界面3&quot;</span>, ToolbarMenuType.PANEL3),</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 选择菜单数据</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> KeyValuePair&lt;<span class="built_in">string</span>, ToolbarMenuType&gt; SelectedMenuData;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 创建Toolbar菜单UI</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">CreateToolbarMenuUI</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 创建菜单组件</span></span><br><span class="line">    SelectedMenuData = mToolbarMenuDatas[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">var</span> toolbarMenu = <span class="keyword">new</span> ToolbarMenu();</span><br><span class="line">    toolbarMenu.name = EventHandleElementNames.ToolBarMenuName;</span><br><span class="line">    toolbarMenu.text = SelectedMenuData.Key;</span><br><span class="line">    toolbarMenu.variant = ToolbarMenu.Variant.Popup;</span><br><span class="line">    toolbarMenu.style.width = <span class="number">100f</span>;</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="keyword">var</span> toolbarData <span class="keyword">in</span> mToolbarMenuDatas)</span><br><span class="line">    &#123;</span><br><span class="line">        toolbarMenu.menu.AppendAction(toolbarData.Key, OnToolbarMenuChoice, OnToolbarStatusObtain, toolbarData);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> menuToolbar = rootVisualElement.Q&lt;Toolbar&gt;(EventHandleElementNames.MenuToolBarName);</span><br><span class="line">    menuToolbar.Add(toolbarMenu);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 响应菜单栏选择事件</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;menuAction&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnToolbarMenuChoice</span>(<span class="params">DropdownMenuAction menuAction</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> menuData = (KeyValuePair&lt;<span class="built_in">string</span>, ToolbarMenuType&gt;)menuAction.userData;</span><br><span class="line">    Debug.Log(<span class="string">$&quot;菜单显示名:<span class="subst">&#123;menuData.Key&#125;</span> 菜单类型:<span class="subst">&#123;menuData.Value&#125;</span>选中！&quot;</span>);</span><br><span class="line">    SelectedMenuData = menuData;</span><br><span class="line">    <span class="keyword">var</span> toolbarMenu = rootVisualElement.Q&lt;ToolbarMenu&gt;(EventHandleElementNames.ToolBarMenuName);</span><br><span class="line">    toolbarMenu.text = SelectedMenuData.Key;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 响应菜单状态获取</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">private</span> DropdownMenuAction.<span class="function">Status <span class="title">OnToolbarStatusObtain</span>(<span class="params">DropdownMenuAction menuAction</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> menuData = (KeyValuePair&lt;<span class="built_in">string</span>, ToolbarMenuType&gt;)menuAction.userData;</span><br><span class="line">    Debug.Log(<span class="string">$&quot;菜单显示名:<span class="subst">&#123;menuData.Key&#125;</span> 菜单类型:<span class="subst">&#123;menuData.Value&#125;</span>响应菜单状态获取！&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (SelectedMenuData.Value == menuData.Value)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> DropdownMenuAction.Status.Checked;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> DropdownMenuAction.Status.Normal;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​	<img src="/img/Unity/UIToolkit/ToolbarMenuPreview.PNG" alt="ToolbarMenuPreview"></p>
<p>​	<img src="/img/Unity/UIToolkit/ToolbarMenuLog.PNG" alt="ToolbarMenuLog"></p>
<p>ToolbarMenu使用流程：</p>
<ol>
<li>创建ToolbarMenu组件</li>
<li>通过ToolbarMenu.menu.AppendAction(***)传递ToolbarMenu显示内容，菜单选中以及菜单状态获取回调</li>
<li>菜单选中以及菜单状态获取回调里编写菜单的选中以及显示数据处理</li>
</ol>
<h5 id="PopupField-下拉框"><a href="#PopupField-下拉框" class="headerlink" title="PopupField(下拉框)"></a>PopupField(下拉框)</h5><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Popup弹窗枚举类型</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="built_in">enum</span> PopupMenuType</span><br><span class="line">&#123;</span><br><span class="line">    POPUP_1,</span><br><span class="line">    POPUP_2,</span><br><span class="line">    POPUP_3,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 创建弹出下拉菜单UI</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">CreatePopupMenuUI</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 创建下拉框菜单组件</span></span><br><span class="line">    <span class="keyword">var</span> popupMenu = <span class="keyword">new</span> PopupField&lt;PopupMenuType&gt;(mPopupMenuDatas, mPopupSelectedIndex);</span><br><span class="line">    popupMenu.style.width = <span class="number">100f</span>;</span><br><span class="line">    popupMenu.RegisterCallback&lt;ChangeEvent&lt;PopupMenuType&gt;&gt;(OnPopupMenuChange);</span><br><span class="line">    <span class="keyword">var</span> menuToolbar = rootVisualElement.Q&lt;Toolbar&gt;(EventHandleElementNames.MenuToolBarName);</span><br><span class="line">    menuToolbar.Add(popupMenu);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 响应弹出菜单变化</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;evt&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnPopupMenuChange</span>(<span class="params">ChangeEvent&lt;PopupMenuType&gt; evt</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    Debug.Log(<span class="string">$&quot;弹出菜单选中:<span class="subst">&#123;evt.newValue&#125;</span>&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> popupMenu = evt.target <span class="keyword">as</span> PopupField&lt;PopupMenuType&gt;;</span><br><span class="line">    popupMenu.<span class="keyword">value</span> = evt.newValue;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​		<img src="/img/Unity/UIToolkit/PopupFieldPreview.PNG" alt="PopupFieldPreview"></p>
<p>​		<img src="/img/Unity/UIToolkit/PopupFieldLog.PNG" alt="PopupFieldLog"></p>
<p>ToolbarMenu使用流程：</p>
<ol>
<li>创建PopupField组件</li>
<li>通过PopupMenu.RegisterCallback&lt;ChangeEvent<T>&gt;(***)注册下拉框切换回调</li>
<li>在下拉框切换回调里处理下拉框切换数据处理</li>
</ol>
<h5 id="Button-按钮"><a href="#Button-按钮" class="headerlink" title="Button(按钮)"></a>Button(按钮)</h5><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 创建保存路径内容</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">CreateSavePathContent</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> leftVerticalContentContainer = rootVisualElement.Q&lt;VisualElement&gt;(EventHandleElementNames.LeftVerticalContentContainerName);</span><br><span class="line">    <span class="keyword">var</span> savePathHorizontalContainer = <span class="keyword">new</span> VisualElement();</span><br><span class="line">    savePathHorizontalContainer.style.left = <span class="number">0</span>;</span><br><span class="line">    savePathHorizontalContainer.style.right = <span class="number">0</span>;</span><br><span class="line">    savePathHorizontalContainer.style.height = <span class="number">20</span>;</span><br><span class="line">    savePathHorizontalContainer.style.flexDirection = FlexDirection.Row;</span><br><span class="line">    savePathHorizontalContainer.AddToClassList(<span class="string">&quot;unity-box&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> savePathLabelTitle = <span class="keyword">new</span> Label();</span><br><span class="line">    savePathLabelTitle.style.width = <span class="number">60</span>;</span><br><span class="line">    savePathLabelTitle.text = <span class="string">&quot;保存路径:&quot;</span>;</span><br><span class="line">    savePathHorizontalContainer.Add(savePathLabelTitle);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> savePathTextField = <span class="keyword">new</span> TextField();</span><br><span class="line">    savePathTextField.name = EventHandleElementNames.SavePathTextFieldName;</span><br><span class="line">    savePathTextField.style.flexGrow = <span class="number">1</span>;</span><br><span class="line">    savePathTextField.style.flexShrink = <span class="number">1</span>;</span><br><span class="line">    savePathTextField.<span class="keyword">value</span> = GraphSavePath;</span><br><span class="line">    savePathHorizontalContainer.Add(savePathTextField);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> savePathButton = <span class="keyword">new</span> Button();</span><br><span class="line">    savePathButton.style.width = <span class="number">60</span>;</span><br><span class="line">    savePathButton.text = <span class="string">&quot;修改&quot;</span>;</span><br><span class="line">    savePathHorizontalContainer.Add(savePathButton);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 注册按钮点击</span></span><br><span class="line">    savePathButton.RegisterCallback&lt;ClickEvent&gt;(OnSavePathButtonClick);</span><br><span class="line">    leftVerticalContentContainer.Add(savePathHorizontalContainer);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 相应保存路径按钮点击</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;clickEvent&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnSavePathButtonClick</span>(<span class="params">ClickEvent clickEvent</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    Debug.Log(<span class="string">$&quot;保存路径按钮点击！&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> newSavePath = EditorUtility.OpenFolderPanel(<span class="string">&quot;保存路径&quot;</span>, GraphSavePath, <span class="built_in">string</span>.Empty);</span><br><span class="line">    <span class="keyword">if</span>(!<span class="built_in">string</span>.IsNullOrEmpty(newSavePath))</span><br><span class="line">    &#123;</span><br><span class="line">        GraphSavePath = newSavePath;</span><br><span class="line">        Debug.Log(<span class="string">$&quot;更新保存路径:<span class="subst">&#123;newSavePath&#125;</span>&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> savePathTextField = rootVisualElement.Q&lt;TextField&gt;(EventHandleElementNames.SavePathTextFieldName);</span><br><span class="line">        savePathTextField.<span class="keyword">value</span> = GraphSavePath;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​		<img src="/img/Unity/UIToolkit/ButtonPreview.PNG" alt="ButtonPreview"><br>​		<img src="/img/Unity/UIToolkit/FolderChosenButtonClickPreview.PNG" alt="FolderChosenButtonClickPreview"></p>
<p>Button使用流程：</p>
<ol>
<li>创建Button组件</li>
<li>通过Button.RegisterCallback<ClickEvent>(***)注册下按钮点击回调</li>
<li>在按钮点击回调处理点击后的响应逻辑</li>
</ol>
<h5 id="Foldout-折叠"><a href="#Foldout-折叠" class="headerlink" title="Foldout(折叠)"></a>Foldout(折叠)</h5><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 创建条件节点UI</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">CreateConditionNodeUI</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> conditionNodeFoldOut = <span class="keyword">new</span> Foldout();</span><br><span class="line">    conditionNodeFoldOut.name = EventHandleElementNames.ConditionNodeFoldOutName;</span><br><span class="line">    conditionNodeFoldOut.viewDataKey = EventHandleViewDataKeys.ConditionNodeFoldOutViewDataKeyName;</span><br><span class="line">    conditionNodeFoldOut.text = <span class="string">&quot;条件节点&quot;</span>;</span><br><span class="line">    conditionNodeFoldOut.AddToClassList(<span class="string">&quot;unity-box&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    ******</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 注册条件节点FoldOut值变化回调</span></span><br><span class="line">    conditionNodeFoldOut.RegisterValueChangedCallback(OnConditionNodeFoldOutValueChange);</span><br><span class="line">    <span class="keyword">var</span> nodeVerticalContainer = rootVisualElement.Q&lt;VisualElement&gt;(EventHandleElementNames.NodeVerticalContainerName);</span><br><span class="line">    nodeVerticalContainer.Add(conditionNodeFoldOut);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 创建行为节点UI</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">CreateActionNodeUI</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> actionNodeFoldOut = <span class="keyword">new</span> Foldout();</span><br><span class="line">    actionNodeFoldOut.name = EventHandleElementNames.ActionNodeFoldOutName;</span><br><span class="line">    actionNodeFoldOut.viewDataKey = EventHandleViewDataKeys.ActionNodeFoldOutViewDataKeyName;</span><br><span class="line">    actionNodeFoldOut.text = <span class="string">&quot;行为节点&quot;</span>;</span><br><span class="line">    actionNodeFoldOut.AddToClassList(<span class="string">&quot;unity-box&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    ******</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 注册行为节点FoldOut值变化回调</span></span><br><span class="line">    actionNodeFoldOut.RegisterValueChangedCallback(OnActionNodeFoldOutValueChange);</span><br><span class="line">    <span class="keyword">var</span> nodeVerticalContainer = rootVisualElement.Q&lt;VisualElement&gt;(EventHandleElementNames.NodeVerticalContainerName);</span><br><span class="line">    nodeVerticalContainer.Add(actionNodeFoldOut);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 响应条件节点FoldOut值变化</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;changeEvent&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnConditionNodeFoldOutValueChange</span>(<span class="params">ChangeEvent&lt;<span class="built_in">bool</span>&gt; changeEvent</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    Debug.Log(<span class="string">$&quot;响应条件节点折叠值更新：<span class="subst">&#123;changeEvent.newValue&#125;</span>&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 响应行为节点FoldOut值变化</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;changeEvent&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnActionNodeFoldOutValueChange</span>(<span class="params">ChangeEvent&lt;<span class="built_in">bool</span>&gt; changeEvent</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    Debug.Log(<span class="string">$&quot;响应行为节点折叠值更新：<span class="subst">&#123;changeEvent.newValue&#125;</span>&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>​		<img src="/img/Unity/UIToolkit/FoldoutPreivew.PNG" alt="FoldoutPreivew"></p>
<p>Foldout使用流程：</p>
<ol>
<li>创建Foldout组件</li>
<li>通过FoldOut.RegisterValueChangedCallback(***)注册折叠变化回调</li>
<li>在折叠变化回调处理折叠变化响应逻辑</li>
</ol>
<h5 id="ListView-列表"><a href="#ListView-列表" class="headerlink" title="ListView(列表)"></a>ListView(列表)</h5><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 行为类型</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="built_in">enum</span> ActionType</span><br><span class="line">&#123;</span><br><span class="line">    ACTION1,</span><br><span class="line">    ACTION2,</span><br><span class="line">    ******,</span><br><span class="line">    ACTION20,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 条件类型</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="built_in">enum</span> ConditionType</span><br><span class="line">&#123;</span><br><span class="line">    CONDITION1,</span><br><span class="line">    CONDITION2,</span><br><span class="line">    ******,</span><br><span class="line">    CONDITION20,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 行为类型列表</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">private</span> List&lt;ActionType&gt; mActionTypeList = <span class="keyword">new</span> List&lt;ActionType&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 条件类型列表</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">private</span> List&lt;ConditionType&gt; mConditionTypeList = <span class="keyword">new</span> List&lt;ConditionType&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 初始化节点数据</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">InitNodeDatas</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    mActionTypeList.Clear();</span><br><span class="line">    <span class="keyword">var</span> actionTypes = Enum.GetValues(<span class="keyword">typeof</span>(ActionType));</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="keyword">var</span> actionType <span class="keyword">in</span> actionTypes)</span><br><span class="line">    &#123;</span><br><span class="line">        mActionTypeList.Add((ActionType)actionType);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mConditionTypeList.Clear();</span><br><span class="line">    <span class="keyword">var</span> conditionTypes = Enum.GetValues(<span class="keyword">typeof</span>(ConditionType));</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="keyword">var</span> conditionType <span class="keyword">in</span> conditionTypes)</span><br><span class="line">    &#123;</span><br><span class="line">        mConditionTypeList.Add((ConditionType)conditionType);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 创建条件节点UI</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">CreateConditionNodeUI</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> conditionNodeFoldOut = <span class="keyword">new</span> Foldout();</span><br><span class="line">    ******</span><br><span class="line">    <span class="keyword">var</span> conditionListView = <span class="keyword">new</span> ListView(mConditionTypeList, <span class="number">20</span>, OnMakeNodeItem, OnBindConditionItem);</span><br><span class="line">    conditionListView.style.height = <span class="number">300</span>;</span><br><span class="line">    conditionNodeFoldOut.Add(conditionListView);</span><br><span class="line">	******</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 创建行为节点UI</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">CreateActionNodeUI</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> actionNodeFoldOut = <span class="keyword">new</span> Foldout();</span><br><span class="line">    ******</span><br><span class="line">    <span class="keyword">var</span> actionListView = <span class="keyword">new</span> ListView(mConditionTypeList, <span class="number">20</span>, OnMakeNodeItem, OnBindActionItem);</span><br><span class="line">    actionListView.style.height = <span class="number">300</span>;</span><br><span class="line">    actionNodeFoldOut.Add(actionListView);</span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 响应绑定条件节点</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;conditionItem&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;index&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnBindConditionItem</span>(<span class="params">VisualElement conditionItem, <span class="built_in">int</span> index</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> conditionButton = conditionItem <span class="keyword">as</span> Button;</span><br><span class="line">    conditionButton.name = GetConditionItemNameByIndex(index);</span><br><span class="line">    conditionButton.text = mConditionTypeList[index].ToString();</span><br><span class="line">    conditionButton.userData = mConditionTypeList[index];</span><br><span class="line">    conditionButton.RegisterCallback&lt;ClickEvent&gt;(OnBindConditionItemButtonClick);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 响应绑定行为节点</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;conditionItem&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;index&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnBindActionItem</span>(<span class="params">VisualElement conditionItem, <span class="built_in">int</span> index</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> actionButton = conditionItem <span class="keyword">as</span> Button;</span><br><span class="line">    actionButton.name = GetActionItemNameByIndex(index);</span><br><span class="line">    actionButton.text = mActionTypeList[index].ToString();</span><br><span class="line">    actionButton.userData = mActionTypeList[index];</span><br><span class="line">    actionButton.RegisterCallback&lt;ClickEvent&gt;(OnBindActionItemButtonClick);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 响应节点Item构建</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> VisualElement <span class="title">OnMakeNodeItem</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Button();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 响应Condition按钮点击</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;clickEvent&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnBindConditionItemButtonClick</span>(<span class="params">ClickEvent clickEvent</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> conditionItemButton = clickEvent.target <span class="keyword">as</span> Button;</span><br><span class="line">    <span class="keyword">var</span> clickConditionType = (ConditionType)conditionItemButton.userData;</span><br><span class="line">    Debug.Log(<span class="string">$&quot;点击了ConditionType:<span class="subst">&#123;clickConditionType&#125;</span>按钮！&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 响应Action按钮点击</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;clickEvent&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnBindActionItemButtonClick</span>(<span class="params">ClickEvent clickEvent</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> actionItemButton = clickEvent.target <span class="keyword">as</span> Button;</span><br><span class="line">    <span class="keyword">var</span> clickActionType = (ActionType)actionItemButton.userData;</span><br><span class="line">    Debug.Log(<span class="string">$&quot;点击了ActionType:<span class="subst">&#123;clickActionType&#125;</span>按钮！&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 获取制定索引的Condition Item名</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;index&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="built_in">string</span> <span class="title">GetConditionItemNameByIndex</span>(<span class="params"><span class="built_in">int</span> index</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">$&quot;<span class="subst">&#123;EventHandleElementNames.ConditionItemPrefixName&#125;</span><span class="subst">&#123;mConditionTypeList[index]&#125;</span>&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 获取制定索引的Action Item名</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;index&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="built_in">string</span> <span class="title">GetActionItemNameByIndex</span>(<span class="params"><span class="built_in">int</span> index</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">$&quot;<span class="subst">&#123;EventHandleElementNames.ActionItemPrefixName&#125;</span><span class="subst">&#123;mActionTypeList[index]&#125;</span>&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​		<img src="/img/Unity/UIToolkit/ListViewPreview.PNG" alt="ListViewPreview"></p>
<p>​		<img src="/img/Unity/UIToolkit/ListViewButtonClickLog.PNG" alt="ListViewButtonClickLog"></p>
<p>ListView使用流程：</p>
<ol>
<li>创建ListView组件</li>
<li>创建ListView组件时传递需要显示的数据，高度，列表组件构造回调以及列表组件绑定回调</li>
<li>在列表组件构造回调里构建我们列表里需要显示的VisualElement</li>
<li>在列表组件绑定回调里处理列表组件的详细逻辑处理</li>
</ol>
<p>更多的事件响应待添加……</p>
<h4 id="数据绑定"><a href="#数据绑定" class="headerlink" title="数据绑定"></a>数据绑定</h4><h5 id="数据绑定组件"><a href="#数据绑定组件" class="headerlink" title="数据绑定组件"></a>数据绑定组件</h5><p>通过前面对于属性绑定的基础学习:</p>
<p><a href="">SerializedObject Data Binding</a></p>
<p>可以知道，对于VisualElement和属性的绑定核心通过以下几个接口:</p>
<ol>
<li><strong>Bind()</strong></li>
<li><strong>Unbind()</strong></li>
<li><strong>bindingPath</strong></li>
<li><strong>BindProperty()</strong></li>
</ol>
<p>UIPropertyBindEditorWindow.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 属性绑定Editor Window</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UIPropertyBindEditorWindow</span> : <span class="title">EditorWindow</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 选中的ScriptableObject</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> ScriptableObject mSelectedScriptableObject;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">MenuItem(<span class="string">&quot;Window/UI Toolkit/UIToolkitStudy/UIPropertyBindEditorWindow&quot;</span>)</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ShowUIPropertyBindEditorWindow</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        UIPropertyBindEditorWindow wnd = GetWindow&lt;UIPropertyBindEditorWindow&gt;();</span><br><span class="line">        wnd.titleContent = <span class="keyword">new</span> GUIContent(<span class="string">&quot;UIPropertyBindEditorWindow&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">CreateGUI</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        CreatePropertyBindUI();</span><br><span class="line">        OnSelectionChange();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 选中Asset变化回调</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnSelectionChange</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mSelectedScriptableObject = Selection.activeObject <span class="keyword">as</span> ScriptableObject;</span><br><span class="line">        <span class="keyword">var</span> propertyBindAssetNameTextField = rootVisualElement.Q&lt;TextField&gt;(PropertyBindElementNames.PropertyBindTextFieldName);</span><br><span class="line">        <span class="keyword">var</span> propertyBindInfoContentContainer = rootVisualElement.Q&lt;VisualElement&gt;(PropertyBindElementNames.PropertyBindInfoContentContainerName);</span><br><span class="line">        <span class="keyword">if</span>(mSelectedScriptableObject != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> selectedSerializedObject = <span class="keyword">new</span> SerializedObject(mSelectedScriptableObject);</span><br><span class="line">            <span class="keyword">if</span>(propertyBindAssetNameTextField != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> nameProperty = selectedSerializedObject.FindProperty(<span class="string">&quot;m_Name&quot;</span>);</span><br><span class="line">                propertyBindAssetNameTextField.BindProperty(nameProperty);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(propertyBindInfoContentContainer != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> propertyIterator = selectedSerializedObject.GetIterator();</span><br><span class="line">                propertyIterator.NextVisible(<span class="literal">true</span>);</span><br><span class="line">                <span class="keyword">while</span>(propertyIterator.NextVisible(<span class="literal">false</span>))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">var</span> propertyField = <span class="keyword">new</span> PropertyField();</span><br><span class="line">                    propertyField.name = propertyIterator.name;</span><br><span class="line">                    propertyField.style.height = <span class="number">20</span>;</span><br><span class="line">                    propertyField.BindProperty(propertyIterator);</span><br><span class="line">                    propertyBindInfoContentContainer.Add(propertyField);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(propertyBindAssetNameTextField != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                propertyBindAssetNameTextField.Unbind();</span><br><span class="line">                propertyBindAssetNameTextField.<span class="keyword">value</span> = <span class="built_in">string</span>.Empty;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(propertyBindInfoContentContainer != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                propertyBindInfoContentContainer.Clear();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 创建属性绑定UI</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">CreatePropertyBindUI</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        CreatePropertyBindAssetInfoUI();</span><br><span class="line">        CreatePropertyBindPropertyUI();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 创建属性绑定Asset信息UI</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">CreatePropertyBindAssetInfoUI</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> propertyBindAssetInfoHContainer = <span class="keyword">new</span> VisualElement();</span><br><span class="line">        propertyBindAssetInfoHContainer.style.flexDirection = FlexDirection.Row;</span><br><span class="line">        propertyBindAssetInfoHContainer.style.height = <span class="number">20</span>;</span><br><span class="line">        rootVisualElement.Add(propertyBindAssetInfoHContainer);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> propertyBindLabelTitle = <span class="keyword">new</span> Label();</span><br><span class="line">        propertyBindLabelTitle.text = <span class="string">&quot;绑定Asset名&quot;</span>;</span><br><span class="line">        propertyBindLabelTitle.style.width = <span class="number">80</span>;</span><br><span class="line">        propertyBindAssetInfoHContainer.Add(propertyBindLabelTitle);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> propertyBindAssetNameTextField = <span class="keyword">new</span> TextField();</span><br><span class="line">        propertyBindAssetNameTextField.name = PropertyBindElementNames.PropertyBindTextFieldName;</span><br><span class="line">        propertyBindAssetNameTextField.style.flexGrow = <span class="number">1</span>;</span><br><span class="line">        propertyBindAssetNameTextField.<span class="keyword">value</span> = <span class="built_in">string</span>.Empty;</span><br><span class="line">        propertyBindAssetInfoHContainer.Add(propertyBindAssetNameTextField);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 创建属性绑定属性UI</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">CreatePropertyBindPropertyUI</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> propertyBindInfoVContainer = <span class="keyword">new</span> VisualElement();</span><br><span class="line">        propertyBindInfoVContainer.style.flexDirection = FlexDirection.Column;</span><br><span class="line">        propertyBindInfoVContainer.style.left = <span class="number">0</span>;</span><br><span class="line">        propertyBindInfoVContainer.style.right = <span class="number">0</span>;</span><br><span class="line">        propertyBindInfoVContainer.style.top = <span class="number">0</span>;</span><br><span class="line">        propertyBindInfoVContainer.style.bottom = <span class="number">0</span>;</span><br><span class="line">        propertyBindInfoVContainer.style.flexGrow = <span class="number">1</span>;</span><br><span class="line">        propertyBindInfoVContainer.AddToClassList(<span class="string">&quot;unity-rect-field&quot;</span>);</span><br><span class="line">        rootVisualElement.Add(propertyBindInfoVContainer);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> propertyBindInfoLabelTitle = <span class="keyword">new</span> Label();</span><br><span class="line">        propertyBindInfoLabelTitle.text = <span class="string">&quot;绑定Assets绑定属性显示&quot;</span>;</span><br><span class="line">        propertyBindInfoLabelTitle.style.alignSelf = Aligh.Center;</span><br><span class="line">        propertyBindInfoLabelTitle.style.height = <span class="number">20</span>;</span><br><span class="line">        propertyBindInfoVContainer.Add(propertyBindInfoLabelTitle);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> propertyBindInfoContentContainer = <span class="keyword">new</span> VisualElement();</span><br><span class="line">        propertyBindInfoContentContainer.name = PropertyBindElementNames.PropertyBindInfoContentContainerName;</span><br><span class="line">        propertyBindInfoContentContainer.style.flexDirection = FlexDirection.Column;</span><br><span class="line">        propertyBindInfoContentContainer.style.flexGrow = <span class="number">1</span>;</span><br><span class="line">        propertyBindInfoVContainer.Add(propertyBindInfoContentContainer);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>PropertyBindSO.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> PropertyBindSO.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 属性绑定ScriptableObject</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">CreateAssetMenu(fileName = <span class="string">&quot;PropertyBindSO&quot;</span>, menuName = <span class="string">&quot;ScriptableObjects/DIY/PropertyBindSO&quot;</span>, order = 1)</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PropertyBindSO</span> : <span class="title">ScriptableObject</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 自定义枚举</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">enum</span> CustomEnum</span><br><span class="line">    &#123;</span><br><span class="line">        ENUM1,</span><br><span class="line">        ENUM2,</span><br><span class="line">        ENUM3,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 名字</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;名字&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Name;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 颜色</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;颜色&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> Color Color;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 绑定GameObject</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;绑定GameObject&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> GameObject GO;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 自定义枚举</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;自定义枚举&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> CustonEnum CustonE;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Transform列表</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;Transform列表&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> List&lt;Transform&gt; TransformList;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 位置数组</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;位置数组&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> Vector3[] Positions;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 自定义Class</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;自定义Class&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> CustomBindClass BindClass;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/img/Unity/UIToolkit/PropertyBindSOEditorWindow.PNG" alt="PropertyBindSOEditorWindow"></p>
<p>从上面截图可以看到，通过Selection.activeObject得到选中的ScriptableObject对象，结合selectedSerializedObject.GetIterator()遍历添加所有可视化属性展示(PropertyField)，同时通过TextField.BindProperty()绑定文本和特定属性显示从而实现属性绑定VisualElement的效果。</p>
<p>当我们未选中任何对象时我们通过Unbind()接口接触VisualElement的属性绑定效果。</p>
<h5 id="数据绑定UI变化回调"><a href="#数据绑定UI变化回调" class="headerlink" title="数据绑定UI变化回调"></a>数据绑定UI变化回调</h5><p>数据绑定变化回调核心通过以下几个接口：</p>
<ol>
<li><strong>TrackPropertyValue()</strong></li>
<li><strong>TrackSerializedObjectValue()</strong></li>
</ol>
<p>UIPropertyBindCBEditorWindow.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> UIPropertyBindCBEditorWindow.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 属性修改绑定窗口</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UIPropertyBindCBEditorWindow</span> : <span class="title">EditorWindow</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 选中的ScriptableObject</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> ScriptableObject mSelectedScriptableObject;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">MenuItem(<span class="string">&quot;Window/UI Toolkit/UIToolkitStudy/UIPropertyBindCBEditorWindow&quot;</span>)</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ShowUIPropertyBindCBEditorWindow</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        UIPropertyBindCBEditorWindow wnd = GetWindow&lt;UIPropertyBindCBEditorWindow&gt;();</span><br><span class="line">        wnd.titleContent = <span class="keyword">new</span> GUIContent(<span class="string">&quot;UIPropertyBindCBEditorWindow&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">CreateGUI</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        CreatePropertyBindCBUI();</span><br><span class="line">        OnSelectionChange();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 选中Asset变化回调</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnSelectionChange</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mSelectedScriptableObject = Selection.activeObject <span class="keyword">as</span> ScriptableObject;</span><br><span class="line">        <span class="keyword">var</span> propertyBindAssetNameTextField = rootVisualElement.Q&lt;TextField&gt;(PropertyBindCBElementNames.PropertyBindCBTextFieldName);</span><br><span class="line">        <span class="keyword">var</span> serializedBindAssetNameTextField = rootVisualElement.Q&lt;TextField&gt;(PropertyBindCBElementNames.SerializedBindCBTextFieldName);</span><br><span class="line">        <span class="keyword">if</span>(mSelectedScriptableObject != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> selectedSerializedObject = <span class="keyword">new</span> SerializedObject(mSelectedScriptableObject);</span><br><span class="line">            <span class="keyword">if</span>(propertyBindAssetNameTextField != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> nameProperty = selectedSerializedObject.FindProperty(<span class="string">&quot;Name&quot;</span>);</span><br><span class="line">                propertyBindAssetNameTextField.TrackPropertyValue(nameProperty, OnNamePropertyChange);</span><br><span class="line">                propertyBindAssetNameTextField.BindProperty(nameProperty);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(serializedBindAssetNameTextField != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                serializedBindAssetNameTextField.TrackSerializedObjectValue(selectedSerializedObject, OnPropertyChange);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(propertyBindAssetNameTextField != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                propertyBindAssetNameTextField.Unbind();</span><br><span class="line">                propertyBindAssetNameTextField.<span class="keyword">value</span> = <span class="built_in">string</span>.Empty;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(serializedBindAssetNameTextField != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                serializedBindAssetNameTextField.Unbind();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 创建属性绑定回调UI</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">CreatePropertyBindCBUI</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> propertyBindCBAssetInfoHContainer = <span class="keyword">new</span> VisualElement();</span><br><span class="line">        propertyBindCBAssetInfoHContainer.style.flexDirection = FlexDirection.Row;</span><br><span class="line">        propertyBindCBAssetInfoHContainer.style.height = <span class="number">20</span>;</span><br><span class="line">        rootVisualElement.Add(propertyBindCBAssetInfoHContainer);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> proeprtyBindLabelTitle = <span class="keyword">new</span> Label();</span><br><span class="line">        proeprtyBindLabelTitle.text = <span class="string">&quot;名字属性值:&quot;</span>;</span><br><span class="line">        proeprtyBindLabelTitle.style.width = <span class="number">160</span>;</span><br><span class="line">        propertyBindCBAssetInfoHContainer.Add(proeprtyBindLabelTitle);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> propertyBindAssetNameTextField = <span class="keyword">new</span> TextField();</span><br><span class="line">        propertyBindAssetNameTextField.name = PropertyBindCBElementNames.PropertyBindCBTextFieldName;</span><br><span class="line">        propertyBindAssetNameTextField.style,flexGrow = <span class="number">1</span>;</span><br><span class="line">        propertyBindAssetNameTextField.<span class="keyword">value</span> = <span class="built_in">string</span>.Empty;</span><br><span class="line">        propertyBindCBAssetInfoHContainer.Add(propertyBindAssetNameTextField);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> serializedObjectBindCBAssetInfoHContainer = <span class="keyword">new</span> VisualElement();</span><br><span class="line">        serializedObjectBindCBAssetInfoHContainer.style.flexDirection = FlexDirection.Row;</span><br><span class="line">        serializedObjectBindCBAssetInfoHContainer.style.height = <span class="number">20</span>;</span><br><span class="line">        rootVisualElement.Add(serializedObjectBindCBAssetInfoHContainer);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> serializedBindLabelTitle = <span class="keyword">new</span> Label();</span><br><span class="line">        serializedBindLabelTitle.text = <span class="string">&quot;属性变化SerializeObject名:&quot;</span>;</span><br><span class="line">        serializedBindLabelTitle.style.width = <span class="number">160</span>;</span><br><span class="line">        serializedObjectBindCBAssetInfoHContainer.Add(serializedBindLabelTitle);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> serializedBindAssetNameTextField = <span class="keyword">new</span> TextField();</span><br><span class="line">        serializedBindAssetNameTextField.name = PropertyBindCBElementNames.SerializedBindCBTextFieldName;</span><br><span class="line">        serializedBindAssetNameTextField.style.flexGrow = <span class="number">1</span>;</span><br><span class="line">        serializedBindAssetNameTextField.<span class="keyword">value</span> = <span class="built_in">string</span>.Empty;</span><br><span class="line">        serializedObjectBindCBAssetInfoHContainer.Add(serializedBindAssetNameTextField);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 响应名字属性变化</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;property&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnNamePropertyChange</span>(<span class="params">SerializedProperty property</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Debug.Log(<span class="string">$&quot;名字属性发生变化！&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 响应属性变化</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;serializedObject&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnPropertyChange</span>(<span class="params">SerializedObject serializedObject</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Debug.Log(<span class="string">$&quot;SerializedObject.name:<span class="subst">&#123;serializedObject.targetObject.name&#125;</span>属性变化！&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> serializedBindAssetNameTextField = rootVisualElement.Q&lt;TextField&gt;(PropertyBindCBElementNames.SerializedBindCBTextFieldName);</span><br><span class="line">        <span class="keyword">if</span>(serializedBindAssetNameTextField != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            serializedBindAssetNameTextField.<span class="keyword">value</span> = serializedObject.targetObject.name;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>PropertyBindCBSO.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> PropertyBindCBSO.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 属性绑定回调ScriptableObject</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">CreateAssetMenu(fileName = <span class="string">&quot;PropertyBindCBSO&quot;</span>, menuName = <span class="string">&quot;ScriptableObjects/DIY/PropertyBindCBSO&quot;</span>, order = 1)</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PropertyBindCBSO</span> : <span class="title">ScriptableObject</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 名字</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;名字&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Name;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 位置</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;位置&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> Vector3 Position;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 颜色</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;颜色&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> Color Color;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 绑定GameObject</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;绑定GameObject&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> GameObject GO;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/img/Unity/UIToolkit/PropertyBindCBSOEditorWindow.PNG" alt="PropertyBindCBSOEditorWindow"></p>
<p>从上面代码可以看到我通过TextField绑定指定属性后调用TrackPropertyValue实现指定属性变化回调监听。</p>
<p>通过TextField调用TrackSerializedObjectValue实现对指定SerializedObject所有属性变化的监听。</p>
<h4 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h4><ol>
<li><strong>EditorWindow.CreateGUI()方法是用于UIToolkit创建Editor窗口的rootVisualElement显示方法</strong></li>
<li><strong>Editor.CreateInspectorGUI()方法是用于UIToolkit创建自定义Inspector面板的显示方法</strong></li>
<li><strong><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/UIE-support-for-editor-ui.html">UI Toolkit to create Editor UI and synchronize data between a property and a visual element for the Editor UI.</a>(UIToolkit支持在Editor UI上同步属性数据到Visual Element上)</strong></li>
</ol>
<h2 id="行为树节点编辑器实战"><a href="#行为树节点编辑器实战" class="headerlink" title="行为树节点编辑器实战"></a>行为树节点编辑器实战</h2><p>详情参考:<a href="">行为树节点编辑器</a></p>
<h1 id="Github"><a href="#Github" class="headerlink" title="Github"></a>Github</h1><p>个人Github:</p>
<p><a href="http://tonytang1990.github.io/2022/02/20/UnityEditor%E7%9F%A5%E8%AF%86/">UnityEditor知识</a></p>
<p><a href="http://tonytang1990.github.io/2023/05/20/UIToolkit%E5%AD%A6%E4%B9%A0/">UIToolkit</a></p>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/UIToolkits.html">Creating user interfaces (UI)</a></p>
<p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/CSS">CSS</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/UIE-uss-properties.html">USS properties reference</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/ScriptReference/UIElements.IStyle.html">IStyle</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/UIE-ElementRef.html">UXML现有可用Element查询</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/UIE-uss-built-in-variable-reference.html">USS built-in variable references</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/UIE-Events-Reference.html">Event Reference</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Packages/com.unity.graphtools.foundation@0.11/manual/overview.html">Graph Tools Foundation 0.11</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Editor/">Editor</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Editor/">Editor</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>







  <nav id="page-nav" class="clearfix">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/2/">Next&lt;span&gt;&lt;&#x2F;span&gt;</a>
  </nav>

</div>
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  


  
<div class="categorieslist">
	<p class="asidetitle">分类</p>
		<ul>
		
		  
			<li><a href="/categories/AI/" title="AI">AI<sup>5</sup></a></li>
		  
		
		  
			<li><a href="/categories/Algorithm/" title="Algorithm">Algorithm<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/Art/" title="Art">Art<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Automation/" title="Automation">Automation<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Collision/" title="Collision">Collision<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Database/" title="Database">Database<sup>3</sup></a></li>
		  
		
		  
			<li><a href="/categories/Editor/" title="Editor">Editor<sup>5</sup></a></li>
		  
		
		  
			<li><a href="/categories/Excel/" title="Excel">Excel<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Game/" title="Game">Game<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/HotUpdate/" title="HotUpdate">HotUpdate<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Lua/" title="Lua">Lua<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Math/" title="Math">Math<sup>3</sup></a></li>
		  
		
		  
			<li><a href="/categories/Native/" title="Native">Native<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/Network/" title="Network">Network<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Optimization/" title="Optimization">Optimization<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Other/" title="Other">Other<sup>5</sup></a></li>
		  
		
		  
			<li><a href="/categories/Plugin/" title="Plugin">Plugin<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/Programming/" title="Programming">Programming<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/Programming-Language/" title="Programming Language">Programming Language<sup>4</sup></a></li>
		  
		
		  
			<li><a href="/categories/Rendering/" title="Rendering">Rendering<sup>6</sup></a></li>
		  
		
		  
			<li><a href="/categories/Resource/" title="Resource">Resource<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/Unity/" title="Unity">Unity<sup>7</sup></a></li>
		  
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">标签</p>
		<ul class="clearfix">
		
			
				<li><a href="/tags/Unity/" title="Unity">Unity<sup>8</sup></a></li>
			
		
			
				<li><a href="/tags/AI/" title="AI">AI<sup>5</sup></a></li>
			
		
			
				<li><a href="/tags/Editor/" title="Editor">Editor<sup>5</sup></a></li>
			
		
			
				<li><a href="/tags/Other/" title="Other">Other<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/Rendering/" title="Rendering">Rendering<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/Math/" title="Math">Math<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/Resource/" title="Resource">Resource<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/OpenGL/" title="OpenGL">OpenGL<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/Programming/" title="Programming">Programming<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/Art/" title="Art">Art<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Android/" title="Android">Android<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/UI/" title="UI">UI<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/C/" title="C#">C#<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Python/" title="Python">Python<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Database/" title="Database">Database<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Shader/" title="Shader">Shader<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/SubmlineText3/" title="SubmlineText3">SubmlineText3<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Native/" title="Native">Native<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Prefab/" title="Prefab">Prefab<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Plugin/" title="Plugin">Plugin<sup>1</sup></a></li>
			
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">友情链接</p>
    <ul>
        
          <li>
            
            	<a href="https://coderq.com" target="_blank" title="一个面向程序员交流分享的新一代社区">码农圈</a>
            
          </li>
        
          <li>
            
            	<a href="http://wuchong.me" target="_blank" title="Jark&#39;s Blog">Jark&#39;s Blog</a>
            
          </li>
        
    </ul>
</div>

  


  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS 订阅</a>
</div>

  <div class="weiboshow">
  <p class="asidetitle">新浪微博</p>
    <iframe width="100%" height="119" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=119&fansRow=2&ptype=1&speed=0&skin=9&isTitle=1&noborder=1&isWeibo=0&isFans=0&uid=&verifier=b3593ceb&dpc=1"></iframe>
</div>


</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> Hello ,I&#39;m Larry Page in Google. <br/>
			This is my blog,believe it or not.</p>
	</section>
	 
	<div class="social-font" class="clearfix">
		
		<a href="http://weibo.com/2176287895" target="_blank" class="icon-weibo" title="微博"></a>
		
		
		
		
		
		
		
		
		
		
	</div>
			
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Jacman">Jacman</a> © 2026 
		
		<a href="/about" target="_blank" title="Tony Tang">Tony Tang</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery.qrcode-0.12.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
        
    }
  });
});
</script>












<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->



<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?e6d1f421bbc9962127a50488f9ed37d1";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>



<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="返回顶部"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
 </html>
