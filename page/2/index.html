
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  
    <title>走停人生路</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="Tony Tang">
    

    
    <meta property="og:type" content="website">
<meta property="og:title" content="走停人生路">
<meta property="og:url" content="http://tonytang1990.github.io/page/2/index.html">
<meta property="og:site_name" content="走停人生路">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Tony Tang">
<meta name="twitter:card" content="summary">

    
    <link rel="alternative" href="/atom.xml" title="走停人生路" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/jacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/jacman.jpg">
    
    
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 7.3.0"></head>

  <body>
    <header>
      
<div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.png" alt="走停人生路" title="走停人生路"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="走停人生路">走停人生路</a></h1>
				<h2 class="blog-motto">做着独立游戏梦，坚持走在游戏开发道路上的人</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">Home</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
						<li><a href="/about">About</a></li>
					
					<li>
 					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="search" id="search" name="q" autocomplete="off" maxlength="20" placeholder="搜索" />
						<input type="hidden" name="q" value="site:tonytang1990.github.io">
					</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main">

   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2022/02/21/数学知识/" title="数学知识" itemprop="url">数学知识</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Tony Tang" target="_blank" itemprop="author">Tony Tang</a>
		
  <p class="article-time">
    <time datetime="2022-02-21T12:51:00.000Z" itemprop="datePublished"> 发表于 2022-02-21</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>Unity游戏开发过程中我需要掌握一些常规的数学知识(比如线性代数)，游戏开发接触的比较多的就是向量和矩阵，本章节用于记录和学习数学相关的知识，好让自己对于平时用到的数学知识有一个归纳和深入的学习总结，避免每次都是久了不用就忘。</p>
<p>推荐书籍:</p>
<p>《3D数学基础:图形与游戏开发》</p>
<p>此书记讲到了游戏开发中需要用到的大部分数学基础知识，以前看这个书的时候是为了学习而学习，没有深入实战，而今天重拾此书，一边实战(结合Unity)一边记录的方式，深入学习游戏开发的数学基础知识，避免出现久了不用就忘的情况，也方便以后温故而知新。</p>
<p>Note:</p>
<ol>
<li>为了减少重复的代码展示，后续相同代码展示会采用***代替</li>
</ol>
<h1 id="3D数学"><a href="#3D数学" class="headerlink" title="3D数学"></a>3D数学</h1><p>什么是3D数学？</p>
<p><a target="_blank" rel="noopener" href="http://cn-library.rukomos.ru/3dshu_xue_ji_chu_tu_xing_yu_you_xi_kai_fa__106961-pdf-read_online.html">3D数学是一门和计算几何相关的学科，计算几何则是研究用数值方法解决几何问题的学科</a></p>
<h1 id="坐标系"><a href="#坐标系" class="headerlink" title="坐标系"></a>坐标系</h1><p><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E7%AC%9B%E5%8D%A1%E5%B0%94%E5%9D%90%E6%A0%87%E7%B3%BB">笛卡尔坐标系在数学中是一种正交坐标系，由法国数学家勒内·笛卡尔引入而得名。二维的直角坐标系是由两条相互垂直、相交于原点的数线构成的。在平面内，任何一点的坐标是根据数轴上对应的点的坐标设定的。在平面内，任何一点与坐标的对应关系，类似于数轴上点与坐标的对应关系。</a></p>
<p><img src="/img/Math/3DCartesian.png" alt="3DCartesian"></p>
<p>笛卡尔坐标系就是我们以前学习平面几何时学习的坐标系，通过笛卡尔坐标系，我们可以通过x,y,z定义1D,2D或3D等空间的点。</p>
<p>坐标系从大的类型上来分分为两类:</p>
<ol>
<li><strong>左手坐标系</strong></li>
<li><strong>右手坐标系</strong></li>
</ol>
<p>如何区分左手还是右手坐标系了？</p>
<p><strong>通过将大拇指指向Z轴正方向，如果其余四指握起是从X轴往Y轴那么就是左手坐标系，反之则是右手坐标系</strong></p>
<p>Note:</p>
<ol>
<li><strong>大拇指指向X轴，食指指向Y轴，中指指向Z轴</strong></li>
<li><strong>Unity是左手坐标系</strong></li>
<li><strong>OpenGL是右手坐标系</strong></li>
</ol>
<h2 id="多坐标系"><a href="#多坐标系" class="headerlink" title="多坐标系"></a>多坐标系</h2><p>坐标系不止一种，<a target="_blank" rel="noopener" href="http://cn-library.rukomos.ru/3dshu_xue_ji_chu_tu_xing_yu_you_xi_kai_fa__106961-pdf-read_online.html">使用多种坐标系的原因是某些信息只能在特定的上下文环境中获得</a></p>
<p>比如以前学习OpenGL的时候，就了解到一个三角形要想渲染到屏幕上，需要经历<strong>MVP</strong>的矩阵变换。</p>
<p><strong>M</strong> – Model -&gt; World(模型坐标系到世界坐标系)</p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/261097735"><strong>变换目的:3D模型是基于自身的坐标系存储的。计算模型各顶点在世界空间的位置，以便将模型摆放到世界空间中。</strong></a></p>
<p>这里的世界坐标系，就是Unity里我们访问Transform.position时访问到的世界坐标所处的坐标系。</p>
<p><img src="/img/Math/WorldCoordinateSystem.PNG" alt="WorldCoordinateSystem"></p>
<p>而物体坐标系是相对物体自身而言的坐标系，通过勾选Local，我们可以看到物体自身的坐标系:</p>
<p><img src="/img/Math/LocalCoordinateSystem.PNG" alt="LocalCoordinateSystem"></p>
<p>通过Model -&gt; World我们就得到了物体在世界坐标系里的位置表达信息。</p>
<p><strong>V</strong> – World -&gt; View(世界坐标系到相机坐标系)</p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/261097735"><strong>变换目的:计算物体对相机的相对位置，以便进行后续变换</strong></a></p>
<p><strong>P</strong> – View -&gt; Projection(摄像机坐标系到投影坐标系)</p>
<p>因为摄像机的投影方式有多种(比如透视投影和正交投影)，所以从摄像机坐标系到投影坐标系也存在着不同的计算方式。</p>
<p>详情参考以前的学习记录:</p>
<p><a href="http://tonytang1990.github.io/2015/08/26/OpenGL%E5%AD%A6%E4%B9%A0/#Coordinate_Transformations_&_Perspective_Projection">Coordinate Transformations &amp; Perspective Projection</a></p>
<p>后续我们学习矩阵概念的时候再深入理解，核心就是通过矩阵执行坐标系转换。</p>
<p>Note:</p>
<ol>
<li><strong>矩阵变换是由M &#x3D; S(scale) × R(rotation) × T(translation)组成，且不满足交换律，因为S和R都是针对坐标系原点进行的，一旦先执行T，那么相对于坐标系原点的位置就会有所变化，这之后再做S和R就会出现不一样的表现。</strong></li>
</ol>
<h2 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h2><p>接下来通过使用Unity来更深入的理解坐标系变化:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             CoordinateStudy.cs</span></span><br><span class="line"><span class="comment"> * Author:                  TONYTANG</span></span><br><span class="line"><span class="comment"> * Create Date:             2022/03/11</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> UnityEngine.UI;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> CoordinateStudy.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 坐标系学习</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CoordinateStudy</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 提示文本</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;提示文本&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> Text TipTxt;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Cube1</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;Cube1&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> GameObject Cube1;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Cube2</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;Cube2&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> GameObject Cube2;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Start</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> cube1RelativeCube2Pos = Cube2.transform.InverseTransformPoint(Cube1.transform.position);</span><br><span class="line">        <span class="keyword">var</span> cube2RelativeCube1Pos = Cube1.transform.InverseTransformPoint(Cube2.transform.position);</span><br><span class="line">        TipTxt.text = <span class="string">$&quot;红色表示Cube1,绿色表示Cube2\n&quot;</span> +</span><br><span class="line">                        <span class="string">$&quot;Cube1世界坐标:<span class="subst">&#123;Cube1.transform.position.ToString()&#125;</span> 旋转角度:<span class="subst">&#123;Cube1.transform.eulerAngles.ToString()&#125;</span>\n&quot;</span> +</span><br><span class="line">                        <span class="string">$&quot;Cube2世界坐标系:<span class="subst">&#123;Cube2.transform.position.ToString()&#125;</span> 旋转角度:<span class="subst">&#123;Cube2.transform.eulerAngles.ToString()&#125;</span>\n&quot;</span> +</span><br><span class="line">                        <span class="string">$&quot;Cube1相对Cube2的坐标为:<span class="subst">&#123;cube1RelativeCube2Pos.ToString()&#125;</span>\n&quot;</span> +</span><br><span class="line">                        <span class="string">$&quot;Cube2相对Cube1的坐标为:<span class="subst">&#123;cube2RelativeCube1Pos.ToString()&#125;</span>&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/img/Math/Cube2LocalCoordinateSystem.PNG" alt="Cube2LocalCoordinateSystem"></p>
<p><img src="/img/Math/WorldAndLocalCoordinateCaculate.PNG" alt="WorldAndLocalCoordinateCaculate"></p>
<p>可以看到我通过调用**transform.InverseTransformPoint()**接口实现了将物体世界坐标转换到另一个物体的局部坐标的转换。因为Cube1在坐标原点且没有旋转，所以Cube2在Cube1物体坐标系里的位置也就是Cube2的世界坐标系位置。而Cube2因为有旋转，所以Cube1在Cube2物体坐标系的位置就需要根据Cube2的本地坐标系来计算了。</p>
<p>考虑到世界坐标系到视口坐标系转换后平时用不上，所以这里就不可视化结果了，通过<strong>Camera.WorldToViewportPoint()<strong>接口可以把</strong>世界坐标转换到摄像机视口坐标</strong>。同理<strong>Camera.WorldToScreenPoint()<strong>可以把</strong>世界坐标转换到屏幕坐标</strong>，这个接口相对而言更常用些(比如3D映射2D UI显示的时候)。</p>
<p>Note:</p>
<ol>
<li><strong>如果想查看物体本地坐标系和世界坐标系的转换矩阵，Unity里可以通过Transform.localToWorldMatrix()和Transform.worldToLocalMatrix()接口拿到变换的矩阵</strong></li>
</ol>
<h1 id="向量"><a href="#向量" class="headerlink" title="向量"></a>向量</h1><p><strong>向量有两种不同但相关相关的意义，一种是纯抽象的数学意义，另一种是几何意义。</strong></p>
<h2 id="数学定义"><a href="#数学定义" class="headerlink" title="数学定义"></a>数学定义</h2><p><strong>向量就是一个数字列表，对程序员而言则是另一种类似的概念–数组</strong></p>
<p>行向量(1行3列):</p>
<p>[1, 2, 3]</p>
<p>列向量(一列三行):</p>
<p>[ 1 ]</p>
<p>[ 2 ]</p>
<p>[ 3 ]</p>
<p><strong>向量中的数表达了每个维度上的有向位移。比如上面的向量在坐标系里表达的是相对[0,0,0]原点的X,Y,Z轴分别位移1,2,3</strong></p>
<p>Note:</p>
<ol>
<li><strong>注意区分向量和标量，标量是平时用的数字的技术称谓</strong></li>
</ol>
<h2 id="几何定义"><a href="#几何定义" class="headerlink" title="几何定义"></a>几何定义</h2><p><strong>向量是有大小和方向的线段。</strong></p>
<p><strong>向量的大小就是向量的长度(模)。向量有非负的长度。</strong></p>
<p><strong>向量的方向描述了空间中向量的指向。</strong></p>
<p><strong>向量模 &#x3D; Sqrt(VX * VX + VY * VY + VZ * VZ)</strong></p>
<p>向量里有一个比较重要的定义:</p>
<p><strong>单位向量，单位向量可以用来表示方式，但单位向量的大小(模)为1</strong></p>
<p><strong>单位向量 &#x3D; 向量 &#x2F; 向量的模</strong></p>
<p>这里简单说一下向量加法的概念：</p>
<p>A + B &#x3D; C</p>
<p><strong>几何解释是向量A通过向量B的平移得到向量C(A向量头连接B向量尾的向量)</strong></p>
<p>接下来让我通过可视化绘制世界坐标系和可视化绘制两个Cube的连线来看看向量是如何表达出两个物体之间的方向和大小的。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             HandlesUtilities.cs</span></span><br><span class="line"><span class="comment"> * Author:                  TONYTANG</span></span><br><span class="line"><span class="comment"> * Create Date:             2022/03/17</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEditor;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> HandlesUtilities.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Handles辅助工具</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">HandlesUtilities</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 绘制有颜色的文本</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;pos&quot;&gt;</span>坐标<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;text&quot;&gt;</span>文本<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;color&quot;&gt;</span>颜色<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">DrawColorLable</span>(<span class="params">Vector3 pos, <span class="built_in">string</span> text, Color color</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Color preColor = GUI.color;</span><br><span class="line">        GUI.color = color;</span><br><span class="line">        Handles.Label(pos, text);</span><br><span class="line">        GUI.color = preColor;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             VectorStudy.cs</span></span><br><span class="line"><span class="comment"> * Author:                  TONYTANG</span></span><br><span class="line"><span class="comment"> * Create Date:             2022/03/17</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> UnityEngine.UI;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> VectorStudy.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 向量学习</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">VectorStudy</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    ******</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Start</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> cube1ToCube2Vector = Cube2.transform.position - Cube1.transform.position;</span><br><span class="line">        <span class="keyword">var</span> cube2ToCube3Vector = Cube3.transform.position - Cube2.transform.position;</span><br><span class="line">        <span class="keyword">var</span> vectorAdd = cube1ToCube2Vector + cube2ToCube3Vector;</span><br><span class="line">        TipTxt.text = <span class="string">$&quot;红色表示Cube1,绿色表示Cube2,蓝色表示Cube3\n&quot;</span> +</span><br><span class="line">                        <span class="string">$&quot;Cube1世界坐标:<span class="subst">&#123;Cube1.transform.position.ToString()&#125;</span> 朝向:<span class="subst">&#123;Cube1.transform.forward.ToString()&#125;</span>\n&quot;</span> +</span><br><span class="line">                        <span class="string">$&quot;Cube2世界坐标系:<span class="subst">&#123;Cube2.transform.position.ToString()&#125;</span> 朝向:<span class="subst">&#123;Cube2.transform.forward.ToString()&#125;</span>\n&quot;</span> +</span><br><span class="line">                        <span class="string">$&quot;Cube3世界坐标系:<span class="subst">&#123;Cube3.transform.position.ToString()&#125;</span> 朝向:<span class="subst">&#123;Cube3.transform.forward.ToString()&#125;</span>\n&quot;</span> +</span><br><span class="line">                        <span class="string">$&quot;Cube1到Cube2的向量:<span class="subst">&#123;cube1ToCube2Vector.ToString()&#125;</span>\n&quot;</span> +</span><br><span class="line">                        <span class="string">$&quot;Cube1到Cube2的向量长度:<span class="subst">&#123;cube1ToCube2Vector.magnitude&#125;</span>\n&quot;</span>+</span><br><span class="line">                        <span class="string">$&quot;Cube2到Cube3的向量:<span class="subst">&#123;cube1ToCube2Vector.ToString()&#125;</span>\n&quot;</span> +</span><br><span class="line">                        <span class="string">$&quot;1-&gt;2 + 2-&gt;3 = <span class="subst">&#123;vectorAdd.ToString()&#125;</span>&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             VectorStudyEditor.cs</span></span><br><span class="line"><span class="comment"> * Author:                  TONYTANG</span></span><br><span class="line"><span class="comment"> * Create Date:             2022/03/17</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEditor;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> VectorStudyEditor.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> VectorStudy的Editor绘制</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">CustomEditor(typeof(VectorStudy))</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">VectorStudyEditor</span> : <span class="title">Editor</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Cube1属性</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    SerializedProperty mCube1Property;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Cube2属性</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    SerializedProperty mCube2Property;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Cube3属性</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    SerializedProperty mCube3Property;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 坐标系长度属性</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    SerializedProperty mCoordinateSystemLengthProperty;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Z轴颜色属性</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    SerializedProperty mForwardAxisColorProperty;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> X轴颜色属性</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    SerializedProperty mRightAxisColorProperty;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Y轴颜色</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    SerializedProperty mUpAxisColorProperty;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 向量颜色</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    SerializedProperty mVectorColorProperty;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Cube1</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> GameObject mCube1;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Cube2</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> GameObject mCube2;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Cube3</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> GameObject mCube3;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">OnEnable</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mCube1Property = serializedObject.FindProperty(<span class="string">&quot;Cube1&quot;</span>);</span><br><span class="line">        mCube2Property = serializedObject.FindProperty(<span class="string">&quot;Cube2&quot;</span>);</span><br><span class="line">        mCube3Property = serializedObject.FindProperty(<span class="string">&quot;Cube3&quot;</span>);</span><br><span class="line">        mCoordinateSystemLengthProperty = serializedObject.FindProperty(<span class="string">&quot;CoordinateSystemLength&quot;</span>);</span><br><span class="line">        mForwardAxisColorProperty = serializedObject.FindProperty(<span class="string">&quot;ForwardAxisColor&quot;</span>);</span><br><span class="line">        mRightAxisColorProperty = serializedObject.FindProperty(<span class="string">&quot;RightAxisColor&quot;</span>);</span><br><span class="line">        mUpAxisColorProperty = serializedObject.FindProperty(<span class="string">&quot;UpAxisColor&quot;</span>);</span><br><span class="line">        mVectorColorProperty = serializedObject.FindProperty(<span class="string">&quot;VectorColor&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">OnSceneGUI</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        InitData();</span><br><span class="line">        DrawCubeInfo();</span><br><span class="line">        DrawWorldCoordinateSystem();</span><br><span class="line">        DrawVectorInfo();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 初始化数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">InitData</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mCube1 = mCube1Property?.objectReferenceValue != <span class="literal">null</span> ? mCube1Property.objectReferenceValue <span class="keyword">as</span> GameObject : <span class="literal">null</span>;</span><br><span class="line">        mCube2 = mCube2Property?.objectReferenceValue != <span class="literal">null</span> ? mCube2Property.objectReferenceValue <span class="keyword">as</span> GameObject : <span class="literal">null</span>;</span><br><span class="line">        mCube3 = mCube3Property?.objectReferenceValue != <span class="literal">null</span> ? mCube3Property.objectReferenceValue <span class="keyword">as</span> GameObject : <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 绘制Cube信息</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">DrawCubeInfo</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        HandlesUtilities.DrawColorLable(mCube1.transform.position, <span class="string">&quot;Cube1&quot;</span>, Color.red);</span><br><span class="line">        HandlesUtilities.DrawColorLable(mCube2.transform.position, <span class="string">&quot;Cube2&quot;</span>, Color.red);</span><br><span class="line">        HandlesUtilities.DrawColorLable(mCube3.transform.position, <span class="string">&quot;Cube3&quot;</span>, Color.red);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 绘制世界坐标系</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">DrawWorldCoordinateSystem</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        HandlesUtilities.DrawColorLable(Vector3.zero, <span class="string">&quot;世界坐标系&quot;</span>, Color.red);</span><br><span class="line">        <span class="keyword">if</span> (Event.current.type == EventType.Repaint)</span><br><span class="line">        &#123;</span><br><span class="line">            Handles.color = mForwardAxisColorProperty.colorValue;</span><br><span class="line">            Handles.ArrowHandleCap(<span class="number">1</span>, Vector3.zero,</span><br><span class="line">                                    Quaternion.LookRotation(Vector3.forward),</span><br><span class="line">                                    mCoordinateSystemLengthProperty.floatValue, EventType.Repaint);</span><br><span class="line"></span><br><span class="line">            Handles.color = mRightAxisColorProperty.colorValue;</span><br><span class="line">            Handles.ArrowHandleCap(<span class="number">1</span>, Vector3.zero,</span><br><span class="line">                                    Quaternion.LookRotation(Vector3.right),</span><br><span class="line">                                    mCoordinateSystemLengthProperty.floatValue, EventType.Repaint);</span><br><span class="line"></span><br><span class="line">            Handles.color = mUpAxisColorProperty.colorValue;</span><br><span class="line">            Handles.ArrowHandleCap(<span class="number">1</span>, Vector3.zero,</span><br><span class="line">                                    Quaternion.LookRotation(Vector3.up),</span><br><span class="line">                                    mCoordinateSystemLengthProperty.floatValue, EventType.Repaint);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 绘制相关向量</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">DrawVectorInfo</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (Event.current.type == EventType.Repaint)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (mCube1 != <span class="literal">null</span> &amp;&amp; mCube2 != <span class="literal">null</span> &amp;&amp; mCube3 != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> cube1ToCube2Vector = mCube2.transform.position - mCube1.transform.position;</span><br><span class="line">                <span class="keyword">var</span> cube2ToCube3Vector = mCube3.transform.position - mCube2.transform.position;</span><br><span class="line">                <span class="keyword">var</span> vectorAdd = cube1ToCube2Vector + cube2ToCube3Vector;</span><br><span class="line">                Handles.color = mVectorColorProperty.colorValue;</span><br><span class="line">                Handles.ArrowHandleCap(<span class="number">1</span>, mCube1.transform.position,</span><br><span class="line">                                        Quaternion.LookRotation(cube1ToCube2Vector),</span><br><span class="line">                                        cube1ToCube2Vector.magnitude, EventType.Repaint);</span><br><span class="line">                Handles.ArrowHandleCap(<span class="number">1</span>, mCube2.transform.position,</span><br><span class="line">                                        Quaternion.LookRotation(cube2ToCube3Vector),</span><br><span class="line">                                        cube2ToCube3Vector.magnitude, EventType.Repaint);</span><br><span class="line">                Handles.ArrowHandleCap(<span class="number">1</span>, mCube1.transform.position,</span><br><span class="line">                                        Quaternion.LookRotation(vectorAdd),</span><br><span class="line">                                        vectorAdd.magnitude, EventType.Repaint);</span><br><span class="line">                Handles.Label(mCube1.transform.position + cube1ToCube2Vector / <span class="number">2</span>, <span class="string">&quot;1-&gt;2&quot;</span>);</span><br><span class="line">                Handles.Label(mCube2.transform.position + cube2ToCube3Vector / <span class="number">2</span>, <span class="string">&quot;2-&gt;3&quot;</span>);</span><br><span class="line">                Handles.Label(mCube1.transform.position + vectorAdd / <span class="number">2</span>, <span class="string">&quot;1-&gt;2 + 2-&gt;3&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/img/Math/ObjectConnectVectorAndCoordinateSystem.PNG" alt="ObjectConnectVectorAndCoordinateSystem"></p>
<p>通过Handles相关接口，我们成功绘制出了以下东西:</p>
<ol>
<li>世界坐标系</li>
<li>Cube1到Cube2的向量</li>
<li>Cube2到Cube3的向量</li>
<li>1-&gt;2 + 2-&gt;3的向量</li>
</ol>
<p>可以看到Cube2坐标-Cube1坐标&#x3D;从Cube1位置指向Cube2位置的向量，也就是说<strong>B - A &#x3D; A-&gt;B</strong></p>
<p>同时上面的可视化也显示了，<strong>A-&gt;B + B-&gt;C &#x3D; A-&gt;C</strong>的向量加法规则，减法反向理解即可。</p>
<p>接下来我们要学习了解向量里比较重要的两个运算概念:</p>
<ol>
<li><strong>点乘</strong></li>
<li><strong>叉乘</strong></li>
</ol>
<p>Note:</p>
<ol>
<li><strong>方向并不完全和方位相同</strong></li>
<li><strong>数学中专门研究向量的分支称作线性代数</strong></li>
<li><strong>向量加法满足交换律，但向量减法不满足交换律。因为得到的向量方向相反。</strong></li>
</ol>
<h3 id="点乘"><a href="#点乘" class="headerlink" title="点乘"></a>点乘</h3><p><strong>点乘(也称为内积)，记做a.b</strong></p>
<p><strong>a.b &#x3D; a1 * b1 + a2 * b2 + a3 * b3 … + an * bn</strong></p>
<p>几何解释:</p>
<p><strong>点乘等于向量大小与向量夹角的cosθ值的积。点乘结果描述了两个向量的”相似”程度，点乘结果越大，两向量越相近。</strong></p>
<p><strong>a.b &#x3D; |a| * |b| * cosθ</strong></p>
<p><img src="/img/Math/VectorDotGeometric.png" alt="VectorDotGeometric"></p>
<p>根据上面的公式和图我们可以看出，点乘在几何里的可以理解成<strong>a向量在b向量上的投影乘以b向量的模</strong></p>
<p>通过上面的公式我们反向推到夹角的计算公式如下:</p>
<p><strong>θ &#x3D; arccor(a.b &#x2F; |a| * |b|)</strong></p>
<p>如果我们不关心点乘的大小，那么从点乘的值我们可以判定两个向量之间的夹角情况:</p>
<ol>
<li><strong>a.b &gt; 0 –&gt; 方向基本相同，夹角在0到90度之间</strong></li>
<li><strong>a.b &#x3D; 0 –&gt; 正交，两向量垂直</strong></li>
<li><strong>a.b &lt; 0 –&gt; 方向基本相反，夹角在90-180度之间</strong></li>
</ol>
<p>接下来让我们通过Unity实战可视化辅助我们学习向量点乘:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             VectorStudyEditor.cs</span></span><br><span class="line"><span class="comment"> * Author:                  TONYTANG</span></span><br><span class="line"><span class="comment"> * Create Date:             2022/03/17</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEditor;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> VectorStudyEditor.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> VectorStudy的Editor绘制</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">CustomEditor(typeof(VectorDotStudy))</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">VectorDotStudyEditor</span> : <span class="title">Editor</span></span><br><span class="line">&#123;</span><br><span class="line">    ******</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 绘制相关向量</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">DrawVectorInfo</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (Event.current.type == EventType.Repaint)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (mCube1 != <span class="literal">null</span> &amp;&amp; mCube2 != <span class="literal">null</span> &amp;&amp; mCube3 != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> cube1ToCube2Vector = mCube2.transform.position - mCube1.transform.position;</span><br><span class="line">                <span class="keyword">var</span> cube1ToCube3Vector = mCube3.transform.position - mCube1.transform.position;</span><br><span class="line">                <span class="keyword">var</span> vectorDot = Vector3.Dot(cube1ToCube2Vector, cube1ToCube3Vector);</span><br><span class="line">                <span class="keyword">var</span> radians = Mathf.Acos(vectorDot / (cube1ToCube2Vector.magnitude * cube1ToCube3Vector.magnitude));</span><br><span class="line">                <span class="keyword">var</span> angle = Mathf.Rad2Deg * radians;</span><br><span class="line">                Handles.color = mVectorColorProperty.colorValue;</span><br><span class="line">                Handles.ArrowHandleCap(<span class="number">1</span>, mCube1.transform.position,</span><br><span class="line">                                        Quaternion.LookRotation(cube1ToCube2Vector),</span><br><span class="line">                                        cube1ToCube2Vector.magnitude, EventType.Repaint);</span><br><span class="line">                Handles.ArrowHandleCap(<span class="number">1</span>, mCube1.transform.position,</span><br><span class="line">                                        Quaternion.LookRotation(cube1ToCube3Vector),</span><br><span class="line">                                        cube1ToCube3Vector.magnitude, EventType.Repaint);</span><br><span class="line">                Handles.Label(mCube1.transform.position + cube1ToCube2Vector / <span class="number">2</span>, <span class="string">&quot;1-&gt;2&quot;</span>);</span><br><span class="line">                Handles.Label(mCube1.transform.position + cube1ToCube3Vector / <span class="number">2</span>, <span class="string">&quot;1-&gt;3&quot;</span>);</span><br><span class="line">                HandlesUtilities.DrawColorLable(mCube1.transform.position, <span class="string">$&quot;夹角:<span class="subst">&#123;angle&#125;</span>&quot;</span>, Color.green);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             VectorDotStudy.cs</span></span><br><span class="line"><span class="comment"> * Author:                  TONYTANG</span></span><br><span class="line"><span class="comment"> * Create Date:             2022/03/17</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> UnityEngine.UI;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> VectorDotStudy.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 向量点乘学习</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">VectorDotStudy</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    ******</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Start</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> cube1ToCube2Vector = Cube2.transform.position - Cube1.transform.position;</span><br><span class="line">        <span class="keyword">var</span> cube1ToCube3Vector = Cube3.transform.position - Cube1.transform.position;</span><br><span class="line">        <span class="keyword">var</span> vectorDot = Vector3.Dot(cube1ToCube2Vector, cube1ToCube3Vector);</span><br><span class="line">        <span class="keyword">var</span> radians = Mathf.Acos(vectorDot / (cube1ToCube2Vector.magnitude * cube1ToCube3Vector.magnitude));</span><br><span class="line">        <span class="keyword">var</span> angle = Mathf.Rad2Deg * radians;</span><br><span class="line">        TipTxt.text = <span class="string">$&quot;红色表示Cube1,绿色表示Cube2,蓝色表示Cube3\n&quot;</span> +</span><br><span class="line">                        <span class="string">$&quot;Cube1世界坐标:<span class="subst">&#123;Cube1.transform.position.ToString()&#125;</span> 朝向:<span class="subst">&#123;Cube1.transform.forward.ToString()&#125;</span>\n&quot;</span> +</span><br><span class="line">                        <span class="string">$&quot;Cube2世界坐标系:<span class="subst">&#123;Cube2.transform.position.ToString()&#125;</span> 朝向:<span class="subst">&#123;Cube2.transform.forward.ToString()&#125;</span>\n&quot;</span> +</span><br><span class="line">                        <span class="string">$&quot;Cube3世界坐标系:<span class="subst">&#123;Cube3.transform.position.ToString()&#125;</span> 朝向:<span class="subst">&#123;Cube3.transform.forward.ToString()&#125;</span>\n&quot;</span> +</span><br><span class="line">                        <span class="string">$&quot;Cube1到Cube2的向量:<span class="subst">&#123;cube1ToCube2Vector.ToString()&#125;</span>\n&quot;</span> +</span><br><span class="line">                        <span class="string">$&quot;Cube1到Cube3的向量:<span class="subst">&#123;cube1ToCube3Vector.magnitude&#125;</span>\n&quot;</span> +</span><br><span class="line">                        <span class="string">$&quot;1-&gt;2 点乘 2-&gt;3 = <span class="subst">&#123;vectorDot&#125;</span>\n&quot;</span> +</span><br><span class="line">                        <span class="string">$&quot;1-&gt;2和2-&gt;3的夹角:<span class="subst">&#123;angle&#125;</span>&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/img/Math/VectorDot.PNG" alt="VectorDot"></p>
<p>通过上面的计算和可视化，可以看到我们通过Mathf.Acos(a.b &#x2F; (|a| * |b|)) * Mathf.Rad2Deg实现了点乘角度的逆推。</p>
<p>并且因为点乘是a.b &#x3D; |a| * |b| * cos(θ)，所以从点乘的结果我们可以分析出两个向量的角度情况:</p>
<p><strong>a.b &gt; 0表示a和b向量夹角为0度到90度</strong></p>
<p><strong>a.b&#x3D;&#x3D;0表示a和b向量垂直</strong></p>
<p><strong>a.b&lt;0表示a和b向量夹角为90度到180度</strong></p>
<p>Note:</p>
<ol>
<li><strong>点乘满足交换律</strong></li>
<li><strong>点乘对零向量的解释是，零向量和任意其他向量垂直</strong></li>
<li><strong>Unity Mathf.Acos()返回的是弧度而非角度，需要通过乘以Mathf.Rad2Deg进行角度转换</strong></li>
</ol>
<h3 id="叉乘"><a href="#叉乘" class="headerlink" title="叉乘"></a>叉乘</h3><p><strong>叉乘又称叉积，和点乘不一样，点乘得到一个标量并满足交换律，向量叉乘得到一个向量并且不满足交换律</strong></p>
<p>​				 [x1] * [x2]	 [y1 * z2 - z1 * y1 ] </p>
<p>​	a X b &#x3D; [y1] * [y2] &#x3D;  [ z1 * x2 - x1 * z2 ]</p>
<p>​			 	[z1] * [y3]	  [ x1 * y2 - y1 * x2 ]</p>
<p>几何解释：</p>
<p><strong>叉乘得到的向量垂直于原来的两个向量</strong></p>
<p><img src="/img/Math/VectorCrossVisilization.png" alt="VectorCrossVisilization"></p>
<p>**|aXb|&#x3D;|a|<em>|b|<em>sinθ</em></em></p>
<p><strong>从2维平面几何来说，a向量和b向量的叉乘长度等于以a向量和b向量为边的平行四边形面积。</strong></p>
<p>我们知道了a向量叉乘b向量得到的是一个垂直于a和b平面的向量，那么这个向量是朝上还是朝下是如何决定的了？</p>
<p><strong>通过把a向量和b向量首尾相连，在左手坐标系里如果a和b成顺时针，那么aXb的结果向量向外，反之向里。右手坐标系中则恰好相反。</strong></p>
<p>接下来让我们结合实战，看下我们是如何利用叉乘计算出垂直a和b向量的c向量的:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             VectorCrossStudyEditor.cs</span></span><br><span class="line"><span class="comment"> * Author:                  TONYTANG</span></span><br><span class="line"><span class="comment"> * Create Date:             2022/03/17</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEditor;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> VectorCrossStudyEditor.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> VectorCrossStudy的Editor绘制</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">CustomEditor(typeof(VectorCrossStudy))</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">VectorCrossStudyEditor</span> : <span class="title">Editor</span></span><br><span class="line">&#123;</span><br><span class="line">    ******</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 绘制相关向量</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">DrawVectorInfo</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (Event.current.type == EventType.Repaint)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (mCube1 != <span class="literal">null</span> &amp;&amp; mCube2 != <span class="literal">null</span> &amp;&amp; mCube3 != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> cube1Forward = mCube1.transform.forward;</span><br><span class="line">                <span class="keyword">var</span> cube1ToCube2 = mCube2.transform.position - mCube1.transform.position;</span><br><span class="line">                <span class="keyword">var</span> vectorDot = Vector3.Dot(cube1Forward, cube1ToCube2);</span><br><span class="line">                <span class="keyword">var</span> radians = Mathf.Acos(vectorDot / (cube1Forward.magnitude * cube1ToCube2.magnitude));</span><br><span class="line">                <span class="keyword">var</span> angle = Mathf.Rad2Deg * radians;</span><br><span class="line">                <span class="keyword">var</span> vectorCross = Vector3.Cross(cube1Forward, cube1ToCube2);</span><br><span class="line">                vectorCross = (angle &lt;= Mathf.Epsilon &amp;&amp; angle &gt;= -Mathf.Epsilon) ? cube1Forward : vectorCross;</span><br><span class="line">                Handles.color = mVectorColorProperty.colorValue;</span><br><span class="line">                Handles.ArrowHandleCap(<span class="number">1</span>, mCube1.transform.position,</span><br><span class="line">                                        Quaternion.LookRotation(cube1Forward),</span><br><span class="line">                                        mCoordinateSystemLengthProperty.floatValue, EventType.Repaint);</span><br><span class="line">                Handles.ArrowHandleCap(<span class="number">1</span>, mCube1.transform.position,</span><br><span class="line">                                        Quaternion.LookRotation(cube1ToCube2),</span><br><span class="line">                                        mCoordinateSystemLengthProperty.floatValue, EventType.Repaint);</span><br><span class="line">                Handles.ArrowHandleCap(<span class="number">1</span>, mCube1.transform.position,</span><br><span class="line">                                        Quaternion.LookRotation(vectorCross),</span><br><span class="line">                                        mCoordinateSystemLengthProperty.floatValue, EventType.Repaint);</span><br><span class="line">                HandlesUtilities.DrawColorLable(mCube1.transform.position, <span class="string">$&quot;夹角:<span class="subst">&#123;angle&#125;</span>&quot;</span>, Color.green);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             VectorCrossStudy.cs</span></span><br><span class="line"><span class="comment"> * Author:                  TONYTANG</span></span><br><span class="line"><span class="comment"> * Create Date:             2022/03/17</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> UnityEngine.UI;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> VectorCrossStudy.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 向量叉乘学习</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">VectorCrossStudy</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    ******</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 旋转角度</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">float</span> mAngle;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 旋转轴</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> Vector3 mRotateAxis;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Start</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        RotateBtn.onClick.AddListener(OnRotateBtnClick);</span><br><span class="line">        <span class="keyword">var</span> cube1Forward = Cube1.transform.forward;</span><br><span class="line">        <span class="keyword">var</span> cube1ToCube2 = Cube2.transform.position - Cube1.transform.position;</span><br><span class="line">        <span class="keyword">var</span> vectorDot = Vector3.Dot(cube1Forward, cube1ToCube2);</span><br><span class="line">        <span class="keyword">var</span> radians = Mathf.Acos(vectorDot / (cube1Forward.magnitude * cube1ToCube2.magnitude));</span><br><span class="line">        mAngle = Mathf.Rad2Deg * radians;</span><br><span class="line">        mRotateAxis = Vector3.Cross(cube1Forward, cube1ToCube2);</span><br><span class="line">        <span class="keyword">var</span> rotationDirection = mRotateAxis.y &gt; <span class="number">0</span> ? <span class="string">&quot;顺时针&quot;</span> : <span class="string">&quot;逆时针&quot;</span>;</span><br><span class="line">        TipTxt.text = <span class="string">$&quot;红色表示Cube1,绿色表示Cube2\n&quot;</span> +</span><br><span class="line">                        <span class="string">$&quot;Cube1世界坐标:<span class="subst">&#123;Cube1.transform.position.ToString()&#125;</span> 朝向:<span class="subst">&#123;Cube1.transform.forward.ToString()&#125;</span>\n&quot;</span> +</span><br><span class="line">                        <span class="string">$&quot;Cube2世界坐标系:<span class="subst">&#123;Cube2.transform.position.ToString()&#125;</span> 朝向:<span class="subst">&#123;Cube2.transform.forward.ToString()&#125;</span>\n&quot;</span> +</span><br><span class="line">                        <span class="string">$&quot;Cube1朝向:<span class="subst">&#123;cube1Forward.ToString()&#125;</span>\n&quot;</span> +</span><br><span class="line">                        <span class="string">$&quot;Cube1到Cube2向量:<span class="subst">&#123;cube1ToCube2.ToString()&#125;</span>\n&quot;</span> +</span><br><span class="line">                        <span class="string">$&quot;Cube1朝向 点乘 Cube1到Cube2向量 = <span class="subst">&#123;vectorDot&#125;</span>\n&quot;</span> +</span><br><span class="line">                        <span class="string">$&quot;Cube1朝向 叉乘 Cube1到Cube2向量 = <span class="subst">&#123;mRotateAxis.ToString()&#125;</span>\n&quot;</span> +</span><br><span class="line">                        <span class="string">$&quot;Cube1看向Cube2旋转方向:<span class="subst">&#123;rotationDirection&#125;</span>\n&quot;</span> +</span><br><span class="line">                        <span class="string">$&quot;Cube1看向Cube2旋转角度:<span class="subst">&#123;mAngle&#125;</span>&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 点击旋转Cube1看向Cube2</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">OnRotateBtnClick</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        Cube1.transform.Rotate(mRotateAxis, mAngle);</span><br><span class="line">        Debug.Log(<span class="string">$&quot;Cube1看向Cube2旋转方向:<span class="subst">&#123;mRotateAxis&#125;</span> 旋转角度:<span class="subst">&#123;mAngle&#125;</span>&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/img/Math/VectorCross.PNG" alt="VectorCross"></p>
<p>从上面的绘制可以看出，向量2-1叉乘向量1-3的结果是(0, 33.6, 0)，即结果向量是向上的，这和Unity左手坐标系，a和b头尾相连顺时针则向外(即向上)是符合的。</p>
<p>Note:</p>
<ol>
<li><strong>点乘和叉乘一起时，叉乘优先计算</strong></li>
<li><strong>叉乘不满足交换律和结合律</strong></li>
<li><strong>判定叉乘A叉乘B方向时可以通过四指指向A向量，然后转向B向量，此时大拇指的方向就是叉乘向量方向</strong></li>
</ol>
<h3 id="运用"><a href="#运用" class="headerlink" title="运用"></a>运用</h3><p><strong>点乘和叉乘最典型的运用就是通过点乘计算两个向量的夹角，通过叉乘计算两个向量的角度方向。</strong></p>
<p><strong>典型的问题就是已知玩家A和B的位置和朝向，如何让玩家A看向玩家B。</strong></p>
<p>要解决上述问题，我们需要通过玩家A到玩家B位置的向量和玩家A的朝向向量来计算出他们的夹角和旋转方向。</p>
<p>接下来结合Unity实战，让我们看看，我们是如何通过点乘和叉乘计算出两个向量的旋转角度和方向的:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             VectorUsingStudyEditor.cs</span></span><br><span class="line"><span class="comment"> * Author:                  TONYTANG</span></span><br><span class="line"><span class="comment"> * Create Date:             2022/03/17</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEditor;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> VectorUsingStudyEditor.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> VectorUsingStudy的Editor绘制</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">CustomEditor(typeof(VectorUsingStudy))</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">VectorUsingStudyEditor</span> : <span class="title">Editor</span></span><br><span class="line">&#123;</span><br><span class="line">    ******</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 绘制相关向量</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">DrawVectorInfo</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (Event.current.type == EventType.Repaint)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (mCube1 != <span class="literal">null</span> &amp;&amp; mCube2 != <span class="literal">null</span> &amp;&amp; mCube3 != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> cube1Forward = mCube1.transform.forward;</span><br><span class="line">                <span class="keyword">var</span> cube1ToCube2 = mCube2.transform.position - mCube1.transform.position;</span><br><span class="line">                <span class="keyword">var</span> vectorDot = Vector3.Dot(cube1Forward, cube1ToCube2);</span><br><span class="line">                <span class="keyword">var</span> radians = Mathf.Acos(vectorDot / (cube1Forward.magnitude * cube1ToCube2.magnitude));</span><br><span class="line">                <span class="keyword">var</span> angle = Mathf.Rad2Deg * radians;</span><br><span class="line">                <span class="keyword">var</span> vectorCross = Vector3.Cross(cube1Forward, cube1ToCube2);</span><br><span class="line">                vectorCross = (angle &lt;= Mathf.Epsilon &amp;&amp; angle &gt;= -Mathf.Epsilon) ? cube1Forward : vectorCross;</span><br><span class="line">                Handles.color = mVectorColorProperty.colorValue;</span><br><span class="line">                Handles.ArrowHandleCap(<span class="number">1</span>, mCube1.transform.position,</span><br><span class="line">                                        Quaternion.LookRotation(cube1Forward),</span><br><span class="line">                                        mCoordinateSystemLengthProperty.floatValue, EventType.Repaint);</span><br><span class="line">                Handles.ArrowHandleCap(<span class="number">1</span>, mCube1.transform.position,</span><br><span class="line">                                        Quaternion.LookRotation(cube1ToCube2),</span><br><span class="line">                                        mCoordinateSystemLengthProperty.floatValue, EventType.Repaint);</span><br><span class="line">                Handles.ArrowHandleCap(<span class="number">1</span>, mCube1.transform.position,</span><br><span class="line">                                        Quaternion.LookRotation(vectorCross),</span><br><span class="line">                                        mCoordinateSystemLengthProperty.floatValue, EventType.Repaint);</span><br><span class="line">                HandlesUtilities.DrawColorLable(mCube1.transform.position, <span class="string">$&quot;夹角:<span class="subst">&#123;angle&#125;</span>&quot;</span>, Color.green);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             VectorUsingStudy.cs</span></span><br><span class="line"><span class="comment"> * Author:                  TONYTANG</span></span><br><span class="line"><span class="comment"> * Create Date:             2022/03/17</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> UnityEngine.UI;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> VectorUsingStudy.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 向量点乘和叉乘实战学习</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">VectorUsingStudy</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    ******</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 旋转角度</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">float</span> mAngle;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 旋转轴</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> Vector3 mRotateAxis;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Start</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        RotateBtn.onClick.AddListener(OnRotateBtnClick);</span><br><span class="line">        <span class="keyword">var</span> cube1Forward = Cube1.transform.forward;</span><br><span class="line">        <span class="keyword">var</span> cube1ToCube2 = Cube2.transform.position - Cube1.transform.position;</span><br><span class="line">        <span class="keyword">var</span> vectorDot = Vector3.Dot(cube1Forward, cube1ToCube2);</span><br><span class="line">        <span class="keyword">var</span> radians = Mathf.Acos(vectorDot / (cube1Forward.magnitude * cube1ToCube2.magnitude));</span><br><span class="line">        mAngle = Mathf.Rad2Deg * radians;</span><br><span class="line">        mRotateAxis = Vector3.Cross(cube1Forward, cube1ToCube2);</span><br><span class="line">        <span class="keyword">var</span> rotationDirection = mRotateAxis.y &gt; <span class="number">0</span> ? <span class="string">&quot;顺时针&quot;</span> : <span class="string">&quot;逆时针&quot;</span>;</span><br><span class="line">        TipTxt.text = <span class="string">$&quot;红色表示Cube1,绿色表示Cube2\n&quot;</span> +</span><br><span class="line">                        <span class="string">$&quot;Cube1世界坐标:<span class="subst">&#123;Cube1.transform.position.ToString()&#125;</span> 朝向:<span class="subst">&#123;Cube1.transform.forward.ToString()&#125;</span>\n&quot;</span> +</span><br><span class="line">                        <span class="string">$&quot;Cube2世界坐标系:<span class="subst">&#123;Cube2.transform.position.ToString()&#125;</span> 朝向:<span class="subst">&#123;Cube2.transform.forward.ToString()&#125;</span>\n&quot;</span> +</span><br><span class="line">                        <span class="string">$&quot;Cube1朝向:<span class="subst">&#123;cube1Forward.ToString()&#125;</span>\n&quot;</span> +</span><br><span class="line">                        <span class="string">$&quot;Cube1到Cube2向量:<span class="subst">&#123;cube1ToCube2.ToString()&#125;</span>\n&quot;</span> +</span><br><span class="line">                        <span class="string">$&quot;Cube1朝向 点乘 Cube1到Cube2向量 = <span class="subst">&#123;vectorDot&#125;</span>\n&quot;</span> +</span><br><span class="line">                        <span class="string">$&quot;Cube1朝向 叉乘 Cube1到Cube2向量 = <span class="subst">&#123;mRotateAxis.ToString()&#125;</span>\n&quot;</span> +</span><br><span class="line">                        <span class="string">$&quot;Cube1看向Cube2旋转方向:<span class="subst">&#123;rotationDirection&#125;</span>\n&quot;</span> +</span><br><span class="line">                        <span class="string">$&quot;Cube1看向Cube2旋转角度:<span class="subst">&#123;mAngle&#125;</span>&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 点击旋转Cube1看向Cube2</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">OnRotateBtnClick</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        Cube1.transform.Rotate(mRotateAxis, mAngle);</span><br><span class="line">        Debug.Log(<span class="string">$&quot;Cube1看向Cube2旋转方向:<span class="subst">&#123;mRotateAxis&#125;</span> 旋转角度:<span class="subst">&#123;mAngle&#125;</span>&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/img/Math/RotationCaculation1.PNG" alt="RotationCaculation1"></p>
<p>从上面的效果图可以看出，当Cube2在不同的位置时，我们通过点乘和叉乘成功算出了Cube1朝向向量到Cube1到Cube2位置向量的旋转角度和选择方向。</p>
<p><img src="/img/Math/RotationCaculation2.PNG" alt="RotationCaculation2"></p>
<p>通过点击Cube1看向Cube2，我们调用transform.Rotate(叉乘的向量, 点乘逆推的角度)我们可以看到，Cube1实现通过绕(0, -1.8, 0)选择158度实现了看向Cube2。</p>
<p>如果只是单纯的让玩家B看向玩家A，实战中我们并不会向上面一样根据公式的逆推实现旋转轴和旋转角度，而是直接使用Unity提供的API，比如transform.LookAt(玩家ATransform)即可实现玩家B看向玩家A的需求。但了解底层的实现原理以及叉乘点乘的实际用处还是很有必要的。</p>
<p><strong>上面有一个细节要注意的是，Quaternion.LookRotation()不支持看向一个零向量，所以通过判定点旋转角度是否为0来判定是否Cube1朝向和Cube1连接Cube2的向量方向一致</strong></p>
<p>更多关于向量的运算参考Vector3相关的接口使用，在后续实战中更多的学习运用，这里就不一一提及了。</p>
<p>Note:</p>
<ol>
<li><strong>|aXb|为0表示两个向量平行</strong></li>
<li><strong>利用叉乘结果y大于0还是y小于0区分方向的同时，我们还能用于推断向量A在向量B的左侧还是右侧(大前提是两个向量在XZ平面)</strong></li>
<li><strong>想判定两个向量的前后关系，可以用点乘的正负结果来判定</strong></li>
</ol>
<h1 id="矩阵"><a href="#矩阵" class="headerlink" title="矩阵"></a>矩阵</h1><p>待添加……</p>
<h1 id="欧拉角与四元数"><a href="#欧拉角与四元数" class="headerlink" title="欧拉角与四元数"></a>欧拉角与四元数</h1><p>待添加……</p>
<h1 id="几何检测"><a href="#几何检测" class="headerlink" title="几何检测"></a>几何检测</h1><p>待添加……</p>
<h1 id="可见性检测"><a href="#可见性检测" class="headerlink" title="可见性检测"></a>可见性检测</h1><p>待添加……</p>
<h1 id="数学概念"><a href="#数学概念" class="headerlink" title="数学概念"></a>数学概念</h1><p>待添加……</p>
<h1 id="学习总结"><a href="#学习总结" class="headerlink" title="学习总结"></a>学习总结</h1><p>待添加……</p>
<h1 id="Github"><a href="#Github" class="headerlink" title="Github"></a>Github</h1><p>个人Github:</p>
<p><a target="_blank" rel="noopener" href="https://github.com/TonyTang1990/MathStudy">MathStudy</a></p>
<p>详细的Editor绘制学习参考:</p>
<p><a href="http://tonytang1990.github.io/2022/02/20/UnityEditor%E7%9F%A5%E8%AF%86/">UnityEditor知识</a></p>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/261097735">计算机图形学 5：齐次坐标与 MVP 矩阵变换</a></p>
<p><a target="_blank" rel="noopener" href="https://my.oschina.net/u/4324682/blog/3457254">向量内积（点乘）和外积（叉乘）概念及几何意义</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Math/">Math</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Math/">Math</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2022/02/20/UnityEditor知识/" title="UnityEditor知识" itemprop="url">UnityEditor知识</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Tony Tang" target="_blank" itemprop="author">Tony Tang</a>
		
  <p class="article-time">
    <time datetime="2022-02-20T14:37:00.000Z" itemprop="datePublished"> 发表于 2022-02-20</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>Unity游戏开发过程中我会需要通过Editor相关工具来编写一些工具和可视化显示工等，用于辅助完成特定的功能和编辑器开发，本章节用于整理和学习Unity相关的Editor知识，好让自己对于Editor的相关知识有一个系统的学习和整理。</p>
<h1 id="Editor绘制分类"><a href="#Editor绘制分类" class="headerlink" title="Editor绘制分类"></a>Editor绘制分类</h1><p>Unity里的UI包含多种UI:</p>
<ol>
<li><strong>UI Toolkit</strong>(最新一代的UI系统框架，高性能跨平台，基础Web技术)</li>
<li><strong>UGUI</strong>(老版的UI系统，2022年为止用的最多的官方UI系统)</li>
<li><strong>IMGUI</strong>(Immediate Mode Graphical User Interface，code-Driven的GUI系统)</li>
</ol>
<p>而我们现在主要Editor用到的GUI暂时是指<strong>IMGUI</strong>，未来更多的学习中心是<strong>UI Toolkit</strong>(通吃Editor和运行时开发的新一代UI框架)。</p>
<p>这里UGUI在Editor篇章就不重点讲述，本文重点学习IMGUI和UI Toolkit(TODO)。</p>
<p>上述三中UI适用场景和适用人群，这里放两张官方的图片用于有个基础认知:</p>
<p><img src="/img/Unity/EditorUIStudy/GUIEditorOrRuntime.PNG" alt="GUIEditorOrRuntime"></p>
<p><img src="/img/Unity/EditorUIStudy/GUIRolesAndSkillSets.PNG" alt="GUIRolesAndSkillSets"></p>
<p>详细的对比参考:</p>
<p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/UI-system-compare.html">UI-system-compare</a></p>
<p>Note:</p>
<ol>
<li><strong>UI Toolkit是官方主推的未来用于Editor和Runtime的新UI框架</strong></li>
</ol>
<h2 id="IMGUI"><a href="#IMGUI" class="headerlink" title="IMGUI"></a>IMGUI</h2><p>IMGUI主要用于绘制我们Editor的自定义UI(比如自定义窗口UI，自定义面板UI，自定义场景UI等)</p>
<h3 id="GUI"><a href="#GUI" class="headerlink" title="GUI"></a>GUI</h3><p>GUI主要由Type,Position和Content组成</p>
<ol>
<li>Type标识了GUI是什么类型的GUI(比如GUI.Label表示是一个标签)</li>
<li>Position标识了GUI的显示位置和大小等信息(Rect)</li>
<li>Content标识了GUI显示的内容(可以是一个文本可以使一个图片)</li>
</ol>
<p><strong>Type</strong>:</p>
<p>我们常用的GUI类型比如Lable(标签),Button(按钮),TextField(输入文本),Toggle(选择按钮)等</p>
<p><strong>Position</strong>:</p>
<p>位置和大小信息主要通过Rect结构来表示位置和大小信息</p>
<p><strong>Content</strong>:</p>
<p>GUI内容显示比如常用的文本和图标等形式</p>
<p>这里实现了一个简单的纯GUI的Unity学习项目:</p>
<p><img src="/img/Unity/EditorUIStudy/UnityEditorStudyiEntryUI.PNG" alt="UnityEditorStudyiEntryUI"></p>
<p><strong>Git地址见文章最后</strong></p>
<p>Note:</p>
<ol>
<li><strong>GUI的坐标系是左上角0,0</strong></li>
</ol>
<h3 id="GUI-Layout"><a href="#GUI-Layout" class="headerlink" title="GUI Layout"></a>GUI Layout</h3><p>GUI的排版分为两类:</p>
<ol>
<li><strong>固定排版</strong></li>
<li><strong>自动排版</strong></li>
</ol>
<p><strong>固定排版</strong>:</p>
<p>固定排版是指我通过调用构建传递Rect信息的方式，显示的指明GUI的显示位置和大小信息。但这样的方式在我们不知道UI布局(比如动态布局动态大小)的时候就很难实现完美的UI布局。</p>
<p>接下来我们直接实战看下效果:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             FixLayoutDraw.cs</span></span><br><span class="line"><span class="comment"> * Author:                  TONYTANG</span></span><br><span class="line"><span class="comment"> * Create Date:             2022/03/06</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> FixLayoutDraw.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 固定排版绘制</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">FixLayoutDraw</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnGUI</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        GUI.Label(<span class="keyword">new</span> Rect(<span class="number">0f</span>, <span class="number">0f</span>, <span class="number">300f</span>, <span class="number">100f</span>), <span class="string">$&quot;固定排版文本位置信息:(0, 0)大小:(300, 100)&quot;</span>);</span><br><span class="line"></span><br><span class="line">        GUI.BeginGroup(<span class="keyword">new</span> Rect(Screen.width / <span class="number">2</span> - <span class="number">100</span>, Screen.height / <span class="number">2</span> - <span class="number">100</span>, <span class="number">300f</span>, <span class="number">200f</span>));</span><br><span class="line">        GUI.Box(<span class="keyword">new</span> Rect(<span class="number">0</span>, <span class="number">25</span>, <span class="number">300</span>, <span class="number">50</span>), <span class="string">&quot;GUI组里的Box位置:(0, 25)大小:(300, 50)&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(GUI.Button(<span class="keyword">new</span> Rect(<span class="number">0</span>, <span class="number">100</span>, <span class="number">300</span>, <span class="number">50</span>), <span class="string">&quot;GUI组里的按钮位置:(0, 100)大小:(300, 50)&quot;</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.Log(<span class="string">$&quot;点击的GUI组里的按钮&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        GUI.EndGroup();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/img/Unity/EditorUIStudy/FixLayoutGUI.PNG" alt="FixLayoutGUI"></p>
<p>Note:</p>
<ol>
<li><strong>GUI Group可以实现GUI按组控制显示的功能</strong></li>
</ol>
<p><strong>自动排版</strong>:</p>
<p>自动排版顾名思义不再需要向固定排版一样对于每一个组件都写死位置和大小信息，自动排版的组件(Type)会根据设置的相关信息进行自动适配。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             AutoLayoutDraw.cs</span></span><br><span class="line"><span class="comment"> * Author:                  TONYTANG</span></span><br><span class="line"><span class="comment"> * Create Date:             2022/03/06</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> AutoLayoutDraw.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 自动排版绘制</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">AutoLayoutDraw</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnGUI</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 自动排版</span></span><br><span class="line">        <span class="keyword">if</span>(GUILayout.Button(<span class="string">&quot;自动排版的第一个按钮&quot;</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.Log(<span class="string">$&quot;点击了自动排版的第一个按钮!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 带自动排版的自定义绘制区域1</span></span><br><span class="line">        GUILayout.BeginArea(<span class="keyword">new</span> Rect(Screen.width / <span class="number">2</span> - <span class="number">150</span>, Screen.height / <span class="number">2</span> - <span class="number">150</span>, <span class="number">300</span>, <span class="number">300</span>));</span><br><span class="line">        <span class="keyword">if</span>(GUILayout.Button(<span class="string">&quot;自动排版中心区域内的按钮1&quot;</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.Log(<span class="string">$&quot;点击了自动排版中心区域内的按钮1!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (GUILayout.Button(<span class="string">&quot;自动排版中心区域内的按钮2&quot;</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.Log(<span class="string">$&quot;点击了自动排版中心区域内的按钮2!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        GUILayout.EndArea();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 带自动排版的自定义绘制区域2</span></span><br><span class="line">        GUILayout.BeginArea(<span class="keyword">new</span> Rect(Screen.width - <span class="number">300</span>, Screen.height - <span class="number">100</span>, <span class="number">300</span>, <span class="number">100</span>));</span><br><span class="line">        <span class="comment">// 指定右下角区域采用纵向自动布局</span></span><br><span class="line">        GUILayout.BeginVertical();</span><br><span class="line">        <span class="comment">// 指定GUI按钮的宽度固定200</span></span><br><span class="line">        <span class="keyword">if</span> (GUILayout.Button(<span class="string">&quot;自动排版右下角区域内的按钮1&quot;</span>, GUILayout.Width(<span class="number">200f</span>)))</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.Log(<span class="string">$&quot;点击了自动排版右下角区域内的按钮1!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 指定GUI按钮的宽度自适应</span></span><br><span class="line">        <span class="keyword">if</span> (GUILayout.Button(<span class="string">&quot;自动排版右下角区域内的按钮2&quot;</span>, GUILayout.ExpandWidth(<span class="literal">true</span>)))</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.Log(<span class="string">$&quot;点击了自动排版右下角区域内的按钮2!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        GUILayout.EndVertical();</span><br><span class="line">        GUILayout.EndArea();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/img/Unity/EditorUIStudy/AutoLayoutGUI.PNG" alt="AutoLayoutGUI"></p>
<p>Note:</p>
<ol>
<li><p><strong>自动布局可以帮我们方便快速的完成UI布局适配而不需要写死所有组件的大小和位置</strong></p>
</li>
<li><p><strong>GUILayout主要用于GUI的自动排版，而EditorGUILayout主要用于Edtior的GUI自动排版</strong></p>
</li>
<li><p><strong>GUI.BeginChange()和GUI.EndChange()的配套使用可以检测指定GUI的值是否变化，做到检测变化响应后做指定的事情</strong></p>
</li>
</ol>
<h3 id="GUISkin和GUIStyle"><a href="#GUISkin和GUIStyle" class="headerlink" title="GUISkin和GUIStyle"></a>GUISkin和GUIStyle</h3><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/gui-Customization.html">GUISkins are a collection of GUIStyles. Styles define the appearance of a GUI Control. You do not have to use a Skin if you want to use a Style.</a></p>
<p>从介绍可以看出GUISkins是GUIStyls的合集，GUIStyles定义了我们GUI的样式。</p>
<p>但如何得知Unity支持哪些GUIStyle了？</p>
<p>GUIStyle查看器工具(网上搜索到别人写的):</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> UnityEditor;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">EditorStyleViewer</span> : <span class="title">EditorWindow</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> Vector2 scrollPosition = Vector2.zero;</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">string</span> search = <span class="built_in">string</span>.Empty;</span><br><span class="line">    [<span class="meta">MenuItem(<span class="string">&quot;Tools/GUI样式查看器&quot;</span>)</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Init</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        EditorWindow.GetWindow(<span class="keyword">typeof</span>(EditorStyleViewer));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">OnGUI</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        GUILayout.BeginHorizontal(<span class="string">&quot;HelpBox&quot;</span>);</span><br><span class="line">        GUILayout.Label(<span class="string">&quot;单击示例将复制其名到剪贴板&quot;</span>, <span class="string">&quot;label&quot;</span>);</span><br><span class="line">        GUILayout.FlexibleSpace();</span><br><span class="line">        GUILayout.Label(<span class="string">&quot;查找:&quot;</span>);</span><br><span class="line">        search = EditorGUILayout.TextField(search);</span><br><span class="line">        GUILayout.EndHorizontal();</span><br><span class="line">        scrollPosition = GUILayout.BeginScrollView(scrollPosition);</span><br><span class="line">        <span class="keyword">foreach</span> (GUIStyle style <span class="keyword">in</span> GUI.skin)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (style.name.ToLower().Contains(search.ToLower()))</span><br><span class="line">            &#123;</span><br><span class="line">                GUILayout.BeginHorizontal(<span class="string">&quot;PopupCurveSwatchBackground&quot;</span>);</span><br><span class="line">                GUILayout.Space(<span class="number">7</span>);</span><br><span class="line">                <span class="keyword">if</span> (GUILayout.Button(style.name, style))</span><br><span class="line">                &#123;</span><br><span class="line">                    EditorGUIUtility.systemCopyBuffer = <span class="string">&quot;\&quot;&quot;</span> + style.name + <span class="string">&quot;\&quot;&quot;</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                GUILayout.FlexibleSpace();</span><br><span class="line">                EditorGUILayout.SelectableLabel(<span class="string">&quot;\&quot;&quot;</span> + style.name + <span class="string">&quot;\&quot;&quot;</span>);</span><br><span class="line">                GUILayout.EndHorizontal();</span><br><span class="line">                GUILayout.Space(<span class="number">11</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        GUILayout.EndScrollView();</span><br><span class="line">    &#125;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<p><img src="/img/Unity/EditorUIStudy/GUIStyleViewer.PNG" alt="GUIStyleViewer"></p>
<p>Note:</p>
<ol>
<li><strong>我们可以右键创建一个GUISkin资源后加载指定GUISkin来控制我们的GUI显示风格</strong></li>
</ol>
<h3 id="UIEvent"><a href="#UIEvent" class="headerlink" title="UIEvent"></a>UIEvent</h3><p>这里说的UIEvent主要是指玩家操作触发的一些事件信息，只有有了这些事件信息的我们才能编写对应的交互反馈。</p>
<p>Unity的事件信息统一由<strong>Event</strong>这个类封装，我们通过访问Event可以实现自定义的按钮响应和交互。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             EventDraw.cs</span></span><br><span class="line"><span class="comment"> * Author:                  TONYTANG</span></span><br><span class="line"><span class="comment"> * Create Date:             2022/03/06</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> EventDraw.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 事件响应绘制</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">EventDraw</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 事件信息</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">string</span> mEventInfo;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 键盘按下事件</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">string</span> mKeyDownEvent;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 鼠标点击事件</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">string</span> mMouseDownEvent;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnGUI</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mEventInfo = <span class="built_in">string</span>.Empty;</span><br><span class="line">        mEventInfo = <span class="string">$&quot;当前事件类型:<span class="subst">&#123;Event.current.type&#125;</span>&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span>(Event.current.type == EventType.KeyDown &amp;&amp; Event.current.keyCode != KeyCode.None)</span><br><span class="line">        &#123;</span><br><span class="line">            mKeyDownEvent = <span class="string">$&quot;按下过按键码:<span class="subst">&#123;Event.current.keyCode&#125;</span>&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (Event.current.type == EventType.MouseDown)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(Event.current.button == <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                mMouseDownEvent = <span class="string">$&quot;按下过鼠标:左键&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (Event.current.button == <span class="number">1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                mMouseDownEvent = <span class="string">$&quot;按下过鼠标:右键&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        GUILayout.BeginArea(<span class="keyword">new</span> Rect(Screen.width / <span class="number">2</span> - <span class="number">200</span>, Screen.height / <span class="number">2</span> - <span class="number">200</span>, <span class="number">400</span>, <span class="number">400</span>));</span><br><span class="line">        GUILayout.Label(<span class="string">$&quot;<span class="subst">&#123;mEventInfo&#125;</span>&quot;</span>, GUILayout.Width(<span class="number">400</span>), GUILayout.Height(<span class="number">20</span>));</span><br><span class="line">        GUILayout.Label(<span class="string">$&quot;<span class="subst">&#123;mKeyDownEvent&#125;</span>&quot;</span>, GUILayout.Width(<span class="number">400</span>), GUILayout.Height(<span class="number">20</span>));</span><br><span class="line">        GUILayout.Label(<span class="string">$&quot;<span class="subst">&#123;mMouseDownEvent&#125;</span>&quot;</span>, GUILayout.Width(<span class="number">400</span>), GUILayout.Height(<span class="number">20</span>));</span><br><span class="line">        GUILayout.EndArea();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/img/Unity/EditorUIStudy/GUIEventGUI.PNG" alt="GUIEventGUI"></p>
<h3 id="IMGUI实战"><a href="#IMGUI实战" class="headerlink" title="IMGUI实战"></a>IMGUI实战</h3><p>了解了GUI相关的基础知识后，让我们来深入学习了解下GUI在Editor里的运用。</p>
<p>Editor个人接触到的按显示区域来分类的话，个人接触过以下几类：</p>
<ol>
<li>Scene场景辅助GUI绘制</li>
<li>Editor纯工具窗口绘制</li>
<li>Inspector面板绘制</li>
<li>其他Editor功能</li>
</ol>
<h4 id="Scene辅助GUI绘制"><a href="#Scene辅助GUI绘制" class="headerlink" title="Scene辅助GUI绘制"></a>Scene辅助GUI绘制</h4><p>Scene的GUI绘制主要分为两种：</p>
<ol>
<li>Gizmos</li>
<li>Handles</li>
</ol>
<p>Gizmos</p>
<p><strong>Gizmos主要用于绘制Scene场景里的可视化调试(比如绘制线，图标，cube等)，不支持交互。</strong></p>
<p>Note:</p>
<ol>
<li><strong>Gizmos的代码需要卸载OnDrawGizmos()或OnDrawGizmosSelected()方法内，区别是前者是Scene场景一直显示，后者是只有包含该脚本的指定对象被选中时显示。</strong></li>
</ol>
<p>Handles</p>
<p><strong>Handles主要用于绘制Scene场景里3D可交互UI(比如可拉伸坐标轴，按钮等)。</strong></p>
<p>Note:</p>
<ol>
<li><strong>Handles的绘制代码需要卸载OnSceneGUI()方法内</strong></li>
<li>Handles里依然支持GUI的2D GUI绘制，但需要把代码写在Hanldes.BeginGUI和Handles.EndGUI内。</li>
</ol>
<h5 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h5><ol>
<li>Gizmos+Handles绘制Scene场景里的坐标系</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             CoordinateSystemDraw.cs</span></span><br><span class="line"><span class="comment"> * Author:                  TONYTANG</span></span><br><span class="line"><span class="comment"> * Create Date:             2022/02/20</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> CoordinateSystemDraw.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 坐标系Gizmo绘制</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CoordinateSystemDraw</span> : <span class="title">MonoBehaviour</span> </span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 坐标系原点</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;坐标系原点&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> Vector3 CoordinateCenterPoint = Vector3.zero;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 坐标系长度</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;坐标系长度&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">float</span> CoordinateSystemLength = <span class="number">1.0f</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Z轴颜色</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;Z轴颜色&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> Color ForwardAxisColor = Color.blue;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> X轴颜色</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;X轴颜色&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> Color RightAxisColor = Color.red;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Y轴颜色</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;Y轴颜色&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> Color UpAxisColor = Color.green;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> XY平面颜色</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;XY平面颜色&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> Color ForwardPlaneColor = <span class="keyword">new</span> Color(<span class="number">0</span>, <span class="number">0</span>, <span class="number">255</span>, <span class="number">48</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> ZY平面颜色</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;ZY平面颜色&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> Color RightPlaneColor = <span class="keyword">new</span> Color(<span class="number">255</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">48</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> XZ平面颜色</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;XZ平面颜色&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> Color UpPlaneColor = <span class="keyword">new</span> Color(<span class="number">0</span>, <span class="number">255</span>, <span class="number">0</span>, <span class="number">48</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> XY轴平面大小</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> Vector3 ForwardPlaneSize = <span class="keyword">new</span> Vector3(<span class="number">1</span>, <span class="number">1</span>, <span class="number">0.001f</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> ZY轴平面大小</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> Vector3 RightPlaneSize = <span class="keyword">new</span> Vector3(<span class="number">0.001f</span>, <span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> XZ轴平面大小</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> Vector3 UpPlaneSize = <span class="keyword">new</span> Vector3(<span class="number">1</span>, <span class="number">0.001f</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 原始颜色</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> Color mOriginalColor;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">OnDrawGizmos</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        DrawForwardPlane();</span><br><span class="line">        DrawRightPlane();</span><br><span class="line">        DrawUpPlane();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 绘制XY平面</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">DrawForwardPlane</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mOriginalColor = GUI.color;</span><br><span class="line">        Gizmos.color = ForwardPlaneColor;</span><br><span class="line">        ForwardPlaneSize.x = CoordinateSystemLength;</span><br><span class="line">        ForwardPlaneSize.y = CoordinateSystemLength;</span><br><span class="line">        Gizmos.DrawCube(CoordinateCenterPoint, ForwardPlaneSize);</span><br><span class="line">        Gizmos.color = mOriginalColor;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 绘制ZY平面</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">DrawRightPlane</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mOriginalColor = GUI.color;</span><br><span class="line">        Gizmos.color = RightPlaneColor;</span><br><span class="line">        RightPlaneSize.y = CoordinateSystemLength;</span><br><span class="line">        RightPlaneSize.z = CoordinateSystemLength;</span><br><span class="line">        Gizmos.DrawCube(CoordinateCenterPoint, RightPlaneSize);</span><br><span class="line">        Gizmos.color = mOriginalColor;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 绘制XZ平面</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">DrawUpPlane</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mOriginalColor = GUI.color;</span><br><span class="line">        Gizmos.color = UpPlaneColor;</span><br><span class="line">        UpPlaneSize.x = CoordinateSystemLength;</span><br><span class="line">        UpPlaneSize.z = CoordinateSystemLength;</span><br><span class="line">        Gizmos.DrawCube(CoordinateCenterPoint, UpPlaneSize);</span><br><span class="line">        Gizmos.color = mOriginalColor;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             CoordinateSystemDrawEditor.cs</span></span><br><span class="line"><span class="comment"> * Author:                  TONYTANG</span></span><br><span class="line"><span class="comment"> * Create Date:             2022/02/20</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEditor;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> CoordinateSystemDrawEditor.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> CoordinateSystemDraw的Editor绘制</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">CustomEditor(typeof(CoordinateSystemDraw))</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CoordinateSystemDrawEditor</span> : <span class="title">Editor</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 坐标系原点属性</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    SerializedProperty mCoordinateCenterPointProperty;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 坐标系长度属性</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    SerializedProperty mCoordinateSystemLengthProperty;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Z轴颜色属性</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    SerializedProperty mForwardAxisColorProperty;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> X轴颜色属性</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    SerializedProperty mRightAxisColorProperty;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Y轴颜色</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    SerializedProperty mUpAxisColorProperty;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">OnEnable</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mCoordinateCenterPointProperty = serializedObject.FindProperty(<span class="string">&quot;CoordinateCenterPoint&quot;</span>);</span><br><span class="line">        mCoordinateSystemLengthProperty = serializedObject.FindProperty(<span class="string">&quot;CoordinateSystemLength&quot;</span>);</span><br><span class="line">        mForwardAxisColorProperty = serializedObject.FindProperty(<span class="string">&quot;ForwardAxisColor&quot;</span>);</span><br><span class="line">        mRightAxisColorProperty = serializedObject.FindProperty(<span class="string">&quot;RightAxisColor&quot;</span>);</span><br><span class="line">        mUpAxisColorProperty = serializedObject.FindProperty(<span class="string">&quot;UpAxisColor&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">OnSceneGUI</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(Event.current.type == EventType.Repaint)</span><br><span class="line">        &#123;</span><br><span class="line">            Handles.color = mForwardAxisColorProperty.colorValue;</span><br><span class="line">            Handles.ArrowHandleCap(<span class="number">1</span>, mCoordinateCenterPointProperty.vector3Value,</span><br><span class="line">                                    Quaternion.LookRotation(Vector3.forward),</span><br><span class="line">                                    mCoordinateSystemLengthProperty.floatValue, EventType.Repaint);</span><br><span class="line"></span><br><span class="line">            Handles.color = mRightAxisColorProperty.colorValue;</span><br><span class="line">            Handles.ArrowHandleCap(<span class="number">1</span>, mCoordinateCenterPointProperty.vector3Value,</span><br><span class="line">                                    Quaternion.LookRotation(Vector3.right),</span><br><span class="line">                                    mCoordinateSystemLengthProperty.floatValue, EventType.Repaint);</span><br><span class="line"></span><br><span class="line">            Handles.color = mUpAxisColorProperty.colorValue;</span><br><span class="line">            Handles.ArrowHandleCap(<span class="number">1</span>, mCoordinateCenterPointProperty.vector3Value,</span><br><span class="line">                                    Quaternion.LookRotation(Vector3.up),</span><br><span class="line">                                    mCoordinateSystemLengthProperty.floatValue, EventType.Repaint);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>效果展示:</p>
<p><img src="/img/Unity/EditorUIStudy/CustomCoordinatesGUI.PNG" alt="CustomCoordinatesGUI"></p>
<ol start="2">
<li>Gizmos绘制物体的标签和2D可交互按钮显示</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             TagAndButtonDraw.cs</span></span><br><span class="line"><span class="comment"> * Author:                  TONYTANG</span></span><br><span class="line"><span class="comment"> * Create Date:             2022/02/21</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> TagAndButtonDraw.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 物体标签和交互按钮显示</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TagAndButtonDraw</span> : <span class="title">MonoBehaviour</span> </span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 物体名</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;物体名&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Name = <span class="string">&quot;GUI测试物体&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 物体标签名</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;物体标签名&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> TagName = <span class="string">&quot;sv_icon_name3&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">OnDrawGizmos</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        DrawTag();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 绘制物体标签</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">DrawTag</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        Gizmos.DrawIcon(transform.position, TagName, <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             TagAndButtonDrawEditor.cs</span></span><br><span class="line"><span class="comment"> * Author:                  TONYTANG</span></span><br><span class="line"><span class="comment"> * Create Date:             2022/02/21</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEditor;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> TagAndButtonDrawEditor.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 物体也签和交互按钮显示的Editor绘制</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">CustomEditor(typeof(TagAndButtonDraw))</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TagAndButtonDrawEditor</span> : <span class="title">Editor</span> </span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 物体名属性</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    SerializedProperty mNameProperty;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">OnEnable</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mNameProperty = serializedObject.FindProperty(<span class="string">&quot;Name&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">OnSceneGUI</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> tagAndButtonDraw = (TagAndButtonDraw)target;</span><br><span class="line">        <span class="keyword">if</span>(tagAndButtonDraw == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        Handles.Label(tagAndButtonDraw.transform.position, mNameProperty.stringValue);</span><br><span class="line">        <span class="comment">// Handles里绘制2D GUI需要在Handles.BeginGUI()和Handles.EndGUI()内</span></span><br><span class="line">        Handles.BeginGUI();</span><br><span class="line">        <span class="keyword">if</span>(GUILayout.Button(<span class="string">&quot;测试按钮&quot;</span>, GUILayout.Width(<span class="number">200f</span>), GUILayout.Height(<span class="number">40f</span>)))</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.Log(<span class="string">$&quot;物体按钮被点击!&quot;</span>);</span><br><span class="line">            Selection.activeGameObject = tagAndButtonDraw.gameObject;</span><br><span class="line">        &#125;</span><br><span class="line">        Handles.EndGUI();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>效果展示:</p>
<p><img src="/img/Unity/EditorUIStudy/GizmoGUI.PNG" alt="GizmoGUI"></p>
<p>关于GUI的Icon详细列表可以查询这里:</p>
<p><a target="_blank" rel="noopener" href="https://unitylist.com/p/5c3/Unity-editor-icons">Unity Editor Built-in Icons</a></p>
<h4 id="Editor窗口绘制"><a href="#Editor窗口绘制" class="headerlink" title="Editor窗口绘制"></a>Editor窗口绘制</h4><p>Editor的窗口绘制需要继承至<strong>EditorWindow</strong>类，然后在**OnGUI()**方法内利用GUI相关接口编写UI排版代码。</p>
<p>这一类代码工具代码写的比较多就不详细介绍了，主要是使用<strong>GUILayout</strong>和<strong>EditorGUILayout</strong>以及<strong>GUI</strong>相关的接口编写，使用<strong>MenuItem</strong>定义窗口UI入口，<strong>GenericMenu</strong>编写自定义菜单，<strong>Handles</strong>编写一些可视化线等。然后结合Event模块编写一些自定义的操作控制。</p>
<h5 id="实战-1"><a href="#实战-1" class="headerlink" title="实战"></a>实战</h5><p>典型例子1-资源打包工具窗口的编写:</p>
<p>效果展示:</p>
<p><img src="/img/Unity/AssetBundle-Framework/AssetBundleCollectWindow.PNG" alt="AssetBundleCollectWindow"></p>
<p><img src="/img/Unity/AssetBundle-Framework/AssetBundleLoadManagerUIAfterDestroyWindow.png" alt="AssetBundleLoadManagerUIAfterDestroyWindow"></p>
<p>详情参见:</p>
<p><a target="_blank" rel="noopener" href="https://github.com/TonyTang1990/AssetBundleLoadManager">AssetBundleManager</a></p>
<p>典型例子2-行为树编辑器编写:</p>
<p><img src="/img/AI/BehaviourTree/CustomVariableNodes.png" alt="自定义变量节点"><br><img src="/img/AI/BehaviourTree/CustomVariableInspector.png" alt="自定义变量参数面板"><br><img src="/img/AI/BehaviourTree/AllCustomVariableInspector.png" alt="所有自定义变量展示面板"></p>
<p><img src="/img/AI/BehaviourTree/GenericMenu.png" alt="节点编辑器操作响应"></p>
<p><img src="/img/AI/BehaviourTree/BTOperationPanel.png" alt="节点编辑器操作面板"></p>
<p><img src="/img/AI/BehaviourTree/GenericMenu.png" alt="行为树编辑器菜单"></p>
<p><img src="/img/AI/BehaviourTree/BTEditorNode.png" alt="行为树节点窗口"></p>
<p><img src="/img/AI/BehaviourTree/BTNodeConnectLine.png" alt="行为树节点连线"></p>
<p><img src="/img/AI/BehaviourTree/BTNodeEditor.png" alt="行为树节点编辑器效果展示"></p>
<p>详情参见:</p>
<p><a target="_blank" rel="noopener" href="https://github.com/TonyTang1990/BehaviourTreeForLua">BehaviourTreeForLua</a></p>
<p>Note:</p>
<ol>
<li><strong>主要注意GUI和GUILayout或EditorGUILayout在自动排版上有区分，前者通过自定义布局实现排版布局，后者通过自动排版实现排版布局。</strong></li>
</ol>
<h4 id="Inspector面板绘制"><a href="#Inspector面板绘制" class="headerlink" title="Inspector面板绘制"></a>Inspector面板绘制</h4><p>Inspector的面板绘制跟Unity序列化相关，常规的Inspector默认显示是通过继承<strong>Monobehaviour</strong>或<strong>ScriptableObject</strong>结合标记<strong>Serializable</strong>(标记类或结构体需要序列化),<strong>SerializedFied</strong>(标记成员需要序列化),<strong>NonSerialized</strong>(标记成员不需要序列化)和<strong>HideInInspector</strong>(标记成员不显示在面板上)来实现字段序列化和显示控制。</p>
<p>详细的序列化支持规则参考:</p>
<p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/script-Serialization.html">Serialization rules</a></p>
<h5 id="实战-2"><a href="#实战-2" class="headerlink" title="实战"></a>实战</h5><p>基础版的序列化事例:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             CustomInspectorDraw.cs</span></span><br><span class="line"><span class="comment"> * Author:                  TONYTANG</span></span><br><span class="line"><span class="comment"> * Create Date:             2022/02/21</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> CustomInspectorDraw.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 自定义Inspector面板绘制</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CustomInspectorDraw</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 序列化类</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Serializable</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">SerilizableClass</span></span><br><span class="line">    &#123;</span><br><span class="line">        [<span class="meta">Header(<span class="string">&quot;类的整形数据&quot;</span>)</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">int</span> ClassIntValue;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 类隐藏不显示的字符串数据</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        [<span class="meta">HideInInspector</span>]</span><br><span class="line">        [<span class="meta">Header(<span class="string">&quot;类隐藏不显示的字符串数据&quot;</span>)</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> ClassHideInspectorStringValue;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 类不序列化的布尔数据</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        [<span class="meta">NonSerialized</span>]</span><br><span class="line">        [<span class="meta">Header(<span class="string">&quot;类不序列化的布尔数据&quot;</span>)</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">bool</span> ClassNonSerializedBoolValue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 字符串数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;字符串数据&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> StringValue;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 布尔数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;布尔数据&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">bool</span> BoolValue;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> GameObject对象数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;GameObject对象数据&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> GameObject GoValue;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 整形数组数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;整形数组数据&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span>[] IntArrayValue;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 序列化类成员</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;序列化类成员&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> SerilizableClass SerilizabledClass;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>效果展示:</p>
<p><img src="/img/Unity/EditorUIStudy/CustomInspectorGUI.PNG" alt="CustomInspectorGUI"></p>
<p>如果我们需要自定义Inspector的面板显示，我们需要<strong>继承Editor</strong>类然后重写<strong>OnInspectorGUI</strong>接口进行自定义UI的代码编写，主要使用GUI，EditorGUI相关接口。</p>
<p>自定义Inspector事例:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             CustomInspectorDraw.cs</span></span><br><span class="line"><span class="comment"> * Author:                  TONYTANG</span></span><br><span class="line"><span class="comment"> * Create Date:             2022/02/21</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> CustomInspectorDraw.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 自定义Inspector面板绘制</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CustomInspectorDraw</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 序列化类</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Serializable</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">SerilizableClass</span></span><br><span class="line">    &#123;</span><br><span class="line">        [<span class="meta">Header(<span class="string">&quot;类的整形数据&quot;</span>)</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">int</span> ClassIntValue;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 类隐藏不显示的字符串数据</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        [<span class="meta">HideInInspector</span>]</span><br><span class="line">        [<span class="meta">Header(<span class="string">&quot;类隐藏不显示的字符串数据&quot;</span>)</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> ClassHideInspectorStringValue;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 类不序列化的布尔数据</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        [<span class="meta">NonSerialized</span>]</span><br><span class="line">        [<span class="meta">Header(<span class="string">&quot;类不序列化的布尔数据&quot;</span>)</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">bool</span> ClassNonSerializedBoolValue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 字符串数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;字符串数据&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> StringValue;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 布尔数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;布尔数据&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">bool</span> BoolValue;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> GameObject对象数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;GameObject对象数据&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> GameObject GoValue;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 整形数组数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;整形数组数据&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span>[] IntArrayValue;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 序列化类成员</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;序列化类成员&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> SerilizableClass SerilizabledClass;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             CustomInspectorDrawEditor.cs</span></span><br><span class="line"><span class="comment"> * Author:                  TONYTANG</span></span><br><span class="line"><span class="comment"> * Create Date:             2022/02/21</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEditor;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> CustomInspectorDrawEditor.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> CustomInspectorDraw自定义Inspector</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">CustomEditor(typeof(CustomInspectorDraw))</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CustomInspectorDrawEditor</span> : <span class="title">Editor</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 字符串数据属性</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    SerializedProperty StringValueProperty;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 布尔数据属性</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    SerializedProperty BoolValueProperty;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> GameObject对象数据属性</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    SerializedProperty GoValueProperty;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 整形数组数据属性</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    SerializedProperty IntArrayValueProperty;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 序列化类成员属性</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    SerializedProperty SerilizabledClassProperty;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 序列化类成员属性</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    SerializedProperty ClassIntValueProperty;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 序列化类成员属性</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    SerializedProperty ClassHideInspectorStringValueProperty;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnEnable</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        StringValueProperty = serializedObject.FindProperty(<span class="string">&quot;StringValue&quot;</span>);</span><br><span class="line">        BoolValueProperty = serializedObject.FindProperty(<span class="string">&quot;BoolValue&quot;</span>);</span><br><span class="line">        GoValueProperty = serializedObject.FindProperty(<span class="string">&quot;GoValue&quot;</span>);</span><br><span class="line">        IntArrayValueProperty = serializedObject.FindProperty(<span class="string">&quot;IntArrayValue&quot;</span>);</span><br><span class="line">        SerilizabledClassProperty = serializedObject.FindProperty(<span class="string">&quot;SerilizabledClass&quot;</span>);</span><br><span class="line">        ClassIntValueProperty = SerilizabledClassProperty.FindPropertyRelative(<span class="string">&quot;ClassIntValue&quot;</span>);</span><br><span class="line">        ClassHideInspectorStringValueProperty = SerilizabledClassProperty.FindPropertyRelative(<span class="string">&quot;ClassHideInspectorStringValue&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnInspectorGUI</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 确保对SerializedObject和SerializedProperty的数据修改每帧同步</span></span><br><span class="line">        serializedObject.Update();</span><br><span class="line"></span><br><span class="line">        EditorGUILayout.BeginVertical();</span><br><span class="line">        <span class="keyword">if</span>(GUILayout.Button(<span class="string">&quot;重置所有值&quot;</span>, GUILayout.ExpandWidth(<span class="literal">true</span>), GUILayout.Height(<span class="number">20f</span>)))</span><br><span class="line">        &#123;</span><br><span class="line">            StringValueProperty.stringValue = <span class="built_in">string</span>.Empty;</span><br><span class="line">            BoolValueProperty.boolValue = <span class="literal">false</span>;</span><br><span class="line">            GoValueProperty.objectReferenceValue = <span class="literal">null</span>;</span><br><span class="line">            IntArrayValueProperty.arraySize = <span class="number">0</span>;</span><br><span class="line">            ClassIntValueProperty.intValue = <span class="number">0</span>;</span><br><span class="line">            ClassHideInspectorStringValueProperty.stringValue = <span class="built_in">string</span>.Empty;</span><br><span class="line">        &#125;</span><br><span class="line">        EditorGUILayout.PropertyField(StringValueProperty);</span><br><span class="line">        EditorGUILayout.PropertyField(BoolValueProperty);</span><br><span class="line">        EditorGUILayout.PropertyField(GoValueProperty);</span><br><span class="line">        EditorGUILayout.PropertyField(IntArrayValueProperty);</span><br><span class="line">        EditorGUILayout.PropertyField(SerilizabledClassProperty, <span class="literal">true</span>);</span><br><span class="line">        EditorGUILayout.EndVertical();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 确保对SerializedObject和SerializedProperty的数据修改写入生效</span></span><br><span class="line">        serializedObject.ApplyModifiedProperties();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>效果展示:</p>
<p><img src="/img/Unity/EditorUIStudy/CustomInspectorDraw.PNG" alt="CustomInspectorDraw"></p>
<p><strong>如果想实现通用的属性重置，可以参考SerializedObject(比如GetIteractor())和SerializedProperty(比如propertyType和propertyPath以及XXXValue等)相关接口实现遍历重置。</strong></p>
<p>通过重写Editor的OnInspectorGUI()方法确实实现了自定义Inspector显示，但每一个属性的显示都要通过编写自定义UI代码的方式去展示重用率低同时重复劳动多。</p>
<p>接下来这里要讲的是通过<strong>自定义属性标签实现面向标签的自定义Inspector绘制控制，从而实现高度的可重用属性标签</strong>。</p>
<p>自定义Inspector属性绘制标签由两部分组成:</p>
<ol>
<li><strong>自定义标签继承至PropertyAttribute(控制自定义属性标签的值)</strong></li>
<li><strong>自定义标签绘制继承至PropertyDrawer(控制自定义属性标签的显示绘制)</strong></li>
</ol>
<p>比如我们想实现一个类似Range标签和纹理Preview显示的标签功能:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             TRangeAttribute.cs</span></span><br><span class="line"><span class="comment"> * Author:                  TONYTANG</span></span><br><span class="line"><span class="comment"> * Create Date:             2022/02/21</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> TRangeAttribute.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 数值范围属性标签</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TRangeAttribute</span> : <span class="title">PropertyAttribute</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 最小值</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">readonly</span> <span class="built_in">float</span> MinValue;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 最大值</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">readonly</span> <span class="built_in">float</span> MaxValue;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TRangeAttribute</span>(<span class="params"><span class="built_in">float</span> minValue, <span class="built_in">float</span> maxValue</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        MinValue = minValue;</span><br><span class="line">        MaxValue = maxValue;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             TRangeDrawer.cs</span></span><br><span class="line"><span class="comment"> * Author:                  TONYTANG</span></span><br><span class="line"><span class="comment"> * Create Date:             2022/02/21</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEditor;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> IntRangeDrawer.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 数值范围绘制</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">CustomPropertyDrawer(typeof(TRangeAttribute))</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TRangeDrawer</span> : <span class="title">PropertyDrawer</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnGUI</span>(<span class="params">Rect position, SerializedProperty property, GUIContent label</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> tRangeAttribute = (TRangeAttribute)attribute;</span><br><span class="line">        <span class="keyword">if</span>(property.propertyType == SerializedPropertyType.Integer)</span><br><span class="line">        &#123;</span><br><span class="line">            EditorGUI.IntSlider(position, property, (<span class="built_in">int</span>)tRangeAttribute.MinValue, (<span class="built_in">int</span>)tRangeAttribute.MaxValue, label);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(property.propertyType == SerializedPropertyType.Float)</span><br><span class="line">        &#123;</span><br><span class="line">            EditorGUI.Slider(position, property, tRangeAttribute.MinValue, tRangeAttribute.MaxValue, label);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            EditorGUILayout.LabelField(label, <span class="string">&quot;请使用TRange到float或int上!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             TPreviewAttribute.cs</span></span><br><span class="line"><span class="comment"> * Author:                  TONYTANG</span></span><br><span class="line"><span class="comment"> * Create Date:             2022/02/21</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> TPreviewAttribute.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 可预览的标签</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TPreviewAttribute</span> : <span class="title">PropertyAttribute</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TPreviewAttribute</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             TPreviewDrawer.cs</span></span><br><span class="line"><span class="comment"> * Author:                  TONYTANG</span></span><br><span class="line"><span class="comment"> * Create Date:             2022/02/21</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEditor;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> TPreviewDrawer.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 预览绘制</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">CustomPropertyDrawer(typeof(TPreviewAttribute))</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TPreviewDrawer</span> : <span class="title">PropertyDrawer</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 调整整体高度</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;property&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;label&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="built_in">float</span> <span class="title">GetPropertyHeight</span>(<span class="params">SerializedProperty property, GUIContent label</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">base</span>.GetPropertyHeight(property, label) + <span class="number">64f</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnGUI</span>(<span class="params">Rect position, SerializedProperty property, GUIContent label</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        EditorGUI.BeginProperty(position, label, property);</span><br><span class="line">        EditorGUI.PropertyField(position, property, label);</span><br><span class="line"></span><br><span class="line">        Texture2D previewTexture = GetAssetPreview(property);</span><br><span class="line">        <span class="keyword">if</span> (previewTexture != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Rect previewRect = <span class="keyword">new</span> Rect()</span><br><span class="line">            &#123;</span><br><span class="line">                x = position.x + GetIndentLength(position),</span><br><span class="line">                y = position.y + EditorGUIUtility.singleLineHeight,</span><br><span class="line">                width = position.width,</span><br><span class="line">                height = <span class="number">64</span></span><br><span class="line">            &#125;;</span><br><span class="line">            GUI.Label(previewRect, previewTexture);</span><br><span class="line">        &#125;</span><br><span class="line">        EditorGUI.EndProperty();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 获取显示缩进间隔</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;sourceRect&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="built_in">float</span> <span class="title">GetIndentLength</span>(<span class="params">Rect sourceRect</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Rect indentRect = EditorGUI.IndentedRect(sourceRect);</span><br><span class="line">        <span class="built_in">float</span> indentLength = indentRect.x - sourceRect.x;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> indentLength;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 获取Asset预览显示纹理</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;property&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Texture2D <span class="title">GetAssetPreview</span>(<span class="params">SerializedProperty property</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (property.propertyType == SerializedPropertyType.ObjectReference)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (property.objectReferenceValue != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                Texture2D previewTexture = AssetPreview.GetAssetPreview(property.objectReferenceValue);</span><br><span class="line">                <span class="keyword">return</span> previewTexture;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             InspectorPropertyDraw.cs</span></span><br><span class="line"><span class="comment"> * Author:                  TONYTANG</span></span><br><span class="line"><span class="comment"> * Create Date:             2022/02/21</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> InspectorPropertyDraw.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 自定义属性标签绘制</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">InspectorPropertyDraw</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 整形数值</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">TRange(0, 100)</span>]</span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;整形数值&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> IntValue;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> float数值</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">TRange(0, 100)</span>]</span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;float数值&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">float</span> FloatValue;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 预览的预制件</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">TPreview</span>]</span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;预览的预制件&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> GameObject PreviewPrefab;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>效果展示:</p>
<p><img src="/img/Unity/EditorUIStudy/CustomInspectorPropertyDraw.PNG" alt="CustomInspectorPropertyDraw"></p>
<p>以上两个自定义属性显示标签主要参考:</p>
<p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/editor-PropertyDrawers.html">Property Drawers</a></p>
<p><a target="_blank" rel="noopener" href="https://indienova.com/indie-game-development/extending-unity-for-beginners/">Unity 拓展编辑器入门指南</a></p>
<p>通过上面的基础学习，我们对于自定义Inspector面板的绘制就有基础的了解了，详细深入的学习在实战中进一步学习了解，这里就不再一一赘述。</p>
<p>Note:</p>
<ol>
<li><strong>Unity默认不支持序列化Dictionary和多维数组等，需要自己通过ISerializationCallbackReceiver接口进行自定义序列化支持</strong></li>
<li><strong>Unity不支持序列化null以及多态的数据</strong></li>
<li><strong>尽量使用SerializedObject和SerializedProperty(泛型设计支持)进行Inspector编写，支持Undo系统，不会有嵌套预制件保存问题</strong></li>
<li><strong>SerializedObject.Update()的调用是为了确保数据修改同步，SerializedObject.ApplyModifiedProperties()是为了对于数据的修改写入生效。总结在OnInspectorGUI()方法最前面调用serializedObject.Update()在最后调用serializedObject.ApplyModifiesdProperties()确保对于SerializedObject和SerializedProperty的修改和读取正确。</strong></li>
</ol>
<h4 id="TreeView绘制"><a href="#TreeView绘制" class="headerlink" title="TreeView绘制"></a>TreeView绘制</h4><h5 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h5><p>TreeView是一个比较特殊的绘制UI，他可以以树状结构来显示我们的指定数据信息(这个个人平时用的不多作为学习了解)</p>
<p>首先让我们看下官网对TreeView的介绍:<br><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/TreeViewAPI.html">TreeView is an IMGUI control used to display hierarchical data that you can expand and collapse. Use TreeView to create highly customizable list views and multi-column tables for Editor windows, which you can use alongside other IMGUI controls and components.</a><br>可以看到TreeView主要用于实现可以自定义快捷操作的多行多列窗口显示的组件。</p>
<p>让我们先了解一下TreeView里几个重要的类，方法和相关概念:</p>
<ul>
<li><p><strong>TreeViewState</strong><br><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/TreeViewAPI.html">TreeViewState contains state information that is changed when interacting with TreeView fields in the Editor, such as selection state, expanded state, navigation state, and scroll state. TreeViewState is the only state that is serializable. The TreeView itself is not serializable - it is reconstructed from the data that it represents when it is constructed or reloaded. </a>(TreeViewState是用于序列化网格列表的一些操作信息，TreeView自身是不序列化的，但TreeViewState是支持序列化的，用于记录所有相关操作信息(e.g. 比如选择状态，展开状态，滚动状态等))</p>
</li>
<li><p><strong>TreeViewItem</strong><br><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/TreeViewAPI.html">TreeViewItem contains data about an individual TreeView item, and is used to build the representation of the tree structure in the Editor. Each TreeViewItem must be constructed with a unique integer ID (unique among all the items in the TreeView). The ID is used for finding items in the tree for the selection state, expanded state, and navigation. All TreeViewItems have a depth property, which indicates the visual indentation.</a>(TreeViewItem表示TreeView里的单个单元，包含了单个单元里的数据，每一个TreeViewItem必须要有一个唯一ID(用于查询每一个TreeViewItem的TreeViewState数据。每一个TreeViewItems必须要有depth属性来标识树状深度。))</p>
</li>
<li><p><strong>BuildRoot</strong><br><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/TreeViewAPI.html">BuildRoot is the single abstract method of the TreeView class that must be implemented to create a TreeView. Use this method to handle creating the root item of the tree. This is called every time Reload is called on the tree. </a>(BuildRoot是一个必须实现的用于构建TreeView根节点的抽象方法，每一次编辑器Reload都会触发调用构建最新的TreeView。)</p>
</li>
<li><p><strong>BuildRows</strong><br><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/TreeViewAPI.html">BuildRows is a virtual method where the default implementation handles building the rows list based on the full tree created in BuildRoot. If only the root was created in BuildRoot, this method should be overridden to handle the expanded rows. </a>(BuildRows是用于根据BuildRoot构建的TreeView进行自定义行显示的虚方法流程。可以支持我们自定义搜索以及只构建可见行展示等自定义行显示功能。适用于大数据自定义构建显示的情况。)</p>
</li>
<li><p><strong>RowGUI</strong></p>
<p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/ScriptReference/IMGUI.Controls.TreeView.RowGUI.html">Override this method to add custom GUI content for the rows in the TreeView.</a>(自定义每行单元格的显示接口)</p>
</li>
<li><p><strong>MultiColumnHeader</strong><br><a target="_blank" rel="noopener" href="https://docs.unity3d.com/ScriptReference/IMGUI.Controls.MultiColumnHeader.html">The MultiColumnHeader is a general purpose class that e.g can be used with the TreeView to create multi-column tree views and list views. It supports resizing of columns widths by dragging and provides useful callbacks for reacting to user input.</a>(MultiColumnHeader用于定义多列数据显示相关数据，用于支持多列的TreeView显示和拖拽列宽度以及响应玩家操作等。)</p>
</li>
<li><p><strong>MultiColumnHeaderState</strong></p>
<p>跟TreeViewState类似，是用于构建MultiColumnHeader的状态数据。</p>
</li>
</ul>
<p><strong>TreeView构建流程图</strong>:<br><img src="/img/Unity/EditorUIStudy/TreeViewFlowChart.png" alt="TreeViewFlowChart"></p>
<p>在了解官方更多抽象之前，让我们先了解几个TreeView里的基本但很重要的概念。</p>
<ul>
<li><p>TreeView表示我们想要构建树状网格结构显示的基类抽象。</p>
</li>
<li><p>TreeView里的单元格由TreeViewItem定义，TreeViewItem表里树状结构里的每一条单元数据。</p>
</li>
<li><p>TreeViewItem里的id必须唯一，用于查询TreeViewItem的状态数据(TreeViewState)，depth标识着单条数据在树状结构里的第几层(同时也标识这TreeViewItem之间的深度即父子关系)，displayName标识着TreeViewItem的显示名字。</p>
</li>
<li><p>TreeViewState记录着TreeViewItem的一些操作序列化数据(e.g. 比如选择状态，展开状态，滚动状态等)。</p>
</li>
<li><p>MultiColumnHeader是TreeView支持多列显示的抽象类。</p>
</li>
<li><p>MultiColumnHeaderState跟TreeViewState类似，是用于构建MultiColumnHeader的状态数据。</p>
</li>
</ul>
<p>从上面的基础介绍可以看出，简单的TreeView对于数据单元的构建是通过TreeViewItem封装而来，而TreeViewItem能封装的数据仅限于id和displayName，这样对于我们快速访问自定义数据并不友好，个人猜测这也是为什么官方为设计泛型TreeView的原因。</p>
<p>Note:</p>
<ol>
<li><strong>BuildRoot在编辑器每次Reload时会调用。BuildRows在每次BuildRoot调用后以及发生折叠展开操作时。</strong></li>
<li><strong>TreeView的初始化发生在每次调用TreeView的Reload方法时。</strong></li>
</ol>
<h5 id="深入学习"><a href="#深入学习" class="headerlink" title="深入学习"></a>深入学习</h5><p>接下来让我们看看官方事例是如何抽象泛型TreeView的。</p>
<p>让我们先来简单理解下各个抽象类的含义：</p>
<ul>
<li><p>TreeElement – 自定义TreeViewItem的数据定义基类抽象，负责抽象需要序列化的数据以及TreeViewItem所需的父子概念。</p>
</li>
<li><p>TreeModel – 泛型定义，用于封装所有的TreeElement数据，抽象出跟节点数据概念以及唯一ID获取以及数据添加删除等接口。</p>
</li>
<li><p>TreeElementUtility – TreeElement数据相关操作辅助方法(e.g. 从数据列表构建TreeElement树状结构或从根节点反向构建数据列表等)。</p>
</li>
<li><p>TreeViewItem<T> – 泛型定义，抽象不同数据类型的TreeElement封装访问。</p>
</li>
<li><p>TreeViewWithTreeModel<T> – 泛型定义，抽象不同数据类型的TreeModel的TreeView封装访问以及通用的数据添加以及搜索等功能。</p>
</li>
</ul>
<h5 id="实战实现"><a href="#实战实现" class="headerlink" title="实战实现"></a>实战实现</h5><p>以下代码根据官方TreeView多列事例(MultiColumnWindow)代码学习编写，但部分类名有所更改，请自行对上官方定义。</p>
<p>接下来看下实战我们怎么基于官方的泛型抽象，实现自定义一个消息统计树状结构展示以及增删改查的。</p>
<p>先看下本人的类定义:</p>
<ul>
<li>MessageAsset(继承至ScriptableObject) – 消息统计基础数据定义，用于填充一些基础的消息统计数据(e.g. 消息黑名单，消息介绍等)。</li>
<li>MessageTreeAsset(继承至ScriptableObject) – 消息TreeView的原始数据Asset结构定义。</li>
<li>MessageTreeAssetEditor(继承至Editor) – 自定义MessageTreeAsset的Inspector面板显示(支持增删以及查看基础数据等操作)。</li>
<li>MessageTreeViewElement(继承至TreeViewElement) – 消息TreeView的单条数据结构定义。</li>
<li>MessageWindow(继承至EditorWindow) – 消息辅助窗口的窗口实现。</li>
<li>MessageTreeView(继承至TreeViewWithModel) – 实现泛型的TreeView定义，将MessageTreeViewElement作为自定义数据结构。</li>
</ul>
<p>先直接放几张效果图:</p>
<p><img src="/img/Unity/EditorUIStudy/MessageStatisticUI.PNG" alt="MessageStatisticUI"></p>
<p><img src="/img/Unity/EditorUIStudy/MessagePreviewUI.PNG" alt="MessagePreviewUI"></p>
<p><img src="/img/Unity/EditorUIStudy/MessageSimulationUI.PNG" alt="MessageSimulationUI"></p>
<p><img src="/img/Unity/EditorUIStudy/MessageTreeAssetEditorUI.PNG" alt="MessageTreeAssetEditorUI"></p>
<p>TreeView的泛型实现和自定义Inspector是第二张和第四张效果图。</p>
<p>本人实现了自定义MessageTreeeViewElement数据结构的TreeView展示。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             MessageTreeViewElement.cs</span></span><br><span class="line"><span class="comment"> * Author:                  TONYTANG</span></span><br><span class="line"><span class="comment"> * Create Date:             2022/04/22</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> MessageTreeViewElement.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 消息树形数据结构</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">Serializable</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MessageTreeViewElement</span> : <span class="title">TreeViewElement</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 消息类型</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">enum</span> MessageType</span><br><span class="line">    &#123;</span><br><span class="line">        Request = <span class="number">0</span>,</span><br><span class="line">        Push,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 消息名</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;消息名&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> MsgName;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 消息类型</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;消息类型&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> MessageTreeViewElement.MessageType MsgType;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 消息内容</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;消息内容&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> MsgContent;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 消息注释</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;消息注释&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> MsgAnnotation;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 带参构造函数</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;id&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;depth&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;name&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MessageTreeViewElement</span>(<span class="params"><span class="built_in">int</span> id, <span class="built_in">int</span> depth, <span class="built_in">string</span> name</span>) : <span class="title">base</span>(<span class="params">id, depth, name</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        MsgName = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 带参构造函数</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;id&quot;&gt;</span>唯一id<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;depth&quot;&gt;</span>深度值<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;name&quot;&gt;</span>显示名字<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;msgType&quot;&gt;</span>消息类型<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;msgContent&quot;&gt;</span>消息内容<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;msgAnnotation&quot;&gt;</span>消息注释<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MessageTreeViewElement</span>(<span class="params"><span class="built_in">int</span> id, <span class="built_in">int</span> depth, <span class="built_in">string</span> name, MessageType msgType, <span class="built_in">string</span> msgContent, <span class="built_in">string</span> msgAnnotation</span>) : <span class="title">base</span>(<span class="params">id, depth, name</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        MsgName = name;</span><br><span class="line">        MsgType = msgType;</span><br><span class="line">        MsgContent = msgContent;</span><br><span class="line">        MsgAnnotation = msgAnnotation;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过使MessageTreeView继承TreeViewWithTreeModel<MessageTreeViewElement>实现泛型的TreeView自定义构建和行列展示以及搜索排序等功能。</p>
<p>接下来我将细节展示我是如何实现TreeView的自定义数据构建和行列展示以及搜索排序等功能的。</p>
<p>为了支持多列显示，我们必须传递MultiColumnHeader来构建MessageTreeView:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 带参构造函数</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;state&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;multicolumnHeader&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;model&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">MessageTreeView</span>(<span class="params">TreeViewState state, MultiColumnHeader multicolumnHeader, TreeModel&lt;MessageTreeViewElement&gt; model</span>) : <span class="title">base</span>(<span class="params">state, multicolumnHeader, model</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    columnIndexForTreeFoldouts = <span class="number">0</span>;</span><br><span class="line">    showAlternatingRowBackgrounds = <span class="literal">true</span>;</span><br><span class="line">    showBorder = <span class="literal">true</span>;</span><br><span class="line">    <span class="comment">// 监听排序设置变化</span></span><br><span class="line">    multicolumnHeader.sortingChanged += OnSortingChanged;</span><br><span class="line"></span><br><span class="line">    Reload();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>多列的数据状态MultiColumnHeaderState通过自定义方法构建返回:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 创建默认的多列显示状态数据</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> MultiColumnHeaderState <span class="title">CreateDefaultMultiColumnHeaderState</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> columns = <span class="keyword">new</span>[]</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">new</span> MultiColumnHeaderState.Column</span><br><span class="line">        &#123;</span><br><span class="line">            headerContent = <span class="keyword">new</span> GUIContent(<span class="string">&quot;消息名&quot;</span>, <span class="string">&quot;消息名&quot;</span>),</span><br><span class="line">            contextMenuText = <span class="string">&quot;消息名&quot;</span>,</span><br><span class="line">            headerTextAlignment = TextAlignment.Center,</span><br><span class="line">            sortedAscending = <span class="literal">true</span>,</span><br><span class="line">            sortingArrowAlignment = TextAlignment.Right,</span><br><span class="line">            width = <span class="number">200</span>,</span><br><span class="line">            minWidth = <span class="number">200</span>,</span><br><span class="line">            maxWidth = <span class="number">250</span>,</span><br><span class="line">            autoResize = <span class="literal">false</span>,</span><br><span class="line">            allowToggleVisibility = <span class="literal">false</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="keyword">new</span> MultiColumnHeaderState.Column</span><br><span class="line">        &#123;</span><br><span class="line">            headerContent = <span class="keyword">new</span> GUIContent(EditorGUIUtility.FindTexture(<span class="string">&quot;FilterByLabel&quot;</span>), <span class="string">&quot;消息类型&quot;</span>),</span><br><span class="line">            contextMenuText = <span class="string">&quot;消息类型&quot;</span>,</span><br><span class="line">            headerTextAlignment = TextAlignment.Center,</span><br><span class="line">            sortedAscending = <span class="literal">true</span>,</span><br><span class="line">            sortingArrowAlignment = TextAlignment.Right,</span><br><span class="line">            width = <span class="number">40</span>,</span><br><span class="line">            minWidth = <span class="number">40</span>,</span><br><span class="line">            maxWidth = <span class="number">60</span>,</span><br><span class="line">            autoResize = <span class="literal">false</span>,</span><br><span class="line">            allowToggleVisibility = <span class="literal">false</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="keyword">new</span> MultiColumnHeaderState.Column</span><br><span class="line">        &#123;</span><br><span class="line">            headerContent = <span class="keyword">new</span> GUIContent(<span class="string">&quot;消息注释&quot;</span>, <span class="string">&quot;消息注释&quot;</span>),</span><br><span class="line">            contextMenuText = <span class="string">&quot;消息介绍&quot;</span>,</span><br><span class="line">            headerTextAlignment = TextAlignment.Center,</span><br><span class="line">            sortingArrowAlignment = TextAlignment.Right,</span><br><span class="line">            width = <span class="number">200</span>,</span><br><span class="line">            minWidth = <span class="number">200</span>,</span><br><span class="line">            maxWidth = <span class="number">250</span>,</span><br><span class="line">            autoResize = <span class="literal">false</span>,</span><br><span class="line">            allowToggleVisibility = <span class="literal">false</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="keyword">new</span> MultiColumnHeaderState.Column</span><br><span class="line">        &#123;</span><br><span class="line">            headerContent = <span class="keyword">new</span> GUIContent(<span class="string">&quot;消息内容&quot;</span>, <span class="string">&quot;消息内容&quot;</span>),</span><br><span class="line">            contextMenuText = <span class="string">&quot;消息内容&quot;</span>,</span><br><span class="line">            headerTextAlignment = TextAlignment.Center,</span><br><span class="line">            sortingArrowAlignment = TextAlignment.Right,</span><br><span class="line">            width = <span class="number">120</span>,</span><br><span class="line">            minWidth = <span class="number">120</span>,</span><br><span class="line">            maxWidth = <span class="number">150</span>,</span><br><span class="line">            autoResize = <span class="literal">false</span>,</span><br><span class="line">            allowToggleVisibility = <span class="literal">false</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="keyword">new</span> MultiColumnHeaderState.Column</span><br><span class="line">        &#123;</span><br><span class="line">            headerContent = <span class="keyword">new</span> GUIContent(<span class="string">&quot;删除&quot;</span>, <span class="string">&quot;删除&quot;</span>),</span><br><span class="line">            contextMenuText = <span class="string">&quot;删除&quot;</span>,</span><br><span class="line">            headerTextAlignment = TextAlignment.Center,</span><br><span class="line">            sortingArrowAlignment = TextAlignment.Right,</span><br><span class="line">            width = <span class="number">80</span>,</span><br><span class="line">            minWidth = <span class="number">80</span>,</span><br><span class="line">            maxWidth = <span class="number">80</span>,</span><br><span class="line">            autoResize = <span class="literal">false</span>,</span><br><span class="line">            allowToggleVisibility = <span class="literal">false</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">var</span> state = <span class="keyword">new</span> MultiColumnHeaderState(columns);</span><br><span class="line">    <span class="keyword">return</span> state;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>MessageTreeView通过重写BuildRoot,BuildRows和RowGUI接口实现根节点构建以及只构建可见的行数据和显示:</p>
<p>TreeViewWithModel.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 构建TreeView根节点</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> TreeViewItem <span class="title">BuildRoot</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> TreeViewItemGeneric&lt;T&gt;(TreeModel.Root.ID, <span class="number">-1</span>, TreeModel.Root.Name, TreeModel.Root);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 构建TreeView单行数据节点</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;root&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> IList&lt;TreeViewItem&gt; <span class="title">BuildRows</span>(<span class="params">TreeViewItem root</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (TreeModel.Root == <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        Debug.LogError(<span class="string">&quot;TreeModel Root is null. Did you call SetData()?&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    RowList.Clear();</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">string</span>.IsNullOrEmpty(searchString))</span><br><span class="line">    &#123;</span><br><span class="line">        Search(TreeModel.Root, searchString, RowList);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (TreeModel.Root.HasChild())</span><br><span class="line">        &#123;</span><br><span class="line">            AddChildrenRecursive(TreeModel.Root, <span class="number">0</span>, RowList);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 自动构建节点深度信息</span></span><br><span class="line">    SetupParentsAndChildrenFromDepths(root, RowList);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> RowList;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 递归添加子节点</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;parent&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;depth&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;newRows&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">AddChildrenRecursive</span>(<span class="params">T parent, <span class="built_in">int</span> depth, IList&lt;TreeViewItem&gt; newRows</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">foreach</span> (T child <span class="keyword">in</span> parent.ChildList)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> item = <span class="keyword">new</span> TreeViewItemGeneric&lt;T&gt;(child.ID, depth, child.Name, child);</span><br><span class="line">        newRows.Add(item);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (child.HasChild())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (IsExpanded(child.ID))</span><br><span class="line">            &#123;</span><br><span class="line">                AddChildrenRecursive(child, depth + <span class="number">1</span>, newRows);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                item.children = CreateChildListForCollapsedParent();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>MessageTreeView.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 自定义构建行显示</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;root&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> IList&lt;TreeViewItem&gt; <span class="title">BuildRows</span>(<span class="params">TreeViewItem root</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> rows = <span class="keyword">base</span>.BuildRows(root);</span><br><span class="line">    SortIfNeeded(root, rows);</span><br><span class="line">    <span class="keyword">return</span> rows;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 自定义TreeView每行显示</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;args&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">RowGUI</span>(<span class="params">RowGUIArgs <span class="keyword">args</span></span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> item = (TreeViewItemGeneric&lt;MessageTreeViewElement&gt;)<span class="keyword">args</span>.item;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 只构建可见的TreeView Row</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">args</span>.GetNumVisibleColumns(); ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        CellGUI(<span class="keyword">args</span>.GetCellRect(i), item, (MessageTreeColumns)<span class="keyword">args</span>.GetColumn(i), <span class="keyword">ref</span> <span class="keyword">args</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 单行显示</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;cellRect&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;item&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;column&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;args&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">CellGUI</span>(<span class="params">Rect cellRect, TreeViewItemGeneric&lt;MessageTreeViewElement&gt; item, MessageTreeColumns column, <span class="keyword">ref</span> RowGUIArgs <span class="keyword">args</span></span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Center cell rect vertically (makes it easier to place controls, icons etc in the cells)</span></span><br><span class="line">    CenterRectUsingSingleLineHeight(<span class="keyword">ref</span> cellRect);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (column)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">case</span> MessageTreeColumns.MessageName:</span><br><span class="line">            <span class="comment">// 显示初始折叠和描述信息</span></span><br><span class="line">            <span class="keyword">base</span>.RowGUI(<span class="keyword">args</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> MessageTreeColumns.MessageType:</span><br><span class="line">            <span class="keyword">var</span> iconTexture = item.Data.MsgType == MessageTreeViewElement.MessageType.Push ? PushIconTexture : PullIconTexture;</span><br><span class="line">            GUI.DrawTexture(cellRect, iconTexture, ScaleMode.ScaleToFit);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> MessageTreeColumns.MessageAnnotation:</span><br><span class="line">            item.Data.MsgAnnotation = EditorGUI.TextField(cellRect, item.Data.MsgAnnotation);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> MessageTreeColumns.MessageContent:</span><br><span class="line">            <span class="keyword">if</span> (GUI.Button(cellRect, <span class="string">&quot;编辑消息内容&quot;</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> messageWindow = MessageWindow.OpenMessageWindow();</span><br><span class="line">                messageWindow.SetSelectedMessageSimulation(item.Data);</span><br><span class="line">                messageWindow.SelectMessageTag(MessageWindow.MessageTag.MessageSimulation);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> MessageTreeColumns.MessageDelete:</span><br><span class="line">            <span class="keyword">if</span> (GUI.Button(cellRect, <span class="string">&quot;-&quot;</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                TreeModel.RemoveElementByID(item.Data.ID);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面构建自定义行数据和展示用到了几个比较重要的接口:</p>
<p>IsExpanded() – 判定指定数据ID节点是否展开</p>
<p>CreateChildListForCollapsedParent() – 为没展开的数据节点创建一个假的子节点，避免构建所有子数据节点</p>
<p>SetupParentsAndChildrenFromDepths() – 通过根节点和自定义构建的行数据节点，自动进行深度以及父子关系关联。</p>
<p>为了支持列排序设置，通过在MessageTreeView构造函数里监听MultiColumnHeader.sortingChanged接口实现自定义排序:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 监听排序设置变化</span></span><br><span class="line">multicolumnHeader.sortingChanged += OnSortingChanged;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 排序回调</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;multiColumnHeader&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">OnSortingChanged</span>(<span class="params">MultiColumnHeader multiColumnHeader</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    SortIfNeeded(rootItem, GetRows());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 排序</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;root&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;rows&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">SortIfNeeded</span>(<span class="params">TreeViewItem root, IList&lt;TreeViewItem&gt; rows</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (rows.Count &lt;= <span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 没有设置排序的列</span></span><br><span class="line">    <span class="keyword">if</span> (multiColumnHeader.sortedColumnIndex == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    SortByMultipleColumns();</span><br><span class="line">    TreeToList(root, rows);</span><br><span class="line">    Repaint();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 根据多列设置排序</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">SortByMultipleColumns</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> sortedColumns = multiColumnHeader.state.sortedColumns;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (sortedColumns.Length == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 暂时只根据单个设置排序</span></span><br><span class="line">    SortByColumnIndex(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 根据指定列索引排序</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;index&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">SortByColumnIndex</span>(<span class="params"><span class="built_in">int</span> index</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> sortedColumns = multiColumnHeader.state.sortedColumns;</span><br><span class="line">    <span class="keyword">if</span> (sortedColumns.Length == <span class="number">0</span> || sortedColumns.Length &lt;= index)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!mSortOptionsMap.ContainsKey(sortedColumns[index]))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> childTreeViewItems = rootItem.children.Cast&lt;TreeViewItemGeneric&lt;MessageTreeViewElement&gt;&gt;();</span><br><span class="line">    SortOption sortOption = mSortOptionsMap[sortedColumns[index]];</span><br><span class="line">    <span class="built_in">bool</span> <span class="keyword">ascending</span> = multiColumnHeader.IsSortedAscending(sortedColumns[index]);</span><br><span class="line">    <span class="keyword">switch</span> (sortOption)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">case</span> SortOption.MsgName:</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">ascending</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                childTreeViewItems = childTreeViewItems.OrderBy(treeViewItemGeneric =&gt; treeViewItemGeneric.Data.MsgName);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                childTreeViewItems = childTreeViewItems.OrderByDescending(treeViewItemGeneric =&gt; treeViewItemGeneric.Data.MsgName);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> SortOption.MsgType:</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">ascending</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                childTreeViewItems = childTreeViewItems.OrderBy(treeViewItemGeneric =&gt; treeViewItemGeneric.Data.MsgType);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                childTreeViewItems = childTreeViewItems.OrderByDescending(treeViewItemGeneric =&gt; treeViewItemGeneric.Data.MsgType);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    rootItem.children = childTreeViewItems.Cast&lt;TreeViewItem&gt;().ToList();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 构建</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;root&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;result&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">TreeToList</span>(<span class="params">TreeViewItem root, IList&lt;TreeViewItem&gt; result</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (root == <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullReferenceException(<span class="string">&quot;不能传空根节点!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (result == <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullReferenceException(<span class="string">&quot;不能传空结果列表!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    result.Clear();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (root.children == <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Stack&lt;TreeViewItem&gt; stack = <span class="keyword">new</span> Stack&lt;TreeViewItem&gt;();</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> i = root.children.Count - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--)</span><br><span class="line">    &#123;</span><br><span class="line">        stack.Push(root.children[i]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (stack.Count &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        TreeViewItem current = stack.Pop();</span><br><span class="line">        result.Add(current);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (current.hasChildren &amp;&amp; current.children[<span class="number">0</span>] != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">int</span> i = current.children.Count - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--)</span><br><span class="line">            &#123;</span><br><span class="line">                stack.Push(current.children[i]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>为了支持树状消息自定义搜索展示，构建SearchField并绑定TreeView的SetFocusAndEnsureSelectedItem接口:</p>
<p>MessageWindow.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">mSearchField = <span class="keyword">new</span> SearchField();</span><br><span class="line"><span class="comment">// 将搜索栏的输入回调和TreeView关联方便搜索检测</span></span><br><span class="line">mSearchField.downOrUpArrowKeyPressed += mMessageTreeView.SetFocusAndEnsureSelectedItem;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 绘制搜索区域</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span><span class="doctag">&lt;param name=&quot;rect&quot;&gt;</span>绘制区域信息<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">DrawSearchBarArea</span>(<span class="params">Rect rect</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span>(mMessageTreeView != <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 显示关联TreeView的搜索栏</span></span><br><span class="line">        mMessageTreeView.searchString = mSearchField.OnGUI(rect, mMessageTreeView.searchString);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>TreeViewWithTreeModel.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 构建TreeView单行数据节点</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;root&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> IList&lt;TreeViewItem&gt; <span class="title">BuildRows</span>(<span class="params">TreeViewItem root</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">   ***</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 支持搜索功能</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">string</span>.IsNullOrEmpty(searchString))</span><br><span class="line">    &#123;</span><br><span class="line">        Search(TreeModel.Root, searchString, RowList);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ***</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>为了操作方便，我还监听了MessageTreeAsset的双击打开操作，快速打开窗口进行消息预览:</p>
<p>MessageWindow.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 监听Asset双击打开</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;instanceID&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;line&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">[<span class="meta">OnOpenAsset</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">bool</span> <span class="title">OnOpenAsset</span>(<span class="params"><span class="built_in">int</span> instanceID, <span class="built_in">int</span> line</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> treeAsset = EditorUtility.InstanceIDToObject(instanceID) <span class="keyword">as</span> MessageTreeAsset;</span><br><span class="line">    <span class="keyword">if</span> (treeAsset != <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> window = OpenMessageWindow();</span><br><span class="line">        window.SetTreeAsset(treeAsset);</span><br><span class="line">        window.SelectMessageTag(MessageTag.MessagePreview);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>TreeElementUtility.cs负责实现二楼TreeViewElement相关的几个比较重要的方法接口:</p>
<p>TreeElementUtility.cs</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">/// &lt;summary&gt;</span><br><span class="line">/// 将树形根节点转换到数据列表</span><br><span class="line">/// &lt;/summary&gt;</span><br><span class="line">/// &lt;typeparam name=&quot;T&quot;&gt;&lt;/typeparam&gt;</span><br><span class="line">/// &lt;param name=&quot;root&quot;&gt;&lt;/param&gt;</span><br><span class="line">/// &lt;param name=&quot;result&quot;&gt;&lt;/param&gt;</span><br><span class="line">public static void TreeToList&lt;T&gt;(T root, IList&lt;T&gt; result) where T : TreeViewElement</span><br><span class="line">&#123;</span><br><span class="line">	******</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/// &lt;summary&gt;</span><br><span class="line">/// 从数据列表里生成TreeView</span><br><span class="line">/// &lt;/summary&gt;</span><br><span class="line">/// &lt;typeparam name=&quot;T&quot;&gt;&lt;/typeparam&gt;</span><br><span class="line">/// &lt;param name=&quot;list&quot;&gt;&lt;/param&gt;</span><br><span class="line">/// &lt;returns&gt;返回根节点&lt;/returns&gt;</span><br><span class="line">public static T ListToTree&lt;T&gt;(IList&lt;T&gt; list) where T : TreeViewElement</span><br><span class="line">&#123;</span><br><span class="line">	******</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/// &lt;summary&gt;</span><br><span class="line">/// 检查数据列表信息</span><br><span class="line">/// &lt;/summary&gt;</span><br><span class="line">/// &lt;typeparam name=&quot;T&quot;&gt;&lt;/typeparam&gt;</span><br><span class="line">/// &lt;param name=&quot;list&quot;&gt;&lt;/param&gt;</span><br><span class="line">public static void ValidateDepthValues&lt;T&gt;(IList&lt;T&gt; list) where T : TreeViewElement</span><br><span class="line">&#123;</span><br><span class="line">	******</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/// &lt;summary&gt;</span><br><span class="line">/// 查找TreeView列表的根数据</span><br><span class="line">/// &lt;/summary&gt;</span><br><span class="line">/// &lt;param name=&quot;treeViewElementList&quot;&gt;&lt;/param&gt;</span><br><span class="line">/// &lt;returns&gt;&lt;/returns&gt;</span><br><span class="line">public static T FindRootTreeViewElement&lt;T&gt;(IList&lt;T&gt; treeViewElementList) where T : TreeViewElement</span><br><span class="line">&#123;</span><br><span class="line">	******</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/// &lt;summary&gt;</span><br><span class="line">/// 更新节点深度信息</span><br><span class="line">/// &lt;/summary&gt;</span><br><span class="line">/// &lt;typeparam name=&quot;T&quot;&gt;&lt;/typeparam&gt;</span><br><span class="line">/// &lt;param name=&quot;root&quot;&gt;&lt;/param&gt;</span><br><span class="line">public static void UpdateDepthValues&lt;T&gt;(T root) where T : TreeViewElement</span><br><span class="line">&#123;</span><br><span class="line">	******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>完整代码链接:</p>
<p><a target="_blank" rel="noopener" href="https://github.com/TonyTang1990/EditorUIStudy">EditorUIStudy</a></p>
<p>上述Git还包含了其他Editor相关GUI学习的代码，TreeView的入口为Tools-&gt;消息辅助窗口。</p>
<h2 id="UI-Toolkit"><a href="#UI-Toolkit" class="headerlink" title="UI Toolkit"></a>UI Toolkit</h2><p>本章节内容比较多，单独提一篇来记录学习，详情参考：</p>
<p><a href="http://tonytang1990.github.io/2023/05/20/UIToolkit%E5%AD%A6%E4%B9%A0/">UIToolkit学习</a></p>
<h2 id="UGUI"><a href="#UGUI" class="headerlink" title="UGUI"></a>UGUI</h2><p>UGUI是UIToolkit之前出的一套用于运行时的UI框架，本篇章主要学习Editor相关的GUI，这里就不深入学习讲解了。</p>
<h2 id="学习总结"><a href="#学习总结" class="headerlink" title="学习总结"></a>学习总结</h2><ol>
<li><strong>Gizmos主要用于绘制Scene场景里的可视化调试(比如绘制线，图标，cube等)，不支持交互。</strong></li>
<li><strong>Handles主要用于绘制Scene场景里3D可交互UI(比如可拉伸坐标轴，按钮等)。</strong></li>
<li><strong>GUI的坐标系是左上角0,0</strong></li>
<li><strong>GUISkins是GUIStyls的合集，GUIStyles定义了我们GUI的样式</strong></li>
</ol>
<h1 id="Editor数据存储"><a href="#Editor数据存储" class="headerlink" title="Editor数据存储"></a>Editor数据存储</h1><p>这里说的Editor的数据存储主要是针对Unity概念，而非常规的序列化反序列化方案。</p>
<p>在了解数据存储之前，我们需要了解Unity里关于序列化的一些概念和规则。</p>
<h2 id="Unity序列化规则"><a href="#Unity序列化规则" class="headerlink" title="Unity序列化规则"></a>Unity序列化规则</h2><p>字段序列化规则：</p>
<ol>
<li><strong>public或者有SerializeField标签</strong></li>
<li><strong>非static</strong></li>
<li><strong>非const</strong></li>
<li><strong>非readonly</strong></li>
<li><strong>基础数据类型(e.g. int,float,double,bool string ……)</strong></li>
<li><strong>枚举</strong></li>
<li><strong>Fixed-size buffers(?不太清楚是指bit，byte还是啥)</strong></li>
<li><strong>Unity一些内置类型(e.g. Vector2,Vector3,Rect,Matrix4x4,Color,AnimationCurve)</strong></li>
<li><strong>标记有Serializable的自定义class</strong></li>
<li><strong>符合以上条件类型的列表或数组</strong></li>
</ol>
<p>详细规则见:</p>
<p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/script-Serialization.html">Script serialization</a></p>
<p>注意事项:</p>
<ol>
<li><strong>Unity不支持序列化多层数据结构类型(e.g. 多维数组，不定长数组，Dictionary，nested container types(?这个没太明白是指什么类型))</strong></li>
</ol>
<p>解决方案：</p>
<ol>
<li><strong>通过class封装，定义成常规支持的数据结构</strong></li>
<li><strong>通过自定义序列化接口ISerializationCallbackReceiver，编写自定义序列化代码</strong></li>
</ol>
<h3 id="序列化自定义Class"><a href="#序列化自定义Class" class="headerlink" title="序列化自定义Class"></a>序列化自定义Class</h3><p>序列化自定义Class必须满足一下两个条件:</p>
<ol>
<li><strong>有Serializable标签</strong></li>
<li><strong>非static Class</strong></li>
</ol>
<p>Unity序列化自定义Class有两种方式：</p>
<ol>
<li><strong>By Reference(按引用，C#里引用的概念，确保同一个对象序列化反序列化指向同一个对象)</strong></li>
<li><strong>By Value(按值，类似C#里值类型的概念，只序列化值不保持引用关系，即反序列化后引用会丢失只有值会还原)</strong></li>
</ol>
<p><strong>默认Unity序列化非继承UntiyEngine.Object的自定义Class方式是By Value，要想支持By Reference需要添加SerializeReference标签(在需要序列化的自定义Class成员上)</strong></p>
<p><strong>SerializeReference</strong>主要支持以下几种情况:</p>
<ol>
<li><strong>字段可以为null</strong></li>
<li><strong>序列化可以保持引用，反序列化后可以指向同一对象</strong></li>
<li><strong>实现定义父类类型但序列化反序列化子类数据的多态序列化反序列化</strong></li>
</ol>
<p>让我们实战理解一下以上概念:</p>
<p>BaseCustomClass.cs(自定义Class基类)</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> BaseCustomClass.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 自定义Class基类</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">Serializable</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BaseCustomClass</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 名字</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;名字&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Name;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BaseCustomClass</span>(<span class="params"><span class="built_in">string</span> name</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Name = name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ChildCustomClass.cs(自定义子类)</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> ChildCustomClass.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 自定义子类</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">Serializable</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ChildCustomClass</span> : <span class="title">BaseCustomClass</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 子名字</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;子名字&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> ChildName;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ChildCustomClass</span>(<span class="params"><span class="built_in">string</span> name, <span class="built_in">string</span> childName</span>) : <span class="title">base</span>(<span class="params">name</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        ChildName = childName;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>GrandchildCustomClass.cs(自定义孙子类)</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> GrandchildCustomClass.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 自定义孙子类</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">Serializable</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">GrandchildCustomClass</span> : <span class="title">ChildCustomClass</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 孙子名</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;孙子名&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> GrandchildName;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 孙子目标GameObject(测试UnityEngine.Object的自带序列化)</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;孙子目标GameObject&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> GameObject GrandchildTargetGo;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">GrandchildCustomClass</span>(<span class="params"><span class="built_in">string</span> name, <span class="built_in">string</span> childName, <span class="built_in">string</span> grandchildName, GameObject grandchildTargetGo</span>) : <span class="title">base</span>(<span class="params">name, childName</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        GrandchildName = grandchildName;</span><br><span class="line">        GrandchildTargetGo = grandchildTargetGo;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>SerializeReferenceMono.cs(序列化自定义类测试脚本)</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> SerializeReferenceMono.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 序列化自定义类测试脚本</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">SerializeReferenceMono</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 基类对象(测试多态)</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;基类对象&quot;</span>)</span>]</span><br><span class="line">    [<span class="meta">SerializeReference</span>]</span><br><span class="line">    <span class="keyword">public</span> BaseCustomClass BaseClass;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 子类对象1(测试自定义Class序列化By Reference)</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;子类对象1&quot;</span>)</span>]</span><br><span class="line">    [<span class="meta">SerializeReference</span>]</span><br><span class="line">    <span class="keyword">public</span> ChildCustomClass ChildClass1;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 子类对象2(测试自定义Class序列化By Reference)</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;子类对象2&quot;</span>)</span>]</span><br><span class="line">    [<span class="meta">SerializeReference</span>]</span><br><span class="line">    <span class="keyword">public</span> ChildCustomClass ChildClass2;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 孙子类对象1(测试自定义Class序列化By Value)</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;孙子类对象1&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> GrandchildCustomClass GrandchildClass1;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 孙子类对象2(测试自定义Class序列化By Value)</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;孙子类对象2&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> GrandchildCustomClass GrandchildClass2;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">ContextMenu(<span class="string">&quot;初始化&quot;</span>)</span>]</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Init</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        Debug.Log(<span class="string">&quot;SerializeReferenceMono.Init()&quot;</span>);</span><br><span class="line">        BaseClass = <span class="keyword">new</span> GrandchildCustomClass(<span class="string">&quot;测试多态基名字&quot;</span>, <span class="string">&quot;测试多态子名字&quot;</span>, <span class="string">&quot;测试多态孙名字&quot;</span>, <span class="keyword">this</span>.gameObject);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> childClassInstance = <span class="keyword">new</span> ChildCustomClass(<span class="string">&quot;测试自定义Class序列化By Reference基名字&quot;</span>, <span class="string">&quot;测试自定义Class序列化By Reference子名字&quot;</span>);</span><br><span class="line">        ChildClass1 = childClassInstance;</span><br><span class="line">        ChildClass2 = childClassInstance;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> grandChildClassInstance = <span class="keyword">new</span> GrandchildCustomClass(<span class="string">&quot;测试自定义Class序列化By Value基名字&quot;</span>, <span class="string">&quot;测试自定义Class序列化By Value子名字&quot;</span>, <span class="string">&quot;测试自定义Class序列化By Value孙名字&quot;</span>, <span class="keyword">this</span>.gameObject);</span><br><span class="line">        GrandchildClass1 = grandChildClassInstance;</span><br><span class="line">        GrandchildClass2 = grandChildClassInstance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">ContextMenu(<span class="string">&quot;测试序列化&quot;</span>)</span>]</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">TestSerialization</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        Debug.Log(<span class="string">&quot;SerializeReferenceMono.TestSerialization()&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(ChildClass1 == ChildClass2)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.Log(<span class="string">$&quot;ChildClass1 == ChildClass2&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            Debug.Log(<span class="string">$&quot;ChildClass1 != ChildClass2&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (GrandchildClass1 == GrandchildClass2)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.Log(<span class="string">$&quot;GrandchildClass1 == GrandchildClass2&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            Debug.Log(<span class="string">$&quot;GrandchildClass1 != GrandchildClass2&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Awake</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        Debug.Log(<span class="string">$&quot;SerializeReferenceMono.Awake()&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Start</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        Debug.Log(<span class="string">$&quot;SerializeReferenceMono.Start()&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先通过创建一个挂载了SerializeReferenceMono组件的GameObject，通过扩展的Inspector操作面板初始化数据:</p>
<p><img src="/img/Unity/UnitySerialization/SerializeReferenceDataInitOperation.PNG" alt="SerializeReferenceDataInitOperation"></p>
<p>初始化后我们会看到我们初始化后的数据：</p>
<p><img src="/img/Unity/UnitySerialization/%5BSerializeReferenceMonoInspectorAfterInit.PNG" alt="SerializeReferenceMonoInspectorAfterInit"></p>
<p>从上面可以看到我们成功初始化了我们想要的数据，从<strong>BaseClass成员已经可以看到标记了SerializeReference后我们成功实现了多重继承后的数据序列化。</strong></p>
<p>接下来我们把初始化数据后的GameObject做成预制件，通过反向丢进场景实例化触发反序列化来测试自定义Class的SerializeReference相关的设计。</p>
<p><img src="/img/Unity/UnitySerialization/SerializeReferenceMonoGO.PNG" alt="SerializeReferenceMonoGO"></p>
<p>最后一步，实例化预制件后通过Inspector操作面板测试自定义Class的SerializeReference设计：</p>
<p><img src="/img/Unity/UnitySerialization/TestSerializeReferenceOperation.PNG" alt="TestSerializeReferenceOperation"></p>
<p><img src="/img/Unity/UnitySerialization/TestSerializeReferenceResult.PNG" alt="TestSerializeReferenceResult"></p>
<p>从上面的打印可以看出，<strong>即使经历了Prefab的实例化(即SerializeReferenceMono脚本的数据反序列化)，我们最初标记SerializeReference的ChildCustomClass序列化同一对象后反序列化依然是指向同一对象(By Reference)，而没有标记SerializeReference的GrandchildCustomClass反序列化后指向的是不同对象(By Value)，从而验证了Unity SerializeReference的By Reference序列化反序列化设计。</strong></p>
<p>Note:</p>
<ol>
<li><strong>Unity用By Value的方式序列化自定义Class更高效，但没法还原引用。</strong></li>
</ol>
<h2 id="Unity序列化方案"><a href="#Unity序列化方案" class="headerlink" title="Unity序列化方案"></a>Unity序列化方案</h2><h3 id="Monobehaviour"><a href="#Monobehaviour" class="headerlink" title="Monobehaviour"></a>Monobehaviour</h3><p>说到数据存储，Unity里最典型的就是Monobehaviour，这个比较常用，只要符合前面提到的成员序列化要求即可。主要要注意的是自定义序列化Class的成员，看是否需要<strong>By Reference序列化</strong></p>
<p>比较简单这里就不实战举例了。</p>
<h3 id="ScriptableObject"><a href="#ScriptableObject" class="headerlink" title="ScriptableObject"></a>ScriptableObject</h3><p><strong>ScriptableObject是Unity提供的一种可以序列化数据成本地Asset的一种方式</strong></p>
<p>使用ScriptableObejct的两大场景如下：</p>
<ol>
<li><strong>想在Editor下存储一些数据</strong></li>
<li><strong>想在运行时序列化一些数据到本地</strong></li>
</ol>
<p>比较简单这里就不实战举例了。</p>
<h2 id="Unity数据存储方案"><a href="#Unity数据存储方案" class="headerlink" title="Unity数据存储方案"></a>Unity数据存储方案</h2><h3 id="EditorPrefs"><a href="#EditorPrefs" class="headerlink" title="EditorPrefs"></a>EditorPrefs</h3><p><strong>Unity用于存储Editor本地数据的类(存储位置好像是注册表里)。</strong></p>
<p>比较简单这里就不实战举例了。</p>
<p>Note:</p>
<ol>
<li><strong>运行时用PlayerPref</strong></li>
</ol>
<h3 id="JsonUtility"><a href="#JsonUtility" class="headerlink" title="JsonUtility"></a>JsonUtility</h3><p><strong>Unity提供的Json工具类，用于Json的序列化和反序列化。</strong></p>
<p>比较简单这里就不实战举例了。</p>
<h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><p>这里的其他是指其他常见的序列化方式:</p>
<ol>
<li>二进制(e.g. Protobuf, FlagBuffer …….)</li>
<li>XML</li>
</ol>
<h1 id="Editor常用标签"><a href="#Editor常用标签" class="headerlink" title="Editor常用标签"></a>Editor常用标签</h1><h2 id="编译相关"><a href="#编译相关" class="headerlink" title="编译相关"></a>编译相关</h2><ul>
<li><p>InitializeOnLoadAttribute</p>
<p>用于在Unity loads(个人理解是Unity打开或编译完成)后初始化一些Editor脚本</p>
</li>
<li><p>InitializeOnLoadMethodAttribute</p>
<p>用于在Unity loads(个人理解是Unity打开或编译完成)后初始化一些Editor脚本)，但在InitializeOnLoadAttribute之后执行</p>
</li>
</ul>
<p>具体使用在博主编写的Asset可配置化管线后处理工具以及路点编辑工具有使用:</p>
<p><a target="_blank" rel="noopener" href="https://github.com/TonyTang1990/AssetPipeline">AssetPipeline</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/TonyTang1990/PathPointTool">PathPointTool</a></p>
<p>Note:</p>
<ol>
<li><strong>InitializeOnLoadMethodAttribute在InitializeOnLoadAttribute之后执行</strong></li>
<li><strong>InitializeOnLoadAttribute在Asset导入完成前触发，不要在此流程里操作Asset相关东西，要处理Asset相关东西使用AssetPostprocessor.OnPostProcessAllAssets接口流程</strong></li>
</ol>
<h2 id="打包流程相关"><a href="#打包流程相关" class="headerlink" title="打包流程相关"></a>打包流程相关</h2><ul>
<li><p>PostProcessBuildAttrbute</p>
<p>打包后处理流程通知标签</p>
</li>
</ul>
<h2 id="Inspector相关"><a href="#Inspector相关" class="headerlink" title="Inspector相关"></a>Inspector相关</h2><ul>
<li><p>Header</p>
<p>字段显示标题文本标签</p>
</li>
<li><p>HideInInspector</p>
<p>不在Inpector显示标签</p>
</li>
<li><p>CustomPropertyDrawer</p>
<p>自定义标签绘制</p>
</li>
<li><p>Range</p>
<p>限定值范围标签</p>
</li>
</ul>
<p>具体使用在博主编写的Unity Editor先关学习里使用:</p>
<p><a href="http://tonytang1990.github.io/2022/02/20/UnityEditor%E7%9F%A5%E8%AF%86/">UnityEditor知识</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/TonyTang1990/EditorUIStudy">EditorUIStudy</a></p>
<h2 id="序列化相关"><a href="#序列化相关" class="headerlink" title="序列化相关"></a>序列化相关</h2><ul>
<li><p>Serializable</p>
<p>标记可以序列化</p>
</li>
<li><p>SerializeField</p>
<p>标记成员可以序列化</p>
</li>
<li><p>SerializeReference</p>
<p>标记序列化方式为By Reference(按引用，C#里引用的概念，确保同一个对象序列化反序列化指向同一个对象)而非By Value(按值，类似C#里值类型的概念，只序列化值不保持引用关系，即反序列化后引用会丢失只有值会还原)</p>
</li>
<li><p>NonSerialized</p>
<p>不参与序列化</p>
</li>
</ul>
<p>待添加……</p>
<h2 id="Editor相关"><a href="#Editor相关" class="headerlink" title="Editor相关"></a>Editor相关</h2><ul>
<li><p>ExecuteInEditMode</p>
<p>允许部分实例化脚本在不运行时执行一些声明周期方法(e.g. Awake,Update,OnGUI ……)</p>
</li>
<li><p>OnOpenAsset</p>
<p>响应Asset双击打开</p>
</li>
<li><p>ExecuteAlways</p>
<p>允许脚本在运行和非运行时总时运行(e.g. Update, OnGUI ……)</p>
</li>
</ul>
<h1 id="Editor操作扩展"><a href="#Editor操作扩展" class="headerlink" title="Editor操作扩展"></a>Editor操作扩展</h1><h2 id="窗口菜单"><a href="#窗口菜单" class="headerlink" title="窗口菜单"></a>窗口菜单</h2><p><strong>MenuItem用于扩展窗口菜单操作以及Asset右键操作等</strong></p>
<p>比较简单这里就不实战举例了。</p>
<p><strong>AddComponentMenu用于扩展添加组件菜单</strong></p>
<p>比较简单这里就不实战举例了。</p>
<h2 id="Inspector菜单"><a href="#Inspector菜单" class="headerlink" title="Inspector菜单"></a>Inspector菜单</h2><p><strong>ContextMenu用于扩展指定脚本的…菜单操作栏</strong></p>
<p>比较简单这里就不实战举例了。</p>
<h2 id="ScriptableObject菜单"><a href="#ScriptableObject菜单" class="headerlink" title="ScriptableObject菜单"></a>ScriptableObject菜单</h2><p><strong>CreateAssetMenu用于创建继承至ScriptableObject的Asset菜单操作</strong></p>
<p>比较简单这里就不实战举例了。</p>
<h1 id="Editor工具分类"><a href="#Editor工具分类" class="headerlink" title="Editor工具分类"></a>Editor工具分类</h1><p><strong>EditorUtility</strong>是Unity Editor里功能比较广泛的工具类，大部分接口跟Editor UI和Asset操作相关。</p>
<h2 id="GUI相关"><a href="#GUI相关" class="headerlink" title="GUI相关"></a>GUI相关</h2><ul>
<li><p>HandleUtility</p>
<p>3D场景GUI绘制相关辅助工具类</p>
</li>
<li></li>
</ul>
<p>待添加……</p>
<h2 id="Asset相关"><a href="#Asset相关" class="headerlink" title="Asset相关"></a>Asset相关</h2><h4 id="PrefabUtility"><a href="#PrefabUtility" class="headerlink" title="PrefabUtility"></a>PrefabUtility</h4><p><strong>Unity里针对预制件操作相关的工具类</strong></p>
<h2 id="序列化相关-1"><a href="#序列化相关-1" class="headerlink" title="序列化相关"></a>序列化相关</h2><h3 id="SerializationUtility"><a href="#SerializationUtility" class="headerlink" title="SerializationUtility"></a>SerializationUtility</h3><p><strong>Unity序列化相关的工具类</strong></p>
<h1 id="Github"><a href="#Github" class="headerlink" title="Github"></a>Github</h1><p>参考学习Github:</p>
<p><a target="_blank" rel="noopener" href="https://github.com/seyedmoeinsaadati/ThreeDDrawing"> ThreeDDrawing</a></p>
<p>个人Github:</p>
<p><a target="_blank" rel="noopener" href="https://github.com/TonyTang1990/AssetPipeline">AssetPipeline</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/TonyTang1990/PathPointTool">PathPointTool</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/TonyTang1990/EditorUIStudy">EditorUIStudy</a></p>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a target="_blank" rel="noopener" href="https://indienova.com/indie-game-development/extending-unity-for-beginners/">Unity 拓展编辑器入门指南</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/script-Serialization.html">Script serialization</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Editor/">Editor</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Editor/">Editor</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2021/05/05/FGUI学习/" title="FGUI学习" itemprop="url">FGUI学习</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Tony Tang" target="_blank" itemprop="author">Tony Tang</a>
		
  <p class="article-time">
    <time datetime="2021-05-05T11:08:24.000Z" itemprop="datePublished"> 发表于 2021-05-05</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>本章节博客是在项目需要使用FGUI的前提下，驱动深入学习FGUI的使用的。关于FGUI个人的认知还停留在第三方跨平台跨引擎制作UI的工具的层面上，接下来还是遵循老规矩从What,Why,How三个步骤来一步一步深入学习FGUI。</p>
<h2 id="FGUI"><a href="#FGUI" class="headerlink" title="FGUI"></a>FGUI</h2><p>什么是FGUI了？</p>
<p>FGUI全称是FairyGUI。官方的介绍是:<a target="_blank" rel="noopener" href="https://www.fairygui.com/">专业游戏 UI 解决方案从对设计师友好的编辑器 到支持 10+ 款引擎的 SDK 助力您生产力翻倍</a></p>
<p>为什么要选择FGUI了？</p>
<p>从官网的介绍可以看出，使用FGUI有以下几个好处:</p>
<ol>
<li>跨平台，多引擎支持(意味着一套UI多处使用)</li>
<li>内部支持的多国语言</li>
<li>高性能DralCall合并优化机制</li>
<li>丰富的UI库(跨平台的UI组件库–省去了从零造UI轮子的功夫)</li>
</ol>
<p>接下来就是学习如何使用FGUI了？</p>
<p>这里依然选择从官网教程入手:</p>
<p><a target="_blank" rel="noopener" href="https://www.fairygui.com/docs/editor">编辑器使用基础</a></p>
<h2 id="FGUI使用"><a href="#FGUI使用" class="headerlink" title="FGUI使用"></a>FGUI使用</h2><p>第一步：</p>
<p>下载<a target="_blank" rel="noopener" href="https://www.fairygui.com/download">FGUI编辑器</a></p>
<p>第二步:</p>
<p>创建第一个FGUI项目(创建新项目-&gt;输入新项目名称以及选择位置)</p>
<p><img src="/img/FGUI/FGUIProjectsCapture.PNG" alt="FGUIProjectsCapture"></p>
<p><img src="/img/FGUI/FGUIProjectsStructure.PNG" alt="FGUIProjectsStructure"></p>
<p><a target="_blank" rel="noopener" href="https://www.fairygui.com/docs/editor/index">编辑器的基础使用参考这里</a></p>
<p><a target="_blank" rel="noopener" href="https://www.fairygui.com/docs/editor/project_settings">项目设置参考这里</a></p>
<p>接下来学习下FGUI里总要的一些独有概念：</p>
<h3 id="包"><a href="#包" class="headerlink" title="包"></a>包</h3><h4 id="包的定义"><a href="#包的定义" class="headerlink" title="包的定义"></a>包的定义</h4><p><a target="_blank" rel="noopener" href="https://www.fairygui.com/docs/editor/package">FairyGUI是以包为单位组织资源的。包在文件系统中体现为一个目录。assets目录下每个子目录都表示一个包。**包内的每个资源都有一个是否导出的属性，一个包只能使用其他包设置为已导出的资源，而不设置为导出的资源是不可访问的。</a></p>
<h4 id="包的依赖"><a href="#包的依赖" class="headerlink" title="包的依赖"></a>包的依赖</h4><p><a target="_blank" rel="noopener" href="https://www.fairygui.com/docs/editor/package">FairyGUI是不处理包之间的依赖关系的，如果B包导出了一个元件B1，而A包的A1元件使用了元件B1，那么在创建A1之前，必须保证B包已经被载入，否则A1里的B1不能正确显示（但不会影响程序正常运行）。<strong>这个载入需要由开发者手动调用，FairyGUI不会自动载入。</strong></a></p>
<h4 id="资源URL地址"><a href="#资源URL地址" class="headerlink" title="资源URL地址"></a>资源URL地址</h4><p><a target="_blank" rel="noopener" href="https://www.fairygui.com/docs/editor/package">在FairyGUI中，每一个资源都有一个URL地址。选中一个资源，右键菜单，选择“复制URL”，就可以得到资源的URL地址。无论在编辑器中还是在代码里，都可以通过这个URL引用资源。</a></p>
<p>Note:</p>
<ol>
<li>URL有两种格式(一种是不可读的一个编码，另一种是ui:&#x2F;&#x2F;包名&#x2F;&#x2F;资源名)</li>
</ol>
<h3 id="发布"><a href="#发布" class="headerlink" title="发布"></a>发布</h3><p><img src="/img/FGUI/FGUIPublicInterface.PNG" alt="FGUIPublicInterface"></p>
<p>可以看到FGUI发布是针对前面设定的包的概念来发布的，可以发布一个包也可以发布所有包。发布里面还有很多设置，比如对纹理图片的导出设置等，具体后续用到详细研究详情参考:<a target="_blank" rel="noopener" href="https://www.fairygui.com/docs/editor/publish">发布</a></p>
<p>这里主要说下<strong>发布代码</strong>这个设置，看介绍是一个FGUI提供的组件绑定代码自动化生成机制。</p>
<p>FGUI发布后会得到一个***_fui.bytes的二进制文件:</p>
<p><img src="/img/FGUI/FGUIPublishAssets.PNG" alt="FGUIPublishAssets"></p>
<p>Note:</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://www.fairygui.com/docs/editor/publish"><strong>当我们载入包时，需要使用这里设定的文件名，而当创建对象时，需要使用包名称</strong></a></li>
</ol>
<h3 id="元件"><a href="#元件" class="headerlink" title="元件"></a>元件</h3><p><a target="_blank" rel="noopener" href="https://www.fairygui.com/docs/editor/object">每个舞台中的组成元素我们称之为元件</a></p>
<p>元件的类型有很多，他们是:</p>
<ol>
<li>基础元件(图片，图形，动画，装载器，文本，富文本，组，组件)</li>
<li>组合型元件(标签，按钮，下拉框，滚动条，滑动条，进度条)</li>
<li>特殊元件(列表)</li>
</ol>
<p>Note:</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://www.fairygui.com/docs/editor/object"><strong>关联系统只对元件的宽高有效，不计入Scale的影响</strong></a></li>
<li><a target="_blank" rel="noopener" href="https://www.fairygui.com/docs/editor/object">设置元件的倾斜值。 对于Unity平台，你可以放心地对图片、动画、装载器使用倾斜，这几乎不会带来额外消耗，但对于其他类型的元件，例如组件，请谨慎使用</a></li>
<li><a target="_blank" rel="noopener" href="https://www.fairygui.com/docs/editor/object">BlendMode这个提供了一部分的混合选项设置。对于Unity平台，对图片、动画、文字，你可以放心地修改它们的BlendMode。但对于组件，请谨慎使用。滤镜设置同理。</a></li>
</ol>
<h4 id="GObject"><a href="#GObject" class="headerlink" title="GObject"></a>GObject</h4><p>FGUI里大部分元件类的基类。个人理解是元件的根Object抽象。</p>
<p>关键元件的位置，缩放，旋转，可见，大小等设置接口都在这个类里。</p>
<h4 id="GComponent"><a href="#GComponent" class="headerlink" title="GComponent"></a>GComponent</h4><p>与Unity里的Component组件不同。个人理解更像是一种包含关系的Component而非GameObject那种绑定Component概念。</p>
<h4 id="图片"><a href="#图片" class="headerlink" title="图片"></a>图片</h4><p>可以理解成Unity里导入图片资源，然后可以对图片资源的大小，是否切九宫，纹理集导出设置等进行设置。</p>
<p>设置图片资源为导出后，发布包会看到生成了两份数据:</p>
<p><img src="/img/FGUI/PictureResourceExport.PNG" alt="PictureResourceExport"></p>
<p>一份为图片资源导出后的图集资源</p>
<p>一份为包的二进制资源</p>
<p>GImage是图片对应FGUI里的类型，类似Unity的Image，相关设置接口都在GImage类里。</p>
<p>Note:</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://www.fairygui.com/docs/editor/image">FairyGUI支持的图片格式有：PNG，JPG，TGA，SVG。</a></li>
<li>默认导入的图片是没有标记小红点的也就是默认不导出的，这里需要选中后右键设置为导出，最后导出包的时候才会导出资源。(<strong>只有导出后的资源才允许被其他包使用</strong>)</li>
</ol>
<h3 id="动画"><a href="#动画" class="headerlink" title="动画"></a>动画</h3><p>FGUI支持三种方式创建动画，详情参考：<a target="_blank" rel="noopener" href="https://www.fairygui.com/docs/editor/movieclip">动画</a></p>
<p>这里主要学习直接在FGUI里创建动画的方式：</p>
<ol>
<li>资源-&gt; 新建动画</li>
<li>导入序列帧图片资源</li>
<li>设置动画属性参数</li>
</ol>
<p>动画文件对应FGUI里的GMoviewClip类，相关API参考GMoviewClip源码</p>
<h3 id="骨骼动画"><a href="#骨骼动画" class="headerlink" title="骨骼动画"></a>骨骼动画</h3><p>暂时略过</p>
<h3 id="图形"><a href="#图形" class="headerlink" title="图形"></a>图形</h3><p><a target="_blank" rel="noopener" href="https://www.fairygui.com/docs/editor/graph">FairyGUI支持生成简单的图形。</a></p>
<p><strong>多边形图形编辑支持直接操作顶点。</strong></p>
<p><strong>图形的主要用途是用于占位，支持设置绑定原生对象(e.g. Image)</strong></p>
<p>图形对应FGUI里的GGraph类，相关API参考GGraph源码</p>
<p>Note:</p>
<ol>
<li><strong>图形支持动态创建，动态创建图形需要注意一定要设置图形的大小，否则显示不出来。</strong></li>
</ol>
<h3 id="装载器"><a href="#装载器" class="headerlink" title="装载器"></a>装载器</h3><p><a target="_blank" rel="noopener" href="https://www.fairygui.com/docs/editor/loader">装载器的用途是动态载入资源。</a></p>
<p>装载器对应FGUI里的GLoader类，相关API参考GLoader源码。</p>
<p>GLoader可以载入图片、动画和组件。如果是UI包里的资源，那么通过“ui:&#x2F;&#x2F;包名&#x2F;图片名”这种格式的地址就可以载入。</p>
<p>FGUI支持了我们自定义装载器实现自定义加载，详情参考官网:<a target="_blank" rel="noopener" href="https://www.fairygui.com/docs/editor/loader">装载器</a></p>
<p>Note:</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://www.fairygui.com/docs/editor/loader">默认的GLoader具有有限度的的加载外部资源的能力，详情参考参考官网说明</a></li>
<li>GLoader不管理外部对象的生命周期，不会主动销毁自定义加载的外部资源需要自行管理</li>
</ol>
<h3 id="3D内容装载器"><a href="#3D内容装载器" class="headerlink" title="3D内容装载器"></a>3D内容装载器</h3><p><a target="_blank" rel="noopener" href="https://www.fairygui.com/docs/editor/loader3d">3D内容装载器的用途是动态载入比较复杂的资源，例如<a target="_blank" rel="noopener" href="https://www.fairygui.com/docs/editor/skeleton">骨骼动画</a>、模型（暂未支持）、粒子特效（暂未支持）等。</a></p>
<p>暂时略过</p>
<h3 id="文本"><a href="#文本" class="headerlink" title="文本"></a>文本</h3><p><a target="_blank" rel="noopener" href="https://www.fairygui.com/docs/editor/text">文本是FairyGUI的基础控件之一。文本不支持交互，鼠标&#x2F;触摸感应是关闭的。</a></p>
<p>文本对应FGUI里的GTextField类，相关API参考GTextField源码。</p>
<p>使用<strong>文本模板</strong>可以更灵活的动态调整文本输出。解决文本占位输出问题。比如我的元宝:{jin&#x3D;100}金{yin&#x3D;200}银。勾选文本模板即可通过直接更新关键字数值即可。</p>
<p>事例:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aTextField.SetVar(<span class="string">&quot;jin&quot;</span>, <span class="string">&quot;500&quot;</span>).SetVar(<span class="string">&quot;yin&quot;</span>, <span class="string">&quot;500&quot;</span>).FlushVars();</span><br></pre></td></tr></table></figure>

<p>Note:</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://www.fairygui.com/docs/editor/text">设置文本支持UBB语法。使用UBB语法可以使单个文本包含多种样式，例如字体大小，颜色等。请参考<a target="_blank" rel="noopener" href="https://www.fairygui.com/docs/editor/text#ubb%E8%AF%AD%E6%B3%95">UBB语法</a>。</a></li>
<li>文本模板优先于UBB解析</li>
</ol>
<h3 id="富文本"><a href="#富文本" class="headerlink" title="富文本"></a>富文本</h3><p>富文本与普通文本的区别在于：</p>
<ol>
<li>普通文本不支持交互，鼠标&#x2F;触摸感应是关闭的；富文本支持。</li>
<li>普通文本不支持链接和图文混排；富文本支持。</li>
<li>普通文本不支持HTML语法（但可以使用UBB实现不同样式）；富文本支持。</li>
</ol>
<p>富文本对应FGUI里的GRichTextField类，相关API参考GRichTextField源码。</p>
<h3 id="输入文本"><a href="#输入文本" class="headerlink" title="输入文本"></a>输入文本</h3><p><a target="_blank" rel="noopener" href="https://www.fairygui.com/docs/editor/inputtext">输入文本元件用于接收用户输入文字。</a></p>
<p>输入文本对应FGUI里的GTextInput类，相关API参考GTextInput源码。</p>
<p>Note:</p>
<ol>
<li>设置文本支持UBB语法。</li>
</ol>
<h3 id="字体"><a href="#字体" class="headerlink" title="字体"></a>字体</h3><p>FairyGUI支持3种字体的使用方式:</p>
<ol>
<li>系统字体</li>
<li>TTF字体</li>
<li>位图字体</li>
</ol>
<p>Note:</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://www.fairygui.com/docs/editor/font">无论字体是否设置为导出，它都不会被发布。UI包发布后，引用此字体资源的文本元件的字体名称是该字体的资源名字。</a></li>
<li>FairyGUI内置支持使用TextMeshPro插件。</li>
</ol>
<h3 id="组"><a href="#组" class="headerlink" title="组"></a>组</h3><p><a target="_blank" rel="noopener" href="https://www.fairygui.com/docs/editor/group">在舞台上选定一个或多个元件，然后按Ctrl+G，就可以建立一个组。 FairyGUI的组有两种类型，<code>普通组</code>和<code>高级组</code>。</a></p>
<ul>
<li><p>普通组</p>
<p><a target="_blank" rel="noopener" href="https://www.fairygui.com/docs/editor/group">普通组仅在编辑时有效，是辅助你进行UI设计的。普通组发布后不存在，也就是在运行时无法访问到普通组。</a></p>
<p>普通组作用:</p>
<ol>
<li>可以整体一起移动；</li>
<li>可以整体一起调整深度；</li>
<li>可以整体复制和粘贴。</li>
<li>双击组，进入组内部后，可以随意调整各个元件的深度，不影响组外的东西。</li>
<li>当组大小改变时，组内的内容将同时增大或者缩小。</li>
</ol>
</li>
<li><p>高级组</p>
<p><a target="_blank" rel="noopener" href="https://www.fairygui.com/docs/editor/group">高级组除了具有普通组所有的功能外，它在发布后仍然保留，也就是在运行时可以通过代码访问高级组对象。所以它可以像一个普通元件那样设置关联和属性控制。</a></p>
<p>高级组作用:</p>
<ol>
<li>可以设置可见性。如果组不可见，则组内的所有元件均不可见。</li>
<li>设置属性控制。高级组支持的属性控制有：显示控制，位置控制，大小控制。</li>
<li>设置关联。</li>
<li>设置布局。</li>
</ol>
</li>
</ul>
<p>个人觉得FGUI里的组类似Unity里的父节点，同时高级组实现了一些类似Layout排版组件的布局效果以及其他特殊控制效果。</p>
<p>高级组对应FGUI里的GGroup类，相关API参考GGroup类源码。</p>
<h3 id="组件"><a href="#组件" class="headerlink" title="组件"></a>组件</h3><p><a target="_blank" rel="noopener" href="https://www.fairygui.com/docs/editor/component">组件是FairyGUI中的一个基础容器。组件可以包含一个或多个基础显示对象，也可以包含组件。</a></p>
<ul>
<li><p>自定义属性</p>
<p><a target="_blank" rel="noopener" href="https://www.fairygui.com/docs/editor/component">当组件被拖入到到其他组件后，能通过检查器设置的属性一般是固定的，例如一个按钮，我们可以改变它的标题、图标、是否选中等，这些都是编辑器提供的固定属性。但如果我在按钮中放置了额外的文本或者装载器，而且需要设定他们在实例化后的属性时，就需要用自定义属性，将组件的子元件甚至更深层次的元件的属性暴露出来。</a></p>
</li>
<li><p>自定义数据</p>
<p><a target="_blank" rel="noopener" href="https://www.fairygui.com/docs/editor/component">可以设置一个自定义的数据，这个数据FairyGUI不做解析，按原样发布到最后的描述文件中。开发者可以在运行时获取。</a></p>
</li>
</ul>
<p><strong>设计图功能</strong>是为了快速拼出效果图要的效果。</p>
<p><strong>点击穿透</strong>设置可以快速将点击事件向后传递。</p>
<p><strong>点击测试</strong>用于不规则区域的点击响应。</p>
<p><strong>遮罩</strong>FGUI里分两种：</p>
<ul>
<li><p>矩形遮罩</p>
</li>
<li><p>自定义遮罩</p>
</li>
</ul>
<p><strong>扩展</strong>功能，<a target="_blank" rel="noopener" href="https://www.fairygui.com/docs/editor/component">选择哪种“扩展”，组件就有了那种扩展的属性和行为特性。</a></p>
<p>组件对应FGUI里的GComponent类，相关API详情参考GComponent源码。</p>
<p><a target="_blank" rel="noopener" href="https://www.fairygui.com/docs/editor/component">动态创建的组件是空组件，可以作为其他组件的容器。一个常见的用途，如果你要建立一个多层的UI管理系统，那么空组件就是一个合适的层级容器选择。</a></p>
<p>Note:</p>
<ol>
<li>动态创建的组件默认是点击穿透的，也就是说如果直接new一个空组件作为接收点击用途，你还得有额外设置</li>
<li><a target="_blank" rel="noopener" href="https://www.fairygui.com/docs/editor/component">在FairyGUI中，显示列表是以树形组织的，下面说的渲染顺序均指在<strong>同一个父元件</strong>下安排的顺序，不同父元件的元件是不可能互相交错的，这是前提，请注意。</a></li>
<li><a target="_blank" rel="noopener" href="https://www.fairygui.com/docs/editor/component">GObject.sortingOrder。**这个属性只用于特定的用途，不作常规的使用。它一般用于类似固定置顶的功能，另外，永远不要将sortingOrder用在列表中。</a></li>
</ol>
<h3 id="滚动容器"><a href="#滚动容器" class="headerlink" title="滚动容器"></a>滚动容器</h3><p>滚动容器对应FGUI里的ScrollPane类，相关API详情参考ScrollPane源码。</p>
<p>……</p>
<h2 id="控制器"><a href="#控制器" class="headerlink" title="控制器"></a>控制器</h2><p><a target="_blank" rel="noopener" href="https://www.fairygui.com/docs/editor/controller">控制器是FairyGUI核心功能之一，它为UI制作中以下类似需求提供了支持：</a></p>
<ul>
<li>分页 一个组件可以由多个页面组成。</li>
<li>按钮状态 按钮通常有按下、鼠标悬浮等多个状态，我们可以利用控制器为每个状态安排不同的显示内容。</li>
<li>属性变化 利用控制器，我们可以使元件具有多个不同的形态，并且可以方便地切换。</li>
</ul>
<p>这里提到了一个重要的概念:分页。</p>
<p>控制器的概念是基于分页的，意思就是通过设计控制的页面的控制效果，我们可以提前做好多个页面效果，运行时只需切页来达到对应效果即可。</p>
<p><a target="_blank" rel="noopener" href="https://www.fairygui.com/docs/editor/controller">显示控制-2一般和显示控制搭配使用，它可以实现两个控制器控制一个元件显隐的需求。特别还提供了一个逻辑关系的选项，可以选择“与”或者“或”。</a></p>
<p>控制器可以很方便实现类似Button多种点击状态以及Toggle选中和未选中效果(程序只需负责切页即可，所有显示效果在FGUI编辑器里定义好)。</p>
<p>比如单选按钮就是通过多个单选按钮配合多个页面控制+按钮联动实现的。</p>
<p>这里的控制器相当于把操作表现流程放到UI制作流程里了(不得不说FGUI确实对于UI制作流有很大好处，部分逻辑都不再需要程序自行编写了)</p>
<p>滚动容器对应FGUI里的Controller类，相关API详情参考Controller源码。</p>
<h2 id="关联系统"><a href="#关联系统" class="headerlink" title="关联系统"></a>关联系统</h2><p><a target="_blank" rel="noopener" href="https://www.fairygui.com/docs/editor/relation">关联系统是FairyGUI实现自动布局的核心技术。其他UI框架提供的布局系统，一般只提供各种固定的layout，或者锚点，都只能定义元件与容器之间的关系。而FairyGUI的关联能够定义任意两个元件的关系，而且互动方式更多样。</a></p>
<p>FGUI的关联系统，个人理解更偏向于美术的概念，而非传统程序锚点的概念，左左，左右，右左这些都是显示知名两个Component的位置关系。</p>
<h2 id="标签"><a href="#标签" class="headerlink" title="标签"></a>标签</h2><p>标签对应FGUI里的GLabel类，相关API详情参考GLabel源码。</p>
<p>Note:</p>
<ol>
<li>标签里title和icon是两个特殊的名字，FGUI设置标签文本和图表会快速查找对应名字作为对应组件。</li>
</ol>
<h2 id="按钮"><a href="#按钮" class="headerlink" title="按钮"></a>按钮</h2><p>标签对应FGUI里的GButton类，相关API详情参考GButton源码。</p>
<p>……</p>
<h2 id="下拉框"><a href="#下拉框" class="headerlink" title="下拉框"></a>下拉框</h2><p>下拉框对应FGUI里的GComboBox类，相关API详情参考GComboBox源码。</p>
<p>……</p>
<h2 id="进度条"><a href="#进度条" class="headerlink" title="进度条"></a>进度条</h2><p>进度条对应FGUI里的GProgressBat类，相关API详情参考GProgressBar源码。</p>
<p>……</p>
<h2 id="滑动条"><a href="#滑动条" class="headerlink" title="滑动条"></a>滑动条</h2><p>滑动条对应FGUI里的GSlider类，相关API详情参考GSilder源码。</p>
<p>……</p>
<h2 id="滚动条"><a href="#滚动条" class="headerlink" title="滚动条"></a>滚动条</h2><p><a target="_blank" rel="noopener" href="https://www.fairygui.com/docs/editor/scrollbar">与很多UI框架使用皮肤机制定义滚动条不同，在FairyGUI中，滚动条是可以随心设计的。<br><a target="_blank" rel="noopener" href="https://www.fairygui.com/docs/editor/scrollpane">滚动容器</a>和滚动条是独立的，也就是说，即使没有滚动条，滚动容器也能完成滚动的功能。<br>注意：滚动条不能直接拖到舞台上使用，永远不要这样做。</a></p>
<p>滚动条对应FGUI里的GScrollBar类，相关API详情参考GScrollBar源码。</p>
<p>Note:</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://www.fairygui.com/docs/editor/scrollbar">运行时滚动条组件的类型是GScrollBar，但你不需要访问GScrollBar对象。所有滚动相关的操作都通过ScrollPane完成</a></li>
</ol>
<h2 id="列表"><a href="#列表" class="headerlink" title="列表"></a>列表</h2><p>滚动条对应FGUI里的GList类，相关API详情参考GList源码。</p>
<p>这是我们游戏中会比较常用的组件，FGUI的列表已经实现了数据与渲染分离(虚拟列表)，也实现了列表所需的几乎所有需求(e.g. 动态大小，动态魔板，循环列表，滚动到指定单元格等)</p>
<p>详情参考:<a target="_blank" rel="noopener" href="https://www.fairygui.com/docs/editor/list">FGUI列表</a></p>
<p>Note:</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://www.fairygui.com/docs/editor/list"><strong>不允许使用AddChild或RemoveChild对虚拟列表增删对象。如果要清空列表，必须要通过设置numItems&#x3D;0，而不是RemoveChildren。</strong></a></li>
</ol>
<h1 id="FGUI设计"><a href="#FGUI设计" class="headerlink" title="FGUI设计"></a>FGUI设计</h1><h2 id="显示UI面板"><a href="#显示UI面板" class="headerlink" title="显示UI面板"></a>显示UI面板</h2><p>待续……</p>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a target="_blank" rel="noopener" href="https://www.fairygui.com/">FGUI</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Plugin/">Plugin</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/UI/">UI</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2021/01/21/碰撞检测/" title="碰撞检测" itemprop="url">碰撞检测</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Tony Tang" target="_blank" itemprop="author">Tony Tang</a>
		
  <p class="article-time">
    <time datetime="2021-01-21T13:37:00.000Z" itemprop="datePublished"> 发表于 2021-01-21</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>游戏开发过程中，特别是战斗中避免不了要判定各种攻击和技能是否击中，而这些判定都得通过碰撞系统来实现正确的判定。本篇文章正是为了学习了解战斗系统中攻击技能判定是如何实现的而编写的。</p>
<p>后续大部分理论知识和小部分文字以及截图来源:</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_37043683/article/details/80375691?utm_medium=distribute.pc_relevant.none-task-blog-baidujs_title-1&spm=1001.2101.3001.4242">【Unity】图形相交检测</a></p>
<p>感谢该博主的无私分享</p>
<p>所有的代码后续会传到Github上，想查看可视化绘制的完整代码可在Github上下到。</p>
<h1 id="碰撞检测"><a href="#碰撞检测" class="headerlink" title="碰撞检测"></a>碰撞检测</h1><h2 id="What"><a href="#What" class="headerlink" title="What"></a>What</h2><p>碰撞检测 – 碰撞检测指判定物体(不论是3D还是2D物体)之间的相交。比如物理系统里碰撞检测指的是物体之间的实体碰撞以及物理效果。战斗系统里碰撞检测指的是技能和攻击的命中判定。</p>
<h2 id="Why"><a href="#Why" class="headerlink" title="Why"></a>Why</h2><p>那么为什么需要碰撞检测了？</p>
<ol>
<li>物理游戏里要模拟真实的物理效果，碰撞检测是必不可少的。</li>
<li>战斗系统里，攻击和技能的命中判定都离不开碰撞检测。</li>
<li>纯数学级别的碰撞检测模拟比Unity自带的Collider准确且高效。</li>
</ol>
<p>Note:</p>
<ol>
<li>虽然我们可以通过Unity现成的Collider去做碰撞检测，但Collider的碰撞判定顺序是不可控的，并且Collider组件会带来很大的性能开销，所以无论是出于准确性还是性能考虑，战斗力的技能和攻击判定我们都不能直接用Collider(特别是涉及网络同步的时候)。</li>
</ol>
<h2 id="How"><a href="#How" class="headerlink" title="How"></a>How</h2><h3 id="功能需求"><a href="#功能需求" class="headerlink" title="功能需求"></a>功能需求</h3><ol>
<li>支持3D一些简单形状(点,AABB,OBB,球形)的碰撞检测判定</li>
<li>支持2D一些简单形状(点,矩形，圆形，扇形，胶囊体，OBB)的碰撞检测判定</li>
</ol>
<h3 id="理论知识"><a href="#理论知识" class="headerlink" title="理论知识"></a>理论知识</h3><p><strong>碰撞检测从原理上来说就是数学运算，就是图形相交检测。</strong></p>
<p>所以要实现一套自己的碰撞检测系统，我们要先学习图形相交检测相关的数学知识。</p>
<p>这里我们以2D的碰撞检测为例来学习实现碰撞检测系统。复杂的3D碰撞检测很多时候可以简化到2D来实现相同的效果并且得到更高效的判定结果。后续只会实现一部分简单的3D形状的碰撞判定。</p>
<h4 id="2D形状"><a href="#2D形状" class="headerlink" title="2D形状"></a>2D形状</h4><h5 id="点"><a href="#点" class="headerlink" title="点"></a>点</h5><p>点在2D里我们通过X，Y坐标来定义，所以点的定义如下:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Vector2 Point;</span><br></pre></td></tr></table></figure>

<h5 id="圆形"><a href="#圆形" class="headerlink" title="圆形"></a>圆形</h5><p>圆形是由圆心+半径来定义，圆形的定义如下:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 2D圆形定义</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">struct</span> Circle2D</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 中心点位置</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> Vector2 Center;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 半径</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">float</span> Radius;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Circle2D</span>(<span class="params">Vector2 center, <span class="built_in">float</span> radius</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Center = center;</span><br><span class="line">        Radius = radius;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="矩形-轴对齐包围盒-AABB"><a href="#矩形-轴对齐包围盒-AABB" class="headerlink" title="矩形(轴对齐包围盒-AABB)"></a>矩形(轴对齐包围盒-AABB)</h5><p>矩形(轴对齐包围盒-AABB)是由中心点+长宽来定义，长宽边分别与X&#x2F;Y轴平行的矩形，矩形(轴对齐包围盒-AABB)定义如下:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 2D AABB定义</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">struct</span> AABB2D</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 中心点位置</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> Vector2 Center;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 宽和高</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> Vector2 Extents;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AABB2D</span>(<span class="params">Vector2 center, Vector2 extents</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Center = center;</span><br><span class="line">        Extents = extents;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Note:</p>
<ol>
<li>矩形(轴对齐包围盒-AABB)的长宽平行于X和Y轴</li>
</ol>
<h5 id="有向包围盒-OBB"><a href="#有向包围盒-OBB" class="headerlink" title="有向包围盒(OBB)"></a>有向包围盒(OBB)</h5><p>有向包围盒(OBB)可以理解成一个带旋转角度的矩形(轴对齐包围盒-AABB)，正因为矩形(轴对齐包围盒-AABB)无法表达长宽不平行与X和Y轴的形状，所以才有了有向包围盒(OBB)。</p>
<p>让我们通过下图来形象的理解圆形，矩形(轴对齐包围盒-AABB)和有向包围盒(OBB)的区别:</p>
<p><img src="/img/CollisionDetection/CIRCLE_AABB_OBB_DES.jpg" alt="CIRCLE_AABB_OBB_DES"></p>
<p>向包围盒(OBB)由中心点+长宽+旋转角度来定义，定义如下:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 2D OBB定义</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">struct</span> OBB2D</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 中心点位置</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> Vector2 Center;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 宽和高</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> Vector2 Extents;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 旋转角度</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">float</span> Angle;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">OBB2D</span>(<span class="params">Vector2 center, Vector2 extents, <span class="built_in">float</span> angle</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Center = center;</span><br><span class="line">        Extents = extents;</span><br><span class="line">        Angle = angle;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="胶囊体"><a href="#胶囊体" class="headerlink" title="胶囊体"></a>胶囊体</h5><p>胶囊体是由起点+线段u+胶囊体半径d定义。胶囊体实际上是与线段u的最短距离d的点的集合。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 2D胶囊体定义</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">struct</span> Capsule2D</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 起点</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> Vector2 StartPoint;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 起点线段</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> Vector2 PointLine;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 胶囊体半径</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">float</span> Radius;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Capsule2D</span>(<span class="params">Vector2 startpoint, Vector2 pointline, <span class="built_in">float</span> radius</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        StartPoint = startpoint;</span><br><span class="line">        PointLine = pointline;</span><br><span class="line">        Radius = radius;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/img/CollisionDetection/SphereDefinition.png" alt="SphereDefinition"></p>
<p>从上面引申出了点与线段的最短距离算法:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 点与线段的最短距离</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;startpoint&quot;&gt;</span>线段起点<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;line&quot;&gt;</span>线段向量<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;targetpoint&quot;&gt;</span>求解点<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">float</span> <span class="title">SqrDistanceBetweenSegmentAndPoint</span>(<span class="params">Vector2 startpoint, Vector2 line, Vector2 targetpoint</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">float</span> t = Vector2.Dot(targetpoint - startpoint, line) / line.sqrMagnitude;</span><br><span class="line">    <span class="keyword">return</span> (targetpoint - (startpoint + Mathf.Clamp01(t) * line)).sqrMagnitude;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>要理解上面的公式，需要知道向量里的一些基本概念，参考:</p>
<p><a href="">向量学习</a></p>
<p>上面的计算公式理解如下：</p>
<p> float t &#x3D; Vector2.Dot(targetpoint - startpoint, line) &#x2F; line.sqrMagnitude; &#x2F;&#x2F; 计算求解点映射到线段line上的比例。</p>
<p>(startpoint + Mathf.Clamp01(t) * line) &#x2F;&#x2F; 计算的是映射点P点的坐标</p>
<p>(targetpoint - (startpoint + Mathf.Clamp01(t) * line) ) &#x2F;&#x2F; 表达的是目标点到线段的那条向量d</p>
<p>(targetpoint - (startpoint + Mathf.Clamp01(t) * line) ) .sqrMagnitude; &#x2F;&#x2F; 得到目标点到线段的向量的距离平方(<strong>后续用平方比代替开方比，因为平方比在计算机上比开方比更快</strong>)</p>
<p><strong>后续计算形状相交很多都会转化成点与线的距离来比较实现碰撞检测</strong></p>
<p>Note:</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_37043683/article/details/80375691?utm_medium=distribute.pc_relevant.none-task-blog-baidujs_title-1&spm=1001.2101.3001.4242"><strong>判定一个点处于胶囊体内部，就是判断点与线段的距离</strong></a></li>
<li><strong>计算机开方计算比平方计算慢，所以我们采用平方比较来代替开方值比较</strong></li>
</ol>
<h5 id="扇形"><a href="#扇形" class="headerlink" title="扇形"></a>扇形</h5><p>扇形是由起点+扇形半径+扇形朝向+扇形角度定义，扇形定义如下:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 2D扇形定义</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">struct</span> Sector2D</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 扇形起点</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> Vector2 StartPoint;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 扇形半径</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">float</span> Radius;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 扇形朝向</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> Vector2 Direction;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 扇形角度</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">float</span> Angle;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Sector2D</span>(<span class="params">Vector2 startpoint, <span class="built_in">float</span> radius, Vector2 direction, <span class="built_in">float</span> angle</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        StartPoint = startpoint;</span><br><span class="line">        Radius = radius;</span><br><span class="line">        Direction = direction;</span><br><span class="line">        Angle = angle;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="凸多边形"><a href="#凸多边形" class="headerlink" title="凸多边形"></a>凸多边形</h5><p>多边形的定义是否多个顶点位置定义的，多边形定义如下:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             Polygon2D.cs</span></span><br><span class="line"><span class="comment"> * Author:                  TONYTANG</span></span><br><span class="line"><span class="comment"> * Create Date:             2022/03/20</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">TH.Module.Collision2D</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Polygon2D.cs</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 多边形定义</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">struct</span> Polygon2D</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 多边形顶点(注意保持统一顺时针或者逆时针定义)</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> Vector2[] Vertexes;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Polygon2D</span>(<span class="params">Vector2[] vertexes</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            Vertexes = vertexes;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 是否是有效多边形</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">IsValide</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (Vertexes == <span class="literal">null</span> || Vertexes.Length &lt; <span class="number">3</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                Debug.LogError(<span class="string">&quot;多边形顶点数不应该小于3个!&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Note:</p>
<ol>
<li><strong>上述定义并不能保证一定是凸多边形</strong></li>
</ol>
<h3 id="分离轴定理"><a href="#分离轴定理" class="headerlink" title="分离轴定理"></a>分离轴定理</h3><p>了解了各种形状的定义后，在了解真正的碰撞检测判定前，为了更好的理解后面的碰撞检测计算，我们先来了解一个概念<strong>分离轴定理</strong></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_37043683/article/details/80375691">分离轴定理（separating axis theorem, SAT）分离轴定理是指，两个不相交的凸集必然存在一个分离轴，使两个凸集在该轴上的投影是分离的。</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_37043683/article/details/80375691">判断两个形状是否相交，实际上是判断分离轴是否能把两个形状分离。若存在分离轴能使两个图形分离，则这两个图形是分离的。</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_37043683/article/details/80375691">基于以上理论，寻找分离轴是我们要做的工作，重新考虑两个圆形的相交检测，实际上我们做的是把圆心连线的方向作为分离轴：</a></p>
<p><img src="/img/CollisionDetection/SAT.png" alt="SAT"></p>
<p><strong>通过分离轴定理的定义可以看出，通过找到两个凸集形状的分离轴，我们可以实现两个形状相交的判定，这个会成为我们后面判定碰撞检测的重要理论知识</strong></p>
<p>接下来让我们真正进入碰撞检测实战。</p>
<h3 id="形状碰撞检测"><a href="#形状碰撞检测" class="headerlink" title="形状碰撞检测"></a>形状碰撞检测</h3><h4 id="点与圆形"><a href="#点与圆形" class="headerlink" title="点与圆形"></a>点与圆形</h4><p><strong>点与圆形的相交判定实际上就是判定点与圆心的距离是否大于半径。</strong></p>
<p>这里理论很简单，就不上效果图了，直接看代码:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 判断圆形与点之间的交叉检测</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;circle1&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;point&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">bool</span> <span class="title">CircleAndPointIntersection2D</span>(<span class="params">Circle2D circle1, Vector2 point</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> (circle1.Center - point).sqrMagnitude &lt; circle1.Radius * circle1.Radius;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="点与矩形-AABB"><a href="#点与矩形-AABB" class="headerlink" title="点与矩形(AABB)"></a>点与矩形(AABB)</h4><p>点与矩形的判定也比较容易，利用AABB的轴和XZ平行，我们可以直接比较点的X和Z是否在AABB的最大最小范围内即可(也可以理解成点与AABB中心的距离是否小于等于AABB的宽&#x2F;2和长&#x2F;2)</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 点是否在矩形(AABB)内</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;aabb&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;point&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">bool</span> <span class="title">PointInAABB2D</span>(<span class="params">AABB2D aabb, Vector2 point</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 点和AABB原点的位置偏移(等价于将点移动到AABB坐标系)</span></span><br><span class="line">    Vector2 offset = aabb.Center - point;</span><br><span class="line">    offset = Vector2.Max(offset, -offset);</span><br><span class="line">    <span class="comment">// 判定偏移是否小于AABB宽/2和AABB长/2</span></span><br><span class="line">    <span class="keyword">return</span> offset.x &lt;= aabb.Extents.x / <span class="number">2</span> &amp;&amp; offset.y &lt;= aabb.Extents.y / <span class="number">2</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/img/CollisionDetection/PointIntersectionWithAABB2D.PNG" alt="PointIntersectionWithAABB2D"></p>
<p>代码比较简单就不详细解释了。</p>
<h4 id="点与多边形"><a href="#点与多边形" class="headerlink" title="点与多边形"></a>点与多边形</h4><p><strong>判定一个点是否在多边形内</strong>，本文使用的是<strong>角度和</strong>和**叉积(点线)**判定法，更多的解题思路参考:</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/WilliamSun0122/article/details/77994526">详谈判断点在多边形内的七种方法（最全面）</a></p>
<p>上文中提到<strong>射线法</strong>比较优，但考虑到理解难易度，还是<strong>角度和</strong>和**叉积(点线)**法更易理解，本文主要以这两种解法为例。</p>
<h6 id="角度和法"><a href="#角度和法" class="headerlink" title="角度和法"></a>角度和法</h6><p>学过平面几何的同学都知道，<strong>如果一个点在凸多边形内，那么这个点和凸多边形各顶点连线构成的夹角和应该为360度</strong>。</p>
<p>角度和法正是利用了这一个定义来实现一个点是否在凸多边形内的。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 点是否在多边形内(内角和法)</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;polygon&quot;&gt;</span>多边形<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;point&quot;&gt;</span>点<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">bool</span> <span class="title">PointInPolygon2D</span>(<span class="params">Polygon2D polygon, Vector2 point</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span>(!polygon.IsValide())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    Vector2[] polygonVertexes = polygon.Vertexes;</span><br><span class="line">    <span class="built_in">int</span> polygonVertexsNumber = polygonVertexes.Length;</span><br><span class="line">	<span class="comment">// 点与所有多边形顶点的连线向量</span></span><br><span class="line">    Vector2[] pointLines = <span class="keyword">new</span> Vector2[polygonVertexsNumber];</span><br><span class="line">    <span class="keyword">for</span>(<span class="built_in">int</span> i = <span class="number">0</span>, length = polygonVertexsNumber; i &lt; length; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        pointLines[i] = polygonVertexes[i] - point;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 计算所有多边形顶点连线之间的夹角总和</span></span><br><span class="line">    <span class="built_in">float</span> totalAngle = Vector2.SignedAngle(pointLines[polygonVertexsNumber - <span class="number">1</span>], pointLines[<span class="number">0</span>]);</span><br><span class="line">    <span class="keyword">for</span>(<span class="built_in">int</span> i = <span class="number">0</span>, length = polygonVertexsNumber - <span class="number">1</span>; i &lt; length; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        totalAngle += Vector2.SignedAngle(pointLines[i], pointLines[i + <span class="number">1</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (Mathf.Abs(Mathf.Abs(totalAngle) - <span class="number">360f</span>) &lt; <span class="number">0.1f</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/img/CollisionDetection/PolygonVertexesInfo.PNG" alt="PolygonVertexesInfo"></p>
<p><img src="/img/CollisionDetection/PointOutOfPolygon.PNG" alt="PointOutOfPolygon"></p>
<p><img src="/img/CollisionDetection/PointInPolygon.PNG" alt="PointInPolygon"></p>
<p>从上面可以看到我们通过累加点到多边形所有顶点构成的线段的夹角总和判定除了点是否在多边形内。但上面的方法new了大量的Vector3数组以及用到了Vector2.SignedAngle()等反三角函数，所以速度和效率上并不是不太优，接下来我们会讲到针对点是否在凸多边形内的更优解法(<strong>叉乘(点线)法</strong>)。</p>
<p>Note:</p>
<ol>
<li><strong>此方法适用于凸多边形和凹多边形</strong></li>
</ol>
<h6 id="叉积-点线-法"><a href="#叉积-点线-法" class="headerlink" title="叉积(点线)法"></a>叉积(点线)法</h6><p><strong>叉积(点线)法的核心思想是判定点到多边形所有顶点构成的边是否都在相邻多边形边的一侧(顺时针的话需要都在左侧，逆时针的话需要都在右侧)</strong></p>
<p>这里我们利用叉乘(叉乘结果&gt;0还是&lt;0能区分)来实现两个向量的左右关系判定。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 点是否在凸边形内(叉积(点线)法)</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Note:</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 1. 确保是凸多边形</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 2. 确保凸多边形顶点是顺时针</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;polygon&quot;&gt;</span>凸多边形<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;point&quot;&gt;</span>点<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">bool</span> <span class="title">PointInConvexPolygon2D</span>(<span class="params">Polygon2D polygon, Vector2 point</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (!polygon.IsValide())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    Vector2[] polygonVertexes = polygon.Vertexes;</span><br><span class="line">    <span class="built_in">int</span> polygonVertexsNumber = polygonVertexes.Length;</span><br><span class="line">    Vector3 pointLine;</span><br><span class="line">    Vector3 polygonEdge;</span><br><span class="line">    <span class="built_in">int</span> index;</span><br><span class="line">    <span class="comment">// 这里采用顶点顺时针判定</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>, length = polygonVertexsNumber; i &lt; length; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        pointLine = <span class="keyword">new</span> Vector3(point.x - polygonVertexes[i].x, <span class="number">0</span>, point.y - polygonVertexes[i].y);</span><br><span class="line">        index = (i + <span class="number">1</span>) % polygonVertexsNumber;</span><br><span class="line">        polygonEdge = <span class="keyword">new</span> Vector3(polygonVertexes[index].x - polygonVertexes[i].x, <span class="number">0</span>, polygonVertexes[index].y - polygonVertexes[i].y);</span><br><span class="line">        <span class="comment">// 计算多边形顶点的连线向量和边的左右关系</span></span><br><span class="line">        <span class="comment">// Vector3.Cross(A, B).y &gt; 0 表示A在B的左侧</span></span><br><span class="line">        <span class="comment">// Vector3.Cross(A, B).y &lt; 0 表示A在B的右侧</span></span><br><span class="line">        <span class="comment">// Vector3.Cross(A, B).y == 0 表示A和B平行</span></span><br><span class="line">        <span class="keyword">if</span> (Vector3.Cross(pointLine, polygonEdge).y &gt;= <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/img/CollisionDetection/PolygonVertexesInfo2.PNG" alt="PolygonVertexesInfo2"></p>
<p><img src="/img/CollisionDetection/PointOutOfPolygon2.PNG" alt="PointOutOfPolygon2"></p>
<p><img src="/img/CollisionDetection/PointInPolygon2.PNG" alt="PointInPolygon2"></p>
<p>从上面的效果图可以看出我们通过叉积法也成功判定出了点是否在<strong>凸多边形</strong>内。</p>
<p>但上面的方式需要创建大量的Vector3来构建边以及叉乘判定，虽然Vector3是结构体类型不会造成GC问题，但核心只是为了实现两个向量的方向判定，依然有优化的空间。</p>
<p><strong>我们可以把2D的向量方向当做就在XZ平面的3D向量来计算(即把Y轴值当做0)，通过叉乘最原始的公式直接计算叉乘后Y轴值的大小来判定两个向量的方向关系</strong>。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 点是否在凸边形内(叉积(点线)法--不构建Vector3纯数学运算)</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Note:</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 1. 确保是凸多边形</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 2. 确保凸多边形顶点是顺时针</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;polygon&quot;&gt;</span>凸多边形<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;point&quot;&gt;</span>点<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">bool</span> <span class="title">BetterPointInConvexPolygon2D</span>(<span class="params">Polygon2D polygon, Vector2 point</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (!polygon.IsValide())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    Vector2[] polygonVertexes = polygon.Vertexes;</span><br><span class="line">    <span class="built_in">int</span> polygonVertexsNumber = polygonVertexes.Length;</span><br><span class="line">    <span class="built_in">int</span> index;</span><br><span class="line">    <span class="built_in">float</span> lineX;</span><br><span class="line">    <span class="built_in">float</span> lineZ;</span><br><span class="line">    <span class="built_in">float</span> edgeX;</span><br><span class="line">    <span class="built_in">float</span> edgeZ;</span><br><span class="line">    <span class="comment">// 把2D向量当做XZ平面的3D向量来处理</span></span><br><span class="line">    <span class="comment">// 不构建Vector3的边，直接利用叉乘公式计算叉乘后的Y值</span></span><br><span class="line">    <span class="comment">// 然后通过Y值来判定两个2D向量的方向</span></span><br><span class="line">    <span class="comment">// 这里采用顶点顺时针判定</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>, length = polygonVertexsNumber; i &lt; length; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        lineX = point.x - polygonVertexes[i].x;</span><br><span class="line">        lineZ = point.y - polygonVertexes[i].y;</span><br><span class="line">        index = (i + <span class="number">1</span>) % polygonVertexsNumber;</span><br><span class="line">        edgeX = polygonVertexes[index].x - polygonVertexes[i].x;</span><br><span class="line">        edgeZ = polygonVertexes[index].y - polygonVertexes[i].y;</span><br><span class="line">        <span class="comment">// 利用叉乘原始公式进行计算判定两个向量的方向</span></span><br><span class="line">        <span class="comment">// Vector3.Cross(A, B).y &gt; 0 表示A在B的左侧</span></span><br><span class="line">        <span class="comment">// Vector3.Cross(A, B).y &lt; 0 表示A在B的右侧</span></span><br><span class="line">        <span class="comment">// Vector3.Cross(A, B).y == 0 表示A和B平行</span></span><br><span class="line">        <span class="keyword">if</span>((lineZ * edgeX - lineX * edgeZ) &gt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/img/CollisionDetection/PolygonVertexesInfo3.PNG" alt="PolygonVertexesInfo3"></p>
<p><img src="/img/CollisionDetection/PointOutOfPolygon3.PNG" alt="PointOutOfPolygon3"></p>
<p><img src="/img/CollisionDetection/PointInPolygon3.PNG" alt="PointInPolygon3"></p>
<p>可以看到不通过构建Vector3，我们直接利用叉乘的公式把2D当3D计算出叉乘的Y值，依然可以有效的判定出点是否在凸多边形内。</p>
<p><strong>在3D维度两个向量不再是在单纯的XZ平面而是在任意平面，这里不再能直接使用叉乘的y值进行判定，除非两个向量在XZ平面。</strong></p>
<p>Note:</p>
<ol>
<li><strong>此方法适用于凸多边形</strong></li>
<li><strong>注意叉积判定对于多边形顶点的顺序要求</strong></li>
<li><strong>2维向量叉乘AXB &#x3D; (0, 0, x1 * y2 - x2 * y1)，x1 * y2 - x2 * y1大于0表示A在B的右侧，小于0表示A在B的左侧，等于0表示A和B平行(大前提是左手坐标系，右手坐标系左右侧是反过来的)</strong></li>
<li><strong>叉乘y大于0表示A在B的左侧还是小于0表示A在B的左侧主要看我们用的左手坐标系还是右手坐标系，因为Unity是左手坐标系，所欲叉乘y大于0表示A在B的左侧</strong></li>
<li><strong>利用叉乘结果y大于0还是y小于0区分方向的同时，我们还能用于推断向量A在向量B的左侧还是右侧(大前提是两个向量在XZ平面)</strong></li>
</ol>
<h4 id="圆形与圆形"><a href="#圆形与圆形" class="headerlink" title="圆形与圆形"></a>圆形与圆形</h4><p>圆形和圆形相交判定起始就是2个圆心的距离是否大于两个圆的半径之和。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 判断圆形与圆形之间的交叉检测</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;circle1&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;circle2&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">bool</span> <span class="title">CircleAndCircleIntersection2D</span>(<span class="params">Circle2D circle1, Circle2D circle2</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> (circle1.Center - circle2.Center).sqrMagnitude &lt; (circle1.Radius + circle2.Radius) * (circle1.Radius + circle2.Radius);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个比较简单没什么好说的。</p>
<h4 id="圆形与胶囊体"><a href="#圆形与胶囊体" class="headerlink" title="圆形与胶囊体"></a>圆形与胶囊体</h4><p>结合前面分离轴定理，我们要想判定圆形和胶囊体是否相交，首先找到分离轴，而圆形和胶囊体的分离轴是胶囊体线段上距离圆形最近的点P与圆心所在的方向。</p>
<p>所以判定圆心到胶囊体线段的距离是否大于胶囊体半径+圆形半径即可。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 判断圆形与胶囊体相交</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;circle&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;capsule&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">bool</span> <span class="title">CircleAndCapsuleIntersection2D</span>(<span class="params">Circle2D circle, Capsule2D capsule</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">float</span> sqrdistance = SqrDistanceBetweenSegmentAndPoint(capsule.StartPoint, capsule.PointLine, circle.Center);</span><br><span class="line">    <span class="keyword">return</span> sqrdistance &lt; (circle.Radius + capsule.Radius) * (circle.Radius + capsule.Radius);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/img/CollisionDetection/Circle2DIntersectionWithCapsule2D.PNG" alt="Circle2DIntersectionWithCapsule2D"></p>
<p><img src="/img/CollisionDetection/Capsule.PNG" alt="Capsule"></p>
<p><img src="/img/CollisionDetection/Circle2DIntersectionWithRotateCapsule2D.PNG" alt="Circle2DIntersectionWithRotateCapsule2D"></p>
<p><img src="/img/CollisionDetection/Capsule2.PNG" alt="Capsule2"></p>
<h4 id="圆形与矩形-AABB"><a href="#圆形与矩形-AABB" class="headerlink" title="圆形与矩形(AABB)"></a>圆形与矩形(AABB)</h4><p>利用AABB的对称性，我们以AABB中心为原点，两边为坐标轴的坐标系。通过将圆形移动AABB的大小，然后看圆形所在位置与中心点距离是否还大于圆形半径来判定圆形和AABB是否相交。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 判断圆形与AABB相交</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;circle&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;aabb&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">bool</span> <span class="title">CircleAndAABBIntersection2D</span>(<span class="params">Circle2D circle, AABB2D aabb</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 以AABB中心为圆心</span></span><br><span class="line">    Vector2 v = Vector2.Max(circle.Center - aabb.Center, -(circle.Center - aabb.Center));</span><br><span class="line">    <span class="comment">// 把圆心坐标偏移AABB大小</span></span><br><span class="line">    Vector2 u = Vector2.Max(v - aabb.Extents / <span class="number">2</span>, Vector2.zero);</span><br><span class="line">    <span class="comment">// 判定圆心距离是否还大于圆形半径判定相交</span></span><br><span class="line">    <span class="keyword">return</span> u.sqrMagnitude &lt; circle.Radius * circle.Radius;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/img/CollisionDetection/Circle2DIntersectionWithAABB.PNG" alt="Circle2DIntersectionWithAABB"></p>
<p><img src="/img/CollisionDetection/AABB2DInfo.PNG" alt="AABB2DInfo"></p>
<h4 id="圆形与有向包围盒-OBB"><a href="#圆形与有向包围盒-OBB" class="headerlink" title="圆形与有向包围盒(OBB)"></a>圆形与有向包围盒(OBB)</h4><p>结合前面OBB的定义:</p>
<p><strong>有向包围盒(OBB)可以理解成一个带旋转角度的矩形(轴对齐包围盒-AABB)</strong></p>
<p>可以看出OBB和AABB的主要区别是支持了选择的AABB，那么我们判定OBB和圆形的相交检测也就等价于把圆形旋转到OBB所在坐标系后，然后当做圆形和AABB相交判定即可。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Vector3临时变量(用于优化new Vector3)</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Vector3 Vector3Temp;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 判定圆形和OBB相交检测</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;circle&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;obb&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">bool</span> <span class="title">CircleAndOBBIntersection2D</span>(<span class="params">Circle2D circle, OBB2D obb</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 以OBB中心为坐标原点</span></span><br><span class="line">    Vector2 point = circle.Center - obb.Center;</span><br><span class="line">    Vector3Temp.x = point.x;</span><br><span class="line">    Vector3Temp.y = <span class="number">0</span>;</span><br><span class="line">    Vector3Temp.z = point.y;</span><br><span class="line">    <span class="comment">// 将圆心通过反向旋转转到OBB坐标系</span></span><br><span class="line">    Vector3 point2 = Quaternion.AngleAxis(-obb.Angle, Vector3.up) * Vector3Temp;</span><br><span class="line">    point.x = point2.x;</span><br><span class="line">    point.y = point2.z;</span><br><span class="line">    <span class="comment">// 将旋转后的圆心位置和OBB做AABB方式的相交判定</span></span><br><span class="line">    Vector2 v = Vector2.Max(point, -point);</span><br><span class="line">    <span class="comment">// 把圆心坐标偏移OBB大小</span></span><br><span class="line">    Vector2 u = Vector2.Max(v - obb.Extents / <span class="number">2</span>, Vector2.zero);</span><br><span class="line">    <span class="comment">// 判定圆心距离是否还大于圆形半径判定相交</span></span><br><span class="line">    <span class="keyword">return</span> u.sqrMagnitude &lt; circle.Radius * circle.Radius;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/img/CollisionDetection/Circle2DIntersectionWithOBB2D.PNG" alt="Circle2DIntersectionWithOBB2D"></p>
<p><img src="/img/CollisionDetection/OBB2DInfo.PNG" alt="OBB2DInfo"></p>
<p>Note:</p>
<ol>
<li><strong>Quaternion.AngleAxis()如果绕Y轴旋转直接乘以Vector2会得到错误的结果，所以我们需要当做Vector3来计算，最后再转换回Vector2</strong></li>
<li><strong>虽然Vector3是结构体不会造成GC，但不想每次判定都创建Vector3所以定义了一个临时Vector3用于计算重用</strong></li>
</ol>
<h4 id="圆形与凸多边形"><a href="#圆形与凸多边形" class="headerlink" title="圆形与凸多边形"></a>圆形与凸多边形</h4><p>圆形与凸多边形相交判定只需要在点和凸多边形相交判定上增加圆心不在凸多边形内时，判定圆心到多边形每条边的距离是否有小于圆形半径即可。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 判断圆形与多边形相交</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;circle&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;polygon&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">bool</span> <span class="title">CircleAndPolygonIntersection2D</span>(<span class="params">Circle2D circle, Polygon2D polygon</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 判定圆心是否在多边形内</span></span><br><span class="line">    <span class="keyword">if</span>(BetterPointInConvexPolygon2D(polygon, circle.Center))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 圆心不在多边形内，则判定圆心与每条边的距离是否小于半径</span></span><br><span class="line">    Vector2 circleCenter = circle.Center;</span><br><span class="line">    <span class="built_in">float</span> sqrR = circle.Radius * circle.Radius;</span><br><span class="line">    <span class="keyword">var</span> vertexes = polygon.Vertexes;</span><br><span class="line">    <span class="built_in">int</span> polygonVertexsNumber = polygon.Vertexes.Length;</span><br><span class="line">    Vector2 edge;</span><br><span class="line">    <span class="built_in">int</span> index;</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>, length = polygonVertexsNumber; i &lt; length; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        index = (i + <span class="number">1</span>) % polygonVertexsNumber;</span><br><span class="line">        edge.x = vertexes[index].x - vertexes[i].x;</span><br><span class="line">        edge.y = vertexes[index].y - vertexes[i].y;</span><br><span class="line">        <span class="comment">// 判定圆心到单条边的距离是否小于半径</span></span><br><span class="line">        <span class="keyword">if</span>(SqrDistanceBetweenSegmentAndPoint(vertexes[i], edge, circleCenter) &lt; sqrR)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/img/CollisionDetection/Circle2DIntersectionPolygon2D.PNG" alt="Circle2DIntersectionPolygon2D"></p>
<p>注释写的很详细了，就不详细解释说明了。</p>
<h4 id="圆形与扇形"><a href="#圆形与扇形" class="headerlink" title="圆形与扇形"></a>圆形与扇形</h4><p><strong>当扇形角度大于180度时，就不再是凸多边形了，不能适用于分离轴理论。</strong></p>
<p>我们把相交判定分成两个部分判定:</p>
<ol>
<li>圆形在扇形角度内，直接判定扇形原点和圆心距离是否大于扇形半径+圆形半径</li>
<li>圆形在扇形角度外，利用扇形对称性，将原因映射到扇形一侧，通过映射后的原因与扇形一条边的距离是否小于圆形半径判定相交</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 判断圆形与扇形相交</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;circle&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;sector&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">bool</span> <span class="title">CircleAndSectorIntersection2D</span>(<span class="params">Circle2D circle, Sector2D sector</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    Vector2 tempDistance = circle.Center - sector.StartPoint;</span><br><span class="line">    <span class="built_in">float</span> halfAngle = Mathf.Deg2Rad * sector.Angle / <span class="number">2</span>;</span><br><span class="line">    <span class="comment">// 判定扇形起点和圆心距离是否小于扇形半径+圆形半径</span></span><br><span class="line">    <span class="keyword">if</span> (tempDistance.sqrMagnitude &lt; (sector.Radius + circle.Radius) * (sector.Radius + circle.Radius))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 判定圆形是否在扇形角度内</span></span><br><span class="line">        <span class="keyword">if</span> (Vector3.Angle(tempDistance, sector.Direction) &lt; sector.Angle / <span class="number">2</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 利用扇形的对称性，将圆心位置映射到一侧</span></span><br><span class="line">            Vector2 targetInsectorAxis = <span class="keyword">new</span> Vector2(Vector2.Dot(tempDistance, sector.Direction), Mathf.Abs(Vector2.Dot(tempDistance, <span class="keyword">new</span> Vector2(-sector.Direction.y, sector.Direction.x))));</span><br><span class="line">            <span class="comment">// 扇形的一条边</span></span><br><span class="line">            Vector2 directionInSectorAxis = sector.Radius * <span class="keyword">new</span> Vector2(Mathf.Cos(halfAngle), Mathf.Sin(halfAngle));</span><br><span class="line">            <span class="comment">// 通过判定映射后的原因与扇形一条边的距离是否小于圆形半径判定相交</span></span><br><span class="line">            <span class="keyword">return</span> SqrDistanceBetweenSegmentAndPoint(Vector2.zero, directionInSectorAxis, targetInsectorAxis) &lt;= circle.Radius * circle.Radius;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/img/CollisionDetection/Circle2DIntersectionWithSector2D.PNG" alt="Circle2DIntersectionWithSector2D"></p>
<p><img src="/img/CollisionDetection/Sector2DInfo.PNG" alt="Sector2DInfo"></p>
<p>Note:</p>
<ol>
<li><strong>当扇形角度大于180度时，就不再是凸多边形了，不能适用于分离轴理论。</strong></li>
</ol>
<h4 id="矩形-AABB-与矩形-AABB"><a href="#矩形-AABB-与矩形-AABB" class="headerlink" title="矩形(AABB)与矩形(AABB)"></a>矩形(AABB)与矩形(AABB)</h4><p>AABB与AABB的相交判定，考虑到AABB的轴都相同且都为矩形的特殊性，相交判定只需要判定两个AABB原点的距离是否有任何一个小于宽&#x2F;2之和或长&#x2F;2之和即可。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 判定AABB和AABB相交检测</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;aabb1&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;aabb2&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">bool</span> <span class="title">AABBAndAABBIntersection2D</span>(<span class="params">AABB2D aabb1, AABB2D aabb2</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 两个AABB原点的位置偏移</span></span><br><span class="line">    Vector2 offset = aabb2.Center - aabb1.Center;</span><br><span class="line">    offset = Vector2.Max(offset, -offset);</span><br><span class="line">    <span class="comment">// 判定偏移是否小于两者宽/2之和和两者长/2之和</span></span><br><span class="line">    <span class="keyword">return</span> offset.x &lt;= (aabb1.Extents.x / <span class="number">2</span> + aabb2.Extents.x / <span class="number">2</span>) &amp;&amp; offset.y &lt;= (aabb1.Extents.y / <span class="number">2</span> + aabb2.Extents.y / <span class="number">2</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/img/CollisionDetection/AABB2DIntersectionWithAABB2D.PNG" alt="AABB2DIntersectionWithAABB2D"></p>
<p><img src="/img/CollisionDetection/AABB2DInfo1.PNG" alt="AABB2DInfo1"></p>
<p><img src="/img/CollisionDetection/AABB2DInfo2.PNG" alt="AABB2DInfo2"></p>
<p>AABB和AABB的判定比较简单，就不详细解释了。</p>
<h4 id="进阶学习"><a href="#进阶学习" class="headerlink" title="进阶学习"></a>进阶学习</h4><p>关于OBB等凸多边形相关的交叉判定，我们需要用到分离轴定理，这里暂时不深入实现了(<strong>TODO</strong>)，详情参考:</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/flj135792468/article/details/120759839">UNITY实战进阶-OBB包围盒详解-6</a></p>
<p>关于3D的相交检测，这里我们用Unity Bounds提供的关于OBB的实现类。</p>
<p>更多的3D相交检测自定义实现，可以参考二维的实现扩展到3维，这里暂时不做进一步的学习记录。(<strong>大部分时候我们可以简化相交检测，比如讲3D简化到2D，扇形椭圆简化到圆形或点来实现相交碰撞检测</strong>)</p>
<h3 id="线段相交"><a href="#线段相交" class="headerlink" title="线段相交"></a>线段相交</h3><p>线段相交理论知识参考:</p>
<p><a target="_blank" rel="noopener" href="http://www.laowangomg.com/?p=501">Unity3D C#数学系列之判断两条线段是否相交并求交点</a></p>
<p><img src="/img/Math/LineIntersectionPoint.png" alt="LineIntersectionPoint"></p>
<p>相交大前提:</p>
<ol>
<li>AB和CD必须共面。</li>
</ol>
<p>如何判定AB和CD共面了?</p>
<p>通过计算<strong>ACD平面法线是否与AB垂直即可</strong>(<strong>2D向量可以省去这一步</strong>)。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 4个点是否共面</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;a&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;b&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;c&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;d&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">bool</span> <span class="title">IsCoplanarVector</span>(<span class="params">Vector3 a, Vector3 b, Vector3 c, Vector3 d</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 通过叉乘计算CA和CD的法线向量</span></span><br><span class="line">    <span class="keyword">var</span> ab = b - a;</span><br><span class="line">    <span class="keyword">var</span> ca = a - c;</span><br><span class="line">    <span class="keyword">var</span> cd = d - c;</span><br><span class="line">    <span class="keyword">var</span> normal = Vector3.Cross(ca, cd);</span><br><span class="line">    <span class="comment">// 通过ab向量和CA和CD法线向量的点乘是否为0来判定是否垂直</span></span><br><span class="line">    <span class="comment">// a,b,c,d从而判定出是否共面</span></span><br><span class="line">    <span class="keyword">if</span>(Mathf.Approximately(Vector3.Dot(normal, ab), Mathf.Epsilon))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如何判定相交:</p>
<ol>
<li>快速排斥和跨立实现判定是否相交</li>
</ol>
<p>这里我采用跨立法来判定，<strong>跨立法是指两个线段相交必须满足两个线段的两个点分别在另一个线段的两侧</strong>。</p>
<p>这里我们利用<strong>叉乘</strong>来判定两个向量的方向从而判定是否线段在另一个线段两侧。</p>
<p>2D向量:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 2D向量叉乘</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;a&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;b&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">float</span> <span class="title">Cross</span>(<span class="params">Vector2 a, Vector2 b</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> a.x * b.y - b.x * a.y;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 4个点是否ab和cd线段是否相交</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;a&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;b&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;c&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;d&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">bool</span> <span class="title">IsCross</span>(<span class="params">Vector2 a, Vector2 b, Vector2 c, Vector2 d</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 通过叉乘计算CA和CD的法线向量</span></span><br><span class="line">    <span class="keyword">var</span> ab = b - a;</span><br><span class="line">    <span class="keyword">var</span> ac = c - a;</span><br><span class="line">    <span class="keyword">var</span> ad = d - a;</span><br><span class="line">    <span class="comment">// 叉乘判定两个向量的方向</span></span><br><span class="line">    <span class="comment">// 判定ab是否在cd两侧</span></span><br><span class="line">    <span class="comment">// 以ab为基准，如果ab叉乘ac或ad大于0表示逆时针反之顺时针,0表示两者方向相同</span></span><br><span class="line">    <span class="comment">// 那么c和d要在ab同一侧，则ab叉乘ac的结果和ab叉乘ad的结果相乘需要&gt;0</span></span><br><span class="line">    <span class="keyword">if</span> (Vector2Utilities.Cross(ab, ac) * Vector2Utilities.Cross(ab, ad) &gt;= <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 同理以cd为基准，如果ca和cb叉乘结果相乘&gt;0则表示a和b在cd同一侧</span></span><br><span class="line">    <span class="keyword">var</span> ca = a - c;</span><br><span class="line">    <span class="keyword">var</span> cb = b - c;</span><br><span class="line">    <span class="keyword">var</span> cd = d - c;</span><br><span class="line">    <span class="keyword">if</span> (Vector2Utilities.Cross(cd, ca) * Vector2Utilities.Cross(cd, cb) &gt;= <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>3D向量:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 4个点是否ab和cd线段是否相交</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;a&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;b&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;c&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;d&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">bool</span> <span class="title">IsCross</span>(<span class="params">Vector3 a, Vector3 b, Vector3 c, Vector3 d</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 通过叉乘计算CA和CD的法线向量</span></span><br><span class="line">    <span class="keyword">var</span> ab = b - a;</span><br><span class="line">    <span class="keyword">var</span> ac = c - a;</span><br><span class="line">    <span class="keyword">var</span> ad = d - a;</span><br><span class="line">    <span class="comment">// 叉乘判定两个向量的方向</span></span><br><span class="line">    <span class="comment">// 判定ab是否在cd两侧</span></span><br><span class="line">    <span class="comment">// 以ab为基准，如果ac和ad叉乘结果再点乘&gt;0则表示c和d在ab同一侧</span></span><br><span class="line">    <span class="comment">// 3D向量叉乘是向量，通过计算两个叉乘向量的点乘判定是否同方向从而判定是否在一侧</span></span><br><span class="line">    <span class="keyword">if</span> (Vector3.Dot(Vector3.Cross(ab, ac), Vector3.Cross(ab, ad)) &gt;= <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 同理以cb为基准，如果ca和cb叉乘结果再点乘&gt;0表示a和b在cd同一侧</span></span><br><span class="line">    <span class="keyword">var</span> ca = a - c;</span><br><span class="line">    <span class="keyword">var</span> cb = b - c;</span><br><span class="line">    <span class="keyword">var</span> cd = d - c;</span><br><span class="line">    <span class="keyword">if</span> (Vector3.Dot(Vector3.Cross(cd, ca), Vector3.Cross(cd, cb)) &gt;= <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如何计算交点:</p>
<ol>
<li>几何法分析出交点</li>
</ol>
<p>让我们直接看下结论:</p>
<p><img src="/img/Math/LineIntersectionFormula.png" alt="LineIntersectionFormula"></p>
<p><strong>这个结论主要是通过2D平面几何的相似三角形以及向量叉乘在的集合解释是平行四边形面积(两个三角形面积之和)推到而来的。</strong></p>
<p><img src="/img/Math/LineIntersectionPicture.png" alt="LineIntersectionPicture"></p>
<p>详情推到参考:</p>
<p><a target="_blank" rel="noopener" href="http://www.laowangomg.com/?p=501">Unity3D C#数学系列之判断两条线段是否相交并求交点</a></p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 计算AB与CD两条线段的交点.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;a&quot;&gt;</span>A点<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;b&quot;&gt;</span>B点<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;c&quot;&gt;</span>C点<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;d&quot;&gt;</span>D点<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;intersectPos&quot;&gt;</span>AB与CD的交点<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>是否相交 true:相交 false:未相交<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">bool</span> <span class="title">GetIntersectPoint</span>(<span class="params">Vector2 a, Vector2 b, Vector2 c, Vector2 d, <span class="keyword">out</span> Vector2 intersectPos</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    intersectPos = Vector2.zero;</span><br><span class="line">    <span class="comment">// Note:</span></span><br><span class="line">    <span class="comment">// 1. 2D向量不需要判定共面</span></span><br><span class="line">    <span class="keyword">if</span> (!IsCross(a, b, c, d))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 根据推到结论</span></span><br><span class="line">    <span class="comment">// AO / AB = Cross(CA, CD) / Cross(CD, AB)</span></span><br><span class="line">    <span class="comment">// O = A + Cross(CA, CD) / Cross(CD, AB) * AB</span></span><br><span class="line">    <span class="keyword">var</span> ab = b - a;</span><br><span class="line">    <span class="keyword">var</span> ca = a - c;</span><br><span class="line">    <span class="keyword">var</span> cd = d - c;</span><br><span class="line">    Vector3 v1 = Vector3.Cross(ca, cd);</span><br><span class="line">    Vector3 v2 = Vector3.Cross(cd, ab);</span><br><span class="line">    <span class="built_in">float</span> ratio = Vector3.Dot(v1, v2) / v2.sqrMagnitude;</span><br><span class="line">    intersectPos = a + ab * ratio;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/img/Math/LineIntersectionPointCapture.PNG" alt="LineIntersectionPointCapture"></p>
<p>可以看到我们成功可视化算出了两条线段相交的点。</p>
<p>那么如果我们不考虑两条线段相交，单纯想求得两个线段(包含延长线)上的交点时，应该怎么计算了？</p>
<p><strong>实际上相似三角形的推论即使两个线段不相交也是成立的，所以我们唯一要确保的就是两个线段不平行，只有两个线段不平行才有交点。所以我们不需要判定线段两个点是否在两侧只需判定两个线段是否平行，剩下的步骤和之前一致即可。</strong></p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 4个点是否ab和cd线段是否平行</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;a&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;b&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;c&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;d&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">bool</span> <span class="title">IsParallel</span>(<span class="params">Vector2 a, Vector2 b, Vector2 c, Vector2 d</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 通过叉乘计算AB和CD是否为0判定是否平行</span></span><br><span class="line">    <span class="keyword">var</span> ab = b - a;</span><br><span class="line">    <span class="keyword">var</span> cd = d - c;</span><br><span class="line">    <span class="keyword">return</span> Mathf.Approximately(Vector2Utilities.Cross(ab, cd), Mathf.Epsilon);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 计算AB与CD两条线段的交点(包含衍生直线)</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;a&quot;&gt;</span>A点<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;b&quot;&gt;</span>B点<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;c&quot;&gt;</span>C点<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;d&quot;&gt;</span>D点<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;intersectPos&quot;&gt;</span>AB与CD的交点<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>是否相交 true:相交 false:未相交<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">bool</span> <span class="title">GetLineIntersectPoint</span>(<span class="params">Vector2 a, Vector2 b, Vector2 c, Vector2 d, <span class="keyword">out</span> Vector2 intersectPos</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    intersectPos = Vector2.zero;</span><br><span class="line">    <span class="comment">// Note:</span></span><br><span class="line">    <span class="comment">// 1. 2D向量不需要判定共面</span></span><br><span class="line">    <span class="keyword">if</span> (IsParallel(a, b, c, d))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 根据推到结论</span></span><br><span class="line">    <span class="comment">// AO / AB = Cross(CA, CD) / Cross(CD, AB)</span></span><br><span class="line">    <span class="comment">// O = A + Cross(CA, CD) / Cross(CD, AB) * AB</span></span><br><span class="line">    <span class="keyword">var</span> ab = b - a;</span><br><span class="line">    <span class="keyword">var</span> ca = a - c;</span><br><span class="line">    <span class="keyword">var</span> cd = d - c;</span><br><span class="line">    Vector3 v1 = Vector3.Cross(ca, cd);</span><br><span class="line">    Vector3 v2 = Vector3.Cross(cd, ab);</span><br><span class="line">    <span class="built_in">float</span> ratio = Vector3.Dot(v1, v2) / v2.sqrMagnitude;</span><br><span class="line">    intersectPos = a + ab * ratio;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/img/Math/LineIntersectionPoint2Capture.PNG" alt="LineIntersectionPoint2Capture"></p>
<p>可以看到我们通过不判定线段点是否在两侧，只判定平时依然计算出了两个线段在延长线上的交点。</p>
<h1 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h1><p>待添加……</p>
<h1 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h1><ul>
<li><p><strong>复杂的3D碰撞检测我们可以映射到2D来简化运算量实现相同的效果</strong></p>
</li>
<li><p><strong>能够用简单的形状实现效果尽量用简单的形状来实现避免过于复杂的碰撞检测判定</strong></p>
</li>
<li><p><strong>在坐标平移旋转转换时注意先旋转后平移，不然先平移后旋转会导致坐标转换错误，因为先旋转后平移!&#x3D;先平移后旋转</strong></p>
</li>
</ul>
<h1 id="Github"><a href="#Github" class="headerlink" title="Github"></a>Github</h1><p><a target="_blank" rel="noopener" href="https://github.com/TonyTang1990/CollisionDetectionStudy">CollisionDetectionStudy</a></p>
<h1 id="学习总结"><a href="#学习总结" class="headerlink" title="学习总结"></a>学习总结</h1><ol>
<li><strong>2D图形相交检测更多的是平面几何知识，通过将图形转换成纯数学定义来求解</strong></li>
<li><strong>向量里的点乘叉乘对于求解向量的角度和旋转方向以及两个向量的相对位置很有用</strong></li>
</ol>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_37043683/article/details/80375691?utm_medium=distribute.pc_relevant.none-task-blog-baidujs_title-1&spm=1001.2101.3001.4242">【Unity】图形相交检测</a></p>
<p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Games/Techniques/3D_collision_detection">3D 碰撞检测</a></p>
<p><a target="_blank" rel="noopener" href="https://www.gameres.com/803677.html">Unity3D-游戏中的技能碰撞检测</a></p>
<p>[<a target="_blank" rel="noopener" href="https://www.cnblogs.com/lyggqm/p/5386174.html">包围盒]球，AABB，OBB</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/flj135792468/article/details/120759839">UNITY实战进阶-OBB包围盒详解-6</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/luoyikun/article/details/115485938?utm_medium=distribute.pc_aggpage_search_result.none-task-blog-2~aggregatepage~first_rank_ecpm_v1~rank_v31_ecpm-3-115485938.pc_agg_new_rank&utm_term=unity%E4%B8%A4%E4%B8%AA%E5%90%91%E9%87%8F%E4%BA%A4%E7%82%B9%E6%80%8E%E4%B9%88%E6%B1%82&spm=1000.2123.3001.4430">unity3d：两条线段相交并求交点坐标</a></p>
<p><a target="_blank" rel="noopener" href="http://www.laowangomg.com/?p=501">Unity3D C#数学系列之判断两条线段是否相交并求交点</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Collision/">Collision</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Collision/">Collision</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2020/09/12/行为树-Unity/" title="行为树-Unity" itemprop="url">行为树-Unity</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Tony Tang" target="_blank" itemprop="author">Tony Tang</a>
		
  <p class="article-time">
    <time datetime="2020-09-12T13:47:46.000Z" itemprop="datePublished"> 发表于 2020-09-12</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>本章节博客是在项目需求设计支持Lua AI系统的前提下，驱动深入学习行为树设计实现。关于AI的相关基础概念学习可以参考:<a href="http://tonytang1990.github.io/2015/10/14/Artificial-Inteligence-Study/#Programming_Game_AI_by_Example">Programming Game AI by Example</a>。而本章节的重点就是行为树，最终目的是实现一份Unity里能够支持项目级使用的支持Lua测使用AI的行为树框架设计。源代码考虑到公司正在使用所以暂时不放源码，大家可以参考设计思路自行实现。</p>
<h2 id="行为树"><a href="#行为树" class="headerlink" title="行为树"></a>行为树</h2><h3 id="行为树介绍"><a href="#行为树介绍" class="headerlink" title="行为树介绍"></a>行为树介绍</h3><p>行为树首先要知道的一点，是一颗树形结构，树里包含控制决策走向的控制节点和负责展示表现的叶子结点。</p>
<p>行为树抽象一个角色的简单AI角色逻辑如下：<br><img src="/img/AI/BehaviorTreeHierachy.png" alt="BehaviorTreeHierachy"></p>
<p>优点：</p>
<ol>
<li>可视化决策逻辑</li>
<li>可复用控制节点</li>
<li>逻辑和实现低耦合(叶子结点才是与上层逻辑挂钩的)</li>
</ol>
<h4 id="节点分类"><a href="#节点分类" class="headerlink" title="节点分类"></a>节点分类</h4><p>从设计上来说节点功能划分为两类：</p>
<ol>
<li>决策节点(决定行为树走向的非叶子节点)</li>
<li>行为节点(叶子节点决定最后的行为表现)</li>
</ol>
<p>决策节点分类：</p>
<ol>
<li>组合节点(序列节点(相当于and)、选择节点(相当于or)、并行节点(相当于for循环)等)</li>
<li>装饰节点(可以作为某种节点的一种额外的附加条件，如允许次数限制，时间限制，错误处理等。Note:<strong>装饰节点只有一个子节点</strong>)</li>
</ol>
<p>行为节点分类：</p>
<ol>
<li>条件节点(控制节点结果)</li>
<li>动作节点(实际的行为表现)</li>
</ol>
<h4 id="节点状态"><a href="#节点状态" class="headerlink" title="节点状态"></a>节点状态</h4><p>所有的节点都有三种状态：</p>
<ol>
<li>运行中(Running)</li>
<li>运行完毕(Success &#x2F; Failed)</li>
<li>无效(Invalide)</li>
</ol>
<p>正是通过上面的三种状态来实现行为树的行为决策的(所有节点都有返回状态)</p>
<h4 id="节点选择"><a href="#节点选择" class="headerlink" title="节点选择"></a>节点选择</h4><p>决策控制选择节点时需要有依据，这里的依据可以看做是选择某个节点的一个前提条件(Precondition)，前提可以让我们快速判定分支避免不必要的子节点判定。控制节点相当于默认返回True，叶子节点可以作为选择节点的依据。</p>
<p>关于节点选择更多的优化(e.g. 1. 带优先级的选择 2. 带权值的选择……)参考：</p>
<p><a target="_blank" rel="noopener" href="http://www.aisharing.com/archives/99">行为树（Behavior Tree）实践（2）– 进一步的讨论</a></p>
<p><strong>Note:</strong><br><strong>这里考虑到前置条件等价于组合节点的第一个节点设置条件节点，所以最终实战实现里没有实现前置条件(Precondition)</strong></p>
<h4 id="行为树更新"><a href="#行为树更新" class="headerlink" title="行为树更新"></a>行为树更新</h4><p>行为树更新方案：<br>2. <strong>每次从上次运行的节点运行(打断时从根节点重新运行)</strong></p>
<h4 id="行为树中断"><a href="#行为树中断" class="headerlink" title="行为树中断"></a>行为树中断</h4><p>前面我们已经选择了方案2，这里就要考虑一下如何实现行为打断了。</p>
<p>从前面可以看出行为树节点是有Running状态的，也就是说只要满足子节点的层层条件后，可以持续执行一段时间(比如寻找目标地点寻路过去这段时间都是Running)。</p>
<p>试想一下游戏过程中所有的条件数据都是在实时变化的，执行寻找目标地点的条件可以在任何时候出现条件不满足的情况，那么我们如何打断正在执行的Running节点，让行为树判定执行一条符合条件的行为分支了？</p>
<p>通过了解，BehaviorDesigner里存在4中类型的中断：</p>
<ol>
<li>None</li>
<li>Self</li>
<li>Lower Priority</li>
<li>Both</li>
</ol>
<p>详情参考:<a target="_blank" rel="noopener" href="https://blog.csdn.net/FireworksFlower/article/details/99655101">行为树 中断的理解</a></p>
<p>核心都是通过标识决策节点的打断类型以及配合设置相应条件节点来实现额外的条件判定，从而实现其他子节点运行时也可以动态判定其他节点条件来实现打断运行节点。</p>
<p>BehaviorDesigner节点有抽象出节点优先级概念(大概就是树形结构的层级顺序优先级)。</p>
<p>这里只是为了实现一个简易版的行为树，所以就不实现那么复杂的打断机制了。</p>
<p>方案：<br><strong>行为树运行时记录运行时跑过的需要重新评估的节点的运行结果状态(现阶段主要是指条件节点)，每一次从根节点运行时都判定需要重新评估的节点运行状态是否有变化，有变化表示条件有变行为树需要打断执行。</strong></p>
<h3 id="为什么使用行为树"><a href="#为什么使用行为树" class="headerlink" title="为什么使用行为树"></a>为什么使用行为树</h3><p>从<a href="http://tonytang1990.github.io/2015/10/14/Artificial-Inteligence-Study/#Programming_Game_AI_by_Example">Programming Game AI by Example</a>的介绍里可以看到相比状态机(FSM)行为树有以下几个好处:</p>
<ol>
<li>使用行为树解决了状态机(FSM)过于复杂后维护成本高不利于扩展的问题。</li>
<li>行为树决策节点重用性高</li>
<li>行为树可视化编辑器能高效的查看行为树执行情况</li>
</ol>
<h3 id="行为树实战"><a href="#行为树实战" class="headerlink" title="行为树实战"></a>行为树实战</h3><p>目标：</p>
<ol>
<li>实现一套可用于项目级别使用的支持Lua版编写AI的Unity行为树(深入理解行为树的原理和实现)</li>
</ol>
<p>设计：</p>
<ol>
<li>使用黑板模式作为单颗行为树的数据中心解决方案</li>
<li>使用Unity原生API实现行为树节点编辑器，支持高效方便的行为树编辑导出调试工具</li>
<li>使用Json(至于性能问题未来可选择高效的Json库，这里主要看中Json的可读性)作为行为树数据序列化反序列化方案</li>
<li>使用C#开发一套兼容CS和Lua的行为树框架(方便未来直接用于作为CS测的行为树解决方案)，兼容Lua的核心思想是参数由string序列化，行为树节点反序列化构建时自行解析。</li>
<li>支持暂停，打断以及加载不同行为树Json的行为树框架</li>
<li>支持条件节点状态变化级别的行为树打断设计</li>
</ol>
<h4 id="数据管理"><a href="#数据管理" class="headerlink" title="数据管理"></a>数据管理</h4><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/KillerAery/p/10054558.html">黑板模式</a></p>
<p>可以简单的理解成一个共享数据的地方，核心设计是一个K-V结构的Map容器(结合泛型的设计支持不同类型的数据访问)，通过统一的数据访问方式实现行为树统一的数据访问。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> 黑板模式，数据共享中心</span></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Blackboard</span></span><br><span class="line">   &#123;</span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> 黑板数据集合中心</span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">       <span class="keyword">protected</span> Dictionary&lt;<span class="built_in">string</span>, IBlackboardData&gt; mBlackboardDataMap;</span><br><span class="line"></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="title">Blackboard</span>()</span></span><br><span class="line">       &#123;</span><br><span class="line">           mBlackboardDataMap = <span class="keyword">new</span> Dictionary&lt;<span class="built_in">string</span>, IBlackboardData&gt;();</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> 添加黑板数据</span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;key&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;data&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">AddData</span>(<span class="params"><span class="built_in">string</span> key, IBlackboardData data</span>)</span></span><br><span class="line">       &#123;</span><br><span class="line">           IBlackboardData <span class="keyword">value</span>;</span><br><span class="line">           <span class="keyword">if</span>(!mBlackboardDataMap.TryGetValue(key, <span class="keyword">out</span> <span class="keyword">value</span>))</span><br><span class="line">           &#123;</span><br><span class="line">               mBlackboardDataMap.Add(key, data);</span><br><span class="line">               <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">else</span></span><br><span class="line">           &#123;</span><br><span class="line">               Debug.LogError(<span class="built_in">string</span>.Format(<span class="string">&quot;黑板数据里已存在Key:&#123;0&#125;的数据，添加数据失败!&quot;</span>, key));</span><br><span class="line">               <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> 移除黑板数据</span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;key&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">RemoveData</span>(<span class="params"><span class="built_in">string</span> key</span>)</span></span><br><span class="line">       &#123;</span><br><span class="line">           <span class="keyword">return</span> mBlackboardDataMap.Remove(key);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> 获取指定黑板数据</span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;typeparam name=&quot;T&quot;&gt;</span><span class="doctag">&lt;/typeparam&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;key&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">       <span class="function"><span class="keyword">public</span> T <span class="title">GetData</span>&lt;<span class="title">T</span>&gt;(<span class="params"><span class="built_in">string</span> key</span>)</span></span><br><span class="line">       &#123;</span><br><span class="line">           <span class="keyword">var</span> <span class="keyword">value</span> = GetBlackboardData(key);</span><br><span class="line">           <span class="keyword">if</span> (<span class="keyword">value</span> != <span class="literal">null</span>)</span><br><span class="line">           &#123;</span><br><span class="line">               <span class="keyword">return</span> (<span class="keyword">value</span> <span class="keyword">as</span> BlackboardData&lt;T&gt;).Data;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">else</span></span><br><span class="line">           &#123;</span><br><span class="line">               Debug.LogError(<span class="string">&quot;返回默认值!&quot;</span>);</span><br><span class="line">               <span class="keyword">return</span> <span class="literal">default</span>(T);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> 更新黑板数据</span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;typeparam name=&quot;T&quot;&gt;</span><span class="doctag">&lt;/typeparam&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;key&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;data&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">UpdateData</span>&lt;<span class="title">T</span>&gt;(<span class="params"><span class="built_in">string</span> key, T data</span>)</span></span><br><span class="line">       &#123;</span><br><span class="line">           <span class="keyword">var</span> <span class="keyword">value</span> = GetBlackboardData(key);</span><br><span class="line">           <span class="keyword">if</span>(<span class="keyword">value</span> != <span class="literal">null</span>)</span><br><span class="line">           &#123;</span><br><span class="line">               (<span class="keyword">value</span> <span class="keyword">as</span> BlackboardData&lt;T&gt;).Data = data;</span><br><span class="line">               <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">else</span></span><br><span class="line">           &#123;</span><br><span class="line">               Debug.LogError(<span class="built_in">string</span>.Format(<span class="string">&quot;更新Key:&#123;0&#125;的数据失败!&quot;</span>, key));</span><br><span class="line">               <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> 清除黑板数据</span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ClearData</span>()</span></span><br><span class="line">       &#123;</span><br><span class="line">           mBlackboardDataMap.Clear();</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> 获取黑板指定数据</span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;key&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">       <span class="function"><span class="keyword">private</span> IBlackboardData <span class="title">GetBlackboardData</span>(<span class="params"><span class="built_in">string</span> key</span>)</span></span><br><span class="line">       &#123;</span><br><span class="line">           IBlackboardData <span class="keyword">value</span>;</span><br><span class="line">           <span class="keyword">if</span> (!mBlackboardDataMap.TryGetValue(key, <span class="keyword">out</span> <span class="keyword">value</span>))</span><br><span class="line">           &#123;</span><br><span class="line">               Debug.LogError(<span class="built_in">string</span>.Format(<span class="string">&quot;找不到Key:&#123;0&#125;的黑板数据!&quot;</span>, key));</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">value</span>;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> 黑板数据接口抽象</span></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IBlackboardData</span></span><br><span class="line">   &#123;</span><br><span class="line"></span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> 黑板数据泛型基类</span></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BlackboardData</span>&lt;<span class="title">T</span>&gt; : <span class="title">IBlackboardData</span></span><br><span class="line">   &#123;</span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> 数据</span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">       <span class="keyword">public</span> T Data</span><br><span class="line">       &#123;</span><br><span class="line">           <span class="keyword">get</span>;</span><br><span class="line">           <span class="keyword">set</span>;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="title">BlackboardData</span>(<span class="params">T data</span>)</span></span><br><span class="line">       &#123;</span><br><span class="line">           Data = data;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">#<span class="keyword">region</span> 黑板数据常用数据类型定义</span></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> 黑板数据整形数据</span></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">IntBlackboardData</span> : <span class="title">BlackboardData</span>&lt;<span class="title">int</span>&gt;</span><br><span class="line">   &#123;</span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="title">IntBlackboardData</span>(<span class="params"><span class="built_in">int</span> data</span>) : <span class="title">base</span>(<span class="params">data</span>)</span></span><br><span class="line">       &#123;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">......</span><br><span class="line">   <span class="meta">#<span class="keyword">endregion</span></span></span><br></pre></td></tr></table></figure>

<p>这里具体的黑板数据类型支持通过集成BlackboardData即可，这里就不放全部代码了。</p>
<p><strong>黑板模式这里用于实现自定义变量并支持修改和读取判定，用于实现自定义变量控制AI逻辑。</strong><br>黑板模式实现效果如下:<br><img src="/img/AI/BehaviourTree/CustomVariableNodes.png" alt="自定义变量节点"><br><img src="/img/AI/BehaviourTree/CustomVariableInspector.png" alt="自定义变量参数面板"><br><img src="/img/AI/BehaviourTree/AllCustomVariableInspector.png" alt="所有自定义变量展示面板"></p>
<h4 id="节点编辑器"><a href="#节点编辑器" class="headerlink" title="节点编辑器"></a>节点编辑器</h4><p>关于节点编辑器，核心要了解Unity以下几个API:</p>
<ol>
<li>Event – UnityGUI事件响应编写接口类<br> <img src="/img/AI/BehaviourTree/GenericMenu.png" alt="节点编辑器操作响应"></li>
<li>GUILayout.BeginArea() GUILayout.Toolbar() GUILayout.EndArea() EditorGUILayout.*** – GUI自定义面板UI显示接口<br> <img src="/img/AI/BehaviourTree/BTOperationPanel.png" alt="节点编辑器操作面板"></li>
<li>GenericMenu – Unity编写自定义菜单的类<br> <img src="/img/AI/BehaviourTree/GenericMenu.png" alt="行为树编辑器菜单"></li>
<li>BeginWindows() GUI.Window() EndWindows() GUI.DragWindow() – Unity编写节点窗口的类(支持拖拽的节点)<br> <img src="/img/AI/BehaviourTree/BTEditorNode.png" alt="行为树节点窗口"></li>
<li>Handles.DrawBezier() – 绘制节点曲线(Bezier曲线)连接线的接口<br> <img src="/img/AI/BehaviourTree/BTNodeConnectLine.png" alt="行为树节点连线"></li>
<li>JsonUtility.ToJson() JsonUtility.FromJson<T>() – Unity Json数据序列化反序列化存储<br> <img src="/img/AI/BehaviourTree/BTJsonData.png" alt="行为树序列化反序列化存储"></li>
</ol>
<p>结合上面几个核心类，最终实现行为树节点编辑器效果图如下:<br><img src="/img/AI/BehaviourTree/BTNodeEditor.png" alt="行为树节点编辑器效果展示"></p>
<h4 id="行为树框架"><a href="#行为树框架" class="headerlink" title="行为树框架"></a>行为树框架</h4><p>这里考虑项目正在使用，所以不方便放出源码，通过给出行为树的UML类图设计，大家可以参考思路自行实现(因为UML比较大所以分了两张图):<br><img src="/img/AI/BehaviourTree/BehaviourTreeUML1.png" alt="行为树UML类图1"><br><img src="/img/AI/BehaviourTree/BehaviourTreeUML2.png" alt="行为树UML类图2"></p>
<h4 id="行为树打断"><a href="#行为树打断" class="headerlink" title="行为树打断"></a>行为树打断</h4><p>这里单独谈谈行为树的打断实现，在BehaviourDesigner里行为树的打断设计相对比较复杂，详情可以参考:<br><a target="_blank" rel="noopener" href="https://blog.csdn.net/u012632851/article/details/89647097">Unity3D Behavior Designer 行为树4 打断机制的实现</a></p>
<p>而这里实现的行为树打断是一种较为简单打断方式，就是在每棵行为树重新从根节点开始执行时，记录执行过的节点以及需要重新判定的节点以及状态，在下一次从根节点运行时执行需要重新判定的节点是否有状态变化来判定是否需要打断行为树Running等执行状态。而需要打断的节点是从上一次记录的执行过的节点里执行结果为Running的才需要打断，其他状态不用打断。</p>
<p>行为树驱动执行代码大致如下:<br>BTGraph.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 更新</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">OnUpdate</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (RootNode != <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 根节点处于非成功和失败状态(一般来说是Running)</span></span><br><span class="line">        <span class="keyword">if</span> (!RootNode.IsTerminated)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 节点处于非运行时需要清除上一次运行数据</span></span><br><span class="line">            <span class="keyword">if</span>(!RootNode.IsRunning)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 清除上一次运行数据(比如执行过的节点和需要重新评估的节点数据)</span></span><br><span class="line">                ClearRunningDatas();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 重新评估需要重新判定的节点，看状态是否有变化</span></span><br><span class="line">            <span class="keyword">if</span> (ReevaluatedExecutedNodes())</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 重新判定节点运行结果有变化需要重置运行节点重新判定</span></span><br><span class="line">                DoAbortBehaviourTree();</span><br><span class="line">            &#125;</span><br><span class="line">            RootNode.OnUpdate();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 根节点处于成功或失败状态</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 清除上一次运行数据(比如执行过的节点和需要重新评估的节点数据)</span></span><br><span class="line">            ClearRunningDatas();</span><br><span class="line">            <span class="comment">// 重新评估需要重新判定的节点，看状态是否有变化</span></span><br><span class="line">            <span class="keyword">if</span> (ReevaluatedExecutedNodes())</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 重新判定节点运行结果有变化需要重置运行节点重新判定</span></span><br><span class="line">                DoAbortBehaviourTree();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 判定行为树单次执行完后是否需要自动重启下一次执行</span></span><br><span class="line">            <span class="keyword">if</span> (OwnerBT.RestartWhenComplete)</span><br><span class="line">            &#123;</span><br><span class="line">                RootNode.OnUpdate();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 执行终止行为树</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">DoAbortBehaviourTree</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    Debug.Log(<span class="string">&quot;DoAbortBehaviourTree()&quot;</span>);</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="keyword">var</span> executingnode <span class="keyword">in</span> ExecutingNodesMap)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 只有执行中的节点需要打断(避免执行完成的节点二次打断)</span></span><br><span class="line">        <span class="keyword">if</span>(executingnode.Value.IsRunning)</span><br><span class="line">        &#123;</span><br><span class="line">            executingnode.Value.OnConditionalAbort();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ClearRunningDatas();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>而动态打断机制是通过指定特定节点(比如当前博主只支持条件节点)是否支持参与重新打断判定实现的。<br>BTBaseConditionNode.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 是否可被重新评估</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="built_in">bool</span> <span class="title">CanReevaluate</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> AbortType == EAbortType.Self;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>公司项目没有继续做了，项目开源了:</p>
<p><a target="_blank" rel="noopener" href="https://github.com/TonyTang1990/BehaviourTreeForLua">BehaviourTreeForLua</a></p>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a target="_blank" rel="noopener" href="http://www.aisharing.com/archives/90">行为树（Behavior Tree）实践（1）– 基本概念</a><br><a target="_blank" rel="noopener" href="http://www.aisharing.com/archives/99">行为树（Behavior Tree）实践（2）– 进一步的讨论</a><br><a target="_blank" rel="noopener" href="http://www.aisharing.com/archives/517">用800行代码做个行为树（Behavior Tree）的库（1）</a><br><a target="_blank" rel="noopener" href="http://www.aisharing.com/archives/522">用800行代码做个行为树（Behavior Tree）的库（2）</a><br><a target="_blank" rel="noopener" href="https://www.veinin.com/2018/08/07/ai_behavior_tree_design_and_implementation_01/">AI 行为树设计与实现-理论篇</a><br><a target="_blank" rel="noopener" href="https://domicat.me/2017/03/behavior-tree-1/">行为树及其实现</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_31850729/article/details/69944324">unity 行为树 简单实现</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/fg5823820/article/details/8750606">基于Unity行为树设计与实现的尝试</a><br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/KillerAery/p/10054558.html">游戏设计模式——黑板模式</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/u012632851/article/details/89647097">Unity3D Behavior Designer 行为树4 打断机制的实现</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/AI/">AI</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/AI/">AI</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2020/06/08/Unity滚动列表/" title="Unity滚动列表" itemprop="url">Unity滚动列表</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Tony Tang" target="_blank" itemprop="author">Tony Tang</a>
		
  <p class="article-time">
    <time datetime="2020-06-08T14:37:17.000Z" itemprop="datePublished"> 发表于 2020-06-08</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>多年使用Unity经验的朋友对于列表单元肯定很熟悉，每个公司也都有着自己的一套单元格设计。本章节博客着重学习Unity里列表单元格框架的设计和实现，深入学习不同单元格框架的设计优劣。</p>
<h2 id="列表"><a href="#列表" class="headerlink" title="列表"></a>列表</h2><p>什么是列表了？<br>可以滚动，支持创建多个基于特定模板显示的单元格容器。</p>
<p>列表的功能需求(**(√)**表示本人已经实现的部分)？</p>
<ol>
<li>滚动显示(支持滚动到指定位置)<strong>(√)</strong></li>
<li>动态添加(支持任何位置添加元素)<strong>(√)</strong></li>
<li>循环列表(支持从头滚到尾再接着滚动到头的循环方式)</li>
<li>不同大小单元格显示(支持自适应大小或者自定义传单元格大小)<strong>(√)</strong></li>
<li>多种列表类型显示(e.g. 横向,竖向，横向网格，竖向网格等)<strong>(√)</strong></li>
<li>单元格构造自定义传参**(√)**</li>
<li>自定义滚动动画**(√)**</li>
<li>不同单元格朝向(e.g. 从左往右或从右往左。从上往下或者从下往上。)<strong>(√)</strong></li>
<li>单元格矫正(最终单元格会滚动到某个最近的单元格位置)<strong>(√)</strong></li>
<li>单元格对象池(e.g. 单元格逻辑对象(Object)对象池。单元格实体对象(GameObject)对象池。)<strong>(√)</strong></li>
<li>单元格嵌套滚动(e.g. 嵌套不同方向的单元格容器滚动支持)<strong>(√)</strong></li>
<li>本地单元格模拟创建查看效果(e.g. Inspector支持快速模拟查看排版等)<strong>(√)</strong></li>
</ol>
<h2 id="单元格容器"><a href="#单元格容器" class="headerlink" title="单元格容器"></a>单元格容器</h2><p>这里关于单元格容器，这里主要实现了两套:</p>
<ol>
<li>支持不同滚动方向不同初始化朝向支持不同大小(手动传Size或者自动计算Size)嵌套滚动单元格的一套通用单元格容器。</li>
<li>支持两侧深度滚动显示的单元格容器(这一套实现的效果比较特别所以单独实现的)<br><strong>其中本人主要以第一套(以前在公司学习到的一套实现方案，后来在此基础上扩展支持了很多功能)为重点来学习实战。</strong></li>
</ol>
<h3 id="单元格实现分析"><a href="#单元格实现分析" class="headerlink" title="单元格实现分析"></a>单元格实现分析</h3><p>这里通过学习了解市面上常见的单元格实现来了解常见的单元格实现方案：</p>
<h4 id="LoopScrollRect"><a href="#LoopScrollRect" class="headerlink" title="LoopScrollRect"></a>LoopScrollRect</h4><p><a target="_blank" rel="noopener" href="https://github.com/qiankanglai/LoopScrollRect">LoopScrollRect</a><br>这一套是<a target="_blank" rel="noopener" href="http://qiankanglai.me/2015/08/15/LoopScrollRect/">钱康来</a>大佬编写分享的一套支持循环列表的实现方案。<br>通过查看源码，可以了解到，这一套实现核心是基于ContentSizeFitter，LayoutGroup和LayoutElement相关组件来实现动态计算单元格位置显示循环滚动以及不同大小等效果的。<br><strong>亮点分析:</strong></p>
<ol>
<li>使用了原生Scroller，但并不依赖原生ScrolRect那套来计算滚动，这样为<strong>支持循环列表</strong>打下了基础。</li>
<li><strong>单元格位置数据与单元格逻辑对象分离</strong>，可以做到动态计算单元格显示时<strong>只有需要显示的才有逻辑单元格对象(避免New大量的单元格)</strong>。</li>
</ol>
<p><strong>缺点分析:</strong></p>
<ol>
<li>虽然基于LayoutGroup和LayoutElement，但并非正向通过他们的排版功能得到不同单元格大小显示，而是反向设置LayoutElement来通过LayoutUtility.GetPreferredHeight()等接口方法来实现正确的计算滚动排版。<strong>这儿也就意味着做不到自动计算单元格大小的功能。</strong></li>
<li>单元格显示是通过SendMessage的形式触发，感觉这种方式效率可能不如直接调用接口方法来的快(个人感觉)。<br>核心获取单元格大小的代码：</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="built_in">float</span> <span class="title">GetSize</span>(<span class="params">RectTransform item</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">float</span> size = contentSpacing;</span><br><span class="line">    <span class="keyword">if</span> (m_GridLayout != <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        size += m_GridLayout.cellSize.y;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        size += LayoutUtility.GetPreferredHeight(item);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> size;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>单元格初始化显示触发代码:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">ProvideData</span>(<span class="params">Transform transform, <span class="built_in">int</span> idx</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    transform.SendMessage(<span class="string">&quot;ScrollCellIndex&quot;</span>, idx);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="FancyScrollView"><a href="#FancyScrollView" class="headerlink" title="FancyScrollView"></a>FancyScrollView</h4><p><a target="_blank" rel="noopener" href="https://github.com/setchi/FancyScrollView">FancyScrollView</a><br><img src="/img/Unity/CellContainer/FancyScrollViewExhibition.png" alt="FancyScrollViewExhibition"><br>这一套是在UWA上看到的，貌似是日本开发者开发的。<br>通过上面的效果图可以看到，这一套实现了很强大的结合自定义动画或者Shader的单元格容器框架。<br>通过查看源代码可以发现，这一套非常强大的一点是通过自定义实现Scroller强大的滚动单元格容器需要的滚动相关的计算和回调支持。<br>上次代码只需要通过ScrollView和Scroller接口设置显示数据以及单元格模板等就能做到很好的单元格容器滚动效果。<br><strong>亮点分析:</strong></p>
<ol>
<li>没有依赖原生Scroller，自定义实现了Scroller，可以更加容易的支持循环列表。</li>
<li>动态计算显示与否是通过当前滚动到的位置来判定，而单元格位置信息并没有耦合到单元格对象里，这样可以做到逻辑对象数量等于最大可显示的数量。</li>
<li>更新显示回调(UpdatePosition)里有传入位置数据，可以基于位置数据做<strong>动画(Animator)或者Shader相关的表现展示</strong>。</li>
<li>不依赖于Scroller，LayoutGroup等组件，开销更低</li>
</ol>
<p><strong>缺点分析:</strong></p>
<ol>
<li><strong>单元格不支持不同大小</strong>，都是按预制件统一大小来计算</li>
</ol>
<h4 id="super-scrollview"><a href="#super-scrollview" class="headerlink" title="super-scrollview"></a>super-scrollview</h4><p><a target="_blank" rel="noopener" href="https://github.com/baba-s/ugui-super-scrollview-example">ugui-super-scrollview-example</a><br>这一套是Unity Asset Store里出售的一套滚动单元格插件。<br>让我们先来一张效果图展示：<br><img src="/img/Unity/CellContainer/SuperScrollViewExhibition.png" alt="SuperScrollViewExhibition"><br>从上面可以看到，SuperScrollView可以做到很多效果(e.g. 翻页，动态加载，动态大小变化，滚动到指定位置，动态增删单元格，不同朝向单元格容器显示……)<br>基本上能想到的单元格容器效果，这个插件都支持。<br>接下来让我们结合源码和实例来分析下这一套单元格容器的好坏:<br><strong>亮点分析:</strong></p>
<ol>
<li>单元格位置数据与逻辑对象分离，可以<strong>有效的减少逻辑单元格对象数量</strong>。</li>
<li>自定义的单元格大小抽象，可以<strong>方便的自定义传入不同大小的单元格并显示</strong>。</li>
<li>支持不同朝向的单元格容器显示(核心是反向初始化和计算单元格位置显示)</li>
</ol>
<p><strong>缺点分析:</strong></p>
<ol>
<li>使用了ScrollRect部分功能(特别是容器滚动部分)，这一点导致要做循环列表就很困难</li>
</ol>
<p><strong>后续本人的单元格容器很大程度上跟SuperScrollView更相近(指功能设计上而非代码设计)。</strong></p>
<h3 id="实战单元格容器"><a href="#实战单元格容器" class="headerlink" title="实战单元格容器"></a>实战单元格容器</h3><p>通过学习了解市面上的单元格容器实现，可以看到有几个比较重要的点：</p>
<ol>
<li><strong>不依赖于ScrollRect滚动，自定义分离单元格位置数据和单元格逻辑对象，是实现循环列表和减少逻辑单元格对象数量的关键。</strong></li>
<li><strong>大部分都不支持自动计算大小，需要手动计算传递单元格大小，相对来说没那么方便，但开销会小。</strong></li>
</ol>
<p>接下来让我们看看博主实战最终实现的效果(主要讲解第一套单元格):<br><img src="/img/Unity/CellContainer/LeftToRightScene.PNG" alt="LeftToRightScene"></p>
<p><img src="/img/Unity/CellContainer/TopToBottomScene.PNG" alt="TopToBottomScene"></p>
<p><img src="/img/Unity/CellContainer/HorizontalGalleryDemoScene.PNG" alt="HorizontalGalleryDemoScene"></p>
<p><img src="/img/Unity/CellContainer/ChatMessageListScene.PNG" alt="ChatMessageListScene"></p>
<p><img src="/img/Unity/CellContainer/ChangeItemSizeScene.PNG" alt="ChangeItemSizeScene"></p>
<p><img src="/img/Unity/CellContainer/ClickAndLoadMoreScene.PNG" alt="ClickAndLoadMoreScene"></p>
<p><img src="/img/Unity/CellContainer/GridViewScene.PNG" alt="GridViewScene"></p>
<p><img src="/img/Unity/CellContainer/PageViewScene.PNG" alt="PageViewScene"></p>
<p><img src="/img/Unity/CellContainer/SpinDatePickerScene.PNG" alt="SpinDatePickerScene"></p>
<p><img src="/img/Unity/CellContainer/SelectAndDeleteOrMoveScene.PNG" alt="SelectAndDeleteOrMoveScene"></p>
<p>上面展示了我支持的各类单元格容器，比如横向单元格容器，竖向单元格容器，横向网格单元格容器，竖向网格单元格容器，动态大小等各种用法。<br><img src="/img/Unity/CellContainer/DepthScrollExhibition.png" alt="DepthScrollExhibition"><br>第三章图主要展示的是另一套单元格容器，支持左右两侧指定深度滚动的单元格容器。</p>
<p>Note:</p>
<p>基于ContentSizeFitter和LayoutGroup的自动计算大小测试性能开销比较大最后决定不予支持了。</p>
<h4 id="深入讲解"><a href="#深入讲解" class="headerlink" title="深入讲解"></a>深入讲解</h4><p>让我们通过横向单元格的面板来大致了解下单元格都支持哪些功能：<br>!(HorizontalContainerInspector)(&#x2F;img&#x2F;Unity&#x2F;CellContainer&#x2F;HorizontalContainerInspector.png)<br>从面板上可以看出，博主的单元格容器主要支持了以下几个功能：</p>
<ol>
<li>单元格滚动自动矫正以及相关速度设置(最终确保滚动到单元格正中心位置)</li>
<li>支持不同朝向的单元格创建显示</li>
<li>支持嵌套单元格容器(不同朝向的单元格容器可以嵌套滚动)</li>
<li>支持单元格的间距和初始位置排版设置</li>
<li>支持设置多预制件用于绑定不同逻辑单元格对象显示在同一个单元格容器下</li>
<li>支持编辑器下快速模拟创建单元格查看排版</li>
</ol>
<p>单元格容器核心实现原理：</p>
<ol>
<li>通过手动传单元格大小或者自动计算单元格大小来得到每个单元格的大小数据</li>
<li>通过累加计算出总的可滚动Content大小，同时计算出单元格的抽象单元格位置</li>
<li>结合IBeginDragHandler, IDragHandler, IEndDragHandler接口来判定拖拽状态(比如是否开始或结束拖拽，拖拽方向等)，以及实现嵌套单元格的拖拽事件判定以及分发</li>
<li>Content结合ScrollRect来实现滚动回调(OnValueChanged)触发滚动计算判定，结合单元格的抽象位置来判定每个单元格的显隐状态。同时判定是否满足单元格矫正条件</li>
<li>通过IEndDragHandler响应结束拖拽时判定是否需要执行单元格矫正</li>
<li>向上层暴露OnShow,OnVisibleScroll,MoveTOIndex,OnHide等接口来实现单元格逻辑流程显示回收(BaseScrollContainer:bindContainerCallBack()接口传递)</li>
</ol>
<p>结合UML类图来理解下单元格容器的设计:<br><img src="/img/Unity/CellContainer/CellContainerUML.png" alt="CellContainerUML"></p>
<p>首先先放一段完整的创建单元格显示的事例代码，后续会一一讲解具体实现细节流程:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">RightToLeftContainer.bindContainerCallBack(onCellShow);</span><br><span class="line">  RightToLeftContainer.setCellDatasByCellCount(<span class="number">20</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> 单元格显示回调</span></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;cellindex&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;cellinstance&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onCellShow</span>(<span class="params"><span class="built_in">int</span> cellindex, GameObject cellinstance</span>)</span></span><br><span class="line">  &#123;</span><br><span class="line">      <span class="keyword">var</span> toptobottomcell = cellinstance.GetComponent&lt;ShowCellIndexCell&gt;();</span><br><span class="line">      <span class="keyword">if</span> (toptobottomcell == <span class="literal">null</span>)</span><br><span class="line">      &#123;</span><br><span class="line">          toptobottomcell = cellinstance.AddComponent&lt;ShowCellIndexCell&gt;();</span><br><span class="line">      &#125;</span><br><span class="line">      toptobottomcell.<span class="keyword">init</span>(cellindex);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>接下来让我们看看单元格容器的细节实现：<br>CellData.cs（<strong>单元格相关抽象</strong>）</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CellData</span> : <span class="title">IRecycle</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 当前Cell索引</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> CellIndex</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 拥有者单元格</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">protected</span> BaseScrollContainer mOwnerContainer;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Cell实例对象</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> GameObject CellGO</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Cell实例对象的RectTransform</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> RectTransform CellGORectTransform</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 单元格大小(宽和高)</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> Vector2 mCellSize;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 单元格预制件索引</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> CellPrefabIndex</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//Debug.Log(&quot;NewCellData:onCreate()&quot;);</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDispose</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//Debug.Log(&quot;NewCellData:onDispose()&quot;);</span></span><br><span class="line">        CellIndex = <span class="number">-1</span>;</span><br><span class="line">        mOwnerContainer = <span class="literal">null</span>;</span><br><span class="line">        CellGO = <span class="literal">null</span>;</span><br><span class="line">        CellGORectTransform = <span class="literal">null</span>;</span><br><span class="line">        CellPrefabIndex = <span class="number">-1</span>;</span><br><span class="line">        mCellSize = Vector2.zero;</span><br><span class="line">        mRectPos = Vector2.zero;</span><br><span class="line">        mRectAbsPos = Vector2.zero;</span><br><span class="line">        CellRect.Set(<span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">0.0f</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CellData</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        CellIndex = <span class="number">-1</span>;</span><br><span class="line">        mOwnerContainer = <span class="literal">null</span>;</span><br><span class="line">        CellGO = <span class="literal">null</span>;</span><br><span class="line">        CellGORectTransform = <span class="literal">null</span>;</span><br><span class="line">        CellPrefabIndex = <span class="number">-1</span>;</span><br><span class="line">        mCellSize = Vector2.zero;</span><br><span class="line">        mRectPos = Vector2.zero;</span><br><span class="line">        mRectAbsPos = Vector2.zero;</span><br><span class="line">        CellRect.Set(<span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">0.0f</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 初始化单元格实例对象</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;cellinstance&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span>(<span class="params">GameObject cellinstance</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(cellinstance != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            CellGO = cellinstance;</span><br><span class="line">            <span class="comment">// 不同单元格容器公用同一个模板对象可能会出现锚点不一致问题，所以每次强制设置</span></span><br><span class="line">            CellGORectTransform = CellGO.transform <span class="keyword">as</span> RectTransform;</span><br><span class="line">            CellGORectTransform.anchorMax = AnchorMax;</span><br><span class="line">            CellGORectTransform.anchorMin = AnchorMin;</span><br><span class="line">            CellGORectTransform.pivot = Pivot;</span><br><span class="line">            updateCellSizeAndPosition();</span><br><span class="line">            <span class="keyword">if</span> (!CellGO.activeSelf)</span><br><span class="line">            &#123;</span><br><span class="line">                CellGO.SetActive(<span class="literal">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            CellGO = <span class="literal">null</span>;</span><br><span class="line">            CellGORectTransform = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Cell数据清除</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">clear</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mOwnerContainer = <span class="literal">null</span>;</span><br><span class="line">        CellGO = <span class="literal">null</span>;</span><br><span class="line">        CellGORectTransform = <span class="literal">null</span>;</span><br><span class="line">        mCellSize = Vector2.zero;</span><br><span class="line">        mRectPos = Vector2.zero;</span><br><span class="line">        CellRect = Rect.zero;</span><br><span class="line">        ObjectPool.Singleton.push&lt;CellData&gt;(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面列举了单元格参与容器显示判定计算比较重要的成员变量以及生命周期函数，可以看出单元格的大小和位置以及显示区域信息会用作单元格容器滚动时的判定数据，从而判定是否需要显示特定单元格。</p>
<p>从前面的事例代码可以看到单元格的创建可以手动指定单元格大小，不传会用默认预制件大小</p>
<p>设定单元格容器回调后触发setCellDatasByCellCount()等设置容器数量相关接口后，触发单元格以及单元格容器相关数据的初始化和判定以及滚动判定监听:<br>BaseScrollContainer.cs(单元格容器基类)</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Use this for initialization</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Start</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    ScrollRect.onValueChanged.AddListener(onScrollChanged);</span><br><span class="line">    TryCorrectData();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 滚动回调刷新Cell显示</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;scrollpos&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">onScrollChanged</span>(<span class="params">Vector2 scrollpos</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (mCellDatas != <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        updateScrollValue();</span><br><span class="line">        mMaskRect.x = mAvalibleScrollDistance * ScrollRect.horizontalNormalizedPosition;</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; mCellDatas.Count; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            onCellDisplay(i);</span><br><span class="line">        &#125;</span><br><span class="line">        checkCellPostionCorrect(mCurrentScrollDir);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Set container celldatas by pass data</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 设置Container的cell数据通过列表数据</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;prefabindexlist&quot;&gt;</span>预制件索引列表<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param width=&quot;cellsizelist&quot;&gt;</span>单元格大小列表(为空表示采用预制件默认大小)<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;scrollnormalizedposition&quot;&gt;</span>单元格初始滚动位置<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCellDatasByDataList</span>(<span class="params">List&lt;<span class="built_in">int</span>&gt; prefabindexlist, List&lt;Vector2&gt; cellsizelist = <span class="literal">null</span>, Vector2? scrollnormalizedposition = <span class="literal">null</span></span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> celldatalist = createNormalCellDataList(prefabindexlist, cellsizelist);</span><br><span class="line">    setCellDatas(celldatalist, scrollnormalizedposition);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Set container celldatas by pass cell count</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 设置Container的cell数据通过单元格数量</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;prefabindexlist&quot;&gt;</span>预制件索引列表<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param width=&quot;cellsizelist&quot;&gt;</span>单元格大小列表(为空表示采用预制件默认大小)<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;scrollnormalizedposition&quot;&gt;</span>单元格初始滚动位置<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCellDatasByCellCount</span>(<span class="params"><span class="built_in">int</span> cellcount, Vector2? scrollnormalizedposition = <span class="literal">null</span></span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> celldatalist = createNormalCellDataListWithCount(cellcount);</span><br><span class="line">    setCellDatas(celldatalist, scrollnormalizedposition);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Set container celldatas by pass celldata list</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 设置Container的cell数据</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;celldatas&quot;&gt;</span>所有的Cell数据<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;scrollnormalizedposition&quot;&gt;</span>单元格初始滚动位置<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCellDatas</span>(<span class="params">List&lt;CellData&gt; celldatas, Vector2? scrollnormalizedposition = <span class="literal">null</span></span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Update container relative datas</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 更新容器数据</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;scrollnormalizaedposition&quot;&gt;</span>单元格初始滚动位置<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;keeprectcontentpos&quot;&gt;</span>是否保持rect content的相对位置(优先于scrollnormalizaedposition)<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">updateContainerData</span>(<span class="params">Vector2? scrollnormalizaedposition = <span class="literal">null</span>, <span class="built_in">bool</span> keeprectcontentpos = <span class="literal">false</span></span>)</span>;</span><br><span class="line"></span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<p>因为单元格的流程和细节还是比较多，这里讲解的不太全面，很多地方没有说到，但考虑到项目还在用这两套单元格滚动，所以展示不打算放出源码，等未来实际成熟再分享源码。</p>
<p><strong>亮点分析:</strong></p>
<ol>
<li><strong>支持嵌套单元格滚动(通过判定滚动方向手动向上传递滚动事件实现)</strong></li>
<li><strong>支持手动传Size</strong></li>
<li><strong>支持不同单元格模板以及不同单元格逻辑对象的显示</strong></li>
</ol>
<p><strong>缺点分析:</strong></p>
<ol start="2">
<li><strong>滚动单元格依赖于ScrollRect的滚动机制需要一开始就计算出总的单元格大小之和，导致很难支持循环列表。</strong></li>
<li><strong>滚动列表要一开始就知道单元格的大小，导致一开始如果有过多的动态大小会导致单元格初始化前的计算开销过大。</strong></li>
</ol>
<h4 id="未来优化"><a href="#未来优化" class="headerlink" title="未来优化"></a>未来优化</h4><ol>
<li>设计成支持纯虚拟的滚动列表，可以在滚动时再请求单元格大小信息做到动态更新ScrollRect滚动容器大小，动态单元格大小在初始化时的开销过大。</li>
<li>设计成不基于ScrollRect的滚动机制，为实现循环列表做准备</li>
</ol>
<p>—————————-2021&#x2F;4&#x2F;20更新开始——————————-</p>
<p>开始着手分离单元格位置和单元格逻辑对象优化单元格逻辑对象过多问题，确保只需创建可见的单元格逻辑对象，减少不必要的逻辑对象创建开销。(<strong>已设计成回调似方式来优化逻辑对象问题</strong>)</p>
<p>—————————-2021&#x2F;4&#x2F;20更新结束——————————-</p>
<p>Note:</p>
<ol>
<li>源代码里默认带了一套组件绑定(结合代码生成)的方案，感兴趣的朋友可以自己了解下</li>
<li>源代码里也默认带了ObjectPool和GameObjectPool两种对象池的实现，感兴趣的朋友可以自己了解下</li>
</ol>
<h1 id="Github地址"><a href="#Github地址" class="headerlink" title="Github地址"></a>Github地址</h1><p><a target="_blank" rel="noopener" href="https://github.com/TonyTang1990/ScrollContainer">ScrollContainer</a></p>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a target="_blank" rel="noopener" href="https://github.com/qiankanglai/LoopScrollRect">LoopScrollRect</a><br><a target="_blank" rel="noopener" href="https://github.com/setchi/FancyScrollView">FancyScrollView</a><br><a target="_blank" rel="noopener" href="https://github.com/baba-s/ugui-super-scrollview-example">ugui-super-scrollview-example</a><br><a target="_blank" rel="noopener" href="http://www.xuanyusong.com/archives/4234">Unity3D研究院之ContentSizeFitter同步立即响应回调</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Unity/">Unity</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Unity/">Unity</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2020/05/29/Unity组件绑定/" title="Unity组件绑定" itemprop="url">Unity组件绑定</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Tony Tang" target="_blank" itemprop="author">Tony Tang</a>
		
  <p class="article-time">
    <time datetime="2020-05-29T15:35:00.000Z" itemprop="datePublished"> 发表于 2020-05-29</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>游戏开发过程中我们经常会需要访问一些指定节点，组件和脚本。</p>
<p>常规方式会通过编写GetChild(?)和GetComponent<?>()代码的方式去获取节点和组件，但这样对于开发来说并不高效同时运行时的GetChild(?)和GetComponent<?>()也是有运行开销的。</p>
<p>为了寻求更高效，高性能和便捷的方式，这里引出组件绑定的工具方案。</p>
<p><strong>实现一套通用的组件绑定方案</strong>，为未来游戏快速开发打下基础。</p>
<h2 id="组件绑定原理"><a href="#组件绑定原理" class="headerlink" title="组件绑定原理"></a>组件绑定原理</h2><ol>
<li>通过Object数组实现通用类型的组件绑定存储</li>
<li>通过自定义Inspector实现绑定对象，绑定对象组件绑定选择以及模板类型选择，代码生成等UI操作界面</li>
<li>通过模板+代码生成实现组件绑定的自定义快速代码生成(通过生成partial代码不入侵原始逻辑代码)</li>
<li>结合自定义ScriptableObject自定义不同模板类型的不同代码输出目录实现自定义代码目录输出设置</li>
</ol>
<h2 id="功能实现"><a href="#功能实现" class="headerlink" title="功能实现"></a>功能实现</h2><ol>
<li><strong>支持通节点不同组件的绑定</strong></li>
<li><strong>支持节点自定义变量名和注释定义</strong></li>
<li><strong>支持自定义代码模板的选择生成</strong></li>
<li><strong>支持组件绑定代码不入侵功能代码(利用partial class)功能生成代码</strong></li>
<li><strong>支持不同模板类型代码生成输出目录设置</strong></li>
</ol>
<h2 id="实战实现"><a href="#实战实现" class="headerlink" title="实战实现"></a>实战实现</h2><h3 id="组件绑定脚本"><a href="#组件绑定脚本" class="headerlink" title="组件绑定脚本"></a>组件绑定脚本</h3><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 节点绑定类</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">DisallowMultipleComponent</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ComponentBinder</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 绑定类型索引值</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> BindCodeTypeIndex;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> UI节点数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> List&lt;ComponentBindData&gt; NodeDatas = <span class="keyword">new</span> List&lt;ComponentBindData&gt;();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 组件绑定节点信息</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">Serializable</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ComponentBindData</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 节点对象</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">SerializeField</span>]</span><br><span class="line">    <span class="keyword">public</span> UnityEngine.Object NodeTarget;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 变量别名(用于生成代码)</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">SerializeField</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> VariableAlias;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 节点描述</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">SerializeField</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> NodeDes;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ComponentBindData</span>(<span class="params">UnityEngine.Object target</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        NodeTarget = target;</span><br><span class="line">        NodeDes = <span class="built_in">string</span>.Empty;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从上面的可以看出节点组件和脚本的数据绑定<strong>核心是通过脚本序列化Object[]数组以及相关数据的方式实现绑定节点数据存储的。</strong></p>
<h3 id="组件绑定自定义面板"><a href="#组件绑定自定义面板" class="headerlink" title="组件绑定自定义面板"></a>组件绑定自定义面板</h3><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 组件绑定自定义Editor</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">CustomEditor(typeof(ComponentBinder))</span>]</span><br><span class="line">[<span class="meta">CanEditMultipleObjects</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ComponentBinderEditor</span> : <span class="title">Editor</span></span><br><span class="line">&#123;</span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这部分代码主要是实现ComponentBinder的Inspector自定义GUI显示，从而实现我们想要的自定义UI操作。</p>
<h3 id="组件绑定模板代码生成"><a href="#组件绑定模板代码生成" class="headerlink" title="组件绑定模板代码生成"></a>组件绑定模板代码生成</h3><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> CompoenntBinder代码生成工具</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">ComponentBinderCodeGenerator</span></span><br><span class="line">&#123;</span><br><span class="line">	******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 模板数据处理类</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TTemplate</span></span><br><span class="line">&#123;</span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此文件主要是通过自定义选择的模板文件***.txt结合TTemplate工具类实现模板文件txt里的内容自定义生成输出我们想要的代码。</p>
<p>窗口模板文件示例:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             #FileName#.cs</span></span><br><span class="line"><span class="comment"> * Author:                  #Author#</span></span><br><span class="line"><span class="comment"> * Create Date:             #CreatedDate#</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> UnityEngine.UI;</span><br><span class="line"><span class="keyword">using</span> TH.Modules.UI;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Game.Modules.UI</span></span><br><span class="line">&#123;	</span><br><span class="line">	<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">	<span class="comment"><span class="doctag">///</span> #ClassName#窗口</span></span><br><span class="line">	<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> #<span class="title">ClassName</span># : <span class="title">BaseWindow</span></span><br><span class="line">    &#123;</span><br><span class="line">		<span class="keyword">public</span> <span class="meta">#ClassName#()</span></span><br><span class="line">		&#123;</span><br><span class="line"></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> 添加监听</span></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">		<span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">addListeners</span>()</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">base</span>.addListeners();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> 窗口显示</span></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">		<span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">onShow</span>()</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">base</span>.onShow();</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> 移除监听</span></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">		<span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">removeListeners</span>()</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">base</span>.removeListeners();</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> 窗口销毁</span></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">		<span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">onDestroy</span>()</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">base</span>.onDestroy();</span><br><span class="line">		&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>窗口组件绑定模板示例:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             #FileName#.cs</span></span><br><span class="line"><span class="comment"> * Author:                  #Author#</span></span><br><span class="line"><span class="comment"> * Create Date:             #CreatedDate#</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> UnityEngine.UI;</span><br><span class="line"><span class="keyword">using</span> TH.Modules.UI;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Game.Modules.UI</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">	<span class="comment"><span class="doctag">///</span> #ClassName#窗口的组件绑定</span></span><br><span class="line">	<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">partial</span> <span class="keyword">class</span> #<span class="title">ClassName</span>#</span><br><span class="line">    &#123;</span><br><span class="line">		 <span class="meta">#MEMBER_DEFINITION_LOOP#</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span> #NodeDes# <span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">private</span> <span class="meta">#NodeType# #NodeName#;#MEMBER_DEFINITION_LOOP#</span></span><br><span class="line">		   </span><br><span class="line">		<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> 缓存组件</span></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">		<span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">cacheComponents</span>()</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">base</span>.cacheComponents();</span><br><span class="line">            <span class="meta">#MEMBER_INIT_LOOP#</span></span><br><span class="line">            <span class="meta">#NodeName# = #NodeMemberName#.NodeDatas[#NodeIndex#].NodeTarget as #NodeType#;#MEMBER_INIT_LOOP#</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> 释放组件</span></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">		<span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">disposeComponents</span>()</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">base</span>.disposeComponents();</span><br><span class="line">			<span class="meta">#MEMBER_DISPOSE_LOOP#</span></span><br><span class="line">            <span class="meta">#NodeName# = null;#MEMBER_DISPOSE_LOOP#</span></span><br><span class="line">		&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其他模板生成参考文件:</p>
<p>CellUIBinder.txt，CellUITemplate.txt，GameObjectUIBinder.txt</p>
<h3 id="组件绑定设置"><a href="#组件绑定设置" class="headerlink" title="组件绑定设置"></a>组件绑定设置</h3><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> ComponentBindSetting.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 组件绑定设置数据</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">CreateAssetMenu(fileName = <span class="string">&quot;ComponentBinderSetting&quot;</span>, menuName = <span class="string">&quot;ScriptableObjects/ComponentBinderSetting&quot;</span>, order = 1)</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ComponentBinderSetting</span> : <span class="title">ScriptableObject</span></span><br><span class="line">&#123;</span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> ComponentBinderSettingEditor.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 组件绑定自定义Editor</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">CustomEditor(typeof(ComponentBinderSetting))</span>]</span><br><span class="line">[<span class="meta">DisallowMultipleComponent</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ComponentBinderSettingEditor</span> : <span class="title">Editor</span></span><br><span class="line">&#123;</span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="实战使用"><a href="#实战使用" class="headerlink" title="实战使用"></a>实战使用</h3><ul>
<li><p>组件绑定设置</p>
<p><img src="/img/Unity/ComponentBinder/ComponentBinderSettingUI.PNG" alt="ComponentBinderSettingUI"></p>
<p><strong>通过自定义模板类型的代码输出路径设置实现自定义代码输出设置</strong></p>
</li>
<li><p>组件绑定选择</p>
<p><img src="/img/Unity/ComponentBinder/ComponentBindChosenUI.PNG" alt="ComponentBindChosenUI"></p>
<ol>
<li><strong>支持通节点不同组件的绑定</strong></li>
<li><strong>支持节点自定义变量名和注释定义</strong></li>
</ol>
</li>
<li><p>自定义绑定节点代码注释</p>
<p><img src="/img/Unity/ComponentBinder/CustomScriptNotation.PNG" alt="CustomScriptNotation"></p>
</li>
<li><p>窗口模板组件绑定设置以及代码生成</p>
<p><img src="/img/Unity/ComponentBinder/WindowTemplateBindUsing.PNG" alt="WindowTemplateBindUsing"></p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             WindowBindPrefab.cs</span></span><br><span class="line"><span class="comment"> * Author:                  TONYTANG</span></span><br><span class="line"><span class="comment"> * Create Date:             2022//05/29</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> UnityEngine.UI;</span><br><span class="line"><span class="keyword">using</span> TH.Modules.UI;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Game.Modules.UI</span></span><br><span class="line">&#123;	</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> WindowBindPrefab窗口</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">WindowBindPrefab</span> : <span class="title">BaseWindow</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">WindowBindPrefab</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 添加监听</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">addListeners</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">base</span>.addListeners();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 窗口显示</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">onShow</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">base</span>.onShow();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 移除监听</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">removeListeners</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">base</span>.removeListeners();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 窗口销毁</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">onDestroy</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">base</span>.onDestroy();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             WindowBindPrefabBinder.cs</span></span><br><span class="line"><span class="comment"> * Author:                  TONYTANG</span></span><br><span class="line"><span class="comment"> * Create Date:             2022//05/29</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> UnityEngine.UI;</span><br><span class="line"><span class="keyword">using</span> TH.Modules.UI;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Game.Modules.UI</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">	<span class="comment"><span class="doctag">///</span> WindowBindPrefab窗口的组件绑定</span></span><br><span class="line">	<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">partial</span> <span class="keyword">class</span> <span class="title">WindowBindPrefab</span></span><br><span class="line">    &#123;</span><br><span class="line">		 </span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span> 根GameObject <span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">private</span> GameObject _rootGo;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span> 根RectTransform <span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">private</span> RectTransform _rootRect;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span> 背景图 <span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">private</span> Image imgBg;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span> 左侧按钮 <span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">private</span> Button btnLeftSwitch;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span> 右侧按钮 <span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">private</span> Button btnRightSwitch;</span><br><span class="line">		   </span><br><span class="line">		<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> 缓存组件</span></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">		<span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">cacheComponents</span>()</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">base</span>.cacheComponents();</span><br><span class="line">            </span><br><span class="line">            _rootGo = mComponentBinder.NodeDatas[<span class="number">0</span>].NodeTarget <span class="keyword">as</span> GameObject;</span><br><span class="line">            _rootRect = mComponentBinder.NodeDatas[<span class="number">1</span>].NodeTarget <span class="keyword">as</span> RectTransform;</span><br><span class="line">            imgBg = mComponentBinder.NodeDatas[<span class="number">2</span>].NodeTarget <span class="keyword">as</span> Image;</span><br><span class="line">            btnLeftSwitch = mComponentBinder.NodeDatas[<span class="number">3</span>].NodeTarget <span class="keyword">as</span> Button;</span><br><span class="line">            btnRightSwitch = mComponentBinder.NodeDatas[<span class="number">4</span>].NodeTarget <span class="keyword">as</span> Button;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> 释放组件</span></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">		<span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">disposeComponents</span>()</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">base</span>.disposeComponents();</span><br><span class="line">			</span><br><span class="line">            _rootGo = <span class="literal">null</span>;</span><br><span class="line">            _rootRect = <span class="literal">null</span>;</span><br><span class="line">            imgBg = <span class="literal">null</span>;</span><br><span class="line">            btnLeftSwitch = <span class="literal">null</span>;</span><br><span class="line">            btnRightSwitch = <span class="literal">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>更多的代码生成示例，参考Github源代码工程。</p>
<p><img src="/img/Unity/ComponentBinder/GameObjectBinderUI.PNG" alt="GameObjectBinderUI"></p>
<p><img src="/img/Unity/ComponentBinder/CellBinderUI.PNG" alt="CellBinderUI"></p>
</li>
</ul>
<h2 id="重点知识"><a href="#重点知识" class="headerlink" title="重点知识"></a>重点知识</h2><ol>
<li><strong>利用自定义UI结合Object[]实现自定义组件绑定数据序列化</strong></li>
<li><strong>利用代码生成使用partial实现组件绑定代码无缝插入工程代码实现快速替换和访问</strong></li>
</ol>
<h2 id="Github"><a href="#Github" class="headerlink" title="Github"></a>Github</h2><p><a target="_blank" rel="noopener" href="https://github.com/TonyTang1990/ComponentBinder">ComponentBinder</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Unity/">Unity</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Unity/">Unity</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2020/05/29/数学与缓动/" title="数学与缓动" itemprop="url">数学与缓动</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Tony Tang" target="_blank" itemprop="author">Tony Tang</a>
		
  <p class="article-time">
    <time datetime="2020-05-29T01:15:31.000Z" itemprop="datePublished"> 发表于 2020-05-29</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>本章节博客是在使用一段时间Dotween后，对于Dotween是如何实现各种不同的缓动类型效果比较好奇。从本片博客会了解线性方程与线性代数之间的关系，以及数学(线性方程)在缓动中的实际应用和数学公式是如何输出显示的。本博客着重于学习数学在插值动画上的运用学习，博客末尾会给出实战的Git地址。</p>
<h2 id="数学"><a href="#数学" class="headerlink" title="数学"></a>数学</h2><p>在开始之前，让我们先来了解下如何编写网页版数学公式，然后用于我们的MarkDown中显示。</p>
<p>紧接着我们来回顾和学习了解，线性方程和线性代数各自的概念以及他们之间的关系。</p>
<h3 id="数学公式"><a href="#数学公式" class="headerlink" title="数学公式"></a>数学公式</h3><p>考虑到MarkDown或者网页显示数学公式都要有额外的插件支持，所以这里采用独立第三方制作公式显示，然后截图使用图片的形式来显示到MarkDown和网页上。</p>
<h4 id="公式制作"><a href="#公式制作" class="headerlink" title="公式制作"></a>公式制作</h4><p>通过搜索了解到<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/LaTeX"><strong>LaTeX</strong>，是一种基于TeX的排版系统</a></p>
<p>LateX表达数学公式支持两种方式：</p>
<ol>
<li><p>inline mode(is used to write formulas that are part of a text)</p>
<p>inline mode采用以下分隔符: </p>
<p>\( \)<code>, </code>$ $<code>or</code>\begin{math} \end{math}</p>
</li>
<li><p>display mode(is used to write expressions that are not part of a text or paragraph, and are therefore put on separate lines.)</p>
</li>
</ol>
<p>由于LateX规则过于庞大，所以这里只是简单的用到什么查什么。</p>
<p>更多更详细的学习参考:</p>
<p><a target="_blank" rel="noopener" href="https://cn.overleaf.com/learn/latex/Mathematical_expressions">Latex数学公式编写介绍</a></p>
<p>接下来只是以简单的二元一次方程组为示例，来学习LateX的数学表达结构:</p>
<p>先来看看最终要的效果：</p>
<p><img src="/img/Unity/Math/XianXingFangCheng.png" alt="XianXingFangCheng"></p>
<p>实战：</p>
<p>这简单的二元一次方程，涉及到如下几个概念：</p>
<ul>
<li><p>[导入amsmath功能包](<a target="_blank" rel="noopener" href="https://cn.overleaf.com/learn/latex/Aligning">https://cn.overleaf.com/learn/latex/Aligning</a> equations with amsmath)</p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://cn.overleaf.com/learn/latex/Brackets_and_Parentheses">Brackets and Parentheses-括号</a></p>
</li>
<li><p>[Aligning equations with amsmath-公式对齐](<a target="_blank" rel="noopener" href="https://cn.overleaf.com/learn/latex/Aligning">https://cn.overleaf.com/learn/latex/Aligning</a> equations with amsmath)</p>
</li>
</ul>
<p>直接上最终LateX代码：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">\usepackage&#123;amsmath&#125;</span><br><span class="line"></span><br><span class="line">\begin&#123;align*&#125;</span><br><span class="line">&amp; \left( <span class="number">2</span>x - y = <span class="number">0</span> \right) \\</span><br><span class="line">&amp; \left( -x + <span class="number">2</span>y = <span class="number">3</span> \right)</span><br><span class="line">\end&#123;align*&#125;</span><br></pre></td></tr></table></figure>

<p>输出效果:</p>
<p><img src="/img/Unity/Math/LateXXianXingFangCheng.png" alt="LateXXianXingFangCheng"></p>
<p>上面没有找到如何输出{符号，忘知道的朋友告知。</p>
<p>上面这种表达方式，我们可以理解成方程组的<strong>行表达形式</strong></p>
<p><a target="_blank" rel="noopener" href="https://cn.overleaf.com/">在线编写LateX网址</a></p>
<p>上面那个LateX网址是收费的，其次是完全自己写LateX语法符号来编写数学公式。后来发现了更加可视化容易编写数学公式的在线免费网站，有兴趣的可以了解下：</p>
<p><a target="_blank" rel="noopener" href="https://www.mathcha.io/editor">mathcha</a></p>
<p>只需要按照规则输入符号就能打出想要的数学公式效果。</p>
<h4 id="公式可视化"><a href="#公式可视化" class="headerlink" title="公式可视化"></a>公式可视化</h4><p>解决了函数编写输出，那么肯定希望更直观的看到函数的二维坐标系绘图，这里我找到一个在线绘制数学函数的网站：</p>
<p><a target="_blank" rel="noopener" href="https://www.wolframalpha.com/examples/mathematics/">WolframAlpha</a></p>
<p><img src="/img/Unity/Math/MathmaticVisualization.png" alt="MathmaticVisualization"></p>
<h3 id="线性方程"><a href="#线性方程" class="headerlink" title="线性方程"></a>线性方程</h3><p>线性方程，这个应该是初中学习的知识，参考前面的示例来回顾一下：</p>
<p><img src="/img/Unity/Math/LateXXianXingFangCheng.png" alt="LateXXianXingFangCheng"></p>
<p><a href="%5Bhttps://zh.wikipedia.org/wiki/%E6%96%B9%E7%A8%8B%E7%BB%84%5D(https://zh.wikipedia.org/wiki/%E6%96%B9%E7%A8%8B%E7%BB%84)"><strong>方程组</strong>又称<strong>联立方程</strong>，是两个或两个以上含有多个[未知数]联立得到的[集]。未知数的值称为方程组的**[根]<strong>，求方程组根的过程称为</strong>解方程组**。</a></p>
<p>这里就不深入探讨了，总之就是解方程组。这里我们更关注的是方程组是如何和线性代数关联上的。</p>
<h3 id="线性代数"><a href="#线性代数" class="headerlink" title="线性代数"></a>线性代数</h3><p><a href="%5Bhttps://zh.wikipedia.org/wiki/%E7%BA%BF%E6%80%A7%E4%BB%A3%E6%95%B0%5D(https://zh.wikipedia.org/wiki/%E7%BA%BF%E6%80%A7%E4%BB%A3%E6%95%B0)"><strong>线性代数</strong>是关于向量空间的一个数学分支。它包括对线、面和子空间的研究，同时也涉及到所有的向量空间的一般性质。</a></p>
<p>前面的二元一次方程示例用不同的角度来思考和表达。</p>
<p>以<strong>列表达形式</strong>如下：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">\begin&#123;equation&#125;</span><br><span class="line">x \binom&#123;<span class="number">2</span>&#125;&#123;<span class="number">1</span>&#125; + y \binom&#123;<span class="number">-1</span>&#125;&#123;<span class="number">-2</span>&#125; = \binom&#123;<span class="number">0</span>&#125;&#123;<span class="number">3</span>&#125;</span><br><span class="line">\end&#123;equation&#125;</span><br></pre></td></tr></table></figure>

<p>效果：</p>
<p><img src="/img/Unity/Math/XianXingFangChengMatrixStyle.png" alt="XianXingFangChengMatrixStyle"></p>
<p>结合二维坐标系：</p>
<p><img src="/img/Unity/Math/ColumePictureXianXingFangCheng.png" alt="ColumePictureXianXingFangCheng"></p>
<p>图中是以向量的概念来绘制方程组图像，可以看到矩阵的概念已经呼之欲出了。</p>
<p>以矩阵的概念来表达如下：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">\qquad \qquad \qquad \qquad \qquad \quad</span><br><span class="line">$\begin&#123;bmatrix&#125;</span><br><span class="line"><span class="number">2</span> &amp; <span class="number">-1</span> \\</span><br><span class="line"><span class="number">-1</span> &amp; <span class="number">2</span></span><br><span class="line">\end&#123;bmatrix&#125;$</span><br><span class="line">$\begin&#123;bmatrix&#125;</span><br><span class="line">x \\</span><br><span class="line">y</span><br><span class="line">\end&#123;bmatrix&#125;$</span><br><span class="line">=</span><br><span class="line">$\begin&#123;bmatrix&#125;</span><br><span class="line"><span class="number">0</span> \\</span><br><span class="line"><span class="number">3</span></span><br><span class="line">\end&#123;bmatrix&#125;$</span><br></pre></td></tr></table></figure>

<p>效果：</p>
<p><img src="/img/Unity/Math/XianXingFangChengRealMatrixStyle.png" alt="XianXingFangChengRealMatrixStyle"></p>
<p> 以下<a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000016428152">截图来源</a>：</p>
<p><img src="/img/Unity/Math/JianHuaMatrix.png" alt="JianHuaMatrix"></p>
<p>可以看出落实到矩阵的概念上，就是对于向量的矩阵变换问题了。向量X通过矩阵A的变换变换到b。</p>
<p><strong>矩阵变换正是线性代数中的一部分。</strong></p>
<p><strong>矩阵可以帮助我们对于复杂的多维函数方程更方便的构造和求解。</strong></p>
<p>更多在线学习参考:</p>
<p><a target="_blank" rel="noopener" href="http://open.163.com/newview/movie/free?pid=M6V0BQC4M&mid=M6V29E773">方程组的几何解释</a></p>
<h2 id="插值"><a href="#插值" class="headerlink" title="插值"></a>插值</h2><p>相比前面的数学基础概念，总算进入更有趣的实战环节了。</p>
<p>插值缓动效果是指游戏里一些需要缓慢变化的动画效果(e.g. 移动位置插值，透明度变化插值，颜色变化插值等)。</p>
<p>一般来说在Unity里要实现插值，我们会直接通过类似Update(e.g. Update或Coroutine)的形式去累加时间，然后通过Unity提供的插值函数来获取当前插值的进度值，最终使用这个进度值参与插值运算得出最终插值效果。</p>
<p>所以我们会看到类似以下的代码:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Lerp挂载基类</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">LerpBaseMono</span> : <span class="title">MonoBehaviour</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Lerp时长</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">float</span> LerpDurationTime = <span class="number">2.0f</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 当前Lerp类型</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">protected</span> ELerpType mLerpType = ELerpType.None;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Use this for initialization</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Start</span> ()</span> &#123;</span><br><span class="line">        DoLerpPrepation();</span><br><span class="line">        StartCoroutine(LerpCoroutine());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 执行Lerp准备工作</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">DoLerpPrepation</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Lerp携程</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> IEnumerator <span class="title">LerpCoroutine</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> starttime = Time.time;</span><br><span class="line">        <span class="keyword">var</span> endtime = starttime + LerpDurationTime;</span><br><span class="line">        <span class="keyword">while</span>(Time.time &lt; endtime)</span><br><span class="line">        &#123;</span><br><span class="line">            DoLerp(starttime, endtime, Time.time);</span><br><span class="line">            <span class="keyword">yield</span> <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        DoLerp(starttime, endtime, Time.time);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 执行Lerp</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;starttime&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;endtime&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;currenttime&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">DoLerp</span>(<span class="params"><span class="built_in">float</span> starttime, <span class="built_in">float</span> endtime, <span class="built_in">float</span> currenttime</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> t = Mathf.InverseLerp(starttime, endtime, currenttime);</span><br><span class="line">        Debug.Log(<span class="string">$&quot;开始时间:<span class="subst">&#123;starttime&#125;</span>结束时间:<span class="subst">&#123;endtime&#125;</span>当前时间:<span class="subst">&#123;currenttime&#125;</span>当前缓动值:<span class="subst">&#123;t&#125;</span>&quot;</span>);</span><br><span class="line">        DoRealLerp(t);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 执行真实Lerp效果</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;t&quot;&gt;</span>缓动进度(0-1)<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">DoRealLerp</span>(<span class="params"><span class="built_in">float</span> t</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输出如下:</p>
<p><img src="/img/Unity/Math/UnityLerpOutput.png" alt="UnityLerpOutput"></p>
<p>接下来有了缓动的插值t,我们就可以做不同的缓动动画效果了。</p>
<p>上面的代码已经为挂载不同的缓动效果做了设计准备，接下来让我们实现三个简单的缓动效果:</p>
<ol>
<li>位移缓动</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> PositionLerpMono.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 位置Lerp组件</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PositionLerpMono</span> : <span class="title">LerpBaseMono</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 结束位置</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> Vector3 EndPos = Vector3.zero;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 开始位置</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">protected</span> Vector3 mStartPos;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 执行Lerp准备工作</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">DoLerpPrepation</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">base</span>.DoLerpPrepation();</span><br><span class="line">        mLerpType = ELerpType.LerpPosition;</span><br><span class="line">        mStartPos = transform.localPosition;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 执行真实Lerp效果</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;t&quot;&gt;</span>缓动进度(0-1)<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">DoRealLerp</span>(<span class="params"><span class="built_in">float</span> t</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        transform.localPosition = Vector3.LerpUnclamped(mStartPos, EndPos, t);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>缩放缓动</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> ScaleLerpMono.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 缩放缓动组件</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ScaleLerpMono</span> : <span class="title">LerpBaseMono</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 结束缩放值</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> Vector3 EndScale = Vector3.one;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 开始缩放值</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">protected</span> Vector3 mStartScale;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 执行Lerp准备工作</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">DoLerpPrepation</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">base</span>.DoLerpPrepation();</span><br><span class="line">        mLerpType = ELerpType.LerpScale;</span><br><span class="line">        mStartScale = transform.localScale;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 执行真实Lerp效果</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;t&quot;&gt;</span>缓动进度(0-1)<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">DoRealLerp</span>(<span class="params"><span class="built_in">float</span> t</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        transform.localScale = Vector3.LerpUnclamped(mStartScale, EndScale, t);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>透明度缓动</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> AlphaLerpMono.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 透明度缓动组件</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">RequireComponent(typeof(Graphic))</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">AlphaLerpMono</span> : <span class="title">LerpBaseMono</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 结束透明度</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">float</span> EndAlpha = <span class="number">0.0f</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Graphic组件</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">protected</span> Graphic mGraphicComponent;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 开始透明度</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">protected</span> <span class="built_in">float</span> mStartAlpha;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 执行Lerp准备工作</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">DoLerpPrepation</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">base</span>.DoLerpPrepation();</span><br><span class="line">        mGraphicComponent = GetComponent&lt;Graphic&gt;();</span><br><span class="line">        mStartAlpha = mGraphicComponent.color.a;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 执行真实Lerp效果</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;t&quot;&gt;</span>缓动进度(0-1)<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">DoRealLerp</span>(<span class="params"><span class="built_in">float</span> t</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> oldcolor = mGraphicComponent.color;</span><br><span class="line">        oldcolor.a = Mathf.Lerp(mStartAlpha, <span class="keyword">this</span>.EndAlpha, t);</span><br><span class="line">        mGraphicComponent.color = oldcolor;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>效果如下:</p>
<p><img src="/img/Unity/Math/LerpScreenShort.png" alt="LerpScreenShort"></p>
<p>通过上面可以看到我们已经实现了一个简陋版的不同Lerp效果的插值动画。</p>
<h3 id="插值线性方程"><a href="#插值线性方程" class="headerlink" title="插值线性方程"></a>插值线性方程</h3><p>接下来就要引入之前提到的线性方程了，从上面可以看出DoRealLerp里的参数t决定了缓动效果的最终进度值，现阶段t的值是通过世间累加然后Lerp插值到0-1的，也就是说是线性的速度。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> t = Mathf.InverseLerp(starttime, endtime, currenttime);</span><br></pre></td></tr></table></figure>

<p>这里的线性速度换成线性方程的话，可以理解成y&#x3D;x</p>
<p><img src="/img/Unity/Math/y=x%E5%87%BD%E6%95%B0%E5%9B%BE.png" alt="y&#x3D;x函数图"></p>
<p>也就是说如果我们把t的变化速度函数修改成其他的线性方程，那就能达到同样的Lerp效果以不同的插值函数来表现。</p>
<p>让我们先通过easings.net来预览下插值函数大概长什么样:</p>
<p><img src="/img/Unity/Math/EaseLerpFunction.png" alt="EaseLerpFunction"></p>
<p>这里核心思想是想替换t的插值计算方式，这里关于插值函数的代码就直接采用Github上现成的了:</p>
<p><a target="_blank" rel="noopener" href="https://gist.github.com/ManeFunction/9f2d437fca6ccf31e4a48fec0584e21a"><strong>EasingFunctions.cs</strong></a></p>
<p>修改基类代码如下:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Lerp挂载基类</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">LerpBaseMono</span> : <span class="title">MonoBehaviour</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Lerp时长</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">float</span> LerpDurationTime = <span class="number">2.0f</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 缓动类型</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> EasingFunction.Ease EaseType = EasingFunction.Ease.Linear;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Use this for initialization</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Start</span> ()</span> &#123;</span><br><span class="line">        StartCoroutine(LerpCoroutine());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 执行Lerp准备工作</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">DoLerpPrepation</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Lerp携程</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> IEnumerator <span class="title">LerpCoroutine</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        DoLerpPrepation();</span><br><span class="line">        <span class="keyword">var</span> starttime = Time.time;</span><br><span class="line">        <span class="keyword">var</span> endtime = starttime + LerpDurationTime;</span><br><span class="line">        <span class="keyword">while</span>(Time.time &lt; endtime)</span><br><span class="line">        &#123;</span><br><span class="line">            DoLerp(starttime, endtime, Time.time);</span><br><span class="line">            <span class="keyword">yield</span> <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        DoLerp(starttime, endtime, Time.time);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 执行Lerp</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;starttime&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;endtime&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;currenttime&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">DoLerp</span>(<span class="params"><span class="built_in">float</span> starttime, <span class="built_in">float</span> endtime, <span class="built_in">float</span> currenttime</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> t = Mathf.InverseLerp(starttime, endtime, currenttime);</span><br><span class="line">        <span class="keyword">var</span> easefunc = EasingFunction.GetEasingFunction(EaseType);</span><br><span class="line">        t = easefunc(<span class="number">0</span>, <span class="number">1</span>, t);</span><br><span class="line">        <span class="comment">//Debug.Log($&quot;缓动类型:&#123;this.EaseType&#125;开始时间:&#123;starttime&#125;结束时间:&#123;endtime&#125;当前时间:&#123;currenttime&#125;当前缓动值:&#123;t&#125;&quot;);</span></span><br><span class="line">        DoRealLerp(t);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 执行真实Lerp效果</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;t&quot;&gt;</span>缓动进度(0-1)<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">DoRealLerp</span>(<span class="params"><span class="built_in">float</span> t</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样一来我们就成功的替换了缓动的线性方程，且限定了缓动值t在0-1范围内，实现了不同缓动速度的t。</p>
<p>让我们来看看最终效果:</p>
<p><img src="/img/Unity/Math/EasingFuncLerpPos.png" alt="EasingFuncLerpPos"></p>
<p>正如我们预期的那样，同样的终点和持续时间，三个不同缓动类型(线性方程)的移动插值，表现出了不一样的速度变化。</p>
<h3 id="插值组件"><a href="#插值组件" class="headerlink" title="插值组件"></a>插值组件</h3><p>上面我们的缓动组件已经雏形已经有了，接下来就是重新好好设计重构以下我们的缓动组件来达到通过挂在缓动组件能快速得到类似Dotween一样的代码效果。</p>
<p>用过<a target="_blank" rel="noopener" href="http://dotween.demigiant.com/documentation.php">Dotween</a>都知道Dotween通过扩展方法的形式和泛型的形式，方便的支持了快速调用动画接口，接下来来看看Dotween几个大的概念设计：</p>
<ul>
<li>Tweener<ul>
<li><a target="_blank" rel="noopener" href="http://dotween.demigiant.com/documentation.php">A tween that takes control of a value and animates it.</a></li>
</ul>
</li>
<li>Sequence<ul>
<li><a target="_blank" rel="noopener" href="http://dotween.demigiant.com/documentation.php">A special tween that, instead of taking control of a value, takes control of other tweens and animates them as a group.</a></li>
</ul>
</li>
</ul>
<p>Tweener是单个动画对象的抽象。</p>
<p>Sequence是多个动画Tweener的组合管理抽象。</p>
<p>所以借助于Tweener和Sequence再加上内部插值缓动的Ease的支持，能快速的触发各种缓动方程的动画组合拼接。</p>
<p>这里就不详细讲解Dotween的学习使用了，这里放一张官网Sequence的代码示例来感受一下，Dotween是如何快捷高效的支持多种缓动方程多个动画效果的编写的:</p>
<p><img src="/img/Unity/Math/DotweenSequenceUsing.png" alt="DotweenSequenceUsing"></p>
<p>接下来参考Dotween的设计，我将动画组件UML设计如下:</p>
<p><img src="/img/Unity/Math/TAnimationUML.png" alt="TAnimationUML"></p>
<p>编辑器面板扩展模拟播放:</p>
<p><img src="/img/Unity/Math/InspectorSimulation.png" alt="InspectorSimulation"></p>
<p>可以把上面的设计理解成组件版的简陋Dotween:</p>
<ul>
<li><p>TBaseAnimation.cs</p>
<p>所有插值动画的基类(抽象网络插值动画的流程以及基础支持),支持是否Awake时自动播放，插值类型，延迟时间，持续时间，循环类型设置等基础设置</p>
</li>
<li><p>TBaseAnimationEditor.cs</p>
<p>插值动画自定义面板，核心扩展支持了Editor快速模拟播放，暂停，继续，停止按钮功能。</p>
</li>
<li><p>TSequenceAnimation.cs</p>
<p>序列动画抽象,负责像Dotween的Sequence一样管理一系列TBaseAnimation的整体播放效果(比如线性播放和并发播放，目前仅支持单次或无限循环播放两种方式)</p>
</li>
<li><p>TSequenceAnimationEditor.cs</p>
<p>序列动画的自定义面板，核心是通过SerializeObject和SerializeProperty编写支持Undo的自定义序列动画面板，同时支持了Editor快速模拟播放，暂停，继续，停止按钮功能。</p>
</li>
<li><p>EasingFunctions.cs</p>
<p>Git上找的关于不同插值动画类型的核心函数方程定义,把时间插值比列通过不同的函数方程计算出不同的插值系数，从而实现不同的插值方程式的插值动画效果</p>
</li>
<li><p>TPositionAnimation.cs, TScaleAnimation.cs, TAlphaAnimation.cs ……</p>
<p>落实到具体的插值动画类型的实现类</p>
</li>
</ul>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><ol>
<li>通过起始时间，结束时间，当前时间我们可以计算出当前的插值比例。然后通过数学方程将插值比例使用不同的数学方程转换成我们不同插值类型的插值比例从而得到我们想要的不同函数插值效果。</li>
<li>组件式的插值动画相比之下没有纯代码(e.g. Dotween)那么高效和可控，但重用性高，方便快速制作简单的程序化动画。</li>
<li>SerializeObject和SerializeProperty的使用就好比对象和反射属性之间的概念和关系，使用SerializeObject和SerilizeProperty能方便的使用Unity的Undo系统。</li>
</ol>
<h1 id="Git地址"><a href="#Git地址" class="headerlink" title="Git地址"></a>Git地址</h1><p><a target="_blank" rel="noopener" href="https://github.com/TonyTang1990/Ease-Component">Ease Component</a></p>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a target="_blank" rel="noopener" href="https://dev.twsiyuan.com/2017/02/tween-animation-and-easing-functions-in-unity.html">Animation &amp; Easing functions in Unity (Tween)</a></p>
<p><a target="_blank" rel="noopener" href="https://easings.net/">Easing functions</a></p>
<p><a target="_blank" rel="noopener" href="https://gist.github.com/ManeFunction/9f2d437fca6ccf31e4a48fec0584e21a">EasingFunctions GitHub</a></p>
<p><a target="_blank" rel="noopener" href="http://dotween.demigiant.com/getstarted.php">Dotween</a></p>
<p><a target="_blank" rel="noopener" href="https://whichxjy.com/my-dotween/">DOTween 动画引擎仿写</a></p>
<p><a href="%5Bhttps://zh.wikipedia.org/wiki/%E7%BA%BF%E6%80%A7%E4%BB%A3%E6%95%B0%5D(https://zh.wikipedia.org/wiki/%E7%BA%BF%E6%80%A7%E4%BB%A3%E6%95%B0)">线性代数</a></p>
<p><a target="_blank" rel="noopener" href="http://open.163.com/newview/movie/free?pid=M6V0BQC4M&mid=M6V29E773">方程组的几何解释</a></p>
<p><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000016428152">线性代数与方程的关系（笔记）</a></p>
<p><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/LaTeX">LATEX</a></p>
<p><a href="%5Bhttps://cn.overleaf.com%5D(https://cn.overleaf.com/)">在线编写LateX网址</a></p>
<p><a target="_blank" rel="noopener" href="https://cn.overleaf.com/learn/latex/Mathematical_expressions">Latex数学公式编写介绍</a></p>
<p><a target="_blank" rel="noopener" href="https://www.wolframalpha.com/examples/mathematics/">WolframAlpha</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Math/">Math</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Math/">Math</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2020/02/01/Unity嵌套预制件/" title="Unity嵌套预制件" itemprop="url">Unity嵌套预制件</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Tony Tang" target="_blank" itemprop="author">Tony Tang</a>
		
  <p class="article-time">
    <time datetime="2020-01-31T16:27:00.000Z" itemprop="datePublished"> 发表于 2020-02-01</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>本篇文章是为了记录学习Unity官方最新推出的嵌套预制件工作流的相关知识，深入理解新版嵌套预制件的设计思路与使用工作流。</p>
<p>达到以下几个目标：</p>
<ol>
<li>理解新版嵌套预制件带来的好处</li>
<li>如何避免Unity版本升级过程中预制件相关操作工具不兼容等问题。</li>
<li>设计新的预制件相关工具时考虑新老版本预制件工作流问题。</li>
</ol>
<h2 id="Prefab"><a href="#Prefab" class="headerlink" title="Prefab"></a>Prefab</h2><p>首先我们先来了解下什么是预制件(Prefab)？<br><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/Prefabs.html"> **Unity’s Prefab system allows you to create, configure, and store a GameObject complete with all its components, property values, and child GameObjects<br> as a reusable Asset. The Prefab Asset acts as a template from which you can create new Prefab instances in the SceneA Scene contains the environments and menus of your game. Think of each unique Scene file as a unique level. In each Scene, you place your environments, obstacles, and decorations, essentially designing and building your game in pieces. More info<br>See in Glossary. </a></p>
<p><strong>根据官网的介绍我们可以得知，在Unity中Prefab和纹理，材质，音效一样都是一种资源格式，预制件(Prefab)其实是一个资源载体(e.g. GameObject包含层级以及多种Component脚本做成的重用实体对象)，为了方便重复使用做好的资源模版。</strong></p>
<p>老版本预制件系统问题：</p>
<ol>
<li>不支持嵌套预制件</li>
<li>不支持变体预制件(后续会介绍)</li>
</ol>
<p>新版本预制件很好的解决了上面说到的两个问题。</p>
<p><strong>新版预制件在Unity 2018.3推出</strong><br>新版预制件主要由以下三个部分组成：</p>
<ol>
<li>嵌套预制件</li>
<li>预制件变体</li>
<li>预制件模式</li>
</ol>
<p>接下来挨个学习上面三个部分。</p>
<p>Note：<br><strong>新版Prefab是一种Asset，但打开处理的时候更多的是一种对Content的封装的概念，打开Prefab Mode是指打开Prefab浏览编辑Prefab Content</strong></p>
<h3 id="嵌套预制件"><a href="#嵌套预制件" class="headerlink" title="嵌套预制件"></a>嵌套预制件</h3><p>嵌套预制件顾名思义是指预制件之间是允许引用使用的关系而不是完全独立复制使用的概念。<br>老版本预制件系统就是采用复制实体引用的方式。<br><strong>而新版嵌套预制件是采用真实预制件引用的方式。</strong></p>
<p>嵌套预制件举例说明：<br>预制件A里用到了预制件B，如果我们修改预制件B，那么预制件A应该是自动更新变化。</p>
<p>嵌套预制件实战：<br>如下所示，我们制作了三个预制件，分别是Prefab_Cube_A,Prefab_Sphere_B以及Prefab_A_And_B,其中前两者是独立的预制件，最后一个是使用前两个预制件拼接而成的新的预制件。<br><img src="/img/Unity/NestedPrefab/NestedPrefabExample.png" alt="NestedPrefabExample"></p>
<p>可以看到嵌套的预制件在新的预制件下是蓝色的(意味着是关联了特定预制件的意思)，为了验证嵌套预制件，我简单的修改Prefab_Cube_A颜色来达到实现我们预期的嵌套预制件是引用关系的验证：<br><img src="/img/Unity/NestedPrefab/NestedPrefabChangeMat.png" alt="NestedPrefabChangeMat"><br>可以看到我们只修改了预制件Prefab_Cube_A的材质，但嵌套使用该预制件的Prefab_A_And_B里的Prefab_A也跟着变化了，这就是前面所提到的<strong>嵌套预制件的概念(嵌套引用关系而非实例化新个体)</strong></p>
<h3 id="预制件变体"><a href="#预制件变体" class="headerlink" title="预制件变体"></a>预制件变体</h3><p>预制件变体的概念类似于编程里继承的概念，继承属性的同时，父预制件的修改也会影响到子预制件变体。</p>
<p><strong>预制件变体不仅继承了父预制件的状态数据，还跟父预制件是强制关联的。</strong><br>举例说明：<br>通过预制件A创建预制件变体A2，当我们改变A时，A2继承的相同属性会跟着变化<br><img src="/img/Unity/NestedPrefab/NestedPrefabPrefabVariant.png" alt="NestedPrefabPrefabVariant"><br><img src="/img/Unity/NestedPrefab/NestedPrefabChangeVariantParent.png" alt="NestedPrefabChangeVariantParent"></p>
<p>适用情况：</p>
<ol>
<li>需要在个别Prefab基础上做少许做成预制件使用，同时需要同步父预制件修改的情况下。</li>
</ol>
<p>Note:</p>
<ol>
<li><strong>预制件变体可以理解成封装了一层Prefab的Prefab Asset</strong></li>
<li><strong>预制件变体的Content根节点时Prefab而Prefab的Content根节点时GameObject</strong></li>
</ol>
<h3 id="新版预制件工作流"><a href="#新版预制件工作流" class="headerlink" title="新版预制件工作流"></a>新版预制件工作流</h3><p>Prefab有两种状态：</p>
<ol>
<li>Prefab Asset(Prefab资源)</li>
<li>Prefab Instance(Prefab实例对象–场景里是蓝色的)<br>Prefab Instance和Prefab Asset之间是关联着的，跟老版预制件里的概念是一致的。我们可以通过修改Prefab Instance然后把改变Apply到Prefab Asset上。<strong>新版预制件有区别的是支持Component级别的Apply和Revert。</strong><br><img src="/img/Unity/NestedPrefab/NestedPrefabComponentApply.png" alt="NestedPrefabComponentApply"></li>
</ol>
<p>还有一种独立于预制件的状态：实例对象<br><img src="/img/Unity/NestedPrefab/UnpackPrefabInstance.png" alt="UnpackPrefabInstance"><br>于预制件无关的实体对象是黑色的而非蓝色:<br><img src="/img/Unity/NestedPrefab/NestedPrefabUnpackPrefabColor.png" alt="NestedPrefabUnpackPrefabColor"><br><strong>这里的Unpack相当于解除了Prefab Asset关联直接访问预制件的Content(Prefab Content后续会说到，在新版预制件里很重要的一个概念)</strong></p>
<p>新版预制件有一个新的概念叫做预制件模式，修改并Apply修改到Prefab Asset上有两种方式：</p>
<ol>
<li>直接打开Prefab Mode编辑</li>
<li>修改Prefab Instance后Apply到Prefab Asset上</li>
</ol>
<p>这里重点讲解学习Prefab Mode：<br><strong>Prefab Mode类似单独打开了一个修改预制件的场景，进入新的预制件场景才能看到预制件里的内容，这一点概念很重要</strong><br><img src="/img/Unity/NestedPrefab/NestedPrefabOpenPrefabMode.png" alt="NestedPrefabOpenPrefabMode"><br><img src="/img/Unity/NestedPrefab/NestedPrefabMode.png" alt="NestedPrefabMode"><br>在Prefab Mode下的修改可以通过保存和Undo操作来实现保存到Prefab Asset和撤销操作的效果。</p>
<p>了解了新版Prefab的Prefab Mode概念后，让我们结合相关API来制作一些新版Prefab的处理操作工具来深入理解：<br>需求：<br>检查指定Prefab里是否有无效的脚本挂在(Missing Script)并清除所有无效挂在脚本后保存Prefab Asset<br><img src="/img/Unity/NestedPrefab/NestedPrefabMissingScriptMono.png" alt="NestedPrefabMissingScriptMono"></p>
<p>相关API：</p>
<ol>
<li>AssetDatabase(处理Asset的工具类接口)</li>
<li>Selection(处理Asset资源选中工具类接口)</li>
</ol>
<p>步骤：</p>
<ol>
<li>选中Prefab Asset</li>
<li>判定是否是选中Prefab Asset</li>
<li>打开Prefab Mode</li>
<li>查找并删除所有Missing Script</li>
<li>保存Prefab Asset并退出Prefab Mode<br>实现：<br>RemovePrefabMissingScriptTool.cs</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEditor;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 删除预制件无效脚本引用工具</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">RemovePrefabMissingScriptTool</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">MenuItem(<span class="string">&quot;Tools/Assets/移除Missing脚本 #&amp;s&quot;</span>, false)</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">RemoveAllMissingScripts</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 1. 选中Prefab Asset</span></span><br><span class="line">        <span class="keyword">var</span> selections = Selection.GetFiltered(<span class="keyword">typeof</span>(Object), SelectionMode.Assets | SelectionMode.DeepAssets);</span><br><span class="line">        Debug.Log(<span class="string">$&quot;选中有效数量:<span class="subst">&#123;selections.Length&#125;</span>&quot;</span>);</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> selection <span class="keyword">in</span> selections)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(IsPrefabAsset(selection))</span><br><span class="line">            &#123;</span><br><span class="line">                RemovePrefabAllMissingScripts(selection <span class="keyword">as</span> GameObject);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                Debug.LogError(<span class="string">$&quot;不符合预制件要求的Asset:<span class="subst">&#123;selection.name&#125;</span>&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        AssetDatabase.SaveAssets();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 是否是预制件资源</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;obj&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">bool</span> <span class="title">IsPrefabAsset</span>(<span class="params">Object obj</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(obj <span class="keyword">is</span> GameObject)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> assetpath = AssetDatabase.GetAssetPath(obj);</span><br><span class="line">            <span class="keyword">return</span> !<span class="built_in">string</span>.IsNullOrEmpty(assetpath);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 移除预制件Asset所有无效的脚本</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">RemovePrefabAllMissingScripts</span>(<span class="params">GameObject go</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 3. 打开Prefab Mode</span></span><br><span class="line">        <span class="comment">// 4. 查找并删除所有Missing Script</span></span><br><span class="line">        <span class="comment">// 5. 保存Prefab Asset并推出Prefab Mode)</span></span><br><span class="line">        <span class="keyword">var</span> assetpath = AssetDatabase.GetAssetPath(go);</span><br><span class="line">        <span class="keyword">var</span> contentsRoot = PrefabUtility.LoadPrefabContents(assetpath);</span><br><span class="line">        RemoveAllMissingScripts(contentsRoot);</span><br><span class="line">        PrefabUtility.SaveAsPrefabAsset(contentsRoot, assetpath);</span><br><span class="line">        PrefabUtility.UnloadPrefabContents(contentsRoot);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 移除无效的脚本</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">RemoveAllMissingScripts</span>(<span class="params">GameObject go</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Component[] components = go.GetComponents&lt;Component&gt;();</span><br><span class="line">        <span class="keyword">var</span> r = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">var</span> serializedObject = <span class="keyword">new</span> SerializedObject(go);</span><br><span class="line">        <span class="keyword">var</span> prop = serializedObject.FindProperty(<span class="string">&quot;m_Component&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; components.Length; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (components[i] == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">string</span> s = go.name;</span><br><span class="line">                Transform t = go.transform;</span><br><span class="line">                <span class="keyword">while</span> (t.parent != <span class="literal">null</span>) </span><br><span class="line">                &#123;</span><br><span class="line">                    s = t.parent.name +<span class="string">&quot;/&quot;</span>+s;</span><br><span class="line">                    t = t.parent;</span><br><span class="line">                &#125;</span><br><span class="line">                Debug.Log (s + <span class="string">&quot; has an empty script attached in position: &quot;</span> + i, go);</span><br><span class="line"></span><br><span class="line">                prop.DeleteArrayElementAtIndex(i - r);</span><br><span class="line">                r++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        serializedObject.ApplyModifiedProperties();</span><br><span class="line">        <span class="keyword">foreach</span> (Transform childT <span class="keyword">in</span> go.transform)</span><br><span class="line">        &#123;</span><br><span class="line">            RemoveAllMissingScripts(childT.gameObject);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>核心思想是因为Missing Component本来就为Null无法向常规Component那样DestroyImmediate，需要通过SerializedObject去获取Component的方式删除指定位置的Component。</p>
<p>此脚本只针对单个预制件内容进行修改，嵌套预制件需要通过批量多选的方式实现各自移除各自身上的Missing Script来实现移除所有Missing脚本。</p>
<p>了解了Prefab Mode的存在，那么如何监听Prefab Mode的打开关闭生命周期了？<br>这里我们需要用到<strong>PrefabStage</strong> API(新版Prefab Mode下打开保存相关生命周期工具类接口)<br>这里只是简单的做个API实验，看看PrefabStage是否起作用。<br>PrefabStageListener.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEditor.Experimental.SceneManagement;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 新版预制件生命周期监听</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">ExecuteInEditMode</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PrefabStageListener</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Start</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        PrefabStage.prefabSaved += OnPrefabSaved;</span><br><span class="line">        PrefabStage.prefabSaving += OnPrefabSaving;</span><br><span class="line">        PrefabStage.prefabStageOpened += OnPrefabOpened;</span><br><span class="line">        PrefabStage.prefabStageClosing += OnPrefabClosing;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnDestroy</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        PrefabStage.prefabSaved -= OnPrefabSaved;</span><br><span class="line">        PrefabStage.prefabSaving -= OnPrefabSaving;</span><br><span class="line">        PrefabStage.prefabStageOpened -= OnPrefabOpened;</span><br><span class="line">        PrefabStage.prefabStageClosing -= OnPrefabClosing;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 响应预制件内容保存完毕</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;go&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnPrefabSaved</span>(<span class="params">GameObject go</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Debug.Log(<span class="string">&quot;预制件内容保存完毕!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 响应预制件内容保存</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;go&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnPrefabSaving</span>(<span class="params">GameObject go</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Debug.Log(<span class="string">&quot;预制件内容保存!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 响应预制件内容打开</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;prefabstage&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnPrefabOpened</span>(<span class="params">PrefabStage prefabstage</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Debug.Log(<span class="string">&quot;打开预制件内容!&quot;</span>);</span><br><span class="line">        Debug.Log(<span class="string">$&quot;预制件:<span class="subst">&#123;prefabstage.prefabAssetPath&#125;</span> 内容阶段:<span class="subst">&#123;prefabstage.stageHandle&#125;</span>&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 响应预制件内容关闭</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;prefabstage&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnPrefabClosing</span>(<span class="params">PrefabStage prefabstage</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Debug.Log(<span class="string">&quot;关闭预制件内容!&quot;</span>);</span><br><span class="line">        Debug.Log(<span class="string">$&quot;预制件:<span class="subst">&#123;prefabstage.prefabAssetPath&#125;</span> 内容阶段:<span class="subst">&#123;prefabstage.stageHandle&#125;</span>&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结果:<br><img src="/img/Unity/NestedPrefab/PrefabStageListener.png" alt="PrefabStageListener"><br><strong>PrefabStage.prefabStageOpened全局监听不起作用(原因未知，忘知道的朋友告知)。PrefabStage.prefabStageClosing能正确工作。</strong></p>
<p>Note:<br><strong>Prefab Mode模式下修改叫做Save而非Apply，因为已经处于Prefab Content模式下了</strong></p>
<h3 id="进阶"><a href="#进阶" class="headerlink" title="进阶"></a>进阶</h3><p>PrefabUtility(操作处理Prefab的工具类接口)</p>
<p>更多学习，待续……</p>
<h2 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h2><ol>
<li>支持嵌套预制件，能更高效的利用预制件，节约预制件的资源大小</li>
<li>支持预制件变体，能更高效的制作只有细微变化且有关联的相关预制件，增加开发效率</li>
<li>新版预制件最大区别就是提出了Prefab Mode的概念，让预制件在一个独立的环境进行编辑，进入Prefab Mode编辑的是Prefab Content而非Prefab本身。</li>
</ol>
<h1 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h1><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/Prefabs.html">Prefabs Manual</a><br><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/283752d80737">详解新版Unity中可嵌套的Prefab系统</a><br><a target="_blank" href="https://www.youtube.com/embed/b9wfVzkubzA?autoplay=1&amp;disablekb=1&amp;iv_load_policy=3&amp;modestbranding=1&amp;showinfo=0&amp;html5=1&amp;rel=0">Introducing the new prefab workflow - Unity at GDC 2019</a><br><a target="_blank" rel="noopener" href="https://www.youtube.com/embed/5q1An6SFe40?autoplay=1&disablekb=1&iv_load_policy=3&modestbranding=1&showinfo=0&html5=1">Unite LA 2018 - Introducing the New Prefab Workflow</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/Prefab/">Prefab</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2019/11/25/Unity官方插件/" title="Unity官方插件" itemprop="url">Unity官方插件</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Tony Tang" target="_blank" itemprop="author">Tony Tang</a>
		
  <p class="article-time">
    <time datetime="2019-11-25T13:27:18.000Z" itemprop="datePublished"> 发表于 2019-11-25</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>本篇文章是为了记录学习Unity官方一些好的第三方插件，作为基础的学习了解，为未来遇到问题思考解决方案时拓宽思路。</p>
<h2 id="Sprite-Atlas"><a href="#Sprite-Atlas" class="headerlink" title="Sprite Atlas"></a>Sprite Atlas</h2><p>依然从What，Why，How三个角度了学习了解Sprite Atlas。</p>
<h3 id="What"><a href="#What" class="headerlink" title="What"></a>What</h3><p>Sprite Atlas是官方Sprite Packer的升级版本，是为了更好的解决图集打包加载问题而开发的，而图集是为了解决Draw Call问题。</p>
<h3 id="Why"><a href="#Why" class="headerlink" title="Why"></a>Why</h3><p>老版Unity的时候，图集打包功能(SpritePacker,打Tag的方式)并不完善，更多的是采用第三方好比TexturePacker打包图集在放到Unity项目里的工作流。</p>
<p>Sprite Atlas主要提供了以下三个功能:<br>1.创建、编辑图集以及设定图集参数<br>2.添加图集Variant（变种）<br>3.运行时访问图集</p>
<p>新版Sprite Atals已经很完善了，考虑到以下几个原因，决定学习官方的打包图集工具跟着官方走:</p>
<ol>
<li>TexturePacker是付费的,Sprite Atlas免费</li>
<li>Sprite Atlas是官方的，跟官方走一般来说不会错</li>
<li>Spritre Atlas已经成熟可以商用的级别</li>
</ol>
<h3 id="How"><a href="#How" class="headerlink" title="How"></a>How</h3><p>使用Sprite Atlas之前，我们需要打开Sprite Atlas功能开关：<br>Edit -&gt; Project Setting -&gt; Editor -&gt; Sprite Packer -&gt; Mode(Always Enable)<br><img src="/img/Unity/SpriteAtlas/EnableSpriteAtlas.png" alt="EnableSpriteAtlas"></p>
<h4 id="创建、编辑图集以及设定图集参数"><a href="#创建、编辑图集以及设定图集参数" class="headerlink" title="创建、编辑图集以及设定图集参数"></a>创建、编辑图集以及设定图集参数</h4><p>在Sprite Atlas里Sprite Atlas是作为一种资源(Asset)存在。<br>创建Sprite Atlas：<br>右键 -&gt; Sprite Atlas</p>
<p>选中创建的Sprite Atlas我们能看到相关设置:<br><img src="/img/Unity/SpriteAtlas/SpriteAtlasSetting.png" alt="SpriteAtlasSetting"><br>这里的设置基本都和图集打包相关，这里就不一一详解了。<br>详情参见官网:<br><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/class-SpriteAtlas.html">Sprite Atlas</a></p>
<p>点击Sprite Atlas -&gt; Pack Preview即可查看打包后的结果:<br><img src="/img/Unity/SpriteAtlas/PackPreview.png" alt="PackPreview"></p>
<p>这里关于Include in Build这个参数要详细说明一下，这个参数会决定一下几方面:</p>
<ol>
<li>影响使用SpriteAtlas图集资源的资源是如何关联SpriteAtlas的(会决定使用该SpriteAtlas资源加载时加载哪一个图集资源–这里指的是有图集Variant的情况)</li>
<li>影响SpriteAtlas是否需要采用Later Bind(触不触发SpriteAtlasManager.atlasRequested接口,通过这个接口结合图集Variant我们可以做到例如不同平台加载不同图集的适配)。反之勾选Include in Build在依赖使用时会自动加载依赖的Sprite Atlas。<br><strong>这里貌似有些Unity版本有个Bug，勾选Include in Build会导致资源打包冗余</strong><br><img src="/img/Unity/SpriteAtlas/IncludeInBuildCauseRedundancySpriteAtlasTexture.png" alt="IncludeInBuildCauseRedundancySpriteAtlasTexture"></li>
</ol>
<p>针对第一条详情参考:<br><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/SpriteAtlasScenarios.html">Resolving different Sprite Atlas scenarios</a></p>
<p>Note:</p>
<ol>
<li><strong>Sprite Atlas支持Objects for Packing设置文件夹</strong></li>
<li><strong>参与打包的图片必须设置成Sprite(2D and UI)格式</strong></li>
<li><strong>Include in Build会影响SpriteAtlas的选择(比如是否要使用Later Bind等)</strong></li>
</ol>
<h4 id="添加图集Variant（变种）"><a href="#添加图集Variant（变种）" class="headerlink" title="添加图集Variant（变种）"></a>添加图集Variant（变种）</h4><p>什么是图集Variant?<br><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/VariantSpriteAtlas.html">A Variant Sprite Atlas is a type of Sprite Atlas that does not contain its own list of selected Textures as it has no Objects for Packing list in its properties. Instead, it receives a copy of the content from the Sprite Atlas set as its Master Atlas.</a><br>图集Variant是指不能指定打包内容的图集，图集Variant内容来源于复制指定的Master图集。</p>
<p>图集Variant的适用场景?<br>图集Variant的主要目的是为了用于不同分辨率设备适配不同图集来实现，内存和效果的可控。</p>
<p>图集Variant设置适用：<br><img src="/img/Unity/SpriteAtlas/SpriteAtlasVariants.png" alt="SpriteAtlasVariants"><br>可以看到我们创建一个SpriteAtlas把Type设置成Variant后，然后指定Master Atlas，最后通过调节Scale为0.5我们得到了比playerpreview图集小一倍大小的图集效果。</p>
<p>结论:</p>
<p>图集变体是类似Mipmap的东西，通过多打包多个不同大小的图集到游戏里，Unity自动帮我们选择合适的图集来加载，从而做到高分辨率机型加载高分辨率的，低分辨率机型加载低分辨率的，<strong>典型的空间换时间做法</strong>。</p>
<p>Note:</p>
<ol>
<li><strong>要想只打包使用图集Variant，需要把图集Variant的Include in Build打开，把图集Master的Include in Build关闭</strong></li>
</ol>
<h4 id="运行时访问图集"><a href="#运行时访问图集" class="headerlink" title="运行时访问图集"></a>运行时访问图集</h4><p><a target="_blank" rel="noopener" href="https://gameinstitute.qq.com/community/detail/127434">Sprite Atlas作为一种资源开放给用户，支持在脚本中直接访问，还可以通过名字获取图集中的精灵。</a></p>
<p><strong>这里我们采用设置不勾选Include in Build的设置打包SpriteAtlas</strong></p>
<p>接下来我们通过SpriteAtlas接口访问打包AB后的Sprite Atlas里的图片资源试试：<br>首先让我们看看SpriteAtlas打包AB后的的资源数据：<br><img src="/img/Unity/SpriteAtlas/SpriteAtlasAssetBundlePreview.png" alt="SpriteAtlasAssetBundlePreview"><br>可以看到SpriteAtlas作为资源参与AB打包，里面包含了SpriteAtlas，图集Texture2D以及Sprite数据。</p>
<p>这里我们看看UI预制件引用SpriteAtlas看看依赖打包的情况：<br><img src="/img/Unity/SpriteAtlas/UIPrefabReferenceNotIncludeBuildSpriteAtlas.png" alt="UIPrefabReferenceNotIncludeBuildSpriteAtlas"><br>从上面可以看出UI窗口预制件包含了依赖的Sprite(这里和以前不一样，以前是不会包含依赖的Sprite的，会直接通过依赖关系加载依赖AB实现自动还原)，个人猜测这个和后续讲到的SpriteAtlas的Later Bind有关。</p>
<p>加载UI窗口预制件后发现Sprite Missing了:<br><img src="/img/Unity/SpriteAtlas/UIPrefabSpriteMissing.png" alt="UIPrefabSpriteMissing"><br>通过查看依赖文件我发现依赖信息是没有对SpriteAtlas的依赖信息的。<strong>不知道这算不算是一个Bug还是设计如此，因为没有依赖信息对资源加载管理会造成问题，忘知道的朋友告知。</strong><br><img src="/img/Unity/SpriteAtlas/UIPrefabDepencency.png" alt="UIPrefabDepencency"></p>
<p>问题:</p>
<ol>
<li><strong>加载使用SpriteAtlas的UI Prefab，SpriteAtlas会自动加载进内存且没有依赖信息。但如果此时主动加载了Sprite Atlas并主动强制卸载该Sprite Atlas的AB会导致UI Prefab使用的Sprite Atlas也跟随被清除。从这里看出UI Prefab对Sprite Atlas的依赖信息是有必要的，不然没法正确的管理资源加载。</strong></li>
</ol>
<p>这里引申出了SpriteAtlas一个很重要的功能，<strong>Later Bind</strong></p>
<p>Note:</p>
<ol>
<li><strong>图集的被动(依赖)加载管理会有使用该图集的资源所决定(比如UI Prefab使用了SpriteAtlas，两个分别打包AB，这时加载UI Prefab后SpriteAtlas会自动加载进内存，而UI Prefab卸载以后，SpriteAtlas没有其他主动加载该SpriteAtlas的会自动卸载。)</strong></li>
</ol>
<h5 id="Later-Bind"><a href="#Later-Bind" class="headerlink" title="Later Bind"></a>Later Bind</h5><p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/80584461">SpritePacker时代“图集”我们是看不到的，因为设计者的初衷是想让开发者完全不用考虑图集的事。但是，这跟游戏开发时的动态加载图集时矛盾的！我们要动态加载就必须要知道atlas名字和sprite名，这样才能在 运行时动态的找到一张sprite！所以U3D程序员必须要清楚的知道你当前界面用的是哪atlas的哪个sprite。但是按照SpritePacker的做法他的初衷应该是想把图集干掉（干掉的意思让开发者不用关心），只需要考虑sprite即可，但是这是行不通的！<br>**SpriteAtlas其实就是为了解决上面说的问题而发布的功能。通过它我们可以将atlas和UIprefab“解耦”。同时，在Unity编辑器状态下我们仍然可以利用未打成SpriteAtlas的Sprite进行开发。等开发完成我们再发布成SpriteAtlas。**Unity提供了所谓“延迟绑定”（late bind）的技术来让我们实现这个功能。</a></p>
<p>AtlasManager.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">AtlasManager</span> : <span class="title">SingletonTemplate</span>&lt;<span class="title">AtlasManager</span>&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AtlasManager</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        DIYLog.Log(<span class="string">&quot;添加SpriteAtals图集延时绑定回调!&quot;</span>);</span><br><span class="line">        SpriteAtlasManager.atlasRequested += onAtlasRequested;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 响应SpriteAtlas图集加载回调</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;atlasname&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;callback&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onAtlasRequested</span>(<span class="params"><span class="built_in">string</span> atlasname, Action&lt;SpriteAtlas&gt; callback</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        DIYLog.Log(<span class="string">$&quot;加载SpriteAtlas:<span class="subst">&#123;atlasname&#125;</span>&quot;</span>);</span><br><span class="line">        <span class="comment">// Later Bind -- 依赖使用SpriteAtlas的加载都会触发这里</span></span><br><span class="line">        ResourceModuleManager.Singleton.requstResource(</span><br><span class="line">        atlasname,</span><br><span class="line">        (abi) =&gt;</span><br><span class="line">        &#123;</span><br><span class="line">            DIYLog.Log(<span class="string">$&quot;Later Bind加载SpriteAtlas:<span class="subst">&#123;atlasname&#125;</span>&quot;</span>);</span><br><span class="line">            <span class="keyword">var</span> sa = abi.loadAsset&lt;SpriteAtlas&gt;(atlasname);</span><br><span class="line">            callback(sa);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在加载使用SpriteAtlas(<strong>仅当设置成不勾选Include in Build</strong>)的相关资源时(比如UI Prefab)上诉回调会被触发完成对SpriteAtlas的加载，确保引用的Sprite能正确显示。同时这一机制就允许我们做到不同平台的不同图集资源加载适配这样的功能。</p>
<p>疑问:</p>
<ol>
<li>Later Bind只是加载SpriteAtlas提供的一个回调接口(无论是主动还是被动(依赖)加载)，回调接口内只知道加载了指定的SpriteAtlas却不知道具体的详细用法，这样一来基于对象绑定和索引计数的资源管理系统就无法正确的加载管理了(因为被动(依赖)加载得不到SpriteAtlas的依赖信息)。</li>
</ol>
<p>个人方案：</p>
<ol>
<li>当前这套基于对象绑定和索引计数的方案暂时没想到好的方案，可能需要对SpriteAtals的资源管理单独做一套管理策略来支持Later Bind的用法。有更好方案的朋友，望告知。</li>
</ol>
<h5 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h5><ol>
<li>开启Sprite Packer的设置Sprite Packer -&gt; Mode(Always Enable)只决定图集合成时机(比如是运行时还是打包时还是编辑器时)。</li>
<li>Sprite Atlas支持Objects for Packing设置文件夹</li>
<li>参与打包的图片必须设置成Sprite(2D and UI)格式</li>
<li><strong>Include in Build会影响SpriteAtlas图集资源的资源是如何关联SpriteAtlas(比如影响是否需要使用Later Bind,不勾选需要使用Later Bind否则会报警告)</strong></li>
</ol>
<h5 id="相关概念"><a href="#相关概念" class="headerlink" title="相关概念"></a>相关概念</h5><ol>
<li>Sprite Atlas把图集打包的概念延迟到特定时刻(比如打包或者打包AB)而编辑模式依然可以使用原始Sprite工作，总的来说就是延时自动化打包图集时机+允许使用原始Sprite的概念。</li>
<li>Include in Build设置主要是看有没有动态适配加载图集需求，有的话就建议不勾选，然后结合Later Bind来做动态图集加载适配。反之勾选Include in Build在依赖使用时会自动加载依赖使用的Sprite Atals。</li>
<li>Include in Build其次还会影响Sprite Atlas变体使用的选择。</li>
<li>SpriteAtlas到了Unity 2018 LTS版本感觉才稳定些，建议使用稳定版本的SpriteAtlas</li>
<li>Later Bind不会区分主动加载还是被动(依赖)加载SpriteAtlas,都会统一回调，要使用Later Bind机制的需要取消勾选Include in Build并解决SpriteAtlas的资源加载管理问题(在沿用原来的对象绑定和索引计数的资源管理方案基础上本人暂时没有好的方案)</li>
<li><strong>Sprite Atlas无论够不够选Include in Build打包AB都得不到Sprite Atlas的依赖信息，感觉这是一个bug</strong></li>
</ol>
<h5 id="Bug记录"><a href="#Bug记录" class="headerlink" title="Bug记录"></a>Bug记录</h5><ol>
<li><strong>勾选Include in Build会导致资源打包冗余(部分Unity版本比如Unity2018.4.1f1)，建议升级到LTS版本</strong></li>
</ol>
<h5 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h5><p>SpriteAtlas虽然解决了Atlas和UIPrefab的解耦，同时提供了图集变体的概念来解决适配图集适配方案，但也带来了一些新的问题要解决(e.g. 要解决没有依赖信息的SpriteAtals基础上做到正确的资源加载管理)。</p>
<p><strong>——————————–2021&#x2F;20&#x2F;12更新开始————————————–</strong></p>
<p>正确使用姿势参考：</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/msxh/p/14194756.html">【Unity游戏开发】SpriteAtlas与AssetBundle最佳食用方案</a></p>
<p>简单来说:</p>
<ol>
<li><strong>SpriteAtlas 勾选Include in build</strong></li>
<li><strong>SpriteAtlas不设置AB打包</strong></li>
<li><strong>直接当做单Sprite一样加载</strong></li>
</ol>
<p><strong>——————————–2021&#x2F;20&#x2F;12更新结束————————————–</strong></p>
<h2 id="Timeline"><a href="#Timeline" class="headerlink" title="Timeline"></a>Timeline</h2><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/TimelineSection.html"> <strong>Timeline</strong> to create cinematic content, game-play sequences, audio sequences, and complex particle effects. </a></p>
<p>官方介绍Timeline可以用于制作类似电影过场表现的工具。</p>
<p>Timeline分为两个部分：</p>
<ol>
<li>Timeline Asset(数据)</li>
<li>Timeline instance(数据关联实体对象)</li>
</ol>
<h3 id="Timeline-Asset"><a href="#Timeline-Asset" class="headerlink" title="Timeline Asset"></a>Timeline Asset</h3><h4 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h4><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/TimelineOverview.html"> <strong>Timeline Asset</strong>: Stores the tracks, clips, and recorded animations without links to the specific GameObjects being animated.</a></p>
<p>通过介绍可以看出Timeline Asset是类似于Animation Clip一样的资源文件可以用于录制动画<strong>但不需要关联到特定的物体上</strong></p>
<p>Timeline Asset记录的动画数据是以子节点资源的形式挂载在Timeline Asset下的：</p>
<p><img src="/img/Unity/Timeline_Cinemachine/TimelineAssetHierachy.png" alt="TimelineAssetHierachy"></p>
<p>Note:<br>前面说的不需要关联到特定的物体上是指不需要像AnimationClip那样动画是针对指定物体制作的(挂给其他物体用不了该动画)，Timeline可以通过PlayableDirector动态关联动画对象。</p>
<h4 id="分类"><a href="#分类" class="headerlink" title="分类"></a>分类</h4><p>Timeline Asset是以Track为最小单位。</p>
<p>主要支持以下几种Track:</p>
<ol>
<li>Track Group(仅分层管理用)</li>
<li>Activation Track(激活物体Track)</li>
<li>Animation Track(动画Track)</li>
<li>Audio Track(音频Track)</li>
<li>Control Track(时间相关的控制)</li>
<li>Playable Track(<strong>自定义Track</strong>)</li>
</ol>
<p><img src="/img/Unity/Timeline_Cinemachine/TimelineComponent.png" alt="TimelineComponent"></p>
<p>这里我们着重学习Playable Track,自定义的一些表现行为都是通过Playable Track来做的。其他几个就不一一讲解了。</p>
<h5 id="Playable-Track"><a href="#Playable-Track" class="headerlink" title="Playable Track"></a>Playable Track</h5><p>自定义Playable Track需要知道两个东西：</p>
<ol>
<li>PlayableAsset(用于支持Timeline创建和显示自定义PlayableAsset数据定义)</li>
<li>PlayableBehaviour(用于Playable实际的生命周期等逻辑实现)</li>
</ol>
<p>示例:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 枚举事件定义</span></span><br><span class="line"><span class="keyword">public</span> <span class="built_in">enum</span> EEventId</span><br><span class="line">&#123;</span><br><span class="line">    DefaultEvent = <span class="number">1</span>,				<span class="comment">// 默认事件</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 事件分发器Asset</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">System.Serializable</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">EventDispatcherAsset</span> : <span class="title">PlayableAsset</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 事件</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> EEventId EventId = EEventId.DefaultEvent;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Factory method that generates a playable based on this asset</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> Playable <span class="title">CreatePlayable</span>(<span class="params">PlayableGraph graph, GameObject go</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> playable = ScriptPlayable&lt;EventDispatcherPlayable&gt;.Create(graph);</span><br><span class="line">        playable.GetBehaviour().EventId = EventId;</span><br><span class="line">        <span class="keyword">return</span> playable;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 事件分发器Playable</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">EventDispatcherPlayable</span> : <span class="title">PlayableBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 事件</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;事件&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> EEventId EventId = EEventId.DefaultEvent;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Called when the owning graph starts playing</span></span><br><span class="line">    <span class="comment">// Playable开始执行时</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnGraphStart</span>(<span class="params">Playable playable</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Called when the owning graph stops playing</span></span><br><span class="line">    <span class="comment">// Playable停止执行时</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnGraphStop</span>(<span class="params">Playable playable</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Called when the state of the playable is set to Play</span></span><br><span class="line">    <span class="comment">// 触发Playable执行时</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnBehaviourPlay</span>(<span class="params">Playable playable, FrameData info</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Debug.Log(<span class="built_in">string</span>.Format(<span class="string">&quot;OnBehaviourPlay() 分发事件 : &#123;0&#125;&quot;</span>, EventId));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Called when the state of the playable is set to Paused</span></span><br><span class="line">    <span class="comment">// Playable暂停执行时</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnBehaviourPause</span>(<span class="params">Playable playable, FrameData info</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Called each frame while the state is set to Play</span></span><br><span class="line">    <span class="comment">// Playable更新执行时</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">PrepareFrame</span>(<span class="params">Playable playable, FrameData info</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/img/Unity/Timeline_Cinemachine/TimelineCustomPlayable.png" alt="TimelineCustomPlayable"></p>
<p>代码不复杂就不详细介绍了。通过上面的代码，我们支持了一个创建自定义分发事件的Playable Track，而这个自定义的事件分发就可以用作我们Timeline和游戏逻辑之间的一个桥梁，帮助我们在Timeline播放的过程中自定义响应做一些表现。</p>
<h3 id="Timeline-instance"><a href="#Timeline-instance" class="headerlink" title="Timeline instance"></a>Timeline instance</h3><h4 id="介绍-1"><a href="#介绍-1" class="headerlink" title="介绍"></a>介绍</h4><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/TimelineOverview.html"> <strong>Timeline instance</strong>: Stores links to the specific GameObjects being animated or affected by the Timeline Asset. These links, referred to as <strong>bindings</strong>, are saved to the Scene. </a></p>
<p>要想关联场景物体和Timeline Asset让我们制作的电影过场动起来，我们需要创建Timeline instance(这里指的Playable Director组件)。</p>
<p><img src="/img/Unity/Timeline_Cinemachine/TimelinePlayableDirectorInspector.png" alt="TimelinePlayableDirectorInspector"></p>
<p>可以看到我们通过Timeline Asset录制的动画是通过Playable Director的Bindings动态关联到了场景物体上。</p>
<p>Note:<br><strong>因为Timeline Asset是纯数据，Timeline instance决定了数据关联的对象，所以我们可以重用Timeline Asset对不同的物体做动画表现。</strong></p>
<h3 id="Timeline类设计"><a href="#Timeline类设计" class="headerlink" title="Timeline类设计"></a>Timeline类设计</h3><h4 id="Playable"><a href="#Playable" class="headerlink" title="Playable"></a>Playable</h4><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/Playables.html">The <strong>Playables</strong> API provides a way to create tools, effects or other gameplay mechanisms by organizing and evaluating data sources in a tree-like structure known as the PlayableGraph. The PlayableGraph allows you to mix, blend, and modify multiple data sources, and play them through a single output.</a></p>
<p>从介绍个人的理解，Playable是一套可自定义数据处理流程成树状结构的工具。而自定义出来的树状结构数据就叫做PlayableGraph(后续会讲到)。而Timeline的核心正是Playable。</p>
<p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/Playables.html">使用Playables API的好处:</a></p>
<ul>
<li>The Playables API allows for dynamic animation blending. This means that objects in the <strong>scenes</strong><br>could provide their own animations. For example, animations for weapons, chests, and traps could be dynamically added to the PlayableGraph and used for a certain duration.</li>
<li>The Playables API allows you to easily play a single animation without the overhead involved in creating and managing an AnimatorController asset.</li>
<li>The Playables API allows users to dynamically create blending graphs and control the blending weights directly frame by frame.</li>
<li>A PlayableGraph can be created at runtime, adding playable node as needed, based on conditions. Instead of having a huge “one-size-fit-all” graph where nodes are enabled and disabled, the PlayableGraph can be tailored to fit the requirements of the current situation.</li>
</ul>
<p>官网上介绍了Playable的不少好处，从介绍可以看出最大的好处就是运行时自定义组装数据处理流程，避免离线构建一套过于臃肿的数据定义(比如AnimatorController)</p>
<p>Note:</p>
<ol>
<li><strong>Playable是Struct而非Class，为了避免内存分配导致GC</strong></li>
<li><strong>Playable和PlayableOutput没有提供太多方法，而是通过PlayableExtension和PlayableOutputExtension用扩展方法的方式来提供的方法</strong></li>
</ol>
<h4 id="PlayableGraph"><a href="#PlayableGraph" class="headerlink" title="PlayableGraph"></a>PlayableGraph</h4><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/Playables-Graph.html">The PlayableGraph defines a set of playable outputs that are bound to a <strong>GameObject</strong> or component. The PlayableGraph also defines a set of <strong>playables</strong> and their relationships. Figure 1 provides an example.</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/Playables-Graph.html">The PlayableGraph is responsible for the life cycle of its playables and their outputs. Use the PlayableGraph to create, connect, and destroy playables.</a></p>
<p>从上面的介绍，个人理解，PlayableGraph是一个自定义数据处理流程的完整单位，负责自定义数据处理流程里的节点定义，关联，以及生命周期。PlayableGraph是由Plyable(e.g.Playable,MixPlayable)+PlayableOuput组成。</p>
<h4 id="PlayableAsset"><a href="#PlayableAsset" class="headerlink" title="PlayableAsset"></a>PlayableAsset</h4><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/ScriptReference/Playables.PlayableAsset.html">A base class for assets that can be used to instantiate a Playable at runtime.</a></p>
<p>PlayableAsset是自定义Playable时定义数据Asset的基类。</p>
<h4 id="PlayableBehaviour"><a href="#PlayableBehaviour" class="headerlink" title="PlayableBehaviour"></a>PlayableBehaviour</h4><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/ScriptReference/Playables.PlayableBehaviour.html">PlayableBehaviour is the base class from which every custom playable script derives.</a></p>
<p>PlayableBehaviour是自定义Playable时定义行为实现的脚本基类。</p>
<h4 id="PlayableOutput"><a href="#PlayableOutput" class="headerlink" title="PlayableOutput"></a>PlayableOutput</h4><p>个人理解是定义Playable里面的输出节点。所有的输入节点最后连接成树状结构后连到输出节点上，执行出自定义行为的输出表现。</p>
<p>参考下图:</p>
<p><img src="/img/Unity/Timeline_Cinemachine/PlayableOutputPreview.PNG" alt="PlayableOutputPreview"></p>
<h4 id="PlayableBinding"><a href="#PlayableBinding" class="headerlink" title="PlayableBinding"></a>PlayableBinding</h4><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/ScriptReference/Playables.PlayableBinding.html">Struct that holds information regarding an output of a PlayableAsset. PlayableAssets specify the type of outputs it supports using PlayableBindings.</a></p>
<p>看介绍PlayableBinding是用于定义并持有PlayableAsset的数据输出信息。</p>
<h4 id="ExposedReference"><a href="#ExposedReference" class="headerlink" title="ExposedReference"></a>ExposedReference</h4><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/ScriptReference/ExposedReference_1.html">Creates a type whos value is resolvable at runtime. ExposedReference is a generic type that can be used to create references to Scene objects and resolve their actual values at runtime and by using a context object. This can be used by assets, such as a ScriptableObject or PlayableAsset to create references to Scene objects.</a></p>
<p>从介绍可以看出，ExposedReference是用于创建一个类型(其值在运行时处理绑定的)。用于解决PlayableAsset引用场景对象组件数据等问题。</p>
<h4 id="辅助工具-GraphVisualizer"><a href="#辅助工具-GraphVisualizer" class="headerlink" title="辅助工具(GraphVisualizer)"></a>辅助工具(GraphVisualizer)</h4><p><a target="_blank" rel="noopener" href="https://github.com/Unity-Technologies/graph-visualizer">The PlayableGraph Visualizer is a tool that displays the PlayableGraphs in the scene. It can be used in both Play and Edit mode and will always reflect the current state of the graph. </a></p>
<p>因为Playable的设计很庞大，里面有很多类和概念，为了方便理解Playable设计和使用可视化的查看构建出来的PlayableGraph显得额外有用，而PlayableGraph Visualizer正是这么一款工具。</p>
<p>接下来我们结合GraphVisualizer动态通过代码创建模拟用Playable API实现动画Animator Controller里的动画状态机类似的效果，从而深入学习理解Playable里各个类的设计和使用。</p>
<h5 id="单AnimationClip单AniamtionOuput的动画播放"><a href="#单AnimationClip单AniamtionOuput的动画播放" class="headerlink" title="单AnimationClip单AniamtionOuput的动画播放"></a>单AnimationClip单AniamtionOuput的动画播放</h5><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建动画播放PlayableGraph</span></span><br><span class="line">mCustomGraph = PlayableGraph.Create(<span class="string">&quot;DIYAnimationPlayableGraph&quot;</span>);</span><br><span class="line"><span class="comment">// 创建动画播放PlyableGraph的PlayableOutput</span></span><br><span class="line"><span class="keyword">var</span> animoutput = AnimationPlayableOutput.Create(mCustomGraph, <span class="string">&quot;AnimationOutput&quot;</span>, CustomAnimator1);</span><br><span class="line"><span class="comment">// 创建动画播放PlyableGraph的动画Playable</span></span><br><span class="line"><span class="keyword">var</span> animationclipplayable = AnimationClipPlayable.Create(mCustomGraph, CustomAnimationClip1);</span><br><span class="line"><span class="comment">// 设置动画播放PlayableOutput的关联Playable</span></span><br><span class="line">animoutput.SetSourcePlayable(animationclipplayable);</span><br><span class="line"><span class="comment">// 播放创建的PlayableGraph</span></span><br><span class="line">mCustomGraph.Play();</span><br></pre></td></tr></table></figure>

<p>通过上面的代码我们动态创建了1个PlayableGraph，1个动画Plyable，1个动画PlayableOutput作为动画播放输出，并设置他们之间的关联，运行代码打开PlayableGraphVisualizer就可以查看到生成的单动画Clip播放PlayableGraph图了。</p>
<p><img src="/img/Unity/Timeline_Cinemachine/PlayableGraphVisualizerPreview.PNG" alt="PlayableGraphVisualizerPreview"></p>
<h5 id="多AnimationClip混合"><a href="#多AnimationClip混合" class="headerlink" title="多AnimationClip混合"></a>多AnimationClip混合</h5><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建动画播放PlayableGraph</span></span><br><span class="line">mCustomGraph = PlayableGraph.Create(<span class="string">&quot;DIYAnimationPlayableGraph&quot;</span>);</span><br><span class="line"><span class="comment">// 创建动画播放PlyableGraph的PlayableOutput</span></span><br><span class="line"><span class="keyword">var</span> animationOutput = AnimationPlayableOutput.Create(mCustomGraph, <span class="string">&quot;AnimationOutput&quot;</span>, CustomAnimator1);</span><br><span class="line"><span class="comment">// 创建动画播放混合Playable(设置两个输入Playable)</span></span><br><span class="line">mAnimationMixerPlayable = AnimationMixerPlayable.Create(mCustomGraph, <span class="number">2</span>);</span><br><span class="line"><span class="comment">// 关联动画混合Playable到PlaybleOutput作为唯一输入</span></span><br><span class="line">animationOutput.SetSourcePlayable(mAnimationMixerPlayable);</span><br><span class="line"><span class="comment">// 创建动画播放PlyableGraph的动画播放Playable1和Playable2</span></span><br><span class="line"><span class="keyword">var</span> animationClipPlayable1 = AnimationClipPlayable.Create(mCustomGraph, CustomAnimationClip1);</span><br><span class="line"><span class="keyword">var</span> animationClipPlayable2 = AnimationClipPlayable.Create(mCustomGraph, CustomAnimationClip2);</span><br><span class="line"><span class="comment">// 关联动画播放Playable1和Playable2作为动画混合Playable的输入连接(分别连接输入0和输入1接口)</span></span><br><span class="line">mCustomGraph.Connect(animationClipPlayable1, <span class="number">0</span>, mAnimationMixerPlayable, <span class="number">0</span>);</span><br><span class="line">mCustomGraph.Connect(animationClipPlayable2, <span class="number">0</span>, mAnimationMixerPlayable, <span class="number">1</span>);</span><br><span class="line"><span class="comment">// 播放创建的PlayableGraph</span></span><br><span class="line">mCustomGraph.Play();</span><br></pre></td></tr></table></figure>

<p>通过上面的代码我们动态创建了一个PlayableGraph，2个动画Plyable作为基础输入，1个动画混合Playable作为混合节点，1个动画PlayableOutput作为动画播放输出，并设置他们之间的关联，运行代码打开PlayableGraphVisualizer就可以查看到生成的动画混合播放PlayableGraph图了。</p>
<p><img src="/img/Unity/Timeline_Cinemachine/AnimationClipMixPreview.PNG" alt="AnimationClipMixPreview"></p>
<h5 id="多AnimationClip多AnimationOuput"><a href="#多AnimationClip多AnimationOuput" class="headerlink" title="多AnimationClip多AnimationOuput"></a>多AnimationClip多AnimationOuput</h5><p><strong>一个PlayableGraph是可以拥有多个PlayableOutput输出的</strong></p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建动画播放PlayableGraph</span></span><br><span class="line">mCustomGraph = PlayableGraph.Create(<span class="string">&quot;DIYAnimationPlayableGraph&quot;</span>);</span><br><span class="line"><span class="comment">// 创建动画播放PlyableGraph的PlayableOutput1和PlayableOutput2</span></span><br><span class="line"><span class="keyword">var</span> animationOutput1 = AnimationPlayableOutput.Create(mCustomGraph, <span class="string">&quot;AnimationOutput1&quot;</span>, CustomAnimator1);</span><br><span class="line"><span class="keyword">var</span> animationOutput2 = AnimationPlayableOutput.Create(mCustomGraph, <span class="string">&quot;AnimationOutput2&quot;</span>, CustomAnimator2);</span><br><span class="line"><span class="comment">// 创建动画播放PlyableGraph的动画播放Playable1和Playable2</span></span><br><span class="line"><span class="keyword">var</span> animationClipPlayable1 = AnimationClipPlayable.Create(mCustomGraph, CustomAnimationClip1);</span><br><span class="line"><span class="keyword">var</span> animationClipPlayable2 = AnimationClipPlayable.Create(mCustomGraph, CustomAnimationClip2);</span><br><span class="line"><span class="comment">// 关联动画播放Playable1到动画播放PlaybleOutput1</span></span><br><span class="line"><span class="comment">// 关联动画播放Playable2到动画播放PlaybleOutput2</span></span><br><span class="line">animationOutput1.SetSourcePlayable(animationClipPlayable1);</span><br><span class="line">animationOutput2.SetSourcePlayable(animationClipPlayable2);</span><br><span class="line"><span class="comment">// 播放创建的PlayableGraph</span></span><br><span class="line">mCustomGraph.Play();</span><br></pre></td></tr></table></figure>

<p>通过上面的代码我们动态创建了一个PlayableGraph，2个动画Plyable对应2个动画PlayableOutput动画播放输出的输入，并设置他们之间的关联，运行代码打开PlayableGraphVisualizer就可以查看到生成的动画混合播放PlayableGraph图了。</p>
<p><img src="/img/Unity/Timeline_Cinemachine/MultipleAnimationInputAndOutputPreview.PNG" alt="MultipleAnimationInputAndOutputPreview"></p>
<h5 id="多AnimationClip混合并控制权重加播放状态"><a href="#多AnimationClip混合并控制权重加播放状态" class="headerlink" title="多AnimationClip混合并控制权重加播放状态"></a>多AnimationClip混合并控制权重加播放状态</h5><p><strong>不同的Playable是可以设置混合权重加播放状态的</strong></p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建动画播放PlayableGraph</span></span><br><span class="line">mCustomGraph = PlayableGraph.Create(<span class="string">&quot;DIYAnimationPlayableGraph&quot;</span>);</span><br><span class="line"><span class="comment">// 创建动画播放PlyableGraph的PlayableOutput</span></span><br><span class="line"><span class="keyword">var</span> animationOutput = AnimationPlayableOutput.Create(mCustomGraph, <span class="string">&quot;AnimationOutput1&quot;</span>, CustomAnimator1);</span><br><span class="line"><span class="comment">// 创建动画混合Playable</span></span><br><span class="line">mAnimationMixerPlayable = AnimationMixerPlayable.Create(mCustomGraph, <span class="number">2</span>);</span><br><span class="line"><span class="comment">// 设置动画混合Playalbe作为动画播放输出Playable</span></span><br><span class="line">animationOutput.SetSourcePlayable(mAnimationMixerPlayable);</span><br><span class="line"><span class="comment">// 创建动画播放PlyableGraph的动画播放Playable1和Playable2</span></span><br><span class="line"><span class="keyword">var</span> animationClipPlayable1 = AnimationClipPlayable.Create(mCustomGraph, CustomAnimationClip1);</span><br><span class="line"><span class="keyword">var</span> animationClipPlayable2 = AnimationClipPlayable.Create(mCustomGraph, CustomAnimationClip2);</span><br><span class="line"><span class="comment">// 设置动画混合输入和权重</span></span><br><span class="line">mCustomGraph.Connect(animationClipPlayable1, <span class="number">0</span>, mAnimationMixerPlayable, <span class="number">0</span>);</span><br><span class="line">mCustomGraph.Connect(animationClipPlayable2, <span class="number">0</span>, mAnimationMixerPlayable, <span class="number">1</span>);</span><br><span class="line">mAnimationMixerPlayable.SetInputWeight(<span class="number">0</span>, <span class="number">1.0f</span>);</span><br><span class="line">mAnimationMixerPlayable.SetInputWeight(<span class="number">1</span>, <span class="number">1.0f</span>);</span><br><span class="line"><span class="comment">// 暂停动画播放Playable1</span></span><br><span class="line">animationClipPlayable1.Pause();</span><br><span class="line"><span class="comment">// 播放创建的PlayableGraph</span></span><br><span class="line">mCustomGraph.Play();</span><br></pre></td></tr></table></figure>

<p>通过上面的代码我们动态创建了一个PlayableGraph，2个动画Plyable作为动画混合Playable的输入,1个动画混合Playable作为动画播放输出的输入,1个PlayableOutput作为动画播放输出，并设置他们之间的关联和权重，并把其中一个动画播放Playable设置成暂停状态，运行代码打开PlayableGraphVisualizer就可以查看到生成的动画混合播放PlayableGraph图了。</p>
<p><img src="/img/Unity/Timeline_Cinemachine/MultipleAnimationBlendAndSetPlayableState.PNG" alt="MultipleAnimationBlendAndSetPlayableState"></p>
<p>Note:</p>
<ol>
<li><strong>父Playable的播放状态设置会影响所有子节点Playable播放状态</strong></li>
</ol>
<h3 id="Timeline实战"><a href="#Timeline实战" class="headerlink" title="Timeline实战"></a>Timeline实战</h3><p>通过上面有了基础的知识后，接下来我们以实战的方式深入学习Timeline。</p>
<ul>
<li>目标</li>
</ul>
<ol>
<li>人物模型移动(Timeline自带)+人物模型动画播放(Timeline自带)+镜头移动(Cinemachine+Timeline)+2D对话+3D气泡对话的剧情表现+特效播放(Timeline自带)+音乐播放控制(扩展自定义Track，方便走自己的音效播放接口)</li>
<li>支持Timeline Editor拖拽预览+运行时播放预览</li>
</ol>
<ul>
<li>功能开发</li>
</ul>
<ol>
<li>音乐播放控制(扩展自定义Track，方便走自己的音效播放接口)</li>
<li>Timeline模型移动控制Track(TimeLine支持)</li>
<li>学习Cinemachine扩展Timeline的Track使用控制镜头移动表现</li>
<li>实现2D气泡对话+3D对话功能</li>
<li>扩展Timneline实现2D气泡对话Track+3D对话Track</li>
<li>动态创建实体对象的自定义Track绑定控制(如何实现?)</li>
</ol>
<ul>
<li>准备工作</li>
</ul>
<ol>
<li>Package Manager里安装Cinemachine模块</li>
<li>下载导入模型特效音效等相关资源</li>
</ol>
<p>安装好Cinemachine后，打开Timeline里面就会看到多了Cinemachine的Track，从而就可以在Timeline里使用Cinemachine相关的扩展功能了:</p>
<p><img src="/img/Unity/Timeline_Cinemachine/TimelineCinemachineTrack.png" alt="TimelineCinemachineTrack"></p>
<p>首先我们先放一下我们自定义制作的Timeline的预制件结构:</p>
<p><img src="/img/Unity/Timeline_Cinemachine/CustomTimelinePrefabHierachyPreview.PNG" alt="CustomTimelinePrefabHierachyPreview"></p>
<hr>
<p><strong>音乐播放控制Track</strong></p>
<p>CustomAduioTrack.cs(自定义音乐播放Track)</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> CustomAudioTrack.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 自定义音效Track</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">TrackClipType(typeof(CustomAudioAsset))</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CustomAudioTrack</span> : <span class="title">PlayableTrack</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>CustomAudioAsset.cs(自定义音乐播放Asset数据结构)</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> CustomAudioAsset.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 自定义音效播放Asset</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CustomAudioAsset</span> : <span class="title">BaseGameAsset</span>, <span class="title">ITimelineClipAsset</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 音效类型</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">enum</span> AudioType</span><br><span class="line">    &#123;</span><br><span class="line">        Bgm = <span class="number">1</span>,            <span class="comment">// 背景音乐</span></span><br><span class="line">        Sound = <span class="number">2</span>,          <span class="comment">// 音效</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 音效播放组件</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> ExposedReference&lt;AudioSource&gt; SourceAudio;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 播放的音效类型</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> AudioType PlayedAudioType = AudioType.Bgm;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 音效资源路径</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> AudioPath;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 不支持重叠</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> ClipCaps clipCaps</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span> &#123; <span class="keyword">return</span> ClipCaps.None; &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> Playable <span class="title">CreatePlayable</span>(<span class="params">PlayableGraph graph, GameObject owner</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> playable = ScriptPlayable&lt;CustomAudioBehaviour&gt;.Create(graph);</span><br><span class="line">        <span class="keyword">var</span> audiobehaviour = playable.GetBehaviour();</span><br><span class="line">        audiobehaviour.Name = Name;</span><br><span class="line">        audiobehaviour.SourceAudio = SourceAudio.Resolve(graph.GetResolver());</span><br><span class="line">        audiobehaviour.PlayedAudioType = PlayedAudioType;</span><br><span class="line">        audiobehaviour.AudioPath = AudioPath;</span><br><span class="line">        <span class="keyword">return</span> playable;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>CustomAudioBehaviour.cs(自定义音乐播放行为)</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> CustomAudioBehaviour.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 自定义音效播放Behaviour</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CustomAudioBehaviour</span> : <span class="title">BaseGameBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 音效播放组件</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> AudioSource SourceAudio;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 播放的音效类型</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> CustomAudioAsset.AudioType PlayedAudioType;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 音效资源路径</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> AudioPath;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 是否正在播放音乐</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">bool</span> mIsPlayingAudio;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnBehaviourPlay</span>(<span class="params">Playable playable, FrameData info</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Debug.Log(<span class="string">$&quot;AudioBehaviour:OnBehaviourPlay() 执行指令:<span class="subst">&#123;Name&#125;</span>&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Called each frame while the state is set to Play</span></span><br><span class="line">    <span class="comment">// Playable更新执行时</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">ProcessFrame</span>(<span class="params">Playable playable, FrameData info, <span class="built_in">object</span> playerData</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">		TryPlayAudio();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Called when the state of the playable is set to Paused</span></span><br><span class="line">    <span class="comment">// Playable暂停执行时</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnBehaviourPause</span>(<span class="params">Playable playable, FrameData info</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Debug.Log(<span class="string">$&quot;AudioBehaviour:OnBehaviourPause() 执行指令:<span class="subst">&#123;Name&#125;</span>&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(SourceAudio != <span class="literal">null</span> &amp;&amp; SourceAudio.clip != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            SourceAudio.clip = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        mIsPlayingAudio = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 尝试执行音乐播放</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">TryPlayAudio</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(mIsPlayingAudio == <span class="literal">false</span> &amp;&amp; SourceAudio != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (PlayedAudioType == CustomAudioAsset.AudioType.Bgm)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// <span class="doctag">TODO:</span> 走背景音乐播放接口</span></span><br><span class="line">                SourceAudio.clip = Resources.Load&lt;AudioClip&gt;(AudioPath);</span><br><span class="line">                SourceAudio.Play();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (PlayedAudioType == CustomAudioAsset.AudioType.Sound)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// <span class="doctag">TODO:</span> 走音效播放接口</span></span><br><span class="line">                SourceAudio.clip = Resources.Load&lt;AudioClip&gt;(AudioPath);</span><br><span class="line">                SourceAudio.Play();</span><br><span class="line">            &#125;</span><br><span class="line">            mIsPlayingAudio = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下来看下我们自定义的音效播放Track和音乐Asset的使用面板效果:</p>
<p><img src="/img/Unity/Timeline_Cinemachine/CustomAudioTrackPreview.PNG" alt="CustomAudioTrackPreview"></p>
<p><img src="/img/Unity/Timeline_Cinemachine/CustomAudioAssetBGMInspector.PNG" alt="CustomAudioAssetBGMInspector"></p>
<p><img src="/img/Unity/Timeline_Cinemachine/CustomAudioAssetSoundInspector.PNG" alt="CustomAudioAssetSoundInspector"></p>
<p>从上面可以看到，我们通过ExposedReference<AudioSource>的方式，挂载绑定了场景里的AudioSource作为背景音乐和音效播放组件。</p>
<p>接下来为了避免每一个CustomAudioAsset都自己去指定AudioSource绑定组件，我们可以通过在CustomAudioTrack来支持在Track统一指定AudioSource。</p>
<p>CustomAudioTrack.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> CustomAudioTrack.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 自定义音效Track</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">TrackClipType(typeof(CustomAudioAsset))</span>]</span><br><span class="line">[<span class="meta">TrackBindingType(typeof(AudioSource))</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CustomAudioTrack</span> : <span class="title">PlayableTrack</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>CustomAudioBehaviour.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> CustomAudioBehaviour.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 自定义音效播放Behaviour</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CustomAudioBehaviour</span> : <span class="title">BaseGameBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    ******</span><br><span class="line">        </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 音效播放组件</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> AudioSource mSourceAudio;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Called each frame while the state is set to Play</span></span><br><span class="line">    <span class="comment">// Playable更新执行时</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">ProcessFrame</span>(<span class="params">Playable playable, FrameData info, <span class="built_in">object</span> playerData</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(mSourceAudio == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            mSourceAudio = playerData <span class="keyword">as</span> AudioSource;</span><br><span class="line">        &#125;</span><br><span class="line">        TryPlayAudio();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">	******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>CustomAudioTrack通过声明TrackBindingType(typeof(AudioSource))指定Track可以绑定AudioSource组件。</p>
<p>CustomAudioBehaviour通过在运行时ProcessFrame里动态使用Track上指定的AudioSource组件作为音乐播放组件来实现CustomAudioBehaviour采用Track统一绑定组件的的效果。</p>
<p><img src="/img/Unity/Timeline_Cinemachine/CustomAudioTrackWithAudioSourceBindingPreview.PNG" alt="CustomAudioTrackWithAudioSourceBindingPreview"></p>
<h3 id="进阶"><a href="#进阶" class="headerlink" title="进阶"></a>进阶</h3><p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/69e60a27bccb">Unity使用Cinemachine和Timeline入门</a><br><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Packages/com.unity.cinemachine@2.3/manual/CinemachineTimeline.html">Cinemachine and Timeline</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.unity.com/tutorial/cinemachine">Cinemachine</a></p>
<p>Timeline可以看做是自定义展示效果的工具，而Cinemachine可以看做是多摄像机的一套完整控制表现的工具。</p>
<p>更多的Cinemachine学习见后面</p>
<h2 id="Cinemachine"><a href="#Cinemachine" class="headerlink" title="Cinemachine"></a>Cinemachine</h2><p><a target="_blank" rel="noopener" href="https://unity.com/unity/features/editor/art-and-design/cinemachine">Powering cameras for films and games</a></p>
<p>根据官网的简单介绍可以看出，Cinemachine是官方出的一款摄像机强大的控制系统，通过该系统，我们可以轻松的做到电影或者游戏级别的摄像机功能以及表现。</p>
<p>博主这里考虑学习使用Cinemachine的一个重大原因是，做赛车游戏，希望有一个稳定(不抖动)跟随的摄像机。(自己写的效果有抖动问题)</p>
<p>Cinemachine里有两个重要的组件和概念:</p>
<ol>
<li>Cinemachine Brain</li>
<li>Virtual Cameras</li>
</ol>
<h3 id="Cinemachine-Brain"><a href="#Cinemachine-Brain" class="headerlink" title="Cinemachine Brain"></a>Cinemachine Brain</h3><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Packages/com.unity.cinemachine@2.3/manual/CinemachineOverview.html">The Cinemachine Brain is a component in the Unity Camera itself. Cinemachine Brain monitors all active Virtual Cameras in the Scene. To specify the next live Virtual Camera, you <a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/DeactivatingGameObjects.html">activate or deactivate</a> the desired Virtual Camera’s game object. </a></p>
<p>从上面的介绍可以看出，Cinemachine Brain组件式挂载在摄像机对象上的一个组件，负责管理所有Virual Camera，同一时间只有一个Virtual Camera起作用用于主摄像机，优先选择Priority高的已激活Virutal Camera作为当前起作用的摄像机，优先级相同的情况下看哪个Virtual Camera后激活优先。</p>
<p><img src="/img/Unity/Timeline_Cinemachine/CinemachineBrain.PNG" alt="CinemachineBrain"></p>
<p>关于Cinemachine Brain的详细参数介绍，这里就不深入探讨了，感兴趣的朋友参考文档去自行了解。</p>
<p>Note:</p>
<ol>
<li>Timeline重写了Cinemachine Brain的Priority系统可以更好的控制摄像机达到更精准的摄像机控制。</li>
</ol>
<h3 id="Virtual-Cameras"><a href="#Virtual-Cameras" class="headerlink" title="Virtual Cameras"></a>Virtual Cameras</h3><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Packages/com.unity.cinemachine@2.3/manual/CinemachineOverview.html">Cinemachine does not create new cameras. Instead, it directs a single Unity camera for multiple shots. You compose these shots with <strong>Virtual Cameras</strong>. Virtual Cameras move and rotate the Unity camera and control its settings.</a></p>
<p>从上面的介绍可以知道，Cinemachine里的Virtual Cameras并非真正的Camera组件，而是一个抽象概念，而这个抽象的Virtuel Cameras会去负责控制真正的摄像机达到预定的效果。</p>
<p>每一个Virtual Cameras都会对应一个GameObject和一个CinemachineVirtualCamera组件脚本:</p>
<p><img src="/img/Unity/Timeline_Cinemachine/CinemachineVirtualCamera.PNG" alt="CinemachineVirtualCamera"></p>
<h4 id="Virtual-Camera-States"><a href="#Virtual-Camera-States" class="headerlink" title="Virtual Camera States"></a>Virtual Camera States</h4><p>Virtual Camera有三种状态:</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Packages/com.unity.cinemachine@2.1/manual/index.html"><strong>Live</strong>:The virtual camera is actively controlling the Unity Camera. The virtual camera is tracking its targets and being updated every frame.</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Packages/com.unity.cinemachine@2.1/manual/index.html"><strong>Standby</strong>: The virtual camera is tracking its targets and being updated every frame, but no Unity Camera is actively being controlled by it. This is the state of a virtual camera that is enabled in the scene but perhaps at a lower priority than the Live virtual camera.</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Packages/com.unity.cinemachine@2.1/manual/index.html"><strong>Disabled</strong>: The virtual camera is present but disabled in the scene. It is not actively tracking its targets and so consumes no processing power. However, the virtual camera can be made live from the Timeline.</a></li>
</ol>
<p>从介绍可以看到Live是指当前Virtual Camera优先级最高起作用的那个。而Standby是优先级低于当前起作用的Virtual Camera但没有Disable的Virtual Camera，这些摄像机逻辑上依然会更新跟随自己设定的对象，但不会影响真实摄像机运作。最后Disabled是即低于当前最高优先级Virtual Camera也没有激活的Virtual Camera，这类摄像机不会有任何运行开销，逻辑层面也不会在继续跟随自己的目标对象。</p>
<h4 id="Virtual-Camera-Params"><a href="#Virtual-Camera-Params" class="headerlink" title="Virtual Camera Params"></a>Virtual Camera Params</h4><p>关于Virtual Camera的细节参数学习，接下来学习几个重要的参数，更多的细节参考:</p>
<p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Packages/com.unity.cinemachine@2.3/manual/CinemachineOverview.html">Cinemachine overview</a></p>
<p><strong>Priority</strong>正如前面提到的，决定了Virtual Camera在Cinemachine Brain里的选择优先级。</p>
<p><strong>Follow</strong>和<strong>Look At</strong>两个参数分别决定了摄像机的跟随对象和对焦对象，这两个参数是常规游戏类型里都需要的概念，好比博主当前要做的赛车游戏，Follow和Look At对象都是赛车就能做到跟随和聚焦赛车的效果。</p>
<p><strong>Body</strong>属性提供了Virtual Camera对于摄像机移动的算法选择，从而达到适配各种游戏类型的摄像机镜头移动要求。</p>
<p><img src="/img/Unity/Timeline_Cinemachine/CinemachineBodyProperties.PNG" alt="CinemachineBodyProperties"></p>
<p>这里博主的赛车游戏默认选择Transposer来达到平滑跟随效果。</p>
<p><strong>Aim</strong>属性提供了Virtual Camera对于佘香即旋转的算法选择，从而达到适配各种游戏类型的摄像机镜头选择要求。</p>
<p><img src="/img/Unity/Timeline_Cinemachine/CinemachineAimProperties.PNG" alt="CinemachineAimProperties"></p>
<p><strong>Body</strong>和<strong>Aim</strong>通过细节的参数调整能实现各种角度以及各种游戏类型需求的摄像机跟随聚焦效果，这里博主暂时就不深入学习讨论了，有兴趣的可以参考文档去了解细节。</p>
<p>那么Virtual Camera的聚焦效果是如何实现的了？</p>
<p>了解聚焦效果之前有几个重钙的概念需要了解:</p>
<ol>
<li><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Packages/com.unity.cinemachine@2.3/manual/CinemachineOverview.html"><strong>Dead zone</strong>: The area of the frame that Cinemachine keeps the target in.</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Packages/com.unity.cinemachine@2.3/manual/CinemachineOverview.html"><strong>Soft zone</strong>: If the target enters this region of the frame, the camera will re-orient to put it back in the dead zone. It will do this slowly or quickly, according to the time specified in the Damping settings.</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Packages/com.unity.cinemachine@2.3/manual/CinemachineOverview.html"><strong>Screen</strong>: The screen position of the center of the dead zone. 0.5 is the center of the screen.</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Packages/com.unity.cinemachine@2.3/manual/CinemachineOverview.html"><strong>Damping</strong>: Simulates the lag that a real camera operator introduces while operating a heavy physical camera. Damping specifies quickly or slowly the camera reacts when the target enters the <strong>soft zone</strong> while the camera tracks the target. Use small numbers to simulate a more responsive camera, rapidly moving or aiming the camera to keep the target in the <strong>dead zone</strong>. Larger numbers simulate heavier cameras, The larger the value, the more Cinemachine allows the target to enter the soft zone.</a></p>
</li>
</ol>
<p><img src="/img/Unity/Timeline_Cinemachine/CinemachineZone.PNG" alt="CinemachineZone"></p>
<p>Dead Zone, Soft Zone, Screen参数在Body和Aim的属性面板上有体现，他们决定了摄像机是如何应对Look At对象走出指定区域时响应变化以及如何确保Look At对象在指定区域内的。</p>
<h3 id="Cinemachine-Camera-Types"><a href="#Cinemachine-Camera-Types" class="headerlink" title="Cinemachine Camera Types"></a>Cinemachine Camera Types</h3><p>Unity Cinemachine自带了很多种摄像机用于不同的游戏种类:</p>
<p><img src="/img/Unity/Timeline_Cinemachine/CinemachineCameraTypes.PNG" alt="CinemachineCameraTypes"></p>
<p>不同的摄像机种类适用于不同的游戏类型。</p>
<h4 id="Virtual-Camera"><a href="#Virtual-Camera" class="headerlink" title="Virtual Camera"></a>Virtual Camera</h4><p>Virtual Camera在前面的介绍已经提过了，这里就不再重复了，后续的摄像机类型大部分也是基于Virtual Camera的，只是在Virtual Camera的基础上实现了一套各自摄像机管理方式从而达到不同的摄像机类型效果。</p>
<h4 id="FreeLook-Camera"><a href="#FreeLook-Camera" class="headerlink" title="FreeLook Camera"></a>FreeLook Camera</h4><p>此类摄像机没有基于Virtual Camera而是单独挂载了一个Cinemachine Free Look的脚本实现的。</p>
<p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Packages/com.unity.cinemachine@2.1/manual/index.html#collision-avoidance-and-shot-evaluation">A Cinemachine Camera geared towards a 3rd person camera experience. The camera orbits around its subject with three separate camera rigs defining rings around the target. Each rig has its own radius, height offset, composer, and lens settings. Depending on the camera’s position along the spline connecting these three rigs, these settings are interpolated to give the final camera position and state.</a></p>
<p>从介绍可以看出，FreeLook Camera是用于第三人称围绕目标对象旋转控制的一套摄像机类型(比如第三人称RPG等游戏，有围绕主角相关的摄像机旋转控制等)。</p>
<h4 id="State-Driven-Camera"><a href="#State-Driven-Camera" class="headerlink" title="State-Driven Camera"></a>State-Driven Camera</h4><p>这里的State指的是Animator里的State，通过State-Drive Camera我们可以轻易的实现Animator State和Virtual Camera选择的绑定。这样就能轻易实现Walk状态用什么Virtual Camera，Idle状态使用什么Virtual Camera的效果。</p>
<p>更多的摄像机类型参考:</p>
<p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Packages/com.unity.cinemachine@2.1/manual/index.html">About Cinemachine</a></p>
<p>这里还值得一提的是摄像机限定移动范围和摄像机被障碍物主档导致目标对象不可见时Cinemachine提供的一种解决方案：</p>
<h3 id="Collision-Avoidance-and-Shot-Evaluation"><a href="#Collision-Avoidance-and-Shot-Evaluation" class="headerlink" title="Collision Avoidance and Shot Evaluation"></a>Collision Avoidance and Shot Evaluation</h3><h4 id="CinemachineCollider"><a href="#CinemachineCollider" class="headerlink" title="CinemachineCollider"></a>CinemachineCollider</h4><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Packages/com.unity.cinemachine@2.1/manual/index.html#collision-avoidance-and-shot-evaluation">An add-on module for Cinemachine Virtual Camera that post-processes the final position of the virtual camera. Based on the supplied settings, the Collider will attempt to preserve the line of sight with the LookAt target of the virtual camera by moving away from objects that will obstruct the view.</a></p>
<p>简单来说CinemachineCollider是通过相关设置，通过射线检测评估出当前摄像机最优的位置，从而避免被障碍物遮挡视线等问题。</p>
<p>Note:</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Packages/com.unity.cinemachine@2.1/manual/index.html#collision-avoidance-and-shot-evaluation">The collider uses Physics Raycasts to do these things, hence obstacles in the scene must have collider volumes in order to be visible to the CinemachineCollider.</a></li>
</ol>
<h4 id="CinemachineConfiner"><a href="#CinemachineConfiner" class="headerlink" title="CinemachineConfiner"></a>CinemachineConfiner</h4><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Packages/com.unity.cinemachine@2.1/manual/index.html#collision-avoidance-and-shot-evaluation">An add-on module for Cinemachine Virtual Camera that post-processes the final position of the virtual camera. It will confine the virtual camera’s position to the volume specified in the Bounding Volume field.</a></p>
<p>从介绍可以看出CinemachineConfiner相比CinemachineCollider，这是一个单纯限制摄像机运动范围的组件，更加轻量，没有过多多射线检测评估等过程，用于简单的限制摄像机运动范围，此组件更佳。</p>
<p>Note:</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Packages/com.unity.cinemachine@2.1/manual/index.html#collision-avoidance-and-shot-evaluation">This is less resource-intensive than CinemachineCollider, but it does not perform shot evaluation.</a></li>
</ol>
<h3 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h3><p>实战前，先让我们明确下个人的摄像机需求，需求明确了才能更加正确的使用Cinemachine达到效果。</p>
<p>摄像机需求:</p>
<ol>
<li>支持相机单独控制操作</li>
<li>支持相机限定移动范围操作</li>
<li>支持相机锁定目标操作</li>
<li>支持相机锁定目标和自由操作自由切换操作</li>
<li>支持相机锁定目标操作回调上层逻辑(用于配合逻辑层做事情)</li>
<li>场景摄像机支持多个摄像机同时控制(比如:MainCamera和3D UI Camera)</li>
</ol>
<p>待续……</p>
<h2 id="TextMeshPro"><a href="#TextMeshPro" class="headerlink" title="TextMeshPro"></a>TextMeshPro</h2><h3 id="What-1"><a href="#What-1" class="headerlink" title="What"></a>What</h3><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/com.unity.textmeshpro.html">TextMesh Pro is the ultimate text solution for Unity. It’s the perfect replacement for Unity’s UI Text and the legacy Text Mesh.</a></p>
<p>TextMeshPro原本是第三方个人编写的一款更优的Unity文本替代方案，后被Unity官方收购。</p>
<h3 id="Why-1"><a href="#Why-1" class="headerlink" title="Why"></a>Why</h3><p>使用TextMeshPro替代原生文本的原因有很多：</p>
<ol>
<li>TMP使用了SDF(<strong>Signed Distance Field</strong>)技术达到不失真的放大缩小渲染</li>
<li>TMP自带实现了图文混排(通过富文本打Tag的形式)以及很多文本所需的功能(e.g. 字间距，自定义字体大小，段落格式，对齐方式等)</li>
<li>TMP使用Shader去实现更好的文本表现效果(类似PS的一些效果)满足文本需求</li>
</ol>
<p>缺点:</p>
<ol>
<li>不支持动态字体(看网上说是TMP1.4支持动态字体(Generating Settings)，但我在Unity2018.4.1.f1上导入的TMP没有找到动态字体设置的入口，望知道的朋友告知一声在哪里设置)，需要生成对应的字体纹理库(对于文字多的比如中文来说有很大的内存压力)</li>
</ol>
<p>SDF(<strong>Signed Distance Field</strong>)介绍:<br><a target="_blank" rel="noopener" href="http://www.sardinefish.com/blog/?pid=296">一个空间区域的SDF函数定义为，从空间中任意给定的一点到该区域边界的距离，SDF函数值的符号取决于该点在区域的内部还是外部，外部为正，内部为负。</a></p>
<p>这里可以简单的理解成TMP通过函数式的定义方式(类似矢量图的定义方式)来解决像素图放大模糊的问题来渲染出可动态放大缩小不模糊的图像。深入理解参考下面的链接：<a target="_blank" rel="noopener" href="http://www.sardinefish.com/blog/?pid=296">函数式编程与 Signed Distance Field</a></p>
<h3 id="How-1"><a href="#How-1" class="headerlink" title="How"></a>How</h3><p>TMP需要通过TMP提供的字体库制作工具制作所需的对应字体文件：<br><img src="/img/Unity/TextMeshPro/FontAssetCreatePanel.png" alt="FontAssetCreatePanel"><br>如果想要使用图文混排还需要自己制作SpriteAsset:<br><img src="/img/Unity/TextMeshPro/SpriteAssetCreatePanel.png" alt="SpriteAssetCreatePanel"><br>制作好后创建TextMeshPro组件后指定需要使用的Font Asset和Sprite Asset即可:<br><img src="/img/Unity/TextMeshPro/TextMeshProAssignFontAssetAndSpriteAsset.png" alt="TextMeshProAssignFontAssetAndSpriteAsset"></p>
<p>最终效果：<br><img src="/img/Unity/TextMeshPro/TextMeshProUsing.png" alt="TextMeshProUsing"><br>TextMeshPro同一个Font Asset需要制作不同的渲染效果需要通过制作不同的Material来实现：<br><img src="/img/Unity/TextMeshPro/CreateFontAssetMaterial.png" alt="CreateFontAssetMaterial"></p>
<p>然后在针对新创建的Material Asset调整Shader和具体效果即可，创建完成后就可以在Font Asset的材质下拉列表里选择需要使用的效果：<br><img src="/img/Unity/TextMeshPro/FontAssetMaterialChosen.png" alt="FontAssetMaterialChosen"></p>
<p>关于TextMeshPro的默认相关设置(e.g. 默认创建的Font Asset，默认Fallback到的Font Asset等)是通过TMP Settings文件里的设置来完成的:<br><img src="/img/Unity/TextMeshPro/TMPSettings.png" alt="TMPSettings"></p>
<p>Note:</p>
<ol>
<li>TMP的Fallback的使用是在原始设定的Font Asset里找不到对应文字时的一种回退安全机制，官方的建议是真正使用的Font Asset采用高分率图集，Fallback的Font Asset采用低分辨率图集。</li>
</ol>
<h1 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h1><h2 id="Sprite-Atlas-1"><a href="#Sprite-Atlas-1" class="headerlink" title="Sprite Atlas"></a>Sprite Atlas</h2><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/class-SpriteAtlas.html">Sprite Atlas</a><br><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/MasterVariantAtlases.html">Master and Variant Sprite Atlases</a><br><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/VariantSpriteAtlas.html">Variant Sprite Atlas</a><br><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/SpriteAtlasWorkflow.html">Sprite Atlas workflow</a><br><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/SpriteAtlasDistribution.html">Preparing Sprite Atlases for distribution</a><br><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/SpritePackerModes.html">Sprite Packer Modes</a><br><a target="_blank" rel="noopener" href="https://gameinstitute.qq.com/community/detail/127434">Unity2017新功能之Sprite Atlas详解</a><br><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/80584461">UGUI的图集处理方式-SpriteAtlas的前世今生</a></p>
<h2 id="Timeline-1"><a href="#Timeline-1" class="headerlink" title="Timeline"></a>Timeline</h2><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq826364410/article/details/80511057">Unity–Timeline自定义PlayableTrack</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/beihuanlihe130/article/details/79233320">Unity2017中Timeline的简单使用方法</a><br><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/69e60a27bccb">Unity使用Cinemachine和Timeline入门</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/Unity-Technologies/graph-visualizer">graph-visualizer</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.unity.com/tutorial/timeline#">Timeline</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.unity.com/technology/extending-timeline-a-practical-guide"><strong>xtending Timeline: A Practical Guide</strong></a></p>
<p><a target="_blank" rel="noopener" href="https://blog.unity.com/technology/creative-scripting-for-timeline"><strong>Creative Scripting for Timeline</strong></a></p>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=MzU5MjQ1NTEwOA==&mid=2247493316&idx=1&sn=7e4fef834a8066faca3d2f1f1a090bb4&chksm=fe1dd26fc96a5b79856840f556cf65026facb83520ac1891605e42d5e777d30a0d5219060e21&mpshare=1&scene=1&srcid=0606YJLYnfprk9UjpPQCnre1#rd">Playable API：定制你的动画系统</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/Playables.html">Playables API</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/Playables-Graph.html">The PlayableGraph</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/Playables-ScriptPlayable.html">ScriptPlayable and PlayableBehaviour</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/Playables-Examples.html">Playables Examples</a></p>
<h2 id="TextMesh-Pro"><a href="#TextMesh-Pro" class="headerlink" title="TextMesh Pro"></a>TextMesh Pro</h2><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/com.unity.textmeshpro.html">TextMesh Pro</a><br><a target="_blank" rel="noopener" href="http://www.sardinefish.com/blog/?pid=296">函数式编程与 Signed Distance Field</a><br><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/84700094">Unity游戏开发——TextMeshPro的使用</a><br><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=MzU5MjQ1NTEwOA==&mid=2247495323&idx=1&sn=3100249c5c4a88c20435d129d23eb727&chksm=fe1dda30c96a53267a53ed2bc0dd47bc73273f4e76f3a0d8f0ce322992e2e7e0b284d9a1df32&mpshare=1&scene=1&srcid=102134Bhmm1T67EKpzswm7mz#rd">在Unity 2018中充分使用TextMesh Pro</a><br><a target="_blank" rel="noopener" href="https://blogs.unity3d.com/2018/10/16/making-the-most-of-textmesh-pro-in-unity-2018/">Making the most of TextMesh Pro in Unity 2018</a></p>
<h2 id="Cinemachine-1"><a href="#Cinemachine-1" class="headerlink" title="Cinemachine"></a>Cinemachine</h2><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Packages/com.unity.cinemachine@2.3/manual/CinemachineOverview.html">Cinemachine overview</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.unity.com/tutorial/cinemachine#">Cinemachine Learn</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Unity/">Unity</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Unity/">Unity</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>







  <nav id="page-nav" class="clearfix">
    <a class="extend prev" rel="prev" href="/">&lt;span&gt;&lt;&#x2F;span&gt;Prev</a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/3/">Next&lt;span&gt;&lt;&#x2F;span&gt;</a>
  </nav>

</div>
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  


  
<div class="categorieslist">
	<p class="asidetitle">分类</p>
		<ul>
		
		  
			<li><a href="/categories/AI/" title="AI">AI<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/Algorithm/" title="Algorithm">Algorithm<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/Art/" title="Art">Art<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Automation/" title="Automation">Automation<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Collision/" title="Collision">Collision<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Database/" title="Database">Database<sup>3</sup></a></li>
		  
		
		  
			<li><a href="/categories/Editor/" title="Editor">Editor<sup>5</sup></a></li>
		  
		
		  
			<li><a href="/categories/Excel/" title="Excel">Excel<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Game/" title="Game">Game<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/HotUpdate/" title="HotUpdate">HotUpdate<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Lua/" title="Lua">Lua<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Math/" title="Math">Math<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/Native/" title="Native">Native<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/Network/" title="Network">Network<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Optimization/" title="Optimization">Optimization<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Other/" title="Other">Other<sup>5</sup></a></li>
		  
		
		  
			<li><a href="/categories/Plugin/" title="Plugin">Plugin<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/Programming/" title="Programming">Programming<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Programming-Language/" title="Programming Language">Programming Language<sup>4</sup></a></li>
		  
		
		  
			<li><a href="/categories/Rendering/" title="Rendering">Rendering<sup>4</sup></a></li>
		  
		
		  
			<li><a href="/categories/Resource/" title="Resource">Resource<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/Unity/" title="Unity">Unity<sup>7</sup></a></li>
		  
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">标签</p>
		<ul class="clearfix">
		
			
				<li><a href="/tags/Unity/" title="Unity">Unity<sup>8</sup></a></li>
			
		
			
				<li><a href="/tags/Editor/" title="Editor">Editor<sup>5</sup></a></li>
			
		
			
				<li><a href="/tags/Other/" title="Other">Other<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/AI/" title="AI">AI<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/Resource/" title="Resource">Resource<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/OpenGL/" title="OpenGL">OpenGL<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/Math/" title="Math">Math<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/Art/" title="Art">Art<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Android/" title="Android">Android<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/UI/" title="UI">UI<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/C/" title="C#">C#<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Python/" title="Python">Python<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Database/" title="Database">Database<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Shader/" title="Shader">Shader<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/SubmlineText3/" title="SubmlineText3">SubmlineText3<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Rendering/" title="Rendering">Rendering<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Native/" title="Native">Native<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Prefab/" title="Prefab">Prefab<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Plugin/" title="Plugin">Plugin<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Optimization/" title="Optimization">Optimization<sup>1</sup></a></li>
			
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">友情链接</p>
    <ul>
        
          <li>
            
            	<a href="https://coderq.com" target="_blank" title="一个面向程序员交流分享的新一代社区">码农圈</a>
            
          </li>
        
          <li>
            
            	<a href="http://wuchong.me" target="_blank" title="Jark&#39;s Blog">Jark&#39;s Blog</a>
            
          </li>
        
    </ul>
</div>

  


  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS 订阅</a>
</div>

  <div class="weiboshow">
  <p class="asidetitle">新浪微博</p>
    <iframe width="100%" height="119" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=119&fansRow=2&ptype=1&speed=0&skin=9&isTitle=1&noborder=1&isWeibo=0&isFans=0&uid=&verifier=b3593ceb&dpc=1"></iframe>
</div>


</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> Hello ,I&#39;m Larry Page in Google. <br/>
			This is my blog,believe it or not.</p>
	</section>
	 
	<div class="social-font" class="clearfix">
		
		<a href="http://weibo.com/2176287895" target="_blank" class="icon-weibo" title="微博"></a>
		
		
		
		
		
		
		
		
		
		
	</div>
			
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Jacman">Jacman</a> © 2025 
		
		<a href="/about" target="_blank" title="Tony Tang">Tony Tang</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery.qrcode-0.12.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
        
    }
  });
});
</script>












<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->



<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?e6d1f421bbc9962127a50488f9ed37d1";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>



<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="返回顶部"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
 </html>
