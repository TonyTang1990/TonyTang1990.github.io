<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha256-dABdfBfUoC8vJUBOwGVdm8L9qlMWaHTIfXt+7GnZCIo=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.22.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/page/3/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://example.com/page/3/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"en","comments":"","permalink":"","path":"page/3/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Hexo</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Hexo</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>







</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">John Doe</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">50</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">22</span>
        <span class="site-state-item-name">categories</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">33</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2019/05/20/%E7%BD%91%E7%BB%9C%E9%80%9A%E4%BF%A1%E5%92%8C%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%AD%A6%E4%B9%A0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/05/20/%E7%BD%91%E7%BB%9C%E9%80%9A%E4%BF%A1%E5%92%8C%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%AD%A6%E4%B9%A0/" class="post-title-link" itemprop="url">网络通信和服务器学习</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2019-05-20 23:29:25" itemprop="dateCreated datePublished" datetime="2019-05-20T23:29:25+08:00">2019-05-20</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-09-08 18:47:03" itemprop="dateModified" datetime="2022-09-08T18:47:03+08:00">2022-09-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Network/" itemprop="url" rel="index"><span itemprop="name">Network</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>本章节是为了记录学习游戏开发过程中的服务器搭建以及前后端网络通信相关的知识点，游戏开发中联网是必不可少的，无论是从游戏热更新(服务器通知版本以及热更相关信息)，还是游戏社交(微信分享，联机组队)，还是防破解(服务器校验)都离不开网络通信和服务器。</p>
<p>本人是前端程序，对后端服务器开发几乎一窍不通，本篇文章也算是为了开阔自己的眼界，同时也是为了未来自己的游戏有网络这一块的支持需要对服务器搭建以及网络通信要有所了解。本文着重点不在于高效和优美的框架设计，着眼于基础的网络通信和服务器搭建，而这正是此篇博客的初衷。</p>
<ul>
<li>目标</li>
</ul>
<ol>
<li>理解游戏服务器工作原理</li>
<li>理解不同服务器框架的优劣，选择合适的服务器框架</li>
<li><strong>学会搭建基础的游戏服务器，具备基础的数据存储功能(本文重点)</strong></li>
<li><strong>掌握网络通信知识，搭建前后端通信框架，支持前后端通信(本文重点)</strong></li>
</ol>
<h1 id="服务器"><a href="#服务器" class="headerlink" title="服务器"></a>服务器</h1><p>那么什么是服务器了？</p>
<p>个人简单的理解，可以把服务器理解成运行在远程电脑上，通过网络对客户端提供服务(数据处理，数据存储读取，消息转发等)的机器或者软件。</p>
<p>了解服务器架构：</p>
<p><a target="_blank" rel="noopener" href="https://www.infoq.cn/article/a-brief-history-of-the-game-server-architecture">游戏服务器架构的演进简史</a></p>
<p>从上面可以看出服务器有以下几个基础功能：</p>
<ol>
<li>对于游戏数据和玩家数据的存储(数据存储)</li>
<li>对玩家数据进行数据广播和同步(消息通信)</li>
<li>把一部分游戏逻辑在服务器上运算，做好验证，防止外挂(服务器验证)</li>
<li>服务器架构设计(容灾，性能，扩容等)</li>
</ol>
<p>第三点涉及到前后端框架设计(帧同步 or 状态同步等)，第四点更与服务器端密切相关，本文着眼点是前两点，第三点和第四点作为未来学习的一个知识点，。</p>
<h2 id="数据存储"><a href="#数据存储" class="headerlink" title="数据存储"></a>数据存储</h2><h3 id="关系型数据库"><a href="#关系型数据库" class="headerlink" title="关系型数据库"></a>关系型数据库</h3><p><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%85%B3%E7%B3%BB%E6%95%B0%E6%8D%AE%E5%BA%93">关系数据库（英语：Relational database），是创建在关系模型基础上的数据库，借助于集合代数等数学概念和方法来处理数据库中的数据。现实世界中的各种实体以及实体之间的各种联系均用关系模型来表示。</a></p>
<p>个人简单的理解，关系数据库大概就是以前学SQL的时候，数据库里通过表来抽象实体数据，表之间通过ID映射关联起来的概念(e.g. 比如数据库里有两张表，一张员工表，一张员工数据表。员工表用于抽象员工ID，员工名字，员工薪资等信息。而员工数据用于存储员工ID，员工入职日期等信息。然后两张表示通过员工ID来映射关联起来。)。</p>
<p>典型的关系型数据库:<br>MySQL</p>
<p>典型的关系型数据查询语言:<br>SQL</p>
<p>这里还值得一提的一个本地数据库：<br>SQLite</p>
<p>详细的MYSQL和SQLite对比参考:<br><a target="_blank" rel="noopener" href="https://blog.csdn.net/zbw1185/article/details/47975965">SQLite和MySQL数据库的区别与应用</a></p>
<h4 id="SQLite"><a href="#SQLite" class="headerlink" title="SQLite"></a>SQLite</h4><p><a target="_blank" rel="noopener" href="http://tonytang1990.github.io/2019/05/20/SQLite%E5%AD%A6%E4%B9%A0/">SQLite学习详情参考</a></p>
<h3 id="非关系型数据库"><a href="#非关系型数据库" class="headerlink" title="非关系型数据库"></a>非关系型数据库</h3><p><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/NoSQL">NoSQL是对不同于传统的关系数据库的数据库管理系统的统称。两者存在许多显著的不同点，其中最重要的是NoSQL不使用SQL作为查询语言。其数据存储可以不需要固定的表格模式，也经常会避免使用SQL的JOIN操作，一般有水平可扩展性的特征。</a></p>
<p>看了上面Wiki的介绍，本人其实还是一知半解，等待后续深入学习理解非关系型数据库。</p>
<p>有了关系型数据库为什么还需要非关系型数据库了？<br><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/NoSQL">当代典型的关系数据库在一些数据敏感的应用中表现了糟糕的性能，例如为巨量文档创建索引、高流量网站的网页服务，以及发送流式媒体。关系型数据库的典型实现主要被调整用于执行规模小而读写频繁，或者大批量极少写访问的事务。NoSQL的结构通常提供弱一致性的保证，如最终一致性，或交易仅限于单个的数据项。不过，有些系统，提供完整的ACID保证在某些情况​​下，增加了补充中间件层（例如：CloudTPS）</a></p>
<p>典型的菲关系型数据库:<br>MongoDB，Redis</p>
<h3 id="数据库选择"><a href="#数据库选择" class="headerlink" title="数据库选择"></a>数据库选择</h3><p><a target="_blank" rel="noopener" href="https://gameinstitute.qq.com/community/detail/102605">关系数据库还是NoSQL数据库</a><br><a target="_blank" rel="noopener" href="http://www.cppblog.com/sunicdavy/archive/2015/06/19/210992.html">数据库选择历程</a><br><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1197215">游戏服务器存储系统设计</a><br>本人对数据库的经验还停留在学校学习SQL的时候，也可以理解成使用过一点关系型数据库。<br>这里是想深入理解关系和非关系之间的区别，同时为选择游戏开发时使用的数据库类型做知识储备。以下理解的不对的地方，忘指出。</p>
<p>结合上面两篇文章的学习理解，个人理解关系型数据库(e.g. MySQL)适用于读写不频繁(面向表级别的锁定)，需要强大的查询(SQL)功能。<br>而非关系型数据库(e.g. Redis)适用于频繁读写(性能要求高 – Redis是Ke-Vlaue结构，且面向内存的存储模型(使用RDB和AOF做持久化))，需要高扩展性。</p>
<p>结合网上的学习理解，使用Redis(做内存Cache)+MySQL(做稳定的数据库存储查询)利用各自优势使用在不同模块来实现高性能的服务器存储设计是比较高效合理的。</p>
<p>这里本人出于学习目的，暂定以关系型数据库(<strong>MySQL</strong>)作为服务器数据库存储介质，暂时不考虑Redis。</p>
<p>出于单机游戏数据库存储学习，暂时以关系型数据库(<strong>SQLite</strong>)作为本地数据库存储介质。</p>
<p>后期Redis进阶学习:<br><a target="_blank" rel="noopener" href="https://www.runoob.com/redis/redis-tutorial.html">Redis 教程</a></p>
<h2 id="消息通信"><a href="#消息通信" class="headerlink" title="消息通信"></a>消息通信</h2><p>消息通信是本篇文章的重点，首先让我们理一理实现消息通信前我们需要做些什么？</p>
<ol>
<li>联网方式(选择通信协议，比如: TCP || UPD)</li>
<li>数据格式定义(会影响数据编码和解析，比如: Protobuf)</li>
<li>数据收发(涉及到网络通信监听，比如: Socket编程)</li>
<li>数据解析(涉及到二进制数据写入和读取，一般来说都不会明文传输)</li>
</ol>
<p>一般来说消息通信的流程如下：</p>
<ol>
<li>服务器启动了网络监听(比如通过Socket监听固定端口等待客户端连接)</li>
<li>客户端通过Socket连接服务器端口</li>
<li>指定前后端消息协议(Protobuf)，基于协议封装消息数据</li>
<li>客户端通过封装二进制消息数据通过Socket传递给服务器</li>
<li>服务器接受到二进制数据通过对应方式解析消息后返回客户端消息</li>
<li>客户端做出对应表现</li>
</ol>
<h3 id="联网方式"><a href="#联网方式" class="headerlink" title="联网方式"></a>联网方式</h3><p>了解联网方式之前，我们需要知道一些相关的网络知识。</p>
<p>以前学计算机网络课程时，印象最深的就是网络的OSI七层分类：</p>
<p><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/OSI%E6%A8%A1%E5%9E%8B">OSI模型</a></p>
<p>这里我们主要关注的是以下两层：</p>
<ol>
<li><p>会话层</p>
<p> <a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/OSI%E6%A8%A1%E5%9E%8B">负责在数据传输中设置和维护计算机网络中两台计算机之间的通信连接。</a>这一层是负责网络连接的，比如我们通过Socket启动端口监听</p>
</li>
<li><p>传输层</p>
<p><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/OSI%E6%A8%A1%E5%9E%8B">把传输表头（TH）加至数据以形成数据包。传输表头包含了所使用的协议等发送信息。例如:传输控制协议（TCP）等。</a>这一层负责添加网络协议相关信息，比如根据不同网络协议(TCP or UDP)用不同的方式处理丢包问题</p>
</li>
</ol>
<p>更详细的网络相关知识介绍参考:</p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/24860273">TCP和UDP的区别</a></p>
<p>这里我们只要知道<strong>TCP(Transmission Control Protocol，传输控制协议)<strong>协议是</strong>面向连接的可靠传输协议</strong>，有三次握手过程。而<strong>UDP(User Data Protocol，用户数据报协议)<strong>协议是</strong>无连接不可靠协议</strong>。</p>
<p>传输协议选择？<br>TCP<br>理由：</p>
<ol>
<li>游戏对网络数据准确性要求较高</li>
</ol>
<h3 id="数据格式定义"><a href="#数据格式定义" class="headerlink" title="数据格式定义"></a>数据格式定义</h3><p>这里的数据格式指的是网络消息数据格式定义。</p>
<p>在完成了客户端和服务器基础网络数据传输能力(TPC)后，我们必须定义一个统一的消息定义(即数据格式)和消息处理的方式，这样客户端和服务器端才能正常的解析网络数据。</p>
<p>数据格式需求：</p>
<ol>
<li>知道数据大小</li>
<li>知道数据类型</li>
<li>知道如何序列化和反序列化数据</li>
</ol>
<p>基础的数据格式定义如下:</p>
<ol>
<li>数据长度(short - 2字节) – 用于存储消息数据长度</li>
<li>消息ID(short - 2字节) – 用于区分消息类型</li>
<li>二进制数据(Protobuf) – 用于序列化和反序列化数据</li>
</ol>
<h3 id="数据收发"><a href="#数据收发" class="headerlink" title="数据收发"></a>数据收发</h3><p>有了TCP网络数据传输的能力后，我们还需要网络通信的能力。<br>网路通信方式选择？<br>Socket</p>
<h3 id="数据解析"><a href="#数据解析" class="headerlink" title="数据解析"></a>数据解析</h3><p>数据的解析就是前面提到的数据序列化和反序列化的能力。</p>
<p>数据解析协议选择？<br>Protobuf<br>理由：</p>
<ol>
<li>强大的生态圈，多语言支持，数据前后兼容性，强大序列化反序列化能力等</li>
</ol>
<h2 id="服务器验证"><a href="#服务器验证" class="headerlink" title="服务器验证"></a>服务器验证</h2><p>为什么需要验证？</p>
<p>单机游戏不联网很容易有外挂的一个原因就是本地数据(本地存储或者只存在内存中)很容易被串改且无法验证正确性，比如通过修改内存数据(e.g. 数值挂)，修改游戏运行速度(e.g. 加速挂)</p>
<p>解决这一问题的关键正式服务器验证，把所有的数据都存储在服务器上，所有的数据修改都必须通过服务器校验才能通过，这样一来客户端伪造数据就能被识别出来从而防止部分外挂。</p>
<p>服务器验证的应用场景？</p>
<p>服务器验证有一点很重要的应用就是服务器运行战斗逻辑，确保所有客户端结果一致性。</p>
<p>这一点涉及到前后端同步框架相关的知识，详情参考:</p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/36884005">两种同步模式：状态同步和帧同步</a></p>
<p>这里直接借用博客里的一些定义来加深基础理解：</p>
<p>什么是同步？</p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/36884005">所谓同步，就是要多个客户端表现效果是一致，数据是一致。</a></p>
<p>什么是状态同步？</p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/36884005">状态同步下，客户端更像是一个服务端数据的表现层。</a>以服务器通知为准。</p>
<p>什么是帧同步？</p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/36884005">帧同步下，通信就比较简单了，服务端只转发操作，不做任何逻辑处理。</a></p>
<p><img src="/img/Network/FrameSync.png" alt="FrameSync"></p>
<p>状态同步和帧同步的区别？</p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/36884005">最大的区别就是战斗核心逻辑写在哪，状态同步的战斗逻辑在服务端，帧同步的战斗逻辑在客户端。</a></p>
<p>这里只是简单的引用上面博主的部分说明来加深理解，更深入学习请参考前面给出的博客链接。</p>
<h1 id="服务器从零开发"><a href="#服务器从零开发" class="headerlink" title="服务器从零开发"></a>服务器从零开发</h1><p>前面是对于服务器相关理论知识的一些基础知识的学习实战。接下来为了真正做到开发一个可用的服务器，接下来打算从零开发搭建一个可用的服务器用于个人独立游戏(最重要的目的是从中学习到服务器相关的知识以及用到自己的游戏中来)。</p>
<h2 id="服务器语言选择"><a href="#服务器语言选择" class="headerlink" title="服务器语言选择"></a>服务器语言选择</h2><p>作为一个服务器知识几乎为零的前端小白(用到过的语言为C#,C++,Lua,Python,Java–其中C#和Lua是现在用的最多的)，打算入门服务器开发(主要用于个人游戏开发)，所以在语言选择上主要是希望易上手，性能也还行。在高并发方面要求不高。</p>
<p>对于相对熟悉C#和Lua的博主来说能使用**C#**开发服务器的是比较合适的。</p>
<p>未来的语言学习要针对开发的游戏类型对服务器的性能要求等来分析再做具体选型。</p>
<p>结合网上的资料，了解到:</p>
<p><a target="_blank" rel="noopener" href="https://www.codenong.com/cs106973892/">11种服务器编程语言对比（附游戏服务器框架） 2020.06</a></p>
<h2 id="服务器开源框架"><a href="#服务器开源框架" class="headerlink" title="服务器开源框架"></a>服务器开源框架</h2><p>选择一个好的开源框架作为服务器开发入门来说是必不可少的，这里了解基于C#的服务器框架比较少，有一个ET的服务器框架比较出名，但ET看起来过于庞大，入门起来可能比较难，所以这里暂时没有考虑。</p>
<p>未来的学习方向可能不限语言，不一定是ET也可能是别的语言的服务器框架。</p>
<p>现阶段打算先从0开始打通服务器和客户端的流程，所以打断用C#自己写一套简易版的服务器来熟悉整个服务器开发。</p>
<h2 id="网络通信"><a href="#网络通信" class="headerlink" title="网络通信"></a>网络通信</h2><p>网络通信是指通过网络进行数据传输处理的能力。为了实现网络通信，我们需要借助于TCP( or UDP or **)协议进行数据传输，借助Socket进行端口监听，从而实现网络通信的能力。</p>
<p>联网方式选择？<br>TCP协议 + Socket<br>理由：</p>
<ol>
<li>游戏开发对网络稳定性要求较高，所以选择以TCP作为网络传输协议。</li>
</ol>
<p>数据格式定义选择？<br>Protobuf<br>理由：</p>
<ol>
<li>强大的生态圈，多语言支持，数据前后兼容性，强大序列化反序列化能力等</li>
</ol>
<p>前后端通信模式选择？<br>帧同步<br>理由：</p>
<ol>
<li>现阶段只是为了实现前后端的通信能力，只是希望后端提供消息处理和数据存储的功能，暂时不考虑反外挂，服务器验证等问题，所以选择更适合以后端转发通知的CS模式的帧同步。</li>
</ol>
<h3 id="联网通信实现"><a href="#联网通信实现" class="headerlink" title="联网通信实现"></a>联网通信实现</h3><h4 id="二进制抽象类"><a href="#二进制抽象类" class="headerlink" title="二进制抽象类"></a>二进制抽象类</h4><p>联网通信免不了对二进制数据的写入，所以在实现TPC和Socket网络连接传输消息之前，我们需要实现一个对二进制数据进行读取和写入工具类实现。</p>
<p>以下代码参考至:<br><a target="_blank" rel="noopener" href="https://blog.csdn.net/linshuhe1/article/details/51386559">Unity3D —— Socket通信(C#)</a></p>
<p>ByteBufferWriter.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             ByteBufferWriter.cs</span></span><br><span class="line"><span class="comment"> * Author:                  TONYTANG</span></span><br><span class="line"><span class="comment"> * Create Date:             2019/07/14</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Net</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> ByteBufferWriter.cs</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 二进制写入抽象类</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ByteBufferWriter</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// Note:</span></span><br><span class="line">        <span class="comment">// 注意大小端问题</span></span><br><span class="line">        <span class="comment">// BinaryWriter和BinaryReader都是小端读写</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 内存写入类</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">private</span> MemoryStream mMemoryStream;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 二进制流写入类</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">private</span> BinaryWriter mBinaryWriter;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">ByteBufferWriter</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            mMemoryStream = <span class="keyword">new</span> MemoryStream();</span><br><span class="line">            mBinaryWriter = <span class="keyword">new</span> BinaryWriter(mMemoryStream);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">ByteBufferWriter</span>(<span class="params"><span class="built_in">byte</span>[] data</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(data != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                mMemoryStream = <span class="keyword">new</span> MemoryStream(data);</span><br><span class="line">                mBinaryWriter = <span class="keyword">new</span> BinaryWriter(mMemoryStream);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                mMemoryStream = <span class="keyword">new</span> MemoryStream();</span><br><span class="line">                mBinaryWriter = <span class="keyword">new</span> BinaryWriter(mMemoryStream);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 关闭二进制读取写入</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Close</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            mBinaryWriter.Close();</span><br><span class="line">            mMemoryStream.Close();</span><br><span class="line">            mBinaryWriter = <span class="literal">null</span>;</span><br><span class="line">            mMemoryStream = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 写入一个字节数据</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;v&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">WriteByte</span>(<span class="params"><span class="built_in">byte</span> v</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            mBinaryWriter.Write(v);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ******</span><br><span class="line">        </span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 获取字节数据</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="built_in">byte</span>[] <span class="title">ToBytes</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            mBinaryWriter.Flush();</span><br><span class="line">            <span class="keyword">return</span> mMemoryStream.ToArray();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 写入数据</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Flush</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            mBinaryWriter.Flush();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ByteBufferReader.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             ByteBufferReader.cs</span></span><br><span class="line"><span class="comment"> * Author:                  TONYTANG</span></span><br><span class="line"><span class="comment"> * Create Date:             2019/07/14</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Net</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> ByteBufferReader.cs</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 二进制读取抽象类</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ByteBufferReader</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// Note:</span></span><br><span class="line">        <span class="comment">// 注意大小端问题</span></span><br><span class="line">        <span class="comment">// BinaryWriter和BinaryReader都是小端读写</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 内存写入类</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">private</span> MemoryStream mMemoryStream;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 二进制流读取类</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">private</span> BinaryReader mBinaryReader;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">ByteBufferReader</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            mMemoryStream = <span class="keyword">new</span> MemoryStream();</span><br><span class="line">            mBinaryReader = <span class="keyword">new</span> BinaryReader(mMemoryStream);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">ByteBufferReader</span>(<span class="params"><span class="built_in">byte</span>[] data</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(data != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                mMemoryStream = <span class="keyword">new</span> MemoryStream(data);</span><br><span class="line">                mBinaryReader = <span class="keyword">new</span> BinaryReader(mMemoryStream);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                mMemoryStream = <span class="keyword">new</span> MemoryStream();</span><br><span class="line">                mBinaryReader = <span class="keyword">new</span> BinaryReader(mMemoryStream);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 关闭二进制读取写入</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Close</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            mBinaryReader.Close();</span><br><span class="line">            mMemoryStream.Close();</span><br><span class="line">            mBinaryReader = <span class="literal">null</span>;</span><br><span class="line">            mMemoryStream = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 读取一个字节数据</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="built_in">byte</span> <span class="title">ReadByte</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> mBinaryReader.ReadByte();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ******</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试用例:<br>NetMessage.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Net</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 网络消息抽象类</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">NetMessage</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 消息ID</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">ushort</span> MessageID</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span>;</span><br><span class="line">            <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 消息二进制数据</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">byte</span>[] MessageData</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span>;</span><br><span class="line">            <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 消息长度</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">ushort</span> MessageLength</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span>;</span><br><span class="line">            <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="title">NetMessage</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">NetMessage</span>(<span class="params"><span class="built_in">ushort</span> messageid, <span class="built_in">byte</span>[] messagedata</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            MessageID = messageid;</span><br><span class="line">            MessageData = messagedata;</span><br><span class="line">            MessageLength = (<span class="built_in">ushort</span>)messagedata.Length;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">NetMessage msg = <span class="keyword">new</span> NetMessage(<span class="number">1</span>, Encoding.UTF8.GetBytes(<span class="string">&quot;我是消息内容&quot;</span>));</span><br><span class="line">ByteBufferWriter bbw = <span class="keyword">new</span> ByteBufferWriter();</span><br><span class="line">bbw.WriteShort(msg.MessageLength);</span><br><span class="line">bbw.WriteShort(msg.MessageID);</span><br><span class="line">bbw.WriteBytes(msg.MessageData);</span><br><span class="line"><span class="keyword">var</span> bytesdata = bbw.ToBytes();</span><br><span class="line">bbw.Close();</span><br><span class="line">ByteBufferReader bbb = <span class="keyword">new</span> ByteBufferReader(bytesdata);</span><br><span class="line"><span class="keyword">var</span> msglength = bbb.ReadShort();</span><br><span class="line"><span class="keyword">var</span> msgid = bbb.ReadShort();</span><br><span class="line"><span class="keyword">var</span> msgcontent = bbb.ReadBytes(msglength);</span><br><span class="line">Debug.Log(<span class="string">&quot;msglength = &quot;</span> + msglength);</span><br><span class="line">Debug.Log(<span class="string">&quot;msgid = &quot;</span> + msgid);</span><br><span class="line">Debug.Log(<span class="string">&quot;MessageContent = &quot;</span> + Encoding.UTF8.GetString(msgcontent));</span><br></pre></td></tr></table></figure>

<p>输出:<br><img src="/img/Network/ByteBufferOutput.png" alt="ByteBufferOutput"></p>
<p>注意问题：</p>
<ol>
<li>大小端问题(前后端写入和读取字节的大小端方式必须一致)</li>
</ol>
<p>大小端知识:<br><a target="_blank" rel="noopener" href="http://www.ruanyifeng.com/blog/2016/11/byte-order.html">理解字节序</a><br><a target="_blank" rel="noopener" href="http://blog.zhaojie.me/2010/02/byte-order-and-related-library.html">浅谈字节序（Byte Order）及其相关操作</a></p>
<h4 id="网络通信-1"><a href="#网络通信-1" class="headerlink" title="网络通信"></a>网络通信</h4><p>TCP + Socket<br>流程：</p>
<ol>
<li>启动服务器端套接字监听等待客户端连接</li>
<li>服务器端启动线程监听客户端消息</li>
<li>启动客户端套接字连接服务器套接字端口</li>
<li>客户端启动消息发送线程等待向服务器发送客户端消息</li>
<li>服务器端接受并返回客户端消息</li>
<li>客户端处理服务器端消息</li>
</ol>
<p>NetConnector.cs(网络连接抽象类)</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 网络连接抽象类</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">NetConnector</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> IP地址</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> IpAddress</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 端口号</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> Port</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 网络套接字</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> Socket NetSocket</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 是否连接成功</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">bool</span> IsConnected</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> IP地址</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> IPAddress IP</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> IP以及端口地址</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> IPEndPoint IPEndPoint</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">NetConnector</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        NetSocket = <span class="keyword">new</span> Socket(AddressFamily.InterNetwork, SocketType.Stream, ProtocolType.Tcp);</span><br><span class="line">        IsConnected = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">NetConnector</span>(<span class="params">ProtocolType protocoltype = ProtocolType.Tcp</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        NetSocket = <span class="keyword">new</span> Socket(AddressFamily.InterNetwork, SocketType.Stream, protocoltype);</span><br><span class="line">        IsConnected = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 监听指定ip和端口地址</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;ipaddress&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;port&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ListenTo</span>(<span class="params"><span class="built_in">string</span> ipaddress, <span class="built_in">int</span> port</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        IpAddress = ipaddress;</span><br><span class="line">        Port = port;</span><br><span class="line">        IP = IPAddress.Parse(IpAddress);</span><br><span class="line">        IPEndPoint = <span class="keyword">new</span> IPEndPoint(IP, Port);</span><br><span class="line">        NetSocket.Bind(IPEndPoint);</span><br><span class="line">        NetSocket.Listen((<span class="built_in">int</span>)SocketOptionName.MaxConnections);</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;启动监听&#123;0&#125;成功&quot;</span>, NetSocket.LocalEndPoint.ToString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 连接指定地址</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;ipaddress&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;port&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">ConnectTo</span>(<span class="params"><span class="built_in">string</span> ipaddress, <span class="built_in">int</span> port</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        IpAddress = ipaddress;</span><br><span class="line">        Port = port;</span><br><span class="line">        IP = IPAddress.Parse(IpAddress);</span><br><span class="line">        IPEndPoint = <span class="keyword">new</span> IPEndPoint(IP, Port);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 连接指定地址</span></span><br><span class="line">            NetSocket.Connect(IPEndPoint);</span><br><span class="line">            IsConnected = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span></span><br><span class="line">        &#123;</span><br><span class="line">            IsConnected = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> IsConnected;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 断开连接</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Close</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        IsConnected = <span class="literal">false</span>;</span><br><span class="line">        NetSocket.Shutdown(SocketShutdown.Both);</span><br><span class="line">        NetSocket.Close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>NetServer.cs(网络服务器抽象类)</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 网络服务器抽象类</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">NetServer</span> : <span class="title">SingletonTemplate</span>&lt;<span class="title">NetServer</span>&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 服务器是否启动</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">bool</span> IsServerStart</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 网络连接器</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> NetConnector mNetConnector;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 限定长度的客户端消息接受二进制数组</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">byte</span>[] ClientMsg = <span class="keyword">new</span> <span class="built_in">byte</span>[<span class="number">1024</span> * <span class="number">1024</span>];</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">NetServer</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mNetConnector = <span class="keyword">new</span> NetConnector();</span><br><span class="line">        IsServerStart = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">NetServer</span>(<span class="params">ProtocolType protocoltype = ProtocolType.Tcp</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        mNetConnector = <span class="keyword">new</span> NetConnector(protocoltype);</span><br><span class="line">        IsServerStart = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 启动服务器端口监听</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">StartServer</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(IsServerStart == <span class="literal">false</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 启动服务器端口监听以及等待客户端连接线程</span></span><br><span class="line">            IsServerStart = <span class="literal">true</span>;</span><br><span class="line">            mNetConnector.ListenTo(<span class="string">&quot;192.168.1.3&quot;</span>, <span class="number">8888</span>);</span><br><span class="line">            Thread clientconnectthread = <span class="keyword">new</span> Thread(ClientConnectListener);</span><br><span class="line">            clientconnectthread.Start();                </span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;服务器端已启动!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 发送消息到客户端</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;msg&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SendMessage</span>(<span class="params">NetMessage msg</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//clientsocket.Send(WriteMessage(msg));</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 客户端连接请求监听线程</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ClientConnectListener</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">while</span>(<span class="literal">true</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 检查是否有客户端连接(阻塞的)</span></span><br><span class="line">            Socket clientsocket = mNetConnector.NetSocket.Accept();</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;客户端&#123;0&#125;成功连接&quot;</span>, clientsocket.RemoteEndPoint.ToString());</span><br><span class="line">            <span class="comment">// 想客户端发送连接成功数据(这里的二进制数据可以换成Protobuf序列化的)</span></span><br><span class="line">            NetMessage netmsg = <span class="keyword">new</span> NetMessage(<span class="number">1</span>, Encoding.UTF8.GetBytes(<span class="string">&quot;连接成功!&quot;</span>));</span><br><span class="line">            clientsocket.Send(WriteMessage(netmsg));</span><br><span class="line">            <span class="comment">// 为连接的客户端创建接受消息的线程</span></span><br><span class="line">            Thread resmsgthread = <span class="keyword">new</span> Thread(ReceiveMessage);</span><br><span class="line">            resmsgthread.Start(clientsocket);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 写入网络传输所需数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 1. 数据长度(short - 2字节) -- 用于存储消息数据长度</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 2. 消息ID(short - 2字节) -- 用于区分消息类型</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 3. 二进制数据(Protobuf) -- 用于序列化和反序列化数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;netmsg&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="built_in">byte</span>[] <span class="title">WriteMessage</span>(<span class="params">NetMessage netmsg</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        ByteBufferWriter bbw = <span class="keyword">new</span> ByteBufferWriter();</span><br><span class="line">        bbw.WriteShort(netmsg.MessageLength);</span><br><span class="line">        bbw.WriteShort(netmsg.MessageID);</span><br><span class="line">        bbw.WriteBytes(netmsg.MessageData);</span><br><span class="line">        bbw.Flush();</span><br><span class="line">        <span class="keyword">var</span> bytesdata = bbw.ToBytes();</span><br><span class="line">        bbw.Close();</span><br><span class="line">        <span class="keyword">return</span> bytesdata;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 接受客户端消息</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;clientsocket&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ReceiveMessage</span>(<span class="params"><span class="built_in">object</span> clientsocket</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Socket cltsocket = (Socket)clientsocket;</span><br><span class="line">        <span class="keyword">while</span>(<span class="literal">true</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">int</span> receivenumber = cltsocket.Receive(ClientMsg);</span><br><span class="line">                <span class="keyword">if</span>(receivenumber == <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    Console.WriteLine(<span class="string">&quot;客户端 : &#123;0&#125;断开了连接!&quot;</span>, cltsocket.RemoteEndPoint.ToString());</span><br><span class="line">                    cltsocket.Shutdown(SocketShutdown.Both);</span><br><span class="line">                    cltsocket.Close();</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    Console.WriteLine(<span class="built_in">string</span>.Format(<span class="string">&quot;接收客户端&#123;0&#125;消息， 长度为&#123;1&#125;&quot;</span>, cltsocket.RemoteEndPoint.ToString(), receivenumber));</span><br><span class="line">                    ByteBufferReader bbr = <span class="keyword">new</span> ByteBufferReader(ClientMsg);</span><br><span class="line">                    <span class="comment">// 消息数据长度</span></span><br><span class="line">                    <span class="built_in">int</span> msglen = bbr.ReadShort();</span><br><span class="line">                    <span class="comment">// 消息id</span></span><br><span class="line">                    <span class="built_in">int</span> msgid = bbr.ReadShort();</span><br><span class="line">                    <span class="comment">// 数据二进制内容</span></span><br><span class="line">                    <span class="built_in">byte</span>[] msgdata = bbr.ReadBytes(msglen);</span><br><span class="line">                    <span class="keyword">var</span> msgcontent = Encoding.UTF8.GetString(msgdata);</span><br><span class="line">                    Console.WriteLine(<span class="built_in">string</span>.Format(<span class="string">&quot;消息数据长度 : &#123;0&#125; 消息ID : &#123;1&#125; 消息数据内容：&#123;2&#125;&quot;</span>, msglen, msgid, msgcontent));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (Exception ex)</span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine(ex.Message);</span><br><span class="line">                cltsocket.Shutdown(SocketShutdown.Both);</span><br><span class="line">                cltsocket.Close();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>NetClient.cs(网络客户端抽象)</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> NetClient.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 网络客户端抽象</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">NetClient</span> : <span class="title">SingletonTemplate</span>&lt;<span class="title">NetClient</span>&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 服务器端的二进制数据缓存区</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">byte</span>[] ServerMsg = <span class="keyword">new</span> <span class="built_in">byte</span>[<span class="number">1024</span> * <span class="number">1024</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 客户端网络连接器</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> NetConnector mNetConnector;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 是否已连接服务器</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">bool</span> IsServerConnected</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> mNetConnector.IsConnected;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 消息接受线程</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> Thread mMsgReceiveThread;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">NetClient</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mNetConnector = <span class="keyword">new</span> NetConnector();</span><br><span class="line">        mMsgReceiveThread = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">NetClient</span>(<span class="params">ProtocolType protocoltype = ProtocolType.Tcp</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        mNetConnector = <span class="keyword">new</span> NetConnector(protocoltype);</span><br><span class="line">        mMsgReceiveThread = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 连接服务器</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;ip&quot;&gt;</span>ip地址<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;port&quot;&gt;</span>端口号<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ConnectToServer</span>(<span class="params"><span class="built_in">string</span> ipaddress, <span class="built_in">int</span> port</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(IsServerConnected)</span><br><span class="line">        &#123;</span><br><span class="line">            mNetConnector.Close();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 连接服务器</span></span><br><span class="line">            mNetConnector.ConnectTo(ipaddress, port);</span><br><span class="line">            Debug.Log(<span class="built_in">string</span>.Format(<span class="string">&quot;连接服务器:&#123;0&#125;成功!&quot;</span>, mNetConnector.IPEndPoint.ToString()));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span></span><br><span class="line">        &#123;</span><br><span class="line">            Debug.Log(<span class="built_in">string</span>.Format(<span class="string">&quot;连接服务器:&#123;0&#125;失败!&quot;</span>, mNetConnector.IPEndPoint.ToString()));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (IsServerConnected)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 启动客户端线程去监听接受服务器消息</span></span><br><span class="line">            mMsgReceiveThread = <span class="keyword">new</span> Thread(ReceiveMessage);</span><br><span class="line">            mMsgReceiveThread.Start(mNetConnector.NetSocket);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 断开连接</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Close</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (IsServerConnected)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.Log(<span class="built_in">string</span>.Format(<span class="string">&quot;断开服务器地址 : &#123;0&#125;连接!&quot;</span>, mNetConnector.NetSocket.RemoteEndPoint.ToString()));</span><br><span class="line">            mNetConnector.Close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 发送消息到服务器</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;msg&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SendMessage</span>(<span class="params">NetMessage msg</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (IsServerConnected == <span class="literal">false</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.Log(<span class="string">&quot;服务器未连接成功，无法发送数据!&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                mNetConnector.NetSocket.Send(WriteMessage(msg));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span></span><br><span class="line">            &#123;</span><br><span class="line">                mNetConnector.Close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 写入网络传输所需数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 1. 数据长度(short - 2字节) -- 用于存储消息数据长度</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 2. 消息ID(short - 2字节) -- 用于区分消息类型</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 3. 二进制数据(Protobuf) -- 用于序列化和反序列化数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;netmsg&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="built_in">byte</span>[] <span class="title">WriteMessage</span>(<span class="params">NetMessage netmsg</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        ByteBufferWriter bbw = <span class="keyword">new</span> ByteBufferWriter();</span><br><span class="line">        bbw.WriteShort(netmsg.MessageLength);</span><br><span class="line">        bbw.WriteShort(netmsg.MessageID);</span><br><span class="line">        bbw.WriteBytes(netmsg.MessageData);</span><br><span class="line">        bbw.Flush();</span><br><span class="line">        <span class="keyword">var</span> bytesdata = bbw.ToBytes();</span><br><span class="line">        bbw.Close();</span><br><span class="line">        <span class="keyword">return</span> bytesdata;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 服务器连接消息接受监听线程</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ReceiveMessage</span>(<span class="params"><span class="built_in">object</span> clientsocket</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Socket cltsocket = (Socket)clientsocket;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span>(mNetConnector.IsConnected)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">if</span>(mNetConnector.NetSocket.Available &gt; <span class="number">0</span>)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="built_in">int</span> receivenumber = cltsocket.Receive(ServerMsg);</span><br><span class="line">                        <span class="keyword">if</span> (receivenumber == <span class="number">0</span>)</span><br><span class="line">                        &#123;</span><br><span class="line">                            Debug.Log(<span class="built_in">string</span>.Format(<span class="string">&quot;服务器端 : &#123;0&#125;断开了连接!&quot;</span>, cltsocket.RemoteEndPoint.ToString()));</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">else</span></span><br><span class="line">                        &#123;</span><br><span class="line">                            ByteBufferReader bbr = <span class="keyword">new</span> ByteBufferReader(ServerMsg);</span><br><span class="line">                            <span class="keyword">var</span> msglength = bbr.ReadShort();</span><br><span class="line">                            <span class="keyword">var</span> msgid = bbr.ReadShort();</span><br><span class="line">                            <span class="keyword">var</span> msgdata = bbr.ReadBytes(msglength);</span><br><span class="line">                            <span class="built_in">string</span> msgcontent = Encoding.UTF8.GetString(msgdata);</span><br><span class="line">                            Debug.Log(<span class="built_in">string</span>.Format(<span class="string">&quot;服务器返回数据: 消息ID : &#123;0&#125; 消息长度 : &#123;1&#125; 消息内容 : &#123;2&#125;&quot;</span>, msgid, msglength, msgcontent));</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;                    </span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (Exception ex)</span><br><span class="line">            &#123;</span><br><span class="line">                Debug.Log(ex.Message);</span><br><span class="line">                mNetConnector.NetSocket.Close();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>NetMessage.cs(网络消息格式抽象)</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 网络消息抽象类</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">NetMessage</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 消息ID</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">ushort</span> MessageID</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 消息二进制数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">byte</span>[] MessageData</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 消息长度</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">ushort</span> MessageLength</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">NetMessage</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">NetMessage</span>(<span class="params"><span class="built_in">ushort</span> messageid, <span class="built_in">byte</span>[] messagedata</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        MessageID = messageid;</span><br><span class="line">        MessageData = messagedata;</span><br><span class="line">        MessageLength = (<span class="built_in">ushort</span>)messagedata.Length;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试用例:</p>
<ol>
<li>启动服务器</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NetServer.Singleton.StartServer();</span><br><span class="line">Console.ReadLine();</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>启动客户端</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NetClient.Singleton.ConnectToServer(<span class="string">&quot;192.168.1.3&quot;</span>, <span class="number">8888</span>);</span><br><span class="line">NetClient.Singleton.SendMessage(<span class="keyword">new</span> NetMessage(<span class="number">2</span>, Encoding.UTF8.GetBytes(<span class="string">&quot;测试客户端发送给服务器!&quot;</span>)));</span><br></pre></td></tr></table></figure>

<p>服务器端输出:<br><img src="/img/Network/ServerOutput.png" alt="ServerOutput"></p>
<p>客户端输出:<br><img src="/img/Network/ClientOutput.png" alt="ClientOutput"></p>
<p>可以看到通过Socket编程，我们使用TPC连接成功将消息从客户端发送到服务器以及服务器发送到客户端进行处理。NetMessage的简单封装是为了上层逻辑能区分收到的是什么消息以及消息数据有多少，基于byte[]的存储让我们可以快速的切换数据序列化和反序列化的方式(为后面使用Protobuf打下基础)。</p>
<p>待续……</p>
<h4 id="数据格式解析"><a href="#数据格式解析" class="headerlink" title="数据格式解析"></a>数据格式解析</h4><h4 id="服务器-1"><a href="#服务器-1" class="headerlink" title="服务器"></a>服务器</h4><h2 id="数据库Redis"><a href="#数据库Redis" class="headerlink" title="数据库Redis"></a>数据库Redis</h2><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><h2 id="进阶"><a href="#进阶" class="headerlink" title="进阶"></a>进阶</h2><p>对于网络框架的设计和理论知识进阶学习：<br><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/pThWX8IMtg6zuyjZ0LQajQ">教你从头写游戏服务器框架</a></p>
<h2 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h2><p><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%85%B3%E7%B3%BB%E6%95%B0%E6%8D%AE%E5%BA%93">关系数据库</a><br><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/NoSQL">NoSQL</a><br><a target="_blank" rel="noopener" href="https://gameinstitute.qq.com/community/detail/102605">关系数据库还是NoSQL数据库</a><br><a target="_blank" rel="noopener" href="http://www.cppblog.com/sunicdavy/archive/2015/06/19/210992.html">数据库选择历程</a><br><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Redis">Redis</a><br><a target="_blank" rel="noopener" href="https://www.sqlite.org/whentouse.html">SQLite</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/zbw1185/article/details/47975965">SQLite和MySQL数据库的区别与应用</a><br><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/36884005">两种同步模式：状态同步和帧同步</a><br><a target="_blank" rel="noopener" href="https://www.infoq.cn/article/a-brief-history-of-the-game-server-architecture">游戏服务器架构的演进简史</a><br><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/24860273">TCP和UDP的区别</a><br><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/OSI%E6%A8%A1%E5%9E%8B">OSI模型</a></p>
<h2 id="相关资料"><a href="#相关资料" class="headerlink" title="相关资料"></a>相关资料</h2><p><a target="_blank" rel="noopener" href="https://www.runoob.com/sql/sql-tutorial.html">SQL 教程</a><br><a target="_blank" rel="noopener" href="https://www.w3schools.com/sql/default.asp">SQL Tutorial</a></p>
<h2 id="实战讲解"><a href="#实战讲解" class="headerlink" title="实战讲解"></a>实战讲解</h2><p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/39005219">我们来用Unity做一个局域网游戏（上）</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/linshuhe1/article/details/51386559">Unity3D —— Socket通信(C#)</a><br><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/27c99677be67">Unity网络服务器搭建【中高级】</a><br><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/pThWX8IMtg6zuyjZ0LQajQ">教你从头写游戏服务器框架</a></p>
<p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1t7411E7fR?p=9">unity3d联网游戏：客户端与服务器端的交互</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/hansquirrel/IOShootGameDemo">IOShootGameDemo</a></p>
<h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><p><a target="_blank" rel="noopener" href="https://www.codenong.com/cs106973892/">11种服务器编程语言对比（附游戏服务器框架） 2020.06</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/ketoo/NoahGameFrame">NoahGameFrame</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2019/05/15/Odin%E6%8F%92%E4%BB%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/05/15/Odin%E6%8F%92%E4%BB%B6/" class="post-title-link" itemprop="url">Odin插件</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2019-05-15 21:33:57" itemprop="dateCreated datePublished" datetime="2019-05-15T21:33:57+08:00">2019-05-15</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-07-31 15:31:21" itemprop="dateModified" datetime="2022-07-31T15:31:21+08:00">2022-07-31</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Editor/" itemprop="url" rel="index"><span itemprop="name">Editor</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>本篇文章是为了记录学习使用Unity第三方插件Odin，通过深入学习Odin，加快平时我们编写编辑器工具的效率。</p>
<h1 id="Odin"><a href="#Odin" class="headerlink" title="Odin"></a>Odin</h1><p>Odin是一款可以帮助我们快速制作友好编辑器界面的工具。</p>
<h2 id="功能特性"><a href="#功能特性" class="headerlink" title="功能特性"></a>功能特性</h2><h3 id="Serialize-Anything"><a href="#Serialize-Anything" class="headerlink" title="Serialize Anything"></a>Serialize Anything</h3><p>那么什么是序列化？<br>熟悉二进制导表工具和Proto协议数据发送解析的话，对序列化不会陌生。<br>从平时我们编写代码的角度来说序列化就是把数据对象存储成二进制(序列化)的过程，然后再通过读取二进制数据能构造出原始对象(反序列化)。</p>
<p>接下来看看Unity官方对序列化的定义：<br><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/script-Serialization.html">Serialization is the automatic process of transforming data structures or object states into a format that Unity can store and reconstruct later.</a>(序列化就是将数据结构或对象状态转换成可供Unity保存和随后重建的自动化处理过程。)</p>
<p>官方的序列化远比我们平常说的数据对象序列化更宏大:</p>
<ol>
<li>文件的保存&#x2F;读取，包括Scene、Asset、AssetBundle，以及自定义的ScriptableObject等。</li>
<li>Inspector窗口</li>
<li>编辑器重加载脚本脚本</li>
<li>Prefab</li>
<li>Instantiation<br>所有这些都是通过Unity序列化和反序列化来完成的。</li>
</ol>
<p>Unity序列化有一套规则，这里就不详细介绍了，详情查看官网:<br><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/script-Serialization.html">Script Serialization</a></p>
<p>众所周知，Unity官方序列化并非所有类型都支持，比如：Dictionary，OOP多态。<br>这些限制让我们在编写代码时受到诸多限制，而我们一般是通过特定的处理方式去支持这些缺失的特性(e.g. 通过两个List去模拟Dictionary的序列化或者通过自定义序列化去支持OOP多态)<br>详情查看:<br><a target="_blank" rel="noopener" href="https://blog.uwa4d.com/archives/2025.html">Unity插件开发基础—浅谈序列化系统</a></p>
<p>所以这里再引出Odin的一大特性：<br>Serialize Anything(所有序列化都支持(e.g. Dictionary，OOP多态问题等))<br>这一大特性就已经是相当的强大了，这也是我们采用Odin能够快速编写更加友好的编辑器界面工具的一大原因。</p>
<p>Note:<br><a target="_blank" rel="noopener" href="http://www.sirenix.net/odininspector/manual/introduction/serialize-anything">Odin’s serialization is currently supported on all platforms, save Universal Windows Platform without IL2CPP..</a></p>
<h4 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h4><p><a href="Odin%E4%BC%9A%E9%BB%98%E8%AE%A4%E7%BB%99%E6%88%91%E4%BB%AC%E6%B2%A1%E6%9C%89%E8%87%AA%E5%AE%9A%E4%B9%89Editor%E6%98%BE%E7%A4%BA%E7%9A%84%E7%B1%BB%E5%9E%8B%E6%B3%A8%E5%85%A5%E9%9D%A2%E6%9D%BF%E6%98%BE%E7%A4%BA%E3%80%82%E4%BD%86%E6%88%91%E4%BB%AC%E4%BE%9D%E7%84%B6%E8%BF%98%E6%98%AF%E9%9C%80%E8%A6%81%E6%98%BE%E7%A4%BA%E7%9A%84%E6%8C%87%E5%AE%9A%E4%BD%BF%E7%94%A8Odin%E5%BA%8F%E5%88%97%E5%8C%96%E3%80%82">While Odin by default injects itself into the inspector for every type that doesn’t already have a custom editor defined, the serialization system is more conservative than that. You always have to explicitly decide to make use of Odin’s serialization system.</a></p>
<ol>
<li>开启Odin代码Inspector</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">SerializeStudy</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Unity自身不支持序列化的Dictionary</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> Dictionary&lt;<span class="built_in">int</span>, <span class="built_in">string</span>&gt; SerializeDictionary = <span class="keyword">new</span> Dictionary&lt;<span class="built_in">int</span>, <span class="built_in">string</span>&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Unity自身支持序列化的List</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> List&lt;<span class="built_in">string</span>&gt; SerializeNormalList = <span class="keyword">new</span> List&lt;<span class="built_in">string</span>&gt;();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/img/Unity/Odin/UnityListSerializationUI.png" alt="UnityListSerializationUI"><br>可以看到默认的Dictionary是不支持序列化的，同时默认的List面板是长上面那样的。</p>
<p>接下来我们通过打开Odin序列化再来对比下区别：<br>Tools -&gt; Odin Inspector -&gt; Preference -&gt; Editor Types -&gt; User Types<br>指定我们自定义的SerializeStudy类使用Odin的序列化:<br><img src="/img/Unity/Odin/TurnOnCustomClassOdinSerialization.png" alt="TurnOnCustomClassOdinSerialization"><br>再次对比查看序列化面板:<br><img src="/img/Unity/Odin/TurnOnOdinSerializationListUI.png" alt="TurnOnOdinSerializationListUI"><br>可以看到List默认的面板显示已经变成了Odin自定义的了，但是Dictionary依然没有被序列化显示出来，因为我们只是指定了SerializeStudy类使用Odin的Inspector，但还未指定SerializeStudy使用Odin的序列化。</p>
<ol start="2">
<li>指定使用Odin序列化<br>要支持Dictionary使用Odin的序列化，我们需要显示指定(继承至SerializedMonoBehaviour or SerializedScriptableObject)使用Odin的序列化:</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">SerializeStudy</span> : <span class="title">SerializedMonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/img/Unity/Odin/OdinSerializationUI.png" alt="OdinSerializationUI"><br>可以看到我们成功的使用Odin序列化了Dictionary且采用Odin自定义的Inspector显示。</p>
<p>这里再展现一个Odin二维数组类型的序列化使用，从这个可以看出Odin的强大之处:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">SerializeStudy</span> : <span class="title">SerializedMonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Unity的自身不支持的二维数组</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">bool</span>[,] TwoDimensionArray = <span class="keyword">new</span> <span class="built_in">bool</span>[<span class="number">5</span>, <span class="number">5</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/img/Unity/Odin/OdinSerializationTwoDimensionArrayUI.png" alt="OdinSerializationTwoDimensionArrayUI"><br>可以看到一句简单的定义在Odin序列化和Odin自定义Inspector的帮助下，帮助我们快速构建和支持了Dictionary和二维数组的序列化，这对于我们构建自己的编辑器可以说是如有神助，而这正式Odin的强大之处。</p>
<p>Note:<br>关于OOP多态序列化问题，本人测试和<a target="_blank" rel="noopener" href="https://blog.uwa4d.com/archives/2025.html">Unity插件开发基础—浅谈序列化系统</a>文章里的测试结果不一致(Unity自带序列化支持多态)，本人使用的是2017.4.3f1，所以这里就不实战Odin的OOP多态功能了。</p>
<h3 id="New-Attributes"><a href="#New-Attributes" class="headerlink" title="New Attributes"></a>New Attributes</h3><p>这里的Attribute指的是C#语言里的那个标签Attribute。<br><a target="_blank" rel="noopener" href="http://www.sirenix.net/odininspector/manual/introduction/design-with-attributes">A core feature of Odin is how easy it makes it to change the appearance of your scripts in the editor - essentially letting you create powerful, complex custom editors at a whim merely by applying a few attributes to your members.</a></p>
<p>在不使用Odin前，我们一般是类通过自定义CustomEditor的形式去自定义Editor UI或者是直接通过继承EditorWindow去编写Editor UI工具，主要是通过EditorGUILayout，GUILayout一系列的类来手动完成布局和排版显示等功能。<br>使用Odin后，我们可以通过Odin提供的Attribute可以快速影响我们自定义脚本的Editor表现，帮助我们快速创建友好的可视化界面。</p>
<h4 id="实战-1"><a href="#实战-1" class="headerlink" title="实战"></a>实战</h4><ol>
<li>PropertyOrder(快速指定面板显示顺序)<br>Unity默认排序是跟Public可序列化成员变量定义的顺序挂钩的：</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">AttributeStudy</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> Second;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> First;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/img/Unity/Odin/UnitySerializationOrderUI.png" alt="UnitySerializationOrderUI"><br>通过Odin的PropertyOrder属性我们可以快速的指定排版顺序</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">AttributeStudy</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">PropertyOrder(2)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> Second;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">PropertyOrder(1)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> First;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/img/Unity/Odin/OdinPropertyOrderUI.png" alt="OdinPropertyOrderUI"><br>2. ValueDropdown属性(显示指定成员变量下拉可选值)</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">AttributeStudy</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">ValueDropdown(<span class="string">&quot;DropDownListString&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> DropDownListStringName;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;<span class="built_in">string</span>&gt; DropDownListString = <span class="keyword">new</span> List&lt;<span class="built_in">string</span>&gt;()&#123;</span><br><span class="line">        <span class="string">&quot;Tony&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Tang&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Huan&quot;</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/img/Unity/Odin/OdinValueDropDownAttributeUI.png" alt="OdinValueDropDownAttributeUI"><br>3. TabGroup属性(指定序列化显示分组)</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">AttributeStudy</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">TabGroup(<span class="string">&quot;Normal List Tab&quot;</span>)</span>]</span><br><span class="line">    [<span class="meta">PropertyOrder(2)</span>]</span><br><span class="line">    <span class="keyword">public</span> List&lt;<span class="built_in">string</span>&gt; NormalListString = <span class="keyword">new</span> List&lt;<span class="built_in">string</span>&gt;()&#123;</span><br><span class="line">        <span class="string">&quot;Tony2&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Tang2&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Huan2&quot;</span>,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">TabGroup(<span class="string">&quot;Drop Down Tab&quot;</span>)</span>]</span><br><span class="line">    [<span class="meta">PropertyOrder(1)</span>]</span><br><span class="line">    [<span class="meta">ValueDropdown(<span class="string">&quot;DropDownListString&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> DropDownListStringName;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;<span class="built_in">string</span>&gt; DropDownListString = <span class="keyword">new</span> List&lt;<span class="built_in">string</span>&gt;()&#123;</span><br><span class="line">        <span class="string">&quot;Tony1&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Tang1&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Huan1&quot;</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/img/Unity/Odin/OdinTabGroupAttributeUI.png" alt="OdinTabGroupAttributeUI"><br>4. MetaAttributes属性(e.g. ValidateInput, Required 验证序列化数据输入)</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">AttributeStudy</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">ValidateInput(<span class="string">&quot;IsGreaterThanZero&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> GreaterThanZero;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="built_in">bool</span> <span class="title">IsGreaterThanZero</span>(<span class="params"><span class="built_in">int</span> <span class="keyword">value</span></span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">value</span> &gt; <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">Required</span>]</span><br><span class="line">    <span class="keyword">public</span> GameObject RequiredValue;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/img/Unity/Odin/OdinValideInputAndRequiredAttributeUI.png" alt="OdinValideInputAndRequiredAttributeUI"><br>这里就不所有都一一举例了，从上面可以看出，借助于Odin的Attribute和序列化以及Ordin自定义的Inspector，可以快速帮助我们管理UI排版以及编写高效准确的UI。<br>更多Attribute详情:<br><a target="_blank" rel="noopener" href="http://www.sirenix.net/odininspector/documentation/sirenix/odininspector/assetlistattribute">Odin Attributes</a><br>Odin官方给的Demo(Assets\Plugins\Sirenix\Demos\Attributes Overview.unitypackage)</p>
<h3 id="Effortless-Integration"><a href="#Effortless-Integration" class="headerlink" title="Effortless Integration"></a>Effortless Integration</h3><p>容易集成这一特性从前面的Serialize Anything和Attribute的简单易用其实已经不言而喻了。</p>
<p>接下来主要学习Odin是如何帮助我们快速创建自定义窗口UI显示的。</p>
<ol>
<li>Odin普通编辑器窗口<br>一般来说我们要自定义窗口UI，我们会继承EditorWindow然后结合EditorGUILayout和GUILayout之类的类来定义窗口UI的显示排版以及逻辑处理。<br>基础的Odin窗口需要继承至OdinEditorWindow：</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CustomClassInfoDisplayOdinEditorWindow</span> : <span class="title">OdinEditorWindow</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CustomClass</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">int</span> Index;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> Name;</span><br><span class="line">        <span class="keyword">public</span> GameObject Go;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">MenuItem(<span class="string">&quot;/TonyTang/Tools/OdinEditorWindow/MyFirstOdinEditorWindow&quot;</span>)</span>]</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">OpenWindow</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> window = GetWindow&lt;CustomClassInfoDisplayOdinEditorWindow&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> List&lt;CustomClass&gt; CustomClassListData = <span class="keyword">new</span> List&lt;CustomClass&gt;();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>​	<img src="/img/Unity/Odin/OdinEditorWindowCustomClassInfoDisplayUI.png" alt="OdinEditorWindowCustomClassInfoDisplayUI"><br>​	可以看到借助于继承OdinEditorWindow,我们不再需要重写OnGUI之后去自己定义GUI排版显示以及数据处理，直接编写public可序列化变量就能达到快速显示UI操作交互界面。</p>
<ol start="2">
<li>Odin带菜单栏的自定义编辑器窗口<ol>
<li>带菜单栏的Odin窗口需要继承至OdinMenuEditorWindow</li>
<li>OdinMenuTree用于创建窗口菜单管理</li>
<li>OdinMenuItem用于创建自定义菜单节点(重写OnDrawMenuItem可自定义菜单节点显示)</li>
<li>自定义类结合Odin Attribute做自定义显示界面</li>
</ol>
</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Sirenix.OdinInspector;</span><br><span class="line"><span class="keyword">using</span> Sirenix.OdinInspector.Editor;</span><br><span class="line"><span class="keyword">using</span> Sirenix.Utilities;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> UnityEditor;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 自定义含菜单的Odin窗口</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CustomOdinMenuEditorWindow</span> : <span class="title">OdinMenuEditorWindow</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 自定义的OdinMenuItem类</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CustomMenuItem</span> : <span class="title">OdinMenuItem</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 自定义OdinMenuItem类的数据抽象类</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CustomMenuItemContentClass</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">public</span> <span class="built_in">int</span> Index;</span><br><span class="line">            <span class="keyword">public</span> <span class="built_in">string</span> Name;</span><br><span class="line">            <span class="keyword">public</span> GameObject Go;</span><br><span class="line">            <span class="keyword">public</span> <span class="built_in">bool</span> CheckOn;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="title">CustomMenuItemContentClass</span>(<span class="params"><span class="built_in">int</span> index, <span class="built_in">string</span> name, GameObject go, <span class="built_in">bool</span> checkon</span>)</span></span><br><span class="line">            &#123;</span><br><span class="line">                Index = index;</span><br><span class="line">                Name = name;</span><br><span class="line">                Go = go;</span><br><span class="line">                CheckOn = checkon;</span><br><span class="line">        &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">CustomMenuItem</span>(<span class="params">OdinMenuTree tree, <span class="built_in">string</span> name, IList <span class="keyword">value</span></span>) : <span class="title">base</span>(<span class="params">tree, name, <span class="keyword">value</span></span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">CustomMenuItem</span>(<span class="params">OdinMenuTree tree, <span class="built_in">string</span> name, <span class="built_in">object</span> <span class="keyword">value</span></span>) : <span class="title">base</span>(<span class="params">tree, name, <span class="keyword">value</span></span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 自定义显示界面的OdinMenuItem类</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CustomDrawMenuItem</span> : <span class="title">OdinMenuItem</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 自定义显示界面OdinMenuItem类的数据抽象类</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CustomDrawMenuItemContentClass</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//利用Odin Attribute排版显示UI</span></span><br><span class="line">            [<span class="meta">FoldoutGroup(<span class="string">&quot;自定义折叠组&quot;</span>)</span>]</span><br><span class="line">            <span class="keyword">public</span> <span class="built_in">int</span> Index;</span><br><span class="line">            [<span class="meta">FoldoutGroup(<span class="string">&quot;自定义折叠组&quot;</span>)</span>]</span><br><span class="line">            <span class="keyword">public</span> <span class="built_in">string</span> Name;</span><br><span class="line">            [<span class="meta">FoldoutGroup(<span class="string">&quot;自定义折叠组&quot;</span>)</span>]</span><br><span class="line">            <span class="keyword">public</span> GameObject Go;</span><br><span class="line">            [<span class="meta">FoldoutGroup(<span class="string">&quot;自定义折叠组&quot;</span>)</span>]</span><br><span class="line">            <span class="keyword">public</span> <span class="built_in">bool</span> CheckOn;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="title">CustomDrawMenuItemContentClass</span>(<span class="params"><span class="built_in">int</span> index, <span class="built_in">string</span> name, GameObject go, <span class="built_in">bool</span> checkon</span>)</span></span><br><span class="line">            &#123;</span><br><span class="line">                Index = index;</span><br><span class="line">                Name = name;</span><br><span class="line">                Go = go;</span><br><span class="line">                CheckOn = checkon;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 自行保存需要显示的数据</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">private</span> CustomDrawMenuItemContentClass mCustomDrawMenuData;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">CustomDrawMenuItem</span>(<span class="params">OdinMenuTree tree, <span class="built_in">string</span> name, CustomDrawMenuItemContentClass data</span>) : <span class="title">base</span>(<span class="params">tree, name, data</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            mCustomDrawMenuData = data;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">CustomDrawMenuItem</span>(<span class="params">OdinMenuTree tree, <span class="built_in">string</span> name, IList <span class="keyword">value</span></span>) : <span class="title">base</span>(<span class="params">tree, name, <span class="keyword">value</span></span>)</span></span><br><span class="line">        &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">CustomDrawMenuItem</span>(<span class="params">OdinMenuTree tree, <span class="built_in">string</span> name, <span class="built_in">object</span> <span class="keyword">value</span></span>) : <span class="title">base</span>(<span class="params">tree, name, <span class="keyword">value</span></span>)</span></span><br><span class="line">        &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 自定义MenuItem显示</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;rect&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;labelRect&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnDrawMenuItem</span>(<span class="params">Rect rect, Rect labelRect</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            labelRect.x -= <span class="number">16</span>;</span><br><span class="line">            <span class="keyword">this</span>.mCustomDrawMenuData.CheckOn = GUI.Toggle(labelRect.AlignMiddle(<span class="number">18</span>).AlignLeft(<span class="number">16</span>), <span class="keyword">this</span>.mCustomDrawMenuData.CheckOn, GUIContent.none);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">MenuItem(<span class="string">&quot;TonyTang/Tools/OdinMenuEditorWindow/CustomOdinMenuEditorWindow&quot;</span>)</span>]</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">OpenWindow</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> window = GetWindow&lt;CustomOdinMenuEditorWindow&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> OdinMenuTree <span class="title">BuildMenuTree</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> menutree = <span class="keyword">new</span> OdinMenuTree(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> custommenustyle = <span class="keyword">new</span> OdinMenuStyle</span><br><span class="line">        &#123;</span><br><span class="line">            BorderPadding = <span class="number">0f</span>,</span><br><span class="line">            AlignTriangleLeft = <span class="literal">true</span>,</span><br><span class="line">            TriangleSize = <span class="number">16f</span>,</span><br><span class="line">            TrianglePadding = <span class="number">0f</span>,</span><br><span class="line">            Offset = <span class="number">20f</span>,</span><br><span class="line">            Height = <span class="number">23</span>,</span><br><span class="line">            IconPadding = <span class="number">0f</span>,</span><br><span class="line">            BorderAlpha = <span class="number">0.323f</span></span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        menutree.DefaultMenuStyle = custommenustyle;</span><br><span class="line">        <span class="comment">//添加菜单风格控制显示菜单</span></span><br><span class="line">        menutree.AddObjectAtPath(<span class="string">&quot;菜单风格&quot;</span>, custommenustyle);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//添加MenuItem节点</span></span><br><span class="line">        <span class="keyword">var</span> custommenuitemdata = <span class="keyword">new</span> CustomMenuItem.CustomMenuItemContentClass(<span class="number">1</span>, <span class="string">&quot;CustomMenuItemContentClass&quot;</span>, <span class="literal">null</span>, <span class="literal">false</span>);</span><br><span class="line">        <span class="keyword">var</span> custommenuitemobj = <span class="keyword">new</span> CustomMenuItem(menutree, <span class="string">&quot;默认菜单子子节点名&quot;</span>, custommenuitemdata);</span><br><span class="line">        menutree.AddMenuItemAtPath(<span class="string">&quot;菜单子节点1&quot;</span>, custommenuitemobj);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> customdrawmenuitemdata = <span class="keyword">new</span> CustomDrawMenuItem.CustomDrawMenuItemContentClass(<span class="number">1</span>, <span class="string">&quot;CustomDrawMenuItemContentClass&quot;</span>, <span class="literal">null</span>, <span class="literal">false</span>);</span><br><span class="line">        <span class="keyword">var</span> customdrawmenuitemobj = <span class="keyword">new</span> CustomDrawMenuItem(menutree, <span class="string">&quot;自定义菜单子子节点名&quot;</span>, customdrawmenuitemdata);</span><br><span class="line">        menutree.AddMenuItemAtPath(<span class="string">&quot;菜单子节点2&quot;</span>, customdrawmenuitemobj);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        menutree.EnumerateTree().AddThumbnailIcons().SortMenuItemsByName();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> menutree;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/img/Unity/Odin/OdinCustomMenuStyleUI.png" alt="OdinCustomMenuStyleUI"><br>可以看到借助于Odin我们很轻松的创建定义了复杂的编辑器窗口UI显示，不再需要手动通过EditorGUILayout去编写排版，开发效率大大提升，编写出来的UI也更加美观。</p>
<p>这里就不再一一学习使用Odin相关特性，详情查询:<br><a target="_blank" rel="noopener" href="http://www.sirenix.net/odininspector/documentation/sirenix/odininspector/editor/odinmenueditorwindow">Code Reference</a><br>Odin官方给的Demo(Assets\Plugins\Sirenix\Demos\Editor Windows.unitypackage)</p>
<h3 id="Extendable"><a href="#Extendable" class="headerlink" title="Extendable"></a>Extendable</h3><p>在了解Odin的高度扩展性之前，我们需要了解Odin的Drawer机制。</p>
<p><a target="_blank" rel="noopener" href="http://sirenix.net/odininspector/manual/drawers-in-depth/understanding-drawers">The single most important part of understanding how Odin’s drawing system works, is understanding the <em>drawing chain</em>. In Odin, any single property is not drawn by a single drawer; instead each property has many drawers assigned to it. </a></p>
<p>从上面可以看到，理解Odin drawing system工作机制，我们需要了解Odin的drawing chain(绘制链)。在Odin里每一个显示在面板的Property(这里的Property不等价于C#里的Property)都不是单一一个drawer绘制出来的而是许多个drawers的连续绘制的结果。</p>
<p>首先Odin提供我们了一个叫ShowDrawerChain的Attibute属性，可视化的显示二楼每一个Property的绘制Drawer组合(<strong>每一个Drawer有一个优先级，优先级高的在前面</strong>)。</p>
<p><img src="/img/Unity/Odin/OdinShowDrawerChainAttribute.png" alt="OdinShowDrawerChainAttribute"></p>
<p>从上图可以看出，我们定义一个int的可序列化字段，通过Odin绘制出来需要三个Drawer:</p>
<ol>
<li>PropertyContextMenuDrawer<int> (并不做任何的绘制，只做了右键Content Menu显示的检查)</li>
<li>PrimitiveValueConflictDrawer<int> (检查值冲突(比如多选时有不一样的值类型))</li>
<li>Int32Drawer(最终负责绘制int值面板显示的Drawer)</li>
</ol>
<p>理解了Odin绘制Property是通过连续的多个Drawer组合的形式后，让我们来学习了解Odin里不同种类的Drawer是如何组成Odin的Drawer绘制机制的。</p>
<ol>
<li>Value Drawers(继承至OdinValueDrawer，优先级(0, 0, 1)，类型默认的Drawer)</li>
<li>Attribute Drawers(继承至OdinAttributeDrawer，优先级(0, 0, 1000)，Attibute绘制)</li>
<li>Attribute Value Drawers(Value Drawers和Atrribute Drawers两者的结合)</li>
<li>Group Drawers(继承至PropertyGroupAttribute，不同于前面三个Drawers，Group Drawers是负责一组Property的指定绘制方式)</li>
<li>Gemeric Drawers(泛型 – 解决显示指定Drawers类型信息的问题)</li>
</ol>
<p>这里不过多的去纠结Odin底层源代码设计和实现，只是通过了解Odin的绘制设计方式来加深对Odin使用的理解，便于应用到实际工程里去解决具体问题。</p>
<p>更多学习请参考Odin里的Demo和官方文档。</p>
<p>Note:</p>
<p><a target="_blank" rel="noopener" href="http://sirenix.net/odininspector/manual/drawers-in-depth/drawer-types">Note that all drawers in Odin are <em>always</em> strongly typed, and <em>do not allow</em> type polymorphism.</a>(Odin里的Drawer是强类型，不支持多态)</p>
<h2 id="官方使用建议"><a href="#官方使用建议" class="headerlink" title="官方使用建议"></a>官方使用建议</h2><p><a target="_blank" rel="noopener" href="http://www.sirenix.net/odininspector/manual/introduction/getting-started">Getting Started</a></p>
<h1 id="实战-2"><a href="#实战-2" class="headerlink" title="实战"></a>实战</h1><h2 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h2><ol>
<li>编写一个基于Odin的游戏模块的文档说明编辑器工具(Odin)</li>
<li>自动根据编译信息反射生成最新类型和字段信息(反射判定)</li>
<li>提供字段可编写自定义介绍的内容并存储共享(ScriptableObject存储共享)</li>
<li>提供类型，枚举搜索查看功能</li>
</ol>
<p>先上最终效果图(这里只挑个别展示，主要是学习编写过程中Odin的小知识和小技巧):</p>
<ol>
<li>模块文档整体界面<br><img src="/img/Unity/Odin/ModuleDocIntroductionUI.png" alt="ModuleDocIntroductionUI"></li>
<li>基础类型说明<br><img src="/img/Unity/Odin/ModuleDocBasicTypeIntroductionUI.png" alt="ModuleDocBasicTypeIntroductionUI"></li>
<li>Effect详情<br><img src="/img/Unity/Odin/ModuleDocEffectTypeDetailUI.png" alt="ModuleDocEffectTypeDetailUI"></li>
</ol>
<h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><p>接下来主要从三个方面来学习讲解上面文档工具通过Odin编写所需要注意的技巧和实现。</p>
<ol>
<li>Odin自定义编辑器菜单实现</li>
<li>Odin自定义类型+Odin自定义编辑器布局显示实现</li>
<li>自定义编辑器数据序列化存储</li>
</ol>
<h3 id="自定义编辑器菜单"><a href="#自定义编辑器菜单" class="headerlink" title="自定义编辑器菜单"></a>自定义编辑器菜单</h3><p>自定义菜单主要是通过继承Odin的OdinMenuEditorWindow类然后结合自定义OdinMenuTree + 自定义OdinMenuStyle来实现自定义的菜单布局加风格显示。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             GameModuleDocumentEditorWindow.cs</span></span><br><span class="line"><span class="comment"> * Author:                  TANGHUAN</span></span><br><span class="line"><span class="comment"> * Create Date:             2019/06/04</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> Sirenix.OdinInspector;</span><br><span class="line"><span class="keyword">using</span> Sirenix.OdinInspector.Editor;</span><br><span class="line"><span class="keyword">using</span> Sirenix.Utilities.Editor;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEditor;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 游戏模块文档编辑器窗口</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">GameModuleDocumentEditorWindow</span> : <span class="title">OdinMenuEditorWindow</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> OdinMenuStyle MenuStyle  = <span class="keyword">new</span> OdinMenuStyle</span><br><span class="line">    &#123;</span><br><span class="line">        BorderPadding = <span class="number">0f</span>,</span><br><span class="line">        AlignTriangleLeft = <span class="literal">true</span>,</span><br><span class="line">        TriangleSize = <span class="number">16f</span>,</span><br><span class="line">        TrianglePadding = <span class="number">0f</span>,</span><br><span class="line">        Offset = <span class="number">20f</span>,</span><br><span class="line">        Height = <span class="number">30</span>,</span><br><span class="line">        IconPadding = <span class="number">0f</span>,</span><br><span class="line">        BorderAlpha = <span class="number">0.323f</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    *******</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> OdinMenuTree <span class="title">BuildMenuTree</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        DocDataUtility.CheckAndCreateFolder(DocDataUtility.DocumentDataSaveFolderPath);</span><br><span class="line">        LoadAllData();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> menutree = <span class="keyword">new</span> OdinMenuTree(<span class="literal">true</span>);</span><br><span class="line">        menutree.DefaultMenuStyle = MenuStyle;</span><br><span class="line"></span><br><span class="line">        menutree.AddObjectAtPath(<span class="string">&quot;游戏模块文档&quot;</span>, IntroductionEditorWindowData);</span><br><span class="line">        menutree.AddObjectAtPath(<span class="string">&quot;游戏模块文档/模块菜单&quot;</span>, <span class="literal">null</span>);</span><br><span class="line">        menutree.AddObjectAtPath(<span class="string">&quot;游戏模块文档/模块菜单/基础类型说明&quot;</span>, DataTypeIntroEditorWindowData);</span><br><span class="line">        menutree.AddObjectAtPath(<span class="string">&quot;游戏模块文档/模块菜单/Effect模块&quot;</span>, EffectModuleIntroEditorWindowData);</span><br><span class="line">        <span class="comment">//menutree.AddObjectAtPath(&quot;游戏模块文档/模块菜单/Effect模块/Effect基础配置介绍&quot;, EffectModuleBasicConfigEditorWindowData);</span></span><br><span class="line">        menutree.AddObjectAtPath(<span class="string">&quot;游戏模块文档/模块菜单/Effect模块/Effect&quot;</span>, EffectIntroEditorWindowData);</span><br><span class="line">        menutree.AddObjectAtPath(<span class="string">&quot;游戏模块文档/模块菜单/Effect模块/Effect/Effect预览&quot;</span>, EffectPreviewEditorWindowData);</span><br><span class="line">        menutree.AddObjectAtPath(<span class="string">&quot;游戏模块文档/模块菜单/Effect模块/Effect/Effect查询&quot;</span>, EffectQueryEditorWindowData);</span><br><span class="line">        menutree.AddObjectAtPath(<span class="string">&quot;游戏模块文档/模块菜单/Effect模块/Effect/Effect详情&quot;</span>, EffectDetailEditorWindowData);</span><br><span class="line">        menutree.AddObjectAtPath(<span class="string">&quot;游戏模块文档/模块菜单/Effect模块/EffectView&quot;</span>, EffectViewIntroEditorWindowData);</span><br><span class="line">        menutree.AddObjectAtPath(<span class="string">&quot;游戏模块文档/模块菜单/Effect模块/EffectView/EffectView预览&quot;</span>, EffectViewPreviewEditorWindowData);</span><br><span class="line">        menutree.AddObjectAtPath(<span class="string">&quot;游戏模块文档/模块菜单/Effect模块/EffectView/EffectView查询&quot;</span>, EffectViewQueryEditorWindowData);</span><br><span class="line">        menutree.AddObjectAtPath(<span class="string">&quot;游戏模块文档/模块菜单/Effect模块/EffectView/EffectView详情&quot;</span>, EffectViewDetailEditorWindowData);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> menutree;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">MenuItem(<span class="string">&quot;TonyTang/Tools/GameModuleDocument/GameModuleDocumentMenuEditorWindow&quot;</span>)</span>]</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">OpenWindow</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> window = GetWindow&lt;GameModuleDocumentEditorWindow&gt;();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>代码已经很清晰了，这里就不详细说明了。<br>通过继承OdinMenuEditorWindow重写BuildMenuTree()方法，使用OdinMenuTree自定义菜单栏，配合自定义OdinMenuStyle决定惨淡显示风格。</p>
<h3 id="自定义编辑器布局"><a href="#自定义编辑器布局" class="headerlink" title="自定义编辑器布局"></a>自定义编辑器布局</h3><p>自定义编辑器布局主要是通过使用Odin的OdinEditorWindow + Odin自定义序列化类型显示 + Odin序列化标签来实现的。</p>
<p>Effect详细信息自定义窗口部分代码(工作原因，不方便放出全部代码，这里只用作学习记录分享Odin的使用):</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             EffectDetailEditorWindow.cs</span></span><br><span class="line"><span class="comment"> * Author:                  TONYTANG</span></span><br><span class="line"><span class="comment"> * Create Date:             2019/06/04</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> Sirenix.OdinInspector;</span><br><span class="line"><span class="keyword">using</span> Sirenix.OdinInspector.Editor;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Reflection;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> EffectDetailEditorWindow.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Effect详情窗口</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">TypeInfoBox(<span class="string">&quot;子类不会显示父类字段信息!要查询父类字段信息直接查询父类类型!&quot;</span>)</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">EffectDetailEditorWindow</span> : <span class="title">OdinEditorWindow</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">EffectDetailData</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> Effect参数说明数据</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">EffectDetailParamDesData</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">            <span class="comment"><span class="doctag">///</span> 参数类型信息</span></span><br><span class="line">            <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">            [<span class="meta">LabelText(<span class="string">&quot;&quot;</span>)</span>]</span><br><span class="line">            [<span class="meta">VerticalGroup(<span class="string">&quot;参数类型&quot;</span>)</span>]</span><br><span class="line">            [<span class="meta">TableColumnWidth(150, Resizable = false)</span>]</span><br><span class="line">            [<span class="meta">ReadOnly</span>]</span><br><span class="line">            <span class="keyword">public</span> <span class="built_in">string</span> ParamType;</span><br><span class="line"></span><br><span class="line">            <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">            <span class="comment"><span class="doctag">///</span> 参数名</span></span><br><span class="line">            <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">            [<span class="meta">LabelText(<span class="string">&quot;&quot;</span>)</span>]</span><br><span class="line">            [<span class="meta">VerticalGroup(<span class="string">&quot;参数名&quot;</span>)</span>]</span><br><span class="line">            [<span class="meta">TableColumnWidth(150, Resizable = false)</span>]</span><br><span class="line">            [<span class="meta">ReadOnly</span>]</span><br><span class="line">            <span class="keyword">public</span> <span class="built_in">string</span> ParamName = <span class="string">&quot;参数名&quot;</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">            <span class="comment"><span class="doctag">///</span> 参数介绍</span></span><br><span class="line">            <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span>            </span></span><br><span class="line">            [<span class="meta">LabelText(<span class="string">&quot;&quot;</span>)</span>]</span><br><span class="line">            [<span class="meta">VerticalGroup(<span class="string">&quot;参数介绍&quot;</span>)</span>]</span><br><span class="line">            [<span class="meta">TextArea</span>]</span><br><span class="line">            <span class="keyword">public</span> <span class="built_in">string</span> ParamIntro;</span><br><span class="line"></span><br><span class="line">            <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">            <span class="comment"><span class="doctag">///</span> 参数额外信息</span></span><br><span class="line">            <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">            [<span class="meta">LabelText(<span class="string">&quot;&quot;</span>)</span>]</span><br><span class="line">            [<span class="meta">VerticalGroup(<span class="string">&quot;参数额外信息&quot;</span>)</span>]</span><br><span class="line">            [<span class="meta">TextArea(3, 6)</span>]</span><br><span class="line">            <span class="keyword">public</span> <span class="built_in">string</span> ParamExtraInfo;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> Effect名</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        [<span class="meta">LabelText(<span class="string">&quot;Effect名&quot;</span>)</span>]</span><br><span class="line">        [<span class="meta">VerticalGroup(<span class="string">&quot;基础信息&quot;</span>)</span>]</span><br><span class="line">        [<span class="meta">TableColumnWidth(220, Resizable = false)</span>]</span><br><span class="line">        [<span class="meta">ReadOnly</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> EffectName;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> Effect父类名字</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        [<span class="meta">LabelText(<span class="string">&quot;父Effect名&quot;</span>)</span>]</span><br><span class="line">        [<span class="meta">VerticalGroup(<span class="string">&quot;基础信息&quot;</span>)</span>]</span><br><span class="line">        [<span class="meta">TableColumnWidth(220, Resizable = false)</span>]</span><br><span class="line">        [<span class="meta">ReadOnly</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> ParentTypeName;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> Effect参数说明数据</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        [<span class="meta">LabelText(<span class="string">&quot;&quot;</span>)</span>]</span><br><span class="line">        [<span class="meta">VerticalGroup(<span class="string">&quot;参数详细信息&quot;</span>)</span>]</span><br><span class="line">        [<span class="meta">TableList(DrawScrollView = false, IsReadOnly = true)</span>]</span><br><span class="line">        <span class="keyword">public</span> List&lt;EffectDetailParamDesData&gt; EffectParamDesDetailList = <span class="keyword">new</span> List&lt;EffectDetailParamDesData&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Effect详细数据列表</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">LabelText(<span class="string">&quot;Effect详细数据&quot;</span>)</span>]</span><br><span class="line">    [<span class="meta">TabGroup(<span class="string">&quot;Effect参数详情&quot;</span>)</span>]</span><br><span class="line">    [<span class="meta">TableList(DrawScrollView = true, MaxScrollViewHeight = 800, MinScrollViewHeight = 800, IsReadOnly = true)</span>]</span><br><span class="line">    <span class="keyword">public</span> List&lt;EffectDetailData&gt; EffectDetailDataList = <span class="keyword">new</span> List&lt;EffectDetailData&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 枚举说明数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">EffectEnumData</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 参数类型信息</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        [<span class="meta">LabelText(<span class="string">&quot;&quot;</span>)</span>]</span><br><span class="line">        [<span class="meta">VerticalGroup(<span class="string">&quot;枚举类型全名&quot;</span>)</span>]</span><br><span class="line">        [<span class="meta">HideInInspector</span>]</span><br><span class="line">        [<span class="meta">ReadOnly</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> QualifiedEnumType;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 参数类型信息</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        [<span class="meta">LabelText(<span class="string">&quot;&quot;</span>)</span>]</span><br><span class="line">        [<span class="meta">VerticalGroup(<span class="string">&quot;枚举名&quot;</span>)</span>]</span><br><span class="line">        [<span class="meta">ReadOnly</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> EnumType;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 枚举可选值</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        [<span class="meta">LabelText(<span class="string">&quot;&quot;</span>)</span>]</span><br><span class="line">        [<span class="meta">VerticalGroup(<span class="string">&quot;枚举可选值&quot;</span>)</span>]</span><br><span class="line">        [<span class="meta">ListDrawerSettings(HideAddButton = true, HideRemoveButton = true)</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>[] EnumValues;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 枚举值说明</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        [<span class="meta">LabelText(<span class="string">&quot;&quot;</span>)</span>]</span><br><span class="line">        [<span class="meta">VerticalGroup(<span class="string">&quot;枚举值说明&quot;</span>)</span>]</span><br><span class="line">        [<span class="meta">TextArea</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> EnumValueDecs;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 枚举详细数据列表</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">LabelText(<span class="string">&quot;枚举详细数据&quot;</span>)</span>]</span><br><span class="line">    [<span class="meta">TabGroup(<span class="string">&quot;枚举详情&quot;</span>)</span>]</span><br><span class="line">    [<span class="meta">TableList(DrawScrollView = true, MaxScrollViewHeight = 800, MinScrollViewHeight = 500, IsReadOnly = true)</span>]</span><br><span class="line">    <span class="keyword">public</span> List&lt;EffectEnumData&gt; EffectEnumDataList = <span class="keyword">new</span> List&lt;EffectEnumData&gt;();</span><br><span class="line"></span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>OdinEditorWindow实现了基于Odin的自定义编辑器入口。</li>
</ul>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">EffectDetailEditorWindow</span> : <span class="title">OdinEditorWindow</span></span><br></pre></td></tr></table></figure>
<ul>
<li>结合自定义类型 + Public类型成员定义决定自定义编辑器显示内容。</li>
</ul>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">EffectDetailData</span></span><br><span class="line">&#123;</span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> List&lt;EffectDetailData&gt; EffectDetailDataList = <span class="keyword">new</span> List&lt;EffectDetailData&gt;();</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">EffectEnumData</span></span><br><span class="line">&#123;</span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> List&lt;EffectEnumData&gt; EffectEnumDataList = <span class="keyword">new</span> List&lt;EffectEnumData&gt;();</span><br></pre></td></tr></table></figure>
<ul>
<li>自定义类型需要序列化显示的参数结合Odin序列化标签实现指定方式显示字段。</li>
</ul>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">LabelText(<span class="string">&quot;枚举详细数据&quot;</span>)</span>]</span><br><span class="line">[<span class="meta">VerticalGroup(<span class="string">&quot;枚举类型全名&quot;</span>)</span>]</span><br><span class="line">[<span class="meta">HideInInspector</span>]</span><br><span class="line">[<span class="meta">ReadOnly</span>]</span><br><span class="line">[<span class="meta">TableColumnWidth(220, Resizable = false)</span>]</span><br><span class="line">[<span class="meta">TabGroup(<span class="string">&quot;枚举详情&quot;</span>)</span>]</span><br><span class="line">[<span class="meta">TableList(DrawScrollView = true, MaxScrollViewHeight = 800, MinScrollViewHeight = 500, IsReadOnly = true)</span>]</span><br></pre></td></tr></table></figure>
<pre><code>LabelText -- 表示显示标题
VerticalGroup -- 表示显示分组
HideInInspector -- 表示不显示在编辑器上
ReadOnly -- 表示字段只读不可编辑
TableColumnWidth -- 表示字段单列显示宽度
TabGroup -- 表示标签页分组
TableList -- 表示按表格列表形式显示(DrawScrollView = true, MaxScrollViewHeight = 800, MinScrollViewHeight = 500, IsReadOnly = true -- 是TableList里的细节显示控制)
更多标签详情查看官网:
[OdinDocumentation](https://odininspector.com/documentation)
</code></pre>
<h3 id="数据序列化存储"><a href="#数据序列化存储" class="headerlink" title="数据序列化存储"></a>数据序列化存储</h3><p>数据序列化存储主要是采用Odin + Unity ScriptableObject<br>Odin的OdinEditorWindow是继承至EditorWindow，而EditorWindow是继承至ScriptableObject，所以我们直接按序列化ScriptableObject的方式序列化OdinEditorWindow即可。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 加载指定文档数据</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;typeparam name=&quot;T&quot;&gt;</span><span class="doctag">&lt;/typeparam&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;datafullpath&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> T <span class="title">LoadDocumentData</span>&lt;<span class="title">T</span>&gt;(<span class="params"><span class="built_in">string</span> datafullpath</span>) <span class="keyword">where</span> T : ScriptableObject</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span>(File.Exists(datafullpath))</span><br><span class="line">    &#123;</span><br><span class="line">        Debug.Log(<span class="built_in">string</span>.Format(<span class="string">&quot;&#123;0&#125;数据加载成功!&quot;</span>, datafullpath));</span><br><span class="line">        <span class="keyword">return</span> AssetDatabase.LoadAssetAtPath&lt;T&gt;(datafullpath);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        Debug.Log(<span class="built_in">string</span>.Format(<span class="string">&quot;&#123;0&#125;数据不存在!&quot;</span>, datafullpath));</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 存储指定文档数据</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;typeparam name=&quot;T&quot;&gt;</span><span class="doctag">&lt;/typeparam&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;documentdata&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;datafullpath&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">SaveDocumentData</span>&lt;<span class="title">T</span>&gt;(<span class="params">T documentdata, <span class="built_in">string</span> datafullpath</span>) <span class="keyword">where</span> T : ScriptableObject</span></span><br><span class="line">&#123;</span><br><span class="line">    AssetDatabase.CreateAsset(documentdata, datafullpath);</span><br><span class="line">    AssetDatabase.SaveAssets();</span><br><span class="line">    Debug.Log(<span class="built_in">string</span>.Format(<span class="string">&quot;保存资源：&#123;0&#125;完成!&quot;</span>, documentdata));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a target="_blank" rel="noopener" href="https://assetstore.unity.com/packages/tools/utilities/odin-inspector-and-serializer-89041">Odin Asset Store链接</a><br><a target="_blank" rel="noopener" href="http://sirenix.net/odininspector">Odin官网</a><br><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/script-Serialization.html">Script Serialization</a><br><a target="_blank" rel="noopener" href="https://blog.uwa4d.com/archives/2025.html">Unity插件开发基础—浅谈序列化系统</a><br><a target="_blank" rel="noopener" href="https://odininspector.com/documentation">OdinDocumentation</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2019/05/03/%E7%83%AD%E6%9B%B4%E6%96%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/05/03/%E7%83%AD%E6%9B%B4%E6%96%B0/" class="post-title-link" itemprop="url">热更新</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2019-05-03 13:30:16" itemprop="dateCreated datePublished" datetime="2019-05-03T13:30:16+08:00">2019-05-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-07-31 15:30:37" itemprop="dateModified" datetime="2022-07-31T15:30:37+08:00">2022-07-31</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/HotUpdate/" itemprop="url" rel="index"><span itemprop="name">HotUpdate</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>本篇文章是为了记录学习游戏开发过程中，版本强更和资源热更相关知识。</p>
<p>关于资源AssetBundle加载模块相关学习参考:<br><a target="_blank" rel="noopener" href="http://tonytang1990.github.io/2016/10/13/Unity-Resource-Manager">Unity Resource Manager</a><br><a target="_blank" rel="noopener" href="http://tonytang1990.github.io/2018/10/24/AssetBundle%E8%B5%84%E6%BA%90%E6%89%93%E5%8C%85%E5%8A%A0%E8%BD%BD%E7%AE%A1%E7%90%86%E5%AD%A6%E4%B9%A0/">AssetBundle资源打包加载管理</a></p>
<h1 id="热更新"><a href="#热更新" class="headerlink" title="热更新"></a>热更新</h1><p>首先还是让我们从What，Why，How三个点来学习理解热更新。</p>
<h2 id="What"><a href="#What" class="headerlink" title="What"></a>What</h2><p>什么是热更新？<br>从前端的角度来说，我个人理解热更新是指无需通过商店审核上传最新版本就能通过游戏内热更下载最新资源和代码的形式更新最新功能。</p>
<p>从服务器的角度来说，可能是无需关闭服务器，不停机状态下修复漏洞，更新资源等，重点是更新逻辑代码。</p>
<p>本人是前端程序，所以侧重点是前端热更这一块，而非服务器热更新。<br>接下来主要以以下三点来深入学习：</p>
<ol>
<li>版本强更(类似于商店下载最新版本的完整包安装更新)</li>
<li>资源热更(游戏内资源热更新下载替换本地游戏内容)</li>
<li>代码热更(游戏内代码热更新下载替换本地游戏代码内容)</li>
</ol>
<h2 id="Why"><a href="#Why" class="headerlink" title="Why"></a>Why</h2><p>为什么需要热更新？</p>
<ol>
<li>商店审核时间不可控(紧急bug严重修复时会造成阻碍)</li>
<li>手机游戏更新频繁，改善用户更新体验(不必每次都走商店版本强更)</li>
<li>快速修复bug和更新功能</li>
</ol>
<h2 id="How"><a href="#How" class="headerlink" title="How"></a>How</h2><p>接下来会针对前面提到的三点来分别讨论：<br>针对版本强更和资源热更，先来看一下我整理的流程图：<br><img src="/img/Unity/HotUpdate/HotUpdateFlowChat.png" alt="HotUpdateFlowChat"></p>
<h3 id="版本强更"><a href="#版本强更" class="headerlink" title="版本强更"></a>版本强更</h3><p>版本强更主要是游戏内通过服务器获取最新版本号判定当前游戏版本是否需要更新，然后引导用户更新(可以是引导到对应商店下载，也可以是直接游戏内直接下载安装包)最新的包。</p>
<ol>
<li>引导到对应商店下载<br>问题：<br>需要判断出用户当前下载的安装包是从哪个应用商店下载的，然后跳转到对应商店，如果玩家不是从应用商店下载或者说玩家本地没有对应应用商店，那么就会出现无法成功跳转对应应用商店的情况。<br>方案：<br>考虑到Android应用商店繁多，基于上述问题，这里我们采用第二种方案，直接引导游戏内CDN下载最新包的形式强更版本(这里指的Android，IOS官方AppStore只有一个本地肯定有AppStore，直接跳转AppStore即可)</li>
<li>游戏内直接下载(cdn下载)<br>游戏内直接下载可以通过下载对应CDN(不同渠道分不同CDN地址即可划分渠道)上的安装包覆盖安装即可。</li>
</ol>
<h4 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h4><p>Android:<br>通过查询相关资料，了解到Android APK安装在Android N(7)之前主要是通过Itent结合File的形式。<br>Android N(7)之后主要是通过FileProvider组件</p>
<p>CS层热更下载APK代码:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">string</span> testresourceurl = <span class="string">&quot;*/HotUpdate.apk&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> webrequest = UnityWebRequest.Get(testresourceurl);</span><br><span class="line"><span class="keyword">yield</span> <span class="keyword">return</span> webrequest.SendWebRequest();</span><br><span class="line"><span class="keyword">if</span> (webrequest.isNetworkError)</span><br><span class="line">&#123;</span><br><span class="line">    Debug.LogError(<span class="built_in">string</span>.Format(<span class="string">&quot;&#123;0&#125;安装包下载出错!&quot;</span>, testresourceurl));</span><br><span class="line">    Debug.LogError(webrequest.error);</span><br><span class="line">    <span class="keyword">if</span> (webrequest.isHttpError)</span><br><span class="line">    &#123;</span><br><span class="line">        Debug.LogError(<span class="built_in">string</span>.Format(<span class="string">&quot;responseCode : &quot;</span>, webrequest.responseCode));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">    Debug.Log(<span class="built_in">string</span>.Format(<span class="string">&quot;&#123;0&#125; webrequest.isDone:&#123;1&#125;!&quot;</span>, testresourceurl, webrequest.isDone));</span><br><span class="line">    Debug.Log(<span class="built_in">string</span>.Format(<span class="string">&quot;&#123;0&#125;安装包下载完成!&quot;</span>, testresourceurl));</span><br><span class="line">    <span class="keyword">var</span> downloadfilefolderpath = Application.persistentDataPath + <span class="string">&quot;/download/&quot;</span>;</span><br><span class="line">    <span class="keyword">var</span> downloadfilesavepath = downloadfilefolderpath + <span class="string">&quot;app.apk&quot;</span>;</span><br><span class="line">    Debug.Log(<span class="string">&quot;downloadfilefolderpath = &quot;</span> + downloadfilefolderpath);</span><br><span class="line">    Debug.Log(<span class="string">&quot;downloadfilesavepath = &quot;</span> + downloadfilesavepath);</span><br><span class="line">    <span class="keyword">if</span>(!Directory.Exists(downloadfilefolderpath))</span><br><span class="line">    &#123;</span><br><span class="line">        Directory.CreateDirectory(downloadfilefolderpath);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (File.Exists(downloadfilesavepath))</span><br><span class="line">    &#123;</span><br><span class="line">        File.Delete(downloadfilesavepath);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">using</span> (<span class="keyword">var</span> fs = File.Create(downloadfilesavepath))</span><br><span class="line">    &#123;</span><br><span class="line">        fs.Write(webrequest.downloadHandler.data, <span class="number">0</span>, webrequest.downloadHandler.data.Length);</span><br><span class="line">        fs.Flush();</span><br><span class="line">        fs.Close();</span><br><span class="line">        Debug.Log(downloadfilesavepath + <span class="string">&quot;文件写入完成!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>原生APK安装代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Intent</span> <span class="variable">install</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(Intent.ACTION_VIEW);</span><br><span class="line">install.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK);</span><br><span class="line"><span class="type">File</span> <span class="variable">apkFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(mContext.getExternalFilesDir(<span class="literal">null</span>).getPath() + <span class="string">&quot;/download/&quot;</span> + <span class="string">&quot;app.apk&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">Uri</span> <span class="variable">uri</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.N) &#123;</span><br><span class="line">    install.setFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION);</span><br><span class="line">    install.addFlags(Intent.FLAG_GRANT_WRITE_URI_PERMISSION);</span><br><span class="line">    install.addFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION);</span><br><span class="line">    uri = FileProvider.getUriForFile(mContext, mPackagename + <span class="string">&quot;.fileprovider&quot;</span>, apkFile);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    uri = Uri.fromFile(apkFile);</span><br><span class="line">&#125;</span><br><span class="line">install.setDataAndType(uri, <span class="string">&quot;application/vnd.android.package-archive&quot;</span>);</span><br><span class="line">startActivity(install);</span><br></pre></td></tr></table></figure>

<p>AndroidMainifest.xml定义相关FileProvider：<br>res下新建xml目录以及file_paths.xml文件<br><img src="/img/Unity/HotUpdate/AndroidHotUpdateFilePath.png" alt="AndroidHotUpdateFilePath"></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">//强更部分</span><br><span class="line"><span class="tag">&lt;<span class="name">provider</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:name</span>=<span class="string">&quot;android.support.v4.content.FileProvider&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:authorities</span>=<span class="string">&quot;应用包名.fileprovider&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:exported</span>=<span class="string">&quot;false&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:grantUriPermissions</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta-data</span></span></span><br><span class="line"><span class="tag">      <span class="attr">android:name</span>=<span class="string">&quot;android.support.FILE_PROVIDER_PATHS&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">android:resource</span>=<span class="string">&quot;@xml/file_paths&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">provider</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>配置file_paths.xml:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">resources</span>&gt;</span></span><br><span class="line">    //下载安装包目录</span><br><span class="line">    <span class="tag">&lt;<span class="name">paths</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">external-path</span></span></span><br><span class="line"><span class="tag">            <span class="attr">name</span>=<span class="string">&quot;download&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">path</span>=<span class="string">&quot;&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">external-files-path</span></span></span><br><span class="line"><span class="tag">            <span class="attr">name</span>=<span class="string">&quot;download&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">path</span>=<span class="string">&quot;&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">paths</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">resources</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>AndroidManifest.xml权限相关设置:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.WRITE_EXTERNAL_STORAGE&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.READ_EXTERNAL_STORAGE&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.REQUEST_INSTALL_PACKAGES&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p>Android相关路径定义知识:<br>以下内容来源：<br><a target="_blank" rel="noopener" href="http://yifeng.studio/2017/05/03/android-7-0-compat-fileprovider/">关于 Android 7.0 适配中 FileProvider 部分的总结</a><br><files-path>：内部存储空间应用私有目录下的 files&#x2F; 目录，等同于 Context.getFilesDir() 所获取的目录路径；</p>
<p><cache-path>：内部存储空间应用私有目录下的 cache&#x2F; 目录，等同于 Context.getCacheDir() 所获取的目录路径；</p>
<p><external-path>：外部存储空间根目录，等同于 Environment.getExternalStorageDirectory() 所获取的目录路径；</p>
<p><external-files-path>：外部存储空间应用私有目录下的 files&#x2F; 目录，等同于 Context.getExternalFilesDir(null) 所获取的目录路径；</p>
<p><external-cache-path>：外部存储空间应用私有目录下的 cache&#x2F; 目录，等同于 Context.getExternalCacheDir()；</p>
<p>最后让我们来看下运行效果：<br><img src="/img/Unity/HotUpdate/HotUpdateUIInterface.png" alt="运行界面"><br><img src="/img/Unity/HotUpdate/DownloadAPK.png" alt="下载安装包"><br><img src="/img/Unity/HotUpdate/InstallAPK.png" alt="版本强更安装"></p>
<p>注意事项：</p>
<ol>
<li>下载保存APK时需要android.permission.WRITE_EXTERNAL_STORAGE权限</li>
<li>安装APK时需要android.permission.REQUEST_INSTALL_PACKAGES和android.permission.READ_EXTERNAL_STORAGE权限</li>
<li>Android 6.0以后敏感权限需要主动请求</li>
<li><a target="_blank" rel="noopener" href="http://lazybios.com/2016/12/install-apk-by-intent-compatible-adnroid-n/">从Android 7.0开始，系统修改了安全机制: 限定应用在默认情况下只能访问自身应用数据。所以当我们想通过File对象访问其它package数据时，就需要借助于ContentProvider、FileProvider这些组件，否则会报FileUriExposedException异常。</a></li>
<li>Android下载和读取安装APK的目录需要是有可读写权限的外部存储目录(e.g. Application.persistentDataPath || Application.temporaryCachePath)</li>
</ol>
<p>IOS:<br>IOS正版只有AppStore(暂时不考虑越狱渠道)，所以IOS直接打开应用商店跳转即可。<br>IOS跳转AppStore商店的代码就简单很多了：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Application.OpenURL(<span class="string">&quot;itms-apps://itunes.apple.com/app/id&quot;</span> + appID);</span><br></pre></td></tr></table></figure>
<p>Android打开商店的代码和IOS类似:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Application.OpenURL(<span class="string">&quot;market://details?id=&quot;</span> + appID);</span><br></pre></td></tr></table></figure>
<p>Note:<br><a target="_blank" rel="noopener" href="https://blog.csdn.net/hackmind/article/details/78113511">IOS appID可以通过itunes的链接获取到，比如我们的游戏链接为:https://itunes.apple.com/app/id1238589899，1238589899 为IOS的appID</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/hackmind/article/details/78113511">google play 的ID通过商店链接获取到，比如我们的游戏链接为:https://play.google.com/store/apps/details?id=com.oasis.movten.android， com.oasis.movten.android 为 Android的appID</a></p>
<h3 id="资源热更"><a href="#资源热更" class="headerlink" title="资源热更"></a>资源热更</h3><p>资源热更是指在游戏内直接下载最新资源，然后本地游戏通过使用最新下载的资源更新到最新的游戏资源并使用。</p>
<p>资源热更下载老版本Unity提供了WWW接口，但这个接口官方已经不推荐使用了，取而代之的是UnityWebRequest(http访问资源服务器的形式)。</p>
<p>资源下载跟前面提到的版本强更APK下载是一个意思，只不过需要通过比较本地更新的资源数据和服务器上的资源数据对比出需要更新的资源列表。这里不厌其烦的再放一次版本强更和资源热更的流程图加深印象：<br><img src="/img/Unity/HotUpdate/HotUpdateFlowChat.png" alt="HotUpdateFlowChat"><br>代码这里就不贴了，感兴趣的可以直接上Git下载了解：<br><a target="_blank" rel="noopener" href="https://github.com/TonyTang1990/AssetBundleLoadManager">AssetBundleLoadManager</a></p>
<h3 id="热更新辅助工具"><a href="#热更新辅助工具" class="headerlink" title="热更新辅助工具"></a>热更新辅助工具</h3><p>Tools-&gt;HotUpdate-&gt;热更新操作工具</p>
<p><img src="/img/Unity/HotUpdate/HotUpdateToolsUI.png" alt="HotUpdateToolsUI"></p>
<p>主要分为以下4个步骤：</p>
<ol>
<li><p>版本资源文件MD5计算(文件名格式:MD5+版本号+资源版本号+平台+时间戳+.txt)</p>
<p><img src="/img/Unity/HotUpdate/AssetBundleMD5Caculation.png" alt="AssetBundleMD5Caculation"></p>
</li>
<li><p>对比两个版本的MD5文件信息得出需要热更新的AB文件信息</p>
</li>
<li><p>执行热更新AB准备操作自动复制需要热更新的AB到热更新准备目录(然后手动拷贝需要强更或热更的资源到真正的热更新目录)</p>
</li>
<li><p>执行热更新准备操作，生成热更新所需的最新资源热更新信息文件(ResourceUpdateList.txt)和服务器最新版本信息文件(ServerVersionConfig.json)</p>
</li>
</ol>
<h3 id="代码热更"><a href="#代码热更" class="headerlink" title="代码热更"></a>代码热更</h3><p>代码热更和版本强更不一样，版本强更一般来说是通过更新下载完整的包来实现整个游戏功能版本更新，而代码热更是指我们通过技术手段(e.g. XLua, ILRuntime, ToLua ……)，通过热更代码的形式实现热更功能代码。</p>
<p>主流的方式有两种：</p>
<ol>
<li>Lua(Lua方案)<br> Lua是解析执行，有自己的虚拟机，对于代码热更有天然的优势，我们完全可以以资源热更(AssetBundle)的形式热更Lua代码。</li>
<li>ILRuntime(CS方案)<br> 这里不是非常了解ILRuntime底层原理，想了解详情的可以参考官网：<a target="_blank" rel="noopener" href="https://ourpalm.github.io/ILRuntime/public/v1/guide/index.html">ILRuntime项目为基于C#的平台（例如Unity）提供了一个纯C#实现，快速、方便且可靠的IL运行时，使得能够在不支持JIT的硬件环境（如iOS）能够实现代码的热更新</a><br> 但ILRuntime有一点很大的优势就是开发期也是用CS语言，不用写Lua。</li>
</ol>
<p>这里因为项目主要用到了XLua，所以后续都是以XLua作为代码热更来学习。<br>选XLua的原因主要有以下几点：</p>
<ol>
<li>腾讯开源，有大公司支持，稳定</li>
<li>除了支持纯Lua开发，还支持CS通过改写Lua的形式热修复Bug</li>
</ol>
<p>Note:</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://gameinstitute.qq.com/community/detail/119660">苹果禁止了C#的部分反射操作，禁止JIT（即时编译，程序运行时创建并运行新代码），不允许逻辑热更新，只允许使用AssetBundle进行资源热更新。</a></li>
</ol>
<h4 id="XLua"><a href="#XLua" class="headerlink" title="XLua"></a>XLua</h4><p>官网：<br><a target="_blank" rel="noopener" href="https://github.com/Tencent/xLua">XLua</a></p>
<p>待续……</p>
<h3 id="资源服务器"><a href="#资源服务器" class="headerlink" title="资源服务器"></a>资源服务器</h3><p>前面提到的版本强更和资源热更都离不开资源服务器，这里说的资源服务器是指静态资源服务器，接下来通过实战学习了解静态资源服务器相关的概念以及静态资源服务器选择和使用。</p>
<p>静态资源服务器:</p>
<p>我们把资源放到指定静态资源服务器上，静态资源服务器开启Http或者其他的连接服务，允许用户通过对应方式(Http或者其他)去访问拉取服务器资源。(个人理解，如果有误欢迎指出)</p>
<p>静态资源服务器是资源热更的一个前提。</p>
<p>CND:</p>
<p><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%85%A7%E5%AE%B9%E5%82%B3%E9%81%9E%E7%B6%B2%E8%B7%AF"><strong>内容分发网络</strong>（英语：<strong>C</strong>ontent <strong>d</strong>elivery <strong>n</strong>etwork或<strong>C</strong>ontent <strong>d</strong>istribution <strong>n</strong>etwork，<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E7%B8%AE%E5%AF%AB">缩写</a>：<strong>CDN</strong>）是指一种透过<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E4%BA%92%E8%81%AF%E7%B6%B2">互联网</a>互相连接的计算机网络系统，利用最靠近每位用户的服务器，更快、更可靠地将音乐、图片、影片、应用程序及其他文件发送给用户，来提供高性能、可扩展性及低成本的网络内容传递给用户。</a></p>
<p>从上面可以看出CDN是独立于静态资源服务器，网络传输层的一个概念，主要目的是为了加快和提供高性能的资源传输。</p>
<h4 id="实战-1"><a href="#实战-1" class="headerlink" title="实战"></a>实战</h4><p>这里我选择了阿里云的<a href="">OSS</a>作为静态资源服务器。</p>
<p>OSS详情:</p>
<p><a target="_blank" rel="noopener" href="https://help.aliyun.com/document_detail/31883.html?spm=5176.208357.1107607.14.5404390fXITEiK">阿里云对象存储服务（Object Storage Service，简称 OSS）为您提供基于网络的数据存取服务。使用 OSS，您可以通过网络随时存储和调用包括文本、图片、音频和视频等在内的各种非结构化数据文件。</a></p>
<p>OSS静态资源服务器搭建：</p>
<ol>
<li>注册阿里云账号</li>
<li>账号实名认证</li>
<li>开通OSS服务</li>
<li>创建Bucket</li>
<li>上传文件</li>
</ol>
<p><a target="_blank" rel="noopener" href="https://help.aliyun.com/document_detail/31883.html?spm=a2c4g.11174283.3.1.1b5a7da2pQvh8V">OSS详细使用说明</a></p>
<p>待续……</p>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/janeky/article/details/17666409">Unity手游之路手游资源热更新策略探讨</a><br><a target="_blank" rel="noopener" href="http://copyfuture.com/blogs-details/cd4f28bd6dfae0a2ece7cd43a6f90e62">Unity 大版本更新之APK的下载与覆盖安装</a><br><a target="_blank" rel="noopener" href="https://gameinstitute.qq.com/community/detail/119660">Unity3D热更新方案总结</a><br><a target="_blank" rel="noopener" href="http://lazybios.com/2016/12/install-apk-by-intent-compatible-adnroid-n/">使用Intent安装APK方法(兼容Android N)</a><br><a target="_blank" rel="noopener" href="http://yifeng.studio/2017/05/03/android-7-0-compat-fileprovider/">关于 Android 7.0 适配中 FileProvider 部分的总结</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/hackmind/article/details/78113511">Unity app 如何打开商店</a></p>
<h1 id="Git"><a href="#Git" class="headerlink" title="Git"></a>Git</h1><p><a target="_blank" rel="noopener" href="https://github.com/TonyTang1990/AssetBundleLoadManager">AssetBundleLoadManager</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2019/04/25/%E4%BC%98%E5%8C%96/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/04/25/%E4%BC%98%E5%8C%96/" class="post-title-link" itemprop="url">优化篇</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2019-04-25 14:41:00" itemprop="dateCreated datePublished" datetime="2019-04-25T14:41:00+08:00">2019-04-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-07-31 15:30:15" itemprop="dateModified" datetime="2022-07-31T15:30:15+08:00">2022-07-31</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Optimization/" itemprop="url" rel="index"><span itemprop="name">Optimization</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>本章节主要目的是学习记录游戏开发中各个模块里的优化知识，深入理解项目设计里的各种底层知识点，避免前期不考虑后期优化成灾的情况。</p>
<p>Note:</p>
<ol>
<li>此处并不是要宣扬优化，项目初期不推崇过度优化毕竟产品做出来才是王道，而是通过深入理解核心知识点在项目初期做出正确的设计来避免没必要的后期优化。</li>
</ol>
<h2 id="UI模块"><a href="#UI模块" class="headerlink" title="UI模块"></a>UI模块</h2><p>深入深度学习Unity UI(UGUI)模块的使用，优化，原理知识等。</p>
<h3 id="UI基础"><a href="#UI基础" class="headerlink" title="UI基础"></a>UI基础</h3><h4 id="UI核心概念"><a href="#UI核心概念" class="headerlink" title="UI核心概念"></a>UI核心概念</h4><p><a target="_blank" rel="noopener" href="https://learn.unity.com/tutorial/optimizing-unity-ui#5c7f8528edbc2a002053b5a0">Canvases are responsible for combining their constituent geometry into batches, generating the appropriate render commands and sending these to Unity’s Graphics system. All of this is done in native C++ code, and is called a rebatch or a batch build.</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.unity.com/tutorial/optimizing-unity-ui#5c7f8528edbc2a002053b5a0">Geometry is provided to Canvases by Canvas Renderer components.</a></p>
<p>从前面可以看出UGUI的绘制是以画布为单位的，子Canvas也就是嵌套的关系，大部分情况子Canvas脏了只会触发子Canvas的网格重建不会触发父Canvas的网格重建。</p>
<p><a target="_blank" rel="noopener" href="https://learn.unity.com/tutorial/optimizing-unity-ui#5c7f8528edbc2a002053b5a0">When composing user interfaces in Unity UI, keep in mind that all geometry drawn by a Canvas will be drawn in the <strong>Transparent queue.</strong></a>(UGUI的Canvas绘制实在Transpanrent Queue里)</p>
<p><a target="_blank" rel="noopener" href="https://learn.unity.com/tutorial/optimizing-unity-ui#5c7f8528edbc2a002053b5a0">A <em>Graphic</em> is a base class provided by the Unity UI C# library. It is the base class for all Unity UI C# classes that provide drawable geometry to the Canvas system. Most built-in Unity UI Graphics are implemented via the <em>MaskableGraphic</em> subclass, which allows them to be masked via the <em>IMaskable</em> interface.</a>(UGUI里Graphic是提供Canvas里可绘制单位的基类，大部分UGUI组件继承至MaskableGraphic，为了支持Mask过滤。)</p>
<p><a target="_blank" rel="noopener" href="https://learn.unity.com/tutorial/optimizing-unity-ui#5c7f8528edbc2a002053b5a0">The updates of Layout and Graphic components is called a rebuild.</a>(网格重建是因为排版或者Graphic组件有更新导致的，比如UI位置变化(排版),UI图片变化(组件变化))</p>
<ol>
<li>Batch Building Process(Canvases)<br><a target="_blank" rel="noopener" href="https://learn.unity.com/tutorial/optimizing-unity-ui#5c7f8528edbc2a002053b5a0">The batch building process is the process whereby a Canvas combines the meshes representing its UI elements and generates the appropriate rendering commands to send to Unity’s graphics pipeline. The results of this process are cached and reused until the Canvas is marked as dirty, which occurs whenever there is a change to one of its constituent meshes.</a>(网格合并是为了将Canvas下的元素合并到一个网格数据里缓存起来直到UI被标记脏时。主要是为了减少DrawCall，减少GPU压力)</li>
<li>Rebuild Process(Graphics)<br><a target="_blank" rel="noopener" href="https://learn.unity.com/tutorial/optimizing-unity-ui#5c7f8528edbc2a002053b5a0">The Rebuild process is where the layout and meshes of Unity UI’s C# Graphic components are recalculated.</a>(网格重建是因为Canvas下的UI有排版或者Graphic组件有变化触发的，目的是为了重新计算绘制所需的网格数据)</li>
</ol>
<p><a target="_blank" rel="noopener" href="https://learn.unity.com/tutorial/optimizing-unity-ui#5c7f8528edbc2a002053b5a0">Whenever any drawable UI element on a given Canvas changes, the Canvas must re-run the batch building process. This process re-analyzes every drawable UI element on the Canvas, regardless of whether it has changed or not. </a>(任何的可绘制UI变化都会导致Canvas重新执行网格合并，因为Mesh有变化了)</p>
<h4 id="UI合批规则"><a href="#UI合批规则" class="headerlink" title="UI合批规则"></a>UI合批规则</h4><p>UI顺序：<br><a href="">Unity UIs are constructed back-to-front, with objects’ order in the hierarchy determining their sort order. </a><br>UI是从后往前结合节点层级(Hierarchy)判定的出序列号的，相邻序列号的会检测是否能合批。所以我们要注意合批打断问题(比如相邻节点没有使用同一个图集，材质。相邻UI节点重叠问题等。)</p>
<p>详细学习参考：<br><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/5b6f5022662e">Unity 之 UGUI 小总结</a></p>
<h4 id="UI射线"><a href="#UI射线" class="headerlink" title="UI射线"></a>UI射线</h4><p>UI射线响应需要满足下面几个条件：</p>
<ol>
<li>目标UI是激活状态</li>
<li>点击区域是目标UI区域</li>
<li>目标UI对象本身或父节点有ICanvasRaycastFilter组件设置允许raycast</li>
</ol>
<p>优化Raycast方案：</p>
<ol>
<li>减少不必要的UI响应Raycast(关闭不必要的UI Raycast Target设置)</li>
</ol>
<p>Note:<br>Unity 5.4之前有个Bug是即使没有input输入也会每帧检查Raycast造成额外开销。</p>
<h3 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h3><p>UI的几个常见问题如下:</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://learn.unity.com/tutorial/optimizing-unity-ui#5c7f8528edbc2a002053b59f">Excessive GPU fragment shader utilization (i.e. fill-rate overutilization)</a>(过度使用GPU – 片元Shader的使用显示，比如填充率过高)</li>
<li><a target="_blank" rel="noopener" href="https://learn.unity.com/tutorial/optimizing-unity-ui#5c7f8528edbc2a002053b59f">Excessive CPU time spent rebuilding a Canvas batch</a>(过度使用CPU – Canvas网格重建和合并)</li>
<li><a target="_blank" rel="noopener" href="https://learn.unity.com/tutorial/optimizing-unity-ui#5c7f8528edbc2a002053b59f">Excessive numbers of rebuilds of Canvas batches (over-dirtying)</a>(过度高频率的触发Canvas网格重建和合并 – 比如大量的动态元素)</li>
<li><a target="_blank" rel="noopener" href="https://learn.unity.com/tutorial/optimizing-unity-ui#5c7f8528edbc2a002053b59f">Excessive CPU time spent generating vertices (usually from text)</a>(过度的使用CPU – 生成过多的顶点数据，比如文本顶点数量)</li>
</ol>
<p>从上面可以看出优化UI主要从两个方面下手：</p>
<ul>
<li>CPU(减少Canvas频繁的合并，减少生成过多的顶点数量)</li>
<li>GPU(减少Drawcall和填充率)</li>
</ul>
<h3 id="Profile-Tool"><a href="#Profile-Tool" class="headerlink" title="Profile Tool"></a>Profile Tool</h3><ol>
<li>Unity Profiler</li>
<li>Unity Frame Debugger</li>
<li>Xcode Intruments</li>
<li>Xcode Frame Debugger<br>详情参考：<br><a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/topics/best-practices/unity-ui-profiling-tools?playlist=30089">Unity UI Profiling Tools</a></li>
</ol>
<h3 id="优化建议"><a href="#优化建议" class="headerlink" title="优化建议"></a>优化建议</h3><ol>
<li>减少不可见UI – 比如全屏不透明UI显示时隐藏背后UI</li>
<li>简化UI结构 – 比如减少不必要节点 不要使用混合GameObject节点等</li>
<li>关闭不可见Camera – 比如全屏不透明UI显示时隐藏其他不必要Camera</li>
<li>划分多Canvas+动静分离 – 比如不同的窗口放到不同的Canvas下避免互相影响。动的元素放在一个Canvas下，静的元素放在一个Canvas下，避免动的元素影响静态元素的网格重建</li>
<li>使用最新版TextMeshPro来替换原生Text方案(TMP使用SDF技术支持不失真的动态字体大小变化)</li>
</ol>
<p>Note:</p>
<ol>
<li>UGUI的Text的文字顶点绘制是单个文字就是一个独立的四边形网格(造成顶点数多)</li>
<li>UGUI的Text动态字体对于不同的大小或者风格(粗体细体)是按不同的文字来处理的(容易造成Canvas的重绘(动态字体纹理重新生成))</li>
<li>文本变化是会触发网格重建和合并的(因为文本网格数据变化了)</li>
</ol>
<h3 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h3><p>通过前面的学习，我们知道了UI的开销主要在Rebatch和Rebuild上。前者可以理解成通过UGUI合批规则把Canvas下的UI合并到指定数量的DrawCall传递到GPU去。后者可以理解成UI变化后重新计算Mesh。</p>
<p>UI优化的关键也就不言而喻了：</p>
<ol>
<li><p>减少Rebatch<br> Canvas没有标记dirty或者Canvas下没有UI Mesh有变化时不会触发Rebatch。<br> 这也就是为什么要划分Canvas且采用动静分离的原因，目的就是把经常变化的UI分离到单独的Canvas，减少静态UI部分的Rebatch开销。</p>
</li>
<li><p>减少Rebuild</p>
</li>
<li><p>降低隐藏激活开销(这一点主要是对于UI显示状态变化时的一种优化)</p>
<p> 根据<a target="_blank" rel="noopener" href="https://blog.uwa4d.com/archives/1875.html"><a target="_blank" rel="noopener" href="https://blog.uwa4d.com/archives/1875.html">UWA 六月直播季 | 6.29 Unity UI模块中的优化案例精讲</a></a>的建议，UGUI最好采用Canvas Group设置Alpha为0的方式来避免SetActive带来的开销以及避免隐藏时的渲染开销</p>
</li>
</ol>
<p>Note:<br>Unity 5.2版本Unity大力优化了UI Batch部分。</p>
<h2 id="资源模块"><a href="#资源模块" class="headerlink" title="资源模块"></a>资源模块</h2><p>资源分很多，比如纹理贴图，图集，材质，Shader，字体，音效，模型，动画等等等。接下来我会针对特定部分来学习针对性的优化知识点。</p>
<h3 id="纹理资源"><a href="#纹理资源" class="headerlink" title="纹理资源"></a>纹理资源</h3><p>这里说的纹理资源同时也包含了图集，图集也可以理解成纹理的一种。</p>
<h3 id="字体"><a href="#字体" class="headerlink" title="字体"></a>字体</h3><p>待续……</p>
<h3 id="音效"><a href="#音效" class="headerlink" title="音效"></a>音效</h3><p>待续……</p>
<h1 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h1><h2 id="Relative-Study"><a href="#Relative-Study" class="headerlink" title="Relative Study"></a>Relative Study</h2><p><a href="">TextMeshPro相关学习</a></p>
<h2 id="Unity-Conception-Part"><a href="#Unity-Conception-Part" class="headerlink" title="Unity Conception Part"></a>Unity Conception Part</h2><p><a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/topics/best-practices/guide-optimizing-unity-ui?playlist=30089">A guide to optimizing Unity UI</a><br><a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/topics/best-practices/fundamentals-unity-ui?playlist=30089">Fundamentals of Unity UI</a><br><a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/topics/best-practices/unity-ui-profiling-tools?playlist=30089">Unity UI Profiling Tools</a><br><a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/topics/best-practices/fill-rate-canvases-and-input?playlist=30089&tdsourcetag=s_pcqq_aiomsg">Fill-rate, Canvases and input</a><br><a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/topics/best-practices/optimizing-ui-controls?playlist=30089">Optimizing UI Controls</a><br><a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/topics/best-practices/other-ui-optimization-techniques-and-tips?playlist=30089">Other UI Optimization Techniques and Tips</a></p>
<h2 id="Other-Part"><a href="#Other-Part" class="headerlink" title="Other Part"></a>Other Part</h2><p><a target="_blank" rel="noopener" href="https://blog.uwa4d.com/archives/QA_UGUI-1.html">关于Unity中的UGUI优化，你可能遇到这些问题</a><br><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/5b6f5022662e">Unity 之 UGUI 小总结</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.uwa4d.com/archives/1875.html"><a target="_blank" rel="noopener" href="https://blog.uwa4d.com/archives/1875.html">UWA 六月直播季 | 6.29 Unity UI模块中的优化案例精讲</a></a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2019/04/19/%E7%89%88%E6%9C%AC%E6%8E%A7%E5%88%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/04/19/%E7%89%88%E6%9C%AC%E6%8E%A7%E5%88%B6/" class="post-title-link" itemprop="url">版本控制</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2019-04-19 12:00:00" itemprop="dateCreated datePublished" datetime="2019-04-19T12:00:00+08:00">2019-04-19</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-07-31 21:24:17" itemprop="dateModified" datetime="2022-07-31T21:24:17+08:00">2022-07-31</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Other/" itemprop="url" rel="index"><span itemprop="name">Other</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>本篇文章是为了记录版本控制相关知识，着重学习Git的使用。</p>
<h2 id="版本控制"><a href="#版本控制" class="headerlink" title="版本控制"></a>版本控制</h2><p>在项目开发过程中，对项目代码进行维护保存，对于多个人协同工作记录下每一次的变更记录，方便日后查看以及恢复。<br>主流的版本管理工具比如Tortoise SVN,P4,Git等。</p>
<h3 id="集中式-vs-分布式"><a href="#集中式-vs-分布式" class="headerlink" title="集中式 vs 分布式"></a>集中式 vs 分布式</h3><p>这里不对版本管理工具做太深入的学习讲解。<br>参见：<br><a target="_blank" rel="noopener" href="http://www.liaoxuefeng.com/wiki/0013739516305929606dd18361248578c67b8067c8c017b000/001374027586935cf69c53637d8458c9aec27dd546a6cd6000">集中式VS分布式</a></p>
<p>分布式工作流：</p>
<p><img src="/img/VersionControl/%E5%88%86%E5%B8%83%E5%BC%8F.png" alt="分布式"></p>
<p>集中式工作流:</p>
<p><img src="/img/VersionControl/%E9%9B%86%E4%B8%AD%E5%BC%8F.png" alt="集中式"></p>
<p>Note：<br>Tortoise SVN是集中式。</p>
<p>Git是分布式。</p>
<h4 id="Tortoise-SVN"><a href="#Tortoise-SVN" class="headerlink" title="Tortoise SVN"></a>Tortoise SVN</h4><h5 id="Visual-SVN-Server"><a href="#Visual-SVN-Server" class="headerlink" title="Visual SVN Server"></a>Visual SVN Server</h5><p><a target="_blank" rel="noopener" href="https://www.visualsvn.com/server/">VisualSVN Server allows you to easily install and manage a fully-functional Subversion server on the Windows platform.</a>(VisualSVN Server是一个在WIndows上帮助我们快速搭建Subversion server的工具。)</p>
<h5 id="Tortoise-SVN-1"><a href="#Tortoise-SVN-1" class="headerlink" title="Tortoise SVN"></a>Tortoise SVN</h5><p><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/TortoiseSVN">TortoiseSVN是一个Windows平台下的Subversion用户端软件.</a></p>
<p>前者是针对Server端，后者是针对Client端。<br>两者结合使用就能实现版本管理控制。</p>
<h5 id="SVN实战实用"><a href="#SVN实战实用" class="headerlink" title="SVN实战实用"></a>SVN实战实用</h5><h6 id="搭建SVN-Server"><a href="#搭建SVN-Server" class="headerlink" title="搭建SVN Server"></a>搭建SVN Server</h6><p>详细设置步骤参考:<br><a target="_blank" rel="noopener" href="https://www.visualsvn.com/server/getting-started/">VISUALSVN SERVER &#x2F;&#x2F; Getting started</a></p>
<p><a target="_blank" rel="noopener" href="https://superuser.com/questions/644278/how-to-use-visualsvn-server-and-tortoisesvn-client">How to use VisualSVN Server and TortoiseSVN client</a></p>
<p>个人工作的话，可以只搭建本地服务器。(未测试Jenkins是否能使用本地服务器)<br>为了多人共享工作(打包IOS需要Mac)，我们需要搭建一个SVN服务器用于存放我们的原始文件。<br>以下以多人共享工作，搭建SVN服务器为例:</p>
<ol>
<li>下载安装Visual SVN</li>
<li>创建SVN Repository<br><img src="/img/Unity/VisalSVNCreateRepository.PNG" alt="VisalSVNCreateRepository"></li>
<li>设置用户成员访问读写权限<br><img src="/img/Unity/VisualSVNUserManager.PNG" alt="VisualSVNUserManager"><br><img src="/img/Unity/VisualSVNGroupManager.PNG" alt="VisualSVNGroupManager"></li>
<li>Check Out刚才创建的Repository</li>
</ol>
<p>Note:</p>
<p>Mac上可以试试<a target="_blank" rel="noopener" href="http://www.smartsvn.com/download">SmartSVN</a></p>
<h6 id="SVN典型目录结构"><a href="#SVN典型目录结构" class="headerlink" title="SVN典型目录结构"></a>SVN典型目录结构</h6><p>SVN</p>
<ul>
<li>&#x2F;trunk(主干，用于所有人开发)</li>
<li>&#x2F;branches(分支，用于存放多个分支副本(比如开发过程中为了保存特定节点分出来的))</li>
<li>&#x2F;tags(存放标记副本)</li>
</ul>
<h3 id="Git"><a href="#Git" class="headerlink" title="Git"></a>Git</h3><p>首先要记住的是Git是分布式的，和Tortoise SVN(集中式)不一样。</p>
<h4 id="Git安装"><a href="#Git安装" class="headerlink" title="Git安装"></a>Git安装</h4><p><a target="_blank" rel="noopener" href="https://git-scm.com/downloads">Git download</a></p>
<p>安装Git没太多说的，直接下载安装即可。</p>
<p>安装好后就能直接使用Git了，下图是安装后通过Git Bash打开的界面:</p>
<p><img src="/img/VersionControl/GitBashUI.png" alt="GitBashUI"></p>
<h4 id="Git-GUI"><a href="#Git-GUI" class="headerlink" title="Git GUI"></a>Git GUI</h4><p>不习惯命令行的话，官方也有很多插件支持可视化Git操作。</p>
<p><a target="_blank" rel="noopener" href="https://git-scm.com/downloads/guis">Git GUI</a></p>
<p>这里本人用的是<a target="_blank" rel="noopener" href="https://gitextensions.github.io/">GitExtensions</a></p>
<p><img src="/img/VersionControl/GitExtensions.png" alt="GitExtensions"></p>
<p>GitExtension UI操作:</p>
<p><img src="/img/VersionControl/GitExtensionCommandsUI.png" alt="GitExtensionCommandsUI"></p>
<p>Note:<br>结合本人使用体验，TortoiseSVN相比GitExtension更方便也更不容易出问题(比如选取提交数量过多GitExtension卡死。TortoiseSVN操作和SVN操作方式类似，熟悉SVN的更容易上手和理解。)</p>
<h4 id="Git优势"><a href="#Git优势" class="headerlink" title="Git优势"></a>Git优势</h4><ol>
<li><p>可离线操作(分布式，可以离线操作。 SVN集中式必须联网和服务器通信)</p>
</li>
<li><p>本地备份不需要本地存在多份实体文件(有抽象的分支概念)</p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://git-scm.com/about/small-and-fast">Small and Fast</a>(小而快)</p>
</li>
<li><p>开源</p>
</li>
</ol>
<h4 id="Git知识"><a href="#Git知识" class="headerlink" title="Git知识"></a>Git知识</h4><p>下面的知识主要参考:</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_22337877/article/details/73249912">Git 工作区和缓存区</a></p>
<ol>
<li>工作区 – 简单来说，电脑中能看到的目录，就是一个工作区。</li>
<li>缓存区 – 在真正提交改动前会存放的地方</li>
<li>版本库(分本地和远程版本库) – 工作区中有一个隐藏目录.git，这个不算工作区，而是Git的版本库。</li>
</ol>
<p>参考下面这张图详细理解:</p>
<p><img src="/img/VersionControl/GitWorkFlow.png" alt="GitWorkFlow"></p>
<p>更多细节学习了解参考:</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/hsany330/article/details/8668748">Git三区（工作区，缓存区，仓库）的互操作</a></p>
<h4 id="Git实战"><a href="#Git实战" class="headerlink" title="Git实战"></a>Git实战</h4><p><strong>主分支最新+没有冲突提交</strong></p>
<ol>
<li><p>git add</p>
<p>把文件添加进去，实际上是把文件修改添加到暂存区</p>
</li>
</ol>
<p><img src="/img/VersionControl/GitAdd.png" alt="GitAdd"></p>
<ol start="2">
<li><p>git commit</p>
<p>提交更改，实际上就是把暂存区的所有内容提交到当前分支。<strong>git commit后还只是提交到自己的分支上，还没有推送到真正的主干分支上。</strong></p>
</li>
</ol>
<p><img src="/img/VersionControl/GitCommit.png" alt="GitCommit"></p>
<ol start="3">
<li><p>git push origin master</p>
<p><strong>git push才是把个人分支的提交推送到主干分支上</strong></p>
</li>
</ol>
<p><strong>落后更新+冲突提交</strong></p>
<ol>
<li><p>git pull</p>
<p>落后分支的话，我们想要提交东西到主分支我们需要先拉去主分支内容</p>
</li>
<li><p>git stash</p>
<p>缓存冲突文件修改，确保能git pull成功</p>
</li>
<li><p>git pull</p>
<p>确保正确拉倒主分支</p>
</li>
<li><p>git commit + 解决冲突</p>
<p>解决冲突，提交缓存区文件倒本地分支</p>
</li>
<li><p>git push</p>
<p>正式推送到主干分支上</p>
</li>
</ol>
<p>从上面可以看出，要想推送最新修改如果落后或者与主分支修改文件有冲突，我们需要先缓存本地修改到缓存区，然后拉取主干分支之后在进行提交推送修改文件流程。</p>
<p><strong>提交过滤指定文件或文件夹</strong></p>
<p>git提供了一个.gitignore文件，方便我们编写需要过滤的规则：</p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="params">#</span> 文件以及目录过滤</span><br><span class="line"><span class="params">#</span> 过滤library目录</span><br><span class="line">Library/</span><br><span class="line"><span class="params">#</span> 过滤.vs目录</span><br><span class="line">.vs/</span><br><span class="line"><span class="params">#</span> 过滤Temp目录</span><br><span class="line">Temp/</span><br><span class="line"><span class="params">#</span> 过滤cs工程文件</span><br><span class="line">*.csproj</span><br><span class="line">*.sln</span><br></pre></td></tr></table></figure>

<p>详细参考：</p>
<p><a target="_blank" rel="noopener" href="https://git-scm.com/docs/gitignore">gitignore</a></p>
<h4 id="Git小知识"><a href="#Git小知识" class="headerlink" title="Git小知识"></a>Git小知识</h4><p>待添加…..</p>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a target="_blank" rel="noopener" href="https://www.visualsvn.com/server/">Visual SVN</a><br><a target="_blank" rel="noopener" href="https://www.liaoxuefeng.com/wiki/0013739516305929606dd18361248578c67b8067c8c017b000/001374027586935cf69c53637d8458c9aec27dd546a6cd6000">集中式VS分布式</a><br><a target="_blank" rel="noopener" href="https://git-scm.com/about">Git Instroduction</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_22337877/article/details/73249912">Git 工作区和缓存区</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2018/10/24/AssetBundle%E8%B5%84%E6%BA%90%E6%89%93%E5%8C%85%E5%8A%A0%E8%BD%BD%E7%AE%A1%E7%90%86%E5%AD%A6%E4%B9%A0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2018/10/24/AssetBundle%E8%B5%84%E6%BA%90%E6%89%93%E5%8C%85%E5%8A%A0%E8%BD%BD%E7%AE%A1%E7%90%86%E5%AD%A6%E4%B9%A0/" class="post-title-link" itemprop="url">AssetBundle资源打包加载管理</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2018-10-24 23:07:12" itemprop="dateCreated datePublished" datetime="2018-10-24T23:07:12+08:00">2018-10-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-08-10 20:26:04" itemprop="dateModified" datetime="2023-08-10T20:26:04+08:00">2023-08-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Resource/" itemprop="url" rel="index"><span itemprop="name">Resource</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>本篇文章是为了记录学习了Unity资源加载(Resource &amp; AssetBundle)相关知识后，对于AssetBundle打包加载框架实战的学习记录。因为前一篇学习Unity资源相关知识的文章太长，所以AssetBundle实战这一块单独提出来写一篇。</p>
<p>基础知识学习回顾，参考:<br><a target="_blank" rel="noopener" href="http://tonytang1990.github.io/2016/10/13/Unity-Resource-Manager">Unity Resource Manager</a></p>
<h1 id="鸣谢"><a href="#鸣谢" class="headerlink" title="鸣谢"></a>鸣谢</h1><p>这里AssetBundle加载管理的框架思路借鉴了Git上的开源库:<br><a target="_blank" rel="noopener" href="https://github.com/tangzx/ABSystem">tangzx&#x2F;ABSystem</a></p>
<p>同时也学习了KEngine相关部分的代码：<br><a target="_blank" rel="noopener" href="https://github.com/mr-kelly/KEngine">mr-kelly&#x2F;KEngine</a></p>
<p>AssetBundle打包这一套后续个人参考<a target="_blank" rel="noopener" href="https://github.com/gmhevinci/MotionFramework">MotionFramework</a>思路编写的。</p>
<p>Unity官方也推出了一个高度可视化和高度自由度打包方案(个人觉得此工具更适合用于辅助查询打包冗余):<br><a target="_blank" rel="noopener" href="https://github.com/Unity-Technologies/AssetBundles-Browser">AssetBundles-Browser</a></p>
<p>本文重点分享，参考ABSystem编写的一套AB加载管理方案实现:<br><a target="_blank" rel="noopener" href="http://tonytang1990.github.io/2018/10/24/AssetBundle-Framework/#%E5%9F%BA%E4%BA%8EAB%E5%BC%95%E7%94%A8%E8%AE%A1%E6%95%B0%E7%9A%84AB%E5%8A%A0%E8%BD%BD%E7%AE%A1%E7%90%86">基于AB引用计数的AB加载管理</a></p>
<h1 id="AssetBundle打包"><a href="#AssetBundle打包" class="headerlink" title="AssetBundle打包"></a>AssetBundle打包</h1><p>Note:<br>这里的AssetBundle打包主要是针对Unity 5.X以及以后的版本来实现学习的。</p>
<h2 id="相关工具"><a href="#相关工具" class="headerlink" title="相关工具"></a>相关工具</h2><ol>
<li>Unity Profiler(Unity自带的新能分析工具，这里主要用于查看内存Asset加载情况)</li>
<li>Unity Studio(Unity AB以及Asset等资源解析查看工具)</li>
<li>DisUnity(解析AB包的工具)</li>
</ol>
<h2 id="AB打包"><a href="#AB打包" class="headerlink" title="AB打包"></a>AB打包</h2><p>AB打包是把资源打包成assetbundle格式的资源。<br>AB打包需要注意的问题：</p>
<ol>
<li>资源冗余</li>
<li>打包策略</li>
<li>AB压缩格式</li>
</ol>
<h3 id="资源冗余"><a href="#资源冗余" class="headerlink" title="资源冗余"></a>资源冗余</h3><p>这里说的资源冗余是指同一份资源被打包到多个AB里，这样就造成了存在多份同样资源。</p>
<p>资源冗余造成的问题：</p>
<ol>
<li>余造成内存中加载多份同样的资源占用内存。</li>
<li>同一份资源通过多次IO加载，性能消耗。</li>
<li>导致包体过大。</li>
</ol>
<p>解决方案：<br>依赖打包</p>
<h4 id="依赖打包"><a href="#依赖打包" class="headerlink" title="依赖打包"></a>依赖打包</h4><p>依赖打包是指指定资源之间的依赖关系，打包时不将依赖的资源重复打包到依赖那些资源的AB里(避免资源冗余)。</p>
<p>在老版(Unity 5之前)，官方提供的API接口是通过BuildPipeline.PushAssetDependencies和BuildPipeline.PopAssetDependencies来指定资源依赖来解决资源冗余打包的问题。</p>
<p>在新版(Unity 5以后)，官方提供了针对每个Asset在面板上设置AssetBundle Name的形式指定每个Asset需要打包到的最终AB。然后通过 API接口BuildPipeline.BuildAssetBundles()触发AB一键打包(Unity自己会根据设置AB的名字以及Asset之间的使用依赖决定是否将依赖的资源打包到最终AB里)。或者通过API接口BuildPipeline.BuildAssetBundles(*)传入自定义分析的打包结论指定如何打包。</p>
<p>这里值得一提的是Unity 5以后提供的增量打包功能。</p>
<h4 id="增量打包-Unity-5以后"><a href="#增量打包-Unity-5以后" class="headerlink" title="增量打包(Unity 5以后)"></a>增量打包(Unity 5以后)</h4><p>增量打包是指Unity自己维护了一个叫manifest的文件(前面提到过的记录AB包含的Asset以及依赖的AB关系的文件)，每次触发AB打包，Unity只会修改有变化的部分，并将最新的依赖关系写入manifest文件。</p>
<p>*.manifest记录所有AB打包依赖信息的文件，内容如下：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">ManifestFileVersion: <span class="number">0</span></span><br><span class="line">CRC: <span class="number">961902239</span></span><br><span class="line">AssetBundleManifest:</span><br><span class="line">  AssetBundleInfos:</span><br><span class="line">    Info_0:</span><br><span class="line">      Name: nonuiprefabs/nui_capsulesingletexture</span><br><span class="line">      Dependencies:</span><br><span class="line">        Dependency_0: materials/mt_singletexturematerial</span><br><span class="line">    Info_1:</span><br><span class="line">      Name: shaders/sd_shaderlist</span><br><span class="line">      Dependencies: &#123;&#125;</span><br><span class="line">    Info_2:</span><br><span class="line">      Name: materials/mt_singletexturematerial</span><br><span class="line">      Dependencies:</span><br><span class="line">        Dependency_0: shaders/sd_shaderlist</span><br><span class="line">        Dependency_1: textures/tx_brick_diffuse</span><br><span class="line">    Info_3:</span><br><span class="line">      Name: textures/tx_brick_diffuse</span><br><span class="line">      Dependencies: &#123;&#125;</span><br><span class="line">    Info_4:</span><br><span class="line">      Name: nonuiprefabs/nui_capsulenormalmappingtexture</span><br><span class="line">      Dependencies: &#123;&#125;</span><br><span class="line">    Info_5:</span><br><span class="line">      Name: textures/tx_brick_normal</span><br><span class="line">      Dependencies: &#123;&#125;</span><br><span class="line">    Info_6:</span><br><span class="line">      Name: materials/mt_normalmappingmaterial</span><br><span class="line">      Dependencies:</span><br><span class="line">        Dependency_0: shaders/sd_shaderlist</span><br><span class="line">        Dependency_1: textures/tx_brick_diffuse</span><br><span class="line">        Dependency_2: textures/tx_brick_normal</span><br></pre></td></tr></table></figure>

<p>问题：<br>虽然Unity5提供了增量打包并记录了依赖关系，但从上面的*.manifest可以看出，依赖关系只记录了依赖的AB的名字没有具体到特定的Asset。</p>
<p>最好的证明就是上面我把用到的Shader都打包到sd_shaderlist里。在我打包的资源里，有两个shader被用到了(SingleTextShader和NormalMappingShader)，这一点可以通过UnityStudio解压查看sd_shaderlist看到:<br><img src="/img/Unity/AssetBundle-Framework/sd_shaderlist.PNG" alt="sd_shaderlist"></p>
<p>从上面可以看出Unity的增量打包只是解决了打包时更新哪些AB的判定，而打包出来的*.manifest文件并不能让我们得知用到了具体哪一个Asset而是AssetBundle。</p>
<p>解决用到哪些Asset这一环节依然是需要我们自己解决的问题，只有存储了用到哪些Asset的信息，我们才能在加载AB的时候对特定Asset做操作(缓存，释放等)。</p>
<p>Note:<br>每一个AB下面都对应一个.manifest文件，这个文件记录了该AB的asset包含情况以及依赖的AB情况，但这些manifest文件最终不会不打包到游戏里的，只有最外层生成的*.manifest文件(记录了所有AB的打包信息)才会被打包到游戏里，所以才有像前面提到的<a target="_blank" rel="noopener" href="http://tonytang1990.github.io/2016/10/13/Unity-Resource-Manager/#AssetBundle">通过读取.manifest文件获取对应AB所依赖的所有AB信息进行加载依赖并最终加载出所需Asset的例子</a></p>
<h4 id="依赖Asset信息打包"><a href="#依赖Asset信息打包" class="headerlink" title="依赖Asset信息打包"></a>依赖Asset信息打包</h4><p>存储依赖的Asset信息可以有多种方式：</p>
<ol>
<li>通过加载依赖AB，依赖Unity自动还原的机制实现依赖Asset加载还原(<em>这正是本博客实现AssetBundle打包以及加载管理的方案</em>)</li>
<li>存储挂载相关信息到Prefab上<br>在设置好AB名字，打包AB之前，将打包对象上用到的信息通过编写[System.Serializable]可序列化标签抽象数据挂载到该Asset对象上，然后打包AB，打包完AB后在运行时利用打包的依赖信息进行依赖Asset加载还原，从而做到对Asset的生命周期掌控。<br><img src="/img/Unity/DPInfoMono.PNG" alt="DPInfoMono"></li>
<li>创建打包Asset到同名AB里，加载的时候读取<br>通过AssetDatabase.CreateAsset()和AssetImporter.GetAtPath()将依赖的信息写入新的Asset并打包到相同AB里，加载时加载出来使用。<br><img src="/img/Unity/AssetBundle-Framework/MaterialAssetInfo.PNG" alt="MaterialAssetInfo"></li>
</ol>
<h3 id="打包策略"><a href="#打包策略" class="headerlink" title="打包策略"></a>打包策略</h3><p>除了资源冗余，打包策略也很重要。打包策略是指决定各个Asset如何分配打包到指定AB里的策略。打包策略会决定AB的数量，资源冗余等问题。AB数量过多会增加IO负担。资源冗余会导致包体过大，内存中存在多份同样的Asset，热更新资源大小等。</p>
<p>打包策略：</p>
<ol>
<li>Logical entities(按逻辑(功能)分类 – 比如按UI，按模型使用，按场景Share等功能分类)<br>优点：可以动态只更新特定Entity</li>
<li>Object Types(类型分类 – 主要用于同类型文件需要同时更新的Asset)<br>优点：只适用于少部分需要经常变化更新的小文件</li>
<li>Concurrent content(加载时机分类 – 比如按Level分类，主要用于游戏里类容固定(Level Based)不会动态变化加载的游戏类型)<br>优点：适合Level based这种一层内容一层不变的游戏类型<br>缺点：不适合用于动态创建对象的游戏类型</li>
</ol>
<p>打包策略遵循几个比较基本的准则：</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/temas/best-practices/assetbundle-usage-patterns#Managing_Loaded_Assets">Split frequently-updated Objects into different AssetBundles than Objects that usually remain unchanged</a>(频繁更新的Asset不要放到不怎么会修改的Asset里而应分别放到不同的AB里)</li>
<li><a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/temas/best-practices/assetbundle-usage-patterns#Managing_Loaded_Assets">Group together Objects that are likely to be loaded simultaneously</a>(把需要同时加载的Asset尽量打包到同一个AB里)</li>
</ol>
<p>从上面可以看出，不同的打包策略适用于不同的游戏类型，根据游戏类型选择最优的策略是关键点。</p>
<h3 id="AB压缩格式"><a href="#AB压缩格式" class="headerlink" title="AB压缩格式"></a>AB压缩格式</h3><p>AB压缩不压缩问题，主要考虑的点如下:</p>
<ol>
<li>加载时间</li>
<li>加载速度</li>
<li>资源包体大小</li>
<li>打包时间</li>
<li>下载AB时间<br>这里就不针对压缩问题做进一步介绍了，主要根据游戏对于各个问题的需求看重点来决定选择(内存与加载性能的抉择)</li>
</ol>
<h3 id="AB打包相关API"><a href="#AB打包相关API" class="headerlink" title="AB打包相关API"></a>AB打包相关API</h3><ol>
<li>Selection(获取Unity Editor当前勾选对象相关信息的接口)</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Object[] assetsselections = Selection.GetFiltered(Type, SelectionMode);</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>AssetDatabase(操作访问Unity Asset的接口)</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取选中Asset的路径</span></span><br><span class="line">assetpath = AssetDatabase.GetAssetPath(assetsselections[i]);</span><br><span class="line"><span class="comment">// 获取选中Asset的GUID</span></span><br><span class="line">assetguid = AssetDatabase.AssetPathToGUID(assetpath);</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>AssetImporter(获取设置Asset的AB名字的接口)</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取指定Asset的Asset设置接口</span></span><br><span class="line">AssetImporter assetimporter = AssetImporter.GetAtPath(assetpath);</span><br><span class="line"><span class="comment">// 设置Asset的AB信息</span></span><br><span class="line">assetimporter.assetBundleVariant = ABVariantName;</span><br><span class="line">assetimporter.assetBundleName = ABName;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>BuildPipeline(AB打包接口)</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">BuildPipeline.BuildAssetBundles(outputPath, BuildAssetBundleOptions, BuildTarget); </span><br><span class="line"></span><br><span class="line">BuildPipeline.BuildAssetBundles(<span class="built_in">string</span> outputPath, AssetBundleBuild[] builds, BuildAssetBundleOptions assetBundleOptions, BuildTarget targetPlatform);</span><br></pre></td></tr></table></figure>

<p>可以看到AB打包Unity 5.X提供了两个主要的接口：</p>
<ol>
<li>前者是依赖于设置每个Asset的AB名字，然后一个接口完成增量打包的方案。<br>优点:<br> 自带增量打包<br>缺点:<br> 需要有一套资源AB命名规则。<br> 开发者可控度低。</li>
<li>后者是提供给开发者自定义哪些Asset打包到指定AB里的一个接口。<br>优点:<br> 可自行实现指定需求的打包规则。<br> 开发者可控度高。<br>缺点:<br> 不自带增量打包需要自己实现。</li>
</ol>
<p>Note:<br>AssetBundle-Browser也是基于前者的一套打包方案，只不过AssetBundle-Browser实现了高度的Asset资源打包可视化操作与智能分析。</p>
<h2 id="AssetBundle加载管理"><a href="#AssetBundle加载管理" class="headerlink" title="AssetBundle加载管理"></a>AssetBundle加载管理</h2><p>实战学习AB加载之前让我们通过一张图先了解下AB与Asset与GameObject之间的关系:<br><img src="/img/Unity/AssetBundleFramework.PNG" alt="AssetBundleFramework"></p>
<h3 id="依赖加载还原"><a href="#依赖加载还原" class="headerlink" title="依赖加载还原"></a>依赖加载还原</h3><p>还记得前面说到的依赖的Assest信息打包吗？<br>这里就需要加载出来并使用进行还原了。<br>这里接不细说加载还原了，主要就是通过存储的依赖信息把依赖的Asset加载进来并设置回去的过程(可以是手动设置回去也可以是Unity自动还原的方式)。</p>
<p>这里主要要注意的是前面那张大图上给出的各种资源类型在Asset加载还原时采用的方式。<br>资源加载还原的方式主要有两种：</p>
<ol>
<li><p>复制+引用<br>UI – 复制(GameObject) + 引用(Components,Tranform等)<br>Material – 复制(材质自身) + 引用(Texture和Shader)</p>
</li>
<li><p>引用<br>Sprite – 引用<br>Audio – 引用<br>Texture – 引用<br>Shader – 引用<br>Material – 引用</p>
</li>
</ol>
<h3 id="AB加载相关API"><a href="#AB加载相关API" class="headerlink" title="AB加载相关API"></a>AB加载相关API</h3><ol>
<li>AssetBundle(AB接口)</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 加载本地压缩过的AB</span></span><br><span class="line">AssetBundle.LoadFromFile(abfullpath)</span><br><span class="line"><span class="comment">// 加载AB里的指定Asset</span></span><br><span class="line">AssetBundle.LoadAsset(assetname);</span><br><span class="line"><span class="comment">// 加载AB里的所有Asset</span></span><br><span class="line">AssetBundle.LoadAllAssets();</span><br></pre></td></tr></table></figure>

<h3 id="AB回收相关API"><a href="#AB回收相关API" class="headerlink" title="AB回收相关API"></a>AB回收相关API</h3><ol>
<li>AssetBundle(AB接口)</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 回收AssetBundle并连带加载实例化出来的Asset以及GameObject一起回收</span></span><br><span class="line">AssetBundle.Unload(<span class="literal">true</span>);</span><br><span class="line"><span class="comment">// 只回收AssetBundle</span></span><br><span class="line">AssetBundle.Unload(<span class="literal">false</span>);</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>Resource(资源接口)</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 回收指定Asset(这里的Asset不能为GameObject)</span></span><br><span class="line">Resource.UnloadAsset(asset);</span><br><span class="line"><span class="comment">// 回收内存以所有不再有任何引用的Asset</span></span><br><span class="line">Resources.UnloadUnusedAssets();</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>GC(内存回收)</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 内存回收</span></span><br><span class="line">GC.Collect();</span><br></pre></td></tr></table></figure>

<p>AB回收的方式有两种：</p>
<ol>
<li>AssetBundle.Unload(false)(基于Asset层面的重用，通过遍历判定的方式去判定Asset是否回收)</li>
<li>AssetBundle.Unload(true)(采取索引技术，基于AB层面的管理，只有AB的引用计数为0时我们直接通过AssetBundle.Unload(true)来卸载AB和Asset资源)</li>
</ol>
<p>接下来结合这两种方式，实战演练加深理解。</p>
<h3 id="基于Asset重用的AB加载"><a href="#基于Asset重用的AB加载" class="headerlink" title="基于Asset重用的AB加载"></a>基于Asset重用的AB加载</h3><p>核心思想：</p>
<ol>
<li>打包时存储了依赖的Asset信息，加载时利用存储的依赖信息并还原</li>
<li>缓存加载进来的Asset的控制权进行重用，卸载AB(AssetBundle.Unload(false))</li>
<li>加载时通过Clone(复制类型)或者返回缓存Asset(引用类型)进行Asset重用</li>
</ol>
<p>一下以之前打包的CapsuleNormalMappingTexture.prefab进行详细说明：<br><img src="/img/Unity/CapsuleNormalMappingPrefab.PNG" alt="CapsuleNormalMappingPrefab.PNG"><br>可以看出CapsuleNormalMappingTexture.prefab用到了如下Asset:</p>
<ol>
<li>NormalMappingMaterial(材质)</li>
<li>Custom&#x2F;Texture&#x2F;NormalMappingShader(Shader)</li>
<li>Brick_Diffuse和Brick_Normal(纹理)</li>
</ol>
<p>开始加载CapsuleNormalMappingTexture.prefab:<br>首先让我们看看加载了CapsuleNormalMappingTexture.prefab前的Asset加载情况:<br><img src="/img/Unity/NonUIPrefabLoadedBeforeProfiler.PNG" alt="NonUIPrefabLoadedBeforeProfiler"><br>可以看出只有Shader Asset被预先加载进来了(因为我预先把所有Shader都加载进来了)<br>第一步：<br>加载CapsuleNormalMappingTexture.prefab对应的AB，因为Prefab是采用复制加引用所以这里需要返回一个通过加载Asset后Clone的一份对象。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">nonuiprefabab = loadAssetBundle(abfullname);</span><br><span class="line"><span class="keyword">var</span> nonuiprefabasset = loadMainAsset(nonuiprefabab);</span><br><span class="line">nonuigo = GameObject.Instantiate(nonuiprefabasset) <span class="keyword">as</span> GameObject;</span><br><span class="line"><span class="comment">// Asest一旦加载进来，我们就可以进行缓存，相应的AB就可以释放掉了</span></span><br><span class="line"><span class="comment">// 后续会讲到相关AB和Asset释放API</span></span><br><span class="line">nonuiprefabab.Unload(<span class="literal">false</span>);</span><br></pre></td></tr></table></figure>

<p>第二步：<br>还原依赖材质<br><img src="/img/Unity/DPInfoMono.PNG" alt="DPInfoMono"></p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">NonUIPrefabDepInfo nonuidpinfo = nonuigo.GetComponent&lt;NonUIPrefabDepInfo&gt;();</span><br><span class="line"><span class="keyword">var</span> dpmaterials = nonuidpinfo.mDPMaterialInfoList;</span><br><span class="line"><span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; dpmaterials.Count; i++)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="built_in">int</span> j = <span class="number">0</span>; j &lt; dpmaterials[i].mMaterialNameList.Count; j++)</span><br><span class="line">    &#123;</span><br><span class="line">        MaterialResourceLoader.getInstance().addMaterial(dpmaterials[i].mRenderer, dpmaterials[i].mMaterialNameList[j]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第三步：<br>还原依赖材质的Shader和Texture依赖引用<br><img src="/img/Unity/MaterialAssetInfo.PNG" alt="MaterialAssetInfo"></p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 根据材质_InfoAsset.asset进行还原材质原始Shader以及Texture信息</span></span><br><span class="line"><span class="keyword">var</span> materialinfoasseetname = <span class="built_in">string</span>.Format(<span class="string">&quot;&#123;0&#125;_&#123;1&#125;InfoAsset.asset&quot;</span>, materialname, ResourceHelper.CurrentPlatformPostfix);</span><br><span class="line"><span class="keyword">var</span> materialassetinfo = loadSpecificAsset(materialab, materialinfoasseetname.ToLower()) <span class="keyword">as</span> MaterialAssetInfo;</span><br><span class="line"><span class="comment">// 加载材质依赖的Shader</span></span><br><span class="line"><span class="keyword">var</span> materialshader = materialassetinfo.mShaderName;</span><br><span class="line"><span class="keyword">var</span> shader = ShaderResourceLoader.getInstance().getSpecificShader(materialshader);</span><br><span class="line">material.shader = shader;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取Shader使用的Texture信息进行还原</span></span><br><span class="line"><span class="keyword">var</span> materialdptextureinfo = materialassetinfo.mTextureInfoList;</span><br><span class="line"><span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; materialdptextureinfo.Count; i++)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 加载指定依赖纹理</span></span><br><span class="line">    Texture shadertexture = TextureResourceLoader.getInstance().loadTexture(materialdptextureinfo[i].Value);</span><br><span class="line">    <span class="comment">//设置材质的对应Texture</span></span><br><span class="line">    material.SetTexture(materialdptextureinfo[i].Key, shadertexture);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下让我们看看加载了CapsuleNormalMappingTexture.prefab后的Asset加载情况:<br><img src="/img/Unity/NonUIPrefabLoadedAfterProfiler.PNG" alt="NonUIPrefabLoadedAfterProfiler"><br>可以看出引用的材质和纹理Asest都被加载到内存里了(Shader因为我预先把所有Shader都加载进来了所以就直接重用了没有被重复加载)<br>第四步：<br>对缓存的Asset进行判定是否回收(这里以材质为例，判定方式可能多种多样，我这里是通过判定是否有有效引用)<br>启动一个携程判定特定Material是否不再有有效组件(所有引用组件为空或者都不再使用任何材质)时回收Material Asset</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Resources.UnloadAsset(materialasset);</span><br></pre></td></tr></table></figure>

<p>接下来让我们看看卸载实例对象后，材质被回收的情况：<br><img src="/img/Unity/MaterialRecycleAssetNumer.PNG" alt="MaterialRecycleAssetNumer"><br><img src="/img/Unity/MaterialRecycle.PNG" alt="MaterialRecycle"><br>可以看到没有被引用的材质Asset被回收了，但内存里的Asset数量却明显增加了。<br>这里多出来的是我们还没有回收的Texture以及Prefab的GameObject以及Components Asset依然还在内存里。<br><img src="/img/Unity/AfterMaterialRecyleTextureStatus.PNG" alt="AfterMaterialRecyleTextureStatus"><br><img src="/img/Unity/AfterMaterialRecyleGameObjectStatus.PNG" alt="AfterMaterialRecyleGameObjectStatus"><br><img src="/img/Unity/AfterMaterialRecyleTrasformStatus.PNG" alt="AfterMaterialRecyleTrasformStatus"><br>第五步：<br>通过切换场景触发置空所有引用将还未回收的Asset变成UnsedAsset或者直接触发Texture Asset回收，然后通过Resources.UnloadUnusedAssets()回收所有未使用的Asset</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mNonUIPrefabAssetMap = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span>(<span class="keyword">var</span> texture <span class="keyword">in</span> mTexturesUsingMap)</span><br><span class="line">&#123;</span><br><span class="line">    unloadAsset(texture.Value);</span><br><span class="line">&#125;</span><br><span class="line">mTexturesUsingMap = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">Resources.UnloadUnusedAssets();</span><br></pre></td></tr></table></figure>

<p><img src="/img/Unity/AfterAssetsRecyleAssetNumber.PNG" alt="AfterAssetsRecyleAssetNumber"><br><img src="/img/Unity/AfterAssetsRecyleTextureStatus.PNG" alt="AfterAssetsRecyleTextureStatus"><br><img src="/img/Unity/AfterAssetsRecyleGameObjectStatus.PNG" alt="AfterAssetsRecyleGameObjectStatus"><br><img src="/img/Unity/AfterAssetsRecyleTransformStatus.PNG" alt="AfterAssetsRecyleTransformStatus"><br>可以看到所有的Texture, GameObject, Transform都被回收了，并且Asset的数量回到了最初的数值。</p>
<h3 id="基于AB引用计数的AB加载管理"><a href="#基于AB引用计数的AB加载管理" class="headerlink" title="基于AB引用计数的AB加载管理"></a>基于AB引用计数的AB加载管理</h3><p><strong>这是本文重点分享的部分</strong></p>
<p>方案1：<br>核心思想：</p>
<ol>
<li>基于AB的引用计数 + AssetBundle.Unload(true)</li>
<li>给每一种资源(e.g. 特效，模型，图片，窗口等)加载都编写统一的资源加载接口(父类抽象)进行自身加载使用的AB引用计数，每个资源负责自身的资源加载管理和返还(主动调用)</li>
<li>由一个单例管理者统一管理所有加载AB的引用计数信息，负责判定是否可回收</li>
</ol>
<p>优点：</p>
<ol>
<li>严格的AB引用计数加载管理和释放</li>
<li>可以做到对资源对象的重用减少GC</li>
<li>对资源对象的重用可以减少AB的重复加载</li>
</ol>
<p>缺点：</p>
<ol>
<li>底层管理的内容比较多(比如基于资源对象的重用)，上层灵活度欠缺(相当于对象池已经写在了最底层)</li>
<li>需要主动去调用返还接口(针对不同资源加载释放时机都需要编写一套对应的代码)</li>
</ol>
<p>方案2：<br>核心思想：</p>
<ol>
<li>基于AB的引用计数 + AssetBundle.Unload(true)</li>
<li>绑定加载AB的生命周期判定到Object上(e.g. GameObject，Image，Material等)，上层无需关心AB的引用计数，只需绑定AB到对应的对象上即可</li>
<li>通过单例管理者统一管理判定依赖使用AB的Object列表是否都为空来判定是否可以回收，无需上层管理AB引用计数返还</li>
</ol>
<p>优点：</p>
<ol>
<li>上层只需关心AB加载绑定，无需关心AB引用计数返还问题，上层使用灵活度高</li>
</ol>
<p>缺点：</p>
<ol>
<li>AB的返还判定跟绑定的Object有关，Object被回收后，AB容易出现重复加载(可以在上层写部分对象池来减少AB的重复加载)</li>
</ol>
<p>考虑到希望上层灵活度高一些，个人现在倾向于第二种方案。</p>
<p>接下来基于第二种方案来实战编写资源AB加载的框架。<br>AB打包这一块采用最新的可视化指定打包策略的方式。</p>
<h2 id="新版AssetBundle加载管理，打包以及热更新"><a href="#新版AssetBundle加载管理，打包以及热更新" class="headerlink" title="新版AssetBundle加载管理，打包以及热更新"></a>新版AssetBundle加载管理，打包以及热更新</h2><p>为了弥补以前设计和实现上不足的地方，从而有了新版AssetBundle加载管理和打包的编写。</p>
<h3 id="新版AssetBundle加载管理"><a href="#新版AssetBundle加载管理" class="headerlink" title="新版AssetBundle加载管理"></a>新版AssetBundle加载管理</h3><p>老版的资源加载管理缺点：</p>
<ol>
<li>面向AssetBundle级别，没有面向Asset级别的加载管理，无法做到Asset级别的加载异步以及Asset级别加载取消的。</li>
<li>老版AssetDatabase模式要求资源必须在设置AB名字后才能正确使用(因为依赖了AB名字作为加载参数而非资源全路径)，无法做到资源导入即可快速使用的迭代开发</li>
<li>资源加载类型分类(普通，预加载，常驻)设计过于面向切场景的游戏设计，不通用到所有游戏类型</li>
<li>老版AssetBundle异步加载采用了开携程的方式，代码流程看起来会比较混乱</li>
<li>老版异步加载没有考虑设计上支持逻辑层加载打断</li>
<li>老版代码没有涉及考虑动态AB下载的设计(边玩边下)</li>
<li>资源加载代码设计还比较混乱，不容易让人看懂看明白</li>
</ol>
<p>综合上面4个问题，新版资源加载管理将支持:</p>
<ol>
<li>面向Asset级别加载管理，支持Asset和AssetBundle级别的同步异步加载。</li>
<li>支持资源导入后AssetDatabase模式马上就能配置全路径加载</li>
<li>资源加载类型只提供普通和常驻两种(且不支持运行时切换相同Asset或AssetBundle的加载类型，意味着一旦第一次加载设定了类型，就再也不能改变，同时第一次因为加载Asset而加载某个AssetBundle的加载类型和Asset一致)，同时提供统一的加载管理策略，细节管理策略由上层自己设计(比如对象池，预加载)</li>
<li>新版异步加载准备采用监听回调的方式来实现，保证流程清晰易懂</li>
<li>新版设计请求UID的概念来支持加载打断设计(仅逻辑层面的打断，资源加载不会打断，当所有逻辑回调都取消时，加载完成时会返还索引计数确保资源正确卸载)</li>
<li>设计上支持动态AB下载(未来填坑)</li>
<li>加载流程重新设计，让代码更清晰</li>
<li><strong>保留索引计数(Asset和AssetBundle级别)+对象绑定的设计(Asset和AssetBundle级别)+按AssetBundle级别卸载(依赖还原的Asset无法准确得知所以无法直接卸载Asset)+加载触发就提前计数(避免异步加载或异步加载打断情况下资源管理异常)</strong></li>
<li><strong>支持非回调式的同步加载返回(通过抽象Loader支持LoadImmediately的方式实现)</strong></li>
</ol>
<p>Note:</p>
<ol>
<li>一直以来设计上都是加载完成后才添加索引计数和对象绑定，这样对于异步加载以及异步打断的资源管理来说是有漏洞的，<strong>新版资源加载管理准备设计成提前添加索引计数，等加载完成后再考虑是否返还计数的方式确保异步加载以及异步加载打断的正确资源管理</strong></li>
</ol>
<p>加载流程设计主要参考:</p>
<p><a target="_blank" rel="noopener" href="https://github.com/xasset/xasset">XAsset</a></p>
<p>对象绑定加索引计数设计主要参考:</p>
<p><a target="_blank" rel="noopener" href="https://github.com/tangzx/ABSystem">tangzx&#x2F;ABSystem</a></p>
<h4 id="类说明"><a href="#类说明" class="headerlink" title="类说明"></a>类说明</h4><p>Manager统一管理：</p>
<pre><code>- ModuleManager(单例类 Manager of Manager的管理类)
- ModuleInterface(模块接口类)
</code></pre>
<p>资源加载类：</p>
<pre><code>- ResourceLoadMethod(资源加载方式枚举类型 -- 同步 or 异步)
- ResourceLoadMode(资源加载模式 -- AssetBundle or AssetDatabase(**限Editor模式下可切换，支持同步和异步(异步是本地模拟延迟加载来实现的)加载方式**))
- ResourceLoadState(资源加载状态 -- 错误，等待加载， 加载中，完成，取消之类的)
- ResourceLoadType(资源加载类型 -- 正常加载，常驻加载)
- ResourceModuleManager(资源加载模块统一入口管理类)
- AbstractResourceModule(资源加载模块抽象)
- AssetBundleModule(AssetBundle模式下的实际加载管理模块)
- AssetDatabaseModule(AssetDatabase模式下的实际加载管理模块)
- AbstractResourceInfo(资源加载使用信息抽象)
- AssetBundleInfo(AssetBundle资源使用信息)
- AssetInfo(Asset资源使用信息)
- LoaderManager(加载器管理单例类)
- Loadable(资源加载器基类--抽象加载流程)
- AssetLoader(Asset加载器基类抽象)
- BundleAssetLoader(AssetBundle模式下的Asset加载器)
- AssetDatabaseLoader(AssetDatabase模式下的Asset加载器)
- BundleLoader(AssetBundle加载器基类抽象)
- AssetBundleLoader(本地AssetBundle加载器)
- DownloadAssetBundleLoader(动态资源AsserBundle加载器)
- AssetDatabaseAsyncRequest(AssetDatabase模式下异步加载模拟)
- AssetBundlePath(AB资源路径相关 -- 处理多平台以及热更资源加载路径问题)
- ResourceDebugWindow.cs(Editor运行模式下可视化查看资源加载(AssetBundle和AssetDatabase两种都支持)详细信息的辅助工具窗口)
- ResourceConstData(资源打包加载相关常量数据)
- ResourceLoadAnalyse(资源加载统计分析工具)
</code></pre>
<h4 id="AB加载管理方案"><a href="#AB加载管理方案" class="headerlink" title="AB加载管理方案"></a>AB加载管理方案</h4><p>加载管理方案：</p>
<ol>
<li>加载指定资源</li>
<li>加载自身AB(自身AB加载完通知资源加载层移除该AB加载任务避免重复的加载任务被创建)，自身AB加载完判定是否有依赖AB</li>
<li>有则加载依赖AB(增加依赖AB的引用计数)(依赖AB采用和自身AB相同的加载方式(ResourceLoadMethod),但依赖AB统一采用ResourceLoadType.NormalLoad加载类型)</li>
<li>自身AB和所有依赖AB加载完回调通知逻辑层可以开始加载Asset资源(AB绑定对象在这一步)</li>
<li>判定AB是否满足引用计数为0，绑定对象为空，且为NormalLoad加载方式则卸载该AB(并释放依赖AB的计数减一)(通知资源管理层AB卸载，重用AssetBundleInfo对象)</li>
<li>切场景，递归判定卸载PreloadLoad加载类型AB资源</li>
</ol>
<p>相关设计：</p>
<ol>
<li>依赖AB与被依赖者采用同样的加载方式(ResourceLoadMethod)，但加载方式依赖AB统一采用ResourceLoadType.NormalLoad</li>
<li>依赖AB通过索引计数管理，只要原始AB不被卸载，依赖AB就不会被卸载</li>
<li>已加载的AB资源加载类型只允许从低往高变(NormalLoad -&gt; Preload -&gt; PermanentLoad)，不允许从高往低(PermanentLoad -&gt; Preload -&gt; NormalLoad)</li>
</ol>
<h4 id="Demo使用说明"><a href="#Demo使用说明" class="headerlink" title="Demo使用说明"></a>Demo使用说明</h4><p>先打开资源调试工具</p>
<p>Tools-&gt;Debug-&gt;资源调试工具</p>
<ol>
<li><p>AssetBundle和AssetDatabase资源加载模式切换<img src="/./img/Unity/AssetBundle-Framework/AssetDatabaseModuleSwitch.png" alt="AssetDatabaseModuleSwitch"></p>
</li>
<li><p>AB依赖信息查看界面</p>
<p><img src="/./img/Unity/AssetBundle-Framework/AssetBundle-Framework/AssetBundleDepInfoUI.png" alt="AssetBundleDepInfoUI"></p>
</li>
<li><p>AB运行时加载管理详细信息界面</p>
<p><img src="/./img/Unity/AssetBundle-Framework/AssetBundleLoadManagerUI.png" alt="AssetBundleLoadManagerUI"></p>
</li>
<li><p>加载器信息查看界面</p>
<p>   <img src="/./img/Unity/AssetBundle-Framework/LoaderDebugUI.png" alt="AssetBundleAsyncUI"></p>
</li>
<li><p>测试界面</p>
<p><img src="/./img/Unity/AssetBundle-Framework/AssetBundleTestUI.png" alt="AssetBundleTestUI"></p>
</li>
<li><p>点击加载窗口预制件按钮后:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ResourceManager.Singleton.getPrefabInstance(</span><br><span class="line">    <span class="string">&quot;Assets/Res/windows/MainWindow.prefab&quot;</span>,</span><br><span class="line">    (prefabInstance, requestUid) =&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        mMainWindow = prefabInstance;</span><br><span class="line">        mMainWindow.transform.SetParent(UIRootCanvas.transform, <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p><img src="/./img/Unity/AssetBundle-Framework/AssetBundleLoadManagerUIAfterLoadWindow.png" alt="AssetBundleLoadManagerUIAfterLoadWindow"><br>可以看到窗口mainwindow依赖于loadingscreen，导致我们加载窗口资源时，loadingscreen作为依赖AB被加载进来了(引用计数为1)，窗口资源被绑定到实例出来的窗口对象上(绑定对象MainWindow)</p>
</li>
<li><p>点击测试异步转同步加载窗口</p>
</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 测试异步转同步窗口加载</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAsynToSyncLoadWindow</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    DIYLog.Log(<span class="string">&quot;onAsynToSyncLoadWindow()&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (mMainWindow == <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        onDestroyWindowInstance();</span><br><span class="line">    &#125;</span><br><span class="line">    AssetLoader assetLoader;</span><br><span class="line">    <span class="keyword">var</span> requestUID = ResourceManager.Singleton.getPrefabInstanceAsync(</span><br><span class="line">        <span class="string">&quot;Assets/Res/windows/MainWindow.prefab&quot;</span>,</span><br><span class="line">        <span class="keyword">out</span> assetLoader,</span><br><span class="line">        (prefabInstance, requestUid) =&gt;</span><br><span class="line">        &#123;</span><br><span class="line">            mMainWindow = prefabInstance;</span><br><span class="line">            mMainWindow.transform.SetParent(UIRootCanvas.transform, <span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    );</span><br><span class="line">    <span class="comment">// 将异步转同步加载</span></span><br><span class="line">    assetLoader.loadImmediately();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="8">
<li>点击销毁窗口实例对象后</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 销毁窗口实例对象</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDestroyWindowInstance</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    DIYLog.Log(<span class="string">&quot;onDestroyWindowInstance()&quot;</span>);</span><br><span class="line">    GameObject.Destroy(mMainWindow);</span><br><span class="line">&#125;</span><br><span class="line">窗口销毁后可以看到之前加载的资源所有绑定对象都为空了，因为被销毁了(MainWindow被销毁了)</span><br></pre></td></tr></table></figure>

<p>​		<img src="/img/Unity/AssetBundle-Framework/AssetBundleLoadManagerUIAfterDestroyWindow.png" alt="AssetBundleLoadManagerUIAfterDestroyWindow"></p>
<ol start="9">
<li>等待回收检测回收后<br><img src="/img/Unity/AssetBundle-Framework/AssetBundleLoadManagerUIAfterUnloadAB.png" alt="AssetBundleLoadManagerUIAfterUnloadAB"><br>上述资源在窗口销毁后，满足了可回收的三大条件(1. 索引计数为0 2. 绑定对象为空 3. NormalLoad加载方式)，最终被成功回收。</li>
</ol>
<p>Note:</p>
<p>读者可能注意到shaderlist索引计数为0，也没绑定对象，但没有被卸载，这是因为shaderlist是被我预加载以常驻资源的形式加载进来的(PermanentLoad)，所以永远不会被卸载。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 加载常驻Shader</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onLoadPermanentShaderList</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    DIYLog.Log(<span class="string">&quot;onLoadPermanentShaderList()&quot;</span>);</span><br><span class="line">    ResourceManager.Singleton.loadAllShader(<span class="string">&quot;shaderlist&quot;</span>, () =&gt;</span><br><span class="line">    &#123;</span><br><span class="line">    &#125;,</span><br><span class="line">    ResourceLoadType.PermanentLoad);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="新版AssetBundle打包"><a href="#新版AssetBundle打包" class="headerlink" title="新版AssetBundle打包"></a>新版AssetBundle打包</h3><p>新版资源打包将支持:</p>
<ol>
<li><p><strong>打包AB的策略由抽象的目录打包策略设定决定</strong></p>
</li>
<li><p><strong>打包后的AB保留目录结构，确保AB模式和AssetDatabase模式加载都面向Asset路径保持一致性</strong></p>
</li>
<li><p><strong>支持打包策略级别的AB压缩格式设置(Note: 仅限使用ScriptableBuildPipeline打包模式)。老版AB打包流程AB压缩格式默认由打包面板压缩格式设置决定。</strong></p>
</li>
<li><p><strong>不支持AB变体功能(ScriptableBuildPipeline也不支持变体功能)，AB后缀名统一由打包和加载平台统一添加</strong></p>
</li>
<li><p><strong>老版AB依赖信息采用原始打包输出的*Manifest文件。新版ScriptableBuildPipeline采用自定义输出打包的CompatibilityAssetBundleManifest文件。</strong></p>
</li>
</ol>
<p>设计主要参考:</p>
<p><a target="_blank" rel="noopener" href="https://github.com/gmhevinci/MotionFramework">MotionFramework</a></p>
<p>核心AB打包思想和流程:</p>
<ol>
<li>通过抽象纯虚拟的打包策略设置(即AB收集打包策略设置界面–设置指定目录的打包策略)，做到AB打包策略设置完全抽象AB名字设置无关化(这样一来无需设置AB或清除AB名字，自己完全掌控AB打包策略和打包结论)</li>
<li>打包时分析打包策略设置的所有有效资源信息，统计出所有有效资源的是否参与打包以及依赖相关等信息，然后结合所有的打包策略设置分析出所有有效Asset的AB打包名字(如果Asset满足多个打包策略设置，默认采用最里层的打包策略设置，找不到符合的采用默认收集打包规则)<strong>(这一步是分析关键，下面细说一下详细步骤)</strong><ul>
<li>通过自定义设置的打包策略得到所有的有效参与打包路径列表</li>
<li>通过AssetDatabase.FindAssets()结合打包路径列表得出所有需要分析的Asset</li>
<li>通过打包配置信息分析所有Asset是否参与打包以及相关打包信息，得出最终的打包信息列表List<AssetBundleBuildInfo></li>
<li>在最后分析得出最后的打包结论之前，这里我个人将AB的依赖信息文件(AssetBuildInfo.asset)的生成和打包信息单独插入在这里，方便AB依赖信息可以跟AB资源一起构建参与热更</li>
<li>最后根据分析得出的打包信息列表List<AssetBundleBuildInfo>构建真真的打包信息List<AssetBundleBuild>进行打包</li>
<li>AB打包完成后进行一些后续的特殊资源处理(比如视频单独打包。AB打包的依赖文件删除(个人采用自定义生成的AssetBuildInfo.Asset作为依赖加载信息文件)。循环依赖检查。创建打包说明文件等。)</li>
</ul>
</li>
<li>不同的打包规则通过反射创建每样一个来实现获取对应打包规则的打包AB名字结论获取(采用全路径AB名的方式，方便快速查看资源打包分布)</li>
<li>然后根据所有有效Asset的所有AB名字打包结论来分析得出自定义的打包结论(即哪些Asset打包到哪个AB名里)</li>
<li>接着根据Asset的AB打包结论来生成最新的AssetBuildInfo(Asset打包信息，可以理解成我们自己分析得出的Manifest文件，用于运行时加载作为资源加载的基础信息数来源)(手动将AssetBuildInfo添加到打包信息里打包成AB，方便热更新走统一流程)</li>
<li>最后采用BuildPipeline.BuildAssetBundles(输出目录, 打包信息列表, ……)的接口来手动指定打包结论的方式触发AB打包。</li>
</ol>
<p>AB打包策略支持了如下几种:</p>
<ol>
<li>按目录打包(打包策略递归子目录判定)</li>
<li>按文件打包(打包策略递归子目录判定)</li>
<li>按固定名字打包(扩展支持固定名字打包–比如所有Shader打包到shaderlist)(打包策略递归子目录判定)</li>
<li>按文件或子目录打包(打包策略递归子目录判定，设定目录按文件打包，其他下层目录按目录打包)</li>
<li>不参与打包(打包策略递归子目录判定)</li>
</ol>
<p>这里先简单的看下新的AB搜集和打包界面:</p>
<p><img src="/img/Unity/AssetBundle-Framework/AssetBundleCollectWindow.PNG" alt="AssetBundleCollectWindow"></p>
<p><img src="/img/Unity/AssetBundle-Framework/AssetBundleBuildWindow.PNG" alt="AssetBundleBuildWindow"></p>
<p>关于Asset路径与AB路径关联信息存在一个叫assetbundlebuildinfo.asset的ScriptableObejct里(单独打包到assetbuildinfo的AB里)，通过Asset路径如何加载到对应AB的关键就在这里。这里和MotionFramework自定义Manifest文件输出不一样，assetbundlebuildinfo.asset只记录AssetPath和AB相关信息映射，不记录AB依赖信息，依赖信息依然采用AB打包生成的*Manifest文件，同时assetbundlebuildinfo.asset采用打包AB的方式（方便和热更新AB走一套机制）</p>
<p>让我们先来看下大致数据信息结构:</p>
<p><img src="/img/Unity/AssetBundle-Framework/AssetBundleBuildInfoView1.PNG" alt="AssetBundleBuildInfoView1"></p>
<p><img src="/img/Unity/AssetBundle-Framework/AssetBundleBuildInfoView2.PNG" alt="AssetBundleBuildInfoView2"></p>
<p><strong>2022&#x2F;1&#x2F;26支持了资源打包后缀名黑名单可视化配置+资源名黑名单可视化配置</strong></p>
<p><img src="/img/Unity/AssetBundle-Framework/PostFixBlackListAndAssetNameBlackList.PNG" alt="PostFixBlackListAndAssetNameBlackList"></p>
<p><strong>2023&#x2F;2&#x2F;8底层支持了新版ScriptableBuildPipeline打包工具打包，加快打包速度(需添加SCRIPTABLE_ASSET_BUILD_PIPELINE宏)</strong></p>
<h4 id="Scriptable-Build-Pipeline"><a href="#Scriptable-Build-Pipeline" class="headerlink" title="Scriptable Build Pipeline"></a>Scriptable Build Pipeline</h4><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Packages/com.unity.scriptablebuildpipeline@1.20/manual/index.html">The Scriptable Build Pipeline (SBP) package allows you to control how Unity builds content. The package moves the previously C++-only build pipeline code to a public C# package with a pre-defined build flow for building AssetBundles. The pre-defined AssetBundle build flow reduces build time, improves incremental build processing, and provides greater flexibility than before.</a></p>
<p>从介绍可以看出Scriptable Build Pipeline是官方推出的新一代Asset Bundle自定义打包管线系统，主要是为了<strong>增加AB打包自由度和减少AB打包时间</strong>。</p>
<p>从老版BuildPipeline.BuildAssetBundles(*)自定义分析打包升级到Scriptable Build Pipeline自定义分析打包，注意事项:</p>
<ol>
<li>老版打包参数走BuildAssetBundleOptions设置，SBP打包参数走BundleBuildParameters设置</li>
<li>AB打包结论都是基于自定义分析得到的List<AssetBundleBuild>，<strong>只不过SBP通过自定义分析的List<AssetBundleBuild>构建BundleBuildContent指定AB打包策略</strong></li>
<li>老版BuildPipeline.BuildAssetBundles(<em>)打包依赖信息是通过输出一个</em>Manifest文件来记录AB依赖信息的，而SBP打包依赖信息是通过打包返回的IBundleBuildResults获取打包Bundle信息后构建自定义CompatibilityAssetBundleManifest数据对象实现类*Manifest依赖信息文件。(<strong>所以SBP自定义AB打包完成后，我们需要创建CompatibilityAssetBundleManifest文件后再单独打包AB</strong>)</li>
</ol>
<p>SBP自定义打包代码:</p>
<p>AssetBundleBuilder.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 执行新版Scriptable Build Pipeline AB打包</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;outputDirectory&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;buildSuccess&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">DoSBPAssetBundleBuild</span>(<span class="params"><span class="built_in">string</span> outputDirectory, <span class="keyword">out</span> <span class="built_in">bool</span> buildSuccess</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> buildParams = MakeBuildParameters();</span><br><span class="line">    IBundleBuildResults results;</span><br><span class="line">    SBPAssetBundleBuilder.BuildAllAssetBundles(<span class="keyword">this</span>, outputDirectory, BuildTarget, buildParams, mAllAssetBundleBuildList, <span class="keyword">out</span> buildSuccess, <span class="keyword">out</span> results);</span><br><span class="line">    CreateSBPReadmeFile(outputDirectory, results);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 获取构建参数</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> CustomBuildParameters <span class="title">MakeBuildParameters</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    CustomBuildParameters bundleBuildParameters = <span class="keyword">new</span> CustomBuildParameters(BuildTarget, BuildTargetGroup, OutputDirectory);</span><br><span class="line">    <span class="comment">//bundleBuildParameters.CacheServerHost = &quot;&quot;;</span></span><br><span class="line">    <span class="comment">//bundleBuildParameters.CacheServerPort = ;</span></span><br><span class="line">    bundleBuildParameters.BundleCompression = GetConfigBuildCompression();</span><br><span class="line">    <span class="keyword">if</span> (IsForceRebuild)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 是否增量打包</span></span><br><span class="line">        bundleBuildParameters.UseCache = !IsForceRebuild;</span><br><span class="line">    &#125;</span><br><span class="line">    bundleBuildParameters.ContiguousBundles = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">if</span> (IsAppendHash)</span><br><span class="line">    &#123;</span><br><span class="line">        bundleBuildParameters.AppendHash = IsAppendHash;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (IsDisableWriteTypeTree)</span><br><span class="line">    &#123;</span><br><span class="line">        bundleBuildParameters.ContentBuildFlags |= ContentBuildFlags.DisableWriteTypeTree;</span><br><span class="line">    &#125;</span><br><span class="line">    bundleBuildParameters.ContentBuildFlags |= ContentBuildFlags.StripUnityVersion;</span><br><span class="line">    <span class="keyword">if</span> (IsIgnoreTypeTreeChanges)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// SBP不支持BuildAssetBundleOptions.IgnoreTypeTreeChanges</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 添加自定义AB压缩格式设置</span></span><br><span class="line">    <span class="keyword">foreach</span>(<span class="keyword">var</span> assetBundleBuildInfo <span class="keyword">in</span> mAllAssetBundleBuildInfoList)</span><br><span class="line">    &#123;</span><br><span class="line">        bundleBuildParameters.AddAssetBundleCompression(assetBundleBuildInfo.AssetBundleName, assetBundleBuildInfo.Compression);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> bundleBuildParameters;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>SBPAssetBundleBuilder.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 执行新版Scriptable Build Pipeline自定义AB打包</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;assetBundleBuilder&quot;&gt;</span>AB打包工具<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;outputDirectory&quot;&gt;</span>输出目录<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;buildTarget&quot;&gt;</span>打包平台<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;options&quot;&gt;</span>打包选项设置<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;allAssetBundleBuildList&quot;&gt;</span>AB打包列表<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;buildSuccess&quot;&gt;</span>打包是否成功<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;results&quot;&gt;</span>打包结果<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> CompatibilityAssetBundleManifest <span class="title">BuildAllAssetBundles</span>(<span class="params">AssetBundleBuilder assetBundleBuilder, <span class="built_in">string</span> outputDirectory, BuildTarget buildTarget, CustomBuildParameters buildParams, List&lt;AssetBundleBuild&gt; allAssetBundleBuildList, <span class="keyword">out</span> <span class="built_in">bool</span> buildSuccess, <span class="keyword">out</span> IBundleBuildResults results</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    ScriptableBuildPipeline.slimWriteResults = <span class="literal">true</span>;</span><br><span class="line">    ScriptableBuildPipeline.useDetailedBuildLog = <span class="literal">false</span>;</span><br><span class="line">    ScriptableBuildPipeline.threadedArchiving = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">var</span> buildContent = <span class="keyword">new</span> BundleBuildContent(allAssetBundleBuildList);</span><br><span class="line">    ReturnCode exitCode = ContentPipeline.BuildAssetBundles(buildParams, buildContent, <span class="keyword">out</span> results);</span><br><span class="line">    buildSuccess = exitCode &gt;= ReturnCode.Success;</span><br><span class="line">    <span class="keyword">if</span> (exitCode &lt; ReturnCode.Success)</span><br><span class="line">    &#123;</span><br><span class="line">        Debug.LogError(<span class="string">$&quot;[BuildPatch] 构建过程中发生错误exitCode:<span class="subst">&#123;exitCode&#125;</span>！&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    CompatibilityAssetBundleManifest unityManifest = CreateAndBuildAssetBundleManifest(assetBundleBuilder, outputDirectory, buildParams, results, <span class="keyword">out</span> buildSuccess);</span><br><span class="line">    CheckCycleDependSBP(unityManifest);</span><br><span class="line">    <span class="keyword">return</span> unityManifest;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 创建并打包AssetBundleManifest</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Note:</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 1. 新版Scriptable Build Pipeline打包没有AssetBundleManifest文件，需要自己创建并打包CompatibilityAssetBundleManifest兼容文件</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;assetBundleBuilder&quot;&gt;</span>AB打包工具<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;outputDirectory&quot;&gt;</span>输出目录<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;buildParams&quot;&gt;</span>打包参数<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;results&quot;&gt;</span>打包结果<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;buildSuccess&quot;&gt;</span>打包是否成功<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> CompatibilityAssetBundleManifest <span class="title">CreateAndBuildAssetBundleManifest</span>(<span class="params">AssetBundleBuilder assetBundleBuilder, <span class="built_in">string</span> outputDirectory, CustomBuildParameters buildParams, IBundleBuildResults results, <span class="keyword">out</span> <span class="built_in">bool</span> buildSuccess</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> outputDirectoryFullPath = Path.GetFullPath(outputDirectory);</span><br><span class="line">    <span class="keyword">var</span> outputDirectoryInfo = <span class="keyword">new</span> DirectoryInfo(outputDirectoryFullPath);</span><br><span class="line">    <span class="keyword">var</span> manifestName = outputDirectoryInfo.Name;</span><br><span class="line">    <span class="keyword">var</span> manifest = ScriptableObject.CreateInstance&lt;CompatibilityAssetBundleManifest&gt;();</span><br><span class="line">    manifest.SetResults(results.BundleInfos);</span><br><span class="line">    <span class="keyword">var</span> manifestPath = buildParams.GetOutputFilePathForIdentifier(<span class="string">$&quot;<span class="subst">&#123;manifestName&#125;</span>.manifest&quot;</span>);</span><br><span class="line">    Debug.Log(<span class="string">$&quot;manifestPath:<span class="subst">&#123;manifestPath&#125;</span>&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> manifestAssetFolderPath = <span class="string">$&quot;Assets/SBPBuildManifest/<span class="subst">&#123;buildParams.Target&#125;</span>&quot;</span>;</span><br><span class="line">    <span class="keyword">if</span>(!Directory.Exists(manifestAssetFolderPath))</span><br><span class="line">    &#123;</span><br><span class="line">        Directory.CreateDirectory(manifestAssetFolderPath);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> manifestAssetFilePath = Path.Combine(manifestAssetFolderPath, <span class="string">$&quot;<span class="subst">&#123;manifestName&#125;</span>.asset&quot;</span>);</span><br><span class="line">    AssetDatabase.CreateAsset(manifest, manifestAssetFilePath);</span><br><span class="line">    AssetDatabase.SaveAssets();</span><br><span class="line">    AssetDatabase.Refresh();</span><br><span class="line">    <span class="keyword">var</span> buildContent = <span class="keyword">new</span> BundleBuildContent(<span class="keyword">new</span>[]</span><br><span class="line">                                              &#123;</span><br><span class="line">                                                  <span class="keyword">new</span> AssetBundleBuild()</span><br><span class="line">                                                  &#123;</span><br><span class="line">                                                      assetBundleName = manifestName,</span><br><span class="line">                                                      assetBundleVariant = assetBundleBuilder.GetAssetBuildBundleVariant(manifestAssetFilePath),</span><br><span class="line">                                                      assetNames = <span class="keyword">new</span>[] &#123; manifestAssetFilePath &#125;,</span><br><span class="line">                                                      <span class="comment">// Manifest的Asset名强制用固定名字</span></span><br><span class="line">                                                      addressableNames = <span class="keyword">new</span>[] &#123; ResourceConstData.AssetBundleManifestAssetName &#125;,</span><br><span class="line">                                                  &#125;</span><br><span class="line">                                              &#125;);</span><br><span class="line">    <span class="keyword">var</span> exitCode = ContentPipeline.BuildAssetBundles(buildParams, buildContent, <span class="keyword">out</span> _);</span><br><span class="line">    buildSuccess = exitCode &gt;= ReturnCode.Success;</span><br><span class="line">    <span class="keyword">if</span>(exitCode &lt; ReturnCode.Success)</span><br><span class="line">    &#123;</span><br><span class="line">        Debug.LogError(<span class="string">$&quot;打包AssetBundleManifest失败！eixtCode:<span class="subst">&#123;exitCode&#125;</span>&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    Debug.Log(<span class="string">$&quot;AB的Manifest打包成功！&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> manifest;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>详情代码参考Github源码：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/TonyTang1990/AssetBundleLoadManager">AssetBundleLoadManager</a></p>
<p>Note:</p>
<ol>
<li><strong>并非老版所有的功能SBP都支持，具体区别参考:<a target="_blank" rel="noopener" href="https://docs.unity3d.com/Packages/com.unity.scriptablebuildpipeline@1.20/manual/UpgradeGuide.html">SBP Upgrade Guide</a></strong></li>
<li><strong>Scriptable Build Pipeline不支持变体功能</strong></li>
<li><strong>打包参数*StripUnityVersion个人测试SBP不起作用，原因不明</strong></li>
<li><strong>自定义AB打包时，AssetBundleBuild.assetNames必须传Asset全路径(Assets&#x2F;<em>&#x2F;</em>&#x2F;*)</strong></li>
<li><strong>自定义AB打包时，AssetBundleBuild.addressableNames传Asset全路径后，老版AB打包支持Asset加载使用多种加载方式(e.g. 全路径，文件名，文件名带后缀等)，但SBP  AB打包只支持按打包测AssetBundleBuild.addressableNames传设置的方式加载Asset</strong></li>
<li><strong>个人测试完全删除所有缓存AB重打的前提下，只对比AB打包这一步，SBP比老版AB打包速度要快10倍左右</strong></li>
</ol>
<h3 id="新版资源热更新流程"><a href="#新版资源热更新流程" class="headerlink" title="新版资源热更新流程"></a>新版资源热更新流程</h3><h4 id="类说明-1"><a href="#类说明-1" class="headerlink" title="类说明"></a>类说明</h4><p>热更类：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- HotUpdateModuleManager.cs(热更新管理模块单例类)</span><br><span class="line">- TWebRequest.cs(资源下载http抽象类)</span><br></pre></td></tr></table></figure>

<p>版本信息类：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- VersionConfigModuleManager.cs(版本管理模块单例类)</span><br><span class="line">- VersionConfig.cs(版本信息抽象类)</span><br></pre></td></tr></table></figure>

<h4 id="功能支持"><a href="#功能支持" class="headerlink" title="功能支持"></a>功能支持</h4><ol>
<li>支持游戏内版本强更(完成 – 暂时限Android，IOS待测试)</li>
<li>支持游戏内资源热更(完成 – 暂时限Android， IOS待测试)</li>
<li>支持游戏内代码热更(未做)</li>
</ol>
<h4 id="热更测试说明"><a href="#热更测试说明" class="headerlink" title="热更测试说明"></a>热更测试说明</h4><p>之前是使用的<a target="_blank" rel="noopener" href="http://www.rejetto.com/hfs/">HFS</a>快速搭建的一个资源本地资源服务器，后来使用阿里的ISS静态资源服务器做了一个网络端的资源服务器。</p>
<p>版本强更流程：</p>
<ol>
<li>比较包内版本信息和包外版本信息检查是否强更过版本</li>
<li>如果强更过版本清空包外相关信息目录</li>
<li>通过资源服务器下载最新服务器版本信息(ServerVersionConfig.json)和本地版本号作对比，决定是否强更版本</li>
<li>结合最新版本号和资源服务器地址(Json配置)拼接出最终热更版本所在的资源服务器地址</li>
<li>下载对应版本号下的强更包并安装</li>
<li>安装完成，退出游戏重进</li>
</ol>
<p>资源热更流程：</p>
<ol>
<li><p>初始化本地热更过的资源列表信息(暂时存储在:Application.persistentDataPath + “&#x2F;ResourceUpdateList&#x2F;ResourceUpdateList.txt”里)</p>
</li>
<li><p>通过资源服务器下载最新服务器版本信息(ServerVersionConfig.json)和本地资源版本号作对比，决定是否资源热更</p>
</li>
<li><p>结合最新版本号，最新资源版本号和资源服务器地址(Json配置)拼接出最终资源热更所在的资源服务器地址</p>
</li>
<li><p>下载对应地址下的AssetBundleMD5.txt(里面包含了对应详细资源MD5信息)</p>
<p>AssetBundleMD5.txt</p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">assetbuildinfo.bundle|ca830d174533e87efad18f1640e5301d</span><br><span class="line">shaderlist.bundle|2ac2d75f7d91fda7880f447e21b2e289</span><br><span class="line">******</span><br></pre></td></tr></table></figure>
</li>
<li><p>根据比较对应地址下的AssetBundleMD5.txt里的资源MD5信息和本地资源MD5信息(包外的MD5信息优先)得出需要更新下载的资源列表</p>
</li>
<li><p>根据得出的需要更新的资源列表下载对应资源地址下的资源并存储在包外(Application.persistentDataPath + “&#x2F;Android&#x2F;“)，同时写入最新的资源MD5信息文件(本地AssetBundleMD5.txt)到本地</p>
</li>
<li><p>直到所有资源热更完成，退出重进游戏</p>
</li>
</ol>
<h4 id="流程图"><a href="#流程图" class="headerlink" title="流程图"></a>流程图</h4><p><img src="/img/Unity/HotUpdate/HotUpdateFlowChat.png" alt="HotUpdateFlowChat"></p>
<h4 id="热更新辅助工具"><a href="#热更新辅助工具" class="headerlink" title="热更新辅助工具"></a>热更新辅助工具</h4><p>Tools-&gt;HotUpdate-&gt;热更新操作工具</p>
<p><img src="/img/Unity/HotUpdate/HotUpdateToolsUI.png" alt="HotUpdateToolsUI"></p>
<p>主要分为以下2个阶段：</p>
<ul>
<li><p>热更新准备阶段:</p>
<ol>
<li>每次资源打包会在包内Resource目录生成一个AssetBundleMd5.txt文件用于记录和对比哪些资源需要热更</li>
</ol>
<p>​    <img src="/./img/Unity/HotUpdate/AssetBundleMD5File.png" alt="AssetBundleMD5File"></p>
<ol start="2">
<li>执行热更新准备操作，生成热更新所需服务器最新版本信息文件(ServerVersionConfig.json)并将包内对应平台资源拷贝到热更新准备目录</li>
</ol>
<p><img src="/./img/Unity/HotUpdate/HotUpdatePreparationFolder.png" alt="HotUpdatePreparationFolder"></p>
</li>
<li><p>热更新判定阶段</p>
<ol>
<li><p>初始化包内(AssetBundleMd5.txt)和包外(AssetBundleMd5.txt)热更新的AssetBundle MD5信息(先读包内后读包外以包外为准)</p>
</li>
<li><p>游戏运行拉去服务器版本和资源版本信息进行比较是否需要版本强更或资源热更新</p>
</li>
<li><p>需要资源热更新则拉去对应最新资源版本的资源MD5信息文件(AssetBundleMD5.txt)进行和本地资源MD5信息进行比较判定哪些资源需要热更新</p>
</li>
<li><p>拉去所有需要热更新的资源，完成后进入游戏</p>
</li>
</ol>
</li>
</ul>
<p>Note:</p>
<ol>
<li>每次打包版本时会拷贝一份AssetBundleMD5.txt到打包输出目录(保存一份方便查看每个版本的资源MD5信息)</li>
</ol>
<h4 id="热更包外目录结构"><a href="#热更包外目录结构" class="headerlink" title="热更包外目录结构"></a>热更包外目录结构</h4><p>PersistentAsset -&gt; HotUpdate -&gt; Platform(资源热更新目录)<br>PersistentAsset -&gt; HotUpdate -&gt; AssetBundleMd5.txt(记录热更新的AssetBundle路径和MD5信息–兼顾进游戏前资源热更和动态资源热更)(格式:热更AB路径:热更AB的MD5&#x2F;n热更AB路径:热更AB的MD5******)<br>PersistentAsset -&gt; Config -&gt; VersionConfig.json(包外版本信息–用于进游戏前强更和热更判定)</p>
<p>PersistentAsset -&gt; HotUpdate -&gt; 版本强更包</p>
<h2 id="资源辅助工具"><a href="#资源辅助工具" class="headerlink" title="资源辅助工具"></a>资源辅助工具</h2><p>资源辅助工具五件套：</p>
<ul>
<li><p>AB删除判定工具</p>
<p>​    <img src="/img/Unity/AssetBundle-Framework/DeleteRemovedAssetBundle.png" alt="DeleteRemovedAssetBundle"></p>
</li>
<li><p>资源依赖查看工具</p>
<p>​    <img src="/img/Unity/AssetBundle-Framework/AssetDependenciesBrowser.png" alt="AssetDependenciesBrowser"></p>
</li>
<li><p>内置资源依赖统计工具(只统计了*.mat和*.prefab，场景建议做成Prefab来统计)</p>
<p>​    <img src="/img/Unity/AssetBundle-Framework/BuildInResourceReferenceAnalyze.png" alt="BuildInResourceReferenceAnalyze"></p>
</li>
<li><p>内置资源提取工具</p>
<p>​    <img src="/img/Unity/AssetBundle-Framework/BuildInResourceExtraction.png" alt="BuildInResourceExtraction"></p>
</li>
<li><p>Shader变体搜集工具</p>
<p>​    <img src="/img/Unity/AssetBundle-Framework/ShaderVariantsCollection.png" alt="ShaderVariantsCollection"></p>
</li>
</ul>
<h2 id="AB实战总结"><a href="#AB实战总结" class="headerlink" title="AB实战总结"></a>AB实战总结</h2><ol>
<li>AB打包和加载是一个相互相存的过程。</li>
<li>Unity 5提供的增量打包只是提供了更新部分AB的打包机制，*.manifest文件里也只提供依赖的AB信息并非Asset，所以想基于Asset的重用还需要我们自己处理。</li>
<li>Unity并非所有的Asset都是采用复制而是部分采用复制，部分采用引用的形式，只有正确掌握了这一点，我们才能确保Asset真确的重用和回收。</li>
<li>打包策略是根据游戏类型，根据实际情况而定。</li>
<li>AB压缩格式选择取决于内存和加载性能以及包体大小等方面的抉择。</li>
<li>资源管理策略而言，主要分为基于Asset管理(AssetBundle.Unload(false))还是基于AB管理(AssetBundle.Unload(true))，前者容易出现内存中多份重复资源，后者需要确保严格的管理机制(比如索引计数))</li>
</ol>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a target="_blank" rel="noopener" href="https://github.com/tangzx/ABSystem">tangzx&#x2F;ABSystem</a><br><a target="_blank" rel="noopener" href="https://github.com/mr-kelly/KEngine">mr-kelly&#x2F;KEngine</a><br><a target="_blank" rel="noopener" href="https://github.com/Unity-Technologies/AssetBundles-Browser">AssetBundles-Browser</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2018/09/10/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2018/09/10/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" class="post-title-link" itemprop="url">设计模式</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2018-09-10 20:39:05" itemprop="dateCreated datePublished" datetime="2018-09-10T20:39:05+08:00">2018-09-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-07-31 15:32:35" itemprop="dateModified" datetime="2022-07-31T15:32:35+08:00">2022-07-31</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Programming-Language/" itemprop="url" rel="index"><span itemprop="name">Programming Language</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>写这篇博客的目的不再是为了一个一个单独去学习了解四人帮的设计模式(以前看四人帮的设计模式时就是这样，并没有结合游戏开发深入思考这些设计模式的真正用处和好处)。</p>
<p>本篇博客的侧重点是针对实战游戏开发过程中用到的设计模式进行深入学习了解(<em>能够运用在实际项目中的东西才是真正能发挥价值的</em>)。</p>
<p>下面几个问题，是本篇博客需要解答的疑问：</p>
<ol>
<li>为什么需要****设计模式？</li>
<li>***设计模式会给游戏开发带来什么好处？</li>
<li>什么情况下适合在实际项目中使用***模式？</li>
</ol>
<p>接下来本文将结合《Game-Programming-Patterns》书籍以及项目实战开发过程中遇到的问题就游戏编程模式而言进行深入学习和分析理解。</p>
<p>《Game-Programming-Patterns》的作者是Bob Nystrom，一个在EA工作了8年的游戏程序开发者。<br>下面给出官方网站链接:<br><a target="_blank" rel="noopener" href="http://gameprogrammingpatterns.com/">Game-Programming-Patterns</a></p>
<p>Note:<br>后面加上””号的内容表示是从书里截取的内容。</p>
<h2 id="游戏架构"><a href="#游戏架构" class="headerlink" title="游戏架构"></a>游戏架构</h2><p>为什么这里要提游戏架构了？<br>作为程序员在写代码的过程中，会发现整个游戏有很多模块，这些模块各自负责不同的功能，所有模块整合到一起才组成了完整的游戏框架。</p>
<p>一个游戏并不是把所有的代码都编写在一个main函数里就能完成的，这样的代码既不具有可读性也不具备扩展性以及维护性。</p>
<p>而游戏架构就是为了让游戏开发变得高度可扩展，可读性高，降低维护成本等。在一个好的游戏架构上编写实现一个功能可能只需要修改很少几处或者添加很少几处代码即可完成。而不好的游戏架构可能会导致你编写了上千行代码去实现一个小功能(这里无论是维护成本还是理解成本都是不能接受的)。</p>
<p>“好的设计意味着当我作出改动，整个程序就好像正等着这种改动。我可以加使用几个函数调用完成任务，而代码库本身无需改动。”</p>
<p>解耦对于上面提到的扩展性和维护成本起到了关键作用，后面会详细学习了解。</p>
<p>下面再引用一句作者对于软件架构的目标的话:<br>“最小化在编写代码前需要了解的信息。”</p>
<p>落实到真正的游戏开发过程中，我们往往要考虑开发周期，开发成本，游戏设计复杂度等，不是说任何游戏开发都往复杂的好的游戏架构上去设计就是正确的，也要结合实际情况分析。(但对于大型游戏开发，好的架构一般来说是必不可少的)</p>
<p>下面是作者给出的几个建议；</p>
<ol>
<li>“抽象和解耦让扩展代码更快更容易，但除非确信需要灵活性，否则不要在这上面浪费时<br>间。”</li>
<li>“在整个开发周期中考虑并为性能设计，但是尽可能推迟那些底层的，基于假设的优化，<br>那会锁死代码。”</li>
<li>“快速地探索游戏的设计空间，但不要跑的太快，在身后留下烂摊子。毕竟，你总得回来<br>打扫。”</li>
<li>“如果打算抛弃这段代码，就不要尝试将其写完美。摇滚明星将旅店房间弄得一团糟，因<br>为他们知道明天他们就走人了。”</li>
<li>“如果你想要做出让人享受的东西，那就享受做它的过程。”</li>
</ol>
<h2 id="游戏设计模式"><a href="#游戏设计模式" class="headerlink" title="游戏设计模式"></a>游戏设计模式</h2><p>接下来我们将结合游戏开发，实战分析学习设计模式带来的好处和实际运用的地方。</p>
<h3 id="命令模式"><a href="#命令模式" class="headerlink" title="命令模式"></a>命令模式</h3><p>首先看看作者是如何定义命令模式的：<br>“命令是具现化的方法调用。”</p>
<p>再看看四人帮是如何定义命令模式的:<br>“Encapsulate a request as an object, thereby letting users parameterize clients with different requests, queue or log requests, and support undoable operations”(将一个请求封装为一个对象，从而使你可用不同的请求对客户进行参数化； 对请求排队或记录请求日志，以及支持可撤销的操作。)</p>
<p>看完定义后更加糊涂了，让我们还是结合实例来学习理解。<br>假设我们通过不同的按键点击去控制玩家的行为，不考虑任何扩展性的前提下我们可能写出下面的代码：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> InputHandler::handleInput()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span>(Input.GetKeyDown(KEY_A))</span><br><span class="line">    &#123;</span><br><span class="line">        Attack();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(Input.GetKeyDown(KEY_SPACE))</span><br><span class="line">    &#123;</span><br><span class="line">        Jump();        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的硬编码确实实现了我们的功能需求，但当我们想改变按键所代表的行为时(比如玩家配置修改按钮功能)，我们会发现上面的代码没法满足需求，因为我们硬编码写死了指定按钮的行为。</p>
<p>我们需要支持按钮动态绑定行为的功能，这时命令模式就起作用了，命令模式把游戏行为封装成对象，通过动态绑定不同的命令可以实现同一按钮实现不同的行为。<br>首先我们需要定义一个命令基类：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> absctract <span class="keyword">class</span> <span class="title">Command</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">execute</span>()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后实现对应行为的命令类：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">AttackCommand</span> : <span class="title">Command</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">execute</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        Attack();</span><br><span class="line">    &#125;    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">JumpCommand</span> : <span class="title">Command</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">execute</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        Jump();</span><br><span class="line">    &#125;    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>此时我们响应输入不再是直接执行特定行为，而是执行绑定在按钮上的命令：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">InputHandler</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> Command Key_A;</span><br><span class="line">    <span class="keyword">private</span> Command Key_Space;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 绑定命令的方法(用于支持动态修改按钮行为绑定)</span></span><br><span class="line">    <span class="comment">// **********</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleInput</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(Input.GetKeyDown(KEY_A))</span><br><span class="line">        &#123;</span><br><span class="line">            Key_A.execute();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(Input.GetKeyDown(KEY_SPACE))</span><br><span class="line">        &#123;</span><br><span class="line">            Key_Space.execute();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>玩家配置按钮行为，在代码里的表现就只是对于Key_A和Key_Space进行不同的行为命令绑定即可，因为我们把<em>请求对象化</em>了(四人帮里提到的定义)，所以可以通过动态绑定对象来绑定不同的命令实现动态绑定行为。</p>
<p>上面的代码还有个问题就是特定命令里的行为并不知道需要表现指定行为的对象，上面的写法是属于全局访问的一种形式，这样做耦合度太高且不灵活。<br>还记得四人帮定义里提到请求对象化后可以<em>对客户参数化</em>，这里的客户就是我们要服务要表现的行为对象。</p>
<p>因为我们把<em>请求对象化</em>了，那么我们对于请求的执行添加一些额外的信息也就是对于命令进行传参的问题：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title">Command</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">execute</span>(<span class="params">GameActor actor</span>)</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">JumpCommand</span> : <span class="title">Command</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">execute</span>(<span class="params">GameActor actor</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        actor.Jump();</span><br><span class="line">    &#125;    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Command* command = inputHandler.handleInput();</span><br><span class="line"><span class="keyword">if</span> (command)</span><br><span class="line">&#123;</span><br><span class="line">    command-&gt;execute(actor);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样一来我们的命令请求就知道应该是对谁做行为操作了。</p>
<p>通过命令模式，我们在按钮和角色操作之间增加了一层重定向，使我们可以通过按钮操作任何角色的行为(只需向命令传入不同的角色即可)。</p>
<p>在真正的实战游戏开发中，角色的AI会使用命令模式，这样一来可以对于所有的角色重用命令行为，而且通过模拟命令队列，我们可以实现AI行为队列的功能(一个行为接一个行为)。这个后续会结合Behavior Designer插件学习来进一步深入了解：</p>
<p>待续……</p>
<p>Note:</p>
<ol>
<li>我们不止可以通过定义类(Command)实现请求对象化，我们也可以通过闭包的形式把请求转化成可返回的函数对象来实现请求对象化。这里需要了解<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/c3c08c621aa1">第一公民函数</a>等概念。</li>
<li>命令模式可以让我们轻易做到撤销和重做的功能。</li>
</ol>
<h3 id="框架模式"><a href="#框架模式" class="headerlink" title="框架模式"></a>框架模式</h3><p>关于框架模式最初了解过MVC，只知道是为了解耦数据，显示以及控制逻辑的一种模式。<br>后来陆陆续续了解到还有MVP,MVVM等模式。<br>为什么会有这么多MV**的框架模式了？<br>核心思想是通过解决M和V的耦合问题来实现界面分离。</p>
<p>接下来我们重点要学习了解MVC和MVVM模式以及实战运用，MVP会简单带过。</p>
<p>参考博客 :<br><a target="_blank" rel="noopener" href="http://www.cnblogs.com/keitsi/p/5764785.html">谈谈对MVC、MVP和MVVM的理解</a><br><a target="_blank" rel="noopener" href="https://draveness.me/mvx">谈 MVC、MVP 和 MVVM 架构模式</a><br><a target="_blank" rel="noopener" href="https://juejin.im/entry/590ae83b5c497d005855988d">Unity 应用架构设计—— MVVM 模式的设计和实施 (Part 1)</a><br><a target="_blank" rel="noopener" href="https://juejin.im/post/5b041882f265da0b9348a4de">mvc的实现</a></p>
<h4 id="MVC"><a href="#MVC" class="headerlink" title="MVC"></a>MVC</h4><p><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/MVC">MVC模式（Model–view–controller）是软件工程中的一种软件架构模式，把软件系统分为三个基本部分：模型（Model）、视图（View）和控制器（Controller）。</a></p>
<p>MVC只是一种框架模式，针对不同的平台环境的实现方式会有些区别，这里本人的理解如下：<br><img src="/img/GameDesignPattern/MVCRelationship.png" alt="MVCRelationship"></p>
<p>模型(Model): 数据结构以及数据处理等。</p>
<p>视图(View)：专注于显示，比如前端UI显示</p>
<p>控制器(Controller)：连接(解耦)模型和视图，如处理视图的请求，更新模型数据，通知视图变化等</p>
<p>这里我们结合实例动手实现一个简单的MVC模式来加深理解：<br>需求：<br>用户通过点击按钮触发一个随机数显示在文本上。</p>
<p>分析事例中的MVC：<br>视图(View)：<br><img src="/img/GameDesignPattern/MVC_View.png" alt="MVC_View"><br>负责显示最终结果。</p>
<p>模型(Model):<br>负责存储随机数数据。</p>
<p>控制器(Controller):<br>负责响应View的点击事件，处理随机数逻辑，修改Model里的随机数数据，通知View更新显示。</p>
<p>这里Model和View之间的更新通知我们会用到监听者模式，Model是发布者，视图是订阅者。<br>接下来看下实际的代码设计:</p>
<p>监听者模式部分：<br>ObserverBase.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 监听者模式的监听者接口</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">ObserverBase</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 用于更新监听者状态</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;subject&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">update</span>(<span class="params">SubjectBase subject</span>)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>SubjectBase.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 监听者模式，发布者父类</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">SubjectBase</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 监听者列表</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> List&lt;ObserverBase&gt; mObserverList;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SubjectBase</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mObserverList = <span class="keyword">new</span> List&lt;ObserverBase&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span> 添加监听者 <span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;observer&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">addObserver</span>(<span class="params">ObserverBase observer</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        mObserverList.Add(observer);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span> 删除监听者 <span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;observer&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">deleteObserver</span>(<span class="params">ObserverBase observer</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        mObserverList.Remove(observer);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span> 通知所有监听者 <span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">notifyAllObserver</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">foreach</span>(<span class="keyword">var</span> obesrver <span class="keyword">in</span> mObserverList)</span><br><span class="line">        &#123;</span><br><span class="line">            obesrver.update(<span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>MVC部分：<br>UIView.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> UnityEngine.UI;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> MVC中的View，负责UI显示</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UIView</span> : <span class="title">MonoBehaviour</span>, <span class="title">ObserverBase</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Text mTxtRandomNumber;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Button mBtnRandomNumber;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Use this for initialization</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Start</span> ()</span> &#123;</span><br><span class="line">        <span class="comment">// 添加UIController对UI点击事件的响应</span></span><br><span class="line">        mBtnRandomNumber.onClick.AddListener(UIController.Instance.OnBtnRandomNumberClick);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">update</span>(<span class="params">SubjectBase subject</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// View层被通知监听对象改变了</span></span><br><span class="line">        <span class="comment">// 这里是UIModel改变了</span></span><br><span class="line">        refreshView(subject);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 刷新视图显示</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">refreshView</span>(<span class="params">SubjectBase subject</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 获取UIModel数据刷新显示</span></span><br><span class="line">        <span class="keyword">var</span> uimodel = subject <span class="keyword">as</span> UIModel;</span><br><span class="line">        mTxtRandomNumber.text = uimodel.mRandomNumber.ToString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>UIModel.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> MVC里的Model，负责存储随机数数据</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UIModel</span> : <span class="title">SubjectBase</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> UIModel Instance</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (mInstance == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                mInstance = <span class="keyword">new</span> UIModel();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> mInstance;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> UIModel mInstance;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 随机数数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> mRandomNumber;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 随机一个数字</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">randomNumber</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mRandomNumber = Random.Range(<span class="number">0</span>, <span class="number">100</span>);</span><br><span class="line">        <span class="comment">// 通知UIView更新显示</span></span><br><span class="line">        notifyAllObserver();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>UIController.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> MVC中的Controller，负责连接(解耦)模型和视图，如处理视图的请求，更新模型数据，通知视图变化等</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 逻辑部分都在这里</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UIController</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> UIController Instance</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(mInstance == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                mInstance = <span class="keyword">new</span> UIController();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> mInstance;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> UIController mInstance;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">UIController</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> UIView按钮点击事件响应</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">OnBtnRandomNumberClick</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 响应UIView按钮点击，</span></span><br><span class="line">        <span class="comment">// 修改UIModel数据，</span></span><br><span class="line">        UIModel.Instance.randomNumber();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>初始化相关代码:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">GameProgrammingPattern</span> : <span class="title">MonoBehaviour</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span> MVC里的模型 <span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> UIModel mModel;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span> MVC里的视图 <span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> UIView mView;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Awake</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 初始化MVC里的各个模块</span></span><br><span class="line">        mModel = UIModel.Instance;</span><br><span class="line">        mView = <span class="keyword">this</span>.transform.GetComponentInChildren&lt;UIView&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Start</span> ()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 添加UIView对UIModel的监听</span></span><br><span class="line">        mModel.addObserver(mView);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到我们把UIView和UIModel设计成了监听者模式用于UIModel变化时通知UIView刷新显示。<br>通过划分V和M，把视图和数据严格分离开，视图只关心显示，模型只关心数据，其他所有的操作变化都是通过控制器去处理。</p>
<p>分析：</p>
<ol>
<li>上面的MVC里V和M并没有完全解耦，视图依然依赖于模型的数据来显示(当然我们可以通过回调注册替换监听者模式的形式去实现V和M的完全解耦)。(参考: <a target="_blank" rel="noopener" href="https://blog.csdn.net/frank901/article/details/72847352"><br>Unity3D用MVC框架思想实现的小例子</a>)</li>
<li>V和M的解耦，让我们可以重复利用M和V，只要控制器处理好V和M逻辑即可。(比如View不变，改变Model数据来源，我们重新编写一个新的Contoller去处理View和新的Model之间的逻辑关系就能实现对View的重用。反之Model重用同理。)</li>
<li>正因为V和M的解耦，所有逻辑相关处理都在C里，使得C看起来过于臃肿。</li>
</ol>
<p>问题：</p>
<ol>
<li>UI操作和数据原本就是大量交互在一起的，使用MVC使V和M分离，使得代码显的过于复杂，Controller这一层过于臃肿，对于后期维护并不友好。</li>
<li>游戏开发中，大部分时候UI变化很大，View层的重用不太现实。</li>
</ol>
<p>下面给出知乎上对于游戏里使用MVC模式的讨论(本人比较认同flashyiyi的分析)：<br><a target="_blank" rel="noopener" href="https://www.zhihu.com/question/23946609">如何在Unity中实现MVC模式？</a></p>
<p>结论：<br>游戏开发需要根据项目需求制定合理的框架设计，并非一种MVC就能包治百病，过度的设计有时候会带来可读性和维护性上的大大降低，Pure MVC并不适用于大部分游戏开发。</p>
<h4 id="MVP"><a href="#MVP" class="headerlink" title="MVP"></a>MVP</h4><p><img src="/img/GameDesignPattern/MVPRelationship.png" alt="MVPRelationship"><br><a target="_blank" rel="noopener" href="http://www.cnblogs.com/keitsi/p/5764785.html">MVP用展示器代替了控制器，而展示器是可以直接更新视图，所以MVP中展示器可以处理视图的请求并递送到模型又可以根据模型的变化更新视图，实现了视图和模型的完全分离。</a></p>
<h4 id="MVVM"><a href="#MVVM" class="headerlink" title="MVVM"></a>MVVM</h4><p><a target="_blank" rel="noopener" href="http://www.cnblogs.com/keitsi/p/5764785.html">MVVM是MVP更进一步的发展，把软件系统分为三个基本部分：模型（Model）、视图（View）和视图模型（ViewModel），关系如下图所示：</a><br><img src="/img/GameDesignPattern/MVVMRelationship.png" alt="MVVMRelationship"></p>
<p>模型(Model): 数据结构，基础数据等(不关心业务逻辑)。</p>
<p>视图(View)：专注于显示，比如前端UI显示</p>
<p>视图模型（ViewModel）：连接模型和视图，暴露视图所关心的数据和属性，负责修改Model数据，<em>视图模型和视图是双向绑定的</em>。</p>
<p>从上面的关系图以及介绍，可以看出MVVM里V和M通过VM完全隔离开来，V的更新通过V和VM的Data Bidning(数据绑定)以及Command模式等形式触发更新显示响应等。M的修改是通过VM来操作，V只关心和VM绑定的数据用于显示，真正的数据是在M里(比如M里存的是一个玩家的名字，VM暴露给V的数据可能是一个地址+名字格式的数据形式)。</p>
<p>MVVM优缺点(来源:<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/8e3d4ab80714">MVC、MVP、MVVM架构分析与比较</a>)：<br>优点：<br>1、低耦合。View可以独立于Model变化和修改，一个ViewModel可以绑定到不同的”View”上，当View变化的时候Model可以不变，当Model变化的时候View也可以不变。<br>2、可重用性。你可以把一些视图逻辑放在一个ViewModel里面，让很多view重用这段视图逻辑。<br>3、独立开发。开发人员可以专注于业务逻辑和数据的开发（ViewModel），设计人员可以专注于页面设计，生成xml代码。<br>4、ViewModel解决MVP中View(Activity)和Presenter相互持有对方应用的问题，界面由数据进行驱动，响应界面操作无需由View(Activity)传递，数据的变化也无需Presenter调用View(Activity)实现，使得数据传递的过程更加简洁，高效。</p>
<p>缺点：<br>1、ViewModel中存在对Model的依赖。<br>2、数据绑定使得 Bug 很难被调试。你看到界面异常了，有可能是你 View 的代码有 Bug，也可能是 Model 的代码有问题。<br>3、IDE不够完善（修改ViewModel的名称对应的xml文件中不会自动修改等）。</p>
<p>关键词：</p>
<ol>
<li>Data Binding(数据绑定)</li>
<li>Event Based Programming</li>
<li>Command</li>
<li>Code Behind</li>
</ol>
<p>后面我们会实战实现一套MVVM里深入理解里面的相关概念，主要参考博客:<br><a target="_blank" rel="noopener" href="https://juejin.im/entry/590ae83b5c497d005855988d#_label3">Unity 应用架构设计—— MVVM 模式的设计和实施 (Part 1)</a></p>
<h5 id="Unity-MVVM实现"><a href="#Unity-MVVM实现" class="headerlink" title="Unity MVVM实现"></a>Unity MVVM实现</h5><p>要是在Unity里实现MVVM架构，那么我们必须先实现一套Unity里的Data Binding。</p>
<h6 id="Data-Binding-in-Unity"><a href="#Data-Binding-in-Unity" class="headerlink" title="Data Binding in Unity"></a>Data Binding in Unity</h6><p>如何在Unity里实现Data Bidning?<br>Data Binding的核心是在修改数据时能触发回调通知，能将数据和回调绑定起来。<br>明白了这一点，回顾C#里设置数据一般是通过方法或者属性或者直接访问public成员变量，要想实现回调触发，我们可以通过C#里的Property设置(set)的形式去确保回调相应。</p>
<h6 id="基础实现"><a href="#基础实现" class="headerlink" title="基础实现"></a>基础实现</h6><p>实现一个可触发回调的Property属性抽象：<br>BindableProperty.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             BindableProperty.cs</span></span><br><span class="line"><span class="comment"> * Author:                  TONYTANG</span></span><br><span class="line"><span class="comment"> * Create Date:             2018/09/15</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> BindableProperty.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 可触发回调的属性抽象</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BindableProperty</span>&lt;<span class="title">T</span>&gt; &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 属性值变化回调委托定义</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;oldvalue&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;newvalue&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">delegate</span> <span class="keyword">void</span> <span class="title">ValueChangedDelegate</span>(<span class="params">T oldvalue, T newvalue</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 属性值变化回调</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> ValueChangedDelegate OnValueChanged;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 属性</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> T Value</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> mValue;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">set</span></span><br><span class="line">        &#123;</span><br><span class="line">            T oldvalue = mValue;</span><br><span class="line">            mValue = <span class="keyword">value</span>;</span><br><span class="line">            ValueChanged(oldvalue, mValue);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> T mValue;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 属性值变化时</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;oldvalue&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;newvalue&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ValueChanged</span>(<span class="params">T oldvalue, T newvalue</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(OnValueChanged != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            OnValueChanged(oldvalue, newvalue);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样一来我们定义VM的Property时就可以按如下方式定义，然后让绑定V里的View到VM里对应的Property上即可：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">readonly</span> BindableProperty&lt;<span class="built_in">string</span>&gt; Name = <span class="keyword">new</span> BindableProperty&lt;<span class="built_in">string</span>&gt;();</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">readonly</span> BindableProperty&lt;<span class="built_in">int</span>&gt; AgeDetail = <span class="keyword">new</span> BindableProperty&lt;<span class="built_in">int</span>&gt;();</span><br></pre></td></tr></table></figure>
<p>按照VM负责和V的数据绑定以及负责M的修改，我们可以定义ViewModel如下：<br>MVVMViewModel.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             MVVMViewModel.cs</span></span><br><span class="line"><span class="comment"> * Author:                  TONYTANG</span></span><br><span class="line"><span class="comment"> * Create Date:             2018/09/15</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> MVVMViewModel.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> MVVM里的VM</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MVVMViewModel</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span> 与View里Name绑定的名字属性 <span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">readonly</span> BindableProperty&lt;<span class="built_in">string</span>&gt; Name = <span class="keyword">new</span> BindableProperty&lt;<span class="built_in">string</span>&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span> 与View里Age绑定的年纪属性 <span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">readonly</span> BindableProperty&lt;<span class="built_in">int</span>&gt; Age = <span class="keyword">new</span> BindableProperty&lt;<span class="built_in">int</span>&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span> Model数据 <span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> MVVMModel Model;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 初始化Model数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;m&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initializeModel</span>(<span class="params">MVVMModel m</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Model = m;</span><br><span class="line">        Name.Value = Model.Name;</span><br><span class="line">        Age.Value = Model.Age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 保存Model数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">saveModel</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        Model.Name = Name.Value;</span><br><span class="line">        Model.Age = Age.Value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>按照V的定义只关心视图，我们可以定义View如下：<br>MVVMView.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             MVVMView.cs</span></span><br><span class="line"><span class="comment"> * Author:                  TONYTANG</span></span><br><span class="line"><span class="comment"> * Create Date:             2018/09/15</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> UnityEngine.UI;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> MVVMView.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> MVVM里的View</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MVVMView</span> : <span class="title">MonoBehaviour</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span> Name输入文本(用于View输入改变Name) <span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> InputField mInputFieldName;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span> Name值展示文本 <span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> Text mTxtName;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span> Age值展示文本 <span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> Text mTxtAge;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span> Model数据保存按钮 <span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> Button mBtnSave;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span> View所绑定的ViewModel <span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> MVVMViewModel mViewModel;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 绑定V到指定VM</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;vm&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">bindViewModel</span>(<span class="params">MVVMViewModel vm</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        mViewModel = vm;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 初始化View(主要是V到VM之间的绑定)</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initialize</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="meta">#<span class="keyword">region</span> Bind VM to V Part</span></span><br><span class="line">        mViewModel.Name.OnValueChanged = onNameChanged;</span><br><span class="line">        mViewModel.Age.OnValueChanged = onAgeChanged;</span><br><span class="line">        <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="keyword">region</span> Bind V To VM</span></span><br><span class="line">        mInputFieldName.onValueChanged.AddListener(onInputNameChanged);</span><br><span class="line">        mBtnSave.onClick.AddListener(onSaveClick);</span><br><span class="line">        <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="keyword">region</span> Bind VM to V Part</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onNameChanged</span>(<span class="params"><span class="built_in">string</span> oldname, <span class="built_in">string</span> newname</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        mInputFieldName.text = newname;</span><br><span class="line">        mTxtName.text = newname;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onAgeChanged</span>(<span class="params"><span class="built_in">int</span> oldvalue, <span class="built_in">int</span> newvalue</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        mTxtAge.text = newvalue.ToString();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="keyword">region</span> Bind V To VM</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onInputNameChanged</span>(<span class="params"><span class="built_in">string</span> newname</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        mViewModel.Name.Value = newname;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onSaveClick</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mViewModel.saveModel();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>按照M的定义只关心数据结构定义，我们可以定义Model如下：<br>MVVMModel.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             MVVMModel.cs</span></span><br><span class="line"><span class="comment"> * Author:                  TONYTANG</span></span><br><span class="line"><span class="comment"> * Create Date:             2018/09/15</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> MVVMModel.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> MVVM里的Model</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MVVMModel</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span> 名字 <span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Name &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span> 年纪 <span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> Age &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MVVMModel</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        Name = <span class="string">&quot;TonyTang&quot;</span>;</span><br><span class="line">        Age = <span class="number">28</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来测试MVVM里的Data Binding:<br>GameProgrammingPattern.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             GameProgrammingPattern.cs</span></span><br><span class="line"><span class="comment"> * Author:                  TONYTANG</span></span><br><span class="line"><span class="comment"> * Create Date:             2018/09/15</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">GameProgrammingPattern</span> : <span class="title">MonoBehaviour</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="keyword">region</span> MVC Part</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span> MVC里的模型 <span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> UIModel mModel;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span> MVC里的视图 <span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> UIView mView;</span><br><span class="line">    <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="keyword">region</span> MVVM Part</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span> MVVM里的模型M <span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> MVVMModel mMVVMModel;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span> MVVM里的视图V <span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> MVVMView mMVVMView;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span> MVVM里的视图VM <span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> MVVMViewModel mMVVMViewModel;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span> 动态变化Age属性值频率 <span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> WaitForSeconds mAgeChangeFrequency;</span><br><span class="line">    <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Awake</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        initMonoScripts();</span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="keyword">region</span> MVC Part</span></span><br><span class="line">        <span class="comment">// 初始化MVC里的各个模块</span></span><br><span class="line">        mModel = UIModel.Instance;</span><br><span class="line">        mView = <span class="keyword">this</span>.transform.GetComponentInChildren&lt;UIView&gt;();</span><br><span class="line">        <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="keyword">region</span> MVVM Part</span></span><br><span class="line">        mMVVMViewModel = <span class="keyword">new</span> MVVMViewModel();</span><br><span class="line">        mMVVMModel = <span class="keyword">new</span> MVVMModel();</span><br><span class="line">        mMVVMView = <span class="keyword">this</span>.transform.GetComponentInChildren&lt;MVVMView&gt;();</span><br><span class="line"></span><br><span class="line">        mAgeChangeFrequency = <span class="keyword">new</span> WaitForSeconds(<span class="number">5.0f</span>);</span><br><span class="line">        <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Start</span> ()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="meta">#<span class="keyword">region</span> MVC Part</span></span><br><span class="line">        <span class="comment">// 添加UIView对UIModel的监听</span></span><br><span class="line">        mModel.addObserver(mView);</span><br><span class="line">        <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="keyword">region</span> MVVM Part</span></span><br><span class="line">        <span class="comment">// 初始化ViewModel里的Model数据</span></span><br><span class="line">        mMVVMViewModel.initializeModel(mMVVMModel);</span><br><span class="line">        <span class="comment">// 绑定View到VM上</span></span><br><span class="line">        mMVVMView.bindViewModel(mMVVMViewModel);</span><br><span class="line">        <span class="comment">// 初始化View和ViewModel的双向绑定</span></span><br><span class="line">        mMVVMView.initialize();</span><br><span class="line">        <span class="comment">// 通过携程动态使用VM修改值Age触发View变化显示</span></span><br><span class="line">        CoroutineManager.Singleton.startCoroutine(changeViewModelAgeCoroutine());</span><br><span class="line">        <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 初始化需要挂在的脚本</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initMonoScripts</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">this</span>.gameObject.AddComponent&lt;CoroutineManager&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 修改ViewModel的Age属性值携程</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function">IEnumerator <span class="title">changeViewModelAgeCoroutine</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">while</span>(<span class="literal">true</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">yield</span> <span class="keyword">return</span> mAgeChangeFrequency;</span><br><span class="line">            mMVVMViewModel.Age.Value = Random.Range(<span class="number">0</span>, <span class="number">100</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们的测试UI如下:<br><img src="/img/GameDesignPattern/MVVMPatternTestUI.png" alt="MVVMPatternTestUI"><br>InputField里动态输入文字，会看到右边的文本动态跟新了，同时下方的Age文本因为携程动态修改数据刷新显示:<br><img src="/img/GameDesignPattern/MVVMPatternExample.png" alt="MVVMPatternExample"><br>上面的表现可以看出，我们通过绑定V和VM里的数据实现了动态修改VM数据后，V自动跟着刷新显示，V变化VM自动更新，做到了数据驱动刷新显示，完全隔离了V和M。</p>
<h6 id="解耦V和VM"><a href="#解耦V和VM" class="headerlink" title="解耦V和VM"></a>解耦V和VM</h6><p>上面的实现有一个比较严重的问题，就是V和VM严重的耦合了，V里通过保存一个指定VM类型的实例对象来访问VM，如果我们想将V绑定到另一个VM的话，就发现代码需要改动才能支持，同时上面的代码是没有处理动态绑定VM时对原始VM动态绑定部分的解除。这里为了改进这一点，我们需要了解几个概念：</p>
<ol>
<li>依赖倒置原则（DIP）<br><a target="_blank" rel="noopener" href="http://www.voidcn.com/article/p-gbdebxum-bnx.html">高层模块不应依赖于低层模块，两者应该依赖于抽象。 抽象不不应该依赖于实现，实现应该依赖于抽象。</a></li>
<li>控制反转（IoC）<br><a target="_blank" rel="noopener" href="http://www.voidcn.com/article/p-gbdebxum-bnx.html">控制反转（IoC），它为相互依赖的组件提供抽象，将依赖（低层模块）对象的获得交给第三方（系统）来控制，即依赖对象不在被依赖模块的类中直接通过new来获取。</a></li>
<li>依赖注入（DI）<br><a target="_blank" rel="noopener" href="http://www.voidcn.com/article/p-gbdebxum-bnx.html">依赖注入（DI），它提供一种机制，将需要依赖（低层模块）对象的引用传递给被依赖（高层模块）对象。</a></li>
</ol>
<p>引用的文章里对几个核心概念做了如下总结，这里直接搬过来:<br><a target="_blank" rel="noopener" href="http://www.voidcn.com/article/p-gbdebxum-bnx.html">依赖倒置原则（DIP）：一种软件架构设计的原则（抽象概念）。<br>控制反转（IoC）：一种反转流、依赖和接口的方式（DIP的具体实现方式）。<br>依赖注入（DI）：IoC的一种实现方式，用来反转依赖（IoC的具体实现方式）。<br>IoC容器：依赖注入的框架，用来映射依赖，管理对象创建和生存周期（DI框架）。</a></p>
<p>上面的核心概念是高层模块不应该直接依赖底层模块，而是依赖于抽象，然后通过依赖注入的形式实现反转依赖，解耦高层模块和底层模块。</p>
<p>针对解耦V和VM，让我们修改上面的实现：<br>为了解耦V和VM，根据依赖倒置的原则，我们需要让V依赖于VM的接口而非具体的类，同时通过依赖注入的形式传入实现控制反转。<br>IMVVMView.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             IMVVMView.cs</span></span><br><span class="line"><span class="comment"> * Author:                  TONYTANG</span></span><br><span class="line"><span class="comment"> * Create Date:             2018/09/16</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> IMVVMView.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> MVVM里的V的抽象接口(抽象出V和VM之间的绑定关系)</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IMVVMView</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> MVVM里V的VM上下文</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Note:</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 通过定义VM的Interface接口类成员，实现依赖倒置</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    IMVVMViewModel mMVVMViewModelContext</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>IMVVMViewModel.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             IMVVMViewModel.cs</span></span><br><span class="line"><span class="comment"> * Author:                  TONYTANG</span></span><br><span class="line"><span class="comment"> * Create Date:             2018/09/16</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> IMVVMViewModel.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> MVVM里的VM抽象接口(实现依赖倒置，避免V和VM的高度耦合)</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IMVVMViewModel</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>为了实现ViewModel可动态绑定修改，我们还需定义一个View的父类，用于实现动态响应ViewModel的绑定修改：<br>MVVMBaseView.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             MVVMBaseView.cs</span></span><br><span class="line"><span class="comment"> * Author:                  TONYTANG</span></span><br><span class="line"><span class="comment"> * Create Date:             2018/09/16</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> MVVMBaseView.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> MVVM里的View的基类(含ViewModel的动态绑定定义以及ViewModel的接口成员定义(依赖倒置))</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MVVMBaseView</span> : <span class="title">MonoBehaviour</span>, <span class="title">IMVVMView</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 可绑定的ViewModel属性</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 用于实现V动态绑定VM</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">readonly</span> BindableProperty&lt;IMVVMViewModel&gt; ViewModelProperty = <span class="keyword">new</span> BindableProperty&lt;IMVVMViewModel&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> V的VM上下文属性接口</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> IMVVMViewModel mMVVMViewModelContext</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> ViewModelProperty.Value;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">set</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(!mIsInitialized)</span><br><span class="line">            &#123;</span><br><span class="line">                OnInitialize();</span><br><span class="line">                mIsInitialized = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            ViewModelProperty.Value = <span class="keyword">value</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> View是否初始化过</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 用于避免逻辑依赖于显示(比如绑定VM上下文属性变化回调时，依赖于View的显示)</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">protected</span> <span class="built_in">bool</span> mIsInitialized;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MVVMBaseView</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 绑定VM上下文修改回调</span></span><br><span class="line">        <span class="comment">// 避免这种写法，会导致绑定VM上下文属性变化回调依赖于显示</span></span><br><span class="line">        <span class="comment">//ViewModelProperty.OnValueChanged += OnBindingContextChanged;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 第一次初始化初始化方法</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">OnInitialize</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 绑定VM上下文修改回调</span></span><br><span class="line">        ViewModelProperty.OnValueChanged += OnBindingContextChanged;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> VM动态绑定回调</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;oldvm&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;newvm&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">OnBindingContextChanged</span>(<span class="params">IMVVMViewModel oldvm, IMVVMViewModel newvm</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>修改原来的MVVMView实现:<br>MVVMView.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             MVVMView.cs</span></span><br><span class="line"><span class="comment"> * Author:                  TONYTANG</span></span><br><span class="line"><span class="comment"> * Create Date:             2018/09/15</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> UnityEngine.UI;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> MVVMView.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> MVVM里的View</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MVVMView</span> : <span class="title">MVVMBaseView</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span> Name输入文本(用于View输入改变Name) <span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> InputField mInputFieldName;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span> Name值展示文本 <span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> Text mTxtName;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span> Age值展示文本 <span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> Text mTxtAge;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span> Model数据保存按钮 <span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> Button mBtnSave;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 真实绑定的VM对象访问入口</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> MVVMViewModel ViewModel</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> (MVVMViewModel)mMVVMViewModelContext;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 响应VM绑定变化回调</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 在这里做V和VM绑定相关的事</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;oldvm&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;newvm&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnBindingContextChanged</span>(<span class="params">IMVVMViewModel oldvm, IMVVMViewModel newvm</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">base</span>.OnBindingContextChanged(oldvm, newvm);</span><br><span class="line">        <span class="comment">// 解除老的VM相关绑定</span></span><br><span class="line">        <span class="keyword">if</span>(oldvm != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="meta">#<span class="keyword">region</span> Bind VM to V Part</span></span><br><span class="line">            MVVMViewModel ovm = oldvm <span class="keyword">as</span> MVVMViewModel;</span><br><span class="line">            ovm.Name.OnValueChanged -= onNameChanged;</span><br><span class="line">            ovm.Age.OnValueChanged -= onAgeChanged;</span><br><span class="line">            <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">            <span class="meta">#<span class="keyword">region</span> Bind V To VM</span></span><br><span class="line">            mInputFieldName.onValueChanged.RemoveListener(onInputNameChanged);</span><br><span class="line">            mBtnSave.onClick.RemoveListener(onSaveClick);</span><br><span class="line">            <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 添加新的VM相关绑定</span></span><br><span class="line">        <span class="keyword">if</span> (ViewModel != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="meta">#<span class="keyword">region</span> Bind VM to V Part            </span></span><br><span class="line">            ViewModel.Name.OnValueChanged += onNameChanged;</span><br><span class="line">            ViewModel.Age.OnValueChanged += onAgeChanged;</span><br><span class="line">            <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">            <span class="meta">#<span class="keyword">region</span> Bind V To VM</span></span><br><span class="line">            mInputFieldName.onValueChanged.AddListener(onInputNameChanged);</span><br><span class="line">            mBtnSave.onClick.AddListener(onSaveClick);</span><br><span class="line">            <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">#<span class="keyword">region</span> Bind VM to V Part</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onNameChanged</span>(<span class="params"><span class="built_in">string</span> oldname, <span class="built_in">string</span> newname</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        mInputFieldName.text = newname;</span><br><span class="line">        mTxtName.text = newname;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onAgeChanged</span>(<span class="params"><span class="built_in">int</span> oldvalue, <span class="built_in">int</span> newvalue</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        mTxtAge.text = newvalue.ToString();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="keyword">region</span> Bind V To VM</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onInputNameChanged</span>(<span class="params"><span class="built_in">string</span> newname</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        ViewModel.Name.Value = newname;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onSaveClick</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        ViewModel.saveModel();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>MVVMViewModel只需要修改来实现IMVVMViewModel即可:<br>MVVMViewModel.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MVVMViewModel</span> : <span class="title">IMVVMViewModel</span>&#123;</span><br><span class="line"></span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试代码也要跟着修改:<br>GameProgrammingPattern.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Start</span> ()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">#<span class="keyword">region</span> MVVM Part</span></span><br><span class="line">    <span class="comment">// 初始化ViewModel里的Model数据</span></span><br><span class="line">    mMVVMViewModel.initializeModel(mMVVMModel);</span><br><span class="line">    <span class="comment">// 绑定View到VM上</span></span><br><span class="line">    mMVVMView.mMVVMViewModelContext = mMVVMViewModel;</span><br><span class="line">    <span class="comment">// 通过携程动态使用VM修改值Age触发View变化显示</span></span><br><span class="line">    CoroutineManager.Singleton.startCoroutine(changeViewModelAgeCoroutine());</span><br><span class="line">    <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结果依然是正常双向绑定V和VM，实现V和M隔离，但现在我们的V不在和VM强耦合了，可以动态绑定到同类型不同的VM实例对象:<br><img src="/img/GameProgrammingPattern/MVVMPatternExampleRefactor.png" alt="MVVMPatternExampleRefactor"></p>
<h6 id="VM如何通知V"><a href="#VM如何通知V" class="headerlink" title="VM如何通知V"></a>VM如何通知V</h6><p>V和VM在MVVM里是通过数据绑定实现的双向绑定，但假设V里点击一个按钮后修改VM里的数据后并不需要更新View刷新显示，而是需要VM通知View数据处理完毕并将最新数据返回做后续处理了(比如弹窗口提示之类)？</p>
<p>这时候我们需要的是一种通知数据处理完毕后回调通知的形式，我们很容易想到的一种实现方案是传递回调的形式：<br>伪代码:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">View</span> : <span class="title">BaseView</span></span><br><span class="line">&#123;</span><br><span class="line">    ******</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onBtnClick</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mViewModel.ChangeName(newname, ChangeNameCallback);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ChangeNameCallback</span>(<span class="params"><span class="built_in">string</span> name</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// VM处理完毕后回调做后续处理</span></span><br><span class="line">    &#125;    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>但这样在View里编写Code Behind代码会导致View层被污染，导致View层包含逻辑代码。同时也打断了MVVM里ViewModel的Unit Test特性。</p>
<p>我们可以通过绑定按钮点击到ViewModel的一个Command(包含操作的数据对象以及检查是否可执行以及最终逻辑回调等)里，把逻辑部分搬到ViewModel层实现Zero Code Behind并不破坏ViewModel的Unit Test。也可以考虑直接调用VM方法在方法里写逻辑。如果是涉及到View层表现，可以考虑绑定属性，在VM写逻辑去修改对应属性触发View层表现。</p>
<p>这里并没有太弄懂Command存在的意义(和直接在VM层写逻辑的区别是什么？)，所以这里没有去实现这一套东西。</p>
<h6 id="简化V和VM绑定代码"><a href="#简化V和VM绑定代码" class="headerlink" title="简化V和VM绑定代码"></a>简化V和VM绑定代码</h6><p>从前面的事例可以看到，V和VM的绑定都是成对出现，属于有规律可循的代码(后续可以自动化代码生成来解决)，但这里我们希望解决的不是自动化代码的问题，而是提供一套更方便的代码绑定方案，解决大量复杂代码的编写。</p>
<p>实现思考:</p>
<ol>
<li>通过统一的一个类来实现简化V和VM的绑定。</li>
<li>因为要访问VM的属性对象，需要通过反射访问(没想到更好的方案)</li>
</ol>
<p>因为涉及到反射实现，这里觉得并不好(一是效率方面，二是直观上查找不到属性引用(维护方面))，不如单纯的实现自动化代码生成的形式。所以这里就不去实现这一套方案了，详细参考下文作者实现：<br><a target="_blank" rel="noopener" href="http://www.cnblogs.com/OceanEyes/p/unity3d_framework_designing_get_started_with_mvvm_part2.html">Unity应用架构设计(1)—— MVVM 模式的设计和实施(Part 2)</a></p>
<h6 id="VM和VM之间通信"><a href="#VM和VM之间通信" class="headerlink" title="VM和VM之间通信"></a>VM和VM之间通信</h6><p>现实开发过程中，我们的View和View有些时候是需要通信的，虽然View实现了和ViewModel的双向绑定，但并没有解决View和View之间的通信问题。</p>
<p>实现方便来说我们会去写如下代码实现View与View之间的访问:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ViewA</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">notifyViewB</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        ViewB.UpdateView();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>但这样的代码是的View与View之间强耦合了，并不推荐这样实现，我们使用MVVM模式的目的是为了解耦V和M，同时实现V和VM之间数据驱动刷新。这里我们需要解决View和View之间ViewModel与ViewModel之间通信的问题。</p>
<p>首先V和VM是一对一的，V和VM是双向绑定的，所以要实现View和View之间的沟通交流，其实只要实现VM和VM之间的沟通交流即可。VM和VM是一对多的，为了解耦，我们可以通过一个中介者来解耦并统一管理ViewModel之间的沟通交流，然后使用订阅者模式实现消息订阅的形式模拟实现ViewModel之间一对多的沟通交流。</p>
<p>首先核心的消息统一订阅分发类：<br>MessageDispatcher.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             MessageDispatcher.cs</span></span><br><span class="line"><span class="comment"> * Author:                  TONYTANG</span></span><br><span class="line"><span class="comment"> * Create Date:             2018/09/16</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> MessageDispatcher.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 消息分发单例类(这里是为了解耦类似ViewModel和ViewModel之间的交流)</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 类似于EventDispather，只不过这里是支持对任意string的消息监听而非EventId枚举</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MessageDispatcher</span> : <span class="title">SingletonTemplate</span>&lt;<span class="title">MessageDispatcher</span>&gt;&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 消息回调定义</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;sender&quot;&gt;</span>发送消息对象<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;paras&quot;&gt;</span>消息参数<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">delegate</span> <span class="keyword">void</span> <span class="title">MessageDelegate</span>(<span class="params"><span class="built_in">object</span> sender, <span class="keyword">params</span> <span class="built_in">object</span>[] paras</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 消息映射类</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Key为订阅的消息字符串</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Value为注册的回调</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> Dictionary&lt;<span class="built_in">string</span>, MessageDelegate&gt; mMessageMap = <span class="keyword">new</span> Dictionary&lt;<span class="built_in">string</span>, MessageDelegate&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 注册监听消息</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;message&quot;&gt;</span>监听的消息字符串<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;handler&quot;&gt;</span>监听的消息响应回调<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">subscribe</span>(<span class="params"><span class="built_in">string</span> message, MessageDelegate handler</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">string</span>.IsNullOrEmpty(message))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (!mMessageMap.ContainsKey(message))</span><br><span class="line">            &#123;</span><br><span class="line">                mMessageMap.Add(message, handler);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                mMessageMap[message] += handler;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">&quot;不能订阅空的字符串消息!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 注销消息监听</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;message&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;handler&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unSubscribe</span>(<span class="params"><span class="built_in">string</span> message, MessageDelegate handler</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">string</span>.IsNullOrEmpty(message))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (mMessageMap.ContainsKey(message))</span><br><span class="line">            &#123;</span><br><span class="line">                mMessageMap[message] -= handler;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">&quot;不能取消空的字符串消息!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 分发消息</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;message&quot;&gt;</span>分发的消息字符串<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;sender&quot;&gt;</span>发送消息对象<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;paras&quot;&gt;</span>消息参数<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">publish</span>(<span class="params"><span class="built_in">string</span> message, <span class="built_in">object</span> sender, <span class="keyword">params</span> <span class="built_in">object</span>[] paras</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">string</span>.IsNullOrEmpty(message))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (mMessageMap.ContainsKey(message))</span><br><span class="line">            &#123;</span><br><span class="line">                mMessageMap[message](sender, paras);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">&quot;不能分发空的字符串消息!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>修改ViewModel1的代码，添加消息监听:<br>MVVMViewModel.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             MVVMViewModel.cs</span></span><br><span class="line"><span class="comment"> * Author:                  TONYTANG</span></span><br><span class="line"><span class="comment"> * Create Date:             2018/09/15</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> MVVMViewModel.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> MVVM里的VM</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MVVMViewModel</span> : <span class="title">IMVVMViewModel</span>&#123;</span><br><span class="line"></span><br><span class="line">    ******</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 注册消息监听</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerMessageListener</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        MessageDispatcher.Singleton.subscribe(<span class="string">&quot;ChangeName&quot;</span>, onChangeNameMessageHandler);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 取消小心监听注册</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unregisterMessageListener</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        MessageDispatcher.Singleton.unSubscribe(<span class="string">&quot;ChangeName&quot;</span>, onChangeNameMessageHandler);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 保存Model数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">saveModel</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        Model.Name = Name.Value;</span><br><span class="line">        Model.Age = Age.Value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 响应ChangeName消息回调</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;sender&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;paras&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onChangeNameMessageHandler</span>(<span class="params"><span class="built_in">object</span> sender, <span class="built_in">object</span>[] paras</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Name.Value = paras[<span class="number">0</span>] <span class="keyword">as</span> <span class="built_in">string</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>添加View 2和ViewModel2相关代码:<br>MVVMView2.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             MVVMView2.cs</span></span><br><span class="line"><span class="comment"> * Author:                  TONYTANG</span></span><br><span class="line"><span class="comment"> * Create Date:             2018/09/16</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> UnityEngine.UI;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> MVVMView2.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 第二个View</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MVVMView2</span> : <span class="title">MVVMBaseView</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span> 通知ViewModel1改变Name属性按钮 <span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> Button mBtnChangeViewModel1Name;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 真实绑定的VM对象访问入口</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> MVVMViewModel2 ViewModel</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> (MVVMViewModel2)mMVVMViewModelContext;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 响应VM绑定变化回调</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 在这里做V和VM绑定相关的事</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;oldvm&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;newvm&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnBindingContextChanged</span>(<span class="params">IMVVMViewModel oldvm, IMVVMViewModel newvm</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">base</span>.OnBindingContextChanged(oldvm, newvm);</span><br><span class="line">        <span class="comment">// 解除老的VM相关绑定</span></span><br><span class="line">        <span class="keyword">if</span> (oldvm != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="meta">#<span class="keyword">region</span> Bind VM to V Part</span></span><br><span class="line">            <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">            <span class="meta">#<span class="keyword">region</span> Bind V To VM</span></span><br><span class="line">            mBtnChangeViewModel1Name.onClick.RemoveListener(onNotifyViewModel1Click);</span><br><span class="line">            <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 添加新的VM相关绑定</span></span><br><span class="line">        <span class="keyword">if</span> (ViewModel != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="meta">#<span class="keyword">region</span> Bind VM to V Part            </span></span><br><span class="line">            <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">            <span class="meta">#<span class="keyword">region</span> Bind V To VM</span></span><br><span class="line">            mBtnChangeViewModel1Name.onClick.AddListener(onNotifyViewModel1Click);</span><br><span class="line">            <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="keyword">region</span> Bind VM to V Part</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="keyword">region</span> Bind V To VM</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onNotifyViewModel1Click</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        ViewModel.notifyViewModel1NameChange();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>MVVMViewModel2.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             MVVMViewModel2.cs</span></span><br><span class="line"><span class="comment"> * Author:                  TONYTANG</span></span><br><span class="line"><span class="comment"> * Create Date:             2018/09/16</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> MVVMViewModel2.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 第二个ViewModel</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MVVMViewModel2</span> : <span class="title">IMVVMViewModel</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 通知ViewModel1的名字修改</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">notifyViewModel1NameChange</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        MessageDispatcher.Singleton.publish(<span class="string">&quot;ChangeName&quot;</span>, <span class="keyword">this</span>, <span class="string">&quot;Hello World!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>初始化View2和ViewModel2相关的绑定:<br>GameProgrammingPattern.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             GameProgrammingPattern.cs</span></span><br><span class="line"><span class="comment"> * Author:                  TONYTANG</span></span><br><span class="line"><span class="comment"> * Create Date:             2018/09/15</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">GameProgrammingPattern</span> : <span class="title">MonoBehaviour</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="keyword">region</span> MVVM Part</span></span><br><span class="line">    ******</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span> 第二个ViewModel <span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> MVVMViewModel2 mMVVMViewModel2;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span> 第二个View <span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> MVVMView2 mMVVMView2;</span><br><span class="line">    <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Awake</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        initMonoScripts();</span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="keyword">region</span> MVVM Part</span></span><br><span class="line">        ******</span><br><span class="line"></span><br><span class="line">        mMVVMViewModel2 = <span class="keyword">new</span> MVVMViewModel2();</span><br><span class="line">        mMVVMView2 = <span class="keyword">this</span>.transform.GetComponentInChildren&lt;MVVMView2&gt;();</span><br><span class="line">        <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Start</span> ()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="meta">#<span class="keyword">region</span> MVVM Part</span></span><br><span class="line">        <span class="comment">// 初始化ViewModel里的Model数据</span></span><br><span class="line">        mMVVMViewModel.initializeModel(mMVVMModel);</span><br><span class="line">        <span class="comment">// ViewModel注册消息监听</span></span><br><span class="line">        mMVVMViewModel.registerMessageListener();</span><br><span class="line">        <span class="comment">// 绑定View到VM上</span></span><br><span class="line">        mMVVMView.mMVVMViewModelContext = mMVVMViewModel;</span><br><span class="line">        <span class="comment">// 通过携程动态使用VM修改值Age触发View变化显示</span></span><br><span class="line">        CoroutineManager.Singleton.startCoroutine(changeViewModelAgeCoroutine());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 绑定View2到ViewModel2上</span></span><br><span class="line">        mMVVMView2.mMVVMViewModelContext = mMVVMViewModel2;</span><br><span class="line">        <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>运行点击ViewModel2的按钮可以看到我们成功通过消息订阅和分发达到ViewModel和ViewModel之间交流的目的，成功实现了解耦ViewModel和ViewModel之间的通信:<br><img src="/img/GameProgrammingPattern/MessageDispatcher.png" alt="MessageDispatcher"></p>
<h6 id="优化"><a href="#优化" class="headerlink" title="优化"></a>优化</h6><ol>
<li>自动化生成View和ViewModel属性绑定部分代码<br>待续……</li>
</ol>
<h5 id="MVVM使用思考"><a href="#MVVM使用思考" class="headerlink" title="MVVM使用思考"></a>MVVM使用思考</h5><p>可以看到MVVM相比传统MVC模式，将V和M完全解耦，V和M不需要关心对方，通过ViewModel去实现V和M的桥接，通过双向绑定实现View的数据驱动刷新显示。通过消息分发注册等类似机制实现ViewModel与ViewModel之间的沟通交流，实现低耦合的MVVM框架。<br>View可以绑定不同的ViewModel，快速实现不同数据刷新显示。<br>同时因为V和M完全分离，开发人员可以专注于业务逻辑和数据的开发（ViewModel），设计人员可以专注于页面设计。</p>
<p>MVVM应用范围思考:</p>
<ol>
<li>独立开发，方便测试，MVVM比较适合多人合作项目，设计人员和开发人员可以同时开工，</li>
<li>代码重用性，开发人员之间的代码有很高的重用性(重用V或者重用VM都有可能)，开发人员之间的代码不会互相污染。</li>
<li>适用于数据驱动的不复杂的游戏UI部分(数据驱动刷新显示)。</li>
</ol>
<p>待续……</p>
<h4 id="ECS"><a href="#ECS" class="headerlink" title="ECS"></a>ECS</h4><p>待续……</p>
<h1 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h1><h2 id="网站"><a href="#网站" class="headerlink" title="网站"></a>网站</h2><p><a target="_blank" rel="noopener" href="http://www.cnblogs.com/keitsi/p/5764785.html">谈谈对MVC、MVP和MVVM的理解</a><br><a target="_blank" rel="noopener" href="https://draveness.me/mvx">谈 MVC、MVP 和 MVVM 架构模式</a><br><a target="_blank" rel="noopener" href="https://juejin.im/entry/590ae83b5c497d005855988d">Unity 应用架构设计—— MVVM 模式的设计和实施 (Part 1)</a><br><a target="_blank" rel="noopener" href="https://juejin.im/post/5b041882f265da0b9348a4de">mvc的实现</a><br><a target="_blank" rel="noopener" href="https://www.zhihu.com/question/23946609">如何在Unity中实现MVC模式？</a><br><a target="_blank" rel="noopener" href="https://blog.codingnow.com/2017/02/tracedoc.html">跟踪数据结构的变更</a><br><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/8e3d4ab80714">MVC、MVP、MVVM架构分析与比较</a></p>
<h2 id="书籍"><a href="#书籍" class="headerlink" title="书籍"></a>书籍</h2><p>《Game-Programming-Patterns》 – Robert.Nystrom<br>《Design Pattern》 – GoF(四人帮)</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2018/05/29/2D%E5%83%8F%E7%B4%A0%E7%94%BB/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2018/05/29/2D%E5%83%8F%E7%B4%A0%E7%94%BB/" class="post-title-link" itemprop="url">2D像素画</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2018-05-29 08:59:01" itemprop="dateCreated datePublished" datetime="2018-05-29T08:59:01+08:00">2018-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-07-31 15:33:30" itemprop="dateModified" datetime="2022-07-31T15:33:30+08:00">2022-07-31</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Art/" itemprop="url" rel="index"><span itemprop="name">Art</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>本篇文章是为了记录学习2D像素画方面的技巧以及知识而写，希望有一天能做自己的2D像素独立游戏。</p>
<h2 id="电子游戏史"><a href="#电子游戏史" class="headerlink" title="电子游戏史"></a>电子游戏史</h2><p>在学习了解像素画之前，先了解下电子游戏史，有助于学习了解像素画游戏的由来，同时也可以加深对游戏发展史的了解。</p>
<p><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E9%9B%BB%E5%AD%90%E9%81%8A%E6%88%B2%E5%8F%B2">电子游戏在1970年代开始以商业娱乐媒体的姿态出现，成为1970年代末日本、美国和欧洲一个重要娱乐工业的基础。</a></p>
<h3 id="街机时代"><a href="#街机时代" class="headerlink" title="街机时代"></a>街机时代</h3><p>关键词： 街机 &amp; 70年代初发展 &amp; 70年代末至90年代中期盛行<br><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E8%A1%97%E6%9C%BA">在街机上运行的游戏为街机游戏。街机游戏发端于70年代初而盛行于70年代末至90年代中期。90年代后期，虽然SNK的拳皇和合金弹头依然颇受欢迎，但整个产业已经开始衰退。进入21世纪后，街机迅速衰弱，日益远离大众的视线。</a><br>小时候90年代，街机很流行，从小就混迹街机室，不得不说有很深的感情。<br>这里放几张图留念：<br><img src="/img/GameArt/ArcadeGame.png" alt="ArcadeGame"><br>小时候比较喜欢的几款街机游戏，拳皇97，三国战纪，恐龙快打，合金弹头等。<br><img src="/img/GameArt/KingOfFighters.png" alt="KingOfFighters"><br><img src="/img/GameArt/SanGuoZhanJi.png" alt="SanGuoZhanJi"><br><img src="/img/GameArt/KongLongKuaiDa.png" alt="KongLongKuaiDa"><br><img src="/img/GameArt/MetalSlug.png" alt="MetalSlug"></p>
<h3 id="掌机时代"><a href="#掌机时代" class="headerlink" title="掌机时代"></a>掌机时代</h3><p>关键词: 掌机 &amp; 任天堂 &amp; 索尼 &amp; 70年代初发展 &amp; 80年代以后开始盛行<br>虽然掌机游戏发展史70年代初，但掌机游戏真正发光是任天堂的掌机系列。<br>任天堂掌机系列:</p>
<ol>
<li>GB(Game Body) – 第一代<br><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Game_Boy">Game Boy（日语：ゲームボーイ，简称GB）是任天堂公司在1989年发售的第一代便携式掌上游戏机。</a><br>这里截取一段GB主机的技术参数信息:<br><img src="/img/GameArt/GameBoyParameters.png" alt="GameBoyParameters"><br>不得不说以前掌机的内存，容量等都相当苛刻，8 KByte RAM放到今天真的是难以想象。<br>掌机小时候玩的并不算多，印象中还是用下面的掌机玩俄罗斯方块之类的:<br><img src="/img/GameArt/GameBoyTetris.png" alt="GameBoyTetris"></li>
<li>GBA(Game Boy Advance) – 第二代<br><a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E6%8E%8C%E4%B8%8A%E6%B8%B8%E6%88%8F%E6%9C%BA/9794830?fromtitle=%E6%8E%8C%E6%9C%BA&fromid=2088143">2001年初，任天堂发布了Game Boy后续机型Game Boy Advance（GBA）。</a></li>
<li>NDS(Nintendo Dual screen) – 第三代<br><a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E6%8E%8C%E4%B8%8A%E6%B8%B8%E6%88%8F%E6%9C%BA/9794830?fromtitle=%E6%8E%8C%E6%9C%BA&fromid=2088143">2004年11月，任天堂DS系列掌机产品上市。NDS采用了上下两块的3英寸屏幕，其下屏幕的触控设计一举颠覆了过往游戏掌机的操控概念。</a><br>可以看出NDS在显示操作上针对GBA做出了很大改变:<br><img src="/img/GameArt/NintendoDualScreen.png" alt="NintendoDualScreen"></li>
<li><a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E6%8E%8C%E4%B8%8A%E6%B8%B8%E6%88%8F%E6%9C%BA/9794830?fromtitle=%E6%8E%8C%E6%9C%BA&fromid=2088143">NDSL</a></li>
<li><a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E6%8E%8C%E4%B8%8A%E6%B8%B8%E6%88%8F%E6%9C%BA/9794830?fromtitle=%E6%8E%8C%E6%9C%BA&fromid=2088143">NDSi</a></li>
<li><a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E6%8E%8C%E4%B8%8A%E6%B8%B8%E6%88%8F%E6%9C%BA/9794830?fromtitle=%E6%8E%8C%E6%9C%BA&fromid=2088143">NDSiLL</a></li>
<li>3DS<br><a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E6%8E%8C%E4%B8%8A%E6%B8%B8%E6%88%8F%E6%9C%BA/9794830?fromtitle=%E6%8E%8C%E6%9C%BA&fromid=2088143">任天堂于2011年2月26日发布的次世代掌机</a><br>这里再看看3DS的部分技术参数信息：<br><img src="/img/GameArt/3DS.png" alt="3DS"><br>可以看出从Game Boy到3DS，经历了20年的发展，内存和容量都得到了大大的提高。</li>
<li><a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E6%8E%8C%E4%B8%8A%E6%B8%B8%E6%88%8F%E6%9C%BA/9794830?fromtitle=%E6%8E%8C%E6%9C%BA&fromid=2088143">3DSLL</a></li>
<li>Switch<br><a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E6%8E%8C%E4%B8%8A%E6%B8%B8%E6%88%8F%E6%9C%BA/9794830?fromtitle=%E6%8E%8C%E6%9C%BA&fromid=2088143">Nintendo Switch近日首度亮相，集电视游戏主机与掌上游戏机“双机一体”</a><br>Switch不同于普通的掌机，还结合了游戏主机的功能。但当初了解到Switch令我眼前一亮的是他的游戏设计创意上(瓦楞纸游戏):<br>通过纸盒做出游戏所需的零部件，在这些纸板上会有一些反光部件，IR 摄像头就是通过计算这些反光，来触发相应的功能，从而实现游戏性。<br>这里就放一个链接，个人可以去感受下，创意真的很好:<br><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/av18433605/">Switch瓦楞纸游戏视频</a></li>
</ol>
<p>索尼掌机系列；</p>
<ol>
<li>PSP(PlayStation Portable)<br><a target="_blank" rel="noopener" href="https://baike.baidu.com/item/PSP/85995">2003年5月13日，SCE在E3大展5月11日的例行新闻发布会上首次披露了携带游戏主机PSP，社长久多良木健将之称许为“21世纪 的WALKMAN” </a></li>
<li><a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E6%8E%8C%E4%B8%8A%E6%B8%B8%E6%88%8F%E6%9C%BA/9794830?fromtitle=%E6%8E%8C%E6%9C%BA&fromid=2088143">PSP2</a></li>
<li><a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E6%8E%8C%E4%B8%8A%E6%B8%B8%E6%88%8F%E6%9C%BA/9794830?fromtitle=%E6%8E%8C%E6%9C%BA&fromid=2088143">PSP3</a></li>
<li><a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E6%8E%8C%E4%B8%8A%E6%B8%B8%E6%88%8F%E6%9C%BA/9794830?fromtitle=%E6%8E%8C%E6%9C%BA&fromid=2088143">PSV(Play Station Vita)</a></li>
<li><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/PlayStation_4">PS4</a></li>
</ol>
<h3 id="家用机时代"><a href="#家用机时代" class="headerlink" title="家用机时代"></a>家用机时代</h3><p>关键词： 家用机 &amp; 任天堂 &amp; </p>
<ol>
<li>FC(Family Computer) – 第一代<br>大家熟悉的红白机指的就是这个，小时候在家玩的插卡的魂斗罗，超级玛丽就是在FC上玩的。<br><img src="/img/GameArt/FamilyComputer.png" alt="FamilyComputer"><br>小时候家里有卖这个，直接拿回家里就可以玩了，真的是童年里很快乐的时光。<br>很多红白机经典游戏，现在都记忆犹新:<br><img src="/img/GameArt/PixelArtGameSuperMario.png" alt="超级玛丽"><br><img src="/img/GameArt/MaXiTuan.png" alt="马戏团"><br><img src="/img/GameArt/HunDouLuo.png" alt="魂斗罗"></li>
<li>SFC – 第二代<br><a target="_blank" rel="noopener" href="https://baike.baidu.com/item/SFC/99631">SFC是「FAMICOM」后任天堂推出的第2代家用机。 [1]  采用全新16位元架构，搭配强化的图形与音效处理功能，成功延续FC的霸业。SFC手柄最大的改进之处在于第一次加入了肩部按键L&#x2F;R，并形成了ABXY四个按键的手柄布局、和satellaview。</a></li>
<li>N64(Nintendo 64) – 第三代<br><a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E4%BB%BB%E5%A4%A9%E5%A0%8264/2619380?fromtitle=N64&fromid=2387227">N64手柄堪称游戏史上最重要的输入设备，它有3个堪称划时代的设计：类比摇杆，扳机按键，震动包。 N64上诞生了塞尔达传说：时之笛和超级马里奥64等超级大作。N64下一代产品为任天堂NGC。</a><br>塞尔达传说和超级玛丽相比也不逊色游戏大作，这里本人并没有玩过，但可以看下简单的游戏版本信息截图来感受下：<br><img src="/img/GameArt/TheLegendOfZelda.png" alt="TheLegendOfZelda"></li>
<li>NGC(Nintento GameCube) – 第四代<br><a target="_blank" rel="noopener" href="https://baike.baidu.com/item/NGC/7005912">2001年9月4日，NGC在日本本土发售。</a></li>
<li>Wii – 第五代<br><a target="_blank" rel="noopener" href="https://baike.baidu.com/item/Wii">Wii是任天堂公司2006年11月19日推出的家用游戏机。是NGC的后续机种。Wii第一次将体感引入了电视游戏主机。</a><br><img src="/img/GameArt/Wii.png" alt="Wii"></li>
<li>WiiU<br><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Wii_U">Wii U是任天堂继Wii之后所推出的家用游戏主机，是Wii的后继机种。于2011年6月7日首次公布</a></li>
</ol>
<h3 id="电脑时代"><a href="#电脑时代" class="headerlink" title="电脑时代"></a>电脑时代</h3><p>关键词： 60年代初诞生 &amp; 斯蒂夫.拉塞尔 &amp; 80,90年代开始盛行 &amp; 21世纪鼎盛时期<br><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E7%94%B5%E8%84%91%E6%B8%B8%E6%88%8F">电脑游戏（英语：PC games，或称computer games，全写personal computer games）是一个相对于主机游戏和街机游戏的概念，指在个人电脑上运行的游戏软件，是一种本身提供娱乐功能的电脑软件。<br>电脑游戏的出现与1960年代电子计算机出现在美国大学校园有密切的联系。当年的环境培养出了一群编程的高手。在1962年，一位叫斯蒂夫·拉塞尔的大学生在美国DEC公司生产的PDP-1型电子计算机上编制的电脑游戏就是在当时很有名的《宇宙战争》（Space War）。游戏业界人士一般认为，斯蒂夫·拉塞尔就是发明电脑游戏的人</a><br>小时候90年代初，电脑游戏已经开始盛行，只是当时处于硬件和技术等限制，还没有那么多3A大作游戏。小时候当初影响最深要数传奇，暗黑2，星际争霸和半条命了。<br>传奇算是当初非常火的MMORPG(大型多人在线角色扮演类游戏):<br><img src="/img/GameArt/Legend.png" alt="传奇"><br>当时还在读小学，玩传奇玩的不亦乐乎，对于这种大型多人在线游戏以及打怪升级，杀人爆装备的设定，感觉很有意思。当时玩的最多的是法师，最喜欢去招宝宝(暗黑神殿的巨型多角虫)带去练级刷怪了。<br>暗黑2(暴雪出品)算是Isometric Projection(等角投影)用2D模拟3D显示典型的游戏:<br><img src="/img/GameArt/Diablo2.png" alt="暗黑2"><br>暗黑2利用Isometric Projectection使用2D来制作2.5D的游戏，看起来特别舒服，同时里面的装备系统，难度模式，剧情以及各种职业特点都很有特点，让人即使是网吧局域网都玩的不亦乐乎。<br>星际争霸(暴雪出品)算是典型的RTS(Real Time Strategy即时战略类)游戏:<br><img src="/img/GameArt/StarCraft1.png" alt="StarCraft1"><br>半条命(Valve公司出品)算是典型的FPS(First Person Shooting第一人称射击)游戏:<br><img src="/img/GameArt/CS.png" alt="半条命"></p>
<p>电脑游戏虽然受到手机游戏的冲击，但目前看来电脑游戏依然还是主流。(2018&#x2F;06&#x2F;02)</p>
<h3 id="手机时代"><a href="#手机时代" class="headerlink" title="手机时代"></a>手机时代</h3><p>关键词： 21世纪 &amp; 智能机普及<br>21世纪，伴随着智能机的普及，手机已经是人们生活中必不可少的工具了。为移动端游戏的开发和繁荣奠定了基础。<br>这里就说太多了，这里主要想提下，移动游戏里自己最喜欢的游戏COC(部落冲突)，由芬兰Supercell公司开发(后来被腾讯斥资86亿美元收购了)。这一款游戏让我被移动游戏开发深深吸引，原来移动游戏可以做到如此的好玩，也激发了我做独立移动游戏的思想。<br>这里不厌其烦的再次放张自己玩COC以前的截图作为纪念:<br><img src="/img/Unity/MyCOC.PNG" alt="My COC"></p>
<p>虽然现在(2018&#x2F;06&#x2F;02)移动游戏已经不再像几年前，百花齐放，已经趋于稳定，基本剩下的都是大厂或者有实力的公司。但独立游戏的梦想让我并不想放弃做移动游戏，因此走上了Unity的移动游戏开发之路。</p>
<h2 id="像素画"><a href="#像素画" class="headerlink" title="像素画"></a>像素画</h2><p>还是按What，Why，How的顺序来学习理解像素画。<br>什么是像素画？(What)<br><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%83%8F%E7%B4%A0%E7%94%BB">像素画是一种以“像素”（Pixel）为基本单位来制作的电脑绘图表现形式。</a></p>
<p>这里让我们了解两个概念，<strong>位图</strong>和<strong>向量图</strong>。<br><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E4%BD%8D%E5%9B%BE">位图（Bitmap），又称栅格图（英语：Raster graphics）或点阵图，是使用像素阵列(Pixel-array&#x2F;Dot-matrix点阵)来表示的图像。</a></p>
<p><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E7%9F%A2%E9%87%8F%E5%9B%BE%E5%BD%A2">矢量图形是计算机图形学中用点、直线或者多边形等基于数学方程的几何图元表示图像。矢量图形与使用像素表示图像的位图不同。</a></p>
<p>我个人简单的理解就是位图是存储的原始像素信息，矢量图存的是图形描述信息然后通过计算机栅格化显示出来。两则很重要的一个区别就是前者放大缩小会失真，后者因为是根据图形描述信息动态栅格化计算显示放大缩小出来的不会失真。</p>
<p>为什么会有像素画？(Why)<br><a target="_blank" rel="noopener" href="https://indienova.com/indie-game-development/pixel-art-academy-1/">像素风格起源于电子游戏，是硬件和显示器技术不发达的时期用来表现画面的一种解决方案。后来随着技术的发展，延伸出越来越多的变种，界限也越来越宽泛。<br>像素风格伴随50年代电子游戏出现而诞生，到了家用机大行其道的FC（Family Computer）时代，更是诞生了大量大家熟知的优秀像素风格游戏作品。<br>正由于这个原因，像素风格往往让人联想到游戏的起源，并且常常被视为游戏文化和复古潮流的象征之一。</a></p>
<p>题外话：<br>个人在做独立游戏的时，美术是个很大的问题，同时游戏开发出来后要想跟大厂的游戏去比画质比游戏性基本是不太可能的，而像素画是一个门槛相对低，对于像素风格复古风格的游戏始终有着自己的一小部分受众，所以像素画是独立游戏的一个不错选择。以前在独立游戏大电影里，了解到了独立游戏FEZ(像素风)一个人花费了大量的时间完成且取得了很大成功的游戏，既有感动，又感受到独立游戏开发之路辛酸。</p>
<p>这里贴一张图以示敬意：<br><img src="/img/GameArt/PixelArtGameFEZ.png" alt="PixelArtGameFEZ"></p>
<p>如何学好像素画？(How)<br>这是一个比较大的问题，这里暂时只提及个人认为从入门到精通需要经历的步骤：</p>
<ol>
<li>找到讲解介绍像素画的网站(找到入门点)</li>
<li>明确自己想学习的方向(想做什么样的像素画，需要学习那些知识)</li>
<li>欲善其事，必先利其器(找到合适的工具)</li>
<li>花费时间去学习了解像素画里的知识和技巧(熟能生巧)</li>
<li>实战运用</li>
</ol>
<h2 id="像素画知识"><a href="#像素画知识" class="headerlink" title="像素画知识"></a>像素画知识</h2><h3 id="像素画分类"><a href="#像素画分类" class="headerlink" title="像素画分类"></a>像素画分类</h3><p>下面的像素画分类信息来源:<br><a target="_blank" rel="noopener" href="https://indienova.com/indie-game-development/learn-pixel-drawing-by-myself-02/">二维平面像素介绍</a></p>
<ol>
<li>黑白画风<br><img src="/img/GameArt/BlackAndWhitePixelArt.png" alt="BlackAndWhitePixelArt"></li>
<li>复古画风<br><img src="/img/GameArt/FuGuPixelArt.png" alt="FuGuPixelArt"></li>
<li>等距视角画风<br><img src="/img/GameArt/IsometricProjectionPixelArt.png" alt="IsometricProjectionPixelArt"></li>
<li>极简画风<br><img src="/img/GameArt/ExtramSimplePixelArt.png" alt="ExtramSimplePixelArt"></li>
<li>计繁画风<br><img src="/img/GameArt/ComplicatedPixelArt.png" alt="ComplicatedPixelArt"></li>
<li>写实画风<br><img src="/img/GameArt/RealisticPixelArt.png" alt="RealisticPixelArt"></li>
<li>Q萌画风<br><img src="/img/GameArt/QStylePixelArt.png" alt="QStylePixelArt"></li>
<li>油画式画风<br><img src="/img/GameArt/YouHuaStylePixelArt.png" alt="YouHuaStylePixelArt"></li>
<li>光影渲染画风<br><img src="/img/GameArt/LightShadowStylePixelArt.png" alt="LightShadowStylePixelArt"><br>从上面别人的总结讲解来看，考虑到个人美术功底比较差，<strong>复古画风</strong>是一个入门学习的不错选择。</li>
</ol>
<h2 id="像素画技巧"><a href="#像素画技巧" class="headerlink" title="像素画技巧"></a>像素画技巧</h2><h3 id="绘制方法"><a href="#绘制方法" class="headerlink" title="绘制方法"></a>绘制方法</h3><p>下面的绘制方法信息来源:<br><a target="_blank" rel="noopener" href="https://indienova.com/indie-game-development/learn-pixel-drawing-by-myself-02/">二维平面像素介绍</a></p>
<ol>
<li>绘制线稿法<br><img src="/img/GameArt/HuiZhiXianGaoFaPixelArt.png" alt="HuiZhiXianGaoFaPixelArt"></li>
<li>色块构图法<br><img src="/img/GameArt/SeKuaiGouTuFaPixelArt.png" alt="SeKuaiGouTuFaPixelArt"></li>
<li>缩图修改法<br><img src="/img/GameArt/SuoTuXiuGaiFaPixelArt.png" alt="SuoTuXiuGaiFaPixelArt"><br>从上面别人的总结分享来看，初学入门选择<strong>绘制线稿法</strong>来练习像素画比较全面的学习像素画的各方面技巧。</li>
</ol>
<h2 id="像素画工具"><a href="#像素画工具" class="headerlink" title="像素画工具"></a>像素画工具</h2><p>欲善其事，必先利其器。<br>PC端：</p>
<ol>
<li>PhotoShop<br>相对来说属于功能很强大，但不适合非专业美术人员用于学习像素画，对于像素画比如Animation，Tile等方面支持都并不友好。</li>
<li><a target="_blank" rel="noopener" href="https://www.aseprite.org/docs/">Aseprite</a>(Open Source这一点比较吃惊，付费版$14.99，免费版需要自己编译)<br><a target="_blank" rel="noopener" href="https://github.com/aseprite/aseprite/">Aseprite Github Link</a></li>
<li><a target="_blank" rel="noopener" href="https://pyxeledit.com/about.php">Pyxel Edit</a>(付费 $9.00)<br>参考了网上的观点和对应官方网站的教学视频。个人觉得Asesprite能满足我做像素画以及像素动画的需求，同时官方网站做的比较完善，资料相对完整些，最终决定Asesprite作为像素画入门工具。</li>
</ol>
<p>移动端:<br>Android:<br>8bit Painter<br>IOS:<br>8bit Painter</p>
<p>Note:<br>因为是移动端版本，只适合画一些简单的像素画(工具丰富层度和操作形式限制了)，专业的还是需要在PC端操作(Aseprite软件)。</p>
<h3 id="Aseprite学习"><a href="#Aseprite学习" class="headerlink" title="Aseprite学习"></a>Aseprite学习</h3><p>本人直接购买的付费版，先来张软件截图：<br><img src="/img/GameArt/Aseprite.png" alt="Aseprite"></p>
<h4 id="快捷键"><a href="#快捷键" class="headerlink" title="快捷键"></a>快捷键</h4><p>通过Edit -&gt; Keyboard Shotcuts修改自定义快捷键<br>Tab – Layer &amp; Frame面板快捷键</p>
<p>可以设置前景色和背景色，左键是前景色，右键是背景色<br>View -&gt; Symetriy Options可以自动对称绘制</p>
<h4 id="工具"><a href="#工具" class="headerlink" title="工具"></a>工具</h4><p>这里的工具很多跟PS里很像，这里就不一一讲解了。详细参考教程学习：<a target="_blank" rel="noopener" href="https://www.aseprite.org/docs/tutorial/">Aseprite Tutorial</a></p>
<h4 id="Tips"><a href="#Tips" class="headerlink" title="Tips"></a>Tips</h4><p>What is the best size to draw pixel art?<br>根据需要绘制的像素画各部位表现所需的大小来决定最终的画布大小。</p>
<p>Common mistakes in Pixel Art:</p>
<ol>
<li>Doubles<br> <img src="/img/GameArt/DoublesInPixelArt.png" alt="DoublesInPixelArt"><br> 纠正方法：<ul>
<li>启用Pixel-Perfect or 手动Pixel-Perfect<br> <img src="/img/GameArt/PixelPerfectPixelArt.png" alt="PixelPerfectPixelArt"></li>
<li>2px</li>
<li>AA<br> <img src="/img/GameArt/DoublesSolutions.png" alt="DoublesSolutions"></li>
</ul>
</li>
<li>Jaggies(锯齿)<br> <img src="/img/GameArt/JaggiesLine.png" alt="JaggiesLine"><br> 纠正方法:<ul>
<li>连续的图像像素连续数量增加减少要有规律(比如:43211234)</li>
<li>连续的图像像素连续数量有限取小数量的(比如:43211235)<br> <img src="/img/GameArt/NotJaggiesLine.png" alt="NotJaggiesLine"></li>
</ul>
</li>
<li>Outline<br> 确认哪些部分是需要突出的，哪些是不需要突出的。<br> 突出部分可以多加一点像素outline来凸显，不需要突出的部分紧贴着outline即可。</li>
</ol>
<h2 id="像素画实战学习"><a href="#像素画实战学习" class="headerlink" title="像素画实战学习"></a>像素画实战学习</h2><p>前面的一部分学习是参考一下学习网站:<br><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=Md6W79jtLJM&feature=youtu.be">Mort的系列视频</a></p>
<p>接下来主要根据下面这个网站，一步一步的学习绘制像素画:<br><a target="_blank" rel="noopener" href="https://32comic.com/tag/%E5%85%A5%E9%97%A8/">教你画像素画</a></p>
<p>像素素材网站:<br><a target="_blank" rel="noopener" href="https://indienova.com/resource/tag/pixel-art">像素艺术</a><br><a target="_blank" rel="noopener" href="http://pixeljoint.com/">pixeljoint</a></p>
<p>工具:<br>Asperite</p>
<h3 id="自定义快捷键"><a href="#自定义快捷键" class="headerlink" title="自定义快捷键"></a>自定义快捷键</h3><p>画像素画，快捷键很重要，因为我们需要不断在各种画笔，橡皮檫，取色工具等之间不断的切换。</p>
<p>Edit -&gt; Keyboard Shortcuts自定义快捷键<br>以下几个是比较常见的，为了方便我把默认的Ctrl + Alt形式改成了Shift + Alt的形式。</p>
<ul>
<li>Shift + Alt + B – 画笔</li>
<li>Shift + Alt + E – 橡皮檫</li>
<li>Shift + Alt + C(默认是I，按键隔太远了我改成了C) – 吸取颜色</li>
<li>Shift + Alt + G – 填充整色</li>
<li>Shift + Alt + M – 矩形选中区</li>
<li>Shift + Alt + U – 矩形框选区</li>
<li>Shift + Alt + Z – Undo</li>
<li>Shift + Alt + Y – Redo</li>
<li>Space + 左键 – 移动画布</li>
<li>滚动鼠标 – 放大缩小<br>更多的快捷键根据自己的需求修改，这里就不一一列出了</li>
</ul>
<h3 id="AA-Anti-Aliasing"><a href="#AA-Anti-Aliasing" class="headerlink" title="AA(Anti-Aliasing)"></a>AA(Anti-Aliasing)</h3><p>AA(Anti-Aliasing)即抗锯齿。<br>前面简单的提过如何去通过手动添加绘制完成AA，但为什么像素画需要AA了？<br><a target="_blank" rel="noopener" href="https://32comic.com/2018/05/14/hgt%E5%83%8F%E7%B4%A0%E7%94%BB%E6%95%99%E7%A8%8B%EF%BC%9A%E5%83%8F%E7%B4%A0%E7%94%BB%E6%8A%80%E6%B3%95%E5%9F%BA%E7%A1%80/">像素画不支持半透明，因此抗锯齿的工作只能有画家手工完成。</a></p>
<p>下面通过对比大写的字母A，一个没有AA一个有AA来对比看下效果:<br><img src="/img/GameArt/AAUsing.png" alt="AAUsing"><br>可以看到没有添加AA的因为没有半透明的过度，边缘斜线过度区域很明显很生硬，添加AA后边的柔和不再那么生硬。</p>
<p>AA不仅在于手工的添加上，好的AA颜色选择也是关键所在。<br>AA颜色的选择记住下面几条准则：</p>
<ol>
<li>确定添加AA的地方两侧的颜色信息</li>
<li>中间色选取两侧颜色信息中间的部分<br><img src="/img/GameArt/AAColorChoosen.png" alt="AAColorChoosen"></li>
</ol>
<p>Note:</p>
<ol>
<li>中间色不能过多，太多的话像素画会模糊。</li>
<li>在AA手工抗锯齿的时候，应当尽量避免平行像素(这里的平行像素是指AA自身像素平行)。平行像素会强化锯齿感，缺乏视觉美感。</li>
</ol>
<h3 id="实战绘画步骤"><a href="#实战绘画步骤" class="headerlink" title="实战绘画步骤"></a>实战绘画步骤</h3><ol>
<li>想好要画什么(最好能找到图片模板对照着)</li>
<li>决定像素画画布大小(初期学习绘制最好控制在32X32大小以内)</li>
<li>选择好颜色(考虑好冷色暖色颜色选择以及中间过度的AA颜色)，设置好调色板(palette)</li>
<li>利用基础线条勾勒出基本轮廓(像素画像素是有限的，讲求的是神似而非写实，所以只要勾勒出基本轮廓即可，<strong>化繁为简</strong>)</li>
<li>填充颜色</li>
<li>AA绘制</li>
<li>勾勒高亮和暗部区域</li>
</ol>
<h4 id="实战画动物"><a href="#实战画动物" class="headerlink" title="实战画动物"></a>实战画动物</h4><p>结合上面几个步骤，接下来实战绘制一次：</p>
<ol>
<li>想好要画什么<br>这一步，考虑到初期学习，这里决定画参考文章尝试绘制动物<br><a target="_blank" rel="noopener" href="https://32comic.com/2018/08/17/%E5%83%8F%E7%B4%A0%E7%94%BB%E5%88%9D%E7%BA%A7%E6%95%99%E7%A8%8B%EF%BC%9A%E9%B8%A1%E7%9A%84%E7%94%BB%E6%B3%95/">像素画初级教程：鸡的画法</a><br>原图:<br><img src="/img/GameArt/Chicken.png" alt="Chicken"></li>
<li>决定好像素画布大小<br>这里考虑初学像素画，决定按32X32的大小来绘制</li>
<li>决定好颜色选择<br>这一步因为有原图，直接吸取原图几个主要颜色作为调色板颜色即可，然后把AA中间色等准备好即可:<br><img src="/img/GameArt/ChikenPalette.png" alt="ChikenPalette"></li>
<li>勾勒基础轮廓<br><img src="/img/GameArt/LunKuo.png" alt="LunKuo"></li>
<li>填充基本色<br><img src="/img/GameArt/TiuanChongJiChuSe.png" alt="TiuanChongJiChuSe"></li>
<li>手动AA<br><img src="/img/GameArt/ChickenAfterAA.png" alt="ChickenAfterAA"></li>
<li>勾勒高亮和暗部区域<br><img src="/img/GameArt/ChikenFinish.png" alt="ChikenFinish"></li>
</ol>
<h4 id="调色板设计与管理"><a href="#调色板设计与管理" class="headerlink" title="调色板设计与管理"></a>调色板设计与管理</h4><p>参考学习文章:<br><a target="_blank" rel="noopener" href="https://32comic.com/2018/07/19/%E5%83%8F%E7%B4%A0%E7%94%BB%E9%AB%98%E7%BA%A7%E6%95%99%E7%A8%8B%EF%BC%9A%E5%83%8F%E7%B4%A0%E7%94%BB%E8%B0%83%E8%89%B2%E6%9D%BF%E6%8C%87%E5%8D%97/">像素画高级教程：像素画调色板指南</a><br><a target="_blank" rel="noopener" href="https://32comic.com/2018/09/13/%E5%83%8F%E7%B4%A0%E7%94%BB%E9%AB%98%E7%BA%A7%E6%95%99%E7%A8%8B%EF%BC%9A%E5%83%8F%E7%B4%A0%E7%94%BB%E8%B0%83%E8%89%B2%E6%9D%BF%E8%AE%BE%E8%AE%A1%E5%92%8C%E7%AE%A1%E7%90%86/">像素画高级教程：像素画调色板设计和管理</a><br><a target="_blank" rel="noopener" href="https://32comic.com/2017/09/27/%E5%83%8F%E7%B4%A0%E7%94%BB%E9%A2%9C%E8%89%B2%E5%9F%BA%E7%A1%80%E5%9F%BA%E6%9C%AC%E9%85%8D%E8%89%B2%E6%96%B9%E6%B3%95%E4%BB%8B%E7%BB%8D/">像素画颜色基础基本配色方法介绍</a></p>
<p>初学像素画，要想画出的效果好看，除了画的好，好的颜色选择也很关键。<br>这一节主要学习像素画调色板的准备和颜色相关知识，为画好的像素画打好基础。</p>
<h5 id="色相-饱和度-亮度-HSB"><a href="#色相-饱和度-亮度-HSB" class="headerlink" title="色相 &amp; 饱和度 &amp; 亮度(HSB)"></a>色相 &amp; 饱和度 &amp; 亮度(HSB)</h5><p>平时我接触关于颜色的概念，更多是RGB三原色的概念(R - 红色 G - 绿色 B - 蓝色)。<br>接下来让我们学习理解下HSB颜色模式：<br>H(Hue)色相 – 实际颜色(0 - 360)<br>S(Saturation)饱和度 - 颜色的强度或纯度(0 - 100%)<br>B(Brightness)亮度 - 混合颜色的黑色或白色的量(0 - 100%)</p>
<p>这里HSB和之前的RGB是完全不一样的概念，颜色的组成不在是三个颜色的混合结果，而是通过定义色相，饱和度，亮度来决定最终的颜色。</p>
<p>色相可以理解成我们选择的基准颜色，这个基准颜色可以是RGB任何一种组合结果，比如我们选取纯红(RGB - 255,0,0)作为基准色。<br><img src="/img/GameArt/HueBasicColor.png" alt="HueBasicColor"><br>可以看到虽然我们选取了红色作为基准色，但最终的颜色还是纯黑的，这是因为我们设置的B亮度是0导致的。</p>
<p>亮度决定了黑白的颜色量，这里可以理解成白色颜色的占比比重((255,255,255) X 0-1(亮度))，从而影响最终颜色的颜色占比，比如我们设置B亮度50%:<br><img src="/img/GameArt/BasicColorWithHalfBrightness.png" alt="BasicColorWithHalfBrightness"><br>可以看到，我们的色相颜色红色(255,0,0)因为B亮度50%的设置，变成了RBG颜色信息是128,128,128，这真是因为50%的亮度决定了整体颜色的颜色基础值。</p>
<p>看到这里，读者可能会和我有一个相同的疑问，既然亮度决定了颜色值，那么我们设置色相又有什么作用了？<br>H色相是配合S饱和度来起作用的，亮度决定了基调颜色信息，色相和饱和度决定了我们非色相颜色信息的占比。</p>
<p>色相只是决定了我们的基准色，但这个颜色的饱和度是多少了，会决定RGB里我们的非色相颜色的占比。比如此时我们把S饱和度信息设置成50%，我们会看到如下结果:<br><img src="/img/GameArt/BasicColorWithHalfBAndHalfS.png" alt="BasicColorWithHalfBAndHalfS"><br>颜色(128,128,128)因为饱和度50%的设置使得非色相颜色的占比降低了一半，也就是颜色(128,64,64)。</p>
<p>因此我们最终得到的颜色信息是128,64,64。</p>
<p>总结:</p>
<ol>
<li>B亮度决定了基础颜色信息。</li>
<li>H色相决定了主色颜色信息。</li>
<li>S饱和度决定了非主色颜色信息的占比。</li>
<li>三者共同影响颜色的计算得出最终颜色。</li>
</ol>
<p>Note：</p>
<ol>
<li>色相的值范围0-360可以理解成颜色圆盘信息从纯红开始绕360度</li>
<li>饱和度是从外往内递减<br><img src="/img/GameArt/HSBCircle.png" alt="HSBCircle"></li>
<li>亮度第二章图下面的横条<br><img src="/img/GameArt/HSBCircle2.png" alt="HSBCircle2"></li>
</ol>
<h5 id="颜色选择"><a href="#颜色选择" class="headerlink" title="颜色选择"></a>颜色选择</h5><p>颜色有区分冷色和暖色之分：</p>
<ol>
<li>冷色<br>冷色给人冰冷的感觉。<br>蓝绿、蓝青、蓝、蓝紫</li>
<li>暖色<br>暖色给人愉悦和温暖的感觉。<br>红紫、红、橘、黄橘、黄。</li>
<li>中性色<br>紫、绿、黑、白、灰。</li>
</ol>
<p><img src="/img/GameArt/WarmAndColdeColor.png" alt="WarmAndColdeColor"></p>
<p>颜色选择建议：</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://32comic.com/2018/04/25/%E5%88%9D%E7%BA%A7%E5%83%8F%E7%B4%A0%E7%94%BB%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8%E6%95%99%E7%A8%8B/">在一件作品上创建阴影时，最好使用偏冷的颜色。对于最亮的区域，包含更多暖色调显然会更好。</a></li>
<li>选色时要考虑角色个性，场景属性，场景光照颜色等。</li>
<li>新手同一个物品绘制颜色选择不要太多(初期建议控制在10个及以内，最多最好控制在32个以内，颜色越多在颜色选择和管理上花费的时间也就越多)。</li>
<li>选好两个基础色(亮度色和暗部色，然后通过添加两个颜色之间的过渡色完成调色板基础色准备)</li>
<li>过渡色除了亮度和饱和度上的变化，最好还有色相上的变化，相邻颜色过度会比较自然。</li>
<li>颜色饱和度不要过高，高了眼睛看久了会累。</li>
</ol>
<h5 id="自制调色板"><a href="#自制调色板" class="headerlink" title="自制调色板"></a>自制调色板</h5><p>有了前面的颜色概念和选色意见，接下来我们去制作一个用于真正绘制像素画的调色板，实战演练。</p>
<ol>
<li>定两个基准颜色(红色和蓝色)</li>
<li>亮度偏黄色(暖色),暗部偏青色(冷色)</li>
<li>分析光照(假设光照是白色光)</li>
</ol>
<p>开始制作我们的调色板：<br><img src="/img/GameArt/CustomPalette.png" alt="CustomPalette"><br>可以看到主色红色和蓝色有饱和度和明暗度以及色相上的颜色变化。</p>
<h4 id="明暗知识"><a href="#明暗知识" class="headerlink" title="明暗知识"></a>明暗知识</h4><p>参考文章:<br><a target="_blank" rel="noopener" href="https://32comic.com/2017/08/18/%E7%94%BB%E6%98%8E%E6%9A%97%E5%92%8C%E9%85%8D%E8%89%B2tips/">画明暗和配色Tips</a><br><a target="_blank" rel="noopener" href="http://chuansong.me/n/2589343151417">笨办法学像素画：像素画明暗画法指南</a></p>
<p><a target="_blank" rel="noopener" href="https://32comic.com/2017/08/18/%E7%94%BB%E6%98%8E%E6%9A%97%E5%92%8C%E9%85%8D%E8%89%B2tips/">上明暗的时候要兼顾色调变化。最简单的规则就是，亮部的颜色偏暖，暗部的颜色偏冷。</a></p>
<p>文章里明暗画法提到下面3点基础：<br>1、有光源（发出光的东西叫光源）才有明暗，影子位置与光源相反；<br>2、光是一种粒子，会被物体吸收和反射；<br>3、光直射的区域是高光；阴影里面稍亮的区域是反光；</p>
<p>接下来结合文章里绘制立方体来学习绘制明暗。<br>步骤一：<br>准备调色板</p>
<ol>
<li>以土黄色单色为主</li>
<li>明暗上的变化以饱和度和亮度变化为主(单纯绘制明暗，暂时不考虑色相变化)<br><img src="/img/GameArt/MingAnPalette.png" alt="MingAnPalette"></li>
</ol>
<p>步骤二：<br>绘制基础形状外观<br><img src="/img/GameArt/BasicOutline.png" alt="BasicOutline"></p>
<p>步骤三：<br>确定光源位置(假设光源在左侧)，会出暗部和亮部以及影子<br><img src="/img/GameArt/MingAnWhithLight.png" alt="MingAnWhithLight"></p>
<p>步骤四：<br>调整颜色以及细节明暗。<br><img src="/img/GameArt/MingAnFinal.png" alt="MingAnFinal"></p>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><h2 id="Conception-Part"><a href="#Conception-Part" class="headerlink" title="Conception Part"></a>Conception Part</h2><p><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%83%8F%E7%B4%A0%E7%94%BB">像素画</a><br><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E4%BD%8D%E5%9B%BE">位图</a><br><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E7%9F%A2%E9%87%8F%E5%9B%BE%E5%BD%A2">矢量图形</a></p>
<h2 id="Background-knowledge-Part"><a href="#Background-knowledge-Part" class="headerlink" title="Background knowledge Part"></a>Background knowledge Part</h2><p><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E9%9B%BB%E5%AD%90%E9%81%8A%E6%88%B2%E5%8F%B2">电子游戏史</a><br><a target="_blank" rel="noopener" href="https://jobyu.gitbooks.io/rpgmakerpixeltutorials/">RPGMaker官方像素画教程</a><br><a target="_blank" rel="noopener" href="https://indienova.com/indie-game-development/learn-pixel-drawing-by-myself-02/">二维平面像素介绍</a><br><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E8%A1%97%E6%9C%BA">街机</a><br><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Game_Boy">Game Boy</a><br><a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E6%8E%8C%E4%B8%8A%E6%B8%B8%E6%88%8F%E6%9C%BA/9794830?fromtitle=%E6%8E%8C%E6%9C%BA&fromid=2088143">Game Boy Advanced</a><br><a target="_blank" rel="noopener" href="https://baike.baidu.com/item/SFC/99631">SFC</a><br><a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E4%BB%BB%E5%A4%A9%E5%A0%8264/2619380?fromtitle=N64&fromid=2387227">N64</a><br><a target="_blank" rel="noopener" href="https://baike.baidu.com/item/NGC/7005912">NGC</a><br><a target="_blank" rel="noopener" href="https://baike.baidu.com/item/Wii">Wii</a><br><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Wii_U">WiiU</a><br><a target="_blank" rel="noopener" href="https://baike.baidu.com/item/PSP/85995">Play Station Portable</a><br><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/PlayStation_4">PS4</a><br><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E7%94%B5%E8%84%91%E6%B8%B8%E6%88%8F">电脑游戏</a></p>
<h2 id="Pixel-Art-Part"><a href="#Pixel-Art-Part" class="headerlink" title="Pixel Art Part"></a>Pixel Art Part</h2><p><a target="_blank" rel="noopener" href="https://indienova.com/indie-game-development/pixel-art-academy-1/">什么是像素画</a><br><a target="_blank" rel="noopener" href="https://32comic.com/tag/%E5%85%A5%E9%97%A8/">教你画像素画</a><br><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=Md6W79jtLJM&feature=youtu.be">Mort的系列视频</a><br><a target="_blank" rel="noopener" href="https://indienova.com/resource/tag/pixel-art">像素艺术</a><br><a target="_blank" rel="noopener" href="http://pixeljoint.com/">pixeljoint</a></p>
<h2 id="Pixel-Art-Tutorial"><a href="#Pixel-Art-Tutorial" class="headerlink" title="Pixel Art Tutorial"></a>Pixel Art Tutorial</h2><p><a target="_blank" rel="noopener" href="https://32comic.com/2018/07/19/%E5%83%8F%E7%B4%A0%E7%94%BB%E9%AB%98%E7%BA%A7%E6%95%99%E7%A8%8B%EF%BC%9A%E5%83%8F%E7%B4%A0%E7%94%BB%E8%B0%83%E8%89%B2%E6%9D%BF%E6%8C%87%E5%8D%97/">像素画高级教程：像素画调色板指南</a><br><a target="_blank" rel="noopener" href="https://32comic.com/2018/09/13/%E5%83%8F%E7%B4%A0%E7%94%BB%E9%AB%98%E7%BA%A7%E6%95%99%E7%A8%8B%EF%BC%9A%E5%83%8F%E7%B4%A0%E7%94%BB%E8%B0%83%E8%89%B2%E6%9D%BF%E8%AE%BE%E8%AE%A1%E5%92%8C%E7%AE%A1%E7%90%86/">像素画高级教程：像素画调色板设计和管理</a><br><a target="_blank" rel="noopener" href="https://32comic.com/2017/09/27/%E5%83%8F%E7%B4%A0%E7%94%BB%E9%A2%9C%E8%89%B2%E5%9F%BA%E7%A1%80%E5%9F%BA%E6%9C%AC%E9%85%8D%E8%89%B2%E6%96%B9%E6%B3%95%E4%BB%8B%E7%BB%8D/">像素画颜色基础基本配色方法介绍</a><br><a target="_blank" rel="noopener" href="https://32comic.com/2017/08/18/%E7%94%BB%E6%98%8E%E6%9A%97%E5%92%8C%E9%85%8D%E8%89%B2tips/">画明暗和配色Tips</a></p>
<h2 id="Other-Part"><a href="#Other-Part" class="headerlink" title="Other Part"></a>Other Part</h2><p><a href=""></a><br><a href=""></a><br><a href=""></a><br><a href=""></a><br><a href=""></a><br><a href=""></a><br><a href=""></a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2018/04/01/Unity%E5%B0%8F%E7%9F%A5%E8%AF%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2018/04/01/Unity%E5%B0%8F%E7%9F%A5%E8%AF%86/" class="post-title-link" itemprop="url">Unity小知识</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2018-04-01 12:24:38" itemprop="dateCreated datePublished" datetime="2018-04-01T12:24:38+08:00">2018-04-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-07-31 16:01:41" itemprop="dateModified" datetime="2022-07-31T16:01:41+08:00">2022-07-31</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Unity/" itemprop="url" rel="index"><span itemprop="name">Unity</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>本篇文章只是为了记录一些使用学习Unity过程中的一些能够帮助我们自动化快速完成一些重复工作的小技巧。</p>
<h2 id="Script-Template"><a href="#Script-Template" class="headerlink" title="Script Template"></a>Script Template</h2><h3 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h3><p>使用Unity的时候我们难以避免需要创建脚本，平时都是通过Priject -&gt; Right CLick -&gt; Create -&gt; C# Script的形式创建默认的脚本。</p>
<p>默认脚本如下:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">NewBehaviourScript</span> : <span class="title">MonoBehaviour</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Use this for initialization</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Start</span> ()</span> &#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Update is called once per frame</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Update</span> ()</span> &#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>需求决定功能，但默认的脚本模本不足以提供我们想要的结果，比如我们希望自动创建如下的脚本:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             NewBehaviourScript类</span></span><br><span class="line"><span class="comment"> * Author:                  tanghuan</span></span><br><span class="line"><span class="comment"> * Create Date:             2018/04/01</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> NewBehaviourScript类</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">NewBehaviourScript</span> : <span class="title">MonoBehaviour</span> &#123;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样我们就不需要每次都自己去编写自动化描述相关的内容了。</p>
<h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><p>如何实现，先让我们来看看，Unity是如何自动化生成NewBehaviourScript.cs脚本的。</p>
<p>让我们打开%EDITORPATH%&#x2F;Data&#x2F;Resources&#x2F;ScriptTemplates&#x2F;路径一探究竟:<br><img src="/img/Unity/UnityScriptTemplate.PNG" alt="UnityScriptTemplate"></p>
<p>可以看到Unity默认的脚本模板是定义在这个路径下的，让我们打开81-C# Script-NewBehaviourScript.cs.txt看看默认的脚本模板是如何定义的:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> #<span class="title">SCRIPTNAME</span># : <span class="title">MonoBehaviour</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Use this for initialization</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Start</span> ()</span> &#123;</span><br><span class="line">        <span class="meta">#NOTRIM#</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Update is called once per frame</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Update</span> ()</span> &#123;</span><br><span class="line">        <span class="meta">#NOTRIM#</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>关于Unity脚本模板的定义规则，这里没有找到官方的介绍，下面的规则参考了网上的说法:<br><a target="_blank" rel="noopener" href="https://gist.github.com/JoaoBorks/af59720a4baba84f080e2df686cacba2">Custom Unity Script Template</a></p>
<p>但Unity提供的脚本模板Keyword数量有限，所以我们想要创建自己的脚本模本需要分两步走：</p>
<ol>
<li>根据Unity脚本模板规则创建自定义脚本</li>
<li>监听脚本Asset修改保存回调去自动化修改替换自定义Keyword</li>
</ol>
<h3 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h3><ol>
<li>根据Unity脚本模板规则创建自定义脚本，编写自定义脚本模板<br>81-C# Custom Mono Script Template-NewBehaviourScript.cs.txt</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             #SCRIPTNAME#.cs</span></span><br><span class="line"><span class="comment"> * Author:                  #AUTHOR#</span></span><br><span class="line"><span class="comment"> * Create Date:             #CREATEDATE#</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> #SCRIPTNAME#.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> #<span class="title">SCRIPTNAME</span># : <span class="title">MonoBehaviour</span> &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到通过添加Unity脚本模板，右键创建时已经多了一个模板脚本选择。<br><img src="/img/Unity/CustomScriptTemplateUI.png" alt="CustomScriptTemplateUI"></p>
<ol start="2">
<li>监听脚本Asset创建回调去自动化修改替换自定义Keyword<br>ScriptKeywordProcesser.cs</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             脚本模板自定义Keyword处理脚本</span></span><br><span class="line"><span class="comment"> * Author:                  tanghuan</span></span><br><span class="line"><span class="comment"> * Create Date:             2018/04/01</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> System.Security.Principal;</span><br><span class="line"><span class="keyword">using</span> UnityEditor;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 脚本模板自定义Keyword处理脚本</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ScriptKeywordProcesser</span> : <span class="title">UnityEditor.AssetModificationProcessor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 非用户导入的Asset创建回调(e.g. .meta文件)</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;assetpath&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">OnWillCreateAsset</span>(<span class="params"><span class="built_in">string</span> assetpath</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        assetpath = assetpath.Replace(<span class="string">&quot;.meta&quot;</span>, <span class="built_in">string</span>.Empty);</span><br><span class="line">        <span class="built_in">int</span> index = assetpath.LastIndexOf(<span class="string">&quot;.&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(index &lt;= <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//判定是否是cs脚本</span></span><br><span class="line">        <span class="built_in">string</span> filepostfix = assetpath.Substring(index);</span><br><span class="line">        <span class="keyword">if</span>(!filepostfix.Equals(<span class="string">&quot;.cs&quot;</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//判定脚本文件是否存在</span></span><br><span class="line">        index = Application.dataPath.LastIndexOf(<span class="string">&quot;Assets&quot;</span>);</span><br><span class="line">        assetpath = Application.dataPath.Substring(<span class="number">0</span>, index) + assetpath;</span><br><span class="line">        <span class="keyword">if</span>(!File.Exists(assetpath))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> filecontent = File.ReadAllText(assetpath);</span><br><span class="line">        filecontent = replaceKeywords(filecontent);</span><br><span class="line">        File.WriteAllText(assetpath, filecontent);</span><br><span class="line">        AssetDatabase.Refresh();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 替换文本Keyword</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Note:</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 自定义Keyword替换规则写在这里</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;filecontent&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">string</span> <span class="title">replaceKeywords</span>(<span class="params"><span class="built_in">string</span> filecontent</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">string</span> author = WindowsIdentity.GetCurrent().Name;</span><br><span class="line">        <span class="comment">// 只取最终用户名</span></span><br><span class="line">        <span class="keyword">var</span> splashindex = author.IndexOf(<span class="string">&quot;\\&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(splashindex &gt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            author = author.Substring(<span class="number">0</span>, splashindex);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        filecontent = filecontent.Replace(<span class="string">&quot;#AUTHOR#&quot;</span>, author);</span><br><span class="line">        filecontent = filecontent.Replace(<span class="string">&quot;#CREATEDATE#&quot;</span>, DateTime.Now.ToString(<span class="string">&quot;yyyy//MM/dd&quot;</span>));</span><br><span class="line">        <span class="keyword">return</span> filecontent;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最终自动化创建一份MyCustomMonoScript.cs:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             MyCustomMonoScript.cs</span></span><br><span class="line"><span class="comment"> * Author:                  TONYTANG</span></span><br><span class="line"><span class="comment"> * Create Date:             2018/04/01</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> MyCustomMonoScript.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MyCustomMonoScript</span> : <span class="title">MonoBehaviour</span> &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>至此我们成功创建并支持了自定义关键词的自动化脚本创建，以后再也不用每次都去编写这些固定的文件头了。</p>
<h2 id="Asset-Import-Cache-资源导入缓存"><a href="#Asset-Import-Cache-资源导入缓存" class="headerlink" title="Asset Import Cache(资源导入缓存)"></a>Asset Import Cache(资源导入缓存)</h2><p>在Unity里，我们每次导入或者修改资源都会资源被重新导入。在大的项目里，当大量的资源被其他人修改或者切换平台的时候会导致资源导入的时间很长，这一点是不能接受的。</p>
<p>Unity官方出的Cache Server正式为了减少资源导入，充分利用缓存以及共享导入资源的方式减少导入资源的时间。</p>
<p>先让我们看看，什么是Cache Server。</p>
<h3 id="Cache-Server"><a href="#Cache-Server" class="headerlink" title="Cache Server"></a>Cache Server</h3><p>接下来还是按照What,Why,How的方式循序渐进了解学习Cache Server.</p>
<h4 id="What"><a href="#What" class="headerlink" title="What"></a>What</h4><p>What is Cache Server?(什么是Cache Server?)<br><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/CacheServer.html">When you enable the Cache Server (see How to set up a Cache Server as a user, below), you can even share Asset imports across multiple projects (that is, the work of importing is done on one computer and the results are shared with others).</a><br>从官方的介绍可以看出，Cache Server是为了共享资源导入的一个工具。</p>
<h4 id="Why"><a href="#Why" class="headerlink" title="Why"></a>Why</h4><p>Why do we use Cache Server?(为什么需要用Cache Server?)<br><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/CacheServer.html">Unity has a completely automatic Asset<br> pipeline. Whenever a source Asset like a .psd or an .fbx file is modified, Unity detects the change and automatically re-imports it. The imported data from the file is subsequently stored by Unity in an internal format.</a><br>因为Unity会把外部资源根据导入设置导入成一个内部的资源格式来使用，每次资源导入设置或者资源有变化都会导致资源被重新导入一次。</p>
<p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/CacheServer.html">Caching the imported Assets data on the Cache Server drastically reduces the time it takes to import Assets.</a><br>缓存并共享前面说到的资源导入则可以有效的减少资源导入的时间，提高团队工作效率，这也是我们为什么需要Cach Server的主要原因。</p>
<h4 id="How"><a href="#How" class="headerlink" title="How"></a>How</h4><p>How to use Cache Server?(如何使用Cache Server)<br>在了解如何使用Cach Server之前，让我们先了解下Asset在什么情况下会被重新导入：</p>
<ol>
<li>The Asset file itself(Asset自身)</li>
<li>The import settings(导入设置)</li>
<li>Asset importer version(Asset导入版本-这里应该是指Unity版本)</li>
<li>The current platform(资源平台-平时我们切换的Android，IOS，PC这些)<br><strong>当上述4点任何一点被改变的话都会导致资源被重新导入。否则就直接使用Cache Server上缓存的资源导入。</strong></li>
</ol>
<p>如何高效的使用Cach Server了？</p>
<ol>
<li>足够的硬盘空间</li>
<li>高速的读写硬盘(SSD)</li>
<li>足够的网络带宽(最好用于局域网内)</li>
<li>尽量在Linux或者MacOS上使用Cache Server</li>
</ol>
<p>第四个点参考官网描述:<br><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/CacheServer.html">he Cache Server runs optimally on a Linux or Mac OS X computer. The Windows file system is not particularly well-optimized for how the Cache Server stores data, and problems with file locking on Windows can cause issues that don’t occur on Linux or Mac OS X.</a></p>
<p>接下来让我们实战看看如何设置Cache Server:<br>第一步：<br>下载对应Unity版本的Cache Server</p>
<p>Unity对应版本官方的Cache Server链接:<br><a target="_blank" rel="noopener" href="https://unity3d.com/cn/get-unity/download/archive">Unity 下载存档</a><br><img src="/img/Unity/Unity-Tips/CacheServerDownloadPage.png" alt="CacheServerDownloadPage"><br>最新Cache Server链接是在Github上:<br><a target="_blank" rel="noopener" href="https://github.com/Unity-Technologies/unity-cache-server">unity-cache-server</a></p>
<p>第二步：<br>运行Cache Server<br>这里我是安装在MacOS上的，所以运行RunOSX.command命令行即可:<br><img src="/img/Unity/Unity-Tips/RunCacheServer.png" alt="RunCacheServer"></p>
<p>第三步：<br>查看Cache Server所在电脑IP(最好能固定Cache Server电脑的IP地址，避免每次去设置)，配置需要使用Cache Server的Unity<br><img src="/img/Unity/Unity-Tips/CacheServerConnect.png" alt="CacheServerConnect"><br>看到Connection Successful就代表我们链接成功了。</p>
<p>接下来我们就可以重用团队或者已经缓存过的Asset导入资源了。</p>
<p>Note:<br>使用Cache Server有哪些需要注意的点了？</p>
<ol>
<li>修改已存在的Material</li>
<li>脚本和一些原始资源(Maya，3D Max直接使用的格式)不会被缓存</li>
</ol>
<h2 id="待续"><a href="#待续" class="headerlink" title="待续"></a>待续</h2><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><h2 id="Conceptions-Part"><a href="#Conceptions-Part" class="headerlink" title="Conceptions Part"></a>Conceptions Part</h2><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/CacheServer.html">Cache Server</a></p>
<h2 id="Other-Part"><a href="#Other-Part" class="headerlink" title="Other Part"></a>Other Part</h2><p><a target="_blank" rel="noopener" href="https://gist.github.com/JoaoBorks/af59720a4baba84f080e2df686cacba2">Custom Unity Script Template</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2018/03/18/%E5%AF%BC%E8%A1%A8%E5%B7%A5%E5%85%B7/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2018/03/18/%E5%AF%BC%E8%A1%A8%E5%B7%A5%E5%85%B7/" class="post-title-link" itemprop="url">导表工具</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2018-03-18 12:30:52" itemprop="dateCreated datePublished" datetime="2018-03-18T12:30:52+08:00">2018-03-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-07-31 15:15:19" itemprop="dateModified" datetime="2022-07-31T15:15:19+08:00">2022-07-31</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Excel/" itemprop="url" rel="index"><span itemprop="name">Excel</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>游戏开发过程中，避免不了和数据打交道，数据是游戏最基础也是很重要的一部分。本篇文章正式为了学习了解游戏开发过程中关于数据配置自动化导表生成代码等一系列自动化相关的知识而写。</p>
<h1 id="Data-Config"><a href="#Data-Config" class="headerlink" title="Data Config"></a>Data Config</h1><h2 id="What"><a href="#What" class="headerlink" title="What"></a>What</h2><p>数据配置 – 策划通过类似Excel或者其他方式配置出游戏里需要的数据，程序通过读取这些数据让游戏根据数据驱动运行起来，这正是我们所谓的数据配置。</p>
<h2 id="Why"><a href="#Why" class="headerlink" title="Why"></a>Why</h2><p>那么为什么需要数据配置了？</p>
<ol>
<li>数据是游戏最基本的单位 – 无论是炫酷的特效还是惊人的AI都是通过读取底层数据最终得出结论的。</li>
<li>协同工作 – 这里说的数据配置更多的是游戏逻辑层的数据，即类似游戏里的对话显示，背包单位格子数量上限等配置。有了数据配置，程序和策划很容易协同工作，程序负责数据读取实现功能，策划负责具体的数据配置实现想要的效果。</li>
<li>多语言显示 – 数据配置用于语言包显示也帮助我们很方便的实现多语言的版本(读取不同语言版本的数据配置即可)。</li>
</ol>
<h2 id="How"><a href="#How" class="headerlink" title="How"></a>How</h2><p>实现数据配置读取原理上是把数据序列化导出保存在本地(.xml, .json .bytes……)，然后通过反序列化读取回来。<br>这里我们不单单是针对个别数据进行序列化反序列化。这里要实现的是一个针对表格配置，可以动态生成支持反序列化读取(非反射机制)读取到程序里的工具。</p>
<p>序列化相关知识学习参考<a target="_blank" rel="noopener" href="http://tonytang1990.github.io/2015/08/15/CS%E5%AD%A6%E4%B9%A0/#Runtime_Serialization">Runtime Serialization</a><br>PC端Excel读取库选择参考:<a target="_blank" rel="noopener" href="http://tonytang1990.github.io/2015/07/15/Unity%E5%AD%A6%E4%B9%A0/#Excel%E6%95%B0%E6%8D%AE%E8%AF%BB%E5%8F%96">Excel数据读取</a></p>
<p>Note:<br>这里注意反射和反序列化不是一回事，反序列化可以用反射也可以不用反射来实现。</p>
<h3 id="Functional-Requirement-功能需求"><a href="#Functional-Requirement-功能需求" class="headerlink" title="Functional Requirement(功能需求)"></a>Functional Requirement(功能需求)</h3><ol>
<li>支持int，float，string基础数据配置</li>
<li>支持大于一个维度的数据读取(多余一个的数据)快速读取(比如配置:1;2;3;4分别代表物体随机的生命值选项)(这个算是<strong>基础需求功能</strong>)</li>
<li>支持列表数据自定义数据结构快速读取(<strong>高阶功能需求</strong>，方便列表数据复杂的时候能够抽象成数据结构快速读取。)<br>实际需求举列:<br>我们配置一个道具不同等级的属性加成数据：1+200|2+300;3+400|4+500|5+600 表示第一级加属性id为1的属性加200并且，属性id为2的加300。第二季加属性id为3,4,5的分别加400,500,600)<br>如果我们不能动态创建自定义结构数据，那么我们就需要在代码里写string.split()这种形式的分割数据去判定读取，不论是从性能开销还是代码编写都是很不划算的。<br>如果我们能自动创建自定义结构，生成如下代码:</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title">Property</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> Id</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">set</span>;        </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> Value</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Property[0].Length : 2</span></span><br><span class="line"><span class="comment">// Proeprty[1].Length : 3</span></span><br><span class="line">Property[<span class="number">2</span>][] mPropertyArray;   <span class="comment">// 存储表格数据的成员</span></span><br></pre></td></tr></table></figure>

<p>那么我们就能方便的编写代码去访问特定等级所加成的属性了：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//快速访问特定等级所加成的属性值</span></span><br><span class="line">mPropertyArray[<span class="number">1</span>][<span class="number">2</span>]表示第二级所加成的第二个属性数据</span><br></pre></td></tr></table></figure>

<pre><code>扩展内嵌多层的话(这样的需求应该很少，这里暂时就不考虑了)，此方案需要扩展多维数组来支持，并不是很友好
</code></pre>
<ol start="4">
<li>支持自动生成读表相关代码</li>
<li>内存开销要控制，读取速度要快</li>
<li>跨平台</li>
<li>跨语言</li>
<li>独立于Unity的工具(后期优化部分)</li>
<li>前后端表格数据区分(后期优化部分)(因为前后端往往是读不同的数据，并不需要导同一套表格数据)</li>
</ol>
<h3 id="原理思考"><a href="#原理思考" class="headerlink" title="原理思考"></a>原理思考</h3><p>流程：</p>
<ol>
<li>定义excel表格格式规则(这一步会影响后面所有步骤)</li>
<li>读取excel数据</li>
<li>生成可跨平台跨语言的序列化代码</li>
<li>序列化写入excel数据(这一步涉及跨语言问题)</li>
<li>反序列化读取数据</li>
</ol>
<ul>
<li><p>定义excel表格格式规则<br>这一步要决定我们excel长什么样子，决定不同数据不同的行号字段代表什么。</p>
</li>
<li><p>读取excel数据<br>通过第三方库(比如PC端跨平台的<a target="_blank" rel="noopener" href="http://exceldatareader.codeplex.com/">ExcelRead</a>)可以解决读取问题。</p>
</li>
<li><p>生成跨平台跨语言的序列化反序列化代码<br>这一步的重点在于跨平台和<br>跨平台这一点肯定不用说，要想在PC端序列化的数据在移动端使用，这一点是必须的也并不是难点。<br><strong>跨语言</strong>这一点上，试想如果前后端用的语言不同，但前后端想共用一份导表工具来生成需要的表格数据，那么跨语言这一点就是必须的了。<br>序列化数据和反序列化数据时，我们需要考虑跨语言的问题，后续的方案中就会强调这一点。</p>
</li>
<li><p>序列化写入excel数据<br>写入数据也就是序列化的过程，解决了前面提到的跨语言生成序列化代码问题后，这个问题也就迎刃而解。</p>
</li>
<li><p>反序列化读取数据<br>读数据就是反序列化的过程，同理序列化，解决了跨语言生成序列化代码的问题，这个问题依然不是问题。</p>
</li>
</ul>
<h3 id="方案比较"><a href="#方案比较" class="headerlink" title="方案比较"></a>方案比较</h3><ol>
<li>C# .Net BinaryFormatter(不夸语言，序列化后数据相对大，反序列化费时且内存开销大)</li>
<li>ProtoBuff(跨语言，序列化数据相对小，反序列化费时和内存开销相对好点。工具成熟，社区完善，自定义数据结构方便)</li>
<li>FlatBuff(跨语言，序列化数据小，反序列化费时少，编写自定义序列化和反序列化数据结构不方便)</li>
<li>XBuffer(之前一位同事写的基于C#的简化版FlatBuff，高效且高度支持扩展和配置)</li>
</ol>
<p>接下来针对各个方案进行简单学习，理解各自的优缺点。</p>
<h4 id="C-Net-BinaryFormatter"><a href="#C-Net-BinaryFormatter" class="headerlink" title="C# .Net BinaryFormatter"></a>C# .Net BinaryFormatter</h4><p>参考这篇文章：<a href="blog.csdn.net/qq_14903317/article/details/78637440">Unity C#配置表工具</a></p>
<p>我们可以看到，我们需要做的事情有以下几步：</p>
<ol>
<li>定义excel表格格式规则</li>
<li>从excel中读取数据</li>
<li>根据数据类型，动态生成每个表的C#类(用于反序列化读取数据)</li>
<li>动态编译C#类，输出一个动态库以及相关代码</li>
<li>实例化C#类，并且把数据填入到实例化对象中，序列化数据，保存在Untiy本地Resources目录中</li>
<li>运行时，通过生成的C#类反序列化加载并创建对应实例化对象去存储数据</li>
</ol>
<p>Utilities.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Diagnostics;</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> System.Runtime.Serialization.Formatters.Binary;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 工具静态类</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">Utilities</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 本机打开特定目录(暂时只用于Windows)</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;folderPath&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">OpenFolder</span>(<span class="params"><span class="built_in">string</span> folderPath</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (Directory.Exists(folderPath))</span><br><span class="line">        &#123;</span><br><span class="line">            ProcessStartInfo startInfo = <span class="keyword">new</span> ProcessStartInfo(folderPath, <span class="string">&quot;explorer.exe&quot;</span>);</span><br><span class="line">            Process.Start(startInfo);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            UnityEngine.Debug.LogError(<span class="built_in">string</span>.Format(<span class="string">&quot;&#123;0&#125; Directory does not exist!&quot;</span>, folderPath));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 检查指定目录是否存在，不存在创建一个</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">checkOrCreateSpecificFolder</span>(<span class="params"><span class="built_in">string</span> folderpath</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (!Directory.Exists(folderpath))</span><br><span class="line">        &#123;</span><br><span class="line">            Directory.CreateDirectory(folderpath);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 无论目录是否存在都删除所有文件重新创建一个目录</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">recreateSpecificFolder</span>(<span class="params"><span class="built_in">string</span> folderpath</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (Directory.Exists(folderpath))</span><br><span class="line">        &#123;</span><br><span class="line">            Directory.Delete(folderpath, <span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        Directory.CreateDirectory(folderpath);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 获取文件的目录名字</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;filepath&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">string</span> <span class="title">getFileFolderName</span>(<span class="params"><span class="built_in">string</span> filepath</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> Path.GetFileName(Path.GetDirectoryName(filepath));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>PathUtilites.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 路径静态工具类</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">PathUtilties</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="keyword">region</span> Excel Data</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Excel数据文件夹目录路径</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">string</span> ExcelFileFolderPath = Application.dataPath + <span class="string">&quot;/../ExcelDatas/Game/&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Excel数据生成的对应代码目录</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Note:</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 因为序列化反序列化时要求Assemble信息一致，所以如果反序列化使用Unity 编译后的C#无法成功反序列化</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> BinderToType低版本.Net可以用但BinderToName要求.Net 4.0</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 所以这里放弃了直接生成新的cs表代码通过Unity编译使用的方案，选择依然采用直接编译表代码成dll来使用</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 表代码依然生成，但放到Asset外部作为非有效代码存储方便查看</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 参考:</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> https://stackoverflow.com/questions/505611/binary-deserialization-with-different-assembly-version</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> https://www.codeproject.com/Tips/1101106/How-to-serialize-across-assemblies-with-the-Binary</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">string</span> ExcelScriptOutputFolderPath = Application.dataPath + <span class="string">&quot;/../DataConfigScripts/&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Excel数据序列化后的文件名</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">string</span> ExcelDataFileName = <span class="string">&quot;dataconfig.byte&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Excel数据序列化后的数据文件存储目录</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">string</span> ExcelDataFileOutputFolderPath = Application.dataPath + <span class="string">&quot;/Resources/DataConfig/&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Excel数据序列化后的数据文件相对于Resource目录的相对目录</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">string</span> ExcelDataFileOutputFolderRelativePath = <span class="string">&quot;DataConfig/&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Excel数据生成的对应Assembly&amp;Script临时文件临时目录</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">string</span> ExcelScriptAssemblyFilePath = Application.dataPath + <span class="string">&quot;/Scripts/Core/DataConfig/&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Excel数据生成的对应Assembly临时文件名</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">string</span> ExcelScriptAssemblyFileName = <span class="string">&quot;dataconfig.dll&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 表格代码文件后缀</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">string</span> ExcelScriptFilePostFix = <span class="string">&quot;.cs&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 表格生成数据管理读取代码文件名</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">string</span> ExcelScriptDataManagerFileName = <span class="string">&quot;DataManager.cs&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 表代码Container后缀名</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">string</span> ExcelTableContainerPostfix = <span class="string">&quot;Container&quot;</span>;</span><br><span class="line">    <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ExportExcelData.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> UnityEditor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> Excel;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> System.Data;</span><br><span class="line"><span class="keyword">using</span> System.Reflection;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"><span class="keyword">using</span> Microsoft.CSharp;</span><br><span class="line"><span class="keyword">using</span> System.CodeDom.Compiler;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Runtime.Serialization.Formatters.Binary;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 表格数据抽象</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ConfigData</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 数据类型</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Type;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 字段名字</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Name;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Data;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 导表工具</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ExportExcelData</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 字段名行号</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">const</span> <span class="built_in">int</span> NameLineNumber = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 字段类型行号</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">const</span> <span class="built_in">int</span> TypeLineNumber = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 数据开始行号</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">const</span> <span class="built_in">int</span> DataLineNumber = <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 有效的数据类型</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> List&lt;<span class="built_in">string</span>&gt; ValideTypesList =  <span class="keyword">new</span> List&lt;<span class="built_in">string</span>&gt;(<span class="keyword">new</span> <span class="built_in">string</span>[]&#123;<span class="string">&quot;int&quot;</span>, <span class="string">&quot;float&quot;</span>, <span class="string">&quot;string&quot;</span>&#125;);</span><br><span class="line"></span><br><span class="line">    [<span class="meta">MenuItem(<span class="string">&quot;Tools/DataConfig/导出所有表格数据&quot;</span>, false, 100)</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">exportAllExcelData</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">string</span>[] excelfiles = Directory.GetFiles(PathUtilties.ExcelFileFolderPath, <span class="string">&quot;*.xlsx&quot;</span>);</span><br><span class="line">        <span class="comment">// 表格数据映射Map</span></span><br><span class="line">        <span class="comment">// Key为表格名字</span></span><br><span class="line">        <span class="comment">// Value为表格对应的数据列表，List的每一个元素代表一行的数据数组</span></span><br><span class="line">        Dictionary&lt;<span class="built_in">string</span>, List&lt;ConfigData[]&gt;&gt; datadic = <span class="keyword">new</span> Dictionary&lt;<span class="built_in">string</span>, List&lt;ConfigData[]&gt;&gt;();</span><br><span class="line">        <span class="comment">// 字段信息map</span></span><br><span class="line">        <span class="comment">// Key为表格名字</span></span><br><span class="line">        <span class="comment">// Value为对应表格的字段数据</span></span><br><span class="line">        Dictionary&lt;<span class="built_in">string</span>, <span class="built_in">string</span>[]&gt; namedic = <span class="keyword">new</span> Dictionary&lt;<span class="built_in">string</span>, <span class="built_in">string</span>[]&gt;();</span><br><span class="line">        <span class="comment">// 字段类型信息map</span></span><br><span class="line">        <span class="comment">// Key为表格名字</span></span><br><span class="line">        <span class="comment">// Value为对应表格的字段类型数据</span></span><br><span class="line">        Dictionary&lt;<span class="built_in">string</span>, <span class="built_in">string</span>[]&gt; typedic = <span class="keyword">new</span> Dictionary&lt;<span class="built_in">string</span>, <span class="built_in">string</span>[]&gt;();</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> excelfile <span class="keyword">in</span> excelfiles)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(!readAllDataFromExcelFile(excelfile, <span class="keyword">ref</span> datadic, <span class="keyword">ref</span> typedic, <span class="keyword">ref</span> namedic))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 表格代码映射map</span></span><br><span class="line">        <span class="comment">// Key为类名字，Value为对应代码数据</span></span><br><span class="line">        Dictionary&lt;<span class="built_in">string</span>, <span class="built_in">string</span>&gt; codemap = <span class="keyword">new</span> Dictionary&lt;<span class="built_in">string</span>, <span class="built_in">string</span>&gt;();</span><br><span class="line">        <span class="comment">//根据刚才记录的每一张表格数据生成对应代码数据</span></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> data <span class="keyword">in</span> datadic)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">string</span> classname = data.Key;</span><br><span class="line">            DataConfigScriptGenerator dcsg = <span class="keyword">new</span> DataConfigScriptGenerator(classname, typedic[classname], namedic[classname]);</span><br><span class="line">            codemap.Add(classname, dcsg.generateCode());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//删除前一次所有相关文件</span></span><br><span class="line">        Utilities.recreateSpecificFolder(PathUtilties.ExcelScriptOutputFolderPath);</span><br><span class="line">        Utilities.recreateSpecificFolder(PathUtilties.ExcelDataFileOutputFolderPath);</span><br><span class="line">        Utilities.recreateSpecificFolder(PathUtilties.ExcelScriptAssemblyFilePath);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//生成dll，Assemble文件用于序列化数据</span></span><br><span class="line">        <span class="built_in">string</span>[] scripts = <span class="keyword">new</span> <span class="built_in">string</span>[codemap.Values.Count];</span><br><span class="line">        codemap.Values.CopyTo(scripts, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">var</span> assemblyfilepath = PathUtilties.ExcelScriptAssemblyFilePath + PathUtilties.ExcelScriptAssemblyFileName;</span><br><span class="line">        Assembly assembly = compileCode(scripts, assemblyfilepath);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (assembly == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">&quot;编译dll失败！&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//使用Assemble序列化数据</span></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> data <span class="keyword">in</span> datadic)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">object</span> container = assembly.CreateInstance(data.Key + <span class="string">&quot;Container&quot;</span>);</span><br><span class="line">            Type classtype = assembly.GetType(data.Key);</span><br><span class="line">            <span class="keyword">if</span> (!serialize(container, classtype, data.Value, PathUtilties.ExcelDataFileOutputFolderPath))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 生成对应Manager加载管理的cs代码文件</span></span><br><span class="line">        createDataManager(assembly, PathUtilties.ExcelScriptAssemblyFilePath);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 生成对应cs代码文件(如果删除dll，使用cs编译的Assembly-CSharp.dll会导致反序列化出问题。猜测是因为Assemly名字改变后，默认的序列化和反序列化的部分信息(e.g. 比如assembly name)对不上。)</span></span><br><span class="line">        <span class="comment">// 所以这里生成的代码仅供查看，释放到Asset上层目录的</span></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> code <span class="keyword">in</span> codemap)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">using</span> (FileStream fs = File.Create(PathUtilties.ExcelScriptOutputFolderPath + code.Key + PathUtilties.ExcelScriptFilePostFix))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">byte</span>[] info = <span class="keyword">new</span> UTF8Encoding(<span class="literal">true</span>).GetBytes(code.Value);</span><br><span class="line">                fs.Write(info, <span class="number">0</span>, info.Length);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//删除Assemble文件</span></span><br><span class="line">        <span class="comment">//File.Delete(assemblyfilepath);</span></span><br><span class="line"></span><br><span class="line">        AssetDatabase.Refresh();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 读取excel里所有数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;excelfile&quot;&gt;</span>excel文件<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;datadic&quot;&gt;</span>表格数据<span class="doctag">&lt;/param&gt;</span>]</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;names&quot;&gt;</span>字段数据<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;typs&quot;&gt;</span>类型数据<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">bool</span> <span class="title">readAllDataFromExcelFile</span>(<span class="params"><span class="built_in">string</span> excelfile, <span class="keyword">ref</span> Dictionary&lt;<span class="built_in">string</span>, List&lt;ConfigData[]&gt;&gt; datadic, <span class="keyword">ref</span> Dictionary&lt;<span class="built_in">string</span>, <span class="built_in">string</span>[]&gt; typesmap, <span class="keyword">ref</span> Dictionary&lt;<span class="built_in">string</span>, <span class="built_in">string</span>[]&gt; namesmap</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Debug.Log(<span class="built_in">string</span>.Format(<span class="string">&quot;excelfile: &#123;0&#125;&quot;</span>, excelfile));</span><br><span class="line">        FileStream fs = File.Open(excelfile, FileMode.Open, FileAccess.Read);</span><br><span class="line">        IExcelDataReader excelreader = ExcelReaderFactory.CreateOpenXmlReader(fs);</span><br><span class="line">        <span class="keyword">if</span> (!excelreader.IsValid)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="built_in">string</span>.Format(<span class="string">&quot;Excel文件:&#123;0&#125;读取失败！&quot;</span>, excelfile));</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            Debug.Log(<span class="built_in">string</span>.Format(<span class="string">&quot;Excel文件.Name:&#123;0&#125;&quot;</span>, excelreader.Name));</span><br><span class="line">            <span class="keyword">var</span> dataset = excelreader.AsDataSet();</span><br><span class="line">            <span class="keyword">if</span> (dataset.Tables.Count &gt; <span class="number">1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                Debug.LogError(<span class="built_in">string</span>.Format(<span class="string">&quot;Excel文件:&#123;0&#125;,不允许一个Excel多张Table!&quot;</span>, excelreader.Name));</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (datadic.ContainsKey(excelreader.Name))</span><br><span class="line">            &#123;</span><br><span class="line">                Debug.LogError(<span class="built_in">string</span>.Format(<span class="string">&quot;有同名的Excel Table存在!同名Excel:&#123;0&#125;!&quot;</span>, excelreader.Name));</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">int</span> currentlinenumber = <span class="number">1</span>;</span><br><span class="line">                <span class="built_in">string</span>[] types = <span class="literal">null</span>;</span><br><span class="line">                <span class="built_in">string</span>[] names = <span class="literal">null</span>;</span><br><span class="line">                datadic.Add(excelreader.Name, <span class="keyword">new</span> List&lt;ConfigData[]&gt;());</span><br><span class="line">                <span class="keyword">while</span>(excelreader.Read())</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//读取每一行的数据</span></span><br><span class="line">                    <span class="built_in">string</span>[] datas = <span class="keyword">new</span> <span class="built_in">string</span>[excelreader.FieldCount];</span><br><span class="line">                    <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; excelreader.FieldCount; i++)</span><br><span class="line">                    &#123;</span><br><span class="line">                        datas[i] = excelreader.GetString(i);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 字段信息</span></span><br><span class="line">                    <span class="keyword">if</span> (currentlinenumber == NameLineNumber)</span><br><span class="line">                    &#123;</span><br><span class="line">                        names = datas;</span><br><span class="line">                        <span class="keyword">if</span>(checkRepeatedNameString(names))</span><br><span class="line">                        &#123;</span><br><span class="line">                            Debug.LogError(<span class="built_in">string</span>.Format(<span class="string">&quot;Excel Table:&#123;0&#125;&quot;</span>, excelreader.Name));</span><br><span class="line">                            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        namesmap.Add(excelreader.Name, names);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// 字段类型信息</span></span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span>(currentlinenumber == TypeLineNumber)</span><br><span class="line">                    &#123;</span><br><span class="line">                        types = datas;</span><br><span class="line">                        <span class="keyword">if</span> (checkInvalideType(types))</span><br><span class="line">                        &#123;</span><br><span class="line">                            Debug.LogError(<span class="built_in">string</span>.Format(<span class="string">&quot;Excel Table:&#123;0&#125;&quot;</span>, excelreader.Name));</span><br><span class="line">                            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        typesmap.Add(excelreader.Name, types);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span>(currentlinenumber &gt;= DataLineNumber)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="comment">// 记录每一行所有数据的字段名，字段类型，字段数据</span></span><br><span class="line">                        ConfigData[] configdatas = <span class="keyword">new</span> ConfigData[datas.Length];</span><br><span class="line">                        <span class="keyword">for</span>(<span class="built_in">int</span> m = <span class="number">0</span>; m &lt; datas.Length; m++)</span><br><span class="line">                        &#123;</span><br><span class="line">                            ConfigData cd = <span class="keyword">new</span> ConfigData();</span><br><span class="line">                            cd.Type = types[m];</span><br><span class="line">                            cd.Name = names[m];</span><br><span class="line">                            cd.Data = datas[m];</span><br><span class="line">                            <span class="keyword">if</span>(<span class="built_in">string</span>.IsNullOrEmpty(cd.Type))</span><br><span class="line">                            &#123;</span><br><span class="line">                                Debug.LogError(<span class="built_in">string</span>.Format(<span class="string">&quot;数据第&#123;0&#125;行，第&#123;1&#125;列字段类型不能为空!&quot;</span>, currentlinenumber, m));</span><br><span class="line">                                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">else</span> <span class="keyword">if</span>(<span class="built_in">string</span>.IsNullOrEmpty(cd.Name))</span><br><span class="line">                            &#123;</span><br><span class="line">                                Debug.LogError(<span class="built_in">string</span>.Format(<span class="string">&quot;数据第&#123;0&#125;行，第&#123;1&#125;列字段名字不能为空!&quot;</span>, currentlinenumber, m));</span><br><span class="line">                                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                            configdatas[m] = cd;</span><br><span class="line">                        &#125;</span><br><span class="line">                        datadic[excelreader.Name].Add(configdatas);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        Debug.LogError(<span class="built_in">string</span>.Format(<span class="string">&quot;无效的行号:&#123;0&#125;&quot;</span>, currentlinenumber));</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    currentlinenumber++;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 检查是否有重复的字段名</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;names&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">bool</span> <span class="title">checkRepeatedNameString</span>(<span class="params"><span class="built_in">string</span>[] names</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> tempdic = <span class="keyword">new</span> Dictionary&lt;<span class="built_in">string</span>, <span class="built_in">string</span>&gt;();</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> name <span class="keyword">in</span> names)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (tempdic.ContainsKey(name))</span><br><span class="line">            &#123;</span><br><span class="line">                Debug.LogError(<span class="built_in">string</span>.Format(<span class="string">&quot;同名字段:&#123;0&#125;!&quot;</span>, name));</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                tempdic.Add(name, name);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 检查是否有无效的字段类型</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;types&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">bool</span> <span class="title">checkInvalideType</span>(<span class="params"><span class="built_in">string</span>[] types</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">foreach</span>(<span class="keyword">var</span> type <span class="keyword">in</span> types)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(!ValideTypesList.Contains(type))</span><br><span class="line">            &#123;</span><br><span class="line">                Debug.LogError(<span class="built_in">string</span>.Format(<span class="string">&quot;无效类型:&#123;0&#125;&quot;</span>, type));</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 编译代码到dll</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;scripts&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;outputfile&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>返回Assembly<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Assembly <span class="title">compileCode</span>(<span class="params"><span class="built_in">string</span>[] scripts, <span class="built_in">string</span> outputfile</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//编译参数</span></span><br><span class="line">        CSharpCodeProvider codeprovider = <span class="keyword">new</span> CSharpCodeProvider();</span><br><span class="line">        CompilerParameters objcompilerparameters = <span class="keyword">new</span> CompilerParameters();</span><br><span class="line">        objcompilerparameters.ReferencedAssemblies.AddRange(<span class="keyword">new</span> <span class="built_in">string</span>[] &#123; <span class="string">&quot;System.dll&quot;</span> &#125;);</span><br><span class="line">        objcompilerparameters.OutputAssembly = outputfile;</span><br><span class="line">        objcompilerparameters.GenerateExecutable = <span class="literal">false</span>;</span><br><span class="line">        objcompilerparameters.GenerateInMemory = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//开始编译脚本</span></span><br><span class="line">        CompilerResults cr = codeprovider.CompileAssemblyFromSource(objcompilerparameters, scripts);</span><br><span class="line">        <span class="keyword">if</span> (cr.Errors.HasErrors)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">&quot;编译错误：&quot;</span>);</span><br><span class="line">            <span class="keyword">foreach</span> (CompilerError err <span class="keyword">in</span> cr.Errors)</span><br><span class="line">                Debug.LogError(err.ErrorText);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> cr.CompiledAssembly;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 序列化数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;container&quot;&gt;</span>数据容器对象<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;type&quot;&gt;</span>数据Class类型<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;datalist&quot;&gt;</span>数据列表<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;outputpath&quot;&gt;</span>输出目录<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">bool</span> <span class="title">serialize</span>(<span class="params"><span class="built_in">object</span> container, Type type, List&lt;ConfigData[]&gt; datalist, <span class="built_in">string</span> outputpath</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        FieldInfo dictInfo = container.GetType().GetField(<span class="string">&quot;Dict&quot;</span>);</span><br><span class="line">        <span class="built_in">object</span> dict = dictInfo.GetValue(container);</span><br><span class="line">        <span class="comment">//读取每一行数据并填充到实例对象里</span></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> datas <span class="keyword">in</span> datalist)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">object</span> instance = type.Assembly.CreateInstance(type.FullName);</span><br><span class="line">            <span class="comment">//填充实例对象数据</span></span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">var</span> data <span class="keyword">in</span> datas)</span><br><span class="line">            &#123;</span><br><span class="line">                FieldInfo fieldinfo = type.GetField(data.Name);</span><br><span class="line">                fieldinfo.SetValue(instance, parseValue(data.Type, data.Data));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//将实例对象数据添加到Container Map里，后续用于序列化数据</span></span><br><span class="line">            <span class="built_in">object</span> id = type.GetField(<span class="string">&quot;id&quot;</span>).GetValue(instance);</span><br><span class="line">            <span class="built_in">bool</span> isExist = (<span class="built_in">bool</span>)dict.GetType().GetMethod(<span class="string">&quot;ContainsKey&quot;</span>).Invoke(dict, <span class="keyword">new</span> <span class="built_in">object</span>[] &#123; id &#125;);</span><br><span class="line">            <span class="keyword">if</span> (isExist)</span><br><span class="line">            &#123;</span><br><span class="line">                Debug.LogError(<span class="string">&quot;Repetitive key &quot;</span> + id + <span class="string">&quot; in &quot;</span> + container.GetType().Name);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            dict.GetType().GetMethod(<span class="string">&quot;Add&quot;</span>).Invoke(dict, <span class="keyword">new</span> <span class="built_in">object</span>[] &#123; id, instance &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//将数据序列化到本地文件</span></span><br><span class="line">        <span class="keyword">var</span> bf = <span class="keyword">new</span> BinaryFormatter();</span><br><span class="line">        <span class="keyword">var</span> s = <span class="keyword">new</span> FileStream(outputpath + type.Name + <span class="string">&quot;.bytes&quot;</span>, FileMode.CreateNew, FileAccess.Write);</span><br><span class="line">        bf.Serialize(s, container);</span><br><span class="line">        s.Close();</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 创建生成反序列化加载接口代码</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;assembly&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;outputpath&quot;&gt;</span>输出路径<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">bool</span> <span class="title">createDataManager</span>(<span class="params">Assembly assembly, <span class="built_in">string</span> outputpath</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        StringBuilder source = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        source.Append(<span class="string">&quot;/*\n&quot;</span>);</span><br><span class="line">        source.Append(<span class="string">&quot;\tAuto create\n&quot;</span>);</span><br><span class="line">        source.Append(<span class="string">&quot;\tDon&#x27;t Edit it\n&quot;</span>);</span><br><span class="line">        source.Append(<span class="string">&quot;*/\n&quot;</span>);</span><br><span class="line">        source.Append(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        source.Append(<span class="string">&quot;using System;\n&quot;</span>);</span><br><span class="line">        source.Append(<span class="string">&quot;using UnityEngine;\n&quot;</span>);</span><br><span class="line">        source.Append(<span class="string">&quot;using System.Runtime.Serialization;\n&quot;</span>);</span><br><span class="line">        source.Append(<span class="string">&quot;using System.Runtime.Serialization.Formatters.Binary;\n&quot;</span>);</span><br><span class="line">        source.Append(<span class="string">&quot;using System.IO;\n\n&quot;</span>);</span><br><span class="line">        source.Append(<span class="string">&quot;[Serializable]\n&quot;</span>);</span><br><span class="line">        source.Append(<span class="string">&quot;public class DataManager : SingletonTemplate&lt;DataManager&gt;\n&quot;</span>);</span><br><span class="line">        source.Append(<span class="string">&quot;&#123;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//定义所有Container的成员变量</span></span><br><span class="line">        <span class="keyword">var</span> types = assembly.GetTypes();</span><br><span class="line">        <span class="keyword">foreach</span>(<span class="keyword">var</span> type <span class="keyword">in</span> types)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(!type.Name.EndsWith(PathUtilties.ExcelTableContainerPostfix))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            source.Append(<span class="string">&quot;\tpublic &quot;</span> + type.Name + <span class="string">&quot; &quot;</span> + type.Name.Remove(<span class="number">0</span>, <span class="number">2</span>) + <span class="string">&quot;;\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        source.Append(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//加载所有配置表</span></span><br><span class="line">        source.Append(<span class="string">&quot;\tpublic void loadAll()\n&quot;</span>);</span><br><span class="line">        source.Append(<span class="string">&quot;\t&#123;\n&quot;</span>);</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> type <span class="keyword">in</span> types)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (!type.Name.EndsWith(<span class="string">&quot;Container&quot;</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">string</span> typeName = type.Name.Remove(type.Name.IndexOf(<span class="string">&quot;Container&quot;</span>));</span><br><span class="line">            source.Append(<span class="string">&quot;\t\t&quot;</span> + type.Name.Remove(<span class="number">0</span>, <span class="number">2</span>) + <span class="string">&quot; = Load(&quot;</span> + <span class="string">&#x27;&quot;&#x27;</span> + typeName + <span class="string">&#x27;&quot;&#x27;</span> + <span class="string">&quot;) as &quot;</span> + type.Name + <span class="string">&quot;;\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        source.Append(<span class="string">&quot;\t&#125;\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//反序列化接口方法</span></span><br><span class="line">        source.Append(<span class="string">&quot;\tprivate System.Object Load(string name)\n&quot;</span>);</span><br><span class="line">        source.Append(<span class="string">&quot;\t&#123;\n&quot;</span>);</span><br><span class="line">        source.Append(<span class="string">&quot;\t\tvar bf = new BinaryFormatter();\n&quot;</span>);</span><br><span class="line">        source.Append(<span class="string">&quot;\t\tTextAsset text = Resources.Load&lt;TextAsset&gt;(&quot;</span> + <span class="string">&#x27;&quot;&#x27;</span> + PathUtilties.ExcelDataFileOutputFolderRelativePath + <span class="string">&#x27;&quot;&#x27;</span> + <span class="string">&quot; + name);\n&quot;</span>);</span><br><span class="line">        source.Append(<span class="string">&quot;\t\tStream s = new MemoryStream(text.bytes);\n&quot;</span>);</span><br><span class="line">        source.Append(<span class="string">&quot;\t\tSystem.Object obj = bf.Deserialize(s);\n&quot;</span>);</span><br><span class="line">        source.Append(<span class="string">&quot;\t\ts.Close();\n&quot;</span>);</span><br><span class="line">        source.Append(<span class="string">&quot;\t\treturn obj;\n&quot;</span>);</span><br><span class="line">        source.Append(<span class="string">&quot;\t&#125;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 数据加载接口</span></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> type <span class="keyword">in</span> types)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (type.Name.EndsWith(<span class="string">&quot;Container&quot;</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">var</span> classname = type.Name;</span><br><span class="line">            source.Append(<span class="string">&quot;\t\n&quot;</span>);</span><br><span class="line">            source.Append(<span class="string">&quot;\tpublic &quot;</span> + classname + <span class="string">&quot; get&quot;</span> + classname.Substring(<span class="number">2</span>) + <span class="string">&quot;Data(int id)\n&quot;</span>);</span><br><span class="line">            source.Append(<span class="string">&quot;\t&#123;\n&quot;</span>);</span><br><span class="line">            source.Append(<span class="string">&quot;\t\t&quot;</span> + classname + <span class="string">&quot; data = null;\n&quot;</span>);</span><br><span class="line">            source.Append(<span class="string">&quot;\t\t&quot;</span> + classname.Substring(<span class="number">2</span>) + <span class="string">&quot;Container.getMap().TryGetValue(id, out data);\n&quot;</span>);</span><br><span class="line">            source.Append(<span class="string">&quot;\t\tif(data == null)\n&quot;</span>);</span><br><span class="line">            source.Append(<span class="string">&quot;\t\t&#123;\n&quot;</span>);</span><br><span class="line">            source.Append(<span class="string">&quot;\t\t\tDebug.LogError(string.Format(\&quot;表格:&#123; 0&#125;找不到id: &#123; 1&#125;的数据!\&quot;, data.GetType().ToString(), id));\n&quot;</span>);</span><br><span class="line">            source.Append(<span class="string">&quot;\t\t&#125;\n&quot;</span>);</span><br><span class="line">            source.Append(<span class="string">&quot;\t\treturn data;\n&quot;</span>);</span><br><span class="line">            source.Append(<span class="string">&quot;\t&#125;\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        source.Append(<span class="string">&quot;&#125;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//保存脚本</span></span><br><span class="line">        StreamWriter sw = <span class="keyword">new</span> StreamWriter(outputpath + PathUtilties.ExcelScriptDataManagerFileName);</span><br><span class="line">        sw.WriteLine(source.ToString());</span><br><span class="line">        sw.Close();</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 根据字符串解析类型(暂时只支持基础类型)</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;type&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;data&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">object</span> <span class="title">parseValue</span>(<span class="params"><span class="built_in">string</span> type, <span class="built_in">string</span> data</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (type.Equals(<span class="string">&quot;string&quot;</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> data;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(type.Equals(<span class="string">&quot;int&quot;</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">int</span>.Parse(data);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(type.Equals(<span class="string">&quot;float&quot;</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">float</span>.Parse(data);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="built_in">string</span>.Format(<span class="string">&quot;类型字符串:&#123;0&#125;不支持该类型数据解析!&quot;</span>, type));</span><br><span class="line">            <span class="keyword">return</span> data;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>DataConfigScriptGenerator.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 导表代码生成工具</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">DataConfigScriptGenerator</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 类名</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> ClassName</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 成员字段类型数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span>[] TypeDatas</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 成员字段名字数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span>[] TypeNameDatas</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DataConfigScriptGenerator</span>(<span class="params"><span class="built_in">string</span> classname, <span class="built_in">string</span>[] typedatas, <span class="built_in">string</span>[] typenamedatas</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        ClassName = classname;</span><br><span class="line">        TypeDatas = typedatas;</span><br><span class="line">        TypeNameDatas = typenamedatas;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 生成对应表代码外部接口</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">generateCode</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">string</span>.IsNullOrEmpty(ClassName) || TypeDatas == <span class="literal">null</span> || TypeNameDatas == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> generateRealCode();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 生成表代码</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="built_in">string</span> <span class="title">generateRealCode</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//生成类文件头</span></span><br><span class="line">        StringBuilder classsource = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        classsource.Append(<span class="string">&quot;/*\n&quot;</span>);</span><br><span class="line">        classsource.Append(<span class="string">&quot;\tAuto create\n&quot;</span>);</span><br><span class="line">        classsource.Append(<span class="string">&quot;\tDon&#x27;t Edit it\n&quot;</span>);</span><br><span class="line">        classsource.Append(<span class="string">&quot;*/\n&quot;</span>);</span><br><span class="line">        classsource.Append(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">        classsource.Append(<span class="string">&quot;using System;\n&quot;</span>);</span><br><span class="line">        classsource.Append(<span class="string">&quot;using System.Reflection;\n&quot;</span>);</span><br><span class="line">        classsource.Append(<span class="string">&quot;using System.Collections.Generic;\n&quot;</span>);</span><br><span class="line">        classsource.Append(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">        classsource.Append(<span class="string">&quot;[Serializable]\n&quot;</span>);</span><br><span class="line">        classsource.Append(<span class="string">&quot;public class &quot;</span> + ClassName + <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">        classsource.Append(<span class="string">&quot;&#123;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//生成成员声明数据</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; TypeDatas.Length; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            classsource.Append(filedString(TypeDatas[i], TypeNameDatas[i]));</span><br><span class="line">        &#125;</span><br><span class="line">        classsource.Append(<span class="string">&quot;&#125;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//生成Container</span></span><br><span class="line">        classsource.Append(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">        classsource.Append(<span class="string">&quot;[Serializable]\n&quot;</span>);</span><br><span class="line">        classsource.Append(<span class="string">&quot;public class &quot;</span> + ClassName + PathUtilties.ExcelTableContainerPostfix + <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">        classsource.Append(<span class="string">&quot;&#123;\n&quot;</span>);</span><br><span class="line">        classsource.Append(<span class="string">&quot;\tpublic &quot;</span> + <span class="string">&quot;Dictionary&lt;int, &quot;</span> + ClassName + <span class="string">&quot;&gt;&quot;</span> + <span class="string">&quot; Dict&quot;</span> + <span class="string">&quot; = new Dictionary&lt;int, &quot;</span> + ClassName + <span class="string">&quot;&gt;();\n&quot;</span>);</span><br><span class="line">        classsource.Append(<span class="string">&quot;\tpublic &quot;</span> + <span class="string">&quot;Dictionary&lt;int, &quot;</span> + ClassName + <span class="string">&quot;&gt;&quot;</span> + <span class="string">&quot; getMap()\n&quot;</span>);</span><br><span class="line">        classsource.Append(<span class="string">&quot;\t&#123;\n&quot;</span>);</span><br><span class="line">        classsource.Append(<span class="string">&quot;\t\treturn Dict;\n&quot;</span>);</span><br><span class="line">        classsource.Append(<span class="string">&quot;\t&#125;\n&quot;</span>);</span><br><span class="line">        classsource.Append(<span class="string">&quot;&#125;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> classsource.ToString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 成员声明数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;type&quot;&gt;</span>成员类型<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;field&quot;&gt;</span>成员名<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="built_in">string</span> <span class="title">filedString</span>(<span class="params"><span class="built_in">string</span> type, <span class="built_in">string</span> field</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">string</span>.IsNullOrEmpty(type) || <span class="built_in">string</span>.IsNullOrEmpty(field))</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        StringBuilder sbProperty = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        sbProperty.Append(<span class="string">&quot;\tpublic &quot;</span> + type + <span class="string">&quot; &quot;</span> + field + <span class="string">&quot;;\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> sbProperty.ToString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>让我们来看看最终的结果：<br>game.xlsx<br><img src="/img/Unity/ExcelDataConfig.PNG" alt="ExcelDataConfig"></p>
<p><img src="/img/Unity/DataConfigData.PNG" alt="DataConfigData"></p>
<p>t_game.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    Auto create</span></span><br><span class="line"><span class="comment">    Don&#x27;t Edit it</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Reflection;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"></span><br><span class="line">[<span class="meta">Serializable</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">t_game</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> id;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> author;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> sex;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> age;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">float</span> money;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[<span class="meta">Serializable</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">t_gameContainer</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> Dictionary&lt;<span class="built_in">int</span>, t_game&gt; Dict = <span class="keyword">new</span> Dictionary&lt;<span class="built_in">int</span>, t_game&gt;();</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Dictionary&lt;<span class="built_in">int</span>, t_game&gt; <span class="title">getMap</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> Dict;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>DataManager.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    Auto create</span></span><br><span class="line"><span class="comment">    Don&#x27;t Edit it</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Runtime.Serialization;</span><br><span class="line"><span class="keyword">using</span> System.Runtime.Serialization.Formatters.Binary;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"></span><br><span class="line">[<span class="meta">Serializable</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">DataManager</span> : <span class="title">SingletonTemplate</span>&lt;<span class="title">DataManager</span>&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> t_gameContainer gameContainer;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadAll</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        gameContainer = Load(<span class="string">&quot;t_game&quot;</span>) <span class="keyword">as</span> t_gameContainer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> System.<span class="function">Object <span class="title">Load</span>(<span class="params"><span class="built_in">string</span> name</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> bf = <span class="keyword">new</span> BinaryFormatter();</span><br><span class="line">        TextAsset text = Resources.Load&lt;TextAsset&gt;(<span class="string">&quot;DataConfig/&quot;</span> + name);</span><br><span class="line">        Stream s = <span class="keyword">new</span> MemoryStream(text.bytes);</span><br><span class="line">        System.Object obj = bf.Deserialize(s);</span><br><span class="line">        s.Close();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> t_game <span class="title">getgameData</span>(<span class="params"><span class="built_in">int</span> id</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        t_game data = <span class="literal">null</span>;</span><br><span class="line">        gameContainer.getMap().TryGetValue(id, <span class="keyword">out</span> data);</span><br><span class="line">        <span class="keyword">if</span>(data == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="built_in">string</span>.Format(<span class="string">&quot;表格:&#123; 0&#125;找不到id: &#123; 1&#125;的数据!&quot;</span>, data.GetType().ToString(), id));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> data;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后在Unity里测试读取和打印:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">GUILayout.BeginHorizontal();</span><br><span class="line"><span class="keyword">if</span> (GUILayout.Button(<span class="string">&quot;加载所有表格数据&quot;</span>, GUILayout.MaxWidth(<span class="number">250.0f</span>), GUILayout.MaxHeight(<span class="number">50.0f</span>)))</span><br><span class="line">&#123;</span><br><span class="line">    Debug.Log(<span class="string">&quot;加载所有表格数据&quot;</span>);</span><br><span class="line">    DataManager.Singleton.loadAll();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (GUILayout.Button(<span class="string">&quot;打印所有表格数据&quot;</span>, GUILayout.MaxWidth(<span class="number">250.0f</span>), GUILayout.MinHeight(<span class="number">50.0f</span>)))</span><br><span class="line">&#123;</span><br><span class="line">    Debug.Log(<span class="string">&quot;打印所有表格数据&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">1</span>; i &lt;= DataManager.Singleton.gameContainer.Dict.Count; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> data = DataManager.Singleton.getgameData(i);</span><br><span class="line">        Debug.Log(<span class="built_in">string</span>.Format(<span class="string">&quot;data.id : &#123;0&#125;, data.author : &#123;1&#125;, data.age : &#123;2&#125;, data.sex : &#123;3&#125;, data.money : &#123;4&#125;&quot;</span>, data.id, data.author, data.age, data.sex, data.money));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">GUILayout.EndHorizontal();</span><br></pre></td></tr></table></figure>

<p><img src="/img/Unity/DataConfigResult.PNG" alt="DataConfigResult"></p>
<p>就这样我们成功的通过读取表格数据，生成对应代码，序列化数据，然后通过生成的对应表代码反序列化读取出数据就基本完成了。</p>
<p>遇到的问题:<br>第三步动态编译dll进行序列化反序列化，这一步本来想最终不使用dll而是跟着Unity参与编译的代码来反序列化，但是反序列化出现了问题。</p>
<p>错误信息:<br>SerializationExeption: could not find type ‘System.Collections.Generic.Dictionary’ **</p>
<p>个人猜测因为序列化反序列化时要求Assemble信息一致，所以如果反序列化使用Unity 编译后的C#无法成功反序列化</p>
<p>网上相关问题:<br><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/505611/binary-deserialization-with-different-assembly-version">SerializationException: Could not find type ‘System.Collections.Generic.List’1 in c# untiy3d</a><br><a target="_blank" rel="noopener" href="https://www.codeproject.com/Tips/1101106/How-to-serialize-across-assemblies-with-the-Binary">How to Serialize Across Assemblies with the BinaryFormatter</a></p>
<p>但考虑到BinderToType低版本.Net可以用但BinderToName要求.Net 4.0，所以这里放弃了直接生成新的cs表代码通过Unity编译使用的方案，选择依然采用直接编译表代码成dll来使用。<br>表代码依然生成，但放到Asset外部作为非有效代码存储方便查看</p>
<h5 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h5><ol>
<li>C#反序列化默认是反射实现的，速度会比较慢，可以考虑实现自定义反序列化加快读取速度，参考：<a target="_blank" rel="noopener" href="http://tonytang1990.github.io/2015/08/15/CSharp-Study/#Runtime_Serialization">Runtime_Serialization</a><br>测试方式:</li>
</ol>
<ul>
<li>序列化同一个类型对象500次并反序列化500次</li>
<li>打印记录反序列化的内存和时间开销<br>测试代码:</li>
</ul>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">long</span> mHeapMemorySize;</span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 显示堆内存使用准备工作(在调用ShowHeapMemoryUsing打印堆内存分配之前调用此方法确保计算显示的堆内存数据申请正确)</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">TonyTangShowHeapMemoryUsingPrepration</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 确保得到正确的起始Heap Memory Size</span></span><br><span class="line">    GC.Collect();</span><br><span class="line">    mHeapMemorySize = GC.GetTotalMemory(<span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 显示堆内存使用情况</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;postfix&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">TonyTangShowHeapMemoryUsing</span>(<span class="params"><span class="built_in">string</span> postfix</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> newestheapmemorysize = GC.GetTotalMemory(<span class="literal">false</span>);</span><br><span class="line">    <span class="keyword">var</span> heapmemoryoffset = newestheapmemorysize - mHeapMemorySize;</span><br><span class="line">    Console.WriteLine(<span class="built_in">string</span>.Format(<span class="string">&quot;Heap Memory Size = &#123;0&#125; Pre Memory Size = &#123;1&#125; Memory Offset = &#123;2&#125; -- &#123;3&#125;&quot;</span>, newestheapmemorysize, mHeapMemorySize, heapmemoryoffset, postfix));</span><br><span class="line">    mHeapMemorySize = newestheapmemorysize;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Note:</span></span><br><span class="line"><span class="comment">//注释掉的部分就是自定义序列化和反序列化的代码部分</span></span><br><span class="line">[<span class="meta">Serializable</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Map</span> <span class="comment">//: ISerializable, IDeserializationCallback</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//Special construct(required by ISerializable) to control deserialization</span></span><br><span class="line">    <span class="comment">//[SecurityPermissionAttribute(SecurityAction.Demand, SerializationFormatter = true)]</span></span><br><span class="line">    <span class="comment">//protected Map(SerializationInfo info, StreamingContext context)</span></span><br><span class="line">    <span class="comment">//&#123;</span></span><br><span class="line">    <span class="comment">//    m_SiInfo = info;</span></span><br><span class="line">    <span class="comment">//&#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//[SecurityPermissionAttribute(SecurityAction.Demand, SerializationFormatter = true)]</span></span><br><span class="line">    <span class="comment">//public virtual void GetObjectData(SerializationInfo info, StreamingContext context)</span></span><br><span class="line">    <span class="comment">//&#123;</span></span><br><span class="line">    <span class="comment">//    info.AddValue(&quot;mID&quot;, mID);</span></span><br><span class="line">    <span class="comment">//    info.AddValue(&quot;mMapName&quot;, mMapName);</span></span><br><span class="line">    <span class="comment">//&#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//void IDeserializationCallback.OnDeserialization(Object sender)</span></span><br><span class="line">    <span class="comment">//&#123;</span></span><br><span class="line">    <span class="comment">//    if (m_SiInfo == null)</span></span><br><span class="line">    <span class="comment">//    &#123;</span></span><br><span class="line">    <span class="comment">//        return;</span></span><br><span class="line">    <span class="comment">//    &#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//    mID = m_SiInfo.GetInt32(&quot;mID&quot;);</span></span><br><span class="line">    <span class="comment">//    mMapName = m_SiInfo.GetString(&quot;mMapName&quot;);</span></span><br><span class="line">    <span class="comment">//&#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//private SerializationInfo m_SiInfo;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Map</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mID = <span class="number">0</span>;</span><br><span class="line">        mMapName = <span class="string">&quot;DefaultMap&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> ID</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> mID;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">set</span></span><br><span class="line">        &#123;</span><br><span class="line">            mID = <span class="keyword">value</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span> mID;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> MapName</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> mMapName;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">set</span></span><br><span class="line">        &#123;</span><br><span class="line">            mMapName = <span class="keyword">value</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">string</span> mMapName;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Serialization</span></span><br><span class="line"><span class="built_in">string</span> mMapSavePath = <span class="string">&quot;./mapInfo.dat&quot;</span>;</span><br><span class="line"><span class="keyword">for</span>(<span class="built_in">int</span> id = <span class="number">0</span>; id &lt; <span class="number">500</span>; id++)</span><br><span class="line">&#123;</span><br><span class="line">    Map map = <span class="keyword">new</span> Map();</span><br><span class="line">    map.ID = id;</span><br><span class="line">    map.MapName = id.ToString();</span><br><span class="line">    BinaryFormatter bf = <span class="keyword">new</span> BinaryFormatter();</span><br><span class="line">    <span class="keyword">var</span> mapsavepath = mMapSavePath + id;</span><br><span class="line">    <span class="keyword">if</span> (!File.Exists(mapsavepath))</span><br><span class="line">    &#123;</span><br><span class="line">        FileStream fsc = File.Create(mapsavepath);</span><br><span class="line">        fsc.Close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    FileStream fs = File.Open(mapsavepath, FileMode.Open);</span><br><span class="line">    bf.Serialize(fs, map);</span><br><span class="line">    fs.Close();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Deserialization</span></span><br><span class="line">ShowHeapMemoryUsingPrepration();</span><br><span class="line">TimeCounter.Singleton.Restart(<span class="string">&quot;Deserialization&quot;</span>);</span><br><span class="line">Map mDSMap;</span><br><span class="line">BinaryFormatter dsbf = <span class="keyword">new</span> BinaryFormatter ();</span><br><span class="line"><span class="keyword">for</span> (<span class="built_in">int</span> id = <span class="number">0</span>; id &lt; <span class="number">500</span>; id++)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> mapsavepath = mMapSavePath + id;</span><br><span class="line">    <span class="keyword">if</span> (File.Exists(mapsavepath))</span><br><span class="line">    &#123;</span><br><span class="line">        FileStream dsfs = File.Open(mapsavepath, FileMode.Open);</span><br><span class="line">        mDSMap = (Map)dsbf.Deserialize(dsfs);</span><br><span class="line">        dsfs.Close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">TimeCounter.Singleton.End();</span><br><span class="line">ShowHeapMemoryUsing(<span class="string">&quot;Serialization&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>自定义序列化反序列化开销:<br><img src="/img/Unity/CustomSerializationPerformance.PNG" alt="CustomSerializationPerformance"><br>默认序列化开销:<br><img src="/img/Unity/DefaultSerializationPerformance.PNG" alt="DefaultSerializationPerformance"><br>Note:<br>    <strong>实际测试以后发现，自定义并没有加快反序列化的速度，反而增加了内存开销</strong><br>    从上面的测试可以看出反序列化的速度没有加快，反倒是反序列化的内存开销增加了。<br>    这里的测试结果也和<a target="_blank" rel="noopener" href="https://theburningwork.com/2011/08/performance-test-binaryformatter-vs-protobuf-net/">Performance Test - BinaryFormatter vs Protobuf-Net</a>里的结论一致了。<strong>但至于为什么反序列化速度没有提升，这里不太明白，理论上避免了反射应该是有所提升才对。希望知道的朋友忘告知。</strong></p>
<ol start="2">
<li>序列化的数据仅仅是通过C#自身可以反序列化出来，不支持跨语言(比如服务器端使用Java的话，并不能直接使用同样的序列化数据)。</li>
</ol>
<h4 id="ProtoBuff"><a href="#ProtoBuff" class="headerlink" title="ProtoBuff"></a>ProtoBuff</h4><h5 id="ProtoBuff学习了解"><a href="#ProtoBuff学习了解" class="headerlink" title="ProtoBuff学习了解"></a>ProtoBuff学习了解</h5><p>Protocol Buffers是Google发布出来的开源项目。<br><a target="_blank" rel="noopener" href="https://developers.google.com/protocol-buffers/docs/overview">Protocol Buffers - a language-neutral, platform-neutral, extensible way of serializing structured data for use in communications protocols, data storage, and more. </a><br>从官网介绍可以看出Google Protocol Buffers(平台无关，语言无关)是针对序列化数据的存储和传输协议等。<br>既然都是用于数据存储，那么Protocol buffers相比传统的二进制和XML序列化有什么优势了？<br>相比XML序列化，Protocol buffers更高效，更灵活，更快，更小，更简单。<br>更方便简单在于 – PB只需定义一次data的数据结构就能自动生成对应语言的解析该数据结构的代码类。<br>更高效更小在于 – XML存储的数据量大，XML在解析的时候，空间开销大，内容多速度慢。(XML的好处 – 具有可读性)<br>更灵活在于 – 只需更新数据结构定义然后编译出对应语言的代码就能无缝衔接以前的版本。<br>既然Protocol buffers这么好，那么让我们看看他是怎么工作的？</p>
<ol>
<li>定义出我们需要序列化的数据结构，保存在.proto文件里。</li>
<li>运用Protocol buffer编译器编译出我们对应语言的解析该数据结构的代码类。<br>首先下载对应语言的<a target="_blank" rel="noopener" href="https://github.com/google/protobuf/releases/tag/v3.0.0">Protocol buffer编译器</a><br>“There are two NuGet packages: Google.Protobuf (the support library) and Google.Protobuf.Tools (containing protoc)”<br>根据上面写的，C#现在貌似有两个版本支持Protocol Buffer，但原生的Protobuf版本支持的.NET版本很高，所以不适合Unity(Unity是基于Mono的，Mono现在对.NET的支持还停留在.NET 2.0和.NET 2.0 subset)。</li>
</ol>
<p>—————————–2018&#x2F;5&#x2F;6(新增)———————————–<br><img src="/img/Unity/UntiyDotNetVersion.PNG" alt="UntiyDotNetVersion"><br>虽然表面上Unity(5.6.4p4)写的.Net 2.0和.Net 2.0 Subnet，其实支持的算是.Net 2.0 + .Net 3.5<br>详情参考<a target="_blank" rel="noopener" href="https://blog.csdn.net/myqtmacc/article/details/70500099">扒一扒.net、.net framework、mono和Unity</a><br><img src="/img/Unity/Unity2017DotNetVersion.PNG" alt="Unity2017DotNetVersion"><br>到了Unity 2017,Unity已经支持到.Net 3.5和测试版的.Net 4.6了(支持C# 6语法)<br>Mono逐渐被IL2CPP取代，MonoDevelop工具在Unity2018开始也正式废弃不再支持。<a target="_blank" rel="noopener" href="https://blogs.unity3d.com/cn/2018/01/05/discontinuing-support-for-monodevelop-unity-starting-in-unity-2018-1/">Replacing MonoDevelop-Unity with Visual Studio Community starting in Unity 2018.1</a><br>——————————2018&#x2F;5&#x2F;6(新增)———————————–</p>
<p>所以通过Google，我找到了以下两个开源项目：<br>    1. <a target="_blank" rel="noopener" href="https://github.com/jskeet/protobuf-csharp-port">Protobuf-csharp-port</a><br>    2. <a target="_blank" rel="noopener" href="https://github.com/mgravell/protobuf-net">Protobuf-net</a><br>    前者在Git上的描述不多，所以这里就以下面引用的话来了解两者之间的区别。<br>    <a target="_blank" rel="noopener" href="http://www.ben-morris.com/protocol-buffers-protobuf-net-vs-protobuf-csharp-port/">Protobuf-csharp-port is written by Jon Skeet and is a faithful port of Google’s java implementation that uses similar command-line tooling. You create the data definitions in text-based .proto files and use a code generation tool to create the C# classes.</a><br>    Protobuf-csharp-port是由Jon Skeet编写，利用原生工具去port的版本。在编译创建上都沿用了Protocol buffer的原始方式(通过编译.proto文件生成解析定义的Message数据结构的C#代码类)<br>    <a target="_blank" rel="noopener" href="http://www.ben-morris.com/protocol-buffers-protobuf-net-vs-protobuf-csharp-port/">Protobuf-net is written by Marc Gravell and will be more familiar to .Net developers. The implementation uses .Net classes and attributes to define data rather than .proto files. Overall, the code resembles existing .Net serializers such as the DataContractSerializer.</a><br>    Protobuf-net是由Marc Gravell编写，支持.NET的类和attributes去定义数据结构，也支持.proto文件预编译生成对应代码类。可以说是.NET风格的Protobuf。<br>    同时Github写明了支持：<br>    .net 2.0&#x2F;3.0&#x2F;3.5&#x2F;4.0<br>    Mono 2.x<br>    所以这里就决定使用Protobuf-net作为Unity C#序列化数据的存储和协议传输的库来学习。<br>        1. 安装Protobuf-net<br>        VS -&gt; Tools -&gt; Nuget Package Manager -&gt; Package Manager Console<br>        在Package Manager Console窗口输入下列命令就会自动去下载Protobuf-net包并安装了。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Install-Package protobuf-net</span><br></pre></td></tr></table></figure>

<pre><code>    也可以直接下载[Down load link of Protobuf-net](https://code.google.com/archive/p/protobuf-net/downloads)
    把Protobuf-net.dll放到Assets/Plugins目录下
    2. 定义可序列化的类
</code></pre>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> ProtoBuf;</span><br><span class="line"></span><br><span class="line">[<span class="meta">ProtoContract</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PlayerData</span> &#123;</span><br><span class="line">    [<span class="meta">ProtoMember(1)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> SceneName</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">ProtoMember(2)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> Scores</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">ProtoMember(3)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> SpeedLevel</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>通过C#(对应语言)protocol buffer API去读写存储的数据。</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Awake</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">   ......</span><br><span class="line"></span><br><span class="line">    mPlayerData = <span class="keyword">new</span> PlayerData();</span><br><span class="line"></span><br><span class="line">    mProfilePath =  Application.persistentDataPath + <span class="string">&quot;/PlayerProile.bin&quot;</span>;</span><br><span class="line">    Debug.Log(<span class="string">&quot;mProfilePath = &quot;</span> + mProfilePath);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SavePlayerData</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//Do serialization for player data</span></span><br><span class="line">    FileStream profile;</span><br><span class="line">    <span class="keyword">if</span>(File.Exists(mProfilePath))</span><br><span class="line">    &#123;</span><br><span class="line">        profile = File.Open(mProfilePath, FileMode.Open);</span><br><span class="line">        Serializer.Serialize(profile, mPlayerData);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        profile = File.Create(mProfilePath);</span><br><span class="line">        Serializer.Serialize(profile, mPlayerData);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">LoadPlayerData</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    FileStream profile;</span><br><span class="line">    <span class="keyword">if</span>(File.Exists(mProfilePath))</span><br><span class="line">    &#123;</span><br><span class="line">        profile = File.OpenRead(mProfilePath);</span><br><span class="line">        mPlayerData = Serializer.Deserialize&lt;PlayerData&gt;(profile);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        mPlayerData = <span class="keyword">new</span> PlayerData();</span><br><span class="line">        mPlayerData.SceneName = Application.productName;</span><br><span class="line">        mPlayerData.Scores = <span class="number">0</span>;</span><br><span class="line">        mPlayerData.SpeedLevel = <span class="number">1</span>;</span><br><span class="line">        SavePlayerData();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但只是这样的话，会报如下错误：<br>NotSupportException： …… System.Reflection.Emit is not supported<br>这里出现了Emit类的使用，显然是用到了动态生成代码，根据我们之前讲到的IOS是在Full-AOT模式下运行不允许动态生成代码的。<br>所以直接使用.NET风格的Attribute会触发动态代码生成，那么我们就需要想办法提前生成，这里就需要使用.proto文件然后通过预编译的方式生成对应的代码类。<br>所以现在我们需要先定义.proto文件(Protobuf-net只支持Proto2)，所以编写<a target="_blank" rel="noopener" href="https://developers.google.com/protocol-buffers/docs/proto">proto2参考</a></p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//PlayerData.proto</span></span><br><span class="line">syntax = <span class="string">&quot;proto2&quot;</span>;</span><br><span class="line"></span><br><span class="line">package NGUI2DGame;</span><br><span class="line"></span><br><span class="line">message PlayerData&#123;</span><br><span class="line">    optional <span class="built_in">string</span> SceneName = <span class="number">1</span>;</span><br><span class="line">    optional int32 Scores = <span class="number">2</span>;</span><br><span class="line">    optional int32 SpeedLevel = <span class="number">3</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后通过Protogen.exe帮我们生成对应解析该数据结构所需要的代码类</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">protogen -i:PlayerData.proto -o:PlayerData.cs -ns:NGUI2DGame</span><br></pre></td></tr></table></figure>

<p>-i是指明输入，这里可以通过-i指定多个输入proto文件。-o是指定输出文件，最终生成的对应信息的代码类。-ns是指定namespace</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//PlayerData.cs</span></span><br><span class="line"><span class="comment">//------------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">// &lt;auto-generated&gt;</span></span><br><span class="line"><span class="comment">//     This code was generated by a tool.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//     Changes to this file may cause incorrect behavior and will be lost if</span></span><br><span class="line"><span class="comment">//     the code is regenerated.</span></span><br><span class="line"><span class="comment">// &lt;/auto-generated&gt;</span></span><br><span class="line"><span class="comment">//------------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Generated from: PlayerData.proto</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">NGUI2DGame</span></span><br><span class="line">&#123;</span><br><span class="line">  [<span class="meta">global::System.Serializable, global::ProtoBuf.ProtoContract(Name=@<span class="string">&quot;PlayerData&quot;</span>)</span>]</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">partial</span> <span class="keyword">class</span> <span class="title">PlayerData</span> : <span class="title">global</span>::<span class="title">ProtoBuf.IExtensible</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PlayerData</span>()</span> &#123;&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">string</span> _SceneName = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    [<span class="meta">global::ProtoBuf.ProtoMember(1, IsRequired = false, Name=@<span class="string">&quot;SceneName&quot;</span>, DataFormat = global::ProtoBuf.DataFormat.Default)</span>]</span><br><span class="line">    [<span class="meta">global::System.ComponentModel.DefaultValue(<span class="string">&quot;&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> SceneName</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">get</span> &#123; <span class="keyword">return</span> _SceneName; &#125;</span><br><span class="line">      <span class="keyword">set</span> &#123; _SceneName = <span class="keyword">value</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span> _Scores = <span class="literal">default</span>(<span class="built_in">int</span>);</span><br><span class="line">    [<span class="meta">global::ProtoBuf.ProtoMember(2, IsRequired = false, Name=@<span class="string">&quot;Scores&quot;</span>, DataFormat = global::ProtoBuf.DataFormat.TwosComplement)</span>]</span><br><span class="line">    [<span class="meta">global::System.ComponentModel.DefaultValue(default(int))</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> Scores</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">get</span> &#123; <span class="keyword">return</span> _Scores; &#125;</span><br><span class="line">      <span class="keyword">set</span> &#123; _Scores = <span class="keyword">value</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span> _SpeedLevel = <span class="literal">default</span>(<span class="built_in">int</span>);</span><br><span class="line">    [<span class="meta">global::ProtoBuf.ProtoMember(3, IsRequired = false, Name=@<span class="string">&quot;SpeedLevel&quot;</span>, DataFormat = global::ProtoBuf.DataFormat.TwosComplement)</span>]</span><br><span class="line">    [<span class="meta">global::System.ComponentModel.DefaultValue(default(int))</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> SpeedLevel</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">get</span> &#123; <span class="keyword">return</span> _SpeedLevel; &#125;</span><br><span class="line">      <span class="keyword">set</span> &#123; _SpeedLevel = <span class="keyword">value</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">global</span>::ProtoBuf.IExtension extensionObject;</span><br><span class="line">    <span class="keyword">global</span>::ProtoBuf.IExtension <span class="keyword">global</span>::ProtoBuf.IExtensible.GetExtensionObject(<span class="built_in">bool</span> createIfMissing)</span><br><span class="line">      &#123; <span class="keyword">return</span> <span class="keyword">global</span>::ProtoBuf.Extensible.GetExtensionObject(<span class="keyword">ref</span> extensionObject, createIfMissing); &#125;</span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下来把我们生成的代码通过VS编译成DLL</p>
<ol>
<li>新建C# Library工程</li>
<li>删掉原始cs添加刚才生成的PlayerData.cs</li>
<li>添加Protobuf-net库引用(用CoreOnly&#x2F;ios&#x2F;protobuf-net.dll)</li>
<li>编译出dll<br>最后我们需要通过上一步生成的信息类dll来编译出专门序列化该信息的类库。(添加precompile.exe的路径到环境变量确保找得到，这里要注意的是dll项目的.NET target设置成2.0，因为Unity Mono现在只支持到2.0)<br>在之前生成的PlayerData.dll目录下执行下列命令：</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">precompile PlayerData.dll -o:ProtobufSerializer.dll -t:com.TonyTang.ProtobufSerializer</span><br></pre></td></tr></table></figure>

<p>-o指明输出文件 -t指明生成的序列化类的类名<br>最后利用生成的PlayerData.dll和ProtobufSerializer.dll到Unity里进行测试，编写对应代码即可，写法和之前的区别就是用我们生成好的类来完成序列化和反序列化。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Serialization</span></span><br><span class="line">ProtobufSerializer serializer = <span class="keyword">new</span> ProtobufSerializer();       </span><br><span class="line">profile = File.Open(mProfilePath, FileMode.Open);</span><br><span class="line">serializer.Serialize(profile, mPlayerData);</span><br><span class="line"><span class="comment">//Deserialization</span></span><br><span class="line">profile = File.OpenRead(mProfilePath);</span><br><span class="line">mPlayerData = serializer.Deserialize(profile,<span class="literal">null</span>,<span class="keyword">typeof</span>(PlayerData)) <span class="keyword">as</span> PlayerData;</span><br></pre></td></tr></table></figure>

<p>因为需要编写.proto文件后编译生成对应的Serialization类的dll，所以最好通过shell脚本写成自动化。<br>还有一种方式是使用Probobuf-net源码的形式(貌似需要设定-unsafe和.NET 2 subset)，这里我没有尝试，下面给出链接：<br><a target="_blank" rel="noopener" href="http://www.ceeger.com/forum/read.php?tid=14359&fid=27">在ios android设备上使用 Protobuf (使用源码方式) </a></p>
<p>了解了什么(What)是Protobuf，如何(How)使用Protobuf，那么我们也应该大概了解下为什么(Why)Protobuf高效，更小，更快，更简单…..<br>参考下面两篇文章：<br><a target="_blank" rel="noopener" href="https://www.ibm.com/developerworks/cn/linux/l-cn-gpb/">Google Protocol Buffer 的使用和原理</a><br><a target="_blank" rel="noopener" href="https://developers.google.com/protocol-buffers/docs/encoding">官网讲到的Protocol buffer的Encode技术</a><br>从上面可以看出，更小更快是因为Protocol buffer采用了巧妙的Encoding方法。<br>而这个Encoding方法利用了Varint技术，那么什么是Varint了？<br>“Varints are a method of serializing integers using one or more bytes. Smaller numbers take a smaller number of bytes. “<br>Varints通过更少的字节来表达准确的数据，比如0-127只需要1个字节就能表示。<br>当需要多个字节表达的时候，通过利用1byte里的first bit来区分，如果first bit是1表示后续的7个bit都表示数据，如果first bit是0表示这是最后一个字节用于表示数据。<br>同时Protocol buffer在Encode的时候通过key和value来存储数据。key只包含filed的名字和类型，value包含数据。<br>类型数据映射<br><img src="/img/Unity/ProtocolBufferMessageValueType.PNG" alt="ProtocolBufferMessageValueType"><br>当Decode的时候，如果遇到不识别的key值，只需要skip即可，保证了程序的老版本兼容。<br>更方便在于，我们只需通过编写简单易懂的.proto文件然后通过ProtoGen，Precompile工具就能生成对应的Message，Encode和Decode类。<br>结合前面的事例，让我们窥探一下到底Protocol-net是如何实现编写.proto文件结合编译生成Message类和序列化类来实现数据的Encode和Decode的。<br>首先反编译的ProtovufSerializer.dll，查看Serialize方法<br><img src="/img/Unity/ProtobufSerializerSerialize.PNG" alt="ProtobufSerializerSerialize"><br>可以看到ProtobufSerializer调用了Write方法，接下来查看Write方法<br><img src="/img/Unity/ProtobufSerializerWrite.PNG" alt="ProtobufSerializerWrite"><br>可以看到我们ProtobufSerializer实际是通过调用ProtoBuf.ProtoWriter::WriteFieldHeader(Protobuf-net库)实现数据的Encode的。同时因为ProtobufSerializer是根据PlayerData.dll编译而成，所以Write方法里的实现针对每一个需要Encode的Message成员进行数据Encode写入。<br>这样一来就完成了通过编写.proto文件定义Message，然后生成对应的Message类和序列化类再结合Protocol-net库实现了自定义Message的Encode和Decode了，而最终数据的Encode，Decode实现就落实到Protocol-net的实现了。</p>
<p>那么为什么要用Protocol buffer了？<br>参考文章：<br><a target="_blank" rel="noopener" href="http://www.oschina.net/translate/choose-protocol-buffers">使用 Protocol Buffers 代替 JSON 的五个原因</a><br>Protocol buffer因为是存储在二进制文件，相比XML，Jason等技术不具可读性。</p>
<p>Note:<br>最初的Protocol Buffers只开发了针对Java,C++,Python的版本。后来开园后有了C#，Go等语言的支持。<br>Protocol Buffer存储的数据是以二进制的形式。<br>Protocol-net只支持<a target="_blank" rel="noopener" href="https://developers.google.com/protocol-buffers/docs/proto">proto2的语言编写规范</a>。</p>
<p>从之前的学习可以知道的是，ProtoBuf通过自定义了Encode和Decode，使用Varint技术，把数据成功压缩更小，实现了更小的数据量存储。</p>
<p>——————————-2018&#x2F;04&#x2F;22———————————–<br>关于ProtoBuf原理深度解析，这里找到一篇好文:<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/30ef9b3780d9">Protocol Buffer 序列化原理大揭秘 - 为什么Protocol Buffer性能这么好？</a>——————————-2018&#x2F;04&#x2F;22———————————–</p>
<p>前面提到的是Protocol Buffer 2的使用，那么我们能否集成使用Protocol Buffer 3吗？<br>答案是可以的，接下来我们学习Protocol Bufffer 3的集成使用。</p>
<h5 id="Protocol-Buffer-3-in-Unity"><a href="#Protocol-Buffer-3-in-Unity" class="headerlink" title="Protocol Buffer 3 in Unity"></a>Protocol Buffer 3 in Unity</h5><p>Protocok Buffer(高效的跨语言序列化反序列化数据以及数据结构向后扩展兼容)</p>
<p>问题：</p>
<ol>
<li>PB3对.Net版本的要求？<br>在前面的学习中，我们使用了Protobuf-net版本(支持.Net 2.0,3.0,4.0，但只支持PB2)，这里是学习了解PB3是否能在Unity中使用起来。</li>
</ol>
<p>Probuf官方Git链接：<br><a target="_blank" rel="noopener" href="https://github.com/google/protobuf">protobuf</a><br>Probuf最新压缩包链接：<br><a target="_blank" rel="noopener" href="https://github.com/google/protobuf/releases/tag/v3.6.1">protobuf latest</a><br>从Git上下载的最新PB3要求.Net4.5，这是从Git上Protobuf CS源代码工程的Google.Protobuf.csproj文件里看出来的：<br><img src="/img/Unity/Data-Config-Automation/Protobuf3DotNetTargetNumber.png" alt="Protobuf3DotNetTargetNumber"></p>
<ol start="2">
<li><p>Unity支持的.Net版本?<br><img src="/img/Unity/Unity2017DotNetVersion.PNG" alt="Unity2017DotNetVersion"><br>到了Unity 2017,Unity已经支持到.Net 3.5和测试版的.Net 4.6了(支持C# 6语法)</p>
</li>
<li><p>Unity支持的PB版本？<br>通过前面两个问题可以知道，Unity要想支持PB3，我们需要把PB3编译成基于.Net 3.5(因为.Net 4.6还处于测试阶段，所以没选择.Net 4.6)来使用。看网上都有兼容PB3的版本了，理论上Unity是有办法支持PB3的。<br>兼容PB3的版本链接:<br><a target="_blank" rel="noopener" href="https://github.com/bitcraftCoLtd/protobuf3-for-unity">protobuf3-for-unity</a></p>
</li>
<li><p>Python对应需要的PB版本？<br>选择和前面CS版本相同版本的Python版本的PB3即可(PB3 3.6.1)</p>
</li>
<li><p>Protoc的选择？<br>直接下载编译好的对应版本的Protoc(3.6.1)压缩包即可</p>
</li>
</ol>
<p>流程：<br>Protobuf CSharp篇：</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://github.com/google/protobuf/releases/tag/v3.6.1">下载新版Protobuf Csharp版</a></li>
<li>自己编译基于.Net 3.5版本Protobuf Csharp版dll(我的理解这一步的dll是Protobuf核心的模块，用于支持对数据编码存储)<br>打开下载的Protobuf Csharp源码里的Google.Protobuf.sln，修改里面Google.Protobuf.csproj工程的TargetFrameworks编译生成我们想要的基于.Net 3.5的Csharp版Protobuf-Csharp.dll<br><img src="/img/Unity/Data-Config-Automation/CompileProtobufCsharpForDoNet35.png" alt="CompileProtobufCsharpForDoNet35"><br><img src="/img/Unity/Data-Config-Automation/DoNet35ProtobufCsharpDll.png" alt="DoNet35ProtobufCsharpDll"><br>复制基于.Net 3.Google.Protobuf.dll到我们的Unity脚本目录下。</li>
</ol>
<p>Note:</p>
<ul>
<li>Protobuf 3.6.1的Google.Protobuf.sln工程需要VS2017才能正确打开，VS2015本人打开显示加载.csproj的C#项目都失败了</li>
</ul>
<ol start="3">
<li>使用Protoc.exe对*.proto文件进行解析生成对应的代码(我的理解，这一步是为了支持指定定义的数据格式的序列化和反序列化相关代码)<br>第一步需要添加Protoc.exe到环境变量里，方便快速访问调用Protoc.exe(这个就不细说了)<br>编写测试GameConfig.proto文件：</li>
</ol>
<figure class="highlight proto"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用proto3</span></span><br><span class="line">syntax = <span class="string">&quot;proto3&quot;</span>;</span><br><span class="line"><span class="comment">// 指明namespace</span></span><br><span class="line"><span class="keyword">package</span> GameData;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 游戏配置信息</span></span><br><span class="line"><span class="keyword">message </span><span class="title class_">GameConfig</span> &#123;</span><br><span class="line">  <span class="type">string</span> difficultyLevel = <span class="number">1</span>;           <span class="comment">// 游戏难度</span></span><br><span class="line">  <span class="type">int32</span> versionNumber = <span class="number">2</span>;              <span class="comment">// 游戏版本号</span></span><br><span class="line">  <span class="type">int32</span> resourceNumber = <span class="number">3</span>;             <span class="comment">// 游戏资源版本号</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用protoc.exe生成用于序列化反序列化GameConfig的代码:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">protoc.exe --csharp_out=CsharpCode -I=Proto GameConfig.proto</span><br></pre></td></tr></table></figure>

<p>–csharp_out指明CS脚本输出目录<br>-I指明Proto文件查找目录<br>GameConfig.proto表示protoc.exe编译该文件<br>最终得到我们Csharp序列化和反序列化GameConfig所需的代码:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// &lt;auto-generated&gt;</span></span><br><span class="line"><span class="comment">//     Generated by the protocol buffer compiler.  DO NOT EDIT!</span></span><br><span class="line"><span class="comment">//     source: GameConfig.proto</span></span><br><span class="line"><span class="comment">// &lt;/auto-generated&gt;</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> <span class="keyword">warning</span> disable 1591, 0612, 3021</span></span><br><span class="line"><span class="meta">#<span class="keyword">region</span> Designer generated code</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> pb = <span class="keyword">global</span>::Google.Protobuf;</span><br><span class="line"><span class="keyword">using</span> pbc = <span class="keyword">global</span>::Google.Protobuf.Collections;</span><br><span class="line"><span class="keyword">using</span> pbr = <span class="keyword">global</span>::Google.Protobuf.Reflection;</span><br><span class="line"><span class="keyword">using</span> scg = <span class="keyword">global</span>::System.Collections.Generic;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">GameData</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span>Holder for reflection information generated from GameConfig.proto<span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">partial</span> <span class="keyword">class</span> <span class="title">GameConfigReflection</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="keyword">region</span> Descriptor</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span>File descriptor for GameConfig.proto<span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> pbr::FileDescriptor Descriptor &#123;</span><br><span class="line">      <span class="keyword">get</span> &#123; <span class="keyword">return</span> descriptor; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> pbr::FileDescriptor descriptor;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="title">GameConfigReflection</span>()</span> &#123;</span><br><span class="line">      <span class="built_in">byte</span>[] descriptorData = <span class="keyword">global</span>::System.Convert.FromBase64String(</span><br><span class="line">          <span class="built_in">string</span>.Concat(</span><br><span class="line">            <span class="string">&quot;ChBHYW1lQ29uZmlnLnByb3RvEghHYW1lRGF0YSJUCgpHYW1lQ29uZmlnEhcK&quot;</span>,</span><br><span class="line">            <span class="string">&quot;D2RpZmZpY3VsdHlMZXZlbBgBIAEoCRIVCg12ZXJzaW9uTnVtYmVyGAIgASgF&quot;</span>,</span><br><span class="line">            <span class="string">&quot;EhYKDnJlc291cmNlTnVtYmVyGAMgASgFYgZwcm90bzM=&quot;</span>));</span><br><span class="line">      descriptor = pbr::FileDescriptor.FromGeneratedCode(descriptorData,</span><br><span class="line">          <span class="keyword">new</span> pbr::FileDescriptor[] &#123; &#125;,</span><br><span class="line">          <span class="keyword">new</span> pbr::GeneratedClrTypeInfo(<span class="literal">null</span>, <span class="keyword">new</span> pbr::GeneratedClrTypeInfo[] &#123;</span><br><span class="line">            <span class="keyword">new</span> pbr::GeneratedClrTypeInfo(<span class="keyword">typeof</span>(<span class="keyword">global</span>::GameData.GameConfig), <span class="keyword">global</span>::GameData.GameConfig.Parser, <span class="keyword">new</span>[]&#123; <span class="string">&quot;DifficultyLevel&quot;</span>, <span class="string">&quot;VersionNumber&quot;</span>, <span class="string">&quot;ResourceNumber&quot;</span> &#125;, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>)</span><br><span class="line">          &#125;));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="meta">#<span class="keyword">region</span> Messages</span></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> 游戏配置信息</span></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">sealed</span> <span class="keyword">partial</span> <span class="keyword">class</span> <span class="title">GameConfig</span> : <span class="title">pb</span>::<span class="title">IMessage</span>&lt;<span class="title">GameConfig</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">readonly</span> pb::MessageParser&lt;GameConfig&gt; _parser = <span class="keyword">new</span> pb::MessageParser&lt;GameConfig&gt;(() =&gt; <span class="keyword">new</span> GameConfig());</span><br><span class="line">    <span class="keyword">private</span> pb::UnknownFieldSet _unknownFields;</span><br><span class="line">    [<span class="meta">global::System.Diagnostics.DebuggerNonUserCodeAttribute</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> pb::MessageParser&lt;GameConfig&gt; Parser &#123; <span class="keyword">get</span> &#123; <span class="keyword">return</span> _parser; &#125; &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">global::System.Diagnostics.DebuggerNonUserCodeAttribute</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> pbr::MessageDescriptor Descriptor &#123;</span><br><span class="line">      <span class="keyword">get</span> &#123; <span class="keyword">return</span> <span class="keyword">global</span>::GameData.GameConfigReflection.Descriptor.MessageTypes[<span class="number">0</span>]; &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">global::System.Diagnostics.DebuggerNonUserCodeAttribute</span>]</span><br><span class="line">    pbr::MessageDescriptor pb::IMessage.Descriptor &#123;</span><br><span class="line">      <span class="keyword">get</span> &#123; <span class="keyword">return</span> Descriptor; &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">global::System.Diagnostics.DebuggerNonUserCodeAttribute</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">GameConfig</span>()</span> &#123;</span><br><span class="line">      OnConstruction();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">partial</span> <span class="keyword">void</span> <span class="title">OnConstruction</span>()</span>;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">global::System.Diagnostics.DebuggerNonUserCodeAttribute</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">GameConfig</span>(<span class="params">GameConfig other</span>) : <span class="title">this</span>()</span> &#123;</span><br><span class="line">      difficultyLevel_ = other.difficultyLevel_;</span><br><span class="line">      versionNumber_ = other.versionNumber_;</span><br><span class="line">      resourceNumber_ = other.resourceNumber_;</span><br><span class="line">      _unknownFields = pb::UnknownFieldSet.Clone(other._unknownFields);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">global::System.Diagnostics.DebuggerNonUserCodeAttribute</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> GameConfig <span class="title">Clone</span>()</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> GameConfig(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span>Field number for the &quot;difficultyLevel&quot; field.<span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">const</span> <span class="built_in">int</span> DifficultyLevelFieldNumber = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">string</span> difficultyLevel_ = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 游戏难度</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">global::System.Diagnostics.DebuggerNonUserCodeAttribute</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> DifficultyLevel &#123;</span><br><span class="line">      <span class="keyword">get</span> &#123; <span class="keyword">return</span> difficultyLevel_; &#125;</span><br><span class="line">      <span class="keyword">set</span> &#123;</span><br><span class="line">        difficultyLevel_ = pb::ProtoPreconditions.CheckNotNull(<span class="keyword">value</span>, <span class="string">&quot;value&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span>Field number for the &quot;versionNumber&quot; field.<span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">const</span> <span class="built_in">int</span> VersionNumberFieldNumber = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span> versionNumber_;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 游戏版本号</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">global::System.Diagnostics.DebuggerNonUserCodeAttribute</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> VersionNumber &#123;</span><br><span class="line">      <span class="keyword">get</span> &#123; <span class="keyword">return</span> versionNumber_; &#125;</span><br><span class="line">      <span class="keyword">set</span> &#123;</span><br><span class="line">        versionNumber_ = <span class="keyword">value</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span>Field number for the &quot;resourceNumber&quot; field.<span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">const</span> <span class="built_in">int</span> ResourceNumberFieldNumber = <span class="number">3</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span> resourceNumber_;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 游戏资源版本号</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">global::System.Diagnostics.DebuggerNonUserCodeAttribute</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> ResourceNumber &#123;</span><br><span class="line">      <span class="keyword">get</span> &#123; <span class="keyword">return</span> resourceNumber_; &#125;</span><br><span class="line">      <span class="keyword">set</span> &#123;</span><br><span class="line">        resourceNumber_ = <span class="keyword">value</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">global::System.Diagnostics.DebuggerNonUserCodeAttribute</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="built_in">bool</span> <span class="title">Equals</span>(<span class="params"><span class="built_in">object</span> other</span>)</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> Equals(other <span class="keyword">as</span> GameConfig);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">global::System.Diagnostics.DebuggerNonUserCodeAttribute</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">Equals</span>(<span class="params">GameConfig other</span>)</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (ReferenceEquals(other, <span class="literal">null</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (ReferenceEquals(other, <span class="keyword">this</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (DifficultyLevel != other.DifficultyLevel) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">      <span class="keyword">if</span> (VersionNumber != other.VersionNumber) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">      <span class="keyword">if</span> (ResourceNumber != other.ResourceNumber) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">      <span class="keyword">return</span> Equals(_unknownFields, other._unknownFields);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">global::System.Diagnostics.DebuggerNonUserCodeAttribute</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="built_in">int</span> <span class="title">GetHashCode</span>()</span> &#123;</span><br><span class="line">      <span class="built_in">int</span> hash = <span class="number">1</span>;</span><br><span class="line">      <span class="keyword">if</span> (DifficultyLevel.Length != <span class="number">0</span>) hash ^= DifficultyLevel.GetHashCode();</span><br><span class="line">      <span class="keyword">if</span> (VersionNumber != <span class="number">0</span>) hash ^= VersionNumber.GetHashCode();</span><br><span class="line">      <span class="keyword">if</span> (ResourceNumber != <span class="number">0</span>) hash ^= ResourceNumber.GetHashCode();</span><br><span class="line">      <span class="keyword">if</span> (_unknownFields != <span class="literal">null</span>) &#123;</span><br><span class="line">        hash ^= _unknownFields.GetHashCode();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> hash;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">global::System.Diagnostics.DebuggerNonUserCodeAttribute</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="built_in">string</span> <span class="title">ToString</span>()</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> pb::JsonFormatter.ToDiagnosticString(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">global::System.Diagnostics.DebuggerNonUserCodeAttribute</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">WriteTo</span>(<span class="params">pb::CodedOutputStream output</span>)</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (DifficultyLevel.Length != <span class="number">0</span>) &#123;</span><br><span class="line">        output.WriteRawTag(<span class="number">10</span>);</span><br><span class="line">        output.WriteString(DifficultyLevel);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (VersionNumber != <span class="number">0</span>) &#123;</span><br><span class="line">        output.WriteRawTag(<span class="number">16</span>);</span><br><span class="line">        output.WriteInt32(VersionNumber);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (ResourceNumber != <span class="number">0</span>) &#123;</span><br><span class="line">        output.WriteRawTag(<span class="number">24</span>);</span><br><span class="line">        output.WriteInt32(ResourceNumber);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (_unknownFields != <span class="literal">null</span>) &#123;</span><br><span class="line">        _unknownFields.WriteTo(output);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">global::System.Diagnostics.DebuggerNonUserCodeAttribute</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">int</span> <span class="title">CalculateSize</span>()</span> &#123;</span><br><span class="line">      <span class="built_in">int</span> size = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">if</span> (DifficultyLevel.Length != <span class="number">0</span>) &#123;</span><br><span class="line">        size += <span class="number">1</span> + pb::CodedOutputStream.ComputeStringSize(DifficultyLevel);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (VersionNumber != <span class="number">0</span>) &#123;</span><br><span class="line">        size += <span class="number">1</span> + pb::CodedOutputStream.ComputeInt32Size(VersionNumber);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (ResourceNumber != <span class="number">0</span>) &#123;</span><br><span class="line">        size += <span class="number">1</span> + pb::CodedOutputStream.ComputeInt32Size(ResourceNumber);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (_unknownFields != <span class="literal">null</span>) &#123;</span><br><span class="line">        size += _unknownFields.CalculateSize();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> size;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">global::System.Diagnostics.DebuggerNonUserCodeAttribute</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">MergeFrom</span>(<span class="params">GameConfig other</span>)</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (other == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (other.DifficultyLevel.Length != <span class="number">0</span>) &#123;</span><br><span class="line">        DifficultyLevel = other.DifficultyLevel;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (other.VersionNumber != <span class="number">0</span>) &#123;</span><br><span class="line">        VersionNumber = other.VersionNumber;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (other.ResourceNumber != <span class="number">0</span>) &#123;</span><br><span class="line">        ResourceNumber = other.ResourceNumber;</span><br><span class="line">      &#125;</span><br><span class="line">      _unknownFields = pb::UnknownFieldSet.MergeFrom(_unknownFields, other._unknownFields);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">global::System.Diagnostics.DebuggerNonUserCodeAttribute</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">MergeFrom</span>(<span class="params">pb::CodedInputStream input</span>)</span> &#123;</span><br><span class="line">      <span class="built_in">uint</span> tag;</span><br><span class="line">      <span class="keyword">while</span> ((tag = input.ReadTag()) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">switch</span>(tag) &#123;</span><br><span class="line">          <span class="literal">default</span>:</span><br><span class="line">            _unknownFields = pb::UnknownFieldSet.MergeFieldFrom(_unknownFields, input);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          <span class="keyword">case</span> <span class="number">10</span>: &#123;</span><br><span class="line">            DifficultyLevel = input.ReadString();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">case</span> <span class="number">16</span>: &#123;</span><br><span class="line">            VersionNumber = input.ReadInt32();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">case</span> <span class="number">24</span>: &#123;</span><br><span class="line">            ResourceNumber = input.ReadInt32();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endregion</span> Designer generated code</span></span><br></pre></td></tr></table></figure>

<ol start="4">
<li>使用生成的代码进行序列化和反序列化数据测试<br>UIDebugMonoScript.cs</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             UIDebugMonoScript.cs</span></span><br><span class="line"><span class="comment"> * Author:                  TONYTANG</span></span><br><span class="line"><span class="comment"> * Create Date:             2018/08/19</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> GameData;</span><br><span class="line"><span class="keyword">using</span> Google.Protobuf;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> UnityEngine.UI;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> UIDebugMonoScript.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 快速访问UI组件测试挂在脚本</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UIDebugMonoScript</span> : <span class="title">MonoBehaviour</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 创建GameConfig按钮</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> Button mBtnCreateGameConfig;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 读取GameConfig按钮</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> Button mBtnReadGameConfig;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Start</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mBtnCreateGameConfig.onClick.AddListener(onCreateGameConfigClick);</span><br><span class="line">        mBtnReadGameConfig.onClick.AddListener(onReadGameConfigClick);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnDestroy</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mBtnCreateGameConfig.onClick.RemoveAllListeners();</span><br><span class="line">        mBtnReadGameConfig.onClick.RemoveAllListeners();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 创建GameConfig按钮点击</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onCreateGameConfigClick</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        Debug.Log(<span class="string">&quot;onCreateGameConfigClick()&quot;</span>);</span><br><span class="line">        Debug.Log(<span class="string">&quot;PathUtilities.ProtobufDataFolderPath : &quot;</span> + PathUtilities.ProtobufDataFolderPath);</span><br><span class="line">        PathUtilities.checkAndCreateFolder(PathUtilities.ProtobufDataFolderPath);</span><br><span class="line">        GameConfig gameconfig = <span class="keyword">new</span> GameConfig();</span><br><span class="line">        gameconfig.DifficultyLevel = <span class="string">&quot;Easy&quot;</span>;</span><br><span class="line">        gameconfig.VersionNumber = <span class="number">1</span>;</span><br><span class="line">        gameconfig.ResourceNumber = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">using</span> (<span class="keyword">var</span> output = File.Create(PathUtilities.ProtobufDataFolderPath + <span class="string">&quot;GameConfig.data&quot;</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            gameconfig.WriteTo(output);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 读取GameConfig按钮点击</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onReadGameConfigClick</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        Debug.Log(<span class="string">&quot;onReadGameConfigClick()&quot;</span>);</span><br><span class="line">        Debug.Log(<span class="string">&quot;PathUtilities.ProtobufDataFolderPath : &quot;</span> + PathUtilities.ProtobufDataFolderPath);</span><br><span class="line">        GameConfig gameconfig;</span><br><span class="line">        <span class="keyword">using</span> (<span class="keyword">var</span> intput = File.OpenRead(PathUtilities.ProtobufDataFolderPath + <span class="string">&quot;GameConfig.data&quot;</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            gameconfig = GameConfig.Parser.ParseFrom(intput);</span><br><span class="line">        &#125;</span><br><span class="line">        Debug.Log(<span class="string">&quot;gameconfig.DifficultyLevel : &quot;</span> + gameconfig.DifficultyLevel);</span><br><span class="line">        Debug.Log(<span class="string">&quot;gameconfig.VersionNumber : &quot;</span> + gameconfig.VersionNumber);</span><br><span class="line">        Debug.Log(<span class="string">&quot;gameconfig.ResourceNumber : &quot;</span> + gameconfig.ResourceNumber);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>PathUtilities.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             路径静态工具类</span></span><br><span class="line"><span class="comment"> * Author:                  tanghuan</span></span><br><span class="line"><span class="comment"> * Create Date:             2018/03/12</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 路径静态工具类</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">PathUtilities</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//******</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="keyword">region</span> Protobuf</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> UNITY_EDITOR</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Protobuf生成数据目录</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">string</span> ProtobufDataFolderPath = Application.dataPath + <span class="string">&quot;/Resources/ProtoData/&quot;</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">elif</span> UNITY_ANDROID</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">string</span> ProtobufDataFolderPath = Application.temporaryCachePath + <span class="string">&quot;/ProtoData/&quot;</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">elif</span> UNITY_IOS</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">string</span> ProtobufDataFolderPath = Application.temporaryCachePath + <span class="string">&quot;/ProtoData/&quot;</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="keyword">region</span> 公用方法</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 检查并确保目录存在</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;folderpath&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">checkAndCreateFolder</span>(<span class="params"><span class="built_in">string</span> folderpath</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(!Directory.Exists(folderpath))</span><br><span class="line">        &#123;</span><br><span class="line">            Directory.CreateDirectory(folderpath);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>PC:<br><img src="/img/Unity/Data-Config-Automation/ProtobufSerialization.png" alt="ProtobufSerialization"><br>Android:<br><img src="/img/Unity/Data-Config-Automation/ProtobufSerializationAndroidPlatform.png" alt="ProtobufSerializationAndroidPlatform"><br>可以看到我们在PC和Android都成功使用Protobuf3进行了数据的序列化和反序列化。<br>接下来我们要完成的是测试同样的二进制序列化文件，通过Python版的Protobuf3是否能够正确的反序列化读取(验证跨语言数据存储读取)。</p>
<p>Protobuf Python篇：</p>
<ol>
<li>安装python</li>
<li>下载<a target="_blank" rel="noopener" href="https://github.com/google/protobuf/releases/download/v3.6.1/protoc-3.6.1-win32.zip">Protoc.exe</a>用于安装生成python版proto文件对应的解析所需文件</li>
<li>下载对应版本的<a target="_blank" rel="noopener" href="https://github.com/google/protobuf/releases/download/v3.6.1/protobuf-python-3.6.1.zip">Protobuf 3 Python版本</a>(这里我下的和Csharp版本的Protobuf3一样的版本3.6.1)</li>
<li>安装Protobuf 3 Python所需环境(在下载的Protobuf3 Python的Python原代码下运行python setup.py install)</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python setup.py install</span><br></pre></td></tr></table></figure>

<p>安装完成后会发现Protobuf 3 For Python相关的Package环境都被下载到了site-packages目录：<br><img src="/img/Unity/Data-Config-Automation/InstallProtobuf3EnviromentForPython.png" alt="Protobuf3ForPythonSetup"></p>
<ol start="5">
<li>编译Proto文件生成解析所需文件<br>依然使用protoc.exe，但这一次指定的输出代码是针对python的:</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">protoc.exe --python_out=PythonCode -I=Proto GameConfig.proto</span><br></pre></td></tr></table></figure>

<p>GameConfig_pb2.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Generated by the protocol buffer compiler.  DO NOT EDIT!</span></span><br><span class="line"><span class="comment"># source: GameConfig.proto</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">_b=sys.version_info[<span class="number">0</span>]&lt;<span class="number">3</span> <span class="keyword">and</span> (<span class="keyword">lambda</span> x:x) <span class="keyword">or</span> (<span class="keyword">lambda</span> x:x.encode(<span class="string">&#x27;latin1&#x27;</span>))</span><br><span class="line"><span class="keyword">from</span> google.protobuf <span class="keyword">import</span> descriptor <span class="keyword">as</span> _descriptor</span><br><span class="line"><span class="keyword">from</span> google.protobuf <span class="keyword">import</span> message <span class="keyword">as</span> _message</span><br><span class="line"><span class="keyword">from</span> google.protobuf <span class="keyword">import</span> reflection <span class="keyword">as</span> _reflection</span><br><span class="line"><span class="keyword">from</span> google.protobuf <span class="keyword">import</span> symbol_database <span class="keyword">as</span> _symbol_database</span><br><span class="line"><span class="comment"># @@protoc_insertion_point(imports)</span></span><br><span class="line"></span><br><span class="line">_sym_db = _symbol_database.Default()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">DESCRIPTOR = _descriptor.FileDescriptor(</span><br><span class="line">  name=<span class="string">&#x27;GameConfig.proto&#x27;</span>,</span><br><span class="line">  package=<span class="string">&#x27;GameData&#x27;</span>,</span><br><span class="line">  syntax=<span class="string">&#x27;proto3&#x27;</span>,</span><br><span class="line">  serialized_options=<span class="literal">None</span>,</span><br><span class="line">  serialized_pb=_b(<span class="string">&#x27;\n\x10GameConfig.proto\x12\x08GameData\&quot;T\n\nGameConfig\x12\x17\n\x0f\x64ifficultyLevel\x18\x01 \x01(\t\x12\x15\n\rversionNumber\x18\x02 \x01(\x05\x12\x16\n\x0eresourceNumber\x18\x03 \x01(\x05\x62\x06proto3&#x27;</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">_GAMECONFIG = _descriptor.Descriptor(</span><br><span class="line">  name=<span class="string">&#x27;GameConfig&#x27;</span>,</span><br><span class="line">  full_name=<span class="string">&#x27;GameData.GameConfig&#x27;</span>,</span><br><span class="line">  filename=<span class="literal">None</span>,</span><br><span class="line">  file=DESCRIPTOR,</span><br><span class="line">  containing_type=<span class="literal">None</span>,</span><br><span class="line">  fields=[</span><br><span class="line">    _descriptor.FieldDescriptor(</span><br><span class="line">      name=<span class="string">&#x27;difficultyLevel&#x27;</span>, full_name=<span class="string">&#x27;GameData.GameConfig.difficultyLevel&#x27;</span>, index=<span class="number">0</span>,</span><br><span class="line">      number=<span class="number">1</span>, <span class="built_in">type</span>=<span class="number">9</span>, cpp_type=<span class="number">9</span>, label=<span class="number">1</span>,</span><br><span class="line">      has_default_value=<span class="literal">False</span>, default_value=_b(<span class="string">&quot;&quot;</span>).decode(<span class="string">&#x27;utf-8&#x27;</span>),</span><br><span class="line">      message_type=<span class="literal">None</span>, enum_type=<span class="literal">None</span>, containing_type=<span class="literal">None</span>,</span><br><span class="line">      is_extension=<span class="literal">False</span>, extension_scope=<span class="literal">None</span>,</span><br><span class="line">      serialized_options=<span class="literal">None</span>, file=DESCRIPTOR),</span><br><span class="line">    _descriptor.FieldDescriptor(</span><br><span class="line">      name=<span class="string">&#x27;versionNumber&#x27;</span>, full_name=<span class="string">&#x27;GameData.GameConfig.versionNumber&#x27;</span>, index=<span class="number">1</span>,</span><br><span class="line">      number=<span class="number">2</span>, <span class="built_in">type</span>=<span class="number">5</span>, cpp_type=<span class="number">1</span>, label=<span class="number">1</span>,</span><br><span class="line">      has_default_value=<span class="literal">False</span>, default_value=<span class="number">0</span>,</span><br><span class="line">      message_type=<span class="literal">None</span>, enum_type=<span class="literal">None</span>, containing_type=<span class="literal">None</span>,</span><br><span class="line">      is_extension=<span class="literal">False</span>, extension_scope=<span class="literal">None</span>,</span><br><span class="line">      serialized_options=<span class="literal">None</span>, file=DESCRIPTOR),</span><br><span class="line">    _descriptor.FieldDescriptor(</span><br><span class="line">      name=<span class="string">&#x27;resourceNumber&#x27;</span>, full_name=<span class="string">&#x27;GameData.GameConfig.resourceNumber&#x27;</span>, index=<span class="number">2</span>,</span><br><span class="line">      number=<span class="number">3</span>, <span class="built_in">type</span>=<span class="number">5</span>, cpp_type=<span class="number">1</span>, label=<span class="number">1</span>,</span><br><span class="line">      has_default_value=<span class="literal">False</span>, default_value=<span class="number">0</span>,</span><br><span class="line">      message_type=<span class="literal">None</span>, enum_type=<span class="literal">None</span>, containing_type=<span class="literal">None</span>,</span><br><span class="line">      is_extension=<span class="literal">False</span>, extension_scope=<span class="literal">None</span>,</span><br><span class="line">      serialized_options=<span class="literal">None</span>, file=DESCRIPTOR),</span><br><span class="line">  ],</span><br><span class="line">  extensions=[</span><br><span class="line">  ],</span><br><span class="line">  nested_types=[],</span><br><span class="line">  enum_types=[</span><br><span class="line">  ],</span><br><span class="line">  serialized_options=<span class="literal">None</span>,</span><br><span class="line">  is_extendable=<span class="literal">False</span>,</span><br><span class="line">  syntax=<span class="string">&#x27;proto3&#x27;</span>,</span><br><span class="line">  extension_ranges=[],</span><br><span class="line">  oneofs=[</span><br><span class="line">  ],</span><br><span class="line">  serialized_start=<span class="number">30</span>,</span><br><span class="line">  serialized_end=<span class="number">114</span>,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">DESCRIPTOR.message_types_by_name[<span class="string">&#x27;GameConfig&#x27;</span>] = _GAMECONFIG</span><br><span class="line">_sym_db.RegisterFileDescriptor(DESCRIPTOR)</span><br><span class="line"></span><br><span class="line">GameConfig = _reflection.GeneratedProtocolMessageType(<span class="string">&#x27;GameConfig&#x27;</span>, (_message.Message,), <span class="built_in">dict</span>(</span><br><span class="line">  DESCRIPTOR = _GAMECONFIG,</span><br><span class="line">  __module__ = <span class="string">&#x27;GameConfig_pb2&#x27;</span></span><br><span class="line">  <span class="comment"># @@protoc_insertion_point(class_scope:GameData.GameConfig)</span></span><br><span class="line">  ))</span><br><span class="line">_sym_db.RegisterMessage(GameConfig)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># @@protoc_insertion_point(module_scope)</span></span><br></pre></td></tr></table></figure>

<ol start="6">
<li>利用Python的Proto代码序列化(或者反序列化C#序列化的)数据<br>反序列化C#序列化的数据事例：<br>GameConfigSerialization.py</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># File Name:        GameConfigSerialization.py</span></span><br><span class="line"><span class="comment"># Description:      This file is used to Serialize GameConfig Data</span></span><br><span class="line"><span class="comment"># Author:           TangHuan</span></span><br><span class="line"><span class="comment"># Create Date:      2018/08/20</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> GameConfig_pb2</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">gameconfig = GameConfig_pb2.GameConfig()</span><br><span class="line"></span><br><span class="line"><span class="comment"># Read the existing GameConfig.data</span></span><br><span class="line">f = <span class="built_in">open</span>(<span class="string">&quot;GameConfig.data&quot;</span>, <span class="string">&quot;rb&quot;</span>)</span><br><span class="line">gameconfig.ParseFromString(f.read())</span><br><span class="line">f.close()</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;gameconfig.difficultyLevel = &#123;&#125;&quot;</span>.<span class="built_in">format</span>(gameconfig.difficultyLevel))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;gameconfig.versionNumber = &#123;&#125;&quot;</span>.<span class="built_in">format</span>(gameconfig.versionNumber))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;gameconfig.resourceNumber = &#123;&#125;&quot;</span>.<span class="built_in">format</span>(gameconfig.resourceNumber))</span><br></pre></td></tr></table></figure>

<p><img src="/img/Unity/Data-Config-Automation/PythonPB3DeserilizationFileStructure.png" alt="PythonPB3DeserilizationFileStructure"><br><img src="/img/Unity/Data-Config-Automation/PythonPB3Deserialization.png" alt="PythonPB3Deserialization"><br>可以看到我们成功的反序列化了C#序列化的数据(*证明了PB3跨语言的序列化反序列化支持)</p>
<p>Python PB3序列化数据事例:<br>GameConfigSerialization.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># File Name:        GameConfigSerialization.py</span></span><br><span class="line"><span class="comment"># Description:      This file is used to Serialize GameConfig Data</span></span><br><span class="line"><span class="comment"># Author:           TangHuan</span></span><br><span class="line"><span class="comment"># Create Date:      2018/08/20</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> GameConfig_pb2</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">gameconfig = GameConfig_pb2.GameConfig()</span><br><span class="line">gameconfig.difficultyLevel = <span class="string">&quot;Hard&quot;</span></span><br><span class="line">gameconfig.versionNumber = <span class="number">2</span></span><br><span class="line">gameconfig.resourceNumber = <span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Write the new GmaeConfig back to disk.</span></span><br><span class="line">f = <span class="built_in">open</span>(<span class="string">&quot;GameConfig_Py.data&quot;</span>, <span class="string">&quot;wb&quot;</span>)</span><br><span class="line">f.write(gameconfig.SerializeToString())</span><br><span class="line">f.close()</span><br></pre></td></tr></table></figure>

<p>CSharp PB3反序列化:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GameConfig gameconfig;</span><br><span class="line"><span class="keyword">using</span> (<span class="keyword">var</span> intput = File.OpenRead(PathUtilities.ProtobufDataFolderPath + <span class="string">&quot;GameConfig_Py.data&quot;</span>))</span><br><span class="line">&#123;</span><br><span class="line">    gameconfig = GameConfig.Parser.ParseFrom(intput);</span><br><span class="line">&#125;</span><br><span class="line">Debug.Log(<span class="string">&quot;gameconfig.DifficultyLevel : &quot;</span> + gameconfig.DifficultyLevel);</span><br><span class="line">Debug.Log(<span class="string">&quot;gameconfig.VersionNumber : &quot;</span> + gameconfig.VersionNumber);</span><br><span class="line">Debug.Log(<span class="string">&quot;gameconfig.ResourceNumber : &quot;</span> + gameconfig.ResourceNumber);</span><br></pre></td></tr></table></figure>

<p><img src="/img/Unity/Data-Config-Automation/CSharpPB3DeserilizationFileStructure.png" alt="CSharpPB3DeserilizationFileStructure"><br><img src="/img/Unity/Data-Config-Automation/CSharpPB3Deserialization.png" alt="CSharpPB3Deserialization"><br>可以看到我们也成功的通过C#的PB3反序列化了Python序列化的数据。这也验证了Protocol Buffer 3<em>跨语言的特性</em>。</p>
<p>Note:<br>Protocol Buffer很适合跨平台跨语言通信，用于网络通信定义数据结构。(待学习)</p>
<h4 id="FlatBuff"><a href="#FlatBuff" class="headerlink" title="FlatBuff"></a>FlatBuff</h4><p>在介绍FlatBuff前，让我们来看一张令人惊艳的各序列化方案测试性能对比图：<br><a target="_blank" rel="noopener" href="https://github.com/CodeZeg/xbuffer">图1来源至XBuffer的性能测试</a>:<br><img src="/img/Unity/Data-Config-Automation/SerializationPerformanceComparision.png" alt="SerializationPerformanceComparision"></p>
<p><a target="_blank" rel="noopener" href="https://google.github.io/flatbuffers/flatbuffers_benchmarks.html">图2来源至FlatBuff官方性能Benchmark</a>:<br><img src="/img/Unity/Data-Config-Automation/FlatBuffPerformanceBenchmark.png" alt="FlatBuffPerformanceBenchmark"></p>
<p>从上面两张图可以看到，令人惊讶的FlatBuff性能，无论是序列化还是反序列化，FlatBuff都相当高效，反序列化的时间居然几乎为0。</p>
<p>接下来我们深入学习了解FlatBuff，洞察其中的奥妙。</p>
<h5 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h5><p><a target="_blank" rel="noopener" href="https://google.github.io/flatbuffers/">官网FlatBuffer</a><br><a href="google.github.io/flatbuffers">Represents hierachical data in a flat binary buffer in such a way that it can still be acecssed directly without parsing&#x2F;unpacking, while also still supporting data structure evolution(forwards&#x2F;backwards compatibility)</a><br>根据官方的介绍，FlatBuff把数据存储在一个扁平化的二进制Buffer里，这样一来FlatBuff访问和解析数据时可以向访问数据结构一样快速不需要解析或者解包(这应该就是为什么FlatBuff的反序列化时间几乎为0的原因)</p>
<p>这里简单列举下官方给出的FlatBuffer的好处:</p>
<ol>
<li>Access to serialized data without parsing&#x2F;unpacking(访问序列化数据块)</li>
<li>Memory efficiency and speed(内存和速度都很高效)</li>
<li>Flexible(向前向后兼容)</li>
<li>Tiny code footprint(生成代码量少且无依赖)</li>
<li>Strongly typed</li>
<li>Convenient to use(使用简单？)</li>
<li>Cross platform code with no dependencies(跨平台无依赖)</li>
</ol>
<p><a target="_blank" rel="noopener" href="https://google.github.io/flatbuffers/">详情参考官网介绍</a></p>
<h5 id="实战使用"><a href="#实战使用" class="headerlink" title="实战使用"></a>实战使用</h5><p>接下来先按教程学习使用一波，再来看看底层的实现和优缺点：<br>使用步骤：</p>
<ol>
<li>编写schema文件(定义数据结构)<br>GameConfigFB.fbs</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">namespace GameData;</span><br><span class="line"></span><br><span class="line">table GameConfigFB&#123;</span><br><span class="line">  difficultyLevel:string;           // 游戏难度</span><br><span class="line">  versionNumber:int;                // 游戏版本号</span><br><span class="line">  resourceNumber:int;               // 游戏资源版本号</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">root_type GameConfigFB;</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://google.github.io/flatbuffers/flatbuffers_guide_writing_schema.html">schema文件编写参考</a></p>
<ol start="2">
<li>使用Flatc.exe(可以自己编译源码，也可以<a target="_blank" rel="noopener" href="https://github.com/google/flatbuffers/releases">下载现成的</a>)编译解析schema文件生成序列化和反序列化数据所需代码</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./../flatc.exe --csharp .\GameConifgFB.fbs</span><br></pre></td></tr></table></figure>

<p>GameConfigFB.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// &lt;auto-generated&gt;</span></span><br><span class="line"><span class="comment">//  automatically generated by the FlatBuffers compiler, do not modify</span></span><br><span class="line"><span class="comment">// &lt;/auto-generated&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">GameData</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">global</span>::System;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">global</span>::FlatBuffers;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">struct</span> GameConfigFB : IFlatbufferObject</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">private</span> Table __p;</span><br><span class="line">  <span class="keyword">public</span> ByteBuffer ByteBuffer &#123; <span class="keyword">get</span> &#123; <span class="keyword">return</span> __p.bb; &#125; &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> GameConfigFB <span class="title">GetRootAsGameConfigFB</span>(<span class="params">ByteBuffer _bb</span>)</span> &#123; <span class="keyword">return</span> GetRootAsGameConfigFB(_bb, <span class="keyword">new</span> GameConfigFB()); &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> GameConfigFB <span class="title">GetRootAsGameConfigFB</span>(<span class="params">ByteBuffer _bb, GameConfigFB obj</span>)</span> &#123; <span class="keyword">return</span> (obj.__assign(_bb.GetInt(_bb.Position) + _bb.Position, _bb)); &#125;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> __init(<span class="built_in">int</span> _i, ByteBuffer _bb) &#123; __p.bb_pos = _i; __p.bb = _bb; &#125;</span><br><span class="line">  <span class="keyword">public</span> GameConfigFB __assign(<span class="built_in">int</span> _i, ByteBuffer _bb) &#123; __init(_i, _bb); <span class="keyword">return</span> <span class="keyword">this</span>; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="built_in">string</span> DifficultyLevel &#123; <span class="keyword">get</span> &#123; <span class="built_in">int</span> o = __p.__offset(<span class="number">4</span>); <span class="keyword">return</span> o != <span class="number">0</span> ? __p.__string(o + __p.bb_pos) : <span class="literal">null</span>; &#125; &#125;</span><br><span class="line">  <span class="keyword">public</span> ArraySegment&lt;<span class="built_in">byte</span>&gt;? GetDifficultyLevelBytes() &#123; <span class="keyword">return</span> __p.__vector_as_arraysegment(<span class="number">4</span>); &#125;</span><br><span class="line">  <span class="keyword">public</span> <span class="built_in">int</span> VersionNumber &#123; <span class="keyword">get</span> &#123; <span class="built_in">int</span> o = __p.__offset(<span class="number">6</span>); <span class="keyword">return</span> o != <span class="number">0</span> ? __p.bb.GetInt(o + __p.bb_pos) : (<span class="built_in">int</span>)<span class="number">0</span>; &#125; &#125;</span><br><span class="line">  <span class="keyword">public</span> <span class="built_in">int</span> ResourceNumber &#123; <span class="keyword">get</span> &#123; <span class="built_in">int</span> o = __p.__offset(<span class="number">8</span>); <span class="keyword">return</span> o != <span class="number">0</span> ? __p.bb.GetInt(o + __p.bb_pos) : (<span class="built_in">int</span>)<span class="number">0</span>; &#125; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Offset&lt;GameConfigFB&gt; <span class="title">CreateGameConfigFB</span>(<span class="params">FlatBufferBuilder builder,</span></span></span><br><span class="line"><span class="params"><span class="function">      StringOffset difficultyLevelOffset = <span class="literal">default</span>(StringOffset</span>),</span></span><br><span class="line"><span class="function">      <span class="built_in">int</span> versionNumber</span> = <span class="number">0</span>,</span><br><span class="line">      <span class="built_in">int</span> resourceNumber = <span class="number">0</span>) &#123;</span><br><span class="line">    builder.StartObject(<span class="number">3</span>);</span><br><span class="line">    GameConfigFB.AddResourceNumber(builder, resourceNumber);</span><br><span class="line">    GameConfigFB.AddVersionNumber(builder, versionNumber);</span><br><span class="line">    GameConfigFB.AddDifficultyLevel(builder, difficultyLevelOffset);</span><br><span class="line">    <span class="keyword">return</span> GameConfigFB.EndGameConfigFB(builder);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">StartGameConfigFB</span>(<span class="params">FlatBufferBuilder builder</span>)</span> &#123; builder.StartObject(<span class="number">3</span>); &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">AddDifficultyLevel</span>(<span class="params">FlatBufferBuilder builder, StringOffset difficultyLevelOffset</span>)</span> &#123; builder.AddOffset(<span class="number">0</span>, difficultyLevelOffset.Value, <span class="number">0</span>); &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">AddVersionNumber</span>(<span class="params">FlatBufferBuilder builder, <span class="built_in">int</span> versionNumber</span>)</span> &#123; builder.AddInt(<span class="number">1</span>, versionNumber, <span class="number">0</span>); &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">AddResourceNumber</span>(<span class="params">FlatBufferBuilder builder, <span class="built_in">int</span> resourceNumber</span>)</span> &#123; builder.AddInt(<span class="number">2</span>, resourceNumber, <span class="number">0</span>); &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Offset&lt;GameConfigFB&gt; <span class="title">EndGameConfigFB</span>(<span class="params">FlatBufferBuilder builder</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">int</span> o = builder.EndObject();</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Offset&lt;GameConfigFB&gt;(o);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">FinishGameConfigFBBuffer</span>(<span class="params">FlatBufferBuilder builder, Offset&lt;GameConfigFB&gt; offset</span>)</span> &#123; builder.Finish(offset.Value); &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">FinishSizePrefixedGameConfigFBBuffer</span>(<span class="params">FlatBufferBuilder builder, Offset&lt;GameConfigFB&gt; offset</span>)</span> &#123; builder.FinishSizePrefixed(offset.Value); &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>使用FlatBufferBuilder(位于FlatBuff源码的&#x2F;net&#x2F;FlatBuffers目录下)根据schema生成代码序列化数据到二进制文件</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> FlatBuffers;</span><br><span class="line"><span class="keyword">using</span> GameData;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">FlatBufferStudy</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> GameConfig数据全路径</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">const</span> <span class="built_in">string</span> GameConfigDataFullPath = <span class="string">&quot;./GameConfig.data&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 存储GameConfig数据</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">SaveGameConfigData</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// Create a `FlatBufferBuilder`, which will be used to create our</span></span><br><span class="line">            <span class="comment">// GameConfigFB&#x27; FlatBuffers.</span></span><br><span class="line">            <span class="comment">// 定义FlatBufferBulder对象用于我们构建数据对象</span></span><br><span class="line">            <span class="keyword">var</span> builder = <span class="keyword">new</span> FlatBufferBuilder(<span class="number">4</span>);</span><br><span class="line">            <span class="keyword">var</span> difficultylevel = builder.CreateString(<span class="string">&quot;Hard-困难&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Use the `CreateGameConfigFB()` helper function to create the GameConfigFB, since we set every field.</span></span><br><span class="line">            <span class="comment">// 往GameConfigFB里填充数据</span></span><br><span class="line">            <span class="keyword">var</span> gameconfig = GameConfigFB.CreateGameConfigFB(builder, difficultylevel, <span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Call `Finish()` to instruct the builder that this GameConfigFB is complete.</span></span><br><span class="line">            <span class="comment">// 指定GameConfigFB数据构建完成</span></span><br><span class="line">            builder.Finish(gameconfig.Value);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// This must be called after `Finish()`.</span></span><br><span class="line">            <span class="comment">// 包含GameConfigFB的二进制数据的数据对象</span></span><br><span class="line">            <span class="keyword">var</span> buf = builder.DataBuffer;</span><br><span class="line">            <span class="comment">// GameConfigFB的二进制数据</span></span><br><span class="line">            <span class="built_in">byte</span>[] bufbytes = builder.SizedByteArray();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//写入GameConfig二进制数据得到本地</span></span><br><span class="line">            <span class="keyword">using</span> (<span class="keyword">var</span> filestream = <span class="keyword">new</span> FileStream(GameConfigDataFullPath, FileMode.Create))</span><br><span class="line">            &#123;</span><br><span class="line">                filestream.Write(bufbytes, <span class="number">0</span>, bufbytes.Length);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 读取GameConfig数据</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ReadGameConfigData</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//写入GameConfig二进制数据得到本地</span></span><br><span class="line">            <span class="keyword">using</span> (<span class="keyword">var</span> filestream = <span class="keyword">new</span> FileStream(GameConfigDataFullPath, FileMode.Open))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">byte</span>[] bufbytes = <span class="keyword">new</span> <span class="built_in">byte</span>[filestream.Length];</span><br><span class="line">                filestream.Read(bufbytes, <span class="number">0</span>, bufbytes.Length);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Get an accessor to the root object inside the buffer.</span></span><br><span class="line">                <span class="comment">// 通过字节流数据构建FlatBuff所需的Buf对象，然后使用该Buf对象通过FlatBuff构建GameConfigFB对象</span></span><br><span class="line">                <span class="keyword">var</span> buf = <span class="keyword">new</span> ByteBuffer(bufbytes);</span><br><span class="line">                <span class="keyword">var</span> gameconfig = GameConfigFB.GetRootAsGameConfigFB(buf);</span><br><span class="line"></span><br><span class="line">                Console.WriteLine(<span class="string">&quot;gameconfig.DifficultyLevel : &quot;</span> + gameconfig.DifficultyLevel);</span><br><span class="line">                Console.WriteLine(<span class="string">&quot;gameconfig.VersionNumber : &quot;</span> + gameconfig.VersionNumber);</span><br><span class="line">                Console.WriteLine(<span class="string">&quot;gameconfig.ResourceNumber : &quot;</span> + gameconfig.ResourceNumber);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] <span class="keyword">args</span></span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            SaveGameConfigData();</span><br><span class="line"></span><br><span class="line">            ReadGameConfigData();</span><br><span class="line"></span><br><span class="line">            Console.WriteLine(<span class="string">&quot;结束!&quot;</span>);</span><br><span class="line"></span><br><span class="line">            Console.ReadKey();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/img/Unity/Data-Config-Automation/FlatBuffGameConfigDataOutput.png" alt="FlatBuffGameConfigDataOutput"><br><img src="/img/Unity/Data-Config-Automation/FlatBuffOutput.png" alt="FlatBuffOutput"><br>可以看到我们成功通过FlatBuff序列化反序列化出了我们想要的数据。</p>
<p>通过上面的使用，可以看出FlatBuff在使用灵活度方面还是比较欠缺，对于数据的填充构建都是通过FlatBufferBuilder按指定填充方式构建数据并填充进去。</p>
<p>这里暂时没有对性能进行测试，具体性能对比参考前面给出过的对比图。</p>
<p>Note：<br>当我把FlatBuffer的.Net代码放进Unity时，我发现里面用到了C# 6.0的高阶语言特性，导致Unity里无法编译通过，所以上面的测试是脱离Unity基于.Net C#工程来测试的。</p>
<h5 id="深入探究"><a href="#深入探究" class="headerlink" title="深入探究"></a>深入探究</h5><p>这一步，让我们结合上面的学习用例来探究下FlatBuffer是如何实现高效的序列化和反序列化读取的。</p>
<p>通过学习了解FlatBuffer下面几个核心的类来理解学习:</p>
<ol>
<li>FlatBufferBuilder.cs(FlatBuffer构建填充数据的对外接口)</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Responsible for building up and accessing a FlatBuffer formatted byte</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> array (via ByteBuffer).</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">FlatBufferBuilder</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span> _space;</span><br><span class="line">    <span class="keyword">private</span> ByteBuffer _bb;</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span> _minAlign = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The vtable for the current table (if _vtableSize &gt;= 0)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span>[] _vtable = <span class="keyword">new</span> <span class="built_in">int</span>[<span class="number">16</span>];</span><br><span class="line">    <span class="comment">// The size of the vtable. -1 indicates no vtable</span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span> _vtableSize = <span class="number">-1</span>;</span><br><span class="line">    <span class="comment">// Starting offset of the current struct/table.</span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span> _objectStart;</span><br><span class="line">    <span class="comment">// List of offsets of all vtables.</span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span>[] _vtables = <span class="keyword">new</span> <span class="built_in">int</span>[<span class="number">16</span>];</span><br><span class="line">    <span class="comment">// Number of entries in `vtables` in use.</span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span> _numVtables = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// For the current vector being built.</span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span> _vectorNumElems = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Create a FlatBufferBuilder with a given initial size.</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;initialSize&quot;&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> The initial size to use for the internal buffer.</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">FlatBufferBuilder</span>(<span class="params"><span class="built_in">int</span> initialSize</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (initialSize &lt;= <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentOutOfRangeException(<span class="string">&quot;initialSize&quot;</span>,</span><br><span class="line">                initialSize, <span class="string">&quot;Must be greater than zero&quot;</span>);</span><br><span class="line">        _space = initialSize;</span><br><span class="line">        _bb = <span class="keyword">new</span> ByteBuffer(initialSize);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">AddInt</span>(<span class="params"><span class="built_in">int</span> o, <span class="built_in">int</span> x, <span class="built_in">int</span> d</span>)</span> </span><br><span class="line">    &#123; </span><br><span class="line">        <span class="keyword">if</span> (ForceDefaults || x != d) </span><br><span class="line">        &#123; </span><br><span class="line">            AddInt(x); Slot(o); </span><br><span class="line">        &#125; </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<pre><code>这里只截图了FlatBufferBuilder成员变量定义和部分函数定义。
</code></pre>
<ol start="2">
<li>ByteBuffer.cs(定义不同数据类型的byte数据分配以及填充，读取)</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ByteBuffer</span> : <span class="title">IDisposable</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> ByteBufferAllocator _buffer;</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span> _pos;  <span class="comment">// Must track start of the buffer.</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ByteBuffer</span>(<span class="params">ByteBufferAllocator allocator, <span class="built_in">int</span> position</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        _buffer = allocator;</span><br><span class="line">        _pos = position;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ByteBuffer</span>(<span class="params"><span class="built_in">int</span> size</span>) : <span class="title">this</span>(<span class="params"><span class="keyword">new</span> <span class="built_in">byte</span>[size]</span>)</span> &#123; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ByteBuffer</span>(<span class="params"><span class="built_in">byte</span>[] buffer</span>) : <span class="title">this</span>(<span class="params">buffer, <span class="number">0</span></span>)</span> &#123; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ByteBuffer</span>(<span class="params"><span class="built_in">byte</span>[] buffer, <span class="built_in">int</span> pos</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        _buffer = <span class="keyword">new</span> ByteArrayAllocator(buffer);</span><br><span class="line">        _pos = pos;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Dispose</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (_buffer != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            _buffer.Dispose();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> Position &#123;</span><br><span class="line">        <span class="keyword">get</span> &#123; <span class="keyword">return</span> _pos; &#125;</span><br><span class="line">        <span class="keyword">set</span> &#123; _pos = <span class="keyword">value</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> Length &#123; <span class="keyword">get</span> &#123; <span class="keyword">return</span> _buffer.Length; &#125; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Reset</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        _pos = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Increases the size of the ByteBuffer, and copies the old data towards</span></span><br><span class="line">    <span class="comment">// the end of the new buffer.</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">GrowFront</span>(<span class="params"><span class="built_in">int</span> newSize</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        _buffer.GrowFront(newSize);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">PutStringUTF8</span>(<span class="params"><span class="built_in">int</span> offset, <span class="built_in">string</span> <span class="keyword">value</span></span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        AssertOffsetAndLength(offset, <span class="keyword">value</span>.Length);</span><br><span class="line">        Encoding.UTF8.GetBytes(<span class="keyword">value</span>, <span class="number">0</span>, <span class="keyword">value</span>.Length,</span><br><span class="line">            _buffer.ByteArray, offset);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">PutInt</span>(<span class="params"><span class="built_in">int</span> offset, <span class="built_in">int</span> <span class="keyword">value</span></span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        PutUint(offset, (<span class="built_in">uint</span>)<span class="keyword">value</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">WriteLittleEndian</span>(<span class="params"><span class="built_in">int</span> offset, <span class="built_in">int</span> count, <span class="built_in">ulong</span> data</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (BitConverter.IsLittleEndian)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; count; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                _buffer.Buffer[offset + i] = (<span class="built_in">byte</span>)(data &gt;&gt; i * <span class="number">8</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; count; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                _buffer.Buffer[offset + count - <span class="number">1</span> - i] = (<span class="built_in">byte</span>)(data &gt;&gt; i * <span class="number">8</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>ByteBufferAllocator.cs(抽象二进制byte数据的分配管理)</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title">ByteBufferAllocator</span> : <span class="title">IDisposable</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> UNSAFE_BYTEBUFFER</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">unsafe</span> <span class="built_in">byte</span>* Buffer</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">byte</span>[] Buffer</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> Length</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">Dispose</span>()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">GrowFront</span>(<span class="params"><span class="built_in">int</span> newSize</span>)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> !ENABLE_SPAN_T</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="built_in">byte</span>[] ByteArray &#123; <span class="keyword">get</span>; &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>Table.cs(抽象FlatBuffer自定义结构的数据存储以及读取)</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">struct</span> Table</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> bb_pos;</span><br><span class="line">    <span class="keyword">public</span> ByteBuffer bb;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> ByteBuffer ByteBuffer &#123; <span class="keyword">get</span> &#123; <span class="keyword">return</span> bb; &#125; &#125;</span><br><span class="line"></span><br><span class="line">    *******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>数据序列化存储部分：<br>可以看出我们所有的数据最终都被写入在一个一维的byte数组里，而Flatbuffer通过按指定方式往byte数组里填充数据实现对数据的序列化存储。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">FlatBufferBuilder</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> ByteBuffer _bb;</span><br><span class="line"></span><br><span class="line">    *******</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ByteBuffer</span> : <span class="title">IDisposable</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> ByteBufferAllocator _buffer;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">PutStringUTF8</span>(<span class="params"><span class="built_in">int</span> offset, <span class="built_in">string</span> <span class="keyword">value</span></span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        ******</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">PutInt</span>(<span class="params"><span class="built_in">int</span> offset, <span class="built_in">int</span> <span class="keyword">value</span></span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        PutUint(offset, (<span class="built_in">uint</span>)<span class="keyword">value</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">WriteLittleEndian</span>(<span class="params"><span class="built_in">int</span> offset, <span class="built_in">int</span> count, <span class="built_in">ulong</span> data</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        ******</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ByteArrayAllocator</span> : <span class="title">ByteBufferAllocator</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">byte</span>[] _buffer;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">GrowFront</span>(<span class="params"><span class="built_in">int</span> newSize</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        _buffer.GrowFront(newSize);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>数据反序列化读取部分；</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">struct</span> GameConfigFB : IFlatbufferObject</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> Table __p;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> ByteBuffer ByteBuffer </span><br><span class="line">    &#123; </span><br><span class="line">      <span class="keyword">get</span> &#123; <span class="keyword">return</span> __p.bb; &#125; </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> GameConfigFB <span class="title">GetRootAsGameConfigFB</span>(<span class="params">ByteBuffer _bb</span>)</span> </span><br><span class="line">    &#123; </span><br><span class="line">       <span class="keyword">return</span> GetRootAsGameConfigFB(_bb, <span class="keyword">new</span> GameConfigFB()); </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> GameConfigFB <span class="title">GetRootAsGameConfigFB</span>(<span class="params">ByteBuffer _bb, GameConfigFB obj</span>)</span> </span><br><span class="line">    &#123; </span><br><span class="line">        <span class="keyword">return</span> (obj.__assign(_bb.GetInt(_bb.Position) + _bb.Position, _bb)); </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> __init(<span class="built_in">int</span> _i, ByteBuffer _bb) </span><br><span class="line">    &#123; </span><br><span class="line">        __p.bb_pos = _i; __p.bb = _bb; </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> GameConfigFB __assign(<span class="built_in">int</span> _i, ByteBuffer _bb) </span><br><span class="line">    &#123; </span><br><span class="line">        __init(_i, _bb); <span class="keyword">return</span> <span class="keyword">this</span>; </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> DifficultyLevel </span><br><span class="line">    &#123; </span><br><span class="line">        <span class="keyword">get</span> &#123; <span class="built_in">int</span> o = __p.__offset(<span class="number">4</span>); <span class="keyword">return</span> o != <span class="number">0</span> ? __p.__string(o + __p.bb_pos) : <span class="literal">null</span>; &#125; </span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    </span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到当我们通过以下代码读取二进制数据构建我们自定义的GameConfigFB对象时,我们已经把二进制数据按FlatBuffer存储的方式读取进来:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> buf = <span class="keyword">new</span> ByteBuffer(bufbytes);</span><br><span class="line"><span class="keyword">var</span> gameconfig = GameConfigFB.GetRootAsGameConfigFB(buf);</span><br></pre></td></tr></table></figure>

<p>然后通过Table按自定义的数据结构读取指定的偏移把数据成功读取出来(这应该也是为什么FlatBuffer反序列化读取能这么高效的原因):</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">struct</span> GameConfigFB : IFlatbufferObject</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> ArraySegment&lt;<span class="built_in">byte</span>&gt;? GetDifficultyLevelBytes() </span><br><span class="line">    &#123; </span><br><span class="line">        <span class="keyword">return</span> __p.__vector_as_arraysegment(<span class="number">4</span>); </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> VersionNumber </span><br><span class="line">    &#123; </span><br><span class="line">        <span class="keyword">get</span> &#123; <span class="built_in">int</span> o = __p.__offset(<span class="number">6</span>); <span class="keyword">return</span> o != <span class="number">0</span> ? __p.bb.GetInt(o + __p.bb_pos) : (<span class="built_in">int</span>)<span class="number">0</span>; &#125; </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> ResourceNumber </span><br><span class="line">    &#123; </span><br><span class="line">        <span class="keyword">get</span> &#123; <span class="built_in">int</span> o = __p.__offset(<span class="number">8</span>); <span class="keyword">return</span> o != <span class="number">0</span> ? __p.bb.GetInt(o + __p.bb_pos) : (<span class="built_in">int</span>)<span class="number">0</span>; &#125; </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里放一张其他博客上给出的一张FlatBuffer数据存储图解加深印象，<a target="_blank" rel="noopener" href="https://www.race604.com/flatbuffers-intro/">下图来源</a>:<br><img src="/img/Unity/Data-Config-Automation/FlatBufferBytesStructure.png" alt="FlatBufferBytesStructure"></p>
<h4 id="Xbuffer"><a href="#Xbuffer" class="headerlink" title="Xbuffer"></a>Xbuffer</h4><p>公司一前同事写的基于C#的简化版的Flatbuffer。<br>这里重复再放一次前面放过的性能对比图：<br><img src="/img/Unity/Data-Config-Automation/SerializationPerformanceComparision.png" alt="SerializationPerformanceComparision"><br>可以看到Xbuffer序列化和反序列化性能也相当优秀。</p>
<p>接下来我们通过实战使用和深入探究来学习其中的奥妙。</p>
<h5 id="实战使用-1"><a href="#实战使用-1" class="headerlink" title="实战使用"></a>实战使用</h5><p>使用流程：</p>
<ol>
<li>定义数据结构文件<br>GameConfigXB.xb</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">// 游戏版本信息</span><br><span class="line">class GameConfigXB</span><br><span class="line">&#123;</span><br><span class="line">    difficultyLevel:string;             // 游戏难度</span><br><span class="line">    versionNumber:int;                  // 游戏版本号</span><br><span class="line">    resourceNumber:int;                 // 游戏资源版本号</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>使用xbuffer_parser.exe根据模板文件解析数据结构文件生成对应类文件以及对应类Xbuffer序列化反序列化所需的代码</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">xbuffer_parser.exe input=GameConfigXB.xb template=&quot;templates/csharp_class.ftl&quot; output_dir=&quot;output/csharp/csharp_class/&quot; suffix=&quot;.cs&quot;</span><br><span class="line">xbuffer_parser.exe input=GameConfigXB.xb template=&quot;templates/csharp_buffer.ftl&quot; output_dir=&quot;output/csharp/csharp_buffer/&quot; suffix=&quot;Buffer.cs&quot;</span><br><span class="line">pause</span><br></pre></td></tr></table></figure>

<p>GameConfigXB.cs(对应数据结构文件)</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 游戏版本信息</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">partial</span> <span class="keyword">class</span> <span class="title">GameConfigXB</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> difficultyLevel;              <span class="comment">// 游戏难度</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> versionNumber;               <span class="comment">// 游戏版本号</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> resourceNumber;              <span class="comment">// 游戏资源版本号</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>GameConfigXBBuffer.cs(对应数据结构Xbuffer序列化反序列化所需文件)</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">xbuffer</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">GameConfigXBBuffer</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> GameConfigXB <span class="title">deserialize</span>(<span class="params"><span class="built_in">byte</span>[] buffer, <span class="keyword">ref</span> <span class="built_in">int</span> offset</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// null</span></span><br><span class="line">            <span class="built_in">bool</span> _null = boolBuffer.deserialize(buffer, <span class="keyword">ref</span> offset);</span><br><span class="line">            <span class="keyword">if</span> (_null) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// difficultyLevel</span></span><br><span class="line"></span><br><span class="line">            <span class="built_in">string</span> _difficultyLevel = stringBuffer.deserialize(buffer, <span class="keyword">ref</span> offset);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// versionNumber</span></span><br><span class="line">            <span class="built_in">int</span> _versionNumber = intBuffer.deserialize(buffer, <span class="keyword">ref</span> offset);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// resourceNumber</span></span><br><span class="line">            <span class="built_in">int</span> _resourceNumber = intBuffer.deserialize(buffer, <span class="keyword">ref</span> offset);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// value</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> GameConfigXB() &#123;</span><br><span class="line">                difficultyLevel = _difficultyLevel,</span><br><span class="line"></span><br><span class="line">                versionNumber = _versionNumber,</span><br><span class="line"></span><br><span class="line">                resourceNumber = _resourceNumber,</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">serialize</span>(<span class="params">GameConfigXB <span class="keyword">value</span>, XSteam steam</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// null</span></span><br><span class="line">            boolBuffer.serialize(<span class="keyword">value</span> == <span class="literal">null</span>, steam);</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">value</span> == <span class="literal">null</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// difficultyLevel</span></span><br><span class="line">            stringBuffer.serialize(<span class="keyword">value</span>.difficultyLevel, steam);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// versionNumber</span></span><br><span class="line">            intBuffer.serialize(<span class="keyword">value</span>.versionNumber, steam);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// resourceNumber</span></span><br><span class="line">            intBuffer.serialize(<span class="keyword">value</span>.resourceNumber, steam);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面生成默认的模板生成的GameConfigXBBuffer.cs貌似跟源码测试使用的接口对不上，需要把模板改成如下:<br>charp_buffer.ftl</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">namespace xbuffer</span><br><span class="line">&#123;</span><br><span class="line">    public static class #CLASS_NAME#Buffer</span><br><span class="line">    &#123;</span><br><span class="line">        public static #CLASS_NAME# deserialize(byte[] buffer, ref uint offset)</span><br><span class="line">        &#123;</span><br><span class="line">#IF_DESERIALIZE_CLASS#</span><br><span class="line">            // null</span><br><span class="line">            bool _null = boolBuffer.deserialize(buffer, ref offset);</span><br><span class="line">            if (_null) return null;</span><br><span class="line">#END_DESERIALIZE_CLASS#</span><br><span class="line">#DESERIALIZE_PROCESS#</span><br><span class="line">            // #VAR_NAME#</span><br><span class="line">#IF_SINGLE#</span><br><span class="line">            #VAR_TYPE# _#VAR_NAME# = #VAR_TYPE#Buffer.deserialize(buffer, ref offset);</span><br><span class="line">#END_SINGLE#</span><br><span class="line">#IF_ARRAY#</span><br><span class="line">            int _#VAR_NAME#_length = intBuffer.deserialize(buffer, ref offset);</span><br><span class="line">            #VAR_TYPE#[] _#VAR_NAME# = new #VAR_TYPE#[_#VAR_NAME#_length];</span><br><span class="line">            for (int i = 0; i &lt; _#VAR_NAME#_length; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                _#VAR_NAME#[i] = #VAR_TYPE#Buffer.deserialize(buffer, ref offset);</span><br><span class="line">            &#125;</span><br><span class="line">#END_ARRAY#</span><br><span class="line">#DESERIALIZE_PROCESS#</span><br><span class="line"></span><br><span class="line">            // value</span><br><span class="line">            return new #CLASS_NAME#() &#123;</span><br><span class="line">#DESERIALIZE_RETURN#</span><br><span class="line">                #VAR_NAME# = _#VAR_NAME#,</span><br><span class="line">#DESERIALIZE_RETURN#</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public static void serialize(#CLASS_NAME# value, XSteam steam)</span><br><span class="line">        &#123;</span><br><span class="line">#IF_SERIALIZE_CLASS#</span><br><span class="line">            // null</span><br><span class="line">            boolBuffer.serialize(value == null, steam);</span><br><span class="line">            if (value == null) return;</span><br><span class="line">#END_SERIALIZE_CLASS#</span><br><span class="line">#SERIALIZE_PROCESS#</span><br><span class="line">            // #VAR_NAME#</span><br><span class="line">#IF_SINGLE#</span><br><span class="line">            #VAR_TYPE#Buffer.serialize(value.#VAR_NAME#, steam);</span><br><span class="line">#END_SINGLE#</span><br><span class="line">#IF_ARRAY#</span><br><span class="line">            intBuffer.serialize(value.#VAR_NAME#.Length, steam);</span><br><span class="line">            for (int i = 0; i &lt; value.#VAR_NAME#.Length; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                #VAR_TYPE#Buffer.serialize(value.#VAR_NAME#[i], steam);</span><br><span class="line">            &#125;</span><br><span class="line">#END_ARRAY#</span><br><span class="line">#SERIALIZE_PROCESS#</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>把Xbuffer核心代码xbuffer_runtime.dll放到项目目录下。</li>
<li>使用Xbuffer生成的对应Buffer类序列化和反序列化数据</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             UIDebugMonoScript.cs</span></span><br><span class="line"><span class="comment"> * Author:                  TONYTANG</span></span><br><span class="line"><span class="comment"> * Create Date:             2018/08/19</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> GameData;</span><br><span class="line"><span class="keyword">using</span> Google.Protobuf;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> UnityEngine.UI;</span><br><span class="line"><span class="keyword">using</span> xbuffer;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> UIDebugMonoScript.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 快速访问UI组件测试挂在脚本</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UIDebugMonoScript</span> : <span class="title">MonoBehaviour</span> &#123;</span><br><span class="line"></span><br><span class="line">    ******</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Xbuffer内存存储抽象对象</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> XSteam mXbufferStream;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 创建GameConfig按钮点击</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onCreateGameConfigClick</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        Debug.Log(<span class="string">&quot;onCreateGameConfigClick()&quot;</span>);</span><br><span class="line">        Debug.Log(<span class="string">&quot;PathUtilities.XbufferDataFolderPath : &quot;</span> + PathUtilities.XbufferDataFolderPath);</span><br><span class="line">        PathUtilities.checkAndCreateFolder(PathUtilities.XbufferDataFolderPath);</span><br><span class="line">        <span class="comment">//固定一个内存分配，把数据往这里面填充，不够的画动态扩展</span></span><br><span class="line">        mXbufferStream = <span class="keyword">new</span> XSteam(<span class="number">1</span>, <span class="number">1024</span> * <span class="number">1024</span> * <span class="number">1000</span>);</span><br><span class="line">        GameConfigXB gameconfigxb = <span class="keyword">new</span> GameConfigXB();</span><br><span class="line">        gameconfigxb.difficultyLevel = <span class="string">&quot;Hard&quot;</span>;</span><br><span class="line">        gameconfigxb.versionNumber = <span class="number">1</span>;</span><br><span class="line">        gameconfigxb.resourceNumber = <span class="number">1</span>;</span><br><span class="line">        GameConfigXBBuffer.serialize(gameconfigxb, mXbufferStream);</span><br><span class="line">        <span class="keyword">var</span> bytes = mXbufferStream.getBytes();</span><br><span class="line">        <span class="keyword">using</span> (<span class="keyword">var</span> output = File.Create(PathUtilities.XbufferDataFolderPath + <span class="string">&quot;GameConfigXB.data&quot;</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            output.Write(bytes, <span class="number">0</span>, bytes.Length);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 读取GameConfig按钮点击</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onReadGameConfigClick</span>()</span> </span><br><span class="line">    &#123;</span><br><span class="line">        Debug.Log(<span class="string">&quot;onReadGameConfigClick()&quot;</span>);</span><br><span class="line">        Debug.Log(<span class="string">&quot;PathUtilities.XbufferDataFolderPath : &quot;</span> + PathUtilities.XbufferDataFolderPath);</span><br><span class="line">        <span class="keyword">using</span> (<span class="keyword">var</span> intput = File.OpenRead(PathUtilities.XbufferDataFolderPath + <span class="string">&quot;GameConfigXB.data&quot;</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> bytes = <span class="keyword">new</span> <span class="built_in">byte</span>[intput.Length];</span><br><span class="line">            intput.Read(bytes, <span class="number">0</span>, bytes.Length);</span><br><span class="line">            <span class="built_in">uint</span> offset = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">var</span> gameconfig = GameConfigXBBuffer.deserialize(bytes, <span class="keyword">ref</span> offset);</span><br><span class="line">            Debug.Log(<span class="string">&quot;gameconfig.difficultyLevel : &quot;</span> + gameconfig.difficultyLevel);</span><br><span class="line">            Debug.Log(<span class="string">&quot;gameconfig.versionNumber : &quot;</span> + gameconfig.versionNumber);</span><br><span class="line">            Debug.Log(<span class="string">&quot;gameconfig.resourceNumber : &quot;</span> + gameconfig.resourceNumber);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/img/Unity/Data-Config-Automation/XbufferData.png" alt="XbufferData"><br><img src="/img/Unity/Data-Config-Automation/XbufferOutput.png" alt="XbufferOutput"><br>可以看到我们成功通过Xbuffer序列化反序列了数据。</p>
<h5 id="深入探究-1"><a href="#深入探究-1" class="headerlink" title="深入探究"></a>深入探究</h5><p>接下来结合源码，让我们深入Xbuffer内部去看看是如何实现高效的序列化和反序列以及挂镀可配置的。<br>Xbuffer提供了一下两个核心的部件：</p>
<ol>
<li>xbuffe_parser.exe</li>
<li>xbuffer_runtime.dll</li>
</ol>
<h6 id="xbuffer-parser"><a href="#xbuffer-parser" class="headerlink" title="xbuffer_parser"></a>xbuffer_parser</h6><p>xbuffer_parser负责根据模板自动化生成对应类以及Xbuffer序列化反序列化所需文件代码。</p>
<ol>
<li>Config.cs(负责参数的检查 – 这个就不详细介绍了)</li>
<li>Proto.cs(抽象数据结构文件的各个组成部分)</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * File Name:               Proto.cs</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Description:             原型语法解析工具</span></span><br><span class="line"><span class="comment"> * Author:                  lisiyu &lt;576603306@qq.com&gt;</span></span><br><span class="line"><span class="comment"> * Create Date:             2017/10/25</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System.Text.RegularExpressions;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">xbuffer</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Proto</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> Proto_Class[] class_protos;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Proto</span>(<span class="params"><span class="built_in">string</span> proto</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> matchs = Regex.Matches(proto, <span class="string">@&quot;//\s*(\S*)\s*((class)|(struct))\s*(\w+)\s*&#123;\s*((\w+):([\[|\]|\w]+);\s*//\s*(\S*)\s*)*&#125;&quot;</span>);</span><br><span class="line">            class_protos = <span class="keyword">new</span> Proto_Class[matchs.Count];</span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; matchs.Count; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                class_protos[i] = <span class="keyword">new</span> Proto_Class(matchs[i]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 变量结构</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Proto_Variable</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> Var_Type;                             <span class="comment">// 变量类型</span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> Var_Name;                             <span class="comment">// 变量名</span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">bool</span> IsArray;                                <span class="comment">// 是否是数组</span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> Var_Comment;                          <span class="comment">// 变量注释</span></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Proto_Variable</span>(<span class="params"><span class="built_in">string</span> name, <span class="built_in">string</span> type, <span class="built_in">string</span> comment</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            Var_Name = name;</span><br><span class="line">            <span class="keyword">if</span> (type.Contains(<span class="string">&quot;[&quot;</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                Var_Type = type.Substring(<span class="number">1</span>, type.Length - <span class="number">2</span>);</span><br><span class="line">                IsArray = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                Var_Type = type;</span><br><span class="line">                IsArray = <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            Var_Comment = comment;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 类结构</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Proto_Class</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> Class_Comment;                            <span class="comment">// 注释</span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> Class_Type;                               <span class="comment">// 类型 例如 class struct</span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> Class_Name;                               <span class="comment">// 类名</span></span><br><span class="line">        <span class="keyword">public</span> Proto_Variable[] Class_Variables;                <span class="comment">// 变量列表</span></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Proto_Class</span>(<span class="params">Match match</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            Class_Comment = match.Groups[<span class="number">1</span>].Value;</span><br><span class="line">            Class_Type = match.Groups[<span class="number">2</span>].Value;</span><br><span class="line">            Class_Name = match.Groups[<span class="number">5</span>].Value;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> varNames = match.Groups[<span class="number">7</span>].Captures;</span><br><span class="line">            <span class="keyword">var</span> varTypes = match.Groups[<span class="number">8</span>].Captures;</span><br><span class="line">            <span class="keyword">var</span> varComments = match.Groups[<span class="number">9</span>].Captures;</span><br><span class="line">            Class_Variables = <span class="keyword">new</span> Proto_Variable[varNames.Count];</span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; Class_Variables.Length; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                Class_Variables[i] = <span class="keyword">new</span> Proto_Variable(varNames[i].Value, varTypes[i].Value, varComments[i].Value);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<pre><code>核心思想是通过正则匹配文本内容后，分别将对应内容填充到抽象的Proto类对象里。
</code></pre>
<ol start="3">
<li>Parser.cs(负责将抽象后的数据结构数据结合模板文件转换成对应代码) &amp; Xtemplate.cs(负责模板与代码生成部分的逻辑处理)</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * File Name:               Parser.cs</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Description:             将类对象转化成代码文本</span></span><br><span class="line"><span class="comment"> * Author:                  lisiyu &lt;576603306@qq.com&gt;</span></span><br><span class="line"><span class="comment"> * Create Date:             2017/10/25</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">xbuffer</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Parser</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 将类对象转化成代码文本</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;proto_class&quot;&gt;</span>类结构<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;template_str&quot;&gt;</span>模板文本<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">string</span> <span class="title">parse</span>(<span class="params">Proto_Class proto_class, <span class="built_in">string</span> template_str, <span class="built_in">bool</span> showHead</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> template = <span class="keyword">new</span> XTemplate(template_str);</span><br><span class="line"></span><br><span class="line">            template.setCondition(<span class="string">&quot;HEAD&quot;</span>, showHead);</span><br><span class="line">            template.setValue(<span class="string">&quot;#CLASS_TYPE#&quot;</span>, proto_class.Class_Type);</span><br><span class="line">            template.setValue(<span class="string">&quot;#CLASS_NAME#&quot;</span>, proto_class.Class_Name);</span><br><span class="line">            template.setValue(<span class="string">&quot;#CLASS_COMMENT#&quot;</span>, proto_class.Class_Comment);</span><br><span class="line"></span><br><span class="line">            template.setCondition(<span class="string">&quot;DESERIALIZE_CLASS&quot;</span>, proto_class.Class_Type == <span class="string">&quot;class&quot;</span>);</span><br><span class="line">            template.setCondition(<span class="string">&quot;SERIALIZE_CLASS&quot;</span>, proto_class.Class_Type == <span class="string">&quot;class&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (template.beginLoop(<span class="string">&quot;#VARIABLES#&quot;</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">foreach</span> (<span class="keyword">var</span> item <span class="keyword">in</span> proto_class.Class_Variables)</span><br><span class="line">                &#123;</span><br><span class="line">                    template.setCondition(<span class="string">&quot;SINGLE&quot;</span>, !item.IsArray);</span><br><span class="line">                    template.setCondition(<span class="string">&quot;ARRAY&quot;</span>, item.IsArray);</span><br><span class="line">                    template.setValue(<span class="string">&quot;#VAR_TYPE#&quot;</span>, item.Var_Type);</span><br><span class="line">                    template.setValue(<span class="string">&quot;#VAR_NAME#&quot;</span>, item.Var_Name);</span><br><span class="line">                    template.setValue(<span class="string">&quot;#VAR_COMMENT#&quot;</span>, item.Var_Comment);</span><br><span class="line">                    template.nextLoop();</span><br><span class="line">                &#125;</span><br><span class="line">                template.endLoop();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (template.beginLoop(<span class="string">&quot;#DESERIALIZE_PROCESS#&quot;</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">foreach</span> (<span class="keyword">var</span> item <span class="keyword">in</span> proto_class.Class_Variables)</span><br><span class="line">                &#123;</span><br><span class="line">                    template.setCondition(<span class="string">&quot;SINGLE&quot;</span>, !item.IsArray);</span><br><span class="line">                    template.setCondition(<span class="string">&quot;ARRAY&quot;</span>, item.IsArray);</span><br><span class="line">                    template.setValue(<span class="string">&quot;#VAR_TYPE#&quot;</span>, item.Var_Type);</span><br><span class="line">                    template.setValue(<span class="string">&quot;#VAR_NAME#&quot;</span>, item.Var_Name);</span><br><span class="line">                    template.setValue(<span class="string">&quot;#VAR_COMMENT#&quot;</span>, item.Var_Comment);</span><br><span class="line">                    template.nextLoop();</span><br><span class="line">                &#125;</span><br><span class="line">                template.endLoop();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (template.beginLoop(<span class="string">&quot;#DESERIALIZE_RETURN#&quot;</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">foreach</span> (<span class="keyword">var</span> item <span class="keyword">in</span> proto_class.Class_Variables)</span><br><span class="line">                &#123;</span><br><span class="line">                    template.setValue(<span class="string">&quot;#VAR_TYPE#&quot;</span>, item.Var_Type);</span><br><span class="line">                    template.setValue(<span class="string">&quot;#VAR_NAME#&quot;</span>, item.Var_Name);</span><br><span class="line">                    template.setValue(<span class="string">&quot;#VAR_COMMENT#&quot;</span>, item.Var_Comment);</span><br><span class="line">                    template.nextLoop();</span><br><span class="line">                &#125;</span><br><span class="line">                template.endLoop();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (template.beginLoop(<span class="string">&quot;#SERIALIZE_PROCESS#&quot;</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">foreach</span> (<span class="keyword">var</span> item <span class="keyword">in</span> proto_class.Class_Variables)</span><br><span class="line">                &#123;</span><br><span class="line">                    template.setCondition(<span class="string">&quot;SINGLE&quot;</span>, !item.IsArray);</span><br><span class="line">                    template.setCondition(<span class="string">&quot;ARRAY&quot;</span>, item.IsArray);</span><br><span class="line">                    template.setValue(<span class="string">&quot;#VAR_TYPE#&quot;</span>, item.Var_Type);</span><br><span class="line">                    template.setValue(<span class="string">&quot;#VAR_NAME#&quot;</span>, item.Var_Name);</span><br><span class="line">                    template.setValue(<span class="string">&quot;#VAR_COMMENT#&quot;</span>, item.Var_Comment);</span><br><span class="line">                    template.nextLoop();</span><br><span class="line">                &#125;</span><br><span class="line">                template.endLoop();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> template.getContent();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<pre><code>核心依然是通过正则匹配替换模板文本内容。
</code></pre>
<p>上面几个文件就是解析模板文件以及根据数据结构定义文件生成对应Xbuffer所需代码的核心逻辑。可以看到模板的高自由度配置，让Xbuffer具备了对多语言的快速支持以及灵活配置的能力。</p>
<h6 id="xbuffer-runtime"><a href="#xbuffer-runtime" class="headerlink" title="xbuffer_runtime"></a>xbuffer_runtime</h6><p>xbuffer_runtime.dll是xbuffer对数据进行序列化和反序列化的核心类。</p>
<ol>
<li>XSteam.cs(Xbuffer核心字节流序列化反序列化的关键类)</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * File Name:               XSteam.cs</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Description:             一个简单的内存流实现 用于精准的控制内存管理</span></span><br><span class="line"><span class="comment"> * Author:                  lisiyu &lt;576603306@qq.com&gt;</span></span><br><span class="line"><span class="comment"> * Create Date:             2018/04/09</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">xbuffer</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">XSteam</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">uint</span> index_group;            <span class="comment">// 当前组别序号 行</span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">uint</span> index_cell;             <span class="comment">// 当前单元序号 列</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">uint</span> capacity_group;         <span class="comment">// 行的数量</span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">uint</span> capacity_cell;          <span class="comment">// 列的数量</span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">byte</span>[][] contents;           <span class="comment">// 内容列表</span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">uint</span>[] wastes;               <span class="comment">// 浪费列表 对应每一行</span></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">XSteam</span>(<span class="params"><span class="built_in">uint</span> capacity_group, <span class="built_in">uint</span> capacity_cell</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">this</span>.capacity_group = capacity_group;</span><br><span class="line">            <span class="keyword">this</span>.capacity_cell = capacity_cell;</span><br><span class="line"></span><br><span class="line">            contents = <span class="keyword">new</span> <span class="built_in">byte</span>[capacity_group][];</span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; capacity_group; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                contents[i] = <span class="keyword">new</span> <span class="built_in">byte</span>[capacity_cell];</span><br><span class="line">            &#125;</span><br><span class="line">            wastes = <span class="keyword">new</span> <span class="built_in">uint</span>[capacity_group];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 申请空间</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 基本策略是不够了就申请一倍</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;size&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">applySize</span>(<span class="params"><span class="built_in">uint</span> size</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (index_cell + size &gt; capacity_cell)</span><br><span class="line">            &#123;</span><br><span class="line">                wastes[index_group] = capacity_cell - index_cell;</span><br><span class="line">                index_cell = <span class="number">0</span>;</span><br><span class="line">                index_group++;</span><br><span class="line">                <span class="keyword">if</span> (index_group &gt;= capacity_group)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">var</span> nCapacity_Group = capacity_group + <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">var</span> nContents = <span class="keyword">new</span> <span class="built_in">byte</span>[nCapacity_Group][];</span><br><span class="line">                    <span class="keyword">for</span> (<span class="built_in">uint</span> i = <span class="number">0</span>; i &lt; nCapacity_Group; i++)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">if</span> (i &lt; capacity_group)</span><br><span class="line">                            nContents[i] = contents[i];</span><br><span class="line">                        <span class="keyword">else</span></span><br><span class="line">                            nContents[i] = <span class="keyword">new</span> <span class="built_in">byte</span>[capacity_cell];</span><br><span class="line">                    &#125;</span><br><span class="line">                    contents = nContents;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">var</span> nWastes = <span class="keyword">new</span> <span class="built_in">uint</span>[nCapacity_Group];</span><br><span class="line">                    <span class="keyword">for</span> (<span class="built_in">uint</span> i = <span class="number">0</span>; i &lt; capacity_group; i++)</span><br><span class="line">                    &#123;</span><br><span class="line">                        nWastes[i] = wastes[i];</span><br><span class="line">                    &#125;</span><br><span class="line">                    wastes = nWastes;</span><br><span class="line"></span><br><span class="line">                    capacity_group = nCapacity_Group;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 返回输出字节流</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="built_in">byte</span>[] <span class="title">getBytes</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> len = index_group * capacity_cell + index_cell;</span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; index_group; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                len -= wastes[i];</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> ret = <span class="keyword">new</span> <span class="built_in">byte</span>[len];</span><br><span class="line">            <span class="keyword">var</span> idx = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; index_group; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="built_in">int</span> j = <span class="number">0</span>; j &lt; capacity_cell - wastes[i]; j++)</span><br><span class="line">                &#123;</span><br><span class="line">                    ret[idx++] = contents[i][j];</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; index_cell; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                ret[idx++] = contents[index_group][i];</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> ret;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<pre><code>从上面源码可以看出，Xbuffer是采用了一个二维的byte数组来存储原始数据的(*实现固定内存大小的数据分配*)。空间容量不够的时候在扩容处理，这一点和Flatbuffer是类似的(Flatbuffer貌似是个一维数组)。当现有定义的空间不足时，Xbuffer采取的是翻倍处理(数据存储上是采用扩展二维数组的第二维度实现扩容)。这里可以想成，

举个例子，一开始是byte[1][1024]的byte数组容量。当不够的时候，会扩展成byte[2][1024]的容量，然后从byte[2][]开始填充新的数据，而byte[1][]里未填充完的部分，就当做浪费的部分不再使用。

*但最后返回Xstream的byte数据时，是返回的一个一维byte数组，并且是剔除了wast部分的byte分配，详情见Xstream的getBytes方法*
</code></pre>
<ol start="2">
<li>boolBuffer.cs &amp; byteBuffer.cs &amp; floatBuffer.cs &amp; intBuffer.cs &amp; longBuffer.cs &amp; stringBuffer.cs &amp; uintBuffer.cs(负责对各数据类型的数据序列化写入和反序列化读取进行实现)<br>下面以intBuffer.cs为例:</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * File Name:               intBuffer.cs</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Description:             基本类型处理</span></span><br><span class="line"><span class="comment"> * Author:                  lisiyu &lt;576603306@qq.com&gt;</span></span><br><span class="line"><span class="comment"> * Create Date:             2017/10/25</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">xbuffer</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">intBuffer</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">readonly</span> <span class="built_in">uint</span> size = <span class="keyword">sizeof</span>(<span class="built_in">int</span>);</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">unsafe</span> <span class="keyword">static</span> <span class="built_in">int</span> <span class="title">deserialize</span>(<span class="params"><span class="built_in">byte</span>[] buffer, <span class="keyword">ref</span> <span class="built_in">uint</span> offset</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">fixed</span> (<span class="built_in">byte</span>* ptr = buffer)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> <span class="keyword">value</span> = *(<span class="built_in">int</span>*)(ptr + offset);</span><br><span class="line">                offset += size;</span><br><span class="line">                <span class="keyword">return</span> BitConverter.IsLittleEndian ? <span class="keyword">value</span> : (<span class="built_in">int</span>)utils.toLittleEndian((<span class="built_in">uint</span>)<span class="keyword">value</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">unsafe</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">serialize</span>(<span class="params"><span class="built_in">int</span> <span class="keyword">value</span>, XSteam steam</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            steam.applySize(size);</span><br><span class="line">            <span class="keyword">fixed</span> (<span class="built_in">byte</span>* ptr = steam.contents[steam.index_group])</span><br><span class="line">            &#123;</span><br><span class="line">                *(<span class="built_in">int</span>*)(ptr + steam.index_cell) = BitConverter.IsLittleEndian ? <span class="keyword">value</span> : (<span class="built_in">int</span>)utils.toLittleEndian((<span class="built_in">uint</span>)<span class="keyword">value</span>);</span><br><span class="line">                steam.index_cell += size;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<pre><code>从上面可以看出，底层的数据写入是根据数据类型大小，通过fixed使用非托管的内存分配方式进行指定内存位置指定数据byte的写入和读取。

举个例子，一开始分配了byte[1][1024*1024]也就是1M的内存，当我们写入一个int数据时，因为int类型的byte大小是4bytes也就是32bits，也就是说byte[1][0] - byte[1][4]的内存数据时用于存储这个int的值。其他类型同理。
</code></pre>
<ol start="3">
<li>utils.cs(负责一些细节处理，比如大小端问题，这里就不放源码了)</li>
<li>Serializer.cs(提供模板化的序列化反序列化读取加载接口)</li>
<li>***Buffer.cs(自动化生成的序列化反序列化所需的类代码)</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">xbuffer</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">GameConfigXBBuffer</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> GameConfigXB <span class="title">deserialize</span>(<span class="params"><span class="built_in">byte</span>[] buffer, <span class="keyword">ref</span> <span class="built_in">uint</span> offset</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// null</span></span><br><span class="line">            <span class="built_in">bool</span> _null = boolBuffer.deserialize(buffer, <span class="keyword">ref</span> offset);</span><br><span class="line">            <span class="keyword">if</span> (_null) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// difficultyLevel</span></span><br><span class="line">            <span class="built_in">string</span> _difficultyLevel = stringBuffer.deserialize(buffer, <span class="keyword">ref</span> offset);            </span><br><span class="line"></span><br><span class="line">            <span class="comment">// versionNumber</span></span><br><span class="line">            <span class="built_in">int</span> _versionNumber = intBuffer.deserialize(buffer, <span class="keyword">ref</span> offset);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// resourceNumber</span></span><br><span class="line">            <span class="built_in">int</span> _resourceNumber = intBuffer.deserialize(buffer, <span class="keyword">ref</span> offset);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// value</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> GameConfigXB()</span><br><span class="line">            &#123;</span><br><span class="line">                difficultyLevel = _difficultyLevel,</span><br><span class="line"></span><br><span class="line">                versionNumber = _versionNumber,</span><br><span class="line"></span><br><span class="line">                resourceNumber = _resourceNumber,</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">serialize</span>(<span class="params">GameConfigXB <span class="keyword">value</span>, XSteam steam</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// null</span></span><br><span class="line">            boolBuffer.serialize(<span class="keyword">value</span> == <span class="literal">null</span>, steam);</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">value</span> == <span class="literal">null</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// difficultyLevel</span></span><br><span class="line">            stringBuffer.serialize(<span class="keyword">value</span>.difficultyLevel, steam);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// versionNumber</span></span><br><span class="line">            intBuffer.serialize(<span class="keyword">value</span>.versionNumber, steam);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// resourceNumber</span></span><br><span class="line">            intBuffer.serialize(<span class="keyword">value</span>.resourceNumber, steam);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<pre><code>从上面可以看到，根据数据结构定义文件生成对应的序列化和反序列化代码核心是通过各成员数据按循序依次以各自类型的写入方式将数据写入XStream里。
反序列化时同理依次从byte数据里读取出来。
不难看出，数据存储确实和Flatbuffer类似，存储在一个固定的内存byte[]数组里，只不过是一维和二维数组的区别(*但实际上最后返回Xstream的byte数据时，是剔除了wast部分的一个一维的byte数组*)。数据序列化和反序列化都是读取指定内存位置按指定数据类型读取出来即可，这应该就是Xbuffer和Flatbuffer序列化和反序列化高效的原因吧。
</code></pre>
<h3 id="方案比较-1"><a href="#方案比较-1" class="headerlink" title="方案比较"></a>方案比较</h3><p>不同的序列化反序列化库的优劣比较:</p>
<ol>
<li>自定义数据填充和读取<br>优点：</li>
</ol>
<ul>
<li>实现简单<br>缺点:</li>
<li>序列化和反序列化速度慢，内存开销大</li>
<li>不适合数据量大和频繁使用的情况</li>
</ul>
<p><em>适用于数据量不大且不需要跨语言的情况，不适合对性能要求高的场合。</em></p>
<ol start="2">
<li>ProtoBuff<br>优点：</li>
</ol>
<ul>
<li>序列化和反序列化速度和内存开销都很不错</li>
<li>数据定义向后兼容</li>
<li>高度自定义配置数据结构(proto文件)</li>
<li>数据序列化反序列化代码简介，接口简单</li>
<li>社区强大<br>缺点:</li>
<li>相比FlatBuffer和Xbuffer速度和内存开销上不占优势</li>
</ul>
<p><em>很适合作为网络数据传输方案(向后兼容)。</em></p>
<ol start="3">
<li>FlatBuff<br>优点：</li>
</ol>
<ul>
<li>序列化和反序列化速度快，内存开销小</li>
<li>支持自定义配置数据结构(schema文件)<br>缺点:</li>
<li>序列化反序列化代码编写过于面向内存结构，不符合平时面向对象的编写风格，编写复杂(这一层被Xbuffer封装成自动化生成***Buffer.cs的代码类)</li>
</ul>
<ol start="4">
<li>XBuffer<br>优点:</li>
</ol>
<ul>
<li>序列化和反序列化速度快，内存开销小</li>
<li>高度自由配置(基于模板配置且自定义配置文件配置)</li>
<li>接口简单方便使用，支持泛型和非泛型序列化反序列化</li>
<li>根据需求可以快速修改来符合自身需求(比如要做导表工具，只需在上层再封一层即可)<br>缺点:</li>
<li>向后不兼容(因为数据是严格按照数据结构按顺序读取的，所以当已经存储进数据库的数据，在扩展字段内容后是无法正常反序列化读取出来的)</li>
</ul>
<p><em>不适合作为网络序列化数据方案，更适合表格数据序列化反序列化方案。</em></p>
<h2 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h2><h3 id="方案选择"><a href="#方案选择" class="headerlink" title="方案选择"></a>方案选择</h3><p>学习了解了那么多序列化和反序列化的库，根据我现有的需求是制作一个导表工具(速度和内存开销以及配置灵活度都要求比较高)来看，个人认为基于Xbuffer来编写是比较适合的一种方案。</p>
<p>原因如下:</p>
<ol>
<li>速度快</li>
<li>内存开销小</li>
<li>高度可配置</li>
</ol>
<h3 id="基于Xbuffer的导表工具"><a href="#基于Xbuffer的导表工具" class="headerlink" title="基于Xbuffer的导表工具"></a>基于Xbuffer的导表工具</h3><p>流程：</p>
<ol>
<li>定义导表工具基础功能需求</li>
<li>XML配置导表相关路径数据(比如表格路径配置，输出目录配置等)</li>
<li>定义excel表格格式规则</li>
<li>读取excel数据(Window可以使用ExcelRead库)</li>
<li>创建excel对应Xbuffer数据结构文件(这一步需要自己去写)</li>
<li>使用Xbuffer_parser解析新生成的数据结构文件，生成所需类文件以及序列化相关文件(使用Xbuffer_parser解析即可)</li>
<li>使用生成的代码序列化excel数据到二进制数据流(这一步需要自己去写)</li>
<li>封装一层表格数据读取快速读取管理类，负责统一管理表格数据的加载和读取(这一步需要自己去写)</li>
<li>通过统一管理类使用Xbuffer去加载读取序列化的二进制数据(结合自身代码，使用Xbuffer_runtime.dll里的核心代码去反序列化)</li>
</ol>
<p>相关语言及工具：<br>C#(Unity客户端使用的语言)<br>Xbuffer(第三方序列化反序列化库)</p>
<p>接下将来针对每一步的实现进行实战学习。</p>
<h4 id="导表功能需求"><a href="#导表功能需求" class="headerlink" title="导表功能需求"></a>导表功能需求</h4><ol>
<li>支持int，float，long, string, bool基础数据配置</li>
<li>支持一维和多维数据配置(进阶功能，理论上，对于xbuffer而言，数组的维度扩展就能支持多维数据)</li>
<li>自动生成表格数据以及表格读取相关代码</li>
<li>工具独立于Unity存在使用</li>
<li>支持跨语言(xbuffer理论上通过模板生成不同语言版本的相关代码即可)</li>
<li>支持XML配置相关工具配置(比如表格路径配置，输出目录配置等。)</li>
</ol>
<h4 id="支持导表路径配置"><a href="#支持导表路径配置" class="headerlink" title="支持导表路径配置"></a>支持导表路径配置</h4><p>因为工具是独立于Unity所以不受Unity .Net版本的限制，这里决定使用.Net自身的XML解析库System.XML。</p>
<p>ExportConfig.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">ExportConfig</span>&gt;</span>  </span><br><span class="line">   <span class="tag">&lt;<span class="name">ExcelInputPath</span>&gt;</span>./Excels/<span class="tag">&lt;/<span class="name">ExcelInputPath</span>&gt;</span>  </span><br><span class="line">   <span class="tag">&lt;<span class="name">TemplatePath</span>&gt;</span>./Templates/<span class="tag">&lt;/<span class="name">TemplatePath</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">DesFileOutputPath</span>&gt;</span>./DesFiles/<span class="tag">&lt;/<span class="name">DesFileOutputPath</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">ByteDataOutputPath</span>&gt;</span>./../Assets/Resources/DataBytes/<span class="tag">&lt;/<span class="name">ByteDataOutputPath</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">CSClassCodeOutputPath</span>&gt;</span>./../Assets/Scripts/Data/CSOutput/ClassCode/<span class="tag">&lt;/<span class="name">CSClassCodeOutputPath</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">CSBufferCodeOutputPath</span>&gt;</span>./../Assets/Scripts/Data/CSOutput/BufferCode/<span class="tag">&lt;/<span class="name">CSBufferCodeOutputPath</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">CSTemplateOutputPath</span>&gt;</span>./../Assets/Scripts/Data/CSTemplateOutput/<span class="tag">&lt;/<span class="name">CSTemplateOutputPath</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">OtherLanguageCodeOutputPath</span>&gt;</span>./OtherOutput/<span class="tag">&lt;/<span class="name">OtherLanguageCodeOutputPath</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ExportConfig</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>ExportConfig.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             导表工具导出配置数据抽象</span></span><br><span class="line"><span class="comment"> * Author:                  tanghuan</span></span><br><span class="line"><span class="comment"> * Create Date:             2018/09/01</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"> <span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">XbufferExcelToData</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ExportConfig</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 表格数据路径</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> ExcelInputPath &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> Xbuffer模板路径</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> TemplatePath &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 序列化数据输出路径</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> ByteDataOutputPath &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> CS代码输出路径</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> CSCodeOutputPath &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 其他语言代码输出路径</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> OtherLanguageCodeOutputPath &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 打印所有信息</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">printOutAllInfo</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            Console.WriteLine(<span class="built_in">string</span>.Format(<span class="string">&quot;ExcelInputPath : &#123;0&#125;&quot;</span>, ExcelInputPath));</span><br><span class="line">            Console.WriteLine(<span class="built_in">string</span>.Format(<span class="string">&quot;TemplatePath : &#123;0&#125;&quot;</span>, TemplatePath));</span><br><span class="line">            Console.WriteLine(<span class="built_in">string</span>.Format(<span class="string">&quot;DesFileOutputPath : &#123;0&#125;&quot;</span>, DesFileOutputPath));</span><br><span class="line">            Console.WriteLine(<span class="built_in">string</span>.Format(<span class="string">&quot;ByteDataOutputPath : &#123;0&#125;&quot;</span>, ByteDataOutputPath));</span><br><span class="line">            Console.WriteLine(<span class="built_in">string</span>.Format(<span class="string">&quot;CSCodeOutputPath : &#123;0&#125;&quot;</span>, CSCodeOutputPath));</span><br><span class="line">            Console.WriteLine(<span class="built_in">string</span>.Format(<span class="string">&quot;OtherLanguageCodeOutputPath : &#123;0&#125;&quot;</span>, OtherLanguageCodeOutputPath));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>XbufferExcelToDataConfig.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             导表工具相关配置单例类</span></span><br><span class="line"><span class="comment"> * Author:                  tanghuan</span></span><br><span class="line"><span class="comment"> * Create Date:             2018/09/01</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"><span class="keyword">using</span> System.Xml;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">XbufferExcelToData</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 导表工具相关配置单例类</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">XbufferExcelToDataConfig</span> : <span class="title">SingletonTemplate</span>&lt;<span class="title">XbufferExcelToDataConfig</span>&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> XML配置文件全路径</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> XMLConfigFileFullPath &#123; <span class="keyword">get</span>; <span class="keyword">private</span> <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 导出配置数据</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> ExportConfig ExportConfigInfo &#123; <span class="keyword">get</span>; <span class="keyword">private</span> <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">XbufferExcelToDataConfig</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            XMLConfigFileFullPath = <span class="string">&quot;./ExportConfig.xml&quot;</span>;</span><br><span class="line">            ExportConfigInfo = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 加载导出配置数据</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">LoadExportConfigData</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(File.Exists(XMLConfigFileFullPath))</span><br><span class="line">            &#123;</span><br><span class="line">                XmlDocument xmldoc = <span class="keyword">new</span> XmlDocument();</span><br><span class="line">                xmldoc.Load(XMLConfigFileFullPath);</span><br><span class="line">                <span class="keyword">var</span> rootnode = xmldoc.DocumentElement;</span><br><span class="line">                <span class="keyword">var</span> rootnodename = rootnode.Name;</span><br><span class="line">                <span class="keyword">var</span> reflecttype = <span class="keyword">this</span>.GetType().Assembly.GetType(<span class="string">&quot;XbufferExcelToData.&quot;</span> + rootnodename);</span><br><span class="line">                <span class="keyword">if</span>(reflecttype ==  <span class="keyword">typeof</span>(ExportConfig))</span><br><span class="line">                &#123;</span><br><span class="line">                    ExportConfigInfo = <span class="keyword">new</span> ExportConfig();</span><br><span class="line">                    <span class="keyword">var</span> childnodes = rootnode.ChildNodes;</span><br><span class="line">                    <span class="keyword">for</span>(<span class="built_in">int</span> i = <span class="number">0</span>, length = childnodes.Count; i &lt; length; i++)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">var</span> property = ExportConfigInfo.GetType().GetProperty(childnodes[i].Name);</span><br><span class="line">                        <span class="keyword">if</span>(property != <span class="literal">null</span>)</span><br><span class="line">                        &#123;</span><br><span class="line">                            property.SetValue(ExportConfigInfo, childnodes[i].InnerText);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">else</span></span><br><span class="line">                        &#123;</span><br><span class="line">                            Console.WriteLine(<span class="built_in">string</span>.Format(<span class="string">&quot;不支持的属性配置 : &#123;0&#125;&quot;</span>, childnodes[i].Name));</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;                    </span><br><span class="line">                    ExportConfigInfo.printOutAllInfo();</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    Console.WriteLine(<span class="built_in">string</span>.Format(<span class="string">&quot;找不到配置的类型数据信息 : &#123;0&#125;&quot;</span>, rootnodename));</span><br><span class="line">                    Console.WriteLine(<span class="string">&quot;当前只支持ExportConfig类型信息配置&quot;</span>);</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine(<span class="built_in">string</span>.Format(<span class="string">&quot;导出配置文件不存在 : &#123;0&#125;&quot;</span>, XMLConfigFileFullPath));</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/img/Unity/Data-Config-Automation/LoadXMLConfig.png" alt="LoadXMLConfig"><br>可以看到我们成功的读取了XML里配置的信息(后续的导表工具会用到)。</p>
<h4 id="定义表格规则"><a href="#定义表格规则" class="headerlink" title="定义表格规则"></a>定义表格规则</h4><ol>
<li>第一行定义字段</li>
<li>第二行写字段注释</li>
<li>第三行定义字段类型</li>
<li>第四行表示分割符(只对一维数组类型有用)</li>
<li>第五和第六行保留为未来扩展使用</li>
<li>第七行及以后正式填写数据(数据不填采用对应类型的默认值，比如int为0，bool为false，int[]为null)</li>
</ol>
<h4 id="读取excel数据"><a href="#读取excel数据" class="headerlink" title="读取excel数据"></a>读取excel数据</h4><p>Windows PC端决定使用ExcelRead库来解决excel读取问题。</p>
<p>核心代码是下面两个文件：<br>ExcelDataManager.cs<br>ExcelData.cs</p>
<p>考虑到博客暂时不支持代码折叠，这里就不直接放源代码了，整个工程源代码会在博客最后给出链接。<br>主要实现了以下功能：</p>
<ol>
<li>按表格规则解析</li>
<li>检查表格配置是否正确(1. 不允许同名excel sheet 2. 字段名不允许重复 3. 支持的数据类型检查 4. id第一列必须为int类型且不允许不填且同一个表格id不能重复 5. 支持的分隔符检查配置)</li>
</ol>
<p>这里直接验证下读取Excel数据的结果:<br><img src="/img/Unity/Data-Config-Automation/ExcelDatOutput.png" alt="ExcelDatOutput"></p>
<h4 id="创建对应数据结构文件"><a href="#创建对应数据结构文件" class="headerlink" title="创建对应数据结构文件"></a>创建对应数据结构文件</h4><p>这一步，我们需要自动化生成Xbuffer用于自动化生成相关序列化代码的数据结构定义文件。</p>
<p>还记的我们前面学习Xbuffer时定义的GameConfigXB.xb吗?<br>GameConfigXB.xb</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 游戏版本信息</span></span><br><span class="line"><span class="keyword">class</span> <span class="title">GameConfigXB</span></span><br><span class="line">&#123;</span><br><span class="line">    difficultyLevel:<span class="built_in">string</span>;             <span class="comment">// 游戏难度</span></span><br><span class="line">    versionNumber:<span class="built_in">int</span>;                  <span class="comment">// 游戏版本号</span></span><br><span class="line">    resourceNumber:<span class="built_in">int</span>;                 <span class="comment">// 游戏资源版本号</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们现在的目标就是将我们的Excel定义的数据内容转换成对应的数据结构定义文件。</p>
<p>实现方案思考：<br>数据结构定义文件不需要考虑跨平台，真正跨平台的实现是在序列化模板文件那一步完成的，所以这里打算简单的通过字节流形式按顺序文本写入即可。</p>
<p>代码很简单，就是利用之前存储的表格数据信息，一次写入字符串信息，最后通过文件流写入文件，这里就不放源代码了。</p>
<p>核心类是:<br>XbufferExcelToDesFile.cs</p>
<p>直接来看下最终生成的结果:<br>t_AuthorInfo.xb</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// t_AuthorInfo的注释</span></span><br><span class="line"><span class="keyword">class</span> <span class="title">t_AuthorInfo</span></span><br><span class="line">&#123;</span><br><span class="line">    id:<span class="built_in">int</span>;                                      <span class="comment">//唯一id</span></span><br><span class="line">    author:<span class="built_in">string</span>;                                <span class="comment">//作者</span></span><br><span class="line">    age:<span class="built_in">int</span>;                                        <span class="comment">//年龄</span></span><br><span class="line">    money:<span class="built_in">float</span>;                                    <span class="comment">//拥有金钱</span></span><br><span class="line">    hashouse:<span class="built_in">bool</span>;                                <span class="comment">//拥有房子</span></span><br><span class="line">    pbutctime:<span class="built_in">long</span>;                              <span class="comment">//出版utc时间</span></span><br><span class="line">    luckynumber:[<span class="built_in">int</span>];                            <span class="comment">//幸运数字</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这一步，我们成功自动化生成了Xbuffer需要的Excel对应的数据结构定义文件。</p>
<h4 id="生成序列化所需文件"><a href="#生成序列化所需文件" class="headerlink" title="生成序列化所需文件"></a>生成序列化所需文件</h4><p>为了便于修改Xbuffer满足我们新的需求，这里直接把Xbuffer的两个核心工程(xbuffer_parser &amp; xbuffer_runtime)集成到我们的导表工具里来：<br><img src="/img/Unity/Data-Config-Automation/IntegrateXbuffer.png" alt="IntegrateXbuffer"></p>
<p>然后修改Xbuffer两个核心工程的输出路径和我们主工程一致(便于主工程使用):<br><img src="/img/Unity/Data-Config-Automation/ModifyXbufferOutputPath.png" alt="ModifyXbufferOutputPath"></p>
<p>然后编译出两个工程各自的核心文件:<br><img src="/img/Unity/Data-Config-Automation/CompileXbufferCSProjects.png" alt="CompileXbufferCSProjects"></p>
<p>为了不修改原有Xbuffer的使用方式，这里采用通过跨程序调用exe的方式来使用Xbuffer。<br>核心类是:<br>XbufferDesFileToCSCode.cs</p>
<p>成功生成序列化相关代码:<br>t_AuthorInfoBuffer.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">xbuffer</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">t_AuthorInfoBuffer</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> t_AuthorInfo <span class="title">deserialize</span>(<span class="params"><span class="built_in">byte</span>[] buffer, <span class="keyword">ref</span> <span class="built_in">uint</span> offset</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// null</span></span><br><span class="line">            <span class="built_in">bool</span> _null = boolBuffer.deserialize(buffer, <span class="keyword">ref</span> offset);</span><br><span class="line">            <span class="keyword">if</span> (_null) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// id</span></span><br><span class="line">            <span class="built_in">int</span> _id = intBuffer.deserialize(buffer, <span class="keyword">ref</span> offset);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// author</span></span><br><span class="line">            <span class="built_in">string</span> _author = stringBuffer.deserialize(buffer, <span class="keyword">ref</span> offset);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// age</span></span><br><span class="line">            <span class="built_in">int</span> _age = intBuffer.deserialize(buffer, <span class="keyword">ref</span> offset);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// money</span></span><br><span class="line">            <span class="built_in">float</span> _money = floatBuffer.deserialize(buffer, <span class="keyword">ref</span> offset);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// hashouse</span></span><br><span class="line">            <span class="built_in">bool</span> _hashouse = boolBuffer.deserialize(buffer, <span class="keyword">ref</span> offset);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// pbutctime</span></span><br><span class="line">            <span class="built_in">long</span> _pbutctime = longBuffer.deserialize(buffer, <span class="keyword">ref</span> offset);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// luckynumber</span></span><br><span class="line">            <span class="built_in">int</span> _luckynumber_length = intBuffer.deserialize(buffer, <span class="keyword">ref</span> offset);</span><br><span class="line">            <span class="built_in">int</span>[] _luckynumber = <span class="keyword">new</span> <span class="built_in">int</span>[_luckynumber_length];</span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; _luckynumber_length; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                _luckynumber[i] = intBuffer.deserialize(buffer, <span class="keyword">ref</span> offset);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// value</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> t_AuthorInfo() &#123;</span><br><span class="line">                id = _id,</span><br><span class="line">                author = _author,</span><br><span class="line">                age = _age,</span><br><span class="line">                money = _money,</span><br><span class="line">                hashouse = _hashouse,</span><br><span class="line">                pbutctime = _pbutctime,</span><br><span class="line">                luckynumber = _luckynumber,</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">serialize</span>(<span class="params">t_AuthorInfo <span class="keyword">value</span>, XSteam steam</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// null</span></span><br><span class="line">            boolBuffer.serialize(<span class="keyword">value</span> == <span class="literal">null</span>, steam);</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">value</span> == <span class="literal">null</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// id</span></span><br><span class="line">            intBuffer.serialize(<span class="keyword">value</span>.id, steam);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// author</span></span><br><span class="line">            stringBuffer.serialize(<span class="keyword">value</span>.author, steam);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// age</span></span><br><span class="line">            intBuffer.serialize(<span class="keyword">value</span>.age, steam);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// money</span></span><br><span class="line">            floatBuffer.serialize(<span class="keyword">value</span>.money, steam);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// hashouse</span></span><br><span class="line">            boolBuffer.serialize(<span class="keyword">value</span>.hashouse, steam);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// pbutctime</span></span><br><span class="line">            longBuffer.serialize(<span class="keyword">value</span>.pbutctime, steam);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// luckynumber</span></span><br><span class="line">            intBuffer.serialize(<span class="keyword">value</span>.luckynumber.Length, steam);</span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">value</span>.luckynumber.Length; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                intBuffer.serialize(<span class="keyword">value</span>.luckynumber[i], steam);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>t_AuthorInfo.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// t_AuthorInfo的注释</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">partial</span> <span class="keyword">class</span> <span class="title">t_AuthorInfo</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> id;              <span class="comment">// 唯一id</span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> author;               <span class="comment">// 作者</span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> age;             <span class="comment">// 年龄</span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">float</span> money;             <span class="comment">// 拥有金钱</span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">bool</span> hashouse;               <span class="comment">// 拥有房子</span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">long</span> pbutctime;              <span class="comment">// 出版utc时间</span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span>[] luckynumber;               <span class="comment">// 幸运数字</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Note:<br>因为xbuffer_parser默认只支持一个一个文件解析，保留原始使用方法会导致弹过多的弹窗，所以这里把xbuffer_parser改成指定目录形式的自动化生成。</p>
<h4 id="序列化数据"><a href="#序列化数据" class="headerlink" title="序列化数据"></a>序列化数据</h4><p>Xbuffer序列化相关的代码自动生成完成后，下一步就是把Excel的数据序列化到我们指定的二进制文件流了。</p>
<p>实现方案思考：</p>
<ul>
<li>这一步主要依赖于最初存储的Excel数据以及前面生成的Xbuffer相关的序列化代码来进行序列化数据。</li>
<li>但序列化的代码是动态生成的没有被编译到工具代码里的，我们无法利用现成的序列化代码来进行数据序列化。</li>
<li>只能根据表格数据以及类型信息通过Xbuffer的基础数据类型写入对应数据，反序列化时再利用反序列化代码进行数据读取。</li>
<li>除了写入数据信息，我们还需要在写入数据信息之前，写入两个关键信息(1. 数据数量(行数) 2. 数据长度(字节数))，用于我们后面去读取加载存储数据时使用，后者如果完全是一个byte对应一个excel数据的话倒是可以不用存储，因为加载后就已经知道总长度了，但如果是所有byte通过zip压缩到一起的话就需要知道每个byte的数据长度。</li>
</ul>
<p>序列化的核心代码文件:<br>XbufferExcelDataToBytes.cs</p>
<p>Note:</p>
<ol>
<li>暂时是一个Excel文件对应一个bytes数据的方式进行存储。(<strong>2022&#x2F;1&#x2F;22完成了单Excel多Sheet导出的支持</strong>)</li>
<li>如果想对数据进行压缩或者加密验证，都可以在序列化这一步或者压缩之后写入数据，然后在加载时反向操作判定对比即可。(TODO:优化)</li>
</ol>
<h4 id="统一表格数据加载和读取"><a href="#统一表格数据加载和读取" class="headerlink" title="统一表格数据加载和读取"></a>统一表格数据加载和读取</h4><p>这一步是属于加载一测的了，是需要运用在Unity里的代码，统一表格加载管理是为了对于表格数据进行快速的访问和管理(一般都会有个GameDataManager之类的单例类负责管理)。<br>因为表格数据是动态生成的，所以加载的代码也需要动态生成。</p>
<p>实现方案思考:</p>
<ul>
<li>这一步因为涉及到自动化的加载代码生成，会涉及到多语言支持问题，所以如果想要支持多语言最好通过模板一类的方式来动态生成代码。</li>
<li>虽然Xbuffer里有一套根据模板生成代码的方案，但想自己尝试实现一下，所以不准备直接拿过来用，准备参考Xbuffer模板替换思路自己模仿写一份(尝试写了这个才发现正则的强大之处)。</li>
</ul>
<p>模板功能需求：</p>
<ul>
<li>支持模板内容基于占位符替换</li>
<li>支持模板内容基于占位符循环替换</li>
</ul>
<p>实现方案跟Xbuffer的一样，支持如下功能：</p>
<ol>
<li>支持两种替换规则(1. 占位符单次替换 2. 限定模板内容多次替换累加)</li>
<li>前者作用范围整个模板(不包含多次替换模板内容部分 – 通过定义不重复的占位符来实现)，后者允许指定局部内容作为模板用于多次替换累加</li>
<li>多次替换模板内容允许跨行</li>
<li>模板占位符可自定义名字，但格式必须是:#名字#</li>
<li>多次替换模板内可定义占位符，支持占位符单次替换</li>
</ol>
<p>比如如下定义方式:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Auto generated, do not edit it</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">using</span> Xbuffer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Data</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">GameDataManager</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="meta">#循环标签名1#</span></span><br><span class="line">        <span class="keyword">public</span> <span class="meta">#循环占位符名1#Container #循环占位符名1#Container = new #循环占位符名1#Container();</span></span><br><span class="line">        <span class="meta">#循环标签名1#</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadAll</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="meta">#循环标签名2#</span></span><br><span class="line">        <span class="meta">#循环占位符名2#Container.loadDataFromBin();</span></span><br><span class="line">        <span class="meta">#循环标签名2#</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">GameDataManager</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">readonly</span> GameDataManager Instance = <span class="keyword">new</span> GameDataManager();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>模板文件定义分析:</p>
<ol>
<li>整个文件内容是作为完整的模板内容。</li>
<li>在非循环占位符标签内的#占位符名#会用于作为单次替换占位符</li>
<li>循环标签名1和循环标签名2定义一个局部模板内容作为多次替换的模板(循环标签必须配对使用，且不允许同一个模板里重复使用)</li>
<li>循环占位符名1和循环占位符名2表示多次替换模板里的占位符(注意不能和单次占位符名字重复，不然会被单次替换掉)</li>
</ol>
<p>这里主要需要以下几个文件的模板:<br>先手写一版模板初稿</p>
<ol>
<li>GameDataManager.ftl – GameDataManager.cs(表数据统一加载管理类)</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Auto generated, do not edit it</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> xbuffer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Data</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">GameDataManager</span></span><br><span class="line">    &#123;</span><br><span class="line">		<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">readonly</span> GameDataManager Singleton = <span class="keyword">new</span> GameDataManager();</span><br><span class="line"></span><br><span class="line">        <span class="meta">#CONTAINER_MEMBER_LOOP#</span></span><br><span class="line">        <span class="keyword">private</span> <span class="meta">#CLASS_NAME#Container m#CLASS_NAME#Container = new #CLASS_NAME#Container();</span></span><br><span class="line">        <span class="meta">#CONTAINER_MEMBER_LOOP#</span></span><br><span class="line"></span><br><span class="line">		<span class="function"><span class="keyword">private</span> <span class="title">GameDataManager</span>()</span></span><br><span class="line">		&#123;</span><br><span class="line">		</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadAll</span>()</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="meta">#CONTAINER_LOAD_LOOP#</span></span><br><span class="line">			m<span class="meta">#LOOP_CLASS_NAME#Container.loadDataFromBin();</span></span><br><span class="line">			<span class="meta">#CONTAINER_LOAD_LOOP#</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="meta">#CONTAINER_GET_LOOP#</span></span><br><span class="line">		<span class="keyword">public</span> List&lt;<span class="meta">#LOOP_CLASS_NAME#&gt; Get#LOOP_CLASS_NAME#List()</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">return</span> m<span class="meta">#LOOP_CLASS_NAME#Container.getList();</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">public</span> Dictionary&lt;<span class="meta">#ID_TYPE#, #LOOP_CLASS_NAME#&gt; Get#LOOP_CLASS_NAME#Map()</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">return</span> m<span class="meta">#LOOP_CLASS_NAME#Container.getMap();</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="meta">#CONTAINER_GET_LOOP#</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>excelContainer.ftl – excelContainer.cs(表格数据存储类)</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Auto generated by XbufferExcelToData, do not edit it </span></span><br><span class="line"><span class="comment"> * 表格名字</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> xbuffer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Data</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> #<span class="title">CLASS_NAME</span>#<span class="title">Container</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> List&lt;<span class="meta">#CLASS_NAME#&gt; list = null;</span></span><br><span class="line">        <span class="keyword">private</span> Dictionary&lt;<span class="meta">#ID_TYPE#, #CLASS_NAME#&gt; map = null;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> List&lt;<span class="meta">#CLASS_NAME#&gt; getList()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (list == <span class="literal">null</span> || list.Count &lt;= <span class="number">0</span>)</span><br><span class="line">                loadDataFromBin();</span><br><span class="line">            <span class="keyword">return</span> list;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> Dictionary&lt;<span class="meta">#ID_TYPE#, #CLASS_NAME#&gt; getMap()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (map == <span class="literal">null</span> || map.Count &lt;= <span class="number">0</span>)</span><br><span class="line">                loadDataFromBin();</span><br><span class="line">            <span class="keyword">return</span> map;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ClearList</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (list != <span class="literal">null</span> &amp;&amp; list.Count &gt; <span class="number">0</span>)</span><br><span class="line">                list.Clear();</span><br><span class="line">            <span class="keyword">if</span> (map != <span class="literal">null</span> &amp;&amp; map.Count &gt; <span class="number">0</span>)</span><br><span class="line">                map.Clear();</span><br><span class="line">        &#125;   </span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadDataFromBin</span>()</span></span><br><span class="line">        &#123;   </span><br><span class="line">            Stream fs = ConfLoader.Singleton.getStreamByteName(<span class="keyword">typeof</span>(<span class="meta">#CLASS_NAME#).Name);</span></span><br><span class="line">            <span class="keyword">if</span>(fs != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                BinaryReader br = <span class="keyword">new</span> BinaryReader(fs);</span><br><span class="line">                <span class="built_in">uint</span> offset = <span class="number">0</span>;</span><br><span class="line">                <span class="built_in">bool</span> frist = <span class="literal">true</span>;</span><br><span class="line">                <span class="keyword">try</span>&#123;</span><br><span class="line">                    <span class="keyword">while</span> (fs.Length - fs.Position &gt; <span class="number">0</span>)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">if</span> (frist)</span><br><span class="line">                        &#123;</span><br><span class="line">                            frist = <span class="literal">false</span>;</span><br><span class="line">                            ClearList();</span><br><span class="line">                            <span class="keyword">var</span> count = br.ReadInt32();</span><br><span class="line">                            list =  <span class="keyword">new</span> List&lt;<span class="meta">#CLASS_NAME#&gt;(count);</span></span><br><span class="line">                            map = <span class="keyword">new</span> Dictionary&lt;<span class="meta">#ID_TYPE#, #CLASS_NAME#&gt;(count);</span></span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">var</span> length = br.ReadInt32();</span><br><span class="line">                        <span class="keyword">var</span> data = br.ReadBytes(length);</span><br><span class="line">                        <span class="keyword">var</span> obj= <span class="meta">#CLASS_NAME#Buffer.deserialize(data, ref offset);</span></span><br><span class="line">                        offset = <span class="number">0</span>;</span><br><span class="line">                        list.Add(obj);</span><br><span class="line">                        map.Add(obj.<span class="meta">#ID_NAME#, obj); </span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;<span class="keyword">catch</span> (Exception ex)</span><br><span class="line">                &#123;</span><br><span class="line">                    Debug.LogError(<span class="string">&quot;import data error: &quot;</span> + ex.ToString());</span><br><span class="line">                &#125;           </span><br><span class="line">                br.Close();</span><br><span class="line">                fs.Close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>ConfLoader.cs(二进制配置数据文件加载类 - 这个不需要自动化生成)</li>
</ol>
<p>这里只支持了一维数组维度的配置:<br>来看下自动生成后的相关代码：<br>GameDataManager.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Auto generated, do not edit it</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> xbuffer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Data</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">GameDataManager</span></span><br><span class="line">    &#123;</span><br><span class="line">		<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">readonly</span> GameDataManager Instance = <span class="keyword">new</span> GameDataManager();</span><br><span class="line"></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">private</span> t_AuthorInfoContainer mt_AuthorInfoContainer = <span class="keyword">new</span> t_AuthorInfoContainer();</span><br><span class="line">        </span><br><span class="line">        ******</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">private</span> t_language_cnContainer mt_language_cnContainer = <span class="keyword">new</span> t_language_cnContainer();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">private</span> t_uiContainer mt_uiContainer = <span class="keyword">new</span> t_uiContainer();</span><br><span class="line">        </span><br><span class="line"></span><br><span class="line">		<span class="function"><span class="keyword">private</span> <span class="title">GameDataManager</span>()</span></span><br><span class="line">		&#123;</span><br><span class="line">		</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadAll</span>()</span></span><br><span class="line">		&#123;</span><br><span class="line">			</span><br><span class="line">			mt_AuthorInfoContainer.loadDataFromBin();</span><br><span class="line">			</span><br><span class="line">			******</span><br><span class="line">			</span><br><span class="line">			mt_language_cnContainer.loadDataFromBin();</span><br><span class="line">			</span><br><span class="line">			mt_uiContainer.loadDataFromBin();</span><br><span class="line">			</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		</span><br><span class="line">		<span class="function"><span class="keyword">public</span> List&lt;t_AuthorInfo&gt; <span class="title">Gett_AuthorInfoList</span>()</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">return</span> mt_AuthorInfoContainer.getList();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="function"><span class="keyword">public</span> Dictionary&lt;<span class="built_in">int</span>, t_AuthorInfo&gt; <span class="title">Gett_AuthorInfoMap</span>()</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">return</span> mt_AuthorInfoContainer.getMap();</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">        ******</span><br><span class="line">		</span><br><span class="line">		<span class="function"><span class="keyword">public</span> List&lt;t_ui&gt; <span class="title">Gett_uiList</span>()</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">return</span> mt_uiContainer.getList();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="function"><span class="keyword">public</span> Dictionary&lt;<span class="built_in">string</span>, t_ui&gt; <span class="title">Gett_uiMap</span>()</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">return</span> mt_uiContainer.getMap();</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>t_AuthorInfoContainer.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Auto generated by XbufferExcelToData, do not edit it </span></span><br><span class="line"><span class="comment"> * 表格名字</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> xbuffer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Data</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">t_AuthorInfoContainer</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> List&lt;t_AuthorInfo&gt; list = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">private</span> Dictionary&lt;<span class="built_in">int</span>, t_AuthorInfo&gt; map = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> List&lt;t_AuthorInfo&gt; <span class="title">getList</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (list == <span class="literal">null</span> || list.Count &lt;= <span class="number">0</span>)</span><br><span class="line">                loadDataFromBin();</span><br><span class="line">            <span class="keyword">return</span> list;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Dictionary&lt;<span class="built_in">int</span>, t_AuthorInfo&gt; <span class="title">getMap</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (map == <span class="literal">null</span> || map.Count &lt;= <span class="number">0</span>)</span><br><span class="line">                loadDataFromBin();</span><br><span class="line">            <span class="keyword">return</span> map;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ClearList</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (list != <span class="literal">null</span> &amp;&amp; list.Count &gt; <span class="number">0</span>)</span><br><span class="line">                list.Clear();</span><br><span class="line">            <span class="keyword">if</span> (map != <span class="literal">null</span> &amp;&amp; map.Count &gt; <span class="number">0</span>)</span><br><span class="line">                map.Clear();</span><br><span class="line">        &#125;   </span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadDataFromBin</span>()</span></span><br><span class="line">        &#123;   </span><br><span class="line">            Stream fs = ConfLoader.Singleton.getStreamByteName(<span class="keyword">typeof</span>(t_AuthorInfo).Name);</span><br><span class="line">            <span class="keyword">if</span>(fs != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                BinaryReader br = <span class="keyword">new</span> BinaryReader(fs);</span><br><span class="line">                <span class="built_in">uint</span> offset = <span class="number">0</span>;</span><br><span class="line">                <span class="built_in">bool</span> frist = <span class="literal">true</span>;</span><br><span class="line">                <span class="keyword">try</span>&#123;</span><br><span class="line">                    <span class="keyword">while</span> (fs.Length - fs.Position &gt; <span class="number">0</span>)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">if</span> (frist)</span><br><span class="line">                        &#123;</span><br><span class="line">                            frist = <span class="literal">false</span>;</span><br><span class="line">                            ClearList();</span><br><span class="line">                            <span class="keyword">var</span> count = br.ReadInt32();</span><br><span class="line">                            list =  <span class="keyword">new</span> List&lt;t_AuthorInfo&gt;(count);</span><br><span class="line">                            map = <span class="keyword">new</span> Dictionary&lt;<span class="built_in">int</span>, t_AuthorInfo&gt;(count);</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">var</span> length = br.ReadInt32();</span><br><span class="line">                        <span class="keyword">var</span> data = br.ReadBytes(length);</span><br><span class="line">                        <span class="keyword">var</span> obj= t_AuthorInfoBuffer.deserialize(data, <span class="keyword">ref</span> offset);</span><br><span class="line">                        offset = <span class="number">0</span>;</span><br><span class="line">                        list.Add(obj);</span><br><span class="line">                        map.Add(obj.id, obj); </span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;<span class="keyword">catch</span> (Exception ex)</span><br><span class="line">                &#123;</span><br><span class="line">                    Debug.LogError(<span class="string">&quot;import data error: &quot;</span> + ex.ToString());</span><br><span class="line">                &#125;           </span><br><span class="line">                br.Close();</span><br><span class="line">                fs.Close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Note：</p>
<ol>
<li>占时我ConfLoad.cs加载二进制文件是通过放在Resources目录下以TextAsset形式加载进来，所以加载的时候是没带后缀的，具体ConfLoad代码根据不同的存储位置和加载方式会稍作改动。</li>
</ol>
<h4 id="读取序列化数据"><a href="#读取序列化数据" class="headerlink" title="读取序列化数据"></a>读取序列化数据</h4><p>终于走到最后一步了，完成这一步，导表工具的工具链基本就算打通了。</p>
<p>ConfLoader.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             配置表加载辅助单例类</span></span><br><span class="line"><span class="comment"> * Author:                  tanghuan</span></span><br><span class="line"><span class="comment"> * Create Date:             2018/09/05</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 配置表加载辅助单例类</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ConfLoader</span> : <span class="title">SingletonTemplate</span>&lt;<span class="title">ConfLoader</span>&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Excel表格数据存储目录</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">const</span> <span class="built_in">string</span> ExcelDataFolderPath = <span class="string">&quot;DataBytes/&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ConfLoader</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 获取表格配置数据的二进制流数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;bytefilename&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Stream <span class="title">getStreamByteName</span>(<span class="params"><span class="built_in">string</span> bytefilename</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> textasset = Resources.Load(ExcelDataFolderPath + bytefilename) <span class="keyword">as</span> TextAsset;</span><br><span class="line">        <span class="keyword">var</span> memorystream = <span class="keyword">new</span> MemoryStream(textasset.bytes);</span><br><span class="line">        <span class="keyword">return</span> memorystream;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结合前面的GameManager.cs和所有对应的***Container.cs文件，完成我们对于序列化数据的加载。</p>
<p>激动人心的一刻，PC上成功加载表格数据代码并打印出来:<br><img src="/img/Unity/Data-Config-Automation/ExcelDataLoadAndPrint.png" alt="ExcelDataLoadAndPrint"></p>
<p>遇到个严峻的问题，真机上读取float数据时出了空引用:<br>？大写的问号脸，PC成功了但是真机Android报空？<br>问题猜想1:<br>是不是Xbuffer对于float的序列化或者反序列化没写对？<br>猜想1思考:<br>但仔细一想PC都是对的，这个猜测自然不成立了。</p>
<p>问题猜想2:<br>大小端数据存储的问题？<br>猜想2思考:<br>Windows PC(Intel)和Android Mix2手机(ARM)都是小端，同时真机不是数据错误而是报空，这个猜想也不成立。</p>
<p>问题猜想3:<br>根据报错是在var value &#x3D; <em>(float</em>)(ptr + offset);时报空，那肯定跟字节数据float解析有关。<br>猜想3思考:<br>结合万能的Google，貌似总算找到关键点了。[Google问答](<a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/28436327/monotouch-floating-point-pointer-throws-nullreferenceexception-when-not-4-byte-a]">https://stackoverflow.com/questions/28436327/monotouch-floating-point-pointer-throws-nullreferenceexception-when-not-4-byte-a]</a></p>
<p>原因:<br>上面那个问题提到了ARM设备上对于浮点数(比如floating，double)的值进行dereference要求内存地址必须是4-bytes对齐的形式才能正确解析。</p>
<p>相关知识储备:<br><a target="_blank" rel="noopener" href="http://blog.zhaojie.me/2010/02/byte-order-and-related-library.html">浅谈字节序（Byte Order）及其相关操作</a><br><a target="_blank" rel="noopener" href="https://www.ibm.com/developerworks/library/pa-dalign/">Data alignment: Straighten up and fly right</a></p>
<p>分析当前情况:<br>当前使用Xbuffer对于表格数据的存储只是单纯的按顺序填充数据，没有考虑任何的对齐问题，float数据也是前面的数据填到哪个字节数就在后面填入4bytes的float数据。</p>
<p>解决方案:<br>固定分配一个常驻的byte[4]作为中间缓冲区，在内存地址不满足4byte对齐时进行赋值byte数据然后对满足4byte对齐的常驻byte[4]对象进行解析。</p>
<p>floatBuffer.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">******</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">xbuffer</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">floatBuffer</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">readonly</span> <span class="built_in">uint</span> size = <span class="keyword">sizeof</span>(<span class="built_in">float</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//-------------------------------------------------</span></span><br><span class="line">        <span class="comment">// float在ARM机器上dereferencing浮点数(float,double等)强制要求内存地址4字节对齐，不然会报空</span></span><br><span class="line">        <span class="comment">// 参考链接:</span></span><br><span class="line">        <span class="comment">// https://stackoverflow.com/questions/28436327/monotouch-floating-point-pointer-throws-nullreferenceexception-when-not-4-byte-a</span></span><br><span class="line">        <span class="comment">//-------------------------------------------------</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 修复方案，定义一个全局的4字节byte数组，用于不满足内存地址4字节对齐时赋值用于解析float</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">readonly</span> <span class="built_in">byte</span>[] fourByteAlginedArray = <span class="keyword">new</span> <span class="built_in">byte</span>[<span class="number">4</span>];</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">unsafe</span> <span class="keyword">static</span> <span class="built_in">float</span> <span class="title">deserialize</span>(<span class="params"><span class="built_in">byte</span>[] buffer, <span class="keyword">ref</span> <span class="built_in">uint</span> offset</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">fixed</span> (<span class="built_in">byte</span>* ptr = buffer)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">float</span> <span class="keyword">value</span>;</span><br><span class="line">                <span class="keyword">if</span> ((<span class="built_in">int</span>)(ptr + offset) % <span class="number">4</span> == <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">value</span> = *(<span class="built_in">float</span>*)(ptr + offset);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++)</span><br><span class="line">                    &#123;</span><br><span class="line">                        fourByteAlginedArray[i] = (ptr + offset)[i];</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">fixed</span> (<span class="built_in">byte</span>* ptr2 = fourByteAlginedArray)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">value</span> = *(<span class="built_in">float</span>*)(ptr2);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                offset += size;</span><br><span class="line">                <span class="keyword">return</span> BitConverter.IsLittleEndian ? <span class="keyword">value</span> : utils.toLittleEndian((<span class="built_in">uint</span>)<span class="keyword">value</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ******</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>真正激动人心的时刻，真机运行反序列化数据:<br><img src="/img/Unity/Data-Config-Automation/AndroidDeviceExcelDataLoadAndPrint.png" alt="AndroidDeviceExcelDataLoadAndPrint"><br>可以看到我们成功反序列化了表格数据，同时解决了float在真机上dereference问题。</p>
<h4 id="性能和内存开销"><a href="#性能和内存开销" class="headerlink" title="性能和内存开销"></a>性能和内存开销</h4><p>工具链虽然打通了，但是我们我不只是要考虑能不能用，更多的我们还要关心内存开始以及序列化反序列化的速度性能问题。</p>
<p>接下来就是通过大数据配置来测试内存分配和序列化性能问题。</p>
<p>测试用例:<br>两张表（author_info.xlsx和global_config.xlsx），各配置了994行数据，然后复制两张表9次并改名(文件名和Excel内部sheet名都得改)(总计20张表 X 994行数据)。</p>
<p>测试平台：<br>PC Windows</p>
<p>导表耗时:<br><img src="/img/Unity/Data-Config-Automation/XbufferExcelToDataTimeConsume.png" alt="XbuuferExcelToDataTimeConsume"></p>
<p>导表后的二进制文件大小(未压缩):<br>二进制数据总大小我统计了下未压缩是1.3M。</p>
<p>表格数据读取内存以及反序列化时间开销：<br>我通过Unity的Profiler.GetMonoUsedSizeLong()统计计算堆内存的开销：<br>统计类:<br>MonoMeoryProfiler.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             MemoryProfiler.cs</span></span><br><span class="line"><span class="comment"> * Author:                  TONYTANG</span></span><br><span class="line"><span class="comment"> * Create Date:             2018/08/08</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> UnityEngine.Profiling;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> MemoryProfiler.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 简陋的内存统计工具(统计托管的Mono内存)</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MonoMemoryProfiler</span> : <span class="title">SingletonTemplate</span>&lt;<span class="title">MonoMemoryProfiler</span>&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 内存Profile类型</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">enum</span> MemoryProfilerType</span><br><span class="line">    &#123;</span><br><span class="line">        CSharp_GC = <span class="number">1</span>,          <span class="comment">// CS GC统计</span></span><br><span class="line">        Unity_Profiler = <span class="number">2</span>      <span class="comment">// Unity Profiler接口统计</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 当前内存统计类型</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> MemoryProfilerType mCurrentMemoryProfilerType = MemoryProfilerType.Unity_Profiler;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 内存标签名</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">string</span> mTagName;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 开始统计时总共使用的Mono内存</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">long</span> mTotalUsedMonoMemory_Begin;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 结束统计时总共使用的Mono内存</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">long</span> mTotalUsedMonoMemory_End;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 设置当前内存统计类型</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;mpt&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMemoryProfilerType</span>(<span class="params">MemoryProfilerType mpt</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        mCurrentMemoryProfilerType = mpt;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 开启内存统计Tag</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;tag&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">beginMemorySample</span>(<span class="params"><span class="built_in">string</span> tag</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(!tag.IsNullOrEmpty())</span><br><span class="line">        &#123;</span><br><span class="line">            mTagName = tag;</span><br><span class="line">            <span class="keyword">if</span> (mCurrentMemoryProfilerType == MemoryProfilerType.CSharp_GC)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 确保得到正确的起始Heap Memory Size</span></span><br><span class="line">                mTotalUsedMonoMemory_Begin = GC.GetTotalMemory(<span class="literal">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (mCurrentMemoryProfilerType == MemoryProfilerType.Unity_Profiler)</span><br><span class="line">            &#123;</span><br><span class="line">                GC.Collect();</span><br><span class="line">                mTotalUsedMonoMemory_Begin = Profiler.GetMonoUsedSizeLong();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">&quot;MonoMemoryProfiler的Tag不能为空!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 结束内存统计</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">endMemorySample</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(!mTagName.IsNullOrEmpty())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (mCurrentMemoryProfilerType == MemoryProfilerType.CSharp_GC)</span><br><span class="line">            &#123;</span><br><span class="line">                mTotalUsedMonoMemory_End = GC.GetTotalMemory(<span class="literal">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (mCurrentMemoryProfilerType == MemoryProfilerType.Unity_Profiler)</span><br><span class="line">            &#123;</span><br><span class="line">                GC.Collect();</span><br><span class="line">                mTotalUsedMonoMemory_End = Profiler.GetMonoUsedSizeLong();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> heapmemoryoffset = mTotalUsedMonoMemory_End - mTotalUsedMonoMemory_Begin;            </span><br><span class="line">            Debug.Log(<span class="built_in">string</span>.Format(<span class="string">&quot;内存统计标签 : &#123;0&#125;&quot;</span>, mTagName));</span><br><span class="line">            Debug.Log(<span class="built_in">string</span>.Format(<span class="string">&quot;当前Mono内存大小 = &#123;0&#125; Bytes&quot;</span>, mTotalUsedMonoMemory_End));</span><br><span class="line">            Debug.Log(<span class="built_in">string</span>.Format(<span class="string">&quot;之前Mono内存大小 = &#123;0&#125; Bytes&quot;</span>, mTotalUsedMonoMemory_Begin));</span><br><span class="line">            Debug.Log(<span class="built_in">string</span>.Format(<span class="string">&quot;总共Mono内存占用 = &#123;0&#125; Bytes == &#123;1&#125; KB == &#123;2&#125; M&quot;</span>, heapmemoryoffset, heapmemoryoffset / <span class="number">1024</span> , heapmemoryoffset / (<span class="number">1024</span> * <span class="number">1024</span>)));</span><br><span class="line">            mTagName = <span class="built_in">string</span>.Empty;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>PC:<br><img src="/img/Unity/Data-Config-Automation/Profiler_GetMonoUsedSizeLong_MemoryUsing.png" alt="Profiler_GetMonoUsedSizeLong_MemoryUsing"></p>
<p>Android真机:<br><img src="/img/Unity/Data-Config-Automation/AndroidDevice_Profiler_GetMonoUsedSizeLong_MemoryUsing.png" alt="AndroidDevice_Profiler_GetMonoUsedSizeLong_MemoryUsing"></p>
<p>可以看到两种方式统计有不少误差，在5M左右的堆内存开销。<br>时间开销PC在100ms左右,Android真机在200ms左右。</p>
<p>从20张表，每张表大概4-7个字段，各1000行数据来看，内存和序列化，反序列化速度都还是相当可观的。这里因为没有集成支持其他序列化方式，所以没法做详细的对比，详细各序列化库性能对比参考Xbuffer作者在Github上的对比<a target="_blank" rel="noopener" href="https://github.com/CodeZeg/xbuffer">Xbuffer</a>。</p>
<h4 id="优化点"><a href="#优化点" class="headerlink" title="优化点"></a>优化点</h4><p>未来需要支持和优化的工作点：</p>
<ol>
<li>支持多维数据的配置(放弃支持)<br>方案1：<br>- 扩展到多维不定长数组<br>问题：<br>- 每一个维度上的数组长度都是不定长的，用多维数组存储会伴随多维数组的维度以及各维度的数量级增长，导致各维度各数量级上的长度信息存储过多(占用过多的二进制字节数据)。<br>- 同时会需要不定长的多维数组来支持，序列化和反序列化都很复杂<br>- 需要扩展Xbuffer的维度支持<br>方案2：<br>- 扩展到多维定长数组<br>结论：<br>不太可行，空间不浪费，各维度数组长度信息过于复杂，实现过于复杂<br>问题：<br>- 只需要存储各个维度上的长度信息，维度长度信息和维度成正比，数量级小易存储<br>- 在配置复杂的不定长数据时，定长数组存储会造成大量的数据空间浪费<br>- 序列化代码依然复杂，反序列化代码相对简单<br>- 需要扩展Xbuffer的维度支持<br>结论：<br>可行，空间比较浪费，多维度数组信息存储简单，实现相对复杂<br>方案3：<br>- 多维数据依然存储在一个一维数组里，通过一维数组索引去访问<br>问题：<br>- 数据存储空间不存在浪费<br>- 不需要扩展Xbuffer多维度支持<br>- 序列化和反序列化代码简单<br>- 无法像多维数组形式方便快速索引数据，只能计算好对应索引值去访问索引数据(数据量配置一旦大了，访问复杂度成指数级成长)<br>- 对于数据配置的抽象不友好们无法快速访问指定部分数据(相当于一维数组的单个字符分割，这样一来没有意义了)<br>结论：<br>可行，空间不浪费，实现简单，访问和理解都不友好，配置复杂度影响访问复杂度。但变相成了一维数组的单个字符分割，没有意义了。<br>最终结论：<br>没有想到好的方式支持，最终放弃了支持多维数据的解析和快速访问。<br>多维数据配置建议:<br>- 可以采用配置多个一维数组映射来支持。<br>- 获取一维数组配置后，自己去split分割访问解析。</li>
<li>支持单列允许填写notation数据类型作为注释类型，单纯作为excel可查看的注释不序列化到数据里。(<strong>完成</strong>)<ul>
<li>修改导表工具支持notation数据类型配置作为注释类型</li>
<li>修改导表生成二进制数据那里不序列化注释类型数据</li>
</ul>
</li>
<li>支持个数据类型不配置，直接使用各类型默认值的方式(<strong>完成</strong>)<ul>
<li>修改导表公安局二进制数据序列化时判定书否有数据，没有数据用各类型默认数据</li>
</ul>
</li>
<li>二进制数据的压缩(暂时未做)<ul>
<li>对序列化好的二进制数据可以进行一些压缩格式的压缩后然后运行时解压的形式实现数据压缩</li>
</ul>
</li>
<li>支持单Excel多Sheet导出(<strong>2022&#x2F;1&#x2F;20完成</strong>)</li>
<li>支持Sheet黑名单，blacklist开头的Sheet名不参与导表(<strong>2022&#x2F;1&#x2F;20完成</strong>)</li>
<li>第一列字段名不限，同时类型支持int和string(<strong>2022&#x2F;1&#x2F;20完成</strong>)</li>
</ol>
<h4 id="Github"><a href="#Github" class="headerlink" title="Github"></a>Github</h4><p>最后给出工具的Github链接:<br><a target="_blank" rel="noopener" href="https://github.com/TonyTang1990/XbufferExcellToData">XbufferExcelToData</a><br>上面写了导表工具的详细支持和测试信息。</p>
<h4 id="学习总结"><a href="#学习总结" class="headerlink" title="学习总结"></a>学习总结</h4><ol>
<li>高效的数据序列化和反序列化不是语言自带的序列化和反序列化方式(很有可能默认使用了反射之类的)而是直接对于内存的数据的快速访问解析(比如flatbuffer，Xbuffer最终都是采用一个扁平化的字节数组对数据进行存储访问)</li>
<li>更进一步的数据压缩是对于基础数据类型的存储格式与数据解析定义(比如Protobuf里Varint数据存储方式)</li>
<li>跨语言的序列化反序列化只要定义统一的字节流写入和读取即可。</li>
<li>数据向后兼容问题(这里需要向Flatbuffer和Protobuf对于数据的存储做更多的处理才能做到)</li>
<li>完整的工具链要考虑的不仅仅是数据的存储和加载，还要关注自动化相关代码的生成(比如通过模板定义做到对多语言工具链的支持)。</li>
<li>二进制数据的处理需要关注大小端问题(不同CPU数据存储方式不一样)，内存对齐问题(不同架构比如ARM和Intel对于浮点数的dereference就有内存4字节对齐的要求)。</li>
<li>强大的正则表达式在做模板问题处理时，相当优秀。</li>
</ol>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><h2 id="Conception-Part"><a href="#Conception-Part" class="headerlink" title="Conception Part"></a>Conception Part</h2><p><a target="_blank" rel="noopener" href="https://github.com/google/protobuf">protobuf</a><br><a target="_blank" rel="noopener" href="https://github.com/google/flatbuffers">FlatBuff</a><br><a target="_blank" rel="noopener" href="https://github.com/CodeZeg/xbuffer">Xbuffer</a></p>
<h2 id="Knowlodge-Part"><a href="#Knowlodge-Part" class="headerlink" title="Knowlodge Part"></a>Knowlodge Part</h2><p><a target="_blank" rel="noopener" href="https://www.race604.com/flatbuffers-intro/">FlatBuffers 体验</a><br><a target="_blank" rel="noopener" href="https://github.com/google/flatbuffers/releases">Flatc</a><br><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/30ef9b3780d9">Protocol Buffer 序列化原理大揭秘 - 为什么Protocol Buffer性能这么好？</a><br><a target="_blank" rel="noopener" href="https://www.xcode.me/more/microsoft-net-framework-version-define">Microsoft .NET Framework 版本定义</a><br><a target="_blank" rel="noopener" href="https://www.ibm.com/developerworks/library/pa-dalign/">Data alignment: Straighten up and fly right</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/ce123_zhouwei/article/details/6971544">详解大端模式和小端模式</a><br><a target="_blank" rel="noopener" href="http://www.ruanyifeng.com/blog/2016/11/byte-order.html">理解字节序</a><br><a target="_blank" rel="noopener" href="http://blog.zhaojie.me/2010/02/byte-order-and-related-library.html">浅谈字节序（Byte Order）及其相关操作</a></p>
<h2 id="Other-Part"><a href="#Other-Part" class="headerlink" title="Other Part"></a>Other Part</h2><p><a href="blog.csdn.net/qq_14903317/article/details/78637440">Unity C#配置表工具</a><br><a target="_blank" rel="noopener" href="http://www.mamicode.com/info-detail-494944.html">Unity3D游戏开发之当游戏开发遇上Excel</a><br><a target="_blank" rel="noopener" href="http://www.xuanyusong.com/archives/2429">Unity3D研究院之MAC&amp;Windows跨平台解析Excel（六十五）</a><br><a target="_blank" rel="noopener" href="https://github.com/ExcelDataReader/ExcelDataReader">ExcelReader</a><br><a target="_blank" rel="noopener" href="https://www.race604.com/flatbuffers-intro/">FlatBuffers 体验</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="Previous page" aria-label="Previous page" href="/page/2/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" title="Next page" aria-label="Next page" href="/page/4/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">John Doe</span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script>

  






  





</body>
</html>
