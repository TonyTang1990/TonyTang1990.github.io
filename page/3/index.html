
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  
    <title>走停人生路</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="Tony Tang">
    

    
    <meta property="og:type" content="website">
<meta property="og:title" content="走停人生路">
<meta property="og:url" content="http://tonytang1990.github.io/page/3/index.html">
<meta property="og:site_name" content="走停人生路">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Tony Tang">
<meta name="twitter:card" content="summary">

    
    <link rel="alternative" href="/atom.xml" title="走停人生路" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/jacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/jacman.jpg">
    
    
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 7.3.0"></head>

  <body>
    <header>
      
<div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.png" alt="走停人生路" title="走停人生路"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="走停人生路">走停人生路</a></h1>
				<h2 class="blog-motto">做着独立游戏梦，坚持走在游戏开发道路上的人</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">Home</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
						<li><a href="/about">About</a></li>
					
					<li>
 					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="search" id="search" name="q" autocomplete="off" maxlength="20" placeholder="搜索" />
						<input type="hidden" name="q" value="site:tonytang1990.github.io">
					</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main">

   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2020/02/01/Unity嵌套预制件/" title="Unity嵌套预制件" itemprop="url">Unity嵌套预制件</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Tony Tang" target="_blank" itemprop="author">Tony Tang</a>
		
  <p class="article-time">
    <time datetime="2020-01-31T16:27:00.000Z" itemprop="datePublished"> 发表于 2020-02-01</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>本篇文章是为了记录学习Unity官方最新推出的嵌套预制件工作流的相关知识，深入理解新版嵌套预制件的设计思路与使用工作流。</p>
<p>达到以下几个目标：</p>
<ol>
<li>理解新版嵌套预制件带来的好处</li>
<li>如何避免Unity版本升级过程中预制件相关操作工具不兼容等问题。</li>
<li>设计新的预制件相关工具时考虑新老版本预制件工作流问题。</li>
</ol>
<h2 id="Prefab"><a href="#Prefab" class="headerlink" title="Prefab"></a>Prefab</h2><p>首先我们先来了解下什么是预制件(Prefab)？<br><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/Prefabs.html"> **Unity’s Prefab system allows you to create, configure, and store a GameObject complete with all its components, property values, and child GameObjects<br> as a reusable Asset. The Prefab Asset acts as a template from which you can create new Prefab instances in the SceneA Scene contains the environments and menus of your game. Think of each unique Scene file as a unique level. In each Scene, you place your environments, obstacles, and decorations, essentially designing and building your game in pieces. More info<br>See in Glossary. </a></p>
<p><strong>根据官网的介绍我们可以得知，在Unity中Prefab和纹理，材质，音效一样都是一种资源格式，预制件(Prefab)其实是一个资源载体(e.g. GameObject包含层级以及多种Component脚本做成的重用实体对象)，为了方便重复使用做好的资源模版。</strong></p>
<p>老版本预制件系统问题：</p>
<ol>
<li>不支持嵌套预制件</li>
<li>不支持变体预制件(后续会介绍)</li>
</ol>
<p>新版本预制件很好的解决了上面说到的两个问题。</p>
<p><strong>新版预制件在Unity 2018.3推出</strong><br>新版预制件主要由以下三个部分组成：</p>
<ol>
<li>嵌套预制件</li>
<li>预制件变体</li>
<li>预制件模式</li>
</ol>
<p>接下来挨个学习上面三个部分。</p>
<p>Note：<br><strong>新版Prefab是一种Asset，但打开处理的时候更多的是一种对Content的封装的概念，打开Prefab Mode是指打开Prefab浏览编辑Prefab Content</strong></p>
<h3 id="嵌套预制件"><a href="#嵌套预制件" class="headerlink" title="嵌套预制件"></a>嵌套预制件</h3><p>嵌套预制件顾名思义是指预制件之间是允许引用使用的关系而不是完全独立复制使用的概念。<br>老版本预制件系统就是采用复制实体引用的方式。<br><strong>而新版嵌套预制件是采用真实预制件引用的方式。</strong></p>
<p>嵌套预制件举例说明：<br>预制件A里用到了预制件B，如果我们修改预制件B，那么预制件A应该是自动更新变化。</p>
<p>嵌套预制件实战：<br>如下所示，我们制作了三个预制件，分别是Prefab_Cube_A,Prefab_Sphere_B以及Prefab_A_And_B,其中前两者是独立的预制件，最后一个是使用前两个预制件拼接而成的新的预制件。<br><img src="/img/Unity/NestedPrefab/NestedPrefabExample.png" alt="NestedPrefabExample"></p>
<p>可以看到嵌套的预制件在新的预制件下是蓝色的(意味着是关联了特定预制件的意思)，为了验证嵌套预制件，我简单的修改Prefab_Cube_A颜色来达到实现我们预期的嵌套预制件是引用关系的验证：<br><img src="/img/Unity/NestedPrefab/NestedPrefabChangeMat.png" alt="NestedPrefabChangeMat"><br>可以看到我们只修改了预制件Prefab_Cube_A的材质，但嵌套使用该预制件的Prefab_A_And_B里的Prefab_A也跟着变化了，这就是前面所提到的<strong>嵌套预制件的概念(嵌套引用关系而非实例化新个体)</strong></p>
<h3 id="预制件变体"><a href="#预制件变体" class="headerlink" title="预制件变体"></a>预制件变体</h3><p>预制件变体的概念类似于编程里继承的概念，继承属性的同时，父预制件的修改也会影响到子预制件变体。</p>
<p><strong>预制件变体不仅继承了父预制件的状态数据，还跟父预制件是强制关联的。</strong><br>举例说明：<br>通过预制件A创建预制件变体A2，当我们改变A时，A2继承的相同属性会跟着变化<br><img src="/img/Unity/NestedPrefab/NestedPrefabPrefabVariant.png" alt="NestedPrefabPrefabVariant"><br><img src="/img/Unity/NestedPrefab/NestedPrefabChangeVariantParent.png" alt="NestedPrefabChangeVariantParent"></p>
<p>适用情况：</p>
<ol>
<li>需要在个别Prefab基础上做少许做成预制件使用，同时需要同步父预制件修改的情况下。</li>
</ol>
<p>Note:</p>
<ol>
<li><strong>预制件变体可以理解成封装了一层Prefab的Prefab Asset</strong></li>
<li><strong>预制件变体的Content根节点时Prefab而Prefab的Content根节点时GameObject</strong></li>
</ol>
<h3 id="新版预制件工作流"><a href="#新版预制件工作流" class="headerlink" title="新版预制件工作流"></a>新版预制件工作流</h3><p>Prefab有两种状态：</p>
<ol>
<li>Prefab Asset(Prefab资源)</li>
<li>Prefab Instance(Prefab实例对象–场景里是蓝色的)<br>Prefab Instance和Prefab Asset之间是关联着的，跟老版预制件里的概念是一致的。我们可以通过修改Prefab Instance然后把改变Apply到Prefab Asset上。<strong>新版预制件有区别的是支持Component级别的Apply和Revert。</strong><br><img src="/img/Unity/NestedPrefab/NestedPrefabComponentApply.png" alt="NestedPrefabComponentApply"></li>
</ol>
<p>还有一种独立于预制件的状态：实例对象<br><img src="/img/Unity/NestedPrefab/UnpackPrefabInstance.png" alt="UnpackPrefabInstance"><br>于预制件无关的实体对象是黑色的而非蓝色:<br><img src="/img/Unity/NestedPrefab/NestedPrefabUnpackPrefabColor.png" alt="NestedPrefabUnpackPrefabColor"><br><strong>这里的Unpack相当于解除了Prefab Asset关联直接访问预制件的Content(Prefab Content后续会说到，在新版预制件里很重要的一个概念)</strong></p>
<p>新版预制件有一个新的概念叫做预制件模式，修改并Apply修改到Prefab Asset上有两种方式：</p>
<ol>
<li>直接打开Prefab Mode编辑</li>
<li>修改Prefab Instance后Apply到Prefab Asset上</li>
</ol>
<p>这里重点讲解学习Prefab Mode：<br><strong>Prefab Mode类似单独打开了一个修改预制件的场景，进入新的预制件场景才能看到预制件里的内容，这一点概念很重要</strong><br><img src="/img/Unity/NestedPrefab/NestedPrefabOpenPrefabMode.png" alt="NestedPrefabOpenPrefabMode"><br><img src="/img/Unity/NestedPrefab/NestedPrefabMode.png" alt="NestedPrefabMode"><br>在Prefab Mode下的修改可以通过保存和Undo操作来实现保存到Prefab Asset和撤销操作的效果。</p>
<p>了解了新版Prefab的Prefab Mode概念后，让我们结合相关API来制作一些新版Prefab的处理操作工具来深入理解：<br>需求：<br>检查指定Prefab里是否有无效的脚本挂在(Missing Script)并清除所有无效挂在脚本后保存Prefab Asset<br><img src="/img/Unity/NestedPrefab/NestedPrefabMissingScriptMono.png" alt="NestedPrefabMissingScriptMono"></p>
<p>相关API：</p>
<ol>
<li>AssetDatabase(处理Asset的工具类接口)</li>
<li>Selection(处理Asset资源选中工具类接口)</li>
</ol>
<p>步骤：</p>
<ol>
<li>选中Prefab Asset</li>
<li>判定是否是选中Prefab Asset</li>
<li>打开Prefab Mode</li>
<li>查找并删除所有Missing Script</li>
<li>保存Prefab Asset并退出Prefab Mode<br>实现：<br>RemovePrefabMissingScriptTool.cs</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEditor;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 删除预制件无效脚本引用工具</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">RemovePrefabMissingScriptTool</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">MenuItem(<span class="string">&quot;Tools/Assets/移除Missing脚本 #&amp;s&quot;</span>, false)</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">RemoveAllMissingScripts</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 1. 选中Prefab Asset</span></span><br><span class="line">        <span class="keyword">var</span> selections = Selection.GetFiltered(<span class="keyword">typeof</span>(Object), SelectionMode.Assets | SelectionMode.DeepAssets);</span><br><span class="line">        Debug.Log(<span class="string">$&quot;选中有效数量:<span class="subst">&#123;selections.Length&#125;</span>&quot;</span>);</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> selection <span class="keyword">in</span> selections)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(IsPrefabAsset(selection))</span><br><span class="line">            &#123;</span><br><span class="line">                RemovePrefabAllMissingScripts(selection <span class="keyword">as</span> GameObject);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                Debug.LogError(<span class="string">$&quot;不符合预制件要求的Asset:<span class="subst">&#123;selection.name&#125;</span>&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        AssetDatabase.SaveAssets();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 是否是预制件资源</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;obj&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">bool</span> <span class="title">IsPrefabAsset</span>(<span class="params">Object obj</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(obj <span class="keyword">is</span> GameObject)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> assetpath = AssetDatabase.GetAssetPath(obj);</span><br><span class="line">            <span class="keyword">return</span> !<span class="built_in">string</span>.IsNullOrEmpty(assetpath);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 移除预制件Asset所有无效的脚本</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">RemovePrefabAllMissingScripts</span>(<span class="params">GameObject go</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 3. 打开Prefab Mode</span></span><br><span class="line">        <span class="comment">// 4. 查找并删除所有Missing Script</span></span><br><span class="line">        <span class="comment">// 5. 保存Prefab Asset并推出Prefab Mode)</span></span><br><span class="line">        <span class="keyword">var</span> assetpath = AssetDatabase.GetAssetPath(go);</span><br><span class="line">        <span class="keyword">var</span> contentsRoot = PrefabUtility.LoadPrefabContents(assetpath);</span><br><span class="line">        RemoveAllMissingScripts(contentsRoot);</span><br><span class="line">        PrefabUtility.SaveAsPrefabAsset(contentsRoot, assetpath);</span><br><span class="line">        PrefabUtility.UnloadPrefabContents(contentsRoot);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 移除无效的脚本</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">RemoveAllMissingScripts</span>(<span class="params">GameObject go</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Component[] components = go.GetComponents&lt;Component&gt;();</span><br><span class="line">        <span class="keyword">var</span> r = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">var</span> serializedObject = <span class="keyword">new</span> SerializedObject(go);</span><br><span class="line">        <span class="keyword">var</span> prop = serializedObject.FindProperty(<span class="string">&quot;m_Component&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; components.Length; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (components[i] == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">string</span> s = go.name;</span><br><span class="line">                Transform t = go.transform;</span><br><span class="line">                <span class="keyword">while</span> (t.parent != <span class="literal">null</span>) </span><br><span class="line">                &#123;</span><br><span class="line">                    s = t.parent.name +<span class="string">&quot;/&quot;</span>+s;</span><br><span class="line">                    t = t.parent;</span><br><span class="line">                &#125;</span><br><span class="line">                Debug.Log (s + <span class="string">&quot; has an empty script attached in position: &quot;</span> + i, go);</span><br><span class="line"></span><br><span class="line">                prop.DeleteArrayElementAtIndex(i - r);</span><br><span class="line">                r++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        serializedObject.ApplyModifiedProperties();</span><br><span class="line">        <span class="keyword">foreach</span> (Transform childT <span class="keyword">in</span> go.transform)</span><br><span class="line">        &#123;</span><br><span class="line">            RemoveAllMissingScripts(childT.gameObject);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>核心思想是因为Missing Component本来就为Null无法向常规Component那样DestroyImmediate，需要通过SerializedObject去获取Component的方式删除指定位置的Component。</p>
<p>此脚本只针对单个预制件内容进行修改，嵌套预制件需要通过批量多选的方式实现各自移除各自身上的Missing Script来实现移除所有Missing脚本。</p>
<p>了解了Prefab Mode的存在，那么如何监听Prefab Mode的打开关闭生命周期了？<br>这里我们需要用到<strong>PrefabStage</strong> API(新版Prefab Mode下打开保存相关生命周期工具类接口)<br>这里只是简单的做个API实验，看看PrefabStage是否起作用。<br>PrefabStageListener.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEditor.Experimental.SceneManagement;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 新版预制件生命周期监听</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">ExecuteInEditMode</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PrefabStageListener</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Start</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        PrefabStage.prefabSaved += OnPrefabSaved;</span><br><span class="line">        PrefabStage.prefabSaving += OnPrefabSaving;</span><br><span class="line">        PrefabStage.prefabStageOpened += OnPrefabOpened;</span><br><span class="line">        PrefabStage.prefabStageClosing += OnPrefabClosing;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnDestroy</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        PrefabStage.prefabSaved -= OnPrefabSaved;</span><br><span class="line">        PrefabStage.prefabSaving -= OnPrefabSaving;</span><br><span class="line">        PrefabStage.prefabStageOpened -= OnPrefabOpened;</span><br><span class="line">        PrefabStage.prefabStageClosing -= OnPrefabClosing;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 响应预制件内容保存完毕</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;go&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnPrefabSaved</span>(<span class="params">GameObject go</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Debug.Log(<span class="string">&quot;预制件内容保存完毕!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 响应预制件内容保存</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;go&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnPrefabSaving</span>(<span class="params">GameObject go</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Debug.Log(<span class="string">&quot;预制件内容保存!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 响应预制件内容打开</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;prefabstage&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnPrefabOpened</span>(<span class="params">PrefabStage prefabstage</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Debug.Log(<span class="string">&quot;打开预制件内容!&quot;</span>);</span><br><span class="line">        Debug.Log(<span class="string">$&quot;预制件:<span class="subst">&#123;prefabstage.prefabAssetPath&#125;</span> 内容阶段:<span class="subst">&#123;prefabstage.stageHandle&#125;</span>&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 响应预制件内容关闭</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;prefabstage&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnPrefabClosing</span>(<span class="params">PrefabStage prefabstage</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Debug.Log(<span class="string">&quot;关闭预制件内容!&quot;</span>);</span><br><span class="line">        Debug.Log(<span class="string">$&quot;预制件:<span class="subst">&#123;prefabstage.prefabAssetPath&#125;</span> 内容阶段:<span class="subst">&#123;prefabstage.stageHandle&#125;</span>&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结果:<br><img src="/img/Unity/NestedPrefab/PrefabStageListener.png" alt="PrefabStageListener"><br><strong>PrefabStage.prefabStageOpened全局监听不起作用(原因未知，忘知道的朋友告知)。PrefabStage.prefabStageClosing能正确工作。</strong></p>
<p>Note:<br><strong>Prefab Mode模式下修改叫做Save而非Apply，因为已经处于Prefab Content模式下了</strong></p>
<h3 id="进阶"><a href="#进阶" class="headerlink" title="进阶"></a>进阶</h3><p>PrefabUtility(操作处理Prefab的工具类接口)</p>
<p>更多学习，待续……</p>
<h2 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h2><ol>
<li>支持嵌套预制件，能更高效的利用预制件，节约预制件的资源大小</li>
<li>支持预制件变体，能更高效的制作只有细微变化且有关联的相关预制件，增加开发效率</li>
<li>新版预制件最大区别就是提出了Prefab Mode的概念，让预制件在一个独立的环境进行编辑，进入Prefab Mode编辑的是Prefab Content而非Prefab本身。</li>
</ol>
<h1 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h1><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/Prefabs.html">Prefabs Manual</a><br><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/283752d80737">详解新版Unity中可嵌套的Prefab系统</a><br><a target="_blank" href="https://www.youtube.com/embed/b9wfVzkubzA?autoplay=1&amp;disablekb=1&amp;iv_load_policy=3&amp;modestbranding=1&amp;showinfo=0&amp;html5=1&amp;rel=0">Introducing the new prefab workflow - Unity at GDC 2019</a><br><a target="_blank" rel="noopener" href="https://www.youtube.com/embed/5q1An6SFe40?autoplay=1&disablekb=1&iv_load_policy=3&modestbranding=1&showinfo=0&html5=1">Unite LA 2018 - Introducing the New Prefab Workflow</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/Prefab/">Prefab</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2019/11/25/Unity官方插件/" title="Unity官方插件" itemprop="url">Unity官方插件</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Tony Tang" target="_blank" itemprop="author">Tony Tang</a>
		
  <p class="article-time">
    <time datetime="2019-11-25T13:27:18.000Z" itemprop="datePublished"> 发表于 2019-11-25</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>本篇文章是为了记录学习Unity官方一些好的第三方插件，作为基础的学习了解，为未来遇到问题思考解决方案时拓宽思路。</p>
<h2 id="Sprite-Atlas"><a href="#Sprite-Atlas" class="headerlink" title="Sprite Atlas"></a>Sprite Atlas</h2><p>依然从What，Why，How三个角度了学习了解Sprite Atlas。</p>
<h3 id="What"><a href="#What" class="headerlink" title="What"></a>What</h3><p>Sprite Atlas是官方Sprite Packer的升级版本，是为了更好的解决图集打包加载问题而开发的，而图集是为了解决Draw Call问题。</p>
<h3 id="Why"><a href="#Why" class="headerlink" title="Why"></a>Why</h3><p>老版Unity的时候，图集打包功能(SpritePacker,打Tag的方式)并不完善，更多的是采用第三方好比TexturePacker打包图集在放到Unity项目里的工作流。</p>
<p>Sprite Atlas主要提供了以下三个功能:<br>1.创建、编辑图集以及设定图集参数<br>2.添加图集Variant（变种）<br>3.运行时访问图集</p>
<p>新版Sprite Atals已经很完善了，考虑到以下几个原因，决定学习官方的打包图集工具跟着官方走:</p>
<ol>
<li>TexturePacker是付费的,Sprite Atlas免费</li>
<li>Sprite Atlas是官方的，跟官方走一般来说不会错</li>
<li>Spritre Atlas已经成熟可以商用的级别</li>
</ol>
<h3 id="How"><a href="#How" class="headerlink" title="How"></a>How</h3><p>使用Sprite Atlas之前，我们需要打开Sprite Atlas功能开关：<br>Edit -&gt; Project Setting -&gt; Editor -&gt; Sprite Packer -&gt; Mode(Always Enable)<br><img src="/img/Unity/SpriteAtlas/EnableSpriteAtlas.png" alt="EnableSpriteAtlas"></p>
<h4 id="创建、编辑图集以及设定图集参数"><a href="#创建、编辑图集以及设定图集参数" class="headerlink" title="创建、编辑图集以及设定图集参数"></a>创建、编辑图集以及设定图集参数</h4><p>在Sprite Atlas里Sprite Atlas是作为一种资源(Asset)存在。<br>创建Sprite Atlas：<br>右键 -&gt; Sprite Atlas</p>
<p>选中创建的Sprite Atlas我们能看到相关设置:<br><img src="/img/Unity/SpriteAtlas/SpriteAtlasSetting.png" alt="SpriteAtlasSetting"><br>这里的设置基本都和图集打包相关，这里就不一一详解了。<br>详情参见官网:<br><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/class-SpriteAtlas.html">Sprite Atlas</a></p>
<p>点击Sprite Atlas -&gt; Pack Preview即可查看打包后的结果:<br><img src="/img/Unity/SpriteAtlas/PackPreview.png" alt="PackPreview"></p>
<p>这里关于Include in Build这个参数要详细说明一下，这个参数会决定一下几方面:</p>
<ol>
<li>影响使用SpriteAtlas图集资源的资源是如何关联SpriteAtlas的(会决定使用该SpriteAtlas资源加载时加载哪一个图集资源–这里指的是有图集Variant的情况)</li>
<li>影响SpriteAtlas是否需要采用Later Bind(触不触发SpriteAtlasManager.atlasRequested接口,通过这个接口结合图集Variant我们可以做到例如不同平台加载不同图集的适配)。反之勾选Include in Build在依赖使用时会自动加载依赖的Sprite Atlas。<br><strong>这里貌似有些Unity版本有个Bug，勾选Include in Build会导致资源打包冗余</strong><br><img src="/img/Unity/SpriteAtlas/IncludeInBuildCauseRedundancySpriteAtlasTexture.png" alt="IncludeInBuildCauseRedundancySpriteAtlasTexture"></li>
</ol>
<p>针对第一条详情参考:<br><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/SpriteAtlasScenarios.html">Resolving different Sprite Atlas scenarios</a></p>
<p>Note:</p>
<ol>
<li><strong>Sprite Atlas支持Objects for Packing设置文件夹</strong></li>
<li><strong>参与打包的图片必须设置成Sprite(2D and UI)格式</strong></li>
<li><strong>Include in Build会影响SpriteAtlas的选择(比如是否要使用Later Bind等)</strong></li>
</ol>
<h4 id="添加图集Variant（变种）"><a href="#添加图集Variant（变种）" class="headerlink" title="添加图集Variant（变种）"></a>添加图集Variant（变种）</h4><p>什么是图集Variant?<br><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/VariantSpriteAtlas.html">A Variant Sprite Atlas is a type of Sprite Atlas that does not contain its own list of selected Textures as it has no Objects for Packing list in its properties. Instead, it receives a copy of the content from the Sprite Atlas set as its Master Atlas.</a><br>图集Variant是指不能指定打包内容的图集，图集Variant内容来源于复制指定的Master图集。</p>
<p>图集Variant的适用场景?<br>图集Variant的主要目的是为了用于不同分辨率设备适配不同图集来实现，内存和效果的可控。</p>
<p>图集Variant设置适用：<br><img src="/img/Unity/SpriteAtlas/SpriteAtlasVariants.png" alt="SpriteAtlasVariants"><br>可以看到我们创建一个SpriteAtlas把Type设置成Variant后，然后指定Master Atlas，最后通过调节Scale为0.5我们得到了比playerpreview图集小一倍大小的图集效果。</p>
<p>结论:</p>
<p>图集变体是类似Mipmap的东西，通过多打包多个不同大小的图集到游戏里，Unity自动帮我们选择合适的图集来加载，从而做到高分辨率机型加载高分辨率的，低分辨率机型加载低分辨率的，<strong>典型的空间换时间做法</strong>。</p>
<p>Note:</p>
<ol>
<li><strong>要想只打包使用图集Variant，需要把图集Variant的Include in Build打开，把图集Master的Include in Build关闭</strong></li>
</ol>
<h4 id="运行时访问图集"><a href="#运行时访问图集" class="headerlink" title="运行时访问图集"></a>运行时访问图集</h4><p><a target="_blank" rel="noopener" href="https://gameinstitute.qq.com/community/detail/127434">Sprite Atlas作为一种资源开放给用户，支持在脚本中直接访问，还可以通过名字获取图集中的精灵。</a></p>
<p><strong>这里我们采用设置不勾选Include in Build的设置打包SpriteAtlas</strong></p>
<p>接下来我们通过SpriteAtlas接口访问打包AB后的Sprite Atlas里的图片资源试试：<br>首先让我们看看SpriteAtlas打包AB后的的资源数据：<br><img src="/img/Unity/SpriteAtlas/SpriteAtlasAssetBundlePreview.png" alt="SpriteAtlasAssetBundlePreview"><br>可以看到SpriteAtlas作为资源参与AB打包，里面包含了SpriteAtlas，图集Texture2D以及Sprite数据。</p>
<p>这里我们看看UI预制件引用SpriteAtlas看看依赖打包的情况：<br><img src="/img/Unity/SpriteAtlas/UIPrefabReferenceNotIncludeBuildSpriteAtlas.png" alt="UIPrefabReferenceNotIncludeBuildSpriteAtlas"><br>从上面可以看出UI窗口预制件包含了依赖的Sprite(这里和以前不一样，以前是不会包含依赖的Sprite的，会直接通过依赖关系加载依赖AB实现自动还原)，个人猜测这个和后续讲到的SpriteAtlas的Later Bind有关。</p>
<p>加载UI窗口预制件后发现Sprite Missing了:<br><img src="/img/Unity/SpriteAtlas/UIPrefabSpriteMissing.png" alt="UIPrefabSpriteMissing"><br>通过查看依赖文件我发现依赖信息是没有对SpriteAtlas的依赖信息的。<strong>不知道这算不算是一个Bug还是设计如此，因为没有依赖信息对资源加载管理会造成问题，忘知道的朋友告知。</strong><br><img src="/img/Unity/SpriteAtlas/UIPrefabDepencency.png" alt="UIPrefabDepencency"></p>
<p>问题:</p>
<ol>
<li><strong>加载使用SpriteAtlas的UI Prefab，SpriteAtlas会自动加载进内存且没有依赖信息。但如果此时主动加载了Sprite Atlas并主动强制卸载该Sprite Atlas的AB会导致UI Prefab使用的Sprite Atlas也跟随被清除。从这里看出UI Prefab对Sprite Atlas的依赖信息是有必要的，不然没法正确的管理资源加载。</strong></li>
</ol>
<p>这里引申出了SpriteAtlas一个很重要的功能，<strong>Later Bind</strong></p>
<p>Note:</p>
<ol>
<li><strong>图集的被动(依赖)加载管理会有使用该图集的资源所决定(比如UI Prefab使用了SpriteAtlas，两个分别打包AB，这时加载UI Prefab后SpriteAtlas会自动加载进内存，而UI Prefab卸载以后，SpriteAtlas没有其他主动加载该SpriteAtlas的会自动卸载。)</strong></li>
</ol>
<h5 id="Later-Bind"><a href="#Later-Bind" class="headerlink" title="Later Bind"></a>Later Bind</h5><p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/80584461">SpritePacker时代“图集”我们是看不到的，因为设计者的初衷是想让开发者完全不用考虑图集的事。但是，这跟游戏开发时的动态加载图集时矛盾的！我们要动态加载就必须要知道atlas名字和sprite名，这样才能在 运行时动态的找到一张sprite！所以U3D程序员必须要清楚的知道你当前界面用的是哪atlas的哪个sprite。但是按照SpritePacker的做法他的初衷应该是想把图集干掉（干掉的意思让开发者不用关心），只需要考虑sprite即可，但是这是行不通的！<br>**SpriteAtlas其实就是为了解决上面说的问题而发布的功能。通过它我们可以将atlas和UIprefab“解耦”。同时，在Unity编辑器状态下我们仍然可以利用未打成SpriteAtlas的Sprite进行开发。等开发完成我们再发布成SpriteAtlas。**Unity提供了所谓“延迟绑定”（late bind）的技术来让我们实现这个功能。</a></p>
<p>AtlasManager.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">AtlasManager</span> : <span class="title">SingletonTemplate</span>&lt;<span class="title">AtlasManager</span>&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AtlasManager</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        DIYLog.Log(<span class="string">&quot;添加SpriteAtals图集延时绑定回调!&quot;</span>);</span><br><span class="line">        SpriteAtlasManager.atlasRequested += onAtlasRequested;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 响应SpriteAtlas图集加载回调</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;atlasname&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;callback&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onAtlasRequested</span>(<span class="params"><span class="built_in">string</span> atlasname, Action&lt;SpriteAtlas&gt; callback</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        DIYLog.Log(<span class="string">$&quot;加载SpriteAtlas:<span class="subst">&#123;atlasname&#125;</span>&quot;</span>);</span><br><span class="line">        <span class="comment">// Later Bind -- 依赖使用SpriteAtlas的加载都会触发这里</span></span><br><span class="line">        ResourceModuleManager.Singleton.requstResource(</span><br><span class="line">        atlasname,</span><br><span class="line">        (abi) =&gt;</span><br><span class="line">        &#123;</span><br><span class="line">            DIYLog.Log(<span class="string">$&quot;Later Bind加载SpriteAtlas:<span class="subst">&#123;atlasname&#125;</span>&quot;</span>);</span><br><span class="line">            <span class="keyword">var</span> sa = abi.loadAsset&lt;SpriteAtlas&gt;(atlasname);</span><br><span class="line">            callback(sa);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在加载使用SpriteAtlas(<strong>仅当设置成不勾选Include in Build</strong>)的相关资源时(比如UI Prefab)上诉回调会被触发完成对SpriteAtlas的加载，确保引用的Sprite能正确显示。同时这一机制就允许我们做到不同平台的不同图集资源加载适配这样的功能。</p>
<p>疑问:</p>
<ol>
<li>Later Bind只是加载SpriteAtlas提供的一个回调接口(无论是主动还是被动(依赖)加载)，回调接口内只知道加载了指定的SpriteAtlas却不知道具体的详细用法，这样一来基于对象绑定和索引计数的资源管理系统就无法正确的加载管理了(因为被动(依赖)加载得不到SpriteAtlas的依赖信息)。</li>
</ol>
<p>个人方案：</p>
<ol>
<li>当前这套基于对象绑定和索引计数的方案暂时没想到好的方案，可能需要对SpriteAtals的资源管理单独做一套管理策略来支持Later Bind的用法。有更好方案的朋友，望告知。</li>
</ol>
<h5 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h5><ol>
<li>开启Sprite Packer的设置Sprite Packer -&gt; Mode(Always Enable)只决定图集合成时机(比如是运行时还是打包时还是编辑器时)。</li>
<li>Sprite Atlas支持Objects for Packing设置文件夹</li>
<li>参与打包的图片必须设置成Sprite(2D and UI)格式</li>
<li><strong>Include in Build会影响SpriteAtlas图集资源的资源是如何关联SpriteAtlas(比如影响是否需要使用Later Bind,不勾选需要使用Later Bind否则会报警告)</strong></li>
</ol>
<h5 id="相关概念"><a href="#相关概念" class="headerlink" title="相关概念"></a>相关概念</h5><ol>
<li>Sprite Atlas把图集打包的概念延迟到特定时刻(比如打包或者打包AB)而编辑模式依然可以使用原始Sprite工作，总的来说就是延时自动化打包图集时机+允许使用原始Sprite的概念。</li>
<li>Include in Build设置主要是看有没有动态适配加载图集需求，有的话就建议不勾选，然后结合Later Bind来做动态图集加载适配。反之勾选Include in Build在依赖使用时会自动加载依赖使用的Sprite Atals。</li>
<li>Include in Build其次还会影响Sprite Atlas变体使用的选择。</li>
<li>SpriteAtlas到了Unity 2018 LTS版本感觉才稳定些，建议使用稳定版本的SpriteAtlas</li>
<li>Later Bind不会区分主动加载还是被动(依赖)加载SpriteAtlas,都会统一回调，要使用Later Bind机制的需要取消勾选Include in Build并解决SpriteAtlas的资源加载管理问题(在沿用原来的对象绑定和索引计数的资源管理方案基础上本人暂时没有好的方案)</li>
<li><strong>Sprite Atlas无论够不够选Include in Build打包AB都得不到Sprite Atlas的依赖信息，感觉这是一个bug</strong></li>
</ol>
<h5 id="Bug记录"><a href="#Bug记录" class="headerlink" title="Bug记录"></a>Bug记录</h5><ol>
<li><strong>勾选Include in Build会导致资源打包冗余(部分Unity版本比如Unity2018.4.1f1)，建议升级到LTS版本</strong></li>
</ol>
<h5 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h5><p>SpriteAtlas虽然解决了Atlas和UIPrefab的解耦，同时提供了图集变体的概念来解决适配图集适配方案，但也带来了一些新的问题要解决(e.g. 要解决没有依赖信息的SpriteAtals基础上做到正确的资源加载管理)。</p>
<p><strong>——————————–2021&#x2F;20&#x2F;12更新开始————————————–</strong></p>
<p>正确使用姿势参考：</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/msxh/p/14194756.html">【Unity游戏开发】SpriteAtlas与AssetBundle最佳食用方案</a></p>
<p>简单来说:</p>
<ol>
<li><strong>SpriteAtlas 勾选Include in build</strong></li>
<li><strong>SpriteAtlas不设置AB打包</strong></li>
<li><strong>直接当做单Sprite一样加载</strong></li>
</ol>
<p><strong>——————————–2021&#x2F;20&#x2F;12更新结束————————————–</strong></p>
<h2 id="Timeline"><a href="#Timeline" class="headerlink" title="Timeline"></a>Timeline</h2><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/TimelineSection.html"> <strong>Timeline</strong> to create cinematic content, game-play sequences, audio sequences, and complex particle effects. </a></p>
<p>官方介绍Timeline可以用于制作类似电影过场表现的工具。</p>
<p>Timeline分为两个部分：</p>
<ol>
<li>Timeline Asset(数据)</li>
<li>Timeline instance(数据关联实体对象)</li>
</ol>
<h3 id="Timeline-Asset"><a href="#Timeline-Asset" class="headerlink" title="Timeline Asset"></a>Timeline Asset</h3><h4 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h4><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/TimelineOverview.html"> <strong>Timeline Asset</strong>: Stores the tracks, clips, and recorded animations without links to the specific GameObjects being animated.</a></p>
<p>通过介绍可以看出Timeline Asset是类似于Animation Clip一样的资源文件可以用于录制动画<strong>但不需要关联到特定的物体上</strong></p>
<p>Timeline Asset记录的动画数据是以子节点资源的形式挂载在Timeline Asset下的：</p>
<p><img src="/img/Unity/Timeline_Cinemachine/TimelineAssetHierachy.png" alt="TimelineAssetHierachy"></p>
<p>Note:<br>前面说的不需要关联到特定的物体上是指不需要像AnimationClip那样动画是针对指定物体制作的(挂给其他物体用不了该动画)，Timeline可以通过PlayableDirector动态关联动画对象。</p>
<h4 id="分类"><a href="#分类" class="headerlink" title="分类"></a>分类</h4><p>Timeline Asset是以Track为最小单位。</p>
<p>主要支持以下几种Track:</p>
<ol>
<li>Track Group(仅分层管理用)</li>
<li>Activation Track(激活物体Track)</li>
<li>Animation Track(动画Track)</li>
<li>Audio Track(音频Track)</li>
<li>Control Track(时间相关的控制)</li>
<li>Playable Track(<strong>自定义Track</strong>)</li>
</ol>
<p><img src="/img/Unity/Timeline_Cinemachine/TimelineComponent.png" alt="TimelineComponent"></p>
<p>这里我们着重学习Playable Track,自定义的一些表现行为都是通过Playable Track来做的。其他几个就不一一讲解了。</p>
<h5 id="Playable-Track"><a href="#Playable-Track" class="headerlink" title="Playable Track"></a>Playable Track</h5><p>自定义Playable Track需要知道两个东西：</p>
<ol>
<li>PlayableAsset(用于支持Timeline创建和显示自定义PlayableAsset数据定义)</li>
<li>PlayableBehaviour(用于Playable实际的生命周期等逻辑实现)</li>
</ol>
<p>示例:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 枚举事件定义</span></span><br><span class="line"><span class="keyword">public</span> <span class="built_in">enum</span> EEventId</span><br><span class="line">&#123;</span><br><span class="line">    DefaultEvent = <span class="number">1</span>,				<span class="comment">// 默认事件</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 事件分发器Asset</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">System.Serializable</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">EventDispatcherAsset</span> : <span class="title">PlayableAsset</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 事件</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> EEventId EventId = EEventId.DefaultEvent;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Factory method that generates a playable based on this asset</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> Playable <span class="title">CreatePlayable</span>(<span class="params">PlayableGraph graph, GameObject go</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> playable = ScriptPlayable&lt;EventDispatcherPlayable&gt;.Create(graph);</span><br><span class="line">        playable.GetBehaviour().EventId = EventId;</span><br><span class="line">        <span class="keyword">return</span> playable;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 事件分发器Playable</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">EventDispatcherPlayable</span> : <span class="title">PlayableBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 事件</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;事件&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> EEventId EventId = EEventId.DefaultEvent;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Called when the owning graph starts playing</span></span><br><span class="line">    <span class="comment">// Playable开始执行时</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnGraphStart</span>(<span class="params">Playable playable</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Called when the owning graph stops playing</span></span><br><span class="line">    <span class="comment">// Playable停止执行时</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnGraphStop</span>(<span class="params">Playable playable</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Called when the state of the playable is set to Play</span></span><br><span class="line">    <span class="comment">// 触发Playable执行时</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnBehaviourPlay</span>(<span class="params">Playable playable, FrameData info</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Debug.Log(<span class="built_in">string</span>.Format(<span class="string">&quot;OnBehaviourPlay() 分发事件 : &#123;0&#125;&quot;</span>, EventId));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Called when the state of the playable is set to Paused</span></span><br><span class="line">    <span class="comment">// Playable暂停执行时</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnBehaviourPause</span>(<span class="params">Playable playable, FrameData info</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Called each frame while the state is set to Play</span></span><br><span class="line">    <span class="comment">// Playable更新执行时</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">PrepareFrame</span>(<span class="params">Playable playable, FrameData info</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/img/Unity/Timeline_Cinemachine/TimelineCustomPlayable.png" alt="TimelineCustomPlayable"></p>
<p>代码不复杂就不详细介绍了。通过上面的代码，我们支持了一个创建自定义分发事件的Playable Track，而这个自定义的事件分发就可以用作我们Timeline和游戏逻辑之间的一个桥梁，帮助我们在Timeline播放的过程中自定义响应做一些表现。</p>
<h3 id="Timeline-instance"><a href="#Timeline-instance" class="headerlink" title="Timeline instance"></a>Timeline instance</h3><h4 id="介绍-1"><a href="#介绍-1" class="headerlink" title="介绍"></a>介绍</h4><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/TimelineOverview.html"> <strong>Timeline instance</strong>: Stores links to the specific GameObjects being animated or affected by the Timeline Asset. These links, referred to as <strong>bindings</strong>, are saved to the Scene. </a></p>
<p>要想关联场景物体和Timeline Asset让我们制作的电影过场动起来，我们需要创建Timeline instance(这里指的Playable Director组件)。</p>
<p><img src="/img/Unity/Timeline_Cinemachine/TimelinePlayableDirectorInspector.png" alt="TimelinePlayableDirectorInspector"></p>
<p>可以看到我们通过Timeline Asset录制的动画是通过Playable Director的Bindings动态关联到了场景物体上。</p>
<p>Note:<br><strong>因为Timeline Asset是纯数据，Timeline instance决定了数据关联的对象，所以我们可以重用Timeline Asset对不同的物体做动画表现。</strong></p>
<h3 id="Timeline类设计"><a href="#Timeline类设计" class="headerlink" title="Timeline类设计"></a>Timeline类设计</h3><h4 id="Playable"><a href="#Playable" class="headerlink" title="Playable"></a>Playable</h4><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/Playables.html">The <strong>Playables</strong> API provides a way to create tools, effects or other gameplay mechanisms by organizing and evaluating data sources in a tree-like structure known as the PlayableGraph. The PlayableGraph allows you to mix, blend, and modify multiple data sources, and play them through a single output.</a></p>
<p>从介绍个人的理解，Playable是一套可自定义数据处理流程成树状结构的工具。而自定义出来的树状结构数据就叫做PlayableGraph(后续会讲到)。而Timeline的核心正是Playable。</p>
<p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/Playables.html">使用Playables API的好处:</a></p>
<ul>
<li>The Playables API allows for dynamic animation blending. This means that objects in the <strong>scenes</strong><br>could provide their own animations. For example, animations for weapons, chests, and traps could be dynamically added to the PlayableGraph and used for a certain duration.</li>
<li>The Playables API allows you to easily play a single animation without the overhead involved in creating and managing an AnimatorController asset.</li>
<li>The Playables API allows users to dynamically create blending graphs and control the blending weights directly frame by frame.</li>
<li>A PlayableGraph can be created at runtime, adding playable node as needed, based on conditions. Instead of having a huge “one-size-fit-all” graph where nodes are enabled and disabled, the PlayableGraph can be tailored to fit the requirements of the current situation.</li>
</ul>
<p>官网上介绍了Playable的不少好处，从介绍可以看出最大的好处就是运行时自定义组装数据处理流程，避免离线构建一套过于臃肿的数据定义(比如AnimatorController)</p>
<p>Note:</p>
<ol>
<li><strong>Playable是Struct而非Class，为了避免内存分配导致GC</strong></li>
<li><strong>Playable和PlayableOutput没有提供太多方法，而是通过PlayableExtension和PlayableOutputExtension用扩展方法的方式来提供的方法</strong></li>
</ol>
<h4 id="PlayableGraph"><a href="#PlayableGraph" class="headerlink" title="PlayableGraph"></a>PlayableGraph</h4><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/Playables-Graph.html">The PlayableGraph defines a set of playable outputs that are bound to a <strong>GameObject</strong> or component. The PlayableGraph also defines a set of <strong>playables</strong> and their relationships. Figure 1 provides an example.</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/Playables-Graph.html">The PlayableGraph is responsible for the life cycle of its playables and their outputs. Use the PlayableGraph to create, connect, and destroy playables.</a></p>
<p>从上面的介绍，个人理解，PlayableGraph是一个自定义数据处理流程的完整单位，负责自定义数据处理流程里的节点定义，关联，以及生命周期。PlayableGraph是由Plyable(e.g.Playable,MixPlayable)+PlayableOuput组成。</p>
<h4 id="PlayableAsset"><a href="#PlayableAsset" class="headerlink" title="PlayableAsset"></a>PlayableAsset</h4><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/ScriptReference/Playables.PlayableAsset.html">A base class for assets that can be used to instantiate a Playable at runtime.</a></p>
<p>PlayableAsset是自定义Playable时定义数据Asset的基类。</p>
<h4 id="PlayableBehaviour"><a href="#PlayableBehaviour" class="headerlink" title="PlayableBehaviour"></a>PlayableBehaviour</h4><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/ScriptReference/Playables.PlayableBehaviour.html">PlayableBehaviour is the base class from which every custom playable script derives.</a></p>
<p>PlayableBehaviour是自定义Playable时定义行为实现的脚本基类。</p>
<h4 id="PlayableOutput"><a href="#PlayableOutput" class="headerlink" title="PlayableOutput"></a>PlayableOutput</h4><p>个人理解是定义Playable里面的输出节点。所有的输入节点最后连接成树状结构后连到输出节点上，执行出自定义行为的输出表现。</p>
<p>参考下图:</p>
<p><img src="/img/Unity/Timeline_Cinemachine/PlayableOutputPreview.PNG" alt="PlayableOutputPreview"></p>
<h4 id="PlayableBinding"><a href="#PlayableBinding" class="headerlink" title="PlayableBinding"></a>PlayableBinding</h4><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/ScriptReference/Playables.PlayableBinding.html">Struct that holds information regarding an output of a PlayableAsset. PlayableAssets specify the type of outputs it supports using PlayableBindings.</a></p>
<p>看介绍PlayableBinding是用于定义并持有PlayableAsset的数据输出信息。</p>
<h4 id="ExposedReference"><a href="#ExposedReference" class="headerlink" title="ExposedReference"></a>ExposedReference</h4><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/ScriptReference/ExposedReference_1.html">Creates a type whos value is resolvable at runtime. ExposedReference is a generic type that can be used to create references to Scene objects and resolve their actual values at runtime and by using a context object. This can be used by assets, such as a ScriptableObject or PlayableAsset to create references to Scene objects.</a></p>
<p>从介绍可以看出，ExposedReference是用于创建一个类型(其值在运行时处理绑定的)。用于解决PlayableAsset引用场景对象组件数据等问题。</p>
<h4 id="辅助工具-GraphVisualizer"><a href="#辅助工具-GraphVisualizer" class="headerlink" title="辅助工具(GraphVisualizer)"></a>辅助工具(GraphVisualizer)</h4><p><a target="_blank" rel="noopener" href="https://github.com/Unity-Technologies/graph-visualizer">The PlayableGraph Visualizer is a tool that displays the PlayableGraphs in the scene. It can be used in both Play and Edit mode and will always reflect the current state of the graph. </a></p>
<p>因为Playable的设计很庞大，里面有很多类和概念，为了方便理解Playable设计和使用可视化的查看构建出来的PlayableGraph显得额外有用，而PlayableGraph Visualizer正是这么一款工具。</p>
<p>接下来我们结合GraphVisualizer动态通过代码创建模拟用Playable API实现动画Animator Controller里的动画状态机类似的效果，从而深入学习理解Playable里各个类的设计和使用。</p>
<h5 id="单AnimationClip单AniamtionOuput的动画播放"><a href="#单AnimationClip单AniamtionOuput的动画播放" class="headerlink" title="单AnimationClip单AniamtionOuput的动画播放"></a>单AnimationClip单AniamtionOuput的动画播放</h5><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建动画播放PlayableGraph</span></span><br><span class="line">mCustomGraph = PlayableGraph.Create(<span class="string">&quot;DIYAnimationPlayableGraph&quot;</span>);</span><br><span class="line"><span class="comment">// 创建动画播放PlyableGraph的PlayableOutput</span></span><br><span class="line"><span class="keyword">var</span> animoutput = AnimationPlayableOutput.Create(mCustomGraph, <span class="string">&quot;AnimationOutput&quot;</span>, CustomAnimator1);</span><br><span class="line"><span class="comment">// 创建动画播放PlyableGraph的动画Playable</span></span><br><span class="line"><span class="keyword">var</span> animationclipplayable = AnimationClipPlayable.Create(mCustomGraph, CustomAnimationClip1);</span><br><span class="line"><span class="comment">// 设置动画播放PlayableOutput的关联Playable</span></span><br><span class="line">animoutput.SetSourcePlayable(animationclipplayable);</span><br><span class="line"><span class="comment">// 播放创建的PlayableGraph</span></span><br><span class="line">mCustomGraph.Play();</span><br></pre></td></tr></table></figure>

<p>通过上面的代码我们动态创建了1个PlayableGraph，1个动画Plyable，1个动画PlayableOutput作为动画播放输出，并设置他们之间的关联，运行代码打开PlayableGraphVisualizer就可以查看到生成的单动画Clip播放PlayableGraph图了。</p>
<p><img src="/img/Unity/Timeline_Cinemachine/PlayableGraphVisualizerPreview.PNG" alt="PlayableGraphVisualizerPreview"></p>
<h5 id="多AnimationClip混合"><a href="#多AnimationClip混合" class="headerlink" title="多AnimationClip混合"></a>多AnimationClip混合</h5><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建动画播放PlayableGraph</span></span><br><span class="line">mCustomGraph = PlayableGraph.Create(<span class="string">&quot;DIYAnimationPlayableGraph&quot;</span>);</span><br><span class="line"><span class="comment">// 创建动画播放PlyableGraph的PlayableOutput</span></span><br><span class="line"><span class="keyword">var</span> animationOutput = AnimationPlayableOutput.Create(mCustomGraph, <span class="string">&quot;AnimationOutput&quot;</span>, CustomAnimator1);</span><br><span class="line"><span class="comment">// 创建动画播放混合Playable(设置两个输入Playable)</span></span><br><span class="line">mAnimationMixerPlayable = AnimationMixerPlayable.Create(mCustomGraph, <span class="number">2</span>);</span><br><span class="line"><span class="comment">// 关联动画混合Playable到PlaybleOutput作为唯一输入</span></span><br><span class="line">animationOutput.SetSourcePlayable(mAnimationMixerPlayable);</span><br><span class="line"><span class="comment">// 创建动画播放PlyableGraph的动画播放Playable1和Playable2</span></span><br><span class="line"><span class="keyword">var</span> animationClipPlayable1 = AnimationClipPlayable.Create(mCustomGraph, CustomAnimationClip1);</span><br><span class="line"><span class="keyword">var</span> animationClipPlayable2 = AnimationClipPlayable.Create(mCustomGraph, CustomAnimationClip2);</span><br><span class="line"><span class="comment">// 关联动画播放Playable1和Playable2作为动画混合Playable的输入连接(分别连接输入0和输入1接口)</span></span><br><span class="line">mCustomGraph.Connect(animationClipPlayable1, <span class="number">0</span>, mAnimationMixerPlayable, <span class="number">0</span>);</span><br><span class="line">mCustomGraph.Connect(animationClipPlayable2, <span class="number">0</span>, mAnimationMixerPlayable, <span class="number">1</span>);</span><br><span class="line"><span class="comment">// 播放创建的PlayableGraph</span></span><br><span class="line">mCustomGraph.Play();</span><br></pre></td></tr></table></figure>

<p>通过上面的代码我们动态创建了一个PlayableGraph，2个动画Plyable作为基础输入，1个动画混合Playable作为混合节点，1个动画PlayableOutput作为动画播放输出，并设置他们之间的关联，运行代码打开PlayableGraphVisualizer就可以查看到生成的动画混合播放PlayableGraph图了。</p>
<p><img src="/img/Unity/Timeline_Cinemachine/AnimationClipMixPreview.PNG" alt="AnimationClipMixPreview"></p>
<h5 id="多AnimationClip多AnimationOuput"><a href="#多AnimationClip多AnimationOuput" class="headerlink" title="多AnimationClip多AnimationOuput"></a>多AnimationClip多AnimationOuput</h5><p><strong>一个PlayableGraph是可以拥有多个PlayableOutput输出的</strong></p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建动画播放PlayableGraph</span></span><br><span class="line">mCustomGraph = PlayableGraph.Create(<span class="string">&quot;DIYAnimationPlayableGraph&quot;</span>);</span><br><span class="line"><span class="comment">// 创建动画播放PlyableGraph的PlayableOutput1和PlayableOutput2</span></span><br><span class="line"><span class="keyword">var</span> animationOutput1 = AnimationPlayableOutput.Create(mCustomGraph, <span class="string">&quot;AnimationOutput1&quot;</span>, CustomAnimator1);</span><br><span class="line"><span class="keyword">var</span> animationOutput2 = AnimationPlayableOutput.Create(mCustomGraph, <span class="string">&quot;AnimationOutput2&quot;</span>, CustomAnimator2);</span><br><span class="line"><span class="comment">// 创建动画播放PlyableGraph的动画播放Playable1和Playable2</span></span><br><span class="line"><span class="keyword">var</span> animationClipPlayable1 = AnimationClipPlayable.Create(mCustomGraph, CustomAnimationClip1);</span><br><span class="line"><span class="keyword">var</span> animationClipPlayable2 = AnimationClipPlayable.Create(mCustomGraph, CustomAnimationClip2);</span><br><span class="line"><span class="comment">// 关联动画播放Playable1到动画播放PlaybleOutput1</span></span><br><span class="line"><span class="comment">// 关联动画播放Playable2到动画播放PlaybleOutput2</span></span><br><span class="line">animationOutput1.SetSourcePlayable(animationClipPlayable1);</span><br><span class="line">animationOutput2.SetSourcePlayable(animationClipPlayable2);</span><br><span class="line"><span class="comment">// 播放创建的PlayableGraph</span></span><br><span class="line">mCustomGraph.Play();</span><br></pre></td></tr></table></figure>

<p>通过上面的代码我们动态创建了一个PlayableGraph，2个动画Plyable对应2个动画PlayableOutput动画播放输出的输入，并设置他们之间的关联，运行代码打开PlayableGraphVisualizer就可以查看到生成的动画混合播放PlayableGraph图了。</p>
<p><img src="/img/Unity/Timeline_Cinemachine/MultipleAnimationInputAndOutputPreview.PNG" alt="MultipleAnimationInputAndOutputPreview"></p>
<h5 id="多AnimationClip混合并控制权重加播放状态"><a href="#多AnimationClip混合并控制权重加播放状态" class="headerlink" title="多AnimationClip混合并控制权重加播放状态"></a>多AnimationClip混合并控制权重加播放状态</h5><p><strong>不同的Playable是可以设置混合权重加播放状态的</strong></p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建动画播放PlayableGraph</span></span><br><span class="line">mCustomGraph = PlayableGraph.Create(<span class="string">&quot;DIYAnimationPlayableGraph&quot;</span>);</span><br><span class="line"><span class="comment">// 创建动画播放PlyableGraph的PlayableOutput</span></span><br><span class="line"><span class="keyword">var</span> animationOutput = AnimationPlayableOutput.Create(mCustomGraph, <span class="string">&quot;AnimationOutput1&quot;</span>, CustomAnimator1);</span><br><span class="line"><span class="comment">// 创建动画混合Playable</span></span><br><span class="line">mAnimationMixerPlayable = AnimationMixerPlayable.Create(mCustomGraph, <span class="number">2</span>);</span><br><span class="line"><span class="comment">// 设置动画混合Playalbe作为动画播放输出Playable</span></span><br><span class="line">animationOutput.SetSourcePlayable(mAnimationMixerPlayable);</span><br><span class="line"><span class="comment">// 创建动画播放PlyableGraph的动画播放Playable1和Playable2</span></span><br><span class="line"><span class="keyword">var</span> animationClipPlayable1 = AnimationClipPlayable.Create(mCustomGraph, CustomAnimationClip1);</span><br><span class="line"><span class="keyword">var</span> animationClipPlayable2 = AnimationClipPlayable.Create(mCustomGraph, CustomAnimationClip2);</span><br><span class="line"><span class="comment">// 设置动画混合输入和权重</span></span><br><span class="line">mCustomGraph.Connect(animationClipPlayable1, <span class="number">0</span>, mAnimationMixerPlayable, <span class="number">0</span>);</span><br><span class="line">mCustomGraph.Connect(animationClipPlayable2, <span class="number">0</span>, mAnimationMixerPlayable, <span class="number">1</span>);</span><br><span class="line">mAnimationMixerPlayable.SetInputWeight(<span class="number">0</span>, <span class="number">1.0f</span>);</span><br><span class="line">mAnimationMixerPlayable.SetInputWeight(<span class="number">1</span>, <span class="number">1.0f</span>);</span><br><span class="line"><span class="comment">// 暂停动画播放Playable1</span></span><br><span class="line">animationClipPlayable1.Pause();</span><br><span class="line"><span class="comment">// 播放创建的PlayableGraph</span></span><br><span class="line">mCustomGraph.Play();</span><br></pre></td></tr></table></figure>

<p>通过上面的代码我们动态创建了一个PlayableGraph，2个动画Plyable作为动画混合Playable的输入,1个动画混合Playable作为动画播放输出的输入,1个PlayableOutput作为动画播放输出，并设置他们之间的关联和权重，并把其中一个动画播放Playable设置成暂停状态，运行代码打开PlayableGraphVisualizer就可以查看到生成的动画混合播放PlayableGraph图了。</p>
<p><img src="/img/Unity/Timeline_Cinemachine/MultipleAnimationBlendAndSetPlayableState.PNG" alt="MultipleAnimationBlendAndSetPlayableState"></p>
<p>Note:</p>
<ol>
<li><strong>父Playable的播放状态设置会影响所有子节点Playable播放状态</strong></li>
</ol>
<h3 id="Timeline实战"><a href="#Timeline实战" class="headerlink" title="Timeline实战"></a>Timeline实战</h3><p>通过上面有了基础的知识后，接下来我们以实战的方式深入学习Timeline。</p>
<ul>
<li>目标</li>
</ul>
<ol>
<li>人物模型移动(Timeline自带)+人物模型动画播放(Timeline自带)+镜头移动(Cinemachine+Timeline)+2D对话+3D气泡对话的剧情表现+特效播放(Timeline自带)+音乐播放控制(扩展自定义Track，方便走自己的音效播放接口)</li>
<li>支持Timeline Editor拖拽预览+运行时播放预览</li>
</ol>
<ul>
<li>功能开发</li>
</ul>
<ol>
<li>音乐播放控制(扩展自定义Track，方便走自己的音效播放接口)</li>
<li>Timeline模型移动控制Track(TimeLine支持)</li>
<li>学习Cinemachine扩展Timeline的Track使用控制镜头移动表现</li>
<li>实现2D气泡对话+3D对话功能</li>
<li>扩展Timneline实现2D气泡对话Track+3D对话Track</li>
<li>动态创建实体对象的自定义Track绑定控制(如何实现?)</li>
</ol>
<ul>
<li>准备工作</li>
</ul>
<ol>
<li>Package Manager里安装Cinemachine模块</li>
<li>下载导入模型特效音效等相关资源</li>
</ol>
<p>安装好Cinemachine后，打开Timeline里面就会看到多了Cinemachine的Track，从而就可以在Timeline里使用Cinemachine相关的扩展功能了:</p>
<p><img src="/img/Unity/Timeline_Cinemachine/TimelineCinemachineTrack.png" alt="TimelineCinemachineTrack"></p>
<p>首先我们先放一下我们自定义制作的Timeline的预制件结构:</p>
<p><img src="/img/Unity/Timeline_Cinemachine/CustomTimelinePrefabHierachyPreview.PNG" alt="CustomTimelinePrefabHierachyPreview"></p>
<hr>
<p><strong>音乐播放控制Track</strong></p>
<p>CustomAduioTrack.cs(自定义音乐播放Track)</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> CustomAudioTrack.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 自定义音效Track</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">TrackClipType(typeof(CustomAudioAsset))</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CustomAudioTrack</span> : <span class="title">PlayableTrack</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>CustomAudioAsset.cs(自定义音乐播放Asset数据结构)</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> CustomAudioAsset.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 自定义音效播放Asset</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CustomAudioAsset</span> : <span class="title">BaseGameAsset</span>, <span class="title">ITimelineClipAsset</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 音效类型</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">enum</span> AudioType</span><br><span class="line">    &#123;</span><br><span class="line">        Bgm = <span class="number">1</span>,            <span class="comment">// 背景音乐</span></span><br><span class="line">        Sound = <span class="number">2</span>,          <span class="comment">// 音效</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 音效播放组件</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> ExposedReference&lt;AudioSource&gt; SourceAudio;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 播放的音效类型</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> AudioType PlayedAudioType = AudioType.Bgm;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 音效资源路径</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> AudioPath;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 不支持重叠</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> ClipCaps clipCaps</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span> &#123; <span class="keyword">return</span> ClipCaps.None; &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> Playable <span class="title">CreatePlayable</span>(<span class="params">PlayableGraph graph, GameObject owner</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> playable = ScriptPlayable&lt;CustomAudioBehaviour&gt;.Create(graph);</span><br><span class="line">        <span class="keyword">var</span> audiobehaviour = playable.GetBehaviour();</span><br><span class="line">        audiobehaviour.Name = Name;</span><br><span class="line">        audiobehaviour.SourceAudio = SourceAudio.Resolve(graph.GetResolver());</span><br><span class="line">        audiobehaviour.PlayedAudioType = PlayedAudioType;</span><br><span class="line">        audiobehaviour.AudioPath = AudioPath;</span><br><span class="line">        <span class="keyword">return</span> playable;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>CustomAudioBehaviour.cs(自定义音乐播放行为)</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> CustomAudioBehaviour.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 自定义音效播放Behaviour</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CustomAudioBehaviour</span> : <span class="title">BaseGameBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 音效播放组件</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> AudioSource SourceAudio;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 播放的音效类型</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> CustomAudioAsset.AudioType PlayedAudioType;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 音效资源路径</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> AudioPath;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 是否正在播放音乐</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">bool</span> mIsPlayingAudio;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnBehaviourPlay</span>(<span class="params">Playable playable, FrameData info</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Debug.Log(<span class="string">$&quot;AudioBehaviour:OnBehaviourPlay() 执行指令:<span class="subst">&#123;Name&#125;</span>&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Called each frame while the state is set to Play</span></span><br><span class="line">    <span class="comment">// Playable更新执行时</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">ProcessFrame</span>(<span class="params">Playable playable, FrameData info, <span class="built_in">object</span> playerData</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">		TryPlayAudio();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Called when the state of the playable is set to Paused</span></span><br><span class="line">    <span class="comment">// Playable暂停执行时</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnBehaviourPause</span>(<span class="params">Playable playable, FrameData info</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Debug.Log(<span class="string">$&quot;AudioBehaviour:OnBehaviourPause() 执行指令:<span class="subst">&#123;Name&#125;</span>&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(SourceAudio != <span class="literal">null</span> &amp;&amp; SourceAudio.clip != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            SourceAudio.clip = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        mIsPlayingAudio = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 尝试执行音乐播放</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">TryPlayAudio</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(mIsPlayingAudio == <span class="literal">false</span> &amp;&amp; SourceAudio != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (PlayedAudioType == CustomAudioAsset.AudioType.Bgm)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// <span class="doctag">TODO:</span> 走背景音乐播放接口</span></span><br><span class="line">                SourceAudio.clip = Resources.Load&lt;AudioClip&gt;(AudioPath);</span><br><span class="line">                SourceAudio.Play();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (PlayedAudioType == CustomAudioAsset.AudioType.Sound)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// <span class="doctag">TODO:</span> 走音效播放接口</span></span><br><span class="line">                SourceAudio.clip = Resources.Load&lt;AudioClip&gt;(AudioPath);</span><br><span class="line">                SourceAudio.Play();</span><br><span class="line">            &#125;</span><br><span class="line">            mIsPlayingAudio = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下来看下我们自定义的音效播放Track和音乐Asset的使用面板效果:</p>
<p><img src="/img/Unity/Timeline_Cinemachine/CustomAudioTrackPreview.PNG" alt="CustomAudioTrackPreview"></p>
<p><img src="/img/Unity/Timeline_Cinemachine/CustomAudioAssetBGMInspector.PNG" alt="CustomAudioAssetBGMInspector"></p>
<p><img src="/img/Unity/Timeline_Cinemachine/CustomAudioAssetSoundInspector.PNG" alt="CustomAudioAssetSoundInspector"></p>
<p>从上面可以看到，我们通过ExposedReference<AudioSource>的方式，挂载绑定了场景里的AudioSource作为背景音乐和音效播放组件。</p>
<p>接下来为了避免每一个CustomAudioAsset都自己去指定AudioSource绑定组件，我们可以通过在CustomAudioTrack来支持在Track统一指定AudioSource。</p>
<p>CustomAudioTrack.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> CustomAudioTrack.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 自定义音效Track</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">TrackClipType(typeof(CustomAudioAsset))</span>]</span><br><span class="line">[<span class="meta">TrackBindingType(typeof(AudioSource))</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CustomAudioTrack</span> : <span class="title">PlayableTrack</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>CustomAudioBehaviour.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> CustomAudioBehaviour.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 自定义音效播放Behaviour</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CustomAudioBehaviour</span> : <span class="title">BaseGameBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    ******</span><br><span class="line">        </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 音效播放组件</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> AudioSource mSourceAudio;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Called each frame while the state is set to Play</span></span><br><span class="line">    <span class="comment">// Playable更新执行时</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">ProcessFrame</span>(<span class="params">Playable playable, FrameData info, <span class="built_in">object</span> playerData</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(mSourceAudio == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            mSourceAudio = playerData <span class="keyword">as</span> AudioSource;</span><br><span class="line">        &#125;</span><br><span class="line">        TryPlayAudio();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">	******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>CustomAudioTrack通过声明TrackBindingType(typeof(AudioSource))指定Track可以绑定AudioSource组件。</p>
<p>CustomAudioBehaviour通过在运行时ProcessFrame里动态使用Track上指定的AudioSource组件作为音乐播放组件来实现CustomAudioBehaviour采用Track统一绑定组件的的效果。</p>
<p><img src="/img/Unity/Timeline_Cinemachine/CustomAudioTrackWithAudioSourceBindingPreview.PNG" alt="CustomAudioTrackWithAudioSourceBindingPreview"></p>
<h3 id="进阶"><a href="#进阶" class="headerlink" title="进阶"></a>进阶</h3><p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/69e60a27bccb">Unity使用Cinemachine和Timeline入门</a><br><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Packages/com.unity.cinemachine@2.3/manual/CinemachineTimeline.html">Cinemachine and Timeline</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.unity.com/tutorial/cinemachine">Cinemachine</a></p>
<p>Timeline可以看做是自定义展示效果的工具，而Cinemachine可以看做是多摄像机的一套完整控制表现的工具。</p>
<p>更多的Cinemachine学习见后面</p>
<h2 id="Cinemachine"><a href="#Cinemachine" class="headerlink" title="Cinemachine"></a>Cinemachine</h2><p><a target="_blank" rel="noopener" href="https://unity.com/unity/features/editor/art-and-design/cinemachine">Powering cameras for films and games</a></p>
<p>根据官网的简单介绍可以看出，Cinemachine是官方出的一款摄像机强大的控制系统，通过该系统，我们可以轻松的做到电影或者游戏级别的摄像机功能以及表现。</p>
<p>博主这里考虑学习使用Cinemachine的一个重大原因是，做赛车游戏，希望有一个稳定(不抖动)跟随的摄像机。(自己写的效果有抖动问题)</p>
<p>Cinemachine里有两个重要的组件和概念:</p>
<ol>
<li>Cinemachine Brain</li>
<li>Virtual Cameras</li>
</ol>
<h3 id="Cinemachine-Brain"><a href="#Cinemachine-Brain" class="headerlink" title="Cinemachine Brain"></a>Cinemachine Brain</h3><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Packages/com.unity.cinemachine@2.3/manual/CinemachineOverview.html">The Cinemachine Brain is a component in the Unity Camera itself. Cinemachine Brain monitors all active Virtual Cameras in the Scene. To specify the next live Virtual Camera, you <a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/DeactivatingGameObjects.html">activate or deactivate</a> the desired Virtual Camera’s game object. </a></p>
<p>从上面的介绍可以看出，Cinemachine Brain组件式挂载在摄像机对象上的一个组件，负责管理所有Virual Camera，同一时间只有一个Virtual Camera起作用用于主摄像机，优先选择Priority高的已激活Virutal Camera作为当前起作用的摄像机，优先级相同的情况下看哪个Virtual Camera后激活优先。</p>
<p><img src="/img/Unity/Timeline_Cinemachine/CinemachineBrain.PNG" alt="CinemachineBrain"></p>
<p>关于Cinemachine Brain的详细参数介绍，这里就不深入探讨了，感兴趣的朋友参考文档去自行了解。</p>
<p>Note:</p>
<ol>
<li>Timeline重写了Cinemachine Brain的Priority系统可以更好的控制摄像机达到更精准的摄像机控制。</li>
</ol>
<h3 id="Virtual-Cameras"><a href="#Virtual-Cameras" class="headerlink" title="Virtual Cameras"></a>Virtual Cameras</h3><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Packages/com.unity.cinemachine@2.3/manual/CinemachineOverview.html">Cinemachine does not create new cameras. Instead, it directs a single Unity camera for multiple shots. You compose these shots with <strong>Virtual Cameras</strong>. Virtual Cameras move and rotate the Unity camera and control its settings.</a></p>
<p>从上面的介绍可以知道，Cinemachine里的Virtual Cameras并非真正的Camera组件，而是一个抽象概念，而这个抽象的Virtuel Cameras会去负责控制真正的摄像机达到预定的效果。</p>
<p>每一个Virtual Cameras都会对应一个GameObject和一个CinemachineVirtualCamera组件脚本:</p>
<p><img src="/img/Unity/Timeline_Cinemachine/CinemachineVirtualCamera.PNG" alt="CinemachineVirtualCamera"></p>
<h4 id="Virtual-Camera-States"><a href="#Virtual-Camera-States" class="headerlink" title="Virtual Camera States"></a>Virtual Camera States</h4><p>Virtual Camera有三种状态:</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Packages/com.unity.cinemachine@2.1/manual/index.html"><strong>Live</strong>:The virtual camera is actively controlling the Unity Camera. The virtual camera is tracking its targets and being updated every frame.</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Packages/com.unity.cinemachine@2.1/manual/index.html"><strong>Standby</strong>: The virtual camera is tracking its targets and being updated every frame, but no Unity Camera is actively being controlled by it. This is the state of a virtual camera that is enabled in the scene but perhaps at a lower priority than the Live virtual camera.</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Packages/com.unity.cinemachine@2.1/manual/index.html"><strong>Disabled</strong>: The virtual camera is present but disabled in the scene. It is not actively tracking its targets and so consumes no processing power. However, the virtual camera can be made live from the Timeline.</a></li>
</ol>
<p>从介绍可以看到Live是指当前Virtual Camera优先级最高起作用的那个。而Standby是优先级低于当前起作用的Virtual Camera但没有Disable的Virtual Camera，这些摄像机逻辑上依然会更新跟随自己设定的对象，但不会影响真实摄像机运作。最后Disabled是即低于当前最高优先级Virtual Camera也没有激活的Virtual Camera，这类摄像机不会有任何运行开销，逻辑层面也不会在继续跟随自己的目标对象。</p>
<h4 id="Virtual-Camera-Params"><a href="#Virtual-Camera-Params" class="headerlink" title="Virtual Camera Params"></a>Virtual Camera Params</h4><p>关于Virtual Camera的细节参数学习，接下来学习几个重要的参数，更多的细节参考:</p>
<p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Packages/com.unity.cinemachine@2.3/manual/CinemachineOverview.html">Cinemachine overview</a></p>
<p><strong>Priority</strong>正如前面提到的，决定了Virtual Camera在Cinemachine Brain里的选择优先级。</p>
<p><strong>Follow</strong>和<strong>Look At</strong>两个参数分别决定了摄像机的跟随对象和对焦对象，这两个参数是常规游戏类型里都需要的概念，好比博主当前要做的赛车游戏，Follow和Look At对象都是赛车就能做到跟随和聚焦赛车的效果。</p>
<p><strong>Body</strong>属性提供了Virtual Camera对于摄像机移动的算法选择，从而达到适配各种游戏类型的摄像机镜头移动要求。</p>
<p><img src="/img/Unity/Timeline_Cinemachine/CinemachineBodyProperties.PNG" alt="CinemachineBodyProperties"></p>
<p>这里博主的赛车游戏默认选择Transposer来达到平滑跟随效果。</p>
<p><strong>Aim</strong>属性提供了Virtual Camera对于佘香即旋转的算法选择，从而达到适配各种游戏类型的摄像机镜头选择要求。</p>
<p><img src="/img/Unity/Timeline_Cinemachine/CinemachineAimProperties.PNG" alt="CinemachineAimProperties"></p>
<p><strong>Body</strong>和<strong>Aim</strong>通过细节的参数调整能实现各种角度以及各种游戏类型需求的摄像机跟随聚焦效果，这里博主暂时就不深入学习讨论了，有兴趣的可以参考文档去了解细节。</p>
<p>那么Virtual Camera的聚焦效果是如何实现的了？</p>
<p>了解聚焦效果之前有几个重钙的概念需要了解:</p>
<ol>
<li><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Packages/com.unity.cinemachine@2.3/manual/CinemachineOverview.html"><strong>Dead zone</strong>: The area of the frame that Cinemachine keeps the target in.</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Packages/com.unity.cinemachine@2.3/manual/CinemachineOverview.html"><strong>Soft zone</strong>: If the target enters this region of the frame, the camera will re-orient to put it back in the dead zone. It will do this slowly or quickly, according to the time specified in the Damping settings.</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Packages/com.unity.cinemachine@2.3/manual/CinemachineOverview.html"><strong>Screen</strong>: The screen position of the center of the dead zone. 0.5 is the center of the screen.</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Packages/com.unity.cinemachine@2.3/manual/CinemachineOverview.html"><strong>Damping</strong>: Simulates the lag that a real camera operator introduces while operating a heavy physical camera. Damping specifies quickly or slowly the camera reacts when the target enters the <strong>soft zone</strong> while the camera tracks the target. Use small numbers to simulate a more responsive camera, rapidly moving or aiming the camera to keep the target in the <strong>dead zone</strong>. Larger numbers simulate heavier cameras, The larger the value, the more Cinemachine allows the target to enter the soft zone.</a></p>
</li>
</ol>
<p><img src="/img/Unity/Timeline_Cinemachine/CinemachineZone.PNG" alt="CinemachineZone"></p>
<p>Dead Zone, Soft Zone, Screen参数在Body和Aim的属性面板上有体现，他们决定了摄像机是如何应对Look At对象走出指定区域时响应变化以及如何确保Look At对象在指定区域内的。</p>
<h3 id="Cinemachine-Camera-Types"><a href="#Cinemachine-Camera-Types" class="headerlink" title="Cinemachine Camera Types"></a>Cinemachine Camera Types</h3><p>Unity Cinemachine自带了很多种摄像机用于不同的游戏种类:</p>
<p><img src="/img/Unity/Timeline_Cinemachine/CinemachineCameraTypes.PNG" alt="CinemachineCameraTypes"></p>
<p>不同的摄像机种类适用于不同的游戏类型。</p>
<h4 id="Virtual-Camera"><a href="#Virtual-Camera" class="headerlink" title="Virtual Camera"></a>Virtual Camera</h4><p>Virtual Camera在前面的介绍已经提过了，这里就不再重复了，后续的摄像机类型大部分也是基于Virtual Camera的，只是在Virtual Camera的基础上实现了一套各自摄像机管理方式从而达到不同的摄像机类型效果。</p>
<h4 id="FreeLook-Camera"><a href="#FreeLook-Camera" class="headerlink" title="FreeLook Camera"></a>FreeLook Camera</h4><p>此类摄像机没有基于Virtual Camera而是单独挂载了一个Cinemachine Free Look的脚本实现的。</p>
<p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Packages/com.unity.cinemachine@2.1/manual/index.html#collision-avoidance-and-shot-evaluation">A Cinemachine Camera geared towards a 3rd person camera experience. The camera orbits around its subject with three separate camera rigs defining rings around the target. Each rig has its own radius, height offset, composer, and lens settings. Depending on the camera’s position along the spline connecting these three rigs, these settings are interpolated to give the final camera position and state.</a></p>
<p>从介绍可以看出，FreeLook Camera是用于第三人称围绕目标对象旋转控制的一套摄像机类型(比如第三人称RPG等游戏，有围绕主角相关的摄像机旋转控制等)。</p>
<h4 id="State-Driven-Camera"><a href="#State-Driven-Camera" class="headerlink" title="State-Driven Camera"></a>State-Driven Camera</h4><p>这里的State指的是Animator里的State，通过State-Drive Camera我们可以轻易的实现Animator State和Virtual Camera选择的绑定。这样就能轻易实现Walk状态用什么Virtual Camera，Idle状态使用什么Virtual Camera的效果。</p>
<p>更多的摄像机类型参考:</p>
<p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Packages/com.unity.cinemachine@2.1/manual/index.html">About Cinemachine</a></p>
<p>这里还值得一提的是摄像机限定移动范围和摄像机被障碍物主档导致目标对象不可见时Cinemachine提供的一种解决方案：</p>
<h3 id="Collision-Avoidance-and-Shot-Evaluation"><a href="#Collision-Avoidance-and-Shot-Evaluation" class="headerlink" title="Collision Avoidance and Shot Evaluation"></a>Collision Avoidance and Shot Evaluation</h3><h4 id="CinemachineCollider"><a href="#CinemachineCollider" class="headerlink" title="CinemachineCollider"></a>CinemachineCollider</h4><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Packages/com.unity.cinemachine@2.1/manual/index.html#collision-avoidance-and-shot-evaluation">An add-on module for Cinemachine Virtual Camera that post-processes the final position of the virtual camera. Based on the supplied settings, the Collider will attempt to preserve the line of sight with the LookAt target of the virtual camera by moving away from objects that will obstruct the view.</a></p>
<p>简单来说CinemachineCollider是通过相关设置，通过射线检测评估出当前摄像机最优的位置，从而避免被障碍物遮挡视线等问题。</p>
<p>Note:</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Packages/com.unity.cinemachine@2.1/manual/index.html#collision-avoidance-and-shot-evaluation">The collider uses Physics Raycasts to do these things, hence obstacles in the scene must have collider volumes in order to be visible to the CinemachineCollider.</a></li>
</ol>
<h4 id="CinemachineConfiner"><a href="#CinemachineConfiner" class="headerlink" title="CinemachineConfiner"></a>CinemachineConfiner</h4><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Packages/com.unity.cinemachine@2.1/manual/index.html#collision-avoidance-and-shot-evaluation">An add-on module for Cinemachine Virtual Camera that post-processes the final position of the virtual camera. It will confine the virtual camera’s position to the volume specified in the Bounding Volume field.</a></p>
<p>从介绍可以看出CinemachineConfiner相比CinemachineCollider，这是一个单纯限制摄像机运动范围的组件，更加轻量，没有过多多射线检测评估等过程，用于简单的限制摄像机运动范围，此组件更佳。</p>
<p>Note:</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Packages/com.unity.cinemachine@2.1/manual/index.html#collision-avoidance-and-shot-evaluation">This is less resource-intensive than CinemachineCollider, but it does not perform shot evaluation.</a></li>
</ol>
<h3 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h3><p>实战前，先让我们明确下个人的摄像机需求，需求明确了才能更加正确的使用Cinemachine达到效果。</p>
<p>摄像机需求:</p>
<ol>
<li>支持相机单独控制操作</li>
<li>支持相机限定移动范围操作</li>
<li>支持相机锁定目标操作</li>
<li>支持相机锁定目标和自由操作自由切换操作</li>
<li>支持相机锁定目标操作回调上层逻辑(用于配合逻辑层做事情)</li>
<li>场景摄像机支持多个摄像机同时控制(比如:MainCamera和3D UI Camera)</li>
</ol>
<p>待续……</p>
<h2 id="TextMeshPro"><a href="#TextMeshPro" class="headerlink" title="TextMeshPro"></a>TextMeshPro</h2><h3 id="What-1"><a href="#What-1" class="headerlink" title="What"></a>What</h3><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/com.unity.textmeshpro.html">TextMesh Pro is the ultimate text solution for Unity. It’s the perfect replacement for Unity’s UI Text and the legacy Text Mesh.</a></p>
<p>TextMeshPro原本是第三方个人编写的一款更优的Unity文本替代方案，后被Unity官方收购。</p>
<h3 id="Why-1"><a href="#Why-1" class="headerlink" title="Why"></a>Why</h3><p>使用TextMeshPro替代原生文本的原因有很多：</p>
<ol>
<li>TMP使用了SDF(<strong>Signed Distance Field</strong>)技术达到不失真的放大缩小渲染</li>
<li>TMP自带实现了图文混排(通过富文本打Tag的形式)以及很多文本所需的功能(e.g. 字间距，自定义字体大小，段落格式，对齐方式等)</li>
<li>TMP使用Shader去实现更好的文本表现效果(类似PS的一些效果)满足文本需求</li>
</ol>
<p>缺点:</p>
<ol>
<li>不支持动态字体(看网上说是TMP1.4支持动态字体(Generating Settings)，但我在Unity2018.4.1.f1上导入的TMP没有找到动态字体设置的入口，望知道的朋友告知一声在哪里设置)，需要生成对应的字体纹理库(对于文字多的比如中文来说有很大的内存压力)</li>
</ol>
<p>SDF(<strong>Signed Distance Field</strong>)介绍:<br><a target="_blank" rel="noopener" href="http://www.sardinefish.com/blog/?pid=296">一个空间区域的SDF函数定义为，从空间中任意给定的一点到该区域边界的距离，SDF函数值的符号取决于该点在区域的内部还是外部，外部为正，内部为负。</a></p>
<p>这里可以简单的理解成TMP通过函数式的定义方式(类似矢量图的定义方式)来解决像素图放大模糊的问题来渲染出可动态放大缩小不模糊的图像。深入理解参考下面的链接：<a target="_blank" rel="noopener" href="http://www.sardinefish.com/blog/?pid=296">函数式编程与 Signed Distance Field</a></p>
<h3 id="How-1"><a href="#How-1" class="headerlink" title="How"></a>How</h3><p>TMP需要通过TMP提供的字体库制作工具制作所需的对应字体文件：<br><img src="/img/Unity/TextMeshPro/FontAssetCreatePanel.png" alt="FontAssetCreatePanel"><br>如果想要使用图文混排还需要自己制作SpriteAsset:<br><img src="/img/Unity/TextMeshPro/SpriteAssetCreatePanel.png" alt="SpriteAssetCreatePanel"><br>制作好后创建TextMeshPro组件后指定需要使用的Font Asset和Sprite Asset即可:<br><img src="/img/Unity/TextMeshPro/TextMeshProAssignFontAssetAndSpriteAsset.png" alt="TextMeshProAssignFontAssetAndSpriteAsset"></p>
<p>最终效果：<br><img src="/img/Unity/TextMeshPro/TextMeshProUsing.png" alt="TextMeshProUsing"><br>TextMeshPro同一个Font Asset需要制作不同的渲染效果需要通过制作不同的Material来实现：<br><img src="/img/Unity/TextMeshPro/CreateFontAssetMaterial.png" alt="CreateFontAssetMaterial"></p>
<p>然后在针对新创建的Material Asset调整Shader和具体效果即可，创建完成后就可以在Font Asset的材质下拉列表里选择需要使用的效果：<br><img src="/img/Unity/TextMeshPro/FontAssetMaterialChosen.png" alt="FontAssetMaterialChosen"></p>
<p>关于TextMeshPro的默认相关设置(e.g. 默认创建的Font Asset，默认Fallback到的Font Asset等)是通过TMP Settings文件里的设置来完成的:<br><img src="/img/Unity/TextMeshPro/TMPSettings.png" alt="TMPSettings"></p>
<p>Note:</p>
<ol>
<li>TMP的Fallback的使用是在原始设定的Font Asset里找不到对应文字时的一种回退安全机制，官方的建议是真正使用的Font Asset采用高分率图集，Fallback的Font Asset采用低分辨率图集。</li>
</ol>
<h1 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h1><h2 id="Sprite-Atlas-1"><a href="#Sprite-Atlas-1" class="headerlink" title="Sprite Atlas"></a>Sprite Atlas</h2><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/class-SpriteAtlas.html">Sprite Atlas</a><br><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/MasterVariantAtlases.html">Master and Variant Sprite Atlases</a><br><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/VariantSpriteAtlas.html">Variant Sprite Atlas</a><br><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/SpriteAtlasWorkflow.html">Sprite Atlas workflow</a><br><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/SpriteAtlasDistribution.html">Preparing Sprite Atlases for distribution</a><br><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/SpritePackerModes.html">Sprite Packer Modes</a><br><a target="_blank" rel="noopener" href="https://gameinstitute.qq.com/community/detail/127434">Unity2017新功能之Sprite Atlas详解</a><br><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/80584461">UGUI的图集处理方式-SpriteAtlas的前世今生</a></p>
<h2 id="Timeline-1"><a href="#Timeline-1" class="headerlink" title="Timeline"></a>Timeline</h2><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq826364410/article/details/80511057">Unity–Timeline自定义PlayableTrack</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/beihuanlihe130/article/details/79233320">Unity2017中Timeline的简单使用方法</a><br><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/69e60a27bccb">Unity使用Cinemachine和Timeline入门</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/Unity-Technologies/graph-visualizer">graph-visualizer</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.unity.com/tutorial/timeline#">Timeline</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.unity.com/technology/extending-timeline-a-practical-guide"><strong>xtending Timeline: A Practical Guide</strong></a></p>
<p><a target="_blank" rel="noopener" href="https://blog.unity.com/technology/creative-scripting-for-timeline"><strong>Creative Scripting for Timeline</strong></a></p>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=MzU5MjQ1NTEwOA==&mid=2247493316&idx=1&sn=7e4fef834a8066faca3d2f1f1a090bb4&chksm=fe1dd26fc96a5b79856840f556cf65026facb83520ac1891605e42d5e777d30a0d5219060e21&mpshare=1&scene=1&srcid=0606YJLYnfprk9UjpPQCnre1#rd">Playable API：定制你的动画系统</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/Playables.html">Playables API</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/Playables-Graph.html">The PlayableGraph</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/Playables-ScriptPlayable.html">ScriptPlayable and PlayableBehaviour</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/Playables-Examples.html">Playables Examples</a></p>
<h2 id="TextMesh-Pro"><a href="#TextMesh-Pro" class="headerlink" title="TextMesh Pro"></a>TextMesh Pro</h2><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/com.unity.textmeshpro.html">TextMesh Pro</a><br><a target="_blank" rel="noopener" href="http://www.sardinefish.com/blog/?pid=296">函数式编程与 Signed Distance Field</a><br><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/84700094">Unity游戏开发——TextMeshPro的使用</a><br><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=MzU5MjQ1NTEwOA==&mid=2247495323&idx=1&sn=3100249c5c4a88c20435d129d23eb727&chksm=fe1dda30c96a53267a53ed2bc0dd47bc73273f4e76f3a0d8f0ce322992e2e7e0b284d9a1df32&mpshare=1&scene=1&srcid=102134Bhmm1T67EKpzswm7mz#rd">在Unity 2018中充分使用TextMesh Pro</a><br><a target="_blank" rel="noopener" href="https://blogs.unity3d.com/2018/10/16/making-the-most-of-textmesh-pro-in-unity-2018/">Making the most of TextMesh Pro in Unity 2018</a></p>
<h2 id="Cinemachine-1"><a href="#Cinemachine-1" class="headerlink" title="Cinemachine"></a>Cinemachine</h2><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Packages/com.unity.cinemachine@2.3/manual/CinemachineOverview.html">Cinemachine overview</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.unity.com/tutorial/cinemachine#">Cinemachine Learn</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Unity/">Unity</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Unity/">Unity</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2019/05/20/SQLite学习/" title="SQLite学习" itemprop="url">SQLite学习</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Tony Tang" target="_blank" itemprop="author">Tony Tang</a>
		
  <p class="article-time">
    <time datetime="2019-05-20T15:29:25.000Z" itemprop="datePublished"> 发表于 2019-05-20</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="数据库"><a href="#数据库" class="headerlink" title="数据库"></a>数据库</h1><p>数据存储对于游戏开发来说是必不可少的，在常规的游戏开发中，后端服务器会采用<strong>MySQL(关系型数据库)</strong>,**MongoDB(非关系型数据库)**等作为数据库存储。</p>
<p>关于关系型和菲关系型数据库的学习理解参考:</p>
<p><a href="http://tonytang1990.github.io/2019/05/20/%E7%BD%91%E7%BB%9C%E9%80%9A%E4%BF%A1%E5%92%8C%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%AD%A6%E4%B9%A0/">网络通信和服务器学习</a></p>
<p>本章节是在没有后端但又有玩家数据存储需求的前提下诞生的，通过调研**SQLite(关系型数据库)**正是定位本地高效数据库而非CS结构的数据库，所以本章节通过深入学习SQLite，弄懂如何正确高效的把本地玩家数据存储到本地数据库。</p>
<h2 id="SQLite"><a href="#SQLite" class="headerlink" title="SQLite"></a>SQLite</h2><h3 id="What"><a href="#What" class="headerlink" title="What"></a>What</h3><p>首先来看看SQLite官网的一个介绍:<br><a target="_blank" rel="noopener" href="https://www.sqlite.org/whentouse.html">SQLite is not directly comparable to client&#x2F;server SQL database engines such as MySQL, Oracle, PostgreSQL, or SQL Server since SQLite is trying to solve a different problem.<br>Client&#x2F;server SQL database engines strive to implement a shared repository of enterprise data. They emphasize scalability, concurrency, centralization, and control. SQLite strives to provide local data storage for individual applications and devices. SQLite emphasizes economy, efficiency, reliability, independence, and simplicity.<br>SQLite does not compete with client&#x2F;server databases. SQLite competes with fopen().</a><br>从上面的介绍可以看出，SQLite(C语言编写的库)虽然也是关系型数据库，但他的定位和MySQL不一样，定位的是本地高效数据库而非CS结构的数据库。</p>
<h3 id="Why"><a href="#Why" class="headerlink" title="Why"></a>Why</h3><p>那么什么时候适用于SQLite?什么时候适用于MySQL(CS)了？<br>SQLite官网也给出了明确的介绍，详情参见官网<a target="_blank" rel="noopener" href="https://www.sqlite.org/whentouse.html">SQLite</a><br>这里只列举下官网介绍的什么时候适用于MYSQL:</p>
<ol>
<li>Client&#x2F;Server Applications(CS结构的程序–需要大量客户端服务器通信存储)</li>
<li>High-volume Websites(高吞吐量的网站)</li>
<li>Very large datasets(数据存储量大–数据大)</li>
<li>High Concurrency(高并发–很多人同时写入)</li>
</ol>
<h3 id="How"><a href="#How" class="headerlink" title="How"></a>How</h3><p>这里本人明确了暂时是打算用于单机版游戏的本地数据库，所以倾向于用SQLite来做。<br>接下来会接触以下几个知识点：</p>
<ol>
<li>Unity(游戏开发引擎)</li>
<li>SQLite4Unity3d(第三方给Unity封装好的SQLite库–支持Window，Android(ARM64貌似也支持了)和IOS)</li>
<li>Navicat(可视化数据库工具)</li>
<li>SQL(数据库查询语言)</li>
</ol>
<p><strong>目标</strong>:</p>
<ol>
<li>编写一个数据库操作UI界面，支持数据库的增删改查操作(方便学习使用SQLite4Unity3d提供的接口访问SQLite数据库)</li>
<li>利用Navicat查看Window本地存储的数据库数据(学会Navicat的基本使用和数据库SQL相关操作)</li>
<li>打包编译Window和Android版本到真机上查看效果(确保多平台的兼容性)</li>
</ol>
<h2 id="SQLite4Unity3d实战"><a href="#SQLite4Unity3d实战" class="headerlink" title="SQLite4Unity3d实战"></a>SQLite4Unity3d实战</h2><p><strong>环境准备</strong>:<br>Unity版本：2018.4.8f1<br>SQLite4Unity3d: <a target="_blank" rel="noopener" href="https://github.com/robertohuertasm/SQLite4Unity3d">SQLite4Unity3d</a><br>Navivat: <a target="_blank" rel="noopener" href="https://www.navicat.com/en/download/navicat-premium">Navicat Premium</a><br>SQL:<a target="_blank" rel="noopener" href="https://www.runoob.com/sql/sql-tutorial.html">SQL学习1</a> or <a target="_blank" rel="noopener" href="https://www.w3schools.com/sql/">SQL学习2</a></p>
<p>Note:</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://github.com/robertohuertasm/SQLite4Unity3d"><strong>SQLite4Unity3d uses only the synchronous part of sqlite-net, so all the calls to the database are synchronous.</strong></a>(<strong>SQLite4Unity3d有这么一句官方提示，可以看出所有的数据库操作都是同步的。这里考虑到都是单机本地存储同时数据量也不会很大，所以同步异步不是很重要，所以并不影响个人使用。</strong>)</li>
</ol>
<h3 id="PC实战"><a href="#PC实战" class="headerlink" title="PC实战"></a>PC实战</h3><p>接下来结合SQLite4Unity3d来实战学习数据库的增删改查等操作。<br><strong>第1步</strong><br>创建空的Unity工程，制作简单的交互UI<br><img src="/img/Database/SQLiteUserInterface.png" alt="SQLiteUserInterface"></p>
<p><strong>第2步</strong><br>拷贝SQLite相关库文件：<br><img src="/img/Database/SQLitePlugin.png" alt="SQLitePlugin"><br>还要拷贝SQLite.cs(SQLite4Unity3d作者封装的访问SQLite的相关接口)<br>通过查看SQLite.cs的源代码可以看出,作者封装的这一层通过CS层多抽象了一层数据库访问(增删改查)和表格数据结构，然后结合反射(反射查找对应类的数据库)和Linq(实现快速的数据库查询)来实现通用的数据访问。</p>
<p><strong>第3步</strong><br>定义数据库表结构:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 玩家信息</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Player</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">PrimaryKey</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> UID &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> FirstName &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> LastName &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> Age &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="built_in">string</span> <span class="title">ToString</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">$&quot;[Player: UId=<span class="subst">&#123;UID&#125;</span>, FirstName=<span class="subst">&#123;FirstName&#125;</span>,  LastName=<span class="subst">&#123;LastName&#125;</span>, Age=<span class="subst">&#123;Age&#125;</span>]&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>第4步</strong><br>建立SQLite数据库连接(不存在的话会根据Flag决定是否自动创建):</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">DatabaseFolderPath = <span class="string">$&quot;<span class="subst">&#123;Application.persistentDataPath&#125;</span>/&quot;</span>;</span><br><span class="line"><span class="comment">// 建立数据库连接</span></span><br><span class="line">mSQLiteConnect = <span class="keyword">new</span> SQLiteConnection(<span class="string">$&quot;<span class="subst">&#123;DatabaseFolderPath&#125;</span>/<span class="subst">&#123;DatabaseName&#125;</span>&quot;</span>, SQLiteOpenFlags.ReadWrite | SQLiteOpenFlags.Create);</span><br></pre></td></tr></table></figure>

<p>可以看到本来StreamingAssets目录下没有数据库文件的这一下就创建成功了。<br><img src="/img/Database/CreateDatabase.png" alt="CreateDatabase"></p>
<p><strong>第5步</strong><br>数据库里创建玩家表:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mSQLiteConnect.CreateTable&lt;Player&gt;();</span><br></pre></td></tr></table></figure>

<p><img src="/img/Database/CreatePlayerTable.png" alt="CreatePlayerTable"><br>因为还没有数据所以看不到数据打印，通过Navicat打开数据库，我们可以看到已经成功创建了Player表:<br><img src="/img/Database/PlayerTableView.png" alt="PlayerTableView"></p>
<p><strong>第6步</strong><br>玩家表插入玩家数据：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">mSQLiteConnect.Insert(<span class="keyword">new</span> Player</span><br><span class="line">        &#123;</span><br><span class="line">            UID = <span class="number">1</span>,</span><br><span class="line">            FirstName = <span class="string">&quot;Huan&quot;</span>,</span><br><span class="line">            LastName = <span class="string">&quot;Tang&quot;</span>,</span><br><span class="line">            Age = <span class="number">29</span>,</span><br><span class="line">        &#125;);</span><br><span class="line">        mSQLiteConnect.Insert(<span class="keyword">new</span> Player</span><br><span class="line">        &#123;</span><br><span class="line">            UID = <span class="number">3</span>,</span><br><span class="line">            FirstName = <span class="string">&quot;XiaoYun&quot;</span>,</span><br><span class="line">            LastName = <span class="string">&quot;Zhou&quot;</span>,</span><br><span class="line">            Age = <span class="number">28</span>,</span><br><span class="line">        &#125;);</span><br><span class="line">        mSQLiteConnect.Insert(<span class="keyword">new</span> Player</span><br><span class="line">        &#123;</span><br><span class="line">            UID = <span class="number">2</span>,</span><br><span class="line">            FirstName = <span class="string">&quot;Jiang&quot;</span>,</span><br><span class="line">            LastName = <span class="string">&quot;Fan&quot;</span>,</span><br><span class="line">            Age = <span class="number">28</span>,</span><br><span class="line">        &#125;);</span><br><span class="line">        mSQLiteConnect.Insert(<span class="keyword">new</span> Player</span><br><span class="line">        &#123;</span><br><span class="line">            UID = <span class="number">5</span>,</span><br><span class="line">            FirstName = <span class="string">&quot;ZhenLiang&quot;</span>,</span><br><span class="line">            LastName = <span class="string">&quot;Li&quot;</span>,</span><br><span class="line">            Age = <span class="number">29</span>,</span><br><span class="line">        &#125;);</span><br><span class="line">        mSQLiteConnect.Insert(<span class="keyword">new</span> Player</span><br><span class="line">        &#123;</span><br><span class="line">            UID = <span class="number">4</span>,</span><br><span class="line">            FirstName = <span class="string">&quot;XiaoLin&quot;</span>,</span><br><span class="line">            LastName = <span class="string">&quot;Kuang&quot;</span>,</span><br><span class="line">            Age = <span class="number">28</span>,</span><br><span class="line">        &#125;);</span><br></pre></td></tr></table></figure>

<p><img src="/img/Database/InsertPlayerTableData.png" alt="InsertPlayerTableData"></p>
<p><strong>第7步</strong><br>玩家表删除指定玩家ID数据：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mSQLiteConnect.Delete&lt;Player&gt;(deleteuid);</span><br></pre></td></tr></table></figure>

<p><img src="/img/Database/DeletePlayerTableData.png" alt="DeletePlayerTableData"></p>
<p><strong>第7步</strong><br>玩家表修改指定玩家Age数据：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">valideplayer.Age = newage;</span><br><span class="line">mSQLiteConnect.Update(valideplayer);</span><br></pre></td></tr></table></figure>

<p><img src="/img/Database/ModifyPlayerTableAgeData.png" alt="ModifyPlayerTableAgeData"></p>
<p><strong>第8步</strong><br>删除玩家表所有数据：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> rownumber = mSQLiteConnect.DeleteAll&lt;Player&gt;();</span><br></pre></td></tr></table></figure>

<p><img src="/img/Database/DeleteAllPlayerTableData.png" alt="DeleteAllPlayerTableData"><br>可以看到我们成功删除了玩家表里的所有数据，接下来用Navicat验证下数据库里的情况：<br><img src="/img/Database/DatabaseAfterDeleteAllPlayerTableData.png" alt="DatabaseAfterDeleteAllPlayerTableData"></p>
<p><strong>第9步</strong><br>删除数据库里的玩家表：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> rownumberaffected = mSQLiteConnect.DropTable&lt;Player&gt;();</span><br></pre></td></tr></table></figure>

<p><img src="/img/Database/DeletePlayerTable.png" alt="DeletePlayerTable"><br>删除玩家表后通过Navicat查看数据库:<br><img src="/img/Database/DatabaseViewAfterDeletePlayerTable.png" alt="DatabaseViewAfterDeletePlayerTable"><br>通过查看源码，我们可以看到，DraopTable底层实际是通过调用SQL的Drop语句来实现删除表的:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Executes a &quot;drop table&quot; on the database.  This is non-recoverable.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="built_in">int</span> <span class="title">DropTable</span>&lt;<span class="title">T</span>&gt;()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> map = GetMapping (<span class="keyword">typeof</span> (T));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> query = <span class="built_in">string</span>.Format(<span class="string">&quot;drop table if exists \&quot;&#123;0&#125;\&quot;&quot;</span>, map.TableName);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Execute (query);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>关于SQL更多学习参考:<br><a target="_blank" rel="noopener" href="https://www.runoob.com/sql/sql-tutorial.html">SQL 教程</a><br><a target="_blank" rel="noopener" href="https://www.w3schools.com/sql/default.asp">SQL Tutorial</a><br>可以看到通过使用SQLite4Unity3d的SQLite.cs相关的接口，成功的实现了对于数据库的创建，以及数据库表的创建，增删改查等操作。</p>
<p><strong>第10步</strong><br>关闭数据库连接:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mSQLiteConnect.Close();</span><br></pre></td></tr></table></figure>

<h3 id="Android实战"><a href="#Android实战" class="headerlink" title="Android实战"></a>Android实战</h3><p>为了验证SQLite4Unity3d的跨平台能力，接下来打包验证真机:<br>Android真机数据库操作:<br><img src="/img/Database/AndroidSQLiteUsing.png" alt="AndroidSQLiteUsing"></p>
<p>Android真机数据库文件查看(本人使用的<strong>ES文件浏览器</strong>)：<br>![DatabaseViewAfterOperation]&#x2F;img&#x2F;Database&#x2F;DatabaseViewAfterOperation.png)</p>
<p>Android真机数据库详细信息PC查看:<br><img src="/img/Database/AndroidDatabaseView.png" alt="AndroidDatabaseView"></p>
<p>可以看到Android真机上数据库的一些基础操作都成功了的。IOS这里就暂时不验证了，根据Github上的介绍理论上是支持的。</p>
<p>Note:</p>
<ol>
<li>真机可读取目录修改为Application.persistentDataPath,因为Application.streamingAssetsPath在真机上是只读目录。</li>
<li>真机使用<strong>ES文件浏览器</strong>来查看程序目录下的数据库文件</li>
</ol>
<h3 id="SQLite4Unity3d进阶"><a href="#SQLite4Unity3d进阶" class="headerlink" title="SQLite4Unity3d进阶"></a>SQLite4Unity3d进阶</h3><p>学习了SQLite4Unity3d的基础使用，接下来要考虑的是实战使用时，如何封装一层数据库管理，方便游戏里的所有数据库数据都成功的加载读取修改保存。</p>
<p>这里主要是对于SQLite.cs的简单封装，用于支持多数据库创建，以及数据库创建路径管理，以及自定义数据库表的封装访问。</p>
<p>上代码之前，先简单看下封装的代码设计:</p>
<ul>
<li>DatabaseManager.cs(<strong>对多数据库创建访问以及路径规划进行封装支持</strong>)</li>
<li>BaseDatabase.cs(<strong>数据库基类抽象</strong>–实现对数据库操作进行封装)</li>
<li>BaseTableData.cs(<strong>数据库表数据基类抽象</strong>–实现对数据库表操作进行封装)</li>
<li>BaseIntTableData.cs(<strong>int做主键的表数据抽象</strong>–实现对int主键表的操作封装)</li>
<li>BaseStringTableData.cs(<strong>string做主键的表数据抽象</strong>–实现对string主键表的操作封装)</li>
</ul>
<p>DatabaseManager.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">TH.Modules.Data</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 数据库管理类</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 主要功能如下:</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 1. 数据库路径处理(数据库存储管理)</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 2. 多数据库支持</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 3. 数据库连接，关闭，CUID操作等操作依然使用SQLite的封装</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">DatabaseManager</span> : <span class="title">SingletonTemplate</span>&lt;<span class="title">DatabaseManager</span>&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 数据库文件夹地址</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> <span class="keyword">static</span> <span class="built_in">string</span> DatabaseFolderPath = Application.persistentDataPath + <span class="string">&quot;/Database/&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 已连接的数据库映射Map</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> Key为数据库名，Value为对应的数据库连接</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">private</span> Dictionary&lt;<span class="built_in">string</span>, SQLiteConnection&gt; ConnectedDatabaseMap;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">DatabaseManager</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//检查数据库文件目录是否存在</span></span><br><span class="line">            <span class="keyword">if</span>(!Directory.Exists(DatabaseFolderPath))</span><br><span class="line">            &#123;</span><br><span class="line">                Directory.CreateDirectory(DatabaseFolderPath);</span><br><span class="line">            &#125;</span><br><span class="line">            ConnectedDatabaseMap = <span class="keyword">new</span> Dictionary&lt;<span class="built_in">string</span>, SQLiteConnection&gt;();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 打开数据库连接</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;databasename&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;openflags&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;storeDateTimeAsTicks&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">openDatabase</span>(<span class="params"><span class="built_in">string</span> databasename, SQLiteOpenFlags openflags = SQLiteOpenFlags.ReadWrite | SQLiteOpenFlags.Create, <span class="built_in">bool</span> storeDateTimeAsTicks = <span class="literal">false</span></span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(!isDatabaseConnected(databasename))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> databasepath = DatabaseFolderPath + databasename;</span><br><span class="line">                <span class="keyword">var</span> connection = <span class="keyword">new</span> SQLiteConnection(databasepath, openflags, storeDateTimeAsTicks);</span><br><span class="line">                ConnectedDatabaseMap.Add(databasename, connection);</span><br><span class="line">                Debug.Log(<span class="string">$&quot;连接数据库:<span class="subst">&#123;databasename&#125;</span>&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                Debug.Log(<span class="string">$&quot;数据库:<span class="subst">&#123;databasename&#125;</span>已连接,请勿重复连接!&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 获取指定数据库连接</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;databasename&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> SQLiteConnection <span class="title">getDatabaseConnection</span>(<span class="params"><span class="built_in">string</span> databasename</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            SQLiteConnection connection;</span><br><span class="line">            <span class="keyword">if</span> (ConnectedDatabaseMap.TryGetValue(databasename, <span class="keyword">out</span> connection))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> connection;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 关闭数据库连接</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;databasename&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">closeDatabase</span>(<span class="params"><span class="built_in">string</span> databasename</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            SQLiteConnection connection;</span><br><span class="line">            <span class="keyword">if</span>(ConnectedDatabaseMap.TryGetValue(databasename, <span class="keyword">out</span> connection))</span><br><span class="line">            &#123;</span><br><span class="line">                connection.Close();</span><br><span class="line">                ConnectedDatabaseMap.Remove(databasename);</span><br><span class="line">                Debug.Log(<span class="string">$&quot;关闭数据库:<span class="subst">&#123;databasename&#125;</span>&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                Debug.LogError(<span class="string">$&quot;未连接数据库:<span class="subst">&#123;databasename&#125;</span>,关闭失败!&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 关闭所有已连接的数据库</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">closeAllDatabase</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">var</span> databasename <span class="keyword">in</span> ConnectedDatabaseMap.Keys)</span><br><span class="line">            &#123;</span><br><span class="line">                closeDatabase(databasename);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 清除</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">clear</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            closeAllDatabase();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 指定数据库是否已连接</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;databasename&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="built_in">bool</span> <span class="title">isDatabaseConnected</span>(<span class="params"><span class="built_in">string</span> databasename</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> ConnectedDatabaseMap.ContainsKey(databasename);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="keyword">region</span> 辅助方法</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 获取指定数据库表的所有数据</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;typeparam name=&quot;T&quot;&gt;</span><span class="doctag">&lt;/typeparam&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;databasename&quot;&gt;</span>数据库名<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">getTableAllDatasInOneString</span>&lt;<span class="title">T</span>&gt;(<span class="params"><span class="built_in">string</span> databasename</span>) <span class="keyword">where</span> T : <span class="keyword">new</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            SQLiteConnection sqliteconnection = getDatabaseConnection(databasename);</span><br><span class="line">            <span class="keyword">if</span> (sqliteconnection != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> querytable = sqliteconnection.Table&lt;T&gt;();</span><br><span class="line">                <span class="keyword">if</span> (querytable != <span class="literal">null</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">var</span> result = <span class="built_in">string</span>.Empty;</span><br><span class="line">                    <span class="keyword">foreach</span> (<span class="keyword">var</span> data <span class="keyword">in</span> querytable)</span><br><span class="line">                    &#123;</span><br><span class="line">                        result += data.ToString();</span><br><span class="line">                        result += <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">return</span> result;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="built_in">string</span>.Empty;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">string</span>.Empty;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>TODO:</p>
<ol>
<li><strong>现阶段是默认存在包外的persistentDataPath，对于数据库如何做好加密管理避免被轻易修改，这个问题还有待学习思考。</strong></li>
<li><strong>数据库表是否存在还没找到方式判定(暂时是从流程上确保表存在的)</strong></li>
</ol>
<p>BaseDatabase.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">TH.Modules.Data</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> BaseDatabase.cs</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 数据库基类抽象</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Note:</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 子类自行实现单例模式方便访问</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title">BaseDatabase</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 数据库连接</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">protected</span> SQLiteConnection mSQLiteConnect;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 数据库名</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">virtual</span> <span class="built_in">string</span> DatabaseName</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">$&quot;<span class="subst">&#123;GetType().Name&#125;</span>.db&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="title">BaseDatabase</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 加载数据库</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">LoadDatabase</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            mSQLiteConnect = DatabaseManager.Singleton.openDatabase(DatabaseName);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 数据库是否已连接</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">IsConnected</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> mSQLiteConnect != <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span>// <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span>// 指定表是否存在</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span>// <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span>// <span class="doctag">&lt;typeparam name=&quot;T&quot;&gt;</span><span class="doctag">&lt;/typeparam&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span>// <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment">//public bool IsTableExist&lt;T&gt;() where T : BaseTableData, new()</span></span><br><span class="line">        <span class="comment">//&#123;</span></span><br><span class="line">        <span class="comment">//    if (!IsConnected())</span></span><br><span class="line">        <span class="comment">//    &#123;</span></span><br><span class="line">        <span class="comment">//        Debug.LogError($&quot;数据库:&#123;DatabaseName&#125;未连接，访问类名:&#123;typeof(T).Name&#125;表是否存在失败!&quot;);</span></span><br><span class="line">        <span class="comment">//        return false;</span></span><br><span class="line">        <span class="comment">//    &#125;</span></span><br><span class="line">        <span class="comment">//    // <span class="doctag">TODO:</span> 找到方法判定是否存在</span></span><br><span class="line">        <span class="comment">//    return false;</span></span><br><span class="line">        <span class="comment">//&#125;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 创建指定数据库表</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;typeparam name=&quot;T&quot;&gt;</span><span class="doctag">&lt;/typeparam&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">CreateTable</span>&lt;<span class="title">T</span>&gt;() <span class="keyword">where</span> T : BaseTableData, <span class="keyword">new</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(!IsConnected())</span><br><span class="line">            &#123;</span><br><span class="line">                Debug.LogError(<span class="string">$&quot;数据库:<span class="subst">&#123;DatabaseName&#125;</span>未连接，创建类名:<span class="subst">&#123;<span class="keyword">typeof</span>(T).Name&#125;</span>表失败!&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//if(!IsTableExist&lt;T&gt;())</span></span><br><span class="line">            <span class="comment">//&#123;</span></span><br><span class="line">            <span class="comment">//    Debug.LogError($&quot;数据库:&#123;DatabaseName&#125;，类名:&#123;typeof(T).Name&#125;表已存在，请勿重复创建!&quot;);</span></span><br><span class="line">            <span class="comment">//    return false;</span></span><br><span class="line">            <span class="comment">//&#125;</span></span><br><span class="line">            mSQLiteConnect.CreateTable&lt;T&gt;();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 插入指定int主键的表数据(如果表不存在则创建表)</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;typeparam name=&quot;T&quot;&gt;</span><span class="doctag">&lt;/typeparam&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">InsertDataI</span>&lt;<span class="title">T</span>&gt;(<span class="params">T data</span>) <span class="keyword">where</span> T : BaseIntTableData, <span class="keyword">new</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (!IsConnected())</span><br><span class="line">            &#123;</span><br><span class="line">                Debug.LogError(<span class="string">$&quot;数据库:<span class="subst">&#123;DatabaseName&#125;</span>未连接，插入类名:<span class="subst">&#123;<span class="keyword">typeof</span>(T).Name&#125;</span>表数据失败!&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//if (!IsTableExist&lt;T&gt;())</span></span><br><span class="line">            <span class="comment">//&#123;</span></span><br><span class="line">            <span class="comment">//    CreateTable&lt;T&gt;();</span></span><br><span class="line">            <span class="comment">//&#125;</span></span><br><span class="line">            mSQLiteConnect.Insert(data);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 插入指定int主键的表数据(如果表不存在则创建表,如果主键存在则覆盖更新)</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;typeparam name=&quot;T&quot;&gt;</span><span class="doctag">&lt;/typeparam&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">InsertOrReplaceDataI</span>&lt;<span class="title">T</span>&gt;(<span class="params">T data</span>) <span class="keyword">where</span> T : BaseIntTableData, <span class="keyword">new</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (!IsConnected())</span><br><span class="line">            &#123;</span><br><span class="line">                Debug.LogError(<span class="string">$&quot;数据库:<span class="subst">&#123;DatabaseName&#125;</span>未连接，插入类名:<span class="subst">&#123;<span class="keyword">typeof</span>(T).Name&#125;</span>表数据失败!&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//if (!IsTableExist&lt;T&gt;())</span></span><br><span class="line">            <span class="comment">//&#123;</span></span><br><span class="line">            <span class="comment">//    CreateTable&lt;T&gt;();</span></span><br><span class="line">            <span class="comment">//&#125;</span></span><br><span class="line">            mSQLiteConnect.InsertOrReplace(data);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 插入指定int主键的表数据(如果表不存在则创建表)</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;typeparam name=&quot;T&quot;&gt;</span><span class="doctag">&lt;/typeparam&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">InsertDataS</span>&lt;<span class="title">T</span>&gt;(<span class="params">T data</span>) <span class="keyword">where</span> T : BaseStringTableData, <span class="keyword">new</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (!IsConnected())</span><br><span class="line">            &#123;</span><br><span class="line">                Debug.LogError(<span class="string">$&quot;数据库:<span class="subst">&#123;DatabaseName&#125;</span>未连接，插入类名:<span class="subst">&#123;<span class="keyword">typeof</span>(T).Name&#125;</span>表数据失败!&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//if (!IsTableExist&lt;T&gt;())</span></span><br><span class="line">            <span class="comment">//&#123;</span></span><br><span class="line">            <span class="comment">//    CreateTable&lt;T&gt;();</span></span><br><span class="line">            <span class="comment">//&#125;</span></span><br><span class="line">            mSQLiteConnect.Insert(data);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 插入指定string主键的表数据(如果表不存在则创建表,如果主键存在则覆盖更新)</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;typeparam name=&quot;T&quot;&gt;</span><span class="doctag">&lt;/typeparam&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">InsertOrReplaceDataS</span>&lt;<span class="title">T</span>&gt;(<span class="params">T data</span>) <span class="keyword">where</span> T : BaseStringTableData, <span class="keyword">new</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (!IsConnected())</span><br><span class="line">            &#123;</span><br><span class="line">                Debug.LogError(<span class="string">$&quot;数据库:<span class="subst">&#123;DatabaseName&#125;</span>未连接，插入类名:<span class="subst">&#123;<span class="keyword">typeof</span>(T).Name&#125;</span>表数据失败!&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//if (!IsTableExist&lt;T&gt;())</span></span><br><span class="line">            <span class="comment">//&#123;</span></span><br><span class="line">            <span class="comment">//    CreateTable&lt;T&gt;();</span></span><br><span class="line">            <span class="comment">//&#125;</span></span><br><span class="line">            mSQLiteConnect.InsertOrReplace(data);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 删除指定UID的表数据(整形主键)</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;typeparam name=&quot;T&quot;&gt;</span><span class="doctag">&lt;/typeparam&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">DeleteDataByUIDI</span>&lt;<span class="title">T</span>&gt;(<span class="params"><span class="built_in">int</span> uid</span>) <span class="keyword">where</span> T : BaseIntTableData, <span class="keyword">new</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (!IsConnected())</span><br><span class="line">            &#123;</span><br><span class="line">                Debug.LogError(<span class="string">$&quot;数据库:<span class="subst">&#123;DatabaseName&#125;</span>未连接，删除类名:<span class="subst">&#123;<span class="keyword">typeof</span>(T).Name&#125;</span>表UID:<span class="subst">&#123;uid&#125;</span>数据失败!&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">var</span> deletedNumber = mSQLiteConnect.Delete&lt;T&gt;(uid);</span><br><span class="line">            Debug.Log(<span class="string">$&quot;数据库:<span class="subst">&#123;DatabaseName&#125;</span>，删除类名:<span class="subst">&#123;<span class="keyword">typeof</span>(T).Name&#125;</span>表UID:<span class="subst">&#123;uid&#125;</span>数量:<span class="subst">&#123;deletedNumber&#125;</span>&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> deletedNumber &gt; <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 删除指定UID的表数据(字符串主键)</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;typeparam name=&quot;T&quot;&gt;</span><span class="doctag">&lt;/typeparam&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">DeleteDataByUIDS</span>&lt;<span class="title">T</span>&gt;(<span class="params"><span class="built_in">string</span> uid</span>) <span class="keyword">where</span> T : BaseStringTableData, <span class="keyword">new</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (!IsConnected())</span><br><span class="line">            &#123;</span><br><span class="line">                Debug.LogError(<span class="string">$&quot;数据库:<span class="subst">&#123;DatabaseName&#125;</span>未连接，删除类名:<span class="subst">&#123;<span class="keyword">typeof</span>(T).Name&#125;</span>表数据失败!&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">var</span> deletedNumber = mSQLiteConnect.Delete&lt;T&gt;(uid);</span><br><span class="line">            Debug.Log(<span class="string">$&quot;数据库:<span class="subst">&#123;DatabaseName&#125;</span>，删除类名:<span class="subst">&#123;<span class="keyword">typeof</span>(T).Name&#125;</span>表UID:<span class="subst">&#123;uid&#125;</span>数量:<span class="subst">&#123;deletedNumber&#125;</span>&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> deletedNumber &gt; <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 更新指定int主键的表数据(如果表不存在则创建表)</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;typeparam name=&quot;T&quot;&gt;</span><span class="doctag">&lt;/typeparam&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">UpdateDataI</span>&lt;<span class="title">T</span>&gt;(<span class="params">T data</span>) <span class="keyword">where</span> T : BaseIntTableData, <span class="keyword">new</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (!IsConnected())</span><br><span class="line">            &#123;</span><br><span class="line">                Debug.LogError(<span class="string">$&quot;数据库:<span class="subst">&#123;DatabaseName&#125;</span>未连接，插入类名:<span class="subst">&#123;<span class="keyword">typeof</span>(T).Name&#125;</span>表数据失败!&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//if (!IsTableExist&lt;T&gt;())</span></span><br><span class="line">            <span class="comment">//&#123;</span></span><br><span class="line">            <span class="comment">//    CreateTable&lt;T&gt;();</span></span><br><span class="line">            <span class="comment">//&#125;</span></span><br><span class="line">            <span class="keyword">var</span> updatedNumber = mSQLiteConnect.Update(data);</span><br><span class="line">            Debug.Log(<span class="string">$&quot;数据库:<span class="subst">&#123;DatabaseName&#125;</span>，更新类名:<span class="subst">&#123;<span class="keyword">typeof</span>(T).Name&#125;</span>表UID:<span class="subst">&#123;data.UID&#125;</span>数量:<span class="subst">&#123;updatedNumber&#125;</span>&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> updatedNumber &gt; <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 更新指定string主键的表数据(如果表不存在则创建表)</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;typeparam name=&quot;T&quot;&gt;</span><span class="doctag">&lt;/typeparam&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">UpdateDataS</span>&lt;<span class="title">T</span>&gt;(<span class="params">T data</span>) <span class="keyword">where</span> T : BaseStringTableData, <span class="keyword">new</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (!IsConnected())</span><br><span class="line">            &#123;</span><br><span class="line">                Debug.LogError(<span class="string">$&quot;数据库:<span class="subst">&#123;DatabaseName&#125;</span>未连接，插入类名:<span class="subst">&#123;<span class="keyword">typeof</span>(T).Name&#125;</span>表数据失败!&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//if (!IsTableExist&lt;T&gt;())</span></span><br><span class="line">            <span class="comment">//&#123;</span></span><br><span class="line">            <span class="comment">//    CreateTable&lt;T&gt;();</span></span><br><span class="line">            <span class="comment">//&#125;</span></span><br><span class="line">            <span class="keyword">var</span> updatedNumber = mSQLiteConnect.Update(data);</span><br><span class="line">            Debug.Log(<span class="string">$&quot;数据库:<span class="subst">&#123;DatabaseName&#125;</span>，更新类名:<span class="subst">&#123;<span class="keyword">typeof</span>(T).Name&#125;</span>表UID:<span class="subst">&#123;data.UID&#125;</span>数量:<span class="subst">&#123;updatedNumber&#125;</span>&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> updatedNumber &gt; <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 获取指定UID的表数据(整形主键)</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;typeparam name=&quot;T&quot;&gt;</span><span class="doctag">&lt;/typeparam&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> T <span class="title">GetDataByUIDI</span>&lt;<span class="title">T</span>&gt;(<span class="params"><span class="built_in">int</span> uid</span>) <span class="keyword">where</span> T : BaseIntTableData, <span class="keyword">new</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (!IsConnected())</span><br><span class="line">            &#123;</span><br><span class="line">                Debug.LogError(<span class="string">$&quot;数据库:<span class="subst">&#123;DatabaseName&#125;</span>未连接，获取类名:<span class="subst">&#123;<span class="keyword">typeof</span>(T).Name&#125;</span>表数据失败!&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">var</span> data = mSQLiteConnect.Find&lt;T&gt;((databaseTable) =&gt; databaseTable.UID == uid);</span><br><span class="line">            <span class="keyword">if</span> (data == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                Debug.LogError(<span class="string">$&quot;数据库:<span class="subst">&#123;DatabaseName&#125;</span>，获取类名:<span class="subst">&#123;<span class="keyword">typeof</span>(T).Name&#125;</span>的UID:<span class="subst">&#123;uid&#125;</span>表数据不存在!&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> data;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 获取指定UID的表数据(字符串主键)</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;typeparam name=&quot;T&quot;&gt;</span><span class="doctag">&lt;/typeparam&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> T <span class="title">GetDataByUIDS</span>&lt;<span class="title">T</span>&gt;(<span class="params"><span class="built_in">string</span> uid</span>) <span class="keyword">where</span> T : BaseStringTableData, <span class="keyword">new</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (!IsConnected())</span><br><span class="line">            &#123;</span><br><span class="line">                Debug.LogError(<span class="string">$&quot;数据库:<span class="subst">&#123;DatabaseName&#125;</span>未连接，获取类名:<span class="subst">&#123;<span class="keyword">typeof</span>(T).Name&#125;</span>表数据失败!&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">var</span> data = mSQLiteConnect.Find&lt;T&gt;((databaseTable) =&gt; databaseTable.UID == uid);</span><br><span class="line">            <span class="keyword">if</span> (data == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                Debug.LogError(<span class="string">$&quot;数据库:<span class="subst">&#123;DatabaseName&#125;</span>，获取类名:<span class="subst">&#123;<span class="keyword">typeof</span>(T).Name&#125;</span>的UID:<span class="subst">&#123;uid&#125;</span>表数据不存在!&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> data;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 获取指定表所有数据</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;typeparam name=&quot;T&quot;&gt;</span><span class="doctag">&lt;/typeparam&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">TableQuery</span>&lt;<span class="title">T</span>&gt; <span class="title">GetAllData</span>&lt;<span class="title">T</span>&gt;() <span class="keyword">where</span> T : BaseTableData, <span class="keyword">new</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (!IsConnected())</span><br><span class="line">            &#123;</span><br><span class="line">                Debug.LogError(<span class="string">$&quot;数据库:<span class="subst">&#123;DatabaseName&#125;</span>未连接，获取类名:<span class="subst">&#123;<span class="keyword">typeof</span>(T).Name&#125;</span>表数据失败!&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">var</span> tbData = mSQLiteConnect.Table&lt;T&gt;();</span><br><span class="line">            <span class="keyword">if</span> (tbData == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                Debug.LogError(<span class="string">$&quot;数据库:<span class="subst">&#123;DatabaseName&#125;</span>，获取类名:<span class="subst">&#123;<span class="keyword">typeof</span>(T).Name&#125;</span>表所有数据不存在!&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> tbData;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 删除指定表所有数据</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="built_in">int</span> <span class="title">DeleteTableAll</span>&lt;<span class="title">T</span>&gt;() <span class="keyword">where</span> T : BaseTableData, <span class="keyword">new</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (!IsConnected())</span><br><span class="line">            &#123;</span><br><span class="line">                Debug.LogError(<span class="string">$&quot;数据库:<span class="subst">&#123;DatabaseName&#125;</span>未连接，删除类名:<span class="subst">&#123;<span class="keyword">typeof</span>(T).Name&#125;</span>表所有数据失败!&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//if (!IsTableExist&lt;T&gt;())</span></span><br><span class="line">            <span class="comment">//&#123;</span></span><br><span class="line">            <span class="comment">//    Debug.LogError($&quot;数据库:&#123;DatabaseName&#125;，删除类名:&#123;typeof(T).Name&#125;表不存在,删除所有数据失败!&quot;);</span></span><br><span class="line">            <span class="comment">//    return 0;</span></span><br><span class="line">            <span class="comment">//&#125;</span></span><br><span class="line">            <span class="keyword">var</span> deletedNumber = mSQLiteConnect.DeleteAll&lt;T&gt;();</span><br><span class="line">            Debug.Log(<span class="string">$&quot;数据库:<span class="subst">&#123;DatabaseName&#125;</span>，删除类名:<span class="subst">&#123;<span class="keyword">typeof</span>(T).Name&#125;</span>表所有数据数量:<span class="subst">&#123;deletedNumber&#125;</span>&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> deletedNumber;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 删除指定表</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="built_in">int</span> <span class="title">DeleteTable</span>&lt;<span class="title">T</span>&gt;() <span class="keyword">where</span> T : BaseTableData, <span class="keyword">new</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (!IsConnected())</span><br><span class="line">            &#123;</span><br><span class="line">                Debug.LogError(<span class="string">$&quot;数据库:<span class="subst">&#123;DatabaseName&#125;</span>未连接，删除类名:<span class="subst">&#123;<span class="keyword">typeof</span>(T).Name&#125;</span>表失败!&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">var</span> deletedNumber = mSQLiteConnect.DropTable&lt;T&gt;();</span><br><span class="line">            Debug.Log(<span class="string">$&quot;数据库:<span class="subst">&#123;DatabaseName&#125;</span>，删除类名:<span class="subst">&#123;<span class="keyword">typeof</span>(T).Name&#125;</span>表数量:<span class="subst">&#123;deletedNumber&#125;</span>&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> deletedNumber;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 关闭数据库</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">CloseDatabase</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            DatabaseManager.Singleton.closeDatabase(DatabaseName);</span><br><span class="line">            mSQLiteConnect = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>BaseTableData.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">TH.Modules.Data</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> BaseTableData.cs</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 数据库表数据基类抽象</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title">BaseTableData</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 表名</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> TableName</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> GetType().Name;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">BaseTableData</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 打印数据</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="built_in">string</span> <span class="title">ToString</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">$&quot;[TableName:<span class="subst">&#123;TableName&#125;</span>]&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>BaseIntTableData.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">TH.Modules.Data</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> BaseIntTableData.cs</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Int做主键的表数据抽象</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title">BaseIntTableData</span> : <span class="title">BaseTableData</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 主键UID</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        [<span class="meta">PrimaryKey</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">int</span> UID</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span>;</span><br><span class="line">            <span class="keyword">set</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">BaseIntTableData</span>() : <span class="title">base</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 构造函数</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;uid&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">BaseIntTableData</span>(<span class="params"><span class="built_in">int</span> uid</span>) : <span class="title">base</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            UID = uid;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 打印所有表数据</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="built_in">string</span> <span class="title">ToString</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">$&quot;[TableName:<span class="subst">&#123;TableName&#125;</span> UID:<span class="subst">&#123;UID&#125;</span>]&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>BaseStringTableData.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">TH.Modules.Data</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> BaseStringTableData.cs</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> string做主键的表数据抽象</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title">BaseStringTableData</span> : <span class="title">BaseTableData</span></span><br><span class="line">    &#123;</span><br><span class="line">        [<span class="meta">PrimaryKey</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> UID</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span>;</span><br><span class="line">            <span class="keyword">set</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">BaseStringTableData</span>() : <span class="title">base</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 构造函数</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;uid&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">BaseStringTableData</span>(<span class="params"><span class="built_in">string</span> uid</span>) : <span class="title">base</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            UID = uid;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 打印数据</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="built_in">string</span> <span class="title">ToString</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">$&quot;[TableName:<span class="subst">&#123;TableName&#125;</span> UID:<span class="subst">&#123;UID&#125;</span>]&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>GameDatabase.cs(自定义游戏数据库)</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> GameDatabase.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 游戏数据库</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">GameDatabase</span> : <span class="title">BaseDatabase</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 单例对象</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> GameDatabase Singleton</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(mSingleton != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> mSingleton;</span><br><span class="line">            &#125;</span><br><span class="line">            mSingleton = <span class="keyword">new</span> GameDatabase();</span><br><span class="line">            <span class="keyword">return</span> mSingleton;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> GameDatabase mSingleton;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">GameDatabase</span>() : <span class="title">base</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Player.cs(自定义玩家数据表结构)</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 玩家信息表成员结构</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Player</span> : <span class="title">BaseIntTableData</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 名</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> FirstName</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 姓</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> LastName</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 年龄</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Indexed</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> Age</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Player</span>() : <span class="title">base</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 构造函数</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;uid&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;firstName&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;lastName&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;age&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Player</span>(<span class="params"><span class="built_in">int</span> uid, <span class="built_in">string</span> firstName, <span class="built_in">string</span> lastName, <span class="built_in">int</span> age</span>) : <span class="title">base</span>(<span class="params">uid</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        FirstName = firstName;</span><br><span class="line">        LastName = lastName;</span><br><span class="line">        Age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 打印数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="built_in">string</span> <span class="title">ToString</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">$&quot;[Player: UID=<span class="subst">&#123;UID&#125;</span>, FirstName=<span class="subst">&#123;FirstName&#125;</span>,  LastName=<span class="subst">&#123;LastName&#125;</span>, Age=<span class="subst">&#123;Age&#125;</span>]&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>进阶版的实战代码见Github源码:</p>
<p><a target="_blank" rel="noopener" href="https://github.com/TonyTang1990/SQLiteStudy">SQLiteStudy</a></p>
<h2 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h2><ol>
<li><strong>SQLite适用于非CS结构，存储数据量不大，不会多人并发操作数据库的情况(好比单机游戏的数据库)。</strong></li>
<li><strong>数据量大或者多人操作频繁或者需要CS架构支持，更适合MySQL+Redis</strong></li>
<li><strong>SQLite4Unity3d通过反射和Linq对SQLite的封装实现了对于SQL无感和ORM(Object Relational Mapping)数据库访问方式。</strong></li>
<li><strong>SQLite4Unity3d支持多平台，适合单机游戏数据存储</strong></li>
</ol>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a target="_blank" rel="noopener" href="https://github.com/robertohuertasm/SQLite4Unity3d">SQLite4Unity3d</a></p>
<h1 id="Github地址"><a href="#Github地址" class="headerlink" title="Github地址"></a>Github地址</h1><p><a target="_blank" rel="noopener" href="https://github.com/TonyTang1990/SQLiteStudy">SQLiteStudy</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Database/">Database</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Database/">Database</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2019/05/20/网络通信和服务器学习/" title="网络通信和服务器学习" itemprop="url">网络通信和服务器学习</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Tony Tang" target="_blank" itemprop="author">Tony Tang</a>
		
  <p class="article-time">
    <time datetime="2019-05-20T15:29:25.000Z" itemprop="datePublished"> 发表于 2019-05-20</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>本章节是为了记录学习游戏开发过程中的服务器搭建以及前后端网络通信相关的知识点，游戏开发中联网是必不可少的，无论是从游戏热更新(服务器通知版本以及热更相关信息)，还是游戏社交(微信分享，联机组队)，还是防破解(服务器校验)都离不开网络通信和服务器。</p>
<p>本人是前端程序，对后端服务器开发几乎一窍不通，本篇文章也算是为了开阔自己的眼界，同时也是为了未来自己的游戏有网络这一块的支持需要对服务器搭建以及网络通信要有所了解。本文着重点不在于高效和优美的框架设计，着眼于基础的网络通信和服务器搭建，而这正是此篇博客的初衷。</p>
<ul>
<li>目标</li>
</ul>
<ol>
<li>理解游戏服务器工作原理</li>
<li>理解不同服务器框架的优劣，选择合适的服务器框架</li>
<li><strong>学会搭建基础的游戏服务器，具备基础的数据存储功能(本文重点)</strong></li>
<li><strong>掌握网络通信知识，搭建前后端通信框架，支持前后端通信(本文重点)</strong></li>
</ol>
<h1 id="服务器"><a href="#服务器" class="headerlink" title="服务器"></a>服务器</h1><p>那么什么是服务器了？</p>
<p>个人简单的理解，可以把服务器理解成运行在远程电脑上，通过网络对客户端提供服务(数据处理，数据存储读取，消息转发等)的机器或者软件。</p>
<p>了解服务器架构：</p>
<p><a target="_blank" rel="noopener" href="https://www.infoq.cn/article/a-brief-history-of-the-game-server-architecture">游戏服务器架构的演进简史</a></p>
<p>从上面可以看出服务器有以下几个基础功能：</p>
<ol>
<li>对于游戏数据和玩家数据的存储(数据存储)</li>
<li>对玩家数据进行数据广播和同步(消息通信)</li>
<li>把一部分游戏逻辑在服务器上运算，做好验证，防止外挂(服务器验证)</li>
<li>服务器架构设计(容灾，性能，扩容等)</li>
</ol>
<p>第三点涉及到前后端框架设计(帧同步 or 状态同步等)，第四点更与服务器端密切相关，本文着眼点是前两点，第三点和第四点作为未来学习的一个知识点，。</p>
<h2 id="数据存储"><a href="#数据存储" class="headerlink" title="数据存储"></a>数据存储</h2><h3 id="关系型数据库"><a href="#关系型数据库" class="headerlink" title="关系型数据库"></a>关系型数据库</h3><p><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%85%B3%E7%B3%BB%E6%95%B0%E6%8D%AE%E5%BA%93">关系数据库（英语：Relational database），是创建在关系模型基础上的数据库，借助于集合代数等数学概念和方法来处理数据库中的数据。现实世界中的各种实体以及实体之间的各种联系均用关系模型来表示。</a></p>
<p>个人简单的理解，关系数据库大概就是以前学SQL的时候，数据库里通过表来抽象实体数据，表之间通过ID映射关联起来的概念(e.g. 比如数据库里有两张表，一张员工表，一张员工数据表。员工表用于抽象员工ID，员工名字，员工薪资等信息。而员工数据用于存储员工ID，员工入职日期等信息。然后两张表示通过员工ID来映射关联起来。)。</p>
<p>典型的关系型数据库:<br>MySQL</p>
<p>典型的关系型数据查询语言:<br>SQL</p>
<p>这里还值得一提的一个本地数据库：<br>SQLite</p>
<p>详细的MYSQL和SQLite对比参考:<br><a target="_blank" rel="noopener" href="https://blog.csdn.net/zbw1185/article/details/47975965">SQLite和MySQL数据库的区别与应用</a></p>
<h4 id="SQLite"><a href="#SQLite" class="headerlink" title="SQLite"></a>SQLite</h4><p><a href="http://tonytang1990.github.io/2019/05/20/SQLite%E5%AD%A6%E4%B9%A0/">SQLite学习详情参考</a></p>
<h3 id="非关系型数据库"><a href="#非关系型数据库" class="headerlink" title="非关系型数据库"></a>非关系型数据库</h3><p><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/NoSQL">NoSQL是对不同于传统的关系数据库的数据库管理系统的统称。两者存在许多显著的不同点，其中最重要的是NoSQL不使用SQL作为查询语言。其数据存储可以不需要固定的表格模式，也经常会避免使用SQL的JOIN操作，一般有水平可扩展性的特征。</a></p>
<p>看了上面Wiki的介绍，本人其实还是一知半解，等待后续深入学习理解非关系型数据库。</p>
<p>有了关系型数据库为什么还需要非关系型数据库了？<br><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/NoSQL">当代典型的关系数据库在一些数据敏感的应用中表现了糟糕的性能，例如为巨量文档创建索引、高流量网站的网页服务，以及发送流式媒体。关系型数据库的典型实现主要被调整用于执行规模小而读写频繁，或者大批量极少写访问的事务。NoSQL的结构通常提供弱一致性的保证，如最终一致性，或交易仅限于单个的数据项。不过，有些系统，提供完整的ACID保证在某些情况​​下，增加了补充中间件层（例如：CloudTPS）</a></p>
<p>典型的菲关系型数据库:<br>MongoDB，Redis</p>
<h3 id="数据库选择"><a href="#数据库选择" class="headerlink" title="数据库选择"></a>数据库选择</h3><p><a target="_blank" rel="noopener" href="https://gameinstitute.qq.com/community/detail/102605">关系数据库还是NoSQL数据库</a><br><a target="_blank" rel="noopener" href="http://www.cppblog.com/sunicdavy/archive/2015/06/19/210992.html">数据库选择历程</a><br><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1197215">游戏服务器存储系统设计</a><br>本人对数据库的经验还停留在学校学习SQL的时候，也可以理解成使用过一点关系型数据库。<br>这里是想深入理解关系和非关系之间的区别，同时为选择游戏开发时使用的数据库类型做知识储备。以下理解的不对的地方，忘指出。</p>
<p>结合上面两篇文章的学习理解，个人理解关系型数据库(e.g. MySQL)适用于读写不频繁(面向表级别的锁定)，需要强大的查询(SQL)功能。<br>而非关系型数据库(e.g. Redis)适用于频繁读写(性能要求高 – Redis是Ke-Vlaue结构，且面向内存的存储模型(使用RDB和AOF做持久化))，需要高扩展性。</p>
<p>结合网上的学习理解，使用Redis(做内存Cache)+MySQL(做稳定的数据库存储查询)利用各自优势使用在不同模块来实现高性能的服务器存储设计是比较高效合理的。</p>
<p>这里本人出于学习目的，暂定以关系型数据库(<strong>MySQL</strong>)作为服务器数据库存储介质，暂时不考虑Redis。</p>
<p>出于单机游戏数据库存储学习，暂时以关系型数据库(<strong>SQLite</strong>)作为本地数据库存储介质。</p>
<p>后期Redis进阶学习:<br><a target="_blank" rel="noopener" href="https://www.runoob.com/redis/redis-tutorial.html">Redis 教程</a></p>
<h2 id="消息通信"><a href="#消息通信" class="headerlink" title="消息通信"></a>消息通信</h2><p>消息通信是本篇文章的重点，首先让我们理一理实现消息通信前我们需要做些什么？</p>
<ol>
<li>联网方式(选择通信协议，比如: TCP || UPD)</li>
<li>数据格式定义(会影响数据编码和解析，比如: Protobuf)</li>
<li>数据收发(涉及到网络通信监听，比如: Socket编程)</li>
<li>数据解析(涉及到二进制数据写入和读取，一般来说都不会明文传输)</li>
</ol>
<p>一般来说消息通信的流程如下：</p>
<ol>
<li>服务器启动了网络监听(比如通过Socket监听固定端口等待客户端连接)</li>
<li>客户端通过Socket连接服务器端口</li>
<li>指定前后端消息协议(Protobuf)，基于协议封装消息数据</li>
<li>客户端通过封装二进制消息数据通过Socket传递给服务器</li>
<li>服务器接受到二进制数据通过对应方式解析消息后返回客户端消息</li>
<li>客户端做出对应表现</li>
</ol>
<h3 id="联网方式"><a href="#联网方式" class="headerlink" title="联网方式"></a>联网方式</h3><p>了解联网方式之前，我们需要知道一些相关的网络知识。</p>
<p>以前学计算机网络课程时，印象最深的就是网络的OSI七层分类：</p>
<p><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/OSI%E6%A8%A1%E5%9E%8B">OSI模型</a></p>
<p>这里我们主要关注的是以下两层：</p>
<ol>
<li><p>会话层</p>
<p> <a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/OSI%E6%A8%A1%E5%9E%8B">负责在数据传输中设置和维护计算机网络中两台计算机之间的通信连接。</a>这一层是负责网络连接的，比如我们通过Socket启动端口监听</p>
</li>
<li><p>传输层</p>
<p><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/OSI%E6%A8%A1%E5%9E%8B">把传输表头（TH）加至数据以形成数据包。传输表头包含了所使用的协议等发送信息。例如:传输控制协议（TCP）等。</a>这一层负责添加网络协议相关信息，比如根据不同网络协议(TCP or UDP)用不同的方式处理丢包问题</p>
</li>
</ol>
<p>更详细的网络相关知识介绍参考:</p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/24860273">TCP和UDP的区别</a></p>
<p>这里我们只要知道<strong>TCP(Transmission Control Protocol，传输控制协议)<strong>协议是</strong>面向连接的可靠传输协议</strong>，有三次握手过程。而<strong>UDP(User Data Protocol，用户数据报协议)<strong>协议是</strong>无连接不可靠协议</strong>。</p>
<p>传输协议选择？<br>TCP<br>理由：</p>
<ol>
<li>游戏对网络数据准确性要求较高</li>
</ol>
<h3 id="数据格式定义"><a href="#数据格式定义" class="headerlink" title="数据格式定义"></a>数据格式定义</h3><p>这里的数据格式指的是网络消息数据格式定义。</p>
<p>在完成了客户端和服务器基础网络数据传输能力(TPC)后，我们必须定义一个统一的消息定义(即数据格式)和消息处理的方式，这样客户端和服务器端才能正常的解析网络数据。</p>
<p>数据格式需求：</p>
<ol>
<li>知道数据大小</li>
<li>知道数据类型</li>
<li>知道如何序列化和反序列化数据</li>
</ol>
<p>基础的数据格式定义如下:</p>
<ol>
<li>数据长度(short - 2字节) – 用于存储消息数据长度</li>
<li>消息ID(short - 2字节) – 用于区分消息类型</li>
<li>二进制数据(Protobuf) – 用于序列化和反序列化数据</li>
</ol>
<h3 id="数据收发"><a href="#数据收发" class="headerlink" title="数据收发"></a>数据收发</h3><p>有了TCP网络数据传输的能力后，我们还需要网络通信的能力。<br>网路通信方式选择？<br>Socket</p>
<h3 id="数据解析"><a href="#数据解析" class="headerlink" title="数据解析"></a>数据解析</h3><p>数据的解析就是前面提到的数据序列化和反序列化的能力。</p>
<p>数据解析协议选择？<br>Protobuf<br>理由：</p>
<ol>
<li>强大的生态圈，多语言支持，数据前后兼容性，强大序列化反序列化能力等</li>
</ol>
<h2 id="服务器验证"><a href="#服务器验证" class="headerlink" title="服务器验证"></a>服务器验证</h2><p>为什么需要验证？</p>
<p>单机游戏不联网很容易有外挂的一个原因就是本地数据(本地存储或者只存在内存中)很容易被串改且无法验证正确性，比如通过修改内存数据(e.g. 数值挂)，修改游戏运行速度(e.g. 加速挂)</p>
<p>解决这一问题的关键正式服务器验证，把所有的数据都存储在服务器上，所有的数据修改都必须通过服务器校验才能通过，这样一来客户端伪造数据就能被识别出来从而防止部分外挂。</p>
<p>服务器验证的应用场景？</p>
<p>服务器验证有一点很重要的应用就是服务器运行战斗逻辑，确保所有客户端结果一致性。</p>
<p>这一点涉及到前后端同步框架相关的知识，详情参考:</p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/36884005">两种同步模式：状态同步和帧同步</a></p>
<p>这里直接借用博客里的一些定义来加深基础理解：</p>
<p>什么是同步？</p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/36884005">所谓同步，就是要多个客户端表现效果是一致，数据是一致。</a></p>
<p>什么是状态同步？</p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/36884005">状态同步下，客户端更像是一个服务端数据的表现层。</a>以服务器通知为准。</p>
<p>什么是帧同步？</p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/36884005">帧同步下，通信就比较简单了，服务端只转发操作，不做任何逻辑处理。</a></p>
<p><img src="/img/Network/FrameSync.png" alt="FrameSync"></p>
<p>状态同步和帧同步的区别？</p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/36884005">最大的区别就是战斗核心逻辑写在哪，状态同步的战斗逻辑在服务端，帧同步的战斗逻辑在客户端。</a></p>
<p>这里只是简单的引用上面博主的部分说明来加深理解，更深入学习请参考前面给出的博客链接。</p>
<h1 id="服务器从零开发"><a href="#服务器从零开发" class="headerlink" title="服务器从零开发"></a>服务器从零开发</h1><p>前面是对于服务器相关理论知识的一些基础知识的学习实战。接下来为了真正做到开发一个可用的服务器，接下来打算从零开发搭建一个可用的服务器用于个人独立游戏(最重要的目的是从中学习到服务器相关的知识以及用到自己的游戏中来)。</p>
<h2 id="服务器语言选择"><a href="#服务器语言选择" class="headerlink" title="服务器语言选择"></a>服务器语言选择</h2><p>作为一个服务器知识几乎为零的前端小白(用到过的语言为C#,C++,Lua,Python,Java–其中C#和Lua是现在用的最多的)，打算入门服务器开发(主要用于个人游戏开发)，所以在语言选择上主要是希望易上手，性能也还行。在高并发方面要求不高。</p>
<p>对于相对熟悉C#和Lua的博主来说能使用**C#**开发服务器的是比较合适的。</p>
<p>未来的语言学习要针对开发的游戏类型对服务器的性能要求等来分析再做具体选型。</p>
<p>结合网上的资料，了解到:</p>
<p><a target="_blank" rel="noopener" href="https://www.codenong.com/cs106973892/">11种服务器编程语言对比（附游戏服务器框架） 2020.06</a></p>
<h2 id="服务器开源框架"><a href="#服务器开源框架" class="headerlink" title="服务器开源框架"></a>服务器开源框架</h2><p>选择一个好的开源框架作为服务器开发入门来说是必不可少的，这里了解基于C#的服务器框架比较少，有一个ET的服务器框架比较出名，但ET看起来过于庞大，入门起来可能比较难，所以这里暂时没有考虑。</p>
<p>未来的学习方向可能不限语言，不一定是ET也可能是别的语言的服务器框架。</p>
<p>现阶段打算先从0开始打通服务器和客户端的流程，所以打断用C#自己写一套简易版的服务器来熟悉整个服务器开发。</p>
<h2 id="网络通信"><a href="#网络通信" class="headerlink" title="网络通信"></a>网络通信</h2><p>网络通信是指通过网络进行数据传输处理的能力。为了实现网络通信，我们需要借助于TCP( or UDP or **)协议进行数据传输，借助Socket进行端口监听，从而实现网络通信的能力。</p>
<p>联网方式选择？<br>TCP协议 + Socket<br>理由：</p>
<ol>
<li>游戏开发对网络稳定性要求较高，所以选择以TCP作为网络传输协议。</li>
</ol>
<p>数据格式定义选择？<br>Protobuf<br>理由：</p>
<ol>
<li>强大的生态圈，多语言支持，数据前后兼容性，强大序列化反序列化能力等</li>
</ol>
<p>前后端通信模式选择？<br>帧同步<br>理由：</p>
<ol>
<li>现阶段只是为了实现前后端的通信能力，只是希望后端提供消息处理和数据存储的功能，暂时不考虑反外挂，服务器验证等问题，所以选择更适合以后端转发通知的CS模式的帧同步。</li>
</ol>
<h3 id="联网通信实现"><a href="#联网通信实现" class="headerlink" title="联网通信实现"></a>联网通信实现</h3><h4 id="二进制抽象类"><a href="#二进制抽象类" class="headerlink" title="二进制抽象类"></a>二进制抽象类</h4><p>联网通信免不了对二进制数据的写入，所以在实现TPC和Socket网络连接传输消息之前，我们需要实现一个对二进制数据进行读取和写入工具类实现。</p>
<p>以下代码参考至:<br><a target="_blank" rel="noopener" href="https://blog.csdn.net/linshuhe1/article/details/51386559">Unity3D —— Socket通信(C#)</a></p>
<p>ByteBufferWriter.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             ByteBufferWriter.cs</span></span><br><span class="line"><span class="comment"> * Author:                  TONYTANG</span></span><br><span class="line"><span class="comment"> * Create Date:             2019/07/14</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Net</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> ByteBufferWriter.cs</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 二进制写入抽象类</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ByteBufferWriter</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// Note:</span></span><br><span class="line">        <span class="comment">// 注意大小端问题</span></span><br><span class="line">        <span class="comment">// BinaryWriter和BinaryReader都是小端读写</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 内存写入类</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">private</span> MemoryStream mMemoryStream;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 二进制流写入类</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">private</span> BinaryWriter mBinaryWriter;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">ByteBufferWriter</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            mMemoryStream = <span class="keyword">new</span> MemoryStream();</span><br><span class="line">            mBinaryWriter = <span class="keyword">new</span> BinaryWriter(mMemoryStream);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">ByteBufferWriter</span>(<span class="params"><span class="built_in">byte</span>[] data</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(data != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                mMemoryStream = <span class="keyword">new</span> MemoryStream(data);</span><br><span class="line">                mBinaryWriter = <span class="keyword">new</span> BinaryWriter(mMemoryStream);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                mMemoryStream = <span class="keyword">new</span> MemoryStream();</span><br><span class="line">                mBinaryWriter = <span class="keyword">new</span> BinaryWriter(mMemoryStream);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 关闭二进制读取写入</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Close</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            mBinaryWriter.Close();</span><br><span class="line">            mMemoryStream.Close();</span><br><span class="line">            mBinaryWriter = <span class="literal">null</span>;</span><br><span class="line">            mMemoryStream = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 写入一个字节数据</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;v&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">WriteByte</span>(<span class="params"><span class="built_in">byte</span> v</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            mBinaryWriter.Write(v);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ******</span><br><span class="line">        </span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 获取字节数据</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="built_in">byte</span>[] <span class="title">ToBytes</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            mBinaryWriter.Flush();</span><br><span class="line">            <span class="keyword">return</span> mMemoryStream.ToArray();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 写入数据</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Flush</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            mBinaryWriter.Flush();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ByteBufferReader.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             ByteBufferReader.cs</span></span><br><span class="line"><span class="comment"> * Author:                  TONYTANG</span></span><br><span class="line"><span class="comment"> * Create Date:             2019/07/14</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Net</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> ByteBufferReader.cs</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 二进制读取抽象类</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ByteBufferReader</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// Note:</span></span><br><span class="line">        <span class="comment">// 注意大小端问题</span></span><br><span class="line">        <span class="comment">// BinaryWriter和BinaryReader都是小端读写</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 内存写入类</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">private</span> MemoryStream mMemoryStream;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 二进制流读取类</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">private</span> BinaryReader mBinaryReader;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">ByteBufferReader</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            mMemoryStream = <span class="keyword">new</span> MemoryStream();</span><br><span class="line">            mBinaryReader = <span class="keyword">new</span> BinaryReader(mMemoryStream);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">ByteBufferReader</span>(<span class="params"><span class="built_in">byte</span>[] data</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(data != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                mMemoryStream = <span class="keyword">new</span> MemoryStream(data);</span><br><span class="line">                mBinaryReader = <span class="keyword">new</span> BinaryReader(mMemoryStream);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                mMemoryStream = <span class="keyword">new</span> MemoryStream();</span><br><span class="line">                mBinaryReader = <span class="keyword">new</span> BinaryReader(mMemoryStream);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 关闭二进制读取写入</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Close</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            mBinaryReader.Close();</span><br><span class="line">            mMemoryStream.Close();</span><br><span class="line">            mBinaryReader = <span class="literal">null</span>;</span><br><span class="line">            mMemoryStream = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 读取一个字节数据</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="built_in">byte</span> <span class="title">ReadByte</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> mBinaryReader.ReadByte();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ******</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试用例:<br>NetMessage.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Net</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 网络消息抽象类</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">NetMessage</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 消息ID</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">ushort</span> MessageID</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span>;</span><br><span class="line">            <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 消息二进制数据</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">byte</span>[] MessageData</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span>;</span><br><span class="line">            <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 消息长度</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">ushort</span> MessageLength</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span>;</span><br><span class="line">            <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="title">NetMessage</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">NetMessage</span>(<span class="params"><span class="built_in">ushort</span> messageid, <span class="built_in">byte</span>[] messagedata</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            MessageID = messageid;</span><br><span class="line">            MessageData = messagedata;</span><br><span class="line">            MessageLength = (<span class="built_in">ushort</span>)messagedata.Length;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">NetMessage msg = <span class="keyword">new</span> NetMessage(<span class="number">1</span>, Encoding.UTF8.GetBytes(<span class="string">&quot;我是消息内容&quot;</span>));</span><br><span class="line">ByteBufferWriter bbw = <span class="keyword">new</span> ByteBufferWriter();</span><br><span class="line">bbw.WriteShort(msg.MessageLength);</span><br><span class="line">bbw.WriteShort(msg.MessageID);</span><br><span class="line">bbw.WriteBytes(msg.MessageData);</span><br><span class="line"><span class="keyword">var</span> bytesdata = bbw.ToBytes();</span><br><span class="line">bbw.Close();</span><br><span class="line">ByteBufferReader bbb = <span class="keyword">new</span> ByteBufferReader(bytesdata);</span><br><span class="line"><span class="keyword">var</span> msglength = bbb.ReadShort();</span><br><span class="line"><span class="keyword">var</span> msgid = bbb.ReadShort();</span><br><span class="line"><span class="keyword">var</span> msgcontent = bbb.ReadBytes(msglength);</span><br><span class="line">Debug.Log(<span class="string">&quot;msglength = &quot;</span> + msglength);</span><br><span class="line">Debug.Log(<span class="string">&quot;msgid = &quot;</span> + msgid);</span><br><span class="line">Debug.Log(<span class="string">&quot;MessageContent = &quot;</span> + Encoding.UTF8.GetString(msgcontent));</span><br></pre></td></tr></table></figure>

<p>输出:<br><img src="/img/Network/ByteBufferOutput.png" alt="ByteBufferOutput"></p>
<p>注意问题：</p>
<ol>
<li>大小端问题(前后端写入和读取字节的大小端方式必须一致)</li>
</ol>
<p>大小端知识:<br><a target="_blank" rel="noopener" href="http://www.ruanyifeng.com/blog/2016/11/byte-order.html">理解字节序</a><br><a target="_blank" rel="noopener" href="http://blog.zhaojie.me/2010/02/byte-order-and-related-library.html">浅谈字节序（Byte Order）及其相关操作</a></p>
<h4 id="网络通信-1"><a href="#网络通信-1" class="headerlink" title="网络通信"></a>网络通信</h4><p>TCP + Socket<br>流程：</p>
<ol>
<li>启动服务器端套接字监听等待客户端连接</li>
<li>服务器端启动线程监听客户端消息</li>
<li>启动客户端套接字连接服务器套接字端口</li>
<li>客户端启动消息发送线程等待向服务器发送客户端消息</li>
<li>服务器端接受并返回客户端消息</li>
<li>客户端处理服务器端消息</li>
</ol>
<p>NetConnector.cs(网络连接抽象类)</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 网络连接抽象类</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">NetConnector</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> IP地址</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> IpAddress</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 端口号</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> Port</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 网络套接字</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> Socket NetSocket</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 是否连接成功</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">bool</span> IsConnected</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> IP地址</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> IPAddress IP</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> IP以及端口地址</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> IPEndPoint IPEndPoint</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">NetConnector</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        NetSocket = <span class="keyword">new</span> Socket(AddressFamily.InterNetwork, SocketType.Stream, ProtocolType.Tcp);</span><br><span class="line">        IsConnected = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">NetConnector</span>(<span class="params">ProtocolType protocoltype = ProtocolType.Tcp</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        NetSocket = <span class="keyword">new</span> Socket(AddressFamily.InterNetwork, SocketType.Stream, protocoltype);</span><br><span class="line">        IsConnected = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 监听指定ip和端口地址</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;ipaddress&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;port&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ListenTo</span>(<span class="params"><span class="built_in">string</span> ipaddress, <span class="built_in">int</span> port</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        IpAddress = ipaddress;</span><br><span class="line">        Port = port;</span><br><span class="line">        IP = IPAddress.Parse(IpAddress);</span><br><span class="line">        IPEndPoint = <span class="keyword">new</span> IPEndPoint(IP, Port);</span><br><span class="line">        NetSocket.Bind(IPEndPoint);</span><br><span class="line">        NetSocket.Listen((<span class="built_in">int</span>)SocketOptionName.MaxConnections);</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;启动监听&#123;0&#125;成功&quot;</span>, NetSocket.LocalEndPoint.ToString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 连接指定地址</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;ipaddress&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;port&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">ConnectTo</span>(<span class="params"><span class="built_in">string</span> ipaddress, <span class="built_in">int</span> port</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        IpAddress = ipaddress;</span><br><span class="line">        Port = port;</span><br><span class="line">        IP = IPAddress.Parse(IpAddress);</span><br><span class="line">        IPEndPoint = <span class="keyword">new</span> IPEndPoint(IP, Port);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 连接指定地址</span></span><br><span class="line">            NetSocket.Connect(IPEndPoint);</span><br><span class="line">            IsConnected = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span></span><br><span class="line">        &#123;</span><br><span class="line">            IsConnected = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> IsConnected;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 断开连接</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Close</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        IsConnected = <span class="literal">false</span>;</span><br><span class="line">        NetSocket.Shutdown(SocketShutdown.Both);</span><br><span class="line">        NetSocket.Close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>NetServer.cs(网络服务器抽象类)</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 网络服务器抽象类</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">NetServer</span> : <span class="title">SingletonTemplate</span>&lt;<span class="title">NetServer</span>&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 服务器是否启动</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">bool</span> IsServerStart</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 网络连接器</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> NetConnector mNetConnector;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 限定长度的客户端消息接受二进制数组</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">byte</span>[] ClientMsg = <span class="keyword">new</span> <span class="built_in">byte</span>[<span class="number">1024</span> * <span class="number">1024</span>];</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">NetServer</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mNetConnector = <span class="keyword">new</span> NetConnector();</span><br><span class="line">        IsServerStart = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">NetServer</span>(<span class="params">ProtocolType protocoltype = ProtocolType.Tcp</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        mNetConnector = <span class="keyword">new</span> NetConnector(protocoltype);</span><br><span class="line">        IsServerStart = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 启动服务器端口监听</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">StartServer</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(IsServerStart == <span class="literal">false</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 启动服务器端口监听以及等待客户端连接线程</span></span><br><span class="line">            IsServerStart = <span class="literal">true</span>;</span><br><span class="line">            mNetConnector.ListenTo(<span class="string">&quot;192.168.1.3&quot;</span>, <span class="number">8888</span>);</span><br><span class="line">            Thread clientconnectthread = <span class="keyword">new</span> Thread(ClientConnectListener);</span><br><span class="line">            clientconnectthread.Start();                </span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;服务器端已启动!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 发送消息到客户端</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;msg&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SendMessage</span>(<span class="params">NetMessage msg</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//clientsocket.Send(WriteMessage(msg));</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 客户端连接请求监听线程</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ClientConnectListener</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">while</span>(<span class="literal">true</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 检查是否有客户端连接(阻塞的)</span></span><br><span class="line">            Socket clientsocket = mNetConnector.NetSocket.Accept();</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;客户端&#123;0&#125;成功连接&quot;</span>, clientsocket.RemoteEndPoint.ToString());</span><br><span class="line">            <span class="comment">// 想客户端发送连接成功数据(这里的二进制数据可以换成Protobuf序列化的)</span></span><br><span class="line">            NetMessage netmsg = <span class="keyword">new</span> NetMessage(<span class="number">1</span>, Encoding.UTF8.GetBytes(<span class="string">&quot;连接成功!&quot;</span>));</span><br><span class="line">            clientsocket.Send(WriteMessage(netmsg));</span><br><span class="line">            <span class="comment">// 为连接的客户端创建接受消息的线程</span></span><br><span class="line">            Thread resmsgthread = <span class="keyword">new</span> Thread(ReceiveMessage);</span><br><span class="line">            resmsgthread.Start(clientsocket);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 写入网络传输所需数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 1. 数据长度(short - 2字节) -- 用于存储消息数据长度</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 2. 消息ID(short - 2字节) -- 用于区分消息类型</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 3. 二进制数据(Protobuf) -- 用于序列化和反序列化数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;netmsg&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="built_in">byte</span>[] <span class="title">WriteMessage</span>(<span class="params">NetMessage netmsg</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        ByteBufferWriter bbw = <span class="keyword">new</span> ByteBufferWriter();</span><br><span class="line">        bbw.WriteShort(netmsg.MessageLength);</span><br><span class="line">        bbw.WriteShort(netmsg.MessageID);</span><br><span class="line">        bbw.WriteBytes(netmsg.MessageData);</span><br><span class="line">        bbw.Flush();</span><br><span class="line">        <span class="keyword">var</span> bytesdata = bbw.ToBytes();</span><br><span class="line">        bbw.Close();</span><br><span class="line">        <span class="keyword">return</span> bytesdata;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 接受客户端消息</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;clientsocket&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ReceiveMessage</span>(<span class="params"><span class="built_in">object</span> clientsocket</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Socket cltsocket = (Socket)clientsocket;</span><br><span class="line">        <span class="keyword">while</span>(<span class="literal">true</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">int</span> receivenumber = cltsocket.Receive(ClientMsg);</span><br><span class="line">                <span class="keyword">if</span>(receivenumber == <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    Console.WriteLine(<span class="string">&quot;客户端 : &#123;0&#125;断开了连接!&quot;</span>, cltsocket.RemoteEndPoint.ToString());</span><br><span class="line">                    cltsocket.Shutdown(SocketShutdown.Both);</span><br><span class="line">                    cltsocket.Close();</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    Console.WriteLine(<span class="built_in">string</span>.Format(<span class="string">&quot;接收客户端&#123;0&#125;消息， 长度为&#123;1&#125;&quot;</span>, cltsocket.RemoteEndPoint.ToString(), receivenumber));</span><br><span class="line">                    ByteBufferReader bbr = <span class="keyword">new</span> ByteBufferReader(ClientMsg);</span><br><span class="line">                    <span class="comment">// 消息数据长度</span></span><br><span class="line">                    <span class="built_in">int</span> msglen = bbr.ReadShort();</span><br><span class="line">                    <span class="comment">// 消息id</span></span><br><span class="line">                    <span class="built_in">int</span> msgid = bbr.ReadShort();</span><br><span class="line">                    <span class="comment">// 数据二进制内容</span></span><br><span class="line">                    <span class="built_in">byte</span>[] msgdata = bbr.ReadBytes(msglen);</span><br><span class="line">                    <span class="keyword">var</span> msgcontent = Encoding.UTF8.GetString(msgdata);</span><br><span class="line">                    Console.WriteLine(<span class="built_in">string</span>.Format(<span class="string">&quot;消息数据长度 : &#123;0&#125; 消息ID : &#123;1&#125; 消息数据内容：&#123;2&#125;&quot;</span>, msglen, msgid, msgcontent));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (Exception ex)</span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine(ex.Message);</span><br><span class="line">                cltsocket.Shutdown(SocketShutdown.Both);</span><br><span class="line">                cltsocket.Close();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>NetClient.cs(网络客户端抽象)</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> NetClient.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 网络客户端抽象</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">NetClient</span> : <span class="title">SingletonTemplate</span>&lt;<span class="title">NetClient</span>&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 服务器端的二进制数据缓存区</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">byte</span>[] ServerMsg = <span class="keyword">new</span> <span class="built_in">byte</span>[<span class="number">1024</span> * <span class="number">1024</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 客户端网络连接器</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> NetConnector mNetConnector;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 是否已连接服务器</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">bool</span> IsServerConnected</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> mNetConnector.IsConnected;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 消息接受线程</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> Thread mMsgReceiveThread;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">NetClient</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mNetConnector = <span class="keyword">new</span> NetConnector();</span><br><span class="line">        mMsgReceiveThread = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">NetClient</span>(<span class="params">ProtocolType protocoltype = ProtocolType.Tcp</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        mNetConnector = <span class="keyword">new</span> NetConnector(protocoltype);</span><br><span class="line">        mMsgReceiveThread = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 连接服务器</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;ip&quot;&gt;</span>ip地址<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;port&quot;&gt;</span>端口号<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ConnectToServer</span>(<span class="params"><span class="built_in">string</span> ipaddress, <span class="built_in">int</span> port</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(IsServerConnected)</span><br><span class="line">        &#123;</span><br><span class="line">            mNetConnector.Close();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 连接服务器</span></span><br><span class="line">            mNetConnector.ConnectTo(ipaddress, port);</span><br><span class="line">            Debug.Log(<span class="built_in">string</span>.Format(<span class="string">&quot;连接服务器:&#123;0&#125;成功!&quot;</span>, mNetConnector.IPEndPoint.ToString()));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span></span><br><span class="line">        &#123;</span><br><span class="line">            Debug.Log(<span class="built_in">string</span>.Format(<span class="string">&quot;连接服务器:&#123;0&#125;失败!&quot;</span>, mNetConnector.IPEndPoint.ToString()));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (IsServerConnected)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 启动客户端线程去监听接受服务器消息</span></span><br><span class="line">            mMsgReceiveThread = <span class="keyword">new</span> Thread(ReceiveMessage);</span><br><span class="line">            mMsgReceiveThread.Start(mNetConnector.NetSocket);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 断开连接</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Close</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (IsServerConnected)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.Log(<span class="built_in">string</span>.Format(<span class="string">&quot;断开服务器地址 : &#123;0&#125;连接!&quot;</span>, mNetConnector.NetSocket.RemoteEndPoint.ToString()));</span><br><span class="line">            mNetConnector.Close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 发送消息到服务器</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;msg&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SendMessage</span>(<span class="params">NetMessage msg</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (IsServerConnected == <span class="literal">false</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.Log(<span class="string">&quot;服务器未连接成功，无法发送数据!&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                mNetConnector.NetSocket.Send(WriteMessage(msg));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span></span><br><span class="line">            &#123;</span><br><span class="line">                mNetConnector.Close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 写入网络传输所需数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 1. 数据长度(short - 2字节) -- 用于存储消息数据长度</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 2. 消息ID(short - 2字节) -- 用于区分消息类型</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 3. 二进制数据(Protobuf) -- 用于序列化和反序列化数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;netmsg&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="built_in">byte</span>[] <span class="title">WriteMessage</span>(<span class="params">NetMessage netmsg</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        ByteBufferWriter bbw = <span class="keyword">new</span> ByteBufferWriter();</span><br><span class="line">        bbw.WriteShort(netmsg.MessageLength);</span><br><span class="line">        bbw.WriteShort(netmsg.MessageID);</span><br><span class="line">        bbw.WriteBytes(netmsg.MessageData);</span><br><span class="line">        bbw.Flush();</span><br><span class="line">        <span class="keyword">var</span> bytesdata = bbw.ToBytes();</span><br><span class="line">        bbw.Close();</span><br><span class="line">        <span class="keyword">return</span> bytesdata;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 服务器连接消息接受监听线程</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ReceiveMessage</span>(<span class="params"><span class="built_in">object</span> clientsocket</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Socket cltsocket = (Socket)clientsocket;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span>(mNetConnector.IsConnected)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">if</span>(mNetConnector.NetSocket.Available &gt; <span class="number">0</span>)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="built_in">int</span> receivenumber = cltsocket.Receive(ServerMsg);</span><br><span class="line">                        <span class="keyword">if</span> (receivenumber == <span class="number">0</span>)</span><br><span class="line">                        &#123;</span><br><span class="line">                            Debug.Log(<span class="built_in">string</span>.Format(<span class="string">&quot;服务器端 : &#123;0&#125;断开了连接!&quot;</span>, cltsocket.RemoteEndPoint.ToString()));</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">else</span></span><br><span class="line">                        &#123;</span><br><span class="line">                            ByteBufferReader bbr = <span class="keyword">new</span> ByteBufferReader(ServerMsg);</span><br><span class="line">                            <span class="keyword">var</span> msglength = bbr.ReadShort();</span><br><span class="line">                            <span class="keyword">var</span> msgid = bbr.ReadShort();</span><br><span class="line">                            <span class="keyword">var</span> msgdata = bbr.ReadBytes(msglength);</span><br><span class="line">                            <span class="built_in">string</span> msgcontent = Encoding.UTF8.GetString(msgdata);</span><br><span class="line">                            Debug.Log(<span class="built_in">string</span>.Format(<span class="string">&quot;服务器返回数据: 消息ID : &#123;0&#125; 消息长度 : &#123;1&#125; 消息内容 : &#123;2&#125;&quot;</span>, msgid, msglength, msgcontent));</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;                    </span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (Exception ex)</span><br><span class="line">            &#123;</span><br><span class="line">                Debug.Log(ex.Message);</span><br><span class="line">                mNetConnector.NetSocket.Close();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>NetMessage.cs(网络消息格式抽象)</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 网络消息抽象类</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">NetMessage</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 消息ID</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">ushort</span> MessageID</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 消息二进制数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">byte</span>[] MessageData</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 消息长度</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">ushort</span> MessageLength</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">NetMessage</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">NetMessage</span>(<span class="params"><span class="built_in">ushort</span> messageid, <span class="built_in">byte</span>[] messagedata</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        MessageID = messageid;</span><br><span class="line">        MessageData = messagedata;</span><br><span class="line">        MessageLength = (<span class="built_in">ushort</span>)messagedata.Length;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试用例:</p>
<ol>
<li>启动服务器</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NetServer.Singleton.StartServer();</span><br><span class="line">Console.ReadLine();</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>启动客户端</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NetClient.Singleton.ConnectToServer(<span class="string">&quot;192.168.1.3&quot;</span>, <span class="number">8888</span>);</span><br><span class="line">NetClient.Singleton.SendMessage(<span class="keyword">new</span> NetMessage(<span class="number">2</span>, Encoding.UTF8.GetBytes(<span class="string">&quot;测试客户端发送给服务器!&quot;</span>)));</span><br></pre></td></tr></table></figure>

<p>服务器端输出:<br><img src="/img/Network/ServerOutput.png" alt="ServerOutput"></p>
<p>客户端输出:<br><img src="/img/Network/ClientOutput.png" alt="ClientOutput"></p>
<p>可以看到通过Socket编程，我们使用TPC连接成功将消息从客户端发送到服务器以及服务器发送到客户端进行处理。NetMessage的简单封装是为了上层逻辑能区分收到的是什么消息以及消息数据有多少，基于byte[]的存储让我们可以快速的切换数据序列化和反序列化的方式(为后面使用Protobuf打下基础)。</p>
<p>待续……</p>
<h4 id="数据格式解析"><a href="#数据格式解析" class="headerlink" title="数据格式解析"></a>数据格式解析</h4><h4 id="服务器-1"><a href="#服务器-1" class="headerlink" title="服务器"></a>服务器</h4><h2 id="数据库Redis"><a href="#数据库Redis" class="headerlink" title="数据库Redis"></a>数据库Redis</h2><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><h2 id="进阶"><a href="#进阶" class="headerlink" title="进阶"></a>进阶</h2><p>对于网络框架的设计和理论知识进阶学习：<br><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/pThWX8IMtg6zuyjZ0LQajQ">教你从头写游戏服务器框架</a></p>
<h2 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h2><p><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%85%B3%E7%B3%BB%E6%95%B0%E6%8D%AE%E5%BA%93">关系数据库</a><br><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/NoSQL">NoSQL</a><br><a target="_blank" rel="noopener" href="https://gameinstitute.qq.com/community/detail/102605">关系数据库还是NoSQL数据库</a><br><a target="_blank" rel="noopener" href="http://www.cppblog.com/sunicdavy/archive/2015/06/19/210992.html">数据库选择历程</a><br><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Redis">Redis</a><br><a target="_blank" rel="noopener" href="https://www.sqlite.org/whentouse.html">SQLite</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/zbw1185/article/details/47975965">SQLite和MySQL数据库的区别与应用</a><br><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/36884005">两种同步模式：状态同步和帧同步</a><br><a target="_blank" rel="noopener" href="https://www.infoq.cn/article/a-brief-history-of-the-game-server-architecture">游戏服务器架构的演进简史</a><br><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/24860273">TCP和UDP的区别</a><br><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/OSI%E6%A8%A1%E5%9E%8B">OSI模型</a></p>
<h2 id="相关资料"><a href="#相关资料" class="headerlink" title="相关资料"></a>相关资料</h2><p><a target="_blank" rel="noopener" href="https://www.runoob.com/sql/sql-tutorial.html">SQL 教程</a><br><a target="_blank" rel="noopener" href="https://www.w3schools.com/sql/default.asp">SQL Tutorial</a></p>
<h2 id="实战讲解"><a href="#实战讲解" class="headerlink" title="实战讲解"></a>实战讲解</h2><p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/39005219">我们来用Unity做一个局域网游戏（上）</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/linshuhe1/article/details/51386559">Unity3D —— Socket通信(C#)</a><br><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/27c99677be67">Unity网络服务器搭建【中高级】</a><br><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/pThWX8IMtg6zuyjZ0LQajQ">教你从头写游戏服务器框架</a></p>
<p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1t7411E7fR?p=9">unity3d联网游戏：客户端与服务器端的交互</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/hansquirrel/IOShootGameDemo">IOShootGameDemo</a></p>
<h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><p><a target="_blank" rel="noopener" href="https://www.codenong.com/cs106973892/">11种服务器编程语言对比（附游戏服务器框架） 2020.06</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/ketoo/NoahGameFrame">NoahGameFrame</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Network/">Network</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Network/">Network</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2019/05/15/Odin插件/" title="Odin插件" itemprop="url">Odin插件</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Tony Tang" target="_blank" itemprop="author">Tony Tang</a>
		
  <p class="article-time">
    <time datetime="2019-05-15T13:33:57.000Z" itemprop="datePublished"> 发表于 2019-05-15</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>本篇文章是为了记录学习使用Unity第三方插件Odin，通过深入学习Odin，加快平时我们编写编辑器工具的效率。</p>
<h1 id="Odin"><a href="#Odin" class="headerlink" title="Odin"></a>Odin</h1><p>Odin是一款可以帮助我们快速制作友好编辑器界面的工具。</p>
<h2 id="功能特性"><a href="#功能特性" class="headerlink" title="功能特性"></a>功能特性</h2><h3 id="Serialize-Anything"><a href="#Serialize-Anything" class="headerlink" title="Serialize Anything"></a>Serialize Anything</h3><p>那么什么是序列化？<br>熟悉二进制导表工具和Proto协议数据发送解析的话，对序列化不会陌生。<br>从平时我们编写代码的角度来说序列化就是把数据对象存储成二进制(序列化)的过程，然后再通过读取二进制数据能构造出原始对象(反序列化)。</p>
<p>接下来看看Unity官方对序列化的定义：<br><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/script-Serialization.html">Serialization is the automatic process of transforming data structures or object states into a format that Unity can store and reconstruct later.</a>(序列化就是将数据结构或对象状态转换成可供Unity保存和随后重建的自动化处理过程。)</p>
<p>官方的序列化远比我们平常说的数据对象序列化更宏大:</p>
<ol>
<li>文件的保存&#x2F;读取，包括Scene、Asset、AssetBundle，以及自定义的ScriptableObject等。</li>
<li>Inspector窗口</li>
<li>编辑器重加载脚本脚本</li>
<li>Prefab</li>
<li>Instantiation<br>所有这些都是通过Unity序列化和反序列化来完成的。</li>
</ol>
<p>Unity序列化有一套规则，这里就不详细介绍了，详情查看官网:<br><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/script-Serialization.html">Script Serialization</a></p>
<p>众所周知，Unity官方序列化并非所有类型都支持，比如：Dictionary，OOP多态。<br>这些限制让我们在编写代码时受到诸多限制，而我们一般是通过特定的处理方式去支持这些缺失的特性(e.g. 通过两个List去模拟Dictionary的序列化或者通过自定义序列化去支持OOP多态)<br>详情查看:<br><a target="_blank" rel="noopener" href="https://blog.uwa4d.com/archives/2025.html">Unity插件开发基础—浅谈序列化系统</a></p>
<p>所以这里再引出Odin的一大特性：<br>Serialize Anything(所有序列化都支持(e.g. Dictionary，OOP多态问题等))<br>这一大特性就已经是相当的强大了，这也是我们采用Odin能够快速编写更加友好的编辑器界面工具的一大原因。</p>
<p>Note:<br><a target="_blank" rel="noopener" href="http://www.sirenix.net/odininspector/manual/introduction/serialize-anything">Odin’s serialization is currently supported on all platforms, save Universal Windows Platform without IL2CPP..</a></p>
<h4 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h4><p><a href="Odin%E4%BC%9A%E9%BB%98%E8%AE%A4%E7%BB%99%E6%88%91%E4%BB%AC%E6%B2%A1%E6%9C%89%E8%87%AA%E5%AE%9A%E4%B9%89Editor%E6%98%BE%E7%A4%BA%E7%9A%84%E7%B1%BB%E5%9E%8B%E6%B3%A8%E5%85%A5%E9%9D%A2%E6%9D%BF%E6%98%BE%E7%A4%BA%E3%80%82%E4%BD%86%E6%88%91%E4%BB%AC%E4%BE%9D%E7%84%B6%E8%BF%98%E6%98%AF%E9%9C%80%E8%A6%81%E6%98%BE%E7%A4%BA%E7%9A%84%E6%8C%87%E5%AE%9A%E4%BD%BF%E7%94%A8Odin%E5%BA%8F%E5%88%97%E5%8C%96%E3%80%82">While Odin by default injects itself into the inspector for every type that doesn’t already have a custom editor defined, the serialization system is more conservative than that. You always have to explicitly decide to make use of Odin’s serialization system.</a></p>
<ol>
<li>开启Odin代码Inspector</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">SerializeStudy</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Unity自身不支持序列化的Dictionary</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> Dictionary&lt;<span class="built_in">int</span>, <span class="built_in">string</span>&gt; SerializeDictionary = <span class="keyword">new</span> Dictionary&lt;<span class="built_in">int</span>, <span class="built_in">string</span>&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Unity自身支持序列化的List</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> List&lt;<span class="built_in">string</span>&gt; SerializeNormalList = <span class="keyword">new</span> List&lt;<span class="built_in">string</span>&gt;();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/img/Unity/Odin/UnityListSerializationUI.png" alt="UnityListSerializationUI"><br>可以看到默认的Dictionary是不支持序列化的，同时默认的List面板是长上面那样的。</p>
<p>接下来我们通过打开Odin序列化再来对比下区别：<br>Tools -&gt; Odin Inspector -&gt; Preference -&gt; Editor Types -&gt; User Types<br>指定我们自定义的SerializeStudy类使用Odin的序列化:<br><img src="/img/Unity/Odin/TurnOnCustomClassOdinSerialization.png" alt="TurnOnCustomClassOdinSerialization"><br>再次对比查看序列化面板:<br><img src="/img/Unity/Odin/TurnOnOdinSerializationListUI.png" alt="TurnOnOdinSerializationListUI"><br>可以看到List默认的面板显示已经变成了Odin自定义的了，但是Dictionary依然没有被序列化显示出来，因为我们只是指定了SerializeStudy类使用Odin的Inspector，但还未指定SerializeStudy使用Odin的序列化。</p>
<ol start="2">
<li>指定使用Odin序列化<br>要支持Dictionary使用Odin的序列化，我们需要显示指定(继承至SerializedMonoBehaviour or SerializedScriptableObject)使用Odin的序列化:</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">SerializeStudy</span> : <span class="title">SerializedMonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/img/Unity/Odin/OdinSerializationUI.png" alt="OdinSerializationUI"><br>可以看到我们成功的使用Odin序列化了Dictionary且采用Odin自定义的Inspector显示。</p>
<p>这里再展现一个Odin二维数组类型的序列化使用，从这个可以看出Odin的强大之处:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">SerializeStudy</span> : <span class="title">SerializedMonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Unity的自身不支持的二维数组</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">bool</span>[,] TwoDimensionArray = <span class="keyword">new</span> <span class="built_in">bool</span>[<span class="number">5</span>, <span class="number">5</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/img/Unity/Odin/OdinSerializationTwoDimensionArrayUI.png" alt="OdinSerializationTwoDimensionArrayUI"><br>可以看到一句简单的定义在Odin序列化和Odin自定义Inspector的帮助下，帮助我们快速构建和支持了Dictionary和二维数组的序列化，这对于我们构建自己的编辑器可以说是如有神助，而这正式Odin的强大之处。</p>
<p>Note:<br>关于OOP多态序列化问题，本人测试和<a target="_blank" rel="noopener" href="https://blog.uwa4d.com/archives/2025.html">Unity插件开发基础—浅谈序列化系统</a>文章里的测试结果不一致(Unity自带序列化支持多态)，本人使用的是2017.4.3f1，所以这里就不实战Odin的OOP多态功能了。</p>
<h3 id="New-Attributes"><a href="#New-Attributes" class="headerlink" title="New Attributes"></a>New Attributes</h3><p>这里的Attribute指的是C#语言里的那个标签Attribute。<br><a target="_blank" rel="noopener" href="http://www.sirenix.net/odininspector/manual/introduction/design-with-attributes">A core feature of Odin is how easy it makes it to change the appearance of your scripts in the editor - essentially letting you create powerful, complex custom editors at a whim merely by applying a few attributes to your members.</a></p>
<p>在不使用Odin前，我们一般是类通过自定义CustomEditor的形式去自定义Editor UI或者是直接通过继承EditorWindow去编写Editor UI工具，主要是通过EditorGUILayout，GUILayout一系列的类来手动完成布局和排版显示等功能。<br>使用Odin后，我们可以通过Odin提供的Attribute可以快速影响我们自定义脚本的Editor表现，帮助我们快速创建友好的可视化界面。</p>
<h4 id="实战-1"><a href="#实战-1" class="headerlink" title="实战"></a>实战</h4><ol>
<li>PropertyOrder(快速指定面板显示顺序)<br>Unity默认排序是跟Public可序列化成员变量定义的顺序挂钩的：</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">AttributeStudy</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> Second;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> First;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/img/Unity/Odin/UnitySerializationOrderUI.png" alt="UnitySerializationOrderUI"><br>通过Odin的PropertyOrder属性我们可以快速的指定排版顺序</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">AttributeStudy</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">PropertyOrder(2)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> Second;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">PropertyOrder(1)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> First;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/img/Unity/Odin/OdinPropertyOrderUI.png" alt="OdinPropertyOrderUI"><br>2. ValueDropdown属性(显示指定成员变量下拉可选值)</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">AttributeStudy</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">ValueDropdown(<span class="string">&quot;DropDownListString&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> DropDownListStringName;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;<span class="built_in">string</span>&gt; DropDownListString = <span class="keyword">new</span> List&lt;<span class="built_in">string</span>&gt;()&#123;</span><br><span class="line">        <span class="string">&quot;Tony&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Tang&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Huan&quot;</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/img/Unity/Odin/OdinValueDropDownAttributeUI.png" alt="OdinValueDropDownAttributeUI"><br>3. TabGroup属性(指定序列化显示分组)</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">AttributeStudy</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">TabGroup(<span class="string">&quot;Normal List Tab&quot;</span>)</span>]</span><br><span class="line">    [<span class="meta">PropertyOrder(2)</span>]</span><br><span class="line">    <span class="keyword">public</span> List&lt;<span class="built_in">string</span>&gt; NormalListString = <span class="keyword">new</span> List&lt;<span class="built_in">string</span>&gt;()&#123;</span><br><span class="line">        <span class="string">&quot;Tony2&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Tang2&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Huan2&quot;</span>,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">TabGroup(<span class="string">&quot;Drop Down Tab&quot;</span>)</span>]</span><br><span class="line">    [<span class="meta">PropertyOrder(1)</span>]</span><br><span class="line">    [<span class="meta">ValueDropdown(<span class="string">&quot;DropDownListString&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> DropDownListStringName;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;<span class="built_in">string</span>&gt; DropDownListString = <span class="keyword">new</span> List&lt;<span class="built_in">string</span>&gt;()&#123;</span><br><span class="line">        <span class="string">&quot;Tony1&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Tang1&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Huan1&quot;</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/img/Unity/Odin/OdinTabGroupAttributeUI.png" alt="OdinTabGroupAttributeUI"><br>4. MetaAttributes属性(e.g. ValidateInput, Required 验证序列化数据输入)</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">AttributeStudy</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">ValidateInput(<span class="string">&quot;IsGreaterThanZero&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> GreaterThanZero;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="built_in">bool</span> <span class="title">IsGreaterThanZero</span>(<span class="params"><span class="built_in">int</span> <span class="keyword">value</span></span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">value</span> &gt; <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">Required</span>]</span><br><span class="line">    <span class="keyword">public</span> GameObject RequiredValue;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/img/Unity/Odin/OdinValideInputAndRequiredAttributeUI.png" alt="OdinValideInputAndRequiredAttributeUI"><br>这里就不所有都一一举例了，从上面可以看出，借助于Odin的Attribute和序列化以及Ordin自定义的Inspector，可以快速帮助我们管理UI排版以及编写高效准确的UI。<br>更多Attribute详情:<br><a target="_blank" rel="noopener" href="http://www.sirenix.net/odininspector/documentation/sirenix/odininspector/assetlistattribute">Odin Attributes</a><br>Odin官方给的Demo(Assets\Plugins\Sirenix\Demos\Attributes Overview.unitypackage)</p>
<h3 id="Effortless-Integration"><a href="#Effortless-Integration" class="headerlink" title="Effortless Integration"></a>Effortless Integration</h3><p>容易集成这一特性从前面的Serialize Anything和Attribute的简单易用其实已经不言而喻了。</p>
<p>接下来主要学习Odin是如何帮助我们快速创建自定义窗口UI显示的。</p>
<ol>
<li>Odin普通编辑器窗口<br>一般来说我们要自定义窗口UI，我们会继承EditorWindow然后结合EditorGUILayout和GUILayout之类的类来定义窗口UI的显示排版以及逻辑处理。<br>基础的Odin窗口需要继承至OdinEditorWindow：</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CustomClassInfoDisplayOdinEditorWindow</span> : <span class="title">OdinEditorWindow</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CustomClass</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">int</span> Index;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> Name;</span><br><span class="line">        <span class="keyword">public</span> GameObject Go;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">MenuItem(<span class="string">&quot;/TonyTang/Tools/OdinEditorWindow/MyFirstOdinEditorWindow&quot;</span>)</span>]</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">OpenWindow</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> window = GetWindow&lt;CustomClassInfoDisplayOdinEditorWindow&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> List&lt;CustomClass&gt; CustomClassListData = <span class="keyword">new</span> List&lt;CustomClass&gt;();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>​	<img src="/img/Unity/Odin/OdinEditorWindowCustomClassInfoDisplayUI.png" alt="OdinEditorWindowCustomClassInfoDisplayUI"><br>​	可以看到借助于继承OdinEditorWindow,我们不再需要重写OnGUI之后去自己定义GUI排版显示以及数据处理，直接编写public可序列化变量就能达到快速显示UI操作交互界面。</p>
<ol start="2">
<li>Odin带菜单栏的自定义编辑器窗口<ol>
<li>带菜单栏的Odin窗口需要继承至OdinMenuEditorWindow</li>
<li>OdinMenuTree用于创建窗口菜单管理</li>
<li>OdinMenuItem用于创建自定义菜单节点(重写OnDrawMenuItem可自定义菜单节点显示)</li>
<li>自定义类结合Odin Attribute做自定义显示界面</li>
</ol>
</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Sirenix.OdinInspector;</span><br><span class="line"><span class="keyword">using</span> Sirenix.OdinInspector.Editor;</span><br><span class="line"><span class="keyword">using</span> Sirenix.Utilities;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> UnityEditor;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 自定义含菜单的Odin窗口</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CustomOdinMenuEditorWindow</span> : <span class="title">OdinMenuEditorWindow</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 自定义的OdinMenuItem类</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CustomMenuItem</span> : <span class="title">OdinMenuItem</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 自定义OdinMenuItem类的数据抽象类</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CustomMenuItemContentClass</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">public</span> <span class="built_in">int</span> Index;</span><br><span class="line">            <span class="keyword">public</span> <span class="built_in">string</span> Name;</span><br><span class="line">            <span class="keyword">public</span> GameObject Go;</span><br><span class="line">            <span class="keyword">public</span> <span class="built_in">bool</span> CheckOn;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="title">CustomMenuItemContentClass</span>(<span class="params"><span class="built_in">int</span> index, <span class="built_in">string</span> name, GameObject go, <span class="built_in">bool</span> checkon</span>)</span></span><br><span class="line">            &#123;</span><br><span class="line">                Index = index;</span><br><span class="line">                Name = name;</span><br><span class="line">                Go = go;</span><br><span class="line">                CheckOn = checkon;</span><br><span class="line">        &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">CustomMenuItem</span>(<span class="params">OdinMenuTree tree, <span class="built_in">string</span> name, IList <span class="keyword">value</span></span>) : <span class="title">base</span>(<span class="params">tree, name, <span class="keyword">value</span></span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">CustomMenuItem</span>(<span class="params">OdinMenuTree tree, <span class="built_in">string</span> name, <span class="built_in">object</span> <span class="keyword">value</span></span>) : <span class="title">base</span>(<span class="params">tree, name, <span class="keyword">value</span></span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 自定义显示界面的OdinMenuItem类</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CustomDrawMenuItem</span> : <span class="title">OdinMenuItem</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 自定义显示界面OdinMenuItem类的数据抽象类</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CustomDrawMenuItemContentClass</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//利用Odin Attribute排版显示UI</span></span><br><span class="line">            [<span class="meta">FoldoutGroup(<span class="string">&quot;自定义折叠组&quot;</span>)</span>]</span><br><span class="line">            <span class="keyword">public</span> <span class="built_in">int</span> Index;</span><br><span class="line">            [<span class="meta">FoldoutGroup(<span class="string">&quot;自定义折叠组&quot;</span>)</span>]</span><br><span class="line">            <span class="keyword">public</span> <span class="built_in">string</span> Name;</span><br><span class="line">            [<span class="meta">FoldoutGroup(<span class="string">&quot;自定义折叠组&quot;</span>)</span>]</span><br><span class="line">            <span class="keyword">public</span> GameObject Go;</span><br><span class="line">            [<span class="meta">FoldoutGroup(<span class="string">&quot;自定义折叠组&quot;</span>)</span>]</span><br><span class="line">            <span class="keyword">public</span> <span class="built_in">bool</span> CheckOn;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="title">CustomDrawMenuItemContentClass</span>(<span class="params"><span class="built_in">int</span> index, <span class="built_in">string</span> name, GameObject go, <span class="built_in">bool</span> checkon</span>)</span></span><br><span class="line">            &#123;</span><br><span class="line">                Index = index;</span><br><span class="line">                Name = name;</span><br><span class="line">                Go = go;</span><br><span class="line">                CheckOn = checkon;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 自行保存需要显示的数据</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">private</span> CustomDrawMenuItemContentClass mCustomDrawMenuData;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">CustomDrawMenuItem</span>(<span class="params">OdinMenuTree tree, <span class="built_in">string</span> name, CustomDrawMenuItemContentClass data</span>) : <span class="title">base</span>(<span class="params">tree, name, data</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            mCustomDrawMenuData = data;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">CustomDrawMenuItem</span>(<span class="params">OdinMenuTree tree, <span class="built_in">string</span> name, IList <span class="keyword">value</span></span>) : <span class="title">base</span>(<span class="params">tree, name, <span class="keyword">value</span></span>)</span></span><br><span class="line">        &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">CustomDrawMenuItem</span>(<span class="params">OdinMenuTree tree, <span class="built_in">string</span> name, <span class="built_in">object</span> <span class="keyword">value</span></span>) : <span class="title">base</span>(<span class="params">tree, name, <span class="keyword">value</span></span>)</span></span><br><span class="line">        &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 自定义MenuItem显示</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;rect&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;labelRect&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnDrawMenuItem</span>(<span class="params">Rect rect, Rect labelRect</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            labelRect.x -= <span class="number">16</span>;</span><br><span class="line">            <span class="keyword">this</span>.mCustomDrawMenuData.CheckOn = GUI.Toggle(labelRect.AlignMiddle(<span class="number">18</span>).AlignLeft(<span class="number">16</span>), <span class="keyword">this</span>.mCustomDrawMenuData.CheckOn, GUIContent.none);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">MenuItem(<span class="string">&quot;TonyTang/Tools/OdinMenuEditorWindow/CustomOdinMenuEditorWindow&quot;</span>)</span>]</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">OpenWindow</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> window = GetWindow&lt;CustomOdinMenuEditorWindow&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> OdinMenuTree <span class="title">BuildMenuTree</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> menutree = <span class="keyword">new</span> OdinMenuTree(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> custommenustyle = <span class="keyword">new</span> OdinMenuStyle</span><br><span class="line">        &#123;</span><br><span class="line">            BorderPadding = <span class="number">0f</span>,</span><br><span class="line">            AlignTriangleLeft = <span class="literal">true</span>,</span><br><span class="line">            TriangleSize = <span class="number">16f</span>,</span><br><span class="line">            TrianglePadding = <span class="number">0f</span>,</span><br><span class="line">            Offset = <span class="number">20f</span>,</span><br><span class="line">            Height = <span class="number">23</span>,</span><br><span class="line">            IconPadding = <span class="number">0f</span>,</span><br><span class="line">            BorderAlpha = <span class="number">0.323f</span></span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        menutree.DefaultMenuStyle = custommenustyle;</span><br><span class="line">        <span class="comment">//添加菜单风格控制显示菜单</span></span><br><span class="line">        menutree.AddObjectAtPath(<span class="string">&quot;菜单风格&quot;</span>, custommenustyle);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//添加MenuItem节点</span></span><br><span class="line">        <span class="keyword">var</span> custommenuitemdata = <span class="keyword">new</span> CustomMenuItem.CustomMenuItemContentClass(<span class="number">1</span>, <span class="string">&quot;CustomMenuItemContentClass&quot;</span>, <span class="literal">null</span>, <span class="literal">false</span>);</span><br><span class="line">        <span class="keyword">var</span> custommenuitemobj = <span class="keyword">new</span> CustomMenuItem(menutree, <span class="string">&quot;默认菜单子子节点名&quot;</span>, custommenuitemdata);</span><br><span class="line">        menutree.AddMenuItemAtPath(<span class="string">&quot;菜单子节点1&quot;</span>, custommenuitemobj);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> customdrawmenuitemdata = <span class="keyword">new</span> CustomDrawMenuItem.CustomDrawMenuItemContentClass(<span class="number">1</span>, <span class="string">&quot;CustomDrawMenuItemContentClass&quot;</span>, <span class="literal">null</span>, <span class="literal">false</span>);</span><br><span class="line">        <span class="keyword">var</span> customdrawmenuitemobj = <span class="keyword">new</span> CustomDrawMenuItem(menutree, <span class="string">&quot;自定义菜单子子节点名&quot;</span>, customdrawmenuitemdata);</span><br><span class="line">        menutree.AddMenuItemAtPath(<span class="string">&quot;菜单子节点2&quot;</span>, customdrawmenuitemobj);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        menutree.EnumerateTree().AddThumbnailIcons().SortMenuItemsByName();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> menutree;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/img/Unity/Odin/OdinCustomMenuStyleUI.png" alt="OdinCustomMenuStyleUI"><br>可以看到借助于Odin我们很轻松的创建定义了复杂的编辑器窗口UI显示，不再需要手动通过EditorGUILayout去编写排版，开发效率大大提升，编写出来的UI也更加美观。</p>
<p>这里就不再一一学习使用Odin相关特性，详情查询:<br><a target="_blank" rel="noopener" href="http://www.sirenix.net/odininspector/documentation/sirenix/odininspector/editor/odinmenueditorwindow">Code Reference</a><br>Odin官方给的Demo(Assets\Plugins\Sirenix\Demos\Editor Windows.unitypackage)</p>
<h3 id="Extendable"><a href="#Extendable" class="headerlink" title="Extendable"></a>Extendable</h3><p>在了解Odin的高度扩展性之前，我们需要了解Odin的Drawer机制。</p>
<p><a target="_blank" rel="noopener" href="http://sirenix.net/odininspector/manual/drawers-in-depth/understanding-drawers">The single most important part of understanding how Odin’s drawing system works, is understanding the <em>drawing chain</em>. In Odin, any single property is not drawn by a single drawer; instead each property has many drawers assigned to it. </a></p>
<p>从上面可以看到，理解Odin drawing system工作机制，我们需要了解Odin的drawing chain(绘制链)。在Odin里每一个显示在面板的Property(这里的Property不等价于C#里的Property)都不是单一一个drawer绘制出来的而是许多个drawers的连续绘制的结果。</p>
<p>首先Odin提供我们了一个叫ShowDrawerChain的Attibute属性，可视化的显示二楼每一个Property的绘制Drawer组合(<strong>每一个Drawer有一个优先级，优先级高的在前面</strong>)。</p>
<p><img src="/img/Unity/Odin/OdinShowDrawerChainAttribute.png" alt="OdinShowDrawerChainAttribute"></p>
<p>从上图可以看出，我们定义一个int的可序列化字段，通过Odin绘制出来需要三个Drawer:</p>
<ol>
<li>PropertyContextMenuDrawer<int> (并不做任何的绘制，只做了右键Content Menu显示的检查)</li>
<li>PrimitiveValueConflictDrawer<int> (检查值冲突(比如多选时有不一样的值类型))</li>
<li>Int32Drawer(最终负责绘制int值面板显示的Drawer)</li>
</ol>
<p>理解了Odin绘制Property是通过连续的多个Drawer组合的形式后，让我们来学习了解Odin里不同种类的Drawer是如何组成Odin的Drawer绘制机制的。</p>
<ol>
<li>Value Drawers(继承至OdinValueDrawer，优先级(0, 0, 1)，类型默认的Drawer)</li>
<li>Attribute Drawers(继承至OdinAttributeDrawer，优先级(0, 0, 1000)，Attibute绘制)</li>
<li>Attribute Value Drawers(Value Drawers和Atrribute Drawers两者的结合)</li>
<li>Group Drawers(继承至PropertyGroupAttribute，不同于前面三个Drawers，Group Drawers是负责一组Property的指定绘制方式)</li>
<li>Gemeric Drawers(泛型 – 解决显示指定Drawers类型信息的问题)</li>
</ol>
<p>这里不过多的去纠结Odin底层源代码设计和实现，只是通过了解Odin的绘制设计方式来加深对Odin使用的理解，便于应用到实际工程里去解决具体问题。</p>
<p>更多学习请参考Odin里的Demo和官方文档。</p>
<p>Note:</p>
<p><a target="_blank" rel="noopener" href="http://sirenix.net/odininspector/manual/drawers-in-depth/drawer-types">Note that all drawers in Odin are <em>always</em> strongly typed, and <em>do not allow</em> type polymorphism.</a>(Odin里的Drawer是强类型，不支持多态)</p>
<h2 id="官方使用建议"><a href="#官方使用建议" class="headerlink" title="官方使用建议"></a>官方使用建议</h2><p><a target="_blank" rel="noopener" href="http://www.sirenix.net/odininspector/manual/introduction/getting-started">Getting Started</a></p>
<h1 id="实战-2"><a href="#实战-2" class="headerlink" title="实战"></a>实战</h1><h2 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h2><ol>
<li>编写一个基于Odin的游戏模块的文档说明编辑器工具(Odin)</li>
<li>自动根据编译信息反射生成最新类型和字段信息(反射判定)</li>
<li>提供字段可编写自定义介绍的内容并存储共享(ScriptableObject存储共享)</li>
<li>提供类型，枚举搜索查看功能</li>
</ol>
<p>先上最终效果图(这里只挑个别展示，主要是学习编写过程中Odin的小知识和小技巧):</p>
<ol>
<li>模块文档整体界面<br><img src="/img/Unity/Odin/ModuleDocIntroductionUI.png" alt="ModuleDocIntroductionUI"></li>
<li>基础类型说明<br><img src="/img/Unity/Odin/ModuleDocBasicTypeIntroductionUI.png" alt="ModuleDocBasicTypeIntroductionUI"></li>
<li>Effect详情<br><img src="/img/Unity/Odin/ModuleDocEffectTypeDetailUI.png" alt="ModuleDocEffectTypeDetailUI"></li>
</ol>
<h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><p>接下来主要从三个方面来学习讲解上面文档工具通过Odin编写所需要注意的技巧和实现。</p>
<ol>
<li>Odin自定义编辑器菜单实现</li>
<li>Odin自定义类型+Odin自定义编辑器布局显示实现</li>
<li>自定义编辑器数据序列化存储</li>
</ol>
<h3 id="自定义编辑器菜单"><a href="#自定义编辑器菜单" class="headerlink" title="自定义编辑器菜单"></a>自定义编辑器菜单</h3><p>自定义菜单主要是通过继承Odin的OdinMenuEditorWindow类然后结合自定义OdinMenuTree + 自定义OdinMenuStyle来实现自定义的菜单布局加风格显示。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             GameModuleDocumentEditorWindow.cs</span></span><br><span class="line"><span class="comment"> * Author:                  TANGHUAN</span></span><br><span class="line"><span class="comment"> * Create Date:             2019/06/04</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> Sirenix.OdinInspector;</span><br><span class="line"><span class="keyword">using</span> Sirenix.OdinInspector.Editor;</span><br><span class="line"><span class="keyword">using</span> Sirenix.Utilities.Editor;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEditor;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 游戏模块文档编辑器窗口</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">GameModuleDocumentEditorWindow</span> : <span class="title">OdinMenuEditorWindow</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> OdinMenuStyle MenuStyle  = <span class="keyword">new</span> OdinMenuStyle</span><br><span class="line">    &#123;</span><br><span class="line">        BorderPadding = <span class="number">0f</span>,</span><br><span class="line">        AlignTriangleLeft = <span class="literal">true</span>,</span><br><span class="line">        TriangleSize = <span class="number">16f</span>,</span><br><span class="line">        TrianglePadding = <span class="number">0f</span>,</span><br><span class="line">        Offset = <span class="number">20f</span>,</span><br><span class="line">        Height = <span class="number">30</span>,</span><br><span class="line">        IconPadding = <span class="number">0f</span>,</span><br><span class="line">        BorderAlpha = <span class="number">0.323f</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    *******</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> OdinMenuTree <span class="title">BuildMenuTree</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        DocDataUtility.CheckAndCreateFolder(DocDataUtility.DocumentDataSaveFolderPath);</span><br><span class="line">        LoadAllData();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> menutree = <span class="keyword">new</span> OdinMenuTree(<span class="literal">true</span>);</span><br><span class="line">        menutree.DefaultMenuStyle = MenuStyle;</span><br><span class="line"></span><br><span class="line">        menutree.AddObjectAtPath(<span class="string">&quot;游戏模块文档&quot;</span>, IntroductionEditorWindowData);</span><br><span class="line">        menutree.AddObjectAtPath(<span class="string">&quot;游戏模块文档/模块菜单&quot;</span>, <span class="literal">null</span>);</span><br><span class="line">        menutree.AddObjectAtPath(<span class="string">&quot;游戏模块文档/模块菜单/基础类型说明&quot;</span>, DataTypeIntroEditorWindowData);</span><br><span class="line">        menutree.AddObjectAtPath(<span class="string">&quot;游戏模块文档/模块菜单/Effect模块&quot;</span>, EffectModuleIntroEditorWindowData);</span><br><span class="line">        <span class="comment">//menutree.AddObjectAtPath(&quot;游戏模块文档/模块菜单/Effect模块/Effect基础配置介绍&quot;, EffectModuleBasicConfigEditorWindowData);</span></span><br><span class="line">        menutree.AddObjectAtPath(<span class="string">&quot;游戏模块文档/模块菜单/Effect模块/Effect&quot;</span>, EffectIntroEditorWindowData);</span><br><span class="line">        menutree.AddObjectAtPath(<span class="string">&quot;游戏模块文档/模块菜单/Effect模块/Effect/Effect预览&quot;</span>, EffectPreviewEditorWindowData);</span><br><span class="line">        menutree.AddObjectAtPath(<span class="string">&quot;游戏模块文档/模块菜单/Effect模块/Effect/Effect查询&quot;</span>, EffectQueryEditorWindowData);</span><br><span class="line">        menutree.AddObjectAtPath(<span class="string">&quot;游戏模块文档/模块菜单/Effect模块/Effect/Effect详情&quot;</span>, EffectDetailEditorWindowData);</span><br><span class="line">        menutree.AddObjectAtPath(<span class="string">&quot;游戏模块文档/模块菜单/Effect模块/EffectView&quot;</span>, EffectViewIntroEditorWindowData);</span><br><span class="line">        menutree.AddObjectAtPath(<span class="string">&quot;游戏模块文档/模块菜单/Effect模块/EffectView/EffectView预览&quot;</span>, EffectViewPreviewEditorWindowData);</span><br><span class="line">        menutree.AddObjectAtPath(<span class="string">&quot;游戏模块文档/模块菜单/Effect模块/EffectView/EffectView查询&quot;</span>, EffectViewQueryEditorWindowData);</span><br><span class="line">        menutree.AddObjectAtPath(<span class="string">&quot;游戏模块文档/模块菜单/Effect模块/EffectView/EffectView详情&quot;</span>, EffectViewDetailEditorWindowData);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> menutree;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">MenuItem(<span class="string">&quot;TonyTang/Tools/GameModuleDocument/GameModuleDocumentMenuEditorWindow&quot;</span>)</span>]</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">OpenWindow</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> window = GetWindow&lt;GameModuleDocumentEditorWindow&gt;();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>代码已经很清晰了，这里就不详细说明了。<br>通过继承OdinMenuEditorWindow重写BuildMenuTree()方法，使用OdinMenuTree自定义菜单栏，配合自定义OdinMenuStyle决定惨淡显示风格。</p>
<h3 id="自定义编辑器布局"><a href="#自定义编辑器布局" class="headerlink" title="自定义编辑器布局"></a>自定义编辑器布局</h3><p>自定义编辑器布局主要是通过使用Odin的OdinEditorWindow + Odin自定义序列化类型显示 + Odin序列化标签来实现的。</p>
<p>Effect详细信息自定义窗口部分代码(工作原因，不方便放出全部代码，这里只用作学习记录分享Odin的使用):</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             EffectDetailEditorWindow.cs</span></span><br><span class="line"><span class="comment"> * Author:                  TONYTANG</span></span><br><span class="line"><span class="comment"> * Create Date:             2019/06/04</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> Sirenix.OdinInspector;</span><br><span class="line"><span class="keyword">using</span> Sirenix.OdinInspector.Editor;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Reflection;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> EffectDetailEditorWindow.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Effect详情窗口</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">TypeInfoBox(<span class="string">&quot;子类不会显示父类字段信息!要查询父类字段信息直接查询父类类型!&quot;</span>)</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">EffectDetailEditorWindow</span> : <span class="title">OdinEditorWindow</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">EffectDetailData</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> Effect参数说明数据</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">EffectDetailParamDesData</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">            <span class="comment"><span class="doctag">///</span> 参数类型信息</span></span><br><span class="line">            <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">            [<span class="meta">LabelText(<span class="string">&quot;&quot;</span>)</span>]</span><br><span class="line">            [<span class="meta">VerticalGroup(<span class="string">&quot;参数类型&quot;</span>)</span>]</span><br><span class="line">            [<span class="meta">TableColumnWidth(150, Resizable = false)</span>]</span><br><span class="line">            [<span class="meta">ReadOnly</span>]</span><br><span class="line">            <span class="keyword">public</span> <span class="built_in">string</span> ParamType;</span><br><span class="line"></span><br><span class="line">            <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">            <span class="comment"><span class="doctag">///</span> 参数名</span></span><br><span class="line">            <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">            [<span class="meta">LabelText(<span class="string">&quot;&quot;</span>)</span>]</span><br><span class="line">            [<span class="meta">VerticalGroup(<span class="string">&quot;参数名&quot;</span>)</span>]</span><br><span class="line">            [<span class="meta">TableColumnWidth(150, Resizable = false)</span>]</span><br><span class="line">            [<span class="meta">ReadOnly</span>]</span><br><span class="line">            <span class="keyword">public</span> <span class="built_in">string</span> ParamName = <span class="string">&quot;参数名&quot;</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">            <span class="comment"><span class="doctag">///</span> 参数介绍</span></span><br><span class="line">            <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span>            </span></span><br><span class="line">            [<span class="meta">LabelText(<span class="string">&quot;&quot;</span>)</span>]</span><br><span class="line">            [<span class="meta">VerticalGroup(<span class="string">&quot;参数介绍&quot;</span>)</span>]</span><br><span class="line">            [<span class="meta">TextArea</span>]</span><br><span class="line">            <span class="keyword">public</span> <span class="built_in">string</span> ParamIntro;</span><br><span class="line"></span><br><span class="line">            <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">            <span class="comment"><span class="doctag">///</span> 参数额外信息</span></span><br><span class="line">            <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">            [<span class="meta">LabelText(<span class="string">&quot;&quot;</span>)</span>]</span><br><span class="line">            [<span class="meta">VerticalGroup(<span class="string">&quot;参数额外信息&quot;</span>)</span>]</span><br><span class="line">            [<span class="meta">TextArea(3, 6)</span>]</span><br><span class="line">            <span class="keyword">public</span> <span class="built_in">string</span> ParamExtraInfo;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> Effect名</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        [<span class="meta">LabelText(<span class="string">&quot;Effect名&quot;</span>)</span>]</span><br><span class="line">        [<span class="meta">VerticalGroup(<span class="string">&quot;基础信息&quot;</span>)</span>]</span><br><span class="line">        [<span class="meta">TableColumnWidth(220, Resizable = false)</span>]</span><br><span class="line">        [<span class="meta">ReadOnly</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> EffectName;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> Effect父类名字</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        [<span class="meta">LabelText(<span class="string">&quot;父Effect名&quot;</span>)</span>]</span><br><span class="line">        [<span class="meta">VerticalGroup(<span class="string">&quot;基础信息&quot;</span>)</span>]</span><br><span class="line">        [<span class="meta">TableColumnWidth(220, Resizable = false)</span>]</span><br><span class="line">        [<span class="meta">ReadOnly</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> ParentTypeName;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> Effect参数说明数据</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        [<span class="meta">LabelText(<span class="string">&quot;&quot;</span>)</span>]</span><br><span class="line">        [<span class="meta">VerticalGroup(<span class="string">&quot;参数详细信息&quot;</span>)</span>]</span><br><span class="line">        [<span class="meta">TableList(DrawScrollView = false, IsReadOnly = true)</span>]</span><br><span class="line">        <span class="keyword">public</span> List&lt;EffectDetailParamDesData&gt; EffectParamDesDetailList = <span class="keyword">new</span> List&lt;EffectDetailParamDesData&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Effect详细数据列表</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">LabelText(<span class="string">&quot;Effect详细数据&quot;</span>)</span>]</span><br><span class="line">    [<span class="meta">TabGroup(<span class="string">&quot;Effect参数详情&quot;</span>)</span>]</span><br><span class="line">    [<span class="meta">TableList(DrawScrollView = true, MaxScrollViewHeight = 800, MinScrollViewHeight = 800, IsReadOnly = true)</span>]</span><br><span class="line">    <span class="keyword">public</span> List&lt;EffectDetailData&gt; EffectDetailDataList = <span class="keyword">new</span> List&lt;EffectDetailData&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 枚举说明数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">EffectEnumData</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 参数类型信息</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        [<span class="meta">LabelText(<span class="string">&quot;&quot;</span>)</span>]</span><br><span class="line">        [<span class="meta">VerticalGroup(<span class="string">&quot;枚举类型全名&quot;</span>)</span>]</span><br><span class="line">        [<span class="meta">HideInInspector</span>]</span><br><span class="line">        [<span class="meta">ReadOnly</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> QualifiedEnumType;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 参数类型信息</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        [<span class="meta">LabelText(<span class="string">&quot;&quot;</span>)</span>]</span><br><span class="line">        [<span class="meta">VerticalGroup(<span class="string">&quot;枚举名&quot;</span>)</span>]</span><br><span class="line">        [<span class="meta">ReadOnly</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> EnumType;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 枚举可选值</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        [<span class="meta">LabelText(<span class="string">&quot;&quot;</span>)</span>]</span><br><span class="line">        [<span class="meta">VerticalGroup(<span class="string">&quot;枚举可选值&quot;</span>)</span>]</span><br><span class="line">        [<span class="meta">ListDrawerSettings(HideAddButton = true, HideRemoveButton = true)</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>[] EnumValues;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 枚举值说明</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        [<span class="meta">LabelText(<span class="string">&quot;&quot;</span>)</span>]</span><br><span class="line">        [<span class="meta">VerticalGroup(<span class="string">&quot;枚举值说明&quot;</span>)</span>]</span><br><span class="line">        [<span class="meta">TextArea</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> EnumValueDecs;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 枚举详细数据列表</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">LabelText(<span class="string">&quot;枚举详细数据&quot;</span>)</span>]</span><br><span class="line">    [<span class="meta">TabGroup(<span class="string">&quot;枚举详情&quot;</span>)</span>]</span><br><span class="line">    [<span class="meta">TableList(DrawScrollView = true, MaxScrollViewHeight = 800, MinScrollViewHeight = 500, IsReadOnly = true)</span>]</span><br><span class="line">    <span class="keyword">public</span> List&lt;EffectEnumData&gt; EffectEnumDataList = <span class="keyword">new</span> List&lt;EffectEnumData&gt;();</span><br><span class="line"></span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>OdinEditorWindow实现了基于Odin的自定义编辑器入口。</li>
</ul>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">EffectDetailEditorWindow</span> : <span class="title">OdinEditorWindow</span></span><br></pre></td></tr></table></figure>
<ul>
<li>结合自定义类型 + Public类型成员定义决定自定义编辑器显示内容。</li>
</ul>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">EffectDetailData</span></span><br><span class="line">&#123;</span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> List&lt;EffectDetailData&gt; EffectDetailDataList = <span class="keyword">new</span> List&lt;EffectDetailData&gt;();</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">EffectEnumData</span></span><br><span class="line">&#123;</span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> List&lt;EffectEnumData&gt; EffectEnumDataList = <span class="keyword">new</span> List&lt;EffectEnumData&gt;();</span><br></pre></td></tr></table></figure>
<ul>
<li>自定义类型需要序列化显示的参数结合Odin序列化标签实现指定方式显示字段。</li>
</ul>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">LabelText(<span class="string">&quot;枚举详细数据&quot;</span>)</span>]</span><br><span class="line">[<span class="meta">VerticalGroup(<span class="string">&quot;枚举类型全名&quot;</span>)</span>]</span><br><span class="line">[<span class="meta">HideInInspector</span>]</span><br><span class="line">[<span class="meta">ReadOnly</span>]</span><br><span class="line">[<span class="meta">TableColumnWidth(220, Resizable = false)</span>]</span><br><span class="line">[<span class="meta">TabGroup(<span class="string">&quot;枚举详情&quot;</span>)</span>]</span><br><span class="line">[<span class="meta">TableList(DrawScrollView = true, MaxScrollViewHeight = 800, MinScrollViewHeight = 500, IsReadOnly = true)</span>]</span><br></pre></td></tr></table></figure>
<pre><code>LabelText -- 表示显示标题
VerticalGroup -- 表示显示分组
HideInInspector -- 表示不显示在编辑器上
ReadOnly -- 表示字段只读不可编辑
TableColumnWidth -- 表示字段单列显示宽度
TabGroup -- 表示标签页分组
TableList -- 表示按表格列表形式显示(DrawScrollView = true, MaxScrollViewHeight = 800, MinScrollViewHeight = 500, IsReadOnly = true -- 是TableList里的细节显示控制)
更多标签详情查看官网:
[OdinDocumentation](https://odininspector.com/documentation)
</code></pre>
<h3 id="数据序列化存储"><a href="#数据序列化存储" class="headerlink" title="数据序列化存储"></a>数据序列化存储</h3><p>数据序列化存储主要是采用Odin + Unity ScriptableObject<br>Odin的OdinEditorWindow是继承至EditorWindow，而EditorWindow是继承至ScriptableObject，所以我们直接按序列化ScriptableObject的方式序列化OdinEditorWindow即可。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 加载指定文档数据</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;typeparam name=&quot;T&quot;&gt;</span><span class="doctag">&lt;/typeparam&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;datafullpath&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> T <span class="title">LoadDocumentData</span>&lt;<span class="title">T</span>&gt;(<span class="params"><span class="built_in">string</span> datafullpath</span>) <span class="keyword">where</span> T : ScriptableObject</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span>(File.Exists(datafullpath))</span><br><span class="line">    &#123;</span><br><span class="line">        Debug.Log(<span class="built_in">string</span>.Format(<span class="string">&quot;&#123;0&#125;数据加载成功!&quot;</span>, datafullpath));</span><br><span class="line">        <span class="keyword">return</span> AssetDatabase.LoadAssetAtPath&lt;T&gt;(datafullpath);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        Debug.Log(<span class="built_in">string</span>.Format(<span class="string">&quot;&#123;0&#125;数据不存在!&quot;</span>, datafullpath));</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 存储指定文档数据</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;typeparam name=&quot;T&quot;&gt;</span><span class="doctag">&lt;/typeparam&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;documentdata&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;datafullpath&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">SaveDocumentData</span>&lt;<span class="title">T</span>&gt;(<span class="params">T documentdata, <span class="built_in">string</span> datafullpath</span>) <span class="keyword">where</span> T : ScriptableObject</span></span><br><span class="line">&#123;</span><br><span class="line">    AssetDatabase.CreateAsset(documentdata, datafullpath);</span><br><span class="line">    AssetDatabase.SaveAssets();</span><br><span class="line">    Debug.Log(<span class="built_in">string</span>.Format(<span class="string">&quot;保存资源：&#123;0&#125;完成!&quot;</span>, documentdata));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a target="_blank" rel="noopener" href="https://assetstore.unity.com/packages/tools/utilities/odin-inspector-and-serializer-89041">Odin Asset Store链接</a><br><a target="_blank" rel="noopener" href="http://sirenix.net/odininspector">Odin官网</a><br><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/script-Serialization.html">Script Serialization</a><br><a target="_blank" rel="noopener" href="https://blog.uwa4d.com/archives/2025.html">Unity插件开发基础—浅谈序列化系统</a><br><a target="_blank" rel="noopener" href="https://odininspector.com/documentation">OdinDocumentation</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Editor/">Editor</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Editor/">Editor</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2019/05/03/热更新/" title="热更新" itemprop="url">热更新</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Tony Tang" target="_blank" itemprop="author">Tony Tang</a>
		
  <p class="article-time">
    <time datetime="2019-05-03T05:30:16.000Z" itemprop="datePublished"> 发表于 2019-05-03</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>本篇文章是为了记录学习游戏开发过程中，版本强更和资源热更相关知识。</p>
<p>关于资源AssetBundle加载模块相关学习参考:<br><a href="http://tonytang1990.github.io/2016/10/13/Unity-Resource-Manager">Unity Resource Manager</a><br><a href="http://tonytang1990.github.io/2018/10/24/AssetBundle%E8%B5%84%E6%BA%90%E6%89%93%E5%8C%85%E5%8A%A0%E8%BD%BD%E7%AE%A1%E7%90%86%E5%AD%A6%E4%B9%A0/">AssetBundle资源打包加载管理</a></p>
<h1 id="热更新"><a href="#热更新" class="headerlink" title="热更新"></a>热更新</h1><p>首先还是让我们从What，Why，How三个点来学习理解热更新。</p>
<h2 id="What"><a href="#What" class="headerlink" title="What"></a>What</h2><p>什么是热更新？<br>从前端的角度来说，我个人理解热更新是指无需通过商店审核上传最新版本就能通过游戏内热更下载最新资源和代码的形式更新最新功能。</p>
<p>从服务器的角度来说，可能是无需关闭服务器，不停机状态下修复漏洞，更新资源等，重点是更新逻辑代码。</p>
<p>本人是前端程序，所以侧重点是前端热更这一块，而非服务器热更新。<br>接下来主要以以下三点来深入学习：</p>
<ol>
<li>版本强更(类似于商店下载最新版本的完整包安装更新)</li>
<li>资源热更(游戏内资源热更新下载替换本地游戏内容)</li>
<li>代码热更(游戏内代码热更新下载替换本地游戏代码内容)</li>
</ol>
<h2 id="Why"><a href="#Why" class="headerlink" title="Why"></a>Why</h2><p>为什么需要热更新？</p>
<ol>
<li>商店审核时间不可控(紧急bug严重修复时会造成阻碍)</li>
<li>手机游戏更新频繁，改善用户更新体验(不必每次都走商店版本强更)</li>
<li>快速修复bug和更新功能</li>
</ol>
<h2 id="How"><a href="#How" class="headerlink" title="How"></a>How</h2><p>接下来会针对前面提到的三点来分别讨论：<br>针对版本强更和资源热更，先来看一下我整理的流程图：<br><img src="/img/Unity/HotUpdate/HotUpdateFlowChat.png" alt="HotUpdateFlowChat"></p>
<h3 id="版本强更"><a href="#版本强更" class="headerlink" title="版本强更"></a>版本强更</h3><p>版本强更主要是游戏内通过服务器获取最新版本号判定当前游戏版本是否需要更新，然后引导用户更新(可以是引导到对应商店下载，也可以是直接游戏内直接下载安装包)最新的包。</p>
<ol>
<li>引导到对应商店下载<br>问题：<br>需要判断出用户当前下载的安装包是从哪个应用商店下载的，然后跳转到对应商店，如果玩家不是从应用商店下载或者说玩家本地没有对应应用商店，那么就会出现无法成功跳转对应应用商店的情况。<br>方案：<br>考虑到Android应用商店繁多，基于上述问题，这里我们采用第二种方案，直接引导游戏内CDN下载最新包的形式强更版本(这里指的Android，IOS官方AppStore只有一个本地肯定有AppStore，直接跳转AppStore即可)</li>
<li>游戏内直接下载(cdn下载)<br>游戏内直接下载可以通过下载对应CDN(不同渠道分不同CDN地址即可划分渠道)上的安装包覆盖安装即可。</li>
</ol>
<h4 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h4><p>Android:<br>通过查询相关资料，了解到Android APK安装在Android N(7)之前主要是通过Itent结合File的形式。<br>Android N(7)之后主要是通过FileProvider组件</p>
<p>CS层热更下载APK代码:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">string</span> testresourceurl = <span class="string">&quot;*/HotUpdate.apk&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> webrequest = UnityWebRequest.Get(testresourceurl);</span><br><span class="line"><span class="keyword">yield</span> <span class="keyword">return</span> webrequest.SendWebRequest();</span><br><span class="line"><span class="keyword">if</span> (webrequest.isNetworkError)</span><br><span class="line">&#123;</span><br><span class="line">    Debug.LogError(<span class="built_in">string</span>.Format(<span class="string">&quot;&#123;0&#125;安装包下载出错!&quot;</span>, testresourceurl));</span><br><span class="line">    Debug.LogError(webrequest.error);</span><br><span class="line">    <span class="keyword">if</span> (webrequest.isHttpError)</span><br><span class="line">    &#123;</span><br><span class="line">        Debug.LogError(<span class="built_in">string</span>.Format(<span class="string">&quot;responseCode : &quot;</span>, webrequest.responseCode));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">    Debug.Log(<span class="built_in">string</span>.Format(<span class="string">&quot;&#123;0&#125; webrequest.isDone:&#123;1&#125;!&quot;</span>, testresourceurl, webrequest.isDone));</span><br><span class="line">    Debug.Log(<span class="built_in">string</span>.Format(<span class="string">&quot;&#123;0&#125;安装包下载完成!&quot;</span>, testresourceurl));</span><br><span class="line">    <span class="keyword">var</span> downloadfilefolderpath = Application.persistentDataPath + <span class="string">&quot;/download/&quot;</span>;</span><br><span class="line">    <span class="keyword">var</span> downloadfilesavepath = downloadfilefolderpath + <span class="string">&quot;app.apk&quot;</span>;</span><br><span class="line">    Debug.Log(<span class="string">&quot;downloadfilefolderpath = &quot;</span> + downloadfilefolderpath);</span><br><span class="line">    Debug.Log(<span class="string">&quot;downloadfilesavepath = &quot;</span> + downloadfilesavepath);</span><br><span class="line">    <span class="keyword">if</span>(!Directory.Exists(downloadfilefolderpath))</span><br><span class="line">    &#123;</span><br><span class="line">        Directory.CreateDirectory(downloadfilefolderpath);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (File.Exists(downloadfilesavepath))</span><br><span class="line">    &#123;</span><br><span class="line">        File.Delete(downloadfilesavepath);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">using</span> (<span class="keyword">var</span> fs = File.Create(downloadfilesavepath))</span><br><span class="line">    &#123;</span><br><span class="line">        fs.Write(webrequest.downloadHandler.data, <span class="number">0</span>, webrequest.downloadHandler.data.Length);</span><br><span class="line">        fs.Flush();</span><br><span class="line">        fs.Close();</span><br><span class="line">        Debug.Log(downloadfilesavepath + <span class="string">&quot;文件写入完成!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>原生APK安装代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Intent</span> <span class="variable">install</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(Intent.ACTION_VIEW);</span><br><span class="line">install.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK);</span><br><span class="line"><span class="type">File</span> <span class="variable">apkFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(mContext.getExternalFilesDir(<span class="literal">null</span>).getPath() + <span class="string">&quot;/download/&quot;</span> + <span class="string">&quot;app.apk&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">Uri</span> <span class="variable">uri</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.N) &#123;</span><br><span class="line">    install.setFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION);</span><br><span class="line">    install.addFlags(Intent.FLAG_GRANT_WRITE_URI_PERMISSION);</span><br><span class="line">    install.addFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION);</span><br><span class="line">    uri = FileProvider.getUriForFile(mContext, mPackagename + <span class="string">&quot;.fileprovider&quot;</span>, apkFile);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    uri = Uri.fromFile(apkFile);</span><br><span class="line">&#125;</span><br><span class="line">install.setDataAndType(uri, <span class="string">&quot;application/vnd.android.package-archive&quot;</span>);</span><br><span class="line">startActivity(install);</span><br></pre></td></tr></table></figure>

<p>AndroidMainifest.xml定义相关FileProvider：<br>res下新建xml目录以及file_paths.xml文件<br><img src="/img/Unity/HotUpdate/AndroidHotUpdateFilePath.png" alt="AndroidHotUpdateFilePath"></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">//强更部分</span><br><span class="line"><span class="tag">&lt;<span class="name">provider</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:name</span>=<span class="string">&quot;android.support.v4.content.FileProvider&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:authorities</span>=<span class="string">&quot;应用包名.fileprovider&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:exported</span>=<span class="string">&quot;false&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:grantUriPermissions</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta-data</span></span></span><br><span class="line"><span class="tag">      <span class="attr">android:name</span>=<span class="string">&quot;android.support.FILE_PROVIDER_PATHS&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">android:resource</span>=<span class="string">&quot;@xml/file_paths&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">provider</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>配置file_paths.xml:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">resources</span>&gt;</span></span><br><span class="line">    //下载安装包目录</span><br><span class="line">    <span class="tag">&lt;<span class="name">paths</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">external-path</span></span></span><br><span class="line"><span class="tag">            <span class="attr">name</span>=<span class="string">&quot;download&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">path</span>=<span class="string">&quot;&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">external-files-path</span></span></span><br><span class="line"><span class="tag">            <span class="attr">name</span>=<span class="string">&quot;download&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">path</span>=<span class="string">&quot;&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">paths</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">resources</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>AndroidManifest.xml权限相关设置:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.WRITE_EXTERNAL_STORAGE&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.READ_EXTERNAL_STORAGE&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.REQUEST_INSTALL_PACKAGES&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p>Android相关路径定义知识:<br>以下内容来源：<br><a target="_blank" rel="noopener" href="http://yifeng.studio/2017/05/03/android-7-0-compat-fileprovider/">关于 Android 7.0 适配中 FileProvider 部分的总结</a><br><files-path>：内部存储空间应用私有目录下的 files&#x2F; 目录，等同于 Context.getFilesDir() 所获取的目录路径；</p>
<p><cache-path>：内部存储空间应用私有目录下的 cache&#x2F; 目录，等同于 Context.getCacheDir() 所获取的目录路径；</p>
<p><external-path>：外部存储空间根目录，等同于 Environment.getExternalStorageDirectory() 所获取的目录路径；</p>
<p><external-files-path>：外部存储空间应用私有目录下的 files&#x2F; 目录，等同于 Context.getExternalFilesDir(null) 所获取的目录路径；</p>
<p><external-cache-path>：外部存储空间应用私有目录下的 cache&#x2F; 目录，等同于 Context.getExternalCacheDir()；</p>
<p>最后让我们来看下运行效果：<br><img src="/img/Unity/HotUpdate/HotUpdateUIInterface.png" alt="运行界面"><br><img src="/img/Unity/HotUpdate/DownloadAPK.png" alt="下载安装包"><br><img src="/img/Unity/HotUpdate/InstallAPK.png" alt="版本强更安装"></p>
<p>注意事项：</p>
<ol>
<li>下载保存APK时需要android.permission.WRITE_EXTERNAL_STORAGE权限</li>
<li>安装APK时需要android.permission.REQUEST_INSTALL_PACKAGES和android.permission.READ_EXTERNAL_STORAGE权限</li>
<li>Android 6.0以后敏感权限需要主动请求</li>
<li><a target="_blank" rel="noopener" href="http://lazybios.com/2016/12/install-apk-by-intent-compatible-adnroid-n/">从Android 7.0开始，系统修改了安全机制: 限定应用在默认情况下只能访问自身应用数据。所以当我们想通过File对象访问其它package数据时，就需要借助于ContentProvider、FileProvider这些组件，否则会报FileUriExposedException异常。</a></li>
<li>Android下载和读取安装APK的目录需要是有可读写权限的外部存储目录(e.g. Application.persistentDataPath || Application.temporaryCachePath)</li>
</ol>
<p>IOS:<br>IOS正版只有AppStore(暂时不考虑越狱渠道)，所以IOS直接打开应用商店跳转即可。<br>IOS跳转AppStore商店的代码就简单很多了：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Application.OpenURL(<span class="string">&quot;itms-apps://itunes.apple.com/app/id&quot;</span> + appID);</span><br></pre></td></tr></table></figure>
<p>Android打开商店的代码和IOS类似:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Application.OpenURL(<span class="string">&quot;market://details?id=&quot;</span> + appID);</span><br></pre></td></tr></table></figure>
<p>Note:<br><a target="_blank" rel="noopener" href="https://blog.csdn.net/hackmind/article/details/78113511">IOS appID可以通过itunes的链接获取到，比如我们的游戏链接为:https://itunes.apple.com/app/id1238589899，1238589899 为IOS的appID</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/hackmind/article/details/78113511">google play 的ID通过商店链接获取到，比如我们的游戏链接为:https://play.google.com/store/apps/details?id=com.oasis.movten.android， com.oasis.movten.android 为 Android的appID</a></p>
<h3 id="资源热更"><a href="#资源热更" class="headerlink" title="资源热更"></a>资源热更</h3><p>资源热更是指在游戏内直接下载最新资源，然后本地游戏通过使用最新下载的资源更新到最新的游戏资源并使用。</p>
<p>资源热更下载老版本Unity提供了WWW接口，但这个接口官方已经不推荐使用了，取而代之的是UnityWebRequest(http访问资源服务器的形式)。</p>
<p>资源下载跟前面提到的版本强更APK下载是一个意思，只不过需要通过比较本地更新的资源数据和服务器上的资源数据对比出需要更新的资源列表。这里不厌其烦的再放一次版本强更和资源热更的流程图加深印象：<br><img src="/img/Unity/HotUpdate/HotUpdateFlowChat.png" alt="HotUpdateFlowChat"><br>代码这里就不贴了，感兴趣的可以直接上Git下载了解：<br><a target="_blank" rel="noopener" href="https://github.com/TonyTang1990/AssetBundleLoadManager">AssetBundleLoadManager</a></p>
<h3 id="热更新辅助工具"><a href="#热更新辅助工具" class="headerlink" title="热更新辅助工具"></a>热更新辅助工具</h3><p>Tools-&gt;HotUpdate-&gt;热更新操作工具</p>
<p><img src="/img/Unity/HotUpdate/HotUpdateToolsUI.png" alt="HotUpdateToolsUI"></p>
<p>主要分为以下4个步骤：</p>
<ol>
<li><p>版本资源文件MD5计算(文件名格式:MD5+版本号+资源版本号+平台+时间戳+.txt)</p>
<p><img src="/img/Unity/HotUpdate/AssetBundleMD5Caculation.png" alt="AssetBundleMD5Caculation"></p>
</li>
<li><p>对比两个版本的MD5文件信息得出需要热更新的AB文件信息</p>
</li>
<li><p>执行热更新AB准备操作自动复制需要热更新的AB到热更新准备目录(然后手动拷贝需要强更或热更的资源到真正的热更新目录)</p>
</li>
<li><p>执行热更新准备操作，生成热更新所需的最新资源热更新信息文件(ResourceUpdateList.txt)和服务器最新版本信息文件(ServerVersionConfig.json)</p>
</li>
</ol>
<h3 id="代码热更"><a href="#代码热更" class="headerlink" title="代码热更"></a>代码热更</h3><p>代码热更和版本强更不一样，版本强更一般来说是通过更新下载完整的包来实现整个游戏功能版本更新，而代码热更是指我们通过技术手段(e.g. XLua, ILRuntime, ToLua ……)，通过热更代码的形式实现热更功能代码。</p>
<p>主流的方式有两种：</p>
<ol>
<li>Lua(Lua方案)<br> Lua是解析执行，有自己的虚拟机，对于代码热更有天然的优势，我们完全可以以资源热更(AssetBundle)的形式热更Lua代码。</li>
<li>ILRuntime(CS方案)<br> 这里不是非常了解ILRuntime底层原理，想了解详情的可以参考官网：<a target="_blank" rel="noopener" href="https://ourpalm.github.io/ILRuntime/public/v1/guide/index.html">ILRuntime项目为基于C#的平台（例如Unity）提供了一个纯C#实现，快速、方便且可靠的IL运行时，使得能够在不支持JIT的硬件环境（如iOS）能够实现代码的热更新</a><br> 但ILRuntime有一点很大的优势就是开发期也是用CS语言，不用写Lua。</li>
</ol>
<p>这里因为项目主要用到了XLua，所以后续都是以XLua作为代码热更来学习。<br>选XLua的原因主要有以下几点：</p>
<ol>
<li>腾讯开源，有大公司支持，稳定</li>
<li>除了支持纯Lua开发，还支持CS通过改写Lua的形式热修复Bug</li>
</ol>
<p>Note:</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://gameinstitute.qq.com/community/detail/119660">苹果禁止了C#的部分反射操作，禁止JIT（即时编译，程序运行时创建并运行新代码），不允许逻辑热更新，只允许使用AssetBundle进行资源热更新。</a></li>
</ol>
<h4 id="XLua"><a href="#XLua" class="headerlink" title="XLua"></a>XLua</h4><p>官网：<br><a target="_blank" rel="noopener" href="https://github.com/Tencent/xLua">XLua</a></p>
<p>待续……</p>
<h3 id="资源服务器"><a href="#资源服务器" class="headerlink" title="资源服务器"></a>资源服务器</h3><p>前面提到的版本强更和资源热更都离不开资源服务器，这里说的资源服务器是指静态资源服务器，接下来通过实战学习了解静态资源服务器相关的概念以及静态资源服务器选择和使用。</p>
<p>静态资源服务器:</p>
<p>我们把资源放到指定静态资源服务器上，静态资源服务器开启Http或者其他的连接服务，允许用户通过对应方式(Http或者其他)去访问拉取服务器资源。(个人理解，如果有误欢迎指出)</p>
<p>静态资源服务器是资源热更的一个前提。</p>
<p>CND:</p>
<p><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%85%A7%E5%AE%B9%E5%82%B3%E9%81%9E%E7%B6%B2%E8%B7%AF"><strong>内容分发网络</strong>（英语：<strong>C</strong>ontent <strong>d</strong>elivery <strong>n</strong>etwork或<strong>C</strong>ontent <strong>d</strong>istribution <strong>n</strong>etwork，<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E7%B8%AE%E5%AF%AB">缩写</a>：<strong>CDN</strong>）是指一种透过<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E4%BA%92%E8%81%AF%E7%B6%B2">互联网</a>互相连接的计算机网络系统，利用最靠近每位用户的服务器，更快、更可靠地将音乐、图片、影片、应用程序及其他文件发送给用户，来提供高性能、可扩展性及低成本的网络内容传递给用户。</a></p>
<p>从上面可以看出CDN是独立于静态资源服务器，网络传输层的一个概念，主要目的是为了加快和提供高性能的资源传输。</p>
<h4 id="实战-1"><a href="#实战-1" class="headerlink" title="实战"></a>实战</h4><p>这里我选择了阿里云的<a href="">OSS</a>作为静态资源服务器。</p>
<p>OSS详情:</p>
<p><a target="_blank" rel="noopener" href="https://help.aliyun.com/document_detail/31883.html?spm=5176.208357.1107607.14.5404390fXITEiK">阿里云对象存储服务（Object Storage Service，简称 OSS）为您提供基于网络的数据存取服务。使用 OSS，您可以通过网络随时存储和调用包括文本、图片、音频和视频等在内的各种非结构化数据文件。</a></p>
<p>OSS静态资源服务器搭建：</p>
<ol>
<li>注册阿里云账号</li>
<li>账号实名认证</li>
<li>开通OSS服务</li>
<li>创建Bucket</li>
<li>上传文件</li>
</ol>
<p><a target="_blank" rel="noopener" href="https://help.aliyun.com/document_detail/31883.html?spm=a2c4g.11174283.3.1.1b5a7da2pQvh8V">OSS详细使用说明</a></p>
<p>待续……</p>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/janeky/article/details/17666409">Unity手游之路手游资源热更新策略探讨</a><br><a target="_blank" rel="noopener" href="http://copyfuture.com/blogs-details/cd4f28bd6dfae0a2ece7cd43a6f90e62">Unity 大版本更新之APK的下载与覆盖安装</a><br><a target="_blank" rel="noopener" href="https://gameinstitute.qq.com/community/detail/119660">Unity3D热更新方案总结</a><br><a target="_blank" rel="noopener" href="http://lazybios.com/2016/12/install-apk-by-intent-compatible-adnroid-n/">使用Intent安装APK方法(兼容Android N)</a><br><a target="_blank" rel="noopener" href="http://yifeng.studio/2017/05/03/android-7-0-compat-fileprovider/">关于 Android 7.0 适配中 FileProvider 部分的总结</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/hackmind/article/details/78113511">Unity app 如何打开商店</a></p>
<h1 id="Git"><a href="#Git" class="headerlink" title="Git"></a>Git</h1><p><a target="_blank" rel="noopener" href="https://github.com/TonyTang1990/AssetBundleLoadManager">AssetBundleLoadManager</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/HotUpdate/">HotUpdate</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/HotUpdate/">HotUpdate</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2019/04/25/优化/" title="优化篇" itemprop="url">优化篇</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Tony Tang" target="_blank" itemprop="author">Tony Tang</a>
		
  <p class="article-time">
    <time datetime="2019-04-25T06:41:00.000Z" itemprop="datePublished"> 发表于 2019-04-25</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>本章节主要目的是学习记录游戏开发中各个模块里的优化知识，深入理解项目设计里的各种底层知识点，避免前期不考虑后期优化成灾的情况。</p>
<p>Note:</p>
<ol>
<li>此处并不是要宣扬优化，项目初期不推崇过度优化毕竟产品做出来才是王道，而是通过深入理解核心知识点在项目初期做出正确的设计来避免没必要的后期优化。</li>
</ol>
<h2 id="UI模块"><a href="#UI模块" class="headerlink" title="UI模块"></a>UI模块</h2><p>深入深度学习Unity UI(UGUI)模块的使用，优化，原理知识等。</p>
<h3 id="UI基础"><a href="#UI基础" class="headerlink" title="UI基础"></a>UI基础</h3><h4 id="UI核心概念"><a href="#UI核心概念" class="headerlink" title="UI核心概念"></a>UI核心概念</h4><p><a target="_blank" rel="noopener" href="https://learn.unity.com/tutorial/optimizing-unity-ui#5c7f8528edbc2a002053b5a0">Canvases are responsible for combining their constituent geometry into batches, generating the appropriate render commands and sending these to Unity’s Graphics system. All of this is done in native C++ code, and is called a rebatch or a batch build.</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.unity.com/tutorial/optimizing-unity-ui#5c7f8528edbc2a002053b5a0">Geometry is provided to Canvases by Canvas Renderer components.</a></p>
<p>从前面可以看出UGUI的绘制是以画布为单位的，子Canvas也就是嵌套的关系，大部分情况子Canvas脏了只会触发子Canvas的网格重建不会触发父Canvas的网格重建。</p>
<p><a target="_blank" rel="noopener" href="https://learn.unity.com/tutorial/optimizing-unity-ui#5c7f8528edbc2a002053b5a0">When composing user interfaces in Unity UI, keep in mind that all geometry drawn by a Canvas will be drawn in the <strong>Transparent queue.</strong></a>(UGUI的Canvas绘制实在Transpanrent Queue里)</p>
<p><a target="_blank" rel="noopener" href="https://learn.unity.com/tutorial/optimizing-unity-ui#5c7f8528edbc2a002053b5a0">A <em>Graphic</em> is a base class provided by the Unity UI C# library. It is the base class for all Unity UI C# classes that provide drawable geometry to the Canvas system. Most built-in Unity UI Graphics are implemented via the <em>MaskableGraphic</em> subclass, which allows them to be masked via the <em>IMaskable</em> interface.</a>(UGUI里Graphic是提供Canvas里可绘制单位的基类，大部分UGUI组件继承至MaskableGraphic，为了支持Mask过滤。)</p>
<p><a target="_blank" rel="noopener" href="https://learn.unity.com/tutorial/optimizing-unity-ui#5c7f8528edbc2a002053b5a0">The updates of Layout and Graphic components is called a rebuild.</a>(网格重建是因为排版或者Graphic组件有更新导致的，比如UI位置变化(排版),UI图片变化(组件变化))</p>
<ol>
<li>Batch Building Process(Canvases)<br><a target="_blank" rel="noopener" href="https://learn.unity.com/tutorial/optimizing-unity-ui#5c7f8528edbc2a002053b5a0">The batch building process is the process whereby a Canvas combines the meshes representing its UI elements and generates the appropriate rendering commands to send to Unity’s graphics pipeline. The results of this process are cached and reused until the Canvas is marked as dirty, which occurs whenever there is a change to one of its constituent meshes.</a>(网格合并是为了将Canvas下的元素合并到一个网格数据里缓存起来直到UI被标记脏时。主要是为了减少DrawCall，减少GPU压力)</li>
<li>Rebuild Process(Graphics)<br><a target="_blank" rel="noopener" href="https://learn.unity.com/tutorial/optimizing-unity-ui#5c7f8528edbc2a002053b5a0">The Rebuild process is where the layout and meshes of Unity UI’s C# Graphic components are recalculated.</a>(网格重建是因为Canvas下的UI有排版或者Graphic组件有变化触发的，目的是为了重新计算绘制所需的网格数据)</li>
</ol>
<p><a target="_blank" rel="noopener" href="https://learn.unity.com/tutorial/optimizing-unity-ui#5c7f8528edbc2a002053b5a0">Whenever any drawable UI element on a given Canvas changes, the Canvas must re-run the batch building process. This process re-analyzes every drawable UI element on the Canvas, regardless of whether it has changed or not. </a>(任何的可绘制UI变化都会导致Canvas重新执行网格合并，因为Mesh有变化了)</p>
<h4 id="UI合批规则"><a href="#UI合批规则" class="headerlink" title="UI合批规则"></a>UI合批规则</h4><p>UI顺序：<br><a href="">Unity UIs are constructed back-to-front, with objects’ order in the hierarchy determining their sort order. </a><br>UI是从后往前结合节点层级(Hierarchy)判定的出序列号的，相邻序列号的会检测是否能合批。所以我们要注意合批打断问题(比如相邻节点没有使用同一个图集，材质。相邻UI节点重叠问题等。)</p>
<p>详细学习参考：<br><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/5b6f5022662e">Unity 之 UGUI 小总结</a></p>
<h4 id="UI射线"><a href="#UI射线" class="headerlink" title="UI射线"></a>UI射线</h4><p>UI射线响应需要满足下面几个条件：</p>
<ol>
<li>目标UI是激活状态</li>
<li>点击区域是目标UI区域</li>
<li>目标UI对象本身或父节点有ICanvasRaycastFilter组件设置允许raycast</li>
</ol>
<p>优化Raycast方案：</p>
<ol>
<li>减少不必要的UI响应Raycast(关闭不必要的UI Raycast Target设置)</li>
</ol>
<p>Note:<br>Unity 5.4之前有个Bug是即使没有input输入也会每帧检查Raycast造成额外开销。</p>
<h3 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h3><p>UI的几个常见问题如下:</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://learn.unity.com/tutorial/optimizing-unity-ui#5c7f8528edbc2a002053b59f">Excessive GPU fragment shader utilization (i.e. fill-rate overutilization)</a>(过度使用GPU – 片元Shader的使用显示，比如填充率过高)</li>
<li><a target="_blank" rel="noopener" href="https://learn.unity.com/tutorial/optimizing-unity-ui#5c7f8528edbc2a002053b59f">Excessive CPU time spent rebuilding a Canvas batch</a>(过度使用CPU – Canvas网格重建和合并)</li>
<li><a target="_blank" rel="noopener" href="https://learn.unity.com/tutorial/optimizing-unity-ui#5c7f8528edbc2a002053b59f">Excessive numbers of rebuilds of Canvas batches (over-dirtying)</a>(过度高频率的触发Canvas网格重建和合并 – 比如大量的动态元素)</li>
<li><a target="_blank" rel="noopener" href="https://learn.unity.com/tutorial/optimizing-unity-ui#5c7f8528edbc2a002053b59f">Excessive CPU time spent generating vertices (usually from text)</a>(过度的使用CPU – 生成过多的顶点数据，比如文本顶点数量)</li>
</ol>
<p>从上面可以看出优化UI主要从两个方面下手：</p>
<ul>
<li>CPU(减少Canvas频繁的合并，减少生成过多的顶点数量)</li>
<li>GPU(减少Drawcall和填充率)</li>
</ul>
<h3 id="Profile-Tool"><a href="#Profile-Tool" class="headerlink" title="Profile Tool"></a>Profile Tool</h3><ol>
<li>Unity Profiler</li>
<li>Unity Frame Debugger</li>
<li>Xcode Intruments</li>
<li>Xcode Frame Debugger<br>详情参考：<br><a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/topics/best-practices/unity-ui-profiling-tools?playlist=30089">Unity UI Profiling Tools</a></li>
</ol>
<h3 id="优化建议"><a href="#优化建议" class="headerlink" title="优化建议"></a>优化建议</h3><ol>
<li>减少不可见UI – 比如全屏不透明UI显示时隐藏背后UI</li>
<li>简化UI结构 – 比如减少不必要节点 不要使用混合GameObject节点等</li>
<li>关闭不可见Camera – 比如全屏不透明UI显示时隐藏其他不必要Camera</li>
<li>划分多Canvas+动静分离 – 比如不同的窗口放到不同的Canvas下避免互相影响。动的元素放在一个Canvas下，静的元素放在一个Canvas下，避免动的元素影响静态元素的网格重建</li>
<li>使用最新版TextMeshPro来替换原生Text方案(TMP使用SDF技术支持不失真的动态字体大小变化)</li>
</ol>
<p>Note:</p>
<ol>
<li>UGUI的Text的文字顶点绘制是单个文字就是一个独立的四边形网格(造成顶点数多)</li>
<li>UGUI的Text动态字体对于不同的大小或者风格(粗体细体)是按不同的文字来处理的(容易造成Canvas的重绘(动态字体纹理重新生成))</li>
<li>文本变化是会触发网格重建和合并的(因为文本网格数据变化了)</li>
</ol>
<h3 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h3><p>通过前面的学习，我们知道了UI的开销主要在Rebatch和Rebuild上。前者可以理解成通过UGUI合批规则把Canvas下的UI合并到指定数量的DrawCall传递到GPU去。后者可以理解成UI变化后重新计算Mesh。</p>
<p>UI优化的关键也就不言而喻了：</p>
<ol>
<li><p>减少Rebatch<br> Canvas没有标记dirty或者Canvas下没有UI Mesh有变化时不会触发Rebatch。<br> 这也就是为什么要划分Canvas且采用动静分离的原因，目的就是把经常变化的UI分离到单独的Canvas，减少静态UI部分的Rebatch开销。</p>
</li>
<li><p>减少Rebuild</p>
</li>
<li><p>降低隐藏激活开销(这一点主要是对于UI显示状态变化时的一种优化)</p>
<p> 根据<a target="_blank" rel="noopener" href="https://blog.uwa4d.com/archives/1875.html"><a target="_blank" rel="noopener" href="https://blog.uwa4d.com/archives/1875.html">UWA 六月直播季 | 6.29 Unity UI模块中的优化案例精讲</a></a>的建议，UGUI最好采用Canvas Group设置Alpha为0的方式来避免SetActive带来的开销以及避免隐藏时的渲染开销</p>
</li>
</ol>
<p>Note:<br>Unity 5.2版本Unity大力优化了UI Batch部分。</p>
<h2 id="资源模块"><a href="#资源模块" class="headerlink" title="资源模块"></a>资源模块</h2><p>资源分很多，比如纹理贴图，图集，材质，Shader，字体，音效，模型，动画等等等。接下来我会针对特定部分来学习针对性的优化知识点。</p>
<h3 id="纹理资源"><a href="#纹理资源" class="headerlink" title="纹理资源"></a>纹理资源</h3><p>这里说的纹理资源同时也包含了图集，图集也可以理解成纹理的一种。</p>
<h3 id="字体"><a href="#字体" class="headerlink" title="字体"></a>字体</h3><p>待续……</p>
<h3 id="音效"><a href="#音效" class="headerlink" title="音效"></a>音效</h3><p>待续……</p>
<h1 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h1><h2 id="Relative-Study"><a href="#Relative-Study" class="headerlink" title="Relative Study"></a>Relative Study</h2><p><a href="">TextMeshPro相关学习</a></p>
<h2 id="Unity-Conception-Part"><a href="#Unity-Conception-Part" class="headerlink" title="Unity Conception Part"></a>Unity Conception Part</h2><p><a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/topics/best-practices/guide-optimizing-unity-ui?playlist=30089">A guide to optimizing Unity UI</a><br><a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/topics/best-practices/fundamentals-unity-ui?playlist=30089">Fundamentals of Unity UI</a><br><a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/topics/best-practices/unity-ui-profiling-tools?playlist=30089">Unity UI Profiling Tools</a><br><a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/topics/best-practices/fill-rate-canvases-and-input?playlist=30089&tdsourcetag=s_pcqq_aiomsg">Fill-rate, Canvases and input</a><br><a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/topics/best-practices/optimizing-ui-controls?playlist=30089">Optimizing UI Controls</a><br><a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/topics/best-practices/other-ui-optimization-techniques-and-tips?playlist=30089">Other UI Optimization Techniques and Tips</a></p>
<h2 id="Other-Part"><a href="#Other-Part" class="headerlink" title="Other Part"></a>Other Part</h2><p><a target="_blank" rel="noopener" href="https://blog.uwa4d.com/archives/QA_UGUI-1.html">关于Unity中的UGUI优化，你可能遇到这些问题</a><br><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/5b6f5022662e">Unity 之 UGUI 小总结</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.uwa4d.com/archives/1875.html"><a target="_blank" rel="noopener" href="https://blog.uwa4d.com/archives/1875.html">UWA 六月直播季 | 6.29 Unity UI模块中的优化案例精讲</a></a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Optimization/">Optimization</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Optimization/">Optimization</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2019/04/19/版本控制/" title="版本控制" itemprop="url">版本控制</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Tony Tang" target="_blank" itemprop="author">Tony Tang</a>
		
  <p class="article-time">
    <time datetime="2019-04-19T04:00:00.000Z" itemprop="datePublished"> 发表于 2019-04-19</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>本篇文章是为了记录版本控制相关知识，着重学习Git的使用。</p>
<h2 id="版本控制"><a href="#版本控制" class="headerlink" title="版本控制"></a>版本控制</h2><p>在项目开发过程中，对项目代码进行维护保存，对于多个人协同工作记录下每一次的变更记录，方便日后查看以及恢复。<br>主流的版本管理工具比如Tortoise SVN,P4,Git等。</p>
<h3 id="集中式-vs-分布式"><a href="#集中式-vs-分布式" class="headerlink" title="集中式 vs 分布式"></a>集中式 vs 分布式</h3><p>这里不对版本管理工具做太深入的学习讲解。<br>参见：<br><a target="_blank" rel="noopener" href="http://www.liaoxuefeng.com/wiki/0013739516305929606dd18361248578c67b8067c8c017b000/001374027586935cf69c53637d8458c9aec27dd546a6cd6000">集中式VS分布式</a></p>
<p>分布式工作流：</p>
<p><img src="/img/VersionControl/%E5%88%86%E5%B8%83%E5%BC%8F.png" alt="分布式"></p>
<p>集中式工作流:</p>
<p><img src="/img/VersionControl/%E9%9B%86%E4%B8%AD%E5%BC%8F.png" alt="集中式"></p>
<p>Note：<br>Tortoise SVN是集中式。</p>
<p>Git是分布式。</p>
<h4 id="Tortoise-SVN"><a href="#Tortoise-SVN" class="headerlink" title="Tortoise SVN"></a>Tortoise SVN</h4><h5 id="Visual-SVN-Server"><a href="#Visual-SVN-Server" class="headerlink" title="Visual SVN Server"></a>Visual SVN Server</h5><p><a target="_blank" rel="noopener" href="https://www.visualsvn.com/server/">VisualSVN Server allows you to easily install and manage a fully-functional Subversion server on the Windows platform.</a>(VisualSVN Server是一个在WIndows上帮助我们快速搭建Subversion server的工具。)</p>
<h5 id="Tortoise-SVN-1"><a href="#Tortoise-SVN-1" class="headerlink" title="Tortoise SVN"></a>Tortoise SVN</h5><p><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/TortoiseSVN">TortoiseSVN是一个Windows平台下的Subversion用户端软件.</a></p>
<p>前者是针对Server端，后者是针对Client端。<br>两者结合使用就能实现版本管理控制。</p>
<h5 id="SVN实战实用"><a href="#SVN实战实用" class="headerlink" title="SVN实战实用"></a>SVN实战实用</h5><h6 id="搭建SVN-Server"><a href="#搭建SVN-Server" class="headerlink" title="搭建SVN Server"></a>搭建SVN Server</h6><p>详细设置步骤参考:<br><a target="_blank" rel="noopener" href="https://www.visualsvn.com/server/getting-started/">VISUALSVN SERVER &#x2F;&#x2F; Getting started</a></p>
<p><a target="_blank" rel="noopener" href="https://superuser.com/questions/644278/how-to-use-visualsvn-server-and-tortoisesvn-client">How to use VisualSVN Server and TortoiseSVN client</a></p>
<p>个人工作的话，可以只搭建本地服务器。(未测试Jenkins是否能使用本地服务器)<br>为了多人共享工作(打包IOS需要Mac)，我们需要搭建一个SVN服务器用于存放我们的原始文件。<br>以下以多人共享工作，搭建SVN服务器为例:</p>
<ol>
<li>下载安装Visual SVN</li>
<li>创建SVN Repository<br><img src="/img/Unity/VisalSVNCreateRepository.PNG" alt="VisalSVNCreateRepository"></li>
<li>设置用户成员访问读写权限<br><img src="/img/Unity/VisualSVNUserManager.PNG" alt="VisualSVNUserManager"><br><img src="/img/Unity/VisualSVNGroupManager.PNG" alt="VisualSVNGroupManager"></li>
<li>Check Out刚才创建的Repository</li>
</ol>
<p>Note:</p>
<p>Mac上可以试试<a target="_blank" rel="noopener" href="http://www.smartsvn.com/download">SmartSVN</a></p>
<h6 id="SVN典型目录结构"><a href="#SVN典型目录结构" class="headerlink" title="SVN典型目录结构"></a>SVN典型目录结构</h6><p>SVN</p>
<ul>
<li>&#x2F;trunk(主干，用于所有人开发)</li>
<li>&#x2F;branches(分支，用于存放多个分支副本(比如开发过程中为了保存特定节点分出来的))</li>
<li>&#x2F;tags(存放标记副本)</li>
</ul>
<h3 id="Git"><a href="#Git" class="headerlink" title="Git"></a>Git</h3><p>首先要记住的是Git是分布式的，和Tortoise SVN(集中式)不一样。</p>
<h4 id="Git安装"><a href="#Git安装" class="headerlink" title="Git安装"></a>Git安装</h4><p><a target="_blank" rel="noopener" href="https://git-scm.com/downloads">Git download</a></p>
<p>安装Git没太多说的，直接下载安装即可。</p>
<p>安装好后就能直接使用Git了，下图是安装后通过Git Bash打开的界面:</p>
<p><img src="/img/VersionControl/GitBashUI.png" alt="GitBashUI"></p>
<h4 id="Git-GUI"><a href="#Git-GUI" class="headerlink" title="Git GUI"></a>Git GUI</h4><p>不习惯命令行的话，官方也有很多插件支持可视化Git操作。</p>
<p><a target="_blank" rel="noopener" href="https://git-scm.com/downloads/guis">Git GUI</a></p>
<p>这里本人用的是<a target="_blank" rel="noopener" href="https://gitextensions.github.io/">GitExtensions</a></p>
<p><img src="/img/VersionControl/GitExtensions.png" alt="GitExtensions"></p>
<p>GitExtension UI操作:</p>
<p><img src="/img/VersionControl/GitExtensionCommandsUI.png" alt="GitExtensionCommandsUI"></p>
<p>Note:<br>结合本人使用体验，TortoiseSVN相比GitExtension更方便也更不容易出问题(比如选取提交数量过多GitExtension卡死。TortoiseSVN操作和SVN操作方式类似，熟悉SVN的更容易上手和理解。)</p>
<h4 id="Git优势"><a href="#Git优势" class="headerlink" title="Git优势"></a>Git优势</h4><ol>
<li><p>可离线操作(分布式，可以离线操作。 SVN集中式必须联网和服务器通信)</p>
</li>
<li><p>本地备份不需要本地存在多份实体文件(有抽象的分支概念)</p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://git-scm.com/about/small-and-fast">Small and Fast</a>(小而快)</p>
</li>
<li><p>开源</p>
</li>
</ol>
<h4 id="Git知识"><a href="#Git知识" class="headerlink" title="Git知识"></a>Git知识</h4><p>下面的知识主要参考:</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_22337877/article/details/73249912">Git 工作区和缓存区</a></p>
<ol>
<li>工作区 – 简单来说，电脑中能看到的目录，就是一个工作区。</li>
<li>缓存区 – 在真正提交改动前会存放的地方</li>
<li>版本库(分本地和远程版本库) – 工作区中有一个隐藏目录.git，这个不算工作区，而是Git的版本库。</li>
</ol>
<p>参考下面这张图详细理解:</p>
<p><img src="/img/VersionControl/GitWorkFlow.png" alt="GitWorkFlow"></p>
<p>更多细节学习了解参考:</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/hsany330/article/details/8668748">Git三区（工作区，缓存区，仓库）的互操作</a></p>
<h4 id="Git实战"><a href="#Git实战" class="headerlink" title="Git实战"></a>Git实战</h4><p><strong>主分支最新+没有冲突提交</strong></p>
<ol>
<li><p>git add</p>
<p>把文件添加进去，实际上是把文件修改添加到暂存区</p>
</li>
</ol>
<p><img src="/img/VersionControl/GitAdd.png" alt="GitAdd"></p>
<ol start="2">
<li><p>git commit</p>
<p>提交更改，实际上就是把暂存区的所有内容提交到当前分支。<strong>git commit后还只是提交到自己的分支上，还没有推送到真正的主干分支上。</strong></p>
</li>
</ol>
<p><img src="/img/VersionControl/GitCommit.png" alt="GitCommit"></p>
<ol start="3">
<li><p>git push origin master</p>
<p><strong>git push才是把个人分支的提交推送到主干分支上</strong></p>
</li>
</ol>
<p><strong>落后更新+冲突提交</strong></p>
<ol>
<li><p>git pull</p>
<p>落后分支的话，我们想要提交东西到主分支我们需要先拉去主分支内容</p>
</li>
<li><p>git stash</p>
<p>缓存冲突文件修改，确保能git pull成功</p>
</li>
<li><p>git pull</p>
<p>确保正确拉倒主分支</p>
</li>
<li><p>git commit + 解决冲突</p>
<p>解决冲突，提交缓存区文件倒本地分支</p>
</li>
<li><p>git push</p>
<p>正式推送到主干分支上</p>
</li>
</ol>
<p>从上面可以看出，要想推送最新修改如果落后或者与主分支修改文件有冲突，我们需要先缓存本地修改到缓存区，然后拉取主干分支之后在进行提交推送修改文件流程。</p>
<p><strong>提交过滤指定文件或文件夹</strong></p>
<p>git提供了一个.gitignore文件，方便我们编写需要过滤的规则：</p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="params">#</span> 文件以及目录过滤</span><br><span class="line"><span class="params">#</span> 过滤library目录</span><br><span class="line">Library/</span><br><span class="line"><span class="params">#</span> 过滤.vs目录</span><br><span class="line">.vs/</span><br><span class="line"><span class="params">#</span> 过滤Temp目录</span><br><span class="line">Temp/</span><br><span class="line"><span class="params">#</span> 过滤cs工程文件</span><br><span class="line">*.csproj</span><br><span class="line">*.sln</span><br></pre></td></tr></table></figure>

<p>详细参考：</p>
<p><a target="_blank" rel="noopener" href="https://git-scm.com/docs/gitignore">gitignore</a></p>
<h4 id="Git小知识"><a href="#Git小知识" class="headerlink" title="Git小知识"></a>Git小知识</h4><p>待添加…..</p>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a target="_blank" rel="noopener" href="https://www.visualsvn.com/server/">Visual SVN</a><br><a target="_blank" rel="noopener" href="https://www.liaoxuefeng.com/wiki/0013739516305929606dd18361248578c67b8067c8c017b000/001374027586935cf69c53637d8458c9aec27dd546a6cd6000">集中式VS分布式</a><br><a target="_blank" rel="noopener" href="https://git-scm.com/about">Git Instroduction</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_22337877/article/details/73249912">Git 工作区和缓存区</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Other/">Other</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/VersionControl/">VersionControl</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2018/10/24/AssetBundle资源打包加载管理学习/" title="AssetBundle资源打包加载管理" itemprop="url">AssetBundle资源打包加载管理</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Tony Tang" target="_blank" itemprop="author">Tony Tang</a>
		
  <p class="article-time">
    <time datetime="2018-10-24T15:07:12.000Z" itemprop="datePublished"> 发表于 2018-10-24</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>本篇文章是为了记录学习了Unity资源加载(Resource &amp; AssetBundle)相关知识后，对于AssetBundle打包加载框架实战的学习记录。因为前一篇学习Unity资源相关知识的文章太长，所以AssetBundle实战这一块单独提出来写一篇。</p>
<p>基础知识学习回顾，参考:<br><a href="http://tonytang1990.github.io/2016/10/13/Unity-Resource-Manager">Unity Resource Manager</a></p>
<h1 id="鸣谢"><a href="#鸣谢" class="headerlink" title="鸣谢"></a>鸣谢</h1><p>这里AssetBundle加载管理的框架思路借鉴了Git上的开源库:<br><a target="_blank" rel="noopener" href="https://github.com/tangzx/ABSystem">tangzx&#x2F;ABSystem</a></p>
<p>同时也学习了KEngine相关部分的代码：<br><a target="_blank" rel="noopener" href="https://github.com/mr-kelly/KEngine">mr-kelly&#x2F;KEngine</a></p>
<p>AssetBundle打包这一套后续个人参考<a target="_blank" rel="noopener" href="https://github.com/gmhevinci/MotionFramework">MotionFramework</a>思路编写的。</p>
<p>Unity官方也推出了一个高度可视化和高度自由度打包方案(个人觉得此工具更适合用于辅助查询打包冗余):<br><a target="_blank" rel="noopener" href="https://github.com/Unity-Technologies/AssetBundles-Browser">AssetBundles-Browser</a></p>
<p>本文重点分享，参考ABSystem编写的一套AB加载管理方案实现:<br><a href="http://tonytang1990.github.io/2018/10/24/AssetBundle-Framework/#%E5%9F%BA%E4%BA%8EAB%E5%BC%95%E7%94%A8%E8%AE%A1%E6%95%B0%E7%9A%84AB%E5%8A%A0%E8%BD%BD%E7%AE%A1%E7%90%86">基于AB引用计数的AB加载管理</a></p>
<h1 id="AssetBundle打包"><a href="#AssetBundle打包" class="headerlink" title="AssetBundle打包"></a>AssetBundle打包</h1><p>Note:<br>这里的AssetBundle打包主要是针对Unity 5.X以及以后的版本来实现学习的。</p>
<h2 id="相关工具"><a href="#相关工具" class="headerlink" title="相关工具"></a>相关工具</h2><ol>
<li>Unity Profiler(Unity自带的新能分析工具，这里主要用于查看内存Asset加载情况)</li>
<li>Unity Studio(Unity AB以及Asset等资源解析查看工具)</li>
<li>DisUnity(解析AB包的工具)</li>
</ol>
<h2 id="AB打包"><a href="#AB打包" class="headerlink" title="AB打包"></a>AB打包</h2><p>AB打包是把资源打包成assetbundle格式的资源。<br>AB打包需要注意的问题：</p>
<ol>
<li>资源冗余</li>
<li>打包策略</li>
<li>AB压缩格式</li>
</ol>
<h3 id="资源冗余"><a href="#资源冗余" class="headerlink" title="资源冗余"></a>资源冗余</h3><p>这里说的资源冗余是指同一份资源被打包到多个AB里，这样就造成了存在多份同样资源。</p>
<p>资源冗余造成的问题：</p>
<ol>
<li>余造成内存中加载多份同样的资源占用内存。</li>
<li>同一份资源通过多次IO加载，性能消耗。</li>
<li>导致包体过大。</li>
</ol>
<p>解决方案：<br>依赖打包</p>
<h4 id="依赖打包"><a href="#依赖打包" class="headerlink" title="依赖打包"></a>依赖打包</h4><p>依赖打包是指指定资源之间的依赖关系，打包时不将依赖的资源重复打包到依赖那些资源的AB里(避免资源冗余)。</p>
<p>在老版(Unity 5之前)，官方提供的API接口是通过BuildPipeline.PushAssetDependencies和BuildPipeline.PopAssetDependencies来指定资源依赖来解决资源冗余打包的问题。</p>
<p>在新版(Unity 5以后)，官方提供了针对每个Asset在面板上设置AssetBundle Name的形式指定每个Asset需要打包到的最终AB。然后通过 API接口BuildPipeline.BuildAssetBundles()触发AB一键打包(Unity自己会根据设置AB的名字以及Asset之间的使用依赖决定是否将依赖的资源打包到最终AB里)。或者通过API接口BuildPipeline.BuildAssetBundles(*)传入自定义分析的打包结论指定如何打包。</p>
<p>这里值得一提的是Unity 5以后提供的增量打包功能。</p>
<h4 id="增量打包-Unity-5以后"><a href="#增量打包-Unity-5以后" class="headerlink" title="增量打包(Unity 5以后)"></a>增量打包(Unity 5以后)</h4><p>增量打包是指Unity自己维护了一个叫manifest的文件(前面提到过的记录AB包含的Asset以及依赖的AB关系的文件)，每次触发AB打包，Unity只会修改有变化的部分，并将最新的依赖关系写入manifest文件。</p>
<p>*.manifest记录所有AB打包依赖信息的文件，内容如下：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">ManifestFileVersion: <span class="number">0</span></span><br><span class="line">CRC: <span class="number">961902239</span></span><br><span class="line">AssetBundleManifest:</span><br><span class="line">  AssetBundleInfos:</span><br><span class="line">    Info_0:</span><br><span class="line">      Name: nonuiprefabs/nui_capsulesingletexture</span><br><span class="line">      Dependencies:</span><br><span class="line">        Dependency_0: materials/mt_singletexturematerial</span><br><span class="line">    Info_1:</span><br><span class="line">      Name: shaders/sd_shaderlist</span><br><span class="line">      Dependencies: &#123;&#125;</span><br><span class="line">    Info_2:</span><br><span class="line">      Name: materials/mt_singletexturematerial</span><br><span class="line">      Dependencies:</span><br><span class="line">        Dependency_0: shaders/sd_shaderlist</span><br><span class="line">        Dependency_1: textures/tx_brick_diffuse</span><br><span class="line">    Info_3:</span><br><span class="line">      Name: textures/tx_brick_diffuse</span><br><span class="line">      Dependencies: &#123;&#125;</span><br><span class="line">    Info_4:</span><br><span class="line">      Name: nonuiprefabs/nui_capsulenormalmappingtexture</span><br><span class="line">      Dependencies: &#123;&#125;</span><br><span class="line">    Info_5:</span><br><span class="line">      Name: textures/tx_brick_normal</span><br><span class="line">      Dependencies: &#123;&#125;</span><br><span class="line">    Info_6:</span><br><span class="line">      Name: materials/mt_normalmappingmaterial</span><br><span class="line">      Dependencies:</span><br><span class="line">        Dependency_0: shaders/sd_shaderlist</span><br><span class="line">        Dependency_1: textures/tx_brick_diffuse</span><br><span class="line">        Dependency_2: textures/tx_brick_normal</span><br></pre></td></tr></table></figure>

<p>问题：<br>虽然Unity5提供了增量打包并记录了依赖关系，但从上面的*.manifest可以看出，依赖关系只记录了依赖的AB的名字没有具体到特定的Asset。</p>
<p>最好的证明就是上面我把用到的Shader都打包到sd_shaderlist里。在我打包的资源里，有两个shader被用到了(SingleTextShader和NormalMappingShader)，这一点可以通过UnityStudio解压查看sd_shaderlist看到:<br><img src="/img/Unity/AssetBundle-Framework/sd_shaderlist.PNG" alt="sd_shaderlist"></p>
<p>从上面可以看出Unity的增量打包只是解决了打包时更新哪些AB的判定，而打包出来的*.manifest文件并不能让我们得知用到了具体哪一个Asset而是AssetBundle。</p>
<p>解决用到哪些Asset这一环节依然是需要我们自己解决的问题，只有存储了用到哪些Asset的信息，我们才能在加载AB的时候对特定Asset做操作(缓存，释放等)。</p>
<p>Note:<br>每一个AB下面都对应一个.manifest文件，这个文件记录了该AB的asset包含情况以及依赖的AB情况，但这些manifest文件最终不会不打包到游戏里的，只有最外层生成的*.manifest文件(记录了所有AB的打包信息)才会被打包到游戏里，所以才有像前面提到的<a href="http://tonytang1990.github.io/2016/10/13/Unity-Resource-Manager/#AssetBundle">通过读取.manifest文件获取对应AB所依赖的所有AB信息进行加载依赖并最终加载出所需Asset的例子</a></p>
<h4 id="依赖Asset信息打包"><a href="#依赖Asset信息打包" class="headerlink" title="依赖Asset信息打包"></a>依赖Asset信息打包</h4><p>存储依赖的Asset信息可以有多种方式：</p>
<ol>
<li>通过加载依赖AB，依赖Unity自动还原的机制实现依赖Asset加载还原(<em>这正是本博客实现AssetBundle打包以及加载管理的方案</em>)</li>
<li>存储挂载相关信息到Prefab上<br>在设置好AB名字，打包AB之前，将打包对象上用到的信息通过编写[System.Serializable]可序列化标签抽象数据挂载到该Asset对象上，然后打包AB，打包完AB后在运行时利用打包的依赖信息进行依赖Asset加载还原，从而做到对Asset的生命周期掌控。<br><img src="/img/Unity/DPInfoMono.PNG" alt="DPInfoMono"></li>
<li>创建打包Asset到同名AB里，加载的时候读取<br>通过AssetDatabase.CreateAsset()和AssetImporter.GetAtPath()将依赖的信息写入新的Asset并打包到相同AB里，加载时加载出来使用。<br><img src="/img/Unity/AssetBundle-Framework/MaterialAssetInfo.PNG" alt="MaterialAssetInfo"></li>
</ol>
<h3 id="打包策略"><a href="#打包策略" class="headerlink" title="打包策略"></a>打包策略</h3><p>除了资源冗余，打包策略也很重要。打包策略是指决定各个Asset如何分配打包到指定AB里的策略。打包策略会决定AB的数量，资源冗余等问题。AB数量过多会增加IO负担。资源冗余会导致包体过大，内存中存在多份同样的Asset，热更新资源大小等。</p>
<p>打包策略：</p>
<ol>
<li>Logical entities(按逻辑(功能)分类 – 比如按UI，按模型使用，按场景Share等功能分类)<br>优点：可以动态只更新特定Entity</li>
<li>Object Types(类型分类 – 主要用于同类型文件需要同时更新的Asset)<br>优点：只适用于少部分需要经常变化更新的小文件</li>
<li>Concurrent content(加载时机分类 – 比如按Level分类，主要用于游戏里类容固定(Level Based)不会动态变化加载的游戏类型)<br>优点：适合Level based这种一层内容一层不变的游戏类型<br>缺点：不适合用于动态创建对象的游戏类型</li>
</ol>
<p>打包策略遵循几个比较基本的准则：</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/temas/best-practices/assetbundle-usage-patterns#Managing_Loaded_Assets">Split frequently-updated Objects into different AssetBundles than Objects that usually remain unchanged</a>(频繁更新的Asset不要放到不怎么会修改的Asset里而应分别放到不同的AB里)</li>
<li><a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/temas/best-practices/assetbundle-usage-patterns#Managing_Loaded_Assets">Group together Objects that are likely to be loaded simultaneously</a>(把需要同时加载的Asset尽量打包到同一个AB里)</li>
</ol>
<p>从上面可以看出，不同的打包策略适用于不同的游戏类型，根据游戏类型选择最优的策略是关键点。</p>
<h3 id="AB压缩格式"><a href="#AB压缩格式" class="headerlink" title="AB压缩格式"></a>AB压缩格式</h3><p>AB压缩不压缩问题，主要考虑的点如下:</p>
<ol>
<li>加载时间</li>
<li>加载速度</li>
<li>资源包体大小</li>
<li>打包时间</li>
<li>下载AB时间<br>这里就不针对压缩问题做进一步介绍了，主要根据游戏对于各个问题的需求看重点来决定选择(内存与加载性能的抉择)</li>
</ol>
<h3 id="AB打包相关API"><a href="#AB打包相关API" class="headerlink" title="AB打包相关API"></a>AB打包相关API</h3><ol>
<li>Selection(获取Unity Editor当前勾选对象相关信息的接口)</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Object[] assetsselections = Selection.GetFiltered(Type, SelectionMode);</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>AssetDatabase(操作访问Unity Asset的接口)</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取选中Asset的路径</span></span><br><span class="line">assetpath = AssetDatabase.GetAssetPath(assetsselections[i]);</span><br><span class="line"><span class="comment">// 获取选中Asset的GUID</span></span><br><span class="line">assetguid = AssetDatabase.AssetPathToGUID(assetpath);</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>AssetImporter(获取设置Asset的AB名字的接口)</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取指定Asset的Asset设置接口</span></span><br><span class="line">AssetImporter assetimporter = AssetImporter.GetAtPath(assetpath);</span><br><span class="line"><span class="comment">// 设置Asset的AB信息</span></span><br><span class="line">assetimporter.assetBundleVariant = ABVariantName;</span><br><span class="line">assetimporter.assetBundleName = ABName;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>BuildPipeline(AB打包接口)</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">BuildPipeline.BuildAssetBundles(outputPath, BuildAssetBundleOptions, BuildTarget); </span><br><span class="line"></span><br><span class="line">BuildPipeline.BuildAssetBundles(<span class="built_in">string</span> outputPath, AssetBundleBuild[] builds, BuildAssetBundleOptions assetBundleOptions, BuildTarget targetPlatform);</span><br></pre></td></tr></table></figure>

<p>可以看到AB打包Unity 5.X提供了两个主要的接口：</p>
<ol>
<li>前者是依赖于设置每个Asset的AB名字，然后一个接口完成增量打包的方案。<br>优点:<br> 自带增量打包<br>缺点:<br> 需要有一套资源AB命名规则。<br> 开发者可控度低。</li>
<li>后者是提供给开发者自定义哪些Asset打包到指定AB里的一个接口。<br>优点:<br> 可自行实现指定需求的打包规则。<br> 开发者可控度高。<br>缺点:<br> 不自带增量打包需要自己实现。</li>
</ol>
<p>Note:<br>AssetBundle-Browser也是基于前者的一套打包方案，只不过AssetBundle-Browser实现了高度的Asset资源打包可视化操作与智能分析。</p>
<h2 id="AssetBundle加载管理"><a href="#AssetBundle加载管理" class="headerlink" title="AssetBundle加载管理"></a>AssetBundle加载管理</h2><p>实战学习AB加载之前让我们通过一张图先了解下AB与Asset与GameObject之间的关系:<br><img src="/img/Unity/AssetBundleFramework.PNG" alt="AssetBundleFramework"></p>
<h3 id="依赖加载还原"><a href="#依赖加载还原" class="headerlink" title="依赖加载还原"></a>依赖加载还原</h3><p>还记得前面说到的依赖的Assest信息打包吗？<br>这里就需要加载出来并使用进行还原了。<br>这里接不细说加载还原了，主要就是通过存储的依赖信息把依赖的Asset加载进来并设置回去的过程(可以是手动设置回去也可以是Unity自动还原的方式)。</p>
<p>这里主要要注意的是前面那张大图上给出的各种资源类型在Asset加载还原时采用的方式。<br>资源加载还原的方式主要有两种：</p>
<ol>
<li><p>复制+引用<br>UI – 复制(GameObject) + 引用(Components,Tranform等)<br>Material – 复制(材质自身) + 引用(Texture和Shader)</p>
</li>
<li><p>引用<br>Sprite – 引用<br>Audio – 引用<br>Texture – 引用<br>Shader – 引用<br>Material – 引用</p>
</li>
</ol>
<h3 id="AB加载相关API"><a href="#AB加载相关API" class="headerlink" title="AB加载相关API"></a>AB加载相关API</h3><ol>
<li>AssetBundle(AB接口)</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 加载本地压缩过的AB</span></span><br><span class="line">AssetBundle.LoadFromFile(abfullpath)</span><br><span class="line"><span class="comment">// 加载AB里的指定Asset</span></span><br><span class="line">AssetBundle.LoadAsset(assetname);</span><br><span class="line"><span class="comment">// 加载AB里的所有Asset</span></span><br><span class="line">AssetBundle.LoadAllAssets();</span><br></pre></td></tr></table></figure>

<h3 id="AB回收相关API"><a href="#AB回收相关API" class="headerlink" title="AB回收相关API"></a>AB回收相关API</h3><ol>
<li>AssetBundle(AB接口)</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 回收AssetBundle并连带加载实例化出来的Asset以及GameObject一起回收</span></span><br><span class="line">AssetBundle.Unload(<span class="literal">true</span>);</span><br><span class="line"><span class="comment">// 只回收AssetBundle</span></span><br><span class="line">AssetBundle.Unload(<span class="literal">false</span>);</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>Resource(资源接口)</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 回收指定Asset(这里的Asset不能为GameObject)</span></span><br><span class="line">Resource.UnloadAsset(asset);</span><br><span class="line"><span class="comment">// 回收内存以所有不再有任何引用的Asset</span></span><br><span class="line">Resources.UnloadUnusedAssets();</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>GC(内存回收)</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 内存回收</span></span><br><span class="line">GC.Collect();</span><br></pre></td></tr></table></figure>

<p>AB回收的方式有两种：</p>
<ol>
<li>AssetBundle.Unload(false)(基于Asset层面的重用，通过遍历判定的方式去判定Asset是否回收)</li>
<li>AssetBundle.Unload(true)(采取索引技术，基于AB层面的管理，只有AB的引用计数为0时我们直接通过AssetBundle.Unload(true)来卸载AB和Asset资源)</li>
</ol>
<p>接下来结合这两种方式，实战演练加深理解。</p>
<h3 id="基于Asset重用的AB加载"><a href="#基于Asset重用的AB加载" class="headerlink" title="基于Asset重用的AB加载"></a>基于Asset重用的AB加载</h3><p>核心思想：</p>
<ol>
<li>打包时存储了依赖的Asset信息，加载时利用存储的依赖信息并还原</li>
<li>缓存加载进来的Asset的控制权进行重用，卸载AB(AssetBundle.Unload(false))</li>
<li>加载时通过Clone(复制类型)或者返回缓存Asset(引用类型)进行Asset重用</li>
</ol>
<p>一下以之前打包的CapsuleNormalMappingTexture.prefab进行详细说明：<br><img src="/img/Unity/CapsuleNormalMappingPrefab.PNG" alt="CapsuleNormalMappingPrefab.PNG"><br>可以看出CapsuleNormalMappingTexture.prefab用到了如下Asset:</p>
<ol>
<li>NormalMappingMaterial(材质)</li>
<li>Custom&#x2F;Texture&#x2F;NormalMappingShader(Shader)</li>
<li>Brick_Diffuse和Brick_Normal(纹理)</li>
</ol>
<p>开始加载CapsuleNormalMappingTexture.prefab:<br>首先让我们看看加载了CapsuleNormalMappingTexture.prefab前的Asset加载情况:<br><img src="/img/Unity/NonUIPrefabLoadedBeforeProfiler.PNG" alt="NonUIPrefabLoadedBeforeProfiler"><br>可以看出只有Shader Asset被预先加载进来了(因为我预先把所有Shader都加载进来了)<br>第一步：<br>加载CapsuleNormalMappingTexture.prefab对应的AB，因为Prefab是采用复制加引用所以这里需要返回一个通过加载Asset后Clone的一份对象。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">nonuiprefabab = loadAssetBundle(abfullname);</span><br><span class="line"><span class="keyword">var</span> nonuiprefabasset = loadMainAsset(nonuiprefabab);</span><br><span class="line">nonuigo = GameObject.Instantiate(nonuiprefabasset) <span class="keyword">as</span> GameObject;</span><br><span class="line"><span class="comment">// Asest一旦加载进来，我们就可以进行缓存，相应的AB就可以释放掉了</span></span><br><span class="line"><span class="comment">// 后续会讲到相关AB和Asset释放API</span></span><br><span class="line">nonuiprefabab.Unload(<span class="literal">false</span>);</span><br></pre></td></tr></table></figure>

<p>第二步：<br>还原依赖材质<br><img src="/img/Unity/DPInfoMono.PNG" alt="DPInfoMono"></p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">NonUIPrefabDepInfo nonuidpinfo = nonuigo.GetComponent&lt;NonUIPrefabDepInfo&gt;();</span><br><span class="line"><span class="keyword">var</span> dpmaterials = nonuidpinfo.mDPMaterialInfoList;</span><br><span class="line"><span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; dpmaterials.Count; i++)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="built_in">int</span> j = <span class="number">0</span>; j &lt; dpmaterials[i].mMaterialNameList.Count; j++)</span><br><span class="line">    &#123;</span><br><span class="line">        MaterialResourceLoader.getInstance().addMaterial(dpmaterials[i].mRenderer, dpmaterials[i].mMaterialNameList[j]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第三步：<br>还原依赖材质的Shader和Texture依赖引用<br><img src="/img/Unity/MaterialAssetInfo.PNG" alt="MaterialAssetInfo"></p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 根据材质_InfoAsset.asset进行还原材质原始Shader以及Texture信息</span></span><br><span class="line"><span class="keyword">var</span> materialinfoasseetname = <span class="built_in">string</span>.Format(<span class="string">&quot;&#123;0&#125;_&#123;1&#125;InfoAsset.asset&quot;</span>, materialname, ResourceHelper.CurrentPlatformPostfix);</span><br><span class="line"><span class="keyword">var</span> materialassetinfo = loadSpecificAsset(materialab, materialinfoasseetname.ToLower()) <span class="keyword">as</span> MaterialAssetInfo;</span><br><span class="line"><span class="comment">// 加载材质依赖的Shader</span></span><br><span class="line"><span class="keyword">var</span> materialshader = materialassetinfo.mShaderName;</span><br><span class="line"><span class="keyword">var</span> shader = ShaderResourceLoader.getInstance().getSpecificShader(materialshader);</span><br><span class="line">material.shader = shader;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取Shader使用的Texture信息进行还原</span></span><br><span class="line"><span class="keyword">var</span> materialdptextureinfo = materialassetinfo.mTextureInfoList;</span><br><span class="line"><span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; materialdptextureinfo.Count; i++)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 加载指定依赖纹理</span></span><br><span class="line">    Texture shadertexture = TextureResourceLoader.getInstance().loadTexture(materialdptextureinfo[i].Value);</span><br><span class="line">    <span class="comment">//设置材质的对应Texture</span></span><br><span class="line">    material.SetTexture(materialdptextureinfo[i].Key, shadertexture);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下让我们看看加载了CapsuleNormalMappingTexture.prefab后的Asset加载情况:<br><img src="/img/Unity/NonUIPrefabLoadedAfterProfiler.PNG" alt="NonUIPrefabLoadedAfterProfiler"><br>可以看出引用的材质和纹理Asest都被加载到内存里了(Shader因为我预先把所有Shader都加载进来了所以就直接重用了没有被重复加载)<br>第四步：<br>对缓存的Asset进行判定是否回收(这里以材质为例，判定方式可能多种多样，我这里是通过判定是否有有效引用)<br>启动一个携程判定特定Material是否不再有有效组件(所有引用组件为空或者都不再使用任何材质)时回收Material Asset</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Resources.UnloadAsset(materialasset);</span><br></pre></td></tr></table></figure>

<p>接下来让我们看看卸载实例对象后，材质被回收的情况：<br><img src="/img/Unity/MaterialRecycleAssetNumer.PNG" alt="MaterialRecycleAssetNumer"><br><img src="/img/Unity/MaterialRecycle.PNG" alt="MaterialRecycle"><br>可以看到没有被引用的材质Asset被回收了，但内存里的Asset数量却明显增加了。<br>这里多出来的是我们还没有回收的Texture以及Prefab的GameObject以及Components Asset依然还在内存里。<br><img src="/img/Unity/AfterMaterialRecyleTextureStatus.PNG" alt="AfterMaterialRecyleTextureStatus"><br><img src="/img/Unity/AfterMaterialRecyleGameObjectStatus.PNG" alt="AfterMaterialRecyleGameObjectStatus"><br><img src="/img/Unity/AfterMaterialRecyleTrasformStatus.PNG" alt="AfterMaterialRecyleTrasformStatus"><br>第五步：<br>通过切换场景触发置空所有引用将还未回收的Asset变成UnsedAsset或者直接触发Texture Asset回收，然后通过Resources.UnloadUnusedAssets()回收所有未使用的Asset</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mNonUIPrefabAssetMap = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span>(<span class="keyword">var</span> texture <span class="keyword">in</span> mTexturesUsingMap)</span><br><span class="line">&#123;</span><br><span class="line">    unloadAsset(texture.Value);</span><br><span class="line">&#125;</span><br><span class="line">mTexturesUsingMap = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">Resources.UnloadUnusedAssets();</span><br></pre></td></tr></table></figure>

<p><img src="/img/Unity/AfterAssetsRecyleAssetNumber.PNG" alt="AfterAssetsRecyleAssetNumber"><br><img src="/img/Unity/AfterAssetsRecyleTextureStatus.PNG" alt="AfterAssetsRecyleTextureStatus"><br><img src="/img/Unity/AfterAssetsRecyleGameObjectStatus.PNG" alt="AfterAssetsRecyleGameObjectStatus"><br><img src="/img/Unity/AfterAssetsRecyleTransformStatus.PNG" alt="AfterAssetsRecyleTransformStatus"><br>可以看到所有的Texture, GameObject, Transform都被回收了，并且Asset的数量回到了最初的数值。</p>
<h3 id="基于AB引用计数的AB加载管理"><a href="#基于AB引用计数的AB加载管理" class="headerlink" title="基于AB引用计数的AB加载管理"></a>基于AB引用计数的AB加载管理</h3><p><strong>这是本文重点分享的部分</strong></p>
<p>方案1：<br>核心思想：</p>
<ol>
<li>基于AB的引用计数 + AssetBundle.Unload(true)</li>
<li>给每一种资源(e.g. 特效，模型，图片，窗口等)加载都编写统一的资源加载接口(父类抽象)进行自身加载使用的AB引用计数，每个资源负责自身的资源加载管理和返还(主动调用)</li>
<li>由一个单例管理者统一管理所有加载AB的引用计数信息，负责判定是否可回收</li>
</ol>
<p>优点：</p>
<ol>
<li>严格的AB引用计数加载管理和释放</li>
<li>可以做到对资源对象的重用减少GC</li>
<li>对资源对象的重用可以减少AB的重复加载</li>
</ol>
<p>缺点：</p>
<ol>
<li>底层管理的内容比较多(比如基于资源对象的重用)，上层灵活度欠缺(相当于对象池已经写在了最底层)</li>
<li>需要主动去调用返还接口(针对不同资源加载释放时机都需要编写一套对应的代码)</li>
</ol>
<p>方案2：<br>核心思想：</p>
<ol>
<li>基于AB的引用计数 + AssetBundle.Unload(true)</li>
<li>绑定加载AB的生命周期判定到Object上(e.g. GameObject，Image，Material等)，上层无需关心AB的引用计数，只需绑定AB到对应的对象上即可</li>
<li>通过单例管理者统一管理判定依赖使用AB的Object列表是否都为空来判定是否可以回收，无需上层管理AB引用计数返还</li>
</ol>
<p>优点：</p>
<ol>
<li>上层只需关心AB加载绑定，无需关心AB引用计数返还问题，上层使用灵活度高</li>
</ol>
<p>缺点：</p>
<ol>
<li>AB的返还判定跟绑定的Object有关，Object被回收后，AB容易出现重复加载(可以在上层写部分对象池来减少AB的重复加载)</li>
</ol>
<p>考虑到希望上层灵活度高一些，个人现在倾向于第二种方案。</p>
<p>接下来基于第二种方案来实战编写资源AB加载的框架。<br>AB打包这一块采用最新的可视化指定打包策略的方式。</p>
<h2 id="新版AssetBundle加载管理，打包以及热更新"><a href="#新版AssetBundle加载管理，打包以及热更新" class="headerlink" title="新版AssetBundle加载管理，打包以及热更新"></a>新版AssetBundle加载管理，打包以及热更新</h2><p>为了弥补以前设计和实现上不足的地方，从而有了新版AssetBundle加载管理和打包的编写。</p>
<h3 id="新版AssetBundle加载管理"><a href="#新版AssetBundle加载管理" class="headerlink" title="新版AssetBundle加载管理"></a>新版AssetBundle加载管理</h3><p>老版的资源加载管理缺点：</p>
<ol>
<li>面向AssetBundle级别，没有面向Asset级别的加载管理，无法做到Asset级别的加载异步以及Asset级别加载取消的。</li>
<li>老版AssetDatabase模式要求资源必须在设置AB名字后才能正确使用(因为依赖了AB名字作为加载参数而非资源全路径)，无法做到资源导入即可快速使用的迭代开发</li>
<li>资源加载类型分类(普通，预加载，常驻)设计过于面向切场景的游戏设计，不通用到所有游戏类型</li>
<li>老版AssetBundle异步加载采用了开携程的方式，代码流程看起来会比较混乱</li>
<li>老版异步加载没有考虑设计上支持逻辑层加载打断</li>
<li>老版代码没有涉及考虑动态AB下载的设计(边玩边下)</li>
<li>资源加载代码设计还比较混乱，不容易让人看懂看明白</li>
</ol>
<p>综合上面4个问题，新版资源加载管理将支持:</p>
<ol>
<li>面向Asset级别加载管理，支持Asset和AssetBundle级别的同步异步加载。</li>
<li>支持资源导入后AssetDatabase模式马上就能配置全路径加载</li>
<li>资源加载类型只提供普通和常驻两种(且不支持运行时切换相同Asset或AssetBundle的加载类型，意味着一旦第一次加载设定了类型，就再也不能改变，同时第一次因为加载Asset而加载某个AssetBundle的加载类型和Asset一致)，同时提供统一的加载管理策略，细节管理策略由上层自己设计(比如对象池，预加载)</li>
<li>新版异步加载准备采用监听回调的方式来实现，保证流程清晰易懂</li>
<li>新版设计请求UID的概念来支持加载打断设计(仅逻辑层面的打断，资源加载不会打断，当所有逻辑回调都取消时，加载完成时会返还索引计数确保资源正确卸载)</li>
<li>设计上支持动态AB下载(未来填坑)</li>
<li>加载流程重新设计，让代码更清晰</li>
<li><strong>保留索引计数(Asset和AssetBundle级别)+对象绑定的设计(Asset和AssetBundle级别)+按AssetBundle级别卸载(依赖还原的Asset无法准确得知所以无法直接卸载Asset)+加载触发就提前计数(避免异步加载或异步加载打断情况下资源管理异常)</strong></li>
<li><strong>支持非回调式的同步加载返回(通过抽象Loader支持LoadImmediately的方式实现)</strong></li>
</ol>
<p>Note:</p>
<ol>
<li>一直以来设计上都是加载完成后才添加索引计数和对象绑定，这样对于异步加载以及异步打断的资源管理来说是有漏洞的，<strong>新版资源加载管理准备设计成提前添加索引计数，等加载完成后再考虑是否返还计数的方式确保异步加载以及异步加载打断的正确资源管理</strong></li>
</ol>
<p>加载流程设计主要参考:</p>
<p><a target="_blank" rel="noopener" href="https://github.com/xasset/xasset">XAsset</a></p>
<p>对象绑定加索引计数设计主要参考:</p>
<p><a target="_blank" rel="noopener" href="https://github.com/tangzx/ABSystem">tangzx&#x2F;ABSystem</a></p>
<h4 id="类说明"><a href="#类说明" class="headerlink" title="类说明"></a>类说明</h4><p>Manager统一管理：</p>
<pre><code>- ModuleManager(单例类 Manager of Manager的管理类)
- ModuleInterface(模块接口类)
</code></pre>
<p>资源加载类：</p>
<pre><code>- ResourceLoadMethod(资源加载方式枚举类型 -- 同步 or 异步)
- ResourceLoadMode(资源加载模式 -- AssetBundle or AssetDatabase(**限Editor模式下可切换，支持同步和异步(异步是本地模拟延迟加载来实现的)加载方式**))
- ResourceLoadState(资源加载状态 -- 错误，等待加载， 加载中，完成，取消之类的)
- ResourceLoadType(资源加载类型 -- 正常加载，常驻加载)
- ResourceModuleManager(资源加载模块统一入口管理类)
- AbstractResourceModule(资源加载模块抽象)
- AssetBundleModule(AssetBundle模式下的实际加载管理模块)
- AssetDatabaseModule(AssetDatabase模式下的实际加载管理模块)
- AbstractResourceInfo(资源加载使用信息抽象)
- AssetBundleInfo(AssetBundle资源使用信息)
- AssetInfo(Asset资源使用信息)
- LoaderManager(加载器管理单例类)
- Loadable(资源加载器基类--抽象加载流程)
- AssetLoader(Asset加载器基类抽象)
- BundleAssetLoader(AssetBundle模式下的Asset加载器)
- AssetDatabaseLoader(AssetDatabase模式下的Asset加载器)
- BundleLoader(AssetBundle加载器基类抽象)
- AssetBundleLoader(本地AssetBundle加载器)
- DownloadAssetBundleLoader(动态资源AsserBundle加载器)
- AssetDatabaseAsyncRequest(AssetDatabase模式下异步加载模拟)
- AssetBundlePath(AB资源路径相关 -- 处理多平台以及热更资源加载路径问题)
- ResourceDebugWindow.cs(Editor运行模式下可视化查看资源加载(AssetBundle和AssetDatabase两种都支持)详细信息的辅助工具窗口)
- ResourceConstData(资源打包加载相关常量数据)
- ResourceLoadAnalyse(资源加载统计分析工具)
</code></pre>
<h4 id="AB加载管理方案"><a href="#AB加载管理方案" class="headerlink" title="AB加载管理方案"></a>AB加载管理方案</h4><p>加载管理方案：</p>
<ol>
<li>加载指定资源</li>
<li>加载自身AB(自身AB加载完通知资源加载层移除该AB加载任务避免重复的加载任务被创建)，自身AB加载完判定是否有依赖AB</li>
<li>有则加载依赖AB(增加依赖AB的引用计数)(依赖AB采用和自身AB相同的加载方式(ResourceLoadMethod),但依赖AB统一采用ResourceLoadType.NormalLoad加载类型)</li>
<li>自身AB和所有依赖AB加载完回调通知逻辑层可以开始加载Asset资源(AB绑定对象在这一步)</li>
<li>判定AB是否满足引用计数为0，绑定对象为空，且为NormalLoad加载方式则卸载该AB(并释放依赖AB的计数减一)(通知资源管理层AB卸载，重用AssetBundleInfo对象)</li>
<li>切场景，递归判定卸载PreloadLoad加载类型AB资源</li>
</ol>
<p>相关设计：</p>
<ol>
<li>依赖AB与被依赖者采用同样的加载方式(ResourceLoadMethod)，但加载方式依赖AB统一采用ResourceLoadType.NormalLoad</li>
<li>依赖AB通过索引计数管理，只要原始AB不被卸载，依赖AB就不会被卸载</li>
<li>已加载的AB资源加载类型只允许从低往高变(NormalLoad -&gt; Preload -&gt; PermanentLoad)，不允许从高往低(PermanentLoad -&gt; Preload -&gt; NormalLoad)</li>
</ol>
<h4 id="Demo使用说明"><a href="#Demo使用说明" class="headerlink" title="Demo使用说明"></a>Demo使用说明</h4><p>先打开资源调试工具</p>
<p>Tools-&gt;Debug-&gt;资源调试工具</p>
<ol>
<li><p>AssetBundle和AssetDatabase资源加载模式切换<img src="/./img/Unity/AssetBundle-Framework/AssetDatabaseModuleSwitch.png" alt="AssetDatabaseModuleSwitch"></p>
</li>
<li><p>AB依赖信息查看界面</p>
<p><img src="/./img/Unity/AssetBundle-Framework/AssetBundle-Framework/AssetBundleDepInfoUI.png" alt="AssetBundleDepInfoUI"></p>
</li>
<li><p>AB运行时加载管理详细信息界面</p>
<p><img src="/./img/Unity/AssetBundle-Framework/AssetBundleLoadManagerUI.png" alt="AssetBundleLoadManagerUI"></p>
</li>
<li><p>加载器信息查看界面</p>
<p>   <img src="/./img/Unity/AssetBundle-Framework/LoaderDebugUI.png" alt="AssetBundleAsyncUI"></p>
</li>
<li><p>测试界面</p>
<p><img src="/./img/Unity/AssetBundle-Framework/AssetBundleTestUI.png" alt="AssetBundleTestUI"></p>
</li>
<li><p>点击加载窗口预制件按钮后:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ResourceManager.Singleton.getPrefabInstance(</span><br><span class="line">    <span class="string">&quot;Assets/Res/windows/MainWindow.prefab&quot;</span>,</span><br><span class="line">    (prefabInstance, requestUid) =&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        mMainWindow = prefabInstance;</span><br><span class="line">        mMainWindow.transform.SetParent(UIRootCanvas.transform, <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p><img src="/./img/Unity/AssetBundle-Framework/AssetBundleLoadManagerUIAfterLoadWindow.png" alt="AssetBundleLoadManagerUIAfterLoadWindow"><br>可以看到窗口mainwindow依赖于loadingscreen，导致我们加载窗口资源时，loadingscreen作为依赖AB被加载进来了(引用计数为1)，窗口资源被绑定到实例出来的窗口对象上(绑定对象MainWindow)</p>
</li>
<li><p>点击测试异步转同步加载窗口</p>
</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 测试异步转同步窗口加载</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAsynToSyncLoadWindow</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    DIYLog.Log(<span class="string">&quot;onAsynToSyncLoadWindow()&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (mMainWindow == <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        onDestroyWindowInstance();</span><br><span class="line">    &#125;</span><br><span class="line">    AssetLoader assetLoader;</span><br><span class="line">    <span class="keyword">var</span> requestUID = ResourceManager.Singleton.getPrefabInstanceAsync(</span><br><span class="line">        <span class="string">&quot;Assets/Res/windows/MainWindow.prefab&quot;</span>,</span><br><span class="line">        <span class="keyword">out</span> assetLoader,</span><br><span class="line">        (prefabInstance, requestUid) =&gt;</span><br><span class="line">        &#123;</span><br><span class="line">            mMainWindow = prefabInstance;</span><br><span class="line">            mMainWindow.transform.SetParent(UIRootCanvas.transform, <span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    );</span><br><span class="line">    <span class="comment">// 将异步转同步加载</span></span><br><span class="line">    assetLoader.loadImmediately();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="8">
<li>点击销毁窗口实例对象后</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 销毁窗口实例对象</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDestroyWindowInstance</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    DIYLog.Log(<span class="string">&quot;onDestroyWindowInstance()&quot;</span>);</span><br><span class="line">    GameObject.Destroy(mMainWindow);</span><br><span class="line">&#125;</span><br><span class="line">窗口销毁后可以看到之前加载的资源所有绑定对象都为空了，因为被销毁了(MainWindow被销毁了)</span><br></pre></td></tr></table></figure>

<p>​		<img src="/img/Unity/AssetBundle-Framework/AssetBundleLoadManagerUIAfterDestroyWindow.png" alt="AssetBundleLoadManagerUIAfterDestroyWindow"></p>
<ol start="9">
<li>等待回收检测回收后<br><img src="/img/Unity/AssetBundle-Framework/AssetBundleLoadManagerUIAfterUnloadAB.png" alt="AssetBundleLoadManagerUIAfterUnloadAB"><br>上述资源在窗口销毁后，满足了可回收的三大条件(1. 索引计数为0 2. 绑定对象为空 3. NormalLoad加载方式)，最终被成功回收。</li>
</ol>
<p>Note:</p>
<p>读者可能注意到shaderlist索引计数为0，也没绑定对象，但没有被卸载，这是因为shaderlist是被我预加载以常驻资源的形式加载进来的(PermanentLoad)，所以永远不会被卸载。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 加载常驻Shader</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onLoadPermanentShaderList</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    DIYLog.Log(<span class="string">&quot;onLoadPermanentShaderList()&quot;</span>);</span><br><span class="line">    ResourceManager.Singleton.loadAllShader(<span class="string">&quot;shaderlist&quot;</span>, () =&gt;</span><br><span class="line">    &#123;</span><br><span class="line">    &#125;,</span><br><span class="line">    ResourceLoadType.PermanentLoad);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="新版AssetBundle打包"><a href="#新版AssetBundle打包" class="headerlink" title="新版AssetBundle打包"></a>新版AssetBundle打包</h3><p>新版资源打包将支持:</p>
<ol>
<li><p><strong>打包AB的策略由抽象的目录打包策略设定决定</strong></p>
</li>
<li><p><strong>打包后的AB保留目录结构，确保AB模式和AssetDatabase模式加载都面向Asset路径保持一致性</strong></p>
</li>
<li><p><strong>支持打包策略级别的AB压缩格式设置(Note: 仅限使用ScriptableBuildPipeline打包模式)。老版AB打包流程AB压缩格式默认由打包面板压缩格式设置决定。</strong></p>
</li>
<li><p><strong>不支持AB变体功能(ScriptableBuildPipeline也不支持变体功能)，AB后缀名统一由打包和加载平台统一添加</strong></p>
</li>
<li><p><strong>老版AB依赖信息采用原始打包输出的*Manifest文件。新版ScriptableBuildPipeline采用自定义输出打包的CompatibilityAssetBundleManifest文件。</strong></p>
</li>
</ol>
<p>设计主要参考:</p>
<p><a target="_blank" rel="noopener" href="https://github.com/gmhevinci/MotionFramework">MotionFramework</a></p>
<p>核心AB打包思想和流程:</p>
<ol>
<li>通过抽象纯虚拟的打包策略设置(即AB收集打包策略设置界面–设置指定目录的打包策略)，做到AB打包策略设置完全抽象AB名字设置无关化(这样一来无需设置AB或清除AB名字，自己完全掌控AB打包策略和打包结论)</li>
<li>打包时分析打包策略设置的所有有效资源信息，统计出所有有效资源的是否参与打包以及依赖相关等信息，然后结合所有的打包策略设置分析出所有有效Asset的AB打包名字(如果Asset满足多个打包策略设置，默认采用最里层的打包策略设置，找不到符合的采用默认收集打包规则)<strong>(这一步是分析关键，下面细说一下详细步骤)</strong><ul>
<li>通过自定义设置的打包策略得到所有的有效参与打包路径列表</li>
<li>通过AssetDatabase.FindAssets()结合打包路径列表得出所有需要分析的Asset</li>
<li>通过打包配置信息分析所有Asset是否参与打包以及相关打包信息，得出最终的打包信息列表List<AssetBundleBuildInfo></li>
<li>在最后分析得出最后的打包结论之前，这里我个人将AB的依赖信息文件(AssetBuildInfo.asset)的生成和打包信息单独插入在这里，方便AB依赖信息可以跟AB资源一起构建参与热更</li>
<li>最后根据分析得出的打包信息列表List<AssetBundleBuildInfo>构建真真的打包信息List<AssetBundleBuild>进行打包</li>
<li>AB打包完成后进行一些后续的特殊资源处理(比如视频单独打包。AB打包的依赖文件删除(个人采用自定义生成的AssetBuildInfo.Asset作为依赖加载信息文件)。循环依赖检查。创建打包说明文件等。)</li>
</ul>
</li>
<li>不同的打包规则通过反射创建每样一个来实现获取对应打包规则的打包AB名字结论获取(采用全路径AB名的方式，方便快速查看资源打包分布)</li>
<li>然后根据所有有效Asset的所有AB名字打包结论来分析得出自定义的打包结论(即哪些Asset打包到哪个AB名里)</li>
<li>接着根据Asset的AB打包结论来生成最新的AssetBuildInfo(Asset打包信息，可以理解成我们自己分析得出的Manifest文件，用于运行时加载作为资源加载的基础信息数来源)(手动将AssetBuildInfo添加到打包信息里打包成AB，方便热更新走统一流程)</li>
<li>最后采用BuildPipeline.BuildAssetBundles(输出目录, 打包信息列表, ……)的接口来手动指定打包结论的方式触发AB打包。</li>
</ol>
<p>AB打包策略支持了如下几种:</p>
<ol>
<li>按目录打包(打包策略递归子目录判定)</li>
<li>按文件打包(打包策略递归子目录判定)</li>
<li>按固定名字打包(扩展支持固定名字打包–比如所有Shader打包到shaderlist)(打包策略递归子目录判定)</li>
<li>按文件或子目录打包(打包策略递归子目录判定，设定目录按文件打包，其他下层目录按目录打包)</li>
<li>不参与打包(打包策略递归子目录判定)</li>
</ol>
<p>这里先简单的看下新的AB搜集和打包界面:</p>
<p><img src="/img/Unity/AssetBundle-Framework/AssetBundleCollectWindow.PNG" alt="AssetBundleCollectWindow"></p>
<p><img src="/img/Unity/AssetBundle-Framework/AssetBundleBuildWindow.PNG" alt="AssetBundleBuildWindow"></p>
<p>关于Asset路径与AB路径关联信息存在一个叫assetbundlebuildinfo.asset的ScriptableObejct里(单独打包到assetbuildinfo的AB里)，通过Asset路径如何加载到对应AB的关键就在这里。这里和MotionFramework自定义Manifest文件输出不一样，assetbundlebuildinfo.asset只记录AssetPath和AB相关信息映射，不记录AB依赖信息，依赖信息依然采用AB打包生成的*Manifest文件，同时assetbundlebuildinfo.asset采用打包AB的方式（方便和热更新AB走一套机制）</p>
<p>让我们先来看下大致数据信息结构:</p>
<p><img src="/img/Unity/AssetBundle-Framework/AssetBundleBuildInfoView1.PNG" alt="AssetBundleBuildInfoView1"></p>
<p><img src="/img/Unity/AssetBundle-Framework/AssetBundleBuildInfoView2.PNG" alt="AssetBundleBuildInfoView2"></p>
<p><strong>2022&#x2F;1&#x2F;26支持了资源打包后缀名黑名单可视化配置+资源名黑名单可视化配置</strong></p>
<p><img src="/img/Unity/AssetBundle-Framework/PostFixBlackListAndAssetNameBlackList.PNG" alt="PostFixBlackListAndAssetNameBlackList"></p>
<p><strong>2023&#x2F;2&#x2F;8底层支持了新版ScriptableBuildPipeline打包工具打包，加快打包速度(需添加SCRIPTABLE_ASSET_BUILD_PIPELINE宏)</strong></p>
<h4 id="Scriptable-Build-Pipeline"><a href="#Scriptable-Build-Pipeline" class="headerlink" title="Scriptable Build Pipeline"></a>Scriptable Build Pipeline</h4><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Packages/com.unity.scriptablebuildpipeline@1.20/manual/index.html">The Scriptable Build Pipeline (SBP) package allows you to control how Unity builds content. The package moves the previously C++-only build pipeline code to a public C# package with a pre-defined build flow for building AssetBundles. The pre-defined AssetBundle build flow reduces build time, improves incremental build processing, and provides greater flexibility than before.</a></p>
<p>从介绍可以看出Scriptable Build Pipeline是官方推出的新一代Asset Bundle自定义打包管线系统，主要是为了<strong>增加AB打包自由度和减少AB打包时间</strong>。</p>
<p>从老版BuildPipeline.BuildAssetBundles(*)自定义分析打包升级到Scriptable Build Pipeline自定义分析打包，注意事项:</p>
<ol>
<li>老版打包参数走BuildAssetBundleOptions设置，SBP打包参数走BundleBuildParameters设置</li>
<li>AB打包结论都是基于自定义分析得到的List<AssetBundleBuild>，<strong>只不过SBP通过自定义分析的List<AssetBundleBuild>构建BundleBuildContent指定AB打包策略</strong></li>
<li>老版BuildPipeline.BuildAssetBundles(<em>)打包依赖信息是通过输出一个</em>Manifest文件来记录AB依赖信息的，而SBP打包依赖信息是通过打包返回的IBundleBuildResults获取打包Bundle信息后构建自定义CompatibilityAssetBundleManifest数据对象实现类*Manifest依赖信息文件。(<strong>所以SBP自定义AB打包完成后，我们需要创建CompatibilityAssetBundleManifest文件后再单独打包AB</strong>)</li>
</ol>
<p>SBP自定义打包代码:</p>
<p>AssetBundleBuilder.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 执行新版Scriptable Build Pipeline AB打包</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;outputDirectory&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;buildSuccess&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">DoSBPAssetBundleBuild</span>(<span class="params"><span class="built_in">string</span> outputDirectory, <span class="keyword">out</span> <span class="built_in">bool</span> buildSuccess</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> buildParams = MakeBuildParameters();</span><br><span class="line">    IBundleBuildResults results;</span><br><span class="line">    SBPAssetBundleBuilder.BuildAllAssetBundles(<span class="keyword">this</span>, outputDirectory, BuildTarget, buildParams, mAllAssetBundleBuildList, <span class="keyword">out</span> buildSuccess, <span class="keyword">out</span> results);</span><br><span class="line">    CreateSBPReadmeFile(outputDirectory, results);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 获取构建参数</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> CustomBuildParameters <span class="title">MakeBuildParameters</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    CustomBuildParameters bundleBuildParameters = <span class="keyword">new</span> CustomBuildParameters(BuildTarget, BuildTargetGroup, OutputDirectory);</span><br><span class="line">    <span class="comment">//bundleBuildParameters.CacheServerHost = &quot;&quot;;</span></span><br><span class="line">    <span class="comment">//bundleBuildParameters.CacheServerPort = ;</span></span><br><span class="line">    bundleBuildParameters.BundleCompression = GetConfigBuildCompression();</span><br><span class="line">    <span class="keyword">if</span> (IsForceRebuild)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 是否增量打包</span></span><br><span class="line">        bundleBuildParameters.UseCache = !IsForceRebuild;</span><br><span class="line">    &#125;</span><br><span class="line">    bundleBuildParameters.ContiguousBundles = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">if</span> (IsAppendHash)</span><br><span class="line">    &#123;</span><br><span class="line">        bundleBuildParameters.AppendHash = IsAppendHash;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (IsDisableWriteTypeTree)</span><br><span class="line">    &#123;</span><br><span class="line">        bundleBuildParameters.ContentBuildFlags |= ContentBuildFlags.DisableWriteTypeTree;</span><br><span class="line">    &#125;</span><br><span class="line">    bundleBuildParameters.ContentBuildFlags |= ContentBuildFlags.StripUnityVersion;</span><br><span class="line">    <span class="keyword">if</span> (IsIgnoreTypeTreeChanges)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// SBP不支持BuildAssetBundleOptions.IgnoreTypeTreeChanges</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 添加自定义AB压缩格式设置</span></span><br><span class="line">    <span class="keyword">foreach</span>(<span class="keyword">var</span> assetBundleBuildInfo <span class="keyword">in</span> mAllAssetBundleBuildInfoList)</span><br><span class="line">    &#123;</span><br><span class="line">        bundleBuildParameters.AddAssetBundleCompression(assetBundleBuildInfo.AssetBundleName, assetBundleBuildInfo.Compression);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> bundleBuildParameters;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>SBPAssetBundleBuilder.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 执行新版Scriptable Build Pipeline自定义AB打包</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;assetBundleBuilder&quot;&gt;</span>AB打包工具<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;outputDirectory&quot;&gt;</span>输出目录<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;buildTarget&quot;&gt;</span>打包平台<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;options&quot;&gt;</span>打包选项设置<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;allAssetBundleBuildList&quot;&gt;</span>AB打包列表<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;buildSuccess&quot;&gt;</span>打包是否成功<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;results&quot;&gt;</span>打包结果<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> CompatibilityAssetBundleManifest <span class="title">BuildAllAssetBundles</span>(<span class="params">AssetBundleBuilder assetBundleBuilder, <span class="built_in">string</span> outputDirectory, BuildTarget buildTarget, CustomBuildParameters buildParams, List&lt;AssetBundleBuild&gt; allAssetBundleBuildList, <span class="keyword">out</span> <span class="built_in">bool</span> buildSuccess, <span class="keyword">out</span> IBundleBuildResults results</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    ScriptableBuildPipeline.slimWriteResults = <span class="literal">true</span>;</span><br><span class="line">    ScriptableBuildPipeline.useDetailedBuildLog = <span class="literal">false</span>;</span><br><span class="line">    ScriptableBuildPipeline.threadedArchiving = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">var</span> buildContent = <span class="keyword">new</span> BundleBuildContent(allAssetBundleBuildList);</span><br><span class="line">    ReturnCode exitCode = ContentPipeline.BuildAssetBundles(buildParams, buildContent, <span class="keyword">out</span> results);</span><br><span class="line">    buildSuccess = exitCode &gt;= ReturnCode.Success;</span><br><span class="line">    <span class="keyword">if</span> (exitCode &lt; ReturnCode.Success)</span><br><span class="line">    &#123;</span><br><span class="line">        Debug.LogError(<span class="string">$&quot;[BuildPatch] 构建过程中发生错误exitCode:<span class="subst">&#123;exitCode&#125;</span>！&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    CompatibilityAssetBundleManifest unityManifest = CreateAndBuildAssetBundleManifest(assetBundleBuilder, outputDirectory, buildParams, results, <span class="keyword">out</span> buildSuccess);</span><br><span class="line">    CheckCycleDependSBP(unityManifest);</span><br><span class="line">    <span class="keyword">return</span> unityManifest;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 创建并打包AssetBundleManifest</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Note:</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 1. 新版Scriptable Build Pipeline打包没有AssetBundleManifest文件，需要自己创建并打包CompatibilityAssetBundleManifest兼容文件</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;assetBundleBuilder&quot;&gt;</span>AB打包工具<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;outputDirectory&quot;&gt;</span>输出目录<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;buildParams&quot;&gt;</span>打包参数<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;results&quot;&gt;</span>打包结果<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;buildSuccess&quot;&gt;</span>打包是否成功<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> CompatibilityAssetBundleManifest <span class="title">CreateAndBuildAssetBundleManifest</span>(<span class="params">AssetBundleBuilder assetBundleBuilder, <span class="built_in">string</span> outputDirectory, CustomBuildParameters buildParams, IBundleBuildResults results, <span class="keyword">out</span> <span class="built_in">bool</span> buildSuccess</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> outputDirectoryFullPath = Path.GetFullPath(outputDirectory);</span><br><span class="line">    <span class="keyword">var</span> outputDirectoryInfo = <span class="keyword">new</span> DirectoryInfo(outputDirectoryFullPath);</span><br><span class="line">    <span class="keyword">var</span> manifestName = outputDirectoryInfo.Name;</span><br><span class="line">    <span class="keyword">var</span> manifest = ScriptableObject.CreateInstance&lt;CompatibilityAssetBundleManifest&gt;();</span><br><span class="line">    manifest.SetResults(results.BundleInfos);</span><br><span class="line">    <span class="keyword">var</span> manifestPath = buildParams.GetOutputFilePathForIdentifier(<span class="string">$&quot;<span class="subst">&#123;manifestName&#125;</span>.manifest&quot;</span>);</span><br><span class="line">    Debug.Log(<span class="string">$&quot;manifestPath:<span class="subst">&#123;manifestPath&#125;</span>&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> manifestAssetFolderPath = <span class="string">$&quot;Assets/SBPBuildManifest/<span class="subst">&#123;buildParams.Target&#125;</span>&quot;</span>;</span><br><span class="line">    <span class="keyword">if</span>(!Directory.Exists(manifestAssetFolderPath))</span><br><span class="line">    &#123;</span><br><span class="line">        Directory.CreateDirectory(manifestAssetFolderPath);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> manifestAssetFilePath = Path.Combine(manifestAssetFolderPath, <span class="string">$&quot;<span class="subst">&#123;manifestName&#125;</span>.asset&quot;</span>);</span><br><span class="line">    AssetDatabase.CreateAsset(manifest, manifestAssetFilePath);</span><br><span class="line">    AssetDatabase.SaveAssets();</span><br><span class="line">    AssetDatabase.Refresh();</span><br><span class="line">    <span class="keyword">var</span> buildContent = <span class="keyword">new</span> BundleBuildContent(<span class="keyword">new</span>[]</span><br><span class="line">                                              &#123;</span><br><span class="line">                                                  <span class="keyword">new</span> AssetBundleBuild()</span><br><span class="line">                                                  &#123;</span><br><span class="line">                                                      assetBundleName = manifestName,</span><br><span class="line">                                                      assetBundleVariant = assetBundleBuilder.GetAssetBuildBundleVariant(manifestAssetFilePath),</span><br><span class="line">                                                      assetNames = <span class="keyword">new</span>[] &#123; manifestAssetFilePath &#125;,</span><br><span class="line">                                                      <span class="comment">// Manifest的Asset名强制用固定名字</span></span><br><span class="line">                                                      addressableNames = <span class="keyword">new</span>[] &#123; ResourceConstData.AssetBundleManifestAssetName &#125;,</span><br><span class="line">                                                  &#125;</span><br><span class="line">                                              &#125;);</span><br><span class="line">    <span class="keyword">var</span> exitCode = ContentPipeline.BuildAssetBundles(buildParams, buildContent, <span class="keyword">out</span> _);</span><br><span class="line">    buildSuccess = exitCode &gt;= ReturnCode.Success;</span><br><span class="line">    <span class="keyword">if</span>(exitCode &lt; ReturnCode.Success)</span><br><span class="line">    &#123;</span><br><span class="line">        Debug.LogError(<span class="string">$&quot;打包AssetBundleManifest失败！eixtCode:<span class="subst">&#123;exitCode&#125;</span>&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    Debug.Log(<span class="string">$&quot;AB的Manifest打包成功！&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> manifest;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>详情代码参考Github源码：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/TonyTang1990/AssetBundleLoadManager">AssetBundleLoadManager</a></p>
<p>Note:</p>
<ol>
<li><strong>并非老版所有的功能SBP都支持，具体区别参考:<a target="_blank" rel="noopener" href="https://docs.unity3d.com/Packages/com.unity.scriptablebuildpipeline@1.20/manual/UpgradeGuide.html">SBP Upgrade Guide</a></strong></li>
<li><strong>Scriptable Build Pipeline不支持变体功能</strong></li>
<li><strong>打包参数*StripUnityVersion个人测试SBP不起作用，原因不明</strong></li>
<li><strong>自定义AB打包时，AssetBundleBuild.assetNames必须传Asset全路径(Assets&#x2F;<em>&#x2F;</em>&#x2F;*)</strong></li>
<li><strong>自定义AB打包时，AssetBundleBuild.addressableNames传Asset全路径后，老版AB打包支持Asset加载使用多种加载方式(e.g. 全路径，文件名，文件名带后缀等)，但SBP  AB打包只支持按打包测AssetBundleBuild.addressableNames传设置的方式加载Asset</strong></li>
<li><strong>个人测试完全删除所有缓存AB重打的前提下，只对比AB打包这一步，SBP比老版AB打包速度要快10倍左右</strong></li>
</ol>
<h3 id="新版资源热更新流程"><a href="#新版资源热更新流程" class="headerlink" title="新版资源热更新流程"></a>新版资源热更新流程</h3><h4 id="类说明-1"><a href="#类说明-1" class="headerlink" title="类说明"></a>类说明</h4><p>热更类：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- HotUpdateModuleManager.cs(热更新管理模块单例类)</span><br><span class="line">- TWebRequest.cs(资源下载http抽象类)</span><br></pre></td></tr></table></figure>

<p>版本信息类：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- VersionConfigModuleManager.cs(版本管理模块单例类)</span><br><span class="line">- VersionConfig.cs(版本信息抽象类)</span><br></pre></td></tr></table></figure>

<h4 id="功能支持"><a href="#功能支持" class="headerlink" title="功能支持"></a>功能支持</h4><ol>
<li>支持游戏内版本强更(完成 – 暂时限Android，IOS待测试)</li>
<li>支持游戏内资源热更(完成 – 暂时限Android， IOS待测试)</li>
<li>支持游戏内代码热更(未做)</li>
</ol>
<h4 id="热更测试说明"><a href="#热更测试说明" class="headerlink" title="热更测试说明"></a>热更测试说明</h4><p>之前是使用的<a target="_blank" rel="noopener" href="http://www.rejetto.com/hfs/">HFS</a>快速搭建的一个资源本地资源服务器，后来使用阿里的ISS静态资源服务器做了一个网络端的资源服务器。</p>
<p>版本强更流程：</p>
<ol>
<li>比较包内版本信息和包外版本信息检查是否强更过版本</li>
<li>如果强更过版本清空包外相关信息目录</li>
<li>通过资源服务器下载最新服务器版本信息(ServerVersionConfig.json)和本地版本号作对比，决定是否强更版本</li>
<li>结合最新版本号和资源服务器地址(Json配置)拼接出最终热更版本所在的资源服务器地址</li>
<li>下载对应版本号下的强更包并安装</li>
<li>安装完成，退出游戏重进</li>
</ol>
<p>资源热更流程：</p>
<ol>
<li><p>初始化本地热更过的资源列表信息(暂时存储在:Application.persistentDataPath + “&#x2F;ResourceUpdateList&#x2F;ResourceUpdateList.txt”里)</p>
</li>
<li><p>通过资源服务器下载最新服务器版本信息(ServerVersionConfig.json)和本地资源版本号作对比，决定是否资源热更</p>
</li>
<li><p>结合最新版本号，最新资源版本号和资源服务器地址(Json配置)拼接出最终资源热更所在的资源服务器地址</p>
</li>
<li><p>下载对应地址下的AssetBundleMD5.txt(里面包含了对应详细资源MD5信息)</p>
<p>AssetBundleMD5.txt</p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">assetbuildinfo.bundle|ca830d174533e87efad18f1640e5301d</span><br><span class="line">shaderlist.bundle|2ac2d75f7d91fda7880f447e21b2e289</span><br><span class="line">******</span><br></pre></td></tr></table></figure>
</li>
<li><p>根据比较对应地址下的AssetBundleMD5.txt里的资源MD5信息和本地资源MD5信息(包外的MD5信息优先)得出需要更新下载的资源列表</p>
</li>
<li><p>根据得出的需要更新的资源列表下载对应资源地址下的资源并存储在包外(Application.persistentDataPath + “&#x2F;Android&#x2F;“)，同时写入最新的资源MD5信息文件(本地AssetBundleMD5.txt)到本地</p>
</li>
<li><p>直到所有资源热更完成，退出重进游戏</p>
</li>
</ol>
<h4 id="流程图"><a href="#流程图" class="headerlink" title="流程图"></a>流程图</h4><p><img src="/img/Unity/HotUpdate/HotUpdateFlowChat.png" alt="HotUpdateFlowChat"></p>
<h4 id="热更新辅助工具"><a href="#热更新辅助工具" class="headerlink" title="热更新辅助工具"></a>热更新辅助工具</h4><p>Tools-&gt;HotUpdate-&gt;热更新操作工具</p>
<p><img src="/img/Unity/HotUpdate/HotUpdateToolsUI.png" alt="HotUpdateToolsUI"></p>
<p>主要分为以下2个阶段：</p>
<ul>
<li><p>热更新准备阶段:</p>
<ol>
<li>每次资源打包会在包内Resource目录生成一个AssetBundleMd5.txt文件用于记录和对比哪些资源需要热更</li>
</ol>
<p>​    <img src="/./img/Unity/HotUpdate/AssetBundleMD5File.png" alt="AssetBundleMD5File"></p>
<ol start="2">
<li>执行热更新准备操作，生成热更新所需服务器最新版本信息文件(ServerVersionConfig.json)并将包内对应平台资源拷贝到热更新准备目录</li>
</ol>
<p><img src="/./img/Unity/HotUpdate/HotUpdatePreparationFolder.png" alt="HotUpdatePreparationFolder"></p>
</li>
<li><p>热更新判定阶段</p>
<ol>
<li><p>初始化包内(AssetBundleMd5.txt)和包外(AssetBundleMd5.txt)热更新的AssetBundle MD5信息(先读包内后读包外以包外为准)</p>
</li>
<li><p>游戏运行拉去服务器版本和资源版本信息进行比较是否需要版本强更或资源热更新</p>
</li>
<li><p>需要资源热更新则拉去对应最新资源版本的资源MD5信息文件(AssetBundleMD5.txt)进行和本地资源MD5信息进行比较判定哪些资源需要热更新</p>
</li>
<li><p>拉去所有需要热更新的资源，完成后进入游戏</p>
</li>
</ol>
</li>
</ul>
<p>Note:</p>
<ol>
<li>每次打包版本时会拷贝一份AssetBundleMD5.txt到打包输出目录(保存一份方便查看每个版本的资源MD5信息)</li>
</ol>
<h4 id="热更包外目录结构"><a href="#热更包外目录结构" class="headerlink" title="热更包外目录结构"></a>热更包外目录结构</h4><p>PersistentAsset -&gt; HotUpdate -&gt; Platform(资源热更新目录)<br>PersistentAsset -&gt; HotUpdate -&gt; AssetBundleMd5.txt(记录热更新的AssetBundle路径和MD5信息–兼顾进游戏前资源热更和动态资源热更)(格式:热更AB路径:热更AB的MD5&#x2F;n热更AB路径:热更AB的MD5******)<br>PersistentAsset -&gt; Config -&gt; VersionConfig.json(包外版本信息–用于进游戏前强更和热更判定)</p>
<p>PersistentAsset -&gt; HotUpdate -&gt; 版本强更包</p>
<h2 id="资源辅助工具"><a href="#资源辅助工具" class="headerlink" title="资源辅助工具"></a>资源辅助工具</h2><p>资源辅助工具五件套：</p>
<ul>
<li><p>AB删除判定工具</p>
<p>​    <img src="/img/Unity/AssetBundle-Framework/DeleteRemovedAssetBundle.png" alt="DeleteRemovedAssetBundle"></p>
</li>
<li><p>资源依赖查看工具</p>
<p>​    <img src="/img/Unity/AssetBundle-Framework/AssetDependenciesBrowser.png" alt="AssetDependenciesBrowser"></p>
</li>
<li><p>内置资源依赖统计工具(只统计了*.mat和*.prefab，场景建议做成Prefab来统计)</p>
<p>​    <img src="/img/Unity/AssetBundle-Framework/BuildInResourceReferenceAnalyze.png" alt="BuildInResourceReferenceAnalyze"></p>
</li>
<li><p>内置资源提取工具</p>
<p>​    <img src="/img/Unity/AssetBundle-Framework/BuildInResourceExtraction.png" alt="BuildInResourceExtraction"></p>
</li>
<li><p>Shader变体搜集工具</p>
<p>​    <img src="/img/Unity/AssetBundle-Framework/ShaderVariantsCollection.png" alt="ShaderVariantsCollection"></p>
</li>
</ul>
<h2 id="AB实战总结"><a href="#AB实战总结" class="headerlink" title="AB实战总结"></a>AB实战总结</h2><ol>
<li>AB打包和加载是一个相互相存的过程。</li>
<li>Unity 5提供的增量打包只是提供了更新部分AB的打包机制，*.manifest文件里也只提供依赖的AB信息并非Asset，所以想基于Asset的重用还需要我们自己处理。</li>
<li>Unity并非所有的Asset都是采用复制而是部分采用复制，部分采用引用的形式，只有正确掌握了这一点，我们才能确保Asset真确的重用和回收。</li>
<li>打包策略是根据游戏类型，根据实际情况而定。</li>
<li>AB压缩格式选择取决于内存和加载性能以及包体大小等方面的抉择。</li>
<li>资源管理策略而言，主要分为基于Asset管理(AssetBundle.Unload(false))还是基于AB管理(AssetBundle.Unload(true))，前者容易出现内存中多份重复资源，后者需要确保严格的管理机制(比如索引计数))</li>
</ol>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a target="_blank" rel="noopener" href="https://github.com/tangzx/ABSystem">tangzx&#x2F;ABSystem</a><br><a target="_blank" rel="noopener" href="https://github.com/mr-kelly/KEngine">mr-kelly&#x2F;KEngine</a><br><a target="_blank" rel="noopener" href="https://github.com/Unity-Technologies/AssetBundles-Browser">AssetBundles-Browser</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Resource/">Resource</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Resource/">Resource</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2018/09/10/设计模式/" title="设计模式" itemprop="url">设计模式</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Tony Tang" target="_blank" itemprop="author">Tony Tang</a>
		
  <p class="article-time">
    <time datetime="2018-09-10T12:39:05.000Z" itemprop="datePublished"> 发表于 2018-09-10</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>写这篇博客的目的不再是为了一个一个单独去学习了解四人帮的设计模式(以前看四人帮的设计模式时就是这样，并没有结合游戏开发深入思考这些设计模式的真正用处和好处)。</p>
<p>本篇博客的侧重点是针对实战游戏开发过程中用到的设计模式进行深入学习了解(<em>能够运用在实际项目中的东西才是真正能发挥价值的</em>)。</p>
<p>下面几个问题，是本篇博客需要解答的疑问：</p>
<ol>
<li>为什么需要****设计模式？</li>
<li>***设计模式会给游戏开发带来什么好处？</li>
<li>什么情况下适合在实际项目中使用***模式？</li>
</ol>
<p>接下来本文将结合《Game-Programming-Patterns》书籍以及项目实战开发过程中遇到的问题就游戏编程模式而言进行深入学习和分析理解。</p>
<p>《Game-Programming-Patterns》的作者是Bob Nystrom，一个在EA工作了8年的游戏程序开发者。<br>下面给出官方网站链接:<br><a target="_blank" rel="noopener" href="http://gameprogrammingpatterns.com/">Game-Programming-Patterns</a></p>
<p>Note:<br>后面加上””号的内容表示是从书里截取的内容。</p>
<h2 id="游戏架构"><a href="#游戏架构" class="headerlink" title="游戏架构"></a>游戏架构</h2><p>为什么这里要提游戏架构了？<br>作为程序员在写代码的过程中，会发现整个游戏有很多模块，这些模块各自负责不同的功能，所有模块整合到一起才组成了完整的游戏框架。</p>
<p>一个游戏并不是把所有的代码都编写在一个main函数里就能完成的，这样的代码既不具有可读性也不具备扩展性以及维护性。</p>
<p>而游戏架构就是为了让游戏开发变得高度可扩展，可读性高，降低维护成本等。在一个好的游戏架构上编写实现一个功能可能只需要修改很少几处或者添加很少几处代码即可完成。而不好的游戏架构可能会导致你编写了上千行代码去实现一个小功能(这里无论是维护成本还是理解成本都是不能接受的)。</p>
<p>“好的设计意味着当我作出改动，整个程序就好像正等着这种改动。我可以加使用几个函数调用完成任务，而代码库本身无需改动。”</p>
<p>解耦对于上面提到的扩展性和维护成本起到了关键作用，后面会详细学习了解。</p>
<p>下面再引用一句作者对于软件架构的目标的话:<br>“最小化在编写代码前需要了解的信息。”</p>
<p>落实到真正的游戏开发过程中，我们往往要考虑开发周期，开发成本，游戏设计复杂度等，不是说任何游戏开发都往复杂的好的游戏架构上去设计就是正确的，也要结合实际情况分析。(但对于大型游戏开发，好的架构一般来说是必不可少的)</p>
<p>下面是作者给出的几个建议；</p>
<ol>
<li>“抽象和解耦让扩展代码更快更容易，但除非确信需要灵活性，否则不要在这上面浪费时<br>间。”</li>
<li>“在整个开发周期中考虑并为性能设计，但是尽可能推迟那些底层的，基于假设的优化，<br>那会锁死代码。”</li>
<li>“快速地探索游戏的设计空间，但不要跑的太快，在身后留下烂摊子。毕竟，你总得回来<br>打扫。”</li>
<li>“如果打算抛弃这段代码，就不要尝试将其写完美。摇滚明星将旅店房间弄得一团糟，因<br>为他们知道明天他们就走人了。”</li>
<li>“如果你想要做出让人享受的东西，那就享受做它的过程。”</li>
</ol>
<h2 id="游戏设计模式"><a href="#游戏设计模式" class="headerlink" title="游戏设计模式"></a>游戏设计模式</h2><p>接下来我们将结合游戏开发，实战分析学习设计模式带来的好处和实际运用的地方。</p>
<h3 id="命令模式"><a href="#命令模式" class="headerlink" title="命令模式"></a>命令模式</h3><p>首先看看作者是如何定义命令模式的：<br>“命令是具现化的方法调用。”</p>
<p>再看看四人帮是如何定义命令模式的:<br>“Encapsulate a request as an object, thereby letting users parameterize clients with different requests, queue or log requests, and support undoable operations”(将一个请求封装为一个对象，从而使你可用不同的请求对客户进行参数化； 对请求排队或记录请求日志，以及支持可撤销的操作。)</p>
<p>看完定义后更加糊涂了，让我们还是结合实例来学习理解。<br>假设我们通过不同的按键点击去控制玩家的行为，不考虑任何扩展性的前提下我们可能写出下面的代码：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> InputHandler::handleInput()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span>(Input.GetKeyDown(KEY_A))</span><br><span class="line">    &#123;</span><br><span class="line">        Attack();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(Input.GetKeyDown(KEY_SPACE))</span><br><span class="line">    &#123;</span><br><span class="line">        Jump();        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的硬编码确实实现了我们的功能需求，但当我们想改变按键所代表的行为时(比如玩家配置修改按钮功能)，我们会发现上面的代码没法满足需求，因为我们硬编码写死了指定按钮的行为。</p>
<p>我们需要支持按钮动态绑定行为的功能，这时命令模式就起作用了，命令模式把游戏行为封装成对象，通过动态绑定不同的命令可以实现同一按钮实现不同的行为。<br>首先我们需要定义一个命令基类：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> absctract <span class="keyword">class</span> <span class="title">Command</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">execute</span>()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后实现对应行为的命令类：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">AttackCommand</span> : <span class="title">Command</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">execute</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        Attack();</span><br><span class="line">    &#125;    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">JumpCommand</span> : <span class="title">Command</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">execute</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        Jump();</span><br><span class="line">    &#125;    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>此时我们响应输入不再是直接执行特定行为，而是执行绑定在按钮上的命令：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">InputHandler</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> Command Key_A;</span><br><span class="line">    <span class="keyword">private</span> Command Key_Space;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 绑定命令的方法(用于支持动态修改按钮行为绑定)</span></span><br><span class="line">    <span class="comment">// **********</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleInput</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(Input.GetKeyDown(KEY_A))</span><br><span class="line">        &#123;</span><br><span class="line">            Key_A.execute();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(Input.GetKeyDown(KEY_SPACE))</span><br><span class="line">        &#123;</span><br><span class="line">            Key_Space.execute();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>玩家配置按钮行为，在代码里的表现就只是对于Key_A和Key_Space进行不同的行为命令绑定即可，因为我们把<em>请求对象化</em>了(四人帮里提到的定义)，所以可以通过动态绑定对象来绑定不同的命令实现动态绑定行为。</p>
<p>上面的代码还有个问题就是特定命令里的行为并不知道需要表现指定行为的对象，上面的写法是属于全局访问的一种形式，这样做耦合度太高且不灵活。<br>还记得四人帮定义里提到请求对象化后可以<em>对客户参数化</em>，这里的客户就是我们要服务要表现的行为对象。</p>
<p>因为我们把<em>请求对象化</em>了，那么我们对于请求的执行添加一些额外的信息也就是对于命令进行传参的问题：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title">Command</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">execute</span>(<span class="params">GameActor actor</span>)</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">JumpCommand</span> : <span class="title">Command</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">execute</span>(<span class="params">GameActor actor</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        actor.Jump();</span><br><span class="line">    &#125;    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Command* command = inputHandler.handleInput();</span><br><span class="line"><span class="keyword">if</span> (command)</span><br><span class="line">&#123;</span><br><span class="line">    command-&gt;execute(actor);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样一来我们的命令请求就知道应该是对谁做行为操作了。</p>
<p>通过命令模式，我们在按钮和角色操作之间增加了一层重定向，使我们可以通过按钮操作任何角色的行为(只需向命令传入不同的角色即可)。</p>
<p>在真正的实战游戏开发中，角色的AI会使用命令模式，这样一来可以对于所有的角色重用命令行为，而且通过模拟命令队列，我们可以实现AI行为队列的功能(一个行为接一个行为)。这个后续会结合Behavior Designer插件学习来进一步深入了解：</p>
<p>待续……</p>
<p>Note:</p>
<ol>
<li>我们不止可以通过定义类(Command)实现请求对象化，我们也可以通过闭包的形式把请求转化成可返回的函数对象来实现请求对象化。这里需要了解<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/c3c08c621aa1">第一公民函数</a>等概念。</li>
<li>命令模式可以让我们轻易做到撤销和重做的功能。</li>
</ol>
<h3 id="框架模式"><a href="#框架模式" class="headerlink" title="框架模式"></a>框架模式</h3><p>关于框架模式最初了解过MVC，只知道是为了解耦数据，显示以及控制逻辑的一种模式。<br>后来陆陆续续了解到还有MVP,MVVM等模式。<br>为什么会有这么多MV**的框架模式了？<br>核心思想是通过解决M和V的耦合问题来实现界面分离。</p>
<p>接下来我们重点要学习了解MVC和MVVM模式以及实战运用，MVP会简单带过。</p>
<p>参考博客 :<br><a target="_blank" rel="noopener" href="http://www.cnblogs.com/keitsi/p/5764785.html">谈谈对MVC、MVP和MVVM的理解</a><br><a target="_blank" rel="noopener" href="https://draveness.me/mvx">谈 MVC、MVP 和 MVVM 架构模式</a><br><a target="_blank" rel="noopener" href="https://juejin.im/entry/590ae83b5c497d005855988d">Unity 应用架构设计—— MVVM 模式的设计和实施 (Part 1)</a><br><a target="_blank" rel="noopener" href="https://juejin.im/post/5b041882f265da0b9348a4de">mvc的实现</a></p>
<h4 id="MVC"><a href="#MVC" class="headerlink" title="MVC"></a>MVC</h4><p><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/MVC">MVC模式（Model–view–controller）是软件工程中的一种软件架构模式，把软件系统分为三个基本部分：模型（Model）、视图（View）和控制器（Controller）。</a></p>
<p>MVC只是一种框架模式，针对不同的平台环境的实现方式会有些区别，这里本人的理解如下：<br><img src="/img/GameDesignPattern/MVCRelationship.png" alt="MVCRelationship"></p>
<p>模型(Model): 数据结构以及数据处理等。</p>
<p>视图(View)：专注于显示，比如前端UI显示</p>
<p>控制器(Controller)：连接(解耦)模型和视图，如处理视图的请求，更新模型数据，通知视图变化等</p>
<p>这里我们结合实例动手实现一个简单的MVC模式来加深理解：<br>需求：<br>用户通过点击按钮触发一个随机数显示在文本上。</p>
<p>分析事例中的MVC：<br>视图(View)：<br><img src="/img/GameDesignPattern/MVC_View.png" alt="MVC_View"><br>负责显示最终结果。</p>
<p>模型(Model):<br>负责存储随机数数据。</p>
<p>控制器(Controller):<br>负责响应View的点击事件，处理随机数逻辑，修改Model里的随机数数据，通知View更新显示。</p>
<p>这里Model和View之间的更新通知我们会用到监听者模式，Model是发布者，视图是订阅者。<br>接下来看下实际的代码设计:</p>
<p>监听者模式部分：<br>ObserverBase.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 监听者模式的监听者接口</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">ObserverBase</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 用于更新监听者状态</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;subject&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">update</span>(<span class="params">SubjectBase subject</span>)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>SubjectBase.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 监听者模式，发布者父类</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">SubjectBase</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 监听者列表</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> List&lt;ObserverBase&gt; mObserverList;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SubjectBase</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mObserverList = <span class="keyword">new</span> List&lt;ObserverBase&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span> 添加监听者 <span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;observer&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">addObserver</span>(<span class="params">ObserverBase observer</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        mObserverList.Add(observer);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span> 删除监听者 <span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;observer&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">deleteObserver</span>(<span class="params">ObserverBase observer</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        mObserverList.Remove(observer);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span> 通知所有监听者 <span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">notifyAllObserver</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">foreach</span>(<span class="keyword">var</span> obesrver <span class="keyword">in</span> mObserverList)</span><br><span class="line">        &#123;</span><br><span class="line">            obesrver.update(<span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>MVC部分：<br>UIView.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> UnityEngine.UI;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> MVC中的View，负责UI显示</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UIView</span> : <span class="title">MonoBehaviour</span>, <span class="title">ObserverBase</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Text mTxtRandomNumber;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Button mBtnRandomNumber;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Use this for initialization</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Start</span> ()</span> &#123;</span><br><span class="line">        <span class="comment">// 添加UIController对UI点击事件的响应</span></span><br><span class="line">        mBtnRandomNumber.onClick.AddListener(UIController.Instance.OnBtnRandomNumberClick);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">update</span>(<span class="params">SubjectBase subject</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// View层被通知监听对象改变了</span></span><br><span class="line">        <span class="comment">// 这里是UIModel改变了</span></span><br><span class="line">        refreshView(subject);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 刷新视图显示</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">refreshView</span>(<span class="params">SubjectBase subject</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 获取UIModel数据刷新显示</span></span><br><span class="line">        <span class="keyword">var</span> uimodel = subject <span class="keyword">as</span> UIModel;</span><br><span class="line">        mTxtRandomNumber.text = uimodel.mRandomNumber.ToString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>UIModel.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> MVC里的Model，负责存储随机数数据</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UIModel</span> : <span class="title">SubjectBase</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> UIModel Instance</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (mInstance == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                mInstance = <span class="keyword">new</span> UIModel();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> mInstance;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> UIModel mInstance;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 随机数数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> mRandomNumber;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 随机一个数字</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">randomNumber</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mRandomNumber = Random.Range(<span class="number">0</span>, <span class="number">100</span>);</span><br><span class="line">        <span class="comment">// 通知UIView更新显示</span></span><br><span class="line">        notifyAllObserver();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>UIController.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> MVC中的Controller，负责连接(解耦)模型和视图，如处理视图的请求，更新模型数据，通知视图变化等</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 逻辑部分都在这里</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UIController</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> UIController Instance</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(mInstance == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                mInstance = <span class="keyword">new</span> UIController();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> mInstance;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> UIController mInstance;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">UIController</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> UIView按钮点击事件响应</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">OnBtnRandomNumberClick</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 响应UIView按钮点击，</span></span><br><span class="line">        <span class="comment">// 修改UIModel数据，</span></span><br><span class="line">        UIModel.Instance.randomNumber();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>初始化相关代码:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">GameProgrammingPattern</span> : <span class="title">MonoBehaviour</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span> MVC里的模型 <span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> UIModel mModel;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span> MVC里的视图 <span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> UIView mView;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Awake</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 初始化MVC里的各个模块</span></span><br><span class="line">        mModel = UIModel.Instance;</span><br><span class="line">        mView = <span class="keyword">this</span>.transform.GetComponentInChildren&lt;UIView&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Start</span> ()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 添加UIView对UIModel的监听</span></span><br><span class="line">        mModel.addObserver(mView);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到我们把UIView和UIModel设计成了监听者模式用于UIModel变化时通知UIView刷新显示。<br>通过划分V和M，把视图和数据严格分离开，视图只关心显示，模型只关心数据，其他所有的操作变化都是通过控制器去处理。</p>
<p>分析：</p>
<ol>
<li>上面的MVC里V和M并没有完全解耦，视图依然依赖于模型的数据来显示(当然我们可以通过回调注册替换监听者模式的形式去实现V和M的完全解耦)。(参考: <a target="_blank" rel="noopener" href="https://blog.csdn.net/frank901/article/details/72847352"><br>Unity3D用MVC框架思想实现的小例子</a>)</li>
<li>V和M的解耦，让我们可以重复利用M和V，只要控制器处理好V和M逻辑即可。(比如View不变，改变Model数据来源，我们重新编写一个新的Contoller去处理View和新的Model之间的逻辑关系就能实现对View的重用。反之Model重用同理。)</li>
<li>正因为V和M的解耦，所有逻辑相关处理都在C里，使得C看起来过于臃肿。</li>
</ol>
<p>问题：</p>
<ol>
<li>UI操作和数据原本就是大量交互在一起的，使用MVC使V和M分离，使得代码显的过于复杂，Controller这一层过于臃肿，对于后期维护并不友好。</li>
<li>游戏开发中，大部分时候UI变化很大，View层的重用不太现实。</li>
</ol>
<p>下面给出知乎上对于游戏里使用MVC模式的讨论(本人比较认同flashyiyi的分析)：<br><a target="_blank" rel="noopener" href="https://www.zhihu.com/question/23946609">如何在Unity中实现MVC模式？</a></p>
<p>结论：<br>游戏开发需要根据项目需求制定合理的框架设计，并非一种MVC就能包治百病，过度的设计有时候会带来可读性和维护性上的大大降低，Pure MVC并不适用于大部分游戏开发。</p>
<h4 id="MVP"><a href="#MVP" class="headerlink" title="MVP"></a>MVP</h4><p><img src="/img/GameDesignPattern/MVPRelationship.png" alt="MVPRelationship"><br><a target="_blank" rel="noopener" href="http://www.cnblogs.com/keitsi/p/5764785.html">MVP用展示器代替了控制器，而展示器是可以直接更新视图，所以MVP中展示器可以处理视图的请求并递送到模型又可以根据模型的变化更新视图，实现了视图和模型的完全分离。</a></p>
<h4 id="MVVM"><a href="#MVVM" class="headerlink" title="MVVM"></a>MVVM</h4><p><a target="_blank" rel="noopener" href="http://www.cnblogs.com/keitsi/p/5764785.html">MVVM是MVP更进一步的发展，把软件系统分为三个基本部分：模型（Model）、视图（View）和视图模型（ViewModel），关系如下图所示：</a><br><img src="/img/GameDesignPattern/MVVMRelationship.png" alt="MVVMRelationship"></p>
<p>模型(Model): 数据结构，基础数据等(不关心业务逻辑)。</p>
<p>视图(View)：专注于显示，比如前端UI显示</p>
<p>视图模型（ViewModel）：连接模型和视图，暴露视图所关心的数据和属性，负责修改Model数据，<em>视图模型和视图是双向绑定的</em>。</p>
<p>从上面的关系图以及介绍，可以看出MVVM里V和M通过VM完全隔离开来，V的更新通过V和VM的Data Bidning(数据绑定)以及Command模式等形式触发更新显示响应等。M的修改是通过VM来操作，V只关心和VM绑定的数据用于显示，真正的数据是在M里(比如M里存的是一个玩家的名字，VM暴露给V的数据可能是一个地址+名字格式的数据形式)。</p>
<p>MVVM优缺点(来源:<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/8e3d4ab80714">MVC、MVP、MVVM架构分析与比较</a>)：<br>优点：<br>1、低耦合。View可以独立于Model变化和修改，一个ViewModel可以绑定到不同的”View”上，当View变化的时候Model可以不变，当Model变化的时候View也可以不变。<br>2、可重用性。你可以把一些视图逻辑放在一个ViewModel里面，让很多view重用这段视图逻辑。<br>3、独立开发。开发人员可以专注于业务逻辑和数据的开发（ViewModel），设计人员可以专注于页面设计，生成xml代码。<br>4、ViewModel解决MVP中View(Activity)和Presenter相互持有对方应用的问题，界面由数据进行驱动，响应界面操作无需由View(Activity)传递，数据的变化也无需Presenter调用View(Activity)实现，使得数据传递的过程更加简洁，高效。</p>
<p>缺点：<br>1、ViewModel中存在对Model的依赖。<br>2、数据绑定使得 Bug 很难被调试。你看到界面异常了，有可能是你 View 的代码有 Bug，也可能是 Model 的代码有问题。<br>3、IDE不够完善（修改ViewModel的名称对应的xml文件中不会自动修改等）。</p>
<p>关键词：</p>
<ol>
<li>Data Binding(数据绑定)</li>
<li>Event Based Programming</li>
<li>Command</li>
<li>Code Behind</li>
</ol>
<p>后面我们会实战实现一套MVVM里深入理解里面的相关概念，主要参考博客:<br><a target="_blank" rel="noopener" href="https://juejin.im/entry/590ae83b5c497d005855988d#_label3">Unity 应用架构设计—— MVVM 模式的设计和实施 (Part 1)</a></p>
<h5 id="Unity-MVVM实现"><a href="#Unity-MVVM实现" class="headerlink" title="Unity MVVM实现"></a>Unity MVVM实现</h5><p>要是在Unity里实现MVVM架构，那么我们必须先实现一套Unity里的Data Binding。</p>
<h6 id="Data-Binding-in-Unity"><a href="#Data-Binding-in-Unity" class="headerlink" title="Data Binding in Unity"></a>Data Binding in Unity</h6><p>如何在Unity里实现Data Bidning?<br>Data Binding的核心是在修改数据时能触发回调通知，能将数据和回调绑定起来。<br>明白了这一点，回顾C#里设置数据一般是通过方法或者属性或者直接访问public成员变量，要想实现回调触发，我们可以通过C#里的Property设置(set)的形式去确保回调相应。</p>
<h6 id="基础实现"><a href="#基础实现" class="headerlink" title="基础实现"></a>基础实现</h6><p>实现一个可触发回调的Property属性抽象：<br>BindableProperty.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             BindableProperty.cs</span></span><br><span class="line"><span class="comment"> * Author:                  TONYTANG</span></span><br><span class="line"><span class="comment"> * Create Date:             2018/09/15</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> BindableProperty.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 可触发回调的属性抽象</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BindableProperty</span>&lt;<span class="title">T</span>&gt; &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 属性值变化回调委托定义</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;oldvalue&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;newvalue&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">delegate</span> <span class="keyword">void</span> <span class="title">ValueChangedDelegate</span>(<span class="params">T oldvalue, T newvalue</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 属性值变化回调</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> ValueChangedDelegate OnValueChanged;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 属性</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> T Value</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> mValue;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">set</span></span><br><span class="line">        &#123;</span><br><span class="line">            T oldvalue = mValue;</span><br><span class="line">            mValue = <span class="keyword">value</span>;</span><br><span class="line">            ValueChanged(oldvalue, mValue);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> T mValue;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 属性值变化时</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;oldvalue&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;newvalue&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ValueChanged</span>(<span class="params">T oldvalue, T newvalue</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(OnValueChanged != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            OnValueChanged(oldvalue, newvalue);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样一来我们定义VM的Property时就可以按如下方式定义，然后让绑定V里的View到VM里对应的Property上即可：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">readonly</span> BindableProperty&lt;<span class="built_in">string</span>&gt; Name = <span class="keyword">new</span> BindableProperty&lt;<span class="built_in">string</span>&gt;();</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">readonly</span> BindableProperty&lt;<span class="built_in">int</span>&gt; AgeDetail = <span class="keyword">new</span> BindableProperty&lt;<span class="built_in">int</span>&gt;();</span><br></pre></td></tr></table></figure>
<p>按照VM负责和V的数据绑定以及负责M的修改，我们可以定义ViewModel如下：<br>MVVMViewModel.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             MVVMViewModel.cs</span></span><br><span class="line"><span class="comment"> * Author:                  TONYTANG</span></span><br><span class="line"><span class="comment"> * Create Date:             2018/09/15</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> MVVMViewModel.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> MVVM里的VM</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MVVMViewModel</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span> 与View里Name绑定的名字属性 <span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">readonly</span> BindableProperty&lt;<span class="built_in">string</span>&gt; Name = <span class="keyword">new</span> BindableProperty&lt;<span class="built_in">string</span>&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span> 与View里Age绑定的年纪属性 <span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">readonly</span> BindableProperty&lt;<span class="built_in">int</span>&gt; Age = <span class="keyword">new</span> BindableProperty&lt;<span class="built_in">int</span>&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span> Model数据 <span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> MVVMModel Model;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 初始化Model数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;m&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initializeModel</span>(<span class="params">MVVMModel m</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Model = m;</span><br><span class="line">        Name.Value = Model.Name;</span><br><span class="line">        Age.Value = Model.Age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 保存Model数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">saveModel</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        Model.Name = Name.Value;</span><br><span class="line">        Model.Age = Age.Value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>按照V的定义只关心视图，我们可以定义View如下：<br>MVVMView.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             MVVMView.cs</span></span><br><span class="line"><span class="comment"> * Author:                  TONYTANG</span></span><br><span class="line"><span class="comment"> * Create Date:             2018/09/15</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> UnityEngine.UI;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> MVVMView.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> MVVM里的View</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MVVMView</span> : <span class="title">MonoBehaviour</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span> Name输入文本(用于View输入改变Name) <span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> InputField mInputFieldName;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span> Name值展示文本 <span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> Text mTxtName;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span> Age值展示文本 <span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> Text mTxtAge;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span> Model数据保存按钮 <span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> Button mBtnSave;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span> View所绑定的ViewModel <span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> MVVMViewModel mViewModel;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 绑定V到指定VM</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;vm&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">bindViewModel</span>(<span class="params">MVVMViewModel vm</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        mViewModel = vm;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 初始化View(主要是V到VM之间的绑定)</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initialize</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="meta">#<span class="keyword">region</span> Bind VM to V Part</span></span><br><span class="line">        mViewModel.Name.OnValueChanged = onNameChanged;</span><br><span class="line">        mViewModel.Age.OnValueChanged = onAgeChanged;</span><br><span class="line">        <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="keyword">region</span> Bind V To VM</span></span><br><span class="line">        mInputFieldName.onValueChanged.AddListener(onInputNameChanged);</span><br><span class="line">        mBtnSave.onClick.AddListener(onSaveClick);</span><br><span class="line">        <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="keyword">region</span> Bind VM to V Part</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onNameChanged</span>(<span class="params"><span class="built_in">string</span> oldname, <span class="built_in">string</span> newname</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        mInputFieldName.text = newname;</span><br><span class="line">        mTxtName.text = newname;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onAgeChanged</span>(<span class="params"><span class="built_in">int</span> oldvalue, <span class="built_in">int</span> newvalue</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        mTxtAge.text = newvalue.ToString();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="keyword">region</span> Bind V To VM</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onInputNameChanged</span>(<span class="params"><span class="built_in">string</span> newname</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        mViewModel.Name.Value = newname;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onSaveClick</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mViewModel.saveModel();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>按照M的定义只关心数据结构定义，我们可以定义Model如下：<br>MVVMModel.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             MVVMModel.cs</span></span><br><span class="line"><span class="comment"> * Author:                  TONYTANG</span></span><br><span class="line"><span class="comment"> * Create Date:             2018/09/15</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> MVVMModel.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> MVVM里的Model</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MVVMModel</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span> 名字 <span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Name &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span> 年纪 <span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> Age &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MVVMModel</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        Name = <span class="string">&quot;TonyTang&quot;</span>;</span><br><span class="line">        Age = <span class="number">28</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来测试MVVM里的Data Binding:<br>GameProgrammingPattern.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             GameProgrammingPattern.cs</span></span><br><span class="line"><span class="comment"> * Author:                  TONYTANG</span></span><br><span class="line"><span class="comment"> * Create Date:             2018/09/15</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">GameProgrammingPattern</span> : <span class="title">MonoBehaviour</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="keyword">region</span> MVC Part</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span> MVC里的模型 <span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> UIModel mModel;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span> MVC里的视图 <span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> UIView mView;</span><br><span class="line">    <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="keyword">region</span> MVVM Part</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span> MVVM里的模型M <span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> MVVMModel mMVVMModel;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span> MVVM里的视图V <span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> MVVMView mMVVMView;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span> MVVM里的视图VM <span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> MVVMViewModel mMVVMViewModel;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span> 动态变化Age属性值频率 <span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> WaitForSeconds mAgeChangeFrequency;</span><br><span class="line">    <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Awake</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        initMonoScripts();</span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="keyword">region</span> MVC Part</span></span><br><span class="line">        <span class="comment">// 初始化MVC里的各个模块</span></span><br><span class="line">        mModel = UIModel.Instance;</span><br><span class="line">        mView = <span class="keyword">this</span>.transform.GetComponentInChildren&lt;UIView&gt;();</span><br><span class="line">        <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="keyword">region</span> MVVM Part</span></span><br><span class="line">        mMVVMViewModel = <span class="keyword">new</span> MVVMViewModel();</span><br><span class="line">        mMVVMModel = <span class="keyword">new</span> MVVMModel();</span><br><span class="line">        mMVVMView = <span class="keyword">this</span>.transform.GetComponentInChildren&lt;MVVMView&gt;();</span><br><span class="line"></span><br><span class="line">        mAgeChangeFrequency = <span class="keyword">new</span> WaitForSeconds(<span class="number">5.0f</span>);</span><br><span class="line">        <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Start</span> ()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="meta">#<span class="keyword">region</span> MVC Part</span></span><br><span class="line">        <span class="comment">// 添加UIView对UIModel的监听</span></span><br><span class="line">        mModel.addObserver(mView);</span><br><span class="line">        <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="keyword">region</span> MVVM Part</span></span><br><span class="line">        <span class="comment">// 初始化ViewModel里的Model数据</span></span><br><span class="line">        mMVVMViewModel.initializeModel(mMVVMModel);</span><br><span class="line">        <span class="comment">// 绑定View到VM上</span></span><br><span class="line">        mMVVMView.bindViewModel(mMVVMViewModel);</span><br><span class="line">        <span class="comment">// 初始化View和ViewModel的双向绑定</span></span><br><span class="line">        mMVVMView.initialize();</span><br><span class="line">        <span class="comment">// 通过携程动态使用VM修改值Age触发View变化显示</span></span><br><span class="line">        CoroutineManager.Singleton.startCoroutine(changeViewModelAgeCoroutine());</span><br><span class="line">        <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 初始化需要挂在的脚本</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initMonoScripts</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">this</span>.gameObject.AddComponent&lt;CoroutineManager&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 修改ViewModel的Age属性值携程</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function">IEnumerator <span class="title">changeViewModelAgeCoroutine</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">while</span>(<span class="literal">true</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">yield</span> <span class="keyword">return</span> mAgeChangeFrequency;</span><br><span class="line">            mMVVMViewModel.Age.Value = Random.Range(<span class="number">0</span>, <span class="number">100</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们的测试UI如下:<br><img src="/img/GameDesignPattern/MVVMPatternTestUI.png" alt="MVVMPatternTestUI"><br>InputField里动态输入文字，会看到右边的文本动态跟新了，同时下方的Age文本因为携程动态修改数据刷新显示:<br><img src="/img/GameDesignPattern/MVVMPatternExample.png" alt="MVVMPatternExample"><br>上面的表现可以看出，我们通过绑定V和VM里的数据实现了动态修改VM数据后，V自动跟着刷新显示，V变化VM自动更新，做到了数据驱动刷新显示，完全隔离了V和M。</p>
<h6 id="解耦V和VM"><a href="#解耦V和VM" class="headerlink" title="解耦V和VM"></a>解耦V和VM</h6><p>上面的实现有一个比较严重的问题，就是V和VM严重的耦合了，V里通过保存一个指定VM类型的实例对象来访问VM，如果我们想将V绑定到另一个VM的话，就发现代码需要改动才能支持，同时上面的代码是没有处理动态绑定VM时对原始VM动态绑定部分的解除。这里为了改进这一点，我们需要了解几个概念：</p>
<ol>
<li>依赖倒置原则（DIP）<br><a target="_blank" rel="noopener" href="http://www.voidcn.com/article/p-gbdebxum-bnx.html">高层模块不应依赖于低层模块，两者应该依赖于抽象。 抽象不不应该依赖于实现，实现应该依赖于抽象。</a></li>
<li>控制反转（IoC）<br><a target="_blank" rel="noopener" href="http://www.voidcn.com/article/p-gbdebxum-bnx.html">控制反转（IoC），它为相互依赖的组件提供抽象，将依赖（低层模块）对象的获得交给第三方（系统）来控制，即依赖对象不在被依赖模块的类中直接通过new来获取。</a></li>
<li>依赖注入（DI）<br><a target="_blank" rel="noopener" href="http://www.voidcn.com/article/p-gbdebxum-bnx.html">依赖注入（DI），它提供一种机制，将需要依赖（低层模块）对象的引用传递给被依赖（高层模块）对象。</a></li>
</ol>
<p>引用的文章里对几个核心概念做了如下总结，这里直接搬过来:<br><a target="_blank" rel="noopener" href="http://www.voidcn.com/article/p-gbdebxum-bnx.html">依赖倒置原则（DIP）：一种软件架构设计的原则（抽象概念）。<br>控制反转（IoC）：一种反转流、依赖和接口的方式（DIP的具体实现方式）。<br>依赖注入（DI）：IoC的一种实现方式，用来反转依赖（IoC的具体实现方式）。<br>IoC容器：依赖注入的框架，用来映射依赖，管理对象创建和生存周期（DI框架）。</a></p>
<p>上面的核心概念是高层模块不应该直接依赖底层模块，而是依赖于抽象，然后通过依赖注入的形式实现反转依赖，解耦高层模块和底层模块。</p>
<p>针对解耦V和VM，让我们修改上面的实现：<br>为了解耦V和VM，根据依赖倒置的原则，我们需要让V依赖于VM的接口而非具体的类，同时通过依赖注入的形式传入实现控制反转。<br>IMVVMView.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             IMVVMView.cs</span></span><br><span class="line"><span class="comment"> * Author:                  TONYTANG</span></span><br><span class="line"><span class="comment"> * Create Date:             2018/09/16</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> IMVVMView.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> MVVM里的V的抽象接口(抽象出V和VM之间的绑定关系)</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IMVVMView</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> MVVM里V的VM上下文</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Note:</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 通过定义VM的Interface接口类成员，实现依赖倒置</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    IMVVMViewModel mMVVMViewModelContext</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>IMVVMViewModel.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             IMVVMViewModel.cs</span></span><br><span class="line"><span class="comment"> * Author:                  TONYTANG</span></span><br><span class="line"><span class="comment"> * Create Date:             2018/09/16</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> IMVVMViewModel.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> MVVM里的VM抽象接口(实现依赖倒置，避免V和VM的高度耦合)</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IMVVMViewModel</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>为了实现ViewModel可动态绑定修改，我们还需定义一个View的父类，用于实现动态响应ViewModel的绑定修改：<br>MVVMBaseView.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             MVVMBaseView.cs</span></span><br><span class="line"><span class="comment"> * Author:                  TONYTANG</span></span><br><span class="line"><span class="comment"> * Create Date:             2018/09/16</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> MVVMBaseView.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> MVVM里的View的基类(含ViewModel的动态绑定定义以及ViewModel的接口成员定义(依赖倒置))</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MVVMBaseView</span> : <span class="title">MonoBehaviour</span>, <span class="title">IMVVMView</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 可绑定的ViewModel属性</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 用于实现V动态绑定VM</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">readonly</span> BindableProperty&lt;IMVVMViewModel&gt; ViewModelProperty = <span class="keyword">new</span> BindableProperty&lt;IMVVMViewModel&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> V的VM上下文属性接口</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> IMVVMViewModel mMVVMViewModelContext</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> ViewModelProperty.Value;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">set</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(!mIsInitialized)</span><br><span class="line">            &#123;</span><br><span class="line">                OnInitialize();</span><br><span class="line">                mIsInitialized = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            ViewModelProperty.Value = <span class="keyword">value</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> View是否初始化过</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 用于避免逻辑依赖于显示(比如绑定VM上下文属性变化回调时，依赖于View的显示)</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">protected</span> <span class="built_in">bool</span> mIsInitialized;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MVVMBaseView</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 绑定VM上下文修改回调</span></span><br><span class="line">        <span class="comment">// 避免这种写法，会导致绑定VM上下文属性变化回调依赖于显示</span></span><br><span class="line">        <span class="comment">//ViewModelProperty.OnValueChanged += OnBindingContextChanged;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 第一次初始化初始化方法</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">OnInitialize</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 绑定VM上下文修改回调</span></span><br><span class="line">        ViewModelProperty.OnValueChanged += OnBindingContextChanged;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> VM动态绑定回调</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;oldvm&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;newvm&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">OnBindingContextChanged</span>(<span class="params">IMVVMViewModel oldvm, IMVVMViewModel newvm</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>修改原来的MVVMView实现:<br>MVVMView.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             MVVMView.cs</span></span><br><span class="line"><span class="comment"> * Author:                  TONYTANG</span></span><br><span class="line"><span class="comment"> * Create Date:             2018/09/15</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> UnityEngine.UI;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> MVVMView.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> MVVM里的View</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MVVMView</span> : <span class="title">MVVMBaseView</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span> Name输入文本(用于View输入改变Name) <span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> InputField mInputFieldName;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span> Name值展示文本 <span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> Text mTxtName;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span> Age值展示文本 <span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> Text mTxtAge;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span> Model数据保存按钮 <span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> Button mBtnSave;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 真实绑定的VM对象访问入口</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> MVVMViewModel ViewModel</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> (MVVMViewModel)mMVVMViewModelContext;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 响应VM绑定变化回调</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 在这里做V和VM绑定相关的事</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;oldvm&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;newvm&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnBindingContextChanged</span>(<span class="params">IMVVMViewModel oldvm, IMVVMViewModel newvm</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">base</span>.OnBindingContextChanged(oldvm, newvm);</span><br><span class="line">        <span class="comment">// 解除老的VM相关绑定</span></span><br><span class="line">        <span class="keyword">if</span>(oldvm != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="meta">#<span class="keyword">region</span> Bind VM to V Part</span></span><br><span class="line">            MVVMViewModel ovm = oldvm <span class="keyword">as</span> MVVMViewModel;</span><br><span class="line">            ovm.Name.OnValueChanged -= onNameChanged;</span><br><span class="line">            ovm.Age.OnValueChanged -= onAgeChanged;</span><br><span class="line">            <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">            <span class="meta">#<span class="keyword">region</span> Bind V To VM</span></span><br><span class="line">            mInputFieldName.onValueChanged.RemoveListener(onInputNameChanged);</span><br><span class="line">            mBtnSave.onClick.RemoveListener(onSaveClick);</span><br><span class="line">            <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 添加新的VM相关绑定</span></span><br><span class="line">        <span class="keyword">if</span> (ViewModel != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="meta">#<span class="keyword">region</span> Bind VM to V Part            </span></span><br><span class="line">            ViewModel.Name.OnValueChanged += onNameChanged;</span><br><span class="line">            ViewModel.Age.OnValueChanged += onAgeChanged;</span><br><span class="line">            <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">            <span class="meta">#<span class="keyword">region</span> Bind V To VM</span></span><br><span class="line">            mInputFieldName.onValueChanged.AddListener(onInputNameChanged);</span><br><span class="line">            mBtnSave.onClick.AddListener(onSaveClick);</span><br><span class="line">            <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">#<span class="keyword">region</span> Bind VM to V Part</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onNameChanged</span>(<span class="params"><span class="built_in">string</span> oldname, <span class="built_in">string</span> newname</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        mInputFieldName.text = newname;</span><br><span class="line">        mTxtName.text = newname;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onAgeChanged</span>(<span class="params"><span class="built_in">int</span> oldvalue, <span class="built_in">int</span> newvalue</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        mTxtAge.text = newvalue.ToString();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="keyword">region</span> Bind V To VM</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onInputNameChanged</span>(<span class="params"><span class="built_in">string</span> newname</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        ViewModel.Name.Value = newname;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onSaveClick</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        ViewModel.saveModel();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>MVVMViewModel只需要修改来实现IMVVMViewModel即可:<br>MVVMViewModel.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MVVMViewModel</span> : <span class="title">IMVVMViewModel</span>&#123;</span><br><span class="line"></span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试代码也要跟着修改:<br>GameProgrammingPattern.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Start</span> ()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">#<span class="keyword">region</span> MVVM Part</span></span><br><span class="line">    <span class="comment">// 初始化ViewModel里的Model数据</span></span><br><span class="line">    mMVVMViewModel.initializeModel(mMVVMModel);</span><br><span class="line">    <span class="comment">// 绑定View到VM上</span></span><br><span class="line">    mMVVMView.mMVVMViewModelContext = mMVVMViewModel;</span><br><span class="line">    <span class="comment">// 通过携程动态使用VM修改值Age触发View变化显示</span></span><br><span class="line">    CoroutineManager.Singleton.startCoroutine(changeViewModelAgeCoroutine());</span><br><span class="line">    <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结果依然是正常双向绑定V和VM，实现V和M隔离，但现在我们的V不在和VM强耦合了，可以动态绑定到同类型不同的VM实例对象:<br><img src="/img/GameProgrammingPattern/MVVMPatternExampleRefactor.png" alt="MVVMPatternExampleRefactor"></p>
<h6 id="VM如何通知V"><a href="#VM如何通知V" class="headerlink" title="VM如何通知V"></a>VM如何通知V</h6><p>V和VM在MVVM里是通过数据绑定实现的双向绑定，但假设V里点击一个按钮后修改VM里的数据后并不需要更新View刷新显示，而是需要VM通知View数据处理完毕并将最新数据返回做后续处理了(比如弹窗口提示之类)？</p>
<p>这时候我们需要的是一种通知数据处理完毕后回调通知的形式，我们很容易想到的一种实现方案是传递回调的形式：<br>伪代码:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">View</span> : <span class="title">BaseView</span></span><br><span class="line">&#123;</span><br><span class="line">    ******</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onBtnClick</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mViewModel.ChangeName(newname, ChangeNameCallback);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ChangeNameCallback</span>(<span class="params"><span class="built_in">string</span> name</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// VM处理完毕后回调做后续处理</span></span><br><span class="line">    &#125;    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>但这样在View里编写Code Behind代码会导致View层被污染，导致View层包含逻辑代码。同时也打断了MVVM里ViewModel的Unit Test特性。</p>
<p>我们可以通过绑定按钮点击到ViewModel的一个Command(包含操作的数据对象以及检查是否可执行以及最终逻辑回调等)里，把逻辑部分搬到ViewModel层实现Zero Code Behind并不破坏ViewModel的Unit Test。也可以考虑直接调用VM方法在方法里写逻辑。如果是涉及到View层表现，可以考虑绑定属性，在VM写逻辑去修改对应属性触发View层表现。</p>
<p>这里并没有太弄懂Command存在的意义(和直接在VM层写逻辑的区别是什么？)，所以这里没有去实现这一套东西。</p>
<h6 id="简化V和VM绑定代码"><a href="#简化V和VM绑定代码" class="headerlink" title="简化V和VM绑定代码"></a>简化V和VM绑定代码</h6><p>从前面的事例可以看到，V和VM的绑定都是成对出现，属于有规律可循的代码(后续可以自动化代码生成来解决)，但这里我们希望解决的不是自动化代码的问题，而是提供一套更方便的代码绑定方案，解决大量复杂代码的编写。</p>
<p>实现思考:</p>
<ol>
<li>通过统一的一个类来实现简化V和VM的绑定。</li>
<li>因为要访问VM的属性对象，需要通过反射访问(没想到更好的方案)</li>
</ol>
<p>因为涉及到反射实现，这里觉得并不好(一是效率方面，二是直观上查找不到属性引用(维护方面))，不如单纯的实现自动化代码生成的形式。所以这里就不去实现这一套方案了，详细参考下文作者实现：<br><a target="_blank" rel="noopener" href="http://www.cnblogs.com/OceanEyes/p/unity3d_framework_designing_get_started_with_mvvm_part2.html">Unity应用架构设计(1)—— MVVM 模式的设计和实施(Part 2)</a></p>
<h6 id="VM和VM之间通信"><a href="#VM和VM之间通信" class="headerlink" title="VM和VM之间通信"></a>VM和VM之间通信</h6><p>现实开发过程中，我们的View和View有些时候是需要通信的，虽然View实现了和ViewModel的双向绑定，但并没有解决View和View之间的通信问题。</p>
<p>实现方便来说我们会去写如下代码实现View与View之间的访问:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ViewA</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">notifyViewB</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        ViewB.UpdateView();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>但这样的代码是的View与View之间强耦合了，并不推荐这样实现，我们使用MVVM模式的目的是为了解耦V和M，同时实现V和VM之间数据驱动刷新。这里我们需要解决View和View之间ViewModel与ViewModel之间通信的问题。</p>
<p>首先V和VM是一对一的，V和VM是双向绑定的，所以要实现View和View之间的沟通交流，其实只要实现VM和VM之间的沟通交流即可。VM和VM是一对多的，为了解耦，我们可以通过一个中介者来解耦并统一管理ViewModel之间的沟通交流，然后使用订阅者模式实现消息订阅的形式模拟实现ViewModel之间一对多的沟通交流。</p>
<p>首先核心的消息统一订阅分发类：<br>MessageDispatcher.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             MessageDispatcher.cs</span></span><br><span class="line"><span class="comment"> * Author:                  TONYTANG</span></span><br><span class="line"><span class="comment"> * Create Date:             2018/09/16</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> MessageDispatcher.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 消息分发单例类(这里是为了解耦类似ViewModel和ViewModel之间的交流)</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 类似于EventDispather，只不过这里是支持对任意string的消息监听而非EventId枚举</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MessageDispatcher</span> : <span class="title">SingletonTemplate</span>&lt;<span class="title">MessageDispatcher</span>&gt;&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 消息回调定义</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;sender&quot;&gt;</span>发送消息对象<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;paras&quot;&gt;</span>消息参数<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">delegate</span> <span class="keyword">void</span> <span class="title">MessageDelegate</span>(<span class="params"><span class="built_in">object</span> sender, <span class="keyword">params</span> <span class="built_in">object</span>[] paras</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 消息映射类</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Key为订阅的消息字符串</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Value为注册的回调</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> Dictionary&lt;<span class="built_in">string</span>, MessageDelegate&gt; mMessageMap = <span class="keyword">new</span> Dictionary&lt;<span class="built_in">string</span>, MessageDelegate&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 注册监听消息</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;message&quot;&gt;</span>监听的消息字符串<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;handler&quot;&gt;</span>监听的消息响应回调<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">subscribe</span>(<span class="params"><span class="built_in">string</span> message, MessageDelegate handler</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">string</span>.IsNullOrEmpty(message))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (!mMessageMap.ContainsKey(message))</span><br><span class="line">            &#123;</span><br><span class="line">                mMessageMap.Add(message, handler);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                mMessageMap[message] += handler;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">&quot;不能订阅空的字符串消息!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 注销消息监听</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;message&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;handler&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unSubscribe</span>(<span class="params"><span class="built_in">string</span> message, MessageDelegate handler</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">string</span>.IsNullOrEmpty(message))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (mMessageMap.ContainsKey(message))</span><br><span class="line">            &#123;</span><br><span class="line">                mMessageMap[message] -= handler;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">&quot;不能取消空的字符串消息!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 分发消息</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;message&quot;&gt;</span>分发的消息字符串<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;sender&quot;&gt;</span>发送消息对象<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;paras&quot;&gt;</span>消息参数<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">publish</span>(<span class="params"><span class="built_in">string</span> message, <span class="built_in">object</span> sender, <span class="keyword">params</span> <span class="built_in">object</span>[] paras</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">string</span>.IsNullOrEmpty(message))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (mMessageMap.ContainsKey(message))</span><br><span class="line">            &#123;</span><br><span class="line">                mMessageMap[message](sender, paras);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">&quot;不能分发空的字符串消息!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>修改ViewModel1的代码，添加消息监听:<br>MVVMViewModel.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             MVVMViewModel.cs</span></span><br><span class="line"><span class="comment"> * Author:                  TONYTANG</span></span><br><span class="line"><span class="comment"> * Create Date:             2018/09/15</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> MVVMViewModel.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> MVVM里的VM</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MVVMViewModel</span> : <span class="title">IMVVMViewModel</span>&#123;</span><br><span class="line"></span><br><span class="line">    ******</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 注册消息监听</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerMessageListener</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        MessageDispatcher.Singleton.subscribe(<span class="string">&quot;ChangeName&quot;</span>, onChangeNameMessageHandler);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 取消小心监听注册</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unregisterMessageListener</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        MessageDispatcher.Singleton.unSubscribe(<span class="string">&quot;ChangeName&quot;</span>, onChangeNameMessageHandler);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 保存Model数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">saveModel</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        Model.Name = Name.Value;</span><br><span class="line">        Model.Age = Age.Value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 响应ChangeName消息回调</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;sender&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;paras&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onChangeNameMessageHandler</span>(<span class="params"><span class="built_in">object</span> sender, <span class="built_in">object</span>[] paras</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Name.Value = paras[<span class="number">0</span>] <span class="keyword">as</span> <span class="built_in">string</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>添加View 2和ViewModel2相关代码:<br>MVVMView2.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             MVVMView2.cs</span></span><br><span class="line"><span class="comment"> * Author:                  TONYTANG</span></span><br><span class="line"><span class="comment"> * Create Date:             2018/09/16</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> UnityEngine.UI;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> MVVMView2.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 第二个View</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MVVMView2</span> : <span class="title">MVVMBaseView</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span> 通知ViewModel1改变Name属性按钮 <span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> Button mBtnChangeViewModel1Name;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 真实绑定的VM对象访问入口</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> MVVMViewModel2 ViewModel</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> (MVVMViewModel2)mMVVMViewModelContext;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 响应VM绑定变化回调</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 在这里做V和VM绑定相关的事</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;oldvm&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;newvm&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnBindingContextChanged</span>(<span class="params">IMVVMViewModel oldvm, IMVVMViewModel newvm</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">base</span>.OnBindingContextChanged(oldvm, newvm);</span><br><span class="line">        <span class="comment">// 解除老的VM相关绑定</span></span><br><span class="line">        <span class="keyword">if</span> (oldvm != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="meta">#<span class="keyword">region</span> Bind VM to V Part</span></span><br><span class="line">            <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">            <span class="meta">#<span class="keyword">region</span> Bind V To VM</span></span><br><span class="line">            mBtnChangeViewModel1Name.onClick.RemoveListener(onNotifyViewModel1Click);</span><br><span class="line">            <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 添加新的VM相关绑定</span></span><br><span class="line">        <span class="keyword">if</span> (ViewModel != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="meta">#<span class="keyword">region</span> Bind VM to V Part            </span></span><br><span class="line">            <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">            <span class="meta">#<span class="keyword">region</span> Bind V To VM</span></span><br><span class="line">            mBtnChangeViewModel1Name.onClick.AddListener(onNotifyViewModel1Click);</span><br><span class="line">            <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="keyword">region</span> Bind VM to V Part</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="keyword">region</span> Bind V To VM</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onNotifyViewModel1Click</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        ViewModel.notifyViewModel1NameChange();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>MVVMViewModel2.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             MVVMViewModel2.cs</span></span><br><span class="line"><span class="comment"> * Author:                  TONYTANG</span></span><br><span class="line"><span class="comment"> * Create Date:             2018/09/16</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> MVVMViewModel2.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 第二个ViewModel</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MVVMViewModel2</span> : <span class="title">IMVVMViewModel</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 通知ViewModel1的名字修改</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">notifyViewModel1NameChange</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        MessageDispatcher.Singleton.publish(<span class="string">&quot;ChangeName&quot;</span>, <span class="keyword">this</span>, <span class="string">&quot;Hello World!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>初始化View2和ViewModel2相关的绑定:<br>GameProgrammingPattern.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             GameProgrammingPattern.cs</span></span><br><span class="line"><span class="comment"> * Author:                  TONYTANG</span></span><br><span class="line"><span class="comment"> * Create Date:             2018/09/15</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">GameProgrammingPattern</span> : <span class="title">MonoBehaviour</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="keyword">region</span> MVVM Part</span></span><br><span class="line">    ******</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span> 第二个ViewModel <span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> MVVMViewModel2 mMVVMViewModel2;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span> 第二个View <span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> MVVMView2 mMVVMView2;</span><br><span class="line">    <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Awake</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        initMonoScripts();</span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="keyword">region</span> MVVM Part</span></span><br><span class="line">        ******</span><br><span class="line"></span><br><span class="line">        mMVVMViewModel2 = <span class="keyword">new</span> MVVMViewModel2();</span><br><span class="line">        mMVVMView2 = <span class="keyword">this</span>.transform.GetComponentInChildren&lt;MVVMView2&gt;();</span><br><span class="line">        <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Start</span> ()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="meta">#<span class="keyword">region</span> MVVM Part</span></span><br><span class="line">        <span class="comment">// 初始化ViewModel里的Model数据</span></span><br><span class="line">        mMVVMViewModel.initializeModel(mMVVMModel);</span><br><span class="line">        <span class="comment">// ViewModel注册消息监听</span></span><br><span class="line">        mMVVMViewModel.registerMessageListener();</span><br><span class="line">        <span class="comment">// 绑定View到VM上</span></span><br><span class="line">        mMVVMView.mMVVMViewModelContext = mMVVMViewModel;</span><br><span class="line">        <span class="comment">// 通过携程动态使用VM修改值Age触发View变化显示</span></span><br><span class="line">        CoroutineManager.Singleton.startCoroutine(changeViewModelAgeCoroutine());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 绑定View2到ViewModel2上</span></span><br><span class="line">        mMVVMView2.mMVVMViewModelContext = mMVVMViewModel2;</span><br><span class="line">        <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>运行点击ViewModel2的按钮可以看到我们成功通过消息订阅和分发达到ViewModel和ViewModel之间交流的目的，成功实现了解耦ViewModel和ViewModel之间的通信:<br><img src="/img/GameProgrammingPattern/MessageDispatcher.png" alt="MessageDispatcher"></p>
<h6 id="优化"><a href="#优化" class="headerlink" title="优化"></a>优化</h6><ol>
<li>自动化生成View和ViewModel属性绑定部分代码<br>待续……</li>
</ol>
<h5 id="MVVM使用思考"><a href="#MVVM使用思考" class="headerlink" title="MVVM使用思考"></a>MVVM使用思考</h5><p>可以看到MVVM相比传统MVC模式，将V和M完全解耦，V和M不需要关心对方，通过ViewModel去实现V和M的桥接，通过双向绑定实现View的数据驱动刷新显示。通过消息分发注册等类似机制实现ViewModel与ViewModel之间的沟通交流，实现低耦合的MVVM框架。<br>View可以绑定不同的ViewModel，快速实现不同数据刷新显示。<br>同时因为V和M完全分离，开发人员可以专注于业务逻辑和数据的开发（ViewModel），设计人员可以专注于页面设计。</p>
<p>MVVM应用范围思考:</p>
<ol>
<li>独立开发，方便测试，MVVM比较适合多人合作项目，设计人员和开发人员可以同时开工，</li>
<li>代码重用性，开发人员之间的代码有很高的重用性(重用V或者重用VM都有可能)，开发人员之间的代码不会互相污染。</li>
<li>适用于数据驱动的不复杂的游戏UI部分(数据驱动刷新显示)。</li>
</ol>
<p>待续……</p>
<h4 id="ECS"><a href="#ECS" class="headerlink" title="ECS"></a>ECS</h4><p>待续……</p>
<h1 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h1><h2 id="网站"><a href="#网站" class="headerlink" title="网站"></a>网站</h2><p><a target="_blank" rel="noopener" href="http://www.cnblogs.com/keitsi/p/5764785.html">谈谈对MVC、MVP和MVVM的理解</a><br><a target="_blank" rel="noopener" href="https://draveness.me/mvx">谈 MVC、MVP 和 MVVM 架构模式</a><br><a target="_blank" rel="noopener" href="https://juejin.im/entry/590ae83b5c497d005855988d">Unity 应用架构设计—— MVVM 模式的设计和实施 (Part 1)</a><br><a target="_blank" rel="noopener" href="https://juejin.im/post/5b041882f265da0b9348a4de">mvc的实现</a><br><a target="_blank" rel="noopener" href="https://www.zhihu.com/question/23946609">如何在Unity中实现MVC模式？</a><br><a target="_blank" rel="noopener" href="https://blog.codingnow.com/2017/02/tracedoc.html">跟踪数据结构的变更</a><br><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/8e3d4ab80714">MVC、MVP、MVVM架构分析与比较</a></p>
<h2 id="书籍"><a href="#书籍" class="headerlink" title="书籍"></a>书籍</h2><p>《Game-Programming-Patterns》 – Robert.Nystrom<br>《Design Pattern》 – GoF(四人帮)</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Programming-Language/">Programming Language</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/GameDesignPattern/">GameDesignPattern</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>







  <nav id="page-nav" class="clearfix">
    <a class="extend prev" rel="prev" href="/page/2/">&lt;span&gt;&lt;&#x2F;span&gt;Prev</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><a class="page-number" href="/page/5/">5</a><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/4/">Next&lt;span&gt;&lt;&#x2F;span&gt;</a>
  </nav>

</div>
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  


  
<div class="categorieslist">
	<p class="asidetitle">分类</p>
		<ul>
		
		  
			<li><a href="/categories/AI/" title="AI">AI<sup>3</sup></a></li>
		  
		
		  
			<li><a href="/categories/Algorithm/" title="Algorithm">Algorithm<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/Art/" title="Art">Art<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Automation/" title="Automation">Automation<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Collision/" title="Collision">Collision<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Database/" title="Database">Database<sup>3</sup></a></li>
		  
		
		  
			<li><a href="/categories/Editor/" title="Editor">Editor<sup>5</sup></a></li>
		  
		
		  
			<li><a href="/categories/Excel/" title="Excel">Excel<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Game/" title="Game">Game<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/HotUpdate/" title="HotUpdate">HotUpdate<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Lua/" title="Lua">Lua<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Math/" title="Math">Math<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/Native/" title="Native">Native<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/Network/" title="Network">Network<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Optimization/" title="Optimization">Optimization<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Other/" title="Other">Other<sup>5</sup></a></li>
		  
		
		  
			<li><a href="/categories/Plugin/" title="Plugin">Plugin<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/Programming/" title="Programming">Programming<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/Programming-Language/" title="Programming Language">Programming Language<sup>4</sup></a></li>
		  
		
		  
			<li><a href="/categories/Rendering/" title="Rendering">Rendering<sup>4</sup></a></li>
		  
		
		  
			<li><a href="/categories/Resource/" title="Resource">Resource<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/Unity/" title="Unity">Unity<sup>7</sup></a></li>
		  
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">标签</p>
		<ul class="clearfix">
		
			
				<li><a href="/tags/Unity/" title="Unity">Unity<sup>8</sup></a></li>
			
		
			
				<li><a href="/tags/Editor/" title="Editor">Editor<sup>5</sup></a></li>
			
		
			
				<li><a href="/tags/Other/" title="Other">Other<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/AI/" title="AI">AI<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/Resource/" title="Resource">Resource<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/OpenGL/" title="OpenGL">OpenGL<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/Programming/" title="Programming">Programming<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/Math/" title="Math">Math<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/Art/" title="Art">Art<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Android/" title="Android">Android<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/UI/" title="UI">UI<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/C/" title="C#">C#<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Python/" title="Python">Python<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Database/" title="Database">Database<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Shader/" title="Shader">Shader<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/SubmlineText3/" title="SubmlineText3">SubmlineText3<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Rendering/" title="Rendering">Rendering<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Native/" title="Native">Native<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Prefab/" title="Prefab">Prefab<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Plugin/" title="Plugin">Plugin<sup>1</sup></a></li>
			
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">友情链接</p>
    <ul>
        
          <li>
            
            	<a href="https://coderq.com" target="_blank" title="一个面向程序员交流分享的新一代社区">码农圈</a>
            
          </li>
        
          <li>
            
            	<a href="http://wuchong.me" target="_blank" title="Jark&#39;s Blog">Jark&#39;s Blog</a>
            
          </li>
        
    </ul>
</div>

  


  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS 订阅</a>
</div>

  <div class="weiboshow">
  <p class="asidetitle">新浪微博</p>
    <iframe width="100%" height="119" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=119&fansRow=2&ptype=1&speed=0&skin=9&isTitle=1&noborder=1&isWeibo=0&isFans=0&uid=&verifier=b3593ceb&dpc=1"></iframe>
</div>


</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> Hello ,I&#39;m Larry Page in Google. <br/>
			This is my blog,believe it or not.</p>
	</section>
	 
	<div class="social-font" class="clearfix">
		
		<a href="http://weibo.com/2176287895" target="_blank" class="icon-weibo" title="微博"></a>
		
		
		
		
		
		
		
		
		
		
	</div>
			
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Jacman">Jacman</a> © 2025 
		
		<a href="/about" target="_blank" title="Tony Tang">Tony Tang</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery.qrcode-0.12.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
        
    }
  });
});
</script>












<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->



<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?e6d1f421bbc9962127a50488f9ed37d1";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>



<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="返回顶部"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
 </html>
