
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  
    <title>走停人生路</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="Tony Tang">
    

    
    <meta property="og:type" content="website">
<meta property="og:title" content="走停人生路">
<meta property="og:url" content="http://tonytang1990.github.io/page/3/index.html">
<meta property="og:site_name" content="走停人生路">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Tony Tang">
<meta name="twitter:card" content="summary">

    
    <link rel="alternative" href="/atom.xml" title="走停人生路" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/jacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/jacman.jpg">
    
    
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 7.3.0"></head>

  <body>
    <header>
      
<div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.png" alt="走停人生路" title="走停人生路"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="走停人生路">走停人生路</a></h1>
				<h2 class="blog-motto">做着独立游戏梦，坚持走在游戏开发道路上的人</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">Home</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
						<li><a href="/about">About</a></li>
					
					<li>
 					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="search" id="search" name="q" autocomplete="off" maxlength="20" placeholder="搜索" />
						<input type="hidden" name="q" value="site:tonytang1990.github.io">
					</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main">

   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2020/06/08/Unity滚动列表/" title="Unity滚动列表" itemprop="url">Unity滚动列表</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Tony Tang" target="_blank" itemprop="author">Tony Tang</a>
		
  <p class="article-time">
    <time datetime="2020-06-08T14:37:17.000Z" itemprop="datePublished"> 发表于 2020-06-08</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>多年使用Unity经验的朋友对于列表单元肯定很熟悉，每个公司也都有着自己的一套单元格设计。本章节博客着重学习Unity里列表单元格框架的设计和实现，深入学习不同单元格框架的设计优劣。</p>
<h2 id="列表"><a href="#列表" class="headerlink" title="列表"></a>列表</h2><p>什么是列表了？<br>可以滚动，支持创建多个基于特定模板显示的单元格容器。</p>
<p>列表的功能需求(**(√)**表示本人已经实现的部分)？</p>
<ol>
<li>滚动显示(支持滚动到指定位置)<strong>(√)</strong></li>
<li>动态添加(支持任何位置添加元素)<strong>(√)</strong></li>
<li>循环列表(支持从头滚到尾再接着滚动到头的循环方式)</li>
<li>不同大小单元格显示(支持自适应大小或者自定义传单元格大小)<strong>(√)</strong></li>
<li>多种列表类型显示(e.g. 横向,竖向，横向网格，竖向网格等)<strong>(√)</strong></li>
<li>单元格构造自定义传参**(√)**</li>
<li>自定义滚动动画**(√)**</li>
<li>不同单元格朝向(e.g. 从左往右或从右往左。从上往下或者从下往上。)<strong>(√)</strong></li>
<li>单元格矫正(最终单元格会滚动到某个最近的单元格位置)<strong>(√)</strong></li>
<li>单元格对象池(e.g. 单元格逻辑对象(Object)对象池。单元格实体对象(GameObject)对象池。)<strong>(√)</strong></li>
<li>单元格嵌套滚动(e.g. 嵌套不同方向的单元格容器滚动支持)<strong>(√)</strong></li>
<li>本地单元格模拟创建查看效果(e.g. Inspector支持快速模拟查看排版等)<strong>(√)</strong></li>
</ol>
<h2 id="单元格容器"><a href="#单元格容器" class="headerlink" title="单元格容器"></a>单元格容器</h2><p>这里关于单元格容器，这里主要实现了两套:</p>
<ol>
<li>支持不同滚动方向不同初始化朝向支持不同大小(手动传Size或者自动计算Size)嵌套滚动单元格的一套通用单元格容器。</li>
<li>支持两侧深度滚动显示的单元格容器(这一套实现的效果比较特别所以单独实现的)<br><strong>其中本人主要以第一套(以前在公司学习到的一套实现方案，后来在此基础上扩展支持了很多功能)为重点来学习实战。</strong></li>
</ol>
<h3 id="单元格实现分析"><a href="#单元格实现分析" class="headerlink" title="单元格实现分析"></a>单元格实现分析</h3><p>这里通过学习了解市面上常见的单元格实现来了解常见的单元格实现方案：</p>
<h4 id="LoopScrollRect"><a href="#LoopScrollRect" class="headerlink" title="LoopScrollRect"></a>LoopScrollRect</h4><p><a target="_blank" rel="noopener" href="https://github.com/qiankanglai/LoopScrollRect">LoopScrollRect</a><br>这一套是<a target="_blank" rel="noopener" href="http://qiankanglai.me/2015/08/15/LoopScrollRect/">钱康来</a>大佬编写分享的一套支持循环列表的实现方案。<br>通过查看源码，可以了解到，这一套实现核心是基于ContentSizeFitter，LayoutGroup和LayoutElement相关组件来实现动态计算单元格位置显示循环滚动以及不同大小等效果的。<br><strong>亮点分析:</strong></p>
<ol>
<li>使用了原生Scroller，但并不依赖原生ScrolRect那套来计算滚动，这样为<strong>支持循环列表</strong>打下了基础。</li>
<li><strong>单元格位置数据与单元格逻辑对象分离</strong>，可以做到动态计算单元格显示时<strong>只有需要显示的才有逻辑单元格对象(避免New大量的单元格)</strong>。</li>
</ol>
<p><strong>缺点分析:</strong></p>
<ol>
<li>虽然基于LayoutGroup和LayoutElement，但并非正向通过他们的排版功能得到不同单元格大小显示，而是反向设置LayoutElement来通过LayoutUtility.GetPreferredHeight()等接口方法来实现正确的计算滚动排版。<strong>这儿也就意味着做不到自动计算单元格大小的功能。</strong></li>
<li>单元格显示是通过SendMessage的形式触发，感觉这种方式效率可能不如直接调用接口方法来的快(个人感觉)。<br>核心获取单元格大小的代码：</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="built_in">float</span> <span class="title">GetSize</span>(<span class="params">RectTransform item</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">float</span> size = contentSpacing;</span><br><span class="line">    <span class="keyword">if</span> (m_GridLayout != <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        size += m_GridLayout.cellSize.y;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        size += LayoutUtility.GetPreferredHeight(item);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> size;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>单元格初始化显示触发代码:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">ProvideData</span>(<span class="params">Transform transform, <span class="built_in">int</span> idx</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    transform.SendMessage(<span class="string">&quot;ScrollCellIndex&quot;</span>, idx);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="FancyScrollView"><a href="#FancyScrollView" class="headerlink" title="FancyScrollView"></a>FancyScrollView</h4><p><a target="_blank" rel="noopener" href="https://github.com/setchi/FancyScrollView">FancyScrollView</a><br><img src="/img/Unity/CellContainer/FancyScrollViewExhibition.png" alt="FancyScrollViewExhibition"><br>这一套是在UWA上看到的，貌似是日本开发者开发的。<br>通过上面的效果图可以看到，这一套实现了很强大的结合自定义动画或者Shader的单元格容器框架。<br>通过查看源代码可以发现，这一套非常强大的一点是通过自定义实现Scroller强大的滚动单元格容器需要的滚动相关的计算和回调支持。<br>上次代码只需要通过ScrollView和Scroller接口设置显示数据以及单元格模板等就能做到很好的单元格容器滚动效果。<br><strong>亮点分析:</strong></p>
<ol>
<li>没有依赖原生Scroller，自定义实现了Scroller，可以更加容易的支持循环列表。</li>
<li>动态计算显示与否是通过当前滚动到的位置来判定，而单元格位置信息并没有耦合到单元格对象里，这样可以做到逻辑对象数量等于最大可显示的数量。</li>
<li>更新显示回调(UpdatePosition)里有传入位置数据，可以基于位置数据做<strong>动画(Animator)或者Shader相关的表现展示</strong>。</li>
<li>不依赖于Scroller，LayoutGroup等组件，开销更低</li>
</ol>
<p><strong>缺点分析:</strong></p>
<ol>
<li><strong>单元格不支持不同大小</strong>，都是按预制件统一大小来计算</li>
</ol>
<h4 id="super-scrollview"><a href="#super-scrollview" class="headerlink" title="super-scrollview"></a>super-scrollview</h4><p><a target="_blank" rel="noopener" href="https://github.com/baba-s/ugui-super-scrollview-example">ugui-super-scrollview-example</a><br>这一套是Unity Asset Store里出售的一套滚动单元格插件。<br>让我们先来一张效果图展示：<br><img src="/img/Unity/CellContainer/SuperScrollViewExhibition.png" alt="SuperScrollViewExhibition"><br>从上面可以看到，SuperScrollView可以做到很多效果(e.g. 翻页，动态加载，动态大小变化，滚动到指定位置，动态增删单元格，不同朝向单元格容器显示……)<br>基本上能想到的单元格容器效果，这个插件都支持。<br>接下来让我们结合源码和实例来分析下这一套单元格容器的好坏:<br><strong>亮点分析:</strong></p>
<ol>
<li>单元格位置数据与逻辑对象分离，可以<strong>有效的减少逻辑单元格对象数量</strong>。</li>
<li>自定义的单元格大小抽象，可以<strong>方便的自定义传入不同大小的单元格并显示</strong>。</li>
<li>支持不同朝向的单元格容器显示(核心是反向初始化和计算单元格位置显示)</li>
</ol>
<p><strong>缺点分析:</strong></p>
<ol>
<li>使用了ScrollRect部分功能(特别是容器滚动部分)，这一点导致要做循环列表就很困难</li>
</ol>
<p><strong>后续本人的单元格容器很大程度上跟SuperScrollView更相近(指功能设计上而非代码设计)。</strong></p>
<h3 id="实战单元格容器"><a href="#实战单元格容器" class="headerlink" title="实战单元格容器"></a>实战单元格容器</h3><p>通过学习了解市面上的单元格容器实现，可以看到有几个比较重要的点：</p>
<ol>
<li><strong>不依赖于ScrollRect滚动，自定义分离单元格位置数据和单元格逻辑对象，是实现循环列表和减少逻辑单元格对象数量的关键。</strong></li>
<li><strong>大部分都不支持自动计算大小，需要手动计算传递单元格大小，相对来说没那么方便，但开销会小。</strong></li>
</ol>
<p>接下来让我们看看博主实战最终实现的效果(主要讲解第一套单元格):<br><img src="/img/Unity/CellContainer/LeftToRightScene.PNG" alt="LeftToRightScene"></p>
<p><img src="/img/Unity/CellContainer/TopToBottomScene.PNG" alt="TopToBottomScene"></p>
<p><img src="/img/Unity/CellContainer/HorizontalGalleryDemoScene.PNG" alt="HorizontalGalleryDemoScene"></p>
<p><img src="/img/Unity/CellContainer/ChatMessageListScene.PNG" alt="ChatMessageListScene"></p>
<p><img src="/img/Unity/CellContainer/ChangeItemSizeScene.PNG" alt="ChangeItemSizeScene"></p>
<p><img src="/img/Unity/CellContainer/ClickAndLoadMoreScene.PNG" alt="ClickAndLoadMoreScene"></p>
<p><img src="/img/Unity/CellContainer/GridViewScene.PNG" alt="GridViewScene"></p>
<p><img src="/img/Unity/CellContainer/PageViewScene.PNG" alt="PageViewScene"></p>
<p><img src="/img/Unity/CellContainer/SpinDatePickerScene.PNG" alt="SpinDatePickerScene"></p>
<p><img src="/img/Unity/CellContainer/SelectAndDeleteOrMoveScene.PNG" alt="SelectAndDeleteOrMoveScene"></p>
<p>上面展示了我支持的各类单元格容器，比如横向单元格容器，竖向单元格容器，横向网格单元格容器，竖向网格单元格容器，动态大小等各种用法。<br><img src="/img/Unity/CellContainer/DepthScrollExhibition.png" alt="DepthScrollExhibition"><br>第三章图主要展示的是另一套单元格容器，支持左右两侧指定深度滚动的单元格容器。</p>
<p>Note:</p>
<p>基于ContentSizeFitter和LayoutGroup的自动计算大小测试性能开销比较大最后决定不予支持了。</p>
<h4 id="深入讲解"><a href="#深入讲解" class="headerlink" title="深入讲解"></a>深入讲解</h4><p>让我们通过横向单元格的面板来大致了解下单元格都支持哪些功能：<br>!(HorizontalContainerInspector)(&#x2F;img&#x2F;Unity&#x2F;CellContainer&#x2F;HorizontalContainerInspector.png)<br>从面板上可以看出，博主的单元格容器主要支持了以下几个功能：</p>
<ol>
<li>单元格滚动自动矫正以及相关速度设置(最终确保滚动到单元格正中心位置)</li>
<li>支持不同朝向的单元格创建显示</li>
<li>支持嵌套单元格容器(不同朝向的单元格容器可以嵌套滚动)</li>
<li>支持单元格的间距和初始位置排版设置</li>
<li>支持设置多预制件用于绑定不同逻辑单元格对象显示在同一个单元格容器下</li>
<li>支持编辑器下快速模拟创建单元格查看排版</li>
</ol>
<p>单元格容器核心实现原理：</p>
<ol>
<li>通过手动传单元格大小或者自动计算单元格大小来得到每个单元格的大小数据</li>
<li>通过累加计算出总的可滚动Content大小，同时计算出单元格的抽象单元格位置</li>
<li>结合IBeginDragHandler, IDragHandler, IEndDragHandler接口来判定拖拽状态(比如是否开始或结束拖拽，拖拽方向等)，以及实现嵌套单元格的拖拽事件判定以及分发</li>
<li>Content结合ScrollRect来实现滚动回调(OnValueChanged)触发滚动计算判定，结合单元格的抽象位置来判定每个单元格的显隐状态。同时判定是否满足单元格矫正条件</li>
<li>通过IEndDragHandler响应结束拖拽时判定是否需要执行单元格矫正</li>
<li>向上层暴露OnShow,OnVisibleScroll,MoveTOIndex,OnHide等接口来实现单元格逻辑流程显示回收(BaseScrollContainer:bindContainerCallBack()接口传递)</li>
</ol>
<p>结合UML类图来理解下单元格容器的设计:<br><img src="/img/Unity/CellContainer/CellContainerUML.png" alt="CellContainerUML"></p>
<p>首先先放一段完整的创建单元格显示的事例代码，后续会一一讲解具体实现细节流程:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">RightToLeftContainer.bindContainerCallBack(onCellShow);</span><br><span class="line">  RightToLeftContainer.setCellDatasByCellCount(<span class="number">20</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> 单元格显示回调</span></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;cellindex&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;cellinstance&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onCellShow</span>(<span class="params"><span class="built_in">int</span> cellindex, GameObject cellinstance</span>)</span></span><br><span class="line">  &#123;</span><br><span class="line">      <span class="keyword">var</span> toptobottomcell = cellinstance.GetComponent&lt;ShowCellIndexCell&gt;();</span><br><span class="line">      <span class="keyword">if</span> (toptobottomcell == <span class="literal">null</span>)</span><br><span class="line">      &#123;</span><br><span class="line">          toptobottomcell = cellinstance.AddComponent&lt;ShowCellIndexCell&gt;();</span><br><span class="line">      &#125;</span><br><span class="line">      toptobottomcell.<span class="keyword">init</span>(cellindex);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>接下来让我们看看单元格容器的细节实现：<br>CellData.cs（<strong>单元格相关抽象</strong>）</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CellData</span> : <span class="title">IRecycle</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 当前Cell索引</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> CellIndex</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 拥有者单元格</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">protected</span> BaseScrollContainer mOwnerContainer;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Cell实例对象</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> GameObject CellGO</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Cell实例对象的RectTransform</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> RectTransform CellGORectTransform</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 单元格大小(宽和高)</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> Vector2 mCellSize;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 单元格预制件索引</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> CellPrefabIndex</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//Debug.Log(&quot;NewCellData:onCreate()&quot;);</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDispose</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//Debug.Log(&quot;NewCellData:onDispose()&quot;);</span></span><br><span class="line">        CellIndex = <span class="number">-1</span>;</span><br><span class="line">        mOwnerContainer = <span class="literal">null</span>;</span><br><span class="line">        CellGO = <span class="literal">null</span>;</span><br><span class="line">        CellGORectTransform = <span class="literal">null</span>;</span><br><span class="line">        CellPrefabIndex = <span class="number">-1</span>;</span><br><span class="line">        mCellSize = Vector2.zero;</span><br><span class="line">        mRectPos = Vector2.zero;</span><br><span class="line">        mRectAbsPos = Vector2.zero;</span><br><span class="line">        CellRect.Set(<span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">0.0f</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CellData</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        CellIndex = <span class="number">-1</span>;</span><br><span class="line">        mOwnerContainer = <span class="literal">null</span>;</span><br><span class="line">        CellGO = <span class="literal">null</span>;</span><br><span class="line">        CellGORectTransform = <span class="literal">null</span>;</span><br><span class="line">        CellPrefabIndex = <span class="number">-1</span>;</span><br><span class="line">        mCellSize = Vector2.zero;</span><br><span class="line">        mRectPos = Vector2.zero;</span><br><span class="line">        mRectAbsPos = Vector2.zero;</span><br><span class="line">        CellRect.Set(<span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">0.0f</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 初始化单元格实例对象</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;cellinstance&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span>(<span class="params">GameObject cellinstance</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(cellinstance != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            CellGO = cellinstance;</span><br><span class="line">            <span class="comment">// 不同单元格容器公用同一个模板对象可能会出现锚点不一致问题，所以每次强制设置</span></span><br><span class="line">            CellGORectTransform = CellGO.transform <span class="keyword">as</span> RectTransform;</span><br><span class="line">            CellGORectTransform.anchorMax = AnchorMax;</span><br><span class="line">            CellGORectTransform.anchorMin = AnchorMin;</span><br><span class="line">            CellGORectTransform.pivot = Pivot;</span><br><span class="line">            updateCellSizeAndPosition();</span><br><span class="line">            <span class="keyword">if</span> (!CellGO.activeSelf)</span><br><span class="line">            &#123;</span><br><span class="line">                CellGO.SetActive(<span class="literal">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            CellGO = <span class="literal">null</span>;</span><br><span class="line">            CellGORectTransform = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Cell数据清除</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">clear</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mOwnerContainer = <span class="literal">null</span>;</span><br><span class="line">        CellGO = <span class="literal">null</span>;</span><br><span class="line">        CellGORectTransform = <span class="literal">null</span>;</span><br><span class="line">        mCellSize = Vector2.zero;</span><br><span class="line">        mRectPos = Vector2.zero;</span><br><span class="line">        CellRect = Rect.zero;</span><br><span class="line">        ObjectPool.Singleton.push&lt;CellData&gt;(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面列举了单元格参与容器显示判定计算比较重要的成员变量以及生命周期函数，可以看出单元格的大小和位置以及显示区域信息会用作单元格容器滚动时的判定数据，从而判定是否需要显示特定单元格。</p>
<p>从前面的事例代码可以看到单元格的创建可以手动指定单元格大小，不传会用默认预制件大小</p>
<p>设定单元格容器回调后触发setCellDatasByCellCount()等设置容器数量相关接口后，触发单元格以及单元格容器相关数据的初始化和判定以及滚动判定监听:<br>BaseScrollContainer.cs(单元格容器基类)</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Use this for initialization</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Start</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    ScrollRect.onValueChanged.AddListener(onScrollChanged);</span><br><span class="line">    TryCorrectData();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 滚动回调刷新Cell显示</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;scrollpos&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">onScrollChanged</span>(<span class="params">Vector2 scrollpos</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (mCellDatas != <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        updateScrollValue();</span><br><span class="line">        mMaskRect.x = mAvalibleScrollDistance * ScrollRect.horizontalNormalizedPosition;</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; mCellDatas.Count; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            onCellDisplay(i);</span><br><span class="line">        &#125;</span><br><span class="line">        checkCellPostionCorrect(mCurrentScrollDir);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Set container celldatas by pass data</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 设置Container的cell数据通过列表数据</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;prefabindexlist&quot;&gt;</span>预制件索引列表<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param width=&quot;cellsizelist&quot;&gt;</span>单元格大小列表(为空表示采用预制件默认大小)<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;scrollnormalizedposition&quot;&gt;</span>单元格初始滚动位置<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCellDatasByDataList</span>(<span class="params">List&lt;<span class="built_in">int</span>&gt; prefabindexlist, List&lt;Vector2&gt; cellsizelist = <span class="literal">null</span>, Vector2? scrollnormalizedposition = <span class="literal">null</span></span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> celldatalist = createNormalCellDataList(prefabindexlist, cellsizelist);</span><br><span class="line">    setCellDatas(celldatalist, scrollnormalizedposition);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Set container celldatas by pass cell count</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 设置Container的cell数据通过单元格数量</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;prefabindexlist&quot;&gt;</span>预制件索引列表<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param width=&quot;cellsizelist&quot;&gt;</span>单元格大小列表(为空表示采用预制件默认大小)<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;scrollnormalizedposition&quot;&gt;</span>单元格初始滚动位置<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCellDatasByCellCount</span>(<span class="params"><span class="built_in">int</span> cellcount, Vector2? scrollnormalizedposition = <span class="literal">null</span></span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> celldatalist = createNormalCellDataListWithCount(cellcount);</span><br><span class="line">    setCellDatas(celldatalist, scrollnormalizedposition);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Set container celldatas by pass celldata list</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 设置Container的cell数据</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;celldatas&quot;&gt;</span>所有的Cell数据<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;scrollnormalizedposition&quot;&gt;</span>单元格初始滚动位置<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCellDatas</span>(<span class="params">List&lt;CellData&gt; celldatas, Vector2? scrollnormalizedposition = <span class="literal">null</span></span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Update container relative datas</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 更新容器数据</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;scrollnormalizaedposition&quot;&gt;</span>单元格初始滚动位置<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;keeprectcontentpos&quot;&gt;</span>是否保持rect content的相对位置(优先于scrollnormalizaedposition)<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">updateContainerData</span>(<span class="params">Vector2? scrollnormalizaedposition = <span class="literal">null</span>, <span class="built_in">bool</span> keeprectcontentpos = <span class="literal">false</span></span>)</span>;</span><br><span class="line"></span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<p>因为单元格的流程和细节还是比较多，这里讲解的不太全面，很多地方没有说到，但考虑到项目还在用这两套单元格滚动，所以展示不打算放出源码，等未来实际成熟再分享源码。</p>
<p><strong>亮点分析:</strong></p>
<ol>
<li><strong>支持嵌套单元格滚动(通过判定滚动方向手动向上传递滚动事件实现)</strong></li>
<li><strong>支持手动传Size</strong></li>
<li><strong>支持不同单元格模板以及不同单元格逻辑对象的显示</strong></li>
</ol>
<p><strong>缺点分析:</strong></p>
<ol start="2">
<li><strong>滚动单元格依赖于ScrollRect的滚动机制需要一开始就计算出总的单元格大小之和，导致很难支持循环列表。</strong></li>
<li><strong>滚动列表要一开始就知道单元格的大小，导致一开始如果有过多的动态大小会导致单元格初始化前的计算开销过大。</strong></li>
</ol>
<h4 id="未来优化"><a href="#未来优化" class="headerlink" title="未来优化"></a>未来优化</h4><ol>
<li>设计成支持纯虚拟的滚动列表，可以在滚动时再请求单元格大小信息做到动态更新ScrollRect滚动容器大小，动态单元格大小在初始化时的开销过大。</li>
<li>设计成不基于ScrollRect的滚动机制，为实现循环列表做准备</li>
</ol>
<p>—————————-2021&#x2F;4&#x2F;20更新开始——————————-</p>
<p>开始着手分离单元格位置和单元格逻辑对象优化单元格逻辑对象过多问题，确保只需创建可见的单元格逻辑对象，减少不必要的逻辑对象创建开销。(<strong>已设计成回调似方式来优化逻辑对象问题</strong>)</p>
<p>—————————-2021&#x2F;4&#x2F;20更新结束——————————-</p>
<p>Note:</p>
<ol>
<li>源代码里默认带了一套组件绑定(结合代码生成)的方案，感兴趣的朋友可以自己了解下</li>
<li>源代码里也默认带了ObjectPool和GameObjectPool两种对象池的实现，感兴趣的朋友可以自己了解下</li>
</ol>
<h1 id="Github地址"><a href="#Github地址" class="headerlink" title="Github地址"></a>Github地址</h1><p><a target="_blank" rel="noopener" href="https://github.com/TonyTang1990/ScrollContainer">ScrollContainer</a></p>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a target="_blank" rel="noopener" href="https://github.com/qiankanglai/LoopScrollRect">LoopScrollRect</a><br><a target="_blank" rel="noopener" href="https://github.com/setchi/FancyScrollView">FancyScrollView</a><br><a target="_blank" rel="noopener" href="https://github.com/baba-s/ugui-super-scrollview-example">ugui-super-scrollview-example</a><br><a target="_blank" rel="noopener" href="http://www.xuanyusong.com/archives/4234">Unity3D研究院之ContentSizeFitter同步立即响应回调</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Unity/">Unity</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Unity/">Unity</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2020/05/29/Unity组件绑定/" title="Unity组件绑定" itemprop="url">Unity组件绑定</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Tony Tang" target="_blank" itemprop="author">Tony Tang</a>
		
  <p class="article-time">
    <time datetime="2020-05-29T15:35:00.000Z" itemprop="datePublished"> 发表于 2020-05-29</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>游戏开发过程中我们经常会需要访问一些指定节点，组件和脚本。</p>
<p>常规方式会通过编写GetChild(?)和GetComponent<?>()代码的方式去获取节点和组件，但这样对于开发来说并不高效同时运行时的GetChild(?)和GetComponent<?>()也是有运行开销的。</p>
<p>为了寻求更高效，高性能和便捷的方式，这里引出组件绑定的工具方案。</p>
<p><strong>实现一套通用的组件绑定方案</strong>，为未来游戏快速开发打下基础。</p>
<h2 id="组件绑定原理"><a href="#组件绑定原理" class="headerlink" title="组件绑定原理"></a>组件绑定原理</h2><ol>
<li>通过Object数组实现通用类型的组件绑定存储</li>
<li>通过自定义Inspector实现绑定对象，绑定对象组件绑定选择以及模板类型选择，代码生成等UI操作界面</li>
<li>通过模板+代码生成实现组件绑定的自定义快速代码生成(通过生成partial代码不入侵原始逻辑代码)</li>
<li>结合自定义ScriptableObject自定义不同模板类型的不同代码输出目录实现自定义代码目录输出设置</li>
</ol>
<h2 id="功能实现"><a href="#功能实现" class="headerlink" title="功能实现"></a>功能实现</h2><ol>
<li><strong>支持通节点不同组件的绑定</strong></li>
<li><strong>支持节点自定义变量名和注释定义</strong></li>
<li><strong>支持自定义代码模板的选择生成</strong></li>
<li><strong>支持组件绑定代码不入侵功能代码(利用partial class)功能生成代码</strong></li>
<li><strong>支持不同模板类型代码生成输出目录设置</strong></li>
</ol>
<h2 id="实战实现"><a href="#实战实现" class="headerlink" title="实战实现"></a>实战实现</h2><h3 id="组件绑定脚本"><a href="#组件绑定脚本" class="headerlink" title="组件绑定脚本"></a>组件绑定脚本</h3><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 节点绑定类</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">DisallowMultipleComponent</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ComponentBinder</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 绑定类型索引值</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> BindCodeTypeIndex;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> UI节点数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> List&lt;ComponentBindData&gt; NodeDatas = <span class="keyword">new</span> List&lt;ComponentBindData&gt;();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 组件绑定节点信息</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">Serializable</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ComponentBindData</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 节点对象</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">SerializeField</span>]</span><br><span class="line">    <span class="keyword">public</span> UnityEngine.Object NodeTarget;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 变量别名(用于生成代码)</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">SerializeField</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> VariableAlias;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 节点描述</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">SerializeField</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> NodeDes;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ComponentBindData</span>(<span class="params">UnityEngine.Object target</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        NodeTarget = target;</span><br><span class="line">        NodeDes = <span class="built_in">string</span>.Empty;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从上面的可以看出节点组件和脚本的数据绑定<strong>核心是通过脚本序列化Object[]数组以及相关数据的方式实现绑定节点数据存储的。</strong></p>
<h3 id="组件绑定自定义面板"><a href="#组件绑定自定义面板" class="headerlink" title="组件绑定自定义面板"></a>组件绑定自定义面板</h3><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 组件绑定自定义Editor</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">CustomEditor(typeof(ComponentBinder))</span>]</span><br><span class="line">[<span class="meta">CanEditMultipleObjects</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ComponentBinderEditor</span> : <span class="title">Editor</span></span><br><span class="line">&#123;</span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这部分代码主要是实现ComponentBinder的Inspector自定义GUI显示，从而实现我们想要的自定义UI操作。</p>
<h3 id="组件绑定模板代码生成"><a href="#组件绑定模板代码生成" class="headerlink" title="组件绑定模板代码生成"></a>组件绑定模板代码生成</h3><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> CompoenntBinder代码生成工具</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">ComponentBinderCodeGenerator</span></span><br><span class="line">&#123;</span><br><span class="line">	******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 模板数据处理类</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TTemplate</span></span><br><span class="line">&#123;</span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此文件主要是通过自定义选择的模板文件***.txt结合TTemplate工具类实现模板文件txt里的内容自定义生成输出我们想要的代码。</p>
<p>窗口模板文件示例:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             #FileName#.cs</span></span><br><span class="line"><span class="comment"> * Author:                  #Author#</span></span><br><span class="line"><span class="comment"> * Create Date:             #CreatedDate#</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> UnityEngine.UI;</span><br><span class="line"><span class="keyword">using</span> TH.Modules.UI;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Game.Modules.UI</span></span><br><span class="line">&#123;	</span><br><span class="line">	<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">	<span class="comment"><span class="doctag">///</span> #ClassName#窗口</span></span><br><span class="line">	<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> #<span class="title">ClassName</span># : <span class="title">BaseWindow</span></span><br><span class="line">    &#123;</span><br><span class="line">		<span class="keyword">public</span> <span class="meta">#ClassName#()</span></span><br><span class="line">		&#123;</span><br><span class="line"></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> 添加监听</span></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">		<span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">addListeners</span>()</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">base</span>.addListeners();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> 窗口显示</span></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">		<span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">onShow</span>()</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">base</span>.onShow();</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> 移除监听</span></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">		<span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">removeListeners</span>()</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">base</span>.removeListeners();</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> 窗口销毁</span></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">		<span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">onDestroy</span>()</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">base</span>.onDestroy();</span><br><span class="line">		&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>窗口组件绑定模板示例:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             #FileName#.cs</span></span><br><span class="line"><span class="comment"> * Author:                  #Author#</span></span><br><span class="line"><span class="comment"> * Create Date:             #CreatedDate#</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> UnityEngine.UI;</span><br><span class="line"><span class="keyword">using</span> TH.Modules.UI;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Game.Modules.UI</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">	<span class="comment"><span class="doctag">///</span> #ClassName#窗口的组件绑定</span></span><br><span class="line">	<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">partial</span> <span class="keyword">class</span> #<span class="title">ClassName</span>#</span><br><span class="line">    &#123;</span><br><span class="line">		 <span class="meta">#MEMBER_DEFINITION_LOOP#</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span> #NodeDes# <span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">private</span> <span class="meta">#NodeType# #NodeName#;#MEMBER_DEFINITION_LOOP#</span></span><br><span class="line">		   </span><br><span class="line">		<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> 缓存组件</span></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">		<span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">cacheComponents</span>()</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">base</span>.cacheComponents();</span><br><span class="line">            <span class="meta">#MEMBER_INIT_LOOP#</span></span><br><span class="line">            <span class="meta">#NodeName# = #NodeMemberName#.NodeDatas[#NodeIndex#].NodeTarget as #NodeType#;#MEMBER_INIT_LOOP#</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> 释放组件</span></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">		<span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">disposeComponents</span>()</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">base</span>.disposeComponents();</span><br><span class="line">			<span class="meta">#MEMBER_DISPOSE_LOOP#</span></span><br><span class="line">            <span class="meta">#NodeName# = null;#MEMBER_DISPOSE_LOOP#</span></span><br><span class="line">		&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其他模板生成参考文件:</p>
<p>CellUIBinder.txt，CellUITemplate.txt，GameObjectUIBinder.txt</p>
<h3 id="组件绑定设置"><a href="#组件绑定设置" class="headerlink" title="组件绑定设置"></a>组件绑定设置</h3><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> ComponentBindSetting.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 组件绑定设置数据</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">CreateAssetMenu(fileName = <span class="string">&quot;ComponentBinderSetting&quot;</span>, menuName = <span class="string">&quot;ScriptableObjects/ComponentBinderSetting&quot;</span>, order = 1)</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ComponentBinderSetting</span> : <span class="title">ScriptableObject</span></span><br><span class="line">&#123;</span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> ComponentBinderSettingEditor.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 组件绑定自定义Editor</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">CustomEditor(typeof(ComponentBinderSetting))</span>]</span><br><span class="line">[<span class="meta">DisallowMultipleComponent</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ComponentBinderSettingEditor</span> : <span class="title">Editor</span></span><br><span class="line">&#123;</span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="实战使用"><a href="#实战使用" class="headerlink" title="实战使用"></a>实战使用</h3><ul>
<li><p>组件绑定设置</p>
<p><img src="/img/Unity/ComponentBinder/ComponentBinderSettingUI.PNG" alt="ComponentBinderSettingUI"></p>
<p><strong>通过自定义模板类型的代码输出路径设置实现自定义代码输出设置</strong></p>
</li>
<li><p>组件绑定选择</p>
<p><img src="/img/Unity/ComponentBinder/ComponentBindChosenUI.PNG" alt="ComponentBindChosenUI"></p>
<ol>
<li><strong>支持通节点不同组件的绑定</strong></li>
<li><strong>支持节点自定义变量名和注释定义</strong></li>
</ol>
</li>
<li><p>自定义绑定节点代码注释</p>
<p><img src="/img/Unity/ComponentBinder/CustomScriptNotation.PNG" alt="CustomScriptNotation"></p>
</li>
<li><p>窗口模板组件绑定设置以及代码生成</p>
<p><img src="/img/Unity/ComponentBinder/WindowTemplateBindUsing.PNG" alt="WindowTemplateBindUsing"></p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             WindowBindPrefab.cs</span></span><br><span class="line"><span class="comment"> * Author:                  TONYTANG</span></span><br><span class="line"><span class="comment"> * Create Date:             2022//05/29</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> UnityEngine.UI;</span><br><span class="line"><span class="keyword">using</span> TH.Modules.UI;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Game.Modules.UI</span></span><br><span class="line">&#123;	</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> WindowBindPrefab窗口</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">WindowBindPrefab</span> : <span class="title">BaseWindow</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">WindowBindPrefab</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 添加监听</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">addListeners</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">base</span>.addListeners();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 窗口显示</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">onShow</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">base</span>.onShow();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 移除监听</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">removeListeners</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">base</span>.removeListeners();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 窗口销毁</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">onDestroy</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">base</span>.onDestroy();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             WindowBindPrefabBinder.cs</span></span><br><span class="line"><span class="comment"> * Author:                  TONYTANG</span></span><br><span class="line"><span class="comment"> * Create Date:             2022//05/29</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> UnityEngine.UI;</span><br><span class="line"><span class="keyword">using</span> TH.Modules.UI;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Game.Modules.UI</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">	<span class="comment"><span class="doctag">///</span> WindowBindPrefab窗口的组件绑定</span></span><br><span class="line">	<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">partial</span> <span class="keyword">class</span> <span class="title">WindowBindPrefab</span></span><br><span class="line">    &#123;</span><br><span class="line">		 </span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span> 根GameObject <span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">private</span> GameObject _rootGo;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span> 根RectTransform <span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">private</span> RectTransform _rootRect;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span> 背景图 <span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">private</span> Image imgBg;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span> 左侧按钮 <span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">private</span> Button btnLeftSwitch;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span> 右侧按钮 <span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">private</span> Button btnRightSwitch;</span><br><span class="line">		   </span><br><span class="line">		<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> 缓存组件</span></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">		<span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">cacheComponents</span>()</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">base</span>.cacheComponents();</span><br><span class="line">            </span><br><span class="line">            _rootGo = mComponentBinder.NodeDatas[<span class="number">0</span>].NodeTarget <span class="keyword">as</span> GameObject;</span><br><span class="line">            _rootRect = mComponentBinder.NodeDatas[<span class="number">1</span>].NodeTarget <span class="keyword">as</span> RectTransform;</span><br><span class="line">            imgBg = mComponentBinder.NodeDatas[<span class="number">2</span>].NodeTarget <span class="keyword">as</span> Image;</span><br><span class="line">            btnLeftSwitch = mComponentBinder.NodeDatas[<span class="number">3</span>].NodeTarget <span class="keyword">as</span> Button;</span><br><span class="line">            btnRightSwitch = mComponentBinder.NodeDatas[<span class="number">4</span>].NodeTarget <span class="keyword">as</span> Button;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> 释放组件</span></span><br><span class="line">		<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">		<span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">disposeComponents</span>()</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">base</span>.disposeComponents();</span><br><span class="line">			</span><br><span class="line">            _rootGo = <span class="literal">null</span>;</span><br><span class="line">            _rootRect = <span class="literal">null</span>;</span><br><span class="line">            imgBg = <span class="literal">null</span>;</span><br><span class="line">            btnLeftSwitch = <span class="literal">null</span>;</span><br><span class="line">            btnRightSwitch = <span class="literal">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>更多的代码生成示例，参考Github源代码工程。</p>
<p><img src="/img/Unity/ComponentBinder/GameObjectBinderUI.PNG" alt="GameObjectBinderUI"></p>
<p><img src="/img/Unity/ComponentBinder/CellBinderUI.PNG" alt="CellBinderUI"></p>
</li>
</ul>
<h2 id="重点知识"><a href="#重点知识" class="headerlink" title="重点知识"></a>重点知识</h2><ol>
<li><strong>利用自定义UI结合Object[]实现自定义组件绑定数据序列化</strong></li>
<li><strong>利用代码生成使用partial实现组件绑定代码无缝插入工程代码实现快速替换和访问</strong></li>
</ol>
<h2 id="Github"><a href="#Github" class="headerlink" title="Github"></a>Github</h2><p><a target="_blank" rel="noopener" href="https://github.com/TonyTang1990/ComponentBinder">ComponentBinder</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Unity/">Unity</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Unity/">Unity</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2020/05/29/数学与缓动/" title="数学与缓动" itemprop="url">数学与缓动</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Tony Tang" target="_blank" itemprop="author">Tony Tang</a>
		
  <p class="article-time">
    <time datetime="2020-05-29T01:15:31.000Z" itemprop="datePublished"> 发表于 2020-05-29</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>本章节博客是在使用一段时间Dotween后，对于Dotween是如何实现各种不同的缓动类型效果比较好奇。从本片博客会了解线性方程与线性代数之间的关系，以及数学(线性方程)在缓动中的实际应用和数学公式是如何输出显示的。本博客着重于学习数学在插值动画上的运用学习，博客末尾会给出实战的Git地址。</p>
<h2 id="数学"><a href="#数学" class="headerlink" title="数学"></a>数学</h2><p>在开始之前，让我们先来了解下如何编写网页版数学公式，然后用于我们的MarkDown中显示。</p>
<p>紧接着我们来回顾和学习了解，线性方程和线性代数各自的概念以及他们之间的关系。</p>
<h3 id="数学公式"><a href="#数学公式" class="headerlink" title="数学公式"></a>数学公式</h3><p>考虑到MarkDown或者网页显示数学公式都要有额外的插件支持，所以这里采用独立第三方制作公式显示，然后截图使用图片的形式来显示到MarkDown和网页上。</p>
<h4 id="公式制作"><a href="#公式制作" class="headerlink" title="公式制作"></a>公式制作</h4><p>通过搜索了解到<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/LaTeX"><strong>LaTeX</strong>，是一种基于TeX的排版系统</a></p>
<p>LateX表达数学公式支持两种方式：</p>
<ol>
<li><p>inline mode(is used to write formulas that are part of a text)</p>
<p>inline mode采用以下分隔符: </p>
<p>\( \)<code>, </code>$ $<code>or</code>\begin{math} \end{math}</p>
</li>
<li><p>display mode(is used to write expressions that are not part of a text or paragraph, and are therefore put on separate lines.)</p>
</li>
</ol>
<p>由于LateX规则过于庞大，所以这里只是简单的用到什么查什么。</p>
<p>更多更详细的学习参考:</p>
<p><a target="_blank" rel="noopener" href="https://cn.overleaf.com/learn/latex/Mathematical_expressions">Latex数学公式编写介绍</a></p>
<p>接下来只是以简单的二元一次方程组为示例，来学习LateX的数学表达结构:</p>
<p>先来看看最终要的效果：</p>
<p><img src="/img/Unity/Math/XianXingFangCheng.png" alt="XianXingFangCheng"></p>
<p>实战：</p>
<p>这简单的二元一次方程，涉及到如下几个概念：</p>
<ul>
<li><p>[导入amsmath功能包](<a target="_blank" rel="noopener" href="https://cn.overleaf.com/learn/latex/Aligning">https://cn.overleaf.com/learn/latex/Aligning</a> equations with amsmath)</p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://cn.overleaf.com/learn/latex/Brackets_and_Parentheses">Brackets and Parentheses-括号</a></p>
</li>
<li><p>[Aligning equations with amsmath-公式对齐](<a target="_blank" rel="noopener" href="https://cn.overleaf.com/learn/latex/Aligning">https://cn.overleaf.com/learn/latex/Aligning</a> equations with amsmath)</p>
</li>
</ul>
<p>直接上最终LateX代码：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">\usepackage&#123;amsmath&#125;</span><br><span class="line"></span><br><span class="line">\begin&#123;align*&#125;</span><br><span class="line">&amp; \left( <span class="number">2</span>x - y = <span class="number">0</span> \right) \\</span><br><span class="line">&amp; \left( -x + <span class="number">2</span>y = <span class="number">3</span> \right)</span><br><span class="line">\end&#123;align*&#125;</span><br></pre></td></tr></table></figure>

<p>输出效果:</p>
<p><img src="/img/Unity/Math/LateXXianXingFangCheng.png" alt="LateXXianXingFangCheng"></p>
<p>上面没有找到如何输出{符号，忘知道的朋友告知。</p>
<p>上面这种表达方式，我们可以理解成方程组的<strong>行表达形式</strong></p>
<p><a target="_blank" rel="noopener" href="https://cn.overleaf.com/">在线编写LateX网址</a></p>
<p>上面那个LateX网址是收费的，其次是完全自己写LateX语法符号来编写数学公式。后来发现了更加可视化容易编写数学公式的在线免费网站，有兴趣的可以了解下：</p>
<p><a target="_blank" rel="noopener" href="https://www.mathcha.io/editor">mathcha</a></p>
<p>只需要按照规则输入符号就能打出想要的数学公式效果。</p>
<h4 id="公式可视化"><a href="#公式可视化" class="headerlink" title="公式可视化"></a>公式可视化</h4><p>解决了函数编写输出，那么肯定希望更直观的看到函数的二维坐标系绘图，这里我找到一个在线绘制数学函数的网站：</p>
<p><a target="_blank" rel="noopener" href="https://www.wolframalpha.com/examples/mathematics/">WolframAlpha</a></p>
<p><img src="/img/Unity/Math/MathmaticVisualization.png" alt="MathmaticVisualization"></p>
<h3 id="线性方程"><a href="#线性方程" class="headerlink" title="线性方程"></a>线性方程</h3><p>线性方程，这个应该是初中学习的知识，参考前面的示例来回顾一下：</p>
<p><img src="/img/Unity/Math/LateXXianXingFangCheng.png" alt="LateXXianXingFangCheng"></p>
<p><a href="%5Bhttps://zh.wikipedia.org/wiki/%E6%96%B9%E7%A8%8B%E7%BB%84%5D(https://zh.wikipedia.org/wiki/%E6%96%B9%E7%A8%8B%E7%BB%84)"><strong>方程组</strong>又称<strong>联立方程</strong>，是两个或两个以上含有多个[未知数]联立得到的[集]。未知数的值称为方程组的**[根]<strong>，求方程组根的过程称为</strong>解方程组**。</a></p>
<p>这里就不深入探讨了，总之就是解方程组。这里我们更关注的是方程组是如何和线性代数关联上的。</p>
<h3 id="线性代数"><a href="#线性代数" class="headerlink" title="线性代数"></a>线性代数</h3><p><a href="%5Bhttps://zh.wikipedia.org/wiki/%E7%BA%BF%E6%80%A7%E4%BB%A3%E6%95%B0%5D(https://zh.wikipedia.org/wiki/%E7%BA%BF%E6%80%A7%E4%BB%A3%E6%95%B0)"><strong>线性代数</strong>是关于向量空间的一个数学分支。它包括对线、面和子空间的研究，同时也涉及到所有的向量空间的一般性质。</a></p>
<p>前面的二元一次方程示例用不同的角度来思考和表达。</p>
<p>以<strong>列表达形式</strong>如下：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">\begin&#123;equation&#125;</span><br><span class="line">x \binom&#123;<span class="number">2</span>&#125;&#123;<span class="number">1</span>&#125; + y \binom&#123;<span class="number">-1</span>&#125;&#123;<span class="number">-2</span>&#125; = \binom&#123;<span class="number">0</span>&#125;&#123;<span class="number">3</span>&#125;</span><br><span class="line">\end&#123;equation&#125;</span><br></pre></td></tr></table></figure>

<p>效果：</p>
<p><img src="/img/Unity/Math/XianXingFangChengMatrixStyle.png" alt="XianXingFangChengMatrixStyle"></p>
<p>结合二维坐标系：</p>
<p><img src="/img/Unity/Math/ColumePictureXianXingFangCheng.png" alt="ColumePictureXianXingFangCheng"></p>
<p>图中是以向量的概念来绘制方程组图像，可以看到矩阵的概念已经呼之欲出了。</p>
<p>以矩阵的概念来表达如下：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">\qquad \qquad \qquad \qquad \qquad \quad</span><br><span class="line">$\begin&#123;bmatrix&#125;</span><br><span class="line"><span class="number">2</span> &amp; <span class="number">-1</span> \\</span><br><span class="line"><span class="number">-1</span> &amp; <span class="number">2</span></span><br><span class="line">\end&#123;bmatrix&#125;$</span><br><span class="line">$\begin&#123;bmatrix&#125;</span><br><span class="line">x \\</span><br><span class="line">y</span><br><span class="line">\end&#123;bmatrix&#125;$</span><br><span class="line">=</span><br><span class="line">$\begin&#123;bmatrix&#125;</span><br><span class="line"><span class="number">0</span> \\</span><br><span class="line"><span class="number">3</span></span><br><span class="line">\end&#123;bmatrix&#125;$</span><br></pre></td></tr></table></figure>

<p>效果：</p>
<p><img src="/img/Unity/Math/XianXingFangChengRealMatrixStyle.png" alt="XianXingFangChengRealMatrixStyle"></p>
<p> 以下<a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000016428152">截图来源</a>：</p>
<p><img src="/img/Unity/Math/JianHuaMatrix.png" alt="JianHuaMatrix"></p>
<p>可以看出落实到矩阵的概念上，就是对于向量的矩阵变换问题了。向量X通过矩阵A的变换变换到b。</p>
<p><strong>矩阵变换正是线性代数中的一部分。</strong></p>
<p><strong>矩阵可以帮助我们对于复杂的多维函数方程更方便的构造和求解。</strong></p>
<p>更多在线学习参考:</p>
<p><a target="_blank" rel="noopener" href="http://open.163.com/newview/movie/free?pid=M6V0BQC4M&mid=M6V29E773">方程组的几何解释</a></p>
<h2 id="插值"><a href="#插值" class="headerlink" title="插值"></a>插值</h2><p>相比前面的数学基础概念，总算进入更有趣的实战环节了。</p>
<p>插值缓动效果是指游戏里一些需要缓慢变化的动画效果(e.g. 移动位置插值，透明度变化插值，颜色变化插值等)。</p>
<p>一般来说在Unity里要实现插值，我们会直接通过类似Update(e.g. Update或Coroutine)的形式去累加时间，然后通过Unity提供的插值函数来获取当前插值的进度值，最终使用这个进度值参与插值运算得出最终插值效果。</p>
<p>所以我们会看到类似以下的代码:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Lerp挂载基类</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">LerpBaseMono</span> : <span class="title">MonoBehaviour</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Lerp时长</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">float</span> LerpDurationTime = <span class="number">2.0f</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 当前Lerp类型</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">protected</span> ELerpType mLerpType = ELerpType.None;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Use this for initialization</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Start</span> ()</span> &#123;</span><br><span class="line">        DoLerpPrepation();</span><br><span class="line">        StartCoroutine(LerpCoroutine());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 执行Lerp准备工作</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">DoLerpPrepation</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Lerp携程</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> IEnumerator <span class="title">LerpCoroutine</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> starttime = Time.time;</span><br><span class="line">        <span class="keyword">var</span> endtime = starttime + LerpDurationTime;</span><br><span class="line">        <span class="keyword">while</span>(Time.time &lt; endtime)</span><br><span class="line">        &#123;</span><br><span class="line">            DoLerp(starttime, endtime, Time.time);</span><br><span class="line">            <span class="keyword">yield</span> <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        DoLerp(starttime, endtime, Time.time);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 执行Lerp</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;starttime&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;endtime&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;currenttime&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">DoLerp</span>(<span class="params"><span class="built_in">float</span> starttime, <span class="built_in">float</span> endtime, <span class="built_in">float</span> currenttime</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> t = Mathf.InverseLerp(starttime, endtime, currenttime);</span><br><span class="line">        Debug.Log(<span class="string">$&quot;开始时间:<span class="subst">&#123;starttime&#125;</span>结束时间:<span class="subst">&#123;endtime&#125;</span>当前时间:<span class="subst">&#123;currenttime&#125;</span>当前缓动值:<span class="subst">&#123;t&#125;</span>&quot;</span>);</span><br><span class="line">        DoRealLerp(t);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 执行真实Lerp效果</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;t&quot;&gt;</span>缓动进度(0-1)<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">DoRealLerp</span>(<span class="params"><span class="built_in">float</span> t</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输出如下:</p>
<p><img src="/img/Unity/Math/UnityLerpOutput.png" alt="UnityLerpOutput"></p>
<p>接下来有了缓动的插值t,我们就可以做不同的缓动动画效果了。</p>
<p>上面的代码已经为挂载不同的缓动效果做了设计准备，接下来让我们实现三个简单的缓动效果:</p>
<ol>
<li>位移缓动</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> PositionLerpMono.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 位置Lerp组件</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PositionLerpMono</span> : <span class="title">LerpBaseMono</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 结束位置</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> Vector3 EndPos = Vector3.zero;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 开始位置</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">protected</span> Vector3 mStartPos;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 执行Lerp准备工作</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">DoLerpPrepation</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">base</span>.DoLerpPrepation();</span><br><span class="line">        mLerpType = ELerpType.LerpPosition;</span><br><span class="line">        mStartPos = transform.localPosition;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 执行真实Lerp效果</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;t&quot;&gt;</span>缓动进度(0-1)<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">DoRealLerp</span>(<span class="params"><span class="built_in">float</span> t</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        transform.localPosition = Vector3.LerpUnclamped(mStartPos, EndPos, t);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>缩放缓动</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> ScaleLerpMono.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 缩放缓动组件</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ScaleLerpMono</span> : <span class="title">LerpBaseMono</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 结束缩放值</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> Vector3 EndScale = Vector3.one;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 开始缩放值</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">protected</span> Vector3 mStartScale;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 执行Lerp准备工作</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">DoLerpPrepation</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">base</span>.DoLerpPrepation();</span><br><span class="line">        mLerpType = ELerpType.LerpScale;</span><br><span class="line">        mStartScale = transform.localScale;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 执行真实Lerp效果</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;t&quot;&gt;</span>缓动进度(0-1)<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">DoRealLerp</span>(<span class="params"><span class="built_in">float</span> t</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        transform.localScale = Vector3.LerpUnclamped(mStartScale, EndScale, t);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>透明度缓动</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> AlphaLerpMono.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 透明度缓动组件</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">RequireComponent(typeof(Graphic))</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">AlphaLerpMono</span> : <span class="title">LerpBaseMono</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 结束透明度</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">float</span> EndAlpha = <span class="number">0.0f</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Graphic组件</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">protected</span> Graphic mGraphicComponent;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 开始透明度</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">protected</span> <span class="built_in">float</span> mStartAlpha;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 执行Lerp准备工作</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">DoLerpPrepation</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">base</span>.DoLerpPrepation();</span><br><span class="line">        mGraphicComponent = GetComponent&lt;Graphic&gt;();</span><br><span class="line">        mStartAlpha = mGraphicComponent.color.a;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 执行真实Lerp效果</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;t&quot;&gt;</span>缓动进度(0-1)<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">DoRealLerp</span>(<span class="params"><span class="built_in">float</span> t</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> oldcolor = mGraphicComponent.color;</span><br><span class="line">        oldcolor.a = Mathf.Lerp(mStartAlpha, <span class="keyword">this</span>.EndAlpha, t);</span><br><span class="line">        mGraphicComponent.color = oldcolor;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>效果如下:</p>
<p><img src="/img/Unity/Math/LerpScreenShort.png" alt="LerpScreenShort"></p>
<p>通过上面可以看到我们已经实现了一个简陋版的不同Lerp效果的插值动画。</p>
<h3 id="插值线性方程"><a href="#插值线性方程" class="headerlink" title="插值线性方程"></a>插值线性方程</h3><p>接下来就要引入之前提到的线性方程了，从上面可以看出DoRealLerp里的参数t决定了缓动效果的最终进度值，现阶段t的值是通过世间累加然后Lerp插值到0-1的，也就是说是线性的速度。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> t = Mathf.InverseLerp(starttime, endtime, currenttime);</span><br></pre></td></tr></table></figure>

<p>这里的线性速度换成线性方程的话，可以理解成y&#x3D;x</p>
<p><img src="/img/Unity/Math/y=x%E5%87%BD%E6%95%B0%E5%9B%BE.png" alt="y&#x3D;x函数图"></p>
<p>也就是说如果我们把t的变化速度函数修改成其他的线性方程，那就能达到同样的Lerp效果以不同的插值函数来表现。</p>
<p>让我们先通过easings.net来预览下插值函数大概长什么样:</p>
<p><img src="/img/Unity/Math/EaseLerpFunction.png" alt="EaseLerpFunction"></p>
<p>这里核心思想是想替换t的插值计算方式，这里关于插值函数的代码就直接采用Github上现成的了:</p>
<p><a target="_blank" rel="noopener" href="https://gist.github.com/ManeFunction/9f2d437fca6ccf31e4a48fec0584e21a"><strong>EasingFunctions.cs</strong></a></p>
<p>修改基类代码如下:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Lerp挂载基类</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">LerpBaseMono</span> : <span class="title">MonoBehaviour</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Lerp时长</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">float</span> LerpDurationTime = <span class="number">2.0f</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 缓动类型</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> EasingFunction.Ease EaseType = EasingFunction.Ease.Linear;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Use this for initialization</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Start</span> ()</span> &#123;</span><br><span class="line">        StartCoroutine(LerpCoroutine());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 执行Lerp准备工作</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">DoLerpPrepation</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Lerp携程</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> IEnumerator <span class="title">LerpCoroutine</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        DoLerpPrepation();</span><br><span class="line">        <span class="keyword">var</span> starttime = Time.time;</span><br><span class="line">        <span class="keyword">var</span> endtime = starttime + LerpDurationTime;</span><br><span class="line">        <span class="keyword">while</span>(Time.time &lt; endtime)</span><br><span class="line">        &#123;</span><br><span class="line">            DoLerp(starttime, endtime, Time.time);</span><br><span class="line">            <span class="keyword">yield</span> <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        DoLerp(starttime, endtime, Time.time);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 执行Lerp</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;starttime&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;endtime&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;currenttime&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">DoLerp</span>(<span class="params"><span class="built_in">float</span> starttime, <span class="built_in">float</span> endtime, <span class="built_in">float</span> currenttime</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> t = Mathf.InverseLerp(starttime, endtime, currenttime);</span><br><span class="line">        <span class="keyword">var</span> easefunc = EasingFunction.GetEasingFunction(EaseType);</span><br><span class="line">        t = easefunc(<span class="number">0</span>, <span class="number">1</span>, t);</span><br><span class="line">        <span class="comment">//Debug.Log($&quot;缓动类型:&#123;this.EaseType&#125;开始时间:&#123;starttime&#125;结束时间:&#123;endtime&#125;当前时间:&#123;currenttime&#125;当前缓动值:&#123;t&#125;&quot;);</span></span><br><span class="line">        DoRealLerp(t);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 执行真实Lerp效果</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;t&quot;&gt;</span>缓动进度(0-1)<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">DoRealLerp</span>(<span class="params"><span class="built_in">float</span> t</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样一来我们就成功的替换了缓动的线性方程，且限定了缓动值t在0-1范围内，实现了不同缓动速度的t。</p>
<p>让我们来看看最终效果:</p>
<p><img src="/img/Unity/Math/EasingFuncLerpPos.png" alt="EasingFuncLerpPos"></p>
<p>正如我们预期的那样，同样的终点和持续时间，三个不同缓动类型(线性方程)的移动插值，表现出了不一样的速度变化。</p>
<h3 id="插值组件"><a href="#插值组件" class="headerlink" title="插值组件"></a>插值组件</h3><p>上面我们的缓动组件已经雏形已经有了，接下来就是重新好好设计重构以下我们的缓动组件来达到通过挂在缓动组件能快速得到类似Dotween一样的代码效果。</p>
<p>用过<a target="_blank" rel="noopener" href="http://dotween.demigiant.com/documentation.php">Dotween</a>都知道Dotween通过扩展方法的形式和泛型的形式，方便的支持了快速调用动画接口，接下来来看看Dotween几个大的概念设计：</p>
<ul>
<li>Tweener<ul>
<li><a target="_blank" rel="noopener" href="http://dotween.demigiant.com/documentation.php">A tween that takes control of a value and animates it.</a></li>
</ul>
</li>
<li>Sequence<ul>
<li><a target="_blank" rel="noopener" href="http://dotween.demigiant.com/documentation.php">A special tween that, instead of taking control of a value, takes control of other tweens and animates them as a group.</a></li>
</ul>
</li>
</ul>
<p>Tweener是单个动画对象的抽象。</p>
<p>Sequence是多个动画Tweener的组合管理抽象。</p>
<p>所以借助于Tweener和Sequence再加上内部插值缓动的Ease的支持，能快速的触发各种缓动方程的动画组合拼接。</p>
<p>这里就不详细讲解Dotween的学习使用了，这里放一张官网Sequence的代码示例来感受一下，Dotween是如何快捷高效的支持多种缓动方程多个动画效果的编写的:</p>
<p><img src="/img/Unity/Math/DotweenSequenceUsing.png" alt="DotweenSequenceUsing"></p>
<p>接下来参考Dotween的设计，我将动画组件UML设计如下:</p>
<p><img src="/img/Unity/Math/TAnimationUML.png" alt="TAnimationUML"></p>
<p>编辑器面板扩展模拟播放:</p>
<p><img src="/img/Unity/Math/InspectorSimulation.png" alt="InspectorSimulation"></p>
<p>可以把上面的设计理解成组件版的简陋Dotween:</p>
<ul>
<li><p>TBaseAnimation.cs</p>
<p>所有插值动画的基类(抽象网络插值动画的流程以及基础支持),支持是否Awake时自动播放，插值类型，延迟时间，持续时间，循环类型设置等基础设置</p>
</li>
<li><p>TBaseAnimationEditor.cs</p>
<p>插值动画自定义面板，核心扩展支持了Editor快速模拟播放，暂停，继续，停止按钮功能。</p>
</li>
<li><p>TSequenceAnimation.cs</p>
<p>序列动画抽象,负责像Dotween的Sequence一样管理一系列TBaseAnimation的整体播放效果(比如线性播放和并发播放，目前仅支持单次或无限循环播放两种方式)</p>
</li>
<li><p>TSequenceAnimationEditor.cs</p>
<p>序列动画的自定义面板，核心是通过SerializeObject和SerializeProperty编写支持Undo的自定义序列动画面板，同时支持了Editor快速模拟播放，暂停，继续，停止按钮功能。</p>
</li>
<li><p>EasingFunctions.cs</p>
<p>Git上找的关于不同插值动画类型的核心函数方程定义,把时间插值比列通过不同的函数方程计算出不同的插值系数，从而实现不同的插值方程式的插值动画效果</p>
</li>
<li><p>TPositionAnimation.cs, TScaleAnimation.cs, TAlphaAnimation.cs ……</p>
<p>落实到具体的插值动画类型的实现类</p>
</li>
</ul>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><ol>
<li>通过起始时间，结束时间，当前时间我们可以计算出当前的插值比例。然后通过数学方程将插值比例使用不同的数学方程转换成我们不同插值类型的插值比例从而得到我们想要的不同函数插值效果。</li>
<li>组件式的插值动画相比之下没有纯代码(e.g. Dotween)那么高效和可控，但重用性高，方便快速制作简单的程序化动画。</li>
<li>SerializeObject和SerializeProperty的使用就好比对象和反射属性之间的概念和关系，使用SerializeObject和SerilizeProperty能方便的使用Unity的Undo系统。</li>
</ol>
<h1 id="Git地址"><a href="#Git地址" class="headerlink" title="Git地址"></a>Git地址</h1><p><a target="_blank" rel="noopener" href="https://github.com/TonyTang1990/Ease-Component">Ease Component</a></p>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a target="_blank" rel="noopener" href="https://dev.twsiyuan.com/2017/02/tween-animation-and-easing-functions-in-unity.html">Animation &amp; Easing functions in Unity (Tween)</a></p>
<p><a target="_blank" rel="noopener" href="https://easings.net/">Easing functions</a></p>
<p><a target="_blank" rel="noopener" href="https://gist.github.com/ManeFunction/9f2d437fca6ccf31e4a48fec0584e21a">EasingFunctions GitHub</a></p>
<p><a target="_blank" rel="noopener" href="http://dotween.demigiant.com/getstarted.php">Dotween</a></p>
<p><a target="_blank" rel="noopener" href="https://whichxjy.com/my-dotween/">DOTween 动画引擎仿写</a></p>
<p><a href="%5Bhttps://zh.wikipedia.org/wiki/%E7%BA%BF%E6%80%A7%E4%BB%A3%E6%95%B0%5D(https://zh.wikipedia.org/wiki/%E7%BA%BF%E6%80%A7%E4%BB%A3%E6%95%B0)">线性代数</a></p>
<p><a target="_blank" rel="noopener" href="http://open.163.com/newview/movie/free?pid=M6V0BQC4M&mid=M6V29E773">方程组的几何解释</a></p>
<p><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000016428152">线性代数与方程的关系（笔记）</a></p>
<p><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/LaTeX">LATEX</a></p>
<p><a href="%5Bhttps://cn.overleaf.com%5D(https://cn.overleaf.com/)">在线编写LateX网址</a></p>
<p><a target="_blank" rel="noopener" href="https://cn.overleaf.com/learn/latex/Mathematical_expressions">Latex数学公式编写介绍</a></p>
<p><a target="_blank" rel="noopener" href="https://www.wolframalpha.com/examples/mathematics/">WolframAlpha</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Math/">Math</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Math/">Math</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2020/02/01/Unity嵌套预制件/" title="Unity嵌套预制件" itemprop="url">Unity嵌套预制件</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Tony Tang" target="_blank" itemprop="author">Tony Tang</a>
		
  <p class="article-time">
    <time datetime="2020-01-31T16:27:00.000Z" itemprop="datePublished"> 发表于 2020-02-01</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>本篇文章是为了记录学习Unity官方最新推出的嵌套预制件工作流的相关知识，深入理解新版嵌套预制件的设计思路与使用工作流。</p>
<p>达到以下几个目标：</p>
<ol>
<li>理解新版嵌套预制件带来的好处</li>
<li>如何避免Unity版本升级过程中预制件相关操作工具不兼容等问题。</li>
<li>设计新的预制件相关工具时考虑新老版本预制件工作流问题。</li>
</ol>
<h2 id="Prefab"><a href="#Prefab" class="headerlink" title="Prefab"></a>Prefab</h2><p>首先我们先来了解下什么是预制件(Prefab)？<br><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/Prefabs.html"> **Unity’s Prefab system allows you to create, configure, and store a GameObject complete with all its components, property values, and child GameObjects<br> as a reusable Asset. The Prefab Asset acts as a template from which you can create new Prefab instances in the SceneA Scene contains the environments and menus of your game. Think of each unique Scene file as a unique level. In each Scene, you place your environments, obstacles, and decorations, essentially designing and building your game in pieces. More info<br>See in Glossary. </a></p>
<p><strong>根据官网的介绍我们可以得知，在Unity中Prefab和纹理，材质，音效一样都是一种资源格式，预制件(Prefab)其实是一个资源载体(e.g. GameObject包含层级以及多种Component脚本做成的重用实体对象)，为了方便重复使用做好的资源模版。</strong></p>
<p>老版本预制件系统问题：</p>
<ol>
<li>不支持嵌套预制件</li>
<li>不支持变体预制件(后续会介绍)</li>
</ol>
<p>新版本预制件很好的解决了上面说到的两个问题。</p>
<p><strong>新版预制件在Unity 2018.3推出</strong><br>新版预制件主要由以下三个部分组成：</p>
<ol>
<li>嵌套预制件</li>
<li>预制件变体</li>
<li>预制件模式</li>
</ol>
<p>接下来挨个学习上面三个部分。</p>
<p>Note：<br><strong>新版Prefab是一种Asset，但打开处理的时候更多的是一种对Content的封装的概念，打开Prefab Mode是指打开Prefab浏览编辑Prefab Content</strong></p>
<h3 id="嵌套预制件"><a href="#嵌套预制件" class="headerlink" title="嵌套预制件"></a>嵌套预制件</h3><p>嵌套预制件顾名思义是指预制件之间是允许引用使用的关系而不是完全独立复制使用的概念。<br>老版本预制件系统就是采用复制实体引用的方式。<br><strong>而新版嵌套预制件是采用真实预制件引用的方式。</strong></p>
<p>嵌套预制件举例说明：<br>预制件A里用到了预制件B，如果我们修改预制件B，那么预制件A应该是自动更新变化。</p>
<p>嵌套预制件实战：<br>如下所示，我们制作了三个预制件，分别是Prefab_Cube_A,Prefab_Sphere_B以及Prefab_A_And_B,其中前两者是独立的预制件，最后一个是使用前两个预制件拼接而成的新的预制件。<br><img src="/img/Unity/NestedPrefab/NestedPrefabExample.png" alt="NestedPrefabExample"></p>
<p>可以看到嵌套的预制件在新的预制件下是蓝色的(意味着是关联了特定预制件的意思)，为了验证嵌套预制件，我简单的修改Prefab_Cube_A颜色来达到实现我们预期的嵌套预制件是引用关系的验证：<br><img src="/img/Unity/NestedPrefab/NestedPrefabChangeMat.png" alt="NestedPrefabChangeMat"><br>可以看到我们只修改了预制件Prefab_Cube_A的材质，但嵌套使用该预制件的Prefab_A_And_B里的Prefab_A也跟着变化了，这就是前面所提到的<strong>嵌套预制件的概念(嵌套引用关系而非实例化新个体)</strong></p>
<h3 id="预制件变体"><a href="#预制件变体" class="headerlink" title="预制件变体"></a>预制件变体</h3><p>预制件变体的概念类似于编程里继承的概念，继承属性的同时，父预制件的修改也会影响到子预制件变体。</p>
<p><strong>预制件变体不仅继承了父预制件的状态数据，还跟父预制件是强制关联的。</strong><br>举例说明：<br>通过预制件A创建预制件变体A2，当我们改变A时，A2继承的相同属性会跟着变化<br><img src="/img/Unity/NestedPrefab/NestedPrefabPrefabVariant.png" alt="NestedPrefabPrefabVariant"><br><img src="/img/Unity/NestedPrefab/NestedPrefabChangeVariantParent.png" alt="NestedPrefabChangeVariantParent"></p>
<p>适用情况：</p>
<ol>
<li>需要在个别Prefab基础上做少许做成预制件使用，同时需要同步父预制件修改的情况下。</li>
</ol>
<p>Note:</p>
<ol>
<li><strong>预制件变体可以理解成封装了一层Prefab的Prefab Asset</strong></li>
<li><strong>预制件变体的Content根节点时Prefab而Prefab的Content根节点时GameObject</strong></li>
</ol>
<h3 id="新版预制件工作流"><a href="#新版预制件工作流" class="headerlink" title="新版预制件工作流"></a>新版预制件工作流</h3><p>Prefab有两种状态：</p>
<ol>
<li>Prefab Asset(Prefab资源)</li>
<li>Prefab Instance(Prefab实例对象–场景里是蓝色的)<br>Prefab Instance和Prefab Asset之间是关联着的，跟老版预制件里的概念是一致的。我们可以通过修改Prefab Instance然后把改变Apply到Prefab Asset上。<strong>新版预制件有区别的是支持Component级别的Apply和Revert。</strong><br><img src="/img/Unity/NestedPrefab/NestedPrefabComponentApply.png" alt="NestedPrefabComponentApply"></li>
</ol>
<p>还有一种独立于预制件的状态：实例对象<br><img src="/img/Unity/NestedPrefab/UnpackPrefabInstance.png" alt="UnpackPrefabInstance"><br>于预制件无关的实体对象是黑色的而非蓝色:<br><img src="/img/Unity/NestedPrefab/NestedPrefabUnpackPrefabColor.png" alt="NestedPrefabUnpackPrefabColor"><br><strong>这里的Unpack相当于解除了Prefab Asset关联直接访问预制件的Content(Prefab Content后续会说到，在新版预制件里很重要的一个概念)</strong></p>
<p>新版预制件有一个新的概念叫做预制件模式，修改并Apply修改到Prefab Asset上有两种方式：</p>
<ol>
<li>直接打开Prefab Mode编辑</li>
<li>修改Prefab Instance后Apply到Prefab Asset上</li>
</ol>
<p>这里重点讲解学习Prefab Mode：<br><strong>Prefab Mode类似单独打开了一个修改预制件的场景，进入新的预制件场景才能看到预制件里的内容，这一点概念很重要</strong><br><img src="/img/Unity/NestedPrefab/NestedPrefabOpenPrefabMode.png" alt="NestedPrefabOpenPrefabMode"><br><img src="/img/Unity/NestedPrefab/NestedPrefabMode.png" alt="NestedPrefabMode"><br>在Prefab Mode下的修改可以通过保存和Undo操作来实现保存到Prefab Asset和撤销操作的效果。</p>
<p>了解了新版Prefab的Prefab Mode概念后，让我们结合相关API来制作一些新版Prefab的处理操作工具来深入理解：<br>需求：<br>检查指定Prefab里是否有无效的脚本挂在(Missing Script)并清除所有无效挂在脚本后保存Prefab Asset<br><img src="/img/Unity/NestedPrefab/NestedPrefabMissingScriptMono.png" alt="NestedPrefabMissingScriptMono"></p>
<p>相关API：</p>
<ol>
<li>AssetDatabase(处理Asset的工具类接口)</li>
<li>Selection(处理Asset资源选中工具类接口)</li>
</ol>
<p>步骤：</p>
<ol>
<li>选中Prefab Asset</li>
<li>判定是否是选中Prefab Asset</li>
<li>打开Prefab Mode</li>
<li>查找并删除所有Missing Script</li>
<li>保存Prefab Asset并退出Prefab Mode<br>实现：<br>RemovePrefabMissingScriptTool.cs</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEditor;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 删除预制件无效脚本引用工具</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">RemovePrefabMissingScriptTool</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">MenuItem(<span class="string">&quot;Tools/Assets/移除Missing脚本 #&amp;s&quot;</span>, false)</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">RemoveAllMissingScripts</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 1. 选中Prefab Asset</span></span><br><span class="line">        <span class="keyword">var</span> selections = Selection.GetFiltered(<span class="keyword">typeof</span>(Object), SelectionMode.Assets | SelectionMode.DeepAssets);</span><br><span class="line">        Debug.Log(<span class="string">$&quot;选中有效数量:<span class="subst">&#123;selections.Length&#125;</span>&quot;</span>);</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> selection <span class="keyword">in</span> selections)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(IsPrefabAsset(selection))</span><br><span class="line">            &#123;</span><br><span class="line">                RemovePrefabAllMissingScripts(selection <span class="keyword">as</span> GameObject);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                Debug.LogError(<span class="string">$&quot;不符合预制件要求的Asset:<span class="subst">&#123;selection.name&#125;</span>&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        AssetDatabase.SaveAssets();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 是否是预制件资源</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;obj&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">bool</span> <span class="title">IsPrefabAsset</span>(<span class="params">Object obj</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(obj <span class="keyword">is</span> GameObject)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> assetpath = AssetDatabase.GetAssetPath(obj);</span><br><span class="line">            <span class="keyword">return</span> !<span class="built_in">string</span>.IsNullOrEmpty(assetpath);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 移除预制件Asset所有无效的脚本</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">RemovePrefabAllMissingScripts</span>(<span class="params">GameObject go</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 3. 打开Prefab Mode</span></span><br><span class="line">        <span class="comment">// 4. 查找并删除所有Missing Script</span></span><br><span class="line">        <span class="comment">// 5. 保存Prefab Asset并推出Prefab Mode)</span></span><br><span class="line">        <span class="keyword">var</span> assetpath = AssetDatabase.GetAssetPath(go);</span><br><span class="line">        <span class="keyword">var</span> contentsRoot = PrefabUtility.LoadPrefabContents(assetpath);</span><br><span class="line">        RemoveAllMissingScripts(contentsRoot);</span><br><span class="line">        PrefabUtility.SaveAsPrefabAsset(contentsRoot, assetpath);</span><br><span class="line">        PrefabUtility.UnloadPrefabContents(contentsRoot);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 移除无效的脚本</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">RemoveAllMissingScripts</span>(<span class="params">GameObject go</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Component[] components = go.GetComponents&lt;Component&gt;();</span><br><span class="line">        <span class="keyword">var</span> r = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">var</span> serializedObject = <span class="keyword">new</span> SerializedObject(go);</span><br><span class="line">        <span class="keyword">var</span> prop = serializedObject.FindProperty(<span class="string">&quot;m_Component&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; components.Length; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (components[i] == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">string</span> s = go.name;</span><br><span class="line">                Transform t = go.transform;</span><br><span class="line">                <span class="keyword">while</span> (t.parent != <span class="literal">null</span>) </span><br><span class="line">                &#123;</span><br><span class="line">                    s = t.parent.name +<span class="string">&quot;/&quot;</span>+s;</span><br><span class="line">                    t = t.parent;</span><br><span class="line">                &#125;</span><br><span class="line">                Debug.Log (s + <span class="string">&quot; has an empty script attached in position: &quot;</span> + i, go);</span><br><span class="line"></span><br><span class="line">                prop.DeleteArrayElementAtIndex(i - r);</span><br><span class="line">                r++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        serializedObject.ApplyModifiedProperties();</span><br><span class="line">        <span class="keyword">foreach</span> (Transform childT <span class="keyword">in</span> go.transform)</span><br><span class="line">        &#123;</span><br><span class="line">            RemoveAllMissingScripts(childT.gameObject);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>核心思想是因为Missing Component本来就为Null无法向常规Component那样DestroyImmediate，需要通过SerializedObject去获取Component的方式删除指定位置的Component。</p>
<p>此脚本只针对单个预制件内容进行修改，嵌套预制件需要通过批量多选的方式实现各自移除各自身上的Missing Script来实现移除所有Missing脚本。</p>
<p>了解了Prefab Mode的存在，那么如何监听Prefab Mode的打开关闭生命周期了？<br>这里我们需要用到<strong>PrefabStage</strong> API(新版Prefab Mode下打开保存相关生命周期工具类接口)<br>这里只是简单的做个API实验，看看PrefabStage是否起作用。<br>PrefabStageListener.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEditor.Experimental.SceneManagement;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 新版预制件生命周期监听</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">ExecuteInEditMode</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PrefabStageListener</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Start</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        PrefabStage.prefabSaved += OnPrefabSaved;</span><br><span class="line">        PrefabStage.prefabSaving += OnPrefabSaving;</span><br><span class="line">        PrefabStage.prefabStageOpened += OnPrefabOpened;</span><br><span class="line">        PrefabStage.prefabStageClosing += OnPrefabClosing;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnDestroy</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        PrefabStage.prefabSaved -= OnPrefabSaved;</span><br><span class="line">        PrefabStage.prefabSaving -= OnPrefabSaving;</span><br><span class="line">        PrefabStage.prefabStageOpened -= OnPrefabOpened;</span><br><span class="line">        PrefabStage.prefabStageClosing -= OnPrefabClosing;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 响应预制件内容保存完毕</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;go&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnPrefabSaved</span>(<span class="params">GameObject go</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Debug.Log(<span class="string">&quot;预制件内容保存完毕!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 响应预制件内容保存</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;go&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnPrefabSaving</span>(<span class="params">GameObject go</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Debug.Log(<span class="string">&quot;预制件内容保存!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 响应预制件内容打开</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;prefabstage&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnPrefabOpened</span>(<span class="params">PrefabStage prefabstage</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Debug.Log(<span class="string">&quot;打开预制件内容!&quot;</span>);</span><br><span class="line">        Debug.Log(<span class="string">$&quot;预制件:<span class="subst">&#123;prefabstage.prefabAssetPath&#125;</span> 内容阶段:<span class="subst">&#123;prefabstage.stageHandle&#125;</span>&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 响应预制件内容关闭</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;prefabstage&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnPrefabClosing</span>(<span class="params">PrefabStage prefabstage</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Debug.Log(<span class="string">&quot;关闭预制件内容!&quot;</span>);</span><br><span class="line">        Debug.Log(<span class="string">$&quot;预制件:<span class="subst">&#123;prefabstage.prefabAssetPath&#125;</span> 内容阶段:<span class="subst">&#123;prefabstage.stageHandle&#125;</span>&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结果:<br><img src="/img/Unity/NestedPrefab/PrefabStageListener.png" alt="PrefabStageListener"><br><strong>PrefabStage.prefabStageOpened全局监听不起作用(原因未知，忘知道的朋友告知)。PrefabStage.prefabStageClosing能正确工作。</strong></p>
<p>Note:<br><strong>Prefab Mode模式下修改叫做Save而非Apply，因为已经处于Prefab Content模式下了</strong></p>
<h3 id="进阶"><a href="#进阶" class="headerlink" title="进阶"></a>进阶</h3><p>PrefabUtility(操作处理Prefab的工具类接口)</p>
<p>更多学习，待续……</p>
<h2 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h2><ol>
<li>支持嵌套预制件，能更高效的利用预制件，节约预制件的资源大小</li>
<li>支持预制件变体，能更高效的制作只有细微变化且有关联的相关预制件，增加开发效率</li>
<li>新版预制件最大区别就是提出了Prefab Mode的概念，让预制件在一个独立的环境进行编辑，进入Prefab Mode编辑的是Prefab Content而非Prefab本身。</li>
</ol>
<h1 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h1><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/Prefabs.html">Prefabs Manual</a><br><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/283752d80737">详解新版Unity中可嵌套的Prefab系统</a><br><a target="_blank" href="https://www.youtube.com/embed/b9wfVzkubzA?autoplay=1&amp;disablekb=1&amp;iv_load_policy=3&amp;modestbranding=1&amp;showinfo=0&amp;html5=1&amp;rel=0">Introducing the new prefab workflow - Unity at GDC 2019</a><br><a target="_blank" rel="noopener" href="https://www.youtube.com/embed/5q1An6SFe40?autoplay=1&disablekb=1&iv_load_policy=3&modestbranding=1&showinfo=0&html5=1">Unite LA 2018 - Introducing the New Prefab Workflow</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/Prefab/">Prefab</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2019/11/25/Unity官方插件/" title="Unity官方插件" itemprop="url">Unity官方插件</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Tony Tang" target="_blank" itemprop="author">Tony Tang</a>
		
  <p class="article-time">
    <time datetime="2019-11-25T13:27:18.000Z" itemprop="datePublished"> 发表于 2019-11-25</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>本篇文章是为了记录学习Unity官方一些好的第三方插件，作为基础的学习了解，为未来遇到问题思考解决方案时拓宽思路。</p>
<h2 id="Sprite-Atlas"><a href="#Sprite-Atlas" class="headerlink" title="Sprite Atlas"></a>Sprite Atlas</h2><p>依然从What，Why，How三个角度了学习了解Sprite Atlas。</p>
<h3 id="What"><a href="#What" class="headerlink" title="What"></a>What</h3><p>Sprite Atlas是官方Sprite Packer的升级版本，是为了更好的解决图集打包加载问题而开发的，而图集是为了解决Draw Call问题。</p>
<h3 id="Why"><a href="#Why" class="headerlink" title="Why"></a>Why</h3><p>老版Unity的时候，图集打包功能(SpritePacker,打Tag的方式)并不完善，更多的是采用第三方好比TexturePacker打包图集在放到Unity项目里的工作流。</p>
<p>Sprite Atlas主要提供了以下三个功能:<br>1.创建、编辑图集以及设定图集参数<br>2.添加图集Variant（变种）<br>3.运行时访问图集</p>
<p>新版Sprite Atals已经很完善了，考虑到以下几个原因，决定学习官方的打包图集工具跟着官方走:</p>
<ol>
<li>TexturePacker是付费的,Sprite Atlas免费</li>
<li>Sprite Atlas是官方的，跟官方走一般来说不会错</li>
<li>Spritre Atlas已经成熟可以商用的级别</li>
</ol>
<h3 id="How"><a href="#How" class="headerlink" title="How"></a>How</h3><p>使用Sprite Atlas之前，我们需要打开Sprite Atlas功能开关：<br>Edit -&gt; Project Setting -&gt; Editor -&gt; Sprite Packer -&gt; Mode(Always Enable)<br><img src="/img/Unity/SpriteAtlas/EnableSpriteAtlas.png" alt="EnableSpriteAtlas"></p>
<h4 id="创建、编辑图集以及设定图集参数"><a href="#创建、编辑图集以及设定图集参数" class="headerlink" title="创建、编辑图集以及设定图集参数"></a>创建、编辑图集以及设定图集参数</h4><p>在Sprite Atlas里Sprite Atlas是作为一种资源(Asset)存在。<br>创建Sprite Atlas：<br>右键 -&gt; Sprite Atlas</p>
<p>选中创建的Sprite Atlas我们能看到相关设置:<br><img src="/img/Unity/SpriteAtlas/SpriteAtlasSetting.png" alt="SpriteAtlasSetting"><br>这里的设置基本都和图集打包相关，这里就不一一详解了。<br>详情参见官网:<br><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/class-SpriteAtlas.html">Sprite Atlas</a></p>
<p>点击Sprite Atlas -&gt; Pack Preview即可查看打包后的结果:<br><img src="/img/Unity/SpriteAtlas/PackPreview.png" alt="PackPreview"></p>
<p>这里关于Include in Build这个参数要详细说明一下，这个参数会决定一下几方面:</p>
<ol>
<li>影响使用SpriteAtlas图集资源的资源是如何关联SpriteAtlas的(会决定使用该SpriteAtlas资源加载时加载哪一个图集资源–这里指的是有图集Variant的情况)</li>
<li>影响SpriteAtlas是否需要采用Later Bind(触不触发SpriteAtlasManager.atlasRequested接口,通过这个接口结合图集Variant我们可以做到例如不同平台加载不同图集的适配)。反之勾选Include in Build在依赖使用时会自动加载依赖的Sprite Atlas。<br><strong>这里貌似有些Unity版本有个Bug，勾选Include in Build会导致资源打包冗余</strong><br><img src="/img/Unity/SpriteAtlas/IncludeInBuildCauseRedundancySpriteAtlasTexture.png" alt="IncludeInBuildCauseRedundancySpriteAtlasTexture"></li>
</ol>
<p>针对第一条详情参考:<br><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/SpriteAtlasScenarios.html">Resolving different Sprite Atlas scenarios</a></p>
<p>Note:</p>
<ol>
<li><strong>Sprite Atlas支持Objects for Packing设置文件夹</strong></li>
<li><strong>参与打包的图片必须设置成Sprite(2D and UI)格式</strong></li>
<li><strong>Include in Build会影响SpriteAtlas的选择(比如是否要使用Later Bind等)</strong></li>
</ol>
<h4 id="添加图集Variant（变种）"><a href="#添加图集Variant（变种）" class="headerlink" title="添加图集Variant（变种）"></a>添加图集Variant（变种）</h4><p>什么是图集Variant?<br><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/VariantSpriteAtlas.html">A Variant Sprite Atlas is a type of Sprite Atlas that does not contain its own list of selected Textures as it has no Objects for Packing list in its properties. Instead, it receives a copy of the content from the Sprite Atlas set as its Master Atlas.</a><br>图集Variant是指不能指定打包内容的图集，图集Variant内容来源于复制指定的Master图集。</p>
<p>图集Variant的适用场景?<br>图集Variant的主要目的是为了用于不同分辨率设备适配不同图集来实现，内存和效果的可控。</p>
<p>图集Variant设置适用：<br><img src="/img/Unity/SpriteAtlas/SpriteAtlasVariants.png" alt="SpriteAtlasVariants"><br>可以看到我们创建一个SpriteAtlas把Type设置成Variant后，然后指定Master Atlas，最后通过调节Scale为0.5我们得到了比playerpreview图集小一倍大小的图集效果。</p>
<p>结论:</p>
<p>图集变体是类似Mipmap的东西，通过多打包多个不同大小的图集到游戏里，Unity自动帮我们选择合适的图集来加载，从而做到高分辨率机型加载高分辨率的，低分辨率机型加载低分辨率的，<strong>典型的空间换时间做法</strong>。</p>
<p>Note:</p>
<ol>
<li><strong>要想只打包使用图集Variant，需要把图集Variant的Include in Build打开，把图集Master的Include in Build关闭</strong></li>
</ol>
<h4 id="运行时访问图集"><a href="#运行时访问图集" class="headerlink" title="运行时访问图集"></a>运行时访问图集</h4><p><a target="_blank" rel="noopener" href="https://gameinstitute.qq.com/community/detail/127434">Sprite Atlas作为一种资源开放给用户，支持在脚本中直接访问，还可以通过名字获取图集中的精灵。</a></p>
<p><strong>这里我们采用设置不勾选Include in Build的设置打包SpriteAtlas</strong></p>
<p>接下来我们通过SpriteAtlas接口访问打包AB后的Sprite Atlas里的图片资源试试：<br>首先让我们看看SpriteAtlas打包AB后的的资源数据：<br><img src="/img/Unity/SpriteAtlas/SpriteAtlasAssetBundlePreview.png" alt="SpriteAtlasAssetBundlePreview"><br>可以看到SpriteAtlas作为资源参与AB打包，里面包含了SpriteAtlas，图集Texture2D以及Sprite数据。</p>
<p>这里我们看看UI预制件引用SpriteAtlas看看依赖打包的情况：<br><img src="/img/Unity/SpriteAtlas/UIPrefabReferenceNotIncludeBuildSpriteAtlas.png" alt="UIPrefabReferenceNotIncludeBuildSpriteAtlas"><br>从上面可以看出UI窗口预制件包含了依赖的Sprite(这里和以前不一样，以前是不会包含依赖的Sprite的，会直接通过依赖关系加载依赖AB实现自动还原)，个人猜测这个和后续讲到的SpriteAtlas的Later Bind有关。</p>
<p>加载UI窗口预制件后发现Sprite Missing了:<br><img src="/img/Unity/SpriteAtlas/UIPrefabSpriteMissing.png" alt="UIPrefabSpriteMissing"><br>通过查看依赖文件我发现依赖信息是没有对SpriteAtlas的依赖信息的。<strong>不知道这算不算是一个Bug还是设计如此，因为没有依赖信息对资源加载管理会造成问题，忘知道的朋友告知。</strong><br><img src="/img/Unity/SpriteAtlas/UIPrefabDepencency.png" alt="UIPrefabDepencency"></p>
<p>问题:</p>
<ol>
<li><strong>加载使用SpriteAtlas的UI Prefab，SpriteAtlas会自动加载进内存且没有依赖信息。但如果此时主动加载了Sprite Atlas并主动强制卸载该Sprite Atlas的AB会导致UI Prefab使用的Sprite Atlas也跟随被清除。从这里看出UI Prefab对Sprite Atlas的依赖信息是有必要的，不然没法正确的管理资源加载。</strong></li>
</ol>
<p>这里引申出了SpriteAtlas一个很重要的功能，<strong>Later Bind</strong></p>
<p>Note:</p>
<ol>
<li><strong>图集的被动(依赖)加载管理会有使用该图集的资源所决定(比如UI Prefab使用了SpriteAtlas，两个分别打包AB，这时加载UI Prefab后SpriteAtlas会自动加载进内存，而UI Prefab卸载以后，SpriteAtlas没有其他主动加载该SpriteAtlas的会自动卸载。)</strong></li>
</ol>
<h5 id="Later-Bind"><a href="#Later-Bind" class="headerlink" title="Later Bind"></a>Later Bind</h5><p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/80584461">SpritePacker时代“图集”我们是看不到的，因为设计者的初衷是想让开发者完全不用考虑图集的事。但是，这跟游戏开发时的动态加载图集时矛盾的！我们要动态加载就必须要知道atlas名字和sprite名，这样才能在 运行时动态的找到一张sprite！所以U3D程序员必须要清楚的知道你当前界面用的是哪atlas的哪个sprite。但是按照SpritePacker的做法他的初衷应该是想把图集干掉（干掉的意思让开发者不用关心），只需要考虑sprite即可，但是这是行不通的！<br>**SpriteAtlas其实就是为了解决上面说的问题而发布的功能。通过它我们可以将atlas和UIprefab“解耦”。同时，在Unity编辑器状态下我们仍然可以利用未打成SpriteAtlas的Sprite进行开发。等开发完成我们再发布成SpriteAtlas。**Unity提供了所谓“延迟绑定”（late bind）的技术来让我们实现这个功能。</a></p>
<p>AtlasManager.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">AtlasManager</span> : <span class="title">SingletonTemplate</span>&lt;<span class="title">AtlasManager</span>&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AtlasManager</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        DIYLog.Log(<span class="string">&quot;添加SpriteAtals图集延时绑定回调!&quot;</span>);</span><br><span class="line">        SpriteAtlasManager.atlasRequested += onAtlasRequested;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 响应SpriteAtlas图集加载回调</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;atlasname&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;callback&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onAtlasRequested</span>(<span class="params"><span class="built_in">string</span> atlasname, Action&lt;SpriteAtlas&gt; callback</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        DIYLog.Log(<span class="string">$&quot;加载SpriteAtlas:<span class="subst">&#123;atlasname&#125;</span>&quot;</span>);</span><br><span class="line">        <span class="comment">// Later Bind -- 依赖使用SpriteAtlas的加载都会触发这里</span></span><br><span class="line">        ResourceModuleManager.Singleton.requstResource(</span><br><span class="line">        atlasname,</span><br><span class="line">        (abi) =&gt;</span><br><span class="line">        &#123;</span><br><span class="line">            DIYLog.Log(<span class="string">$&quot;Later Bind加载SpriteAtlas:<span class="subst">&#123;atlasname&#125;</span>&quot;</span>);</span><br><span class="line">            <span class="keyword">var</span> sa = abi.loadAsset&lt;SpriteAtlas&gt;(atlasname);</span><br><span class="line">            callback(sa);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在加载使用SpriteAtlas(<strong>仅当设置成不勾选Include in Build</strong>)的相关资源时(比如UI Prefab)上诉回调会被触发完成对SpriteAtlas的加载，确保引用的Sprite能正确显示。同时这一机制就允许我们做到不同平台的不同图集资源加载适配这样的功能。</p>
<p>疑问:</p>
<ol>
<li>Later Bind只是加载SpriteAtlas提供的一个回调接口(无论是主动还是被动(依赖)加载)，回调接口内只知道加载了指定的SpriteAtlas却不知道具体的详细用法，这样一来基于对象绑定和索引计数的资源管理系统就无法正确的加载管理了(因为被动(依赖)加载得不到SpriteAtlas的依赖信息)。</li>
</ol>
<p>个人方案：</p>
<ol>
<li>当前这套基于对象绑定和索引计数的方案暂时没想到好的方案，可能需要对SpriteAtals的资源管理单独做一套管理策略来支持Later Bind的用法。有更好方案的朋友，望告知。</li>
</ol>
<h5 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h5><ol>
<li>开启Sprite Packer的设置Sprite Packer -&gt; Mode(Always Enable)只决定图集合成时机(比如是运行时还是打包时还是编辑器时)。</li>
<li>Sprite Atlas支持Objects for Packing设置文件夹</li>
<li>参与打包的图片必须设置成Sprite(2D and UI)格式</li>
<li><strong>Include in Build会影响SpriteAtlas图集资源的资源是如何关联SpriteAtlas(比如影响是否需要使用Later Bind,不勾选需要使用Later Bind否则会报警告)</strong></li>
</ol>
<h5 id="相关概念"><a href="#相关概念" class="headerlink" title="相关概念"></a>相关概念</h5><ol>
<li>Sprite Atlas把图集打包的概念延迟到特定时刻(比如打包或者打包AB)而编辑模式依然可以使用原始Sprite工作，总的来说就是延时自动化打包图集时机+允许使用原始Sprite的概念。</li>
<li>Include in Build设置主要是看有没有动态适配加载图集需求，有的话就建议不勾选，然后结合Later Bind来做动态图集加载适配。反之勾选Include in Build在依赖使用时会自动加载依赖使用的Sprite Atals。</li>
<li>Include in Build其次还会影响Sprite Atlas变体使用的选择。</li>
<li>SpriteAtlas到了Unity 2018 LTS版本感觉才稳定些，建议使用稳定版本的SpriteAtlas</li>
<li>Later Bind不会区分主动加载还是被动(依赖)加载SpriteAtlas,都会统一回调，要使用Later Bind机制的需要取消勾选Include in Build并解决SpriteAtlas的资源加载管理问题(在沿用原来的对象绑定和索引计数的资源管理方案基础上本人暂时没有好的方案)</li>
<li><strong>Sprite Atlas无论够不够选Include in Build打包AB都得不到Sprite Atlas的依赖信息，感觉这是一个bug</strong></li>
</ol>
<h5 id="Bug记录"><a href="#Bug记录" class="headerlink" title="Bug记录"></a>Bug记录</h5><ol>
<li><strong>勾选Include in Build会导致资源打包冗余(部分Unity版本比如Unity2018.4.1f1)，建议升级到LTS版本</strong></li>
</ol>
<h5 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h5><p>SpriteAtlas虽然解决了Atlas和UIPrefab的解耦，同时提供了图集变体的概念来解决适配图集适配方案，但也带来了一些新的问题要解决(e.g. 要解决没有依赖信息的SpriteAtals基础上做到正确的资源加载管理)。</p>
<p><strong>——————————–2021&#x2F;20&#x2F;12更新开始————————————–</strong></p>
<p>正确使用姿势参考：</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/msxh/p/14194756.html">【Unity游戏开发】SpriteAtlas与AssetBundle最佳食用方案</a></p>
<p>简单来说:</p>
<ol>
<li><strong>SpriteAtlas 勾选Include in build</strong></li>
<li><strong>SpriteAtlas不设置AB打包</strong></li>
<li><strong>直接当做单Sprite一样加载</strong></li>
</ol>
<p><strong>——————————–2021&#x2F;20&#x2F;12更新结束————————————–</strong></p>
<h2 id="Timeline"><a href="#Timeline" class="headerlink" title="Timeline"></a>Timeline</h2><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/TimelineSection.html"> <strong>Timeline</strong> to create cinematic content, game-play sequences, audio sequences, and complex particle effects. </a></p>
<p>官方介绍Timeline可以用于制作类似电影过场表现的工具。</p>
<p>Timeline分为两个部分：</p>
<ol>
<li>Timeline Asset(数据)</li>
<li>Timeline instance(数据关联实体对象)</li>
</ol>
<h3 id="Timeline-Asset"><a href="#Timeline-Asset" class="headerlink" title="Timeline Asset"></a>Timeline Asset</h3><h4 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h4><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/TimelineOverview.html"> <strong>Timeline Asset</strong>: Stores the tracks, clips, and recorded animations without links to the specific GameObjects being animated.</a></p>
<p>通过介绍可以看出Timeline Asset是类似于Animation Clip一样的资源文件可以用于录制动画<strong>但不需要关联到特定的物体上</strong></p>
<p>Timeline Asset记录的动画数据是以子节点资源的形式挂载在Timeline Asset下的：</p>
<p><img src="/img/Unity/Timeline_Cinemachine/TimelineAssetHierachy.png" alt="TimelineAssetHierachy"></p>
<p>Note:<br>前面说的不需要关联到特定的物体上是指不需要像AnimationClip那样动画是针对指定物体制作的(挂给其他物体用不了该动画)，Timeline可以通过PlayableDirector动态关联动画对象。</p>
<h4 id="分类"><a href="#分类" class="headerlink" title="分类"></a>分类</h4><p>Timeline Asset是以Track为最小单位。</p>
<p>主要支持以下几种Track:</p>
<ol>
<li>Track Group(仅分层管理用)</li>
<li>Activation Track(激活物体Track)</li>
<li>Animation Track(动画Track)</li>
<li>Audio Track(音频Track)</li>
<li>Control Track(时间相关的控制)</li>
<li>Playable Track(<strong>自定义Track</strong>)</li>
</ol>
<p><img src="/img/Unity/Timeline_Cinemachine/TimelineComponent.png" alt="TimelineComponent"></p>
<p>这里我们着重学习Playable Track,自定义的一些表现行为都是通过Playable Track来做的。其他几个就不一一讲解了。</p>
<h5 id="Playable-Track"><a href="#Playable-Track" class="headerlink" title="Playable Track"></a>Playable Track</h5><p>自定义Playable Track需要知道两个东西：</p>
<ol>
<li>PlayableAsset(用于支持Timeline创建和显示自定义PlayableAsset数据定义)</li>
<li>PlayableBehaviour(用于Playable实际的生命周期等逻辑实现)</li>
</ol>
<p>示例:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 枚举事件定义</span></span><br><span class="line"><span class="keyword">public</span> <span class="built_in">enum</span> EEventId</span><br><span class="line">&#123;</span><br><span class="line">    DefaultEvent = <span class="number">1</span>,				<span class="comment">// 默认事件</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 事件分发器Asset</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">System.Serializable</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">EventDispatcherAsset</span> : <span class="title">PlayableAsset</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 事件</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> EEventId EventId = EEventId.DefaultEvent;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Factory method that generates a playable based on this asset</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> Playable <span class="title">CreatePlayable</span>(<span class="params">PlayableGraph graph, GameObject go</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> playable = ScriptPlayable&lt;EventDispatcherPlayable&gt;.Create(graph);</span><br><span class="line">        playable.GetBehaviour().EventId = EventId;</span><br><span class="line">        <span class="keyword">return</span> playable;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 事件分发器Playable</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">EventDispatcherPlayable</span> : <span class="title">PlayableBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 事件</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;事件&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> EEventId EventId = EEventId.DefaultEvent;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Called when the owning graph starts playing</span></span><br><span class="line">    <span class="comment">// Playable开始执行时</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnGraphStart</span>(<span class="params">Playable playable</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Called when the owning graph stops playing</span></span><br><span class="line">    <span class="comment">// Playable停止执行时</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnGraphStop</span>(<span class="params">Playable playable</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Called when the state of the playable is set to Play</span></span><br><span class="line">    <span class="comment">// 触发Playable执行时</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnBehaviourPlay</span>(<span class="params">Playable playable, FrameData info</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Debug.Log(<span class="built_in">string</span>.Format(<span class="string">&quot;OnBehaviourPlay() 分发事件 : &#123;0&#125;&quot;</span>, EventId));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Called when the state of the playable is set to Paused</span></span><br><span class="line">    <span class="comment">// Playable暂停执行时</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnBehaviourPause</span>(<span class="params">Playable playable, FrameData info</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Called each frame while the state is set to Play</span></span><br><span class="line">    <span class="comment">// Playable更新执行时</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">PrepareFrame</span>(<span class="params">Playable playable, FrameData info</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/img/Unity/Timeline_Cinemachine/TimelineCustomPlayable.png" alt="TimelineCustomPlayable"></p>
<p>代码不复杂就不详细介绍了。通过上面的代码，我们支持了一个创建自定义分发事件的Playable Track，而这个自定义的事件分发就可以用作我们Timeline和游戏逻辑之间的一个桥梁，帮助我们在Timeline播放的过程中自定义响应做一些表现。</p>
<h3 id="Timeline-instance"><a href="#Timeline-instance" class="headerlink" title="Timeline instance"></a>Timeline instance</h3><h4 id="介绍-1"><a href="#介绍-1" class="headerlink" title="介绍"></a>介绍</h4><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/TimelineOverview.html"> <strong>Timeline instance</strong>: Stores links to the specific GameObjects being animated or affected by the Timeline Asset. These links, referred to as <strong>bindings</strong>, are saved to the Scene. </a></p>
<p>要想关联场景物体和Timeline Asset让我们制作的电影过场动起来，我们需要创建Timeline instance(这里指的Playable Director组件)。</p>
<p><img src="/img/Unity/Timeline_Cinemachine/TimelinePlayableDirectorInspector.png" alt="TimelinePlayableDirectorInspector"></p>
<p>可以看到我们通过Timeline Asset录制的动画是通过Playable Director的Bindings动态关联到了场景物体上。</p>
<p>Note:<br><strong>因为Timeline Asset是纯数据，Timeline instance决定了数据关联的对象，所以我们可以重用Timeline Asset对不同的物体做动画表现。</strong></p>
<h3 id="Timeline类设计"><a href="#Timeline类设计" class="headerlink" title="Timeline类设计"></a>Timeline类设计</h3><h4 id="Playable"><a href="#Playable" class="headerlink" title="Playable"></a>Playable</h4><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/Playables.html">The <strong>Playables</strong> API provides a way to create tools, effects or other gameplay mechanisms by organizing and evaluating data sources in a tree-like structure known as the PlayableGraph. The PlayableGraph allows you to mix, blend, and modify multiple data sources, and play them through a single output.</a></p>
<p>从介绍个人的理解，Playable是一套可自定义数据处理流程成树状结构的工具。而自定义出来的树状结构数据就叫做PlayableGraph(后续会讲到)。而Timeline的核心正是Playable。</p>
<p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/Playables.html">使用Playables API的好处:</a></p>
<ul>
<li>The Playables API allows for dynamic animation blending. This means that objects in the <strong>scenes</strong><br>could provide their own animations. For example, animations for weapons, chests, and traps could be dynamically added to the PlayableGraph and used for a certain duration.</li>
<li>The Playables API allows you to easily play a single animation without the overhead involved in creating and managing an AnimatorController asset.</li>
<li>The Playables API allows users to dynamically create blending graphs and control the blending weights directly frame by frame.</li>
<li>A PlayableGraph can be created at runtime, adding playable node as needed, based on conditions. Instead of having a huge “one-size-fit-all” graph where nodes are enabled and disabled, the PlayableGraph can be tailored to fit the requirements of the current situation.</li>
</ul>
<p>官网上介绍了Playable的不少好处，从介绍可以看出最大的好处就是运行时自定义组装数据处理流程，避免离线构建一套过于臃肿的数据定义(比如AnimatorController)</p>
<p>Note:</p>
<ol>
<li><strong>Playable是Struct而非Class，为了避免内存分配导致GC</strong></li>
<li><strong>Playable和PlayableOutput没有提供太多方法，而是通过PlayableExtension和PlayableOutputExtension用扩展方法的方式来提供的方法</strong></li>
</ol>
<h4 id="PlayableGraph"><a href="#PlayableGraph" class="headerlink" title="PlayableGraph"></a>PlayableGraph</h4><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/Playables-Graph.html">The PlayableGraph defines a set of playable outputs that are bound to a <strong>GameObject</strong> or component. The PlayableGraph also defines a set of <strong>playables</strong> and their relationships. Figure 1 provides an example.</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/Playables-Graph.html">The PlayableGraph is responsible for the life cycle of its playables and their outputs. Use the PlayableGraph to create, connect, and destroy playables.</a></p>
<p>从上面的介绍，个人理解，PlayableGraph是一个自定义数据处理流程的完整单位，负责自定义数据处理流程里的节点定义，关联，以及生命周期。PlayableGraph是由Plyable(e.g.Playable,MixPlayable)+PlayableOuput组成。</p>
<h4 id="PlayableAsset"><a href="#PlayableAsset" class="headerlink" title="PlayableAsset"></a>PlayableAsset</h4><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/ScriptReference/Playables.PlayableAsset.html">A base class for assets that can be used to instantiate a Playable at runtime.</a></p>
<p>PlayableAsset是自定义Playable时定义数据Asset的基类。</p>
<h4 id="PlayableBehaviour"><a href="#PlayableBehaviour" class="headerlink" title="PlayableBehaviour"></a>PlayableBehaviour</h4><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/ScriptReference/Playables.PlayableBehaviour.html">PlayableBehaviour is the base class from which every custom playable script derives.</a></p>
<p>PlayableBehaviour是自定义Playable时定义行为实现的脚本基类。</p>
<h4 id="PlayableOutput"><a href="#PlayableOutput" class="headerlink" title="PlayableOutput"></a>PlayableOutput</h4><p>个人理解是定义Playable里面的输出节点。所有的输入节点最后连接成树状结构后连到输出节点上，执行出自定义行为的输出表现。</p>
<p>参考下图:</p>
<p><img src="/img/Unity/Timeline_Cinemachine/PlayableOutputPreview.PNG" alt="PlayableOutputPreview"></p>
<h4 id="PlayableBinding"><a href="#PlayableBinding" class="headerlink" title="PlayableBinding"></a>PlayableBinding</h4><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/ScriptReference/Playables.PlayableBinding.html">Struct that holds information regarding an output of a PlayableAsset. PlayableAssets specify the type of outputs it supports using PlayableBindings.</a></p>
<p>看介绍PlayableBinding是用于定义并持有PlayableAsset的数据输出信息。</p>
<h4 id="ExposedReference"><a href="#ExposedReference" class="headerlink" title="ExposedReference"></a>ExposedReference</h4><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/ScriptReference/ExposedReference_1.html">Creates a type whos value is resolvable at runtime. ExposedReference is a generic type that can be used to create references to Scene objects and resolve their actual values at runtime and by using a context object. This can be used by assets, such as a ScriptableObject or PlayableAsset to create references to Scene objects.</a></p>
<p>从介绍可以看出，ExposedReference是用于创建一个类型(其值在运行时处理绑定的)。用于解决PlayableAsset引用场景对象组件数据等问题。</p>
<h4 id="辅助工具-GraphVisualizer"><a href="#辅助工具-GraphVisualizer" class="headerlink" title="辅助工具(GraphVisualizer)"></a>辅助工具(GraphVisualizer)</h4><p><a target="_blank" rel="noopener" href="https://github.com/Unity-Technologies/graph-visualizer">The PlayableGraph Visualizer is a tool that displays the PlayableGraphs in the scene. It can be used in both Play and Edit mode and will always reflect the current state of the graph. </a></p>
<p>因为Playable的设计很庞大，里面有很多类和概念，为了方便理解Playable设计和使用可视化的查看构建出来的PlayableGraph显得额外有用，而PlayableGraph Visualizer正是这么一款工具。</p>
<p>接下来我们结合GraphVisualizer动态通过代码创建模拟用Playable API实现动画Animator Controller里的动画状态机类似的效果，从而深入学习理解Playable里各个类的设计和使用。</p>
<h5 id="单AnimationClip单AniamtionOuput的动画播放"><a href="#单AnimationClip单AniamtionOuput的动画播放" class="headerlink" title="单AnimationClip单AniamtionOuput的动画播放"></a>单AnimationClip单AniamtionOuput的动画播放</h5><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建动画播放PlayableGraph</span></span><br><span class="line">mCustomGraph = PlayableGraph.Create(<span class="string">&quot;DIYAnimationPlayableGraph&quot;</span>);</span><br><span class="line"><span class="comment">// 创建动画播放PlyableGraph的PlayableOutput</span></span><br><span class="line"><span class="keyword">var</span> animoutput = AnimationPlayableOutput.Create(mCustomGraph, <span class="string">&quot;AnimationOutput&quot;</span>, CustomAnimator1);</span><br><span class="line"><span class="comment">// 创建动画播放PlyableGraph的动画Playable</span></span><br><span class="line"><span class="keyword">var</span> animationclipplayable = AnimationClipPlayable.Create(mCustomGraph, CustomAnimationClip1);</span><br><span class="line"><span class="comment">// 设置动画播放PlayableOutput的关联Playable</span></span><br><span class="line">animoutput.SetSourcePlayable(animationclipplayable);</span><br><span class="line"><span class="comment">// 播放创建的PlayableGraph</span></span><br><span class="line">mCustomGraph.Play();</span><br></pre></td></tr></table></figure>

<p>通过上面的代码我们动态创建了1个PlayableGraph，1个动画Plyable，1个动画PlayableOutput作为动画播放输出，并设置他们之间的关联，运行代码打开PlayableGraphVisualizer就可以查看到生成的单动画Clip播放PlayableGraph图了。</p>
<p><img src="/img/Unity/Timeline_Cinemachine/PlayableGraphVisualizerPreview.PNG" alt="PlayableGraphVisualizerPreview"></p>
<h5 id="多AnimationClip混合"><a href="#多AnimationClip混合" class="headerlink" title="多AnimationClip混合"></a>多AnimationClip混合</h5><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建动画播放PlayableGraph</span></span><br><span class="line">mCustomGraph = PlayableGraph.Create(<span class="string">&quot;DIYAnimationPlayableGraph&quot;</span>);</span><br><span class="line"><span class="comment">// 创建动画播放PlyableGraph的PlayableOutput</span></span><br><span class="line"><span class="keyword">var</span> animationOutput = AnimationPlayableOutput.Create(mCustomGraph, <span class="string">&quot;AnimationOutput&quot;</span>, CustomAnimator1);</span><br><span class="line"><span class="comment">// 创建动画播放混合Playable(设置两个输入Playable)</span></span><br><span class="line">mAnimationMixerPlayable = AnimationMixerPlayable.Create(mCustomGraph, <span class="number">2</span>);</span><br><span class="line"><span class="comment">// 关联动画混合Playable到PlaybleOutput作为唯一输入</span></span><br><span class="line">animationOutput.SetSourcePlayable(mAnimationMixerPlayable);</span><br><span class="line"><span class="comment">// 创建动画播放PlyableGraph的动画播放Playable1和Playable2</span></span><br><span class="line"><span class="keyword">var</span> animationClipPlayable1 = AnimationClipPlayable.Create(mCustomGraph, CustomAnimationClip1);</span><br><span class="line"><span class="keyword">var</span> animationClipPlayable2 = AnimationClipPlayable.Create(mCustomGraph, CustomAnimationClip2);</span><br><span class="line"><span class="comment">// 关联动画播放Playable1和Playable2作为动画混合Playable的输入连接(分别连接输入0和输入1接口)</span></span><br><span class="line">mCustomGraph.Connect(animationClipPlayable1, <span class="number">0</span>, mAnimationMixerPlayable, <span class="number">0</span>);</span><br><span class="line">mCustomGraph.Connect(animationClipPlayable2, <span class="number">0</span>, mAnimationMixerPlayable, <span class="number">1</span>);</span><br><span class="line"><span class="comment">// 播放创建的PlayableGraph</span></span><br><span class="line">mCustomGraph.Play();</span><br></pre></td></tr></table></figure>

<p>通过上面的代码我们动态创建了一个PlayableGraph，2个动画Plyable作为基础输入，1个动画混合Playable作为混合节点，1个动画PlayableOutput作为动画播放输出，并设置他们之间的关联，运行代码打开PlayableGraphVisualizer就可以查看到生成的动画混合播放PlayableGraph图了。</p>
<p><img src="/img/Unity/Timeline_Cinemachine/AnimationClipMixPreview.PNG" alt="AnimationClipMixPreview"></p>
<h5 id="多AnimationClip多AnimationOuput"><a href="#多AnimationClip多AnimationOuput" class="headerlink" title="多AnimationClip多AnimationOuput"></a>多AnimationClip多AnimationOuput</h5><p><strong>一个PlayableGraph是可以拥有多个PlayableOutput输出的</strong></p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建动画播放PlayableGraph</span></span><br><span class="line">mCustomGraph = PlayableGraph.Create(<span class="string">&quot;DIYAnimationPlayableGraph&quot;</span>);</span><br><span class="line"><span class="comment">// 创建动画播放PlyableGraph的PlayableOutput1和PlayableOutput2</span></span><br><span class="line"><span class="keyword">var</span> animationOutput1 = AnimationPlayableOutput.Create(mCustomGraph, <span class="string">&quot;AnimationOutput1&quot;</span>, CustomAnimator1);</span><br><span class="line"><span class="keyword">var</span> animationOutput2 = AnimationPlayableOutput.Create(mCustomGraph, <span class="string">&quot;AnimationOutput2&quot;</span>, CustomAnimator2);</span><br><span class="line"><span class="comment">// 创建动画播放PlyableGraph的动画播放Playable1和Playable2</span></span><br><span class="line"><span class="keyword">var</span> animationClipPlayable1 = AnimationClipPlayable.Create(mCustomGraph, CustomAnimationClip1);</span><br><span class="line"><span class="keyword">var</span> animationClipPlayable2 = AnimationClipPlayable.Create(mCustomGraph, CustomAnimationClip2);</span><br><span class="line"><span class="comment">// 关联动画播放Playable1到动画播放PlaybleOutput1</span></span><br><span class="line"><span class="comment">// 关联动画播放Playable2到动画播放PlaybleOutput2</span></span><br><span class="line">animationOutput1.SetSourcePlayable(animationClipPlayable1);</span><br><span class="line">animationOutput2.SetSourcePlayable(animationClipPlayable2);</span><br><span class="line"><span class="comment">// 播放创建的PlayableGraph</span></span><br><span class="line">mCustomGraph.Play();</span><br></pre></td></tr></table></figure>

<p>通过上面的代码我们动态创建了一个PlayableGraph，2个动画Plyable对应2个动画PlayableOutput动画播放输出的输入，并设置他们之间的关联，运行代码打开PlayableGraphVisualizer就可以查看到生成的动画混合播放PlayableGraph图了。</p>
<p><img src="/img/Unity/Timeline_Cinemachine/MultipleAnimationInputAndOutputPreview.PNG" alt="MultipleAnimationInputAndOutputPreview"></p>
<h5 id="多AnimationClip混合并控制权重加播放状态"><a href="#多AnimationClip混合并控制权重加播放状态" class="headerlink" title="多AnimationClip混合并控制权重加播放状态"></a>多AnimationClip混合并控制权重加播放状态</h5><p><strong>不同的Playable是可以设置混合权重加播放状态的</strong></p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建动画播放PlayableGraph</span></span><br><span class="line">mCustomGraph = PlayableGraph.Create(<span class="string">&quot;DIYAnimationPlayableGraph&quot;</span>);</span><br><span class="line"><span class="comment">// 创建动画播放PlyableGraph的PlayableOutput</span></span><br><span class="line"><span class="keyword">var</span> animationOutput = AnimationPlayableOutput.Create(mCustomGraph, <span class="string">&quot;AnimationOutput1&quot;</span>, CustomAnimator1);</span><br><span class="line"><span class="comment">// 创建动画混合Playable</span></span><br><span class="line">mAnimationMixerPlayable = AnimationMixerPlayable.Create(mCustomGraph, <span class="number">2</span>);</span><br><span class="line"><span class="comment">// 设置动画混合Playalbe作为动画播放输出Playable</span></span><br><span class="line">animationOutput.SetSourcePlayable(mAnimationMixerPlayable);</span><br><span class="line"><span class="comment">// 创建动画播放PlyableGraph的动画播放Playable1和Playable2</span></span><br><span class="line"><span class="keyword">var</span> animationClipPlayable1 = AnimationClipPlayable.Create(mCustomGraph, CustomAnimationClip1);</span><br><span class="line"><span class="keyword">var</span> animationClipPlayable2 = AnimationClipPlayable.Create(mCustomGraph, CustomAnimationClip2);</span><br><span class="line"><span class="comment">// 设置动画混合输入和权重</span></span><br><span class="line">mCustomGraph.Connect(animationClipPlayable1, <span class="number">0</span>, mAnimationMixerPlayable, <span class="number">0</span>);</span><br><span class="line">mCustomGraph.Connect(animationClipPlayable2, <span class="number">0</span>, mAnimationMixerPlayable, <span class="number">1</span>);</span><br><span class="line">mAnimationMixerPlayable.SetInputWeight(<span class="number">0</span>, <span class="number">1.0f</span>);</span><br><span class="line">mAnimationMixerPlayable.SetInputWeight(<span class="number">1</span>, <span class="number">1.0f</span>);</span><br><span class="line"><span class="comment">// 暂停动画播放Playable1</span></span><br><span class="line">animationClipPlayable1.Pause();</span><br><span class="line"><span class="comment">// 播放创建的PlayableGraph</span></span><br><span class="line">mCustomGraph.Play();</span><br></pre></td></tr></table></figure>

<p>通过上面的代码我们动态创建了一个PlayableGraph，2个动画Plyable作为动画混合Playable的输入,1个动画混合Playable作为动画播放输出的输入,1个PlayableOutput作为动画播放输出，并设置他们之间的关联和权重，并把其中一个动画播放Playable设置成暂停状态，运行代码打开PlayableGraphVisualizer就可以查看到生成的动画混合播放PlayableGraph图了。</p>
<p><img src="/img/Unity/Timeline_Cinemachine/MultipleAnimationBlendAndSetPlayableState.PNG" alt="MultipleAnimationBlendAndSetPlayableState"></p>
<p>Note:</p>
<ol>
<li><strong>父Playable的播放状态设置会影响所有子节点Playable播放状态</strong></li>
</ol>
<h3 id="Timeline实战"><a href="#Timeline实战" class="headerlink" title="Timeline实战"></a>Timeline实战</h3><p>通过上面有了基础的知识后，接下来我们以实战的方式深入学习Timeline。</p>
<ul>
<li>目标</li>
</ul>
<ol>
<li>人物模型移动(Timeline自带)+人物模型动画播放(Timeline自带)+镜头移动(Cinemachine+Timeline)+2D对话+3D气泡对话的剧情表现+特效播放(Timeline自带)+音乐播放控制(扩展自定义Track，方便走自己的音效播放接口)</li>
<li>支持Timeline Editor拖拽预览+运行时播放预览</li>
</ol>
<ul>
<li>功能开发</li>
</ul>
<ol>
<li>音乐播放控制(扩展自定义Track，方便走自己的音效播放接口)</li>
<li>Timeline模型移动控制Track(TimeLine支持)</li>
<li>学习Cinemachine扩展Timeline的Track使用控制镜头移动表现</li>
<li>实现2D气泡对话+3D对话功能</li>
<li>扩展Timneline实现2D气泡对话Track+3D对话Track</li>
<li>动态创建实体对象的自定义Track绑定控制(如何实现?)</li>
</ol>
<ul>
<li>准备工作</li>
</ul>
<ol>
<li>Package Manager里安装Cinemachine模块</li>
<li>下载导入模型特效音效等相关资源</li>
</ol>
<p>安装好Cinemachine后，打开Timeline里面就会看到多了Cinemachine的Track，从而就可以在Timeline里使用Cinemachine相关的扩展功能了:</p>
<p><img src="/img/Unity/Timeline_Cinemachine/TimelineCinemachineTrack.png" alt="TimelineCinemachineTrack"></p>
<p>首先我们先放一下我们自定义制作的Timeline的预制件结构:</p>
<p><img src="/img/Unity/Timeline_Cinemachine/CustomTimelinePrefabHierachyPreview.PNG" alt="CustomTimelinePrefabHierachyPreview"></p>
<hr>
<p><strong>音乐播放控制Track</strong></p>
<p>CustomAduioTrack.cs(自定义音乐播放Track)</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> CustomAudioTrack.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 自定义音效Track</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">TrackClipType(typeof(CustomAudioAsset))</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CustomAudioTrack</span> : <span class="title">PlayableTrack</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>CustomAudioAsset.cs(自定义音乐播放Asset数据结构)</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> CustomAudioAsset.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 自定义音效播放Asset</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CustomAudioAsset</span> : <span class="title">BaseGameAsset</span>, <span class="title">ITimelineClipAsset</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 音效类型</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">enum</span> AudioType</span><br><span class="line">    &#123;</span><br><span class="line">        Bgm = <span class="number">1</span>,            <span class="comment">// 背景音乐</span></span><br><span class="line">        Sound = <span class="number">2</span>,          <span class="comment">// 音效</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 音效播放组件</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> ExposedReference&lt;AudioSource&gt; SourceAudio;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 播放的音效类型</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> AudioType PlayedAudioType = AudioType.Bgm;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 音效资源路径</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> AudioPath;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 不支持重叠</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> ClipCaps clipCaps</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span> &#123; <span class="keyword">return</span> ClipCaps.None; &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> Playable <span class="title">CreatePlayable</span>(<span class="params">PlayableGraph graph, GameObject owner</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> playable = ScriptPlayable&lt;CustomAudioBehaviour&gt;.Create(graph);</span><br><span class="line">        <span class="keyword">var</span> audiobehaviour = playable.GetBehaviour();</span><br><span class="line">        audiobehaviour.Name = Name;</span><br><span class="line">        audiobehaviour.SourceAudio = SourceAudio.Resolve(graph.GetResolver());</span><br><span class="line">        audiobehaviour.PlayedAudioType = PlayedAudioType;</span><br><span class="line">        audiobehaviour.AudioPath = AudioPath;</span><br><span class="line">        <span class="keyword">return</span> playable;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>CustomAudioBehaviour.cs(自定义音乐播放行为)</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> CustomAudioBehaviour.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 自定义音效播放Behaviour</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CustomAudioBehaviour</span> : <span class="title">BaseGameBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 音效播放组件</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> AudioSource SourceAudio;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 播放的音效类型</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> CustomAudioAsset.AudioType PlayedAudioType;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 音效资源路径</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> AudioPath;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 是否正在播放音乐</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">bool</span> mIsPlayingAudio;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnBehaviourPlay</span>(<span class="params">Playable playable, FrameData info</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Debug.Log(<span class="string">$&quot;AudioBehaviour:OnBehaviourPlay() 执行指令:<span class="subst">&#123;Name&#125;</span>&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Called each frame while the state is set to Play</span></span><br><span class="line">    <span class="comment">// Playable更新执行时</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">ProcessFrame</span>(<span class="params">Playable playable, FrameData info, <span class="built_in">object</span> playerData</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">		TryPlayAudio();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Called when the state of the playable is set to Paused</span></span><br><span class="line">    <span class="comment">// Playable暂停执行时</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnBehaviourPause</span>(<span class="params">Playable playable, FrameData info</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Debug.Log(<span class="string">$&quot;AudioBehaviour:OnBehaviourPause() 执行指令:<span class="subst">&#123;Name&#125;</span>&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(SourceAudio != <span class="literal">null</span> &amp;&amp; SourceAudio.clip != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            SourceAudio.clip = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        mIsPlayingAudio = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 尝试执行音乐播放</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">TryPlayAudio</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(mIsPlayingAudio == <span class="literal">false</span> &amp;&amp; SourceAudio != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (PlayedAudioType == CustomAudioAsset.AudioType.Bgm)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// <span class="doctag">TODO:</span> 走背景音乐播放接口</span></span><br><span class="line">                SourceAudio.clip = Resources.Load&lt;AudioClip&gt;(AudioPath);</span><br><span class="line">                SourceAudio.Play();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (PlayedAudioType == CustomAudioAsset.AudioType.Sound)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// <span class="doctag">TODO:</span> 走音效播放接口</span></span><br><span class="line">                SourceAudio.clip = Resources.Load&lt;AudioClip&gt;(AudioPath);</span><br><span class="line">                SourceAudio.Play();</span><br><span class="line">            &#125;</span><br><span class="line">            mIsPlayingAudio = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下来看下我们自定义的音效播放Track和音乐Asset的使用面板效果:</p>
<p><img src="/img/Unity/Timeline_Cinemachine/CustomAudioTrackPreview.PNG" alt="CustomAudioTrackPreview"></p>
<p><img src="/img/Unity/Timeline_Cinemachine/CustomAudioAssetBGMInspector.PNG" alt="CustomAudioAssetBGMInspector"></p>
<p><img src="/img/Unity/Timeline_Cinemachine/CustomAudioAssetSoundInspector.PNG" alt="CustomAudioAssetSoundInspector"></p>
<p>从上面可以看到，我们通过ExposedReference<AudioSource>的方式，挂载绑定了场景里的AudioSource作为背景音乐和音效播放组件。</p>
<p>接下来为了避免每一个CustomAudioAsset都自己去指定AudioSource绑定组件，我们可以通过在CustomAudioTrack来支持在Track统一指定AudioSource。</p>
<p>CustomAudioTrack.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> CustomAudioTrack.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 自定义音效Track</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">TrackClipType(typeof(CustomAudioAsset))</span>]</span><br><span class="line">[<span class="meta">TrackBindingType(typeof(AudioSource))</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CustomAudioTrack</span> : <span class="title">PlayableTrack</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>CustomAudioBehaviour.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> CustomAudioBehaviour.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 自定义音效播放Behaviour</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CustomAudioBehaviour</span> : <span class="title">BaseGameBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    ******</span><br><span class="line">        </span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 音效播放组件</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> AudioSource mSourceAudio;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Called each frame while the state is set to Play</span></span><br><span class="line">    <span class="comment">// Playable更新执行时</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">ProcessFrame</span>(<span class="params">Playable playable, FrameData info, <span class="built_in">object</span> playerData</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(mSourceAudio == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            mSourceAudio = playerData <span class="keyword">as</span> AudioSource;</span><br><span class="line">        &#125;</span><br><span class="line">        TryPlayAudio();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">	******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>CustomAudioTrack通过声明TrackBindingType(typeof(AudioSource))指定Track可以绑定AudioSource组件。</p>
<p>CustomAudioBehaviour通过在运行时ProcessFrame里动态使用Track上指定的AudioSource组件作为音乐播放组件来实现CustomAudioBehaviour采用Track统一绑定组件的的效果。</p>
<p><img src="/img/Unity/Timeline_Cinemachine/CustomAudioTrackWithAudioSourceBindingPreview.PNG" alt="CustomAudioTrackWithAudioSourceBindingPreview"></p>
<h3 id="进阶"><a href="#进阶" class="headerlink" title="进阶"></a>进阶</h3><p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/69e60a27bccb">Unity使用Cinemachine和Timeline入门</a><br><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Packages/com.unity.cinemachine@2.3/manual/CinemachineTimeline.html">Cinemachine and Timeline</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.unity.com/tutorial/cinemachine">Cinemachine</a></p>
<p>Timeline可以看做是自定义展示效果的工具，而Cinemachine可以看做是多摄像机的一套完整控制表现的工具。</p>
<p>更多的Cinemachine学习见后面</p>
<h2 id="Cinemachine"><a href="#Cinemachine" class="headerlink" title="Cinemachine"></a>Cinemachine</h2><p><a target="_blank" rel="noopener" href="https://unity.com/unity/features/editor/art-and-design/cinemachine">Powering cameras for films and games</a></p>
<p>根据官网的简单介绍可以看出，Cinemachine是官方出的一款摄像机强大的控制系统，通过该系统，我们可以轻松的做到电影或者游戏级别的摄像机功能以及表现。</p>
<p>博主这里考虑学习使用Cinemachine的一个重大原因是，做赛车游戏，希望有一个稳定(不抖动)跟随的摄像机。(自己写的效果有抖动问题)</p>
<p>Cinemachine里有两个重要的组件和概念:</p>
<ol>
<li>Cinemachine Brain</li>
<li>Virtual Cameras</li>
</ol>
<h3 id="Cinemachine-Brain"><a href="#Cinemachine-Brain" class="headerlink" title="Cinemachine Brain"></a>Cinemachine Brain</h3><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Packages/com.unity.cinemachine@2.3/manual/CinemachineOverview.html">The Cinemachine Brain is a component in the Unity Camera itself. Cinemachine Brain monitors all active Virtual Cameras in the Scene. To specify the next live Virtual Camera, you <a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/DeactivatingGameObjects.html">activate or deactivate</a> the desired Virtual Camera’s game object. </a></p>
<p>从上面的介绍可以看出，Cinemachine Brain组件式挂载在摄像机对象上的一个组件，负责管理所有Virual Camera，同一时间只有一个Virtual Camera起作用用于主摄像机，优先选择Priority高的已激活Virutal Camera作为当前起作用的摄像机，优先级相同的情况下看哪个Virtual Camera后激活优先。</p>
<p><img src="/img/Unity/Timeline_Cinemachine/CinemachineBrain.PNG" alt="CinemachineBrain"></p>
<p>关于Cinemachine Brain的详细参数介绍，这里就不深入探讨了，感兴趣的朋友参考文档去自行了解。</p>
<p>Note:</p>
<ol>
<li>Timeline重写了Cinemachine Brain的Priority系统可以更好的控制摄像机达到更精准的摄像机控制。</li>
</ol>
<h3 id="Virtual-Cameras"><a href="#Virtual-Cameras" class="headerlink" title="Virtual Cameras"></a>Virtual Cameras</h3><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Packages/com.unity.cinemachine@2.3/manual/CinemachineOverview.html">Cinemachine does not create new cameras. Instead, it directs a single Unity camera for multiple shots. You compose these shots with <strong>Virtual Cameras</strong>. Virtual Cameras move and rotate the Unity camera and control its settings.</a></p>
<p>从上面的介绍可以知道，Cinemachine里的Virtual Cameras并非真正的Camera组件，而是一个抽象概念，而这个抽象的Virtuel Cameras会去负责控制真正的摄像机达到预定的效果。</p>
<p>每一个Virtual Cameras都会对应一个GameObject和一个CinemachineVirtualCamera组件脚本:</p>
<p><img src="/img/Unity/Timeline_Cinemachine/CinemachineVirtualCamera.PNG" alt="CinemachineVirtualCamera"></p>
<h4 id="Virtual-Camera-States"><a href="#Virtual-Camera-States" class="headerlink" title="Virtual Camera States"></a>Virtual Camera States</h4><p>Virtual Camera有三种状态:</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Packages/com.unity.cinemachine@2.1/manual/index.html"><strong>Live</strong>:The virtual camera is actively controlling the Unity Camera. The virtual camera is tracking its targets and being updated every frame.</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Packages/com.unity.cinemachine@2.1/manual/index.html"><strong>Standby</strong>: The virtual camera is tracking its targets and being updated every frame, but no Unity Camera is actively being controlled by it. This is the state of a virtual camera that is enabled in the scene but perhaps at a lower priority than the Live virtual camera.</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Packages/com.unity.cinemachine@2.1/manual/index.html"><strong>Disabled</strong>: The virtual camera is present but disabled in the scene. It is not actively tracking its targets and so consumes no processing power. However, the virtual camera can be made live from the Timeline.</a></li>
</ol>
<p>从介绍可以看到Live是指当前Virtual Camera优先级最高起作用的那个。而Standby是优先级低于当前起作用的Virtual Camera但没有Disable的Virtual Camera，这些摄像机逻辑上依然会更新跟随自己设定的对象，但不会影响真实摄像机运作。最后Disabled是即低于当前最高优先级Virtual Camera也没有激活的Virtual Camera，这类摄像机不会有任何运行开销，逻辑层面也不会在继续跟随自己的目标对象。</p>
<h4 id="Virtual-Camera-Params"><a href="#Virtual-Camera-Params" class="headerlink" title="Virtual Camera Params"></a>Virtual Camera Params</h4><p>关于Virtual Camera的细节参数学习，接下来学习几个重要的参数，更多的细节参考:</p>
<p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Packages/com.unity.cinemachine@2.3/manual/CinemachineOverview.html">Cinemachine overview</a></p>
<p><strong>Priority</strong>正如前面提到的，决定了Virtual Camera在Cinemachine Brain里的选择优先级。</p>
<p><strong>Follow</strong>和<strong>Look At</strong>两个参数分别决定了摄像机的跟随对象和对焦对象，这两个参数是常规游戏类型里都需要的概念，好比博主当前要做的赛车游戏，Follow和Look At对象都是赛车就能做到跟随和聚焦赛车的效果。</p>
<p><strong>Body</strong>属性提供了Virtual Camera对于摄像机移动的算法选择，从而达到适配各种游戏类型的摄像机镜头移动要求。</p>
<p><img src="/img/Unity/Timeline_Cinemachine/CinemachineBodyProperties.PNG" alt="CinemachineBodyProperties"></p>
<p>这里博主的赛车游戏默认选择Transposer来达到平滑跟随效果。</p>
<p><strong>Aim</strong>属性提供了Virtual Camera对于佘香即旋转的算法选择，从而达到适配各种游戏类型的摄像机镜头选择要求。</p>
<p><img src="/img/Unity/Timeline_Cinemachine/CinemachineAimProperties.PNG" alt="CinemachineAimProperties"></p>
<p><strong>Body</strong>和<strong>Aim</strong>通过细节的参数调整能实现各种角度以及各种游戏类型需求的摄像机跟随聚焦效果，这里博主暂时就不深入学习讨论了，有兴趣的可以参考文档去了解细节。</p>
<p>那么Virtual Camera的聚焦效果是如何实现的了？</p>
<p>了解聚焦效果之前有几个重钙的概念需要了解:</p>
<ol>
<li><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Packages/com.unity.cinemachine@2.3/manual/CinemachineOverview.html"><strong>Dead zone</strong>: The area of the frame that Cinemachine keeps the target in.</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Packages/com.unity.cinemachine@2.3/manual/CinemachineOverview.html"><strong>Soft zone</strong>: If the target enters this region of the frame, the camera will re-orient to put it back in the dead zone. It will do this slowly or quickly, according to the time specified in the Damping settings.</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Packages/com.unity.cinemachine@2.3/manual/CinemachineOverview.html"><strong>Screen</strong>: The screen position of the center of the dead zone. 0.5 is the center of the screen.</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Packages/com.unity.cinemachine@2.3/manual/CinemachineOverview.html"><strong>Damping</strong>: Simulates the lag that a real camera operator introduces while operating a heavy physical camera. Damping specifies quickly or slowly the camera reacts when the target enters the <strong>soft zone</strong> while the camera tracks the target. Use small numbers to simulate a more responsive camera, rapidly moving or aiming the camera to keep the target in the <strong>dead zone</strong>. Larger numbers simulate heavier cameras, The larger the value, the more Cinemachine allows the target to enter the soft zone.</a></p>
</li>
</ol>
<p><img src="/img/Unity/Timeline_Cinemachine/CinemachineZone.PNG" alt="CinemachineZone"></p>
<p>Dead Zone, Soft Zone, Screen参数在Body和Aim的属性面板上有体现，他们决定了摄像机是如何应对Look At对象走出指定区域时响应变化以及如何确保Look At对象在指定区域内的。</p>
<h3 id="Cinemachine-Camera-Types"><a href="#Cinemachine-Camera-Types" class="headerlink" title="Cinemachine Camera Types"></a>Cinemachine Camera Types</h3><p>Unity Cinemachine自带了很多种摄像机用于不同的游戏种类:</p>
<p><img src="/img/Unity/Timeline_Cinemachine/CinemachineCameraTypes.PNG" alt="CinemachineCameraTypes"></p>
<p>不同的摄像机种类适用于不同的游戏类型。</p>
<h4 id="Virtual-Camera"><a href="#Virtual-Camera" class="headerlink" title="Virtual Camera"></a>Virtual Camera</h4><p>Virtual Camera在前面的介绍已经提过了，这里就不再重复了，后续的摄像机类型大部分也是基于Virtual Camera的，只是在Virtual Camera的基础上实现了一套各自摄像机管理方式从而达到不同的摄像机类型效果。</p>
<h4 id="FreeLook-Camera"><a href="#FreeLook-Camera" class="headerlink" title="FreeLook Camera"></a>FreeLook Camera</h4><p>此类摄像机没有基于Virtual Camera而是单独挂载了一个Cinemachine Free Look的脚本实现的。</p>
<p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Packages/com.unity.cinemachine@2.1/manual/index.html#collision-avoidance-and-shot-evaluation">A Cinemachine Camera geared towards a 3rd person camera experience. The camera orbits around its subject with three separate camera rigs defining rings around the target. Each rig has its own radius, height offset, composer, and lens settings. Depending on the camera’s position along the spline connecting these three rigs, these settings are interpolated to give the final camera position and state.</a></p>
<p>从介绍可以看出，FreeLook Camera是用于第三人称围绕目标对象旋转控制的一套摄像机类型(比如第三人称RPG等游戏，有围绕主角相关的摄像机旋转控制等)。</p>
<h4 id="State-Driven-Camera"><a href="#State-Driven-Camera" class="headerlink" title="State-Driven Camera"></a>State-Driven Camera</h4><p>这里的State指的是Animator里的State，通过State-Drive Camera我们可以轻易的实现Animator State和Virtual Camera选择的绑定。这样就能轻易实现Walk状态用什么Virtual Camera，Idle状态使用什么Virtual Camera的效果。</p>
<p>更多的摄像机类型参考:</p>
<p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Packages/com.unity.cinemachine@2.1/manual/index.html">About Cinemachine</a></p>
<p>这里还值得一提的是摄像机限定移动范围和摄像机被障碍物主档导致目标对象不可见时Cinemachine提供的一种解决方案：</p>
<h3 id="Collision-Avoidance-and-Shot-Evaluation"><a href="#Collision-Avoidance-and-Shot-Evaluation" class="headerlink" title="Collision Avoidance and Shot Evaluation"></a>Collision Avoidance and Shot Evaluation</h3><h4 id="CinemachineCollider"><a href="#CinemachineCollider" class="headerlink" title="CinemachineCollider"></a>CinemachineCollider</h4><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Packages/com.unity.cinemachine@2.1/manual/index.html#collision-avoidance-and-shot-evaluation">An add-on module for Cinemachine Virtual Camera that post-processes the final position of the virtual camera. Based on the supplied settings, the Collider will attempt to preserve the line of sight with the LookAt target of the virtual camera by moving away from objects that will obstruct the view.</a></p>
<p>简单来说CinemachineCollider是通过相关设置，通过射线检测评估出当前摄像机最优的位置，从而避免被障碍物遮挡视线等问题。</p>
<p>Note:</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Packages/com.unity.cinemachine@2.1/manual/index.html#collision-avoidance-and-shot-evaluation">The collider uses Physics Raycasts to do these things, hence obstacles in the scene must have collider volumes in order to be visible to the CinemachineCollider.</a></li>
</ol>
<h4 id="CinemachineConfiner"><a href="#CinemachineConfiner" class="headerlink" title="CinemachineConfiner"></a>CinemachineConfiner</h4><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Packages/com.unity.cinemachine@2.1/manual/index.html#collision-avoidance-and-shot-evaluation">An add-on module for Cinemachine Virtual Camera that post-processes the final position of the virtual camera. It will confine the virtual camera’s position to the volume specified in the Bounding Volume field.</a></p>
<p>从介绍可以看出CinemachineConfiner相比CinemachineCollider，这是一个单纯限制摄像机运动范围的组件，更加轻量，没有过多多射线检测评估等过程，用于简单的限制摄像机运动范围，此组件更佳。</p>
<p>Note:</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Packages/com.unity.cinemachine@2.1/manual/index.html#collision-avoidance-and-shot-evaluation">This is less resource-intensive than CinemachineCollider, but it does not perform shot evaluation.</a></li>
</ol>
<h3 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h3><p>实战前，先让我们明确下个人的摄像机需求，需求明确了才能更加正确的使用Cinemachine达到效果。</p>
<p>摄像机需求:</p>
<ol>
<li>支持相机单独控制操作</li>
<li>支持相机限定移动范围操作</li>
<li>支持相机锁定目标操作</li>
<li>支持相机锁定目标和自由操作自由切换操作</li>
<li>支持相机锁定目标操作回调上层逻辑(用于配合逻辑层做事情)</li>
<li>场景摄像机支持多个摄像机同时控制(比如:MainCamera和3D UI Camera)</li>
</ol>
<p>待续……</p>
<h2 id="TextMeshPro"><a href="#TextMeshPro" class="headerlink" title="TextMeshPro"></a>TextMeshPro</h2><h3 id="What-1"><a href="#What-1" class="headerlink" title="What"></a>What</h3><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/com.unity.textmeshpro.html">TextMesh Pro is the ultimate text solution for Unity. It’s the perfect replacement for Unity’s UI Text and the legacy Text Mesh.</a></p>
<p>TextMeshPro原本是第三方个人编写的一款更优的Unity文本替代方案，后被Unity官方收购。</p>
<h3 id="Why-1"><a href="#Why-1" class="headerlink" title="Why"></a>Why</h3><p>使用TextMeshPro替代原生文本的原因有很多：</p>
<ol>
<li>TMP使用了SDF(<strong>Signed Distance Field</strong>)技术达到不失真的放大缩小渲染</li>
<li>TMP自带实现了图文混排(通过富文本打Tag的形式)以及很多文本所需的功能(e.g. 字间距，自定义字体大小，段落格式，对齐方式等)</li>
<li>TMP使用Shader去实现更好的文本表现效果(类似PS的一些效果)满足文本需求</li>
</ol>
<p>缺点:</p>
<ol>
<li>不支持动态字体(看网上说是TMP1.4支持动态字体(Generating Settings)，但我在Unity2018.4.1.f1上导入的TMP没有找到动态字体设置的入口，望知道的朋友告知一声在哪里设置)，需要生成对应的字体纹理库(对于文字多的比如中文来说有很大的内存压力)</li>
</ol>
<p>SDF(<strong>Signed Distance Field</strong>)介绍:<br><a target="_blank" rel="noopener" href="http://www.sardinefish.com/blog/?pid=296">一个空间区域的SDF函数定义为，从空间中任意给定的一点到该区域边界的距离，SDF函数值的符号取决于该点在区域的内部还是外部，外部为正，内部为负。</a></p>
<p>这里可以简单的理解成TMP通过函数式的定义方式(类似矢量图的定义方式)来解决像素图放大模糊的问题来渲染出可动态放大缩小不模糊的图像。深入理解参考下面的链接：<a target="_blank" rel="noopener" href="http://www.sardinefish.com/blog/?pid=296">函数式编程与 Signed Distance Field</a></p>
<h3 id="How-1"><a href="#How-1" class="headerlink" title="How"></a>How</h3><p>TMP需要通过TMP提供的字体库制作工具制作所需的对应字体文件：<br><img src="/img/Unity/TextMeshPro/FontAssetCreatePanel.png" alt="FontAssetCreatePanel"><br>如果想要使用图文混排还需要自己制作SpriteAsset:<br><img src="/img/Unity/TextMeshPro/SpriteAssetCreatePanel.png" alt="SpriteAssetCreatePanel"><br>制作好后创建TextMeshPro组件后指定需要使用的Font Asset和Sprite Asset即可:<br><img src="/img/Unity/TextMeshPro/TextMeshProAssignFontAssetAndSpriteAsset.png" alt="TextMeshProAssignFontAssetAndSpriteAsset"></p>
<p>最终效果：<br><img src="/img/Unity/TextMeshPro/TextMeshProUsing.png" alt="TextMeshProUsing"><br>TextMeshPro同一个Font Asset需要制作不同的渲染效果需要通过制作不同的Material来实现：<br><img src="/img/Unity/TextMeshPro/CreateFontAssetMaterial.png" alt="CreateFontAssetMaterial"></p>
<p>然后在针对新创建的Material Asset调整Shader和具体效果即可，创建完成后就可以在Font Asset的材质下拉列表里选择需要使用的效果：<br><img src="/img/Unity/TextMeshPro/FontAssetMaterialChosen.png" alt="FontAssetMaterialChosen"></p>
<p>关于TextMeshPro的默认相关设置(e.g. 默认创建的Font Asset，默认Fallback到的Font Asset等)是通过TMP Settings文件里的设置来完成的:<br><img src="/img/Unity/TextMeshPro/TMPSettings.png" alt="TMPSettings"></p>
<p>Note:</p>
<ol>
<li>TMP的Fallback的使用是在原始设定的Font Asset里找不到对应文字时的一种回退安全机制，官方的建议是真正使用的Font Asset采用高分率图集，Fallback的Font Asset采用低分辨率图集。</li>
</ol>
<h1 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h1><h2 id="Sprite-Atlas-1"><a href="#Sprite-Atlas-1" class="headerlink" title="Sprite Atlas"></a>Sprite Atlas</h2><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/class-SpriteAtlas.html">Sprite Atlas</a><br><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/MasterVariantAtlases.html">Master and Variant Sprite Atlases</a><br><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/VariantSpriteAtlas.html">Variant Sprite Atlas</a><br><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/SpriteAtlasWorkflow.html">Sprite Atlas workflow</a><br><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/SpriteAtlasDistribution.html">Preparing Sprite Atlases for distribution</a><br><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/SpritePackerModes.html">Sprite Packer Modes</a><br><a target="_blank" rel="noopener" href="https://gameinstitute.qq.com/community/detail/127434">Unity2017新功能之Sprite Atlas详解</a><br><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/80584461">UGUI的图集处理方式-SpriteAtlas的前世今生</a></p>
<h2 id="Timeline-1"><a href="#Timeline-1" class="headerlink" title="Timeline"></a>Timeline</h2><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq826364410/article/details/80511057">Unity–Timeline自定义PlayableTrack</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/beihuanlihe130/article/details/79233320">Unity2017中Timeline的简单使用方法</a><br><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/69e60a27bccb">Unity使用Cinemachine和Timeline入门</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/Unity-Technologies/graph-visualizer">graph-visualizer</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.unity.com/tutorial/timeline#">Timeline</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.unity.com/technology/extending-timeline-a-practical-guide"><strong>xtending Timeline: A Practical Guide</strong></a></p>
<p><a target="_blank" rel="noopener" href="https://blog.unity.com/technology/creative-scripting-for-timeline"><strong>Creative Scripting for Timeline</strong></a></p>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=MzU5MjQ1NTEwOA==&mid=2247493316&idx=1&sn=7e4fef834a8066faca3d2f1f1a090bb4&chksm=fe1dd26fc96a5b79856840f556cf65026facb83520ac1891605e42d5e777d30a0d5219060e21&mpshare=1&scene=1&srcid=0606YJLYnfprk9UjpPQCnre1#rd">Playable API：定制你的动画系统</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/Playables.html">Playables API</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/Playables-Graph.html">The PlayableGraph</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/Playables-ScriptPlayable.html">ScriptPlayable and PlayableBehaviour</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/Playables-Examples.html">Playables Examples</a></p>
<h2 id="TextMesh-Pro"><a href="#TextMesh-Pro" class="headerlink" title="TextMesh Pro"></a>TextMesh Pro</h2><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/com.unity.textmeshpro.html">TextMesh Pro</a><br><a target="_blank" rel="noopener" href="http://www.sardinefish.com/blog/?pid=296">函数式编程与 Signed Distance Field</a><br><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/84700094">Unity游戏开发——TextMeshPro的使用</a><br><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=MzU5MjQ1NTEwOA==&mid=2247495323&idx=1&sn=3100249c5c4a88c20435d129d23eb727&chksm=fe1dda30c96a53267a53ed2bc0dd47bc73273f4e76f3a0d8f0ce322992e2e7e0b284d9a1df32&mpshare=1&scene=1&srcid=102134Bhmm1T67EKpzswm7mz#rd">在Unity 2018中充分使用TextMesh Pro</a><br><a target="_blank" rel="noopener" href="https://blogs.unity3d.com/2018/10/16/making-the-most-of-textmesh-pro-in-unity-2018/">Making the most of TextMesh Pro in Unity 2018</a></p>
<h2 id="Cinemachine-1"><a href="#Cinemachine-1" class="headerlink" title="Cinemachine"></a>Cinemachine</h2><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Packages/com.unity.cinemachine@2.3/manual/CinemachineOverview.html">Cinemachine overview</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.unity.com/tutorial/cinemachine#">Cinemachine Learn</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Unity/">Unity</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Unity/">Unity</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2019/05/20/SQLite学习/" title="SQLite学习" itemprop="url">SQLite学习</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Tony Tang" target="_blank" itemprop="author">Tony Tang</a>
		
  <p class="article-time">
    <time datetime="2019-05-20T15:29:25.000Z" itemprop="datePublished"> 发表于 2019-05-20</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="数据库"><a href="#数据库" class="headerlink" title="数据库"></a>数据库</h1><p>数据存储对于游戏开发来说是必不可少的，在常规的游戏开发中，后端服务器会采用<strong>MySQL(关系型数据库)</strong>,**MongoDB(非关系型数据库)**等作为数据库存储。</p>
<p>关于关系型和菲关系型数据库的学习理解参考:</p>
<p><a href="http://tonytang1990.github.io/2019/05/20/%E7%BD%91%E7%BB%9C%E9%80%9A%E4%BF%A1%E5%92%8C%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%AD%A6%E4%B9%A0/">网络通信和服务器学习</a></p>
<p>本章节是在没有后端但又有玩家数据存储需求的前提下诞生的，通过调研**SQLite(关系型数据库)**正是定位本地高效数据库而非CS结构的数据库，所以本章节通过深入学习SQLite，弄懂如何正确高效的把本地玩家数据存储到本地数据库。</p>
<h2 id="SQLite"><a href="#SQLite" class="headerlink" title="SQLite"></a>SQLite</h2><h3 id="What"><a href="#What" class="headerlink" title="What"></a>What</h3><p>首先来看看SQLite官网的一个介绍:<br><a target="_blank" rel="noopener" href="https://www.sqlite.org/whentouse.html">SQLite is not directly comparable to client&#x2F;server SQL database engines such as MySQL, Oracle, PostgreSQL, or SQL Server since SQLite is trying to solve a different problem.<br>Client&#x2F;server SQL database engines strive to implement a shared repository of enterprise data. They emphasize scalability, concurrency, centralization, and control. SQLite strives to provide local data storage for individual applications and devices. SQLite emphasizes economy, efficiency, reliability, independence, and simplicity.<br>SQLite does not compete with client&#x2F;server databases. SQLite competes with fopen().</a><br>从上面的介绍可以看出，SQLite(C语言编写的库)虽然也是关系型数据库，但他的定位和MySQL不一样，定位的是本地高效数据库而非CS结构的数据库。</p>
<h3 id="Why"><a href="#Why" class="headerlink" title="Why"></a>Why</h3><p>那么什么时候适用于SQLite?什么时候适用于MySQL(CS)了？<br>SQLite官网也给出了明确的介绍，详情参见官网<a target="_blank" rel="noopener" href="https://www.sqlite.org/whentouse.html">SQLite</a><br>这里只列举下官网介绍的什么时候适用于MYSQL:</p>
<ol>
<li>Client&#x2F;Server Applications(CS结构的程序–需要大量客户端服务器通信存储)</li>
<li>High-volume Websites(高吞吐量的网站)</li>
<li>Very large datasets(数据存储量大–数据大)</li>
<li>High Concurrency(高并发–很多人同时写入)</li>
</ol>
<h3 id="How"><a href="#How" class="headerlink" title="How"></a>How</h3><p>这里本人明确了暂时是打算用于单机版游戏的本地数据库，所以倾向于用SQLite来做。<br>接下来会接触以下几个知识点：</p>
<ol>
<li>Unity(游戏开发引擎)</li>
<li>SQLite4Unity3d(第三方给Unity封装好的SQLite库–支持Window，Android(ARM64貌似也支持了)和IOS)</li>
<li>Navicat(可视化数据库工具)</li>
<li>SQL(数据库查询语言)</li>
</ol>
<p><strong>目标</strong>:</p>
<ol>
<li>编写一个数据库操作UI界面，支持数据库的增删改查操作(方便学习使用SQLite4Unity3d提供的接口访问SQLite数据库)</li>
<li>利用Navicat查看Window本地存储的数据库数据(学会Navicat的基本使用和数据库SQL相关操作)</li>
<li>打包编译Window和Android版本到真机上查看效果(确保多平台的兼容性)</li>
</ol>
<h2 id="SQLite4Unity3d实战"><a href="#SQLite4Unity3d实战" class="headerlink" title="SQLite4Unity3d实战"></a>SQLite4Unity3d实战</h2><p><strong>环境准备</strong>:<br>Unity版本：2018.4.8f1<br>SQLite4Unity3d: <a target="_blank" rel="noopener" href="https://github.com/robertohuertasm/SQLite4Unity3d">SQLite4Unity3d</a><br>Navivat: <a target="_blank" rel="noopener" href="https://www.navicat.com/en/download/navicat-premium">Navicat Premium</a><br>SQL:<a target="_blank" rel="noopener" href="https://www.runoob.com/sql/sql-tutorial.html">SQL学习1</a> or <a target="_blank" rel="noopener" href="https://www.w3schools.com/sql/">SQL学习2</a></p>
<p>Note:</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://github.com/robertohuertasm/SQLite4Unity3d"><strong>SQLite4Unity3d uses only the synchronous part of sqlite-net, so all the calls to the database are synchronous.</strong></a>(<strong>SQLite4Unity3d有这么一句官方提示，可以看出所有的数据库操作都是同步的。这里考虑到都是单机本地存储同时数据量也不会很大，所以同步异步不是很重要，所以并不影响个人使用。</strong>)</li>
</ol>
<h3 id="PC实战"><a href="#PC实战" class="headerlink" title="PC实战"></a>PC实战</h3><p>接下来结合SQLite4Unity3d来实战学习数据库的增删改查等操作。<br><strong>第1步</strong><br>创建空的Unity工程，制作简单的交互UI<br><img src="/img/Database/SQLiteUserInterface.png" alt="SQLiteUserInterface"></p>
<p><strong>第2步</strong><br>拷贝SQLite相关库文件：<br><img src="/img/Database/SQLitePlugin.png" alt="SQLitePlugin"><br>还要拷贝SQLite.cs(SQLite4Unity3d作者封装的访问SQLite的相关接口)<br>通过查看SQLite.cs的源代码可以看出,作者封装的这一层通过CS层多抽象了一层数据库访问(增删改查)和表格数据结构，然后结合反射(反射查找对应类的数据库)和Linq(实现快速的数据库查询)来实现通用的数据访问。</p>
<p><strong>第3步</strong><br>定义数据库表结构:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 玩家信息</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Player</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">PrimaryKey</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> UID &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> FirstName &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> LastName &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> Age &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="built_in">string</span> <span class="title">ToString</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">$&quot;[Player: UId=<span class="subst">&#123;UID&#125;</span>, FirstName=<span class="subst">&#123;FirstName&#125;</span>,  LastName=<span class="subst">&#123;LastName&#125;</span>, Age=<span class="subst">&#123;Age&#125;</span>]&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>第4步</strong><br>建立SQLite数据库连接(不存在的话会根据Flag决定是否自动创建):</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">DatabaseFolderPath = <span class="string">$&quot;<span class="subst">&#123;Application.persistentDataPath&#125;</span>/&quot;</span>;</span><br><span class="line"><span class="comment">// 建立数据库连接</span></span><br><span class="line">mSQLiteConnect = <span class="keyword">new</span> SQLiteConnection(<span class="string">$&quot;<span class="subst">&#123;DatabaseFolderPath&#125;</span>/<span class="subst">&#123;DatabaseName&#125;</span>&quot;</span>, SQLiteOpenFlags.ReadWrite | SQLiteOpenFlags.Create);</span><br></pre></td></tr></table></figure>

<p>可以看到本来StreamingAssets目录下没有数据库文件的这一下就创建成功了。<br><img src="/img/Database/CreateDatabase.png" alt="CreateDatabase"></p>
<p><strong>第5步</strong><br>数据库里创建玩家表:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mSQLiteConnect.CreateTable&lt;Player&gt;();</span><br></pre></td></tr></table></figure>

<p><img src="/img/Database/CreatePlayerTable.png" alt="CreatePlayerTable"><br>因为还没有数据所以看不到数据打印，通过Navicat打开数据库，我们可以看到已经成功创建了Player表:<br><img src="/img/Database/PlayerTableView.png" alt="PlayerTableView"></p>
<p><strong>第6步</strong><br>玩家表插入玩家数据：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">mSQLiteConnect.Insert(<span class="keyword">new</span> Player</span><br><span class="line">        &#123;</span><br><span class="line">            UID = <span class="number">1</span>,</span><br><span class="line">            FirstName = <span class="string">&quot;Huan&quot;</span>,</span><br><span class="line">            LastName = <span class="string">&quot;Tang&quot;</span>,</span><br><span class="line">            Age = <span class="number">29</span>,</span><br><span class="line">        &#125;);</span><br><span class="line">        mSQLiteConnect.Insert(<span class="keyword">new</span> Player</span><br><span class="line">        &#123;</span><br><span class="line">            UID = <span class="number">3</span>,</span><br><span class="line">            FirstName = <span class="string">&quot;XiaoYun&quot;</span>,</span><br><span class="line">            LastName = <span class="string">&quot;Zhou&quot;</span>,</span><br><span class="line">            Age = <span class="number">28</span>,</span><br><span class="line">        &#125;);</span><br><span class="line">        mSQLiteConnect.Insert(<span class="keyword">new</span> Player</span><br><span class="line">        &#123;</span><br><span class="line">            UID = <span class="number">2</span>,</span><br><span class="line">            FirstName = <span class="string">&quot;Jiang&quot;</span>,</span><br><span class="line">            LastName = <span class="string">&quot;Fan&quot;</span>,</span><br><span class="line">            Age = <span class="number">28</span>,</span><br><span class="line">        &#125;);</span><br><span class="line">        mSQLiteConnect.Insert(<span class="keyword">new</span> Player</span><br><span class="line">        &#123;</span><br><span class="line">            UID = <span class="number">5</span>,</span><br><span class="line">            FirstName = <span class="string">&quot;ZhenLiang&quot;</span>,</span><br><span class="line">            LastName = <span class="string">&quot;Li&quot;</span>,</span><br><span class="line">            Age = <span class="number">29</span>,</span><br><span class="line">        &#125;);</span><br><span class="line">        mSQLiteConnect.Insert(<span class="keyword">new</span> Player</span><br><span class="line">        &#123;</span><br><span class="line">            UID = <span class="number">4</span>,</span><br><span class="line">            FirstName = <span class="string">&quot;XiaoLin&quot;</span>,</span><br><span class="line">            LastName = <span class="string">&quot;Kuang&quot;</span>,</span><br><span class="line">            Age = <span class="number">28</span>,</span><br><span class="line">        &#125;);</span><br></pre></td></tr></table></figure>

<p><img src="/img/Database/InsertPlayerTableData.png" alt="InsertPlayerTableData"></p>
<p><strong>第7步</strong><br>玩家表删除指定玩家ID数据：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mSQLiteConnect.Delete&lt;Player&gt;(deleteuid);</span><br></pre></td></tr></table></figure>

<p><img src="/img/Database/DeletePlayerTableData.png" alt="DeletePlayerTableData"></p>
<p><strong>第7步</strong><br>玩家表修改指定玩家Age数据：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">valideplayer.Age = newage;</span><br><span class="line">mSQLiteConnect.Update(valideplayer);</span><br></pre></td></tr></table></figure>

<p><img src="/img/Database/ModifyPlayerTableAgeData.png" alt="ModifyPlayerTableAgeData"></p>
<p><strong>第8步</strong><br>删除玩家表所有数据：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> rownumber = mSQLiteConnect.DeleteAll&lt;Player&gt;();</span><br></pre></td></tr></table></figure>

<p><img src="/img/Database/DeleteAllPlayerTableData.png" alt="DeleteAllPlayerTableData"><br>可以看到我们成功删除了玩家表里的所有数据，接下来用Navicat验证下数据库里的情况：<br><img src="/img/Database/DatabaseAfterDeleteAllPlayerTableData.png" alt="DatabaseAfterDeleteAllPlayerTableData"></p>
<p><strong>第9步</strong><br>删除数据库里的玩家表：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> rownumberaffected = mSQLiteConnect.DropTable&lt;Player&gt;();</span><br></pre></td></tr></table></figure>

<p><img src="/img/Database/DeletePlayerTable.png" alt="DeletePlayerTable"><br>删除玩家表后通过Navicat查看数据库:<br><img src="/img/Database/DatabaseViewAfterDeletePlayerTable.png" alt="DatabaseViewAfterDeletePlayerTable"><br>通过查看源码，我们可以看到，DraopTable底层实际是通过调用SQL的Drop语句来实现删除表的:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Executes a &quot;drop table&quot; on the database.  This is non-recoverable.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="built_in">int</span> <span class="title">DropTable</span>&lt;<span class="title">T</span>&gt;()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> map = GetMapping (<span class="keyword">typeof</span> (T));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> query = <span class="built_in">string</span>.Format(<span class="string">&quot;drop table if exists \&quot;&#123;0&#125;\&quot;&quot;</span>, map.TableName);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Execute (query);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>关于SQL更多学习参考:<br><a target="_blank" rel="noopener" href="https://www.runoob.com/sql/sql-tutorial.html">SQL 教程</a><br><a target="_blank" rel="noopener" href="https://www.w3schools.com/sql/default.asp">SQL Tutorial</a><br>可以看到通过使用SQLite4Unity3d的SQLite.cs相关的接口，成功的实现了对于数据库的创建，以及数据库表的创建，增删改查等操作。</p>
<p><strong>第10步</strong><br>关闭数据库连接:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mSQLiteConnect.Close();</span><br></pre></td></tr></table></figure>

<h3 id="Android实战"><a href="#Android实战" class="headerlink" title="Android实战"></a>Android实战</h3><p>为了验证SQLite4Unity3d的跨平台能力，接下来打包验证真机:<br>Android真机数据库操作:<br><img src="/img/Database/AndroidSQLiteUsing.png" alt="AndroidSQLiteUsing"></p>
<p>Android真机数据库文件查看(本人使用的<strong>ES文件浏览器</strong>)：<br>![DatabaseViewAfterOperation]&#x2F;img&#x2F;Database&#x2F;DatabaseViewAfterOperation.png)</p>
<p>Android真机数据库详细信息PC查看:<br><img src="/img/Database/AndroidDatabaseView.png" alt="AndroidDatabaseView"></p>
<p>可以看到Android真机上数据库的一些基础操作都成功了的。IOS这里就暂时不验证了，根据Github上的介绍理论上是支持的。</p>
<p>Note:</p>
<ol>
<li>真机可读取目录修改为Application.persistentDataPath,因为Application.streamingAssetsPath在真机上是只读目录。</li>
<li>真机使用<strong>ES文件浏览器</strong>来查看程序目录下的数据库文件</li>
</ol>
<h3 id="SQLite4Unity3d进阶"><a href="#SQLite4Unity3d进阶" class="headerlink" title="SQLite4Unity3d进阶"></a>SQLite4Unity3d进阶</h3><p>学习了SQLite4Unity3d的基础使用，接下来要考虑的是实战使用时，如何封装一层数据库管理，方便游戏里的所有数据库数据都成功的加载读取修改保存。</p>
<p>这里主要是对于SQLite.cs的简单封装，用于支持多数据库创建，以及数据库创建路径管理，以及自定义数据库表的封装访问。</p>
<p>上代码之前，先简单看下封装的代码设计:</p>
<ul>
<li>DatabaseManager.cs(<strong>对多数据库创建访问以及路径规划进行封装支持</strong>)</li>
<li>BaseDatabase.cs(<strong>数据库基类抽象</strong>–实现对数据库操作进行封装)</li>
<li>BaseTableData.cs(<strong>数据库表数据基类抽象</strong>–实现对数据库表操作进行封装)</li>
<li>BaseIntTableData.cs(<strong>int做主键的表数据抽象</strong>–实现对int主键表的操作封装)</li>
<li>BaseStringTableData.cs(<strong>string做主键的表数据抽象</strong>–实现对string主键表的操作封装)</li>
</ul>
<p>DatabaseManager.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">TH.Modules.Data</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 数据库管理类</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 主要功能如下:</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 1. 数据库路径处理(数据库存储管理)</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 2. 多数据库支持</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 3. 数据库连接，关闭，CUID操作等操作依然使用SQLite的封装</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">DatabaseManager</span> : <span class="title">SingletonTemplate</span>&lt;<span class="title">DatabaseManager</span>&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 数据库文件夹地址</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> <span class="keyword">static</span> <span class="built_in">string</span> DatabaseFolderPath = Application.persistentDataPath + <span class="string">&quot;/Database/&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 已连接的数据库映射Map</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> Key为数据库名，Value为对应的数据库连接</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">private</span> Dictionary&lt;<span class="built_in">string</span>, SQLiteConnection&gt; ConnectedDatabaseMap;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">DatabaseManager</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//检查数据库文件目录是否存在</span></span><br><span class="line">            <span class="keyword">if</span>(!Directory.Exists(DatabaseFolderPath))</span><br><span class="line">            &#123;</span><br><span class="line">                Directory.CreateDirectory(DatabaseFolderPath);</span><br><span class="line">            &#125;</span><br><span class="line">            ConnectedDatabaseMap = <span class="keyword">new</span> Dictionary&lt;<span class="built_in">string</span>, SQLiteConnection&gt;();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 打开数据库连接</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;databasename&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;openflags&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;storeDateTimeAsTicks&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">openDatabase</span>(<span class="params"><span class="built_in">string</span> databasename, SQLiteOpenFlags openflags = SQLiteOpenFlags.ReadWrite | SQLiteOpenFlags.Create, <span class="built_in">bool</span> storeDateTimeAsTicks = <span class="literal">false</span></span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(!isDatabaseConnected(databasename))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> databasepath = DatabaseFolderPath + databasename;</span><br><span class="line">                <span class="keyword">var</span> connection = <span class="keyword">new</span> SQLiteConnection(databasepath, openflags, storeDateTimeAsTicks);</span><br><span class="line">                ConnectedDatabaseMap.Add(databasename, connection);</span><br><span class="line">                Debug.Log(<span class="string">$&quot;连接数据库:<span class="subst">&#123;databasename&#125;</span>&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                Debug.Log(<span class="string">$&quot;数据库:<span class="subst">&#123;databasename&#125;</span>已连接,请勿重复连接!&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 获取指定数据库连接</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;databasename&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> SQLiteConnection <span class="title">getDatabaseConnection</span>(<span class="params"><span class="built_in">string</span> databasename</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            SQLiteConnection connection;</span><br><span class="line">            <span class="keyword">if</span> (ConnectedDatabaseMap.TryGetValue(databasename, <span class="keyword">out</span> connection))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> connection;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 关闭数据库连接</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;databasename&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">closeDatabase</span>(<span class="params"><span class="built_in">string</span> databasename</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            SQLiteConnection connection;</span><br><span class="line">            <span class="keyword">if</span>(ConnectedDatabaseMap.TryGetValue(databasename, <span class="keyword">out</span> connection))</span><br><span class="line">            &#123;</span><br><span class="line">                connection.Close();</span><br><span class="line">                ConnectedDatabaseMap.Remove(databasename);</span><br><span class="line">                Debug.Log(<span class="string">$&quot;关闭数据库:<span class="subst">&#123;databasename&#125;</span>&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                Debug.LogError(<span class="string">$&quot;未连接数据库:<span class="subst">&#123;databasename&#125;</span>,关闭失败!&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 关闭所有已连接的数据库</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">closeAllDatabase</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">var</span> databasename <span class="keyword">in</span> ConnectedDatabaseMap.Keys)</span><br><span class="line">            &#123;</span><br><span class="line">                closeDatabase(databasename);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 清除</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">clear</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            closeAllDatabase();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 指定数据库是否已连接</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;databasename&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="built_in">bool</span> <span class="title">isDatabaseConnected</span>(<span class="params"><span class="built_in">string</span> databasename</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> ConnectedDatabaseMap.ContainsKey(databasename);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="keyword">region</span> 辅助方法</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 获取指定数据库表的所有数据</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;typeparam name=&quot;T&quot;&gt;</span><span class="doctag">&lt;/typeparam&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;databasename&quot;&gt;</span>数据库名<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">getTableAllDatasInOneString</span>&lt;<span class="title">T</span>&gt;(<span class="params"><span class="built_in">string</span> databasename</span>) <span class="keyword">where</span> T : <span class="keyword">new</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            SQLiteConnection sqliteconnection = getDatabaseConnection(databasename);</span><br><span class="line">            <span class="keyword">if</span> (sqliteconnection != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> querytable = sqliteconnection.Table&lt;T&gt;();</span><br><span class="line">                <span class="keyword">if</span> (querytable != <span class="literal">null</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">var</span> result = <span class="built_in">string</span>.Empty;</span><br><span class="line">                    <span class="keyword">foreach</span> (<span class="keyword">var</span> data <span class="keyword">in</span> querytable)</span><br><span class="line">                    &#123;</span><br><span class="line">                        result += data.ToString();</span><br><span class="line">                        result += <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">return</span> result;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="built_in">string</span>.Empty;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">string</span>.Empty;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>TODO:</p>
<ol>
<li><strong>现阶段是默认存在包外的persistentDataPath，对于数据库如何做好加密管理避免被轻易修改，这个问题还有待学习思考。</strong></li>
<li><strong>数据库表是否存在还没找到方式判定(暂时是从流程上确保表存在的)</strong></li>
</ol>
<p>BaseDatabase.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">TH.Modules.Data</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> BaseDatabase.cs</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 数据库基类抽象</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Note:</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 子类自行实现单例模式方便访问</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title">BaseDatabase</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 数据库连接</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">protected</span> SQLiteConnection mSQLiteConnect;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 数据库名</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">virtual</span> <span class="built_in">string</span> DatabaseName</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">$&quot;<span class="subst">&#123;GetType().Name&#125;</span>.db&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="title">BaseDatabase</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 加载数据库</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">LoadDatabase</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            mSQLiteConnect = DatabaseManager.Singleton.openDatabase(DatabaseName);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 数据库是否已连接</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">IsConnected</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> mSQLiteConnect != <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span>// <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span>// 指定表是否存在</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span>// <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span>// <span class="doctag">&lt;typeparam name=&quot;T&quot;&gt;</span><span class="doctag">&lt;/typeparam&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span>// <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment">//public bool IsTableExist&lt;T&gt;() where T : BaseTableData, new()</span></span><br><span class="line">        <span class="comment">//&#123;</span></span><br><span class="line">        <span class="comment">//    if (!IsConnected())</span></span><br><span class="line">        <span class="comment">//    &#123;</span></span><br><span class="line">        <span class="comment">//        Debug.LogError($&quot;数据库:&#123;DatabaseName&#125;未连接，访问类名:&#123;typeof(T).Name&#125;表是否存在失败!&quot;);</span></span><br><span class="line">        <span class="comment">//        return false;</span></span><br><span class="line">        <span class="comment">//    &#125;</span></span><br><span class="line">        <span class="comment">//    // <span class="doctag">TODO:</span> 找到方法判定是否存在</span></span><br><span class="line">        <span class="comment">//    return false;</span></span><br><span class="line">        <span class="comment">//&#125;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 创建指定数据库表</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;typeparam name=&quot;T&quot;&gt;</span><span class="doctag">&lt;/typeparam&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">CreateTable</span>&lt;<span class="title">T</span>&gt;() <span class="keyword">where</span> T : BaseTableData, <span class="keyword">new</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(!IsConnected())</span><br><span class="line">            &#123;</span><br><span class="line">                Debug.LogError(<span class="string">$&quot;数据库:<span class="subst">&#123;DatabaseName&#125;</span>未连接，创建类名:<span class="subst">&#123;<span class="keyword">typeof</span>(T).Name&#125;</span>表失败!&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//if(!IsTableExist&lt;T&gt;())</span></span><br><span class="line">            <span class="comment">//&#123;</span></span><br><span class="line">            <span class="comment">//    Debug.LogError($&quot;数据库:&#123;DatabaseName&#125;，类名:&#123;typeof(T).Name&#125;表已存在，请勿重复创建!&quot;);</span></span><br><span class="line">            <span class="comment">//    return false;</span></span><br><span class="line">            <span class="comment">//&#125;</span></span><br><span class="line">            mSQLiteConnect.CreateTable&lt;T&gt;();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 插入指定int主键的表数据(如果表不存在则创建表)</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;typeparam name=&quot;T&quot;&gt;</span><span class="doctag">&lt;/typeparam&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">InsertDataI</span>&lt;<span class="title">T</span>&gt;(<span class="params">T data</span>) <span class="keyword">where</span> T : BaseIntTableData, <span class="keyword">new</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (!IsConnected())</span><br><span class="line">            &#123;</span><br><span class="line">                Debug.LogError(<span class="string">$&quot;数据库:<span class="subst">&#123;DatabaseName&#125;</span>未连接，插入类名:<span class="subst">&#123;<span class="keyword">typeof</span>(T).Name&#125;</span>表数据失败!&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//if (!IsTableExist&lt;T&gt;())</span></span><br><span class="line">            <span class="comment">//&#123;</span></span><br><span class="line">            <span class="comment">//    CreateTable&lt;T&gt;();</span></span><br><span class="line">            <span class="comment">//&#125;</span></span><br><span class="line">            mSQLiteConnect.Insert(data);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 插入指定int主键的表数据(如果表不存在则创建表,如果主键存在则覆盖更新)</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;typeparam name=&quot;T&quot;&gt;</span><span class="doctag">&lt;/typeparam&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">InsertOrReplaceDataI</span>&lt;<span class="title">T</span>&gt;(<span class="params">T data</span>) <span class="keyword">where</span> T : BaseIntTableData, <span class="keyword">new</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (!IsConnected())</span><br><span class="line">            &#123;</span><br><span class="line">                Debug.LogError(<span class="string">$&quot;数据库:<span class="subst">&#123;DatabaseName&#125;</span>未连接，插入类名:<span class="subst">&#123;<span class="keyword">typeof</span>(T).Name&#125;</span>表数据失败!&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//if (!IsTableExist&lt;T&gt;())</span></span><br><span class="line">            <span class="comment">//&#123;</span></span><br><span class="line">            <span class="comment">//    CreateTable&lt;T&gt;();</span></span><br><span class="line">            <span class="comment">//&#125;</span></span><br><span class="line">            mSQLiteConnect.InsertOrReplace(data);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 插入指定int主键的表数据(如果表不存在则创建表)</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;typeparam name=&quot;T&quot;&gt;</span><span class="doctag">&lt;/typeparam&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">InsertDataS</span>&lt;<span class="title">T</span>&gt;(<span class="params">T data</span>) <span class="keyword">where</span> T : BaseStringTableData, <span class="keyword">new</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (!IsConnected())</span><br><span class="line">            &#123;</span><br><span class="line">                Debug.LogError(<span class="string">$&quot;数据库:<span class="subst">&#123;DatabaseName&#125;</span>未连接，插入类名:<span class="subst">&#123;<span class="keyword">typeof</span>(T).Name&#125;</span>表数据失败!&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//if (!IsTableExist&lt;T&gt;())</span></span><br><span class="line">            <span class="comment">//&#123;</span></span><br><span class="line">            <span class="comment">//    CreateTable&lt;T&gt;();</span></span><br><span class="line">            <span class="comment">//&#125;</span></span><br><span class="line">            mSQLiteConnect.Insert(data);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 插入指定string主键的表数据(如果表不存在则创建表,如果主键存在则覆盖更新)</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;typeparam name=&quot;T&quot;&gt;</span><span class="doctag">&lt;/typeparam&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">InsertOrReplaceDataS</span>&lt;<span class="title">T</span>&gt;(<span class="params">T data</span>) <span class="keyword">where</span> T : BaseStringTableData, <span class="keyword">new</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (!IsConnected())</span><br><span class="line">            &#123;</span><br><span class="line">                Debug.LogError(<span class="string">$&quot;数据库:<span class="subst">&#123;DatabaseName&#125;</span>未连接，插入类名:<span class="subst">&#123;<span class="keyword">typeof</span>(T).Name&#125;</span>表数据失败!&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//if (!IsTableExist&lt;T&gt;())</span></span><br><span class="line">            <span class="comment">//&#123;</span></span><br><span class="line">            <span class="comment">//    CreateTable&lt;T&gt;();</span></span><br><span class="line">            <span class="comment">//&#125;</span></span><br><span class="line">            mSQLiteConnect.InsertOrReplace(data);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 删除指定UID的表数据(整形主键)</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;typeparam name=&quot;T&quot;&gt;</span><span class="doctag">&lt;/typeparam&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">DeleteDataByUIDI</span>&lt;<span class="title">T</span>&gt;(<span class="params"><span class="built_in">int</span> uid</span>) <span class="keyword">where</span> T : BaseIntTableData, <span class="keyword">new</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (!IsConnected())</span><br><span class="line">            &#123;</span><br><span class="line">                Debug.LogError(<span class="string">$&quot;数据库:<span class="subst">&#123;DatabaseName&#125;</span>未连接，删除类名:<span class="subst">&#123;<span class="keyword">typeof</span>(T).Name&#125;</span>表UID:<span class="subst">&#123;uid&#125;</span>数据失败!&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">var</span> deletedNumber = mSQLiteConnect.Delete&lt;T&gt;(uid);</span><br><span class="line">            Debug.Log(<span class="string">$&quot;数据库:<span class="subst">&#123;DatabaseName&#125;</span>，删除类名:<span class="subst">&#123;<span class="keyword">typeof</span>(T).Name&#125;</span>表UID:<span class="subst">&#123;uid&#125;</span>数量:<span class="subst">&#123;deletedNumber&#125;</span>&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> deletedNumber &gt; <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 删除指定UID的表数据(字符串主键)</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;typeparam name=&quot;T&quot;&gt;</span><span class="doctag">&lt;/typeparam&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">DeleteDataByUIDS</span>&lt;<span class="title">T</span>&gt;(<span class="params"><span class="built_in">string</span> uid</span>) <span class="keyword">where</span> T : BaseStringTableData, <span class="keyword">new</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (!IsConnected())</span><br><span class="line">            &#123;</span><br><span class="line">                Debug.LogError(<span class="string">$&quot;数据库:<span class="subst">&#123;DatabaseName&#125;</span>未连接，删除类名:<span class="subst">&#123;<span class="keyword">typeof</span>(T).Name&#125;</span>表数据失败!&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">var</span> deletedNumber = mSQLiteConnect.Delete&lt;T&gt;(uid);</span><br><span class="line">            Debug.Log(<span class="string">$&quot;数据库:<span class="subst">&#123;DatabaseName&#125;</span>，删除类名:<span class="subst">&#123;<span class="keyword">typeof</span>(T).Name&#125;</span>表UID:<span class="subst">&#123;uid&#125;</span>数量:<span class="subst">&#123;deletedNumber&#125;</span>&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> deletedNumber &gt; <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 更新指定int主键的表数据(如果表不存在则创建表)</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;typeparam name=&quot;T&quot;&gt;</span><span class="doctag">&lt;/typeparam&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">UpdateDataI</span>&lt;<span class="title">T</span>&gt;(<span class="params">T data</span>) <span class="keyword">where</span> T : BaseIntTableData, <span class="keyword">new</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (!IsConnected())</span><br><span class="line">            &#123;</span><br><span class="line">                Debug.LogError(<span class="string">$&quot;数据库:<span class="subst">&#123;DatabaseName&#125;</span>未连接，插入类名:<span class="subst">&#123;<span class="keyword">typeof</span>(T).Name&#125;</span>表数据失败!&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//if (!IsTableExist&lt;T&gt;())</span></span><br><span class="line">            <span class="comment">//&#123;</span></span><br><span class="line">            <span class="comment">//    CreateTable&lt;T&gt;();</span></span><br><span class="line">            <span class="comment">//&#125;</span></span><br><span class="line">            <span class="keyword">var</span> updatedNumber = mSQLiteConnect.Update(data);</span><br><span class="line">            Debug.Log(<span class="string">$&quot;数据库:<span class="subst">&#123;DatabaseName&#125;</span>，更新类名:<span class="subst">&#123;<span class="keyword">typeof</span>(T).Name&#125;</span>表UID:<span class="subst">&#123;data.UID&#125;</span>数量:<span class="subst">&#123;updatedNumber&#125;</span>&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> updatedNumber &gt; <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 更新指定string主键的表数据(如果表不存在则创建表)</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;typeparam name=&quot;T&quot;&gt;</span><span class="doctag">&lt;/typeparam&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">UpdateDataS</span>&lt;<span class="title">T</span>&gt;(<span class="params">T data</span>) <span class="keyword">where</span> T : BaseStringTableData, <span class="keyword">new</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (!IsConnected())</span><br><span class="line">            &#123;</span><br><span class="line">                Debug.LogError(<span class="string">$&quot;数据库:<span class="subst">&#123;DatabaseName&#125;</span>未连接，插入类名:<span class="subst">&#123;<span class="keyword">typeof</span>(T).Name&#125;</span>表数据失败!&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//if (!IsTableExist&lt;T&gt;())</span></span><br><span class="line">            <span class="comment">//&#123;</span></span><br><span class="line">            <span class="comment">//    CreateTable&lt;T&gt;();</span></span><br><span class="line">            <span class="comment">//&#125;</span></span><br><span class="line">            <span class="keyword">var</span> updatedNumber = mSQLiteConnect.Update(data);</span><br><span class="line">            Debug.Log(<span class="string">$&quot;数据库:<span class="subst">&#123;DatabaseName&#125;</span>，更新类名:<span class="subst">&#123;<span class="keyword">typeof</span>(T).Name&#125;</span>表UID:<span class="subst">&#123;data.UID&#125;</span>数量:<span class="subst">&#123;updatedNumber&#125;</span>&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> updatedNumber &gt; <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 获取指定UID的表数据(整形主键)</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;typeparam name=&quot;T&quot;&gt;</span><span class="doctag">&lt;/typeparam&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> T <span class="title">GetDataByUIDI</span>&lt;<span class="title">T</span>&gt;(<span class="params"><span class="built_in">int</span> uid</span>) <span class="keyword">where</span> T : BaseIntTableData, <span class="keyword">new</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (!IsConnected())</span><br><span class="line">            &#123;</span><br><span class="line">                Debug.LogError(<span class="string">$&quot;数据库:<span class="subst">&#123;DatabaseName&#125;</span>未连接，获取类名:<span class="subst">&#123;<span class="keyword">typeof</span>(T).Name&#125;</span>表数据失败!&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">var</span> data = mSQLiteConnect.Find&lt;T&gt;((databaseTable) =&gt; databaseTable.UID == uid);</span><br><span class="line">            <span class="keyword">if</span> (data == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                Debug.LogError(<span class="string">$&quot;数据库:<span class="subst">&#123;DatabaseName&#125;</span>，获取类名:<span class="subst">&#123;<span class="keyword">typeof</span>(T).Name&#125;</span>的UID:<span class="subst">&#123;uid&#125;</span>表数据不存在!&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> data;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 获取指定UID的表数据(字符串主键)</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;typeparam name=&quot;T&quot;&gt;</span><span class="doctag">&lt;/typeparam&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> T <span class="title">GetDataByUIDS</span>&lt;<span class="title">T</span>&gt;(<span class="params"><span class="built_in">string</span> uid</span>) <span class="keyword">where</span> T : BaseStringTableData, <span class="keyword">new</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (!IsConnected())</span><br><span class="line">            &#123;</span><br><span class="line">                Debug.LogError(<span class="string">$&quot;数据库:<span class="subst">&#123;DatabaseName&#125;</span>未连接，获取类名:<span class="subst">&#123;<span class="keyword">typeof</span>(T).Name&#125;</span>表数据失败!&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">var</span> data = mSQLiteConnect.Find&lt;T&gt;((databaseTable) =&gt; databaseTable.UID == uid);</span><br><span class="line">            <span class="keyword">if</span> (data == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                Debug.LogError(<span class="string">$&quot;数据库:<span class="subst">&#123;DatabaseName&#125;</span>，获取类名:<span class="subst">&#123;<span class="keyword">typeof</span>(T).Name&#125;</span>的UID:<span class="subst">&#123;uid&#125;</span>表数据不存在!&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> data;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 获取指定表所有数据</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;typeparam name=&quot;T&quot;&gt;</span><span class="doctag">&lt;/typeparam&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">TableQuery</span>&lt;<span class="title">T</span>&gt; <span class="title">GetAllData</span>&lt;<span class="title">T</span>&gt;() <span class="keyword">where</span> T : BaseTableData, <span class="keyword">new</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (!IsConnected())</span><br><span class="line">            &#123;</span><br><span class="line">                Debug.LogError(<span class="string">$&quot;数据库:<span class="subst">&#123;DatabaseName&#125;</span>未连接，获取类名:<span class="subst">&#123;<span class="keyword">typeof</span>(T).Name&#125;</span>表数据失败!&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">var</span> tbData = mSQLiteConnect.Table&lt;T&gt;();</span><br><span class="line">            <span class="keyword">if</span> (tbData == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                Debug.LogError(<span class="string">$&quot;数据库:<span class="subst">&#123;DatabaseName&#125;</span>，获取类名:<span class="subst">&#123;<span class="keyword">typeof</span>(T).Name&#125;</span>表所有数据不存在!&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> tbData;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 删除指定表所有数据</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="built_in">int</span> <span class="title">DeleteTableAll</span>&lt;<span class="title">T</span>&gt;() <span class="keyword">where</span> T : BaseTableData, <span class="keyword">new</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (!IsConnected())</span><br><span class="line">            &#123;</span><br><span class="line">                Debug.LogError(<span class="string">$&quot;数据库:<span class="subst">&#123;DatabaseName&#125;</span>未连接，删除类名:<span class="subst">&#123;<span class="keyword">typeof</span>(T).Name&#125;</span>表所有数据失败!&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//if (!IsTableExist&lt;T&gt;())</span></span><br><span class="line">            <span class="comment">//&#123;</span></span><br><span class="line">            <span class="comment">//    Debug.LogError($&quot;数据库:&#123;DatabaseName&#125;，删除类名:&#123;typeof(T).Name&#125;表不存在,删除所有数据失败!&quot;);</span></span><br><span class="line">            <span class="comment">//    return 0;</span></span><br><span class="line">            <span class="comment">//&#125;</span></span><br><span class="line">            <span class="keyword">var</span> deletedNumber = mSQLiteConnect.DeleteAll&lt;T&gt;();</span><br><span class="line">            Debug.Log(<span class="string">$&quot;数据库:<span class="subst">&#123;DatabaseName&#125;</span>，删除类名:<span class="subst">&#123;<span class="keyword">typeof</span>(T).Name&#125;</span>表所有数据数量:<span class="subst">&#123;deletedNumber&#125;</span>&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> deletedNumber;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 删除指定表</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="built_in">int</span> <span class="title">DeleteTable</span>&lt;<span class="title">T</span>&gt;() <span class="keyword">where</span> T : BaseTableData, <span class="keyword">new</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (!IsConnected())</span><br><span class="line">            &#123;</span><br><span class="line">                Debug.LogError(<span class="string">$&quot;数据库:<span class="subst">&#123;DatabaseName&#125;</span>未连接，删除类名:<span class="subst">&#123;<span class="keyword">typeof</span>(T).Name&#125;</span>表失败!&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">var</span> deletedNumber = mSQLiteConnect.DropTable&lt;T&gt;();</span><br><span class="line">            Debug.Log(<span class="string">$&quot;数据库:<span class="subst">&#123;DatabaseName&#125;</span>，删除类名:<span class="subst">&#123;<span class="keyword">typeof</span>(T).Name&#125;</span>表数量:<span class="subst">&#123;deletedNumber&#125;</span>&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> deletedNumber;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 关闭数据库</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">CloseDatabase</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            DatabaseManager.Singleton.closeDatabase(DatabaseName);</span><br><span class="line">            mSQLiteConnect = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>BaseTableData.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">TH.Modules.Data</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> BaseTableData.cs</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 数据库表数据基类抽象</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title">BaseTableData</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 表名</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> TableName</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> GetType().Name;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">BaseTableData</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 打印数据</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="built_in">string</span> <span class="title">ToString</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">$&quot;[TableName:<span class="subst">&#123;TableName&#125;</span>]&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>BaseIntTableData.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">TH.Modules.Data</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> BaseIntTableData.cs</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Int做主键的表数据抽象</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title">BaseIntTableData</span> : <span class="title">BaseTableData</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 主键UID</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        [<span class="meta">PrimaryKey</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">int</span> UID</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span>;</span><br><span class="line">            <span class="keyword">set</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">BaseIntTableData</span>() : <span class="title">base</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 构造函数</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;uid&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">BaseIntTableData</span>(<span class="params"><span class="built_in">int</span> uid</span>) : <span class="title">base</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            UID = uid;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 打印所有表数据</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="built_in">string</span> <span class="title">ToString</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">$&quot;[TableName:<span class="subst">&#123;TableName&#125;</span> UID:<span class="subst">&#123;UID&#125;</span>]&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>BaseStringTableData.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">TH.Modules.Data</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> BaseStringTableData.cs</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> string做主键的表数据抽象</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title">BaseStringTableData</span> : <span class="title">BaseTableData</span></span><br><span class="line">    &#123;</span><br><span class="line">        [<span class="meta">PrimaryKey</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> UID</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span>;</span><br><span class="line">            <span class="keyword">set</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">BaseStringTableData</span>() : <span class="title">base</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 构造函数</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;uid&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">BaseStringTableData</span>(<span class="params"><span class="built_in">string</span> uid</span>) : <span class="title">base</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            UID = uid;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 打印数据</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="built_in">string</span> <span class="title">ToString</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">$&quot;[TableName:<span class="subst">&#123;TableName&#125;</span> UID:<span class="subst">&#123;UID&#125;</span>]&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>GameDatabase.cs(自定义游戏数据库)</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> GameDatabase.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 游戏数据库</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">GameDatabase</span> : <span class="title">BaseDatabase</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 单例对象</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> GameDatabase Singleton</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(mSingleton != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> mSingleton;</span><br><span class="line">            &#125;</span><br><span class="line">            mSingleton = <span class="keyword">new</span> GameDatabase();</span><br><span class="line">            <span class="keyword">return</span> mSingleton;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> GameDatabase mSingleton;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">GameDatabase</span>() : <span class="title">base</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Player.cs(自定义玩家数据表结构)</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 玩家信息表成员结构</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Player</span> : <span class="title">BaseIntTableData</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 名</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> FirstName</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 姓</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> LastName</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 年龄</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Indexed</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> Age</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Player</span>() : <span class="title">base</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 构造函数</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;uid&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;firstName&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;lastName&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;age&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Player</span>(<span class="params"><span class="built_in">int</span> uid, <span class="built_in">string</span> firstName, <span class="built_in">string</span> lastName, <span class="built_in">int</span> age</span>) : <span class="title">base</span>(<span class="params">uid</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        FirstName = firstName;</span><br><span class="line">        LastName = lastName;</span><br><span class="line">        Age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 打印数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="built_in">string</span> <span class="title">ToString</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">$&quot;[Player: UID=<span class="subst">&#123;UID&#125;</span>, FirstName=<span class="subst">&#123;FirstName&#125;</span>,  LastName=<span class="subst">&#123;LastName&#125;</span>, Age=<span class="subst">&#123;Age&#125;</span>]&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>进阶版的实战代码见Github源码:</p>
<p><a target="_blank" rel="noopener" href="https://github.com/TonyTang1990/SQLiteStudy">SQLiteStudy</a></p>
<h2 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h2><ol>
<li><strong>SQLite适用于非CS结构，存储数据量不大，不会多人并发操作数据库的情况(好比单机游戏的数据库)。</strong></li>
<li><strong>数据量大或者多人操作频繁或者需要CS架构支持，更适合MySQL+Redis</strong></li>
<li><strong>SQLite4Unity3d通过反射和Linq对SQLite的封装实现了对于SQL无感和ORM(Object Relational Mapping)数据库访问方式。</strong></li>
<li><strong>SQLite4Unity3d支持多平台，适合单机游戏数据存储</strong></li>
</ol>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a target="_blank" rel="noopener" href="https://github.com/robertohuertasm/SQLite4Unity3d">SQLite4Unity3d</a></p>
<h1 id="Github地址"><a href="#Github地址" class="headerlink" title="Github地址"></a>Github地址</h1><p><a target="_blank" rel="noopener" href="https://github.com/TonyTang1990/SQLiteStudy">SQLiteStudy</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Database/">Database</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Database/">Database</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2019/05/20/网络通信和服务器学习/" title="网络通信和服务器学习" itemprop="url">网络通信和服务器学习</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Tony Tang" target="_blank" itemprop="author">Tony Tang</a>
		
  <p class="article-time">
    <time datetime="2019-05-20T15:29:25.000Z" itemprop="datePublished"> 发表于 2019-05-20</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>本章节是为了记录学习游戏开发过程中的服务器搭建以及前后端网络通信相关的知识点，游戏开发中联网是必不可少的，无论是从游戏热更新(服务器通知版本以及热更相关信息)，还是游戏社交(微信分享，联机组队)，还是防破解(服务器校验)都离不开网络通信和服务器。</p>
<p>本人是前端程序，对后端服务器开发几乎一窍不通，本篇文章也算是为了开阔自己的眼界，同时也是为了未来自己的游戏有网络这一块的支持需要对服务器搭建以及网络通信要有所了解。本文着重点不在于高效和优美的框架设计，着眼于基础的网络通信和服务器搭建，而这正是此篇博客的初衷。</p>
<ul>
<li>目标</li>
</ul>
<ol>
<li>理解游戏服务器工作原理</li>
<li>理解不同服务器框架的优劣，选择合适的服务器框架</li>
<li><strong>学会搭建基础的游戏服务器，具备基础的数据存储功能(本文重点)</strong></li>
<li><strong>掌握网络通信知识，搭建前后端通信框架，支持前后端通信(本文重点)</strong></li>
</ol>
<h1 id="服务器"><a href="#服务器" class="headerlink" title="服务器"></a>服务器</h1><p>那么什么是服务器了？</p>
<p>个人简单的理解，可以把服务器理解成运行在远程电脑上，通过网络对客户端提供服务(数据处理，数据存储读取，消息转发等)的机器或者软件。</p>
<p>了解服务器架构：</p>
<p><a target="_blank" rel="noopener" href="https://www.infoq.cn/article/a-brief-history-of-the-game-server-architecture">游戏服务器架构的演进简史</a></p>
<p>从上面可以看出服务器有以下几个基础功能：</p>
<ol>
<li>对于游戏数据和玩家数据的存储(数据存储)</li>
<li>对玩家数据进行数据广播和同步(消息通信)</li>
<li>把一部分游戏逻辑在服务器上运算，做好验证，防止外挂(服务器验证)</li>
<li>服务器架构设计(容灾，性能，扩容等)</li>
</ol>
<p>第三点涉及到前后端框架设计(帧同步 or 状态同步等)，第四点更与服务器端密切相关，本文着眼点是前两点，第三点和第四点作为未来学习的一个知识点，。</p>
<h2 id="数据存储"><a href="#数据存储" class="headerlink" title="数据存储"></a>数据存储</h2><h3 id="关系型数据库"><a href="#关系型数据库" class="headerlink" title="关系型数据库"></a>关系型数据库</h3><p><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%85%B3%E7%B3%BB%E6%95%B0%E6%8D%AE%E5%BA%93">关系数据库（英语：Relational database），是创建在关系模型基础上的数据库，借助于集合代数等数学概念和方法来处理数据库中的数据。现实世界中的各种实体以及实体之间的各种联系均用关系模型来表示。</a></p>
<p>个人简单的理解，关系数据库大概就是以前学SQL的时候，数据库里通过表来抽象实体数据，表之间通过ID映射关联起来的概念(e.g. 比如数据库里有两张表，一张员工表，一张员工数据表。员工表用于抽象员工ID，员工名字，员工薪资等信息。而员工数据用于存储员工ID，员工入职日期等信息。然后两张表示通过员工ID来映射关联起来。)。</p>
<p>典型的关系型数据库:<br>MySQL</p>
<p>典型的关系型数据查询语言:<br>SQL</p>
<p>这里还值得一提的一个本地数据库：<br>SQLite</p>
<p>详细的MYSQL和SQLite对比参考:<br><a target="_blank" rel="noopener" href="https://blog.csdn.net/zbw1185/article/details/47975965">SQLite和MySQL数据库的区别与应用</a></p>
<h4 id="SQLite"><a href="#SQLite" class="headerlink" title="SQLite"></a>SQLite</h4><p><a href="http://tonytang1990.github.io/2019/05/20/SQLite%E5%AD%A6%E4%B9%A0/">SQLite学习详情参考</a></p>
<h3 id="非关系型数据库"><a href="#非关系型数据库" class="headerlink" title="非关系型数据库"></a>非关系型数据库</h3><p><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/NoSQL">NoSQL是对不同于传统的关系数据库的数据库管理系统的统称。两者存在许多显著的不同点，其中最重要的是NoSQL不使用SQL作为查询语言。其数据存储可以不需要固定的表格模式，也经常会避免使用SQL的JOIN操作，一般有水平可扩展性的特征。</a></p>
<p>看了上面Wiki的介绍，本人其实还是一知半解，等待后续深入学习理解非关系型数据库。</p>
<p>有了关系型数据库为什么还需要非关系型数据库了？<br><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/NoSQL">当代典型的关系数据库在一些数据敏感的应用中表现了糟糕的性能，例如为巨量文档创建索引、高流量网站的网页服务，以及发送流式媒体。关系型数据库的典型实现主要被调整用于执行规模小而读写频繁，或者大批量极少写访问的事务。NoSQL的结构通常提供弱一致性的保证，如最终一致性，或交易仅限于单个的数据项。不过，有些系统，提供完整的ACID保证在某些情况​​下，增加了补充中间件层（例如：CloudTPS）</a></p>
<p>典型的菲关系型数据库:<br>MongoDB，Redis</p>
<h3 id="数据库选择"><a href="#数据库选择" class="headerlink" title="数据库选择"></a>数据库选择</h3><p><a target="_blank" rel="noopener" href="https://gameinstitute.qq.com/community/detail/102605">关系数据库还是NoSQL数据库</a><br><a target="_blank" rel="noopener" href="http://www.cppblog.com/sunicdavy/archive/2015/06/19/210992.html">数据库选择历程</a><br><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1197215">游戏服务器存储系统设计</a><br>本人对数据库的经验还停留在学校学习SQL的时候，也可以理解成使用过一点关系型数据库。<br>这里是想深入理解关系和非关系之间的区别，同时为选择游戏开发时使用的数据库类型做知识储备。以下理解的不对的地方，忘指出。</p>
<p>结合上面两篇文章的学习理解，个人理解关系型数据库(e.g. MySQL)适用于读写不频繁(面向表级别的锁定)，需要强大的查询(SQL)功能。<br>而非关系型数据库(e.g. Redis)适用于频繁读写(性能要求高 – Redis是Ke-Vlaue结构，且面向内存的存储模型(使用RDB和AOF做持久化))，需要高扩展性。</p>
<p>结合网上的学习理解，使用Redis(做内存Cache)+MySQL(做稳定的数据库存储查询)利用各自优势使用在不同模块来实现高性能的服务器存储设计是比较高效合理的。</p>
<p>这里本人出于学习目的，暂定以关系型数据库(<strong>MySQL</strong>)作为服务器数据库存储介质，暂时不考虑Redis。</p>
<p>出于单机游戏数据库存储学习，暂时以关系型数据库(<strong>SQLite</strong>)作为本地数据库存储介质。</p>
<p>后期Redis进阶学习:<br><a target="_blank" rel="noopener" href="https://www.runoob.com/redis/redis-tutorial.html">Redis 教程</a></p>
<h2 id="消息通信"><a href="#消息通信" class="headerlink" title="消息通信"></a>消息通信</h2><p>消息通信是本篇文章的重点，首先让我们理一理实现消息通信前我们需要做些什么？</p>
<ol>
<li>联网方式(选择通信协议，比如: TCP || UPD)</li>
<li>数据格式定义(会影响数据编码和解析，比如: Protobuf)</li>
<li>数据收发(涉及到网络通信监听，比如: Socket编程)</li>
<li>数据解析(涉及到二进制数据写入和读取，一般来说都不会明文传输)</li>
</ol>
<p>一般来说消息通信的流程如下：</p>
<ol>
<li>服务器启动了网络监听(比如通过Socket监听固定端口等待客户端连接)</li>
<li>客户端通过Socket连接服务器端口</li>
<li>指定前后端消息协议(Protobuf)，基于协议封装消息数据</li>
<li>客户端通过封装二进制消息数据通过Socket传递给服务器</li>
<li>服务器接受到二进制数据通过对应方式解析消息后返回客户端消息</li>
<li>客户端做出对应表现</li>
</ol>
<h3 id="联网方式"><a href="#联网方式" class="headerlink" title="联网方式"></a>联网方式</h3><p>了解联网方式之前，我们需要知道一些相关的网络知识。</p>
<p>以前学计算机网络课程时，印象最深的就是网络的OSI七层分类：</p>
<p><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/OSI%E6%A8%A1%E5%9E%8B">OSI模型</a></p>
<p>这里我们主要关注的是以下两层：</p>
<ol>
<li><p>会话层</p>
<p> <a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/OSI%E6%A8%A1%E5%9E%8B">负责在数据传输中设置和维护计算机网络中两台计算机之间的通信连接。</a>这一层是负责网络连接的，比如我们通过Socket启动端口监听</p>
</li>
<li><p>传输层</p>
<p><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/OSI%E6%A8%A1%E5%9E%8B">把传输表头（TH）加至数据以形成数据包。传输表头包含了所使用的协议等发送信息。例如:传输控制协议（TCP）等。</a>这一层负责添加网络协议相关信息，比如根据不同网络协议(TCP or UDP)用不同的方式处理丢包问题</p>
</li>
</ol>
<p>更详细的网络相关知识介绍参考:</p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/24860273">TCP和UDP的区别</a></p>
<p>这里我们只要知道<strong>TCP(Transmission Control Protocol，传输控制协议)<strong>协议是</strong>面向连接的可靠传输协议</strong>，有三次握手过程。而<strong>UDP(User Data Protocol，用户数据报协议)<strong>协议是</strong>无连接不可靠协议</strong>。</p>
<p>传输协议选择？<br>TCP<br>理由：</p>
<ol>
<li>游戏对网络数据准确性要求较高</li>
</ol>
<h3 id="数据格式定义"><a href="#数据格式定义" class="headerlink" title="数据格式定义"></a>数据格式定义</h3><p>这里的数据格式指的是网络消息数据格式定义。</p>
<p>在完成了客户端和服务器基础网络数据传输能力(TPC)后，我们必须定义一个统一的消息定义(即数据格式)和消息处理的方式，这样客户端和服务器端才能正常的解析网络数据。</p>
<p>数据格式需求：</p>
<ol>
<li>知道数据大小</li>
<li>知道数据类型</li>
<li>知道如何序列化和反序列化数据</li>
</ol>
<p>基础的数据格式定义如下:</p>
<ol>
<li>数据长度(short - 2字节) – 用于存储消息数据长度</li>
<li>消息ID(short - 2字节) – 用于区分消息类型</li>
<li>二进制数据(Protobuf) – 用于序列化和反序列化数据</li>
</ol>
<h3 id="数据收发"><a href="#数据收发" class="headerlink" title="数据收发"></a>数据收发</h3><p>有了TCP网络数据传输的能力后，我们还需要网络通信的能力。<br>网路通信方式选择？<br>Socket</p>
<h3 id="数据解析"><a href="#数据解析" class="headerlink" title="数据解析"></a>数据解析</h3><p>数据的解析就是前面提到的数据序列化和反序列化的能力。</p>
<p>数据解析协议选择？<br>Protobuf<br>理由：</p>
<ol>
<li>强大的生态圈，多语言支持，数据前后兼容性，强大序列化反序列化能力等</li>
</ol>
<h2 id="服务器验证"><a href="#服务器验证" class="headerlink" title="服务器验证"></a>服务器验证</h2><p>为什么需要验证？</p>
<p>单机游戏不联网很容易有外挂的一个原因就是本地数据(本地存储或者只存在内存中)很容易被串改且无法验证正确性，比如通过修改内存数据(e.g. 数值挂)，修改游戏运行速度(e.g. 加速挂)</p>
<p>解决这一问题的关键正式服务器验证，把所有的数据都存储在服务器上，所有的数据修改都必须通过服务器校验才能通过，这样一来客户端伪造数据就能被识别出来从而防止部分外挂。</p>
<p>服务器验证的应用场景？</p>
<p>服务器验证有一点很重要的应用就是服务器运行战斗逻辑，确保所有客户端结果一致性。</p>
<p>这一点涉及到前后端同步框架相关的知识，详情参考:</p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/36884005">两种同步模式：状态同步和帧同步</a></p>
<p>这里直接借用博客里的一些定义来加深基础理解：</p>
<p>什么是同步？</p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/36884005">所谓同步，就是要多个客户端表现效果是一致，数据是一致。</a></p>
<p>什么是状态同步？</p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/36884005">状态同步下，客户端更像是一个服务端数据的表现层。</a>以服务器通知为准。</p>
<p>什么是帧同步？</p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/36884005">帧同步下，通信就比较简单了，服务端只转发操作，不做任何逻辑处理。</a></p>
<p><img src="/img/Network/FrameSync.png" alt="FrameSync"></p>
<p>状态同步和帧同步的区别？</p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/36884005">最大的区别就是战斗核心逻辑写在哪，状态同步的战斗逻辑在服务端，帧同步的战斗逻辑在客户端。</a></p>
<p>这里只是简单的引用上面博主的部分说明来加深理解，更深入学习请参考前面给出的博客链接。</p>
<h1 id="服务器从零开发"><a href="#服务器从零开发" class="headerlink" title="服务器从零开发"></a>服务器从零开发</h1><p>前面是对于服务器相关理论知识的一些基础知识的学习实战。接下来为了真正做到开发一个可用的服务器，接下来打算从零开发搭建一个可用的服务器用于个人独立游戏(最重要的目的是从中学习到服务器相关的知识以及用到自己的游戏中来)。</p>
<h2 id="服务器语言选择"><a href="#服务器语言选择" class="headerlink" title="服务器语言选择"></a>服务器语言选择</h2><p>作为一个服务器知识几乎为零的前端小白(用到过的语言为C#,C++,Lua,Python,Java–其中C#和Lua是现在用的最多的)，打算入门服务器开发(主要用于个人游戏开发)，所以在语言选择上主要是希望易上手，性能也还行。在高并发方面要求不高。</p>
<p>对于相对熟悉C#和Lua的博主来说能使用**C#**开发服务器的是比较合适的。</p>
<p>未来的语言学习要针对开发的游戏类型对服务器的性能要求等来分析再做具体选型。</p>
<p>结合网上的资料，了解到:</p>
<p><a target="_blank" rel="noopener" href="https://www.codenong.com/cs106973892/">11种服务器编程语言对比（附游戏服务器框架） 2020.06</a></p>
<h2 id="服务器开源框架"><a href="#服务器开源框架" class="headerlink" title="服务器开源框架"></a>服务器开源框架</h2><p>选择一个好的开源框架作为服务器开发入门来说是必不可少的，这里了解基于C#的服务器框架比较少，有一个ET的服务器框架比较出名，但ET看起来过于庞大，入门起来可能比较难，所以这里暂时没有考虑。</p>
<p>未来的学习方向可能不限语言，不一定是ET也可能是别的语言的服务器框架。</p>
<p>现阶段打算先从0开始打通服务器和客户端的流程，所以打断用C#自己写一套简易版的服务器来熟悉整个服务器开发。</p>
<h2 id="网络通信"><a href="#网络通信" class="headerlink" title="网络通信"></a>网络通信</h2><p>网络通信是指通过网络进行数据传输处理的能力。为了实现网络通信，我们需要借助于TCP( or UDP or **)协议进行数据传输，借助Socket进行端口监听，从而实现网络通信的能力。</p>
<p>联网方式选择？<br>TCP协议 + Socket<br>理由：</p>
<ol>
<li>游戏开发对网络稳定性要求较高，所以选择以TCP作为网络传输协议。</li>
</ol>
<p>数据格式定义选择？<br>Protobuf<br>理由：</p>
<ol>
<li>强大的生态圈，多语言支持，数据前后兼容性，强大序列化反序列化能力等</li>
</ol>
<p>前后端通信模式选择？<br>帧同步<br>理由：</p>
<ol>
<li>现阶段只是为了实现前后端的通信能力，只是希望后端提供消息处理和数据存储的功能，暂时不考虑反外挂，服务器验证等问题，所以选择更适合以后端转发通知的CS模式的帧同步。</li>
</ol>
<h3 id="联网通信实现"><a href="#联网通信实现" class="headerlink" title="联网通信实现"></a>联网通信实现</h3><h4 id="二进制抽象类"><a href="#二进制抽象类" class="headerlink" title="二进制抽象类"></a>二进制抽象类</h4><p>联网通信免不了对二进制数据的写入，所以在实现TPC和Socket网络连接传输消息之前，我们需要实现一个对二进制数据进行读取和写入工具类实现。</p>
<p>以下代码参考至:<br><a target="_blank" rel="noopener" href="https://blog.csdn.net/linshuhe1/article/details/51386559">Unity3D —— Socket通信(C#)</a></p>
<p>ByteBufferWriter.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             ByteBufferWriter.cs</span></span><br><span class="line"><span class="comment"> * Author:                  TONYTANG</span></span><br><span class="line"><span class="comment"> * Create Date:             2019/07/14</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Net</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> ByteBufferWriter.cs</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 二进制写入抽象类</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ByteBufferWriter</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// Note:</span></span><br><span class="line">        <span class="comment">// 注意大小端问题</span></span><br><span class="line">        <span class="comment">// BinaryWriter和BinaryReader都是小端读写</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 内存写入类</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">private</span> MemoryStream mMemoryStream;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 二进制流写入类</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">private</span> BinaryWriter mBinaryWriter;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">ByteBufferWriter</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            mMemoryStream = <span class="keyword">new</span> MemoryStream();</span><br><span class="line">            mBinaryWriter = <span class="keyword">new</span> BinaryWriter(mMemoryStream);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">ByteBufferWriter</span>(<span class="params"><span class="built_in">byte</span>[] data</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(data != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                mMemoryStream = <span class="keyword">new</span> MemoryStream(data);</span><br><span class="line">                mBinaryWriter = <span class="keyword">new</span> BinaryWriter(mMemoryStream);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                mMemoryStream = <span class="keyword">new</span> MemoryStream();</span><br><span class="line">                mBinaryWriter = <span class="keyword">new</span> BinaryWriter(mMemoryStream);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 关闭二进制读取写入</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Close</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            mBinaryWriter.Close();</span><br><span class="line">            mMemoryStream.Close();</span><br><span class="line">            mBinaryWriter = <span class="literal">null</span>;</span><br><span class="line">            mMemoryStream = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 写入一个字节数据</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;v&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">WriteByte</span>(<span class="params"><span class="built_in">byte</span> v</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            mBinaryWriter.Write(v);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ******</span><br><span class="line">        </span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 获取字节数据</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="built_in">byte</span>[] <span class="title">ToBytes</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            mBinaryWriter.Flush();</span><br><span class="line">            <span class="keyword">return</span> mMemoryStream.ToArray();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 写入数据</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Flush</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            mBinaryWriter.Flush();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ByteBufferReader.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             ByteBufferReader.cs</span></span><br><span class="line"><span class="comment"> * Author:                  TONYTANG</span></span><br><span class="line"><span class="comment"> * Create Date:             2019/07/14</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Net</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> ByteBufferReader.cs</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 二进制读取抽象类</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ByteBufferReader</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// Note:</span></span><br><span class="line">        <span class="comment">// 注意大小端问题</span></span><br><span class="line">        <span class="comment">// BinaryWriter和BinaryReader都是小端读写</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 内存写入类</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">private</span> MemoryStream mMemoryStream;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 二进制流读取类</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">private</span> BinaryReader mBinaryReader;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">ByteBufferReader</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            mMemoryStream = <span class="keyword">new</span> MemoryStream();</span><br><span class="line">            mBinaryReader = <span class="keyword">new</span> BinaryReader(mMemoryStream);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">ByteBufferReader</span>(<span class="params"><span class="built_in">byte</span>[] data</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(data != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                mMemoryStream = <span class="keyword">new</span> MemoryStream(data);</span><br><span class="line">                mBinaryReader = <span class="keyword">new</span> BinaryReader(mMemoryStream);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                mMemoryStream = <span class="keyword">new</span> MemoryStream();</span><br><span class="line">                mBinaryReader = <span class="keyword">new</span> BinaryReader(mMemoryStream);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 关闭二进制读取写入</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Close</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            mBinaryReader.Close();</span><br><span class="line">            mMemoryStream.Close();</span><br><span class="line">            mBinaryReader = <span class="literal">null</span>;</span><br><span class="line">            mMemoryStream = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 读取一个字节数据</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="built_in">byte</span> <span class="title">ReadByte</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> mBinaryReader.ReadByte();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ******</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试用例:<br>NetMessage.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Net</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 网络消息抽象类</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">NetMessage</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 消息ID</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">ushort</span> MessageID</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span>;</span><br><span class="line">            <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 消息二进制数据</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">byte</span>[] MessageData</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span>;</span><br><span class="line">            <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 消息长度</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">ushort</span> MessageLength</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span>;</span><br><span class="line">            <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="title">NetMessage</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">NetMessage</span>(<span class="params"><span class="built_in">ushort</span> messageid, <span class="built_in">byte</span>[] messagedata</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            MessageID = messageid;</span><br><span class="line">            MessageData = messagedata;</span><br><span class="line">            MessageLength = (<span class="built_in">ushort</span>)messagedata.Length;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">NetMessage msg = <span class="keyword">new</span> NetMessage(<span class="number">1</span>, Encoding.UTF8.GetBytes(<span class="string">&quot;我是消息内容&quot;</span>));</span><br><span class="line">ByteBufferWriter bbw = <span class="keyword">new</span> ByteBufferWriter();</span><br><span class="line">bbw.WriteShort(msg.MessageLength);</span><br><span class="line">bbw.WriteShort(msg.MessageID);</span><br><span class="line">bbw.WriteBytes(msg.MessageData);</span><br><span class="line"><span class="keyword">var</span> bytesdata = bbw.ToBytes();</span><br><span class="line">bbw.Close();</span><br><span class="line">ByteBufferReader bbb = <span class="keyword">new</span> ByteBufferReader(bytesdata);</span><br><span class="line"><span class="keyword">var</span> msglength = bbb.ReadShort();</span><br><span class="line"><span class="keyword">var</span> msgid = bbb.ReadShort();</span><br><span class="line"><span class="keyword">var</span> msgcontent = bbb.ReadBytes(msglength);</span><br><span class="line">Debug.Log(<span class="string">&quot;msglength = &quot;</span> + msglength);</span><br><span class="line">Debug.Log(<span class="string">&quot;msgid = &quot;</span> + msgid);</span><br><span class="line">Debug.Log(<span class="string">&quot;MessageContent = &quot;</span> + Encoding.UTF8.GetString(msgcontent));</span><br></pre></td></tr></table></figure>

<p>输出:<br><img src="/img/Network/ByteBufferOutput.png" alt="ByteBufferOutput"></p>
<p>注意问题：</p>
<ol>
<li>大小端问题(前后端写入和读取字节的大小端方式必须一致)</li>
</ol>
<p>大小端知识:<br><a target="_blank" rel="noopener" href="http://www.ruanyifeng.com/blog/2016/11/byte-order.html">理解字节序</a><br><a target="_blank" rel="noopener" href="http://blog.zhaojie.me/2010/02/byte-order-and-related-library.html">浅谈字节序（Byte Order）及其相关操作</a></p>
<h4 id="网络通信-1"><a href="#网络通信-1" class="headerlink" title="网络通信"></a>网络通信</h4><p>TCP + Socket<br>流程：</p>
<ol>
<li>启动服务器端套接字监听等待客户端连接</li>
<li>服务器端启动线程监听客户端消息</li>
<li>启动客户端套接字连接服务器套接字端口</li>
<li>客户端启动消息发送线程等待向服务器发送客户端消息</li>
<li>服务器端接受并返回客户端消息</li>
<li>客户端处理服务器端消息</li>
</ol>
<p>NetConnector.cs(网络连接抽象类)</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 网络连接抽象类</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">NetConnector</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> IP地址</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> IpAddress</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 端口号</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> Port</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 网络套接字</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> Socket NetSocket</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 是否连接成功</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">bool</span> IsConnected</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> IP地址</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> IPAddress IP</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> IP以及端口地址</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> IPEndPoint IPEndPoint</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">NetConnector</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        NetSocket = <span class="keyword">new</span> Socket(AddressFamily.InterNetwork, SocketType.Stream, ProtocolType.Tcp);</span><br><span class="line">        IsConnected = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">NetConnector</span>(<span class="params">ProtocolType protocoltype = ProtocolType.Tcp</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        NetSocket = <span class="keyword">new</span> Socket(AddressFamily.InterNetwork, SocketType.Stream, protocoltype);</span><br><span class="line">        IsConnected = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 监听指定ip和端口地址</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;ipaddress&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;port&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ListenTo</span>(<span class="params"><span class="built_in">string</span> ipaddress, <span class="built_in">int</span> port</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        IpAddress = ipaddress;</span><br><span class="line">        Port = port;</span><br><span class="line">        IP = IPAddress.Parse(IpAddress);</span><br><span class="line">        IPEndPoint = <span class="keyword">new</span> IPEndPoint(IP, Port);</span><br><span class="line">        NetSocket.Bind(IPEndPoint);</span><br><span class="line">        NetSocket.Listen((<span class="built_in">int</span>)SocketOptionName.MaxConnections);</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;启动监听&#123;0&#125;成功&quot;</span>, NetSocket.LocalEndPoint.ToString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 连接指定地址</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;ipaddress&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;port&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">ConnectTo</span>(<span class="params"><span class="built_in">string</span> ipaddress, <span class="built_in">int</span> port</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        IpAddress = ipaddress;</span><br><span class="line">        Port = port;</span><br><span class="line">        IP = IPAddress.Parse(IpAddress);</span><br><span class="line">        IPEndPoint = <span class="keyword">new</span> IPEndPoint(IP, Port);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 连接指定地址</span></span><br><span class="line">            NetSocket.Connect(IPEndPoint);</span><br><span class="line">            IsConnected = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span></span><br><span class="line">        &#123;</span><br><span class="line">            IsConnected = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> IsConnected;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 断开连接</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Close</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        IsConnected = <span class="literal">false</span>;</span><br><span class="line">        NetSocket.Shutdown(SocketShutdown.Both);</span><br><span class="line">        NetSocket.Close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>NetServer.cs(网络服务器抽象类)</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 网络服务器抽象类</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">NetServer</span> : <span class="title">SingletonTemplate</span>&lt;<span class="title">NetServer</span>&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 服务器是否启动</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">bool</span> IsServerStart</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 网络连接器</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> NetConnector mNetConnector;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 限定长度的客户端消息接受二进制数组</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">byte</span>[] ClientMsg = <span class="keyword">new</span> <span class="built_in">byte</span>[<span class="number">1024</span> * <span class="number">1024</span>];</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">NetServer</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mNetConnector = <span class="keyword">new</span> NetConnector();</span><br><span class="line">        IsServerStart = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">NetServer</span>(<span class="params">ProtocolType protocoltype = ProtocolType.Tcp</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        mNetConnector = <span class="keyword">new</span> NetConnector(protocoltype);</span><br><span class="line">        IsServerStart = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 启动服务器端口监听</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">StartServer</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(IsServerStart == <span class="literal">false</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 启动服务器端口监听以及等待客户端连接线程</span></span><br><span class="line">            IsServerStart = <span class="literal">true</span>;</span><br><span class="line">            mNetConnector.ListenTo(<span class="string">&quot;192.168.1.3&quot;</span>, <span class="number">8888</span>);</span><br><span class="line">            Thread clientconnectthread = <span class="keyword">new</span> Thread(ClientConnectListener);</span><br><span class="line">            clientconnectthread.Start();                </span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;服务器端已启动!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 发送消息到客户端</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;msg&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SendMessage</span>(<span class="params">NetMessage msg</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//clientsocket.Send(WriteMessage(msg));</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 客户端连接请求监听线程</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ClientConnectListener</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">while</span>(<span class="literal">true</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 检查是否有客户端连接(阻塞的)</span></span><br><span class="line">            Socket clientsocket = mNetConnector.NetSocket.Accept();</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;客户端&#123;0&#125;成功连接&quot;</span>, clientsocket.RemoteEndPoint.ToString());</span><br><span class="line">            <span class="comment">// 想客户端发送连接成功数据(这里的二进制数据可以换成Protobuf序列化的)</span></span><br><span class="line">            NetMessage netmsg = <span class="keyword">new</span> NetMessage(<span class="number">1</span>, Encoding.UTF8.GetBytes(<span class="string">&quot;连接成功!&quot;</span>));</span><br><span class="line">            clientsocket.Send(WriteMessage(netmsg));</span><br><span class="line">            <span class="comment">// 为连接的客户端创建接受消息的线程</span></span><br><span class="line">            Thread resmsgthread = <span class="keyword">new</span> Thread(ReceiveMessage);</span><br><span class="line">            resmsgthread.Start(clientsocket);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 写入网络传输所需数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 1. 数据长度(short - 2字节) -- 用于存储消息数据长度</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 2. 消息ID(short - 2字节) -- 用于区分消息类型</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 3. 二进制数据(Protobuf) -- 用于序列化和反序列化数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;netmsg&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="built_in">byte</span>[] <span class="title">WriteMessage</span>(<span class="params">NetMessage netmsg</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        ByteBufferWriter bbw = <span class="keyword">new</span> ByteBufferWriter();</span><br><span class="line">        bbw.WriteShort(netmsg.MessageLength);</span><br><span class="line">        bbw.WriteShort(netmsg.MessageID);</span><br><span class="line">        bbw.WriteBytes(netmsg.MessageData);</span><br><span class="line">        bbw.Flush();</span><br><span class="line">        <span class="keyword">var</span> bytesdata = bbw.ToBytes();</span><br><span class="line">        bbw.Close();</span><br><span class="line">        <span class="keyword">return</span> bytesdata;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 接受客户端消息</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;clientsocket&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ReceiveMessage</span>(<span class="params"><span class="built_in">object</span> clientsocket</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Socket cltsocket = (Socket)clientsocket;</span><br><span class="line">        <span class="keyword">while</span>(<span class="literal">true</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">int</span> receivenumber = cltsocket.Receive(ClientMsg);</span><br><span class="line">                <span class="keyword">if</span>(receivenumber == <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    Console.WriteLine(<span class="string">&quot;客户端 : &#123;0&#125;断开了连接!&quot;</span>, cltsocket.RemoteEndPoint.ToString());</span><br><span class="line">                    cltsocket.Shutdown(SocketShutdown.Both);</span><br><span class="line">                    cltsocket.Close();</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    Console.WriteLine(<span class="built_in">string</span>.Format(<span class="string">&quot;接收客户端&#123;0&#125;消息， 长度为&#123;1&#125;&quot;</span>, cltsocket.RemoteEndPoint.ToString(), receivenumber));</span><br><span class="line">                    ByteBufferReader bbr = <span class="keyword">new</span> ByteBufferReader(ClientMsg);</span><br><span class="line">                    <span class="comment">// 消息数据长度</span></span><br><span class="line">                    <span class="built_in">int</span> msglen = bbr.ReadShort();</span><br><span class="line">                    <span class="comment">// 消息id</span></span><br><span class="line">                    <span class="built_in">int</span> msgid = bbr.ReadShort();</span><br><span class="line">                    <span class="comment">// 数据二进制内容</span></span><br><span class="line">                    <span class="built_in">byte</span>[] msgdata = bbr.ReadBytes(msglen);</span><br><span class="line">                    <span class="keyword">var</span> msgcontent = Encoding.UTF8.GetString(msgdata);</span><br><span class="line">                    Console.WriteLine(<span class="built_in">string</span>.Format(<span class="string">&quot;消息数据长度 : &#123;0&#125; 消息ID : &#123;1&#125; 消息数据内容：&#123;2&#125;&quot;</span>, msglen, msgid, msgcontent));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (Exception ex)</span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine(ex.Message);</span><br><span class="line">                cltsocket.Shutdown(SocketShutdown.Both);</span><br><span class="line">                cltsocket.Close();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>NetClient.cs(网络客户端抽象)</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> NetClient.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 网络客户端抽象</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">NetClient</span> : <span class="title">SingletonTemplate</span>&lt;<span class="title">NetClient</span>&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 服务器端的二进制数据缓存区</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">byte</span>[] ServerMsg = <span class="keyword">new</span> <span class="built_in">byte</span>[<span class="number">1024</span> * <span class="number">1024</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 客户端网络连接器</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> NetConnector mNetConnector;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 是否已连接服务器</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">bool</span> IsServerConnected</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> mNetConnector.IsConnected;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 消息接受线程</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> Thread mMsgReceiveThread;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">NetClient</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mNetConnector = <span class="keyword">new</span> NetConnector();</span><br><span class="line">        mMsgReceiveThread = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">NetClient</span>(<span class="params">ProtocolType protocoltype = ProtocolType.Tcp</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        mNetConnector = <span class="keyword">new</span> NetConnector(protocoltype);</span><br><span class="line">        mMsgReceiveThread = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 连接服务器</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;ip&quot;&gt;</span>ip地址<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;port&quot;&gt;</span>端口号<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ConnectToServer</span>(<span class="params"><span class="built_in">string</span> ipaddress, <span class="built_in">int</span> port</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(IsServerConnected)</span><br><span class="line">        &#123;</span><br><span class="line">            mNetConnector.Close();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 连接服务器</span></span><br><span class="line">            mNetConnector.ConnectTo(ipaddress, port);</span><br><span class="line">            Debug.Log(<span class="built_in">string</span>.Format(<span class="string">&quot;连接服务器:&#123;0&#125;成功!&quot;</span>, mNetConnector.IPEndPoint.ToString()));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span></span><br><span class="line">        &#123;</span><br><span class="line">            Debug.Log(<span class="built_in">string</span>.Format(<span class="string">&quot;连接服务器:&#123;0&#125;失败!&quot;</span>, mNetConnector.IPEndPoint.ToString()));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (IsServerConnected)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 启动客户端线程去监听接受服务器消息</span></span><br><span class="line">            mMsgReceiveThread = <span class="keyword">new</span> Thread(ReceiveMessage);</span><br><span class="line">            mMsgReceiveThread.Start(mNetConnector.NetSocket);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 断开连接</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Close</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (IsServerConnected)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.Log(<span class="built_in">string</span>.Format(<span class="string">&quot;断开服务器地址 : &#123;0&#125;连接!&quot;</span>, mNetConnector.NetSocket.RemoteEndPoint.ToString()));</span><br><span class="line">            mNetConnector.Close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 发送消息到服务器</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;msg&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SendMessage</span>(<span class="params">NetMessage msg</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (IsServerConnected == <span class="literal">false</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.Log(<span class="string">&quot;服务器未连接成功，无法发送数据!&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                mNetConnector.NetSocket.Send(WriteMessage(msg));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span></span><br><span class="line">            &#123;</span><br><span class="line">                mNetConnector.Close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 写入网络传输所需数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 1. 数据长度(short - 2字节) -- 用于存储消息数据长度</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 2. 消息ID(short - 2字节) -- 用于区分消息类型</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 3. 二进制数据(Protobuf) -- 用于序列化和反序列化数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;netmsg&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="built_in">byte</span>[] <span class="title">WriteMessage</span>(<span class="params">NetMessage netmsg</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        ByteBufferWriter bbw = <span class="keyword">new</span> ByteBufferWriter();</span><br><span class="line">        bbw.WriteShort(netmsg.MessageLength);</span><br><span class="line">        bbw.WriteShort(netmsg.MessageID);</span><br><span class="line">        bbw.WriteBytes(netmsg.MessageData);</span><br><span class="line">        bbw.Flush();</span><br><span class="line">        <span class="keyword">var</span> bytesdata = bbw.ToBytes();</span><br><span class="line">        bbw.Close();</span><br><span class="line">        <span class="keyword">return</span> bytesdata;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 服务器连接消息接受监听线程</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ReceiveMessage</span>(<span class="params"><span class="built_in">object</span> clientsocket</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Socket cltsocket = (Socket)clientsocket;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span>(mNetConnector.IsConnected)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">if</span>(mNetConnector.NetSocket.Available &gt; <span class="number">0</span>)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="built_in">int</span> receivenumber = cltsocket.Receive(ServerMsg);</span><br><span class="line">                        <span class="keyword">if</span> (receivenumber == <span class="number">0</span>)</span><br><span class="line">                        &#123;</span><br><span class="line">                            Debug.Log(<span class="built_in">string</span>.Format(<span class="string">&quot;服务器端 : &#123;0&#125;断开了连接!&quot;</span>, cltsocket.RemoteEndPoint.ToString()));</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">else</span></span><br><span class="line">                        &#123;</span><br><span class="line">                            ByteBufferReader bbr = <span class="keyword">new</span> ByteBufferReader(ServerMsg);</span><br><span class="line">                            <span class="keyword">var</span> msglength = bbr.ReadShort();</span><br><span class="line">                            <span class="keyword">var</span> msgid = bbr.ReadShort();</span><br><span class="line">                            <span class="keyword">var</span> msgdata = bbr.ReadBytes(msglength);</span><br><span class="line">                            <span class="built_in">string</span> msgcontent = Encoding.UTF8.GetString(msgdata);</span><br><span class="line">                            Debug.Log(<span class="built_in">string</span>.Format(<span class="string">&quot;服务器返回数据: 消息ID : &#123;0&#125; 消息长度 : &#123;1&#125; 消息内容 : &#123;2&#125;&quot;</span>, msgid, msglength, msgcontent));</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;                    </span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (Exception ex)</span><br><span class="line">            &#123;</span><br><span class="line">                Debug.Log(ex.Message);</span><br><span class="line">                mNetConnector.NetSocket.Close();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>NetMessage.cs(网络消息格式抽象)</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 网络消息抽象类</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">NetMessage</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 消息ID</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">ushort</span> MessageID</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 消息二进制数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">byte</span>[] MessageData</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 消息长度</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">ushort</span> MessageLength</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">NetMessage</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">NetMessage</span>(<span class="params"><span class="built_in">ushort</span> messageid, <span class="built_in">byte</span>[] messagedata</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        MessageID = messageid;</span><br><span class="line">        MessageData = messagedata;</span><br><span class="line">        MessageLength = (<span class="built_in">ushort</span>)messagedata.Length;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试用例:</p>
<ol>
<li>启动服务器</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NetServer.Singleton.StartServer();</span><br><span class="line">Console.ReadLine();</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>启动客户端</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NetClient.Singleton.ConnectToServer(<span class="string">&quot;192.168.1.3&quot;</span>, <span class="number">8888</span>);</span><br><span class="line">NetClient.Singleton.SendMessage(<span class="keyword">new</span> NetMessage(<span class="number">2</span>, Encoding.UTF8.GetBytes(<span class="string">&quot;测试客户端发送给服务器!&quot;</span>)));</span><br></pre></td></tr></table></figure>

<p>服务器端输出:<br><img src="/img/Network/ServerOutput.png" alt="ServerOutput"></p>
<p>客户端输出:<br><img src="/img/Network/ClientOutput.png" alt="ClientOutput"></p>
<p>可以看到通过Socket编程，我们使用TPC连接成功将消息从客户端发送到服务器以及服务器发送到客户端进行处理。NetMessage的简单封装是为了上层逻辑能区分收到的是什么消息以及消息数据有多少，基于byte[]的存储让我们可以快速的切换数据序列化和反序列化的方式(为后面使用Protobuf打下基础)。</p>
<p>待续……</p>
<h4 id="数据格式解析"><a href="#数据格式解析" class="headerlink" title="数据格式解析"></a>数据格式解析</h4><h4 id="服务器-1"><a href="#服务器-1" class="headerlink" title="服务器"></a>服务器</h4><h2 id="数据库Redis"><a href="#数据库Redis" class="headerlink" title="数据库Redis"></a>数据库Redis</h2><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><h2 id="进阶"><a href="#进阶" class="headerlink" title="进阶"></a>进阶</h2><p>对于网络框架的设计和理论知识进阶学习：<br><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/pThWX8IMtg6zuyjZ0LQajQ">教你从头写游戏服务器框架</a></p>
<h2 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h2><p><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%85%B3%E7%B3%BB%E6%95%B0%E6%8D%AE%E5%BA%93">关系数据库</a><br><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/NoSQL">NoSQL</a><br><a target="_blank" rel="noopener" href="https://gameinstitute.qq.com/community/detail/102605">关系数据库还是NoSQL数据库</a><br><a target="_blank" rel="noopener" href="http://www.cppblog.com/sunicdavy/archive/2015/06/19/210992.html">数据库选择历程</a><br><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Redis">Redis</a><br><a target="_blank" rel="noopener" href="https://www.sqlite.org/whentouse.html">SQLite</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/zbw1185/article/details/47975965">SQLite和MySQL数据库的区别与应用</a><br><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/36884005">两种同步模式：状态同步和帧同步</a><br><a target="_blank" rel="noopener" href="https://www.infoq.cn/article/a-brief-history-of-the-game-server-architecture">游戏服务器架构的演进简史</a><br><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/24860273">TCP和UDP的区别</a><br><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/OSI%E6%A8%A1%E5%9E%8B">OSI模型</a></p>
<h2 id="相关资料"><a href="#相关资料" class="headerlink" title="相关资料"></a>相关资料</h2><p><a target="_blank" rel="noopener" href="https://www.runoob.com/sql/sql-tutorial.html">SQL 教程</a><br><a target="_blank" rel="noopener" href="https://www.w3schools.com/sql/default.asp">SQL Tutorial</a></p>
<h2 id="实战讲解"><a href="#实战讲解" class="headerlink" title="实战讲解"></a>实战讲解</h2><p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/39005219">我们来用Unity做一个局域网游戏（上）</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/linshuhe1/article/details/51386559">Unity3D —— Socket通信(C#)</a><br><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/27c99677be67">Unity网络服务器搭建【中高级】</a><br><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/pThWX8IMtg6zuyjZ0LQajQ">教你从头写游戏服务器框架</a></p>
<p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1t7411E7fR?p=9">unity3d联网游戏：客户端与服务器端的交互</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/hansquirrel/IOShootGameDemo">IOShootGameDemo</a></p>
<h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><p><a target="_blank" rel="noopener" href="https://www.codenong.com/cs106973892/">11种服务器编程语言对比（附游戏服务器框架） 2020.06</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/ketoo/NoahGameFrame">NoahGameFrame</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Network/">Network</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Network/">Network</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2019/05/15/Odin插件/" title="Odin插件" itemprop="url">Odin插件</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Tony Tang" target="_blank" itemprop="author">Tony Tang</a>
		
  <p class="article-time">
    <time datetime="2019-05-15T13:33:57.000Z" itemprop="datePublished"> 发表于 2019-05-15</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>本篇文章是为了记录学习使用Unity第三方插件Odin，通过深入学习Odin，加快平时我们编写编辑器工具的效率。</p>
<h1 id="Odin"><a href="#Odin" class="headerlink" title="Odin"></a>Odin</h1><p>Odin是一款可以帮助我们快速制作友好编辑器界面的工具。</p>
<h2 id="功能特性"><a href="#功能特性" class="headerlink" title="功能特性"></a>功能特性</h2><h3 id="Serialize-Anything"><a href="#Serialize-Anything" class="headerlink" title="Serialize Anything"></a>Serialize Anything</h3><p>那么什么是序列化？<br>熟悉二进制导表工具和Proto协议数据发送解析的话，对序列化不会陌生。<br>从平时我们编写代码的角度来说序列化就是把数据对象存储成二进制(序列化)的过程，然后再通过读取二进制数据能构造出原始对象(反序列化)。</p>
<p>接下来看看Unity官方对序列化的定义：<br><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/script-Serialization.html">Serialization is the automatic process of transforming data structures or object states into a format that Unity can store and reconstruct later.</a>(序列化就是将数据结构或对象状态转换成可供Unity保存和随后重建的自动化处理过程。)</p>
<p>官方的序列化远比我们平常说的数据对象序列化更宏大:</p>
<ol>
<li>文件的保存&#x2F;读取，包括Scene、Asset、AssetBundle，以及自定义的ScriptableObject等。</li>
<li>Inspector窗口</li>
<li>编辑器重加载脚本脚本</li>
<li>Prefab</li>
<li>Instantiation<br>所有这些都是通过Unity序列化和反序列化来完成的。</li>
</ol>
<p>Unity序列化有一套规则，这里就不详细介绍了，详情查看官网:<br><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/script-Serialization.html">Script Serialization</a></p>
<p>众所周知，Unity官方序列化并非所有类型都支持，比如：Dictionary，OOP多态。<br>这些限制让我们在编写代码时受到诸多限制，而我们一般是通过特定的处理方式去支持这些缺失的特性(e.g. 通过两个List去模拟Dictionary的序列化或者通过自定义序列化去支持OOP多态)<br>详情查看:<br><a target="_blank" rel="noopener" href="https://blog.uwa4d.com/archives/2025.html">Unity插件开发基础—浅谈序列化系统</a></p>
<p>所以这里再引出Odin的一大特性：<br>Serialize Anything(所有序列化都支持(e.g. Dictionary，OOP多态问题等))<br>这一大特性就已经是相当的强大了，这也是我们采用Odin能够快速编写更加友好的编辑器界面工具的一大原因。</p>
<p>Note:<br><a target="_blank" rel="noopener" href="http://www.sirenix.net/odininspector/manual/introduction/serialize-anything">Odin’s serialization is currently supported on all platforms, save Universal Windows Platform without IL2CPP..</a></p>
<h4 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h4><p><a href="Odin%E4%BC%9A%E9%BB%98%E8%AE%A4%E7%BB%99%E6%88%91%E4%BB%AC%E6%B2%A1%E6%9C%89%E8%87%AA%E5%AE%9A%E4%B9%89Editor%E6%98%BE%E7%A4%BA%E7%9A%84%E7%B1%BB%E5%9E%8B%E6%B3%A8%E5%85%A5%E9%9D%A2%E6%9D%BF%E6%98%BE%E7%A4%BA%E3%80%82%E4%BD%86%E6%88%91%E4%BB%AC%E4%BE%9D%E7%84%B6%E8%BF%98%E6%98%AF%E9%9C%80%E8%A6%81%E6%98%BE%E7%A4%BA%E7%9A%84%E6%8C%87%E5%AE%9A%E4%BD%BF%E7%94%A8Odin%E5%BA%8F%E5%88%97%E5%8C%96%E3%80%82">While Odin by default injects itself into the inspector for every type that doesn’t already have a custom editor defined, the serialization system is more conservative than that. You always have to explicitly decide to make use of Odin’s serialization system.</a></p>
<ol>
<li>开启Odin代码Inspector</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">SerializeStudy</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Unity自身不支持序列化的Dictionary</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> Dictionary&lt;<span class="built_in">int</span>, <span class="built_in">string</span>&gt; SerializeDictionary = <span class="keyword">new</span> Dictionary&lt;<span class="built_in">int</span>, <span class="built_in">string</span>&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Unity自身支持序列化的List</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> List&lt;<span class="built_in">string</span>&gt; SerializeNormalList = <span class="keyword">new</span> List&lt;<span class="built_in">string</span>&gt;();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/img/Unity/Odin/UnityListSerializationUI.png" alt="UnityListSerializationUI"><br>可以看到默认的Dictionary是不支持序列化的，同时默认的List面板是长上面那样的。</p>
<p>接下来我们通过打开Odin序列化再来对比下区别：<br>Tools -&gt; Odin Inspector -&gt; Preference -&gt; Editor Types -&gt; User Types<br>指定我们自定义的SerializeStudy类使用Odin的序列化:<br><img src="/img/Unity/Odin/TurnOnCustomClassOdinSerialization.png" alt="TurnOnCustomClassOdinSerialization"><br>再次对比查看序列化面板:<br><img src="/img/Unity/Odin/TurnOnOdinSerializationListUI.png" alt="TurnOnOdinSerializationListUI"><br>可以看到List默认的面板显示已经变成了Odin自定义的了，但是Dictionary依然没有被序列化显示出来，因为我们只是指定了SerializeStudy类使用Odin的Inspector，但还未指定SerializeStudy使用Odin的序列化。</p>
<ol start="2">
<li>指定使用Odin序列化<br>要支持Dictionary使用Odin的序列化，我们需要显示指定(继承至SerializedMonoBehaviour or SerializedScriptableObject)使用Odin的序列化:</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">SerializeStudy</span> : <span class="title">SerializedMonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/img/Unity/Odin/OdinSerializationUI.png" alt="OdinSerializationUI"><br>可以看到我们成功的使用Odin序列化了Dictionary且采用Odin自定义的Inspector显示。</p>
<p>这里再展现一个Odin二维数组类型的序列化使用，从这个可以看出Odin的强大之处:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">SerializeStudy</span> : <span class="title">SerializedMonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Unity的自身不支持的二维数组</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">bool</span>[,] TwoDimensionArray = <span class="keyword">new</span> <span class="built_in">bool</span>[<span class="number">5</span>, <span class="number">5</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/img/Unity/Odin/OdinSerializationTwoDimensionArrayUI.png" alt="OdinSerializationTwoDimensionArrayUI"><br>可以看到一句简单的定义在Odin序列化和Odin自定义Inspector的帮助下，帮助我们快速构建和支持了Dictionary和二维数组的序列化，这对于我们构建自己的编辑器可以说是如有神助，而这正式Odin的强大之处。</p>
<p>Note:<br>关于OOP多态序列化问题，本人测试和<a target="_blank" rel="noopener" href="https://blog.uwa4d.com/archives/2025.html">Unity插件开发基础—浅谈序列化系统</a>文章里的测试结果不一致(Unity自带序列化支持多态)，本人使用的是2017.4.3f1，所以这里就不实战Odin的OOP多态功能了。</p>
<h3 id="New-Attributes"><a href="#New-Attributes" class="headerlink" title="New Attributes"></a>New Attributes</h3><p>这里的Attribute指的是C#语言里的那个标签Attribute。<br><a target="_blank" rel="noopener" href="http://www.sirenix.net/odininspector/manual/introduction/design-with-attributes">A core feature of Odin is how easy it makes it to change the appearance of your scripts in the editor - essentially letting you create powerful, complex custom editors at a whim merely by applying a few attributes to your members.</a></p>
<p>在不使用Odin前，我们一般是类通过自定义CustomEditor的形式去自定义Editor UI或者是直接通过继承EditorWindow去编写Editor UI工具，主要是通过EditorGUILayout，GUILayout一系列的类来手动完成布局和排版显示等功能。<br>使用Odin后，我们可以通过Odin提供的Attribute可以快速影响我们自定义脚本的Editor表现，帮助我们快速创建友好的可视化界面。</p>
<h4 id="实战-1"><a href="#实战-1" class="headerlink" title="实战"></a>实战</h4><ol>
<li>PropertyOrder(快速指定面板显示顺序)<br>Unity默认排序是跟Public可序列化成员变量定义的顺序挂钩的：</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">AttributeStudy</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> Second;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> First;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/img/Unity/Odin/UnitySerializationOrderUI.png" alt="UnitySerializationOrderUI"><br>通过Odin的PropertyOrder属性我们可以快速的指定排版顺序</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">AttributeStudy</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">PropertyOrder(2)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> Second;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">PropertyOrder(1)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> First;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/img/Unity/Odin/OdinPropertyOrderUI.png" alt="OdinPropertyOrderUI"><br>2. ValueDropdown属性(显示指定成员变量下拉可选值)</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">AttributeStudy</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">ValueDropdown(<span class="string">&quot;DropDownListString&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> DropDownListStringName;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;<span class="built_in">string</span>&gt; DropDownListString = <span class="keyword">new</span> List&lt;<span class="built_in">string</span>&gt;()&#123;</span><br><span class="line">        <span class="string">&quot;Tony&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Tang&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Huan&quot;</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/img/Unity/Odin/OdinValueDropDownAttributeUI.png" alt="OdinValueDropDownAttributeUI"><br>3. TabGroup属性(指定序列化显示分组)</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">AttributeStudy</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">TabGroup(<span class="string">&quot;Normal List Tab&quot;</span>)</span>]</span><br><span class="line">    [<span class="meta">PropertyOrder(2)</span>]</span><br><span class="line">    <span class="keyword">public</span> List&lt;<span class="built_in">string</span>&gt; NormalListString = <span class="keyword">new</span> List&lt;<span class="built_in">string</span>&gt;()&#123;</span><br><span class="line">        <span class="string">&quot;Tony2&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Tang2&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Huan2&quot;</span>,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">TabGroup(<span class="string">&quot;Drop Down Tab&quot;</span>)</span>]</span><br><span class="line">    [<span class="meta">PropertyOrder(1)</span>]</span><br><span class="line">    [<span class="meta">ValueDropdown(<span class="string">&quot;DropDownListString&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> DropDownListStringName;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;<span class="built_in">string</span>&gt; DropDownListString = <span class="keyword">new</span> List&lt;<span class="built_in">string</span>&gt;()&#123;</span><br><span class="line">        <span class="string">&quot;Tony1&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Tang1&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Huan1&quot;</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/img/Unity/Odin/OdinTabGroupAttributeUI.png" alt="OdinTabGroupAttributeUI"><br>4. MetaAttributes属性(e.g. ValidateInput, Required 验证序列化数据输入)</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">AttributeStudy</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">ValidateInput(<span class="string">&quot;IsGreaterThanZero&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> GreaterThanZero;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="built_in">bool</span> <span class="title">IsGreaterThanZero</span>(<span class="params"><span class="built_in">int</span> <span class="keyword">value</span></span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">value</span> &gt; <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">Required</span>]</span><br><span class="line">    <span class="keyword">public</span> GameObject RequiredValue;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/img/Unity/Odin/OdinValideInputAndRequiredAttributeUI.png" alt="OdinValideInputAndRequiredAttributeUI"><br>这里就不所有都一一举例了，从上面可以看出，借助于Odin的Attribute和序列化以及Ordin自定义的Inspector，可以快速帮助我们管理UI排版以及编写高效准确的UI。<br>更多Attribute详情:<br><a target="_blank" rel="noopener" href="http://www.sirenix.net/odininspector/documentation/sirenix/odininspector/assetlistattribute">Odin Attributes</a><br>Odin官方给的Demo(Assets\Plugins\Sirenix\Demos\Attributes Overview.unitypackage)</p>
<h3 id="Effortless-Integration"><a href="#Effortless-Integration" class="headerlink" title="Effortless Integration"></a>Effortless Integration</h3><p>容易集成这一特性从前面的Serialize Anything和Attribute的简单易用其实已经不言而喻了。</p>
<p>接下来主要学习Odin是如何帮助我们快速创建自定义窗口UI显示的。</p>
<ol>
<li>Odin普通编辑器窗口<br>一般来说我们要自定义窗口UI，我们会继承EditorWindow然后结合EditorGUILayout和GUILayout之类的类来定义窗口UI的显示排版以及逻辑处理。<br>基础的Odin窗口需要继承至OdinEditorWindow：</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CustomClassInfoDisplayOdinEditorWindow</span> : <span class="title">OdinEditorWindow</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CustomClass</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">int</span> Index;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> Name;</span><br><span class="line">        <span class="keyword">public</span> GameObject Go;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">MenuItem(<span class="string">&quot;/TonyTang/Tools/OdinEditorWindow/MyFirstOdinEditorWindow&quot;</span>)</span>]</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">OpenWindow</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> window = GetWindow&lt;CustomClassInfoDisplayOdinEditorWindow&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> List&lt;CustomClass&gt; CustomClassListData = <span class="keyword">new</span> List&lt;CustomClass&gt;();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>​	<img src="/img/Unity/Odin/OdinEditorWindowCustomClassInfoDisplayUI.png" alt="OdinEditorWindowCustomClassInfoDisplayUI"><br>​	可以看到借助于继承OdinEditorWindow,我们不再需要重写OnGUI之后去自己定义GUI排版显示以及数据处理，直接编写public可序列化变量就能达到快速显示UI操作交互界面。</p>
<ol start="2">
<li>Odin带菜单栏的自定义编辑器窗口<ol>
<li>带菜单栏的Odin窗口需要继承至OdinMenuEditorWindow</li>
<li>OdinMenuTree用于创建窗口菜单管理</li>
<li>OdinMenuItem用于创建自定义菜单节点(重写OnDrawMenuItem可自定义菜单节点显示)</li>
<li>自定义类结合Odin Attribute做自定义显示界面</li>
</ol>
</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Sirenix.OdinInspector;</span><br><span class="line"><span class="keyword">using</span> Sirenix.OdinInspector.Editor;</span><br><span class="line"><span class="keyword">using</span> Sirenix.Utilities;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> UnityEditor;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 自定义含菜单的Odin窗口</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CustomOdinMenuEditorWindow</span> : <span class="title">OdinMenuEditorWindow</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 自定义的OdinMenuItem类</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CustomMenuItem</span> : <span class="title">OdinMenuItem</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 自定义OdinMenuItem类的数据抽象类</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CustomMenuItemContentClass</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">public</span> <span class="built_in">int</span> Index;</span><br><span class="line">            <span class="keyword">public</span> <span class="built_in">string</span> Name;</span><br><span class="line">            <span class="keyword">public</span> GameObject Go;</span><br><span class="line">            <span class="keyword">public</span> <span class="built_in">bool</span> CheckOn;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="title">CustomMenuItemContentClass</span>(<span class="params"><span class="built_in">int</span> index, <span class="built_in">string</span> name, GameObject go, <span class="built_in">bool</span> checkon</span>)</span></span><br><span class="line">            &#123;</span><br><span class="line">                Index = index;</span><br><span class="line">                Name = name;</span><br><span class="line">                Go = go;</span><br><span class="line">                CheckOn = checkon;</span><br><span class="line">        &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">CustomMenuItem</span>(<span class="params">OdinMenuTree tree, <span class="built_in">string</span> name, IList <span class="keyword">value</span></span>) : <span class="title">base</span>(<span class="params">tree, name, <span class="keyword">value</span></span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">CustomMenuItem</span>(<span class="params">OdinMenuTree tree, <span class="built_in">string</span> name, <span class="built_in">object</span> <span class="keyword">value</span></span>) : <span class="title">base</span>(<span class="params">tree, name, <span class="keyword">value</span></span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 自定义显示界面的OdinMenuItem类</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CustomDrawMenuItem</span> : <span class="title">OdinMenuItem</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 自定义显示界面OdinMenuItem类的数据抽象类</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CustomDrawMenuItemContentClass</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//利用Odin Attribute排版显示UI</span></span><br><span class="line">            [<span class="meta">FoldoutGroup(<span class="string">&quot;自定义折叠组&quot;</span>)</span>]</span><br><span class="line">            <span class="keyword">public</span> <span class="built_in">int</span> Index;</span><br><span class="line">            [<span class="meta">FoldoutGroup(<span class="string">&quot;自定义折叠组&quot;</span>)</span>]</span><br><span class="line">            <span class="keyword">public</span> <span class="built_in">string</span> Name;</span><br><span class="line">            [<span class="meta">FoldoutGroup(<span class="string">&quot;自定义折叠组&quot;</span>)</span>]</span><br><span class="line">            <span class="keyword">public</span> GameObject Go;</span><br><span class="line">            [<span class="meta">FoldoutGroup(<span class="string">&quot;自定义折叠组&quot;</span>)</span>]</span><br><span class="line">            <span class="keyword">public</span> <span class="built_in">bool</span> CheckOn;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="title">CustomDrawMenuItemContentClass</span>(<span class="params"><span class="built_in">int</span> index, <span class="built_in">string</span> name, GameObject go, <span class="built_in">bool</span> checkon</span>)</span></span><br><span class="line">            &#123;</span><br><span class="line">                Index = index;</span><br><span class="line">                Name = name;</span><br><span class="line">                Go = go;</span><br><span class="line">                CheckOn = checkon;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 自行保存需要显示的数据</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">private</span> CustomDrawMenuItemContentClass mCustomDrawMenuData;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">CustomDrawMenuItem</span>(<span class="params">OdinMenuTree tree, <span class="built_in">string</span> name, CustomDrawMenuItemContentClass data</span>) : <span class="title">base</span>(<span class="params">tree, name, data</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            mCustomDrawMenuData = data;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">CustomDrawMenuItem</span>(<span class="params">OdinMenuTree tree, <span class="built_in">string</span> name, IList <span class="keyword">value</span></span>) : <span class="title">base</span>(<span class="params">tree, name, <span class="keyword">value</span></span>)</span></span><br><span class="line">        &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">CustomDrawMenuItem</span>(<span class="params">OdinMenuTree tree, <span class="built_in">string</span> name, <span class="built_in">object</span> <span class="keyword">value</span></span>) : <span class="title">base</span>(<span class="params">tree, name, <span class="keyword">value</span></span>)</span></span><br><span class="line">        &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 自定义MenuItem显示</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;rect&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;labelRect&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnDrawMenuItem</span>(<span class="params">Rect rect, Rect labelRect</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            labelRect.x -= <span class="number">16</span>;</span><br><span class="line">            <span class="keyword">this</span>.mCustomDrawMenuData.CheckOn = GUI.Toggle(labelRect.AlignMiddle(<span class="number">18</span>).AlignLeft(<span class="number">16</span>), <span class="keyword">this</span>.mCustomDrawMenuData.CheckOn, GUIContent.none);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">MenuItem(<span class="string">&quot;TonyTang/Tools/OdinMenuEditorWindow/CustomOdinMenuEditorWindow&quot;</span>)</span>]</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">OpenWindow</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> window = GetWindow&lt;CustomOdinMenuEditorWindow&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> OdinMenuTree <span class="title">BuildMenuTree</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> menutree = <span class="keyword">new</span> OdinMenuTree(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> custommenustyle = <span class="keyword">new</span> OdinMenuStyle</span><br><span class="line">        &#123;</span><br><span class="line">            BorderPadding = <span class="number">0f</span>,</span><br><span class="line">            AlignTriangleLeft = <span class="literal">true</span>,</span><br><span class="line">            TriangleSize = <span class="number">16f</span>,</span><br><span class="line">            TrianglePadding = <span class="number">0f</span>,</span><br><span class="line">            Offset = <span class="number">20f</span>,</span><br><span class="line">            Height = <span class="number">23</span>,</span><br><span class="line">            IconPadding = <span class="number">0f</span>,</span><br><span class="line">            BorderAlpha = <span class="number">0.323f</span></span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        menutree.DefaultMenuStyle = custommenustyle;</span><br><span class="line">        <span class="comment">//添加菜单风格控制显示菜单</span></span><br><span class="line">        menutree.AddObjectAtPath(<span class="string">&quot;菜单风格&quot;</span>, custommenustyle);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//添加MenuItem节点</span></span><br><span class="line">        <span class="keyword">var</span> custommenuitemdata = <span class="keyword">new</span> CustomMenuItem.CustomMenuItemContentClass(<span class="number">1</span>, <span class="string">&quot;CustomMenuItemContentClass&quot;</span>, <span class="literal">null</span>, <span class="literal">false</span>);</span><br><span class="line">        <span class="keyword">var</span> custommenuitemobj = <span class="keyword">new</span> CustomMenuItem(menutree, <span class="string">&quot;默认菜单子子节点名&quot;</span>, custommenuitemdata);</span><br><span class="line">        menutree.AddMenuItemAtPath(<span class="string">&quot;菜单子节点1&quot;</span>, custommenuitemobj);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> customdrawmenuitemdata = <span class="keyword">new</span> CustomDrawMenuItem.CustomDrawMenuItemContentClass(<span class="number">1</span>, <span class="string">&quot;CustomDrawMenuItemContentClass&quot;</span>, <span class="literal">null</span>, <span class="literal">false</span>);</span><br><span class="line">        <span class="keyword">var</span> customdrawmenuitemobj = <span class="keyword">new</span> CustomDrawMenuItem(menutree, <span class="string">&quot;自定义菜单子子节点名&quot;</span>, customdrawmenuitemdata);</span><br><span class="line">        menutree.AddMenuItemAtPath(<span class="string">&quot;菜单子节点2&quot;</span>, customdrawmenuitemobj);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        menutree.EnumerateTree().AddThumbnailIcons().SortMenuItemsByName();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> menutree;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/img/Unity/Odin/OdinCustomMenuStyleUI.png" alt="OdinCustomMenuStyleUI"><br>可以看到借助于Odin我们很轻松的创建定义了复杂的编辑器窗口UI显示，不再需要手动通过EditorGUILayout去编写排版，开发效率大大提升，编写出来的UI也更加美观。</p>
<p>这里就不再一一学习使用Odin相关特性，详情查询:<br><a target="_blank" rel="noopener" href="http://www.sirenix.net/odininspector/documentation/sirenix/odininspector/editor/odinmenueditorwindow">Code Reference</a><br>Odin官方给的Demo(Assets\Plugins\Sirenix\Demos\Editor Windows.unitypackage)</p>
<h3 id="Extendable"><a href="#Extendable" class="headerlink" title="Extendable"></a>Extendable</h3><p>在了解Odin的高度扩展性之前，我们需要了解Odin的Drawer机制。</p>
<p><a target="_blank" rel="noopener" href="http://sirenix.net/odininspector/manual/drawers-in-depth/understanding-drawers">The single most important part of understanding how Odin’s drawing system works, is understanding the <em>drawing chain</em>. In Odin, any single property is not drawn by a single drawer; instead each property has many drawers assigned to it. </a></p>
<p>从上面可以看到，理解Odin drawing system工作机制，我们需要了解Odin的drawing chain(绘制链)。在Odin里每一个显示在面板的Property(这里的Property不等价于C#里的Property)都不是单一一个drawer绘制出来的而是许多个drawers的连续绘制的结果。</p>
<p>首先Odin提供我们了一个叫ShowDrawerChain的Attibute属性，可视化的显示二楼每一个Property的绘制Drawer组合(<strong>每一个Drawer有一个优先级，优先级高的在前面</strong>)。</p>
<p><img src="/img/Unity/Odin/OdinShowDrawerChainAttribute.png" alt="OdinShowDrawerChainAttribute"></p>
<p>从上图可以看出，我们定义一个int的可序列化字段，通过Odin绘制出来需要三个Drawer:</p>
<ol>
<li>PropertyContextMenuDrawer<int> (并不做任何的绘制，只做了右键Content Menu显示的检查)</li>
<li>PrimitiveValueConflictDrawer<int> (检查值冲突(比如多选时有不一样的值类型))</li>
<li>Int32Drawer(最终负责绘制int值面板显示的Drawer)</li>
</ol>
<p>理解了Odin绘制Property是通过连续的多个Drawer组合的形式后，让我们来学习了解Odin里不同种类的Drawer是如何组成Odin的Drawer绘制机制的。</p>
<ol>
<li>Value Drawers(继承至OdinValueDrawer，优先级(0, 0, 1)，类型默认的Drawer)</li>
<li>Attribute Drawers(继承至OdinAttributeDrawer，优先级(0, 0, 1000)，Attibute绘制)</li>
<li>Attribute Value Drawers(Value Drawers和Atrribute Drawers两者的结合)</li>
<li>Group Drawers(继承至PropertyGroupAttribute，不同于前面三个Drawers，Group Drawers是负责一组Property的指定绘制方式)</li>
<li>Gemeric Drawers(泛型 – 解决显示指定Drawers类型信息的问题)</li>
</ol>
<p>这里不过多的去纠结Odin底层源代码设计和实现，只是通过了解Odin的绘制设计方式来加深对Odin使用的理解，便于应用到实际工程里去解决具体问题。</p>
<p>更多学习请参考Odin里的Demo和官方文档。</p>
<p>Note:</p>
<p><a target="_blank" rel="noopener" href="http://sirenix.net/odininspector/manual/drawers-in-depth/drawer-types">Note that all drawers in Odin are <em>always</em> strongly typed, and <em>do not allow</em> type polymorphism.</a>(Odin里的Drawer是强类型，不支持多态)</p>
<h2 id="官方使用建议"><a href="#官方使用建议" class="headerlink" title="官方使用建议"></a>官方使用建议</h2><p><a target="_blank" rel="noopener" href="http://www.sirenix.net/odininspector/manual/introduction/getting-started">Getting Started</a></p>
<h1 id="实战-2"><a href="#实战-2" class="headerlink" title="实战"></a>实战</h1><h2 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h2><ol>
<li>编写一个基于Odin的游戏模块的文档说明编辑器工具(Odin)</li>
<li>自动根据编译信息反射生成最新类型和字段信息(反射判定)</li>
<li>提供字段可编写自定义介绍的内容并存储共享(ScriptableObject存储共享)</li>
<li>提供类型，枚举搜索查看功能</li>
</ol>
<p>先上最终效果图(这里只挑个别展示，主要是学习编写过程中Odin的小知识和小技巧):</p>
<ol>
<li>模块文档整体界面<br><img src="/img/Unity/Odin/ModuleDocIntroductionUI.png" alt="ModuleDocIntroductionUI"></li>
<li>基础类型说明<br><img src="/img/Unity/Odin/ModuleDocBasicTypeIntroductionUI.png" alt="ModuleDocBasicTypeIntroductionUI"></li>
<li>Effect详情<br><img src="/img/Unity/Odin/ModuleDocEffectTypeDetailUI.png" alt="ModuleDocEffectTypeDetailUI"></li>
</ol>
<h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><p>接下来主要从三个方面来学习讲解上面文档工具通过Odin编写所需要注意的技巧和实现。</p>
<ol>
<li>Odin自定义编辑器菜单实现</li>
<li>Odin自定义类型+Odin自定义编辑器布局显示实现</li>
<li>自定义编辑器数据序列化存储</li>
</ol>
<h3 id="自定义编辑器菜单"><a href="#自定义编辑器菜单" class="headerlink" title="自定义编辑器菜单"></a>自定义编辑器菜单</h3><p>自定义菜单主要是通过继承Odin的OdinMenuEditorWindow类然后结合自定义OdinMenuTree + 自定义OdinMenuStyle来实现自定义的菜单布局加风格显示。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             GameModuleDocumentEditorWindow.cs</span></span><br><span class="line"><span class="comment"> * Author:                  TANGHUAN</span></span><br><span class="line"><span class="comment"> * Create Date:             2019/06/04</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> Sirenix.OdinInspector;</span><br><span class="line"><span class="keyword">using</span> Sirenix.OdinInspector.Editor;</span><br><span class="line"><span class="keyword">using</span> Sirenix.Utilities.Editor;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEditor;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 游戏模块文档编辑器窗口</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">GameModuleDocumentEditorWindow</span> : <span class="title">OdinMenuEditorWindow</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> OdinMenuStyle MenuStyle  = <span class="keyword">new</span> OdinMenuStyle</span><br><span class="line">    &#123;</span><br><span class="line">        BorderPadding = <span class="number">0f</span>,</span><br><span class="line">        AlignTriangleLeft = <span class="literal">true</span>,</span><br><span class="line">        TriangleSize = <span class="number">16f</span>,</span><br><span class="line">        TrianglePadding = <span class="number">0f</span>,</span><br><span class="line">        Offset = <span class="number">20f</span>,</span><br><span class="line">        Height = <span class="number">30</span>,</span><br><span class="line">        IconPadding = <span class="number">0f</span>,</span><br><span class="line">        BorderAlpha = <span class="number">0.323f</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    *******</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> OdinMenuTree <span class="title">BuildMenuTree</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        DocDataUtility.CheckAndCreateFolder(DocDataUtility.DocumentDataSaveFolderPath);</span><br><span class="line">        LoadAllData();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> menutree = <span class="keyword">new</span> OdinMenuTree(<span class="literal">true</span>);</span><br><span class="line">        menutree.DefaultMenuStyle = MenuStyle;</span><br><span class="line"></span><br><span class="line">        menutree.AddObjectAtPath(<span class="string">&quot;游戏模块文档&quot;</span>, IntroductionEditorWindowData);</span><br><span class="line">        menutree.AddObjectAtPath(<span class="string">&quot;游戏模块文档/模块菜单&quot;</span>, <span class="literal">null</span>);</span><br><span class="line">        menutree.AddObjectAtPath(<span class="string">&quot;游戏模块文档/模块菜单/基础类型说明&quot;</span>, DataTypeIntroEditorWindowData);</span><br><span class="line">        menutree.AddObjectAtPath(<span class="string">&quot;游戏模块文档/模块菜单/Effect模块&quot;</span>, EffectModuleIntroEditorWindowData);</span><br><span class="line">        <span class="comment">//menutree.AddObjectAtPath(&quot;游戏模块文档/模块菜单/Effect模块/Effect基础配置介绍&quot;, EffectModuleBasicConfigEditorWindowData);</span></span><br><span class="line">        menutree.AddObjectAtPath(<span class="string">&quot;游戏模块文档/模块菜单/Effect模块/Effect&quot;</span>, EffectIntroEditorWindowData);</span><br><span class="line">        menutree.AddObjectAtPath(<span class="string">&quot;游戏模块文档/模块菜单/Effect模块/Effect/Effect预览&quot;</span>, EffectPreviewEditorWindowData);</span><br><span class="line">        menutree.AddObjectAtPath(<span class="string">&quot;游戏模块文档/模块菜单/Effect模块/Effect/Effect查询&quot;</span>, EffectQueryEditorWindowData);</span><br><span class="line">        menutree.AddObjectAtPath(<span class="string">&quot;游戏模块文档/模块菜单/Effect模块/Effect/Effect详情&quot;</span>, EffectDetailEditorWindowData);</span><br><span class="line">        menutree.AddObjectAtPath(<span class="string">&quot;游戏模块文档/模块菜单/Effect模块/EffectView&quot;</span>, EffectViewIntroEditorWindowData);</span><br><span class="line">        menutree.AddObjectAtPath(<span class="string">&quot;游戏模块文档/模块菜单/Effect模块/EffectView/EffectView预览&quot;</span>, EffectViewPreviewEditorWindowData);</span><br><span class="line">        menutree.AddObjectAtPath(<span class="string">&quot;游戏模块文档/模块菜单/Effect模块/EffectView/EffectView查询&quot;</span>, EffectViewQueryEditorWindowData);</span><br><span class="line">        menutree.AddObjectAtPath(<span class="string">&quot;游戏模块文档/模块菜单/Effect模块/EffectView/EffectView详情&quot;</span>, EffectViewDetailEditorWindowData);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> menutree;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">MenuItem(<span class="string">&quot;TonyTang/Tools/GameModuleDocument/GameModuleDocumentMenuEditorWindow&quot;</span>)</span>]</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">OpenWindow</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> window = GetWindow&lt;GameModuleDocumentEditorWindow&gt;();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>代码已经很清晰了，这里就不详细说明了。<br>通过继承OdinMenuEditorWindow重写BuildMenuTree()方法，使用OdinMenuTree自定义菜单栏，配合自定义OdinMenuStyle决定惨淡显示风格。</p>
<h3 id="自定义编辑器布局"><a href="#自定义编辑器布局" class="headerlink" title="自定义编辑器布局"></a>自定义编辑器布局</h3><p>自定义编辑器布局主要是通过使用Odin的OdinEditorWindow + Odin自定义序列化类型显示 + Odin序列化标签来实现的。</p>
<p>Effect详细信息自定义窗口部分代码(工作原因，不方便放出全部代码，这里只用作学习记录分享Odin的使用):</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             EffectDetailEditorWindow.cs</span></span><br><span class="line"><span class="comment"> * Author:                  TONYTANG</span></span><br><span class="line"><span class="comment"> * Create Date:             2019/06/04</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> Sirenix.OdinInspector;</span><br><span class="line"><span class="keyword">using</span> Sirenix.OdinInspector.Editor;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Reflection;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> EffectDetailEditorWindow.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Effect详情窗口</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">TypeInfoBox(<span class="string">&quot;子类不会显示父类字段信息!要查询父类字段信息直接查询父类类型!&quot;</span>)</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">EffectDetailEditorWindow</span> : <span class="title">OdinEditorWindow</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">EffectDetailData</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> Effect参数说明数据</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">EffectDetailParamDesData</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">            <span class="comment"><span class="doctag">///</span> 参数类型信息</span></span><br><span class="line">            <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">            [<span class="meta">LabelText(<span class="string">&quot;&quot;</span>)</span>]</span><br><span class="line">            [<span class="meta">VerticalGroup(<span class="string">&quot;参数类型&quot;</span>)</span>]</span><br><span class="line">            [<span class="meta">TableColumnWidth(150, Resizable = false)</span>]</span><br><span class="line">            [<span class="meta">ReadOnly</span>]</span><br><span class="line">            <span class="keyword">public</span> <span class="built_in">string</span> ParamType;</span><br><span class="line"></span><br><span class="line">            <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">            <span class="comment"><span class="doctag">///</span> 参数名</span></span><br><span class="line">            <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">            [<span class="meta">LabelText(<span class="string">&quot;&quot;</span>)</span>]</span><br><span class="line">            [<span class="meta">VerticalGroup(<span class="string">&quot;参数名&quot;</span>)</span>]</span><br><span class="line">            [<span class="meta">TableColumnWidth(150, Resizable = false)</span>]</span><br><span class="line">            [<span class="meta">ReadOnly</span>]</span><br><span class="line">            <span class="keyword">public</span> <span class="built_in">string</span> ParamName = <span class="string">&quot;参数名&quot;</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">            <span class="comment"><span class="doctag">///</span> 参数介绍</span></span><br><span class="line">            <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span>            </span></span><br><span class="line">            [<span class="meta">LabelText(<span class="string">&quot;&quot;</span>)</span>]</span><br><span class="line">            [<span class="meta">VerticalGroup(<span class="string">&quot;参数介绍&quot;</span>)</span>]</span><br><span class="line">            [<span class="meta">TextArea</span>]</span><br><span class="line">            <span class="keyword">public</span> <span class="built_in">string</span> ParamIntro;</span><br><span class="line"></span><br><span class="line">            <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">            <span class="comment"><span class="doctag">///</span> 参数额外信息</span></span><br><span class="line">            <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">            [<span class="meta">LabelText(<span class="string">&quot;&quot;</span>)</span>]</span><br><span class="line">            [<span class="meta">VerticalGroup(<span class="string">&quot;参数额外信息&quot;</span>)</span>]</span><br><span class="line">            [<span class="meta">TextArea(3, 6)</span>]</span><br><span class="line">            <span class="keyword">public</span> <span class="built_in">string</span> ParamExtraInfo;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> Effect名</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        [<span class="meta">LabelText(<span class="string">&quot;Effect名&quot;</span>)</span>]</span><br><span class="line">        [<span class="meta">VerticalGroup(<span class="string">&quot;基础信息&quot;</span>)</span>]</span><br><span class="line">        [<span class="meta">TableColumnWidth(220, Resizable = false)</span>]</span><br><span class="line">        [<span class="meta">ReadOnly</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> EffectName;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> Effect父类名字</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        [<span class="meta">LabelText(<span class="string">&quot;父Effect名&quot;</span>)</span>]</span><br><span class="line">        [<span class="meta">VerticalGroup(<span class="string">&quot;基础信息&quot;</span>)</span>]</span><br><span class="line">        [<span class="meta">TableColumnWidth(220, Resizable = false)</span>]</span><br><span class="line">        [<span class="meta">ReadOnly</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> ParentTypeName;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> Effect参数说明数据</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        [<span class="meta">LabelText(<span class="string">&quot;&quot;</span>)</span>]</span><br><span class="line">        [<span class="meta">VerticalGroup(<span class="string">&quot;参数详细信息&quot;</span>)</span>]</span><br><span class="line">        [<span class="meta">TableList(DrawScrollView = false, IsReadOnly = true)</span>]</span><br><span class="line">        <span class="keyword">public</span> List&lt;EffectDetailParamDesData&gt; EffectParamDesDetailList = <span class="keyword">new</span> List&lt;EffectDetailParamDesData&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Effect详细数据列表</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">LabelText(<span class="string">&quot;Effect详细数据&quot;</span>)</span>]</span><br><span class="line">    [<span class="meta">TabGroup(<span class="string">&quot;Effect参数详情&quot;</span>)</span>]</span><br><span class="line">    [<span class="meta">TableList(DrawScrollView = true, MaxScrollViewHeight = 800, MinScrollViewHeight = 800, IsReadOnly = true)</span>]</span><br><span class="line">    <span class="keyword">public</span> List&lt;EffectDetailData&gt; EffectDetailDataList = <span class="keyword">new</span> List&lt;EffectDetailData&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 枚举说明数据</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">EffectEnumData</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 参数类型信息</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        [<span class="meta">LabelText(<span class="string">&quot;&quot;</span>)</span>]</span><br><span class="line">        [<span class="meta">VerticalGroup(<span class="string">&quot;枚举类型全名&quot;</span>)</span>]</span><br><span class="line">        [<span class="meta">HideInInspector</span>]</span><br><span class="line">        [<span class="meta">ReadOnly</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> QualifiedEnumType;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 参数类型信息</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        [<span class="meta">LabelText(<span class="string">&quot;&quot;</span>)</span>]</span><br><span class="line">        [<span class="meta">VerticalGroup(<span class="string">&quot;枚举名&quot;</span>)</span>]</span><br><span class="line">        [<span class="meta">ReadOnly</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> EnumType;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 枚举可选值</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        [<span class="meta">LabelText(<span class="string">&quot;&quot;</span>)</span>]</span><br><span class="line">        [<span class="meta">VerticalGroup(<span class="string">&quot;枚举可选值&quot;</span>)</span>]</span><br><span class="line">        [<span class="meta">ListDrawerSettings(HideAddButton = true, HideRemoveButton = true)</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>[] EnumValues;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 枚举值说明</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        [<span class="meta">LabelText(<span class="string">&quot;&quot;</span>)</span>]</span><br><span class="line">        [<span class="meta">VerticalGroup(<span class="string">&quot;枚举值说明&quot;</span>)</span>]</span><br><span class="line">        [<span class="meta">TextArea</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> EnumValueDecs;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 枚举详细数据列表</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">LabelText(<span class="string">&quot;枚举详细数据&quot;</span>)</span>]</span><br><span class="line">    [<span class="meta">TabGroup(<span class="string">&quot;枚举详情&quot;</span>)</span>]</span><br><span class="line">    [<span class="meta">TableList(DrawScrollView = true, MaxScrollViewHeight = 800, MinScrollViewHeight = 500, IsReadOnly = true)</span>]</span><br><span class="line">    <span class="keyword">public</span> List&lt;EffectEnumData&gt; EffectEnumDataList = <span class="keyword">new</span> List&lt;EffectEnumData&gt;();</span><br><span class="line"></span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>OdinEditorWindow实现了基于Odin的自定义编辑器入口。</li>
</ul>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">EffectDetailEditorWindow</span> : <span class="title">OdinEditorWindow</span></span><br></pre></td></tr></table></figure>
<ul>
<li>结合自定义类型 + Public类型成员定义决定自定义编辑器显示内容。</li>
</ul>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">EffectDetailData</span></span><br><span class="line">&#123;</span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> List&lt;EffectDetailData&gt; EffectDetailDataList = <span class="keyword">new</span> List&lt;EffectDetailData&gt;();</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">EffectEnumData</span></span><br><span class="line">&#123;</span><br><span class="line">    ******</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> List&lt;EffectEnumData&gt; EffectEnumDataList = <span class="keyword">new</span> List&lt;EffectEnumData&gt;();</span><br></pre></td></tr></table></figure>
<ul>
<li>自定义类型需要序列化显示的参数结合Odin序列化标签实现指定方式显示字段。</li>
</ul>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">LabelText(<span class="string">&quot;枚举详细数据&quot;</span>)</span>]</span><br><span class="line">[<span class="meta">VerticalGroup(<span class="string">&quot;枚举类型全名&quot;</span>)</span>]</span><br><span class="line">[<span class="meta">HideInInspector</span>]</span><br><span class="line">[<span class="meta">ReadOnly</span>]</span><br><span class="line">[<span class="meta">TableColumnWidth(220, Resizable = false)</span>]</span><br><span class="line">[<span class="meta">TabGroup(<span class="string">&quot;枚举详情&quot;</span>)</span>]</span><br><span class="line">[<span class="meta">TableList(DrawScrollView = true, MaxScrollViewHeight = 800, MinScrollViewHeight = 500, IsReadOnly = true)</span>]</span><br></pre></td></tr></table></figure>
<pre><code>LabelText -- 表示显示标题
VerticalGroup -- 表示显示分组
HideInInspector -- 表示不显示在编辑器上
ReadOnly -- 表示字段只读不可编辑
TableColumnWidth -- 表示字段单列显示宽度
TabGroup -- 表示标签页分组
TableList -- 表示按表格列表形式显示(DrawScrollView = true, MaxScrollViewHeight = 800, MinScrollViewHeight = 500, IsReadOnly = true -- 是TableList里的细节显示控制)
更多标签详情查看官网:
[OdinDocumentation](https://odininspector.com/documentation)
</code></pre>
<h3 id="数据序列化存储"><a href="#数据序列化存储" class="headerlink" title="数据序列化存储"></a>数据序列化存储</h3><p>数据序列化存储主要是采用Odin + Unity ScriptableObject<br>Odin的OdinEditorWindow是继承至EditorWindow，而EditorWindow是继承至ScriptableObject，所以我们直接按序列化ScriptableObject的方式序列化OdinEditorWindow即可。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 加载指定文档数据</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;typeparam name=&quot;T&quot;&gt;</span><span class="doctag">&lt;/typeparam&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;datafullpath&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> T <span class="title">LoadDocumentData</span>&lt;<span class="title">T</span>&gt;(<span class="params"><span class="built_in">string</span> datafullpath</span>) <span class="keyword">where</span> T : ScriptableObject</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span>(File.Exists(datafullpath))</span><br><span class="line">    &#123;</span><br><span class="line">        Debug.Log(<span class="built_in">string</span>.Format(<span class="string">&quot;&#123;0&#125;数据加载成功!&quot;</span>, datafullpath));</span><br><span class="line">        <span class="keyword">return</span> AssetDatabase.LoadAssetAtPath&lt;T&gt;(datafullpath);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        Debug.Log(<span class="built_in">string</span>.Format(<span class="string">&quot;&#123;0&#125;数据不存在!&quot;</span>, datafullpath));</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 存储指定文档数据</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;typeparam name=&quot;T&quot;&gt;</span><span class="doctag">&lt;/typeparam&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;documentdata&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;datafullpath&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">SaveDocumentData</span>&lt;<span class="title">T</span>&gt;(<span class="params">T documentdata, <span class="built_in">string</span> datafullpath</span>) <span class="keyword">where</span> T : ScriptableObject</span></span><br><span class="line">&#123;</span><br><span class="line">    AssetDatabase.CreateAsset(documentdata, datafullpath);</span><br><span class="line">    AssetDatabase.SaveAssets();</span><br><span class="line">    Debug.Log(<span class="built_in">string</span>.Format(<span class="string">&quot;保存资源：&#123;0&#125;完成!&quot;</span>, documentdata));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a target="_blank" rel="noopener" href="https://assetstore.unity.com/packages/tools/utilities/odin-inspector-and-serializer-89041">Odin Asset Store链接</a><br><a target="_blank" rel="noopener" href="http://sirenix.net/odininspector">Odin官网</a><br><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/script-Serialization.html">Script Serialization</a><br><a target="_blank" rel="noopener" href="https://blog.uwa4d.com/archives/2025.html">Unity插件开发基础—浅谈序列化系统</a><br><a target="_blank" rel="noopener" href="https://odininspector.com/documentation">OdinDocumentation</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Editor/">Editor</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Editor/">Editor</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2019/05/03/热更新/" title="热更新" itemprop="url">热更新</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Tony Tang" target="_blank" itemprop="author">Tony Tang</a>
		
  <p class="article-time">
    <time datetime="2019-05-03T05:30:16.000Z" itemprop="datePublished"> 发表于 2019-05-03</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>本篇文章是为了记录学习游戏开发过程中，版本强更和资源热更相关知识。</p>
<p>关于资源AssetBundle加载模块相关学习参考:<br><a href="http://tonytang1990.github.io/2016/10/13/Unity-Resource-Manager">Unity Resource Manager</a><br><a href="http://tonytang1990.github.io/2018/10/24/AssetBundle%E8%B5%84%E6%BA%90%E6%89%93%E5%8C%85%E5%8A%A0%E8%BD%BD%E7%AE%A1%E7%90%86%E5%AD%A6%E4%B9%A0/">AssetBundle资源打包加载管理</a></p>
<h1 id="热更新"><a href="#热更新" class="headerlink" title="热更新"></a>热更新</h1><p>首先还是让我们从What，Why，How三个点来学习理解热更新。</p>
<h2 id="What"><a href="#What" class="headerlink" title="What"></a>What</h2><p>什么是热更新？<br>从前端的角度来说，我个人理解热更新是指无需通过商店审核上传最新版本就能通过游戏内热更下载最新资源和代码的形式更新最新功能。</p>
<p>从服务器的角度来说，可能是无需关闭服务器，不停机状态下修复漏洞，更新资源等，重点是更新逻辑代码。</p>
<p>本人是前端程序，所以侧重点是前端热更这一块，而非服务器热更新。<br>接下来主要以以下三点来深入学习：</p>
<ol>
<li>版本强更(类似于商店下载最新版本的完整包安装更新)</li>
<li>资源热更(游戏内资源热更新下载替换本地游戏内容)</li>
<li>代码热更(游戏内代码热更新下载替换本地游戏代码内容)</li>
</ol>
<h2 id="Why"><a href="#Why" class="headerlink" title="Why"></a>Why</h2><p>为什么需要热更新？</p>
<ol>
<li>商店审核时间不可控(紧急bug严重修复时会造成阻碍)</li>
<li>手机游戏更新频繁，改善用户更新体验(不必每次都走商店版本强更)</li>
<li>快速修复bug和更新功能</li>
</ol>
<h2 id="How"><a href="#How" class="headerlink" title="How"></a>How</h2><p>接下来会针对前面提到的三点来分别讨论：<br>针对版本强更和资源热更，先来看一下我整理的流程图：<br><img src="/img/Unity/HotUpdate/HotUpdateFlowChat.png" alt="HotUpdateFlowChat"></p>
<h3 id="版本强更"><a href="#版本强更" class="headerlink" title="版本强更"></a>版本强更</h3><p>版本强更主要是游戏内通过服务器获取最新版本号判定当前游戏版本是否需要更新，然后引导用户更新(可以是引导到对应商店下载，也可以是直接游戏内直接下载安装包)最新的包。</p>
<ol>
<li>引导到对应商店下载<br>问题：<br>需要判断出用户当前下载的安装包是从哪个应用商店下载的，然后跳转到对应商店，如果玩家不是从应用商店下载或者说玩家本地没有对应应用商店，那么就会出现无法成功跳转对应应用商店的情况。<br>方案：<br>考虑到Android应用商店繁多，基于上述问题，这里我们采用第二种方案，直接引导游戏内CDN下载最新包的形式强更版本(这里指的Android，IOS官方AppStore只有一个本地肯定有AppStore，直接跳转AppStore即可)</li>
<li>游戏内直接下载(cdn下载)<br>游戏内直接下载可以通过下载对应CDN(不同渠道分不同CDN地址即可划分渠道)上的安装包覆盖安装即可。</li>
</ol>
<h4 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h4><p>Android:<br>通过查询相关资料，了解到Android APK安装在Android N(7)之前主要是通过Itent结合File的形式。<br>Android N(7)之后主要是通过FileProvider组件</p>
<p>CS层热更下载APK代码:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">string</span> testresourceurl = <span class="string">&quot;*/HotUpdate.apk&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> webrequest = UnityWebRequest.Get(testresourceurl);</span><br><span class="line"><span class="keyword">yield</span> <span class="keyword">return</span> webrequest.SendWebRequest();</span><br><span class="line"><span class="keyword">if</span> (webrequest.isNetworkError)</span><br><span class="line">&#123;</span><br><span class="line">    Debug.LogError(<span class="built_in">string</span>.Format(<span class="string">&quot;&#123;0&#125;安装包下载出错!&quot;</span>, testresourceurl));</span><br><span class="line">    Debug.LogError(webrequest.error);</span><br><span class="line">    <span class="keyword">if</span> (webrequest.isHttpError)</span><br><span class="line">    &#123;</span><br><span class="line">        Debug.LogError(<span class="built_in">string</span>.Format(<span class="string">&quot;responseCode : &quot;</span>, webrequest.responseCode));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">    Debug.Log(<span class="built_in">string</span>.Format(<span class="string">&quot;&#123;0&#125; webrequest.isDone:&#123;1&#125;!&quot;</span>, testresourceurl, webrequest.isDone));</span><br><span class="line">    Debug.Log(<span class="built_in">string</span>.Format(<span class="string">&quot;&#123;0&#125;安装包下载完成!&quot;</span>, testresourceurl));</span><br><span class="line">    <span class="keyword">var</span> downloadfilefolderpath = Application.persistentDataPath + <span class="string">&quot;/download/&quot;</span>;</span><br><span class="line">    <span class="keyword">var</span> downloadfilesavepath = downloadfilefolderpath + <span class="string">&quot;app.apk&quot;</span>;</span><br><span class="line">    Debug.Log(<span class="string">&quot;downloadfilefolderpath = &quot;</span> + downloadfilefolderpath);</span><br><span class="line">    Debug.Log(<span class="string">&quot;downloadfilesavepath = &quot;</span> + downloadfilesavepath);</span><br><span class="line">    <span class="keyword">if</span>(!Directory.Exists(downloadfilefolderpath))</span><br><span class="line">    &#123;</span><br><span class="line">        Directory.CreateDirectory(downloadfilefolderpath);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (File.Exists(downloadfilesavepath))</span><br><span class="line">    &#123;</span><br><span class="line">        File.Delete(downloadfilesavepath);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">using</span> (<span class="keyword">var</span> fs = File.Create(downloadfilesavepath))</span><br><span class="line">    &#123;</span><br><span class="line">        fs.Write(webrequest.downloadHandler.data, <span class="number">0</span>, webrequest.downloadHandler.data.Length);</span><br><span class="line">        fs.Flush();</span><br><span class="line">        fs.Close();</span><br><span class="line">        Debug.Log(downloadfilesavepath + <span class="string">&quot;文件写入完成!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>原生APK安装代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Intent</span> <span class="variable">install</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(Intent.ACTION_VIEW);</span><br><span class="line">install.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK);</span><br><span class="line"><span class="type">File</span> <span class="variable">apkFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(mContext.getExternalFilesDir(<span class="literal">null</span>).getPath() + <span class="string">&quot;/download/&quot;</span> + <span class="string">&quot;app.apk&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">Uri</span> <span class="variable">uri</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.N) &#123;</span><br><span class="line">    install.setFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION);</span><br><span class="line">    install.addFlags(Intent.FLAG_GRANT_WRITE_URI_PERMISSION);</span><br><span class="line">    install.addFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION);</span><br><span class="line">    uri = FileProvider.getUriForFile(mContext, mPackagename + <span class="string">&quot;.fileprovider&quot;</span>, apkFile);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    uri = Uri.fromFile(apkFile);</span><br><span class="line">&#125;</span><br><span class="line">install.setDataAndType(uri, <span class="string">&quot;application/vnd.android.package-archive&quot;</span>);</span><br><span class="line">startActivity(install);</span><br></pre></td></tr></table></figure>

<p>AndroidMainifest.xml定义相关FileProvider：<br>res下新建xml目录以及file_paths.xml文件<br><img src="/img/Unity/HotUpdate/AndroidHotUpdateFilePath.png" alt="AndroidHotUpdateFilePath"></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">//强更部分</span><br><span class="line"><span class="tag">&lt;<span class="name">provider</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:name</span>=<span class="string">&quot;android.support.v4.content.FileProvider&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:authorities</span>=<span class="string">&quot;应用包名.fileprovider&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:exported</span>=<span class="string">&quot;false&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:grantUriPermissions</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta-data</span></span></span><br><span class="line"><span class="tag">      <span class="attr">android:name</span>=<span class="string">&quot;android.support.FILE_PROVIDER_PATHS&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">android:resource</span>=<span class="string">&quot;@xml/file_paths&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">provider</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>配置file_paths.xml:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">resources</span>&gt;</span></span><br><span class="line">    //下载安装包目录</span><br><span class="line">    <span class="tag">&lt;<span class="name">paths</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">external-path</span></span></span><br><span class="line"><span class="tag">            <span class="attr">name</span>=<span class="string">&quot;download&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">path</span>=<span class="string">&quot;&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">external-files-path</span></span></span><br><span class="line"><span class="tag">            <span class="attr">name</span>=<span class="string">&quot;download&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">path</span>=<span class="string">&quot;&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">paths</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">resources</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>AndroidManifest.xml权限相关设置:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.WRITE_EXTERNAL_STORAGE&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.READ_EXTERNAL_STORAGE&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.REQUEST_INSTALL_PACKAGES&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p>Android相关路径定义知识:<br>以下内容来源：<br><a target="_blank" rel="noopener" href="http://yifeng.studio/2017/05/03/android-7-0-compat-fileprovider/">关于 Android 7.0 适配中 FileProvider 部分的总结</a><br><files-path>：内部存储空间应用私有目录下的 files&#x2F; 目录，等同于 Context.getFilesDir() 所获取的目录路径；</p>
<p><cache-path>：内部存储空间应用私有目录下的 cache&#x2F; 目录，等同于 Context.getCacheDir() 所获取的目录路径；</p>
<p><external-path>：外部存储空间根目录，等同于 Environment.getExternalStorageDirectory() 所获取的目录路径；</p>
<p><external-files-path>：外部存储空间应用私有目录下的 files&#x2F; 目录，等同于 Context.getExternalFilesDir(null) 所获取的目录路径；</p>
<p><external-cache-path>：外部存储空间应用私有目录下的 cache&#x2F; 目录，等同于 Context.getExternalCacheDir()；</p>
<p>最后让我们来看下运行效果：<br><img src="/img/Unity/HotUpdate/HotUpdateUIInterface.png" alt="运行界面"><br><img src="/img/Unity/HotUpdate/DownloadAPK.png" alt="下载安装包"><br><img src="/img/Unity/HotUpdate/InstallAPK.png" alt="版本强更安装"></p>
<p>注意事项：</p>
<ol>
<li>下载保存APK时需要android.permission.WRITE_EXTERNAL_STORAGE权限</li>
<li>安装APK时需要android.permission.REQUEST_INSTALL_PACKAGES和android.permission.READ_EXTERNAL_STORAGE权限</li>
<li>Android 6.0以后敏感权限需要主动请求</li>
<li><a target="_blank" rel="noopener" href="http://lazybios.com/2016/12/install-apk-by-intent-compatible-adnroid-n/">从Android 7.0开始，系统修改了安全机制: 限定应用在默认情况下只能访问自身应用数据。所以当我们想通过File对象访问其它package数据时，就需要借助于ContentProvider、FileProvider这些组件，否则会报FileUriExposedException异常。</a></li>
<li>Android下载和读取安装APK的目录需要是有可读写权限的外部存储目录(e.g. Application.persistentDataPath || Application.temporaryCachePath)</li>
</ol>
<p>IOS:<br>IOS正版只有AppStore(暂时不考虑越狱渠道)，所以IOS直接打开应用商店跳转即可。<br>IOS跳转AppStore商店的代码就简单很多了：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Application.OpenURL(<span class="string">&quot;itms-apps://itunes.apple.com/app/id&quot;</span> + appID);</span><br></pre></td></tr></table></figure>
<p>Android打开商店的代码和IOS类似:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Application.OpenURL(<span class="string">&quot;market://details?id=&quot;</span> + appID);</span><br></pre></td></tr></table></figure>
<p>Note:<br><a target="_blank" rel="noopener" href="https://blog.csdn.net/hackmind/article/details/78113511">IOS appID可以通过itunes的链接获取到，比如我们的游戏链接为:https://itunes.apple.com/app/id1238589899，1238589899 为IOS的appID</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/hackmind/article/details/78113511">google play 的ID通过商店链接获取到，比如我们的游戏链接为:https://play.google.com/store/apps/details?id=com.oasis.movten.android， com.oasis.movten.android 为 Android的appID</a></p>
<h3 id="资源热更"><a href="#资源热更" class="headerlink" title="资源热更"></a>资源热更</h3><p>资源热更是指在游戏内直接下载最新资源，然后本地游戏通过使用最新下载的资源更新到最新的游戏资源并使用。</p>
<p>资源热更下载老版本Unity提供了WWW接口，但这个接口官方已经不推荐使用了，取而代之的是UnityWebRequest(http访问资源服务器的形式)。</p>
<p>资源下载跟前面提到的版本强更APK下载是一个意思，只不过需要通过比较本地更新的资源数据和服务器上的资源数据对比出需要更新的资源列表。这里不厌其烦的再放一次版本强更和资源热更的流程图加深印象：<br><img src="/img/Unity/HotUpdate/HotUpdateFlowChat.png" alt="HotUpdateFlowChat"><br>代码这里就不贴了，感兴趣的可以直接上Git下载了解：<br><a target="_blank" rel="noopener" href="https://github.com/TonyTang1990/AssetBundleLoadManager">AssetBundleLoadManager</a></p>
<h3 id="热更新辅助工具"><a href="#热更新辅助工具" class="headerlink" title="热更新辅助工具"></a>热更新辅助工具</h3><p>Tools-&gt;HotUpdate-&gt;热更新操作工具</p>
<p><img src="/img/Unity/HotUpdate/HotUpdateToolsUI.png" alt="HotUpdateToolsUI"></p>
<p>主要分为以下4个步骤：</p>
<ol>
<li><p>版本资源文件MD5计算(文件名格式:MD5+版本号+资源版本号+平台+时间戳+.txt)</p>
<p><img src="/img/Unity/HotUpdate/AssetBundleMD5Caculation.png" alt="AssetBundleMD5Caculation"></p>
</li>
<li><p>对比两个版本的MD5文件信息得出需要热更新的AB文件信息</p>
</li>
<li><p>执行热更新AB准备操作自动复制需要热更新的AB到热更新准备目录(然后手动拷贝需要强更或热更的资源到真正的热更新目录)</p>
</li>
<li><p>执行热更新准备操作，生成热更新所需的最新资源热更新信息文件(ResourceUpdateList.txt)和服务器最新版本信息文件(ServerVersionConfig.json)</p>
</li>
</ol>
<h3 id="代码热更"><a href="#代码热更" class="headerlink" title="代码热更"></a>代码热更</h3><p>代码热更和版本强更不一样，版本强更一般来说是通过更新下载完整的包来实现整个游戏功能版本更新，而代码热更是指我们通过技术手段(e.g. XLua, ILRuntime, ToLua ……)，通过热更代码的形式实现热更功能代码。</p>
<p>主流的方式有两种：</p>
<ol>
<li>Lua(Lua方案)<br> Lua是解析执行，有自己的虚拟机，对于代码热更有天然的优势，我们完全可以以资源热更(AssetBundle)的形式热更Lua代码。</li>
<li>ILRuntime(CS方案)<br> 这里不是非常了解ILRuntime底层原理，想了解详情的可以参考官网：<a target="_blank" rel="noopener" href="https://ourpalm.github.io/ILRuntime/public/v1/guide/index.html">ILRuntime项目为基于C#的平台（例如Unity）提供了一个纯C#实现，快速、方便且可靠的IL运行时，使得能够在不支持JIT的硬件环境（如iOS）能够实现代码的热更新</a><br> 但ILRuntime有一点很大的优势就是开发期也是用CS语言，不用写Lua。</li>
</ol>
<p>这里因为项目主要用到了XLua，所以后续都是以XLua作为代码热更来学习。<br>选XLua的原因主要有以下几点：</p>
<ol>
<li>腾讯开源，有大公司支持，稳定</li>
<li>除了支持纯Lua开发，还支持CS通过改写Lua的形式热修复Bug</li>
</ol>
<p>Note:</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://gameinstitute.qq.com/community/detail/119660">苹果禁止了C#的部分反射操作，禁止JIT（即时编译，程序运行时创建并运行新代码），不允许逻辑热更新，只允许使用AssetBundle进行资源热更新。</a></li>
</ol>
<h4 id="XLua"><a href="#XLua" class="headerlink" title="XLua"></a>XLua</h4><p>官网：<br><a target="_blank" rel="noopener" href="https://github.com/Tencent/xLua">XLua</a></p>
<p>待续……</p>
<h3 id="资源服务器"><a href="#资源服务器" class="headerlink" title="资源服务器"></a>资源服务器</h3><p>前面提到的版本强更和资源热更都离不开资源服务器，这里说的资源服务器是指静态资源服务器，接下来通过实战学习了解静态资源服务器相关的概念以及静态资源服务器选择和使用。</p>
<p>静态资源服务器:</p>
<p>我们把资源放到指定静态资源服务器上，静态资源服务器开启Http或者其他的连接服务，允许用户通过对应方式(Http或者其他)去访问拉取服务器资源。(个人理解，如果有误欢迎指出)</p>
<p>静态资源服务器是资源热更的一个前提。</p>
<p>CND:</p>
<p><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%85%A7%E5%AE%B9%E5%82%B3%E9%81%9E%E7%B6%B2%E8%B7%AF"><strong>内容分发网络</strong>（英语：<strong>C</strong>ontent <strong>d</strong>elivery <strong>n</strong>etwork或<strong>C</strong>ontent <strong>d</strong>istribution <strong>n</strong>etwork，<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E7%B8%AE%E5%AF%AB">缩写</a>：<strong>CDN</strong>）是指一种透过<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E4%BA%92%E8%81%AF%E7%B6%B2">互联网</a>互相连接的计算机网络系统，利用最靠近每位用户的服务器，更快、更可靠地将音乐、图片、影片、应用程序及其他文件发送给用户，来提供高性能、可扩展性及低成本的网络内容传递给用户。</a></p>
<p>从上面可以看出CDN是独立于静态资源服务器，网络传输层的一个概念，主要目的是为了加快和提供高性能的资源传输。</p>
<h4 id="实战-1"><a href="#实战-1" class="headerlink" title="实战"></a>实战</h4><p>这里我选择了阿里云的<a href="">OSS</a>作为静态资源服务器。</p>
<p>OSS详情:</p>
<p><a target="_blank" rel="noopener" href="https://help.aliyun.com/document_detail/31883.html?spm=5176.208357.1107607.14.5404390fXITEiK">阿里云对象存储服务（Object Storage Service，简称 OSS）为您提供基于网络的数据存取服务。使用 OSS，您可以通过网络随时存储和调用包括文本、图片、音频和视频等在内的各种非结构化数据文件。</a></p>
<p>OSS静态资源服务器搭建：</p>
<ol>
<li>注册阿里云账号</li>
<li>账号实名认证</li>
<li>开通OSS服务</li>
<li>创建Bucket</li>
<li>上传文件</li>
</ol>
<p><a target="_blank" rel="noopener" href="https://help.aliyun.com/document_detail/31883.html?spm=a2c4g.11174283.3.1.1b5a7da2pQvh8V">OSS详细使用说明</a></p>
<p>待续……</p>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/janeky/article/details/17666409">Unity手游之路手游资源热更新策略探讨</a><br><a target="_blank" rel="noopener" href="http://copyfuture.com/blogs-details/cd4f28bd6dfae0a2ece7cd43a6f90e62">Unity 大版本更新之APK的下载与覆盖安装</a><br><a target="_blank" rel="noopener" href="https://gameinstitute.qq.com/community/detail/119660">Unity3D热更新方案总结</a><br><a target="_blank" rel="noopener" href="http://lazybios.com/2016/12/install-apk-by-intent-compatible-adnroid-n/">使用Intent安装APK方法(兼容Android N)</a><br><a target="_blank" rel="noopener" href="http://yifeng.studio/2017/05/03/android-7-0-compat-fileprovider/">关于 Android 7.0 适配中 FileProvider 部分的总结</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/hackmind/article/details/78113511">Unity app 如何打开商店</a></p>
<h1 id="Git"><a href="#Git" class="headerlink" title="Git"></a>Git</h1><p><a target="_blank" rel="noopener" href="https://github.com/TonyTang1990/AssetBundleLoadManager">AssetBundleLoadManager</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/HotUpdate/">HotUpdate</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/HotUpdate/">HotUpdate</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2019/04/25/优化/" title="优化篇" itemprop="url">优化篇</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Tony Tang" target="_blank" itemprop="author">Tony Tang</a>
		
  <p class="article-time">
    <time datetime="2019-04-25T06:41:00.000Z" itemprop="datePublished"> 发表于 2019-04-25</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>本章节主要目的是学习记录游戏开发中各个模块里的优化知识，深入理解项目设计里的各种底层知识点，避免前期不考虑后期优化成灾的情况。</p>
<p>Note:</p>
<ol>
<li>此处并不是要宣扬优化，项目初期不推崇过度优化毕竟产品做出来才是王道，而是通过深入理解核心知识点在项目初期做出正确的设计来避免没必要的后期优化。</li>
</ol>
<h2 id="UI模块"><a href="#UI模块" class="headerlink" title="UI模块"></a>UI模块</h2><p>深入深度学习Unity UI(UGUI)模块的使用，优化，原理知识等。</p>
<h3 id="UI基础"><a href="#UI基础" class="headerlink" title="UI基础"></a>UI基础</h3><h4 id="UI核心概念"><a href="#UI核心概念" class="headerlink" title="UI核心概念"></a>UI核心概念</h4><p><a target="_blank" rel="noopener" href="https://learn.unity.com/tutorial/optimizing-unity-ui#5c7f8528edbc2a002053b5a0">Canvases are responsible for combining their constituent geometry into batches, generating the appropriate render commands and sending these to Unity’s Graphics system. All of this is done in native C++ code, and is called a rebatch or a batch build.</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.unity.com/tutorial/optimizing-unity-ui#5c7f8528edbc2a002053b5a0">Geometry is provided to Canvases by Canvas Renderer components.</a></p>
<p>从前面可以看出UGUI的绘制是以画布为单位的，子Canvas也就是嵌套的关系，大部分情况子Canvas脏了只会触发子Canvas的网格重建不会触发父Canvas的网格重建。</p>
<p><a target="_blank" rel="noopener" href="https://learn.unity.com/tutorial/optimizing-unity-ui#5c7f8528edbc2a002053b5a0">When composing user interfaces in Unity UI, keep in mind that all geometry drawn by a Canvas will be drawn in the <strong>Transparent queue.</strong></a>(UGUI的Canvas绘制实在Transpanrent Queue里)</p>
<p><a target="_blank" rel="noopener" href="https://learn.unity.com/tutorial/optimizing-unity-ui#5c7f8528edbc2a002053b5a0">A <em>Graphic</em> is a base class provided by the Unity UI C# library. It is the base class for all Unity UI C# classes that provide drawable geometry to the Canvas system. Most built-in Unity UI Graphics are implemented via the <em>MaskableGraphic</em> subclass, which allows them to be masked via the <em>IMaskable</em> interface.</a>(UGUI里Graphic是提供Canvas里可绘制单位的基类，大部分UGUI组件继承至MaskableGraphic，为了支持Mask过滤。)</p>
<p><a target="_blank" rel="noopener" href="https://learn.unity.com/tutorial/optimizing-unity-ui#5c7f8528edbc2a002053b5a0">The updates of Layout and Graphic components is called a rebuild.</a>(网格重建是因为排版或者Graphic组件有更新导致的，比如UI位置变化(排版),UI图片变化(组件变化))</p>
<ol>
<li>Batch Building Process(Canvases)<br><a target="_blank" rel="noopener" href="https://learn.unity.com/tutorial/optimizing-unity-ui#5c7f8528edbc2a002053b5a0">The batch building process is the process whereby a Canvas combines the meshes representing its UI elements and generates the appropriate rendering commands to send to Unity’s graphics pipeline. The results of this process are cached and reused until the Canvas is marked as dirty, which occurs whenever there is a change to one of its constituent meshes.</a>(网格合并是为了将Canvas下的元素合并到一个网格数据里缓存起来直到UI被标记脏时。主要是为了减少DrawCall，减少GPU压力)</li>
<li>Rebuild Process(Graphics)<br><a target="_blank" rel="noopener" href="https://learn.unity.com/tutorial/optimizing-unity-ui#5c7f8528edbc2a002053b5a0">The Rebuild process is where the layout and meshes of Unity UI’s C# Graphic components are recalculated.</a>(网格重建是因为Canvas下的UI有排版或者Graphic组件有变化触发的，目的是为了重新计算绘制所需的网格数据)</li>
</ol>
<p><a target="_blank" rel="noopener" href="https://learn.unity.com/tutorial/optimizing-unity-ui#5c7f8528edbc2a002053b5a0">Whenever any drawable UI element on a given Canvas changes, the Canvas must re-run the batch building process. This process re-analyzes every drawable UI element on the Canvas, regardless of whether it has changed or not. </a>(任何的可绘制UI变化都会导致Canvas重新执行网格合并，因为Mesh有变化了)</p>
<h4 id="UI合批规则"><a href="#UI合批规则" class="headerlink" title="UI合批规则"></a>UI合批规则</h4><p>UI顺序：<br><a href="">Unity UIs are constructed back-to-front, with objects’ order in the hierarchy determining their sort order. </a><br>UI是从后往前结合节点层级(Hierarchy)判定的出序列号的，相邻序列号的会检测是否能合批。所以我们要注意合批打断问题(比如相邻节点没有使用同一个图集，材质。相邻UI节点重叠问题等。)</p>
<p>详细学习参考：<br><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/5b6f5022662e">Unity 之 UGUI 小总结</a></p>
<h4 id="UI射线"><a href="#UI射线" class="headerlink" title="UI射线"></a>UI射线</h4><p>UI射线响应需要满足下面几个条件：</p>
<ol>
<li>目标UI是激活状态</li>
<li>点击区域是目标UI区域</li>
<li>目标UI对象本身或父节点有ICanvasRaycastFilter组件设置允许raycast</li>
</ol>
<p>优化Raycast方案：</p>
<ol>
<li>减少不必要的UI响应Raycast(关闭不必要的UI Raycast Target设置)</li>
</ol>
<p>Note:<br>Unity 5.4之前有个Bug是即使没有input输入也会每帧检查Raycast造成额外开销。</p>
<h3 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h3><p>UI的几个常见问题如下:</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://learn.unity.com/tutorial/optimizing-unity-ui#5c7f8528edbc2a002053b59f">Excessive GPU fragment shader utilization (i.e. fill-rate overutilization)</a>(过度使用GPU – 片元Shader的使用显示，比如填充率过高)</li>
<li><a target="_blank" rel="noopener" href="https://learn.unity.com/tutorial/optimizing-unity-ui#5c7f8528edbc2a002053b59f">Excessive CPU time spent rebuilding a Canvas batch</a>(过度使用CPU – Canvas网格重建和合并)</li>
<li><a target="_blank" rel="noopener" href="https://learn.unity.com/tutorial/optimizing-unity-ui#5c7f8528edbc2a002053b59f">Excessive numbers of rebuilds of Canvas batches (over-dirtying)</a>(过度高频率的触发Canvas网格重建和合并 – 比如大量的动态元素)</li>
<li><a target="_blank" rel="noopener" href="https://learn.unity.com/tutorial/optimizing-unity-ui#5c7f8528edbc2a002053b59f">Excessive CPU time spent generating vertices (usually from text)</a>(过度的使用CPU – 生成过多的顶点数据，比如文本顶点数量)</li>
</ol>
<p>从上面可以看出优化UI主要从两个方面下手：</p>
<ul>
<li>CPU(减少Canvas频繁的合并，减少生成过多的顶点数量)</li>
<li>GPU(减少Drawcall和填充率)</li>
</ul>
<h3 id="Profile-Tool"><a href="#Profile-Tool" class="headerlink" title="Profile Tool"></a>Profile Tool</h3><ol>
<li>Unity Profiler</li>
<li>Unity Frame Debugger</li>
<li>Xcode Intruments</li>
<li>Xcode Frame Debugger<br>详情参考：<br><a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/topics/best-practices/unity-ui-profiling-tools?playlist=30089">Unity UI Profiling Tools</a></li>
</ol>
<h3 id="优化建议"><a href="#优化建议" class="headerlink" title="优化建议"></a>优化建议</h3><ol>
<li>减少不可见UI – 比如全屏不透明UI显示时隐藏背后UI</li>
<li>简化UI结构 – 比如减少不必要节点 不要使用混合GameObject节点等</li>
<li>关闭不可见Camera – 比如全屏不透明UI显示时隐藏其他不必要Camera</li>
<li>划分多Canvas+动静分离 – 比如不同的窗口放到不同的Canvas下避免互相影响。动的元素放在一个Canvas下，静的元素放在一个Canvas下，避免动的元素影响静态元素的网格重建</li>
<li>使用最新版TextMeshPro来替换原生Text方案(TMP使用SDF技术支持不失真的动态字体大小变化)</li>
</ol>
<p>Note:</p>
<ol>
<li>UGUI的Text的文字顶点绘制是单个文字就是一个独立的四边形网格(造成顶点数多)</li>
<li>UGUI的Text动态字体对于不同的大小或者风格(粗体细体)是按不同的文字来处理的(容易造成Canvas的重绘(动态字体纹理重新生成))</li>
<li>文本变化是会触发网格重建和合并的(因为文本网格数据变化了)</li>
</ol>
<h3 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h3><p>通过前面的学习，我们知道了UI的开销主要在Rebatch和Rebuild上。前者可以理解成通过UGUI合批规则把Canvas下的UI合并到指定数量的DrawCall传递到GPU去。后者可以理解成UI变化后重新计算Mesh。</p>
<p>UI优化的关键也就不言而喻了：</p>
<ol>
<li><p>减少Rebatch<br> Canvas没有标记dirty或者Canvas下没有UI Mesh有变化时不会触发Rebatch。<br> 这也就是为什么要划分Canvas且采用动静分离的原因，目的就是把经常变化的UI分离到单独的Canvas，减少静态UI部分的Rebatch开销。</p>
</li>
<li><p>减少Rebuild</p>
</li>
<li><p>降低隐藏激活开销(这一点主要是对于UI显示状态变化时的一种优化)</p>
<p> 根据<a target="_blank" rel="noopener" href="https://blog.uwa4d.com/archives/1875.html"><a target="_blank" rel="noopener" href="https://blog.uwa4d.com/archives/1875.html">UWA 六月直播季 | 6.29 Unity UI模块中的优化案例精讲</a></a>的建议，UGUI最好采用Canvas Group设置Alpha为0的方式来避免SetActive带来的开销以及避免隐藏时的渲染开销</p>
</li>
</ol>
<p>Note:<br>Unity 5.2版本Unity大力优化了UI Batch部分。</p>
<h2 id="资源模块"><a href="#资源模块" class="headerlink" title="资源模块"></a>资源模块</h2><p>资源分很多，比如纹理贴图，图集，材质，Shader，字体，音效，模型，动画等等等。接下来我会针对特定部分来学习针对性的优化知识点。</p>
<h3 id="纹理资源"><a href="#纹理资源" class="headerlink" title="纹理资源"></a>纹理资源</h3><p>这里说的纹理资源同时也包含了图集，图集也可以理解成纹理的一种。</p>
<h3 id="字体"><a href="#字体" class="headerlink" title="字体"></a>字体</h3><p>待续……</p>
<h3 id="音效"><a href="#音效" class="headerlink" title="音效"></a>音效</h3><p>待续……</p>
<h1 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h1><h2 id="Relative-Study"><a href="#Relative-Study" class="headerlink" title="Relative Study"></a>Relative Study</h2><p><a href="">TextMeshPro相关学习</a></p>
<h2 id="Unity-Conception-Part"><a href="#Unity-Conception-Part" class="headerlink" title="Unity Conception Part"></a>Unity Conception Part</h2><p><a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/topics/best-practices/guide-optimizing-unity-ui?playlist=30089">A guide to optimizing Unity UI</a><br><a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/topics/best-practices/fundamentals-unity-ui?playlist=30089">Fundamentals of Unity UI</a><br><a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/topics/best-practices/unity-ui-profiling-tools?playlist=30089">Unity UI Profiling Tools</a><br><a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/topics/best-practices/fill-rate-canvases-and-input?playlist=30089&tdsourcetag=s_pcqq_aiomsg">Fill-rate, Canvases and input</a><br><a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/topics/best-practices/optimizing-ui-controls?playlist=30089">Optimizing UI Controls</a><br><a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/topics/best-practices/other-ui-optimization-techniques-and-tips?playlist=30089">Other UI Optimization Techniques and Tips</a></p>
<h2 id="Other-Part"><a href="#Other-Part" class="headerlink" title="Other Part"></a>Other Part</h2><p><a target="_blank" rel="noopener" href="https://blog.uwa4d.com/archives/QA_UGUI-1.html">关于Unity中的UGUI优化，你可能遇到这些问题</a><br><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/5b6f5022662e">Unity 之 UGUI 小总结</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.uwa4d.com/archives/1875.html"><a target="_blank" rel="noopener" href="https://blog.uwa4d.com/archives/1875.html">UWA 六月直播季 | 6.29 Unity UI模块中的优化案例精讲</a></a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Optimization/">Optimization</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Optimization/">Optimization</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>







  <nav id="page-nav" class="clearfix">
    <a class="extend prev" rel="prev" href="/page/2/">&lt;span&gt;&lt;&#x2F;span&gt;Prev</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><a class="page-number" href="/page/5/">5</a><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/4/">Next&lt;span&gt;&lt;&#x2F;span&gt;</a>
  </nav>

</div>
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  


  
<div class="categorieslist">
	<p class="asidetitle">分类</p>
		<ul>
		
		  
			<li><a href="/categories/AI/" title="AI">AI<sup>5</sup></a></li>
		  
		
		  
			<li><a href="/categories/Algorithm/" title="Algorithm">Algorithm<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/Art/" title="Art">Art<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Automation/" title="Automation">Automation<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Collision/" title="Collision">Collision<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Database/" title="Database">Database<sup>3</sup></a></li>
		  
		
		  
			<li><a href="/categories/Editor/" title="Editor">Editor<sup>5</sup></a></li>
		  
		
		  
			<li><a href="/categories/Excel/" title="Excel">Excel<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Game/" title="Game">Game<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/HotUpdate/" title="HotUpdate">HotUpdate<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Lua/" title="Lua">Lua<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Math/" title="Math">Math<sup>3</sup></a></li>
		  
		
		  
			<li><a href="/categories/Native/" title="Native">Native<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/Network/" title="Network">Network<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Optimization/" title="Optimization">Optimization<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Other/" title="Other">Other<sup>5</sup></a></li>
		  
		
		  
			<li><a href="/categories/Plugin/" title="Plugin">Plugin<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/Programming/" title="Programming">Programming<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/Programming-Language/" title="Programming Language">Programming Language<sup>4</sup></a></li>
		  
		
		  
			<li><a href="/categories/Rendering/" title="Rendering">Rendering<sup>4</sup></a></li>
		  
		
		  
			<li><a href="/categories/Resource/" title="Resource">Resource<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/Unity/" title="Unity">Unity<sup>7</sup></a></li>
		  
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">标签</p>
		<ul class="clearfix">
		
			
				<li><a href="/tags/Unity/" title="Unity">Unity<sup>8</sup></a></li>
			
		
			
				<li><a href="/tags/AI/" title="AI">AI<sup>5</sup></a></li>
			
		
			
				<li><a href="/tags/Editor/" title="Editor">Editor<sup>5</sup></a></li>
			
		
			
				<li><a href="/tags/Other/" title="Other">Other<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/Math/" title="Math">Math<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/Resource/" title="Resource">Resource<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/OpenGL/" title="OpenGL">OpenGL<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/Programming/" title="Programming">Programming<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/Art/" title="Art">Art<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Android/" title="Android">Android<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/UI/" title="UI">UI<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/C/" title="C#">C#<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Python/" title="Python">Python<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Database/" title="Database">Database<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Shader/" title="Shader">Shader<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/SubmlineText3/" title="SubmlineText3">SubmlineText3<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Rendering/" title="Rendering">Rendering<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Native/" title="Native">Native<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Prefab/" title="Prefab">Prefab<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Plugin/" title="Plugin">Plugin<sup>1</sup></a></li>
			
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">友情链接</p>
    <ul>
        
          <li>
            
            	<a href="https://coderq.com" target="_blank" title="一个面向程序员交流分享的新一代社区">码农圈</a>
            
          </li>
        
          <li>
            
            	<a href="http://wuchong.me" target="_blank" title="Jark&#39;s Blog">Jark&#39;s Blog</a>
            
          </li>
        
    </ul>
</div>

  


  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS 订阅</a>
</div>

  <div class="weiboshow">
  <p class="asidetitle">新浪微博</p>
    <iframe width="100%" height="119" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=119&fansRow=2&ptype=1&speed=0&skin=9&isTitle=1&noborder=1&isWeibo=0&isFans=0&uid=&verifier=b3593ceb&dpc=1"></iframe>
</div>


</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> Hello ,I&#39;m Larry Page in Google. <br/>
			This is my blog,believe it or not.</p>
	</section>
	 
	<div class="social-font" class="clearfix">
		
		<a href="http://weibo.com/2176287895" target="_blank" class="icon-weibo" title="微博"></a>
		
		
		
		
		
		
		
		
		
		
	</div>
			
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Jacman">Jacman</a> © 2026 
		
		<a href="/about" target="_blank" title="Tony Tang">Tony Tang</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery.qrcode-0.12.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
        
    }
  });
});
</script>












<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->



<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?e6d1f421bbc9962127a50488f9ed37d1";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>



<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="返回顶部"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
 </html>
