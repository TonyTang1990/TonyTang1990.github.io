
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  
    <title>走停人生路</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="Tony Tang">
    

    
    <meta property="og:type" content="website">
<meta property="og:title" content="走停人生路">
<meta property="og:url" content="http://tonytang1990.github.io/page/5/index.html">
<meta property="og:site_name" content="走停人生路">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Tony Tang">
<meta name="twitter:card" content="summary">

    
    <link rel="alternative" href="/atom.xml" title="走停人生路" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/jacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/jacman.jpg">
    
    
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 7.3.0"></head>

  <body>
    <header>
      
<div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.png" alt="走停人生路" title="走停人生路"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="走停人生路">走停人生路</a></h1>
				<h2 class="blog-motto">做着独立游戏梦，坚持走在游戏开发道路上的人</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">Home</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
						<li><a href="/about">About</a></li>
					
					<li>
 					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="search" id="search" name="q" autocomplete="off" maxlength="20" placeholder="搜索" />
						<input type="hidden" name="q" value="site:tonytang1990.github.io">
					</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main">

   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/12/11/Unity原生/" title="Unity原生" itemprop="url">Unity原生</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Tony Tang" target="_blank" itemprop="author">Tony Tang</a>
		
  <p class="article-time">
    <time datetime="2016-12-11T15:46:11.000Z" itemprop="datePublished"> 发表于 2016-12-11</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="原生知识"><a href="#原生知识" class="headerlink" title="原生知识"></a>原生知识</h1><h2 id="Plugins分类"><a href="#Plugins分类" class="headerlink" title="Plugins分类"></a>Plugins分类</h2><p>Unity Plugins主要分为两类：</p>
<ol>
<li>Managed Plugins</li>
<li>Native Plugins</li>
</ol>
<h3 id="Managed-Plugins"><a href="#Managed-Plugins" class="headerlink" title="Managed Plugins"></a>Managed Plugins</h3><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/Plugins.html">Managed plugins are managed .NET assemblies created with tools like Visual Studio or MonoDevelop. They contain only .NET code which means that they can’t access any features that are not supported by the .NET libraries</a><br>可以看出Managed Plugins是基于.NET的，只含有.NET code(因为Unity只支持.net 2.0，所以并非所有的.NET库和特性都支持)。</p>
<h3 id="Natiev-Plugins"><a href="#Natiev-Plugins" class="headerlink" title="Natiev Plugins"></a>Natiev Plugins</h3><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/Plugins.html">Native plugins are platform-specific native code libraries. They can access features like OS calls and third-party code libraries that would otherwise not be available to Unity.</a><br>Native Plugins可以理解成.NET以外的平台相关的本地代码库(比如c++(unmanaged code),java等等编写的库)，通过编译使用这些平台相关的bendi 代码我们可以去得到一些Unity不支持的一些功能特性，同时Native Plugins允许我们去重用那些平台相关的库。</p>
<p>Note:<br><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/Plugins.html">if you forget to add a managed plugin file to the project, you will get standard compiler error messages. If you do the same with a native plugin, you will only see an error report when you try to run the project.</a>(Managed Plugin是基于.NET的，Unity<br>直接识别，所以在编译时就会报错。而Native Plugin只会在运行时报错。)</p>
<h2 id="Plugins文件扩展名和支持平台"><a href="#Plugins文件扩展名和支持平台" class="headerlink" title="Plugins文件扩展名和支持平台"></a>Plugins文件扩展名和支持平台</h2><p>Unity支持的Plugins文件扩展名如下：<br>.dll(这里要分Managed还是Native，支持多个平台)<br>.so(Android上使用的代码库文件类型)<br>.a(IOS上使用的代码库文件类型)<br>.jar(java文件打包(不包含Android资源文件)<br>.swift(IOS上新语言swift)<br>.aar(打包Android包含代码文件和所有Android资源文件)<br>.framework<br>.bundle<br>.plugin<br>……(这里只列举了比较典型的一些插件文件扩展名)</p>
<p>Unity支持的平台：<br>Unity是支持多平台的：</p>
<ol>
<li>Editor(Unity Editor)</li>
<li>Windows</li>
<li>IOS</li>
<li>Android<br>……(上述只列举了一部分)</li>
</ol>
<p>那么为什么需要了解这么多不同扩展名和不同的支持平台了？<br>因为不同的文件扩展名是针对不同的平台而运用的。<br>比较典型的就是:<br>.dll(多平台)<br>.so .jar .aar(Android)<br>.a .m .mm .swift .framework(IOS)</p>
<p>那么是不是只要随便编译一个.so文件就能在所有的Android机器上运行了了？<br>答案是否定的。因为不同的CPU处理器所支持的指令集是不一样的</p>
<h3 id="处理器与Plugins"><a href="#处理器与Plugins" class="headerlink" title="处理器与Plugins"></a>处理器与Plugins</h3><p>不同的CPU处理器所支持的指令集是不一样的，也就是说要想我们编译的Plugins要在对应机器上运行起来，我们必须确保我们编译的Plugins支持该设备处理器所支持的指令集。</p>
<p>接下来以Android平台.so为例来学习：<br><a target="_blank" rel="noopener" href="http://www.jianshu.com/p/cb05698a1968">Android系统目前支持以下七种不同的CPU架构：ARMv5，ARMv7 (从2010年起)，x86 (从2011年起)，MIPS (从2012年起)，ARMv8，MIPS64和x86_64 (从2014年起)，每一种都关联着一个相应的ABI。</a><br><a target="_blank" rel="noopener" href="http://www.jianshu.com/p/cb05698a1968">应用程序二进制接口（Application Binary Interface）定义了二进制文件（尤其是.so文件）如何运行在相应的系统平台上，从使用的指令集，内存对齐到可用的系统函数库。在Android系统上，每一个CPU架构对应一个ABI：armeabi，armeabi-v7a，x86，mips，arm64-v8a，mips64，x86_64。</a></p>
<p>从上面的引用可以看出，要想在编译的.so文件在不同的Android处理器上运行起来，我们必须保证编译的.so支持该设备的指令集。</p>
<p>但有一点要注意，并不是说每一种CPU都只支持一种架构：<br><a target="_blank" rel="noopener" href="https://developer.android.com/ndk/guides/abis.html#sa">armeabi. By contrast, a typical, ARMv7-based device would define the primary ABI as armeabi-v7a and the secondary one as armeabi, since it can run application native binaries generated for each of them.</a>(ARMv7的机器的第一选择是armabi-v7a,但ARMv7也同时支持armeabi(第二选择))</p>
<p><a target="_blank" rel="noopener" href="https://developer.android.com/ndk/guides/abis.html#sa">Many x86-based devices can also run armeabi-v7a and armeabi NDK binaries. For such devices, the primary ABI would be x86, and the second one, armeabi-v7a.</a>(大部分x86机器都支持armeabi-v7a和armeabi，但x86的第一选择是x86)</p>
<p>那么接下来我们通过学习编译和使用.so来加深理解。</p>
<h3 id="so文件"><a href="#so文件" class="headerlink" title=".so文件"></a>.so文件</h3><p>首先让我们认识一下什么是.so文件？<br><a target="_blank" rel="noopener" href="http://linux-wiki.cn/wiki/zh-hans/%E5%8A%A8%E6%80%81%E5%BA%93(.so)/">Linux中的.so文件类似于Windows中的DLL，是动态链接库，也有人译作共享库</a></p>
<p>为什么我们需要编译成.so文件？<br><a target="_blank" rel="noopener" href="http://linux-wiki.cn/wiki/zh-hans/%E5%8A%A8%E6%80%81%E5%BA%93(.so)/">当多个程序使用同一个动态链接库时，既能节约可执行文件的大小，也能减少运行时的内存占用。</a><br><a target="_blank" rel="noopener" href="https://developer.android.com/ndk/guides/index.html">Squeeze extra performance out of a device to achieve low latency or run computationally intensive applications, such as games or physics simulations. </a>(压榨机器性能)<br><a target="_blank" rel="noopener" href="https://developer.android.com/ndk/guides/index.html">Reuse your own or other developers’ C or C++ libraries. </a>(重用C和C++库)</p>
<h3 id="so与ELF"><a href="#so与ELF" class="headerlink" title=".so与ELF"></a>.so与ELF</h3><p>在了解.so文件结构之前，我们需要了解一下什么是ELF文件？<br><a target="_blank" rel="noopener" href="http://www.cnblogs.com/xmphoenix/archive/2011/10/23/2221879.html">ELF(Executable and Linking Format)是一种对象文件的格式，用于定义不同类型的对象文件(Object files)中都放了什么东西、以及都以什么样的格式去放这些东西。它自最早在 System V 系统上出现后，被 xNIX 世界所广泛接受，作为缺省的二进制文件格式来使用</a></p>
<p>ELF文件主要分为三类：</p>
<ol>
<li>Relocatable file(可重定位对象文件 e.g. 汇编生成的.o文件)</li>
<li>Executable file(可执行文件)</li>
<li>Shared object file(动态库文件 e.g. .so文件)</li>
</ol>
<p>接下来让我们看看ELF Object file的构成：<br><img src="/img/Unity/ELFFileStructure.PNG" alt="ELFFileStructure"><br><a target="_blank" rel="noopener" href="http://www.cnblogs.com/xmphoenix/archive/2011/10/23/2221879.html">为什么会有左右两个很类似的图来说明ELF的组成格式？这是因为ELF格式需要使用在两种场合：</a><br>a) <a target="_blank" rel="noopener" href="http://www.cnblogs.com/xmphoenix/archive/2011/10/23/2221879.html">组成不同的可重定位文件，以参与可执行文件或者可被共享的对象文件的链接构建；</a><br>b) <a target="_blank" rel="noopener" href="http://www.cnblogs.com/xmphoenix/archive/2011/10/23/2221879.html">组成可执行文件或者可被共享的对象文件，以在运行时内存中进程映像的构建。</a></p>
<p>如果想知道ELF文件属于哪一类ELF，并且采用了大端还是小段模式，以及支持的架构等信息的话可以通过fiel命令(貌似属于Linux上的命令，Windows上可以通过Cygwin来模拟Linux环境)<br><img src="/img/Unity/ELFFileCommand.PNG" alt="ELFFileCommand"><br>可以看到libBugly.so是属于shared objectt，target架构是ARM，是小端(LSB)32位结构</p>
<p>接下来我们关注一下ELF文件具体的组成部分：<br><img src="/img/Unity/ELFFileStructureDetail.PNG" alt="ELFFileStructureDetail"></p>
<p>主要由三部分组成：</p>
<ol>
<li>the ELF header</li>
<li>the Program Header Table</li>
<li>the Section Header Table</li>
</ol>
<p>ELF header除了包含前面file命令打印出的一些信息外，还包括更多描述ELF各文件部分的相关信息。<br>我们可以通过readelf命令来查看(Windows上除了通过Cygwin，这里我们还可以使用NDK里的arm-linux-androideabi-readelf.exe来查看ELF Header信息)<br><img src="/img/Unity/ELFHeaderReadelfCommand.PNG" alt="ELFHeaderReadelfCommand"><br>具体每一个字段的含义可以查看<a target="_blank" rel="noopener" href="http://man7.org/linux/man-pages/man5/elf.5.html">ELF</a><br>这里我比较关注的是：<br>Machine  – 表示当前的ELF文件支持的架构。从上面可以看出libBugly.so支持ARM架构<br>Entry point address – 描述程序入口的虚拟地址，如果没有入口则为0x0(这里因为libBugly.so是提供再链接，所以不存在入口点)<br>Start of *** – 描述了特定headers内容的内存偏移<br>Size of *** – 描述了特定header所占字节大小<br>……</p>
<p>从上面的readelf输出结果可以看出libBugly.so包含了9个program headers，25个section headers。</p>
<p>这里暂时不深入去了解ELF文件了，如需了解，可以查看下面给出的链接。<br><a target="_blank" rel="noopener" href="http://www.cnblogs.com/xmphoenix/archive/2011/10/23/2221879.html">可执行文件（ELF）格式的理解</a>:</p>
<p>这里因为我在Android 7.0(API 24)遇到了一个问题：<br>Missing Section Headers<br>后来了解到在Android 7.0开始，Google做了很多改动和要求，包括下面这一项：<br>Missing Section Headers (Enforced since API 24)<br>而因为Section Headers在.so中被移除了所以报出了这个问题。(好像是为了增加破解难度)</p>
<p>这里让我们来了解一个命令工具strip – 用于移除ELF文件中一些不必要的信息。(比如 debug symbol, section headers……)</p>
<p>首先让我们通过readelf –section-headers查看section headers的信息：<br><img src="/img/Unity/SectionHeadersInfo.PNG" alt="SectionHeadersInfo"><br>可以看到libSubly.so有24个section headers</p>
<p>然后通过strip –remove-sections&#x3D;.* libBugly.so尝试移除所有sections(这里注意Cygwin strip无法识别.so，但NDK strip却可以，不知道是不是需要)<br><img src="/img/Unity/StripSectionsAfter.PNG" alt="StripSectionsAfter"><br>可以看到我们成功的移除了所有section header(除了.shstrtab)。</p>
<p>我想这应该就是前面遇到Missing Section Headers的原因，Android 7.0上强制要求不能Missing Section Header。(待确认)</p>
<p>这里主要知道如何去查看.so文件的架构等信息以及ELF文件的大概组成以及如何通过strip命令去移除一些ELF文件里不必要的信息即可。</p>
<h3 id="编译和使用-so"><a href="#编译和使用-so" class="headerlink" title="编译和使用.so"></a>编译和使用.so</h3><p>结合以前学习的一些知识：<br><a target="_blank" rel="noopener" href="http://blog.sina.com.cn/s/blog_8c7d49f20102v7t7.html">JNI和NDK交叉编译进阶学习</a><br><a target="_blank" rel="noopener" href="http://blog.sina.com.cn/s/blog_8c7d49f20102vazu.html">NDK&amp;JNI&amp;Java&amp;Android初步学习总结归纳</a></p>
<p>要想在Windows上编译出在Android处理器使用的.so文件，我需要通过<a target="_blank" rel="noopener" href="https://developer.android.com/ndk/downloads/index.html">NDK</a>(一系列工具的集合，帮助开发者快速开发C(或C++)的动态库。集成了交叉编译器)或者Android Studio配合CMake进行编译。</p>
<p>待续…..</p>
<h3 id="so架构的抉择"><a href="#so架构的抉择" class="headerlink" title=".so架构的抉择"></a>.so架构的抉择</h3><p>还记得前面提到的关于.so架构兼容的问题吗。<br>按照前面的理论是不是说我们只需要支持armeabi或者armeabi-v7架构，就能在大部分机器上跑了了？<br>答案是肯定的，这也是为什么有些人通过减少.so的种类来达到减少APK大小。但值得注意的一点是兼容并不是说100%不会出问题，同时兼容的.so并不一定能使使用性能达到最佳。</p>
<p>所以最好的方法还是通过想办法使用正确架构的.so才是上上之策。</p>
<p>至于即想减少APK大小又想完美使用正确的.so架构的方式，可以参考下面这位博主的一些提议：<br><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000005646078">ANDROID动态加载 使用SO库时要注意的一些问题</a></p>
<h3 id="Unity-Android-IOS-Plugin"><a href="#Unity-Android-IOS-Plugin" class="headerlink" title="Unity Android &amp; IOS Plugin"></a>Unity Android &amp; IOS Plugin</h3><p>接下来让我们结合Unity对Android和IOS平台架构的支持来学习理解CPU架构与Unity之间的关系。<br>Android:<br><img src="/img/Unity/AndroidSupportedArchitectures.PNG" alt="AndroidSupportedArchitectures"></p>
<p>IOS(mono):<br><img src="/img/Unity/IOSMonoSupportedArchitectures.PNG" alt="IOSMonoSupportedArchitectures"></p>
<p>IOS(IL2CPP):<br><img src="/img/Unity/IOSIL2CPPSupportedArchitectures.PNG" alt="IOSIL2CPPSupportedArchitectures"></p>
<p>可以看到Android上只支持ARMv7和x86<br>IOS上支持的情况要根据编译后端设置而定(这里提一下Mac上查看.a文件架构的命令是lipo)：<br>Mono只支持IOS ARMv7<br>IL2CPP支持IOS ARMv7和ARM64</p>
<p>Android因为前面提到的armeabi-v7和x86几乎兼容了所有Android机器，所以只支持这两个是说的过去的。</p>
<p>armv7支持了IOS 4 - 5的大部分机器<br>但IOS 5之后基本都要求arm64，也就是说要支持IOS新机器我们必须使用IL2CPP作为后端编译工具(Unity 4.6之后开始支持的)</p>
<p>对应平台的Plugin需要放到对应文件目录下。<br>Android:<br>Assets&#x2F;Plugins&#x2F;Android<br>IOS:<br>Assets&#x2F;Plugins&#x2F;IOS<br>Windows:<br>Assets&#x2F;Plugins</p>
<h4 id="Android实战"><a href="#Android实战" class="headerlink" title="Android实战"></a>Android实战</h4><p>实战Android前，让我们先了解下Android重要的IDE以及代码相关知识。</p>
<h5 id="Android-Studio"><a href="#Android-Studio" class="headerlink" title="Android Studio"></a>Android Studio</h5><p>以前设计到Android开发的时候，都是使用的Eclipse配合ADT插件来弄得。但Eclipse已经被Google放弃了，Google推出了Android Studio作为新一代Android的IDE，所以学习Android Studio用于Android开发是有必要的。</p>
<p>先让我们来了解下什么是Android Studio:<br><a target="_blank" rel="noopener" href="https://developer.android.com/studio/intro/">Android Studio 是基于 IntelliJ IDEA 的官方 Android 应用开发集成开发环境 (IDE)。</a></p>
<p>这里本人使用Android Studio的需求是为了做移动平台游戏开发时用于Android原生开发。<br>接下来以使用Android Studio配合Unity开发Android为例来学习。</p>
<p>这里放一张Android官网的Android构建流程图加深印象:<br><img src="/img/Android/AndroidBuildFlowChart.png" alt="AndroidBuildFlowChart"></p>
<h5 id="JNI-Java交互"><a href="#JNI-Java交互" class="headerlink" title="JNI(Java交互)"></a>JNI(Java交互)</h5><p>Unity开发搞Android原生开发，主要是通过JNI(Java Native Interface)去访问JVM和Java代码交互。(更多内容见后面的实战学习)<br>详细的JNI，JVM，Java，Android，NDK等概念学习，参考以前的学习:<br><a target="_blank" rel="noopener" href="http://blog.sina.com.cn/s/blog_8c7d49f20102v7t7.html">JNI和NDK交叉编译进阶学习</a><br><a target="_blank" rel="noopener" href="http://blog.sina.com.cn/s/blog_8c7d49f20102vazu.html">NDK&amp;JNI&amp;Java&amp;Android初步学习总结归纳</a></p>
<h5 id="Android项目相关概念"><a href="#Android项目相关概念" class="headerlink" title="Android项目相关概念"></a>Android项目相关概念</h5><p>接下来让我们看看Android Studio创建Android工程之后的基本结构:<br><img src="/img/Android/AndroidStudioAndroidProjectStucture.png" alt="AndroidStudioAndroidProjectStucture"></p>
<p>接下来我们需要理解一个Android Studio里很重要的同一个概念:<br><strong>模块</strong><br><a target="_blank" rel="noopener" href="https://developer.android.com/studio/projects/">模块是源文件和构建设置的集合，允许您将项目分成不同的功能单元。您的项目可以包含一个或多个模块，并且一个模块可以将其他模块用作依赖项。每个模块都可以独立构建、测试和调试。</a></p>
<p>Android Studio提供了一下集中不同类型的模块：</p>
<ol>
<li>Android应用模块(就是上面我们创建Android Project时看到的app就是我们的Android应用模块)</li>
<li>库模块(unityandroidlib就是我单独创建的Android库模块–目的是为了单独导出jar或者aar)</li>
<li>Google Cloud模块</li>
</ol>
<h5 id="Android库模块实战"><a href="#Android库模块实战" class="headerlink" title="Android库模块实战"></a>Android库模块实战</h5><p>在通过Android库模块导出AAR或者Jar前，我们需要弄学习了解一个自动化构建工具：Gradle</p>
<h6 id="Gradle"><a href="#Gradle" class="headerlink" title="Gradle"></a>Gradle</h6><p><a target="_blank" rel="noopener" href="https://docs.gradle.org/current/userguide/userguide.html">Gradle is an open-source build automation tool focused on flexibility and performance. Gradle build scripts are written using a Groovy or Kotlin DSL.</a></p>
<p><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Gradle">Gradle是一个基于Apache Ant和Apache Maven概念的项目自动化建构工具。</a></p>
<p>这里直接引用别人的对Gradle的总结，来简单了解下Gradle:<br><a target="_blank" rel="noopener" href="https://www.zhihu.com/question/30432152">Gradle是一种构建工具,它可以帮你管理项目中的差异,依赖,编译,打包,部署……,你可以定义满足自己需要的构建逻辑,写入到build.gradle中供日后复用.</a></p>
<p>这里暂时需要了解知道的是，Gradle有两大概念:</p>
<ol>
<li>Project<br><a target="_blank" rel="noopener" href="https://docs.gradle.org/current/userguide/tutorial_using_tasks.html">Every Gradle build is made up of one or more projects. What a project represents depends on what it is that you are doing with Gradle. For example, a project might represent a library JAR or a web application. It might represent a distribution ZIP assembled from the JARs produced by other projects. </a></li>
<li>Tasks<br><a target="_blank" rel="noopener" href="https://docs.gradle.org/current/userguide/tutorial_using_tasks.html">Each project is made up of one or more tasks. A task represents some atomic piece of work which a build performs. This might be compiling some classes, creating a JAR, generating Javadoc, or publishing some archives to a repository.</a></li>
</ol>
<p>详细的Gradle学习，参考官网内容:<br><a target="_blank" rel="noopener" href="https://docs.gradle.org/current/userguide/tutorial_using_tasks.html">Build Script Basics</a></p>
<h6 id="Android库模块"><a href="#Android库模块" class="headerlink" title="Android库模块"></a>Android库模块</h6><p><a target="_blank" rel="noopener" href="https://developer.android.com/studio/projects/android-library">Android 库在结构上与 Android 应用模块相同。它可以提供构建应用所需的一切内容，包括源代码、资源文件和 Android 清单。不过，Android 库将编译到您可以用作 Android 应用模块依赖项的 Android 归档 (AAR) 文件，而不是在设备上运行的 APK。</a></p>
<p>这里简单理解下aar和jar的区别就是，AAR是带了所有资源(包括res，AndroidManifest.xml等APK需要的资源+代码Jar的集合)。</p>
<h6 id="Jar库模块"><a href="#Jar库模块" class="headerlink" title="Jar库模块"></a>Jar库模块</h6><p>Studio如何导出库模块作为学习对象，因为我们的目标就是通过Android Studio导出AAR或者Jar给Unity使用:<br>来看看Android库模块是如何新建的：<br>Project右键-&gt;New-&gt;Module-&gt;Android Library<br><img src="/img/Android/AndroidStuidoAndroidModule.png" alt="AndroidStuidoAndroidModule"></p>
<p>通过查看Android应用模块和Android库模块的build.gradle，我们可以通过Gradle是如何定义的：<br>Android应用模块:</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apply plugin: <span class="string">&#x27;com.android.application&#x27;</span></span><br></pre></td></tr></table></figure>
<p>Android库模块:</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apply plugin: <span class="string">&#x27;com.android.library&#x27;</span></span><br></pre></td></tr></table></figure>

<p>接下来我们目标是在如何把我们想要的java代码通过Android模块导出成Jar：<br>让我们看下Android模块的结构：<br><img src="/img/Android/AndroidStudioAndroidModule.png" alt="AndroidStudioAndroidModule"><br>把相关jar和java代码导入到我们的：<br><img src="/img/Android/AndroidStudioAndroidMudleImportCode.png" alt="AndroidStudioAndroidMudleImportCode"></p>
<p>我们现在需要做的就是通过编写我们unityandroidlib这个Android库模块下的build.gradle去支持导出我们想要的jar:<br>在写出我们需要的Android模块build.gradle构建文件之前，我们先来了解下Android模块构建的build.gradle里每一个标签的意义：<br><a target="_blank" rel="noopener" href="https://developer.android.com/studio/build/#module-level">详细的Android模块构建gradle标签学习</a><br><a target="_blank" rel="noopener" href="http://google.github.io/android-gradle-dsl/current/index.html">详细的Android DSL标签参考</a><br><a target="_blank" rel="noopener" href="https://guides.gradle.org/building-android-apps/?_ga=2.32380022.931589262.1533988091-1402562034.1533988091">Android Gradle的详细学习参考Building Android Apps</a></p>
<p>实战Android模块的build.gradle：</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 表示使用Android插件进行gradle的Android自动化构建</span></span><br><span class="line"><span class="comment"> * com.android.library表示是构建成一个Android模块</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">apply plugin: <span class="string">&#x27;com.android.library&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// android &#123;&#125;指定如何配置android相关编译构建</span></span><br><span class="line">android &#123;</span><br><span class="line">    <span class="comment">// 指定Android API编译版本</span></span><br><span class="line">    compileSdkVersion <span class="number">27</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//defaultConfig &#123;&#125;指定Android部分默认设置，可以通过这里的指定覆盖AndroidManifest.xml里的部分内容</span></span><br><span class="line">    defaultConfig &#123;</span><br><span class="line">        minSdkVersion <span class="number">15</span>            <span class="comment">// 最低支持的Android API版本</span></span><br><span class="line">        targetSdkVersion <span class="number">27</span>         <span class="comment">// 目标Android API版本</span></span><br><span class="line">        versionCode <span class="number">1</span>               <span class="comment">// App的version number</span></span><br><span class="line">        versionName <span class="string">&quot;1.0&quot;</span>           <span class="comment">// App的version name</span></span><br><span class="line"></span><br><span class="line">        testInstrumentationRunner <span class="string">&quot;android.support.test.runner.AndroidJUnitRunner&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// buildTypes &#123;&#125;指定编译类型的详细信息，比如release和debug的详细编译设定</span></span><br><span class="line">    buildTypes &#123;</span><br><span class="line">        <span class="comment">// release的编译设定</span></span><br><span class="line">        release &#123;</span><br><span class="line">            minifyEnabled <span class="keyword">false</span>                                                                         <span class="comment">// 是否开启代码精简</span></span><br><span class="line">            proguardFiles getDefaultProguardFile(<span class="string">&#x27;proguard-android.txt&#x27;</span>), <span class="string">&#x27;proguard-rules.pro&#x27;</span>    <span class="comment">// 代码混淆相关设置</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// dependencies &#123;&#125;指定编译依赖信息(比如我们的项目需要依赖unity的classes.jar库)</span></span><br><span class="line"><span class="keyword">dependencies</span> &#123;</span><br><span class="line">    <span class="comment">// fileTree - 指定目录(libs)下符合条件(*.jar)的文件添加到编译路径下</span></span><br><span class="line">    implementation <span class="keyword">fileTree</span>(<span class="keyword">include</span>: [<span class="string">&#x27;*.jar&#x27;</span>], dir: <span class="string">&#x27;libs&#x27;</span>)</span><br><span class="line">    <span class="comment">// com.android.support:appcompat-v7:27.1.1 - 添加Android兼容模式库到项目，用于支持更多的theme和兼容老的部分功能</span></span><br><span class="line">    implementation <span class="string">&#x27;com.android.support:appcompat-v7:27.1.1&#x27;</span></span><br><span class="line">    testImplementation <span class="string">&#x27;junit:junit:4.12&#x27;</span></span><br><span class="line">    androidTestImplementation <span class="string">&#x27;com.android.support.test:runner:1.0.2&#x27;</span></span><br><span class="line">    androidTestImplementation <span class="string">&#x27;com.android.support.test.espresso:espresso-core:3.0.2&#x27;</span></span><br><span class="line">    <span class="comment">// files - 猜测是指定需要依赖的jar库(没找到官方解释)</span></span><br><span class="line">    implementation files(<span class="string">&#x27;libs/classes.jar&#x27;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// task - 添加自定义的构建任务</span></span><br><span class="line"><span class="comment">// 这里是增加一个删除旧的jar的任务</span></span><br><span class="line"><span class="comment">// type:指定任务的类型delete删除</span></span><br><span class="line"><span class="keyword">task</span> deleteOldJar(type: <span class="keyword">Delete</span>) &#123;</span><br><span class="line">    <span class="comment">// 指定删除release/AndroidPlugin.jar文件</span></span><br><span class="line">    <span class="keyword">delete</span> <span class="string">&#x27;build/libs/classes.jar&#x27;</span></span><br><span class="line">    <span class="keyword">delete</span> <span class="string">&#x27;release/AndroidPlugin.jar&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// task - 添加自定义的构建任务</span></span><br><span class="line"><span class="comment">// 这里增加一个从新打包jar的任务，目的是为了去除默认build里打包的BuildConfig.class(会导致Unity使用jar时报错)</span></span><br><span class="line"><span class="comment">// type: 指定任务类型是Jar打包</span></span><br><span class="line"><span class="keyword">task</span> makeJar(type: Jar) &#123;</span><br><span class="line">    <span class="comment">// 指定jar来源(文件或者目录)</span></span><br><span class="line">    <span class="keyword">from</span> <span class="keyword">file</span>(<span class="string">&#x27;build/intermediates/classes/release&#x27;</span>)</span><br><span class="line">    <span class="comment">// 指定需要重新打包后的jar名字</span></span><br><span class="line">    archiveName = <span class="string">&#x27;classes.jar&#x27;</span></span><br><span class="line">    <span class="comment">// 输出目录</span></span><br><span class="line">    <span class="keyword">destinationDir</span> = <span class="keyword">file</span>(<span class="string">&#x27;build/libs/&#x27;</span>)</span><br><span class="line">    <span class="comment">// 过滤不需要的class文件</span></span><br><span class="line">    <span class="keyword">exclude</span>(<span class="string">&#x27;com/tonytang/unityandroidproject/BuildConfig.class&#x27;</span>)</span><br><span class="line">    <span class="keyword">exclude</span>(<span class="string">&#x27;com/tonytang/unityandroidproject/BuildConfig\$*.class&#x27;</span>)</span><br><span class="line">    <span class="keyword">exclude</span>(<span class="string">&#x27;com/tonytang/unityandroidproject/R.class&#x27;</span>)</span><br><span class="line">    <span class="keyword">exclude</span>(<span class="string">&#x27;com/tonytang/unityandroidproject/R\$*.class&#x27;</span>)</span><br><span class="line">    <span class="comment">// 需要包含打包到jar中的文件</span></span><br><span class="line">    <span class="keyword">include</span>(<span class="string">&#x27;com/tonytang/unityandroidproject/**&#x27;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 指定makeJar任务依赖的任务build(依赖的任务先执行)</span></span><br><span class="line">makeJar.dependsOn(build)</span><br><span class="line"></span><br><span class="line"><span class="comment">// task - 添加自定义的构建任务</span></span><br><span class="line"><span class="comment">// 这里是增加一个到处jar的任务</span></span><br><span class="line"><span class="comment">// type:指定任务类型为Copy复制</span></span><br><span class="line"><span class="keyword">task</span> exportJar(type: <span class="keyword">Copy</span>) &#123;</span><br><span class="line">    <span class="comment">// 从哪里复制</span></span><br><span class="line">    <span class="keyword">from</span>(<span class="string">&#x27;build/libs/&#x27;</span>)</span><br><span class="line">    <span class="comment">// 复制到哪里</span></span><br><span class="line">    <span class="keyword">into</span>(<span class="string">&#x27;release/&#x27;</span>)</span><br><span class="line">    <span class="comment">/// 重命名文件</span></span><br><span class="line">    rename(<span class="string">&#x27;classes.jar&#x27;</span>, <span class="string">&#x27;AndroidPlugin.jar&#x27;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 指定exportJar任务依赖的任务deleteOldJar,build,makeJar(依赖的任务先执行)</span></span><br><span class="line">exportJar.dependsOn(deleteOldJar, makeJar)</span><br></pre></td></tr></table></figure>
<p>完成build.gradle编写后，我们打开Gradle Project就可以选中我们新写的exportJar任务，双击执行:<br><img src="/img/Android/AndroidStudioGradleProjectView.png" alt="AndroidStudioGradleProjectView"><br><img src="/img/Android/AndroidStudioGraduleBuildProccess.png" alt="AndroidStudioGraduleBuildProccess"></p>
<p>上面的注释很详细了，就不过多描述了，直接来看下我们在release下生成的新得AndroidPlugin.jar吧：<br><img src="/img/Android/AndroidModuleJar.png" alt="AndroidModuleJar"><br>我们成功得到了过滤掉BuildConfig.class,R.class等文件的jar代码包。<br>得到jar包后，我们还需要把我们的Android相关的资源以及jar包放到我们的Unity对应项目目录才行（Plugins&#x2F;Android&#x2F;）:<br><img src="/img/Android/UnityAndroidFolderStructure.png" alt="UnityAndroidFolderStructure"></p>
<p>接下来我们需要的是通过Unity封装的JNI去访问Java代码：<br>AndroidNativeManager.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             AndroidNativeManager.cs</span></span><br><span class="line"><span class="comment"> * Author:                  TONYTANG</span></span><br><span class="line"><span class="comment"> * Create Date:             2018/08/10</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> UNITY_ANDROID</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> AndroidNativeManager.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Android原生管理类</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">AndroidNativeManager</span> : <span class="title">NativeManager</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Android主Activity对象</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> AndroidJavaObject mAndroidActivity;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 初始化</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">init</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">base</span>.<span class="keyword">init</span>();</span><br><span class="line">        Debug.Log(<span class="string">&quot;init()&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (Application.platform == RuntimePlatform.Android)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//这里使用using的目的是确保AndroidJavaClass对象尽快被删除</span></span><br><span class="line">            <span class="keyword">using</span> (AndroidJavaClass jc = <span class="keyword">new</span> AndroidJavaClass(<span class="string">&quot;com.unity3d.player.UnityPlayer&quot;</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//获得当前Activity(这里是为了获得MainActivity)</span></span><br><span class="line">                mAndroidActivity = jc.GetStatic&lt;AndroidJavaObject&gt;(<span class="string">&quot;currentActivity&quot;</span>);</span><br><span class="line">                <span class="keyword">if</span> (mAndroidActivity == <span class="literal">null</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    Debug.Log(<span class="string">&quot;获取UnityMainActivity::mAndroidActivity成员失败！&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    Debug.Log(<span class="string">&quot;获取UnityMainActivity::mAndroidActivity成员成功!&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 调用原生方法</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">callNativeMethod</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">base</span>.callNativeMethod();</span><br><span class="line">        Debug.Log(<span class="string">&quot;callNativeMethod()&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (mAndroidActivity != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            mAndroidActivity.Call(<span class="string">&quot;javaMethod&quot;</span>, <span class="string">&quot;cs param&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p>NativeMessageHandler.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             NativeMessageHandler.cs</span></span><br><span class="line"><span class="comment"> * Author:                  TONYTANG</span></span><br><span class="line"><span class="comment"> * Create Date:             2018/08/10</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> NativeMessageHandler.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 原生消息相应处理器</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">NativeMessageHandler</span> : <span class="title">MonoBehaviour</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 接收原生消息</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;msg&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">resUnityMsg</span>(<span class="params"><span class="built_in">string</span> msg</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Debug.Log(<span class="built_in">string</span>.Format(<span class="string">&quot;resUnityMsg : &#123;0&#125;&quot;</span>, msg));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>MainActivity.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.tonytang.unityandroidproject;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.app.Activity;</span><br><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.content.res.Configuration;</span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> android.util.DisplayMetrics;</span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.unity3d.player.UnityPlayer;</span><br><span class="line"><span class="keyword">import</span> com.unity3d.player.UnityPlayerActivity;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">UnityPlayerActivity</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Unity那一侧相应Java回调的GameObject名字</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">mUnityCallBackHandler</span> <span class="operator">=</span> <span class="string">&quot;GameLauncher&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Android上下文</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">Context</span> <span class="variable">mContext</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 主Activity</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">Activity</span> <span class="variable">mCurrentActivity</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line"></span><br><span class="line">        Log.d(<span class="string">&quot;JNI&quot;</span>, <span class="string">&quot;onCreate()&quot;</span>);</span><br><span class="line">        mContext = <span class="built_in">this</span>.getApplicationContext();</span><br><span class="line">        mCurrentActivity = <span class="built_in">this</span>;</span><br><span class="line">        ******</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ******</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Unity call part</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">javaMethod</span><span class="params">(String csparam)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Log.d(<span class="string">&quot;JNI&quot;</span>, <span class="string">&quot;javaMethod() with parameter:&quot;</span> + csparam);</span><br><span class="line">        UnityPlayer.UnitySendMessage(mUnityCallBackHandler,<span class="string">&quot;resUnityMsg&quot;</span>, <span class="string">&quot;java param&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/img/Android/UnityJNICall.png" alt="UnityJNICall"></p>
<p>至此我们成功完成了使用Android Studio通过编写Gradule导出我们需要的jar代码包，然后通过Unity封装的JNI访问java方法并通过Unity的方法UnityPlayer.UnitySendMessage()方法成功返回调用了CS代码。</p>
<p>关于Unity使用AAR的学习:<br>待续……</p>
<p>详细的Android DSL标签学习:<br><a target="_blank" rel="noopener" href="http://google.github.io/android-gradle-dsl/current/index.html">Android Plugin DSL Reference</a><br>详细的Gradle task学习：<br><a target="_blank" rel="noopener" href="https://docs.gradle.org/current/dsl/org.gradle.api.Task.html">Gradle Task</a></p>
<p>待续……</p>
<h6 id="AAR库模块"><a href="#AAR库模块" class="headerlink" title="AAR库模块"></a>AAR库模块</h6><p>这里再次说一下AAR和Jar的区别：<br>AAR是带了所有资源(包括res，AndroidManifest.xml等APK需要的资源+代码Jar的集合)。</p>
<p>Unity是可以使用AAR作为资源的使用的，导出AAR和Jar没有太多区别，这里注重讲下Unity使用Android Studio导出的Jar需要注意的地方和坑点。</p>
<p>导出Jar的同时其实已经导出了AAR，AAR存在下面这个目录:<br><img src="/img/Android/AndroidAAROutput.png" alt="AndroidAAROutput"></p>
<p>但如果我们直接把res和aar以及AndroidManifest拷贝到Plugins插件目下，打包会发现报错：<br>错误的意思大致是classes.jar代码已存在有重复。</p>
<p>classes.jar代码重复是因为我们前面导出jar的build.gradle配置了:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// dependencies &#123;&#125;指定编译依赖信息(比如我们的项目需要依赖unity的classes.jar库)</span></span><br><span class="line">dependencies &#123;</span><br><span class="line">    <span class="comment">// fileTree - 指定目录(libs)下符合条件(*.jar)的文件添加到编译路径下</span></span><br><span class="line">    <span class="function">implementation <span class="title">fileTree</span>(<span class="params">include: [<span class="string">&#x27;*.jar&#x27;</span>], dir: <span class="string">&#x27;libs&#x27;</span></span>)</span></span><br><span class="line"><span class="function">    ******</span></span><br><span class="line"><span class="function">    <span class="comment">// files - 指定需要依赖的库文件(没找到官方解释)</span></span></span><br><span class="line"><span class="function">    implementation <span class="title">files</span>(<span class="params"><span class="string">&#x27;libs/classes.jar&#x27;</span></span>)</span></span><br><span class="line"><span class="function">&#125;</span></span><br></pre></td></tr></table></figure>
<p>这里的两句implementation，前者是表示libs下的jar作为引用并一起打包输出到aar里，后者表示要引用并一起打包classes.jar库。</p>
<p>所以这里就是导致我们的AAR里有一份classes.jar库代码存在的原因。</p>
<p>改写build.gradle避免classes.jar被一起打包到AAR里:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// dependencies &#123;&#125;指定编译依赖信息(比如我们的项目需要依赖unity的classes.jar库)</span></span><br><span class="line">dependencies &#123;</span><br><span class="line">    <span class="comment">// fileTree - 指定目录(libs)下符合条件(*.jar)的文件添加到编译路径下</span></span><br><span class="line">    <span class="comment">// 因为项目依赖了Unity的class.jar但又不希望classes.jar跟着aar一起导出(会导致unity打包报错 -- classes.jar包重复问题)</span></span><br><span class="line">    <span class="comment">// 所以这里不能使用fileTree包含lib目录下所有jar，需要修改成不包含classes.jar的形式</span></span><br><span class="line">    <span class="function">implementation <span class="title">fileTree</span>(<span class="params">include: [<span class="string">&#x27;*.jar&#x27;</span>], dir: <span class="string">&#x27;libs/include&#x27;</span></span>)</span></span><br><span class="line"><span class="function">    ******</span></span><br><span class="line"><span class="function">    <span class="comment">// files - 猜测是显示指定依赖文件(没找到官方解释)</span></span></span><br><span class="line"><span class="function">    <span class="comment">// 这里专门用compileOnly是为了避免classes.jar进aar包</span></span></span><br><span class="line"><span class="function">    compileOnly <span class="title">files</span>(<span class="params"><span class="string">&#x27;libs/exclude/classes.jar&#x27;</span></span>)</span></span><br><span class="line"><span class="function">&#125;</span></span><br></pre></td></tr></table></figure>

<p>implementation – Gradle 会将依赖项添加到编译类路径，并将依赖项打包到构建输出<br>compileOnly – Gradle 只会将依赖项添加到编译类路径（即不会将其添加到构建输出）<br>通过修改build.gradle和调整目录：<br><img src="/img/Android/AndroidGradleLibsFolderStructure.png" alt="AndroidGradleLibsFolderStructure"><br>我们避免了classes.jar被打进AAR里，这样一来就不会在Unity打包时有classes.jar代码重复的问题了。</p>
<p>Note:<br><strong>AAR可以通过修改后缀成.zip通过解压软件插件内部详情</strong><br><a target="_blank" rel="noopener" href="https://developer.android.com/studio/build/dependencies">dependencies模块详细说明参考</a></p>
<h3 id="IOS实战"><a href="#IOS实战" class="headerlink" title="IOS实战"></a>IOS实战</h3><p>IOS实战学习前，我们需要了解IOS的开发语言，以前是Objective-C，后来苹果推出了switf。<br>这里针对Unity而言，我们主要用到的还是以Objective-C为主。</p>
<h4 id="Objective-C语法"><a href="#Objective-C语法" class="headerlink" title="Objective-C语法"></a>Objective-C语法</h4><p>*.h</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">///所需其他头文件</span><br><span class="line">#import &quot;*.h&quot;</span><br><span class="line"></span><br><span class="line">//&lt;Protocol&gt; OC里的Protocol相当于Interface，需要实现接口方法</span><br><span class="line">//但有一点不同的是Protocol里并不是所有的接口方法都必须实现</span><br><span class="line">//@required -- 必须实现的部分</span><br><span class="line">//@optional -- 可选实现的部分</span><br><span class="line">@interface *:NSObject&lt;*&gt;&#123;</span><br><span class="line"></span><br><span class="line">    // 类变量声明</span><br><span class="line">    //......</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//类属性声明</span><br><span class="line">@property (nonatomic, strong) * *属性名;</span><br><span class="line">//Unity回调GameObject名字</span><br><span class="line">@property (nonatomic, strong) NSString *mGameObjectHandler;</span><br><span class="line"></span><br><span class="line">//类方法声明</span><br><span class="line">//+代表属于类方法，相当于静态</span><br><span class="line">//-代表属于对象，相当于类成员</span><br><span class="line">//方法定义格式如下:</span><br><span class="line">//(+ or -)(return 返回类型)方法名:(参数1类型) 参数1名 : (参数2类型) 参数2名;</span><br><span class="line">+(类型*) Instance;</span><br><span class="line"></span><br><span class="line">-(void)方法名;</span><br><span class="line"></span><br><span class="line">-(void)方法名:(参数类型 *)参数名;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure>

<p>*.mm</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">#import &quot;*.h&quot;</span><br><span class="line"></span><br><span class="line">//定义全局的静态变量</span><br><span class="line">static 类型名* 变量名 = nil;</span><br><span class="line"></span><br><span class="line">//声明UnitySendMessage为外部方法，用于native code和C＃发消息交互</span><br><span class="line">#if defined(__cpluscplus)</span><br><span class="line">//确保函数的编译方式</span><br><span class="line">//确保找到正确的函数名</span><br><span class="line">//这一点好比C++指定不同的调用约定(stdcall(C++默认使用)和cdecl(C默认使用))</span><br><span class="line">//会决定函数名生成，参数入栈顺序，堆栈维护等</span><br><span class="line">//在读取的时候也需要指定同样编译方式</span><br><span class="line">extern &quot;C&quot;&#123;</span><br><span class="line">#endif  </span><br><span class="line">    extern void UnitySendMessage(const char *, const char *, const char *);</span><br><span class="line"></span><br><span class="line">#if defined(__cpluscplus)</span><br><span class="line">&#125;</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">//指定实现的类型</span><br><span class="line">@implementation 类型名</span><br><span class="line"></span><br><span class="line">//获取单例对象</span><br><span class="line">+(返回类型*) Instance</span><br><span class="line">&#123;</span><br><span class="line">    return *;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">-(void)方法名</span><br><span class="line">&#123;</span><br><span class="line">    //方法实现</span><br><span class="line">    NSLog(@&quot;initSDK&quot;);</span><br><span class="line">    self.mGameObjectHandler = @&quot;响应原生消息的GameObejct名字&quot;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">-(void)方法名:(参数1类型 *)key value:(参数2类型 *)value</span><br><span class="line">&#123;</span><br><span class="line">    //Log打印方式</span><br><span class="line">    NSLog(@&quot;参数设置：key = %@ value = %@&quot;, key,value);</span><br><span class="line">    //字符串拼接方式</span><br><span class="line">    NSString *msg = [NSString stringWithFormat:@&quot;%@ %@ %s&quot;, key, value, issuccess ? &quot;true&quot; : &quot;false&quot;];</span><br><span class="line">    //原生发送消息给CS一侧</span><br><span class="line">    UnitySendMessage([self.mGameObjectHandler UTF8String], &quot;CS回调响应方法名&quot;, [msg UTF8String]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//用于C#和Objective C交互的代码</span><br><span class="line">extern &quot;C&quot;&#123;</span><br><span class="line">    void CS方法名()</span><br><span class="line">    &#123;</span><br><span class="line">        [[类型名 类型静态变量] 成员方法];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    void CS方法名(char* key, char* value)</span><br><span class="line">    &#123;</span><br><span class="line">        //CS char*到NSString转换方式</span><br><span class="line">        NSString* parameterkey = [NSString stringWithUTF8String:key];</span><br><span class="line">        NSString* parametervalue = [NSString stringWithUTF8String:value];</span><br><span class="line">        [[类型名 类型静态变量] 成员方法:参数1值 参数2名字:参数2值];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure>

<h4 id="Unity与IOS的交互"><a href="#Unity与IOS的交互" class="headerlink" title="Unity与IOS的交互"></a>Unity与IOS的交互</h4><p>了解Unity与IOS交互前，让我们先了解部分IOS相关概念：<br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/lixiaojian/p/3336653.html">UIView是一个视图,UIViewController是一个控制器,每一个viewController管理着一个view。</a></p>
<p>IOS和UIViewController的交互就好比Android里和Activity的交互。</p>
<p>结合Unity官方讲解:<br><a target="_blank" rel="noopener" href="https://docs.unity3d.com/2017.4/Documentation/Manual/StructureOfXcodeProject.html">Customizing an iOS Splash Screen Other Versions Leave feedback Structure of a Unity XCode Project</a></p>
<p>我们可以知道IOS里，UnityAppController.mm是整个程序的入口。如果我们想要自定义入口，我们需要继承至UnityAppController。<br>AppController.h</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">// 自定义Unity AppCOntroller</span><br><span class="line">//导入Unity的UnityAppController.h，自定义AppController需要继承至UnityAppController</span><br><span class="line">#import &quot;UnityAppController.h&quot;</span><br><span class="line"></span><br><span class="line">@interface AppController : UnityAppController</span><br><span class="line">@property(nonatomic,strong) UINavigationController *naVC;</span><br><span class="line">-(void) createUI;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure>
<p>AppController.mm</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">//自身的头文件</span><br><span class="line">#import &quot;AppController.h&quot;</span><br><span class="line">//导入我们自己写接口的类的.h文件，用于实现自定义的UIViewController</span><br><span class="line">#import &quot;UnityViewController.h&quot;</span><br><span class="line">//其他文件</span><br><span class="line">#import &lt;Foundation/Foundation.h&gt;</span><br><span class="line"></span><br><span class="line">@implementation AppController</span><br><span class="line">-(void) createUI</span><br><span class="line">&#123;</span><br><span class="line">    NSLog(@&quot;AppController:createUI()&quot;);</span><br><span class="line">    _rootController = [[UIViewController alloc]init];</span><br><span class="line">    _rootView = [[UIView alloc]initWithFrame:[UIScreen mainScreen].bounds];</span><br><span class="line">    _rootController.view = _rootView;</span><br><span class="line">        </span><br><span class="line">    //自定义viewcontroller添加到现有的viewcontroller上</span><br><span class="line">    UnityViewController *vc = [[UnityViewController alloc]init];</span><br><span class="line">    self.naVC =[[UINavigationController alloc]initWithRootViewController:vc];</span><br><span class="line">    </span><br><span class="line">    //添加自定义view到rootView上</span><br><span class="line">    [_rootView addSubview:self.naVC.view];</span><br><span class="line"></span><br><span class="line">    _window.rootViewController = _rootController;</span><br><span class="line">    [_window bringSubviewToFront:_rootView];</span><br><span class="line">    [_window makeKeyAndVisible];</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">//这是一个固定写法，因为这个代码，所以启动界面是从这里启动</span><br><span class="line">IMPL_APP_CONTROLLER_SUBCLASS(AppController);</span><br></pre></td></tr></table></figure>
<p>通过上面的代码，我们完成了下面两件事：</p>
<ol>
<li>自定义Unity IOS程序入口</li>
<li>添加了自定义的View(绑定到自定义UIViewController上)到rootView上</li>
</ol>
<p>成功绑定到自定义UIViewController上后，我们就能通过自定义的UIViewController去和IOS打交道了。<br>接下来看看自定义的UIViewController是如何定义的，结合权限申请实战学习：<br>UnityViewController.h</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">//自定义的UIViewController</span><br><span class="line">#import &quot;UnityAppController.h&quot;</span><br><span class="line"></span><br><span class="line">@interface UnityViewController : UIViewController</span><br><span class="line">//权限申请</span><br><span class="line">- (void)audioAuthAction;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure>
<p>UnityViewController.mm</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">//包含自身头文件</span><br><span class="line">#import &quot;UnityViewController.h&quot;</span><br><span class="line"></span><br><span class="line">//其他头文件</span><br><span class="line">#import &quot;UnityAppController+ViewHandling.h&quot;</span><br><span class="line">#import &lt;UI/UnityView.h&gt;</span><br><span class="line">#import &lt;Foundation/Foundation.h&gt;</span><br><span class="line">#import &lt;AVFoundation/AVFoundation.h&gt;</span><br><span class="line"></span><br><span class="line">@implementation UnityViewController</span><br><span class="line"></span><br><span class="line">- (void)viewDidLoad</span><br><span class="line">&#123;</span><br><span class="line">    NSLog(@&quot;UnityViewController:viewDidLoad()&quot;);</span><br><span class="line">    [super viewDidLoad];</span><br><span class="line">    [self.view addSubview:GetAppController().unityView];</span><br><span class="line">    GetAppController().unityView.frame = self.view.frame;</span><br><span class="line">    </span><br><span class="line">    // Do any additional setup after loading the view.</span><br><span class="line">    // 权限申请相关</span><br><span class="line">    [self audioAuthAction];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//权限申请</span><br><span class="line">- (void)audioAuthAction</span><br><span class="line">&#123;</span><br><span class="line">    //麦克风权限申请</span><br><span class="line">    NSLog(@&quot;UnityViewController:audioAuthAction()&quot;);</span><br><span class="line">    [AVCaptureDevice requestAccessForMediaType:AVMediaTypeAudio completionHandler:^(BOOL granted) &#123;</span><br><span class="line">       NSLog(@&quot;%@&quot;,granted ? @&quot;麦克风准许&quot;:@&quot;麦克风不准许&quot;);</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">-(void)viewWillAppear:(BOOL)animated&#123;</span><br><span class="line">    //隐藏导航条view</span><br><span class="line">    NSLog(@&quot;UnityViewController:viewWillAppear()&quot;);</span><br><span class="line">    self.navigationController.navigationBar.hidden = YES;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">-(void)viewDidDisappear:(BOOL)animated</span><br><span class="line">&#123;</span><br><span class="line">    NSLog(@&quot;UnityViewController:viewDidDisappear()&quot;);</span><br><span class="line">    self.navigationController.navigationBar.hidden = NO;</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure>
<p>可以看到通过自定义的UIViewController，我们就可以直接编写对应原生功能(e.g. 权限申请)代码了。</p>
<h4 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h4><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/2017.4/Documentation/Manual/StructureOfXcodeProject.html">Customizing an iOS Splash Screen Other Versions Leave feedback Structure of a Unity XCode Project</a><br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/vsirWaiter/p/8383408.html">Unity-IOS交互整理</a><br><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/bd944258105f">iOS 系统权限</a></p>
<p>待续……</p>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><h2 id="Unity-Official-Website-Part"><a href="#Unity-Official-Website-Part" class="headerlink" title="Unity Official Website Part"></a>Unity Official Website Part</h2><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/Plugins.html">Unity Plugin</a></p>
<h2 id="Knowledge-Part"><a href="#Knowledge-Part" class="headerlink" title="Knowledge Part"></a>Knowledge Part</h2><p><a target="_blank" rel="noopener" href="http://www.jianshu.com/p/cb05698a1968">关于Android的.so文件你所需要知道的</a><br><a target="_blank" rel="noopener" href="http://linux-wiki.cn/wiki/zh-hans/%E5%8A%A8%E6%80%81%E5%BA%93(.so)">动态库(.so)</a><br><a target="_blank" rel="noopener" href="https://developer.android.com/ndk/guides/index.html">Getting Started with the NDK</a><br><a target="_blank" rel="noopener" href="http://linuxtools-rst.readthedocs.io/zh_CN/latest/tool/readelf.html">readelf elf文件格式分析</a><br><a target="_blank" rel="noopener" href="https://developer.android.com/ndk/guides/abis.html">ABI Management</a><br><a target="_blank" rel="noopener" href="https://android-developers.googleblog.com/2016/06/android-changes-for-ndk-developers.html">Android changes for NDK developers </a><br><a target="_blank" rel="noopener" href="http://www.cnblogs.com/xmphoenix/archive/2011/10/23/2221879.html">可执行文件（ELF）格式的理解</a><br><a target="_blank" rel="noopener" href="http://infocenter.arm.com/help/topic/com.arm.doc.dui0101a/DUI0101A_Elf.pdf">ARM ELF File Format</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Native/">Native</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Native/">Native</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/12/11/Unity第三方插件/" title="Unity第三方插件" itemprop="url">Unity第三方插件</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Tony Tang" target="_blank" itemprop="author">Tony Tang</a>
		
  <p class="article-time">
    <time datetime="2016-12-11T15:46:11.000Z" itemprop="datePublished"> 发表于 2016-12-11</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="Unity第三方插件"><a href="#Unity第三方插件" class="headerlink" title="Unity第三方插件"></a>Unity第三方插件</h1><p>本章节主要讲解学习Unity第三方工具插件(比如NGUI，Dotween，2DToolkit……)。</p>
<h2 id="NGUI"><a href="#NGUI" class="headerlink" title="NGUI"></a>NGUI</h2><p>NGUI是C#写的第三方插件，堪称Unity 4.6之前最完美的GUI解决方案(NGUI 2.7及之前貌似是免费)，复杂的UI都能在一个Draw Call完成渲染。<br>出于学习目的下载NGUI 2.7试试：<br><a target="_blank" rel="noopener" href="http://forum.unity3d.com/threads/ngui-free-edition.124032/">NGUI 2.7 Download</a><br>一下学习都是基于NGUI 2.7版本学习的，新的版本特性这里没有涉及到。</p>
<h3 id="Tutorials"><a href="#Tutorials" class="headerlink" title="Tutorials"></a>Tutorials</h3><p><a target="_blank" rel="noopener" href="http://www.tasharen.com/?page_id=197">以下学习参考</a></p>
<h4 id="Creating-Your-UI"><a href="#Creating-Your-UI" class="headerlink" title="Creating Your UI"></a>Creating Your UI</h4><p>这里就不再一一讲述步骤了，主要记录一些重要的概念。<br>先来看看我们创建出UI之后的UI层次结构：<br><img src="/img/Unity/NGUIUIHierachy.PNG" alt="NGUIUIHierachy"><br>看看各组成部分的作用：</p>
<ol>
<li>UI Root<br>上面挂载UIRoot Script，这个脚本的主要目的是把所有挂载在UI Root下的object 所在屏幕比例根据屏幕大小变化而变化<br><a target="_blank" rel="noopener" href="http://www.tasharen.com/?page_id=619">When attached to the root object of the UI, it will scale that object by the inverse of the screen’s height, thus maintaining a 1 pixel &#x3D; 1 unit ratio, ensuring pixel-perfect UIs.</a><br>UIStretch – <a target="_blank" rel="noopener" href="http://www.tasharen.com/?page_id=619">This script is capable of stretching the widget relative to the size of the screen (or, if specified — panel or widget size).</a><br>UIStretch是自适应的关键，根据屏幕或特定panel长宽变化去做适应。但后来的NGUI版本好像对自适应这一块做了很大修改，UIStretch貌似不再支持。</li>
<li>Camera<br>上面挂载了UICamera Script，这个脚本的主要目的是”contains NGUI’s event system”，至于消息是如何传递的这里先暂时不管，以后会深入学习。</li>
<li>Anchor<br>上面挂载了UIAnchor Script，这个脚本的主要目的是”apply a half-pixel offset on Windows machines, for pixel-perfect results.”(把UI限定在窗口特定位置，当窗口变化的时候会依然处于相对窗口的位置)</li>
<li>Panel<br>上面挂载了UIPanel，这个脚本的主要目的是”container that will collect all UI widgets under it and will combine them into as few draw calls as possible.”(这里相当于UI的管理容器，负责以最少的draw call去管理UI)</li>
</ol>
<h4 id="Sprite"><a href="#Sprite" class="headerlink" title="Sprite"></a>Sprite</h4><p>创建了UI，那么接下来就是增加我们的UI组件。<br>通过Widget Tool可以创建一系列不同类型的组件，这里有两个概念比较重要。<br>Atlas(图集) – Atlas好比我们的图片库，因为组件会需要选择图案，而Atlas定义了切割好的图集可供选择<br>Font(字体库) – 正如其名，字体库，至于字体库是怎么制作的这里暂时不得而知(待学习)<br>让我们简单看一下创建一个Sprite后的显示面板：<br><img src="/img/Unity/SpriteControlPanel.PNG" alt="SpriteControlPanel"><br>这里Sprite有深度的概念，通过调节Depth我们可以实现层次排序。<br>还值得注意的一点是Sprite有个属性Sprite Type，这里的Sprite Type不仅可以决定Sprite如何显示，还会影响Sprite如何去适应显示区域。</p>
<h5 id="9-Sliced-Sprite"><a href="#9-Sliced-Sprite" class="headerlink" title="9-Sliced Sprite"></a>9-Sliced Sprite</h5><p>Sliced技术会决定如何去拉伸图案去适应显示区域而不至于看起来变形。<br><a target="_blank" rel="noopener" href="http://www.unityrealm.com/unity-9-slice-advantages/">9-Sliced详解</a></p>
<h5 id="Tiled-Sprite"><a href="#Tiled-Sprite" class="headerlink" title="Tiled Sprite"></a>Tiled Sprite</h5><p>Tiled Sprite是用原始sprite大小去铺满显示区域</p>
<p>Note:<br>这里有一个官网说是显示Debug Info的东西，通过把Panel的Debug Info设置成Geometry，场景里会增加一个叫_UIDrawCall的对象。<br><img src="/img/Unity/UIDrawCall.PNG" alt="UIDrawCall"><br>(这里还不太明白是什么，但看起来是把UI更新整合到一个Draw Call里了)</p>
<h4 id="Label"><a href="#Label" class="headerlink" title="Label"></a>Label</h4><p>Lable里的字来源于我们之前选的字库。<br>在Label里填写文本有个比较方便的设定，可以通过[hex color]改变后续文本的颜色e.g. [FF0000]代表红色。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">FF0000</span>]NGUI<span class="string">&#x27;s [FFFFFF]lables can have [00FF00]embedded </span></span><br><span class="line"><span class="string">[0000FF]colors.</span></span><br></pre></td></tr></table></figure>

<p><img src="/img/Unity/LabelFont.PNG" alt="LabelFont"></p>
<h4 id="Button"><a href="#Button" class="headerlink" title="Button"></a>Button</h4><p>当我们添加了Button后，如何响应事件了？<br>“anything with a collider on it will receive all of the events.”</p>
<p>还记得之前说UICamera负责发送所有事件吗？所有在Camera(绑定了UICamera)下的UI都会接受到Event(前提是设置了event发送到UI层)。<br>让我们来看下UICamera的一些public可控变量：<br><img src="/img/Unity/UICameraPanel.PNG" alt="UICameraPanel"><br>让我们关注一些比较重要的点：<br>Event Receive Mask – 控制了接受events的layer层<br>Debug – debug模式下可以让我们看到哪一个game objec<br>t接收到了event<br>Range Distance – 控制raycast的有效范围<br>Scroll Axis Name – 设定横向控制来源<br>Vertical Axis Name – 设定纵向控制来源<br>……</p>
<p>接下来让我们看看UICamera都负责发送哪些事件？(具体可以参见UICamera源码)<br>    OnHover (isOver) is sent when the mouse hovers over a collider or moves away.<br>    OnPress (isDown) is sent when a mouse button gets pressed on the collider.<br>    OnSelect (selected) is sent when a mouse button is first pressed on a game object. Repeated presses on the same object won’t result in a new OnSelect.<br>    OnClick () is sent with the same conditions as OnSelect, with the added check to see if the mouse has not moved much. UICamera.currentTouchID tells you which button was clicked.<br>    OnDoubleClick () is sent when the click happens twice within a fourth of a second. UICamera.currentTouchID tells you which button was clicked.<br>    OnDragStart () is sent to a game object under the touch just before the OnDrag() notifications begin.<br>    OnDrag (delta) is sent to an object that’s being dragged.<br>    OnDragOver (draggedObject) is sent to a game object when another object is dragged over its area.<br>    OnDragOut (draggedObject) is sent to a game object when another object is dragged out of its area.<br>    OnDragEnd () is sent to a dragged object when the drag event finishes.<br>    OnInput (text) is sent when typing (after selecting a collider by clicking on it).<br>    OnTooltip (show) is sent when the mouse hovers over a collider for some time without moving.<br>    OnScroll (float delta) is sent out when the mouse scroll wheel is moved.<br>    OnKey (KeyCode key) is sent when keyboard or controller input is used.</p>
<p>那么知道了发送哪些事件，那么我们如何通过添加的控件去响应事件了？</p>
<ol>
<li>控件要处于Camera(含UICamera脚本)之下</li>
<li>Layer处于UICamera的Event Receiver Mask</li>
<li>接受事件的控件必须包含Collider</li>
<li>自定义响应方法<ol>
<li>定义对应事件响应的方法并挂载到需要响应的Game Object上</li>
</ol>
</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">OnPress</span>(<span class="params"><span class="built_in">bool</span> isPressed</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span>(isPressed)</span><br><span class="line">    &#123;</span><br><span class="line">        Debug.Log(<span class="string">&quot;Exit button is pressed!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        Debug.Log(<span class="string">&quot;Exit button is unpressed!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<pre><code>2. 通过UIListener，直接添加delegate去监听事件
</code></pre>
<p>首先现在需要实现delegate监听事件的控件上添加一个UIListener脚本(Component -&gt; NGUI -&gt; Internal -&gt; Event Listener)。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UIListener Soure Code</span></span><br><span class="line"><span class="comment">//----------------------------------------------</span></span><br><span class="line"><span class="comment">//            NGUI: Next-Gen UI kit</span></span><br><span class="line"><span class="comment">// Copyright © 2011-2013 Tasharen Entertainment</span></span><br><span class="line"><span class="comment">//----------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Event Hook class lets you easily add remote event listener functions to an object.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Example usage: UIEventListener.Get(gameObject).onClick += MyClickFunction;</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"></span><br><span class="line">[<span class="meta">AddComponentMenu(<span class="string">&quot;NGUI/Internal/Event Listener&quot;</span>)</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UIEventListener</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">delegate</span> <span class="keyword">void</span> <span class="title">VoidDelegate</span> (<span class="params">GameObject go</span>)</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">delegate</span> <span class="keyword">void</span> <span class="title">BoolDelegate</span> (<span class="params">GameObject go, <span class="built_in">bool</span> state</span>)</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">delegate</span> <span class="keyword">void</span> <span class="title">FloatDelegate</span> (<span class="params">GameObject go, <span class="built_in">float</span> delta</span>)</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">delegate</span> <span class="keyword">void</span> <span class="title">VectorDelegate</span> (<span class="params">GameObject go, Vector2 delta</span>)</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">delegate</span> <span class="keyword">void</span> <span class="title">StringDelegate</span> (<span class="params">GameObject go, <span class="built_in">string</span> text</span>)</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">delegate</span> <span class="keyword">void</span> <span class="title">ObjectDelegate</span> (<span class="params">GameObject go, GameObject draggedObject</span>)</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">delegate</span> <span class="keyword">void</span> <span class="title">KeyCodeDelegate</span> (<span class="params">GameObject go, KeyCode key</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">object</span> parameter;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> VoidDelegate onSubmit;</span><br><span class="line">    <span class="keyword">public</span> VoidDelegate onClick;</span><br><span class="line">    <span class="keyword">public</span> VoidDelegate onDoubleClick;</span><br><span class="line">    <span class="keyword">public</span> BoolDelegate onHover;</span><br><span class="line">    <span class="keyword">public</span> BoolDelegate onPress;</span><br><span class="line">    <span class="keyword">public</span> BoolDelegate onSelect;</span><br><span class="line">    <span class="keyword">public</span> FloatDelegate onScroll;</span><br><span class="line">    <span class="keyword">public</span> VectorDelegate onDrag;</span><br><span class="line">    <span class="keyword">public</span> ObjectDelegate onDrop;</span><br><span class="line">    <span class="keyword">public</span> StringDelegate onInput;</span><br><span class="line">    <span class="keyword">public</span> KeyCodeDelegate onKey;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">OnSubmit</span> ()</span>                &#123; <span class="keyword">if</span> (onSubmit != <span class="literal">null</span>) onSubmit(gameObject); &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">OnClick</span> ()</span>                 &#123; <span class="keyword">if</span> (onClick != <span class="literal">null</span>) onClick(gameObject); &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">OnDoubleClick</span> ()</span>           &#123; <span class="keyword">if</span> (onDoubleClick != <span class="literal">null</span>) onDoubleClick(gameObject); &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">OnHover</span> (<span class="params"><span class="built_in">bool</span> isOver</span>)</span>      &#123; <span class="keyword">if</span> (onHover != <span class="literal">null</span>) onHover(gameObject, isOver); &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">OnPress</span> (<span class="params"><span class="built_in">bool</span> isPressed</span>)</span>   &#123; <span class="keyword">if</span> (onPress != <span class="literal">null</span>) onPress(gameObject, isPressed); &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">OnSelect</span> (<span class="params"><span class="built_in">bool</span> selected</span>)</span>   &#123; <span class="keyword">if</span> (onSelect != <span class="literal">null</span>) onSelect(gameObject, selected); &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">OnScroll</span> (<span class="params"><span class="built_in">float</span> delta</span>)</span>     &#123; <span class="keyword">if</span> (onScroll != <span class="literal">null</span>) onScroll(gameObject, delta); &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">OnDrag</span> (<span class="params">Vector2 delta</span>)</span>     &#123; <span class="keyword">if</span> (onDrag != <span class="literal">null</span>) onDrag(gameObject, delta); &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">OnDrop</span> (<span class="params">GameObject go</span>)</span>     &#123; <span class="keyword">if</span> (onDrop != <span class="literal">null</span>) onDrop(gameObject, go); &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">OnInput</span> (<span class="params"><span class="built_in">string</span> text</span>)</span>      &#123; <span class="keyword">if</span> (onInput != <span class="literal">null</span>) onInput(gameObject, text); &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">OnKey</span> (<span class="params">KeyCode key</span>)</span>        &#123; <span class="keyword">if</span> (onKey != <span class="literal">null</span>) onKey(gameObject, key); &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Get or add an event listener to the specified game object.</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">public</span> UIEventListener <span class="title">Get</span> (<span class="params">GameObject go</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        UIEventListener listener = go.GetComponent&lt;UIEventListener&gt;();</span><br><span class="line">        <span class="keyword">if</span> (listener == <span class="literal">null</span>) listener = go.AddComponent&lt;UIEventListener&gt;();</span><br><span class="line">        <span class="keyword">return</span> listener;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看出通过UIListener，该控件已经具备了响应UI Event的能力，而且每一个UI Event都定义了对应的delegate，这样一来我们就可以通过动态的添加修改每一个UI event的delegate实现控制UI Event响应了。<br>那么接下来我们只需在任何一个Game Object挂载下列代码就能响应特定控件的特定UI事件了。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">RemoveExitButtonListener</span> : <span class="title">MonoBehaviour</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Use this for initialization</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Start</span> ()</span> &#123;</span><br><span class="line">        GameObject exitbutton = GameObject.Find(<span class="string">&quot;UI Root (2D)/Camera/Anchor/Panel/Exit&quot;</span>);</span><br><span class="line">        <span class="comment">// 这里的回调方法要和delegate签名一致</span></span><br><span class="line">        UIEventListener.Get(exitbutton).onPress = RemoteExitButtonClick;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Update is called once per frame</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Update</span> ()</span> &#123;</span><br><span class="line">    </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">RemoteExitButtonClick</span>(<span class="params">GameObject go, <span class="built_in">bool</span> state</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (state)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.Log(<span class="string">&quot;RemoteExitButtonClick button is pressed!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            Debug.Log(<span class="string">&quot;RemoteExitButtonClick button is unpressed!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/img/Unity/UIEventCall.PNG" alt="UIEventCall"><br>同时NGUI还为Button控制添加了很多可自定义的脚本：</p>
<ol>
<li>UIButton – 自定义控件被点击或处于控件之上等颜色信息</li>
<li>UIButtonScale – 自定义焦点处于控件之上时的scale变换</li>
<li>UIButtonOffset – 自定义控件被点击后的位移</li>
<li>UIButtonSound – 自定义控件被点击时播放的声音</li>
<li>UIButtonMessage – 自定义控件触发事件</li>
<li>UIButtonTween – 自定义控件触发tween</li>
<li>UIButtonPlayAnimation – 自定义控件触发动画</li>
</ol>
<h4 id="Slider"><a href="#Slider" class="headerlink" title="Slider"></a>Slider</h4><p>通过传递接受Slider Event的Game Object，我们可以去对应物体上定义OnSliderChange(float stepvalue)去响应slider事件，这样一来响应了Slider Event的物体就可以根据Slider的拖拽去做对应的事情了。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">DisplayTextListener</span> : <span class="title">MonoBehaviour</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Vector3 m_OriginalPosition;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Use this for initialization</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Start</span> ()</span> &#123;</span><br><span class="line">        <span class="comment">// 这里获取的postion不是世界坐标系的，不知道为什么</span></span><br><span class="line">        m_OriginalPosition = transform.position;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Update is called once per frame</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Update</span> ()</span> &#123;</span><br><span class="line">    </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">OnSliderChange</span>(<span class="params"><span class="built_in">float</span> stepvalue</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Vector3 temp = m_OriginalPosition;</span><br><span class="line">        temp.y *= stepvalue;</span><br><span class="line">        transform.position = temp;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/img/Unity/OnSliderChangeBegin.PNG" alt="OnSliderChangeBegin"><br><img src="/img/Unity/OnSliderChangeEnd.PNG" alt="OnSliderChangeEnd"></p>
<h4 id="Checkbox"><a href="#Checkbox" class="headerlink" title="Checkbox"></a>Checkbox</h4><p>通过把一组Checkbox放到同一个Game Object，然后设定所有UICheckbox的Radio Button Root到同一个Game Object可以实现一组单选按钮。<br>然后通过添加UICheckboxControlledComponent到Checkbox上，我们可以指定当该Checkbox激活或未激活时去enable的Game Object(做到根据Checkbox状态响应)。<br><img src="/img/Unity/CheckBoxWithWrongAnswer.PNG" alt="CheckBoxWithWrongAnswer"><br><img src="/img/Unity/CheckBoxWithCorrectAnswer.PNG" alt="CheckBoxWithCorrectAnswer"></p>
<h4 id="Input"><a href="#Input" class="headerlink" title="Input"></a>Input</h4><p>Label要具有而输入的特性需要确保以下几点：</p>
<ol>
<li>父节点或自身包含Box Collider</li>
<li>父节点或自身包含UIInput Script(所有的Input相关的东西都抽象到这里了e.g. IME，键盘弹出，平台相关输入等)</li>
<li>指定需要增加Input功能的Laybel到UIInput的Laybel属性<br>Note：<br>两者必须都在同一个Game Object上才能起作用，因为UIInput要通过Box Collider去接收OnSelect等事件。</li>
</ol>
<p>NGUI为我们提供了方便的控件类，Input – 直接用于创建可接收输入的Laybel模板<br><img src="/img/Unity/InputUsing.PNG" alt="InputUsing"></p>
<h4 id="3D"><a href="#3D" class="headerlink" title="3D"></a>3D</h4><p>将2D UI变换到3D UI很容易。<br>步骤如下：</p>
<ol>
<li>去掉Anchor，直接把panel挂载在UIRoot(2D)上<br>还记得最初创建NGUI UI的时候Anchor上面挂载的UIAnchor Script的作用吗？因为变换到3D后我们不需要在控制相对窗口的位置，所以不需要UIAnchor了。</li>
<li>设置Camera的投影方式到Perspective(为了3D显示)<br>就这么简单，通过这样设置后，UI就完全当做3D Game Object显示在scene里了。<br><img src="/img/Unity/3DUI.PNG" alt="3DUI"></li>
</ol>
<h4 id="Atlas-Maker"><a href="#Atlas-Maker" class="headerlink" title="Atlas Maker"></a>Atlas Maker</h4><p>声明：后续用到的UI素材来源于COC，仅用于学习目的。<br>首先要知道为什么要使用图集？<br>减少纹理的使用，比如当多个材质只是纹理不同的时候，我们可以合并纹理到一个大的纹理，给材质指定对应的UV坐标即可。另外合并多个小的纹理到大的纹理图集也可以减少Memory使用。详情见<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Texture_atlas">Texture atlas</a>。<br>这一节讲一下图集的制作。</p>
<ol>
<li>准备好所有图片素材(可以通过PS等工具制作)</li>
<li>打开NGUI Atlas Maker<br>NGUI -&gt; Open the Altas Maker</li>
<li>设置一个Atlas名字，点击Create，选中要放到一张图集里的所有纹理图片，然后等Altas Maker切割完成后点击Add&#x2F;Update All<br><img src="/img/Unity/AtlasMaker.PNG" alt="AtlasMaker"><br><img src="/img/Unity/UIAtlas.PNG" alt="UIAtlas"><br>Note:<br>NGUI也支持导入Texture Packer导出的文件<br>NGUI Atlas Maker支持多种图片格式(e.g. PNG, psd……)<br>一旦Sprite导入并生成UI Atlas后，我们可以直接在Atlas Maker里添加并更新该Atlas即可。</li>
</ol>
<h4 id="Font-Maker"><a href="#Font-Maker" class="headerlink" title="Font Maker"></a>Font Maker</h4><p>Font Maker里的字体是由什么制作而来的了？<br>“All fonts are created using the free BMFont program, or the more advanced Glyph Designer.”(NGUI使用的Font是由BMFont program或Glyph Designer制作的)</p>
<p>那么BMFont program又是什么了？<br><a target="_blank" rel="noopener" href="http://www.angelcode.com/products/bmfont/">This program will allow you to generate bitmap fonts from TrueType fonts. The application generates both image files and character descriptions that can be read by a game for easy rendering of fonts.</a>BMFont program通过TrueType fonts生成bitmap fonts(一个是Font的image file文件，一个是描述了每一个字符渲染所需的信息文件))</p>
<p>那么这里提到了两个概念：</p>
<ol>
<li><p>TrueType Font<br><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/TrueType">TrueType is an outline font</a><br><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Computer_font#OUTLINE">Outline fonts (also called vector fonts) use Bézier curves, drawing instructions and mathematical formulae to describe each glyph, which make the character outlines scalable to any size.</a><br>可以看出TrueType是outline font，outline font是一种vector font(可以理解成矢量字体，放大缩小不会出现锯齿和模糊。之所以称作vector font是因为TrueType记录每一个字符的轮廓信息，通过这些信息可以计算出如何绘制字符)<br>以下引用至<a target="_blank" rel="noopener" href="http://computer.howstuffworks.com/question460.htm">What are TrueType fonts?</a><br>TrueType technology actually involves two parts:<br>The TrueType Rasterizer<br>TrueType fonts – “The fonts themselves contain data that describes the outline of each character in the typeface. “</p>
</li>
<li><p>Bitmap Font<br><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Computer_font#OUTLINE">Bitmap fonts consist of a matrix of dots or pixels representing the image of each glyph in each face and size.</a><br>可以看出Bitmap Font是记录的每一个字符的像素和位置等信息。<br>以下引用至<a target="_blank" rel="noopener" href="https://71squared.com/blog/what-is-a-bitmap-font">What is a Bitmap Font?</a><br>A bitmap font is essentially an image file containing a bunch of characters and a control file detailing the size and location of each character within the image. Each character is represented by a number of dots or pixels, rendered in a particular font and size.<br>可以看出Bitmap Font包含两部分：</p>
</li>
<li><p>Image file – 包含了所有文字的纹理图片</p>
</li>
<li><p>Control file – 包含了字体大小，每一个字符所在位置等信息<br>Bitmap Font因为不是outline font(vector font)，所以在字体拉伸变换的时候会出现失真的情况。<br>既然这样我们为什么还要使用Bitmap Font了？<br><a target="_blank" rel="noopener" href="https://71squared.com/blog/what-is-a-bitmap-font">OpenGL itself doesn’t even understand fonts(e.g. vector font), so in order to display text in your game you would need to use whats known as a bitmap font.</a><br>当计算去利用vector font渲染字体的时候，不会失真。但是在游戏里，如果我们还想对vector font做进一步的处理就显得心有余而力不足了。<br><a target="_blank" rel="noopener" href="https://71squared.com/blog/what-is-a-bitmap-font">The major benefit of using bitmap fonts is that each character can be pre-rendered using multiple effects, loaded into OpenGL as a texture, and rendered to the screen using very little resources.</a><br>但Bitmap Font不一样，Bitmap Font存储的就是字体的纹理图片，纹理图片在OpenGL里做额外的效果处理就容易的多了。</p>
</li>
</ol>
<p>说了这么多让我们看看BMFon program是如何制作Bitmap Font的？</p>
<ol>
<li>下载BitMap Font Program<br><a target="_blank" rel="noopener" href="http://www.angelcode.com/products/bmfont/">Bitmap Font Program Download Link</a></li>
<li>通过Font Settings我可以选择我们要导入的ttf字库，是否采用unicode编码等。</li>
<li>然后选中我们要导出的字符集(这里主要选择了英文和中文字符集)<br><img src="/img/Unity/BMFontMakerFontSetting.PNG" alt="BMFontMakerFontSetting"></li>
<li>设置export option，为导出的文件设置相关配置<br><img src="/img/Unity/BMFontExportOptions.PNG" alt="BMFontExportOptions"><br>Note：<br><a target="_blank" rel="noopener" href="http://www.angelcode.com/products/bmfont/doc/export_options.html">If you’re importing colored icons, or planning on using post processing to add colors to the characters, then you’ll want to choose the 32bit format, otherwise the 8bit format may be sufficient.</a><br>官网提到如果要后期再对字符做颜色等处理，需要选择32bit的存储模式(应该是为了能存储颜色信息)<br>同时File Format会决定我们导出的字符集纹理图片和Font descriptor的格式。<br>为了将字符都导出到一张纹理图片我们需要定义合适的Texture Size。</li>
<li>最后点击存储为Bitmap导出字符集(Option -&gt; Save Bitmap Font As)<br>这里就会生成对应的字符集纹理图片和Font Descriptor文件。<br><img src="/img/Unity/MyAtlasFont.PNG" alt="MyAtlasFont"><br>Note:<br>但我发现由于包含了大量中文字符，字符纹理比较大，包括中文和英文就有10M了，如果文字比较多比如做本地化，静态字体(我们这里提前生成字符集纹理就是静态字体)不适合。</li>
</ol>
<p>NGUI支持动态字体的生成：<br>让我们先看看什么是动态字体？<br>“When you set the Characters drop-down in the Import Settings to Dynamic, Unity will not pre-generate a texture with all font characters. Instead, it will use the FreeType font rendering engine to create the texture on the fly.”(<a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/class-Font.html">https://docs.unity3d.com/Manual/class-Font.html</a>)<br>可以看出动态字体不需提前生成字符集纹理，而是通过导入的ttf动态的在游戏里生成对应字体纹理。这样做的好处就是减少了像静态字体这样的纹理内存开销，我们只需指定使用哪些ttf并确保用户包含了该ttf就能正确显示所有语言。<br>个人认为动态字体是本地化的一个解决方案。<br>动态字体直接从ttf文件生成。<br><img src="/img/Unity/DynamicFont.PNG" alt="DynamicFont"><br>Note:<br>值得注意的是动态字体下写的那个警告”Please note that dynamic fonts can’t be made a part of an atlas, and they will always be draw in a speparate draw call. You will need to adjust transform position’s Z rather than depth.”<br>使用动态字体后会增加一个draw call，而且动态字体的深度不再是有depth来控制而是z值。</p>
<p>Bitmap Font制作好了，那么接下来我就应该用制作好的Bitmap Font去通过Font Maker制作我们的字符集(Atlas)了。</p>
<ol>
<li>打开Font Maker</li>
<li>选定我们刚才制作的Font Texture和Font Descriptor作为输入，指定生成的字符集名字</li>
<li>点击创建<br><img src="/img/Unity/FontMakerProcess.PNG" alt="FontMakerProcess"></li>
</ol>
<p>这里看一下用自己制作的字体集和UI图片集做的登陆界面：<br><img src="/img/Unity/LoginScene.PNG" alt="LoginScene"></p>
<h4 id="NGUI-2-7屏幕自适应"><a href="#NGUI-2-7屏幕自适应" class="headerlink" title="NGUI 2.7屏幕自适应"></a>NGUI 2.7屏幕自适应</h4><p>下文主要参考：<br><a target="_blank" rel="noopener" href="http://dsqiu.iteye.com/blog/1964679">NGUI所见即所得之UIRoot</a><br><a target="_blank" rel="noopener" href="http://www.cnblogs.com/cqgreen/p/3348154.html">Unity3d + NGUI 的多分辨率适配</a><br><a target="_blank" rel="noopener" href="http://blog.csdn.net/onerain88/article/details/11713299">Unity3D开发（一）：NGUI之UIRoot屏幕分辨率自适应 </a><br><a target="_blank" rel="noopener" href="http://www.xuanyusong.com/archives/2536">NGUI研究院之自适应屏幕（十）</a><br><a target="_blank" rel="noopener" href="http://www.cnblogs.com/cqgreen/p/3348154.html">Unity3d + NGUI 的多分辨率适配</a><br>屏幕自适应是UI在所难免会遇到的问题。<br>那么为什么需要做屏幕自适应了？<br>美术在做UI的时候，程序需要确定我们资源的最基本的分辨率，比如我们是基于1024 * 768（1.3333比例）。<br>在屏幕分辨率为1024 * 768(1.333比例)的时候完美显示如下：<br><img src="/img/Unity/1024Multiple768.PNG" alt="1024Multiple768"><br>当我们把屏幕分辨率设置成800 * 800(1.0比例)的时候显示如下：<br><img src="/img/Unity/800Multiple800.PNG" alt="800Multiple800"><br>当我们把屏幕分辨率设置成960 * 640(1.5比例)的时候显示如下：<br><img src="/img/Unity/960Multiple640.PNG" alt="960Multiple640"><br>Note:<br>UIRoot的Manual Height设置为768，Scaling Stype为FixedSize(后续会讲到UIRoot的缩放自适应原理)<br>从上面可以看出当分辨率比例降低的时候，会出现图像显示不全，这是因为NGUI是基于高度去缩放的。(后续会详细讲解)<br>所以当比例从1.33变到1.0的时候，768&#x2F;800&#x3D;0.96的缩放比例，宽度应该是1024&#x2F;0.96&#x3D;1066.66大于800这也就是为什么会出现图像显示不全的原因了。<br>再来看看从1.33变到1.5的时候，同理768&#x2F;640&#x3D;1.2缩放比例，宽度应该是1024&#x2F;1.2&#x3D;853.33小于960这也就是为什么会出现宽度铺不满的情况。<br>所以在这个时候为了不去做多套不同分辨率的资源去适应各种分辨率的机型，我们需要使用NGUII里的自适应。<br>当下移动设备的主流分辨率，数据来源<a target="_blank" rel="noopener" href="http://djt.qq.com/article/view/399">腾讯分析移动设备屏幕分辨率分析报告</a>：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">iOS设备的分辨率主要有：</span><br><span class="line">宽　  高   宽高比</span><br><span class="line"><span class="number">960</span>     <span class="number">640</span>     <span class="number">1.5</span></span><br><span class="line"><span class="number">1136</span>    <span class="number">640</span>     <span class="number">1.775</span></span><br><span class="line"><span class="number">1024</span>    <span class="number">768</span>     <span class="number">1.3333</span></span><br><span class="line"><span class="number">2048</span>    <span class="number">1536</span>    <span class="number">1.3333</span></span><br><span class="line"> </span><br><span class="line">Android设备的分辨率则相对纷杂，主流的分辨率有：</span><br><span class="line">宽   高   宽高比</span><br><span class="line"><span class="number">800</span>     <span class="number">480</span>     <span class="number">1.6667</span></span><br><span class="line"><span class="number">854</span>     <span class="number">480</span>     <span class="number">1.7792</span></span><br><span class="line"><span class="number">1280</span>    <span class="number">720</span>     <span class="number">1.7778</span></span><br><span class="line"><span class="number">960</span>     <span class="number">540</span>     <span class="number">1.7778</span></span><br><span class="line"><span class="number">1280</span>    <span class="number">800</span>     <span class="number">1.6</span></span><br><span class="line"><span class="number">960</span>     <span class="number">640</span>     <span class="number">1.5</span></span><br><span class="line"><span class="number">1184</span>    <span class="number">720</span>     <span class="number">1.6444</span></span><br><span class="line"><span class="number">1920</span>    <span class="number">1080</span>    <span class="number">1.7778</span></span><br></pre></td></tr></table></figure>

<p>那么让我们进入正题，NGUI是如何实现屏幕自适应的了？<br>这里有三个最重要的脚本需要学习：</p>
<ol>
<li>UIRoot</li>
<li>UIStretch</li>
<li>Anchor<br>让我们先来看看UIRoot的界面：<br><img src="/img/Unity/UIRootPanel.PNG" alt="UIRootPanel"><br>还记得之前提到UIRoot的功能吗？<br><a target="_blank" rel="noopener" href="http://www.tasharen.com/?page_id=185">This script rescales the object it’s on to be 2&#x2F;ScreenHeight in size, letting you specify widget coordinates in pixels and still have them be relatively small when compared to the rest of your game world.</a><br>可以看出UIRoot通过scale UIRoot到2&#x2F;ScreenHeight比例后，使得所有控件的坐标与像素一一对应。那么为什么这样能实现控件坐标与像素一一对应了？这个问题后面会讲到。<br>让我们先分别看看具体参数的含义:<br>Scaling Style</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="built_in">enum</span> Scaling</span><br><span class="line">&#123;</span><br><span class="line">    PixelPerfect,</span><br><span class="line">    FixedSize,</span><br><span class="line">    FixedSizeOnMobiles,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>而已看出NGUI 2.7给我们提供了3种scale方式。<br>那么三种方式是如何起作用的了？</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="built_in">int</span> activeHeight</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">get</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">int</span> height = Mathf.Max(<span class="number">2</span>, Screen.height);</span><br><span class="line">        <span class="keyword">if</span> (scalingStyle == Scaling.FixedSize) <span class="keyword">return</span> manualHeight;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> UNITY_IPHONE || UNITY_ANDROID</span></span><br><span class="line">        <span class="keyword">if</span> (scalingStyle == Scaling.FixedSizeOnMobiles)</span><br><span class="line">            <span class="keyword">return</span> manualHeight;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        <span class="keyword">if</span> (height &lt; minimumHeight) <span class="keyword">return</span> minimumHeight;</span><br><span class="line">        <span class="keyword">if</span> (height &gt; maximumHeight) <span class="keyword">return</span> maximumHeight;</span><br><span class="line">        <span class="keyword">return</span> height;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Update</span> ()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (mTrans != <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">float</span> calcActiveHeight = activeHeight;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (calcActiveHeight &gt; <span class="number">0f</span> )</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">float</span> size = <span class="number">2f</span> / calcActiveHeight;</span><br><span class="line">            </span><br><span class="line">            Vector3 ls = mTrans.localScale;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!(Mathf.Abs(ls.x - size) &lt;= <span class="built_in">float</span>.Epsilon) ||</span><br><span class="line">                !(Mathf.Abs(ls.y - size) &lt;= <span class="built_in">float</span>.Epsilon) ||</span><br><span class="line">                !(Mathf.Abs(ls.z - size) &lt;= <span class="built_in">float</span>.Epsilon))</span><br><span class="line">            &#123;</span><br><span class="line">                mTrans.localScale = <span class="keyword">new</span> Vector3(size, size, size);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从上面可以看出PixelPerfect，FixedSize(FixedSizeOnMobile是移动平台的FixedSize设置)主要是缩放标准的选取。<br>当设置为PixelPerfect的时候会根据ScreenHeight与minmumHeight和maxmumHeight的比较来决定是以ScreenHeight为基准按2&#x2F;ScreenHeight比例缩放还是2&#x2F;minmumHeight or 2&#x2F;maxmumHeight为比例缩放。<br>当设置FixedSize的时候只根据我们设定的manualHeight作为参考标准去缩放UIRoot，缩放比例为2&#x2F;manualHeight。<br>根据缩放标准的选取去设定UIRoot localScale的值以实现UI缩放。<br>那么这里就有个疑问，为什么是2&#x2F;manualHeight而不是1&#x2F;manualHeight了？<br>要明白2这个常数的含义，我们先要看看Camera设定为Orthographic类型中的Orthographic Size的含义。<br><a target="_blank" rel="noopener" href="https://docs.unity3d.com/ScriptReference/Camera-orthographicSize.html">Camera’s half-size when in orthographic mode. This is half of the vertical size of the viewing volume. Horizontal viewing size varies depending on viewport’s aspect ratio. Orthographic size is ignored when camera is not orthographic (see orthographic). See Also: camera component.</a><br>可以看出Orthographic Size是指摄像机所观察垂直区域的一半。(前提是设置了orthographic camera)。如果Size设置为1，那么Camera所看到的高度为2 Unit。摄像机所看到的垂直区域一半也就是屏幕高度的一半,Orthographic Size所指示的1个Unit的高度为Screen.Height&#x2F;2。(结合Orthographic Size和Pixel Per Unit设置，我们可以实现Sprite的Pixels Perfect显示)<br><a target="_blank" rel="noopener" href="http://dsqiu.iteye.com/blog/1964679">如果屏幕高度为1000个像素，Size设置的值为1表示1000&#x2F;2&#x3D;500个像素。所以，我们通过整个关系计算UIRoot下的GameObject的实际对应屏幕的高度：从GameObject向上一直到UIRoot，将它们的loaclScal相乘得到的乘积除以Size乘以屏幕高度的一半，即（localScale*….localScale)&#x2F;Size*Screen.height&#x2F;2。</a><br>如果屏幕分辨率为1024 * 768，那么如果我们把Size设置为1，那么1 Unit就对应屏幕分辩率高度的一半即384，也就是说UIRoot下Gameobject实际对应屏幕的高度应该按照384来计算即Screen.height&#x2F;2来计算，因为Size的大小会使物体所占比例成倍缩小，所以我们还需要除以Size。<br>最终得出UIRoot下GameObject的实际对应屏幕的高度计算如下：<br>(localScale *…….*localScale)<em>Screen.height&#x2F;2&#x2F;Size<br>(这也就是为什么UIRoot缩放比例是2&#x2F;manuaHeight里常数为2的原因，这样一来localScale的值就和屏幕所占比例一一对应了(前提是Size为1))<br><a target="_blank" rel="noopener" href="http://dsqiu.iteye.com/blog/1964679">这可以解释UIRoot的localStyle为啥都是很小的小数，因为这样可以保证UIRoot的子节点都可以以原来的大小作为localScale，比如一张图片是20*20的，我们可以直接设置localScale为（20,20,1）不用进行换算，直观方便。（NGUI3.0（or 2.7)以后的版本已经不再使用localScale来表示UISprite ，UILable（UIWidget的子类）的大小了，而是在UIWidget的width和height来设置，这样做的好处就是一个gameObject节点可以挂多个UISprite或UILabel了，而不会受localScale的冲突影响    2013&#x2F;11&#x2F;16增补）。</a><br>这样一来控件坐标与像素一一对应了。这也就是为什么在缩放UIRoot的时候采用2f &#x2F; calcActiveHeight的原因。<br>那么如何让我们的制作的Sprite的像素完美一一对应显示在屏幕上了？<br>我们知道了屏幕分辨率为1024</em>768且Orthographic Size设置为1时，1个Unit对应的高度是384，那么也就是说要想让Sprite像素完美一一对应屏幕显示，我们要确保Sprite的Pixel Per Unit设定为Screen.height&#x2F;2&#x2F;Size。<br>之前提到当我们的常数是2来除以Screen.height的时候需要把Camera的Orthographic Size设置成1才能实现控件坐标与像素的一一对应，让我们看看UIRoot的源码：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Start</span> ()</span>  </span><br><span class="line">&#123;  </span><br><span class="line">    UIOrthoCamera oc = GetComponentInChildren&lt;UIOrthoCamera&gt;();  </span><br><span class="line">    <span class="keyword">if</span> (oc != <span class="literal">null</span>)  </span><br><span class="line">    &#123;  </span><br><span class="line">        Debug.LogWarning(<span class="string">&quot;UIRoot should not be active at the same time as UIOrthoCamera. Disabling UIOrthoCamera.&quot;</span>, oc);  </span><br><span class="line">        Camera cam = oc.gameObject.GetComponent&lt;Camera&gt;();  </span><br><span class="line">        oc.enabled = <span class="literal">false</span>;  </span><br><span class="line">        <span class="keyword">if</span> (cam != <span class="literal">null</span>) cam.orthographicSize = <span class="number">1f</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">else</span> Update();  </span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>

<p>看得出NGUI并没有为我们强制设置为1，只是警告我们不能把UIRoot和UIOrthoCamera一起使用，如果使用了会自动剔除UIOrthoCamera，并设置orthographicSize为1。我们可以去设置orthographicSize实现不同的效果。<br>了解了UIRoot的实现，那么回到我们原始的话题，如何通过UIRoot实现屏幕自适应了？<br>当屏幕分辨率变化的时候UIRoot下的UI会出现显示不全或者两边有黑边的问题，因为FixedSize结合Manual Height而已控制UIRoot的按比例缩放，所以我们只需把两边未能显示全的UI以宽为基准按比例缩放即可(通过动态计算Manual Height的值)。<br><a target="_blank" rel="noopener" href="http://www.ceeger.com/forum/read.php?tid=9230&ds=1">UIRoot分辨率自适应代码</a><br>ManualWidth和ManualHeight是我们最初美术设计所针对的分辨率，修改到对应的即可。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UIRootExtend</span> : <span class="title">MonoBehaviour</span> &#123;</span><br><span class="line">      </span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> ManualWidth = <span class="number">640</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> ManualHeight = <span class="number">960</span>;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">private</span> UIRoot _UIRoot;</span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Awake</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        _UIRoot = <span class="keyword">this</span>.GetComponent&lt;UIRoot&gt;();</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">FixedUpdate</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (System.Convert.ToSingle(Screen.height) / Screen.width &gt; System.Convert.ToSingle(ManualHeight) / ManualWidth)</span><br><span class="line">            _UIRoot.manualHeight = Mathf.RoundToInt(System.Convert.ToSingle(ManualWidth) / Screen.width * Screen.height);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            _UIRoot.manualHeight = ManualHeight;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>自适应后在屏幕分辨率为1024<em>768(1.333比例)的时候完美显示如下：<br><img src="/img/Unity/1024Multiple768SelfAdaption.PNG" alt="1024Multiple768SelfAdaption"><br>自适应后在屏幕分辨率为800</em>800(1.0比例)的时候显示如下：<br><img src="/img/Unity/800Multiple800SelfAdaption.PNG" alt="800Multiple800SelfAdaption"><br>自适应后在屏幕分辨率设置为960*640(1.5比例)的时候显示如下：<br><img src="/img/Unity/960Multiple640SelfAdaption.PNG" alt="960Multiple640SelfAdaption"><br>这样一来就实现了保持比例自适应。因为UIRoot是基于高度来缩放的，所以在低分辨率变到高分辨率的时候会出现左右黑边，这在横版游戏里是肯定不行的，所以我们需要做到以宽为基准的自适应。<br>那么基于宽度缩放的代码如下：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="built_in">int</span> activeHeight</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">get</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">int</span> height = Mathf.Max(<span class="number">2</span>, Screen.height);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Base on width instead of height</span></span><br><span class="line">        manualHeight = Screen.height * UIRootExtend.ManualWidth / Screen.width;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (scalingStyle == Scaling.FixedSize) <span class="keyword">return</span> manualHeight;</span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="keyword">if</span> UNITY_IPHONE || UNITY_ANDROID</span></span><br><span class="line">        <span class="keyword">if</span> (scalingStyle == Scaling.FixedSizeOnMobiles)</span><br><span class="line">            <span class="keyword">return</span> manualHeight;</span><br><span class="line">        <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        <span class="keyword">if</span> (height &lt; minimumHeight) <span class="keyword">return</span> minimumHeight;</span><br><span class="line">        <span class="keyword">if</span> (height &gt; maximumHeight) <span class="keyword">return</span> maximumHeight;</span><br><span class="line">        <span class="keyword">return</span> height;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但上述在低分辨率变到高分辨率的时候会因为以宽为基准导致高度的自适应超出范围，见下图：<br><img src="/img/Unity/960Multiple640BaseOnWidth.PNG" alt="960Multiple640BaseOnWidth"><br>这种情况只能通过拉伸背景来铺满屏幕，但会失去原始比例(UIStretch可以实现基于屏幕或容器的自适应，不建议使用，后续NGUI都放弃了)。<br>我们肯定不希望我们的主要的UI都被拉伸变形，所以这里需要提到的是UIAnchor，<br>让我们在回忆下UIAnchor的作用：<br>“apply a half-pixel offset on Windows machines, for pixel-perfect results.”(把UI限定在窗口特定位置，当窗口变化的时候会依然处于相对窗口的位置)<br>待续……</p>
<p>关于UI制作尺寸的选择以及UI自适应相关设置：<br>前面的学习结合<a href="">Unity Unit Pixel Per Unit</a>的学习，可以看出，UI自适应和Pixel显示我們需要考虑的点有以下几个:<br>UI需要考虑的点：</p>
<ol>
<li>Canvas Render Mode(Canvas) – Screen Space Camera(一般来说不是作为3D UI摄像机的话，都会选择Screen Space Camera去自己指定一個UI Camera)</li>
<li>UI Scale Mode(Canvas Scaler) – Scale With Screen Size(一般来说为了根据不同设备分辨率进行自适应，我們都会选择这种模式(跟物理size无关))</li>
<li>Project(Camera) – 不是用于3D UI的话，一般来说UI Camera都是设置成Orthographic(正交投影)</li>
<li>Screen Match Mode(Canvas Scaler) – 一般都选择Match Width Or Height指定是以宽为主还是以高为主(影响最终黑边情况 – 是上下黑边还是左右黑边)</li>
<li>Reference Size(Canvas Scaler) – 影响不同机器上的自适应情况(分辨率降低或者升高会影响自适应结果 – 比如居中满屏显示的UI，以高分辨Reference Size在低分辨率Screen Size上以高度自适应会导致左右两侧的UI超出显示范围)(主流手机分辨率比例都在1.333 - 1.778，大部分是1.778)</li>
<li>UI Anchors – 主要影響UI的自適應佈局方式(是自适应缩放还是相对位置)</li>
</ol>
<p>Note:<br>横版2D和竖版2D游戏选择时，主要要考虑Screen Match Mode和Reference Size的选择，因为前者是不允许左右黑边，后者是不允许上下黑边的，两者同时也不允许超出的情况，所以个人认为横版2D应该选择Match Width Or Height值为0(以宽为主不让左右有黑边)，同时Reference Size选择高分辨率，在低分辨率机器上显示时不至于超出高度(只是上下有黑边，这个问题可以通过用背景结合UI Anchors自适应的方式避免)。普通的2D UI，我们最主要要考虑的是Refrence Size的选择(选择高分辨率Reference Size和以宽度为基准自适应，然后结合UI Anchor<br>s布局和拉升背景即可)，这样居中的物体不会被切割显示不全，在低分辨率Screen Size上只是显示高度缩小而已，UI Anchor靠边布局的UI依然正常显示。</p>
<p>Pixel Perfect显示考虑的点：</p>
<ol>
<li>Reference Size(Canvas Scaler) – 我们作为基准计算PPU的分辨率</li>
<li>Orthographic Size(Camera) – 参与Pixel Perfect显示计算，同时把屏幕划分成Orthographci Size * 2个高Unit</li>
<li>Reference Pixels Per Unit(Canvas Scaler) – 参与SpriteRectSize显示计算的参数(SpriteRectSize &#x3D; SpriteSize * SpritePPU &#x2F; CanvaReferencePPU)，一般设置跟Sprite PPU一样保证Sprite按原始大小显示即可</li>
<li>Pixels Per Unit(Asset) – Asset相对一个屏幕Unit显示的Pixels，用于确保Asset Pixel Perfect显示</li>
</ol>
<p>Pixel Perfect显示公式：<br>Orthographic Size &#x3D; Screen.height &#x2F; 2 &#x2F; PPU;<br>从前面的学习我们知道了，要想Pixel Perfect显示，除了动态修正Orthographic Size以外就是针对不同分辨率机器做多套PPU的资源去使用。<br>如果想Pixel Perfect显示，那么UI尺寸的选择就要参考计算出的PPU来设计。</p>
<h2 id="DOTween"><a href="#DOTween" class="headerlink" title="DOTween"></a>DOTween</h2><h3 id="DOTween-Instroduction"><a href="#DOTween-Instroduction" class="headerlink" title="DOTween Instroduction"></a>DOTween Instroduction</h3><p><a target="_blank" rel="noopener" href="http://dotween.demigiant.com/">DOTween is a fast, efficient, fully type-safe object-oriented animation engine for Unity, optimized for C# users, free and open-source, with tons of advanced features</a></p>
<p>简单看一下官网提到的Features(这里只Copy一部分)：<br>Speed and efficiency:<br>    Not only very fast, but also very efficient: everything is cached and reused to avoid useless GC allocations.<br>Shortcuts:<br>    Shortcut extensions that directly extend common objects<br>Extremely accurate:<br>    Time is calculated in a very precise way. This means that 1000 loops of 1 second each will play exactly as long as a single loop of 1000 seconds.<br>Animate everything (almost)<br>    DOTween can animate every numeric value and also some non-numeric ones. It can even animate strings, with support for rich-text.<br>Full control<br>    Play, Pause, Rewind, Restart, Complete, Goto and tons of other useful methods to control your tweens.<br>Grouping<br>    Combine tweens into Sequences to create complex animations (which don’t need to be in a, uh, sequence: they can also overlap each other).<br>Blendable tweens<br>    Some tweens can blend between each other in realtime, thanks to powerful DOBlendable shortcuts.<br>Paths<br>    Animate stuff along both linear and curved paths, with additional options for the orientation of your traveling agents.<br>Change values and duration while playing<br>    Change a tween’s start&#x2F;end values or duration at any moment, even while playing.<br>Yield for coroutines<br>    Various “WaitFor…” methods to use inside coroutines, that allow you to wait for a tween to be completed, killed, started, or for it to reach a given position or loops.<br>Plugins<br>    DOTween is built with an extensible architecture in mind, which allows you to create your own tween plugins as separate files.<br>Extras<br>    Extra virtual methods to do stuff like calling a function after a given delay.<br>…….<br>总的来说DOTween可以满足我们做动画的任何要求且高效快速方便使用。</p>
<h3 id="DOTween-Install"><a href="#DOTween-Install" class="headerlink" title="DOTween Install"></a>DOTween Install</h3><p>看得出DOTween的定位是一个动画引擎。<br>首先是<a target="_blank" rel="noopener" href="http://dotween.demigiant.com/download.php#download">DOTween下载</a><br>其次是DOTween加入到我们的工程项目里(Assets下)，然后DOTween被自动加载。<br>DOTween加载进来后会弹出设置界面：<br><img src="/img/Unity/DOTweenSetting.PNG" alt="DOTweenSetting"><br>点击Setup DOTween进行设置，设置DOTween好使DOTween根据我们的Unity版本去导入一些特定库。<br>接下来我们就可以使用DOTween里的库函数做动画了。</p>
<h3 id="DOTween-Nomenclature-and-Prefixes"><a href="#DOTween-Nomenclature-and-Prefixes" class="headerlink" title="DOTween Nomenclature and Prefixes"></a>DOTween Nomenclature and Prefixes</h3><p>深入学习DOTween之前，让我们先了解下DOTween里的命名方式和一些关键术语：<br>以下学习源于<a target="_blank" rel="noopener" href="http://dotween.demigiant.com/documentation.php#globalSettings">DOTween官网</a><br><strong>Nomenclature</strong>:<br><em>Tweener</em> – A tween that takes control of a value and animates it.(Tweener是控制动画细节参数和播放的)<br><em>Sequence</em> – A special tween that, instead of taking control of a value, takes control of other tweens and animates them as a group.(Sequence可以理解成负责对tweens进行动画而非对属性比如position做动画)<br><em>Tween</em> – A generic word that indicates both a Tweener and a Sequence.<br><em>Nested tween</em> – A tween contained inside a Sequence.</p>
<p><strong>Prefixes</strong>:<br><em>DO</em> – Prefix for all tween shortcuts (operations that can be started directly from a known object, like a transform or a material). Also the prefix of the main DOTween class.</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">transform.DOMoveX(<span class="number">100</span>, <span class="number">1</span>);</span><br><span class="line">transform.DORestart();</span><br><span class="line">DOTween.Play();</span><br></pre></td></tr></table></figure>

<p><em>Set</em> – Prefix for all settings that can be chained to a tween (except for From, since it’s applied as a setting but is not really a setting).(tween的setting函数)</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">myTween.SetLoops(<span class="number">4</span>, LoopType.Yoyo).SetSpeedBased();</span><br></pre></td></tr></table></figure>

<p><em>On</em> – Prefix for all callbacks that can be chained to a tween.(tween的一些回调设定函数)</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">myTween.OnStart(myStartFunction).OnComplete(myCompleteFunction);</span><br></pre></td></tr></table></figure>

<h3 id="DOTween使用学习"><a href="#DOTween使用学习" class="headerlink" title="DOTween使用学习"></a>DOTween使用学习</h3><p>在使用DOTween之前，我们需要在项目添加命名空间并对DOTween的初始化(初始化这一步不是必须的，不手动初始化也会自动初始化，官网推荐手动初始化设定)：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> DG.Tweening;</span><br><span class="line"></span><br><span class="line">DOTween.Init();</span><br></pre></td></tr></table></figure>

<p>让我们来看看DOTween里的函数定义：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Tweener <span class="title">DOMove</span>(<span class="params"><span class="keyword">this</span> Transform target, Vector3 endValue, <span class="built_in">float</span> duration, <span class="built_in">bool</span> snapping = <span class="literal">false</span></span>)</span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Sequence <span class="title">DOJump</span>(<span class="params"><span class="keyword">this</span> Transform target, Vector3 endValue, <span class="built_in">float</span> jumpPower, <span class="built_in">int</span> numJumps, <span class="built_in">float</span> duration, <span class="built_in">bool</span> snapping = <span class="literal">false</span></span>)</span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">int</span> <span class="title">DOKill</span>(<span class="params"><span class="keyword">this</span> Component target, <span class="built_in">bool</span> complete = <span class="literal">false</span></span>)</span>;</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<p>可以看出DOTween里面的大量方法都是通过C#里extend method的方式添加进去的。<br>所以我们要使用特定DOTween方法，我只需要在对应类的实例调用扩展方法即可。<br>接下来看看我们如何创建自定义的Tween。<br>有三中方式可供选择：</p>
<ol>
<li>The generic way<br>DOTween.TO(getter, setter, to float duration)<br>Changes the given property from its current value to the given one.<br>getter A delegate that returns the value of the property to tween. Can be written as a lambda like this: ()&#x3D;&gt; myValue<br>where myValue is the name of the property to tween.<br>setter A delegate that sets the value of the property to tween. Can be written as a lambda like this: x&#x3D;&gt; myValue &#x3D; x<br>where myValue is the name of the property to tween.<br>to The end value to reach.<br>duration The duration of the tween.</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Tween a Vector3 called myVector to 3,4,8 in 1 second</span></span><br><span class="line">DOTween.To(()=&gt; myVector, x=&gt; myVector = x, <span class="keyword">new</span> Vector3(<span class="number">3</span>,<span class="number">4</span>,<span class="number">8</span>), <span class="number">1</span>);</span><br><span class="line"><span class="comment">// Tween a float called myFloat to 52 in 1 second</span></span><br><span class="line">DOTween.To(()=&gt; myFloat, x=&gt; myFloat = x, <span class="number">52</span>, <span class="number">1</span>);</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>The shortcuts way(Extension method)</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">transform.DOMove(<span class="keyword">new</span> Vector3(<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>), <span class="number">1</span>);</span><br></pre></td></tr></table></figure>

<pre><code>在shortcuts方法后面调用From()的话，就会初始位置当做dest，把dest当做初始绘制来做动画。
</code></pre>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">transform.DOMove(<span class="keyword">new</span> Vector3(<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>), <span class="number">1</span>).From();</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>Additional generic ways<br>这种没太看明白</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> DOTween.Punch(getter, setter, Vector3 direction, <span class="built_in">float</span> duration, <span class="built_in">int</span> vibrato, <span class="built_in">float</span> elasticity)</span><br><span class="line"><span class="keyword">static</span> DOTween.Shake(getter, setter, <span class="built_in">float</span> duration, <span class="built_in">float</span>/Vector3 strength, <span class="built_in">int</span> vibrato, <span class="built_in">float</span> randomness, <span class="built_in">bool</span> ignoreZAxis)</span><br><span class="line"><span class="keyword">static</span> DOTween.ToAlpha(getter, setter, <span class="built_in">float</span> to, <span class="built_in">float</span> duration)</span><br><span class="line"><span class="keyword">static</span> DOTween.ToArray(getter, setter, <span class="built_in">float</span> to, <span class="built_in">float</span> duration)</span><br><span class="line"><span class="keyword">static</span> DOTween.ToAxis(getter, setter, <span class="built_in">float</span> to, <span class="built_in">float</span> duration, AxisConstraint axis)</span><br></pre></td></tr></table></figure>

<p>貌似是会对Tween做特殊的限制，比如DOTween.Shake延axis轴变化vector3。</p>
<p>接下来让我们看看如何使用Sequence：<br>The sequenced tweens don’t have to be one after each other. You can overlap tweens with the Insert method.(sequence可包含其他sequence，可以通过Insert把tween插入到特定时间执行)<br>A tween (Sequence or Tweener) can be nested only inside a single other Sequence, meaning you can’t reuse the same tween in multiple Sequences. (同一个tween不能被多个sequence使用)<br>创建一个Sequence:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DOTween.Sequence();</span><br></pre></td></tr></table></figure>

<p>我们可以通过添加tweens，callback到sequence里去做一些特别的动画。<br>Note:<br>“ all these methods need to be applied before the Sequence starts (usually the next frame after you create it, unless it’s paused), or they won’t have any effect.”(添加tweens，callback这些都必须在Sequence开始之前，可以理解为同一帧里)</p>
<p>接下来我们看看Tween的一些设置：<br>这些设置分为针对全局，tweens，sequence，tweener设置。<br>举个简单的例子，比如我们在初始化DOTween的时候设置了tween在同一时刻激活的最大数量。我超过这个数量后想要修改，我们可以通过:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DOTween.SetTweensCapacity(***);</span><br></pre></td></tr></table></figure>

<p>上述这个方法就是针对全局设置的</p>
<p>接下来我们看看如何动态的控制tween动画的：<br>有三种方式：</p>
<ol>
<li>Via Static methods and filters<br>DOTween class给我们提供了大量的静态方法去控制tween动画。<br>比如我们想暂停某个tween动画或暂停所有tween：</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">DOTween.Pause(tweenname);</span><br><span class="line">DOTween.PauseAll();</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>Directly from the tween<br>我们也可以通过保存的tween动画引用去调用控制相关的动画</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">myTween.Pause();</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>From a shortcut-enhanced reference<br>直接通过扩展方法去停止对应的物体上的tween(这里要注意的是，所有控制tween的扩展方法都带DO前缀)</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">transfrom.DOPause();</span><br></pre></td></tr></table></figure>

<p>Note:<br>“IMPORTANT: remember that to use these methods on a tween after it has ended, you have to disable its autoKill behaviour, otherwise a tween is automatically killed at completion.”(对tween设置的时候一定要disable automatically kill，否则在tween完成的时候tween会被销毁)<br>同时DOTween还给我们提供了很多静态方法去获取tween的信息(比如Delay(),Duration()等)</p>
<p>Tween结合Coroutines的使用：<br>Tween提供了一些YieldInstructions的方法，可以让我们结合Coroutines去方便快速的实现一些对调用时机有讲究的动画:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 需要等到tween结束</span></span><br><span class="line"><span class="function">IEnumerator <span class="title">SomeCoroutine</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    Tween myTween = transform.DOMoveX(<span class="number">45</span>, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">yield</span> <span class="keyword">return</span> myTween.WaitForCompletion();</span><br><span class="line">    <span class="comment">// This log will happen after the tween has completed</span></span><br><span class="line">    Debug.Log(<span class="string">&quot;Tween completed!&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>总结：<br>给我的感觉，DOTween是一个基于Unity扩展的强大的数学动画库。<br>通过DOTween我们可以快速的去针对Unity里的一些属性比如位置，材质，UI等做动画，可以说是属于程序员的动画制作工具。</p>
<p><a target="_blank" rel="noopener" href="https://www.codeandweb.com/texturepacker">TexturePacker官网</a></p>
<p>待续……</p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p><a target="_blank" rel="noopener" href="https://www.codeandweb.com/texturepacker">TexturePacker官网</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Plugin/">Plugin</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Plugin/">Plugin</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/10/21/数据结构与算法/" title="数据结构与算法" itemprop="url">数据结构与算法</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Tony Tang" target="_blank" itemprop="author">Tony Tang</a>
		
  <p class="article-time">
    <time datetime="2016-10-21T06:04:40.000Z" itemprop="datePublished"> 发表于 2016-10-21</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>写这一篇文章的目的是出于自己一直以来基础都比较弱，特别是数据结构和算法，但数据结构和算法确实程序里很核心的部分，只有了解各种数据结构和算法的基本思想，才能针对实际问题做出最好的选择，写出最优的程序。工作两年多了，但感觉自己再这方面还是依然原地踏步，了解的一知半解。为了避免多年以后还来学习这些本应该在学校学好的知识，从而有了这一次学习计划。</p>
<p>在看了这位博主的<a target="_blank" rel="noopener" href="http://www.cnblogs.com/figure9/archive/2014/05/05/3708351.html">我的算法学习之路</a>之后，深深的感受到了数据结构和算法的魅力和重要性。虽然不知道自己还能为游戏梦想坚持多久，但当下，制定一个完整的数据结构和算法的学习计划是当务之急。</p>
<p>现在有点理解别人说过的”编程语言只是工具，编程思想，数据结构和算法才是核心。”</p>
<p>以下学习主要是对于数据结构和算法的回顾和进阶学习计划。准备用C++来写。</p>
<p>参考书籍：<br>编程语言：<br>《C++ Primer》Fifth Edition – Stanley B.Lippman Josee Lajoie Barbara E.Moo<br>《Effective C++》Third Edition – Scott Meyers<br>最初学习C++是看的《Thinking in C++》和《Professional C++》，但后来看了部分《C++ Primer》之后觉得，这本书在细节方面讲解的更细致到位。而《Effective C++》是从我们平时容易忽略或错误理解的点，以一条条规则的形式，讲述背后的道理，可以作为C++编程指南。</p>
<p>数据结构和算法：<br>《数据结构与算法 - C语言描述》 – Mark Allen Weiss<br><a target="_blank" rel="noopener" href="http://wenku.baidu.com/link?url=3xIVKWrL5_o5rBlEsr5j-1Es983eN4n00LwX9dyOH41Vm7ErO7RpoyHR389A_FP0O665guNIjbxbLzM7cu38QZlRN1xqIo0XUnfDPCZ6No3">数据结构与算法 - C语言描述课后习题在线答案参考</a><br>《算法设计与分析》 Third Edition – 王晓东<br>《Introduction To Algorithm》(算法导论) Third Edition– Thomas H.Cormen &amp; ……<br><a target="_blank" rel="noopener" href="https://ocw.mit.edu/courses/electrical-engineering-and-computer-science/6-006-introduction-to-algorithms-fall-2011/lecture-videos/">Introduction To Algorithm MIT课程视频</a></p>
<p>前两者是我在大学时候学习的关于数据结构和算法的书籍，作为基础知识回顾来学习。<br>第三个在网络上的评价褒贬不一，但作为国外的优秀教材来使用，可以看出是很有分量的，作为进阶学习书籍。最后一个是麻省理工对于算法导论教材的上课视频可以作为学习《Introduction To Algorithm》的学习资料。</p>
<p>编程艺术和思考：<br>《The Progmatic Programmer》(程序员修炼之道) – Andrew Hunt &amp; David Thomas<br>此书并非将编程技巧而是讲程序员应该如何去思考，如何高效的开发。</p>
<p>STL深入学习：<br>《C++标准程序库》<br>此书虽然比较老，但貌似是C++标准库学习的经典书籍，里面对STL进行基本的讲解学习。<br>《STL源码剖析》<br>此书乃侯捷所著，对于STL进行了深入的讲解学习，属于对STL的深入学习的一本参考书籍。</p>
<h1 id="欲善其事必先利其器"><a href="#欲善其事必先利其器" class="headerlink" title="欲善其事必先利其器"></a>欲善其事必先利其器</h1><p>单纯学习数据结构和算法是比较枯燥的，<a target="_blank" rel="noopener" href="https://visualgo.net/">算法可视化的神奇网站</a>，这个网站可以让我们在学习数据结构和算法的时候可视化的看到每一步的变化，更加形象生动。</p>
<h1 id="数学知识"><a href="#数学知识" class="headerlink" title="数学知识"></a>数学知识</h1><h2 id="指数"><a href="#指数" class="headerlink" title="指数"></a>指数</h2><p>Power(X,A) X Power(X,B) &#x3D; Power(X,A+B)<br>Power(X,A) &#x2F; Power(X,B) &#x3D; Power(X,A-B)</p>
<h2 id="对数"><a href="#对数" class="headerlink" title="对数"></a>对数</h2><p>LogA(B) &#x3D; LogC(B) &#x2F; LogC(A); C &gt; 0<br>Log(AB) &#x3D; Log(A) + Log(B)<br>Log(A&#x2F;B) &#x3D; Log(A) - Log(B)<br>Log(Power(A,B)) &#x3D; B X Log(A)<br>Log(X) &lt; X(X &gt; 0)</p>
<h2 id="级数"><a href="#级数" class="headerlink" title="级数"></a>级数</h2><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> N</span><br><span class="line"> ∑  (Power(<span class="number">2</span>, i)) =  Power(<span class="number">2</span>, N+<span class="number">1</span>) - <span class="number">1</span>;</span><br><span class="line">i=<span class="number">0</span></span><br><span class="line"> N</span><br><span class="line"> ∑ (Power(A, i)) = (Power(<span class="number">2</span>, N+<span class="number">1</span>) - <span class="number">1</span>) / (A - <span class="number">1</span>)</span><br><span class="line">i=<span class="number">0</span></span><br></pre></td></tr></table></figure>

<h2 id="模运算"><a href="#模运算" class="headerlink" title="模运算"></a>模运算</h2><p>如果N整除A-B,那么A与B模N同余，记为A≡B(mod N)</p>
<h2 id="证明方法"><a href="#证明方法" class="headerlink" title="证明方法"></a>证明方法</h2><ol>
<li>归纳法<br>第一步证明基准情形(对于某些小的值的正确性，比如1)<br>第二步，假设直到k也成立<br>最后，证明k+1的时候也成立即可</li>
<li>反证法<br>首先假设定力不成立<br>然后证明该假设导致的某个已知的性质不成立，从而证明原假设是错误的。</li>
</ol>
<h2 id="递归简论"><a href="#递归简论" class="headerlink" title="递归简论"></a>递归简论</h2><p>基本法则：</p>
<ol>
<li>基准情形<br>必须要有某些基准的情形，它们不用递归就能求解</li>
<li>不断推进<br>对于那些递归求解的情形，递归调用必须总能够朝着产生基准情形的方向推进</li>
<li>设计法则<br>假设所有的递归调用都能运行</li>
<li>合成效益法则<br>在求解一个问题的同一个实例时，切勿在不同的递归调用中做重复性的工作</li>
</ol>
<h1 id="数据结构"><a href="#数据结构" class="headerlink" title="数据结构"></a>数据结构</h1><p>抽象数据类型(Abstract data type, ADT)是一些操作的集合。</p>
<h2 id="链表"><a href="#链表" class="headerlink" title="链表"></a>链表</h2><p>链表是由一系列不必在内存中向连的结构组成。每一个结构均含有表元素和指向包含该元素后继元的结构的指针。最后一个单元的后继元指向NULL。</p>
<p>链表分类：</p>
<ol>
<li>单向链表<br> 只能从前往后访问节点<br> 以下实现了简单的单向链表，允许头插入Node，删除第一个满足条件的Node，打印所有成员，判断是否为空，得到Node节点数等。</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;stdafx.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">SingleLinkNode</span></span><br><span class="line">&#123;</span><br><span class="line">	T mElement;</span><br><span class="line">	SingleLinkNode* Next;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SingleLinkList</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">SingleLinkList</span>()</span><br><span class="line">	&#123;</span><br><span class="line">		mHeadNode = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">		mLength = <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	~<span class="built_in">SingleLinkList</span>()</span><br><span class="line">	&#123;</span><br><span class="line">		SingleLinkNode&lt;T&gt; *tempnode;</span><br><span class="line">		<span class="keyword">while</span> (mHeadNode != <span class="literal">NULL</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			tempnode = mHeadNode-&gt;Next;</span><br><span class="line">			<span class="keyword">delete</span> mHeadNode;</span><br><span class="line">			mLength--;</span><br><span class="line">			mHeadNode = tempnode;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//ADT</span></span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">FrontInsert</span><span class="params">(T v)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		SingleLinkNode&lt;T&gt; *tempnode = <span class="keyword">new</span> <span class="built_in">SingleLinkNode</span>&lt;T&gt;();</span><br><span class="line"></span><br><span class="line">		tempnode-&gt;mElement = v;</span><br><span class="line"></span><br><span class="line">		tempnode-&gt;Next = mHeadNode;</span><br><span class="line"></span><br><span class="line">		mHeadNode = tempnode;</span><br><span class="line"></span><br><span class="line">		mLength++;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="type">bool</span> <span class="title">IsEmpty</span><span class="params">()</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> mLength;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">Delete</span><span class="params">(T v)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (mHeadNode == <span class="literal">NULL</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		SingleLinkNode&lt;T&gt; *tempnode = mHeadNode;</span><br><span class="line"></span><br><span class="line">		SingleLinkNode&lt;T&gt; *prenode = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">		<span class="type">bool</span> find = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">while</span> (tempnode != <span class="literal">NULL</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">//remove first v element</span></span><br><span class="line">			<span class="keyword">if</span> (tempnode-&gt;mElement == v)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="comment">//when remove first node, move forward mHeadNode</span></span><br><span class="line">				<span class="keyword">if</span> (tempnode == mHeadNode)</span><br><span class="line">				&#123;</span><br><span class="line">					mHeadNode = tempnode-&gt;Next;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">else</span></span><br><span class="line">				&#123;</span><br><span class="line">					prenode-&gt;Next = tempnode-&gt;Next;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">delete</span> tempnode;</span><br><span class="line">				mLength--;</span><br><span class="line">				find = <span class="literal">true</span>;</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">//Record pre node for later operation</span></span><br><span class="line">			prenode = tempnode;</span><br><span class="line">			tempnode = tempnode-&gt;Next;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (find)</span><br><span class="line">		&#123;</span><br><span class="line">			cout &lt;&lt; <span class="string">&quot;Delete &quot;</span> &lt;&lt; v &lt;&lt; <span class="string">&quot; successfully!&quot;</span> &lt;&lt; endl;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			cout &lt;&lt; <span class="string">&quot;Delete &quot;</span> &lt;&lt; v &lt;&lt; <span class="string">&quot; failed! Not find it in list!&quot;</span> &lt;&lt; endl;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="type">int</span> <span class="title">Find</span><span class="params">(T v)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="type">int</span> position = <span class="number">0</span>;</span><br><span class="line">		SingleLinkNode&lt;T&gt; *tempnode = mHeadNode;</span><br><span class="line">		<span class="keyword">while</span> (tempnode != <span class="literal">NULL</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			position++;</span><br><span class="line">			<span class="keyword">if</span> (tempnode-&gt;mElement == v)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">return</span> position;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">			&#123;</span><br><span class="line">				tempnode = tempnode-&gt;Next;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function">SingleLinkNode&lt;T&gt;* <span class="title">GetNodeAt</span><span class="params">(<span class="type">int</span> position)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (position &lt; <span class="number">1</span> || position &gt; mLength)</span><br><span class="line">		&#123;</span><br><span class="line">			cout &lt;&lt; position &lt;&lt; <span class="string">&quot; Out of range of link list!&quot;</span> &lt;&lt; endl;</span><br><span class="line">			cout &lt;&lt; <span class="string">&quot;Current length of link list = &quot;</span> &lt;&lt; mLength &lt;&lt; endl;</span><br><span class="line">			cout &lt;&lt; <span class="string">&quot;Insert failed!&quot;</span> &lt;&lt; endl;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">//链表是非连续的存储方式，所以需要通过循环访问到特定位置</span></span><br><span class="line">			SingleLinkNode&lt;T&gt; *tempnode = mHeadNode;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (position == <span class="number">1</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">return</span> mHeadNode;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt; position; i++)</span><br><span class="line">				&#123;</span><br><span class="line">					tempnode = tempnode-&gt;Next;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">return</span> tempnode;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">TraversAll</span><span class="params">()</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		SingleLinkNode&lt;T&gt; *tempnode = mHeadNode;</span><br><span class="line">		<span class="keyword">while</span> (tempnode != <span class="literal">NULL</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			cout &lt;&lt; tempnode-&gt;mElement &lt;&lt; endl;</span><br><span class="line">			tempnode = tempnode-&gt;Next;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="type">int</span> <span class="title">Length</span><span class="params">()</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> mLength;</span><br><span class="line">	&#125;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	SingleLinkNode&lt;T&gt; *mHeadNode;</span><br><span class="line"></span><br><span class="line">	<span class="type">int</span> mLength;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<pre><code>测试程序：
</code></pre>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;stdafx.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vld.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;SingleLinkList.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> _tmain(<span class="type">int</span> argc, _TCHAR* argv[])</span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">//Single Link List part</span></span><br><span class="line">	SingleLinkList&lt;<span class="type">int</span>&gt; *singlelinklist = <span class="keyword">new</span> <span class="built_in">SingleLinkList</span>&lt;<span class="type">int</span>&gt;();</span><br><span class="line"></span><br><span class="line">	singlelinklist-&gt;<span class="built_in">FrontInsert</span>(<span class="number">3</span>);</span><br><span class="line">	singlelinklist-&gt;<span class="built_in">FrontInsert</span>(<span class="number">1</span>);</span><br><span class="line">	singlelinklist-&gt;<span class="built_in">FrontInsert</span>(<span class="number">4</span>);</span><br><span class="line">	singlelinklist-&gt;<span class="built_in">FrontInsert</span>(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">	singlelinklist-&gt;<span class="built_in">TraversAll</span>();</span><br><span class="line"></span><br><span class="line">	singlelinklist-&gt;<span class="built_in">Delete</span>(<span class="number">1</span>);</span><br><span class="line">	singlelinklist-&gt;<span class="built_in">Delete</span>(<span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">	singlelinklist-&gt;<span class="built_in">TraversAll</span>();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">delete</span> singlelinklist;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre><code>可以看到链表的节点是通过SingleLinkNode抽象出来。
</code></pre>
<p><img src="/img/Algorithem/SingleLinkList.PNG" alt="SingleLinkList"></p>
<ol start="2">
<li>双向链表<br> 可以从前往后也可以从后往前访问节点<br> 为了从后往前访问，我们需要改写SingleLinkNode支持从当前Node访问前一Node</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">DoubleLinkNode</span></span><br><span class="line">&#123;</span><br><span class="line">	T mElement;</span><br><span class="line">	</span><br><span class="line">	DoubleLinkNode *Pre;</span><br><span class="line"></span><br><span class="line">	DoubleLinkNode *Next;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<pre><code>同时为了快速从尾部访问，SingleLinkList需要增加mTailNode去指向链表尾部Node，同时支持从尾部插入
</code></pre>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;stdafx.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//DoubleLinkNode definition</span></span><br><span class="line"><span class="comment">//.....</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DoubleLinkList</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">DoubleLinkList</span>()</span><br><span class="line">	&#123;</span><br><span class="line">		mHeadNode = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">		mTailNode = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">		mLength = <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	~<span class="built_in">DoubleLinkList</span>()</span><br><span class="line">	&#123;</span><br><span class="line">		DoubleLinkNode&lt;T&gt; *tempnode;</span><br><span class="line">		<span class="keyword">while</span> (mHeadNode != <span class="literal">NULL</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			tempnode = mHeadNode-&gt;Next;</span><br><span class="line">			<span class="keyword">delete</span> mHeadNode;</span><br><span class="line">			mLength--;</span><br><span class="line">			mHeadNode = tempnode;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//ADT</span></span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">FrontInsert</span><span class="params">(T v)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		DoubleLinkNode&lt;T&gt; *tempnode = <span class="keyword">new</span> <span class="built_in">DoubleLinkNode</span>&lt;T&gt;();</span><br><span class="line"></span><br><span class="line">		tempnode-&gt;mElement = v;</span><br><span class="line"></span><br><span class="line">		<span class="comment">//when insert first element, tail node equals to head node</span></span><br><span class="line">		<span class="keyword">if</span> (mLength == <span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			tempnode-&gt;Pre = <span class="literal">NULL</span>;</span><br><span class="line">			tempnode-&gt;Next = <span class="literal">NULL</span>;</span><br><span class="line">			mHeadNode = tempnode;</span><br><span class="line">			mTailNode = mHeadNode;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			mHeadNode-&gt;Pre = tempnode;</span><br><span class="line">			tempnode-&gt;Next = mHeadNode;</span><br><span class="line">			mHeadNode = tempnode;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		mLength++;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">InsertAtPosition</span><span class="params">(<span class="type">int</span> position, T v)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (position &lt; <span class="number">1</span> || position &gt; mLength + <span class="number">1</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			cout &lt;&lt; position &lt;&lt; <span class="string">&quot; Out of range of link list!&quot;</span> &lt;&lt; endl;</span><br><span class="line">			cout &lt;&lt; <span class="string">&quot;Current length of link list = &quot;</span> &lt;&lt; mLength &lt;&lt; endl;</span><br><span class="line">			cout &lt;&lt; <span class="string">&quot;Insert failed!&quot;</span> &lt;&lt; endl;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//when insert element as first element.</span></span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (position == <span class="number">1</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">FrontInsert</span>(v);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//when insert at final position</span></span><br><span class="line">		<span class="comment">//when position is larger than length of link list,</span></span><br><span class="line">		<span class="comment">//we insert it at the end of the link list</span></span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (position == mLength + <span class="number">1</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">TailInsert</span>(v);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//insert element between head and last element</span></span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			DoubleLinkNode&lt;T&gt; *tempnode = <span class="keyword">new</span> <span class="built_in">DoubleLinkNode</span>&lt;T&gt;();</span><br><span class="line"></span><br><span class="line">			tempnode-&gt;mElement = v;</span><br><span class="line"></span><br><span class="line">			DoubleLinkNode&lt;T&gt; *prenode = <span class="built_in">GetNodeAt</span>(position - <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (prenode != <span class="literal">NULL</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				tempnode-&gt;Pre = prenode;</span><br><span class="line"></span><br><span class="line">				tempnode-&gt;Next = prenode-&gt;Next;</span><br><span class="line"></span><br><span class="line">				prenode-&gt;Next-&gt;Pre = tempnode;</span><br><span class="line"></span><br><span class="line">				prenode-&gt;Next = tempnode;</span><br><span class="line"></span><br><span class="line">				mLength++;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">TailInsert</span><span class="params">(T v)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		DoubleLinkNode&lt;T&gt; *tempnode = <span class="keyword">new</span> <span class="built_in">DoubleLinkNode</span>&lt;T&gt;();</span><br><span class="line"></span><br><span class="line">		tempnode-&gt;mElement = v;</span><br><span class="line"></span><br><span class="line">		<span class="comment">//when insert first element, tail node equals to head node</span></span><br><span class="line">		<span class="keyword">if</span> (mLength == <span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			tempnode-&gt;Pre = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">			tempnode-&gt;Next = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">			mHeadNode = tempnode;</span><br><span class="line"></span><br><span class="line">			mTailNode = mHeadNode;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			tempnode-&gt;Pre = mTailNode;</span><br><span class="line"></span><br><span class="line">			tempnode-&gt;Next = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">			mTailNode-&gt;Next = tempnode;</span><br><span class="line"></span><br><span class="line">			mTailNode = tempnode;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		mLength++;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function">DoubleLinkNode&lt;T&gt;* <span class="title">GetNodeAt</span><span class="params">(<span class="type">int</span> position)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (position &lt; <span class="number">1</span> || position &gt; mLength)</span><br><span class="line">		&#123;</span><br><span class="line">			cout &lt;&lt; position &lt;&lt; <span class="string">&quot; Out of range of link list!&quot;</span> &lt;&lt; endl;</span><br><span class="line">			cout &lt;&lt; <span class="string">&quot;Current length of link list = &quot;</span> &lt;&lt; mLength &lt;&lt; endl;</span><br><span class="line">			cout &lt;&lt; <span class="string">&quot;Insert failed!&quot;</span> &lt;&lt; endl;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">//链表是非连续的存储方式，所以需要通过循环访问到特定位置</span></span><br><span class="line">			DoubleLinkNode&lt;T&gt; *tempnode = mHeadNode;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (position == <span class="number">1</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">return</span> mHeadNode;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (position == mLength)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">return</span> mTailNode;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt; position; i++)</span><br><span class="line">				&#123;</span><br><span class="line">					tempnode = tempnode-&gt;Next;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">return</span> tempnode;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="type">bool</span> <span class="title">IsEmpty</span><span class="params">()</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> mLength;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">Delete</span><span class="params">(T v)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (mHeadNode == <span class="literal">NULL</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		DoubleLinkNode&lt;T&gt; *tempnode = mHeadNode;</span><br><span class="line"></span><br><span class="line">		DoubleLinkNode&lt;T&gt; *prenode = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">		<span class="type">bool</span> find = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">while</span> (tempnode != <span class="literal">NULL</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">//remove first v element</span></span><br><span class="line">			<span class="keyword">if</span> (tempnode-&gt;mElement == v)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="comment">//when remove first node, move forward mHeadNode</span></span><br><span class="line">				<span class="keyword">if</span> (tempnode == mHeadNode)</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="keyword">if</span> (mLength &lt;= <span class="number">1</span>)</span><br><span class="line">					&#123;</span><br><span class="line">						mHeadNode = <span class="literal">NULL</span>;</span><br><span class="line">						mTailNode = <span class="literal">NULL</span>;</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">else</span></span><br><span class="line">					&#123;</span><br><span class="line">						mHeadNode = tempnode-&gt;Next;</span><br><span class="line">						mHeadNode-&gt;Pre = <span class="literal">NULL</span>;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">else</span> <span class="keyword">if</span> (tempnode == mTailNode)</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="keyword">if</span> (mLength &lt;= <span class="number">1</span>)</span><br><span class="line">					&#123;</span><br><span class="line">						mHeadNode = <span class="literal">NULL</span>;</span><br><span class="line">						mTailNode = <span class="literal">NULL</span>;</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">else</span></span><br><span class="line">					&#123;</span><br><span class="line">						mTailNode = prenode;</span><br><span class="line">						mTailNode-&gt;Next = <span class="literal">NULL</span>;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">else</span></span><br><span class="line">				&#123;</span><br><span class="line">					prenode-&gt;Next = tempnode-&gt;Next;</span><br><span class="line">					tempnode-&gt;Next-&gt;Pre = prenode;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">delete</span> tempnode;</span><br><span class="line">				mLength--;</span><br><span class="line">				find = <span class="literal">true</span>;</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">//Record pre node for later operation</span></span><br><span class="line">			prenode = tempnode;</span><br><span class="line">			tempnode = tempnode-&gt;Next;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (find)</span><br><span class="line">		&#123;</span><br><span class="line">			cout &lt;&lt; <span class="string">&quot;Delete &quot;</span> &lt;&lt; v &lt;&lt; <span class="string">&quot; successfully!&quot;</span> &lt;&lt; endl;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			cout &lt;&lt; <span class="string">&quot;Delete &quot;</span> &lt;&lt; v &lt;&lt; <span class="string">&quot; failed! Not find it in list!&quot;</span> &lt;&lt; endl;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="type">int</span> <span class="title">Find</span><span class="params">(T v)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="type">int</span> position = <span class="number">0</span>;</span><br><span class="line">		DoubleLinkNode&lt;T&gt; *tempnode = mHeadNode;</span><br><span class="line">		<span class="keyword">while</span> (tempnode != <span class="literal">NULL</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			position++;</span><br><span class="line">			<span class="keyword">if</span> (tempnode-&gt;mElement == v)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">return</span> position;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">			&#123;</span><br><span class="line">				tempnode = tempnode-&gt;Next;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">TraversAll</span><span class="params">()</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		DoubleLinkNode&lt;T&gt; *tempnode = mHeadNode;</span><br><span class="line">		<span class="keyword">while</span> (tempnode != <span class="literal">NULL</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			cout &lt;&lt; tempnode-&gt;mElement &lt;&lt; endl;</span><br><span class="line">			tempnode = tempnode-&gt;Next;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="type">int</span> <span class="title">Length</span><span class="params">()</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> mLength;</span><br><span class="line">	&#125;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	DoubleLinkNode&lt;T&gt; *mHeadNode;</span><br><span class="line"></span><br><span class="line">	DoubleLinkNode&lt;T&gt; *mTailNode;</span><br><span class="line"></span><br><span class="line">	<span class="type">int</span> mLength;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<pre><code>测试程序
</code></pre>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;stdafx.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vld.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;SingleLinkList.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> _tmain(<span class="type">int</span> argc, _TCHAR* argv[])</span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">//Double link list part</span></span><br><span class="line">	DoubleLinkList&lt;<span class="type">int</span>&gt; *doublelinklist = <span class="keyword">new</span> <span class="built_in">DoubleLinkList</span>&lt;<span class="type">int</span>&gt;();</span><br><span class="line"></span><br><span class="line">	doublelinklist-&gt;<span class="built_in">TailInsert</span>(<span class="number">2</span>);</span><br><span class="line">	doublelinklist-&gt;<span class="built_in">FrontInsert</span>(<span class="number">3</span>);</span><br><span class="line">	doublelinklist-&gt;<span class="built_in">TailInsert</span>(<span class="number">4</span>);</span><br><span class="line">	doublelinklist-&gt;<span class="built_in">TailInsert</span>(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">	doublelinklist-&gt;<span class="built_in">TraversAll</span>();</span><br><span class="line"></span><br><span class="line">	doublelinklist-&gt;<span class="built_in">Delete</span>(<span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">	cout &lt;&lt; <span class="string">&quot;Complete doublelinklist-&gt;Delete(4);&quot;</span> &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">	doublelinklist-&gt;<span class="built_in">TraversAll</span>();</span><br><span class="line"></span><br><span class="line">	doublelinklist-&gt;<span class="built_in">InsertAtPosition</span>(<span class="number">3</span>, <span class="number">6</span>);</span><br><span class="line"></span><br><span class="line">	cout &lt;&lt; <span class="string">&quot;Complete doublelinklist-&gt;InsertAtPosition(3, 6);&quot;</span> &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">	doublelinklist-&gt;<span class="built_in">TraversAll</span>();</span><br><span class="line"></span><br><span class="line">	doublelinklist-&gt;<span class="built_in">InsertAtPosition</span>(<span class="number">5</span>, <span class="number">7</span>);</span><br><span class="line"></span><br><span class="line">	cout &lt;&lt; <span class="string">&quot;Complete doublelinklist-&gt;InsertAtPosition(5, 7);&quot;</span> &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">	doublelinklist-&gt;<span class="built_in">TraversAll</span>();</span><br><span class="line"></span><br><span class="line">	doublelinklist-&gt;<span class="built_in">InsertAtPosition</span>(<span class="number">9</span>, <span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">	cout &lt;&lt; <span class="string">&quot;Complete doublelinklist-&gt;InsertAtPosition(9, 10);&quot;</span> &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">	doublelinklist-&gt;<span class="built_in">TraversAll</span>();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">delete</span> doublelinklist;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre><code>测试结果：
</code></pre>
<p><img src="/img/Algorithem/DoubleLinkList.PNG" alt="DoubleLinkList"></p>
<ol start="3">
<li>循环链表<br> 双向链表的基础上，可以从头直接访问尾也可以从尾直接访问头<br> 出于测试目的，为了验证是否至此从尾访问到头部，在TraversAll的方法里，我从第二个节点开始访问进行打印数据直到回到头节点</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">TraversAll</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	CircleLinkNode&lt;T&gt; *tempnode = mHeadNode;</span><br><span class="line">	tempnode = tempnode-&gt;Next;</span><br><span class="line">	cout &lt;&lt; mHeadNode-&gt;mElement &lt;&lt; endl;</span><br><span class="line">	<span class="keyword">while</span> (tempnode != mHeadNode)</span><br><span class="line">	&#123;</span><br><span class="line">		cout &lt;&lt; tempnode-&gt;mElement &lt;&lt; endl;</span><br><span class="line">		tempnode = tempnode-&gt;Next;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre><code>因为Head节点的Pre指向Tail节点，Tail节点的Next指向Head，所以这里在析构释放内存的时候需要注意判断条件：
</code></pre>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">~<span class="built_in">CircleLinkList</span>()</span><br><span class="line">&#123;</span><br><span class="line">	CircleLinkNode&lt;T&gt; *	tempnode = mHeadNode;</span><br><span class="line">	<span class="keyword">while</span> (mLength != <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		mHeadNode = mHeadNode-&gt;Next;</span><br><span class="line">		<span class="keyword">delete</span> tempnode;</span><br><span class="line">		tempnode = mHeadNode;</span><br><span class="line">		mLength--;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre><code>其他情况主要注意在Head和Tail的极端顶点时的判断处理：
</code></pre>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ADT</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">FrontInsert</span><span class="params">(T v)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	CircleLinkNode&lt;T&gt; *tempnode = <span class="keyword">new</span> <span class="built_in">CircleLinkNode</span>&lt;T&gt;();</span><br><span class="line"></span><br><span class="line">	tempnode-&gt;mElement = v;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//when insert first element, tail node equals to head node</span></span><br><span class="line">	<span class="keyword">if</span> (mLength == <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		tempnode-&gt;Pre = tempnode;</span><br><span class="line">		tempnode-&gt;Next = tempnode;</span><br><span class="line">		mHeadNode = tempnode;</span><br><span class="line">		mTailNode = mHeadNode;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		mHeadNode-&gt;Pre = tempnode;</span><br><span class="line">		tempnode-&gt;Pre = mTailNode;</span><br><span class="line">		tempnode-&gt;Next = mHeadNode-&gt;Next;</span><br><span class="line">		mHeadNode = tempnode;</span><br><span class="line">		mTailNode-&gt;Next = mHeadNode;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	mLength++;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//......</span></span><br></pre></td></tr></table></figure>
<pre><code>测试结果：
</code></pre>
<p><img src="/img/Algorithem/CircleLinkList.PNG" alt="CircleLinkList"></p>
<h2 id="栈"><a href="#栈" class="headerlink" title="栈"></a>栈</h2><p>栈是限制插入和删除只能在一个位置上进行的表，该位置是表的末端，叫做栈的顶。<br>栈的ADT：<br>Push(进栈)<br>Pop(出栈)</p>
<p>栈是LIFO(后进先出)</p>
<p>栈的实现：<br>栈是一个表，因此任何实现表的方法都能实现栈(比如数组，链表)。<br>下面以前面实现的链表为例来实现栈：<br>因为栈只允许顶端Push，Pop以及Top查看顶端元素并返回值，所以这里采用单向链表即可。</p>
<p>待续……</p>
<h1 id="算法"><a href="#算法" class="headerlink" title="算法"></a>算法</h1><h2 id="算法与程序"><a href="#算法与程序" class="headerlink" title="算法与程序"></a>算法与程序</h2><p>算法是由若干条指令组成的又有穷序列，且满足下述4条性质：</p>
<ol>
<li>输入：有零个或多个由外部提供的量作为算法的输入。</li>
<li>输出：算法产生至少一个量作为输出。</li>
<li>确定性：组成算法的每条指令是清晰的，无歧义的。</li>
<li>有限性：算法中每条指令的执行次数是有限的，执行每条指令的时间也是有限的。</li>
</ol>
<p>区分程序和算法：<br>程序与算法不同。程序是算法用某种程序设计语言的具体实现。</p>
<h2 id="算法复杂性"><a href="#算法复杂性" class="headerlink" title="算法复杂性"></a>算法复杂性</h2><p>算法复杂性体现在运行该算法所需的计算机资源(时间和空间)的多少上。</p>
<p>所以算法复杂性主要是体现的时间复杂度和空间复杂度上。<br>C表示复杂度，N表示问题的规模，I表示算法的输入，A表示算法本身。<br>C &#x3D; F(N,I,A)<br>T表示时间复杂度，S表示空间复杂度。<br>T &#x3D; F(N,I,A)<br>S &#x3D; F(N,I,A)</p>
<h3 id="时间复杂度"><a href="#时间复杂度" class="headerlink" title="时间复杂度"></a>时间复杂度</h3><p>时间复杂度 — 指执行算法所需要的计算工作量<br>时间复杂度分为下列三种：</p>
<ol>
<li>平均时间复杂度 — 理论上一般情况的时间复杂度</li>
<li>最坏时间复杂度 — 特殊情况下（导致时间耗费最多的数据输入）</li>
<li>最优时间复杂度 — 特殊情况下（导致时间耗费最少的数据输入）</li>
</ol>
<h3 id="空间复杂度"><a href="#空间复杂度" class="headerlink" title="空间复杂度"></a>空间复杂度</h3><p>空间复杂度 — 指执行算法所需要的内存空间</p>
<h2 id="程序算法思想"><a href="#程序算法思想" class="headerlink" title="程序算法思想"></a>程序算法思想</h2><h3 id="递归"><a href="#递归" class="headerlink" title="递归"></a>递归</h3><p>定义：<br>直接或间接地调用自身的算法称为递归算法。<br>用函数自身给出定义的函数称为递归函数。</p>
<p>基本思想：<br>每个递归函数都必须有非递归定义的初始值，否则，递归函数就无法计算。<br>递归式的第二式用较小自变量的函数值来表示较大自变量的函数值的方式来定义。</p>
<p>事例：<br>无穷数列1,1,2,3,5,8,13，,2,34,55……，称为Fibonacci数列。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">       &#123;  <span class="number">1</span>                         n = <span class="number">0</span></span><br><span class="line"><span class="built_in">F</span>(n) = &#123;  <span class="number">1</span>                         n = <span class="number">1</span></span><br><span class="line">       &#123;  <span class="built_in">F</span>(n - <span class="number">1</span>) + <span class="built_in">F</span>(n - <span class="number">2</span>)       n &gt; <span class="number">1</span></span><br></pre></td></tr></table></figure>
<p>代码实现：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AlgorithmStudy.cpp : 定义控制台应用程序的入口点。</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;stdafx.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">Fibonacci</span><span class="params">(<span class="type">int</span> n)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span>( n &lt;= <span class="number">2</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">Fibonacci</span>(n - <span class="number">1</span>) + <span class="built_in">Fibonacci</span>(n - <span class="number">2</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> _tmain(<span class="type">int</span> argc, _TCHAR* argv[])</span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> n;</span><br><span class="line">	cout&lt;&lt;<span class="string">&quot;Please Enter the Fibonacci&#x27;s n:&quot;</span>&lt;&lt;endl;</span><br><span class="line">	cin&gt;&gt;n;</span><br><span class="line">	cout&lt;&lt;<span class="string">&quot;Fibonacci(&quot;</span>&lt;&lt;n&lt;&lt;<span class="string">&quot;) = &quot;</span>&lt;&lt;<span class="built_in">Fibonacci</span>(n)&lt;&lt;endl;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/img/Algorithem/FabonacciRecursion.PNG" alt="FabonacciRecursion"></p>
<p>还有一个典型的问题，汉诺塔问题。<br>问题描述：<br>a，b，c三个塔座。塔座a上共n个圆盘，圆盘至下而上从大到小的叠放在一起，圆盘编号从小到大为1,2,3……n。要求将塔座a上的这一叠圆盘移动到塔座b上，并按同样顺序叠放。移动规则如下：</p>
<ol>
<li>每次只能移动一个圆盘</li>
<li>任何时时刻都不允许将较大的圆盘压在较小的圆盘会上</li>
<li>在满足移动规则1和2的前提下，将圆盘至a，b，c中任意塔座上。</li>
</ol>
<p>解题思想：<br>若是奇数次移动，则将最小的圆盘移到顺时针方向的下一座塔上。若是偶数次移动，则保持最小的圆盘不动，而在其他两个塔座之间，将较小的圆盘移动到另一个塔座上。</p>
<p>那么如何用递归来实现这个解题思想了。<br>当n &#x3D; 1时，将编号1的圆盘从塔座a移动到塔座b即可。<br>当n &gt; 1时，需要利用塔座c作为辅助塔座。此时要设法将n - 1个较小的圆盘依照移动规则从塔座a移至塔座c上，然后，将剩下的最大圆盘从塔座a移至塔座b上，最后，再设法将n - 1个较小的圆盘你依照移动规则从塔座c移至塔座b上。(由此可见，n个圆盘的移动问题分解成为了两次n - 1个圆盘的移动问题，这就可以通过递归的方式解决)</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">Hanoi</span><span class="params">(<span class="type">int</span> n, <span class="type">int</span> a, <span class="type">int</span> b, <span class="type">int</span> c)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(n &gt; <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">        <span class="built_in">Hanoi</span>(n - <span class="number">1</span>, a, c, b); <span class="comment">// 将n - 1个圆盘按移动规则从a移动到c</span></span><br><span class="line">        <span class="built_in">move</span>(a,b);             <span class="comment">// 将圆盘n从a移动到b</span></span><br><span class="line">        <span class="built_in">Hanoi</span>(n <span class="number">-1</span>, c,  b, a); <span class="comment">// 将n - 1个圆盘按移动规则从c移动到b</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>递归算法好处：<br>结构清晰，可读性强，且容易用数学归纳法证明算法的正确性，方便调试。</p>
<p>递归算法坏处：<br>运行效率低，时间复杂度和空间复杂度都很大。</p>
<p>针对Fabonacci方法，我们可以写一个非递归的方法，</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">FibonacciNoRecursion</span><span class="params">(<span class="type">int</span> n)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="type">int</span> temp[<span class="number">2</span>];</span><br><span class="line">	temp[<span class="number">0</span>] = <span class="number">1</span>;</span><br><span class="line">	temp[<span class="number">1</span>] = <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">if</span>(n &lt;= <span class="number">2</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">2</span>; i &lt; n; i++)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="type">int</span> tp = temp[<span class="number">0</span>] + temp[<span class="number">1</span>];</span><br><span class="line">			temp[<span class="number">1</span>]= temp[<span class="number">0</span>];</span><br><span class="line">			temp[<span class="number">0</span>] = tp;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> temp[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样一来，递归调用导致的调用栈深度问题就没有了，而是通过临时变量把数据存储了起来。</p>
<h3 id="分治"><a href="#分治" class="headerlink" title="分治"></a>分治</h3><p>基本思想：<br>将一个规模为n的问题分解为k个(一般划分成n&#x2F;2 – 二分细分)规模较小的子问题，这些子问题互相独立且与原问题相同。递归的解这些子问题，然后将各子问题的解合并得到原问题的解。</p>
<p>在排序算法学习中，<a href="http://tonytang1990.github.io/2015/07/11/Sort-Algorithm/">快速排序(Quick Sort)和归并排序(Merge Sort)</a>就用到了分治的思想。</p>
<h3 id="动态规划"><a href="#动态规划" class="headerlink" title="动态规划"></a>动态规划</h3><p>基本思想：<br>动态规划与分治思想类似，但动态规划里经分解得到的子问题往往不是互相独立的。如果我们能够保存已解决的子问题的答案，而在需要时再找出已求得的答案，会这样就可以避免大量的重复计算，从而得到多项式时间算法。</p>
<p>动态规划适用于解最优化问题。一般有4个步骤设计：</p>
<ol>
<li>找出最优解的性质，并刻画其结构特征。</li>
<li>递归地定义最优值。</li>
<li>以自底向上的方式计算出最优值。</li>
<li>根据计算最优值时得到的信息，构造最优解。</li>
</ol>
<p>动态规划的基本要素：</p>
<ol>
<li>最优子结构<br>当问题的最优解包含其子问题的最优解时，称该问题具有最优子结构性质</li>
<li>重叠子问题<br>在递归算法自顶向下解此问题时，每次产生的子问题并不总是新问题，有些子问题被反复运算。</li>
<li>备忘录方法<br>备忘录方法是动态规划的变形，唯一不同的是递归方式是至顶向下。</li>
</ol>
<p>接下来以求解最长公共子序列来分析动态规划算法。<br>问题描述：<br>X &#x3D; {x1, x2, x3,…..xn}<br>Z &#x3D; {z1, z2, z3,…..zn}<br>存在一个递增序列，即Z是X的子序列。</p>
<p>X &#x3D; {x1, x2, x3,….. xm}<br>Y &#x3D; {y1, y2, y3,….. yn}<br>求解X和Y的最长公共子序列Z：<br>Z &#x3D; {z1, z2, z3,…zk}</p>
<p>分析最优子结构性质：<br>若X(m) &#x3D; Y(n)，则Z(k) &#x3D; X(m) &#x3D; Y(n)，且Z(k-1)是X(m-1)和Y(n-1)的最长公共子序列<br>若X(m) !&#x3D; Y(n)且Z(k)  !&#x3D; X(m)，则Z是X(m-1)和Y的最长公共子序列<br>若X(m) !&#x3D; Y(n)且Z(k) !&#x3D; Y(n)，则Z是X和Y(n-1)的最长公共子序列</p>
<p>c[i][j]记录序列X(i)和Y(j)的最长公共子序列的长度<br>从上面的最优子结构性质我们可以得出下列结论：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">          &#123;         <span class="number">0</span>                       i = <span class="number">0</span>, j = <span class="number">0</span></span><br><span class="line">c[i][j] = &#123;    c[i<span class="number">-1</span>][j<span class="number">-1</span>] + <span class="number">1</span>              i,j &gt; <span class="number">0</span>; <span class="built_in">X</span>(i) = <span class="built_in">Y</span>(j)</span><br><span class="line">          &#123; <span class="built_in">Max</span>(c[i][j<span class="number">-1</span>], c[i<span class="number">-1</span>][j])       i,j &gt; <span class="number">0</span>; <span class="built_in">X</span>(i) != <span class="built_in">Y</span>(j)</span><br></pre></td></tr></table></figure>
<p>从上面而已看出，在递归求的时候，很多子问题是重叠的。</p>
<p>b[i][j]用于记录c[i][j]的值是由哪一个子问题的解得到的。b最后会用于构建最优解。<br>我们把上面的情况分别分为1,2,3。在递归求解的时候存储的b[i][j]里。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;stdafx.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">GetArrayLength</span><span class="params">(T &amp;array)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">sizeof</span>(array) / <span class="built_in">sizeof</span>(array[<span class="number">0</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">LCSLength</span><span class="params">(<span class="type">int</span> m, <span class="type">int</span> n, <span class="type">char</span> *x, <span class="type">char</span> *y, <span class="type">int</span> **c, <span class="type">int</span> **b)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="type">int</span> i,j;</span><br><span class="line">	<span class="comment">// i = 0, j = 0的情况</span></span><br><span class="line">	c[<span class="number">0</span>][<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span>(i = <span class="number">1</span>; i &lt;= m; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		c[i][<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">for</span>(i = <span class="number">1</span>; i &lt;= n; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		c[<span class="number">0</span>][i] = <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//自底向上的填充最优解</span></span><br><span class="line">	<span class="keyword">for</span>(i = <span class="number">1</span>; i &lt;= m; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">for</span>(j = <span class="number">1</span>; j &lt;= n; j++)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">// X(i) == Y(j)的情况</span></span><br><span class="line">			<span class="keyword">if</span>(x[i] == y[j])</span><br><span class="line">			&#123;</span><br><span class="line">				c[i][j] = c[i<span class="number">-1</span>][j<span class="number">-1</span>] + <span class="number">1</span>;</span><br><span class="line">				b[i][j] = <span class="number">1</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">// X(i) != Y(j) 且 Max&#123;&#125;取c[i][j-1]</span></span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span>(c[i<span class="number">-1</span>][j] &gt;= c[i][j - <span class="number">1</span>])</span><br><span class="line">			&#123;</span><br><span class="line">				c[i][j] = c[i<span class="number">-1</span>][j];</span><br><span class="line">				b[i][j] = <span class="number">2</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">// X(i) != Y(j) 且 Max&#123;&#125;取c[i-1][j]</span></span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">			&#123;</span><br><span class="line">				c[i][j] = c[i][j<span class="number">-1</span>];</span><br><span class="line">				b[i][j] = <span class="number">3</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">LCS</span><span class="params">(<span class="type">int</span> i, <span class="type">int</span> j, <span class="type">char</span> *x, <span class="type">int</span> **b)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(i == <span class="number">0</span> || j == <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> ;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//根据前面LCSLength的分解情况，自底向上的递归构建最长公共子序列</span></span><br><span class="line">	<span class="keyword">if</span>(b[i][j] == <span class="number">1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">LCS</span>(i<span class="number">-1</span>, j<span class="number">-1</span>, x, b);</span><br><span class="line">		cout&lt;&lt;x[i]&lt;&lt;endl;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span>(b[i][j] == <span class="number">2</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">LCS</span>(i<span class="number">-1</span>, j, x, b);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">LCS</span>(i, j<span class="number">-1</span>, x, b);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> _tmain(<span class="type">int</span> argc, _TCHAR* argv[])</span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">//LCS,因为LCSLength里面都是以1作为索引来访问x和y的第一个字母，</span></span><br><span class="line">	<span class="comment">//所以这里增加一个额外的&quot; &quot;便于1作为第一个字母的索引</span></span><br><span class="line">	<span class="type">char</span> x[] = &#123;<span class="string">&#x27; &#x27;</span>, <span class="string">&#x27;A&#x27;</span>, <span class="string">&#x27;B&#x27;</span>, <span class="string">&#x27;D&#x27;</span>, <span class="string">&#x27;B&#x27;</span>, <span class="string">&#x27;C&#x27;</span>, <span class="string">&#x27;A&#x27;</span>, <span class="string">&#x27;E&#x27;</span>, <span class="string">&#x27;F&#x27;</span>&#125;;</span><br><span class="line">	<span class="type">char</span> y[] = &#123;<span class="string">&#x27; &#x27;</span>, <span class="string">&#x27;A&#x27;</span>, <span class="string">&#x27;C&#x27;</span>, <span class="string">&#x27;B&#x27;</span>, <span class="string">&#x27;A&#x27;</span>, <span class="string">&#x27;F&#x27;</span>&#125;;</span><br><span class="line">	<span class="type">int</span> **c = <span class="keyword">new</span> <span class="type">int</span>*[<span class="built_in">GetArrayLength</span>(x)];</span><br><span class="line">	<span class="type">int</span> **b = <span class="keyword">new</span> <span class="type">int</span>*[<span class="built_in">GetArrayLength</span>(x)];</span><br><span class="line">	<span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="built_in">GetArrayLength</span>(x); i++)</span><br><span class="line">	&#123;</span><br><span class="line">		c[i] = <span class="keyword">new</span> <span class="type">int</span>[<span class="built_in">GetArrayLength</span>(y)];</span><br><span class="line">		b[i] = <span class="keyword">new</span> <span class="type">int</span>[<span class="built_in">GetArrayLength</span>(y)];</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//因为前面我们额外增加了一个&quot; &quot;，所以这里要减少一个长度计算</span></span><br><span class="line">	<span class="built_in">LCSLength</span>(<span class="built_in">GetArrayLength</span>(x) - <span class="number">1</span>, <span class="built_in">GetArrayLength</span>(y) - <span class="number">1</span>, x, y, c, b);</span><br><span class="line">	<span class="built_in">LCS</span>(<span class="built_in">GetArrayLength</span>(x) - <span class="number">1</span>, <span class="built_in">GetArrayLength</span>(y) - <span class="number">1</span>, x, b);</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/img/Algorithem/LCSLength.PNG" alt="LCSLength"></p>
<p>算法时间复杂度分析：<br>计算最长公共序列的LCSLength耗时O(m x n);<br>构建最长公共序列的LCS递归调用自身使i和j - 1,时间复杂度为O(m + n)</p>
<p>算法改进：<br>c[i][j]可以由c[i-1][j-1],c[i-1][j]和c[i][j-1]推断出来，所以可以节省数组b的空间，但数组c仍需要m x n的空间，所以空间复杂度仍然是O(m x n)</p>
<p>另一个很典型的动态规划事例是0-1背包问题：<br>问题描述：<br>给定n种物品和一背包。物品i的重量是w(i)，其价值为v(i)，背包容量为c。应如何选择装入背包中的物品，使得装入背包中物品的总价值最大？</p>
<p>形式化描述：<br>给定c &gt; 0,w(i) &gt; 0, v(i) &gt; 0, i &lt;&#x3D; i &lt;&#x3D;n,要求找出一个n元0-1向量(x1,x2,x3…..,xn), x(i) ∈ {0, 1}, 1 &lt;&#x3D; i &lt;&#x3D; n,使得∑(i&#x3D; 1 - n)(w(i) x x(i)) &lt;&#x3D; c，而且∑(i&#x3D; 1 - n)(v(i) x x(i))达到最大。<br>转换成式子如下：<br>   max(∑( 1 &lt;&#x3D; i &lt;&#x3D; n)(v(i) x x(i)))<br>{  ∑(i&#x3D; 1 - n)(w(i) x x(i)) &lt;&#x3D; c<br>{  x(i) ∈ {0, 1}, 1 &lt;&#x3D; i &lt;&#x3D; n</p>
<p>分析：<br>最优子结构性质：<br>设(y1,y2……yn)是所给0-1背包问题的一个最优解，则(y2,y3…..yn)是下面相应子问题的一个最优解：<br>   max(∑(2 &lt;&#x3D; i &lt;&#x3D; n)(v(i) x x(i)))<br>{  ∑(2 &lt;&#x3D; i &lt;&#x3D; n)(w(i) x x(i)) &lt;&#x3D; c - w(1) x y(1)<br>{  x(i) ∈ {0, 1}, 2 &lt;&#x3D; i &lt;&#x3D; n</p>
<p>递归关系：<br>0-1背包问题的子问题：<br>   max(∑(i &lt;&#x3D; k &lt;&#x3D; n)(v(k) x x(k)))<br>{  ∑(i &lt;&#x3D; k &lt;&#x3D; n)(w(k) x x(k)) &lt;&#x3D; j<br>{  x(k) ∈ {0, 1}, i &lt;&#x3D; k &lt;&#x3D; n<br>m(i,j)是背包容量为j，可选物品为i,i+1…..n时0-1背包问题的最优解。<br>x(i)表示背包i的选择∈ {0, 1}<br>根据最优子结构性质，可以建立就按m(i,j)的递归式如下：<br>         {  max{m((i+1,j), m(i+1, j - w(i)) + v(i))}    j &gt;&#x3D; w(i)<br>m(i,j) &#x3D; {<br>         {  m(i+1,j)                                    0 &lt;&#x3D; j &lt;&#x3D; w(i)</p>
<pre><code>     &#123;  v(n)   j &gt;= w(n)
</code></pre>
<p>m(n,j) &#x3D; {<br>         {   0     0 &lt;&#x3D; j &lt; w(n)</p>
<p>计算出所有m[i][j]后，我们可以通过判断m[i][c]和m[i+1]<a href="c%E4%B8%BA%E5%BD%93%E5%89%8D%E8%83%8C%E5%8C%85%E5%89%A9%E4%BD%99%E5%AE%B9%E9%87%8F">c</a>是否相同来判断x(i)的值。</p>
<p>算法：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;stdafx.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vld.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;math.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">GetArrayLength</span><span class="params">(T &amp;array)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="type">int</span> length = <span class="built_in">sizeof</span>(array) / <span class="built_in">sizeof</span>(array[<span class="number">0</span>]);</span><br><span class="line">	<span class="keyword">return</span> length;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Knapsack</span><span class="params">(<span class="type">float</span> *v, <span class="type">int</span> *w, <span class="type">int</span> c, <span class="type">int</span> n, <span class="type">float</span> **m)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="type">int</span> jmax = <span class="built_in">fmin</span>(w[n] - <span class="number">1</span>,c);</span><br><span class="line">	<span class="comment">//根据最优子结构性质，m[n - 1][j]的最优解是m[n][j]最优解的子集，</span></span><br><span class="line">	<span class="comment">//我们先构建出m[n][j]时的数据,然后利用m[n][j]的数据去构建m[i][c]  1 &lt;= i &lt; n</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt;= jmax; j++)</span><br><span class="line">	&#123;</span><br><span class="line">		m[n][j] = <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> j = w[n]; j &lt;= c; j++)</span><br><span class="line">	&#123;</span><br><span class="line">		m[n][j] = v[n];</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//利用m[n][j]去构建m[i][j]   1 &lt;= i &lt; n</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = n - <span class="number">1</span>; i &gt; <span class="number">1</span>; i--)</span><br><span class="line">	&#123;</span><br><span class="line">		jmax = <span class="built_in">fmin</span>(w[i] - <span class="number">1</span>, c);</span><br><span class="line">		<span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt;= jmax; j++)</span><br><span class="line">		&#123;</span><br><span class="line">			m[i][j] = m[i + <span class="number">1</span>][j];</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">for</span> (<span class="type">int</span> j = w[i]; j &lt;= c; j++)</span><br><span class="line">		&#123;</span><br><span class="line">			m[i][j] = <span class="built_in">fmax</span>(m[i + <span class="number">1</span>][j], m[i + <span class="number">1</span>][j - w[i]] + v[i]);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//Finally, we can get m[1][c] from c[2][c]</span></span><br><span class="line">	m[<span class="number">1</span>][c] = m[<span class="number">2</span>][c];</span><br><span class="line">	<span class="keyword">if</span> (c &gt;= w[<span class="number">1</span>])</span><br><span class="line">	&#123;</span><br><span class="line">		m[<span class="number">1</span>][c] = <span class="built_in">fmax</span>(m[<span class="number">2</span>][c], m[<span class="number">2</span>][c - w[<span class="number">1</span>]] + v[<span class="number">1</span>]);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Traceback</span><span class="params">(<span class="type">float</span> **m, <span class="type">int</span> *w, <span class="type">int</span> c, <span class="type">int</span> n, <span class="type">int</span> *x)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt; n; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (m[i][c] == m[i + <span class="number">1</span>][c])</span><br><span class="line">		&#123;</span><br><span class="line">			x[i] = <span class="number">0</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			x[i] = <span class="number">1</span>;</span><br><span class="line">			c -= w[i];</span><br><span class="line">			cout &lt;&lt; <span class="string">&quot;Put &quot;</span> &lt;&lt; i &lt;&lt; <span class="string">&quot; into the bag!&quot;</span> &lt;&lt; endl;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//check for last one</span></span><br><span class="line">	x[n] = m[n][c] ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">if</span> (x[n] == <span class="number">1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		cout &lt;&lt; <span class="string">&quot;Put &quot;</span> &lt;&lt; n &lt;&lt; <span class="string">&quot; into the bag!&quot;</span> &lt;&lt; endl;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> _tmain(<span class="type">int</span> argc, _TCHAR* argv[])</span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">//0-1背包问题</span></span><br><span class="line">	<span class="comment">//因为我们从v[1]开始访问当做第一个背包的价值，</span></span><br><span class="line">	<span class="comment">//所以这里加一个0在最前面方便从1开始索引</span></span><br><span class="line">	<span class="type">float</span> v[] = &#123; <span class="number">0</span>, <span class="number">1</span>, <span class="number">5</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">6</span>, <span class="number">8</span>, <span class="number">3</span> &#125;;</span><br><span class="line">	<span class="type">int</span> w[] = &#123; <span class="number">0</span>, <span class="number">4</span>, <span class="number">3</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">1</span> &#125;;</span><br><span class="line">	<span class="type">int</span> c = <span class="number">20</span>;</span><br><span class="line">	<span class="comment">//减掉我们额外增加的第一个</span></span><br><span class="line">	<span class="type">int</span> n = <span class="built_in">GetArrayLength</span>(v) - <span class="number">1</span>;</span><br><span class="line">	<span class="type">float</span> **m = <span class="keyword">new</span> <span class="type">float</span>*[<span class="built_in">GetArrayLength</span>(v)];</span><br><span class="line">	<span class="comment">//为了从1开始索引</span></span><br><span class="line">	<span class="type">int</span> *x = <span class="keyword">new</span> <span class="type">int</span>[n + <span class="number">1</span>];</span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="built_in">GetArrayLength</span>(v); i++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">//m[i][j]    1 &lt;= j &lt;= n用于表示背包容量为j，可选物品为i,i+1....n是0-1背包问题的最优解</span></span><br><span class="line">		<span class="comment">//为了m[i][c]来访问背包重量为c的时候的最优解，这里需要额外增加数组长度1</span></span><br><span class="line">		m[i] = <span class="keyword">new</span> <span class="type">float</span>[c + <span class="number">1</span>];</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">Knapsack</span>(v, w, c, n, m);</span><br><span class="line">	<span class="built_in">Traceback</span>(m, w, c, n, x);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="built_in">GetArrayLength</span>(v); i++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">delete</span> m[i];</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">delete</span> x;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/img/Algorithem/01Knapsack.PNG" alt="01Knapsack"></p>
<p>算法复杂度分析：<br>计算m[i][j]的递归式可以看出，算法Knapsack需要O(nc)计算时间，Traceback需要O(n)计算时间</p>
<p>算法缺点：</p>
<ol>
<li>w[i]要求是整数</li>
<li>当c很大的时候，算法Knapsack时间复杂度很大</li>
</ol>
<p>算法改进：<br>详情参考计算机算法设计与分析(第3版)</p>
<h3 id="贪心算法"><a href="#贪心算法" class="headerlink" title="贪心算法"></a>贪心算法</h3><p>基本思想：<br>贪心算法通过一系列的选择来得到问题的解。它所做的每一个选择都是当前状态下局部最好选择，即贪心选择。</p>
<p>基本要素：</p>
<ol>
<li>贪心选择性质<br>贪心选择性质是指所求问题的整体最优解可以通过一系列局部最优的选择，即贪心选择来达到。(贪心算法以自顶向下的方式进行，以迭代的方式做出相继的贪心选择，每做一次贪心选择就将所求问题简化为规模更小的子问题)</li>
<li>最优子结构性质<br>最优解包含其子问题的最优解时，称此问题具有最优子结构性质。</li>
</ol>
<p>下面结合背包问题来区分动态规划和贪心算法在实际应用中的区别：<br>问题描述：<br>背包问题与0-1背包问题类似，所不同的是在选择物品i装入背包时，可以选择物品i的一部分，而不一定要全部装入背包，1 &lt;&#x3D; i &lt;&#x3D; n。</p>
<p>最优子结构性质分析：<br>若它的一个最优解包含物品j，则从该最优解中拿出所含的物品j的那部分重量w，剩余的将是n-1个原重量物品1,2,…,j-1,j+1,…,n及重为w(j)-w的物品j中可装入容量为c-w的背包且具有最大价值的物品。</p>
<p>贪心选择性质分析：<br>按单位价值为依据(局部最优)进行选择(贪心选择)，可使最终装满背包时，价值最大。</p>
<p>贪心算法解背包问题的基本步骤：</p>
<ol>
<li>计算每种物品单位重量的价值v(i)&#x2F;w(i)</li>
<li>依贪心选择策略，将尽可能多的单位重量价值最高的物品装入背包。</li>
<li>若将这种物品全部装入背包后，背包内的物品总重量未超过c，则选择单位重量价值次高的物品并尽可能多的装入背包。</li>
<li>依次策略，直到背包装满为止。</li>
</ol>
<p>贪心选择对于0-1背包问题就不能得到最优解，因为它无法保证最终背包能装满，部分闲置的背包空间使每千克背包空间的价值降低了。所以在考虑0-1背包问题时，应比较选择该物品和不选择该物品所导致的最终方案，然后做出最好选择，而不是按最优单位价值(局部最优)来选。</p>
<h3 id="回溯法算法"><a href="#回溯法算法" class="headerlink" title="回溯法算法"></a>回溯法算法</h3><p>回溯法的算法框架：</p>
<ol>
<li>问题的解空间<br>解空间包含所有可能的答案</li>
<li>回溯法的基本思想<br>在问题的解空间树种，按深度优先策略，从根节点触发搜索解空间树。算法搜索到任一节点时，先判断该节点是否包含问题的解，如果不包含，则以该节点为根节点以深度优先搜索。直到搜索到叶节点也没找到问题解时，回溯到最近一个非叶节点继续搜索，知道所有节点都搜索完成为止。</li>
</ol>
<p>接下来以0-1背包问题为例来学习理解回溯法：<br>假设0-1背包n &#x3D; 3，w &#x3D; [16, 15, 15] v &#x3D; [45, 25, 25] c&#x3D; 30<br>解空间为：<br>{(0,0,0), (0,1,0), (0,0,1), (1,0,0), (0,1,1), (1,0,1), (1,1,0), (1,1,1)}<br><img src="/img/Algorithem/Backtracking.PNG" alt="Backtracking"><br>因为是以深度优先搜索，所以是延A -&gt; B -&gt; D -&gt; H -&gt; D -&gt; I -&gt; D -&gt; B -&gt; E -&gt; J -&gt; K的顺序来搜索，直到回溯完所有的解空间节点或找到答案为止。</p>
<p>问题:<br>上述回溯法把所有的解空间都搜索了一遍，时间和空间复杂度大。</p>
<p>优化：<br>回溯法通常采用两种策略避免无效搜索，提高回溯法的搜索效率：</p>
<ol>
<li>用约束函数在扩展结点处剪去不满足约束条件的子树。</li>
<li>用限界函数剪去得不到最优解的子树。(两个函数统称为剪枝函数)</li>
</ol>
<p>在0-1背包里左子树表示装载当前背包，右子树表示不装载当前背包。<br>所以在针对剪枝函数的优化上，我们可以在判断只有在右子树中有可能包含最优解时才进入。设r是当前剩余物品价值总和；cp是当前价值；bestp是当前最优价值。当cp + r &lt;&#x3D; bestp时，可剪去右子树。</p>
<p>正确的选取r是优化的关键之一：<br>我们可以通过按背包问题里贪心算法的方式计算出当前剩余物品的最优值(算出当前剩余物品最多还能增加的价值)作为上界剪枝。</p>
<p>代码实现:<br>Utilites.h</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;stdafx.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">GetArrayLength</span><span class="params">(T &amp;array)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="type">int</span> length = <span class="built_in">sizeof</span>(array) / <span class="built_in">sizeof</span>(array[<span class="number">0</span>]);</span><br><span class="line">	<span class="keyword">return</span> length;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Knap.h</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;stdafx.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Knap</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">Knap</span>(<span class="type">float</span> *v, <span class="type">int</span> *w, <span class="type">int</span> c, <span class="type">int</span> n);</span><br><span class="line"></span><br><span class="line">	~<span class="built_in">Knap</span>();</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">Backtrack</span><span class="params">(<span class="type">int</span> i)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="type">float</span> <span class="title">GetBestp</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	<span class="function"><span class="type">float</span> <span class="title">Bound</span><span class="params">(<span class="type">int</span> i)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//把物品按单位价值降序排列</span></span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">Sort</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="type">int</span> mC; <span class="comment">//背包容量</span></span><br><span class="line"></span><br><span class="line">	<span class="type">int</span> mN; <span class="comment">//物品数量</span></span><br><span class="line"></span><br><span class="line">	<span class="type">int</span> *mW; <span class="comment">//物品重量</span></span><br><span class="line"></span><br><span class="line">	<span class="type">float</span> *mV; <span class="comment">//物品价值</span></span><br><span class="line"></span><br><span class="line">	<span class="type">int</span> mCW; <span class="comment">//当前重量</span></span><br><span class="line"></span><br><span class="line">	<span class="type">float</span> mCV; <span class="comment">//当前价值</span></span><br><span class="line"></span><br><span class="line">	<span class="type">float</span> mBestp; <span class="comment">//当前最优价值</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>Knap.cpp</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;stdafx.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Knap.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Utilties.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">Knap::<span class="built_in">Knap</span>(<span class="type">float</span> *v, <span class="type">int</span> *w, <span class="type">int</span> c, <span class="type">int</span> n)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">assert</span>(c &gt; <span class="number">0</span>);</span><br><span class="line">	<span class="built_in">assert</span>(n &gt; <span class="number">0</span>);</span><br><span class="line">	mC = c;</span><br><span class="line">	mN = n;</span><br><span class="line">	mW = w;</span><br><span class="line">	mV = v;</span><br><span class="line">	mCW = <span class="number">0</span>;</span><br><span class="line">	mCV = <span class="number">0</span>; </span><br><span class="line">	mBestp = <span class="number">0</span>;</span><br><span class="line">	<span class="built_in">Sort</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Knap::Backtrack</span><span class="params">(<span class="type">int</span> i)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//到达叶节点</span></span><br><span class="line">	<span class="keyword">if</span> (i &gt; mN)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">//到了叶节点后记录最优值</span></span><br><span class="line">		mBestp = mCV;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//进入左子树</span></span><br><span class="line">	<span class="keyword">if</span> (mCW + mW[i] &lt;= mC)</span><br><span class="line">	&#123;</span><br><span class="line">		mCW += mW[i];</span><br><span class="line">		mCV += mV[i];</span><br><span class="line">		<span class="comment">//深度优先扩张</span></span><br><span class="line">		<span class="built_in">Backtrack</span>(i + <span class="number">1</span>);</span><br><span class="line">		<span class="comment">//回溯到i时，我们需要在判断是否进入右子树之前把mCW和mCV的值回复到正确的值。</span></span><br><span class="line">		mCW -= mW[i];</span><br><span class="line">		mCV -= mV[i];</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//进入右子树</span></span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">Bound</span>(i + <span class="number">1</span>) &gt; mBestp)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">//继续深度优先扩张</span></span><br><span class="line">		<span class="built_in">Backtrack</span>(i + <span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">float</span> <span class="title">Knap::GetBestp</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> mBestp;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//计算cp + r &lt;= bestp中r的值</span></span><br><span class="line"><span class="comment">//通过把剩余物品按贪心算法的背包问题来计算出最优值上界</span></span><br><span class="line"><span class="function"><span class="type">float</span> <span class="title">Knap::Bound</span><span class="params">(<span class="type">int</span> i)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="type">int</span> cleft = mC - mCW; <span class="comment">//剩余容量</span></span><br><span class="line"></span><br><span class="line">	<span class="type">float</span> b = mCV; <span class="comment">//当前价值</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//以物品单位重量价值递减序装入物品</span></span><br><span class="line">	<span class="keyword">while</span> (i &lt;= mN &amp;&amp; mW[i] &lt;= cleft)</span><br><span class="line">	&#123;</span><br><span class="line">		cleft -= mW[i];</span><br><span class="line">		b += mV[i];</span><br><span class="line">		i++;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//装满背包</span></span><br><span class="line">	<span class="keyword">if</span> (i &lt;= mN)</span><br><span class="line">	&#123;</span><br><span class="line">		b += mV[i] * cleft / mW[i];</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Knap::Sort</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">assert</span>(mN &gt; <span class="number">0</span>);</span><br><span class="line">	<span class="type">float</span> *pervalue = <span class="keyword">new</span> <span class="type">float</span>[mN];</span><br><span class="line">	pervalue[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt;= mN; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		pervalue[i] = mV[i] / mW[i];</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//双重循环都跟数据大小有关</span></span><br><span class="line">	<span class="comment">//所以冒泡排序平均时间复杂度是O(square(n))</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt;= mN; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">for</span> (<span class="type">int</span> j = i + <span class="number">1</span>; j &lt;= mN; j++)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span> (pervalue[i] &lt; pervalue[j])</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="built_in">swap</span>(mV[i], mV[j]);</span><br><span class="line">				<span class="built_in">swap</span>(mW[i], mW[j]);</span><br><span class="line">				<span class="built_in">swap</span>(pervalue[i], pervalue[j]);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Knap::~<span class="built_in">Knap</span>()</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>main.cpp</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> _tmain(<span class="type">int</span> argc, _TCHAR* argv[])</span><br><span class="line">&#123;	</span><br><span class="line">	<span class="comment">//0-1背包回溯算法</span></span><br><span class="line">	<span class="comment">//因为我们从v[1]开始访问当做第一个背包的价值，</span></span><br><span class="line">	<span class="comment">//所以这里加一个0在最前面方便从1开始索引</span></span><br><span class="line">	<span class="type">float</span> v[] = &#123; <span class="number">0</span>, <span class="number">1</span>, <span class="number">5</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">6</span>, <span class="number">8</span>, <span class="number">3</span> &#125;;</span><br><span class="line">	<span class="type">int</span> w[] = &#123; <span class="number">0</span>, <span class="number">4</span>, <span class="number">3</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">1</span> &#125;;</span><br><span class="line">	<span class="type">int</span> c = <span class="number">20</span>;</span><br><span class="line">	<span class="comment">//减掉我们额外增加的第一个</span></span><br><span class="line">	<span class="type">int</span> n = <span class="built_in">GetArrayLength</span>(v) - <span class="number">1</span>;</span><br><span class="line">	Knap *knap = <span class="keyword">new</span> <span class="built_in">Knap</span>(v, w, c, n);</span><br><span class="line"></span><br><span class="line">	knap-&gt;<span class="built_in">Backtrack</span>(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">	cout &lt;&lt; <span class="string">&quot;knap-&gt;GetBestp() = &quot;</span> &lt;&lt; knap-&gt;<span class="built_in">GetBestp</span>() &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">delete</span> knap;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/img/Algorithem/BacktrackingResult.PNG" alt="BacktrackingResult"></p>
<p>时间复杂度分析：<br>Knap::Sort()排序采用冒泡排序，时间复杂度为：<br>平均时间复杂度：O(square(n))<br>最坏时间复杂度：O(square(n)) （每一次比较都需要交换）<br>最优时间复杂度：O(n) （第一次循环就完成所有排序而无需进行后面的，需要判断结束条件）</p>
<p>Knap::Bound()计算上界剪枝需要O(n)<br>最坏情况下有O(Pow(2,n))个右节点，所以回溯算法的最坏时间复杂度为O(n x Pow(2,n))<br>跟动态规划解0-1背包的O(nc)时间复杂度相比，回溯算法的时间复杂度大得多。</p>
<p>Note:<br>剪枝函数(约束函数和上界函数)的选取是回溯法性能的关键。</p>
<h3 id="分支限界法"><a href="#分支限界法" class="headerlink" title="分支限界法"></a>分支限界法</h3><p>待续…..</p>
<h1 id="STL"><a href="#STL" class="headerlink" title="STL"></a>STL</h1><p>C++里将数据结构和算法运用的比较好的就不得不提STL了。</p>
<h2 id="STL-1"><a href="#STL-1" class="headerlink" title="STL"></a>STL</h2><p>STL(标准模板库)是C++标准程序库的核心，是一个泛型程序库，利用先进，高效的算法来管理数据。</p>
<h2 id="STL组件"><a href="#STL组件" class="headerlink" title="STL组件"></a>STL组件</h2><ol>
<li>容器(Containers)<br>用来管理某类对象的集合。</li>
<li>迭代器(Iterators)<br>用来在一个对象群集(Collection of objects)的元素上进行遍历动作</li>
<li>算法(Algorithoms)<br>用来处理群集内的元素。(比如搜寻，排序，修改，使用等)</li>
</ol>
<p>“STL的基本观念就是将数据和操作分离。数据由容器类加以管理，操作则由可定制的算法定义。迭代器在两者之间充当粘合剂是的任何算法都可以和任何容器运作。”<br><img src="/img/CPP/STLComponentsRelationship.PNG" alt="STLComponentsRelationship"></p>
<p>STL将数据和算法分开对待，这和面向对象设计(OOP)的思想是矛盾的。<br>但这么做的好处是：<br>可以将各容器与各算法结合起来。</p>
<p>STL的特性一：<br>泛型，可以针对任意类型运作</p>
<p>Note:<br>“STL甚至提供更泛型化的组件。通过特定的适配器(adapters)和仿函数(functors)，你可以补充，约束或定制算法，以满足特别需求。”</p>
<h3 id="容器-Containers"><a href="#容器-Containers" class="headerlink" title="容器(Containers)"></a>容器(Containers)</h3><p>容器可分为两类：</p>
<ol>
<li>Sequence Containers<br>“可序(ordered)群集，每个元素均有固定位置–取决于插入时机和地点，和元素值无关。”<br>vector，deque，list<br>Vectors特点(Vector将其元素置于一个dynamic array)：<ol>
<li>允许随机存储。</li>
<li>非尾部插入会比较费时(要保持原本的相对次序，导致元素移动)</li>
<li>动态扩容<br>Deques特点(double-ended queue是一个dynamic array，可以向两端发展)：</li>
<li>允许随机存储</li>
<li>头部和尾部插入迅速</li>
<li>中间部分插入费时(导致元素移动)</li>
<li>动态扩容<br>Lists特点(doubly linked list，分散存储内存):</li>
<li>不提供随机存取(因为是分散存储的)</li>
<li>访问元素费时(沿着链表节点访问)</li>
<li>插入和删除快速(因为只需要改变链接点即可)</li>
<li>动态扩容</li>
</ol>
</li>
<li>Associative Containers<br>“已序(sorted)群集，元素位置取决于特定的排序准则。”<br>set，multiset，map，multimap<br>Sets特点:<ol>
<li>依据值自动排序</li>
<li>每个元素值只允许出现一次</li>
<li>动态扩容<br>Multisets特点：</li>
<li>依据值自动排序</li>
<li>允许重复元素</li>
<li>动态扩容<br>Maps特点：</li>
<li>采用键值对存储，根据键值排序</li>
<li>键值不允许重复</li>
<li>动态扩容<br>Multimaps特点：</li>
<li>采用键值对存储，根据键值排序</li>
<li>允许键值重复</li>
<li>动态扩容</li>
</ol>
</li>
</ol>
<p>除了上述容器，C++标准成宿还提供了一些特别的Container Adapters。<br>Container Adapaters：</p>
<ol>
<li>Stacks<br>LIFO(后进先出)</li>
<li>Queues<br>FIFO(先进先出)</li>
<li>Priority Queues<br>元素按优先级排序</li>
</ol>
<p>Note:<br>“通常关联式容器由二叉树(binary tree)实现。”</p>
<p>容器的共同能力：</p>
<ol>
<li>所有容器提供的都是“Value语意”而非“Reference语意”<br>Value语意 VS Reference语意<br>“STL只支持value语意，不支持reference语意”<br>好处：<ol>
<li>元素拷贝简单</li>
<li>使用references时容易导致错误<br>缺点：</li>
<li>“拷贝元素”可能导致不好的性能</li>
<li>无法在数个不同的容器中管理同一份对象</li>
</ol>
</li>
<li>所有元素形成一个次序(返回iterator的接口用于访问所有元素)</li>
<li>各项操作并非绝对安全。调用者必须确保传给操作函数的参数符合需求。</li>
</ol>
<p>Note:<br>实现Reference语意需要通过智能指针(e.g. share_ptr)</p>
<p>容器的共同操作：</p>
<ol>
<li>初始化</li>
<li>大小相关操作函数(size(),empty(),max_size())</li>
<li>比较(&#x3D;&#x3D;,!&#x3D;,&lt;,&lt;&#x3D;,&gt;,&gt;&#x3D;)</li>
</ol>
<p>Value语意也就引出了容器元素的条件：</p>
<ol>
<li>必须可透过copy构造函数进行复制</li>
<li>必须可以透过assignment操作符完成赋值动作</li>
<li>必须可以透过析构函数完成销毁动作</li>
</ol>
<p>如何选择合适的Container？<br>根据以下规则：</p>
<ol>
<li>缺省情况下使用vector，vector内部结构简单，支持随机存储</li>
<li>如果经常要在头部和尾部安插和移除元素，采用deque</li>
<li>如果需要经常在容器的中段执行元素的插入，移除和移动，可以考虑使用list</li>
<li>如果经常需要根据某个准则来搜寻元素，那么应当使用“以该排序准则对元素进行排序”的set或multiset(hash table比二叉树更快，对于无需排序的元素，推荐用hash table)</li>
<li>如果想处理key&#x2F;value pair，采用map或multimap</li>
<li>如果需要关联式数组，应用map</li>
<li>如果需要字典结构，应用multimap</li>
</ol>
<p>STL Container能力详情参见：<br><img src="/img/CPP/STLContainerCapabilities.PNG" alt="STLContainerCapabilities"></p>
<h4 id="容器内的类型和成员"><a href="#容器内的类型和成员" class="headerlink" title="容器内的类型和成员"></a>容器内的类型和成员</h4><p>容器内的类型：<br>container::value_type – 元素类型<br>container::reference –元素的引用类型<br>container::const_reference – 常数元素的引用类型<br>container::iterator – 迭代器类型<br>container::const_iterator – 常数迭代器的类型<br>container::const_reverse_iteator – 常数反向迭代器的类型<br>container::size_type – 无符号整数类型，用以定义容器大小<br>container::difference_type – 正整数类型，用以定义距离<br>container::key_type – 用以定义关联式容器的元素内的key类型<br>container::mapped_type – 用以定义关联式容器的元素内的value类型<br>container::key_compare – 关联式容器内的“比较准则”的类型<br>container::value_compare – 整个元素”比较准则”的类型<br>container::allocator_type – 配置器类型</p>
<p>生成，复制，销毁,非变动性操作,赋值,元素存储,返回迭代器操作,元素insert和remove:<br>……<br>……</p>
<h3 id="迭代器-Iterators"><a href="#迭代器-Iterators" class="headerlink" title="迭代器(Iterators)"></a>迭代器(Iterators)</h3><p>什么是迭代器(Iteratos)？<br>“迭代器是一个“可遍历STL容器内全部或部分元素”的对象。”</p>
<p>Note:<br>“迭代器奉行一个村抽象概念：任何东西，只要行为类似迭代器，就是一种迭代器。不同的迭代器具有不同的“能力”(指行进和存储能力)”</p>
<p>迭代器分类：<br><img src="/img/CPP/STLIteratorClassification.PNG" alt="STLIteratorClassification"></p>
<p>迭代器的能力取决于容器的内部结构，所以根据能力来分类的话：</p>
<ol>
<li>双向迭代器(Bidirectional iterator)<br>支持双向行进(++ –)(list, set, multiset, map, multimap)</li>
<li>随机存取迭代器(Random access iterator)<br>支持双向行进同时具备随机访问(&lt; &gt;等)(vector, deque)</li>
</ol>
<p>“为了编写与容器类型无关的泛型程序编码，最好不要使用随机存取迭代器。(因为不是所有的容器都支持随机迭代器)”</p>
<p>比如如下代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(pos = coll.<span class="built_in">begin</span>(); pos &lt; col.<span class="built_in">end</span>(); ++pos)</span><br><span class="line">&#123;</span><br><span class="line">	.......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面使用的&lt;就是随机存储迭代器才支持的。</p>
<p>Note:<br>是否支持特定迭代器跟迭代器的能力和容器的内部结构挂钩(比如List因为是链接形式所以肯定不支持Random access iterator的随机访问的)。</p>
<p>迭代器操作：</p>
<ol>
<li>Operator *<br>返回当前元素值</li>
<li>Operator ++<br>访问下一个元素</li>
<li>Operators &#x3D;&#x3D;<br>判断迭代器是否指向同一位置</li>
<li>Operators ！&#x3D;<br>判断迭代器是否指向同一位置</li>
<li>Operator &#x3D;<br>为迭代器赋值</li>
</ol>
<p>“迭代器是个所谓的smart pointers，具有遍历复杂数据结构的能力。其下层运行机制取决于其所遍历的数据结构。因此，每一种容器类型都必须提供自己的迭代器。”</p>
<p>容器类提供的迭代器访问相关函数：</p>
<ol>
<li>begin()<br>返回一个迭代器，指向容器的起始点</li>
<li>end()<br>返回一个迭代器，指向容器结束点(最后一个元素之后)</li>
</ol>
<p>读写方式区分：</p>
<ol>
<li>iterator<br>支持读&#x2F;写模式</li>
<li>const_iterator<br>只读模式</li>
</ol>
<p>这里通过简单的使用Set container为例，对iterator和自定义比较函数做个了解：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// STLStudy.cpp : Defines the entry point for the console application.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;stdafx.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Greater</span><span class="params">(<span class="type">const</span> T&amp; p1, <span class="type">const</span> T&amp; p2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> p1 &gt; p2;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> _tmain(<span class="type">int</span> argc, _TCHAR* argv[])</span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">//Associative Container</span></span><br><span class="line">	<span class="built_in">bool</span>(*fn_pt)(<span class="type">const</span> <span class="type">int</span>&amp;,<span class="type">const</span> <span class="type">int</span>&amp;) = Greater&lt;<span class="type">int</span>&gt;;</span><br><span class="line">	<span class="function">set&lt;<span class="type">int</span>, <span class="title">bool</span><span class="params">(*)</span><span class="params">(<span class="type">const</span> <span class="type">int</span>&amp;,<span class="type">const</span> <span class="type">int</span>&amp;)</span>&gt; <span class="title">s</span><span class="params">(fn_pt)</span></span>;</span><br><span class="line"></span><br><span class="line">	s.<span class="built_in">insert</span>(<span class="number">4</span>);</span><br><span class="line">	s.<span class="built_in">insert</span>(<span class="number">3</span>);</span><br><span class="line">	s.<span class="built_in">insert</span>(<span class="number">2</span>);</span><br><span class="line">	s.<span class="built_in">insert</span>(<span class="number">6</span>);</span><br><span class="line">	s.<span class="built_in">insert</span>(<span class="number">5</span>);</span><br><span class="line">	s.<span class="built_in">insert</span>(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">	set&lt;<span class="type">int</span>&gt;::const_iterator set_const_iterator;</span><br><span class="line">	<span class="keyword">for</span> (set_const_iterator = s.<span class="built_in">begin</span>(); set_const_iterator != s.<span class="built_in">end</span>(); ++set_const_iterator)</span><br><span class="line">	&#123;</span><br><span class="line">		cout &lt;&lt; *set_const_iterator&lt;&lt;endl;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/img/CPP/SetIteratorAndCompareFunction.PNG" alt="SetIteratorAndCompareFunction"><br>从上面可以看到set有自己对应的iterator去访问set container里的元素，同时我们也可以传递一个自定义的比较函数作为set container排序的依据。</p>
<p>迭代器相关辅助函数：</p>
<ol>
<li>advance() – 可令迭代器前进</li>
<li>distance() – 计算两个迭代器之间的距离</li>
<li>iter_swap() – 交换两个迭代器所指内容</li>
</ol>
<p>Iterator Adapter：</p>
<ol>
<li>Insert iterators<br>使算法以安插(insert)方式而非覆写(overwrite)方式运作<ol>
<li>Back inserters(安插于容器最尾端)</li>
<li>Front inserters(安插于容器最前端)</li>
<li>General inserters(安插到指定位置)</li>
</ol>
</li>
<li>Stream iterators<br>用于读写stream的迭代器。</li>
<li>Reverse iterators<br>以逆方向进行所有操作(++相当于–  –相当于++)<br>通过容器的rbegin()，rend()可以获得Reverse iterators</li>
</ol>
<p>迭代器特性(Iterator Traits):<br>“迭代器可以区分为不同类型，每个类型都具有特定的迭代器功能。如果能根据不同的迭代器类型，将操作行为重载，将会很有用，甚至很必要。透过迭代器标记(tags)和特性(traits)可以实现这样的重载。”</p>
<p>首先来看看迭代器标志的定义：<br><img src="/img/CPP/STLIteratorTags.PNG" alt="STLIteratorTags"></p>
<p>接下来是迭代器特性(包含迭代器相关的所有信息)的定义：<br><img src="/img/CPP/STLIteratorTraits.PNG" alt="STLIteratorTraits"><br>“有了上面这个template，T表示迭代器类型，我们就可以撰写任何运用“迭代器类型或其元素类型”等特征的泛型程序代码”</p>
<p>iterator_traits<T>结构描述了迭代器相关的类型信息。<br>针对特定的迭代器(一般指针作为迭代器时)需要特化版本：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> std&#123;</span><br><span class="line">	<span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt;</span><br><span class="line">	<span class="keyword">struct</span> <span class="title class_">iterator_traits</span>&lt;T*&gt;&#123;</span><br><span class="line">		<span class="keyword">typedef</span> T                            value_type;</span><br><span class="line">		<span class="keyword">typedef</span> <span class="type">ptrdiff_t</span>                    difference_type;</span><br><span class="line">		<span class="keyword">typedef</span> random_access_iterator_tag   iterator_category</span><br><span class="line">		<span class="keyword">typedef</span> T*                           pointer;</span><br><span class="line">		<span class="keyword">typedef</span> T&amp;                           reference;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>比如元素环形移动：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">class</span> Forwarditerator&gt;</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">shift_left</span><span class="params">(Forwarditerator beg, Forwarditerator end)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//temporary variable for first element</span></span><br><span class="line">	<span class="keyword">typedef</span> <span class="keyword">typename</span> std::iterator_traits&lt;Forwarditerator&gt;::value_type value_type;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(beg != end)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">//save value of first element</span></span><br><span class="line">		<span class="function">value_type <span class="title">temp</span><span class="params">(*beg)</span></span>;</span><br><span class="line"></span><br><span class="line">		<span class="comment">//shift following values</span></span><br><span class="line">		......</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过把迭代器类型作为模板参数通过iterator_traits访问该迭代器类型的value_type。</p>
<p>iterator_traits里的iterator_category可以帮助我们写出针对不同迭代器类型的函数。<br>接下来结合distance()的实现来学习理解</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">iterator</span>&gt;</span><br><span class="line"><span class="keyword">typename</span> std::iterator_traits&lt;iterator&gt;::<span class="function">difference_type <span class="title">distance</span><span class="params">(iterator pos1, iterator pos2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">distance</span>(pos1, pos2, std::iterator_traits&lt;iterator&gt;::<span class="built_in">iterator_category</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">Raiterator</span>&gt;</span><br><span class="line"><span class="keyword">typename</span> std::iterator_traits&lt;Raiterator&gt;::<span class="function">difference_type <span class="title">foo</span><span class="params">(Raiterator pos1, Raiterator pos2, std::random_access_iterator_tag)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> pos2 - pos1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">Initerator</span>&gt;</span><br><span class="line"><span class="keyword">typename</span> std::iterator_traits&lt;Initerator&gt;::<span class="function">difference_type <span class="title">foo</span><span class="params">(Initerator pos1, Initerator pos2, std::input_iterator_tag)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">typename</span> std::iterator_traits&lt;Initerator&gt;::difference_type d;</span><br><span class="line">	<span class="keyword">for</span>(d = <span class="number">0</span>; pos1 != pos2; ++pos1, ++d)</span><br><span class="line">	&#123;</span><br><span class="line">		;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> d;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>根据传递迭代器类型iterator_category()作为第三个参数，我们可以写出针对不同迭代器类型的distance方法实现。根据迭代器是否支持随机访问，我们写出了不同的distance计算实现。<br>Note：<br>difference_type代表迭代器距离类型。同时std::tag对于子类同时有效。</p>
<p>如何自定义迭代器？<br>可以看出迭代器必须具有iterator_traits结构所描述的类型定义，用于描述迭代器相关类型信息。</p>
<ol>
<li>提供必要的五种类型定义(iterator_traits里定义的)</li>
<li>提供一个特化版本(用于一般指针迭代器)的iterator_traits结构</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;stdafx.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> Container&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyInsertIterator</span> : <span class="keyword">public</span> std::iterator&lt;std::output_iterator_tag, <span class="type">void</span>, <span class="type">void</span>, <span class="type">void</span>, <span class="type">void</span>&gt;</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">	Container&amp; container;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="function"><span class="keyword">explicit</span> <span class="title">MyInsertIterator</span><span class="params">(Container&amp; c)</span> : container(c)</span></span><br><span class="line"><span class="function">	&#123;</span></span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	MyInsertIterator&lt;Container&gt;&amp; <span class="keyword">operator</span>= (<span class="type">const</span> <span class="keyword">typename</span> Container::value_type&amp; value)</span><br><span class="line">	&#123;</span><br><span class="line">		container.<span class="built_in">insert</span>(value);</span><br><span class="line">		<span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	MyInsertIterator&lt;Container&gt;&amp; <span class="keyword">operator</span>* ()</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	MyInsertIterator&lt;Container&gt;&amp; <span class="keyword">operator</span>++ ()</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	MyInsertIterator&lt;Container&gt;&amp; <span class="keyword">operator</span>++ (<span class="type">int</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//convenience function to create the MyInsertIterator</span></span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">class</span> Container&gt;</span></span><br><span class="line"><span class="function"><span class="keyword">inline</span> MyInsertIterator&lt;Container&gt; <span class="title">MyInsert</span><span class="params">(Container&amp; c)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">MyInsertIterator</span>&lt;Container&gt;(c);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试程序</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;stdafx.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;MyInsertIterator.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> _tmain(<span class="type">int</span> argc, _TCHAR* argv[])</span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">//My own Iterator part</span></span><br><span class="line">	set&lt;<span class="type">int</span>&gt; coll;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//create MyInsertIterator for coll</span></span><br><span class="line">	MyInsertIterator&lt;set&lt;<span class="type">int</span>&gt;&gt; <span class="built_in">iter</span>(coll);</span><br><span class="line">	*iter = <span class="number">1</span>;</span><br><span class="line">	iter++;</span><br><span class="line">	*iter = <span class="number">2</span>;</span><br><span class="line">	iter++;</span><br><span class="line">	*iter = <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">PrintAll</span>(coll);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">MyInsert</span>(coll) = <span class="number">44</span>;</span><br><span class="line">	<span class="built_in">MyInsert</span>(coll) = <span class="number">55</span>;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">PrintAll</span>(coll);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/img/CPP/STLOwnIterator.PNG" alt="STLOwnIterator"><br>把iterator作为父类，通过设定模板参数设置iterator_traits里需要设定的类型相关信息。<br>通过重载各个运算符实现我们自己的迭代器支持的操作。</p>
<p>Note：<br>“Iterator traits是掌握STL编程技术的关键。”</p>
<h3 id="算法-Algorithms"><a href="#算法-Algorithms" class="headerlink" title="算法(Algorithms)"></a>算法(Algorithms)</h3><p>“算法并非容器类的成员函数，而是一种搭配迭代器使用的全局函数。”</p>
<p>这样做的好处：<br>“不必为每一种容器量身定制算法，所有算法只需一份。”</p>
<p>先来看看实战使用：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;stdafx.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> _tmain(<span class="type">int</span> argc, _TCHAR* argv[])</span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">//cout &lt;&lt; MyClass::mID &lt;&lt; endl;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//Sequence container</span></span><br><span class="line">	vector&lt;<span class="type">int</span>&gt; v;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		v.<span class="built_in">push_back</span>(i);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">reverse</span>(v.<span class="built_in">begin</span>(), v.<span class="built_in">end</span>());</span><br><span class="line"></span><br><span class="line">	vector&lt;<span class="type">int</span>&gt;::const_iterator vector_const_iterator;</span><br><span class="line">	<span class="keyword">for</span> (vector_const_iterator = v.<span class="built_in">begin</span>(); vector_const_iterator != v.<span class="built_in">end</span>(); ++vector_const_iterator)</span><br><span class="line">	&#123;</span><br><span class="line">		cout &lt;&lt; *vector_const_iterator &lt;&lt; endl;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/img/CPP/STLAlgorithems.PNG" alt="STLAlgorithems"><br>从上面reverse的调用可以看出，用户需要负责传入两个iterator作为访问区间。<br>但这样做的话接口虽然灵活，但是确需要用户去保证传入的两个iterator的有效性。</p>
<p>算法分类：</p>
<ol>
<li>Manipulating Algorithms<br> 是指会“删除或重排或修改元素”的算法<br> remmove,resort,modify……<br> 下面以remove算法为例：</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;stdafx.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">PrintAll</span><span class="params">(T container)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">typename</span> T::const_iterator const_iterator;</span><br><span class="line">	<span class="keyword">for</span> (const_iterator = container.<span class="built_in">begin</span>(); const_iterator != container.<span class="built_in">end</span>(); ++const_iterator)</span><br><span class="line">	&#123;</span><br><span class="line">		cout &lt;&lt; *const_iterator &lt;&lt; endl;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	cout &lt;&lt; <span class="string">&quot;-------------------------------------&quot;</span> &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> _tmain(<span class="type">int</span> argc, _TCHAR* argv[])</span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">//cout &lt;&lt; MyClass::mID &lt;&lt; endl;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//Sequence container</span></span><br><span class="line">	vector&lt;<span class="type">int</span>&gt; v;</span><br><span class="line">	vector&lt;<span class="type">int</span>&gt; v2;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		v.<span class="built_in">push_back</span>(i);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">reverse</span>(v.<span class="built_in">begin</span>(), v.<span class="built_in">end</span>());</span><br><span class="line"></span><br><span class="line">	<span class="comment">//PrintAll&lt;vector&lt;int&gt;::const_iterator&gt;(v.begin(), v.end());</span></span><br><span class="line"></span><br><span class="line">	<span class="built_in">copy</span>(v.<span class="built_in">begin</span>(), v.<span class="built_in">end</span>(), <span class="built_in">inserter</span>(v2, v<span class="number">2.</span><span class="built_in">begin</span>()));</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//PrintAll&lt;vector&lt;int&gt;::const_iterator&gt;(v2.begin(), v2.end());</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//注意remove不会改变container数量，只是用后面的覆盖符合规则的元素</span></span><br><span class="line">	<span class="comment">//同时返回新的最尾端元素iterator</span></span><br><span class="line">	vector&lt;<span class="type">int</span>&gt;::iterator v2end = <span class="built_in">remove</span>(v<span class="number">2.</span><span class="built_in">begin</span>(), v<span class="number">2.</span><span class="built_in">end</span>(), <span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">	PrintAll&lt;vector&lt;<span class="type">int</span>&gt;&gt;(v2);</span><br><span class="line"></span><br><span class="line">	PrintAll&lt;vector&lt;<span class="type">int</span>&gt;&gt;(v2);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//要想删除container里的元素，需要使用容器的erase</span></span><br><span class="line">	v<span class="number">2.</span><span class="built_in">erase</span>(v2end, v<span class="number">2.</span><span class="built_in">end</span>());</span><br><span class="line"></span><br><span class="line">	PrintAll&lt;vector&lt;<span class="type">int</span>&gt;&gt;(v2);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/img/CPP/STLRemove.PNG" alt="STLRemove"><br>	从上面看到，我们无法通过迭代器本身去删除容器的元素而需要通过容器本身去删除。<br>	为什么会这样了？<br>	“STL将数据结构和算法分离开来。然而，迭代器只不过是“容器中某一位置”的抽象概念而已。一般来说，迭代器对自己所属容器一无所知。任何“以迭代器访问容器元素”的算法，都不得透过迭代器条用容器类提供的任何成员方法。”<br>	但正因为这样的设计，算法只需要操作与迭代器上而不需要了解容器细节。<br>	那么这里有一个问题，Manipulating Algorithms会修改或移除或重排容器元素，那么他们可以作用于Associative Containers(按特定规则对元素进行了排序)上吗？<br>	答案是不能，为了保证Associative Containers已序的特性，Associative Containers只提供了const_iterator的迭代器，从而防止了Manipulating Algorithms的使用。<br>	算法 VS 容器成员函数？<br>	算法只是做一些通用的工作，本不能完美针对各个容器使用最优的方式。<br>	比如针对list，如果采用算法remove，会导致删除第一个元素后，后面所有的元素都分别设给前一个元素，这就违背了list的通过修改链接而非实值来安插，移动，移除元素的优点。在这种情况下，使用list自身的成员函数更优于通用算法。</p>
<pre><code>自定义泛型函数：
参见前面我们自定义的PrintAll泛型模板函数，把container作为参数传递，从而打印出所有元素。

以函数作为算法的参数：
一些算法可以接受用户定义的辅助性函数，由此提高其灵活性和能力。这些函数将在算法内部被调用。
下面以for_each为例：
</code></pre>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;stdafx.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Print</span><span class="params">(T elem)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	cout &lt;&lt; elem &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> _tmain(<span class="type">int</span> argc, _TCHAR* argv[])</span><br><span class="line">&#123;</span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">	cout &lt;&lt; <span class="string">&quot;foreach-------------------------&quot;</span> &lt;&lt; endl;</span><br><span class="line">	for_each(v<span class="number">2.</span><span class="built_in">begin</span>(), v<span class="number">2.</span><span class="built_in">end</span>(), Print&lt;<span class="type">int</span>&gt;);</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/img/CPP/STLForEach.PNG" alt="STLForEach"><br>	“运用这些辅助函数，我们可以指定搜寻准则，排序准则或定义某种操作等。”<br>	Predicates：<br>	“Predicates是一种特殊的辅助函数。返回bool的函数，通常被用来指定排序准则和搜寻准则。(STL要求，面对相同的值，predicates必须得出相同的结果)”<br>	下面以find_if为例：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;stdafx.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">IsEven</span><span class="params">(T number)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	number = <span class="built_in">abs</span>(number);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (number % <span class="number">2</span> == <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> _tmain(<span class="type">int</span> argc, _TCHAR* argv[])</span><br><span class="line">&#123;</span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">	for_each(v<span class="number">2.</span><span class="built_in">begin</span>(), v<span class="number">2.</span><span class="built_in">end</span>(), Print&lt;<span class="type">int</span>&gt;);</span><br><span class="line"></span><br><span class="line">	vector&lt;<span class="type">int</span>&gt;::iterator pos = <span class="built_in">find_if</span>(v<span class="number">2.</span><span class="built_in">begin</span>(), v<span class="number">2.</span><span class="built_in">end</span>(), IsEven&lt;<span class="type">int</span>&gt;);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (pos != v<span class="number">2.</span><span class="built_in">end</span>())</span><br><span class="line">	&#123;</span><br><span class="line">		cout &lt;&lt; *pos &lt;&lt; <span class="string">&quot; is first even number in v2!&quot;</span> &lt;&lt; endl;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		cout &lt;&lt; <span class="string">&quot;No even number found!&quot;</span> &lt;&lt; endl;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/img/CPP/STLPredicates.PNG" alt="STLPredicates"><br>	更多的predicates参考STL Algorithms的使用。<br>2. Nonmodifying Algorithms<br>	是指不会变动元素值，也不会改变元素次序的算法。<br>	e.g. count, min_element, max_element, find……</p>
<p>仿函数(Functors):<br>什么是Functors？<br>“Functors是泛型编程强大为例和纯粹抽象概念的又一个例证。你可以说，任何东西，只要其行为像函数，它就是函数。因此，如果你定义了一个对象，行为像函数，它就可以被当做函数来用。”</p>
<p>那么什么才算是具备函数行为了？<br>“是指可以“使用小括号传递参数，籍以调用某个东西”。”<br>e.g.<br>function(arg1,arg2);</p>
<p>如何实现？<br>通过自定义operator()即可</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;stdafx.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//functors</span></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FunctorClass</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">operator</span><span class="params">()</span><span class="params">(T elem)</span> <span class="type">const</span></span>&#123;</span><br><span class="line">		cout &lt;&lt; elem &lt;&lt; endl;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> _tmain(<span class="type">int</span> argc, _TCHAR* argv[])</span><br><span class="line">&#123;</span><br><span class="line">	......</span><br><span class="line"></span><br><span class="line">	FunctorClass&lt;<span class="type">int</span>&gt; func;</span><br><span class="line"></span><br><span class="line">	for_each(v<span class="number">2.</span><span class="built_in">begin</span>(), v<span class="number">2.</span><span class="built_in">end</span>(), func);</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/img/CPP/STLFunctors.PNG" alt="STLFunctors"><br>让我们看看for_each源码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">class</span> InputIterator, <span class="keyword">class</span> Function&gt;</span></span><br><span class="line"><span class="function">  Function <span class="title">for_each</span><span class="params">(InputIterator first, InputIterator last, Function fn)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">while</span> (first!=last) &#123;</span><br><span class="line">    <span class="built_in">fn</span> (*first);</span><br><span class="line">    ++first;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> fn;      <span class="comment">// or, since C++11: return move(fn);</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看出我们传递的FunctorClass<int>实例对象通过fn(*first)的方式调用了我们定义的operator()函数</p>
<p>Functor好处：</p>
<ol>
<li>smart functions(智能型函数)<br>““行为类似指针”的对象。拥有成员函数和成员变量，意味着functor拥有状态。”</li>
<li>每个functor都有自己的类型</li>
<li>functor通常比一般函数速度快<br>“就template概念而言，由于更多细节在编译器就已确定，所以通常可能进行更好的最佳化。”</li>
</ol>
<p>预定义的Functor：<br>C++标准库里包含了一些预先定义的仿函数：<br>less&lt;&gt;,negate&lt;&gt;……</p>
<p>什么是Function Adaptors？<br>所谓的Function Adaptors是指能够将仿函数和另一个仿函数(或某个值，或某个一般函数)结合起来的仿函数。<br>比如：<br>bind2nd(greater<int>(),42) – 检查某个int值大于42.bind2nd把二元仿函数转换为一元仿函数。<br>“通过Function Adaptors，我们可以把多个仿函数结合起来，形成强大的表达式，这种编程方式称为functional composition。”</p>
<p>那么成员函数能当做Function Adaptors使用吗？<br>答案是可以。C++里提供了将成员函数转换成Function Adaptors的方法(mem_fun_ref()和mem_fun())<br>Note:<br>mem_fun_ref和mem_fun调用的成员函数必须是const。</p>
<p>那么非成员函数是否能当做Function Adaptors了？<br>答案是可以的。C++里提供了ptr_fun将非成员函数转换为Functor Object。<br>详细内容参见《C++标准程序库》第8章</p>
<p>接下来让我们看看如何使自定义的Functor也可以使用Function Adaptors。<br>要想使自定义Functor使用Function Adaptors需要满足下列条件：</p>
<ol>
<li>必须提供一些类型成员来反映其参数和返回值的类型。<br>C++标准程序库提供了一些结构如下：<br><img src="/img/CPP/STLFunctionAdaptorsStructor.PNG" alt="STLFunctionAdaptorsStructor"><br>如果自定义Functor想要支持Functor Adaptors，我们只需要定义struct继承至unary_function或binary_function，同时定义operator()的Functor行为即可。</li>
</ol>
<p>更多一元，二元组合函数配接器参见《C++标准程序库》第8章</p>
<p>Note：<br>算法参数传递的区间是半开区间[begin, end)(包含begin，不包含end)</p>
<h2 id="STL内部的错误处理和异常处理"><a href="#STL内部的错误处理和异常处理" class="headerlink" title="STL内部的错误处理和异常处理"></a>STL内部的错误处理和异常处理</h2><h3 id="错误处理"><a href="#错误处理" class="headerlink" title="错误处理"></a>错误处理</h3><p>“STL的设计原则是效率优先，安全次之。错误检查相当花时间，所以几乎没有。”<br>原因：</p>
<ol>
<li>错误检验会降低效率，而速度始终是程序的总体目标。</li>
<li>不加入的话，用户可以通过封装自己写错误检查的版本，但反过来却不行。</li>
</ol>
<p>使用STL需要注意的点：</p>
<ol>
<li>迭代器务必合法而有效</li>
<li>一个迭代器如果只想”end”位置，它并不指向任何对象，因而不能对它调用operator*或operator-&gt;</li>
<li>区间必须是合法的</li>
<li>如果涉及的区间不止一个，第二区间及后继各区间必须拥有“至少和第一区间一样多”的元素</li>
<li>覆盖动作中的“目标区间”必须拥有足够的元素，否则就必须采用insert iterators</li>
</ol>
<p>Note:<br>含错误处理版本的STL，<a target="_blank" rel="noopener" href="http://www.stlport.org/">STLport</a></p>
<h3 id="异常处理"><a href="#异常处理" class="headerlink" title="异常处理"></a>异常处理</h3><p>……</p>
<h2 id="扩展STL"><a href="#扩展STL" class="headerlink" title="扩展STL"></a>扩展STL</h2><p>“STL被涉及成一个框架，可以向任何方向扩展。你可以提供自己的容器，迭代器，算法，Functor…..，只要你满足条件即可。”</p>
<p>待续……</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Algorithm/">Algorithm</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Algorithm/">Algorithm</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/10/13/Unity资源/" title="Unity资源管理" itemprop="url">Unity资源管理</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Tony Tang" target="_blank" itemprop="author">Tony Tang</a>
		
  <p class="article-time">
    <time datetime="2016-10-13T08:21:47.000Z" itemprop="datePublished"> 发表于 2016-10-13</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>在最初学习Unity的时候，对于资源管理没有系统的概念，只知道放到Assets下即可。<br>本章节主要是对于Unity在资源管理方面的进一步学习了解。</p>
<p>这里简单提及正确的利用Unity资源管理的好处：</p>
<ol>
<li>高效的管理资源</li>
<li>合理的分配内存(避免不必要的内存开销 – 比如同一个Asset被打包到多个AssetBundle里，然后分别被游戏加载)</li>
<li>做到增量更新(无需下载更新整个游戏程序，通过Patch的形式动态更新部分游戏内容)</li>
<li>以最少及最合理的方式减少程序大小(避免所有资源一次性打到游戏程序里)</li>
<li>帮助快速开发(动态和静态的资源方式合理利用，高效开发)</li>
</ol>
<h1 id="资源管理"><a href="#资源管理" class="headerlink" title="资源管理"></a>资源管理</h1><h2 id="资源形式"><a href="#资源形式" class="headerlink" title="资源形式"></a>资源形式</h2><h3 id="Asset"><a href="#Asset" class="headerlink" title="Asset"></a>Asset</h3><p>在Unity里所有我们使用的资源都是以Asset的形式存在的。<br>我们要想在Unity里使用特定的资源文件(比如.ogg .png .fbx等(Unity支持的资源格式))，我们需要放到Assets目录下。<br>见下图：<br><img src="/img/Unity/AssetsDirectory.PNG" alt="AssetsDirectory"></p>
<p>在进一步了解我们导入Assets的时候，会发生些什么之前，先让我们来学习了解一些相关的概念。<br>首先，什么是Asset？<br>Asset – “An Asset is a file on disk, stored in the Assets folder of a Unity Project. e.g. texture files, material files and FBX files……”(Asset代表的所有存储在Assets目录下的文件资源)</p>
<p>Unity如何区分每一个Asset？<br>Unity通过赋予每一个Asset一个Unique ID来区分每一个Asset。<br>每一个放在Asset目录下的资源都会对应生成一个同样名字的.meta文件，前面提到的Unique ID就被存储在这里。<br>下面我已导入一张Projectile.png并设置导入设置为Sprite等相关信息为例。<br><img src="/img/Unity/ImportProjectilePNG.PNG" alt="ImportProjectilePNG"><br><img src="/img/Unity/ProjectilePNGImportSetting.PNG" alt="ProjectilePNGImportSetting"><br>Projectile.png.meta</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">fileFormatVersion: <span class="number">2</span></span><br><span class="line">guid: <span class="number">8764571b</span>0416f90488390d0114c49afd</span><br><span class="line">timeCreated: <span class="number">1476349445</span></span><br><span class="line">licenseType: Free</span><br><span class="line">TextureImporter:</span><br><span class="line">  fileIDToRecycleName: &#123;&#125;</span><br><span class="line">  ......</span><br></pre></td></tr></table></figure>
<p>可以看到对应生成了一个叫Projectile.png.meta的文件，里面存储了guid(前面提到的那个Unique ID)和资源导入配置的数据。<br>这样一来无论我们如何移动Asset(在Assets目录下)，我们都不会影响其他资源对该Asset的引用(因为Unity通过Unique ID去标识该Asset)<br>Note：<br>所以我们一旦在Unity外部移动或改名Asset文件，一定要把对应的Asset.meta文件名也对应移动和改名。(在Unity窗口修改可以不必管这些，因为Unity会对应生成新的.meta文件)<br>如果script脚本的.meta文件丢失，那么所有挂载了该script的GameObject都会显示unassaigned script(因为找不到该Script Asset的ID标识)</p>
<p>知道了Asset在Unity是如何区分的，那么接下来的问题是，Unity是直接使用这些Asset资源文件作为游戏资源吗？<br>答案是否定的，所有导入的Asset都会被Unity转化成特定的格式在游戏中使用，被存储在Library目录下，而原有资源保持不变，依然放在原始位置。(这样一来，我们可以通过修改原始文件，快速的在Unity中看到变化。比如.png作为UI，我们在Photoshop里修改源文件，直接就能在Unity看到变化)<br><img src="/img/Unity/UnityAssetInternalFormatInLibraryFolder.PNG" alt="UnityAssetInternalFormatInLibraryFolder"><br>Note:<br>因为Library目录是通过动态转换Asset资源成Unity识别的数据，所以我们不会去主动修改该目录文件，同时也不会对该目录做版本控制，我们放心的删除该目录(但会导致所有Asset重新导入声称一次Unity识别的数据)</p>
<p>知道了Unity如何利用原始文件生成最终的可利用的资源数据，那么是不是所有的Asset都是通过直接放置在Assets目录下得到的了？<br>答案是否定的，Unity支持从一些资源文件里细分出多个Assets。(比如.png文件可以作为Multiple Sprite导入到Unity里，然后通过Sprite Editor细分出多个Sprite，然后每一个Sprite都作为Asset存在于Unity里)</p>
<p>知道了Asset在Unity里的概念以及存储方式，那么Unity支持哪些常见的Asset格式了？</p>
<ol>
<li>Image File(e.g. .bmp, .tif, .tga, .jpg, .psd……)</li>
<li>3D Model Files(.fbx)</li>
<li>Meshes &amp; Animations</li>
<li>Audio files</li>
<li>Other Asset Types</li>
</ol>
<p>遇到Unity不支持的格式，Unity需要通过import process导入资源文件(e.g. PNG, JPG)<br>“The import process converts source Assets into formats suitable for the target platform selected in the Unity Editor.”(Import process主要是为了将不支持的资源格式转换到Unity对应平台设置的对应格式)</p>
<p>Unity不可能每一次都去重新Import这些资源，那么Unity是如何将import结果存储在哪里了？<br>为了避免重复的import导入，” the results of Asset importing are cached in the Library folder.”(Asset导入的结果被缓存在了library folder – 我想这也就是为什么每次删掉Library文件会导致一些asset重新导入的原因)</p>
<p>“the results of the import process are stored in a folder named for the first two digits of the Asset’s File GUID. This folder is stored inside the Library&#x2F;metadata&#x2F; folder. The individual Objects are serialized into a single binary file that has a name identical to the Asset’s File GUID.”(可以看出import的结果存储在Library&#x2F;metadata&#x2F;文件夹下，并且把File GUID的前两位bit作为文件夹名，以File GUID作为文件名字)<br>以前面Projectile.png导入为例：<br>因为Projectile.png.meta的File ID为8764571b0416f90488390d0114c49afd<br>所以导入的结果就存储在Library\metadata\87\文件夹下，文件名为8764571b0416f90488390d0114c49afd(由于是二进制文件，无法查看具体内容)<br><img src="/img/Unity/AssetImportResult.PNG" alt="AssetImportResult"><br>Note:<br>Non-Native asset type需要通过asset importer去导入Unity。(自动调用，也可以通过AssetImporter API去调用)</p>
<p>明白了Asset在Unity里的概念和存储方式，那么我们如何去访问，使用，创建Asset了？<br>在了解如何访问Asset之前，我们需要明确的是，我们访问的目的是什么。<br>如果只是在编辑器里单纯访问Asset去创建和删除一些Asset，那么通过AssetDatabase就可以实现。</p>
<p>先来看看什么是AssetDatabase：<br>“AssetDatabase is an API which allows you to access the assets contained in your project. Among other things, it provides methods to find and load assets and also to create, delete and modify them. The Unity Editor uses the AssetDatabase internally to keep track of asset files and maintain the linkage between assets and objects that reference them.”(可以看出，AssetDatabase在Unity对于Asset管理上起了关键性作用，AssetDatabase里存储了Asset相关的很多信息(e.g. Asset Depedency, Asset Path…..))</p>
<p>所以如果我们想通过代码去实现一些关于Assset的操作，我们应该使用AssetDatabase而非Filesystem(Filesystem只是单纯的删除或移动文件，但对于Asset在Unity里的导入设置，Asset访问等还是得通过AssetDatabase的接口来操作)</p>
<p>这里我以之前导入的Projectile.png为纹理图片，通过程序创建3个颜色分别是Red，Blue，Green的Material和分别使用其作为材质的3个Cude Prefab为例：<br>先看一下效果图：<br><img src="/img/Unity/CreateCubePrefabs.PNG" alt="CreateCubePrefabs"><br><img src="/img/Unity/CreateCubeMaterials.PNG" alt="CreateCubeMaterials"></p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> UNITY_EDITOR</span></span><br><span class="line"><span class="keyword">using</span> UnityEditor;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CreateCubeAssetMenu</span> &#123;</span><br><span class="line">    <span class="comment">//Only works under editor</span></span><br><span class="line">    <span class="meta">#<span class="keyword">if</span> UNITY_EDITOR</span></span><br><span class="line">    [<span class="meta">MenuItem(<span class="string">&quot;AssetDatabase/CreateCubeAsset&quot;</span>)</span>]</span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">CreateCudeAsset</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//load Projectile.png as texture</span></span><br><span class="line">        Texture2D texture = (Texture2D)AssetDatabase.LoadAssetAtPath(<span class="string">&quot;Assets/Sprites/Projectile.png&quot;</span>, <span class="keyword">typeof</span>(Texture2D));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//create material and cube assets</span></span><br><span class="line">        <span class="built_in">string</span> matassetname;</span><br><span class="line">        <span class="built_in">string</span> cubename;</span><br><span class="line">        <span class="built_in">string</span> materialfoldername = <span class="string">&quot;Materials&quot;</span>;</span><br><span class="line">        <span class="built_in">string</span> cubefoldername = <span class="string">&quot;Prefabs&quot;</span>;</span><br><span class="line"></span><br><span class="line">        Color[] colors = &#123; Color.red, Color.blue, Color.green &#125;;</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; colors.Length; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//Create material first</span></span><br><span class="line">            Material mat = <span class="keyword">new</span> Material(Shader.Find(<span class="string">&quot;Transparent/Diffuse&quot;</span>));</span><br><span class="line">            mat.mainTexture = texture;</span><br><span class="line">            mat.color = colors[i];</span><br><span class="line"></span><br><span class="line">            <span class="comment">//create a new cube and set material for it</span></span><br><span class="line">            GameObject obj = GameObject.CreatePrimitive(PrimitiveType.Cube);</span><br><span class="line">            MeshRenderer meshrender = obj.GetComponent&lt;MeshRenderer&gt;();</span><br><span class="line">            <span class="keyword">if</span> (meshrender != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                meshrender.material = mat;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                Debug.Log(<span class="string">&quot;meshrender == null!&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            matassetname = mat.color.ToString() + <span class="string">&quot;Material.mat&quot;</span>;</span><br><span class="line">            cubename = mat.color.ToString() + <span class="string">&quot;Cube.prefab&quot;</span>;</span><br><span class="line">            <span class="comment">//create material folder</span></span><br><span class="line">            <span class="comment">//check whether material folder exist</span></span><br><span class="line">            <span class="keyword">if</span> (AssetDatabase.Contains(mat))</span><br><span class="line">            &#123;</span><br><span class="line">                Debug.Log(<span class="string">&quot;Material asset has been created before!&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (!AssetDatabase.IsValidFolder(<span class="string">&quot;Assets/&quot;</span> + materialfoldername))</span><br><span class="line">                &#123;</span><br><span class="line">                    AssetDatabase.CreateFolder(<span class="string">&quot;Assets&quot;</span>, materialfoldername);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (!AssetDatabase.IsValidFolder(<span class="string">&quot;Assets/&quot;</span> + cubefoldername))</span><br><span class="line">                &#123;</span><br><span class="line">                    AssetDatabase.CreateFolder(<span class="string">&quot;Assets&quot;</span>, cubefoldername);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                AssetDatabase.CreateAsset(mat, <span class="string">&quot;Assets/&quot;</span> + materialfoldername + <span class="string">&quot;/&quot;</span> + matassetname);</span><br><span class="line"></span><br><span class="line">                <span class="comment">//Create prefab</span></span><br><span class="line">                PrefabUtility.CreatePrefab(<span class="string">&quot;Assets/&quot;</span> + cubefoldername + <span class="string">&quot;/&quot;</span> + cubename, obj);</span><br><span class="line"></span><br><span class="line">                <span class="comment">//inform  the change</span></span><br><span class="line">                AssetDatabase.Refresh();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Note:<br>AssetDatabase只适用于Editor，所以上述代码都用#if UNITY_EDITOR #endif判断了平台</p>
<p>那么是不是只需存储Asset的.meta文件(Unique ID和导入配置信息)就足够了了？<br>答案是否定的，要知道在Unity里很多Asset不只是单纯的通过原始资源导入构成的(比如一个Bullet Prefab，上面会挂载Component，我们不仅要去标识Asset，我们还需要对Asset上的各个Component进行标识和相关信息存储，这样Unity才能正确的找到特定Asset上的特定Component的)。</p>
<h3 id="Object"><a href="#Object" class="headerlink" title="Object"></a>Object</h3><p>在进一步了解还应该存储哪些信息之前，这里需要理解一个概念UnityEngine.Object<br>那么Object在Unity里是什么概念了？<br>UnityEngine.Object – “Object with a capitalized ‘O’, is a set of serialized data collectively describing a specific instance of a resource. This can be any type of resource which the Unity Engine uses, such as a mesh, a sprite, and AudioClip …..”(Object是指描述了Asset上使用的所有resources的序列化数据。比如制作一个2D Bullet Prefab，上面会挂载Transform，Sprite Renderer，Box Collider 2D,Rigidbody 2D, Bullet Script，Animator等Object，这里我们需要分别标识和记录这些Object的信息)</p>
<p>前面我们提到了Asset是通过Unique ID(File GUID)来标识，那么这里的Object用什么来标识了？并且又存储在哪里了？<br>答案是使用Local ID来标识并存储在Asset文件里(需要设置Asset Serialization到Force Text才能查看(默认是Mixed(Text和Binary)))<br>Local ID – identifies each Object within an Asset file because an Asset file may contain multiple Objects.</p>
<p>那么Asset和Object之间是什么样的关系了？<br>“There is a one-to-many relationship between Assets and Objects: that is, any given Asset file contains one or more Objects.”(Asset file可以包含一个或多个Objects)</p>
<p>那么如何查看Object的具体信息了？<br>通过设置Edit -&gt; Project Setting -&gt; Editor -&gt; Asset Serialization -&gt; Force Text<br>我们可以去查看所有Object索引的相关信息。<br>这里我们以一个创建一个Bullet Prefab的Asest file为例(Bullet Prefab包含很多Component)：<br>当创建一个Bullet Prefab的时候，我在上面挂载了Transform，Sprite Renderer，Box Collider 2D,Rigidbody 2D, Bullet Script，Animator等Object。<br><img src="/img/Unity/BulletInspector.PNG" alt="BulletInspector"><br>这里的Bullet.prefab文件就是我们说的Asset File。<br>而上述挂载的所有Components就是之前说的Object。(这就印证了Asset File和Object一对多的关系)<br>下面让我们看看在包含多个Obejct的Prefab里是如何通过File GUID和Local ID来定位各个Object的。<br>Bullet.prefab</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">%YAML <span class="number">1.1</span></span><br><span class="line">%TAG !u! tag:unity3d.com,<span class="number">2011</span>:</span><br><span class="line">--- !u!<span class="number">1001</span> &amp;<span class="number">100100000</span></span><br><span class="line">Prefab:</span><br><span class="line">  ......</span><br><span class="line">--- !u!<span class="number">1</span> &amp;<span class="number">1000012041017010</span></span><br><span class="line">GameObject:</span><br><span class="line">  ......</span><br><span class="line">--- !u!<span class="number">4</span> &amp;<span class="number">4000011268538122</span></span><br><span class="line">Transform:</span><br><span class="line">  ......</span><br><span class="line">--- !u!<span class="number">50</span> &amp;<span class="number">50000011296845006</span></span><br><span class="line">Rigidbody2D:</span><br><span class="line">  ......</span><br><span class="line">--- !u!<span class="number">61</span> &amp;<span class="number">61000010120606286</span></span><br><span class="line">BoxCollider2D:</span><br><span class="line">  ......</span><br><span class="line">--- !u!<span class="number">95</span> &amp;<span class="number">95000013277359834</span></span><br><span class="line">Animator:</span><br><span class="line">  ......</span><br><span class="line">--- !u!<span class="number">114</span> &amp;<span class="number">114000011185120874</span></span><br><span class="line">MonoBehaviour:</span><br><span class="line">  ......</span><br><span class="line">--- !u!<span class="number">212</span> &amp;<span class="number">212000011673545760</span></span><br><span class="line">SpriteRenderer:</span><br><span class="line">  ......</span><br></pre></td></tr></table></figure>
<p>Bullet.prefab.meta</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">fileFormatVersion: <span class="number">2</span></span><br><span class="line">guid: <span class="number">9</span>c4834a7b611ce848b2d182d5057bcbb</span><br><span class="line">timeCreated: <span class="number">1476367984</span></span><br><span class="line">licenseType: Free</span><br><span class="line">NativeFormatImporter:</span><br><span class="line">  userData: </span><br><span class="line">  assetBundleName: </span><br><span class="line">  assetBundleVariant: </span><br></pre></td></tr></table></figure>
<p>从Bullet.prefab里可以看出每一个Object都有定义对应的Local ID<br>而在Bullet.prefab.meta里定义了Bullet Prefab这个Asset File的File GUID<br>结合File GUID和Local ID我们就能定位到Bullet Prefab Asset File里的某某Object</p>
<p>那么为什么要采用File GUID和Local ID了？<br>“The File GUID provides an abstraction of a file’s specific location. As long as a specific File GUID can be associated with a specific file, that file’s location on disk becomes irrelevant. The file can be freely moved without having to update all Objects referring to the file.”(通过指定唯一个File GUID和Local ID，使文件的位置变的无关紧要，我们可以随意的移动文件位置而无需更新所有的Object reference信息)</p>
<p>所以一旦File GUID丢失，那么所有引用该文件里的Object的引用都会丢失，因为无法定位位于哪一个Asset File里。(所以不要随意乱改.meta文件)</p>
<p>File GUID和Local ID虽然好，但是一味的比较File GUID和Local ID会导致slow performance，所以Unity为了快速访问标识的各个Asset，内部维护了一个Instance ID的映射缓存(通过File GUID和Local ID计算得出的唯一的integer)来标识各个Asset。<br>通过Instance ID Unity可以快速的访问到被加载了的对应的Object。(如果target object还没被加载，那么通过File GUID和Local ID，Unity会去把Object加载进来)</p>
<p>那么Instance ID是如何运作的了？<br>“At startup, the Instance ID cache is initialized with data for all Objects that are built-in to the project (i.e. referenced in Scenes), as well as all Objects contained in the Resources folder. Additional entries are added to the cache when new assets are imported at runtime(3) and when Objects are loaded from AssetBundles. Instance ID entries are only removed from the cache when they become stale. This happens when an AssetBundle providing access to a specific File GUID and Local ID is unloaded.”(当游戏启动的时候，Instance ID的cache开始初始化所有在项目场景里引用到的Object。额外的Instance ID Cache只有在通过运行时导入或则AssetBundle动态加载Object的时候添加。Instance ID只有在Instance ID标识的Object被Unloaded的时候才会被removed from cache)</p>
<p>那么什么时候Object才会被Unloaded了？Object的Instance ID与AssetBundle之间又是如何关联起来的了？<br>“When the unloading of an AssetBundle causes an Instance ID to become stale, the mapping between the Instance ID and its File GUID and Local ID is deleted to conserve memory. If the AssetBundle is re-loaded, a new Instance ID will be created for each Object loaded from the re-loaded AssetBundle.”(当AssetBundle(后面会详细讲到)被unload后，通过AssetBundle加载的Object的Instance ID会被删除以节约内存。当AssetBundle再次加载进来后，当AssetBundel里的Obejct被再次加载时，会为该Object生成新的Instance ID到cache里)</p>
<p>上面算是提到了Resource(Asset里的Object)的lifecycle。关于Resource Lifecycle和Instance ID相关的学习在了解了Unity里与资源加载相关的Resource和AssetBundle后会再次讨论，见后面。</p>
<p>Note:<br><a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/topics/best-practices/assets-objects-and-serialization">Implementation note: At runtime, the above control flow is not literally accurate. Comparing File GUIDs and Local IDs at runtime would not be sufficiently performant during heavy loading operations. When building a Unity project, the File GUIDs and Local IDs are deterministically mapped into a simpler format. However, the concept remains identical, and thinking in terms of File GUIDs and Local IDs remains a useful analogy during runtime.</a></p>
<p>接下来看看两种特殊的Object类型:</p>
<ol>
<li>ScriptableObject<br>“Provides a convenient system for developers to define their own data types.”(用于定义自定义类型数据)</li>
<li>MonoBehaviour<br>“Provides a wrapper that lins to a MonoScript. A MonoScript is an internal data type that Unity uses to hold a reference to a specific scripting class within a specific assembly and namespace. The MonoScript does not contain any actual executable code.”</li>
</ol>
<p>Monoscripts:<br>“a MonoBehaviour has a reference to a MonoScript, and MonoScripts simply contain the information needed to locate a specific script class. Neither type of Object contains the executable code of script class.”<br>“A MonoScript contains three strings: an assembly name, a class name, and a namespace.”(正如前面MonoBehavior提到的，MonoScript包含了定位script class需要的信息。 e.g. assembly name, class name, namspace……)</p>
<p>我们编写的scripts最终会被Unity编译到Assembly-CSharp.dll里。<br>在Plugins目录下的插件会被编译到Assembly-CSharp-firstpass.dll里。<br><img src="/img/Unity/UnityAssembly.PNG" alt="UnityAssembly"></p>
<p>那么我们的Asset资源被打包到哪里去了了？<br>接下来我们设置场景如下：</p>
<ol>
<li>放置一个Bullet.prefab实例(上面挂载了Bullet script和一系列Component，使用Assets&#x2F;Sprites&#x2F;Projectile.png作为sprite(设置了打包到图集1里))</li>
<li>创建一个Cude的3D GameObject(Unity Primitive Cube)</li>
<li>创建UI Image使用Background.png作为Sprie(&#x2F;Assets&#x2F;Resources&#x2F;Textures&#x2F;UI&#x2F;Background.png)</li>
<li>放置一张未使用的AddImage.png在Assets&#x2F;Sprites下，并设置打包到图集2里。</li>
<li>放置一张未使用的Coin.png在Assets&#x2F;Resources&#x2F;Textures&#x2F;UI下，并设置打包到图集3里。</li>
</ol>
<p>然后通过Unity提取查看IOS打包后的各个资源分别存储在哪里。<br>首先看看我们在场景里创建的GameObject情况：<br><img src="/img/Unity/ResourceManagerStudyScene.PNG" alt="ResourceManagerStudyScene"><br>接下来查看下打包的IOS的资源文件夹下的.asset文件：<br><img src="/img/Unity/ResourceManagerStudyIOSResource.PNG" alt="ResourceManagerStudyIOSResource"><br>可以看到Data下有三个.assets文件(globalgamemanager.assets和sharedassets0.assets和resources.assets)<br>然后通过UnityStudio我们分别打开这三个文件进行查看：<br>globalgamemanager.assets<br><img src="/img/Unity/globalgamemanagerassets.PNG" alt="globalgamemanagerassets"><br><img src="/img/Unity/sharedassets0assets.PNG" alt="sharedassets0assets"><br><img src="/img/Unity/resourcesassets.PNG" alt="resourcesassets"><br>通过查看里面的资源可以发现，我们放在Assets&#x2F;Sprites下的Projectile.png被打包到了SpriteAtlasTexture-1-32x32-fmt33(Texture2D)图集里，而作为UI背景放置在Assets&#x2F;Resoures&#x2F;Textures&#x2F;UI下的backgroudn.png被单独打包在了名为backgroudn(Texture2D)里<br>而没有在游戏里使用且放置在Assets&#x2F;Resources&#x2F;Textures&#x2F;UI下的Coin.png被单独打包到了名为resources.assets的资源文件里。</p>
<p>从上面可以看出Resources下的资源文件并没有被打包到图集里，而是作为单独的Texture2D资源存在。同时没有放置在Resources目录下的资源，如果没有被游戏使用，最终是不会被打包到游戏里(反之放在Resources目录下即使未被使用也会被打包到游戏里)。</p>
<p>如果我们使用UnityStudio加载整个Data文件夹，我们还能查看到场景Level里的树状结构：<br><img src="/img/Unity/SeneHierarchy.PNG" alt="SeneHierarchy"></p>
<p>说了这么多Asset和Object相关的知识和概念，下面提一个与之相关却又常常遇到的问题。<br>Unity Store可以下载很多Asset Package资源，那么这里的问题就是，Asset Package是个什么概念？为什么通过导入Asset Package我们就能导入别人做好的Asset资源？如何制作自己的Asset Package？<br>Asset Package概念：<br>“Packages are collections of files and data from Unity projects, or elements of projects, which are compressed and stored in one file, similar to Zip files.”(可以看出Asset Package只是相当于Unity对于一系列Assets的打包，单记录了Assets原始的目录结构和Asset信息，好比压缩包)</p>
<p>正如我们前面学习理解的，要想使Asset能够使用，我们需要把Asset源文件和Asset.meta文件一起保存下来(为了确保原始的Asset和Object引用正确)。那么Asset Package是否保存了Asset源文件和Asset.meta文件了？接下来通过自制Asset Package我们来验证这个问题。</p>
<p>如何制作自己的Asset Package：<br>这里以导出前面制作的Bullet.prefab(Bullet.prefab以Projectile.png作为Sprite，同时挂载了Rigidbox 2D，Boxcollider 2D，Bullet script……)为例：<br>Asset -&gt; Export Package -&gt; 只勾选Bullet.prefab -&gt; Export<br>不勾选Include Dependencies：<br><img src="/img/Unity/ExportPackageWithoutDepedency.PNG" alt="ExportPackageWithoutDependency"><br>勾选Include Dependencies：<br><img src="/img/Unity/ExportPackage.PNG" alt="ExportPackageWithDependency"><br>这里不知道为什么CreateCubeAssetMenu.cs会作为Bullet.prefab的dependencies！<br>接下来在新的项目里导入该Asset Package：<br>Assets -&gt; Import Package -&gt; custom package<br>这样一来就得到了我们所导出的Assets Package<br><img src="/img/Unity/AssetPackageCompare.PNG" alt="AssetPackageCompare"><br>可以看出Bullet.prefab和Bullet.meta原封不动的以原始的形式保留了下来。<br>Note:<br>当导出Asset Package的时候，勾选Include dependencies，那么所有Asset依赖的Asset都会被导出到最终的Package</p>
<h2 id="资源来源"><a href="#资源来源" class="headerlink" title="资源来源"></a>资源来源</h2><h3 id="Unity自动打包"><a href="#Unity自动打包" class="headerlink" title="Unity自动打包"></a>Unity自动打包</h3><p><a target="_blank" rel="noopener" href="http://blog.csdn.net/ring0hx/article/details/46376709">Unity自动打包资源是指在Unity场景中直接使用到的资源会随着场景被自动打包到游戏中，这些资源会在场景加载的时候由unity自动加载。这些资源只要放置在Unity工程目录的Assets文件夹下即可，程序不需要关心他们的打包和加载，这也意味着这些资源都是静态加载的。但在实际的游戏开发中我们一般都是会动态创建GameObject，资源是动态加载的，因此这种资源其实不多</a></p>
<h3 id="Resources"><a href="#Resources" class="headerlink" title="Resources"></a>Resources</h3><p>所有放在Assets&#x2F;Resources目录下的资源都当做Resources。无论游戏是否使用，都会被打包到最终的程序里。(这也就说明为什么前面的例子在Resources下没有被使用的Coin.png最终被打包到了resources.assets里)<br>那么如何判断Resources下的资源是被打包到resources.assets里还是其他的assets里了？<br>答案取决于我们是否在Unity对Resources目录下的资源进行了索引引用。<br>正如前面我们测试的结果一样，同样是放在Resources目录下的backgroudn.png和Coin.png，前者因为在游戏里有引用，所以被打包到了sharedassets0.assets里，后者因为无人使用，而打包到了resources.assets里。(Resources下被引用的资源是存储在.sharedAsseets file里，而没被引用的是存储在resources.assets里)</p>
<p>那么为什么我们需要把资源放置在Resources下了？放在Assets下单独去引用使用不就可以了吗？<br>Resources主要是为了帮助我们去动态加载一些资源去创建Asset。(通过Resource API可以动态加载Resource里的资源)</p>
<p>但Unity官网讲解提到的我们应该尽量去避免使用Resources。<br>原因如下：</p>
<ol>
<li>Use of the Resources folder makes fine-grained memory management more difficult.(使用Resources folder会使内存管理更困难)</li>
<li>Improper use of Resources folders will increase application startup time and the length of builds.(不合理的使用Resources folders会使程序启动和编译时间变长)<br> As the number of Resources folders increases, management of the Assets within those folders becomes very difficult.(随着Resources folders数量的增加，Assets管理越来越困难)</li>
<li>The Resources system degrades a project’s ability to deliver custom content to specific platforms and eliminates the possibility of incremental content upgrades.(Resources System降低了项目对于各平台和资源的动态更新能力，因为Resources目录下的资源无论如何都会被打包到游戏程序里)<br> AssetBundle Variants are Unity’s primary tool for adjusting content on a per-device basis.(AssetBundle是Unity针对设备动态更新的主要工具)</li>
</ol>
<p>正确的使用Resources system就显得尤为重要：<br>以下两种情况比较适合使用Resource System：</p>
<ol>
<li>Resources is an excellent system for during rapid prototyping and experimentation because it is simple and easy to use. However, when a project moves into full production, it is strongly recommended to eliminate uses of the Resources folder.(快速开发，但到了真正发布还是应该减少Resources Folder的使用)</li>
<li>The Resources folder is also useful in trivial cases, when all of the following conditions are met(当下列情况都满足的时候，Resource folder比较有用):<ol>
<li>The content stored in the Resources folder is not memory-intense</li>
<li>The content is generally required throughout a project’s lifetime(该资源在项目生命周期里都需要)</li>
<li>The content rarely requires patching(很少需要改动patch)</li>
<li>The content does not vary across platforms or devices.(在各个平台设备都一致)<br>比如一些第三方配置文件等asset。</li>
</ol>
</li>
</ol>
<p>那么接下来让我们了解下Resources是如何被保存到Unity里的：<br>Serialization of resources:<br>“The Assets and Objects in all folders named “Resources” are combined into a single serialized file when a project is built.”(当项目编译的时候，所有放到Resources目录下的Assets和Object最终会被序列化到一个单独的文件，根据前面的测试应该是resources.assets)</p>
<p>“This file also contains metadata and indexing information, similar to an AssetBundle. This indexing information includes a serialized lookup tree that is used to resolve a given Object’s name into its appropriate File GUID and Local ID. It is also used to locate the Object at a specific byte offset in the serialized file’s body.”(Resource会去维护一个映射表，用于查询特定Object</p>
<p>“As the lookup data structure is (on most platforms) a balanced search tree(1), its construction time grows at an O(N log(N)) rate.”(Lookup是通过平衡二叉树来查找，所以时间复杂度为N x Log(N))</p>
<p>“This operation is unskippable and occurs at application startup time while the initial non-interactive splash screen is displayed.”(在程序启动的时候会去初始化index info(Lookup data)的时候，Resources里assets数量过多的话会导致花费大量时间)</p>
<h3 id="AssetBundle"><a href="#AssetBundle" class="headerlink" title="AssetBundle"></a>AssetBundle</h3><p>接下来让我们前面一直提到的一个很重要的点AssetBundle。<br>什么是AssetBundle？<br><a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/topics/best-practices/assetbundle-fundamentals?playlist=30089">The AssetBundle system provides a method for storing one or more files in an archival format that Unity can index. The purpose of the system is to provide a data delivery method compatible with Unity’s serialization system. AssetBundles are Unity’s primary tool for the delivery and updating of non-code content after installation.</a>(AssetBundle system提供了一个被Unity支持索引的格式文件(被Unity serialization system支持)。主要用于非代码资源的动态更新。)</p>
<p>为什么需要AssetBundle？<br><a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/topics/best-practices/assetbundle-fundamentals?playlist=30089">This permits developers to reduce shipped asset size, minimize runtime memory pressure, and selectively load content that is optimized for the end-user’s device.</a>(AssetBundle的好处是减少了发布的Asset大小，降低了运行时内存压力，动态更新非代码资源)</p>
<p>AssetBundle包含些什么信息？<br>主要包含两部分信息：</p>
<ol>
<li>A header<br>The header is generated by Unity when the AssetBundle is built.(header是在Unity编译AssetBundle的时候生成)主要包含下列内容：<ol>
<li>The AssetBundle’s identifier</li>
<li>Whether the AssetBundle is compressed or uncompressed</li>
<li>A manifest(“The manifest is a lookup table keyed by an Object’s name. Each entry provides a byte index that indicates where a given Object can be found within the AssetBundle’s data segment.”(manifest把Object的名字作为key，用于查询特定object是否存在于AssetBundle的数据字段里))<br> (manifest里通过std::multimap实现，不同平台multimap的实现有些许差别，Windows和OSX采用red-black tree，所以在构造manifest的时候，时间复杂度是N x Log(N))</li>
</ol>
</li>
<li>A data segment.<br>“Contains the raw data generated by serializing the Assets in the AssetBundle.”(data segment包含了序列化Assets的原始数据)<br>data segment最后还会通过LZMA algorithm压缩。<br>“Prior to Unity 5.3, Objects could not be compressed individually inside an AssetBundle. “(Unity 5.3之前Object不支持被单独压缩到AssetBundle里，所以在去访问一个被包含在压缩了的AssetBundle里的Object时，Unity需要去解压整个AssetBundle)<br>“Unity 5.3 added a LZ4 compression option. AssetBundles built with the LZ4 compression option will compress individual Objects within the AssetBundle, allowing Unity to store compressed AssetBundles on disk.”(Unity 5.3加入了LZ4压缩选项，支持单独的Object压缩到AssetBundle里，这样一来就可以通过单独解压特定的Object来实现访问该Object)</li>
</ol>
<p>AssetBundle能包含哪些Assets？<br>Models,Materials,textures and secenes.AssetBundle can not contain scripts.</p>
<p>如何去加载AssetBundles？<br>下列四种方式主要是根据AssetBundle的压缩算法和平台支持来划分。<br>API加载AssetBundles:</p>
<ol>
<li>AssetBundle.LoadFromMemoryAsync(Unity’s recommendation is not use this API)<br><a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/topics/best-practices/assetbundle-fundamentals?playlist=30089">AssetBundle.LoadFromMemoryAsync详情</a></li>
<li>AssetBundle.LoadFromFile<br>“A highly-efficient API intended for loading uncompressed AssetBundle from local storage, such as a hard disk or an SD card.”(可以高效的加载本地未压缩的AssetBundle，也支持加载LZ4压缩的AssetBundle，但不支持LZMA压缩的AssetBundle)<br><a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/topics/best-practices/assetbundle-fundamentals?playlist=30089">Mobile和Editor表现不一样，详情参见</a></li>
<li><a href="WWW.LoadFromCacheOrDownload">WWW.LoadFromCacheOrDownload</a><br>“A useful API for loading Objects both from remote servers and from local storage.”(主要用于加载远程服务器端和本地的Object)<br>使用建议：<br>“Due to the memory overhead of caching an AssetBundle’s bytes in the WWW object, it is recommended that all developers using WWW.LoadFromCacheOrDownload ensure that their AssetBundles remain small”(尽量保证AssetBundle很小，避免内存消耗过大)<br>“Each call to this API will spawn a new worker thread. Be careful of creating an excessive number of threads when calling this API multiple times.”(避免同时调用多次，导致大量的Thread执行，确保同一时间很少的thread执行)</li>
<li>UnityWebRequest’s DonwloadHandleAssetBundle(on Unity 5.3 or newer)<br>“UnityWebRequest allows developers to specify exactly how Unity should handle downloaded data and allows developers to eliminate unnecessary memory usage.”(UnityWebRequest支持更细致的AssetBundle加载的内存使用，可以通过配置UnityWebRequest达到使用最少内存的目的得到我们想要加载的Obejct)<br>“Note: Unlike WWW, the UnityWebRequest system has an internal pool of worker threads and an internal job system to ensure that developers cannot start an excessive number of simultaneous downloads. The size of the thread pool is not currently configurable.”(UnituWebRequest system内部有自身的线程管理，避免同一时间大量的线程同时加载)</li>
</ol>
<p>使用建议：<br>尽可能的使用AssetBundle.LoadFromFile(使用异步版本LoadFromFileAsync)<br>当项目需要下载和patch AssetBundle时，尽量使用UnityWebRequest(Unity 5.3),老版本的话使用WWW.LoadFromCacheOrDownload.<br>可能的话最好在项目安装的时候，预先缓存AssetBundle</p>
<p>Loading Assets from AssetBundles:<br>Synchronous API:</p>
<ol>
<li>LoadAsset</li>
<li>LoadAllAssets</li>
<li>LoadAssetWithSubAsset</li>
</ol>
<p>Asynchronous API:</p>
<ol>
<li>LoadAssetAsync</li>
<li>LoadAllAssetsAsync</li>
<li>LoadAssetWithSubAssetAsync</li>
</ol>
<p>使用建议：<br>“LoadAllAssets should be used when loading multiple independent UnityEngine.Objects.”(当需要加载大量独立的Objects的时候，使用LoadAllAssets。当需要加载的Object数量很多，又少于AssetBundle里的2&#x2F;3的时候，我们可以采用制作多个小的AssetBundle，然后再通过LoadAllAssets加载)<br>“LoadAssetWithSubAssets should be used when loading a composite Asset which contains multiple embedded Objects. If the Objects that need to be loaded all come from the same Asset, but are stored in an AssetBundle with many other unrelated Objects.”(当加载由多个obejct构成的Object的时候，建议使用LoadAssetWithSubAssets。当加载的Objects都来之同一个Asset，但存储的AssetBundle里包含很多其他无关的Obejcts时，采用LoadAssetWithSubAssets)<br>“For any other case, use LoadAsset or LoadAssetAsync.”(其他情况都是用LoadAsset和LoadAssetAsync)</p>
<p>Low-Level Loading details:<br>“UnityEngine.Object loading is performed off the main thread: an Object’s data is read from storage on a worker thread. Anything which does not touch thread-sensitive parts of the Unity system (scripting, graphics) will be converted on the worker thread.”(Object的加载是在main thread上，而object data的数据读取是在worker thread。所有线程不敏感的数据都是在worker thread进行。)</p>
<p>加载AssetBundle里的Object需要注意些什么？<br>“An Object is assigned a valid Instance ID when its AssetBundle is loaded, the order in which AssetBundles are loaded is not important. Instead, it is important to load all AssetBundles that contain dependencies of an Object before loading the Object itself. Unity will not attempt to automatically load any child AssetBundles when a parent AssetBundle is loaded.”(当AssetBundle被加载的时候，Object会被assigned一个valide instance ID，因为这个instance ID是唯一的，所以AssetBundle的加载顺序并不重要，重要的是我们要确保所有Object依赖的Objects都被加载(Unity不会自动加载所有Child AssetBundles当Parent AssetBundle被加载的时候))<br>下面以Material A引用Texture B为例。Material A被Packaged到了AssetBundle1，而Texture B被packaged到了AssetBundle2。<br><img src="/img/Unity/AssetBundleDependencies.PNG" alt="AssetBundleDependencies"><br>所以我们要使用Material A，我们不仅要加载AssetBundle1，还得确保在此之前我们加载了AssetBundle2里的Texture B</p>
<p>AssetBundle的dependencies信息存储在哪里？<br>AssetBundleManifest存储了AssetBundle’s dependency information(AssetBundle里的依赖关系信息)</p>
<p>AssetBundleManifest存放在哪里？<br><a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/topics/best-practices/assetbundle-fundamentals?playlist=30089">This Asset will be stored in an AssetBundle with the same name as the parent directory where the AssetBundles are being built.</a>(AssetBundleManifest存放在AssetBundle同级目录，并且包含一样的名字)</p>
<p>Note:<br><a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/topics/best-practices/assetbundle-fundamentals?playlist=30089">The AssetBundle containing the manifest can be loaded, cached and unloaded just like any other AssetBundle.</a>(AssetBundleManifest可以像AssetBundle一样被加载，缓存，释放)</p>
<p>如何查询AssetBundle里的Dependecy信息？<br>Depending on the runtime environmen:</p>
<ol>
<li>Editor<br>AssetDatabase API(Query AssetBundle dependencies)<br>AssetImporter API(Access and change AssetBundle assignments and dependencies)</li>
<li>Runtime<br>AssetBundleManifest API(load the dependency information of AssetBundle)<br> AssetBundleManifest.GetAllDependencies<br> AssetBundleManifest.GetDirectDependencies<br>Note:<br>“Both of these APIs allocate arrays of strings. Use them sparingly, and preferably not during performance-sensitive portions of an application’s lifetime.”(因为上述API会分配大量的string字符串，所以要尽量少用并且避开性能敏感的时期)</li>
</ol>
<p>接下来通过制作2个UI prefab：<br>一个包含全屏显示的Background image(打到uitextures AssetBundle里)<br>一个包含Backgroundimage但大小只有背景的一半(打到backgroundimage AssetBundle里)<br>同时设置background图片都打包到uitextures AssetBundle里<br>通过AssetBundleManifest API查询两个AssetBundle里的Dependencies信息。<br>首先如何制作AssetBundle？</p>
<ol>
<li>选择需要制作成AssetBundle的资源(Texture,Prefab)，设置相应的AssetBundle名字<br><img src="/img/Unity/AssetBundleUIBackgrnd1.PNG" alt="AssetBundleUIBackground1"><br><img src="/img/Unity/BackgroundImagePrefabAssetBundle.PNG" alt="BackgroundImagePrefabAssetBundle"><br><img src="/img/Unity/UIBackgroundPrefabAssetBundle.PNG" alt="UIBackgroundPrefabAssetBundle"></li>
<li>调用BuildPipeline.BuildAssetBundles()打包AssetBundle<br> Unity5.4官网给出了两个方法：</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> AssetBundleManifest <span class="title">BuildAssetBundles</span>(<span class="params"><span class="built_in">string</span> outputPath, BuildAssetBundleOptions assetBundleOptions, BuildTarget targetPlatform</span>)</span>; </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> AssetBundleManifest <span class="title">BuildAssetBundles</span>(<span class="params"><span class="built_in">string</span> outputPath, AssetBundleBuild[] builds, BuildAssetBundleOptions assetBundleOptions, BuildTarget targetPlatform</span>)</span>; </span><br></pre></td></tr></table></figure>
<pre><code>前者是以UnityEditor设置的AssetBundle name为准进行所有AssetBundle打包，后者是根据自定义的打包规则打包特定AssetBundle。
这里我尝试使用前者针对PC进行测试。
</code></pre>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> UnityEditor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">AssetBundleMenu</span> &#123;</span><br><span class="line">    [<span class="meta">MenuItem(<span class="string">&quot;Assets/Build AssetsBundle&quot;</span>)</span>]</span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">BuildAllAssetBundles</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (!AssetDatabase.IsValidFolder(<span class="string">&quot;Assets/StreamingAssets&quot;</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            AssetDatabase.CreateFolder(<span class="string">&quot;Assets&quot;</span>, <span class="string">&quot;StreamingAssets&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Caching.CleanCache();</span><br><span class="line">        BuildPipeline.BuildAssetBundles(<span class="string">&quot;Assets/StreamingAssets&quot;</span>, BuildAssetBundleOptions.None, BuildTarget.StandaloneWindows);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre><code>第一个参数是输出目录
第二参数控制AssetBundle打包设定，比如是否压缩等
第三个参数可设置打包平台
打包AssetBundle之后的目录结构：
![AssetBundleFolder](/img/Unity/AssetBundleFolder.PNG)
.manifest文件里存储了dependencies信息和AssetBundle里所打包的Assets相关信息
StreamingAssets.manifest
</code></pre>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ManifestFileVersion: <span class="number">0</span></span><br><span class="line">CRC: <span class="number">931964529</span></span><br><span class="line">AssetBundleManifest:</span><br><span class="line">  AssetBundleInfos:</span><br><span class="line">    Info_0:</span><br><span class="line">      Name: uitextures</span><br><span class="line">      Dependencies: &#123;&#125;</span><br><span class="line">    Info_1:</span><br><span class="line">      Name: backgroundimage</span><br><span class="line">      Dependencies:</span><br><span class="line">        Dependency_0: uitextures</span><br></pre></td></tr></table></figure>
<pre><code>uibackground.manifest
</code></pre>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">ManifestFileVersion: <span class="number">0</span></span><br><span class="line">CRC: <span class="number">1667709317</span></span><br><span class="line">Hashes:</span><br><span class="line">  AssetFileHash:</span><br><span class="line">    serializedVersion: <span class="number">2</span></span><br><span class="line">    Hash: <span class="number">452</span>c307ebc11a6155a4bdc61d8a0e39f</span><br><span class="line">  TypeTreeHash:</span><br><span class="line">    serializedVersion: <span class="number">2</span></span><br><span class="line">    Hash: a13e216067ae14bd74f1f5dcc7c211d7</span><br><span class="line">HashAppended: <span class="number">0</span></span><br><span class="line">ClassTypes:</span><br><span class="line">- Class: <span class="number">1</span></span><br><span class="line">  Script: &#123;instanceID: <span class="number">0</span>&#125;</span><br><span class="line">......</span><br><span class="line">Assets:</span><br><span class="line">- Assets/Resources/Textures/UI/backgroudn.png</span><br><span class="line">- Assets/Prefabs/UIBackground.prefab</span><br><span class="line">Dependencies: []</span><br></pre></td></tr></table></figure>
<pre><code>backgroundimage.manifest
</code></pre>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">ManifestFileVersion: <span class="number">0</span></span><br><span class="line">CRC: <span class="number">4279971007</span></span><br><span class="line">Hashes:</span><br><span class="line">  AssetFileHash:</span><br><span class="line">    serializedVersion: <span class="number">2</span></span><br><span class="line">    Hash: c15d1d4fd0fc89ad672fd6a94e16d981</span><br><span class="line">  TypeTreeHash:</span><br><span class="line">    serializedVersion: <span class="number">2</span></span><br><span class="line">    Hash: <span class="number">4583000</span>a582d4aadcaf8400b20641bd6</span><br><span class="line">HashAppended: <span class="number">0</span></span><br><span class="line">ClassTypes:</span><br><span class="line">- Class: <span class="number">1</span></span><br><span class="line">  Script: &#123;instanceID: <span class="number">0</span>&#125;</span><br><span class="line">......</span><br><span class="line">Assets:</span><br><span class="line">- Assets/Prefabs/BackgroundImage.prefab</span><br><span class="line">Dependencies:</span><br><span class="line">- Assets/ABs/uitextures</span><br></pre></td></tr></table></figure>
<pre><code>从StreamingAssets.manifest可以看出，我们总共制作了两个AssetBundle，名字分别为uitextures和backgroundimage，并且backgroundimage AssetBundle依赖于uitextures。
从uibackground.manifest和backgroundimage.manifest中可以看出，uibackground AssetBundle里包含了UIBackground.prefab和backgroudn.png，而backgroundimage AsssetBundle只包含BackgroundImage.prefab。
由于BackgroundImage.prefab使用background.png作为背景，但backgroundimage被打包到了uitextures AssetBundle里，所以backgroundimage AssetBundle是依赖于uitextures AssetBundle的。
</code></pre>
<ol start="3">
<li>通过AssetBundle API下载并加载主AssetBundle，然后通过AssetBundleManifest API查看所有AssetBundle的依赖信息并加载依赖的AssetBundle，最后通过AssetBundle API加载AssetBundle里的特定资源并实例化</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> UNITY_EDITOR</span></span><br><span class="line"><span class="keyword">using</span> UnityEditor;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">AssetBundleLoad</span> : <span class="title">MonoBehaviour</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Use this for initialization</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Start</span> ()</span> &#123;</span><br><span class="line">	    StartCoroutine(LoadAssetBundles());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">IEnumerator <span class="title">LoadAssetBundles</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="meta">#<span class="keyword">if</span> UNITY_EDITOR</span></span><br><span class="line">        <span class="keyword">var</span> names = AssetDatabase.GetAllAssetBundleNames();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="built_in">string</span> name <span class="keyword">in</span> names)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.Log(<span class="string">&quot;Current Alive Asset Bundle name: &quot;</span> + name);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        </span><br><span class="line">        <span class="built_in">string</span> bundlename = <span class="string">&quot;StreamingAssets&quot;</span>;</span><br><span class="line">        <span class="keyword">var</span> assetbundlerequest = AssetBundle.LoadFromFileAsync(Path.Combine(Application.streamingAssetsPath, bundlename));</span><br><span class="line">        <span class="keyword">yield</span> <span class="keyword">return</span> assetbundlerequest;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> assetbundle = assetbundlerequest.assetBundle;</span><br><span class="line">        <span class="keyword">if</span> (assetbundle == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.Log(<span class="string">&quot;Failed to load &quot;</span> + bundlename);</span><br><span class="line">            <span class="keyword">yield</span> <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        AssetBundleManifest manifest = assetbundle.LoadAsset&lt;AssetBundleManifest&gt;(<span class="string">&quot;AssetBundleManifest&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (manifest == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.Log(<span class="built_in">string</span>.Format(<span class="string">&quot;Failed to load &#123;0&#125;.manifest!&quot;</span>, bundlename));</span><br><span class="line">            <span class="keyword">yield</span> <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//try to instantiate backgroundimage assetbundle</span></span><br><span class="line">        <span class="comment">//but need to load dependencies assetbundle first</span></span><br><span class="line">        Debug.Log(<span class="string">&quot;Instantiate BackgroundImage.prefab&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> backgroundbundlename = <span class="string">&quot;backgroundimage&quot;</span>;</span><br><span class="line">        <span class="keyword">var</span> backgroundimagerequest = AssetBundle.LoadFromFileAsync(Path.Combine(Application.streamingAssetsPath, backgroundbundlename));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">yield</span> <span class="keyword">return</span> backgroundimagerequest;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (backgroundimagerequest == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.Log(<span class="built_in">string</span>.Format(<span class="string">&quot;Load &#123;0&#125; falied!&quot;</span>, <span class="string">&quot;backgroundimagerequest&quot;</span>));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> backgroundimageassetbundle = backgroundimagerequest.assetBundle;</span><br><span class="line">        <span class="keyword">if</span>(backgroundimageassetbundle == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.Log(<span class="built_in">string</span>.Format(<span class="string">&quot;Load &#123;0&#125; falied!&quot;</span>, backgroundimageassetbundle));</span><br><span class="line">            <span class="keyword">yield</span> <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> backgrounddependencies = manifest.GetAllDependencies(backgroundbundlename);</span><br><span class="line">        <span class="keyword">if</span> (backgrounddependencies.Length == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.Log(<span class="string">&quot;dependencies.length == 0&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Load dependencies assetbundle first</span></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="built_in">string</span> dependency <span class="keyword">in</span> backgrounddependencies)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.Log(<span class="string">&quot;Dependency : &quot;</span> + dependency);</span><br><span class="line">            <span class="keyword">var</span> dependencyabrequest = AssetBundle.LoadFromFileAsync(Path.Combine(Application.streamingAssetsPath, dependency));</span><br><span class="line">            <span class="keyword">yield</span> <span class="keyword">return</span> dependencyabrequest;</span><br><span class="line">            AssetBundle dependencyab = dependencyabrequest.assetBundle;</span><br><span class="line">            <span class="keyword">if</span> (dependencyab == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                Debug.Log(<span class="built_in">string</span>.Format(<span class="string">&quot;Load &#123;0&#125; failed!&quot;</span>, dependency));</span><br><span class="line">                <span class="keyword">yield</span> <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Once load all dependencies assetbundle, we can instantiate the gameobject in assetbundle</span></span><br><span class="line">        <span class="keyword">var</span> backgroundprefabrequest = backgroundimageassetbundle.LoadAssetAsync(<span class="string">&quot;BackgroundImage.prefab&quot;</span>);</span><br><span class="line">        <span class="keyword">yield</span> <span class="keyword">return</span> backgroundprefabrequest;</span><br><span class="line">        <span class="keyword">if</span>(backgroundprefabrequest == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.Log(<span class="built_in">string</span>.Format(<span class="string">&quot;Load &#123;0&#125; faled!&quot;</span>, <span class="string">&quot;BackgroundImage.prefab&quot;</span>));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        GameObject backgroundimage = backgroundprefabrequest.asset <span class="keyword">as</span> GameObject;</span><br><span class="line">        <span class="keyword">if</span>(backgroundimage == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.Log(<span class="string">&quot;backgroundimage == null&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            GameObject bggo = Instantiate(backgroundimage);</span><br><span class="line">            bggo.transform.SetParent(gameObject.transform, <span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//After complete using AssetBundle, always remember unload it, </span></span><br><span class="line">        <span class="comment">//otherwise you can not load it again due to it has exists in memory</span></span><br><span class="line">        assetbundle.Unload(<span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从上面可以看出，通过主的StreamingAssets，我们获取到了里面所包含的所有AssetBundle信息。然后通过加载指定AssetBundle以及dependencies AssetBundle后，我们就能成功初始化出AsestBundle里的资源。<br>上述代码实例化了Background.prefab(使用的backgroudn.png存储在uitextures AssetBundle里)<br>效果图：<br><img src="/img/Unity/BackgroundImageAssetBundleLoad.PNG" alt="BackgroundImageAssetBundleLoad"></p>
<p>上面使用的CreateFromFile后续Unity更新成了LoadFromFile，这个方法只支持uncompressed asset bundles，这里主要是因为利用了streaming assets，所以直接用这个方法可以加载本地的AssetBundle。<br>官方的建议在正式的时候是使用UnityWebRequest。<br>Note:<br><a target="_blank" rel="noopener" href="https://docs.unity3d.com/ScriptReference/BuildPipeline.BuildAssetBundles.html">Note that bundles built for standalone platforms are not compatible with those built for mobiles and so you may need to produce different versions of a given bundle. </a>(针对不同平台打包的AssetBundle不通用，需要各自打包对应平台的版本)</p>
<p>上面仅仅是以本地读取作为事例，了解了如何去访问AssetBundle以及manifest里的信息以及如何实例化AssetBundle里的资源。<br>那么如何判断AssetBundle是否需要更新了？<br>这里我们可以利用Built-in caching去实现版本更新判断。<br>“AssetBundle caching system that can be used to cache AssetBundles downloaded via the WWW.LoadFromCacheOrDownload or UnityWebRequest APIs.”(AssetBundle caching system可以帮助我们缓存加载了的AssetBundle而无需每次都重新加载)<br>而AssetBundle caching system是根据AssetBundle的version number来决定时是否下载新的AssetBundle。(AssetBundleManifest API支持通过MD5算法去计算出AssetBundle的version<br>number，这样一来每次AssetBundle有变化都会得到一个新的Hash version number)</p>
<p>“AssetBundles in the caching system are identified only by their file names, and not by the full URL from which they are downloaded.”(AssetBundles在Caching system里是通过文件名来标识的跟URL无关，所以无论AssetBundle放在服务器哪里都没有关系)</p>
<p>Cach相关的API控制:</p>
<ol>
<li>Caching.expirationDelay<br>“The minimum number of seconds that must elapse before an AssetBundle is automatically deleted. If an AssetBundle is not accessed during this time, it will be deleted automatically.”(AssetBundle可允许被删除的未使用时间，只有未被使用的时间达到了才能才被删除)</li>
<li>Caching.maximumAvailableDiskSpace<br>“The amount of space on local storage that the cache may use before it begins deleting AssetBundles that have been used less recently than the expirationDelay. It is counted in bytes.”(Caching内存使用上限)</li>
</ol>
<p>Note:<br>“As of Unity 5.3, control over the built-in Unity cache is very rough. It is not possible to remove specific AssetBundles from the cache. They will only be removed due to expiration, excess disk space usage, or a call to Caching.CleanCache. (Caching.CleanCache will delete all AssetBundles currently in the cache.) “(Caching System还不完善，所以还不允许删除特定AssetBundle，而只能通过Caching.CleanCache去删除所有的AssetBundle)</p>
<p>Cache Priming:<br>Steps:</p>
<ol>
<li>Store the initial or base version of each AssetBundle in &#x2F;Assets&#x2F;StreamingAssets&#x2F;</li>
<li>Loading AssetBundles from Application.streamingAssetsPath the first time the application is run</li>
<li>Call WWW.LoadFromCacheOrDownload or UnityWebRequest normally.</li>
</ol>
<p>Custom downloaders:<br><a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/topics/best-practices/assetbundle-usage-patterns?playlist=30089">Custom downloaders More</a><br>……</p>
<p>一般AssetBundle都是通过WWW.LoadFromCacheOrDownload(老版本)或者UnityWebRequest指定url和版本号信息去决定是否下载更新到本地。<br>然后我们利用AssetBundle.CreateFromFile()去读取AssetBundle，从而实现动态更新AssetBundle。</p>
<p>那么在使用AssetBundle的过程中，我们应该遵循后续讲到的内容(大部分翻译至官网，翻译不太对的地方欢迎指出)：<br>Managing Loaded Assets：<br>“If an AssetBundle is unloaded improperly, it can cause Object duplication in memory. Improperly unloading AssetBundles can also result in undesirable behavior in certain circumstances.”(不合理的释放Object会导致在内存中重复创建Object。同时也可能导致非预期的问题(比如texture丢失))</p>
<p>对于AssetBundle里Assets管理，这里需要强调的一个API是AssetBundle.Unload(bool);<br>Unloads all assets in the bundle.<br>Unload frees all the memory associated with the objects inside the bundle.<br>当传递true的时候所有从AssetBundle里实例化的Object都会被unload。传递false则只释放AssetBundle资源。</p>
<p>那么这里释放的AssetBundle资源是哪些了？<br>还记得之前提到的AssetBundle的组成吗(header &amp; data segment)</p>
<p>下面通过AssetBundleAB里的Material Object M实例化的M为例：<br><img src="/img/Unity/AssetBundleUnload.PNG" alt="AssetBundleUnload"><br><img src="/img/Unity/AssetBundleAfterUnloadFalse.PNG" alt="AssetBundleAfterUnloadFalse"><br><img src="/img/Unity/AssetBundleReload.PNG" alt="AssetBundleReload"><br><img src="/img/Unity/AssetBundleLoadObjectAgain.PNG" alt="AssetBundleLoadObjectAgain"><br>如果AB.Unload(true)，那么实例化的M会被destroyed。<br>如果AB.Unload(false)，那么AB里的信息会被unloaded，但M还存在于Scene里，但M和AB之间关联就断开了。<br>当我们重新加载AB后，我们只是再次加载了AB里的信息，但M和AB还是没有关联。<br>当我们通过重新加载的AB再去实例化Material Object M的时候，我们是创建了一个关联到当前AB的新的M而非把就的关联到AB(Scene里当前存在两个M)</p>
<p>当我们想unloaded旧的M的时候，只能通过下列方式：</p>
<ol>
<li>Eliminate all references to an unwanted Object, both in the scene and in code. After this is done, call Resources.UnloadUnusedAssets.(取消所有引用，并调用Resources.UnloadUnusedAssets)</li>
<li>Load a scene non-additively. This will destroy all Objects in the current scene and invoke Resources.UnloadUnusedAssets automatically.(切换Scene，触发Resources.UnloadUnusedAssets)</li>
</ol>
<p>“Another problem can arise if Unity must reload an Object from its AssetBundle after the AssetBundle has been unloaded. In this case, the reload will fail and the Object will appear in the Unity Editor’s hierarchy as a (Missing) Object.”(当AssetBundle被释放后，如果再从该AssetBundle里加载Object会加载失败，出现missing object)</p>
<p>Distribution:<br>Two basic ways to distribute a project’s AssetBundles to clients:</p>
<ol>
<li>Installing them simultaneously with the project </li>
<li>Downloading them after installation.<br>使用哪一种方式，主要取决于平台需求。<br>“Mobile projects usually opt for post-install downloads to reduce initial install size and remain below over-the-air download size limits. Console and PC projects generally ship AssetBundles with their initial install.”(手机上为了减少安装程序大小，通常选择post-installation。而PC不担心硬盘不够，所以通常选择initial install)</li>
</ol>
<p>Shipped with Project：<br>“To reduce project build times and permit simpler iterative development. If these AssetBundles do not need to be updated separately from the application itself, then the AssetBundles can be included with the application by storing the AssetBundles in Streaming Assets.”(和程序一起更新的AssetBundle可以放在streaming assets伴随程序一起打包发布)</p>
<p>Streaming Assets:<br>“The easiest way to include any type of content within a Unity application at install time is to build the content into the &#x2F;Assets&#x2F;StreamingAssets&#x2F; folder, prior to building the project. Anything contained in the StreamingAssets folder at build time will be copied into the final application. This folder can be used to store any type of content within the final application, not just AssetBundles.”(可以看出Streaming Assets被存放在&#x2F;Assets&#x2F;StreamingAssets&#x2F;目录下，最终会被打包到应用程序里)</p>
<p>Note:<br>“Android Developers: On Android, Application.streamingAssetsPath will point to a compressed .jar file, even if the AssetBundles are compressed. In this case, WWW.LoadFromCacheOrDownload must be used to load each AssetBundle.”(在Android上，streamingAssetsPath指向的是压缩后的.jar文件，所以我们需要采用LoadFromCacheOrDonwload去解压读取(5.3及以后可以采用UnityWebRequest’s DonwloadHandleAssetBundle))</p>
<p>“Streaming Assets is not a writable location on some platforms. If a project’s AssetBundles need to be updated after installation, either use WWW.LoadFromCacheOrDownload or write a custom downloader. “(因为Streaming Assets在一些平台上是一个不可写的位置，所以我们如果还需要更新该AssetBundle，我们而已通过WWW.LoadFromCacheOrDonwload或则自己编写custom downloader)</p>
<p>Donwloaded post-install:<br>手机上出于程序安装大小考虑多采用这个方案。<br>同时AssetBundle通过WWW.LoadFromCacheOrDownload or UnityWebRequest的更新可以快速方便的更新一些经常变化的资源。<br><a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/topics/best-practices/assetbundle-usage-patterns?playlist=30089">更多内容参见</a></p>
<p>Asset Assignment Strategies:<br>The key decision is how to group Objects into AssetBundles. The primary strategies are:</p>
<ol>
<li>Logical entities</li>
<li>Object Types</li>
<li>Concurrent content<br><a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/topics/best-practices/assetbundle-usage-patterns?playlist=30089">详情参见</a></li>
</ol>
<p>Guidelines to follow:</p>
<ol>
<li>Split frequently-updated Objects into different AssetBundles than Objects that usually remain unchanged</li>
<li>Group together Objects that are likely to be loaded simultaneously</li>
</ol>
<p>Patching with AssetBundles:<br>“Patching AssetBundles is as simple as downloading a new AssetBundle and replacing the existing one.”(Patching AssetBundles用于实现动态替换一些资源很方便)</p>
<p>AssetBundle Variants：<br>什么是AssetBundle Variants？<br>AssetBundle Variants可以指定AssetBundle里Asset的别名。(两个不同的名字可以指代同一个Asset)</p>
<p>AssetBundle Variants可以用来做什么？<br>[<a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/topics/best-practices/assetbundle-usage-patterns?playlist=30089">The purpose of Variants is to allow an application to adjust its content to better suit its runtime environment. Variants permit different UnityEngine.Objects in different AssetBundle files to appear as being the “same” Object when loading Objects and resolving Instance ID references.It permits two UnityEngine.Objects to appear to share the same File GUID &amp; Local ID, and identifies the actual UnityEngine.Object to load by a string Variant ID.</a>(AssetBundle Variants的主要目的是用于动态适应一些运行时的设置。AssetBundle Variants允许两个Asset Object拥有同样的File GUID …&amp; Local ID，但可以通过string Variant ID加载特定的Asest Object)</p>
<p>什么情况下适合使用AssetBundle Variants？</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/topics/best-practices/assetbundle-usage-patterns?playlist=30089">Variants simplify the loading of AssetBundles appropriate for a given platform</a>(用于加载特定平台的对应AssetBundle)</li>
<li><a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/topics/best-practices/assetbundle-usage-patterns?playlist=30089">Variants allow an application to load different content on the same platform, but with different hardware.</a>(针对不同硬件相同平台加载对应的content资源)</li>
</ol>
<p>那么AssetBundle Variants有哪些限制？<br><a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/topics/best-practices/assetbundle-usage-patterns?playlist=30089">A key limitation of the AssetBundle Variant system is that it requires Variants to be built from distinct Assets.</a>(最大的限制就是AssetBundle Variant要求不同的Variants必须编译到不同的Asset。这样一来会导致重复的资源打包(e.g比如两个不同的Texture Variant只是import设置不一样也必须编译两份))</p>
<p>另一个AssetBundle需要关注的点就是Compressed or Uncompressed？<br>那么如何在Compressed和Uncompressed之间抉择了？主要关注以下几点：</p>
<ol>
<li>加载速度。<br>压缩与否影响AssetBundle的资源大小，同时也影响加载的时候的加载速度。</li>
<li>AssetBundle编译时间。<br>同时压缩的话也会导致Build AssetBundle的时间变长。</li>
<li>程序大小<br>一些AssetBundle是伴随Application打包发布，会影响程序初始大小</li>
<li>内存使用<br>不同的压缩算法对加载时对内存的影响也不一样，LZ4压缩算法和未压缩的方式允许AssetBundle无需解压缩就能访问使用(节约内存)。</li>
<li>AssetBundle下载时间<br>AssetBundle资源的大小也同时影响AssetBundle的下载时间。</li>
</ol>
<p>更多学习<a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/topics/best-practices/assetbundle-usage-patterns?playlist=30089">参考</a><br><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/BuildingAssetBundles.html">AssetBundles</a></p>
<p>具体现有的完美AssetBundle使用方案，<a target="_blank" rel="noopener" href="https://bitbucket.org/Unity-Technologies/assetbundledemo">AssetBundle Manager on Bitbucket</a><br>接下来以学习使用AssetBundle Manager来理解AssetBundle里的一些相关知识和概念。<br>首先来看看什么是AssetBundle Manager？<br><a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/topics/scripting/assetbundles-and-assetbundle-manager">The AssetBundle Manager is a downloadable package that can be installed in any current Unity project and will provide a High-level API and improved workflow for managing AssetBundles.</a>(可以看出AssetBundle Manager为我们提供了更高层的AssetBundle管理的抽象，更方便使用和管理AssetBundle，作为免费的第三方插件在Unity Asset Store可以下载使用)<br><a target="_blank" rel="noopener" href="https://www.assetstore.unity3d.com/#!/content/45836">AssetBundle Manager Download</a></p>
<p>那么AssetBundle Manager能做到什么？<br><a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/topics/scripting/assetbundles-and-assetbundle-manager">The AssetBundle Manager helps manage the key steps in building and testing AssetBundles. The key features provided by the AssetBundle Manager are a Simulation Mode, a Local AssetBundle Server and a quick menu item to Build AssetBundles to work seamlessly with the Local AssetBundle Server.</a>(在AssetBundle里，最令人头疼的是编译和测试(需要不断编译然后上传然后测试)。AsestBundle Manager为我们提供了本地AssetBundle Server模拟的方案，还有快速编译打包AssetBundle的菜单，让我们可以快速的编译测试AssetBundle)<br><img src="/img/Unity/AssetBundleManagerQuickMenu.PNG" alt="AssetBundleManagerQuickMenu"><br>Simulation Mode:<br><a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/topics/scripting/assetbundles-and-assetbundle-manager">When enabled, allows the editor to simulate AssetBundles without having to actually build them. The editor looks to see which Assets are assigned to AssetBundles and uses these Assets directly from the Project’s hierarchy as if they were in an AssetBundl.</a>(当模拟模式开启的时候，editor可以通过不编译AssetBundle就能模拟AssetBundles的使用(直接使用指定了AssetBundle name的Assets)，这样一来在Editor下就能快速的修改测试，无需每次编译AssetBundle)</p>
<p>Local Asset Server:<br>作为AssetBundle里重要的功能之一： AsssetBundle Variant<br>AssetBundle Manager也支持了快速方便的AssetBundle Variant测试。<br>通过Local Asset Server的本地模拟方式测试。(同时Local Asset Server还支持真机测试)<br>Note:<br><a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/topics/scripting/assetbundles-and-assetbundle-manager">When Local Asset Server is enabled, AssetBundles must be built and placed in a folder explicitly called “AssetBundles” in the root of the Project, which is on the same level as the “Assets” folder.</a>(当Local Asest Server开启的时候，AssetBundles必须编译放置在Assets&#x2F;AssetBundles目录下)</p>
<p>Build AssetBundles:<br>快速编译打包AssetBundles。</p>
<p>实战学习使用AssetBundle Manager：<br>首先粗略的了解下AssetBundle Manager提供的一些API：<br>Initialize() – Initializes the AssetBundle manifest object.(初始化AssetBundle Manifest Object)<br>LoadAssetAsync() – Loads a given asset from a given AssetBundle and handles all the dependencies.(加载特定Asset，并负责处理器所有的dependencies)<br>LoadLevelAsync() – Loads a given scene from a given AssetBundle and handles all the dependencies.(加载特定scene，并负责处理所有的dependencies)<br>LoadDependencies() – Loads all the dependent AssetBundles for a given AssetBundle.(加载AssetBundle所依赖的所有dependencies)<br>BaseDownloadingURL – Sets the base downloading url which is used for automatic downloading dependencies.(设置dependencies下载url)<br>SimulateAssetBundleInEditor – Sets Simulation Mode in the Editor.(设置editor的模拟模式)<br>Variants – Sets the active variant.(设置激活的variants)<br>RemapVariantName() – Resolves the correct AssetBundle according to the active variant.</p>
<p>Loading Assets(AssetLoader.unity)：<br>待续……</p>
<h2 id="Resource-LifeCycle"><a href="#Resource-LifeCycle" class="headerlink" title="Resource LifeCycle"></a>Resource LifeCycle</h2><p>在得出如何利用Resources和AsetBundle高效管理资源方案之前，我们需要了解Resource的Lifecycle。<br>还记得前面提到的Asset和Obejct是如何被Unity记录下来的吗？<br>通过File GUID进行Asset标识(存储在.meta文件里，还存储了导入配置信息)，通过Local ID对Object标识(存储在Asset文件自身，还存储了Object具体的配置信息)。<br>然后Unity通过Instance ID cache system管理着Instance ID到File GUID和Local ID(用于标识Asset的Obejct)的映射去查询访问每一个Object。</p>
<p>那么Resources Lifecycle(UnityEngine.Object)具体是怎样的了？<br>程序启动时会去加载所有场景里引用的Object的Instance ID，后续程序动态加载或则通过AssetBundle加载资源的时候会去更新新的Instance ID。</p>
<p>Two ways to load UnityEngine.Objects(加载Object): </p>
<ol>
<li>Automatically – An Object is loaded automatically whenever the instance ID mapped to that Object is dereferenced(间接引用)</li>
<li>Explicitly – Resource-loading API(e.g. AssetBundle.LoadAsset)</li>
</ol>
<p>那么Object什么情况下才会被加载到游戏里了？<br>An Object will be loaded on-demand the first time its Instance ID is dereferenced if two criteria are true:(当Instance ID被间接引用同时满足以下两个条件的时候，Object会被加载)</p>
<ol>
<li>The Instance ID references an Object that is not currently loaded(Instance ID引用的Object还没加载)</li>
<li>The Instance ID has a valid File GUID and Local ID registered in the cache(Instance ID拥有的File GUID和Local ID已经存在于cache里)</li>
</ol>
<p>什么情况下，Object会被unloaded了？<br>Objects are unloaded in three specific scenarios(Object被Unloaded的三种情况):</p>
<ol>
<li>Objects are automatically unloaded when unused Asset cleanup occurs.(比如Application.LoadLevel() Rersources.UnloadUnusedAssets()调用的时候，Object会被自动unloaded)</li>
<li>Objects sourced from the Resources folder can be explicitly unloaded by invoking the Resource.UnloadAsset API.(主动调用Resource API去unload resoures下的object)</li>
<li>Objects source from Asset Bundles are automatically and immediately unloaded when invoking the AssetBundle.Unload(true) API.(这样会导致AssetBundle里的Objects InstanceID的引用无效)<br>具体Resource API如何影响Object的的生命周期，还需进一步学习，参考文档<a target="_blank" rel="noopener" href="https://docs.unity3d.com/ScriptReference/AssetBundle.html">AssetBundle</a></li>
</ol>
<p>知道了Resources的生命周期和如何被映射缓存的，那么如何才能以高效的方式存储resources了？<br>Loading Large Hierarchies(当我们制作一个复杂的Resources时):<br>“When serializing hierarchies of Unity GameObjects (such as when serializing prefabs), it is important to remember that the entire hierarchy will be fully serialized.”(当序列化Unity GameObject的时候，所有存在于hierarchy下的GameObject都会被一一序列化。)</p>
<p>When creating any GameObject hierarchy, CPU time is spent in several different ways:</p>
<ol>
<li>Time to read the source data (from storage, from another GameObject, etc.)</li>
<li>Time to set up the parent-child relationships between the new Transforms</li>
<li>Time to instantiate the new GameObjects and Components</li>
<li>Time to awaken the new GameObjects and Components<br>我们的关注点放到第一点上，数据的读写方式对后面三点影响不大，第一点跟数据的读写方式和数据的大小紧密相关。<br>“On all current platforms, it is considerably faster to read data from elsewhere in memory rather than loading it from a storage device. “(所有平台上，从内存中读取都比从存储设备去读取快，当然不同的平台的读取速度会有一些差别)</li>
</ol>
<p>我们前面提到当由复杂结构的GameObject的时候，所有对象都会被单独序列化(无论是否重复)，这样一来会导致数据量很大，在加载的时候很慢。为了提高速度，我们可以通过把复杂的GameObject划分为多个单独的小的Prefab，然后通过实例化多个Prefab来构建我们的GameObject而非完全依赖于Unity的Serialization和prefab system。(减少了数据量。同时一旦Prefab被加载后，从内存中读取就比从硬件设备读取快多了)</p>
<h1 id="内置资源"><a href="#内置资源" class="headerlink" title="内置资源"></a>内置资源</h1><p><strong>内置资源</strong>是指Unity默认自带的一些资源(e.g. 默认的图标资源，默认的材质资源，默认的天空盒资源，默认的Shader资源等)</p>
<p>为什么要了解内置资源了？</p>
<p>因为内置资源我们没法显示指定AB名字，容易造成打包冗余。所以在了解特定资源打包之前，我们来学习了解下如何避免内置资源造成的打包冗余。</p>
<p>详情参考:</p>
<p><a target="_blank" rel="noopener" href="https://blog.uwa4d.com/archives/1577.html">Unity 5.x AssetBundle零冗余解决方案</a></p>
<p>要想避免内置资源的打包冗余，我们需要把内置资源提取出来使用。结合上面的文章的学习，可以理解成如下几步：</p>
<ol>
<li>提取内置资源</li>
<li>修改内置资源引用(手动)</li>
<li>检查内置资源引用</li>
</ol>
<p>本人尝试了前面文章提到的 AssetDataBase.LoadAllAssetsAtPath(“Resources&#x2F;unity_builtin_extra”)的方式，发现并不能得到内置资源(<strong>AssetDataBase.LoadAllAssetsAtPath(“Resources&#x2F;unity_builtin_extra”)此路不通后，暂时只想到从使用内置资源的对象上复制内置资源进行提取了。</strong>)</p>
<p>修改内置资源的引用比较麻烦，需要修改相关文件里对内置资源引用的guid和fieldID等来实现串改内置资源引用的目的。这样做实现起来比较困难，所以这里并不打算使用此方案。</p>
<p>新方案：</p>
<p><strong>直接收集所有使用了内置资源的资源然后结合内置资源引用统计分析来进行时侯东替换来实现内质资源的引用替换</strong></p>
<p>实现上述功能我们需要做到如下两点：</p>
<ol>
<li>提取内置资源</li>
<li>结合内置资源引用分析替换对应内置资源成提取出来的资源</li>
</ol>
<p>资源辅助工具三件套：</p>
<ul>
<li><p>资源依赖查看工具</p>
<p><img src="/img/Unity/AssetBundle-Framework/AssetDependenciesBrowser.png" alt="AssetDependenciesBrowser"></p>
</li>
<li><p>内置资源依赖统计工具(只统计了*.mat和*.prefab，场景建议做成Prefab来统计)</p>
<p><img src="/img/Unity/AssetBundle-Framework/BuildInResourceReferenceAnalyze.png" alt="BuildInResourceReferenceAnalyze"></p>
</li>
<li><p>内置资源提取工具</p>
<p><img src="/img/Unity/AssetBundle-Framework/BuildInResourceExtraction.png" alt="BuildInResourceExtraction"></p>
</li>
</ul>
<p>至此，我们完成了依赖Asset统计，内置资源引用分析，内置资源提取和内置资源引用替换(手动)。</p>
<p>详细代码：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/TonyTang1990/AssetBundleLoadManager">AssetBundleLoadManager</a></p>
<p>解决了内置Shader的引用打包问题，后面在专门讲Shader的小节会提到如何使用ShaderVariantsCollection解决变体预加载问题。</p>
<p>Note:</p>
<ol>
<li>内置Shader可直接官网下载</li>
<li><strong>复制提取资源引用的Shader需要重新指定一次才能正确引用本地下载的Shader</strong></li>
<li><strong>一开始导入下载好的内置Shader后，经过代码统计原来引用内置Shader的还是引用的内置的，但我将一个导入的内置Shader改名(这里指的改Shader “Mobile&#x2F;Diffuse” 后再改回来发现引用内置Shader的资源变成了引用最新导入的内置Shader了。</strong></li>
</ol>
<h1 id="Unity-AB实战"><a href="#Unity-AB实战" class="headerlink" title="Unity AB实战"></a>Unity AB实战</h1><p>以Unity5.0以后的版本作为学习对象。<br>打包以及加载管理这一套实战，单独提了一篇文章来写，详情查看:<br><a href="http://tonytang1990.github.io/2018/10/24/AssetBundle-Framework">AssetBundle-Framework</a></p>
<h1 id="特定资源打包"><a href="#特定资源打包" class="headerlink" title="特定资源打包"></a>特定资源打包</h1><p>这里针对不同的资源类型进行深度学习了解，理解项目中为什么不同的资源格式不同的平台为什么要设置特定的格式或者导入设定等信息，从而优化资源的内存占用以及相关不必要的开销。</p>
<h2 id="纹理贴图"><a href="#纹理贴图" class="headerlink" title="纹理贴图"></a>纹理贴图</h2><p>纹理贴图是游戏内存占用中的一个很大板块(含纹理，图集等)。</p>
<p>首先让我们理解一下，纹理贴图里一些重要的概念:</p>
<ol>
<li>GPU与纹理</li>
<li>文件格式</li>
<li>纹理格式</li>
<li>压缩算法</li>
</ol>
<h3 id="移动GPU"><a href="#移动GPU" class="headerlink" title="移动GPU"></a>移动GPU</h3><ol>
<li><p>Imagination Techniologies(PowerVR)<br>代表作： Apple Iphone，Ipad系列</p>
</li>
<li><p>Qualcomm(高通 Adreno系列)<br>代表作：小米部分手机</p>
</li>
<li><p>ARM(Mali系列)<br>代表作：三星部分手机</p>
</li>
<li><p>NVIDIA(英伟达 Tegre系列)<br>代表作：Google Nexus部分手机</p>
</li>
</ol>
<h3 id="文件格式"><a href="#文件格式" class="headerlink" title="文件格式"></a>文件格式</h3><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/luming1979/archive/2013/02/04/2891421.html">文件格式是图像为了存储信息而使用的对信息的特殊编码方式，它存储在磁盘中，或者内存中，但是并不能被GPU所识别，因为以向量计算见长的GPU对于这些复杂的计算无能为力。这些文件格式当被游戏读入后，还是需要经过CPU解压成R5G6B5，A4R4G4B4，A1R5G5B5，R8G8B8, A8R8G8B8等像素格式，再传送到GPU端进行使用。</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/luming1979/archive/2013/02/04/2891421.html">常用的图像文件格式有BMP，TGA，JPG，GIF，PNG等；</a></p>
<p>文件格式主要决定了原数据是有损还是无损的以及数据存储方式。<br>这里主要提两个常见的文件格式：</p>
<ol>
<li>PNG<br><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/PNG">便携式网络图形（Portable Network Graphics，PNG）是一种<strong>无损压缩</strong>的位图图形格式，支持索引、灰度、RGB三种颜色方案以及Alpha通道等特性。</a></li>
<li>JPG<br><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/JPEG">JPEG是一种针对照片视频而广泛使用的<strong>有损压缩</strong>标准方法。</a><a target="_blank" rel="noopener" href="https://www.zhihu.com/question/20028452">JPEG不适合用来存储企业Logo、线框类的图。因为有损压缩会导致图片模糊</a></li>
</ol>
<p>详情参考:<a target="_blank" rel="noopener" href="https://www.zhihu.com/question/20028452">图片格式 jpg、png、gif各有什么优缺点？什么情况下用什么格式的图片呢？</a></p>
<p>Note：<br><strong>考虑到Unity最终进游戏是源文件经过Unity压缩后的形式，所以个人觉得采用不压缩的PNG作为源文件相比JPG更好(1. 无损压缩 2. 支持Alpha通道)。</strong></p>
<h3 id="纹理格式"><a href="#纹理格式" class="headerlink" title="纹理格式"></a>纹理格式</h3><p>在了解纹理格式之前，我先了解下纹理格式能带来什么好处？<br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/luming1979/archive/2013/02/04/2891421.html"><strong>纹理格式是能被GPU所识别的像素格式，能被快速寻址并采样。</strong></a><br>简而言之<a target="_blank" rel="noopener" href="http://imgtec.eetrend.com/blog/6912"><strong>无需CPU解压即可被GPU读取，节省CPU时间和带宽。</strong></a></p>
<p>了解了纹理格式的好处，让我们看看不同的纹理格式的内存占用情况。<br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/luming1979/archive/2013/02/04/2891421.html">OpenGL ES 2.0支持以上提到的R5G6B5，A4R4G4B4，A1R5G5B5，R8G8B8，A8R8G8B8等纹理格式，其中 R5G6B5，A4R4G4B4，A1R5G5B5每个像素占用2个字节(BYTE)，R8G8B8每个像素占用3个字节，A8R8G8B8每个像素占用 4个字节。</a><br><img src="/img/Unity/OpenGLES2TextureFormatDisplay.png" alt="OpenGLES2TextureFormatDisplay"></p>
<p>查了半天OpenGL ES 2.0的纹理格式支持，官方找到的，见下图:<br><img src="/img/Unity/OpenGLES2TextureFormatSupported.png" alt="OpenGLES2TextureFormat"></p>
<p><a target="_blank" rel="noopener" href="https://www.khronos.org/registry/OpenGL/specs/es/2.0/es_cm_spec_2.0.pdf">es_cm_spec_2.0.pdf</a></p>
<p>如何查询Android GPU是否支持OpenGL ES3.0我也没找到单个比较全面的网站，所以只找到各自GPU的官网或者wiki上有描述。<br>参考:<br><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Adreno">Adreno</a><br><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Mali_(GPU)">Mali (GPU)</a><br><a target="_blank" rel="noopener" href="https://www.qualcomm.cn/snapdragon/gpu-specifications">Qualcomm GPU规格</a></p>
<p>比如我们要查小米3是否支持OpenGL ES3.0，我们可以现在小米官网查到小米3使用的是Adreno 800 GPU，系统是&gt;4.3的。<br>那么我们去查adreno 800支不支持OpenGL ES3.0即可，然后发现在Qualcomm官网查到adreno 800系列全部都支持OpenGL ES3.0。</p>
<p>如何查询IOS GPU是否支持OpenGL ES3.0:<br>参考:<br><a target="_blank" rel="noopener" href="https://developer.apple.com/library/archive/documentation/DeviceInformation/Reference/iOSDeviceCompatibility/HardwareGPUInformation/HardwareGPUInformation.html">IOS device Graphics Processors</a></p>
<p>至于代码层面如何判定是否支持OpenGL 3.0：<br>参考UWA的一个问答:<br><a target="_blank" rel="noopener" href="https://answer.uwa4d.com/question/5ae714b00956834900752685">如何判断硬件支持GpuInstance</a></p>
<p>Note:</p>
<ol>
<li>ETC1不支持Alpha，ETC2支持Alpha，但ETC2需要OpenGL ES 3.0支持。</li>
<li>ETC2不仅需要Android 4.3以上，还要硬件GPU支持OpenGL ES3.0才行。</li>
<li>IOS5s(含5s)以后使用A7 GPU(含A7)以后的GPU才支持OpenGL ES3.0。</li>
</ol>
<h3 id="压缩压缩格式"><a href="#压缩压缩格式" class="headerlink" title="压缩压缩格式"></a>压缩压缩格式</h3><p>通过纹理格式，我们已经使得GPU能够直接读取纹理，为什么还需要纹理压缩了？<br><strong>纹理压缩的主要作用是为了压缩数据，减少内存开销。</strong></p>
<p>常见的纹理压缩格式：</p>
<ol>
<li><p>ETC(Erricsson texture compression)<br>这里的ETC主要分为ETC1和ETC2.</p>
<ul>
<li>ETC1主要是用于RGB的24-bit数据压缩(Note:不包含Alpha通道，在OpenGL ES 2.0就要求支持，所以基本是所有Android机型通用。参考：<a target="_blank" rel="noopener" href="https://www.khronos.org/registry/OpenGL/extensions/OES/OES_compressed_ETC1_RGB8_texture.txt">GL_OES_compressed_ETC1_RGB8_texture</a>。ETC1想要配合使用Alpha信息需要拆成两张图，一张RGB，一张A。)</li>
<li>ETC2在兼容ETC1的基础上支持了Alpha通道的压缩(Note:ECT2至少要OpenGL ES 3.0 参考：<a target="_blank" rel="noopener" href="https://www.khronos.org/assets/uploads/developers/library/2012-siggraph-opengl-es-bof/Ericsson-ETC2-SIGGRAPH_Aug12.pdf">ETC2 Compression</a>)</li>
</ul>
</li>
<li><p>PVRTC(PowerVR texture compression)<br>PowerVR主要用于苹果的压缩格式</p>
</li>
<li><p>ATITC(ATI texture compression)<br>Qualcomm Adreno系列。</p>
</li>
<li><p>S3TC(也叫作DXT)<br>PC的NVIDIA Tegra系列。</p>
</li>
<li><p>ASTC(Adaptive Scalable Texture Compression)<br><a target="_blank" rel="noopener" href="https://www.khronos.org/opengl/wiki/ASTC_Texture_Compression">ASTC Texture Compression</a><br>从wiki来看，ASTC是一个更高效，希望能统一移动端压缩格式的一个新兴压缩格式，要求至少OpenGL ES 3.0，且大部分手机现在并不支持ASTC(2018&#x2F;05&#x2F;28，当前只有少部分Mali的机器支持)。</p>
</li>
</ol>
<p>移动平台各种压缩格式像素数据信息(以下信息来源:<a target="_blank" rel="noopener" href="http://imgtec.eetrend.com/blog/6912">移动设备的纹理压缩方案</a>):<br><img src="/img/Unity/CompresssionFormatSizeComparision.png" alt="CompresssionFormatSizeComparision"></p>
<p>移动端平台压缩格式选择：<br>Android:</p>
<ol>
<li>ECT1是被OpenGL ES 2.0支持，适合大部分Android机器。</li>
<li>同时ASTC看起来离普及还有段时间。</li>
<li>随着OpenGL ES 3.0机器的普及，ETC2被大部分手机支持。</li>
</ol>
<p>综上看来ECT2将会成为近期不错的选择(2018&#x2F;05&#x2F;28)</p>
<p>下图为Google给出的OpenGL ES版本占比图：<br><img src="/img/Unity/OpenGLESOccupation.png" alt="OpenGLESOccupation"></p>
<p>IOS:<br>IOS支持的纹理压缩格式不多，通常采用PVRTC。PVRTC 2bit显示效果并不好，所以一般采用PCRTC 4bit。</p>
<p>Note：</p>
<ol>
<li>Google给出的是全球收集的数据信息，并不一定完全适合国内情况。</li>
<li><a target="_blank" rel="noopener" href="http://imgtec.eetrend.com/blog/6912">PVRTC 4bit里A占比较少，半透明效果不是很好</a></li>
<li>不同的压缩算法对原始图形的宽高像素有要求<br>详情参考,下图来源<a target="_blank" rel="noopener" href="http://gad.qq.com/article/detail/25347">干货：Unity游戏开发图片纹理压缩方案</a>:<br><img src="/img/Unity/TextureFormatComparision2.png" alt="TextureFormatComparision2"></li>
</ol>
<h3 id="纹理内存大小占用"><a href="#纹理内存大小占用" class="headerlink" title="纹理内存大小占用"></a>纹理内存大小占用</h3><p>通过前面我们学习了解了什么是纹理格式以及什么是纹理压缩。</p>
<p>说了那么多，我们最终的目标其实是为了在内存和显示效果之间选择一个比较合适的折中点。</p>
<p>内存占用和显示效果主要取决于纹理压缩算法。<br>首先让我们来看看，纹理的内存大小是如何计算的？<br>Texture Size(纹理大小) &#x3D; Texture Pixel Width(宽像素数量) * Texture Pixel Height(高像素数量) * Bytes Per Pixel(每个像素数据大小)</p>
<p>假设一张1024 * 1024的R8G8B8A8纹理格式的贴图在不压缩的情况下：<br>1024 * 1024 * 4byte &#x3D; 4.0M</p>
<p>假设一张1024 * 1024的R8G8B8A8纹理格式的贴图采用ETC2 4bit压缩:<br>1024 * 1024 * 4bit &#x3D; 0.5M</p>
<p>相同的纹理贴图压缩后的内存占用明显降低，具体显示效果跟压缩算法有关，这里暂时不深入学习讨论。<br>进阶学习理解：<br><a target="_blank" rel="noopener" href="https://blog.csdn.net/bugrunner/article/details/50538770">几种主流贴图压缩算法的实现原理</a></p>
<p>这里我们结合Unity实战学习一番：<br>首先这里我准备了三张不同大小的UI图，然后复制了多份，分别设置不同的压缩格式(为了方便的比较显示不同贴图大小对于不同压缩格式时的纹理内存占用大小):<br><img src="/img/Unity/TextureCompressionSprites.png" alt="TextureCompressionSprites"></p>
<p>可以看到我准备的三张分别是128 * 256， 200 * 200和256 * 256，大小都是特地准备的，为了说明后面针对不同大小的原图设置不同压缩格式会导致最终内存纹理贴图大小占用不一样。</p>
<p>这里也贴一下UI图的导入设置:<br><img src="/img/Unity/UITextureImporterSetting.png" alt="UITextureImporterSetting"></p>
<p>通过挂在测试脚本(TextureDetailInfoDisplay.cs)，得到我们想要查看的数据：<br>TextureDetailInfoDisplay.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             TextureDetailInfoDisplay.cs</span></span><br><span class="line"><span class="comment"> * Author:                  TONYTANG</span></span><br><span class="line"><span class="comment"> * Create Date:             2018//08/02</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> UnityEngine.UI;</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> TextureDetailInfoDisplay.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 用于计算显示当前Image使用的纹理贴图格式以及所占用的内存大小等信息</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TextureDetailInfoDisplay</span> : <span class="title">MonoBehaviour</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 图片显示组件</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> Image mImgSpriteDisplay;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 显示纹理信息的文本节点</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> Text mTxtTexturueInfoDisplay;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Start</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mImgSpriteDisplay = transform.GetComponent&lt;Image&gt;();</span><br><span class="line">        mTxtTexturueInfoDisplay = transform.GetChild(<span class="number">0</span>).GetComponent&lt;Text&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mImgSpriteDisplay != <span class="literal">null</span> &amp;&amp; mImgSpriteDisplay.sprite != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> texture = mImgSpriteDisplay.sprite.texture;</span><br><span class="line">            sb.Append(<span class="string">&quot;Name: &quot;</span>);</span><br><span class="line">            sb.Append(texture.name);</span><br><span class="line">            sb.Append(Environment.NewLine);</span><br><span class="line">            sb.Append(<span class="string">&quot;Texture Size: &quot;</span>);</span><br><span class="line">            sb.Append(texture.width);</span><br><span class="line">            sb.Append(<span class="string">&quot; * &quot;</span>);</span><br><span class="line">            sb.Append(texture.height);</span><br><span class="line">            sb.Append(Environment.NewLine);</span><br><span class="line">            sb.Append(<span class="string">&quot;Format: &quot;</span>);</span><br><span class="line">            sb.Append(texture.format.ToString());</span><br><span class="line">            sb.Append(Environment.NewLine);</span><br><span class="line">            sb.Append(<span class="string">&quot;Bits Per Pixel: &quot;</span>);</span><br><span class="line">            sb.Append(TextureUtilities.GetTextureFormatBitsPerPixel(texture.format));</span><br><span class="line">            sb.Append(<span class="string">&quot; bits&quot;</span>);</span><br><span class="line">            sb.Append(Environment.NewLine);</span><br><span class="line">            sb.Append(<span class="string">&quot;Memory Size: &quot;</span>);</span><br><span class="line">            sb.Append(TextureUtilities.GetTextureMemorySize(texture));</span><br><span class="line">            sb.Append(<span class="string">&quot; KBs&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            sb.Append(<span class="string">&quot;No Image or Sprite!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mTxtTexturueInfoDisplay != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            mTxtTexturueInfoDisplay.text = sb.ToString();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>TextureUtilities.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             TextureUtilities.cs</span></span><br><span class="line"><span class="comment"> * Author:                  TONYTANG</span></span><br><span class="line"><span class="comment"> * Create Date:             2018//08/05</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> TextureUtilities.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 纹理相关辅助工具</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">TextureUtilities</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 获取指定纹理图片内存占用大小</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Note:</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 这里是没有考虑mipmap的计算方法</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Texture Size = width * height * Bits Per Pixels / 8 /1024 = * KB</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;texture&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">int</span> <span class="title">GetTextureMemorySize</span>(<span class="params">Texture2D texture</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (texture != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> texture.width * texture.height * GetTextureFormatBitsPerPixel(texture.format) / <span class="number">8</span> / <span class="number">1024</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 获取指定纹理压缩格式的Bits Per Pixel(多少bit每像素)</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;textureformat&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/return&gt;</span>s</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">int</span> <span class="title">GetTextureFormatBitsPerPixel</span>(<span class="params">TextureFormat textureformat</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">switch</span>(textureformat)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">case</span> TextureFormat.ETC_RGB4:</span><br><span class="line">                <span class="keyword">return</span> <span class="number">4</span>;</span><br><span class="line">            <span class="keyword">case</span> TextureFormat.ETC2_RGB:</span><br><span class="line">            <span class="keyword">case</span> TextureFormat.ETC2_RGBA8:</span><br><span class="line">                <span class="keyword">return</span> <span class="number">8</span>;</span><br><span class="line">            <span class="keyword">case</span> TextureFormat.PVRTC_RGB4:</span><br><span class="line">            <span class="keyword">case</span> TextureFormat.PVRTC_RGBA4:</span><br><span class="line">                <span class="keyword">return</span> <span class="number">4</span>;</span><br><span class="line">            <span class="keyword">case</span> TextureFormat.ARGB4444:</span><br><span class="line">            <span class="keyword">case</span> TextureFormat.RGBA4444:</span><br><span class="line">            <span class="keyword">case</span> TextureFormat.RGB565:</span><br><span class="line">                <span class="keyword">return</span> <span class="number">16</span>;</span><br><span class="line">            <span class="keyword">case</span> TextureFormat.RGB24:</span><br><span class="line">                <span class="keyword">return</span> <span class="number">24</span>;</span><br><span class="line">            <span class="keyword">case</span> TextureFormat.RGBA32:</span><br><span class="line">            <span class="keyword">case</span> TextureFormat.ARGB32:</span><br><span class="line">                <span class="keyword">return</span> <span class="number">32</span>;</span><br><span class="line">            <span class="literal">default</span>:</span><br><span class="line">                Debug.LogErrorFormat(<span class="string">&quot;没有被包含的纹理压缩格式：&#123;0&#125;，无法返回对应BitsPerPixel信息，请自己添加。&quot;</span>, textureformat);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出结果:<br><img src="/img/Unity/TextureComppresionSizeInfoDisplay.png" alt="TextureComppresionSizeInfoDisplay"></p>
<p>从上面我们可以看出以下几个结论：</p>
<ol>
<li><p>纹理的大小主要取决于纹理压缩格式和自身宽高，纹理压缩格式所占的Bits Per Pixel越大，纹理内存占用越大。<br><img src="/img/Unity/TextureMemorySizeIncreasing.png" alt="TextureMemorySizeIncreasing"></p>
</li>
<li><p>当不满足纹理压缩格式要求时，纹理会被Unity压缩成其他纹理格式导致内存增大。<br><img src="/img/Unity/NPOT_PVRTC.png" alt="NPOT_PVRTC"><br><img src="/img/Unity/NPOT_ETC1.png" alt="NPOT_ETC1"></p>
</li>
<li><p>ETC1本来是不支持Alpha的，但Unity 5.3以后，Unity支持通过设置Compress using ETC1(split alpha channel)并设置Packing Tag来支持ETC1自动分离Alpha的实现(否则需要我们自己分离以后在代码里融合ETC1和Alpha图)。ETC1 + Alpha Split直接在预览那里看不到真实大小，所以下面我是在Profile里查看的确认的。<br><a href="/img/Unity/ETC1AlphaSplit.png">ETC1AlphaSplit</a><br>手动分离Alpha + ETC1，参考:<br><a target="_blank" rel="noopener" href="https://support.unity3d.com/hc/zh-cn/articles/207051116-%E5%A6%82%E4%BD%95%E5%9C%A8ETC1%E5%8E%8B%E7%BC%A9%E6%96%B9%E5%BC%8F%E4%B8%AD%E6%B7%BB%E5%8A%A0Alpha%E9%80%9A%E9%81%93-">如何在ETC1压缩方式中添加Alpha通道?</a></p>
</li>
<li><p>清晰度一般来说是伴随着Bit Per Pixel的增加而增加(所以一般需要在内存和清晰度之间抉择)<br>详细参考:<br><a target="_blank" rel="noopener" href="http://gad.qq.com/article/detail/10057">移动设备的纹理压缩方案</a></p>
</li>
</ol>
<p>未来更多学习：<br>待续……</p>
<p>注意要点：</p>
<ol>
<li>ETC1要求长宽都POT(Power Of Two)，且ETC1不支持Alpha。</li>
<li>PVRTC要求长宽都POT且宽高要一致。</li>
<li>ETC2支持Alpha，但需要Android 4.3以上，还要硬件GPU支持OpenGL ES3.0才行。</li>
<li>根据前面的学习，我们知道ASTC格式支持要求高(OpenGL ES3.0)且还不普及，所以这里暂时只讨论ECT1，ETC2，PVRTC，RGB，RGBA这几种格式选择。(2018&#x2F;08&#x2F;03)。</li>
<li>ASTC从IOS9(A8架构)开始支持，压缩效果相比PVRTC更好且不需要设置正方形。</li>
<li>上面主要是针对移动设备来分析，所以没有考虑PC Windows平台比如DXT等压缩格式。</li>
</ol>
<p>疑问：<br>ETC2不要求宽高Power Of Two吗？(希望知道的朋友告知一下)<br>首先我确认ETC1是要求宽高必须POT的，不然会被强制转成其他格式：<br><img src="/img/Unity/NPOT_ETC1.png" alt="NPOT_ETC1"><br>但上述测试过程中我发现ETC2即使是NPOT也没有被转成其他格式：<br><img src="/img/Unity/NPOT_ETC2.png" alt="NPOT_ETC2"><br>后来测试加上查询资料(但是是从一篇博客上看到的)得知，ETC2要求宽高是4的倍数即可，所以200*200也没有转换成其他格式：<br><img src="/img/Unity/ETC2SizeRequirement.png" alt="ETC2SizeRequirement"><br>参考:<br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/zsb517/p/6297739.html">移动端纹理压缩格式</a></p>
<h3 id="纹理总结"><a href="#纹理总结" class="headerlink" title="纹理总结"></a>纹理总结</h3><p>简单理一下Unity处理纹理，在游戏里使用的流程:<br>原图(PNG,JPG…..) –&gt; Texture2D(压缩后的纹理图片，无需CPU解压，能被GPU识别的像素格式) –&gt; 游戏内Texture2D(看硬件是否支持，不支持会被硬件转换成其他格式,比如RGBA32)</p>
<p>纹理压缩格式的选择：<br>Android:<br>ETC1(需要POT,不支持Alpha) &gt; ETC1 + Alpha Split(需要配合大于Unity 5.3的Sprite Packer使用) &gt; ETC2(需要Android 4.3且OpenGL ES3.0) &gt; RGB16 &gt; RGBA16 &gt; RGB24 &gt; RGBA32</p>
<p>IOS:<br>PVRTC(需要POT且宽高一样) &gt; RGB16 &gt; RGBA16 &gt; RGB24 &gt; RGBA32</p>
<p>未来ETC2普及了，可能普遍是设置ETC2格式。至于ASTC也是未来的一个趋势，ASTC从IOS9(A8架构)开始支持(Android也还不普及)，但压缩效果相比PVRTC更好且不需要设置正方形。。(2018&#x2F;08&#x2F;05)</p>
<p>Note：<br><a target="_blank" rel="noopener" href="http://gad.qq.com/article/detail/25347">Unity3D引擎对纹理的处理是智能的：不论你放入的是PNG，PSD还是TGA，它们都会被自动转换成Unity自己的Texture2D格式。</a></p>
<h2 id="网格"><a href="#网格" class="headerlink" title="网格"></a>网格</h2><h2 id="动画"><a href="#动画" class="headerlink" title="动画"></a>动画</h2><h2 id="材质"><a href="#材质" class="headerlink" title="材质"></a>材质</h2><h2 id="特效"><a href="#特效" class="headerlink" title="特效"></a>特效</h2><h2 id="Shader"><a href="#Shader" class="headerlink" title="Shader"></a>Shader</h2><p>这一小节主要是针对Shader的变体打包相关知识进行学习，之前打包Shader的AB都是简单的全部标打包到一个AB里，所以没有关注Shader细节方面的优化问题。</p>
<p>这一小节通过学习Shader变体相关知识，来优化Shader打包和加载方面的问题。</p>
<p>还是先从What，Why，How三个方面来循序渐进</p>
<ol>
<li><p>什么是Shader？</p>
<p>结合以前学习OpenGL和Unity Shader，Shader在我的理解里就是GPU(从以前的固定管线到现在的可编程管线)处理图形图像相关数据(定点，像素，纹理等)的程序。</p>
</li>
<li><p>为什么需要Shader？</p>
<p>结合模型和纹理数据等，我们可以通过Shader程序去实现更多更酷炫的效果，而不是简单的模型纹理展示。而图形图像的处理上，正式GPU的特长，也就是为什么引入Shader程序的原因。</p>
</li>
<li><p>Shader是如何被程序加载使用的？</p>
<p>真正被真机使用的Shader还需要通过加载，解析，编译三个过程。以Shader被我们打包成AB为例。加载是指我们把Shader AB加载进内存。解析是指我们读取分析我们的Shader代码。编译是指将Shader代码编译成GPU特定的格式(而这一步是最耗时的，也是后面我们优化的关键部分)。加载解析编译完成后Shader才被真正的作用于我们的游戏里。</p>
</li>
<li><p>如何优化Shader打包加载？</p>
<p>这个问题是本小节的重点，得出这个问题答案之前，我们需要了解其他相关知识</p>
</li>
</ol>
<h3 id="Shader预加载"><a href="#Shader预加载" class="headerlink" title="Shader预加载"></a>Shader预加载</h3><p>老版本的时候我们通过加载所有Shader后调用Shader.WarmupAllShaders()来触发所有Shader变体的预加载编译，从而避免运行时Shader的解析卡顿开销。</p>
<p>但随着项目越来越大，使用的Shader越来越多，变体数也越来越多，粗暴的全部预加载编译变得不合适了，这也正是我们需要搜集需要用到的变体按需预编译加载变体的原因。</p>
<h4 id="变体"><a href="#变体" class="headerlink" title="变体"></a>变体</h4><p>什么是Shader变体(Shader Variants)？</p>
<p><a target="_blank" rel="noopener" href="https://blog.uwa4d.com/archives/USparkle_Shadervariant.html">In Unity,  many shaders internally have multiple “variants”, to account for different light modes, lightmaps, shadows and so on. These variants are indentified by a shader pass type, and a set of shader keywords. </a></p>
<p>从上面的介绍可以看出Shader变体是因为Shader宏，渲染状态等原因造成需要编译出多种不同的Shader代码，不同效果要想起作用都必须被打包进游戏里，不然就会出现Shader失效(实际为变体丢失)。</p>
<p>Shader里面的宏主要是通过multi_compile和shader_feature来定义。</p>
<p>PassType主要是跟光照渲染管线相关，详情参考:</p>
<p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/ScriptReference/Rendering.PassType.html">PassType</a></p>
<p>详细的区别参考:</p>
<p><a target="_blank" rel="noopener" href="https://blog.uwa4d.com/archives/USparkle_Shadervariant.html">一种Shader变体收集和打包编译优化的思路</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/68888831">Shader变体收集与打包</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/SL-MultipleProgramVariants.html">Making multiple shader program variants</a></p>
<p>对于预编译宏来说，这里我们主要要知道multi_compile会默认生成所有的变体(导致变体数激增)，而shader_feature要如何生成变体需要我们自定义(这里就引出了官方的ShaderVaraintCollection，用于控制自定义的Shader变体打包以及预加载编译等问题)</p>
<p>查看单个Shader的变体数量?</p>
<p><img src="/img/Unity/AssetBundle-Framework/ShaderVaraintNumber.png" alt="ShaderVaraintNumber"></p>
<p>查看材质用到哪些变体？</p>
<p>我们可以在编辑器模式下把材质设置成Debug模式查看使用的变体</p>
<p><img src="/img/Unity/AssetBundle-Framework/MaterialDebugInspector.png" alt="MaterialDebugInspector"></p>
<h4 id="变体搜集"><a href="#变体搜集" class="headerlink" title="变体搜集"></a>变体搜集</h4><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/OptimizingShaderLoadTime.html">ShaderVariantCollection is an asset that is basically a list of Shaders<br>, and for each of them, a list of Pass types and shader keyword combinations to load. </a></p>
<p>通过介绍，可以看出ShaderVariantCollection是一种Asset资源，这个资源记录了我们需要包含的Shader变体相关数据。</p>
<p>Edit -&gt; Project Settings -&gt; Graphics</p>
<p><img src="/img/Unity/AssetBundle-Framework/ShaderVariantAssetInspector.png" alt="ShaderVariantAssetInspector"></p>
<p>从ShaderVariantsCollection资源Asset里可以看到，里面列举了我们自定义包含的Shader变体信息。</p>
<p>通过ShaderVariantsCollection我们可以手动打开指定Shader的变体添加操作面板:</p>
<p><img src="/img/Unity/AssetBundle-Framework/ShaderVariantsChoiceDetail.png" alt="ShaderVariantsChoiceDetail"></p>
<p>从上面可以看到默认创建的ShaderVariantsCollection里的Rim Lit Bumped Specular只包含了两个变体:</p>
<p><img src="/img/Unity/AssetBundle-Framework/ShaderCustomVaraints.png" alt="ShaderCustomVaraints"></p>
<p>这里就引出了一个疑问，为什么不是前面单个Shader下显示的52个变体了？</p>
<p>这里猜测是因为Unity默认创建的ShaderVariantsCollection是经过裁剪优化的。</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://gameinstitute.qq.com/community/detail/118869">个别着色器特性，比如使用 #pragma shader_feature的着色器，如果没有材质使用到了这个特性，那么就不会把它打包进去；</a></li>
<li><a target="_blank" rel="noopener" href="https://gameinstitute.qq.com/community/detail/118869">没有被任何场景使用到的雾效(Fog)或光照贴图模式(Lightmap)的着色器变体，也不会打包进去</a></li>
</ul>
<p><strong>既然Unity会自动分析哪些变体用到了才打进ShaderVariantsCollection里，那为什么我们还是会出现打包后变体丢失了？</strong></p>
<p>前面提到了shader_feature定义的变体需要自定义是否参与打包，如果没有显示的使用，Unity自带的ShaderVariantsCollection也不会把它打包进去。</p>
<p>同时参考这篇文章:<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/68888831">Shader变体收集与打包</a></p>
<p>可以得知Shader的宏是支持控制的(e.g. Material.EnableKeyword() Shader.EnableKeyword()……)，这样一来Unity的静态分析就没有办法正确得出结论了，我想这就是为什么我们需要自行分析需要打包的变体的原因(shader_feature+宏动态控制)。</p>
<h4 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h4><p>参考这篇文章:<a target="_blank" rel="noopener" href="https://blog.csdn.net/RandomXM/article/details/88642534">对Shader Variant的研究(概念介绍、生成方式、打包策略) </a></p>
<p>Shader的搜集策略有点复杂，本人并没有完全看明白，只是结合自定义Shader和材质理解了一下Shader宏和PassType对Shader变体的影响。测试了<a target="_blank" rel="noopener" href="https://github.com/yimengfan/BDFramework.Core">BDFramework</a>里现成的Shader变体收集方案，发现跟Unity自带搜集的变体差异比较大。</p>
<p>这里只放几张简单的测试图来对比自定义Shader宏+PassType在Unity Shader变体搜集功能下和自定义的Shader变体搜集的结果。</p>
<p>自定义Shader和材质:</p>
<p><img src="/img/Unity/AssetBundle-Framework/DIYShaderList.png" alt="DIYShaderList"></p>
<p><img src="/img/Unity/AssetBundle-Framework/DIYMaterialList.png" alt="DIYMaterialList"></p>
<p>Unity自带变体搜集:</p>
<p><img src="/img/Unity/AssetBundle-Framework/UnityShaderVariantsCollection.png" alt="UnityShaderVariantsCollection"></p>
<p>自定义变体搜集:</p>
<p><img src="/img/Unity/AssetBundle-Framework/CustomShaderVariantsCollection.png" alt="CustomShaderVariantsCollection"></p>
<p>最后还是打算采用UWA上的一个方案：<a target="_blank" rel="noopener" href="https://blog.uwa4d.com/archives/USparkle_Shadervariant.html">一种Shader变体收集和打包编译优化的思路</a></p>
<p><strong>针对UWA方案还有一个疑问就是，单纯的把所有用到的材质渲染一次，能保证那些动态切换(e.g. Material.EnableKeyword() Shader.EnableKeyword())的变体被搜集到吗？毕竟Unity的ShaderVariantsCollection有裁剪策略，忘知道的朋友告知</strong></p>
<p>接下来主要是结合Profiler来查看ShaderVariantsCollection对于预编译带来的实际用处：</p>
<p>先看一下自定义搜集到的ShaderVariantsCollection变体文件信息:</p>
<p><img src="/img/Unity/AssetBundle-Framework/ShaderVariantsCollectionAsset.png" alt="ShaderVariantsCollectionAsset"></p>
<p>只加载Shader不预编译(指LoadAllAsset<Shader>)然后加载实体对象：</p>
<p><img src="/img/Unity/AssetBundle-Framework/PreloadAllShaderNoWarmUp.png" alt="PreloadAllShaderNoWarmUp"></p>
<p><img src="/img/Unity/AssetBundle-Framework/LoadActorWithoughtWarmUp.png" alt="LoadActorWithoughtWarmUp"></p>
<p><strong>从上面可以看到加载Shader但不WarmUp，等到加载实体对象时还是会触发Shader编译（CreateGPUProgram）</strong></p>
<p>不加载Shader直接预编译之后加载实体对象:</p>
<p><img src="/img/Unity/AssetBundle-Framework/WarmUpShaderWithoughtLoadShader.png" alt="WarmUpShaderWithoughtLoadShader"></p>
<p><img src="/img/Unity/AssetBundle-Framework/LoadActorAfterWarmUpShader.png" alt="LoadActorAfterWarmUpShader"></p>
<p><strong>从上面可以看出WarmUp会直接触发所有ShaderVariantsCollection里相关的Shader的预编译，等到加载实体对象时不会再有Shader编译开销(CreateGPUProgram)</strong></p>
<p>Shader变体搜集工具:</p>
<p><img src="/img/Unity/AssetBundle-Framework/ShaderVariantsCollection.png" alt="ShaderVariantsCollection"> </p>
<p>详细代码:</p>
<p><a target="_blank" rel="noopener" href="https://github.com/TonyTang1990/AssetBundleLoadManager">AssetBundleLoadManager</a></p>
<p>Tools-&gt;Assets-&gt;Asset相关处理工具</p>
<p>TODO:</p>
<p>现阶段只实现自动收集那一步，UsePass问题看起来比较复杂，暂时不考虑。具体请参考:<a target="_blank" rel="noopener" href="https://blog.uwa4d.com/archives/USparkle_Shadervariant.html">一种Shader变体收集和打包编译优化的思路</a></p>
<h3 id="Shader总结"><a href="#Shader总结" class="headerlink" title="Shader总结"></a>Shader总结</h3><ol>
<li>为了避免内置Shader带来的一些不必要问题(打包加载等问题)，建议直接把内置Shader导入到项目工程使用。</li>
<li>移动端尽量避免使用Standard Shader使用Mobile Shader替代，Standard Shader过于笨重以及变体数量庞大。</li>
<li>ShaderVariantsCollection和Shader打包到一起，一开始就加载并调用ShaderVariantsCollect:WarmUp()触发变体预编译，减少使用到Shader时实时编译的卡顿问题，触发预编译之后再加载剩余Shader Asset确保Shader都加载进来即可。</li>
<li>Shader的变体数量主要和Shader宏(multi_compile和shader_feature以及PassType有关)，multi_compile会默认生成所有相关变体，尽量使用shader_feature来实现自定义宏功能。</li>
<li>ShaderVariantsCollection主要解决的是shader_feature的变体搜集预加载问题。</li>
</ol>
<h1 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h1><h2 id="Unity-Conception-Part"><a href="#Unity-Conception-Part" class="headerlink" title="Unity Conception Part"></a>Unity Conception Part</h2><p><a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/temas/best-practices/assets-objects-and-serialization#InterObject_References">Assets, Objects and serialization</a><br><a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/topics/best-practices/guide-assetbundles-and-resources?playlist=30089">A guide to AssetBundles and Resources</a><br><a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/temas/best-practices/resources-folder">The Resources folder</a><br><a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/topics/best-practices/assetbundle-fundamentals?playlist=30089">AssetBundle fundamentals</a><br><a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/temas/best-practices/assetbundle-usage-patterns#Managing_Loaded_Assets">AssetBundle usage patterns</a></p>
<h2 id="AssetBundle-Part"><a href="#AssetBundle-Part" class="headerlink" title="AssetBundle Part"></a>AssetBundle Part</h2><p><a target="_blank" rel="noopener" href="http://liweizhaolili.blog.163.com/blog/static/162307442015282017852/">Unity5的AssetBundle的一点使用心得</a><br><a target="_blank" rel="noopener" href="http://gad.qq.com/article/detail/16006">Unity3D中Assetbundle技术使用心得</a><br><a target="_blank" rel="noopener" href="https://blog.uwa4d.com/archives/QA_ResourceManagement.html">关于Unity中的资源管理，你可能遇到这些问题</a><br><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/AssetWorkflow.html">Asset Workflow</a><br><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/BehindtheScenes.html">Behind the Scenes</a><br><a target="_blank" rel="noopener" href="http://blog.csdn.net/ring0hx/article/details/46376709">Unity5 如何做资源管理和增量更新</a><br><a target="_blank" rel="noopener" href="http://www.xuanyusong.com/archives/3618">Unity3D研究院之提取游戏资源的三个工具支持Unity5</a><br><a target="_blank" rel="noopener" href="http://www.xuanyusong.com/archives/2373">Unity3D研究院之Assetbundle的原理（六十一）</a><br><a target="_blank" rel="noopener" href="http://www.xuanyusong.com/archives/2405">Unity3D研究院之Assetbundle的实战（六十三）</a></p>
<h2 id="Texture-Compression-Part"><a href="#Texture-Compression-Part" class="headerlink" title="Texture Compression Part"></a>Texture Compression Part</h2><p><a target="_blank" rel="noopener" href="http://gad.qq.com/article/detail/25347">干货：Unity游戏开发图片纹理压缩方案</a><br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/luming1979/archive/2013/02/04/2891421.html">各种移动GPU压缩纹理的使用方法</a><br><a target="_blank" rel="noopener" href="http://imgtec.eetrend.com/blog/6912">移动设备的纹理压缩方案</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/bugrunner/article/details/50538770">几种主流贴图压缩算法的实现原理</a><br><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Adreno">Adreno</a><br><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Mali_(GPU)">Mali (GPU)</a><br><a target="_blank" rel="noopener" href="https://www.qualcomm.cn/snapdragon/gpu-specifications">Qualcomm GPU规格</a><br><a target="_blank" rel="noopener" href="https://developer.apple.com/library/archive/documentation/DeviceInformation/Reference/iOSDeviceCompatibility/HardwareGPUInformation/HardwareGPUInformation.html">IOS device Graphics Processors</a><br><a target="_blank" rel="noopener" href="https://answer.uwa4d.com/question/5ae714b00956834900752685">如何判断硬件支持GpuInstance</a><br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/zsb517/p/6297739.html">移动端纹理压缩格式</a><br><a target="_blank" rel="noopener" href="https://support.unity3d.com/hc/zh-cn/articles/207051116-%E5%A6%82%E4%BD%95%E5%9C%A8ETC1%E5%8E%8B%E7%BC%A9%E6%96%B9%E5%BC%8F%E4%B8%AD%E6%B7%BB%E5%8A%A0Alpha%E9%80%9A%E9%81%93-">如何在ETC1压缩方式中添加Alpha通道?</a></p>
<h2 id="Shadere-Part"><a href="#Shadere-Part" class="headerlink" title="Shadere Part"></a>Shadere Part</h2><p><a target="_blank" rel="noopener" href="https://www.duanyiliang.com/2018/11/21/unity/shader_load_performace/">Unity Shader加载性能消耗问题</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/e295166319/article/details/60141478">Unity3D Shader加载时机和预编译</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/68888831">Shader变体收集与打包</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/OptimizingShaderLoadTime.html">Optimizing Shader Load Time</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/SL-MultipleProgramVariants.html">Making multiple shader program variants</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.uwa4d.com/archives/USparkle_Shadervariant.html">一种Shader变体收集和打包编译优化的思路</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/RandomXM/article/details/88642534">对Shader Variant的研究(概念介绍、生成方式、打包策略) </a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/yimengfan/BDFramework.Core">BDFramework</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Resource/">Resource</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Resource/">Resource</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/08/21/经典2D小游戏/" title="经典2D小游戏" itemprop="url">经典2D小游戏</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Tony Tang" target="_blank" itemprop="author">Tony Tang</a>
		
  <p class="article-time">
    <time datetime="2016-08-21T06:50:28.000Z" itemprop="datePublished"> 发表于 2016-08-21</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>这一章节主要是为了实战学习Unity和NGUI的使用而写的。</p>
<h2 id="Game-Introduction"><a href="#Game-Introduction" class="headerlink" title="Game Introduction"></a>Game Introduction</h2><p>开发环境：<br>游戏引擎：Unity<br>UI插件：NGUI 2.7</p>
<p>游戏内容：<br>容纳多个经典2D红白机和手机游戏：</p>
<ol>
<li>2D赛车躲避(原始名字想不起来了)</li>
<li>贪吃蛇</li>
<li>坦克大战<br>待添加</li>
</ol>
<p>平台：<br>支持Android，IOS多设备。</p>
<h2 id="Preparation"><a href="#Preparation" class="headerlink" title="Preparation"></a>Preparation</h2><p>关于IOS打包准备工作参见:<br><a href="http://tonytang1990.github.io/2017/04/29/Unity%E8%87%AA%E5%8A%A8%E5%8C%96&IOS%E8%87%AA%E5%8A%A8%E5%8C%96%E7%AD%BE%E5%8C%85/#IOS%E6%89%93%E5%8C%85%E5%87%86%E5%A4%87">IOS打包准备</a></p>
<h3 id="Unity-IOS-build-process"><a href="#Unity-IOS-build-process" class="headerlink" title="Unity IOS build process"></a>Unity IOS build process</h3><ol>
<li>XCode project is generated by Unity with all the required libraries, precompiled .NET code and serialized assets.(打包所有需要的库和资源生成XCode项目)<br>第一步是通过Unity的Building Settings设定IOS平台点击Build生成</li>
<li>XCode project is built by XCode and deployed and run on the actual device.(编译Xcode项目安装到设备上)<br>第二部必须在Mac上执行(或者黑苹果)，因为需要用到IOS SDK和XCode编译器</li>
</ol>
<h3 id="Cloud-Build"><a href="#Cloud-Build" class="headerlink" title="Cloud Build"></a>Cloud Build</h3><p>关于Cloud Build让我们直接看看官网的介绍吧：<br>What is Unity Cloud Build?<br>A service that automates the build pipeline for Unity games.(自动化编译打包服务 – Build Machine)</p>
<p>Why Should I Use Cloud Build?<br>By using Cloud Build automation services, you will - Save Time. Builds are compiled and distributed automatically, minimizing manual work and intervention. Games with multiple platforms can be consolidated into a single build process.</p>
<ul>
<li>Improve Quality. Games are built continuously as changes are detected (“Continuous Integration”), enabling detection of issues as they are introduced to the project. - Distribute Faster. Cloud-based infrastructure compiles builds; in parallel if for multi platform projects. Completed builds are available to download by anyone on the team through Cloud Build’s website.(快捷方便，自动化检测变化进行编译打包。每个人都可以自己去下载安装对应的版本)</li>
</ul>
<p>How does Unity Cloud Build work?<br>Unity Cloud Build monitors your source control repository (e.g. Git, Subversion, Mercurial, Perforce). When a change is detected, a build is automatically generated by Cloud Build. When the build is completed, you and your team are notified via email. Your build is hosted by Unity for you and your team mates. If the build is not successful, you’re also notified and provided with logs to begin troubleshooting.(通过检测Git等工具上传变化，自动触发编译打包流程，完成或出错的时候有邮件提醒和log)</p>
<p>What do I need to use Unity Cloud Build?<br>使用Unity Cloud Build我们必须先选择一个版本管理器<br>Git, Subversion, Mercurial, Perforce<br>这里我使用Git。</p>
<ol>
<li>github上创建Repository</li>
<li>Clone到本地目录(git clone repo)</li>
<li>上传XCode项目<br>创建Cloud Build Project:<br><a target="_blank" rel="noopener" href="https://build.cloud.unity3d.com/">Unity Cloud Build</a></li>
<li>Create New Project</li>
<li>添加Git repository地址</li>
<li>选择platform(这里我选的IOS)</li>
<li>最后设置项目打包发布相关的Certificate，bundle ID， Xcode版本设置等(注意Provision Profile里的Certificate和我们导出上传的Certificate要一致)，后续还有一堆关于Build的控制(比如定义宏，编译Development版本)<br>这样一来就可以通过访问<a target="_blank" rel="noopener" href="https://build.cloud.unity3d.com/">Unity Cloud Build</a>去查看自动化打包编译的详细情况了。<br><img src="/img/Unity/UnityCloudBuild.PNG" alt="UnityCloudBuild"><br>这样一来每一次提交Git后只需在Cloud Build点击build就会触发更新编译打包了。<br>如果打包没有错误的话，我们只需去Cloud Buid上取打包好的包安装即可。</li>
</ol>
<h3 id="UI库选择"><a href="#UI库选择" class="headerlink" title="UI库选择"></a>UI库选择</h3><p>在Unity 4.6以后UI主要是有两种选择：</p>
<ol>
<li>UGUI(Unity 自带UI)</li>
<li>NGUI(成熟的第三方UI插件)<br>这里处于学习NGUI目的，我选择采用NGUI 2.7版本作为UI库。</li>
</ol>
<h2 id="游戏实战开发"><a href="#游戏实战开发" class="headerlink" title="游戏实战开发"></a>游戏实战开发</h2><h3 id="赛车躲避"><a href="#赛车躲避" class="headerlink" title="赛车躲避"></a>赛车躲避</h3><h4 id="游戏说明"><a href="#游戏说明" class="headerlink" title="游戏说明"></a>游戏说明</h4><p>这是一款在2D竖版的赛车躲避类游戏，场景里有三条道可供行驶，玩家操控当前赛车(上下左右移动以及跳跃来躲避迎面而来的赛车)来回在三条道之间切换以躲避随机从三条道上出现的赛车，每躲过一个赛车就会增加得分，赛车移动游戏速度会随着游戏的进行越来越快已达到更快速度，最终躲避最多赛车得分最高者创造新纪录。</p>
<p>操控：<br>上下左右移动，圆形按钮跳跃(通过单独制作的控制面板，通过点击对应按钮响应)</p>
<h4 id="相关概念学习"><a href="#相关概念学习" class="headerlink" title="相关概念学习"></a>相关概念学习</h4><p>首先作为2D游戏，这里要讲一下Project 2D Mode和Editor 2D Mode这两个概念。<br>Project 2D Mode：<br>Project 2D Mode会去决定Unity Editor的一些设置。<br><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/2DAnd3DModeSettings.html">Unity Editor Settings influence by mode settings</a><br>下列以官网将的2D Mode为例，看看分别会影响些什么？</p>
<ol>
<li>Any images you import are assumed to be 2D images (Sprites) and set to Sprite mode.(2D模式下默认导入的图片都是2D Sprite而不是Texture)</li>
<li>The Sprite Packer is enabled.(Sprite Packer默认开启，Sprite Packager是为了高效的渲染并节约内存，用于打包图集(Atlas)的工具)</li>
<li>The Scene View is set to 2D.(默认设置Scene view为2D mode，当然也可以切到Scene 3D mode)</li>
<li>The default game objects do not have real time, directional light.(默认不创建方向光)</li>
<li>The camera’s default position is at 0,0,–10. (It is 0,1,–10 in 3D Mode.)(Camera默认位置0,0,-10)</li>
<li>The camera is set to be Orthographic. (In 3D Mode it is Perspective.)(Camera默认是Orthographic(正交)投影)</li>
<li>Skybox is disabled for new scenes.(天空盒默认disable)</li>
<li>Ambient Source is set to Color. (With the color set as a dark grey: RGB: 54, 58, 66.)(环境光默认设置为54,58,66)</li>
<li>Precomputed Realtime GI is set to off.(预计算的全局光默认关闭)</li>
<li>Baked GI is set to off.(烘焙全局观默认关闭)</li>
<li>Lighting Auto-Building set to off.(光照的自动编译默认关闭)<br>Editor 2D Mode：<br>Editor 2D Mode只是决定了Scene窗口是以2D还是3D的形式显示。<br>从上面可以看出Project的2D Mode会帮助我们设置一些对于2D游戏不需要或重要的设定，帮助我们快速开发2D游戏。</li>
</ol>
<p>在2D游戏里，有个很重要的概念就是Sprite：<br>Sprite – Sprites are 2D Graphic objects.<br>提到Sprite就不得不提Sprite制作，优化相关的工具和一些相关的重要概念：</p>
<ol>
<li>Sprite Editor<br>主要用于指明Sprite的一些重要属性，比如：<br>Texture Type – 指明纹理类型(Sprite 2D)<br>Sprite Mode – 指明这个Sprite是单独显示还是和其他Sprite一起显示(有利于Texture Packer去做图集的切割)<br>Packing Tag – 指明Sprite所在图集<br>…….</li>
<li>Sprite Creator<br>Unity提供的创建临时的sprite placeholder.(后期替换成我们想要的Sprite)<br>也可以帮助我们去切割包含多个Sprite的图片到多个单独的Sprite(前提是包含多个Sprite的图片Sprite Mode要设置成Multiple。通过设置Slice或者Grid方式，可以快速帮助我们切割包含多个图片的Sprite)<br><img src="/img/Unity/SpriteEditor.PNG" alt="SpriteEditor"></li>
<li>Sprite Packer<br>Unity提供的自动制作图集(Atlas)的工具，为了节约内存高效渲染，把多个Sprite打包到一个大的纹理图片里，然后通过记录对应的UV信息去访问，这样只需加载一张纹理图片就能去渲染多个Sprite。<br>Edit -&gt; Project Settings -&gt; Editor -&gt; Sprite Packer Mode</li>
<li>Sprite Renderer<br>这里需要区别一下Sprite Renderer和Mesh Renderer。<br>Sprite Renderer是以2D Sprite作为输入通过Color，Material等属性去渲染出最终颜色。(默认的Sprite-Default Material是不计算光照的，因为2D游戏一般不考虑光照，当然我们也可用其他的Material去计算光照的影响)<br>Mesh Renderer是以geometry from the Mesh Filter(模型数据)作为输入通过Material和光照方面的设置渲染出最终颜色。<br>Sprite Renderer里值得一提的是Layer，因为2D游戏里没有深度的概念，所以通过Layer和Layer Order去决定Sprite的渲染顺序，同时Layer属性也被Camera和Ray Cast用作过滤的条件之一。(我们可以自定义Layer且设定Layer所处顺序(Edit -&gt; Project Setting -&gt; Tags and Layers)，然后通过设定Sprite在Layer里的Layer Order去决定在同一Layer里的顺序)<br><img src="/img/Unity/TagsAndLayers.PNG" alt="TagsAndLayers"></li>
</ol>
<h4 id="游戏制作过程"><a href="#游戏制作过程" class="headerlink" title="游戏制作过程"></a>游戏制作过程</h4><h5 id="Project-Mode选择"><a href="#Project-Mode选择" class="headerlink" title="Project Mode选择"></a>Project Mode选择</h5><p>通过上面概念学习，我们知道了设置Project Mode 2D会帮助我们快速开发2D游戏，所以这里我们选择2D Mode。<br>Edit-&gt;Project Settings-&gt;Editor-&gt;Default Behavior Mode -&gt; 2D<br>然后再创建我们的CarDodge Scene:<br>File -&gt; New Scene</p>
<h5 id="美术图片分辨率选择"><a href="#美术图片分辨率选择" class="headerlink" title="美术图片分辨率选择"></a>美术图片分辨率选择</h5><p>每个游戏制作都需要指定美术图片大小标准。<br>考虑到不同屏幕分辨率适应的问题，结合<a href="http://tonytang1990.github.io/2015/07/15/Unity-Study/#IL2CPP">Unity Study里NGUI 2.7屏幕自适应的学习</a>，我选择了1024*768也就是4:3的比例作为标准，这样一来在高分辨率的机器上(大部分主流机器都高于4:3)，只是两边会多显示一部分而不至于背景或游戏场景被裁减，多出来的一部分我们可以把背景放大来覆盖。(作为2D竖版游戏这样是完全可以接受的)<br>为了使我们的Sprite的像素完美显示在屏幕上(1个Sprite像素对应屏幕的一个pixel)，要做到这一点我们只需保证Screen.height&#x2F;2&#x2F;Size &#x3D; PPU(Pixel Per Unit)即可，所以因为我们设定Sprite的100 Pixel对应一个Unit，Size &#x3D; 768&#x2F;2&#x2F;100 &#x3D; 3.84，所以我们把Orthographic Camera的Size设置为3.84，这样一来Sprite的像素就和屏幕意义对应了。</p>
<h5 id="游戏背景循环移动实现方式选择"><a href="#游戏背景循环移动实现方式选择" class="headerlink" title="游戏背景循环移动实现方式选择"></a>游戏背景循环移动实现方式选择</h5><p>通过官网<a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/topics/2d-game-creation/2d-scrolling-backgrounds?playlist=17093">2D Scrolling Backgrounds</a>的学习，了解到有下列两种方式可以实现背景循环移动。</p>
<ol>
<li>用一张Sprite作为背景，通过动态计算(循环)transform.position的值去实现背景移动。<br>这种方式的缺点是多分辨率适应问题，且当我们循环的时候，Sprite明显衔接不对，出现画面跳动。</li>
<li>设置3D Quad，添加Material去控制显示，通过动态控制(循环texture offset)Texture的显示实现背景移动。<br>这种方式的好处是可以通过Tile Texture和设置Offset实现不拉伸背景实现铺满屏幕的效果。<br>第一种方式游戏体验明显不行，所以这里我们采取第二种方式实现背景循环滚动。(这里使用的是Texture而非Sprite)<br>OffsetScroller.cs</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">OffsetScroller</span> : <span class="title">MonoBehaviour</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">float</span> mScrollSpeed = <span class="number">0.2f</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Vector2 mStartOffset;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> MeshRenderer mBackgroundMeshRender;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Awake</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mBackgroundMeshRender = gameObject.GetComponent&lt;MeshRenderer&gt;();</span><br><span class="line">        <span class="keyword">if</span>(mBackgroundMeshRender != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            mStartOffset = mBackgroundMeshRender.material.mainTextureOffset;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Update is called once per frame</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Update</span> ()</span> &#123;</span><br><span class="line">        <span class="built_in">float</span> y = Mathf.Repeat(Time.time * mScrollSpeed, <span class="number">1</span>);</span><br><span class="line">        Vector2 offset = <span class="keyword">new</span> Vector2(<span class="number">0.0f</span>, y);</span><br><span class="line">        <span class="keyword">if</span>(mBackgroundMeshRender != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            mBackgroundMeshRender.material.mainTextureOffset = offset;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            Debug.Log(<span class="string">&quot;This script only works with Gameobject that contains MeshRenderer and Material.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">OnDisable</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(mBackgroundMeshRender != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            mBackgroundMeshRender.material.mainTextureOffset = mStartOffset;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/img/Unity/OffsetScrollBackground.PNG" alt="OffsetScrollBackground"><br>上述代码实现了通过根据时间和设定的速度来调整Background Material的Offset值实现背景循环滚动效果。</p>
<h5 id="游戏控制方式选择"><a href="#游戏控制方式选择" class="headerlink" title="游戏控制方式选择"></a>游戏控制方式选择</h5><p>Assets Store有一些付费的成熟控制插件，但考虑到控制上没太大的需求(上下左右和个别按钮即可)，这里选择自己制作。(提供上下左右和一个单独的按钮交互界面)<br><img src="/img/Unity/InputPanelHierachy.PNG" alt="InputPanelHierachy"><br><img src="/img/Unity/InputPanelUI.PNG" alt="InputPanelUI"><br>我在Panel上挂载了UIAnchor和InputControlerManager脚本，前者用于在场景里设置位置，后者是我自己写来用于通过单一接口去传递相应回调。<br>InputControllerManager.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">InputControllerManager</span> : <span class="title">MonoBehaviour</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> InputControllerManager mInputControllerManager = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> GameObject mControlButton;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> GameObject mLeftButton;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> GameObject mRightButton;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> GameObject mUpButton;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> GameObject mDownButton;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> UIEventListener mControlButtonUIEL;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> UIEventListener mLeftButtonUIEL;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> UIEventListener mRightButtonUIEL;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> UIEventListener mUpButtonUIEL;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> UIEventListener mDownButtonUIEL;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">InputControllerManager</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Awake</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(mInputControllerManager == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            mInputControllerManager = <span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (mInputControllerManager != <span class="keyword">this</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Destroy(mInputControllerManager);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Start</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (mControlButton != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            mControlButtonUIEL = mControlButton.GetComponent&lt;UIEventListener&gt;();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mLeftButton != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            mLeftButtonUIEL = mLeftButton.GetComponent&lt;UIEventListener&gt;();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mRightButton != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            mRightButtonUIEL = mRightButton.GetComponent&lt;UIEventListener&gt;();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mUpButton != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            mUpButtonUIEL = mUpButton.GetComponent&lt;UIEventListener&gt;();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mDownButton != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            mDownButtonUIEL = mDownButton.GetComponent&lt;UIEventListener&gt;();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ControlButtonClickDelegate</span>(<span class="params">UIEventListener.VoidDelegate oncontrolbuttonclick</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (mControlButtonUIEL != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            mControlButtonUIEL.onClick = oncontrolbuttonclick;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ControlButtonOnPressDelegat</span>(<span class="params">UIEventListener.BoolDelegate oncontrolbuttononpress</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (mControlButtonUIEL != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            mControlButtonUIEL.onPress = oncontrolbuttononpress;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">LeftButtonClickDelegate</span>(<span class="params">UIEventListener.VoidDelegate onleftbuttonclick</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (mLeftButtonUIEL != <span class="literal">null</span>)</span><br><span class="line">        &#123; </span><br><span class="line">            mLeftButtonUIEL.onClick = onleftbuttonclick;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">LeftButtonOnPressDelegat</span>(<span class="params">UIEventListener.BoolDelegate onleftbuttononpress</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(mLeftButtonUIEL != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            mLeftButtonUIEL.onPress = onleftbuttononpress;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">RightButtonClickDelegate</span>(<span class="params">UIEventListener.VoidDelegate onrightbuttonclick</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(mRightButtonUIEL != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            mRightButtonUIEL.onClick = onrightbuttonclick;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">RightButtonOnPressDelegat</span>(<span class="params">UIEventListener.BoolDelegate onrightbuttononpress</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (mRightButtonUIEL != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            mRightButtonUIEL.onPress = onrightbuttononpress;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">UpButtonClickDelegate</span>(<span class="params">UIEventListener.VoidDelegate onupbuttonclick</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(mUpButtonUIEL != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            mUpButtonUIEL.onClick = onupbuttonclick;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">UpButtonOnPressDelegat</span>(<span class="params">UIEventListener.BoolDelegate onupbuttononpress</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (mUpButtonUIEL != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            mUpButtonUIEL.onPress = onupbuttononpress;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">DownButtonClickDelegate</span>(<span class="params">UIEventListener.VoidDelegate ondownbuttonclick</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(mDownButtonUIEL != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            mDownButtonUIEL.onClick = ondownbuttonclick;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">DownButtonOnPressDelegat</span>(<span class="params">UIEventListener.BoolDelegate ondownbuttononpress</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (mDownButtonUIEL != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            mDownButtonUIEL.onPress = ondownbuttononpress;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后把做好的InputPanel作为Prefab存起来。上述代码只提供了按钮的OnClick和OnPress回调设置。<br>当前游戏界面如下：<br><img src="/img/Unity/InputControlWithScrollBackground.PNG" alt="InputControlWithScrollBackground"><br>游戏完成时只会有三条道会显示，但玩家需要移动8次来实现从最左边移动到最右边，这里显示九条是为了方便确认位置。</p>
<h5 id="可视化重要信息"><a href="#可视化重要信息" class="headerlink" title="可视化重要信息"></a>可视化重要信息</h5><p>这里主要是为了可视化的看出我们在制作游戏的过程中是否用了一些导致性能或内存消耗很高的方法。<br>关于性能消耗：<br>我们采用在<a href="http://tonytang1990.github.io/2016/03/13/Unity-COC-Study/#Optimization">Unity_COC_Study</a>里打印FPS的方式来可视化。<br>关于内存消耗：<br>之前使用过Memroy Profiler，很直观的显示了各方面的内存消耗和运行时间，性能消耗也能在这里看的一清二楚。<br>这里为了不每次都链接电脑开Memory Profiler，我采用打印FPS的方式查看性能上的消耗。<br>FPSDisplay.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> UnityEngine.UI;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">FPSDisplay</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> UILabel mFPSText;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="built_in">float</span> mDeltaTime = <span class="number">0.0f</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="built_in">float</span> mFPS = <span class="number">0.0f</span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Update</span>()</span></span><br><span class="line">	&#123;</span><br><span class="line">		mDeltaTime += (Time.deltaTime - mDeltaTime) * <span class="number">0.1f</span>;</span><br><span class="line">		<span class="built_in">float</span> msec = mDeltaTime * <span class="number">1000.0f</span>;</span><br><span class="line">		mFPS = <span class="number">1.0f</span> / mDeltaTime;</span><br><span class="line">		mFPSText.text = <span class="built_in">string</span>.Format(<span class="string">&quot;&#123;0:0.0&#125; ms (&#123;1:0.&#125; fps)&quot;</span>, msec, mFPS);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/img/Unity/FPSDisplay.PNG" alt="FPSDisplay"></p>
<h5 id="2D动画抉择"><a href="#2D动画抉择" class="headerlink" title="2D动画抉择"></a>2D动画抉择</h5><p>一个游戏如果都是静态的图片移动，那么看起来肯定很无聊。<br>所以这里我们必须知道如何去制作动画。<br>首先我们确定的是我们使用的是2D Sprite，那么这里就确定了我们需要制作Sprite Animation。<br>在执着2D Sprite Animation之前，我们需要了解一些重要的概念：</p>
<ol>
<li>Animation – 基于关键帧的动画</li>
<li>Animation Controller — 动画管理，通过给物体添加Animator并设定动画状态机之间的切换规则来实现动画状态切换管理(通过给UI添加Animator我们也可以在Anmation面板设置简单动画)<br>接下来看看制作2D Animation步骤：<br>这里由于我下载的资源都只有一整张赛车的Sprite，见下图:<br><img src="/img/Unity/PlayerCarSprite.PNG" alt="PlayerCarSprite"><br>因为原始图片是463*1010的，对于我们来说像素太大了，需要缩小，所以我首先通过PS把图片缩小。<br>如果要想做更细致的动画，比如控车里的人做动画，轮子转弯的时候做动画，那么我就需要制作多张关键帧的Sprite。<br>关键帧图片制作(下面只列举最后一帧，就不多放图片了这里)：<br><img src="/img/Unity/PlayerCarTurnLeft4.png" alt="PlayerCarTurnLeft4"><br><img src="/img/Unity/PlayerCarTurnRight4.png" alt="PlayerCarTurnRight4"><br>接下来我们把制作好的关键帧图片导入Unity作为2D Sprite。<br>然后在Animation面板创建并制作Turn Right，Turn Left，Normal和Crash四种动画。<br><img src="/img/Unity/NormalAnimation.PNG" alt="NormalAnimation"><br><img src="/img/Unity/TurnLeftAnimation.PNG" alt="TurnLeftAnimation"><br><img src="/img/Unity/TurnRightAnimation.PNG" alt="TurnRightAnimation"><br><img src="/img/Unity/CrashAnimator.PNG" alt="CrashAnimator"><br>动画制作完成后，我们需要通过Animation Controller去控制四个动画之间的状态转换规则(Unity里可视化的状态机)。(除了默认的Sprite创建的动画，我们还可以在Aniamtor里通过修改scale，position等属性制作帧动画)<br>首先在Animation Controller里我的赛车有四中状态，Normal，TurnRight，TurnLeft，Crash：<br><img src="/img/Unity/AnimationController.PNG" alt="AnimationController"><br>设置了四种状态之间的转换后，我们需要添加转换条件，添加转换条件，需要通过Animator-&gt;Parameters面板添加，这里我添加了四个trigger类型的条件变量(Trigger的设置只会触发一次状态)：<br><img src="/img/Unity/AnimatorParameters.PNG" alt="AnimatorParameters"><br>创建了状态切换条件后我们需要在状态切换的条件那里设置触发条件：<br>首先选中特定状态切换的带三尖角的线，然后在Inspector设置触发条件和一些状态转换之间的设置，见下图：<br><img src="/img/Unity/StateTranslationConditionSetting.PNG" alt="StateTranslationConditionSetting"><br>这样一来我们在代码里只需获取特定对象身上的Animator，然后调用Animator.SetTrigger(“IsTurningNormal”)就能触发到Normal的状态切换了，同时触发动画效果。</li>
</ol>
<p>除了Unity自带的帧动画，我们还可以通过Animation插件去实现一些动画效果。<br>让我们来看看下面DOTween官网对于各个Tween插件的比较<a target="_blank" rel="noopener" href="http://dotween.demigiant.com/#enginesComparison">Comparison with other engines</a>。<br>因为我一个都没有用过，就直接按上面的理论使用方便快速的DOTween作为这一次学习使用的对象。<br>具体的DOTween学习参见<a href="http://tonytang1990.github.io/2015/07/15/Unity-Study/#2D-ROGUELIKE-TUTORIAL">Unity_Study_Plugins_DOTween</a></p>
<p>这样一来车子的左右平滑移动和Jump动画效果就通过DOTween实现了。<br>而车子的上下移动结合Coroutine来实现(使用Coroutine的好处是可以实现避免每帧都判断是否需要向上或向下移动)。<br>具体代码如下：<br>PlayerCarController.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> DG.Tweening;</span><br><span class="line"><span class="keyword">using</span> UnityEngine.SceneManagement;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PlayerCarController</span> : <span class="title">MonoBehaviour</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">float</span> mMoveTweenTime = <span class="number">0.3f</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">float</span> mIntervalTimeToKeepMovingUPOrDown = <span class="number">0.025f</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Vector3 mHorizontalOffset = <span class="keyword">new</span> Vector3(<span class="number">0.9f</span>, <span class="number">0.0f</span>, <span class="number">0.0f</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Vector3 mVerticalOffset = <span class="keyword">new</span> Vector3(<span class="number">0.0f</span>, <span class="number">0.08f</span>, <span class="number">0.0f</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> LayerMask mBolockingLayer;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">const</span> <span class="built_in">int</span> mLimitTopDownMoving = <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Vector3 mTargetPosition;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">bool</span> mIsTweenComplete = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">bool</span> mIsJumpComplete = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">bool</span> mIsKeepMovingUp = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">bool</span> mIsKeepMovingDown = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">bool</span> mUpdateJumpAnimationLater = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Animator mPlayerCarAnimator;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">bool</span> mIsCrash = <span class="literal">false</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//Jump tween</span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">float</span> mJumpDuration = <span class="number">0.4f</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">float</span> mOriginalJumpDuration;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Vector3 mJumpEndScale = <span class="keyword">new</span> Vector3(<span class="number">0.6f</span>, <span class="number">0.6f</span>, <span class="number">1.0f</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Vector3 mOriginalScale;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Sequence mJumpSequence;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Box2D</span></span><br><span class="line">    <span class="keyword">private</span> BoxCollider2D mPlayerCarBox2D;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Awake</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mTargetPosition = gameObject.transform.position;</span><br><span class="line"></span><br><span class="line">        mPlayerCarAnimator = gameObject.GetComponent&lt;Animator&gt;();</span><br><span class="line"></span><br><span class="line">        mOriginalScale = transform.localScale;</span><br><span class="line"></span><br><span class="line">        mPlayerCarBox2D = gameObject.GetComponent&lt;BoxCollider2D&gt;();</span><br><span class="line"></span><br><span class="line">        mOriginalJumpDuration = mJumpDuration;</span><br><span class="line"></span><br><span class="line">        mJumpSequence =  DOTween.Sequence();</span><br><span class="line"></span><br><span class="line">        mJumpSequence.Append(transform.DOScale(mJumpEndScale, mJumpDuration));</span><br><span class="line">        mJumpSequence.Append(transform.DOScale(mOriginalScale, mJumpDuration));</span><br><span class="line">        mJumpSequence.SetAutoKill(<span class="literal">false</span>);</span><br><span class="line">        mJumpSequence.OnComplete(OnJumpComplete);</span><br><span class="line">        mJumpSequence.Pause();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Use this for initialization</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Start</span> ()</span> &#123;</span><br><span class="line">        InputControllerManager.mInputControllerManager.RightButtonClickDelegate(MoveRight);</span><br><span class="line">        InputControllerManager.mInputControllerManager.LeftButtonClickDelegate(MoveLeft);</span><br><span class="line">        InputControllerManager.mInputControllerManager.UpButtonClickDelegate(MoveUp);</span><br><span class="line">        InputControllerManager.mInputControllerManager.UpButtonOnPressDelegat(KeepMoveUp);</span><br><span class="line">        InputControllerManager.mInputControllerManager.DownButtonClickDelegate(MoveDown);</span><br><span class="line">        InputControllerManager.mInputControllerManager.DownButtonOnPressDelegat(KeepMoveDown);</span><br><span class="line">        InputControllerManager.mInputControllerManager.ControlButtonClickDelegate(Jump);</span><br><span class="line"></span><br><span class="line">        StartCoroutine(MoveUpCoroutine());</span><br><span class="line">        StartCoroutine(MoveDownCoroutine());</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// Update is called once per frame</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Update</span> ()</span> &#123;</span><br><span class="line">	</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">MoveRight</span>(<span class="params">GameObject go</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (mIsTweenComplete == <span class="literal">true</span> &amp;&amp; mIsCrash == <span class="literal">false</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Vector2 start = <span class="keyword">new</span> Vector2(transform.position.x, transform.position.y);</span><br><span class="line">            mTargetPosition = transform.position + mHorizontalOffset;</span><br><span class="line">            Vector2 end = <span class="keyword">new</span> Vector2(mTargetPosition.x, mTargetPosition.y);</span><br><span class="line">            RaycastHit2D hit = Physics2D.Linecast(start, end, mBolockingLayer);</span><br><span class="line">            <span class="keyword">if</span>(hit.transform == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (mPlayerCarAnimator != <span class="literal">null</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    mPlayerCarAnimator.SetTrigger(<span class="string">&quot;IsTurningRight&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                mIsTweenComplete = <span class="literal">false</span>;</span><br><span class="line">                transform.DOMove(mTargetPosition, mMoveTweenTime).OnComplete(OnTweenComplete);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">MoveLeft</span>(<span class="params">GameObject go</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (mIsTweenComplete == <span class="literal">true</span> &amp;&amp; mIsCrash == <span class="literal">false</span>) </span><br><span class="line">        &#123;</span><br><span class="line">            Vector2 start = <span class="keyword">new</span> Vector2(transform.position.x, transform.position.y);</span><br><span class="line">            mTargetPosition = transform.position - mHorizontalOffset;</span><br><span class="line">            Vector2 end = <span class="keyword">new</span> Vector2(mTargetPosition.x, mTargetPosition.y);</span><br><span class="line">            RaycastHit2D hit = Physics2D.Linecast(start, end, mBolockingLayer);</span><br><span class="line">            <span class="keyword">if</span> (hit.transform == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (mPlayerCarAnimator != <span class="literal">null</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    mPlayerCarAnimator.SetTrigger(<span class="string">&quot;IsTurningLeft&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                mIsTweenComplete = <span class="literal">false</span>;</span><br><span class="line">                mTargetPosition = transform.position - mHorizontalOffset;</span><br><span class="line">                transform.DOMove(mTargetPosition, mMoveTweenTime).OnComplete(OnTweenComplete);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">MoveUp</span>(<span class="params">GameObject go</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">    </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">KeepMoveUp</span>(<span class="params">GameObject go, <span class="built_in">bool</span> state</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(state)</span><br><span class="line">        &#123;</span><br><span class="line">            mIsKeepMovingUp = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            mIsKeepMovingUp = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">IEnumerator <span class="title">MoveUpCoroutine</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (mIsKeepMovingUp &amp;&amp; mIsCrash == <span class="literal">false</span> &amp;&amp; mIsJumpComplete == <span class="literal">true</span>)</span><br><span class="line">            &#123;  </span><br><span class="line">                Vector2 start = <span class="keyword">new</span> Vector2(transform.position.x, transform.position.y);</span><br><span class="line">                mTargetPosition = transform.position + mVerticalOffset * mLimitTopDownMoving;</span><br><span class="line">                Vector2 end = <span class="keyword">new</span> Vector2(mTargetPosition.x, mTargetPosition.y);</span><br><span class="line">                RaycastHit2D hit = Physics2D.Linecast(start, end, mBolockingLayer);</span><br><span class="line">                <span class="keyword">if</span> (hit.transform == <span class="literal">null</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    mTargetPosition = transform.position + mVerticalOffset;</span><br><span class="line">                    transform.position = mTargetPosition;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="function"><span class="keyword">yield</span> <span class="keyword">return</span> <span class="keyword">new</span> <span class="title">WaitForSeconds</span>(<span class="params">mIntervalTimeToKeepMovingUPOrDown</span>)</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">MoveDown</span>(<span class="params">GameObject go</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">    </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">KeepMoveDown</span>(<span class="params">GameObject go, <span class="built_in">bool</span> state</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (state)</span><br><span class="line">        &#123;</span><br><span class="line">            mIsKeepMovingDown = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            mIsKeepMovingDown = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">IEnumerator <span class="title">MoveDownCoroutine</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (mIsKeepMovingDown &amp;&amp; mIsCrash == <span class="literal">false</span> &amp;&amp; mIsJumpComplete == <span class="literal">true</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                Vector2 start = <span class="keyword">new</span> Vector2(transform.position.x, transform.position.y);</span><br><span class="line">                mTargetPosition = transform.position - mVerticalOffset * mLimitTopDownMoving;</span><br><span class="line">                Vector2 end = <span class="keyword">new</span> Vector2(mTargetPosition.x, mTargetPosition.y);</span><br><span class="line">                RaycastHit2D hit = Physics2D.Linecast(start, end, mBolockingLayer);</span><br><span class="line">                <span class="keyword">if</span> (hit.transform == <span class="literal">null</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    mTargetPosition = transform.position - mVerticalOffset;</span><br><span class="line">                    transform.position = mTargetPosition;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="function"><span class="keyword">yield</span> <span class="keyword">return</span> <span class="keyword">new</span> <span class="title">WaitForSeconds</span>(<span class="params">mIntervalTimeToKeepMovingUPOrDown</span>)</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Jump</span>(<span class="params">GameObject go</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (mIsJumpComplete == <span class="literal">true</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            mIsJumpComplete = <span class="literal">false</span>;</span><br><span class="line">            mPlayerCarBox2D.enabled = <span class="literal">false</span>;</span><br><span class="line">            mJumpSequence.Restart();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">CrashCallBack</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        SceneManager.LoadScene(<span class="string">&quot;Game&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">OnTriggerEnter2D</span>(<span class="params">Collider2D collision</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(collision.tag == <span class="string">&quot;EnemyCar&quot;</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.Log(<span class="built_in">string</span>.Format(<span class="string">&quot;Collision with EnemyCar.name &#123;0&#125;&quot;</span>,collision.name));</span><br><span class="line">            mIsCrash = <span class="literal">true</span>;</span><br><span class="line">            mPlayerCarAnimator.SetTrigger(<span class="string">&quot;IsCrash&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">OnTriggerExit2D</span>(<span class="params">Collider2D collision</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (collision.tag == <span class="string">&quot;EnemyCar&quot;</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.Log(<span class="built_in">string</span>.Format(<span class="string">&quot;Collision with EnemyCar.name &#123;0&#125;&quot;</span>, collision.name));</span><br><span class="line">            mIsCrash = <span class="literal">true</span>;</span><br><span class="line">            mPlayerCarAnimator.SetTrigger(<span class="string">&quot;IsCrash&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnTweenComplete</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mIsTweenComplete = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">if</span>(mIsCrash == <span class="literal">false</span>)</span><br><span class="line">        &#123; </span><br><span class="line">            mPlayerCarAnimator.SetTrigger(<span class="string">&quot;IsTurningNormal&quot;</span>);</span><br><span class="line">        &#125; </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnJumpComplete</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mIsJumpComplete = <span class="literal">true</span>;</span><br><span class="line">        mPlayerCarBox2D.enabled = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">if</span>(mUpdateJumpAnimationLater)</span><br><span class="line">        &#123;</span><br><span class="line">            mUpdateJumpAnimationLater = <span class="literal">false</span>;</span><br><span class="line">            UpdateJumpAnimation();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">UpdateJumpAnimation</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (mIsJumpComplete == <span class="literal">false</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            mUpdateJumpAnimationLater = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">        	<span class="comment">//Reset Sequence to adjust tween&#x27;s duration</span></span><br><span class="line">            mJumpSequence.Kill(<span class="literal">true</span>);</span><br><span class="line">            mJumpSequence = DOTween.Sequence();</span><br><span class="line">            mJumpDuration = mOriginalJumpDuration - CarDodgeGame.mCarDodgeGameInstance.GameLevel / <span class="number">15.0f</span>;</span><br><span class="line">            Debug.Log(<span class="string">&quot;mJumpDuration = &quot;</span> + mJumpDuration);</span><br><span class="line">            mJumpSequence.Append(transform.DOScale(mJumpEndScale, mJumpDuration));</span><br><span class="line">            mJumpSequence.Append(transform.DOScale(mOriginalScale, mJumpDuration));</span><br><span class="line">            mJumpSequence.SetAutoKill(<span class="literal">false</span>);</span><br><span class="line">            mJumpSequence.OnComplete(OnJumpComplete);</span><br><span class="line">            mJumpSequence.Pause();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过调节给出的public变量，可控制movetween的duration时间和coroutine的执行时间间隔，还有垂直和水平方向的移动位移等。</p>
<h5 id="游戏内GameObject数量的思考"><a href="#游戏内GameObject数量的思考" class="headerlink" title="游戏内GameObject数量的思考"></a>游戏内GameObject数量的思考</h5><p>因为2D赛车躲避小游戏同一时间不会有太多的GameObject处于场景里，通过<a href="http://tonytang1990.github.io/2016/03/13/Unity-COC-Study/#Optimization">Unity_COC_Study</a>的学习，我知道了我们可以通过Object Pool的方式来预创建一定数量的GameObject，然后在适当的时机active or deactive他们来减少Instantiate的调用，即节约内存又性能损耗低。<br>ObjectPoolManager .cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ObjectPoolManager</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ObjectPoolManager mObjectPoolManagerInstance = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> GameObject[] mEnemyCar;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> mAmountForEachEnemyCar = <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;List&lt;GameObject&gt;&gt; mEnemyCarTwoDimensionList;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">bool</span> mWillGrow = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Awake</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (mObjectPoolManagerInstance == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            mObjectPoolManagerInstance = <span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (mObjectPoolManagerInstance != <span class="keyword">this</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Destroy(gameObject);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Start</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mEnemyCarTwoDimensionList = <span class="keyword">new</span> List&lt;List&lt;GameObject&gt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; mEnemyCar.Length; i++)</span><br><span class="line">        &#123; </span><br><span class="line">            List&lt;GameObject&gt; enemycarlist = <span class="keyword">new</span> List&lt;GameObject&gt;(mAmountForEachEnemyCar);</span><br><span class="line">            <span class="keyword">for</span>(<span class="built_in">int</span> j = <span class="number">0</span>; j &lt; mAmountForEachEnemyCar; j++)</span><br><span class="line">            &#123;</span><br><span class="line">                GameObject enemycarobj = Instantiate(mEnemyCar[i]) <span class="keyword">as</span> GameObject;</span><br><span class="line">                enemycarobj.SetActive(<span class="literal">false</span>);</span><br><span class="line">                enemycarlist.Add(enemycarobj);</span><br><span class="line">            &#125;</span><br><span class="line">            mEnemyCarTwoDimensionList.Add(enemycarlist);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> GameObject <span class="title">GetEnemyCarObject</span>(<span class="params"><span class="built_in">int</span> carindex</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; mEnemyCarTwoDimensionList[carindex].Count; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (!mEnemyCarTwoDimensionList[carindex][i].activeInHierarchy)</span><br><span class="line">            &#123;</span><br><span class="line">                mEnemyCarTwoDimensionList[carindex][i].SetActive(<span class="literal">true</span>);</span><br><span class="line">                <span class="keyword">return</span> mEnemyCarTwoDimensionList[carindex][i];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mWillGrow)</span><br><span class="line">        &#123;</span><br><span class="line">            GameObject enemycar = Instantiate(mEnemyCar[carindex]) <span class="keyword">as</span> GameObject;</span><br><span class="line">            mEnemyCarTwoDimensionList[carindex].Add(enemycar);</span><br><span class="line">            <span class="keyword">return</span> enemycar;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上述代码写的比较死，是针对CarDodge这个游戏而言，因为有多种车子，所以用到了List&lt;List<GameObject>&gt;这样的双重List来存储对应车子所与生成的GameObject。</p>
<p>最终游戏截图(大部分游戏UI素材选至COC)：<br><img src="/img/Unity/LoginUI.PNG" alt="LoginUI"><br>出于是学习使用旧版的NGUI，所以上述UI并没有实际的账号注册检查，只实现了简单的输入文字要求和账号对错(账号暂时是硬代码写的，PC上是通过读取Excel(使用的是ExcelReader，参考<a target="_blank" rel="noopener" href="http://exceldatareader.codeplex.com/">ExcelRead website</a>)，真机对应功能还没做)检查。<br><img src="/img/Unity/LoadingUI.PNG" alt="LoadingUI"><br>这一个主要是尝试Scroll Bar<br><img src="/img/Unity/GameSetting1.PNG" alt="GameSetting1"><br><img src="/img/Unity/GameSetting2.PNG" alt="GameSetting2"><br><img src="/img/Unity/GameSetting3.PNG" alt="GameSetting3"><br>这三个主要是尝试UIBUtton，UIPopupList，UIISlider，UIDraggable Panel的使用和TweenPosition制作简单UI动画(包含了对背景音乐和音量的设置功能，存储采取PlayerPrefs写入程序文件)。<br><img src="/img/Unity/IpadScreenShot.jpg" alt="IpadScreenShot"><br>最后这一个是本章2D赛车躲避的最终真机(Ipad mini 1)游戏截图，主要实现了赛车跳跃，前后左右移动，随着赛车数量躲避增加游戏速度增加，限制了移动范围。</p>
<h3 id="贪吃蛇"><a href="#贪吃蛇" class="headerlink" title="贪吃蛇"></a>贪吃蛇</h3><h4 id="游戏说明-1"><a href="#游戏说明-1" class="headerlink" title="游戏说明"></a>游戏说明</h4><p>这个游戏我想没什么好说的了，直接移步<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E8%B4%AA%E9%A3%9F%E8%9B%87">贪吃蛇维基百科</a></p>
<h4 id="游戏要点思考"><a href="#游戏要点思考" class="headerlink" title="游戏要点思考"></a>游戏要点思考</h4><ol>
<li>2D or 3D？<br>标准的传统2D游戏，所以这里可以用纯2D来做(这里采用纯NGUI来做，看看NGUI的自适应效果)。</li>
<li>游戏素材大小<br>依然以1024<em>768(4:3)为标准，因为之前在<a href="http://tonytang1990.github.io/2015/07/15/Unity-Study/#NGUI_2-7%E5%B1%8F%E5%B9%95%E8%87%AA%E9%80%82%E5%BA%94">NGUI 2.7屏幕自适应</a>已经提到了，把UIRoot的Scaling Style设置为Fixed Size，然后通过动态修改ManuaHeight已经实现了基于高度的自适应，所以我们在创建地图的时候只需考虑把Grid创建在基于1024</em>768的分辨率对应位置即可(当然这样会出现在不同分辨率机器上自适应后铺不满屏幕，但这样做我们可以无需考虑机器分辨率)。准备设计宽40<em>30(4:3)个单元格，单元格以20乘以20像素为基准，这样一来游戏地图占据800</em>600像素，高度腾出来的像素768-600&#x3D;168用于控制UI面板显示。<br>这个游戏实现没什么特别的，这里主要看看不同分辨率的显示情况。<br>1024-768：<br><img src="/img/Unity/SnakeGame1024768.PNG" alt="SnakeGame1024768"><br>960-640：<br><img src="/img/Unity/Snake960640.PNG" alt="Snake960640"><br>800-800：<br><img src="/img/Unity/Snake800800.PNG" alt="Snake800800"></li>
</ol>
<h3 id="坦克大战"><a href="#坦克大战" class="headerlink" title="坦克大战"></a>坦克大战</h3><h4 id="游戏说明-2"><a href="#游戏说明-2" class="headerlink" title="游戏说明"></a>游戏说明</h4><p><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%9D%A6%E5%85%8B%E5%A4%A7%E6%88%98">坦克大战（英语：Battle City）是一款平面射击游戏</a></p>
<h4 id="游戏要点思考-1"><a href="#游戏要点思考-1" class="headerlink" title="游戏要点思考"></a>游戏要点思考</h4><ol>
<li><p>2D or 3D?<br>以纯2D的形式来制作坦克大战游戏。</p>
</li>
<li><p>UI选择<br>这里为了熟悉UGUI，进而和NGUI相比较，这里采用UGUI来学习。<br><a href="http://tonytang1990.github.io/2015/07/15/Unity-Study/#UGUI">UGUI相关知识学习</a></p>
</li>
<li><p>UI自适应<br>UI Render Space – Screen Space(Camera)(设置Main Camera作为渲染Camera)<br>UI Scale Mode – Scale With Screen Size(设置MatchWidthOrHeight &#x3D; 0.5确保按宽度和高度变化同时变化去适应)<br>Background UI Scale Mode – Scale with Screen Size(设置MatchWidthOrHeight &#x3D; 1确保游戏背景是高度铺满，Anchor设置在中心保持1:1比例)</p>
</li>
<li><p>Pixel Perfect 2D?素材选择？地图大小？地图在不同分辨率上的显示？<br>为了实现Pixel Perfect 2D，我们需要确保1 Unit所代表的像素 &#x3D; PPU。<br>我以1024 X 768为基准，Orthographic Size设置为6，PPU为64。(这样一来屏幕高度被分为12 Unit，每个Unit代表768 &#x2F; 2 &#x2F; 6 &#x3D; 64 pixel)<br>2D素材采用64 X 64的Tile(每一个Tile占一个Unit)<br>游戏区域为704 X 704大小(占11 X 11个Unit，四周多出来的用于UI显示)<br>UI Sprite采用64 X 64。<br>因为地图是基于Tile的，所以在不同分辨率上，地图的大小(Tile数量)应该是一致的，这里地图大小默认设定为11 X 11个Tile(704 X 704)(基于1024 X 768，高度顶部留1个Unit)。<br>要想Tile在不同分辨率机器上都Pixel Perfect显示，动态修改Orthographic Size会导致Size Change(屏幕高度的Unit数量也会改变)，以PPU &#x3D; 64且Tile像素为64 * 64去显示12个Tile是没法恰好铺满屏幕高度的。所以这里采用保持Orthographic Size不变保持6，制作多套PPU去适应屏幕分辨率的方案(通过Assetbundle动态替换)。(出于学习目的这里只针对1024 X 768(PPU &#x3D; 64)和1920 X 1080(PPU &#x3D; 1080 &#x2F; 2 &#x2F; 6 &#x3D; 90)来做两套PPU实验)<br>Note:<br>这方案会导致做很多套不同PPU的资源去适应不同屏幕分辨率。</p>
</li>
<li><p>Sprite Setting?<br>Sprite Type – Sprite(2D and UI) 因为用于纯2D游戏<br>Sprite Mode – Single or Multiple 根据我们的图片是否需要切割成单独的Sprite而定<br>Packing Tag – 用于Unity Sprite Packer打包Spite图集<br>Pixels Per Unit – 64(Pixel Perfect显示，PPU &#x3D; Screen.height &#x2F; Orthographic Size(6) &#x2F; 2)。<br>Generate Mip Maps – No(因为是纯2D游戏，摄像机与Sprite距离保持不变(当然其实Camera设置成Screen Space(Camera)而言是可以变的，但这里我们设置Orthographic投影，所以距离对于显示大小没有意义，并且我们还保证了Pixel Perfet显示，所以就游戏里的Sprite而言Mipmap是没有必要的。(前面的前提是使用多套Asset资源并保证Pixel Perfect显示))<br>后面三个参数学习参考<a target="_blank" rel="noopener" href="http://blog.csdn.net/candycat1992/article/details/22794773">调整画质（贴图）质量</a><br>Filter Mode – Bilinear(Filter Mode用于纹理图片这里的Sprite拉伸后如何插值计算(抗锯齿计算)，Bilinear会进行双线性插值，效果和运算开销在Point，Biinear，Trilinear里最能够接受。)<br>Max Size – 2048(导入纹理的最大尺寸，默认2048，设置过小会导致大图片被压缩，质量变得很差(当然也要考虑内存的使用降低了))<br>Format – Compressed(纹理压缩格式，大小和质量的权衡。采用默认的Compressed即可。)</p>
</li>
<li><p>物理？<br>不使用物理控制(Transform移动)，使用Trigger做触发，纯2D游戏，使用Physical2D和Rigibody2D。<br>平滑移动思考：<br> 需求：<br> 保持匀速移动，固定时间内完成<br> 方案一：<br> DoTwen<br> 使用DoTween会导致需要初始化大量的Tween(假设地图是11 X 11，每次移动的offset是0.5，那么我们会需要创建(11 &#x2F; 0.5 ) X (11 &#x2F; 0.5) &#x3D;  484个Tween)<br> 方案二：<br> Vector3.Lerp(Vector3 a, Vector3 b, float t);<br> <a target="_blank" rel="noopener" href="https://docs.unity3d.com/ScriptReference/Vector3.Lerp.html">Interpolates between the vectors a and b by the interpolant t. The parameter t is clamped to the range [0, 1].</a><br> <a target="_blank" rel="noopener" href="http://www.blueraja.com/blog/404/how-to-use-unity-3ds-linear-interpolation-vector3-lerp-correctly">Using Vector3.Lerp() correctly in Unity</a><br> 参考上述博文，我们会发现，平时大部分的用法是如下：</p>
</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">transform.position = Vector3.Lerp(transform.position, _endPosition, speed*Time.deltaTime);</span><br></pre></td></tr></table></figure>
<pre><code>这样的用法其实会导致非线性的移动速度，因为每一次transform.position的位置在变(离终点越来越近)，假设Time.deltaTime是固定时间间隔，那么就会出现前半段移动的快，后半段移动的慢的效果。
为了保证正真的平滑移动(匀速移动)，我们需要保证初始位置和结束位置不变，然后调整t参数，所以这里把t参数设定为timepassed(从开始Lerp计时) / timetocomplete(总共完成Lerp的用时。通过在Update或FixedUpdate里每隔一段时间更新Lerp的t参数，我们可以实现跟帧率挂钩的匀速移动效果(帧率高，移动的平滑。帧率低，移动的跳跃。但都能在固定时间内达到终点)。
</code></pre>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">IEnumerator <span class="title">MovingCoroutine</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (mIsMoving == <span class="literal">true</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">float</span> timesincestarted = Time.time - mTimeStartMoving;</span><br><span class="line">            <span class="built_in">float</span> percentagecomplete = timesincestarted / mTimeToCompleteMove;</span><br><span class="line">            transform.position = Vector3.Lerp(mStartPosition, mDestinationPosition, percentagecomplete);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (percentagecomplete &gt;= <span class="number">1.0f</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                mIsMoving = <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">yield</span> <span class="keyword">return</span> <span class="keyword">new</span> <span class="title">WaitForSeconds</span>(<span class="params">mKeepMoveIntervalTime / <span class="number">10</span></span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="7">
<li><p>控制方式<br>因为之前的控制面板是基于NGUI制作的，所以这里就混合UGUI和NGUI来作为控制面板。</p>
</li>
<li><p>游戏特性<br> 坦克特性：<br> 1. 占据一个Tile，1 Unit(1 Tile被细分成16 * 16的网格)<br> 2. Tank以0.5个Unit的单位的移动，只要前方0.5 Unit单位内有不可通行物，就不能前进<br> 3. 多个Tank不能占据同一位置<br> 4. Tank只能上下左右移动<br> 5. 坦克只能发射出有限数量的子弹，在子弹数量达到上限时需要等待子弹消失。<br> 6. 不同的坦克的移动速度和子弹数量上限和子弹速度不一样<br> 子弹特性：<br> 1. 子弹拥有不同等级的威力，根据威力不同可消灭的小块数量和小块类型不同<br> 2. 子弹不能击中友方队员(友方队员子弹也不行)<br> 3. 子弹只有上下左右四个固定的方向，一旦射出子弹，方向不会改变<br> Tile特性：<br> 1. Tile可以被攻击切割成多个小块(Normal Tile这里假设可切割成16)，<br> 每个小块具备完整的特性(占据单元格阻碍前进，能被攻击)。<br> 2. 小块Tile被子弹击中会根据子弹伤害和周围Tile小块情况来决定是消灭单独一个小块还是2个或多个。<br> 3. 不同类型的Tile有不同的特性(能否通过，能否破坏等)</p>
</li>
<li><p>敌人AI<br> 敌军坦克特性：<br> 1. 移动方向只有上下左右<br> 2. 单次移动单位0.5 Unit<br> 3. 撞到障碍物(不可通行的地方(不包括友军坦克))后重新选择方向<br> 4. 方向选择(避开之前行进方向随机选取一个方向，为了保证坦克不至于一直一左一右，这里需要采用[Shuffle Bag]而非完全随机的方式选取新移动方向，Shuffle Bag可以保证特定事件发生的概率从而保证各个方向的选择都能平摊，比如4次里面肯定会有上下左右而非左右左右)<br> 5. 多个坦克相遇的时候不立刻重新选择方向而是开始累计坦克无法移动的时间<br> (直到坦克达到坦克停止时间限制时重新选择，这里不同速度的坦克所忍耐的停止时间不一样，这样一来就可以实现，速度快的追着速度慢的跑)<br> 6. 子弹随机隔一段时间发射，但不会发射超过子弹数量上限。<br> <a target="_blank" rel="noopener" href="https://web.archive.org/web/20150324141028/http://kaioa.com/node/53">Shuffle Bag</a><br> Shuffle Bag代码：</p>
</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ShuffleBag</span>&lt;<span class="title">T</span>&gt; : <span class="title">ICollection</span>&lt;<span class="title">T</span>&gt;, <span class="title">IList</span>&lt;<span class="title">T</span>&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> List&lt;T&gt; mData = <span class="keyword">new</span> List&lt;T&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span> mCursor = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> T last;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> T <span class="title">Next</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (mData.Count == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">default</span>(T);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mCursor &lt; <span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            mCursor = mData.Count - <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">if</span> (mData.Count &lt; <span class="number">1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">default</span>(T);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> mData[<span class="number">0</span>];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">int</span> grab = Mathf.FloorToInt(Random.<span class="keyword">value</span> * (mCursor + <span class="number">1</span>));</span><br><span class="line">        T temp = mData[grab];</span><br><span class="line">        mData[grab] = mData[mCursor];</span><br><span class="line">        mData[mCursor] = temp;</span><br><span class="line">        mCursor--;</span><br><span class="line">        <span class="keyword">return</span> temp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//IList[T] implementation</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">int</span> <span class="title">IndexOf</span>(<span class="params">T item</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> mData.IndexOf(item);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Insert</span>(<span class="params"><span class="built_in">int</span> index, T item</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        mData.Insert(index, item);</span><br><span class="line">        mCursor = mData.Count - <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">RemoveAt</span>(<span class="params"><span class="built_in">int</span> index</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        mData.RemoveAt(index);</span><br><span class="line">        mCursor = mData.Count - <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> T <span class="keyword">this</span>[<span class="built_in">int</span> index]</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> mData[index];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">set</span></span><br><span class="line">        &#123;</span><br><span class="line">            mData[index] = <span class="keyword">value</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//IEnumerable[T] implementation</span></span><br><span class="line">    IEnumerator&lt;T&gt; IEnumerable&lt;T&gt;.GetEnumerator()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> mData.GetEnumerator();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ICollection[T] implementation</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Add</span>(<span class="params">T item</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        mData.Add(item);</span><br><span class="line">        mCursor = mData.Count - <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> Count</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> mData.Count;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Clear</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//mCursor = 0;</span></span><br><span class="line">        mData.Clear();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">Contains</span>(<span class="params">T item</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> mData.Contains(item);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">CopyTo</span>(<span class="params">T[] array, <span class="built_in">int</span> arrayindex</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">foreach</span> (T item <span class="keyword">in</span> mData)</span><br><span class="line">        &#123;</span><br><span class="line">            array.SetValue(item, arrayindex);</span><br><span class="line">            arrayindex++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">Remove</span>(<span class="params">T item</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">bool</span> removesuccess = mData.Remove(item);</span><br><span class="line">        mCursor = mData.Count - <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">return</span> removesuccess;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">bool</span> IsReadOnly</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//IEnumerable implementation</span></span><br><span class="line">    IEnumerator IEnumerable.GetEnumerator()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> mData.GetEnumerator();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="10">
<li><p>地图编辑器制作<br>做一个地图编辑模式，提供多种Tile模型选择，通过序列化存储起来。(可用于制作关卡)</p>
</li>
<li><p>多人网络游戏(学习多人网络游戏开发)<br>暂不支持多人联网进行(通过Unity High Level API去开发  – 待深入学习)</p>
</li>
<li><p>地图存储方式<br>地图信息很简单，主要存储地图里每一个Tile的类型信息(同时存储地图名称，坦克出生地点信息)，这里采用序列化的方式。(因为我们保持了Orthographic Size为6，通过动态切换不同PPU的Assets去保证Pixel Perfect显示，所以Screen高度一直都是12个Unit，同时设置了PPU &#x3D; Screen.height &#x2F; 2 &#x2F; 6，Tile素材PPU * PPU，所以1个Tile对应1个Unit。地图存储的信息是11 * 11(704 * 704)个Tile相关的信息(高度顶部留3个Unit用作UI显示)。</p>
</li>
<li><p>地图数据加密<br>待思考</p>
</li>
<li><p>游戏地图数据结构？如何实现Tile可以被多个方向打击切割成小块效果？<br>地图存储数据信息(MapInfo)：<br>1. 地图被细分成多个Tile(MapSize.Row * MapSize.Column大小)，存储所有Tile相关信息(用于构建地图)<br>2. 记录玩家Tank出生点和敌军坦克出生点信息。(用于获取Spawn玩家坦克和敌军坦克的位置信息)<br>3. 记录是否包含基地和基地位置信息。(用于确保只有一个基地)<br>4. 存储地图名字(用于地图存储)<br>游戏地图数据(TankMap)：<br>1. 记录所有细分后是否被占用信息(用于Tank移动判断)<br>同时记录是否被Tank占用(用于Tank移动的时候判断前方是Tank还是Tile)<br>同时记录细分后占用的类型信息(Tile Type,用于子弹撞击后检测周边Tile类型信息)<br>地图应该被细分成所有 Tile数量 * Tile最小切割数的网格<br>(这里假设Tile最多被切割成16，那么地图应该被细分到MapSize.Row * MapSize.Column * 16的BitArray)<br>2. 每个细分的Tile记录自身包含细分后的索引信息<br>(e.g. 最大细分16，Iron Tile细分为2 * 2 &#x3D; 4，那么每个细分的Iro Tile所记录的细分后的索引信息数量为16 &#x2F; 4 &#x3D; 4个)<br>这样一来每个小的Tile被破坏后支持快速改写该小块占有地图网格的占用信息)。<br>3. 坦克存储自身所占用的所有indexs作为移动索引信息<br>3. 包含前面地图存储的信息(用于构建游戏地图数据)</p>
</li>
</ol>
<p>Note：<br>不同类型的Tile的细分程度不同(16 * 16 or 4 * 4 or 2 * 2 or 1 * 1)，但游戏地图数据细分以细分程度最大的为准。(细分程度不同会影响Tile在子弹撞击时的效果判定)</p>
<p>实现功能：</p>
<ol>
<li>地图编辑存储和读取(支持原始的那些Tile选择)</li>
<li>敌军坦克简单AI(基本无AI，主要是随机的方向选择，但通过Shuffle Bag来避免了过于随机的选择方式)</li>
<li>我方坦克控制和子弹射击</li>
<li>子弹打击效果</li>
</ol>
<p>暂时效果：<br><img src="/img/Unity/TankScreenShot.PNG" alt="TankScreenShot"><br><a target="_blank" rel="noopener" href="http://blog.sina.com.cn/s/blog_8c7d49f20102xrwk.html">具体视频效果参见</a></p>
<p>因为只上传了IOS打包后的XCode项目等文件作为Unity Icloud Build的地址，所以这里没有源代码地址。</p>
<p>待续……</p>
<h2 id="问题记录"><a href="#问题记录" class="headerlink" title="问题记录"></a>问题记录</h2><ol>
<li>编译打包XCode项目出问题<br>Failed to Copy File &#x2F; Directory from ‘**\Unity\Editor\Data\Tools&#x2F;MapFileParser&#x2F;MapFileParser’ to ‘Temp&#x2F;StagingArea\Trampoline\MapFileParser’.<br>这是Unity 5.1版本的一个bug。<br><a target="_blank" rel="noopener" href="http://answers.unity3d.com/questions/990499/error-building-player-ioexception-failed-to-copy.html">解决方案</a><br>修改.\Unity\Editor\Data\Tools\MapFileParser\MapFileParser.exe到MapFileParser然后打包XCode项目，然后在XCode项目里把MapFileParser改回MapFileParser.exe<br>或者使用新版本Unity</li>
<li>编译打包XCode项目时库找不到的问题<br>ArgumentException: The Assembly System.Configuration is referenced by System.Data. But the dll is not allowed to be included or could not be found.<br><a target="_blank" rel="noopener" href="http://answers.unity3d.com/questions/485085/dll-is-not-allowed-to-be-included-or-could-not-be.html">解决方案</a><br>Change it from .NET sub 2.0 to .NET</li>
<li>Git不支持超过100M文件上传<br><a target="_blank" rel="noopener" href="https://git-lfs.github.com/">解决方案Git Large File Storage (LFS)</a></li>
<li>Cloud Build显示Bitcode错误<br>又是Unity5.1.1的一个bug<br>解决方案：<br>可以打开XCode项目，项目属性设置bitcode enale<br>由于遇到太多Unity bug，个人建议采用新版本Unity为佳。我个人最后去下载了最新版本的Unity5.4.0版本。</li>
<li>MapParser.sh acess Permission denied<br>貌似又是Unity bug，Unity 5.4.0<br>解决方案:<br>需要在Mac电脑上修改MapParser.sh的执行权限(chmod +x MapParser.sh)，然后提交到Git后再触发编译。然后用修改后的MapParser.sh覆盖引擎目录下的Editor\Data\PlaybackEngines\iOSSupport\Trampoline\MapParser.sh以确保每次生成的XCode Project里的MapParser.sh有可执行权限。</li>
<li>指定Android NDK的时候报错”Unable to detect NDK version, please pick a different folder”<br>解决方案：<br>需要下载特定版本的NDK 10r<br>Edit -&gt; Preference -&gt; External Tool -&gt; NDK download<br>或者<br>自己去下载后指定目录</li>
<li>XCode编译项目报错：MapParser.sh: bin&#x2F;sh^M: bad interpreter: no such file or directory<br><a target="_blank" rel="noopener" href="http://www.cnblogs.com/pipelone/archive/2009/04/17/1437879.html">解决方案</a><br>这是不同系统编码格式引起的：在windows系统中编辑的.sh文件可能有不可见字符，所以在Linux系统下执行会报以上异常信息。<br>使用dos2unix工具转换字符编码后放到Xcode项目里。(为了避免XCode生成每次都出这个问题，我们替换字符编码为Unix位于Unity引擎里的Editor-&gt;Data-&gt;PlaybackEngines-&gt;iOSSupport-&gt;Trampoline-&gt;MapFileParser.sh)</li>
<li>Unity Cloud Build error:”2015-12-10 17:21:27.407 xcodebuild[7363:75765] Failed to locate a valid instance of CoreSimulatorService in the bootstrap.  Adding it now.<br>Could not find service “com.apple.CoreSimulator.CoreSimulatorService” in domain for uid: 502<br>2015-12-10 17:21:27.431 xcodebuild[7363:75765] launchctl print returned an error code: 28928”<br><a target="_blank" rel="noopener" href="https://trac.macports.org/wiki/ProblemHotlist#xcode7.2">解决方案</a><br>从上面链接发现这是Xcode 7.2的一个bug，我们需要用Xcode 7.3，所以我们只需要把Unity Cloud Build设置到Xcode 7.3即可。</li>
<li>Unity Icloud Build打包出来的.ipa文件很大<br>一. 关闭Bitcode<br><a target="_blank" rel="noopener" href="https://developer.apple.com/library/content/documentation/IDEs/Conceptual/AppDistributionGuide/AppThinning/AppThinning.html">关闭Bitcode</a><br>Bitcode好像是Apple提交App后用于帮助优化的数据，IOS上是optional的，但watchOS and tvOS apps是必须的。</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> UnityEditor;</span><br><span class="line"><span class="keyword">using</span> UnityEditor.Callbacks;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> UnityEditor.iOS.Xcode;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BuildSetting</span> &#123;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">PostProcessBuild</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">OnPostprocessBuild</span>(<span class="params">BuildTarget buildTarget, <span class="built_in">string</span> path</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Debug.Log(<span class="built_in">string</span>.Format(<span class="string">&quot;OnPostprocessBuild(&#123;0&#125;,&#123;1&#125;) called!&quot;</span>, buildTarget.ToString(), path));</span><br><span class="line">        <span class="keyword">if</span> (buildTarget == BuildTarget.iOS)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">string</span> projPath = path + <span class="string">&quot;/Unity-iPhone.xcodeproj/project.pbxproj&quot;</span>;</span><br><span class="line">            PBXProject proj = <span class="keyword">new</span> PBXProject();</span><br><span class="line">            proj.ReadFromString(File.ReadAllText(projPath));</span><br><span class="line"></span><br><span class="line">            <span class="built_in">string</span> nativeTarget = proj.TargetGuidByName(PBXProject.GetUnityTargetName());</span><br><span class="line">            <span class="built_in">string</span> testTarget = proj.TargetGuidByName(PBXProject.GetUnityTestTargetName());</span><br><span class="line">            <span class="built_in">string</span>[] buildTargets = <span class="keyword">new</span> <span class="built_in">string</span>[] &#123; nativeTarget, testTarget &#125;;</span><br><span class="line"></span><br><span class="line">            proj.SetBuildProperty(buildTargets, <span class="string">&quot;ENABLE_BITCODE&quot;</span>, <span class="string">&quot;NO&quot;</span>);</span><br><span class="line">            File.WriteAllText(projPath, proj.WriteToString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>二. 不使用的资源不要放在Resources目录下，避免被打包到resources.assets里<br>三. 打包编译Release版本而非Debug版</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Other/">Other</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Other/">Other</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/07/25/Shader-Toy/" title="Shader Toy" itemprop="url">Shader Toy</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Tony Tang" target="_blank" itemprop="author">Tony Tang</a>
		
  <p class="article-time">
    <time datetime="2016-07-25T07:36:19.000Z" itemprop="datePublished"> 发表于 2016-07-25</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="Shader-Toy-Introduction"><a href="#Shader-Toy-Introduction" class="headerlink" title="Shader Toy Introduction"></a>Shader Toy Introduction</h1><p>之前就听别人提起过这个网站，上面有各式各样只通过Pixel Shader编写绚丽的效果(里面包含了很多数学和算法)。<br>而且作者编写的代码在网站上一目了然，让你知道这个效果是如何计算得出的。<br>看一下下面这一张效果：<br><img src="/img/OpenGL/ShaderToyExmaple.PNG" alt="ShaderToyExmaple"><br>第一眼看到的时候，我很难相信这是通过简单纹理贴图输入加上数学运算得出的图案。</p>
<p>那么我们首先要知道什么是Pixel Shader？<br>Pixel Shader在OpenGL里也叫做Fragment Shader,可以简单的理解成针对每一个pixel做处理的Shader。</p>
<p>在这个网站上编写Pixel Shader还有一个好处就是快速方便的看到效果，当你要去测试一些数学算式算法的时候，很容易可视化的在上面编写并测试。</p>
<h1 id="Shader-Toy-Study"><a href="#Shader-Toy-Study" class="headerlink" title="Shader Toy Study"></a>Shader Toy Study</h1><p>接下来是基于ShaderToy上”GLSL 2D Tutorials”教程学习的一些事例。</p>
<h2 id="fragColor"><a href="#fragColor" class="headerlink" title="fragColor"></a>fragColor</h2><p>fragColor就是我们在GLSL的fragment shader里最后代表像素颜色的最后输出变量，他控制着我每一个像素最终的颜色值</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">mainImage</span><span class="params">( out vec4 fragColor, in vec2 fragCoord )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    fragColor = <span class="built_in">vec4</span>(<span class="number">0.0</span>,<span class="number">1.0</span>,<span class="number">1.0</span>,<span class="number">1.0</span>);    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>mainImage(…)是我们的Pixel Shader的函数路口，每一帧都会对每一像素进行调用。<br>Final Effect：<br><img src="/img/OpenGL/ShaderToyfragColor.PNG" alt="ShaderToyfragColor"></p>
<h2 id="fragCoord"><a href="#fragCoord" class="headerlink" title="fragCoord"></a>fragCoord</h2><p>fragCoord是针对像素坐标而言的，因为mainImage会针对每一个像素执行一次，而fragCoord就给出了像素的坐标位置(左下角为原点)。<br>iResolution是ShaderToy里给出的关于frame的宽高像素信息（主要用于适应屏幕的大小变化，做到按比例而非特定像素值）</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">mainImage</span><span class="params">( out vec4 fragColor, in vec2 fragCoord )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// fragcoord通过使用像素的fragCoord位置除以iResolution的宽高像素信息，</span></span><br><span class="line">	<span class="comment">// 成功将像素位置的width和heigth都映射到了[0.0,1.0]</span></span><br><span class="line">    vec2 fragcoord = <span class="built_in">vec2</span>(fragCoord.xy / iResolution.xy);</span><br><span class="line">    vec3 backgroundcolor = <span class="built_in">vec3</span>(<span class="number">1.0</span>,<span class="number">1.0</span>,<span class="number">1.0</span>);</span><br><span class="line">    vec3 pixelcolor = backgroundcolor;</span><br><span class="line">    vec3 gridcolor = <span class="built_in">vec3</span>(<span class="number">0.5</span>,<span class="number">0.5</span>,<span class="number">0.5</span>);</span><br><span class="line">    vec3 axescolor = <span class="built_in">vec3</span>(<span class="number">0.0</span>,<span class="number">0.0</span>,<span class="number">1.0</span>);</span><br><span class="line">    <span class="type">const</span> <span class="type">float</span> thickwidth = <span class="number">0.1</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">float</span> i = <span class="number">0.0</span>; i &lt; <span class="number">1.0</span>; i+=thickwidth)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">mod</span>(fragcoord.x, thickwidth) &lt; <span class="number">0.008</span> || <span class="built_in">mod</span>(fragcoord.y, thickwidth) &lt; <span class="number">0.008</span>)</span><br><span class="line">        &#123;</span><br><span class="line">           pixelcolor = gridcolor;  </span><br><span class="line">        &#125;       </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">abs</span>(fragcoord.x ) &lt; <span class="number">0.006</span> || <span class="built_in">abs</span>(fragcoord.y) &lt; <span class="number">0.006</span>)</span><br><span class="line">    &#123;</span><br><span class="line">       pixelcolor = axescolor;   </span><br><span class="line">    &#125;</span><br><span class="line">    fragColor = <span class="built_in">vec4</span>(pixelcolor,<span class="number">1.0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Final Effect:<br><img src="/img/OpenGL/ShaderToyfragCoord.PNG" alt="ShaderToyfragCoord"></p>
<h2 id="Own-Coordinate-System"><a href="#Own-Coordinate-System" class="headerlink" title="Own Coordinate System"></a>Own Coordinate System</h2><p>前一节讲到的把像素坐标映射到了[0.0,1.0]，那么如果我们想把坐标信息映射到[-1.0,1.0]并且把屏幕中点作为(0.0,0.0)改如何映射了<br>而且前一节有一个问题需要注意，我们绘制出的grid是长方形而不是正方形（这主要是由于我们屏幕宽高是不一样，但我们都把x，y映射到了[0.0,1.0]并且用相同的interval即thickwidth去做等分导致的）</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">mainImage</span><span class="params">( out vec4 fragColor, in vec2 fragCoord )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// 这里值得注意一下，因为一般情况都是屏幕宽大于高，</span></span><br><span class="line">	<span class="comment">// 所以我们在映射宽高的时候，只需把高映射到[-1.0,1.0]，</span></span><br><span class="line">	<span class="comment">// 宽保持和高的比例差即可，即映射到[-width/height, width/height]</span></span><br><span class="line">	<span class="comment">// 这样一来，同一个interval对于宽和高来说就一样了</span></span><br><span class="line">    vec2 r = <span class="built_in">vec2</span>( fragCoord.xy - <span class="number">0.5</span>*iResolution.xy );</span><br><span class="line">	r = <span class="number">2.0</span> * r.xy / iResolution.y;</span><br><span class="line">    vec3 backgroundcolor = <span class="built_in">vec3</span>(<span class="number">1.0</span>,<span class="number">1.0</span>,<span class="number">1.0</span>);</span><br><span class="line">    vec3 pixelcolor = backgroundcolor;</span><br><span class="line">    vec3 gridcolor = <span class="built_in">vec3</span>(<span class="number">0.5</span>,<span class="number">0.5</span>,<span class="number">0.5</span>);</span><br><span class="line">    vec3 axescolor = <span class="built_in">vec3</span>(<span class="number">0.0</span>,<span class="number">0.0</span>,<span class="number">1.0</span>);</span><br><span class="line">    <span class="type">const</span> <span class="type">float</span> thickwidth = <span class="number">0.1</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">float</span> i = <span class="number">0.0</span>; i &lt; <span class="number">1.0</span>; i+=thickwidth)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">mod</span>(r.x, thickwidth) &lt; <span class="number">0.008</span> || <span class="built_in">mod</span>(r.y, thickwidth) &lt; <span class="number">0.008</span>)</span><br><span class="line">        &#123;</span><br><span class="line">           pixelcolor = gridcolor;  </span><br><span class="line">        &#125;       </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">abs</span>(r.x ) &lt; <span class="number">0.006</span> || <span class="built_in">abs</span>(r.y) &lt; <span class="number">0.006</span>)</span><br><span class="line">    &#123;</span><br><span class="line">       pixelcolor = axescolor;   </span><br><span class="line">    &#125;</span><br><span class="line">    fragColor = <span class="built_in">vec4</span>(pixelcolor,<span class="number">1.0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Final Effect:<br><img src="/img/OpenGL/ShaderToyOwnCoordinateSystem.PNG" alt="ShaderToyOwnCoordinateSystem"></p>
<h2 id="Cicle-Demo"><a href="#Cicle-Demo" class="headerlink" title="Cicle Demo"></a>Cicle Demo</h2><p>接下来我们即将看实现以下功能：</p>
<ol>
<li>绘制圆<br>针对绘制圆，我们主要是通过判断像素到圆心的位置的距离来决定是否处于圆内。</li>
<li>让圆之间的颜色实现叠加计算<br>针对叠加运算的判断，我们主要是通过一个smoothstep的函数去得出像素在圆内和圆外所参与颜色计算的比例(这里是院内1.0,圆外0.0)<br>这里要介绍一下<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Smoothstep">smoothstep</a>函数。<br>函数原型：<br>float smoothstep(float edge0, float edge1, float x)<br>如果我们传递x&lt;edge0则返回0.0，x&gt;edge1则返回1.0，如果在中间则返回edge0-edge1的interpolation值(这里我们主要用来实现判断像素是在圆内还是圆外来决定是否参与叠加运算)</li>
<li>使圆做周期性运动。<br>圆做周期性运动主要是通过iGlobalTime(Pixel Shader运行后的一个动态时间)来计算得出圆心的位置来实现的。</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> PI 3.14159265359</span></span><br><span class="line"><span class="comment">// 绘制圆并返回是否改圆的该像素是否应该参与像素叠加计算</span></span><br><span class="line"><span class="function"><span class="type">float</span> <span class="title">disk</span><span class="params">(vec2 r, vec2 center, <span class="type">float</span> radius, vec3 color, inout vec3 pixel)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   <span class="type">float</span> rtoclength = <span class="built_in">length</span>(r - center);</span><br><span class="line">   <span class="type">float</span> inside = <span class="number">0.0</span>; </span><br><span class="line">   <span class="keyword">if</span>(rtoclength &lt; radius)</span><br><span class="line">   &#123;</span><br><span class="line">      <span class="comment">//pixel = vec3(clamp(rtoclength, radius / 4.0,radius / 2.0));   </span></span><br><span class="line">      inside = <span class="number">1.0</span> - <span class="built_in">smoothstep</span>(radius - <span class="number">0.005</span>,radius + <span class="number">0.005</span>, rtoclength);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> inside;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">mainImage</span><span class="params">( out vec4 fragColor, in vec2 fragCoord )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    vec2 p = <span class="built_in">vec2</span>(fragCoord.xy / iResolution.xy);</span><br><span class="line">  	vec2 r = <span class="built_in">vec2</span>( fragCoord.xy - <span class="number">0.5</span>*iResolution.xy );</span><br><span class="line">	r = <span class="number">2.0</span> * r.xy / iResolution.y;</span><br><span class="line">    vec3 backgroundcolor = <span class="built_in">vec3</span>(<span class="number">0.0</span>, <span class="number">0.0</span>, <span class="number">0.0</span>);</span><br><span class="line">    vec3 color1 = <span class="built_in">vec3</span>(<span class="number">1.0</span>, <span class="number">0.0</span>,<span class="number">0.0</span>);</span><br><span class="line">    vec3 color2 = <span class="built_in">vec3</span>(<span class="number">0.0</span>, <span class="number">1.0</span>, <span class="number">0.0</span>);</span><br><span class="line">    vec3 color3 = <span class="built_in">vec3</span>(<span class="number">0.0</span>, <span class="number">0.0</span>, <span class="number">1.0</span>);</span><br><span class="line">    vec2 circle1center1 = <span class="built_in">vec2</span>(<span class="built_in">sin</span>(iGlobalTime / <span class="number">1.0</span>), <span class="built_in">cos</span>(iGlobalTime / <span class="number">1.0</span>));</span><br><span class="line">    vec2 circle1center2 = <span class="built_in">vec2</span>(<span class="built_in">cos</span>(iGlobalTime / <span class="number">2.0</span>), <span class="built_in">sin</span>(iGlobalTime / <span class="number">2.0</span>));</span><br><span class="line">    vec2 circle1center3 = <span class="built_in">vec2</span>(-<span class="built_in">sin</span>(iGlobalTime / <span class="number">3.0</span>), -<span class="built_in">cos</span>(iGlobalTime / <span class="number">3.0</span>));  </span><br><span class="line">    </span><br><span class="line">    vec3 resultcolor = <span class="built_in">vec3</span>(<span class="number">0.0</span>,<span class="number">0.0</span>,<span class="number">0.0</span>);</span><br><span class="line">    </span><br><span class="line">    vec3 pixel = backgroundcolor;</span><br><span class="line">    </span><br><span class="line">    resultcolor += <span class="built_in">disk</span>(r, circle1center1, <span class="number">0.6</span>, color1, pixel) * color1;</span><br><span class="line">    </span><br><span class="line">    resultcolor += <span class="built_in">disk</span>(r, circle1center2, <span class="number">0.6</span>, color2, pixel) * color2;</span><br><span class="line">    </span><br><span class="line">    resultcolor += <span class="built_in">disk</span>(r, circle1center3, <span class="number">0.6</span>, color3, pixel) * color3;  </span><br><span class="line">    </span><br><span class="line">    fragColor = <span class="built_in">vec4</span>(resultcolor, <span class="number">1.0</span>);</span><br><span class="line">&#125;    </span><br></pre></td></tr></table></figure>
<p>Final Effect:<br><img src="/img/OpenGL/ShaderToyCircleDemo.PNG" alt="ShaderToyCircleDemo"></p>
<h2 id="Plasma-Effect"><a href="#Plasma-Effect" class="headerlink" title="Plasma Effect"></a>Plasma Effect</h2><p><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Plasma_effect">Plasma Effect</a><br>关于这一节还有很多相关知识需要学习理解，暂时只贴代码和效果，后续会进一步深入了解。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">mainImage</span><span class="params">( out vec4 fragColor, in vec2 fragCoord )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    vec2 p = <span class="built_in">vec2</span>(fragCoord.xy / iResolution.xy);</span><br><span class="line">  	vec2 r = <span class="built_in">vec2</span>( fragCoord.xy - <span class="number">0.5</span>*iResolution.xy );</span><br><span class="line">	r = <span class="number">2.0</span> * r.xy / iResolution.y;</span><br><span class="line">    vec3 ret = <span class="built_in">vec3</span>(<span class="number">1.0</span>, <span class="number">1.0</span>, <span class="number">1.0</span>);</span><br><span class="line">    <span class="type">float</span> t = iGlobalTime;</span><br><span class="line">    r = r * <span class="number">8.0</span>;</span><br><span class="line">    <span class="type">float</span> v1 = <span class="built_in">sin</span>(r.x + t);</span><br><span class="line">    <span class="type">float</span> v2 = <span class="built_in">sin</span>(r.y + t);</span><br><span class="line">    <span class="type">float</span> v3 = <span class="built_in">sin</span>(r.x + r.y + t);</span><br><span class="line">    <span class="type">float</span> v4 = <span class="built_in">sin</span>(<span class="built_in">sqrt</span>(r.x * r.x + r.y * r.y) + t);</span><br><span class="line">    <span class="type">float</span> v5 = v1 + v2 + v3 + v4;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>( p.x &lt; <span class="number">1.0</span> / <span class="number">10.0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">       ret = <span class="built_in">vec3</span>(v1);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>( p.x &lt; <span class="number">2.0</span> / <span class="number">10.0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">       ret = <span class="built_in">vec3</span>(v2);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>( p.x &lt; <span class="number">3.0</span> / <span class="number">10.0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">       ret = <span class="built_in">vec3</span>(v3); </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>( p.x &lt; <span class="number">4.0</span> / <span class="number">10.0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">       ret = <span class="built_in">vec3</span>(v4); </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>( p.x &lt; <span class="number">5.0</span> / <span class="number">10.0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">       ret = <span class="built_in">vec3</span>(v5);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>( p.x &lt; <span class="number">6.0</span> / <span class="number">10.0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        ret = <span class="built_in">vec3</span>(<span class="built_in">sin</span>(v5));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">       ret *= <span class="built_in">vec3</span>(<span class="built_in">sin</span>(v5), <span class="built_in">cos</span>(v5), <span class="built_in">tan</span>(v5));         </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    fragColor = <span class="built_in">vec4</span>(ret, <span class="number">1.0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Final Effect:<br><img src="/img/OpenGL/ShaderToyPlasmaEffect.PNG" alt="ShaderToyPlasmaEffect"></p>
<h2 id="Texture-Video-as-Input"><a href="#Texture-Video-as-Input" class="headerlink" title="Texture &amp; Video as Input"></a>Texture &amp; Video as Input</h2><p>下面这个效果比较有趣，是通过把两个视频作为输入，通过把其中一个视频作为背景，把另一个含绿色背景的颜色出掉后合二为一实现的效果。<br>在Shader Toy里，我们可以设置几个Texture到iChannel<em>上，然后通过texture2D(iChannel</em>,*)去访问纹理值。<br>参考至<a target="_blank" rel="noopener" href="http://gamedevelopment.tutsplus.com/tutorials/a-beginners-guide-to-coding-graphics-shaders--cms-23313">A Beginner’s Guide to Coding Graphics Shaders</a></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">mainImage</span><span class="params">( out vec4 fragColor, in vec2 fragCoord )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    vec4 backgroundtexture = <span class="built_in">texture2D</span>(iChannel0, p);</span><br><span class="line">    vec4 fronttexture = <span class="built_in">texture2D</span>(iChannel2, p);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(fronttexture.r + fronttexture.b &gt; fronttexture.g)</span><br><span class="line">    &#123;</span><br><span class="line">       fragColor = fronttexture;   </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">       fragColor = backgroundtexture;  </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Final Effect:<br><img src="/img/OpenGL/ShaderToyTextureAndVideoInput.PNG" alt="ShaderToyTextureAndVideoInput"><br><img src="/img/OpenGL/ShaderToyTextureAndVideoInput2.PNG" alt="ShaderToyTextureAndVideoInput2"></p>
<h2 id="Mouse-Input"><a href="#Mouse-Input" class="headerlink" title="Mouse Input"></a>Mouse Input</h2><p>这一节讲到ShaderToy里关于如何响应Mouse Input。<br>ShaderToy里给了一个iMouse变量，用于得到Mouse输入的信息，我们可以通过iMouse变量的值去做出对应的响应效果。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">float</span> <span class="title">disk</span><span class="params">(vec2 r, vec2 center, <span class="type">float</span> radius, vec3 color, inout vec3 pixel)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   <span class="type">float</span> rtoclength = <span class="built_in">length</span>(r - center);</span><br><span class="line">   <span class="type">float</span> inside = <span class="number">0.0</span>; </span><br><span class="line">   <span class="keyword">if</span>(rtoclength &lt; radius)</span><br><span class="line">   &#123;</span><br><span class="line">      <span class="comment">//pixel = vec3(clamp(rtoclength, radius / 4.0,radius / 2.0));   </span></span><br><span class="line">      inside = <span class="number">1.0</span> - <span class="built_in">smoothstep</span>(radius - <span class="number">0.005</span>,radius + <span class="number">0.005</span>, rtoclength);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> inside;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">mainImage</span><span class="params">( out vec4 fragColor, in vec2 fragCoord )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  	vec2 r = <span class="built_in">vec2</span>( fragCoord.xy - <span class="number">0.5</span>*iResolution.xy );</span><br><span class="line">	r = <span class="number">2.0</span> * r.xy / iResolution.y;</span><br><span class="line">	vec3 backgroundcolor = <span class="built_in">vec3</span>(iMouse.x / iResolution.x);</span><br><span class="line">    vec3 resultcolor = backgroundcolor;</span><br><span class="line">    <span class="comment">// 这里值得注意的一点是，因为我们把高映射到[-1.0,1.0]，但宽是[-aspect, aspect]</span></span><br><span class="line">    <span class="comment">// 我们必须把mouse的x也映射到一样的比例才能正确显示在以r为坐标系的位置</span></span><br><span class="line">    vec2 center = <span class="number">2.0</span> * <span class="built_in">vec2</span>(iMouse.xy - <span class="number">0.5</span> * iResolution.xy) / iResolution.y;</span><br><span class="line">    resultcolor += <span class="built_in">disk</span>(r, center, <span class="number">0.3</span>, <span class="built_in">vec3</span>(<span class="number">1.0</span>,<span class="number">0.0</span>,<span class="number">0.0</span>), resultcolor) * <span class="built_in">vec3</span>(<span class="number">1.0</span>,<span class="number">0.0</span>,<span class="number">0.0</span>);</span><br><span class="line">    fragColor = <span class="built_in">vec4</span>(resultcolor, <span class="number">1.0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Final Effect:<br><img src="/img/OpenGL/ShaderToyMouseInput1.PNG" alt="ShaderToyMouseInput1"><br><img src="/img/OpenGL/ShaderToyMouseInput2.PNG" alt="ShaderToyMouseInput2"></p>
<h2 id="Random-Noise"><a href="#Random-Noise" class="headerlink" title="Random Noise"></a>Random Noise</h2><p>这一章讲关于OpenGL Shader里随机数的生成，这里还了解的不清晰，暂时只贴出代码和效果，后续会进一步学习修改。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">float</span> <span class="title">disk</span><span class="params">(vec2 r, vec2 center, <span class="type">float</span> radius, vec3 color, inout vec3 pixel)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   <span class="type">float</span> rtoclength = <span class="built_in">length</span>(r - center);</span><br><span class="line">   <span class="type">float</span> inside = <span class="number">0.0</span>; </span><br><span class="line">   <span class="keyword">if</span>(rtoclength &lt; radius)</span><br><span class="line">   &#123;</span><br><span class="line">      <span class="comment">//pixel = vec3(clamp(rtoclength, radius / 4.0,radius / 2.0));   </span></span><br><span class="line">      inside = <span class="number">1.0</span> - <span class="built_in">smoothstep</span>(radius - <span class="number">0.005</span>,radius + <span class="number">0.005</span>, rtoclength);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> inside;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">mainImage</span><span class="params">( out vec4 fragColor, in vec2 fragCoord )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    vec2 p = <span class="built_in">vec2</span>(fragCoord.xy / iResolution.xy);</span><br><span class="line">  	vec2 r = <span class="built_in">vec2</span>( fragCoord.xy - <span class="number">0.5</span>*iResolution.xy );</span><br><span class="line">	r = <span class="number">2.0</span> * r.xy / iResolution.y;</span><br><span class="line">    vec3 backgroundcolor = <span class="built_in">vec3</span>(<span class="number">0.0</span>,<span class="number">0.0</span>,<span class="number">0.0</span>);</span><br><span class="line">    vec3 resultcolor = backgroundcolor;</span><br><span class="line">    <span class="type">float</span> widthratio = iResolution.x / iResolution.y;</span><br><span class="line">    vec2 center;</span><br><span class="line">    vec2 pos;</span><br><span class="line">	<span class="keyword">for</span>(<span class="type">float</span> i = <span class="number">0.0</span>; i &lt; <span class="number">6.0</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 这里有一点要注意，</span></span><br><span class="line">        <span class="comment">// 我们需要将随机数映射到正确的宽高映射值才能正确随机显示在整个屏幕上</span></span><br><span class="line">        pos = <span class="built_in">vec2</span>(<span class="number">2.0</span> * widthratio * <span class="built_in">hash</span>(i) - widthratio, <span class="number">2.0</span> * <span class="built_in">hash</span>(i + <span class="number">0.5</span>) - <span class="number">1.0</span>);</span><br><span class="line">    	center = pos;</span><br><span class="line">    	resultcolor += <span class="built_in">disk</span>(r, center, <span class="built_in">hash</span>(i * <span class="number">5.0</span> + <span class="number">10.0</span>) / <span class="number">5.0</span>, <span class="built_in">vec3</span>(<span class="number">1.0</span>, <span class="number">0.0</span>, <span class="number">0.0</span>), resultcolor) * <span class="built_in">vec3</span>(<span class="number">1.0</span>, <span class="number">0.0</span>, <span class="number">0.0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    fragColor = <span class="built_in">vec4</span>(resultcolor, <span class="number">1.0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Final Effect:<br><img src="/img/OpenGL/ShaderToyRandomNumber.PNG" alt="ShaderToyRandomNumber"></p>
<h2 id="更多学习待更新"><a href="#更多学习待更新" class="headerlink" title="更多学习待更新"></a>更多学习待更新</h2><p>……</p>
<h1 id="Shader-Toy-Relative-Knowledge"><a href="#Shader-Toy-Relative-Knowledge" class="headerlink" title="Shader Toy Relative Knowledge"></a>Shader Toy Relative Knowledge</h1><h2 id="Shader-Toy-Inputs"><a href="#Shader-Toy-Inputs" class="headerlink" title="Shader Toy Inputs"></a>Shader Toy Inputs</h2><p><img src="/img/OpenGL/ShaderToyInputs.PNG" alt="ShaderToyInputs"></p>
<p>总的来说ShaderToy是一个很好的Shader学习网站，让我们可以在上面方便可视化的测试一些数学算式和算法效果。</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Rendering/">Rendering</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Shader/">Shader</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/03/13/Unity仿COC/" title="Unity仿COC" itemprop="url">Unity仿COC</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Tony Tang" target="_blank" itemprop="author">Tony Tang</a>
		
  <p class="article-time">
    <time datetime="2016-03-13T11:14:35.000Z" itemprop="datePublished"> 发表于 2016-03-13</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="Preface-序言"><a href="#Preface-序言" class="headerlink" title="Preface(序言)"></a>Preface(序言)</h1><h2 id="What-is-COC"><a href="#What-is-COC" class="headerlink" title="What is COC?"></a>What is COC?</h2><p>COC(Clash of Clans) is a freemium mobile MMO strategy video game developed and published by Supercell.The game was released for iOS platforms on 2 August, 2012,[1] and on Google Play for Android on 7 October, 2013<br>(<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Clash_of_Clans">from wiki</a>)</p>
<h2 id="My-COC-Experience"><a href="#My-COC-Experience" class="headerlink" title="My COC Experience"></a>My COC Experience</h2><p>我第一次接触COC大概是在2014年2月份，当时被朋友拉着一起玩这个游戏，三个人建立了自己的小部落，后来陆陆续续拉了不少朋友加入，口口相传，部落成长到40人的部落，从此以后就一发不可收拾。<br>这款游戏最吸引我的地方有以下几点：</p>
<ol>
<li>游戏时间碎片化（采用真实时间计时），不需要玩家长时间在线。</li>
<li>线上进攻布局，线下防守的玩法。</li>
<li>不同兵种和法术的不同特性使得玩家的手法和路线规划显得尤为重要（后来出的部落战尤其体现了这一点）。</li>
<li>部落的概念，增强了集体的概念和玩家间的互动（分享进攻防守记录，打部落战，聊天，捐兵等）</li>
<li>资深COC玩家来说，游戏的种树文化也不得不说是一种游戏乐趣。</li>
</ol>
<p>贴一张我的COC图已做留念<br><img src="/img/Unity/MyCOC.PNG" alt="My COC"></p>
<p>为了这个游戏还买过COC模型<br><img src="/img/Unity/COCModel.JPG" alt="COC Model"></p>
<p>经历了两年多的COC洗礼，经历了部落解散，部落合并，到现在最后一起坚持到最后的7,8个小伙伴（基本都满防满王了），感慨万千（此处省略一万字）。</p>
<p>出于自己是做游戏开发的缘故，刚开始学习Unity（同时学习C#），所以决定以COC为模板来制作学习Unity。就这样我的Unity COC计划就这样开始了，虽然最后只实现了很小一部分东西（而且很不完美，但学到很多东西），所以写下这个篇文章来总结自己学到的一些东西。</p>
<h1 id="COC-Project-Unity"><a href="#COC-Project-Unity" class="headerlink" title="COC Project(Unity)"></a>COC Project(Unity)</h1><h2 id="Preparation"><a href="#Preparation" class="headerlink" title="Preparation"></a>Preparation</h2><h3 id="Unity"><a href="#Unity" class="headerlink" title="Unity"></a>Unity</h3><p>(<a href="http://tonytang1990.github.io/2015/07/15/Unity-Study/">Unity Study</a>)</p>
<h3 id="Programming-Language-C"><a href="#Programming-Language-C" class="headerlink" title="Programming Language(C#)"></a>Programming Language(C#)</h3><p>(<a href="http://tonytang1990.github.io/2015/08/15/CSharp-Study/">C# Study</a>)</p>
<p>参考书籍：<br><a target="_blank" rel="noopener" href="http://download.csdn.net/download/baiyu9821179/4282298">C#入门经典第五版</a><br>CLR Via C# Fourth Edition - Jeffrey Richter</p>
<h3 id="AI"><a href="#AI" class="headerlink" title="AI"></a>AI</h3><p>(<a href="http://tonytang1990.github.io/2015/10/14/Artificial-Inteligence-Study/">Artificial-Inteligence-Study</a>)</p>
<h3 id="Knowledge"><a href="#Knowledge" class="headerlink" title="Knowledge"></a>Knowledge</h3><h4 id="Is-COC-a-2D-game-or-3D-game"><a href="#Is-COC-a-2D-game-or-3D-game" class="headerlink" title="Is COC a 2D game or 3D game?"></a>Is COC a 2D game or 3D game?</h4><p>The answer is 2D game，actually we should call 2.5D.<br>第一眼看到COC里面的所有动画人物给人的感觉都是3D的，但后来知道了Isometric Tileset Engine的概念。</p>
<h4 id="Isometric-Tileset-Engine"><a href="#Isometric-Tileset-Engine" class="headerlink" title="Isometric Tileset Engine"></a>Isometric Tileset Engine</h4><h5 id="What-is-Isometric-Tileset-Engine"><a href="#What-is-Isometric-Tileset-Engine" class="headerlink" title="What is Isometric Tileset Engine?"></a>What is Isometric Tileset Engine?</h5><p>(<a target="_blank" rel="noopener" href="http://blog.codingnow.com/2014/01/isometric_tileset_engine.html">斜视角游戏的地图渲染</a>)<br>(<a target="_blank" rel="noopener" href="http://flarerpg.org/tutorials/isometric_intro/">Isometric Tiles Introduction</a>)<br>结合上述文章，我们可以知道，Isometric Tileset Engine主要是通过美术制作出Isometric Projection（we angle our camera along two axes (swing the camera 45 degrees to one side, then 30 degrees down)）的2D图片来实现游戏的3D效果（2.5D）。</p>
<h5 id="What-does-game-with-isometric-projection-look-like"><a href="#What-does-game-with-isometric-projection-look-like" class="headerlink" title="What does game with isometric projection look like?"></a>What does game with isometric projection look like?</h5><p>典型的Isometric Projection游戏有：<br>Age of Empires<br><img src="/img/Unity/AgeOfEmpires.PNG" alt="Age of Empires"><br>Diablo 2<br><img src="/img/Unity/Diablo2.PNG" alt="Diablo2"></p>
<h5 id="How-to-make-game-work-under-isometric-projection"><a href="#How-to-make-game-work-under-isometric-projection" class="headerlink" title="How to make game work under isometric projection?"></a>How to make game work under isometric projection?</h5><p>(<a target="_blank" rel="noopener" href="http://gamedevelopment.tutsplus.com/tutorials/creating-isometric-worlds-a-primer-for-game-developers--gamedev-6511">参考:Creating Isometric Worlds: A Primer for Game Developers</a>)<br>从标准的2D游戏到isometric projection的2.5D注意事项</p>
<ol>
<li>Coordinates Transformation – From Cartesian to isometric coordiates</li>
<li>Creating the Art – isometric projection art</li>
<li>Collision Detection – based on rectangle that is caculated from isometric projection</li>
</ol>
<h3 id="Searching"><a href="#Searching" class="headerlink" title="Searching"></a>Searching</h3><h4 id="How-to-develope-COC-like-game"><a href="#How-to-develope-COC-like-game" class="headerlink" title="How to develope COC like game?"></a>How to develope COC like game?</h4><p>云风参与开发的陌陌争霸<br>(<a target="_blank" rel="noopener" href="http://blog.codingnow.com/2014/01/routemap.html">参考:COC Like 游戏中的寻路算法</a>)<br>从上面我们可以看出通过对不同建筑队不同兵种的路径的预算，我们可以在在城墙未被破坏的前提下实现O(1)的速度查询建筑距离信息。（但这里我没明白云风大哥所说的”如果下一个行军路线是城墙就攻打城墙” – 这个前提下怎么实现远距离攻打城墙的效果，所以最终并未采取这种方式实现）。</p>
<h2 id="Project"><a href="#Project" class="headerlink" title="Project"></a>Project</h2><h3 id="Game-Engine"><a href="#Game-Engine" class="headerlink" title="Game Engine"></a>Game Engine</h3><p>Unity</p>
<h3 id="Programming-Language"><a href="#Programming-Language" class="headerlink" title="Programming Language"></a>Programming Language</h3><p>C#</p>
<h3 id="Developer-Tool"><a href="#Developer-Tool" class="headerlink" title="Developer Tool"></a>Developer Tool</h3><p>Unity<br>VS2013 &#x2F; VS2010 (IDE)<br>ILDissembler – 反编译工具<br>Blender – 建模工具（本来打算学习并使用这个，但由于游戏最终并未做出来，都只是使用Unity官网的一些现有模型）<br>Git – 版本控制<br><a target="_blank" rel="noopener" href="https://github.com/TonyTang1990/PathFinding/commits/master">项目地址</a></p>
<h3 id="Basic-Setting-with-Scene"><a href="#Basic-Setting-with-Scene" class="headerlink" title="Basic Setting with Scene"></a>Basic Setting with Scene</h3><p>Scene – 3D Scene(考虑2.5D素材的缘故，直接采用3D场景来学习制作2.5D游戏)<br>Camera – Orthographic Projection(通过采用正交投影并旋转摄像机X轴35度，Y轴45度来模拟Isometric Projection)</p>
<h3 id="Camera-Control-Input"><a href="#Camera-Control-Input" class="headerlink" title="Camera Control &amp; Input"></a>Camera Control &amp; Input</h3><h4 id="PC"><a href="#PC" class="headerlink" title="PC"></a>PC</h4><p>PC主要通过GetAxis()来针对用户的上下左右控制</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">float</span> moveHorizontal = Input.GetAxis (<span class="string">&quot;Horizontal&quot;</span>) * mMoveSpeed * Time.deltaTime;</span><br><span class="line"><span class="built_in">float</span> moveVertical = Input.GetAxis (<span class="string">&quot;Vertical&quot;</span>) * mMoveSpeed * Time.deltaTime;</span><br></pre></td></tr></table></figure>

<h4 id="Mobile"><a href="#Mobile" class="headerlink" title="Mobile"></a>Mobile</h4><p>Mobile主要通过Input.touch来获取屏幕点击事件信息<br>遇到得问题：<br><strong>点击到UI上的时候touch事件并未被吞噬</strong><br>Solved – 通过UnityEngine.EventSystems.EventSystem.current.IsPointerOverGameObject(Input.touches[0].fingerId)来判断是否点击到UI上<br>e.g.</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">f (!UnityEngine.EventSystems.EventSystem.current.IsPointerOverGameObject (Input.touches[<span class="number">0</span>].fingerId));</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>单指和多指的处理<br>通过Input.touchCount分别作处理，多指的处理主要通过遍历Input.touches来判断多指的具体行为<br>遇到的问题：<br><strong>单指相应速度过快</strong><br>Solved – 通过定义一个有效的单指响应时间，只有当每帧DeltaTime时间叠加超过有效响应时间的时候才响应输入<br>e.g.</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Update</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">	mInputTimer += Time.deltaTime;</span><br><span class="line">	<span class="keyword">if</span> (Input.touchCount == <span class="number">1</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span>(Input.touches[<span class="number">0</span>].phase == TouchPhase.Ended &amp;&amp; (mInputTimer &gt; mValidInputDeltaTime))</span><br><span class="line">		&#123;</span><br><span class="line">			......</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>两根手指如何判断是拉远还是缩近地图</strong><br>Solved – 主要通过判断两根手指每一帧的距离是变大还是变小来判断<br>e.g.</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; i++)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (Input.touches[i].phase == TouchPhase.Began)</span><br><span class="line">    &#123;</span><br><span class="line">        mCurrentTouchFingerPos[i] = Input.touches[<span class="number">0</span>].position;</span><br><span class="line">        mPreTouchFingerPos[i] = Input.touches[<span class="number">0</span>].position;</span><br><span class="line">        mTouchFingerDeltaPos[i] = Vector2.zero;</span><br><span class="line">        <span class="keyword">if</span> (i == <span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            mPreTwoFingersDistance = mCurrentTwoFingersDistance;</span><br><span class="line">            mCurrentTwoFingersDistance = Vector2.Distance(mCurrentTouchFingerPos[<span class="number">0</span>], mCurrentTouchFingerPos[<span class="number">1</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (Input.touches[i].phase == TouchPhase.Moved)</span><br><span class="line">    &#123;</span><br><span class="line">        mPreTouchFingerPos[i] = mCurrentTouchFingerPos[i];</span><br><span class="line">        mCurrentTouchFingerPos[i] = Input.touches[i].position;</span><br><span class="line">        mTouchFingerDeltaPos[i] = Input.touches[i].deltaPosition;</span><br><span class="line">        <span class="keyword">if</span> (i == <span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            mPreTwoFingersDistance = mCurrentTwoFingersDistance;</span><br><span class="line">            mCurrentTwoFingersDistance = Vector2.Distance(mCurrentTouchFingerPos[<span class="number">0</span>], mCurrentTouchFingerPos[<span class="number">1</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (Input.touches[i].phase == TouchPhase.Ended)</span><br><span class="line">    &#123;</span><br><span class="line">        mCurrentTouchFingerPos[i] = Vector2.zero;</span><br><span class="line">        mPreTouchFingerPos[i] = Vector2.zero;</span><br><span class="line">        mTouchFingerDeltaPos[i] = Vector2.zero;</span><br><span class="line">        mCurrentTwoFingersDistance = <span class="number">0.0f</span>;</span><br><span class="line">        mPreTwoFingersDistance = <span class="number">0.0f</span>;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="UI"><a href="#UI" class="headerlink" title="UI"></a>UI</h3><p>UI主要使用Unity自带的UI，主要以一个按钮一个方法响应的基本方式。</p>
<p>UI有几个重要的概念：</p>
<ol>
<li>Unity里所有的UI elements都是包含在Canvas里。</li>
<li>UI的Render Mode主要分为三种<br> 2.1 Screen Space – Overlay(Rendered on top of the secene)<br> 2.2 Screen Space – Camera(有距离感的UI，受摄像机设置影响)<br> 2.3 World Space(3D UI,有深度概念，会被3D物体遮挡)</li>
</ol>
<p>UI自适应里的重要概念：</p>
<ol>
<li>UI Scale Mode<br> 1.1 Constant Pixel Size<br> 1.2 Scale With Screen Size(自适应里比较重的一种，会根据设定分辨率比例自动扩大或缩小UI)<br> 1.3 Constant Physical Size</li>
<li>Anchors – 这个我的理解是根据锚点的四个点相对父节点位置的设置，会决定子节点UI如何针对父节点的变化而变化<br>比如锚点的四个点分别位于父节点的四个角落，那就表示子节点UI会根据父节点的放大缩小做出一致的变化。<br>比如锚点的四个点都在父节点的四个角落中的一个角落，就表示，无论父节点如何变化，子节点UI都不会变化并且相对于父节点锚点的那个点的相对位置是不变的。</li>
</ol>
<p><a target="_blank" rel="noopener" href="http://docs.unity3d.com/Manual/UISystem.html">更多的UI概念参考官网学习</a></p>
<h3 id="Map"><a href="#Map" class="headerlink" title="Map"></a>Map</h3><h4 id="Map-Type"><a href="#Map-Type" class="headerlink" title="Map Type"></a>Map Type</h4><p>Tile Map<br>地图是基于一块一块的Tile构成，默认40 * 40</p>
<h4 id="Map-Save"><a href="#Map-Save" class="headerlink" title="Map Save"></a>Map Save</h4><p>C# System.Runtime.Serialization – 序列化来存储Map数据<br>Unity [System.Serializable] – 支持在编辑器可视化</p>
<p>遇到的问题：</p>
<ol>
<li>Unity一些自带的基础类型不支持Serializable<br>e.g. UnityEngine.Vector3(is not marked as Serializable)<br>Solved – 需要自定义Seralizable的Struct来封装Vector3数据</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">Serializable</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">struct</span> BuildingPosition</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">float</span> mX;</span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">float</span> mY;</span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">float</span> mZ;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>Unity挂载和类继承问题<br>Unity要挂载到GameObject上必须继承至MonoBehaviour,但C#不支持多重继承<br>Solved – 定义interface，通过extends interface来实现C#中的多重继承（这一点和Java很像）</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">GameObjectType</span> &#123;</span><br><span class="line">	ObjectType GameType</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">get</span>;</span><br><span class="line">		<span class="keyword">set</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[<span class="meta">Serializable</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Building</span> : <span class="title">MonoBehaviour</span>, <span class="title">GameObjectType</span> &#123;</span><br><span class="line">	.......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Event-Manager"><a href="#Event-Manager" class="headerlink" title="Event Manager"></a>Event Manager</h3><p>主要用于事件监听。（UnityAction是无参并返回void类型的的Delegate）<br>遇到的问题：</p>
<ol>
<li>对于带参数的事件监听<br>Solved – 通过继承UnityEvent<T>实现带特定参数的Delegate监听</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine.Events;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MyIntEvent</span> : <span class="title">UnityEvent</span>&lt;<span class="title">int</span>&gt;</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">EventManager</span> : <span class="title">MonoBehaviour</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Dictionary&lt;<span class="built_in">string</span>, UnityEvent&gt; mEventDictionary;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Dictionary&lt;<span class="built_in">string</span>, MyIntEvent&gt; mIntEventDictionary;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> EventManager mEMInstance = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Awake</span>()</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (mEMInstance == <span class="literal">null</span>) &#123;</span><br><span class="line">			mEMInstance = <span class="keyword">this</span>;</span><br><span class="line">			mEMInstance.Init();</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (mEMInstance != <span class="keyword">this</span>) &#123;</span><br><span class="line">			Destroy(gameObject);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Init</span>()</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (mEventDictionary == <span class="literal">null</span>) &#123;</span><br><span class="line">			mEventDictionary = <span class="keyword">new</span> Dictionary&lt;<span class="built_in">string</span>, UnityEvent&gt;();</span><br><span class="line">		&#125;</span><br><span class="line">        <span class="keyword">if</span> (mIntEventDictionary == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            mIntEventDictionary = <span class="keyword">new</span> Dictionary&lt;<span class="built_in">string</span>, MyIntEvent&gt;();</span><br><span class="line">        &#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">StartListening</span>(<span class="params"><span class="built_in">string</span> eventname, UnityAction listener</span>)</span></span><br><span class="line">	&#123;</span><br><span class="line">		UnityEvent evt = <span class="literal">null</span>;</span><br><span class="line">		<span class="keyword">if</span> (mEMInstance.mEventDictionary.TryGetValue (eventname, <span class="keyword">out</span> evt)) &#123;</span><br><span class="line">			evt.AddListener (listener);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			evt = <span class="keyword">new</span> UnityEvent();</span><br><span class="line">			evt.AddListener(listener);</span><br><span class="line">			mEMInstance.mEventDictionary.Add(eventname, evt);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">StopListening</span>(<span class="params"><span class="built_in">string</span> eventname, UnityAction listener</span>)</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (mEMInstance == <span class="literal">null</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span> ;</span><br><span class="line">		&#125;</span><br><span class="line">		UnityEvent thisevent = <span class="literal">null</span>;</span><br><span class="line">		<span class="keyword">if</span> (mEMInstance.mEventDictionary.TryGetValue (eventname, <span class="keyword">out</span> thisevent)) &#123;</span><br><span class="line">			thisevent.RemoveListener(listener);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">StartListening</span>(<span class="params"><span class="built_in">string</span> eventname, UnityAction&lt;<span class="built_in">int</span>&gt; listener</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        MyIntEvent evt = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (mEMInstance.mIntEventDictionary.TryGetValue(eventname, <span class="keyword">out</span> evt))</span><br><span class="line">        &#123;</span><br><span class="line">            evt.AddListener(listener);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            evt = <span class="keyword">new</span> MyIntEvent();</span><br><span class="line">            evt.AddListener(listener);</span><br><span class="line">            mEMInstance.mIntEventDictionary.Add(eventname, evt);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">StopListening</span>(<span class="params"><span class="built_in">string</span> eventname, UnityAction&lt;<span class="built_in">int</span>&gt; listener</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (mEMInstance == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        MyIntEvent thisevent = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (mEMInstance.mIntEventDictionary.TryGetValue(eventname, <span class="keyword">out</span> thisevent))</span><br><span class="line">        &#123;</span><br><span class="line">            thisevent.RemoveListener(listener);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">HasListening</span>(<span class="params"><span class="built_in">string</span> eventname</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (mEMInstance == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        UnityEvent thisevent = <span class="literal">null</span>;</span><br><span class="line">        MyIntEvent intevent = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (mEMInstance.mEventDictionary.TryGetValue(eventname, <span class="keyword">out</span> thisevent))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(thisevent != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mEMInstance.mIntEventDictionary.TryGetValue(eventname, <span class="keyword">out</span> intevent))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (intevent != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">TriggerEvent</span>(<span class="params"><span class="built_in">string</span> eventname, <span class="built_in">int</span> p = <span class="number">0</span></span>)</span></span><br><span class="line">	&#123;</span><br><span class="line">		UnityEvent thisevent = <span class="literal">null</span>;</span><br><span class="line">		<span class="keyword">if</span> (mEMInstance.mEventDictionary.TryGetValue (eventname, <span class="keyword">out</span> thisevent)) &#123;</span><br><span class="line">			<span class="keyword">if</span>(thisevent != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                thisevent.Invoke();</span><br><span class="line">            &#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">        MyIntEvent intevent = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (mEMInstance.mIntEventDictionary.TryGetValue(eventname, <span class="keyword">out</span> intevent))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (intevent != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                intevent.Invoke(p);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Object-Pool"><a href="#Object-Pool" class="headerlink" title="Object Pool"></a>Object Pool</h3><p>主要为了重用GameObject，减少Instantiate的调用。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ObjectPoolManager</span> : <span class="title">MonoBehaviour</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ObjectPoolManager mObjectPoolManagerInstance = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> GameObject mBuildingBullet;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> mBBulletPoolAmount = <span class="number">20</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;GameObject&gt; mBBulletsList;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> GameObject mSoldierBullet;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> mSBulletPoolAmount = <span class="number">50</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;GameObject&gt; mSBulletsList;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">bool</span> mWillGrow = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Awake</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (mObjectPoolManagerInstance == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            mObjectPoolManagerInstance = <span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (mObjectPoolManagerInstance != <span class="keyword">this</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Destroy(gameObject);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Start</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mBBulletsList = <span class="keyword">new</span> List&lt;GameObject&gt;();</span><br><span class="line">        mSBulletsList = <span class="keyword">new</span> List&lt;GameObject&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; mBBulletPoolAmount; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            GameObject bbulletobj = Instantiate(mBuildingBullet) <span class="keyword">as</span> GameObject;</span><br><span class="line">            bbulletobj.SetActive(<span class="literal">false</span>);</span><br><span class="line">            mBBulletsList.Add(bbulletobj);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> j = <span class="number">0</span>; j &lt; mSBulletPoolAmount; j++)</span><br><span class="line">        &#123;</span><br><span class="line">            GameObject sbulletobj = Instantiate(mSoldierBullet) <span class="keyword">as</span> GameObject;</span><br><span class="line">            sbulletobj.SetActive(<span class="literal">false</span>);</span><br><span class="line">            mSBulletsList.Add(sbulletobj);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> GameObject <span class="title">GetBuildingBulletObject</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; mBBulletsList.Count; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (!mBBulletsList[i].activeInHierarchy)</span><br><span class="line">            &#123;</span><br><span class="line">                mBBulletsList[i].SetActive(<span class="literal">true</span>);</span><br><span class="line">                <span class="keyword">return</span> mBBulletsList[i];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mWillGrow)</span><br><span class="line">        &#123;</span><br><span class="line">            GameObject bbulletobj = Instantiate(mBuildingBullet) <span class="keyword">as</span> GameObject;</span><br><span class="line">            mBBulletsList.Add(bbulletobj);</span><br><span class="line">            <span class="keyword">return</span> bbulletobj;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> GameObject <span class="title">GetSoldierBulletObject</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; mSBulletsList.Count; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (!mSBulletsList[i].activeInHierarchy)</span><br><span class="line">            &#123;</span><br><span class="line">                mSBulletsList[i].SetActive(<span class="literal">true</span>);</span><br><span class="line">                <span class="keyword">return</span> mSBulletsList[i];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mWillGrow)</span><br><span class="line">        &#123;</span><br><span class="line">            GameObject sbulletobj = Instantiate(mSoldierBullet) <span class="keyword">as</span> GameObject;</span><br><span class="line">            mSBulletsList.Add(sbulletobj);</span><br><span class="line">            <span class="keyword">return</span> sbulletobj;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Utilities"><a href="#Utilities" class="headerlink" title="Utilities"></a>Utilities</h3><ol>
<li>FPS Display(用于显示FPS)</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> UnityEngine.UI;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">FPSDisplay</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">public</span> Text mFPSText;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="built_in">float</span> mDeltaTime = <span class="number">0.0f</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="built_in">float</span> mFPS = <span class="number">0.0f</span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Update</span>()</span></span><br><span class="line">	&#123;</span><br><span class="line">		mDeltaTime += (Time.deltaTime - mDeltaTime) * <span class="number">0.1f</span>;</span><br><span class="line">		<span class="built_in">float</span> msec = mDeltaTime * <span class="number">1000.0f</span>;</span><br><span class="line">		mFPS = <span class="number">1.0f</span> / mDeltaTime;</span><br><span class="line">		mFPSText.text = <span class="built_in">string</span>.Format(<span class="string">&quot;&#123;0:0.0&#125; ms (&#123;1:0.&#125; fps)&quot;</span>, msec, mFPS);</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>Time Counter(用于计算时间消耗 – 比如A Star运算时间)</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Diagnostics;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TimerCounter</span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> TimerCounter TCInstance = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Stopwatch mTimer;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="built_in">string</span> mName;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">float</span> TimeSpend</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">get</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">return</span> mTimer.ElapsedMilliseconds;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">private</span> <span class="built_in">float</span> mTimeSpend;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> TimerCounter <span class="title">CreateInstance</span>()</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (TCInstance == <span class="literal">null</span>) &#123;</span><br><span class="line">			TCInstance = <span class="keyword">new</span> TimerCounter();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> TCInstance;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">DestroyInstance</span>()</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (TCInstance != <span class="literal">null</span>) &#123;</span><br><span class="line">			TCInstance = <span class="literal">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="title">TimerCounter</span>()</span></span><br><span class="line">	&#123;</span><br><span class="line">		mTimer = <span class="keyword">new</span> Stopwatch ();</span><br><span class="line">		mName = <span class="string">&quot;Default&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Start</span>(<span class="params"><span class="built_in">string</span> name</span>)</span></span><br><span class="line">	&#123;</span><br><span class="line">		mName = name;</span><br><span class="line">		mTimer.Start ();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Restart</span>(<span class="params"><span class="built_in">string</span> name</span>)</span></span><br><span class="line">	&#123;</span><br><span class="line">		mTimer.Reset ();</span><br><span class="line">		mTimer.Start ();</span><br><span class="line">		mName = name;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">End</span>()</span></span><br><span class="line">	&#123;</span><br><span class="line">		mTimer.Stop ();</span><br><span class="line"></span><br><span class="line">		mTimeSpend = mTimer.ElapsedMilliseconds;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="AI-1"><a href="#AI-1" class="headerlink" title="AI"></a>AI</h3><ol>
<li>FSM(Finite State Machine – 有限状态机)<br>通过把行为体的行为细分到几种状态来抽象行为体行为，不同状态的AI逻辑在对应的状态去编写。<br>下图来源：《Artificial Intelligence for Game》 – Ian Millington<br><img src="/img/Unity/FSM.PNG" alt="FSM"><br>游戏里把士兵的状态分为三种，MoveState, AttackState, IdleState。</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">SoldierAttackState</span> : <span class="title">SoldierState</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Soldier mSoldier; </span><br><span class="line"></span><br><span class="line">	......</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">SoldierAttackState</span> : <span class="title">SoldierState</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Soldier mSoldier; </span><br><span class="line"></span><br><span class="line">	......</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">SoldierAttackState</span> : <span class="title">SoldierState</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Soldier mSoldier; </span><br><span class="line"></span><br><span class="line">	......</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[<span class="meta">Serializable</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Soldier</span> : <span class="title">MonoBehaviour</span>, <span class="title">GameObjectType</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> SoldierState SCurrentState</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">set</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (mSCurrentState != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                mSCurrentState.ExitState();</span><br><span class="line">            &#125;</span><br><span class="line">            mSCurrentState = <span class="keyword">value</span>;</span><br><span class="line">            mSCurrentState.EnterState();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    [<span class="meta">HideInInspector</span>]</span><br><span class="line">    <span class="keyword">private</span> SoldierState mSCurrentState;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">HideInInspector</span>]</span><br><span class="line">    <span class="keyword">public</span> SoldierAttackState mSAttackState;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">HideInInspector</span>]</span><br><span class="line">    <span class="keyword">public</span> SoldierDeadState mSDeadState;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">HideInInspector</span>]</span><br><span class="line">    <span class="keyword">public</span> SoldierMoveState mSMoveState;</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Awake</span>()</span></span><br><span class="line">	&#123;</span><br><span class="line">	    mSAttackState = <span class="keyword">new</span> SoldierAttackState(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">	    mSMoveState = <span class="keyword">new</span> SoldierMoveState(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">	    mSDeadState = <span class="keyword">new</span> SoldierDeadState(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">	    ......</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Update</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (gameObject)</span><br><span class="line">        &#123;</span><br><span class="line">            mSCurrentState.UpdateState();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>Decision Trees(决策树 – 用于简单的AI(Decision making))<br>Decision Trees主要用于AI体做决策，通过对已知数据的分析判断，根据Decision Tree抉择出最终的决定（即AI行为）。（项目里我主要使用FSM而非Decision Trees）<br>下图来源：《Artificial Intelligence for Game》 – Ian Millington<br><img src="/img/Unity/AI_DecisionTree.PNG" alt="Decision Tree"></li>
<li>A Star(A Star是 <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Dijkstra's_algorithm">Dijkstra</a>（著名的最短路径算法）基础上通过一个启发因子来预估给定节点到目标节点的距离来使得路径节点搜索是向目标节点方向逼近不至于出现搜索大量无效节点的情况)<br>(<a href="http://tonytang1990.github.io/2015/10/14/Artificial-Inteligence-Study/">AI相关学习</a>)</li>
</ol>
<h4 id="A-Star"><a href="#A-Star" class="headerlink" title="A Star"></a>A Star</h4><h5 id="Searching-1"><a href="#Searching-1" class="headerlink" title="Searching"></a>Searching</h5><p>通过搜索，我发现网络上有现成的很完善的A Star的版本<br><a target="_blank" rel="noopener" href="http://arongranberg.com/astar/">A Star Pathfinding Project(Asset)</a><br>但通过使用后发现，里面所支持的Four,Six and Eight connections都不符合我的需求（每个点都和周围的八个点连通），所以最终放弃了A Star Pathfinding Project而决定自己实现自己的A Star Pathfinding</p>
<h5 id="Create-Myself-A-Star"><a href="#Create-Myself-A-Star" class="headerlink" title="Create Myself A Star"></a>Create Myself A Star</h5><h6 id="A-Star-Preperation"><a href="#A-Star-Preperation" class="headerlink" title="A Star Preperation"></a>A Star Preperation</h6><p>结合<a href="http://tonytang1990.github.io/2015/10/14/Artificial-Inteligence-Study/">Artificial-Inteligence-Study</a>的学习，让我们了解下A Star里的一些基本概念和核心思想：<br>A Star属于什么图？<br>A Star里的图属于导航图（Navigation Graph），是基于开销的图搜索(cost-based graph searches)</p>
<p>导航图信息的数据存储？<br>邻接矩阵：<br>![Adjacency _Matrix](&#x2F;img&#x2F;AI&#x2F;Adjacency _Matrix.PNG)<br>邻接表：<br><img src="/img/AI/Adjacency_List.PNG" alt="Adjacency_List"><br>邻接表用于存储稀疏图非常有效，不会浪费空间来存储空链接。(邻接矩阵会存储大量无效数据(没有连接的边))<br>这里我们只需要每个点和周边的8个点相连接，所以可以定位成稀疏图。<br>当我们初始化地图数据的时候，会把所有的点和边以及点和周边相连接边等信息存储起来。<br>大部分操作都是插入和查询(一般不涉及删除，一旦地图创建好，一般只是修改节点信息而非删除节点(如果真要删除可以通过设定节点信息为INVALID_INDEX来实现而非真正删除))。<br>为了快速查询我们采用C#里的List &lt; Node &gt; 和List &lt; List &lt; Edge &gt; &gt;来存储节点信息和边连接信息。因为我们会用一个唯一的index去标识节点，所以当我们用节点index去访问节点数据的时候是O(1)的时间复杂度，添加节点到List里也是O(1)。同理，当我们用List &lt; List &lt; Edge &gt; &gt;来存储边连接信息(邻接表)的时候，我们可以通过List[index]去访问特定节点的边连接信息(O(1)，对于边连接信息的添加和删除(这里不是O(1)主要是因为添加的时候我们需要确保不会重复添加同一个边连接信息，删除的时候要去查询找到该边连接信息)<br>这样一来所有的节点和边链接信息就都存储起来了。</p>
<p>图搜索(寻路)是怎样基于图实现的了？<br>首先我们要明确我们的搜索目的，为什么这样说了，只有明确了搜索目的我们才能制定合理的搜索策略。<br>在之前的学习<a href="http://tonytang1990.github.io/2015/10/14/Artificial-Inteligence-Study/">Artificial-Inteligence-Study</a>中提到了盲目搜索(基于广度(Stack来模拟FILO)或者深度的搜索策略(Queue来模拟FIFO))和基于开销的搜索(最短路径开销的策略)。<br>因为这里我是为了找到最短路径，所以肯定采用的是基于开销的搜索策略。<br>基于开销的搜索策略的一个重要思想是边放松，边放松的核心思想是通过存储源节点到其他节点的最短路径信息，一边探索新边一边更新该最短路径信息(如果新的边加入导致A节点到B节点有更优的最短路径，那么就更新该A节点到B节点的最短路径信息。直到找到从源节点到目标节点的最短路径信息为止。)</p>
<p>SPT(Shortest Path Tree – 最短路径树)存储的就是源节点到其他节点的最短路径信息(只存储了搜索过的)。(List<Edge>的方式存储起来，比如源节点是0，目标节点是8，那么最短路径存储即为List[0] &#x3D; Edge(0,x) List[x] &#x3D; Edge(x,y) …. List[8] &#x3D; Edge(y,8))<br>Edge的抽象Edge(From,To)，From表示初始点，To表示结束点。</p>
<p>知道了最短路径的存储，那么更重要的问题来了，这个最短路径是怎么推导出来的？<br>这里不得不提Dijstra算法和A Star算法。<br>Dijstra步骤 ：</p>
<ol>
<li>从源节点开始搜索，利用优先队列对在搜索的节点的GCost(源节点到搜索节点的距离)进行排序</li>
<li>Pop出到当前所有搜索过的节点里GCost最小的节点</li>
<li>添加到该节点的行进边作为抵达该节点的最短路径边(包含在SPT里)</li>
<li>基于该节点进行扩展搜索</li>
<li>如果在扩展搜索时有到该节点更短(GCost)的路线边出现就更新该点的GCost以及行进边信息</li>
<li>继续弹出搜索节点里GCost最小的节点</li>
<li>直到搜索到目标节点为止</li>
<li>最后通过最短路径树(SPT)从目标节点反推得出源节点到目标节点的最短路径行进路线</li>
</ol>
<p>Dijstra算法的缺点：<br>Dijkstra算法检查了太多的边。</p>
<p>Dijstra算法改进：<br>A Star – 和Dijkstra算法的唯一区别是对搜索边界上的点的开销(GCost)的计算。因为Dijstra的搜索扩展方向是由GCost决定的，所以A Star算法通过给GCost添加一个启发因子(H)来确保搜索行进方向。<br>F的计算：<br>F &#x3D; G + H<br>G是到达一个节点的累计开销， H是一个启发因子，它给出的是节点到目标节点的估计距离。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//伪代码如下</span></span><br><span class="line"><span class="comment">//添加源节点开始Dijstra算法搜索</span></span><br><span class="line">mPQ.Clear();</span><br><span class="line">mPQ.Push(mFCosts[mISource]);</span><br><span class="line"><span class="comment">//Pop出所有搜索过的节点到目标节点FCost最小的节点</span></span><br><span class="line"><span class="keyword">while</span> (!mPQ.Empty())</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">int</span> nextclosestnode = mPQ.Pop().Key;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//添加当前搜索节点里FCost最小的行进边作为最短路径的边之一</span></span><br><span class="line">    <span class="keyword">if</span> (mSearchFrontier[nextclosestnode] != <span class="literal">null</span> &amp;&amp; mSearchFrontier[nextclosestnode].IsValidEdge())</span><br><span class="line">    &#123;</span><br><span class="line">        mShortestPathTree[nextclosestnode] = mSearchFrontier[nextclosestnode];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//直到找到目标节点为止</span></span><br><span class="line">    <span class="keyword">if</span> (nextclosestnode == mITarget)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//以当前搜索节点里到目标节点最近的点为基准进行边扩展搜索</span></span><br><span class="line">    List&lt;GraphEdge&gt; edgelist = mGraph.EdgesList[nextclosestnode];</span><br><span class="line">    GraphEdge edge;</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; edgelist.Count; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        edge = edgelist[i];</span><br><span class="line">        <span class="comment">//计算该节点到目标节点的H值，用于控制搜索行进方向(A*对Dijstra算法的改进)</span></span><br><span class="line">        <span class="built_in">float</span> hcost = Heuristic_Euclid.Calculate(mGraph, mITarget, edge.To) * mHCostPercentage;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//算出到该节点的路径GCost</span></span><br><span class="line">        <span class="comment">//GCost是源节点到特定节点的实际距离(用于判断是否是源节点到特定节点更近的路线)</span></span><br><span class="line">        <span class="comment">//G+H是源节点通过特定节点到目标节点的预估距离(用于控制行进方向)</span></span><br><span class="line">        <span class="built_in">float</span> gcost = mGCosts[nextclosestnode] + edge.Cost;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//判断搜索行进的节点是否已经有任何搜索边抵达过</span></span><br><span class="line">        <span class="comment">//如果没有抵达过，添加该边到搜索列表里(mSearchFrontier)，并添加更新到该新节点的最短距离GCost和预估距离FCost(GCost+H)</span></span><br><span class="line">        <span class="comment">//同时把该FCost作为该节点通过特定节点到目标节点的估算距离添加到队列里进行排序，</span></span><br><span class="line">        <span class="comment">//用于得出搜索节点里下一个离目标节点最近的节点index</span></span><br><span class="line">        <span class="keyword">if</span> (mSearchFrontier[edge.To] != <span class="literal">null</span> &amp;&amp; !mSearchFrontier[edge.To].IsValidEdge())</span><br><span class="line">        &#123;</span><br><span class="line">            mFCosts[edge.To].Value = gcost + hcost;</span><br><span class="line">            mGCosts[edge.To] = gcost;</span><br><span class="line">            <span class="comment">//添加的是特定节点到目标节点的估算距离G+H来作为排序的依据</span></span><br><span class="line">            mPQ.Push(mFCosts[edge.To]);</span><br><span class="line"></span><br><span class="line">            mSearchFrontier[edge.To] = edge;</span><br><span class="line"></span><br><span class="line">            mAStarPathInfo.EdgesSearched++;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (mBDrawExplorePath)</span><br><span class="line">            &#123;</span><br><span class="line">                Debug.DrawLine(mGraph.Nodes[edge.From].Position, mGraph.Nodes[edge.To].Position, Color.yellow, mExplorePathRemainTime);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//如果抵达过，那么就去判断当前路线(通过当前边到该节点的路线)的GCost是否比之前记录在GCost里到达该节点的GCost更小</span></span><br><span class="line">        <span class="comment">//如果更小就说明有新的更短的路径可以抵达该节点</span></span><br><span class="line">        <span class="comment">//更新到该节点的GCost，FCost用于下一次Pop当前搜索节点里里目标节点最近(FCost)的节点</span></span><br><span class="line">        <span class="comment">//同时更新到该节点的最短路径边</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (gcost &lt; mGCosts[edge.To])</span><br><span class="line">        &#123;</span><br><span class="line">            mFCosts[edge.To].Value = gcost + hcost;</span><br><span class="line">            mGCosts[edge.To] = gcost;</span><br><span class="line"></span><br><span class="line">            mPQ.ChangePriority(edge.To);</span><br><span class="line"></span><br><span class="line">            mSearchFrontier[edge.To] = edge;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面有一个关键的点(PriorityQueue)，用于得到所有搜索节点到目标节点的FCost最小的节点。<br>这里对于节点的操作主要是插入和修改。<br>为了快速得到当前搜索节点里里目标节点的估算距离最近的节点，我们需要对当前所有的搜索节点进行排序。<br>而这里每一次排序的时间复杂度很大程度就决定了A Star的时间消耗。<br>参考<a href="http://tonytang1990.github.io/2015/07/11/Sort-Algorithm/">排序算法概念</a>的学习<br>可以知道借助堆的特性，我们可以很容易的得到最大最小值。<br>原本堆排序要经历下列步骤:</p>
<ol>
<li>Init heap(创建最大堆（Build_Max_Heap）：初始化堆数据)</li>
<li>Adjust heap(最大堆调整（Max_Heapify）：将堆的末端子节点作调整，使得子节点永远小于父节点) – O(Log(n))</li>
<li>Sort heap(堆排序（HeapSort）：移除位在第一个数据的根节点，并做最大堆调整的递归运算) – O(n)<br>但这里我们并不需要对堆进行完整的排序，我们只需每次插入或删除或修改的时候能得到最大或最小值即可(即只需要Adjust Heap即可)<br>这样一来每一次插入，删除或修改都只需O(Log(n))的时间复杂度。</li>
</ol>
<p>了解了理论，接下来一步一步看一下如何实现A Star算法的：<br>首先我们需要抽象出导航图里的节点和边<br>NavGraphNode里的mIsWall和mIsJumpable后续会讲到为什么会有这两个成员变量<br>e.g.</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">GraphEdge</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">GraphEdge</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mFrom = (<span class="built_in">int</span>)E_NODE_INDEX.INVALID_NODE;</span><br><span class="line">        mTo = (<span class="built_in">int</span>)E_NODE_INDEX.INVALID_NODE;</span><br><span class="line">        mCost = <span class="number">0.0f</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> From</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> mFrom;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">set</span></span><br><span class="line">        &#123;</span><br><span class="line">            Debug.Assert(<span class="keyword">value</span> &gt;= <span class="number">0</span>, <span class="string">&quot;mFrom must great or equal to 0&quot;</span>);</span><br><span class="line">            mFrom = <span class="keyword">value</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span> mFrom;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> To</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> mTo;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">set</span></span><br><span class="line">        &#123;</span><br><span class="line">            Debug.Assert(<span class="keyword">value</span> &gt;= <span class="number">0</span>, <span class="string">&quot;mTo must great or equal to 0&quot;</span>);</span><br><span class="line">            mTo = <span class="keyword">value</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span> mTo;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">float</span> Cost</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> mCost;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">set</span></span><br><span class="line">        &#123;</span><br><span class="line">            Debug.Assert(<span class="keyword">value</span> &gt;= <span class="number">0</span>, <span class="string">&quot;mCost must great or equal to 0&quot;</span>);</span><br><span class="line">            mCost = <span class="keyword">value</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">float</span> mCost;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">NavGraphNode</span> : <span class="title">GraphNode</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="title">NavGraphNode</span>()</span></span><br><span class="line">	&#123;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">NavGraphNode</span>(<span class="params"><span class="built_in">int</span> index,Vector3 pos, <span class="built_in">float</span> weight, <span class="built_in">bool</span> iswall</span>)</span></span><br><span class="line">	&#123;</span><br><span class="line">		Index = index;</span><br><span class="line">		mPosition = pos;</span><br><span class="line">		mWeight = weight;</span><br><span class="line">		mIsWall = iswall;</span><br><span class="line">		mIsJumpable = <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">int</span> Index</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">get</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">return</span> mIndex;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">set</span></span><br><span class="line">		&#123;</span><br><span class="line">			mIndex = <span class="keyword">value</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">private</span> <span class="built_in">int</span> mIndex;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> Vector3 Position</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">get</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">return</span> mPosition;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">set</span></span><br><span class="line">		&#123;</span><br><span class="line">			mPosition = <span class="keyword">value</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">private</span> Vector3 mPosition;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">float</span> Weight</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">get</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">return</span> mWeight;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">set</span></span><br><span class="line">		&#123;</span><br><span class="line">			mWeight = <span class="keyword">value</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">private</span> <span class="built_in">float</span> mWeight;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">bool</span> IsWall</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">get</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">return</span> mIsWall;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">set</span></span><br><span class="line">		&#123;</span><br><span class="line">			mIsWall = <span class="keyword">value</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">private</span> <span class="built_in">bool</span> mIsWall;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">bool</span> IsJumpable</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">get</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">return</span> mIsJumpable;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">set</span></span><br><span class="line">		&#123;</span><br><span class="line">			mIsJumpable = <span class="keyword">value</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">private</span> <span class="built_in">bool</span> mIsJumpable;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>抽象了节点和边后，我们就可以初始化我们的地图数据了</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">CreateGraph</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">	mNavGraph = <span class="keyword">new</span> SparseGraph&lt;NavGraphNode, GraphEdge&gt; (mRow * mColumn);</span><br><span class="line">	</span><br><span class="line">	mNavGraph.BDrawMap = mBDrawMap;</span><br><span class="line"></span><br><span class="line">	Vector3 nodeposition = <span class="keyword">new</span> Vector3 ();</span><br><span class="line">	<span class="built_in">int</span> nextindex = <span class="number">0</span>;</span><br><span class="line">	<span class="comment">//SparseGraph nodes data</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="built_in">int</span> rw = <span class="number">0</span>; rw &lt; mRow; rw++) &#123;</span><br><span class="line">		<span class="keyword">for</span> (<span class="built_in">int</span> col = <span class="number">0</span>; col &lt; mColumn; col++) &#123;</span><br><span class="line">			nodeposition = <span class="keyword">new</span> Vector3 (rw, <span class="number">0.0f</span>, col);</span><br><span class="line">			nextindex = mNavGraph.NextFreeNodeIndex;</span><br><span class="line">			mNavGraph.AddNode (<span class="keyword">new</span> NavGraphNode (nextindex, nodeposition, <span class="number">0.0f</span>, <span class="literal">false</span>));</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//SparseGraph edges data</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="built_in">int</span> rw = <span class="number">0</span>; rw &lt; mRow; rw++) </span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">for</span> (<span class="built_in">int</span> col = <span class="number">0</span>; col &lt; mColumn; col++) </span><br><span class="line">		&#123;</span><br><span class="line">			CreateAllNeighboursToGridNode(rw, col, mRow, mColumn);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	mTotalNodes = mNavGraph.NumNodes();</span><br><span class="line">	mTotalEdges = mNavGraph.NumEdges ();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样一来我们的地图基本数据就都创建完成了。<br>在实现A Star之前，我们需要一个优先队列来排序我们所搜索的所有边的优先级。</p>
<h6 id="PriorityQueue"><a href="#PriorityQueue" class="headerlink" title="PriorityQueue"></a>PriorityQueue</h6><p>通过Search我发现C#没有自带的优先队列，所以需要自己实现<br>这里的优先队列主要要实现排第一位的永远是cost最低的（其他并不需要有序，因为A Star里面是通过pop出cost最低的边来进行搜索行进的）<br>这里我用到了<a href="http://tonytang1990.github.io/2015/07/11/Sort-Algorithm/">堆排序(Heap Sort)</a>：<br>平均时间复杂度：O(n log(n))<br>最坏时间复杂度：O(n log(n))<br>最优时间复杂度：O(n log(n)) (时间复杂度都跟堆的深度和数据长度相关，无可避免的需要去做堆调整和堆排序<br>所以最坏时间复杂度和最优时间复杂度都是O(nlog(n)<br>因为我们只需要确保第一个是cost最低的，所以我们并不需要每一次都完整的排序整个堆（完整排序的时间复杂度是n * Log(n)），我们只需要在每一次insert和pop的时候重新掉整一下堆即可（这样一来就可以在Log(n)的时间内保证第一个是cost最低的）</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine.Assertions;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PriorityQueue</span>&lt;<span class="title">T1</span>, <span class="title">T2</span>&gt;</span><br><span class="line">&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">PriorityQueue</span>()</span></span><br><span class="line">	&#123;</span><br><span class="line">		mHeap = <span class="keyword">new</span> Heap&lt;T1, T2&gt;();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">PriorityQueue</span>(<span class="params"><span class="built_in">int</span> size</span>)</span></span><br><span class="line">	&#123;</span><br><span class="line">		mHeap = <span class="keyword">new</span> Heap&lt;T1, T2&gt; (size);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">PriorityQueue</span>(<span class="params">Heap&lt;T1, T2&gt; heap</span>)</span></span><br><span class="line">	&#123;</span><br><span class="line">		mHeap = heap;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">PriorityQueue</span>(<span class="params">List&lt;Pair&lt;T1,T2&gt;&gt; key</span>)</span></span><br><span class="line">	&#123;</span><br><span class="line">		mHeap = <span class="keyword">new</span> Heap&lt;T1, T2&gt; (key);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">Empty</span>()</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> (mHeap.Size() == <span class="number">0</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Clear</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mHeap.Clear();</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Push</span>(<span class="params">Pair&lt;T1, T2&gt; kvp</span>)</span></span><br><span class="line">	&#123;</span><br><span class="line">		mHeap.Insert(kvp);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> Pair&lt;T1, T2&gt; <span class="title">Pop</span>()</span></span><br><span class="line">	&#123;</span><br><span class="line">		Pair&lt;T1,T2&gt; result = mHeap.Top();</span><br><span class="line">		mHeap.RemoveTop();</span><br><span class="line">		<span class="keyword">return</span> result;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="built_in">int</span> <span class="title">Size</span>()</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> mHeap.Size();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> Pair&lt;T1, T2&gt; <span class="title">Top</span>()</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> mHeap.Top(); ;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ChangePriority</span>(<span class="params">T1 index</span>)</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">//Assert.IsTrue (index &gt;= 0 &amp;&amp; index &lt; mHeap.Size ());</span></span><br><span class="line">		<span class="built_in">int</span> i = <span class="number">0</span>;</span><br><span class="line">		i  = mHeap.FindSpecificKeyIndex(index);</span><br><span class="line">		mHeap.HeapifyFromEndToBeginning (i);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">PrintOutAllMember</span>()</span></span><br><span class="line">	&#123;</span><br><span class="line">		mHeap.PrintOutAllMember();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> Heap&lt;T1, T2&gt; mHeap;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Heap</span>&lt;<span class="title">T1</span>, <span class="title">T2</span>&gt;</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">private</span> List&lt;Pair&lt;T1, T2&gt;&gt; mList;</span><br><span class="line">	<span class="keyword">private</span> IComparer&lt;T2&gt; mComparer;</span><br><span class="line">	<span class="keyword">private</span> IComparer&lt;T1&gt; mCompareKey;</span><br><span class="line">	<span class="keyword">private</span> <span class="built_in">int</span> mCount;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Heap</span>()</span></span><br><span class="line">	&#123;</span><br><span class="line">		mList = <span class="keyword">new</span> List&lt;Pair&lt;T1, T2&gt;&gt;();</span><br><span class="line">		mComparer = Comparer&lt;T2&gt;.Default;</span><br><span class="line">		mCompareKey = Comparer&lt;T1&gt;.Default;</span><br><span class="line">		mCount = <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Heap</span>(<span class="params"><span class="built_in">int</span> size</span>)</span></span><br><span class="line">	&#123;</span><br><span class="line">		mList = <span class="keyword">new</span> List&lt;Pair&lt;T1, T2&gt;&gt;(size);</span><br><span class="line">		mComparer = Comparer&lt;T2&gt;.Default;</span><br><span class="line">		mCompareKey = Comparer&lt;T1&gt;.Default;</span><br><span class="line">		mCount = <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Heap</span>(<span class="params">List&lt;Pair&lt;T1, T2&gt;&gt; list</span>)</span></span><br><span class="line">	&#123;</span><br><span class="line">		mList = list;</span><br><span class="line">		mCount = list.Count;</span><br><span class="line">		mComparer = Comparer&lt;T2&gt;.Default;</span><br><span class="line">		mCompareKey = Comparer&lt;T1&gt;.Default;</span><br><span class="line">		BuildingHeap();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Clear</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mList.Clear();</span><br><span class="line">        mCount = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="built_in">int</span> <span class="title">Size</span>()</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (mList != <span class="literal">null</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">return</span> mCount;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//O(Log(N))</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">RemoveTop</span>()</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (mList != <span class="literal">null</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			mList[<span class="number">0</span>] = mList[mCount - <span class="number">1</span>];</span><br><span class="line">			mList.RemoveAt(mCount<span class="number">-1</span>);</span><br><span class="line">			mCount--;</span><br><span class="line">			HeapifyFromBeginningToEnd(<span class="number">0</span>,mCount - <span class="number">1</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> Pair&lt;T1, T2&gt; <span class="title">Top</span>()</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (mList != <span class="literal">null</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">return</span> mList[<span class="number">0</span>];</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">//No more member</span></span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> InvalidOperationException(<span class="string">&quot;Empty heap.&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="built_in">int</span> <span class="title">FindSpecificKeyIndex</span>(<span class="params">T1 key</span>)</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> mList.FindIndex (x =&gt; mCompareKey.Compare (x.Key, key) == <span class="number">0</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">PrintOutAllMember</span>()</span></span><br><span class="line">	&#123;</span><br><span class="line">        Pair&lt;T1, T2&gt; valuepair;</span><br><span class="line">		<span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; mList.Count; i++)</span><br><span class="line">		&#123;</span><br><span class="line">            valuepair = mList[i];</span><br><span class="line">			Debug.Log(valuepair.ToString());</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//O(Log(N))</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Insert</span>(<span class="params">Pair&lt;T1, T2&gt; valuepair</span>)</span></span><br><span class="line">	&#123;</span><br><span class="line">		mList.Add(valuepair);</span><br><span class="line">		mCount++;</span><br><span class="line">		HeapifyFromEndToBeginning(mCount - <span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//调整堆确保堆是最大堆，这里花O(log(n))，跟堆的深度有关</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">HeapifyFromBeginningToEnd</span>(<span class="params"><span class="built_in">int</span> parentindex, <span class="built_in">int</span> length</span>)</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">int</span> max_index = parentindex;</span><br><span class="line">		<span class="built_in">int</span> left_child_index = parentindex * <span class="number">2</span> + <span class="number">1</span>;</span><br><span class="line">		<span class="built_in">int</span> right_child_index = parentindex * <span class="number">2</span> + <span class="number">2</span>;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//Chose biggest one between parent and left&amp;right child</span></span><br><span class="line">		<span class="keyword">if</span> (left_child_index &lt; length &amp;&amp; mComparer.Compare(mList[left_child_index].Value, mList[max_index].Value) &lt; <span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			max_index = left_child_index;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">if</span> (right_child_index &lt; length &amp;&amp; mComparer.Compare(mList[right_child_index].Value, mList[max_index].Value) &lt; <span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			max_index = right_child_index;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//If any child is bigger than parent, </span></span><br><span class="line">		<span class="comment">//then we swap it and do adjust for child again to make sure meet max heap definition</span></span><br><span class="line">		<span class="keyword">if</span> (max_index != parentindex)</span><br><span class="line">		&#123;</span><br><span class="line">			Swap(max_index, parentindex);</span><br><span class="line">			HeapifyFromBeginningToEnd(max_index, length);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//O(log(N))</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">HeapifyFromEndToBeginning</span>(<span class="params"><span class="built_in">int</span> index</span>)</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span>(index &gt;= mCount)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">while</span> (index &gt; <span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">int</span> parentindex = (index - <span class="number">1</span>) / <span class="number">2</span>;</span><br><span class="line">			<span class="keyword">if</span>(mComparer.Compare(mList[parentindex].Value,mList[index].Value) &gt; <span class="number">0</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				Swap(parentindex, index);</span><br><span class="line">				index = parentindex;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//通过初试数据构建最大堆</span></span><br><span class="line">	<span class="comment"><span class="doctag">///</span>/O(N*Log(N))</span></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">BuildingHeap</span>()</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (mList != <span class="literal">null</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">for</span> (<span class="built_in">int</span> i = mList.Count / <span class="number">2</span> - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="comment">//1.2 Adjust heap</span></span><br><span class="line">				<span class="comment">//Make sure meet max heap definition</span></span><br><span class="line">				<span class="comment">//Max Heap definition:</span></span><br><span class="line">				<span class="comment">// (k(i) &gt;= k(2i) &amp;&amp; k(i) &gt;= k(2i+1))   (1 &lt;= i &lt;= n/2)</span></span><br><span class="line">				HeapifyFromBeginningToEnd(i, mList.Count);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment"><span class="doctag">///</span>/O(N*log(N))</span></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">HeapSort</span>()</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (mList != <span class="literal">null</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">//Steps:</span></span><br><span class="line">			<span class="comment">// 1. Build heap</span></span><br><span class="line">			<span class="comment">// 1.1 Init heap</span></span><br><span class="line">			<span class="comment">// 1.2 Adjust heap</span></span><br><span class="line">			<span class="comment">// 2. Sort heap</span></span><br><span class="line">			</span><br><span class="line">			<span class="comment">//1. Build max heap</span></span><br><span class="line">			<span class="comment">// 1.1 Init heap</span></span><br><span class="line">			<span class="comment">//Assume we construct max heap</span></span><br><span class="line">			BuildingHeap();</span><br><span class="line">			<span class="comment">//2. Sort heap</span></span><br><span class="line">			<span class="comment">//这里花O(n)，跟数据数量有关</span></span><br><span class="line">			<span class="keyword">for</span> (<span class="built_in">int</span> i = mList.Count - <span class="number">1</span>; i &gt; <span class="number">0</span>; i--)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="comment">//swap first element and last element</span></span><br><span class="line">				<span class="comment">//do adjust heap process again to make sure the new array are still max heap</span></span><br><span class="line">				Swap(i, <span class="number">0</span>);</span><br><span class="line">				<span class="comment">//Due to we already building max heap before,</span></span><br><span class="line">				<span class="comment">//so  we just need to adjust for index 0 after we swap first and last element</span></span><br><span class="line">				HeapifyFromBeginningToEnd(<span class="number">0</span>, i);</span><br><span class="line">			&#125;            </span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			Debug.Log(<span class="string">&quot;mList == null&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Swap</span>(<span class="params"><span class="built_in">int</span> id1, <span class="built_in">int</span> id2</span>)</span></span><br><span class="line">	&#123;</span><br><span class="line">		Pair&lt;T1, T2&gt; temp;</span><br><span class="line">		temp = mList[id1];</span><br><span class="line">		mList[id1] = mList[id2];</span><br><span class="line">		mList[id2] = temp;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Pair</span>&lt;<span class="title">T1</span>, <span class="title">T2</span>&gt;</span><br><span class="line">&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Pair</span>()</span></span><br><span class="line">	&#123;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Pair</span>(<span class="params">T1 k, T2 v</span>)</span></span><br><span class="line">	&#123;</span><br><span class="line">		Key = k;</span><br><span class="line">		Value = v;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="built_in">string</span> <span class="title">ToString</span>()</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> String.Format(<span class="string">&quot;[&#123;0&#125;,&#123;1&#125;]&quot;</span>,Key,Value);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> T1 Key</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">get</span>;</span><br><span class="line">		<span class="keyword">set</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> T2 Value</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">get</span>;</span><br><span class="line">		<span class="keyword">set</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样一来我们所需要的优先队列就完成了。</p>
<h6 id="A-Star-1"><a href="#A-Star-1" class="headerlink" title="A Star"></a>A Star</h6><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> UnityEngine.Assertions;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">SearchAStar</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">struct</span> PathInfo</span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> List&lt;<span class="built_in">int</span>&gt; PathToTarget</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> mPathToTarget;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">set</span></span><br><span class="line">            &#123;</span><br><span class="line">                mPathToTarget = <span class="keyword">value</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">private</span> List&lt;<span class="built_in">int</span>&gt; mPathToTarget;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> List&lt;Vector3&gt; MovementPathToTarget</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> mMovementPathToTarget;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">set</span></span><br><span class="line">            &#123;</span><br><span class="line">                mMovementPathToTarget = <span class="keyword">value</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">private</span> List&lt;Vector3&gt; mMovementPathToTarget;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">bool</span> IsWallInPathToTarget</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> mIsWallInPathToTarget;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">set</span></span><br><span class="line">            &#123;</span><br><span class="line">                mIsWallInPathToTarget = <span class="keyword">value</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">private</span> <span class="built_in">bool</span> mIsWallInPathToTarget;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">int</span> WallInPathToTargetIndex</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> mWallInPathToTargetIndex;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">set</span></span><br><span class="line">            &#123;</span><br><span class="line">                mWallInPathToTargetIndex = <span class="keyword">value</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">private</span> <span class="built_in">int</span> mWallInPathToTargetIndex;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">float</span> CostToTarget</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> mCostToTarget;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">set</span></span><br><span class="line">            &#123;</span><br><span class="line">                mCostToTarget = <span class="keyword">value</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">private</span> <span class="built_in">float</span> mCostToTarget;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">int</span> ITarget</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">set</span></span><br><span class="line">            &#123;</span><br><span class="line">                mITarget = <span class="keyword">value</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">get</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> mITarget;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">private</span> <span class="built_in">int</span> mITarget;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">int</span> OriginalTarget</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> mOriginalTarget;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">set</span></span><br><span class="line">            &#123;</span><br><span class="line">                mOriginalTarget = <span class="keyword">value</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">private</span> <span class="built_in">int</span> mOriginalTarget;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">int</span> NodesSearched</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> mNodesSearched;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">set</span></span><br><span class="line">            &#123;</span><br><span class="line">                mNodesSearched = <span class="keyword">value</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">private</span> <span class="built_in">int</span> mNodesSearched;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">int</span> EdgesSearched</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> mEdgesSearched;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">set</span></span><br><span class="line">            &#123;</span><br><span class="line">                mEdgesSearched = <span class="keyword">value</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">private</span> <span class="built_in">int</span> mEdgesSearched;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//this list of edges is used to store any subtree returned from any of the graph algorithms</span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        public List&lt;GraphEdge&gt; SubTree</span></span><br><span class="line"><span class="comment">        &#123;</span></span><br><span class="line"><span class="comment">            get</span></span><br><span class="line"><span class="comment">            &#123;</span></span><br><span class="line"><span class="comment">                return mSubTree;</span></span><br><span class="line"><span class="comment">            &#125;</span></span><br><span class="line"><span class="comment">            set</span></span><br><span class="line"><span class="comment">            &#123;</span></span><br><span class="line"><span class="comment">                mSubTree = value;</span></span><br><span class="line"><span class="comment">            &#125;</span></span><br><span class="line"><span class="comment">        &#125;</span></span><br><span class="line"><span class="comment">        private List&lt;GraphEdge&gt; mSubTree;</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        public PathInfo()</span></span><br><span class="line"><span class="comment">        &#123;</span></span><br><span class="line"><span class="comment">            ResetPathInfo();</span></span><br><span class="line"><span class="comment">        &#125;</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> PathInfo <span class="title">DeepCopy</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            PathInfo pi = (PathInfo)<span class="keyword">this</span>.MemberwiseClone();</span><br><span class="line">            pi.PathToTarget = <span class="keyword">new</span> List&lt;<span class="built_in">int</span>&gt;(mPathToTarget);</span><br><span class="line">            pi.MovementPathToTarget = <span class="keyword">new</span> List&lt;Vector3&gt;(mMovementPathToTarget);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> pi;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ResetPathInfo</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            mIsWallInPathToTarget = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">            mWallInPathToTargetIndex = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (mPathToTarget != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                mPathToTarget.Clear();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                mPathToTarget = <span class="keyword">new</span> List&lt;<span class="built_in">int</span>&gt;();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (mMovementPathToTarget != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                mMovementPathToTarget.Clear();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                mMovementPathToTarget = <span class="keyword">new</span> List&lt;Vector3&gt;();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            mNodesSearched = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">            mEdgesSearched = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">            mCostToTarget = <span class="number">0.0f</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">SearchAStar</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SearchAStar</span>(<span class="params">SparseGraph&lt;NavGraphNode, GraphEdge&gt; graph</span></span></span><br><span class="line"><span class="params"><span class="function">                       , <span class="built_in">int</span> source</span></span></span><br><span class="line"><span class="params"><span class="function">                       , <span class="built_in">int</span> target</span></span></span><br><span class="line"><span class="params"><span class="function">                       , <span class="built_in">bool</span> isignorewall</span></span></span><br><span class="line"><span class="params"><span class="function">                       , <span class="built_in">float</span> strickdistance</span></span></span><br><span class="line"><span class="params"><span class="function">                       , <span class="built_in">float</span> hcostpercentage</span></span></span><br><span class="line"><span class="params"><span class="function">                       , <span class="built_in">bool</span> drawexplorepath</span></span></span><br><span class="line"><span class="params"><span class="function">                       , <span class="built_in">float</span> explorepathremaintime</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        mGraph = graph;</span><br><span class="line">        mPQ = <span class="keyword">new</span> PriorityQueue&lt;<span class="built_in">int</span>, <span class="built_in">float</span>&gt;((<span class="built_in">int</span>)Mathf.Sqrt(mGraph.NumNodes()));</span><br><span class="line">        mGCosts = <span class="keyword">new</span> List&lt;<span class="built_in">float</span>&gt;(graph.NumNodes());</span><br><span class="line">        mFCosts = <span class="keyword">new</span> List&lt;Pair&lt;<span class="built_in">int</span>, <span class="built_in">float</span>&gt;&gt;(graph.NumNodes());</span><br><span class="line">        mShortestPathTree = <span class="keyword">new</span> List&lt;GraphEdge&gt;(graph.NumNodes());</span><br><span class="line">        mSearchFrontier = <span class="keyword">new</span> List&lt;GraphEdge&gt;(graph.NumNodes());</span><br><span class="line">        <span class="comment">//Init G cost and F cost and Cost value</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; graph.NumNodes(); i++)</span><br><span class="line">        &#123;</span><br><span class="line">            mGCosts.Add(<span class="number">0.0f</span>);</span><br><span class="line">            mFCosts.Add(<span class="keyword">new</span> Pair&lt;<span class="built_in">int</span>, <span class="built_in">float</span>&gt;(i, <span class="number">0.0f</span>));</span><br><span class="line">            mShortestPathTree.Add(<span class="keyword">new</span> GraphEdge());</span><br><span class="line">            mSearchFrontier.Add(<span class="keyword">new</span> GraphEdge());</span><br><span class="line">        &#125;</span><br><span class="line">        mISource = source;</span><br><span class="line">        mITarget = target;</span><br><span class="line">        mOriginalTarget = target;</span><br><span class="line"></span><br><span class="line">        Assert.IsTrue(hcostpercentage &gt;= <span class="number">0</span>);</span><br><span class="line">        mHCostPercentage = hcostpercentage;</span><br><span class="line"></span><br><span class="line">        mBDrawExplorePath = drawexplorepath;</span><br><span class="line"></span><br><span class="line">        mExplorePathRemainTime = explorepathremaintime;</span><br><span class="line"></span><br><span class="line">        mAStarPathInfo = <span class="keyword">new</span> PathInfo();</span><br><span class="line"></span><br><span class="line">        mIsIgnoreWall = isignorewall;</span><br><span class="line"></span><br><span class="line">        mStrickDistance = strickdistance;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Search(mStrickDistance, mIsIgnoreWall);</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//GeneratePathToTargetInfo();</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">UpdateSearch</span>(<span class="params"><span class="built_in">int</span> sourceindex, <span class="built_in">int</span> targetindex, <span class="built_in">float</span> strickdistance</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Assert.IsTrue(mISource &gt;= <span class="number">0</span> &amp;&amp; mISource &lt; mGraph.NumNodes());</span><br><span class="line">        Assert.IsTrue(mITarget &gt;= <span class="number">0</span> &amp;&amp; mITarget &lt; mGraph.NumNodes());</span><br><span class="line"></span><br><span class="line">        AstarReset(sourceindex, targetindex, strickdistance);</span><br><span class="line"></span><br><span class="line">        Search(mStrickDistance, mIsIgnoreWall);</span><br><span class="line"></span><br><span class="line">        GeneratePathToTargetInfo();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">AstarReset</span>(<span class="params"><span class="built_in">int</span> sourceindex, <span class="built_in">int</span> targetindex, <span class="built_in">float</span> strickdistance</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        mISource = sourceindex;</span><br><span class="line"></span><br><span class="line">        mITarget = targetindex;</span><br><span class="line"></span><br><span class="line">        mOriginalTarget = targetindex;</span><br><span class="line"></span><br><span class="line">        mStrickDistance = strickdistance;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; mGraph.NumNodes(); i++)</span><br><span class="line">        &#123;</span><br><span class="line">            mGCosts[i] = <span class="number">0.0f</span>;</span><br><span class="line">            mFCosts[i].Value = <span class="number">0.0f</span>;</span><br><span class="line">            mShortestPathTree[i].Reset();</span><br><span class="line">            mSearchFrontier[i].Reset();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mAStarPathInfo.ResetPathInfo();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">bool</span> mIsIgnoreWall;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">float</span> StrickDistance</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">set</span></span><br><span class="line">        &#123;</span><br><span class="line">            mStrickDistance = <span class="keyword">value</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">float</span> mStrickDistance;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> PathInfo AStarPathInfo</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> mAStarPathInfo;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">set</span></span><br><span class="line">        &#123;</span><br><span class="line">            mAStarPathInfo = <span class="keyword">value</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> PathInfo mAStarPathInfo;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">GeneratePathToTargetInfo</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mAStarPathInfo.PathToTarget.Clear();</span><br><span class="line">        mAStarPathInfo.MovementPathToTarget.Clear();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mITarget &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">int</span> nd = mITarget;</span><br><span class="line"></span><br><span class="line">        mAStarPathInfo.PathToTarget.Add(nd);</span><br><span class="line"></span><br><span class="line">        mAStarPathInfo.MovementPathToTarget.Add(mGraph.Nodes[nd].Position);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> ((nd != mISource) &amp;&amp; (mShortestPathTree[nd] != <span class="literal">null</span>) &amp;&amp; mShortestPathTree[nd].IsValidEdge())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//Debug.DrawLine(mGraph.Nodes[mShortestPathTree[nd].From].Position,mGraph.Nodes[nd].Position,Color.green, Mathf.Infinity);</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!mIsIgnoreWall)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//No matter the wall in path is jumpable or not, we should record it as useful information</span></span><br><span class="line">                <span class="keyword">if</span> (mGraph.Nodes[nd].IsWall <span class="comment">/*&amp;&amp; !mGraph.Nodes[nd].IsJumpable*/</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    mAStarPathInfo.IsWallInPathToTarget = <span class="literal">true</span>;</span><br><span class="line">                    mAStarPathInfo.WallInPathToTargetIndex = nd;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            nd = mShortestPathTree[nd].From;</span><br><span class="line"></span><br><span class="line">            mAStarPathInfo.PathToTarget.Add(nd);</span><br><span class="line"></span><br><span class="line">            mAStarPathInfo.MovementPathToTarget.Add(mGraph.Nodes[nd].Position);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mAStarPathInfo.CostToTarget = GetCostToTarget();</span><br><span class="line"></span><br><span class="line">        mAStarPathInfo.ITarget = mITarget;</span><br><span class="line"></span><br><span class="line">        mAStarPathInfo.OriginalTarget = mOriginalTarget;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;GraphEdge&gt; <span class="title">GetSPT</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> mShortestPathTree;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="built_in">float</span> <span class="title">GetCostToTarget</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> mGCosts[mITarget];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> SparseGraph&lt;NavGraphNode, GraphEdge&gt; mGraph;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> PriorityQueue&lt;<span class="built_in">int</span>, <span class="built_in">float</span>&gt; mPQ;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;<span class="built_in">float</span>&gt; mGCosts;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;Pair&lt;<span class="built_in">int</span>, <span class="built_in">float</span>&gt;&gt; mFCosts;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> List&lt;GraphEdge&gt; SPT</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> mShortestPathTree;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> List&lt;GraphEdge&gt; mShortestPathTree;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">	public List&lt;float&gt; CostToTargetNode </span></span><br><span class="line"><span class="comment">	&#123;</span></span><br><span class="line"><span class="comment">		get &#123;</span></span><br><span class="line"><span class="comment">			return mCostToTargetNode;</span></span><br><span class="line"><span class="comment">		&#125;</span></span><br><span class="line"><span class="comment">		set</span></span><br><span class="line"><span class="comment">		&#123;</span></span><br><span class="line"><span class="comment">			mCostToTargetNode = value;</span></span><br><span class="line"><span class="comment">		&#125;</span></span><br><span class="line"><span class="comment">	&#125;</span></span><br><span class="line"><span class="comment">	private List&lt;float&gt; mCostToTargetNode;</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;GraphEdge&gt; mSearchFrontier;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> ISource</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">set</span></span><br><span class="line">        &#123;</span><br><span class="line">            mISource = <span class="keyword">value</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span> mISource;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> ITarget</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">set</span></span><br><span class="line">        &#123;</span><br><span class="line">            mITarget = <span class="keyword">value</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> mITarget;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span> mITarget;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> OriginalTarget</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> mOriginalTarget;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">set</span></span><br><span class="line">        &#123;</span><br><span class="line">            mOriginalTarget = <span class="keyword">value</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span> mOriginalTarget;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">float</span> mHCostPercentage;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">bool</span> mBDrawExplorePath;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">float</span> mExplorePathRemainTime;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//The A* search algorithm</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Search</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mPQ.Clear();</span><br><span class="line"></span><br><span class="line">        mPQ.Push(mFCosts[mISource]);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//mSearchFrontier [mISource] = new GraphEdge (mISource, mISource, 0.0f);</span></span><br><span class="line">        mSearchFrontier[mISource].From = mISource;</span><br><span class="line">        mSearchFrontier[mISource].To = mISource;</span><br><span class="line">        mSearchFrontier[mISource].Cost = <span class="number">0.0f</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (!mPQ.Empty())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//Get lowest cost node from the queue</span></span><br><span class="line">            <span class="built_in">int</span> nextclosestnode = mPQ.Pop().Key;</span><br><span class="line"></span><br><span class="line">            mAStarPathInfo.NodesSearched++;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//move this node from the frontier to the spanning tree</span></span><br><span class="line">            <span class="keyword">if</span> (mSearchFrontier[nextclosestnode] != <span class="literal">null</span> &amp;&amp; mSearchFrontier[nextclosestnode].IsValidEdge())</span><br><span class="line">            &#123;</span><br><span class="line">                mShortestPathTree[nextclosestnode] = mSearchFrontier[nextclosestnode];</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//If the target has been found exit</span></span><br><span class="line">            <span class="keyword">if</span> (nextclosestnode == mITarget)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//Now to test all the edges attached to this node</span></span><br><span class="line">            List&lt;GraphEdge&gt; edgelist = mGraph.EdgesList[nextclosestnode];</span><br><span class="line">            GraphEdge edge;</span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; edgelist.Count; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                edge = edgelist[i];</span><br><span class="line">                <span class="comment">//calculate the heuristic cost from this node to the target (H)</span></span><br><span class="line">                <span class="built_in">float</span> hcost = Heuristic_Euclid.Calculate(mGraph, mITarget, edge.To) * mHCostPercentage;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//calculate the &#x27;real&#x27; cost to this node from the source (G)</span></span><br><span class="line">                <span class="built_in">float</span> gcost = mGCosts[nextclosestnode] + edge.Cost;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//if the node has not been added to the frontier, add it and update the G and F costs</span></span><br><span class="line">                <span class="keyword">if</span> (mSearchFrontier[edge.To] != <span class="literal">null</span> &amp;&amp; !mSearchFrontier[edge.To].IsValidEdge())</span><br><span class="line">                &#123;</span><br><span class="line">                    mFCosts[edge.To].Value = gcost + hcost;</span><br><span class="line">                    mGCosts[edge.To] = gcost;</span><br><span class="line"></span><br><span class="line">                    mPQ.Push(mFCosts[edge.To]);</span><br><span class="line"></span><br><span class="line">                    mSearchFrontier[edge.To] = edge;</span><br><span class="line"></span><br><span class="line">                    mAStarPathInfo.EdgesSearched++;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (mBDrawExplorePath)</span><br><span class="line">                    &#123;</span><br><span class="line">                        Debug.DrawLine(mGraph.Nodes[edge.From].Position, mGraph.Nodes[edge.To].Position, Color.yellow, mExplorePathRemainTime);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//if this node is already on the frontier but the cost to get here</span></span><br><span class="line">                <span class="comment">//is cheaper than has been found previously, update the node</span></span><br><span class="line">                <span class="comment">//cost and frontier accordingly</span></span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (gcost &lt; mGCosts[edge.To])</span><br><span class="line">                &#123;</span><br><span class="line">                    mFCosts[edge.To].Value = gcost + hcost;</span><br><span class="line">                    mGCosts[edge.To] = gcost;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//Due to some node&#x27;s f cost has been changed</span></span><br><span class="line">                    <span class="comment">//we should reoder the priority queue to make sure we pop up the lowest fcost node first</span></span><br><span class="line">                    <span class="comment">//compare the fcost will make sure we search the path in the right direction</span></span><br><span class="line">                    <span class="comment">//h cost is the key to search in the right direction</span></span><br><span class="line">                    mPQ.ChangePriority(edge.To);</span><br><span class="line"></span><br><span class="line">                    mSearchFrontier[edge.To] = edge;</span><br><span class="line"></span><br><span class="line">                    mAStarPathInfo.EdgesSearched++;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//The A* search algorithm with strickdistance</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Search</span>(<span class="params"><span class="built_in">float</span> strickdistance</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">float</span> currentnodetotargetdistance = Mathf.Infinity;</span><br><span class="line"></span><br><span class="line">        mPQ.Clear();</span><br><span class="line"></span><br><span class="line">        mPQ.Push(mFCosts[mISource]);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//mSearchFrontier [mISource] = new GraphEdge (mISource, mISource, 0.0f);</span></span><br><span class="line">        mSearchFrontier[mISource].From = mISource;</span><br><span class="line">        mSearchFrontier[mISource].To = mISource;</span><br><span class="line">        mSearchFrontier[mISource].Cost = <span class="number">0.0f</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (!mPQ.Empty())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//Get lowest cost node from the queue</span></span><br><span class="line">            <span class="built_in">int</span> nextclosestnode = mPQ.Pop().Key;</span><br><span class="line"></span><br><span class="line">            mAStarPathInfo.NodesSearched++;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//move this node from the frontier to the spanning tree</span></span><br><span class="line">            <span class="keyword">if</span> (mSearchFrontier[nextclosestnode] != <span class="literal">null</span> &amp;&amp; mSearchFrontier[nextclosestnode].IsValidEdge())</span><br><span class="line">            &#123;</span><br><span class="line">                mShortestPathTree[nextclosestnode] = mSearchFrontier[nextclosestnode];</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            currentnodetotargetdistance = Heuristic_Euclid.Calculate(mGraph, mITarget, nextclosestnode);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (nextclosestnode == mITarget || currentnodetotargetdistance &lt;= strickdistance)</span><br><span class="line">            &#123;</span><br><span class="line">                mITarget = nextclosestnode;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//Now to test all the edges attached to this node</span></span><br><span class="line">            List&lt;GraphEdge&gt; edgelist = mGraph.EdgesList[nextclosestnode];</span><br><span class="line">            GraphEdge edge;</span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; edgelist.Count; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                edge = edgelist[i];</span><br><span class="line">                <span class="comment">//calculate the heuristic cost from this node to the target (H)</span></span><br><span class="line">                <span class="built_in">float</span> hcost = Heuristic_Euclid.Calculate(mGraph, mITarget, edge.To) * mHCostPercentage;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//calculate the &#x27;real&#x27; cost to this node from the source (G)</span></span><br><span class="line">                <span class="built_in">float</span> gcost = mGCosts[nextclosestnode] + edge.Cost;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//if the node has not been added to the frontier, add it and update the G and F costs</span></span><br><span class="line">                <span class="keyword">if</span> (mSearchFrontier[edge.To] != <span class="literal">null</span> &amp;&amp; !mSearchFrontier[edge.To].IsValidEdge())</span><br><span class="line">                &#123;</span><br><span class="line">                    mFCosts[edge.To].Value = gcost + hcost;</span><br><span class="line">                    mGCosts[edge.To] = gcost;</span><br><span class="line"></span><br><span class="line">                    mPQ.Push(mFCosts[edge.To]);</span><br><span class="line"></span><br><span class="line">                    mSearchFrontier[edge.To] = edge;</span><br><span class="line"></span><br><span class="line">                    mAStarPathInfo.EdgesSearched++;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (mBDrawExplorePath)</span><br><span class="line">                    &#123;</span><br><span class="line">                        Debug.DrawLine(mGraph.Nodes[edge.From].Position, mGraph.Nodes[edge.To].Position, Color.yellow, mExplorePathRemainTime);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//if this node is already on the frontier but the cost to get here</span></span><br><span class="line">                <span class="comment">//is cheaper than has been found previously, update the node</span></span><br><span class="line">                <span class="comment">//cost and frontier accordingly</span></span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (gcost &lt; mGCosts[edge.To])</span><br><span class="line">                &#123;</span><br><span class="line">                    mFCosts[edge.To].Value = gcost + hcost;</span><br><span class="line">                    mGCosts[edge.To] = gcost;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//Due to some node&#x27;s f cost has been changed</span></span><br><span class="line">                    <span class="comment">//we should reoder the priority queue to make sure we pop up the lowest fcost node first</span></span><br><span class="line">                    <span class="comment">//compare the fcost will make sure we search the path in the right direction</span></span><br><span class="line">                    <span class="comment">//h cost is the key to search in the right direction</span></span><br><span class="line">                    mPQ.ChangePriority(edge.To);</span><br><span class="line"></span><br><span class="line">                    mSearchFrontier[edge.To] = edge;</span><br><span class="line"></span><br><span class="line">                    mAStarPathInfo.EdgesSearched++;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//The A* search algorithm with strickdistance with wall consideration</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Search</span>(<span class="params"><span class="built_in">float</span> strickdistance, <span class="built_in">bool</span> isignorewall</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">float</span> currentnodetotargetdistance = Mathf.Infinity;</span><br><span class="line"></span><br><span class="line">        mPQ.Clear();</span><br><span class="line"></span><br><span class="line">        mPQ.Push(mFCosts[mISource]);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//mSearchFrontier [mISource] = new GraphEdge (mISource, mISource, 0.0f);</span></span><br><span class="line">        mSearchFrontier[mISource].From = mISource;</span><br><span class="line">        mSearchFrontier[mISource].To = mISource;</span><br><span class="line">        mSearchFrontier[mISource].Cost = <span class="number">0.0f</span>;</span><br><span class="line">        GraphEdge edge = <span class="keyword">new</span> GraphEdge();</span><br><span class="line">        <span class="built_in">int</span> nextclosestnode = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (!mPQ.Empty())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//Get lowest cost node from the queue</span></span><br><span class="line">            nextclosestnode = mPQ.Pop().Key;</span><br><span class="line"></span><br><span class="line">            mAStarPathInfo.NodesSearched++;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//move this node from the frontier to the spanning tree</span></span><br><span class="line">            <span class="keyword">if</span> (mSearchFrontier[nextclosestnode] != <span class="literal">null</span> &amp;&amp; mSearchFrontier[nextclosestnode].IsValidEdge())</span><br><span class="line">            &#123;</span><br><span class="line">                mShortestPathTree[nextclosestnode] = mSearchFrontier[nextclosestnode];</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            currentnodetotargetdistance = Heuristic_Euclid.Calculate(mGraph, mITarget, nextclosestnode);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (nextclosestnode == mITarget || (currentnodetotargetdistance &lt;= strickdistance &amp;&amp; !mGraph.Nodes[nextclosestnode].IsWall))</span><br><span class="line">            &#123;</span><br><span class="line">                mITarget = nextclosestnode;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//Now to test all the edges attached to this node</span></span><br><span class="line">            List&lt;GraphEdge&gt; edgelist = mGraph.EdgesList[nextclosestnode];</span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; edgelist.Count; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//Avoid pass refrence</span></span><br><span class="line">                edge.Reset();</span><br><span class="line">                edge.From = edgelist[i].From;</span><br><span class="line">                edge.To = edgelist[i].To;</span><br><span class="line">                edge.Cost = edgelist[i].Cost;</span><br><span class="line">                <span class="comment">//calculate the heuristic cost from this node to the target (H)</span></span><br><span class="line">                <span class="built_in">float</span> hcost = Heuristic_Euclid.Calculate(mGraph, mITarget, edge.To) * mHCostPercentage;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//calculate the &#x27;real&#x27; cost to this node from the source (G)</span></span><br><span class="line">                <span class="built_in">float</span> gcost = <span class="number">0.0f</span>;</span><br><span class="line">                <span class="keyword">if</span> (isignorewall)</span><br><span class="line">                &#123;</span><br><span class="line">                    gcost = mGCosts[nextclosestnode] + edge.Cost;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (mGraph.Nodes[edge.From].IsWall)</span><br><span class="line">                    &#123;</span><br><span class="line">                        gcost -= mGraph.Nodes[edge.From].Weight;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (mGraph.Nodes[edge.To].IsWall)</span><br><span class="line">                    &#123;</span><br><span class="line">                        gcost -= mGraph.Nodes[edge.To].Weight;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    gcost = mGCosts[nextclosestnode] + edge.Cost;</span><br><span class="line">                    <span class="keyword">if</span> (mGraph.Nodes[edge.From].IsJumpable)</span><br><span class="line">                    &#123;</span><br><span class="line">                        gcost -= mGraph.Nodes[edge.From].Weight;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (mGraph.Nodes[edge.To].IsJumpable)</span><br><span class="line">                    &#123;</span><br><span class="line">                        gcost -= mGraph.Nodes[edge.To].Weight;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//if the node has not been added to the frontier, add it and update the G and F costs</span></span><br><span class="line">                <span class="keyword">if</span> (mSearchFrontier[edge.To] != <span class="literal">null</span> &amp;&amp; !mSearchFrontier[edge.To].IsValidEdge())</span><br><span class="line">                &#123;</span><br><span class="line">                    mFCosts[edge.To].Value = gcost + hcost;</span><br><span class="line">                    mGCosts[edge.To] = gcost;</span><br><span class="line"></span><br><span class="line">                    mPQ.Push(mFCosts[edge.To]);</span><br><span class="line"></span><br><span class="line">                    mSearchFrontier[edge.To].ValueCopy(edge);</span><br><span class="line"></span><br><span class="line">                    mAStarPathInfo.EdgesSearched++;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (mBDrawExplorePath)</span><br><span class="line">                    &#123;</span><br><span class="line">                        Debug.DrawLine(mGraph.Nodes[edge.From].Position, mGraph.Nodes[edge.To].Position, Color.yellow, mExplorePathRemainTime);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//if this node is already on the frontier but the cost to get here</span></span><br><span class="line">                <span class="comment">//is cheaper than has been found previously, update the node</span></span><br><span class="line">                <span class="comment">//cost and frontier accordingly</span></span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (gcost &lt; mGCosts[edge.To])</span><br><span class="line">                &#123;</span><br><span class="line">                    mFCosts[edge.To].Value = gcost + hcost;</span><br><span class="line">                    mGCosts[edge.To] = gcost;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//Due to some node&#x27;s f cost has been changed</span></span><br><span class="line">                    <span class="comment">//we should reoder the priority queue to make sure we pop up the lowest fcost node first</span></span><br><span class="line">                    <span class="comment">//compare the fcost will make sure we search the path in the right direction</span></span><br><span class="line">                    <span class="comment">//h cost is the key to search in the right direction</span></span><br><span class="line">                    mPQ.ChangePriority(edge.To);</span><br><span class="line"></span><br><span class="line">                    mSearchFrontier[edge.To].ValueCopy(edge);</span><br><span class="line"></span><br><span class="line">                    mAStarPathInfo.EdgesSearched++;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title">Heuristic_Euclid</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">float</span> <span class="title">Calculate</span>(<span class="params">SparseGraph&lt;NavGraphNode, GraphEdge&gt; g, <span class="built_in">int</span> nd1, <span class="built_in">int</span> nd2</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//Manhattan distance heuritic</span></span><br><span class="line">        <span class="comment">//Vector2 v1 = Utility.ConvertIndexToRC (nd1);</span></span><br><span class="line">        <span class="comment">//Vector2 v2 = Utility.ConvertIndexToRC (nd2);</span></span><br><span class="line">        <span class="comment">//float dis = v1.x - v2.x + v1.y - v2.y;</span></span><br><span class="line">        <span class="comment">//Debug.Log(&quot;dis = &quot; + dis);</span></span><br><span class="line">        <span class="comment">//return dis;</span></span><br><span class="line">        <span class="comment">//Caculation distance takes much time</span></span><br><span class="line">        <span class="keyword">return</span> Vector3.Distance(g.Nodes[nd1].Position, g.Nodes[nd2].Position);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从上面可以看出我写了三个Search的版本：<br>第一个没有参数是最初的A Star Search，用于普通的寻路。<br>第二个带有float strickdistance的参数，是由于后来为了实现兵种间不同攻击距离下的寻路，只要达到攻击范围就算寻路完成。<br>第三个参数带了float strickdistance和bool isignorewall两个参数，还记得之前在GraphNode里写到的由于游戏里有城墙的概念，所以我在NavGraphNode里加入的mIsWall和mIsJumpable变量，用于判断节点是否是城墙并且是否可以直接越过。而这里的第二个参数isignorewall主要是用于判断当前兵种是否支持跳跃城墙（比如COC里的野猪），如果可以忽略城墙，那么寻路的时候就不会加入城墙的考虑。<br>后续我都会一一展示。</p>
<p>注意： A算法和Dijkstra算法的唯一区别是对搜索边界上的点的开销的计算。被修正的到节点的开销F用来决定节点在优先队列中的位置。<br>F的计算：<br>F &#x3D; G + H<br>G是到达一个节点的累计开销， H是一个启发因子，它给出的是节点到目标节点的估计距离。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">float</span> hcost = Heuristic_Euclid.Calculate(mGraph, mITarget, edge.To) * mHCostPercentage;</span><br></pre></td></tr></table></figure>
<p>这里算的是两点之间的实际距离，通过设定一个mHCostPercentage来实现对启发因子数值的控制。</p>
<p>让我们看看mHCostPercentage不同值时的效果：<br>黄色为寻路过程中探测的路线，绿色是最终路线。<br>mHCostPercentage &#x3D; 1，即以两点之间的实际距离为H值的寻路的效果：<br><img src="/img/Unity/mHCostPercentage1.PNG" alt="mHCostPercentage1"></p>
<p>mHCostPercentage &#x3D; 1.5,即以两点之前的实际距离的1.5倍为H值得寻路效果：<br><img src="/img/Unity/mHCostPercentage1point5.PNG" alt="mHCostPercentage1point5"></p>
<p>从上图可以看出H的值会使得A Star的搜索方向尽可能的往正确的方向搜索，从而避免不必要的边搜索。<br>上图由于绘制了搜索路径，所以实际上的Search Time没有那么高，如果mHCostPercentage设置成1.5一般都在2ms以内。</p>
<p>让我们看看加入城墙以后的效果：<br>注意，这里城墙的权值是设的4，即经过城墙相当于多走4的距离<br>mHCostPercentage &#x3D; 1<br><img src="/img/Unity/mHCostPercentage1withWall.PNG" alt="mHCostPercentage1withWall"></p>
<p>mHCostPercentage &#x3D; 1.5<br><img src="/img/Unity/mHCostPercentage1point5withWall.PNG" alt="mHCostPercentage1point5withWall"></p>
<p>从上图可以看出通过探索，士兵选择了最近的路线是绕过城墙，同时mHCostPercentage越大使得搜索的边减少了。</p>
<p>接下来看看当建筑被城墙大量包围时的寻路效果：<br>mHCostPercentage &#x3D; 1<br><img src="/img/Unity/mHCostPercentage1withMoreWall.PNG" alt="mHCostPercentage1withMoreWall"></p>
<p>mHCostPercentage &#x3D; 1.5<br><img src="/img/Unity/mHCostPercentage1point5withMoreWall.PNG" alt="mHCostPercentage1point5withMoreWall"></p>
<p>通过上面可以看出，由于建筑被城墙幅度包围，士兵的最终路线选择是经过城墙。<br>让我们来看一张有城墙的和无城墙的权值图：<br>有城墙：<br><img src="/img/Unity/WithWallWeightValue.PNG" alt="WithWallWeightValue"></p>
<p>无城墙：<br><img src="/img/Unity/WithoutWallWeightValue.PNG" alt="WithoutWallWeightValue"></p>
<p>NavGraphNode里加入的mIsJumpable变量将用于对城墙是否可跳跃的状态进行了抽象（实现COC里的弹跳法术）。</p>
<p>最终这个游戏实现了如下功能：</p>
<ol>
<li>地图的存储</li>
<li>地图的编辑（建造和删除）</li>
<li>游戏进攻AI（包括对特有类型建筑有限攻击（好比COC里胖子优先攻击防御建筑））</li>
<li>存档清除</li>
<li>PC和Mobile控制</li>
<li>A Star调试信息面板</li>
<li>调整兵种信息调整（对优先攻击进行设定，行进速度设定，攻击距离设定，攻击伤害，血量是否可跳墙等属性设定等）</li>
<li>对建筑物信息调整（所占格子2<em>2 or 3</em>3等设定（暂时只支持1<em>1,2</em>2,3*3），攻击距离，攻击伤害，血量等信息）</li>
<li>法术信息调整（法术范围，法术持续时间等信息）</li>
</ol>
<p>兵种支持：</p>
<ol>
<li>近战型优先攻击防御建筑 – 好比COC的胖子</li>
<li>远程，无特定攻击对象 – 好比COC的弓箭手</li>
</ol>
<p>建筑支持：</p>
<ol>
<li>攻击建筑 – 好比COC里的箭塔</li>
<li>不可攻击建筑 – 好比COC里的兵营</li>
<li>城墙 – 好比COC里的城墙</li>
</ol>
<p>法术支持：<br>弹跳法术</p>
<p>所有功能都会在最后的视频一一展示。</p>
<h3 id="Optimization"><a href="#Optimization" class="headerlink" title="Optimization"></a>Optimization</h3><ol>
<li><p>Rendering<br>最初是绘制了40*40，1600个带Sprite图案的Tile，后来改为用一张整的Ground和只带Collider的1600个Tile。</p>
</li>
<li><p>GC<br>A Star最初写的时候是每一次运算都申请新的内存(每一次都New上百k的内存)，后来改为通用数据保留下来，每次只重新申请需要返回的A Star Path的数据(大概几K)</p>
</li>
<li><p>Physics<br>最初是打开了所有Layer之间的碰撞检测，后来改为只打开需要碰撞检测的Layer之间的碰撞检测(Edit -&gt; Project Settings -&gt; Physics)</p>
</li>
<li><p>Memory<br>避免不必要的内存开销(比如box会在堆上申请额外的内存)<br>项目里用Dictionary而不要用Hashtable，因为Dictionary是基于模板的，在针对ValueType的时候不会触发box和unbox。<br>Unity里foreach会触发box，所以在Unity里尽量避免使用foreach，用while or for代替。</p>
</li>
</ol>
<h2 id="Sumary"><a href="#Sumary" class="headerlink" title="Sumary"></a>Sumary</h2><p>在这次尝试制作和学习的过程中，学习了解了Unity和C#的一些基本概念。<br>巩固学习了AI寻路方面的知识。<br>对于炸弹人的AI，虽然云风大哥说大概是“寻找附近封闭空间中最近目标”，对于如何实现这一点没有头绪。(未来AI学习书籍 – 《Artificial Intelligence for Game》 — Ian Millington)<br>通过这一次的实践学习，我明白了，好的数据结构设计才是性能的关键所在。我的实现依赖于A Star的实时运算，即使每次运算时1ms级别，但数量一旦达到成百上千，A Star是无法保证帧率的。尽量做到预算和O(1)时间的查找或者运用更好的数据结构解决问题才是提升性能的关键。<br>最后再贴一个没有解决的真机bug（相对严重的，PC上没有），暂时未能解决的。<br><a target="_blank" rel="noopener" href="http://answers.unity3d.com/questions/1158635/transformlookat-got-different-behaviour-on-pc-and.html">Unity 的提问</a></p>
<h2 id="Final-Effect"><a href="#Final-Effect" class="headerlink" title="Final Effect"></a>Final Effect</h2><p><a target="_blank" rel="noopener" href="http://blog.sina.com.cn/s/blog_8c7d49f20102xfck.html">视频</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Unity/">Unity</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Unity/">Unity</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/10/14/Artificial-Inteligence-Study/" title="Artificial-Inteligence-Study" itemprop="url">Artificial-Inteligence-Study</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Tony Tang" target="_blank" itemprop="author">Tony Tang</a>
		
  <p class="article-time">
    <time datetime="2015-10-14T14:25:28.000Z" itemprop="datePublished"> 发表于 2015-10-14</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="Programming-Game-AI-by-Example"><a href="#Programming-Game-AI-by-Example" class="headerlink" title="Programming Game AI by Example"></a>Programming Game AI by Example</h1><h2 id="图的秘密"><a href="#图的秘密" class="headerlink" title="图的秘密"></a>图的秘密</h2><h3 id="图的术语"><a href="#图的术语" class="headerlink" title="图的术语"></a>图的术语</h3><p>路径节点叫做节点(node)<br>连接节点的路线被叫做边(edge)<br>权包含了从一个节点移动到另一个节点所需要的开销信息</p>
<h3 id="图的分类："><a href="#图的分类：" class="headerlink" title="图的分类："></a>图的分类：</h3><ol>
<li>连通图 （途中任何一个节点都可以找到一条路径到达所有其他的节点）</li>
<li>不连通图</li>
</ol>
<h3 id="图的定义："><a href="#图的定义：" class="headerlink" title="图的定义："></a>图的定义：</h3><p>图G的规范化的定义：通过边的集合E，节点的集合N来定义<br>G &#x3D; {N , E}</p>
<p>注意：树是图的一个子集，树包含了所有的无环图</p>
<p>图密度：<br>边与节点的比率决定了一个图是稀疏还是致密的</p>
<p>有向图：<br>一个有向图的边是有方向的。</p>
<p>游戏AI中的图：</p>
<ol>
<li><p>导航图(Navigation Graph) （包含了在一个游戏环境中智能体可能访问的所有的位置和这些位置之间的所有连接）</p>
</li>
<li><p>依赖图(Dependency Graph) （被用来秒速玩家可以利用的不同的建筑物，材料，单元以及技术之间的依赖关系）</p>
</li>
<li><p>状态图(State Graph) （用来表示一个系统的每一个可能的状态以及状态之间的转换关系）</p>
</li>
</ol>
<p>两种数据结构被用来表示图：</p>
<ol>
<li><p>邻接矩阵 （用一个二维的矩阵来表示图的链接关系，矩阵的每一个元素可以使布尔类型的，也可以是浮点类型的）<br>优缺点：<br>直观<br>但对于大的稀疏图来说，这种表示方法不经济，大部分矩阵元素被用来存储0</p>
</li>
<li><p>邻接表<br>优缺点：<br>对于存储稀疏图是非常有效的，不会浪费空间来存储空连接<br>例子：<br>有向图：<br><img src="/img/AI/Digraph.PNG" alt="Digraph"></p>
</li>
</ol>
<p>邻接矩阵：<br>![Adjacency _Matrix](&#x2F;img&#x2F;AI&#x2F;Adjacency _Matrix.PNG)</p>
<p>邻接表：<br><img src="/img/AI/Adjacency_List.PNG" alt="Adjacency_List"></p>
<p>图的搜索算法：</p>
<ol>
<li><p>盲目搜索(Uniformed Graph Searches) （在搜索一个图时不考虑相关的边的开销）<br> a. 深度优先搜索(DFS: Depth First Search) （搜索时尽可能地深入一个图。在搜索时，当它走入死胡同时，才会回溯，以回到上一个较浅的节点，在那里继续深度搜索）<br>注意： 使用Stack来模拟，先进后出（FILO）的原则<br> DFS优化：<br> 一些图可能非常深，深度优先便可能非常容易地就在错误的路径上陷得很深，因而延误了搜索。<br> 限制深度的搜索(Limited Search)： 限制深度优先搜索算法在开始回溯之前可以进行多少步的深度搜索<br>缺点： 如何设置最大搜索深度<br>  迭代加深深度优先搜索(Iterative Deepending Depth First Search)<br> b. 广度优先搜索(BFS：Breadth First Search) （从源节点展开以检查从它出发的边指向的每一个节点，然后再从那些刚检查过的节点继续展开）<br>注意： 使用Queue来模拟，先进先出（FIFO）的原则<br> BFS缺点：<br> 如果搜索的图非常大而且分支数很高，那么BFS就会浪费大量的内存并且表现出很低的效率。</p>
</li>
<li><p>基于开销的图搜索(cost-based graph searchs)<br> a. 边放松(Edge Relaxation) （从源节点到抵达目标节点的路径上的所有其他节点中搜集当前最优路径（BPFSF: Best Path Found So Far）信息。这个信息在检查新的边时得到更新。如果刚检查的边表明，如果用通过此边到达一个节点的路径取代现有的最优路径会使路程更短，那么，这条边就 被加入，而路径也相应地更新）<br> b. 最短路径树(SPT: Short Path Tree) （从任何节点到达源节点的最短路径）<br><img src="/img/AI/SPT_Short_Path_Tree.PNG" alt="SPT_Short_Path_Tree"><br>c. Dijkstra算法(Dijkstra Algorithm) （教授Edsger Wybe Dijkstra著名的寻找带全图的最短路径算法）<br>注意： 使用一个索引的优先队列(Indexed Priority Queue)来实现。<br> 缺点：<br> Dijkstra算法检查了太多的边。<br> d. Dijkstra算法的一个改进：A<em>算法 （Dijkstra算法通过最小化开销进行搜索。在处理搜索边界上的点时，如果估计一下他们距离目标节点的开销，并将这个信息考虑进去，那么算法的效率就可以大大提高。这个估计值被称为启发因子。）<br>注意： A</em>算法和Dijkstra算法的唯一区别是对搜索边界上的点的开销的计算。被修正的到节点的开销F用来决定节点在优先队列中的位置。<br>F的计算：<br> F &#x3D; G + H<br>G是到达一个节点的累计开销， H是一个启发因子，它给出的是节点到目标节点的估计距离。<br>   通过用这种方法使用一个启发因子，被修正的开销会指引搜索逼近目标节点，而不是在各个可能的方向发散的搜索。这也使需要检查的边更少。因此搜索的加速是Disjkstra算法和A<em>算法的最主要区别。<br>   A</em>算法的实现需要维护两个用来存储开销的std::vector，一个用来保存每一个节点的F开销，作为优先队列的索引，另一个是每一个节点的G开销。</p>
</li>
</ol>
<p>《Artificial Intelligence for Game》 – Ian Millington<br>1.	Introduction<br>	1.1	What is AI?<br>Artificial intelligence is about making computers able to perform the thinking tasks that humans and animals are capable of</p>
<p>1.1.2  Game AI<br>Pacman [Midway Games West, Inc, 1979] – state machine<br>Warcraft –[Blizzard Entertainment, 1994] – Path finding</p>
<p>AI three basic needs:<br>1.	Move<br>Movement refers to algorithms that turn decisions into some kind of motion<br>2.	Decision making<br>Decision making involves a characterworking out what to do next<br>3.	Strategy<br>Strategy refers to an overall approach used by a group of characters – e.g. Harf-Life<br>Note:<br>Not all game applications require all levels of AI</p>
<p>1.2.5 Agent-Based AI<br>Agent-based AI is about producing autonomous characters that take in information from the game data, determine what actions to take based on the information, and carry out those actions</p>
<p>1.3	Algorithms, Data Structures, and Representations<br>1.3.1	Algorithms</p>
<ol start="6">
<li>Tactical and Strategic AI<br>6.1 Waypoint Tactics<br>6.1.1 Tactical Locations</li>
</ol>
<p>12.4 Real-Time Strategy<br>待续……</p>
<h1 id="AI"><a href="#AI" class="headerlink" title="AI"></a>AI</h1><p>前面提到的图主要是用于寻路方面(e.g. A*)的知识储备。</p>
<p>接下来要提到的AI主要是涉及到角色AI行为决策的实现，本章主要以学习状态机，分层状态机以及行为树来理解AI中行为决策的几个常用实现方式加深AI行为决策学习理解，更多更深入的学习可参考《Artificial.Intelligence.for.Games》书籍。</p>
<h2 id="状态机"><a href="#状态机" class="headerlink" title="状态机"></a>状态机</h2><p>游戏中，一般人物或者游戏的状态都是有限的，这里我们可以使用状态机把这些有限的状态抽象出来，然后把各自的逻辑写在对应的状态中。一来逻辑清晰，二来各状态之间的关系也清晰。</p>
<p>打个比方：</p>
<p>游戏状态划分:</p>
<ul>
<li>游戏初始状态(刚进游戏的第一个状态，负责初始化所有模块引导进入游戏)</li>
<li>游戏更新状态(热更新的一个状态，负责处理热更新相关)</li>
<li>游戏UI状态(游戏玩法外的一个状态，比如游戏主城时候)</li>
<li>游戏Loading状态(切换场景加载显示Loading图的过渡状态)</li>
<li>游戏GamePlay状态(具体的某个玩法状态，比如选择关卡后进去的具体玩游戏状态)</li>
<li>游戏暂停状态(顾名思义暂停游戏的一个状态)</li>
<li>游戏退出状态(关闭退出游戏时的一个状态，可以做一些游戏清除保存工作)</li>
</ul>
<p><img src="/img/AI/GameStateMachine.png" alt="GameStateMachine"></p>
<p>这里就只放几个核心代码：</p>
<p>StateMachine.cs(状态机管理类)</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">StateMachine</span>&lt;<span class="title">T</span>&gt; <span class="keyword">where</span> <span class="title">T</span> : <span class="keyword">class</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 状态机拥有者</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">protected</span> T mOwner;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 当前游戏状态</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> StateTemplate&lt;T&gt; mCurrentState;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 当前游戏状态的int值(为了状态机通用这里没有写成特定Enum)</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> CurrentStateValue</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> mCurrentStateValue;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span> mCurrentStateValue;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 游戏状态机Map</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> Dictionary&lt;<span class="built_in">int</span>, StateTemplate&lt;T&gt;&gt; mStatesMap;    </span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">StateMachine</span>(<span class="params">T owner</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        mOwner = owner;</span><br><span class="line">        mCurrentState = <span class="literal">null</span>;</span><br><span class="line">        mCurrentStateValue = <span class="number">-1</span>;</span><br><span class="line">        mStatesMap = <span class="keyword">new</span> Dictionary&lt;<span class="built_in">int</span>, StateTemplate&lt;T&gt;&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 设置拥有者</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;owner&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setOwner</span>(<span class="params">T owner</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        mOwner = owner;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 消息响应处理</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;message&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span>(<span class="params">MessageData message</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(mCurrentState != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            mCurrentState.onMessage(message);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 游戏更新</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">update</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (mCurrentState != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            mCurrentState.executeState();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 注册游戏状态</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;state&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">registerState</span>(<span class="params"><span class="built_in">int</span> stateenum, StateTemplate&lt;T&gt; state</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (mStatesMap.ContainsKey(stateenum))</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="built_in">string</span>.Format(<span class="string">&quot;已经注册过状态:&#123;0&#125;&quot;</span>, stateenum));</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            mStatesMap.Add(stateenum, state);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 是否已经注册过特定状态</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;stateenum&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">hasRegisterSpecificState</span>(<span class="params"><span class="built_in">int</span> stateenum</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> mStatesMap.ContainsKey(stateenum);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 移除状态</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;stateenum&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">removeState</span>(<span class="params"><span class="built_in">int</span> stateenum</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (mStatesMap.ContainsKey(stateenum))</span><br><span class="line">        &#123;</span><br><span class="line">            mStatesMap.Remove(stateenum);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="built_in">string</span>.Format(<span class="string">&quot;状态:&#123;0&#125;未注册，无法移除！&quot;</span>, stateenum));</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 清除所有注册的游戏状态</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">clearAllStates</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mStatesMap.Clear();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 切换游戏状态</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;stateenum&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;param&quot;&gt;</span>状态切换参数<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">changeToState</span>(<span class="params"><span class="built_in">int</span> stateenum, <span class="keyword">params</span> <span class="built_in">object</span>[] param</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (mStatesMap.ContainsKey(stateenum))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (mCurrentState != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                mCurrentState.exitState();</span><br><span class="line">            &#125;</span><br><span class="line">            mCurrentState = mStatesMap[stateenum];</span><br><span class="line">            mCurrentStateValue = stateenum;</span><br><span class="line">            mCurrentState.setOwner(mOwner);</span><br><span class="line">            mCurrentState.enterState(param);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="built_in">string</span>.Format(<span class="string">&quot;未注册游戏状态:&#123;0&#125;&quot;</span>, stateenum));</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 清除所有数据状态</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">clearAll</span>()</span></span><br><span class="line">    &#123;        </span><br><span class="line">        mCurrentState = <span class="literal">null</span>;</span><br><span class="line">        mStatesMap.Clear();</span><br><span class="line">        mOwner = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>StateTemplate.cs(状态模板类)</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 游戏物体状态抽象基类</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">StateTemplate</span>&lt;<span class="title">T</span>&gt; <span class="keyword">where</span> <span class="title">T</span> : <span class="keyword">class</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 状态拥有者</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">protected</span> T mOwner;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 设置状态拥有者</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;owner&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setOwner</span>(<span class="params">T owner</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        mOwner = owner;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 获取状态拥有者</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> T <span class="title">getOwner</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> mOwner;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 进入当前状态</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;param&quot;&gt;</span>状态运行参数<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">enterState</span>(<span class="params"><span class="keyword">params</span> <span class="built_in">object</span>[] param</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 执行当前状态</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">executeState</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 退出当前状态</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">exitState</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>GameBaseState.cs(游戏状态基类)</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             GameBaseState.cs</span></span><br><span class="line"><span class="comment"> * Author:                  TONYTANG</span></span><br><span class="line"><span class="comment"> * Create Date:             2018/12/09</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 游戏状态基类</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">GameBaseState</span> : <span class="title">StateTemplate</span>&lt;<span class="title">GameManager</span>&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 进入当前状态</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;param&quot;&gt;</span>状态运行参数<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">enterState</span>(<span class="params"><span class="keyword">params</span> <span class="built_in">object</span>[] param</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        loadRes(param);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 执行当前状态</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">executeState</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 退出当前状态</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">exitState</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        unloadRes();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 加载相关资源</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">loadRes</span>(<span class="params"><span class="keyword">params</span> <span class="built_in">object</span>[] param</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 释放所有资源</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">unloadRes</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>代码就不详细说明了，看一眼大概就能明白了。</p>
<p>优点：</p>
<ol>
<li>对于状态不多不复杂的来说，可以把状态逻辑划分很清晰，易于维护</li>
</ol>
<p>缺点:</p>
<ol>
<li>对于复杂拥有过多状态的情况来说，维护成本高不方便管理(横向扩展不利于维护)</li>
</ol>
<p>针对缺点1的方案可以考虑HFSM(分层状态机)，通过细分大小状态机来进行更加细致的状态机分类。</p>
<p>结论：</p>
<p>FSM(有限状态机)更适合于状态数量不多不复杂的情况(e.g. 游戏状态分类)</p>
<h2 id="分层状态机"><a href="#分层状态机" class="headerlink" title="分层状态机"></a>分层状态机</h2><p><a target="_blank" rel="noopener" href="https://www.twblogs.net/a/5b7fb24f2b717767c6b1124d/zh-cn">详细HFSM参考</a></p>
<h2 id="行为树"><a href="#行为树" class="headerlink" title="行为树"></a>行为树</h2><p>行为树是本章AI决策的重点，考虑到篇幅过长，所以另起一篇博客来详解行为树在Unity里的实战学习。</p>
<p>详情参考:</p>
<p><a href="%5Bhttp://tonytang1990.github.io/2020/09/12/%E8%A1%8C%E4%B8%BA%E6%A0%91-Unity/%5D(http://tonytang1990.github.io/2020/09/12/%E8%A1%8C%E4%B8%BA%E6%A0%91-Unity/)">行为树-Unity</a></p>
<h3 id="行为树实战"><a href="#行为树实战" class="headerlink" title="行为树实战"></a>行为树实战</h3><p>目标：</p>
<ol>
<li>实现一个简易的行为树，深入理解行为树的原理和实现</li>
<li>配套一个简易的节点编辑器(支持可视化编辑和调试)</li>
</ol>
<p>实现：</p>
<ol>
<li>目标1通过自行实现一个简易版</li>
<li>目标2基于Unity原生GUI API来实现可视化节点编辑器</li>
</ol>
<h4 id="数据管理"><a href="#数据管理" class="headerlink" title="数据管理"></a>数据管理</h4><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/KillerAery/p/10054558.html">黑板模式</a></p>
<p>可以简单的理解成一个共享数据的地方。</p>
<h4 id="抽象行为树"><a href="#抽象行为树" class="headerlink" title="抽象行为树"></a>抽象行为树</h4><p>待添加……</p>
<h4 id="行为中断"><a href="#行为中断" class="headerlink" title="行为中断"></a>行为中断</h4><p>待添加……</p>
<h4 id="节点编辑器"><a href="#节点编辑器" class="headerlink" title="节点编辑器"></a>节点编辑器</h4><p>待添加……</p>
<h1 id="参考书籍"><a href="#参考书籍" class="headerlink" title="参考书籍"></a>参考书籍</h1><p>《Programming Game AI by Example》 – Mat Buckland<br>《Artificial Intelligence for Game》 – Ian Millington</p>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a target="_blank" rel="noopener" href="https://www.twblogs.net/a/5b7fb24f2b717767c6b1124d/zh-cn">FSM（状态机）、HFSM（分层状态机）、BT（行为树）的区别</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/AI/">AI</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/AI/">AI</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/08/29/装机相关知识/" title="装机相关知识" itemprop="url">装机相关知识</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Tony Tang" target="_blank" itemprop="author">Tony Tang</a>
		
  <p class="article-time">
    <time datetime="2015-08-29T10:28:18.000Z" itemprop="datePublished"> 发表于 2015-08-29</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="装机相关知识"><a href="#装机相关知识" class="headerlink" title="装机相关知识"></a>装机相关知识</h1><p>组装电脑组要的配件：<br>主板，CPU，显卡，内存，硬盘，外设，机箱，电源组成。</p>
<p>接下来就各个模块的相关概念参数进行学习了解，最后结合网上的经验之谈和自己的理论知识用于实践组机参考。</p>
<h2 id="装机模块"><a href="#装机模块" class="headerlink" title="装机模块"></a>装机模块</h2><h3 id="主板"><a href="#主板" class="headerlink" title="主板"></a>主板</h3><p>首先了解下主板在电脑中的作用：<br><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E4%B8%BB%E6%9D%BF">典型的主板能提供一系列接合点，供处理器、显卡、声卡、硬盘驱动器、内存、对外设备等设备接合。它们通常直接插入有关插槽，或用线路连接。</a></p>
<p><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E4%B8%BB%E6%9D%BF">主板上最重要的构成组件是芯片组（Chipset）。而芯片组通常由北桥和南桥组成，也有些以单片机设计，增强其性能。</a></p>
<p>可以看出主板是让所有电脑组件组合运行起来的关键，起到了模块连接，数据传递，提供硬件接口等重要作用。</p>
<p>主板购买装机需要考虑的点：</p>
<ol>
<li>兼容</li>
<li>稳定性</li>
<li>扩展</li>
</ol>
<p>以下主要是针对主板上的各个接口进行学习了解，了解他们每一个模块是负责做什么，所有模块是怎么整合运行起来的。后面会针对主要组件进行深入学习了解用于判断怎样的组件才是高性能更优的，帮助我们组装时购买各个组件提供理论知识。</p>
<p>首先让我们先看看主板的构成和架构图:<br><img src="/img/Graphic/MainBoard.PNG" alt="MainBoard"><br><img src="/img/Graphic/MainboardDiagram.PNG" alt="MainboardDiagram"></p>
<p>以下只列出了几个重要的模块进行了解：</p>
<ol>
<li>CPU插槽 – CPU插槽接口(CPU主要分为Intel和AMD，注意接口标准兼容问题)</li>
<li>芯片组 – CPU与其他组件沟通的桥梁，分为北桥(Normal Bridge)和南桥(South Bridge)<br>图二可以看出，北桥(NB)主要是负责CPU与RAM(内存)，AGP,PCI Express还有南桥的通信。<br>南桥主要是负责和外设，多媒体，通信接口等通信。<br>Note:<br>北桥随着发展被整合到CPU里了。 </li>
<li>AGP插槽(根据Wiki的说法被PCI Express取代了) – 显卡插槽专用接口<br><img src="/img/Graphic/PCIExpressPerformance.PNG" alt="PCI Express性能参考表"><br>当然最好的是PCI Express 3.0 x16。区分是x1,x4,x8,x16看针脚数量。<br>PCI Express总线对显卡传输的瓶颈暂时不考虑，情况比较复杂。尽量买支持PCI Express 3.0 x16插槽的主板就好。<br><img src="/img/Graphic/PCIExpressInfo.PNG" alt="PCI Express信息查看"><br>GPU-Z里的Bus Interface显示的就是PCI Express的版本和带宽数。</li>
<li>内存插槽 – 内存条插槽接口(多个内存插槽方便以后内存扩展)</li>
<li>PCI扩展插槽 – 外设(e.g. 网卡，声卡，调制解调器……)扩展插槽接口(被PCI Express慢慢取代)</li>
<li>mSATA(结合下面的图查看) – 安装我们平时说的SSD(固态硬盘)的插槽接口(推荐使用固态硬盘)<br><img src="/img/Graphic/mSATALocation.PNG" alt="mSATA插槽位置"></li>
<li>BIOS – <a target="_blank" rel="noopener" href="http://www.it892.com/content/hardware/onboard/2014/1001/5581.html">基本输入、输出系统)是一块装入了启动和自检程序的EPROM 或EEPROM 集成电路。</a></li>
</ol>
<p>主板决定了我们其他组件的选择范围(比如CPU必须和主板CPU插槽一致)，不然出现不兼容或者不允许安装就尴尬了。<br>Intel和AMD的CPU插槽详解参见下面链接：<br><a target="_blank" rel="noopener" href="http://www.it892.com/content/hardware/onboard/2013/0905/4863.html">电脑主板有哪些插槽详细介绍</a></p>
<h3 id="CPU"><a href="#CPU" class="headerlink" title="CPU"></a>CPU</h3><p><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E4%B8%AD%E5%A4%AE%E5%A4%84%E7%90%86%E5%99%A8">中央处理器(Central Processing Unit)，是计算机的主要设备之一，功能主要是解释计算机指令以及处理计算机软件中的数据。</a></p>
<p>CPU的好坏决定了运算速度。那么是什么决定了CPU性能好坏的了？<br>在了解决定因素之前，我们需要了解学习几个概念：</p>
<ol>
<li><p>主频 – CPU正常运行时的工作频率(一个时钟周期能完成的指令数是固定的，所以工作频率越高性能越高)</p>
</li>
<li><p>外频 – 系统总线的工作频率</p>
</li>
<li><p>倍频 – CPU外频与主频相差的倍数</p>
</li>
<li><p>超频 – <a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E8%B6%85%E9%A2%91%E6%8A%80%E6%9C%AF">过人为的方式将CPU、显卡等硬件的工作频率提高，让它们在高于其额定的频率状态下稳定工作</a>(通过改变CPU的倍频或者外频来实现)</p>
</li>
<li><p>前端总线 – <a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%89%8D%E7%AB%AF%E6%80%BB%E7%BA%BF">CPU和北桥芯片间总线的速度。</a><a target="_blank" rel="noopener" href="http://www.cnblogs.com/spinsoft/archive/2012/08/02/2619982.html">数据传输的速度，即每秒钟CPU可接受的数据传输量。</a></p>
</li>
<li><p>系统总线 – <a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%89%8D%E7%AB%AF%E6%80%BB%E7%BA%BF">创建在数字脉冲信号震荡速度基础之上的，也就是说，100MHz系统总线（BusSpeed）特指数字脉冲信号在每秒钟震荡一亿次，它更多的影响了PCI及其他总线的频率</a><br>[CPU与主板之间同步运行的速度，是指数字脉冲信号在每秒钟震荡的次数；</p>
<p>](<a target="_blank" rel="noopener" href="http://www.cnblogs.com/spinsoft/archive/2012/08/02/2619982.html">http://www.cnblogs.com/spinsoft/archive/2012/08/02/2619982.html</a>)</p>
</li>
</ol>
<p>公式：<br>CPU主频&#x3D;CPU外频(系统总线)×CPU倍频系数</p>
<p>不同的CPU(Intel or AMD)，CPU外频(系统总线)和前端总线频率关系不一样：<br>Intel CPU来说，前端总线&#x3D;系统总线*4</p>
<p>超频会带来影响CPU的稳定性，更发热，需要更大供电等问题。</p>
<p>了解了上述概念，不难看出，CPU的性能好坏主要是由主频和超频能力决定的。<br>通过CPU-Z工具，我们可以看到CPU相关的详细信息:<br><img src="/img/Graphic/CPUProcessorFrequency.PNG" alt="CPU-Z信息查看"><br>结合我在Intel官网查到的CPU信息:<br><img src="/img/Graphic/MyCPUInfo.PNG" alt="我的CPU信息"><br>从上面可以看出，我的电脑CPU基本频率2.3GHz，超频最高达到3.3GHz，倍频是在12-33之间变化。</p>
<p>组装购买CPU时，不仅要考虑CPU的性能好坏，还要考虑前端总线的传输能力，如果前端总线远远小于CPU的频率那么性能就受限于前端总线，反之亦然。</p>
<p>其次CPU还要考虑一个很重要的点：<br><strong>多核</strong>，多核能提升多线程并行处理运算的能力，特别是很多大型游戏都会利用CPU的多核运算能力去利用加开运算速度。后端服务器尤其看重多核，个人认为也是为了提高并行运算能力。。所以除了看CPU主频多核也是一个很重要的参考点。</p>
<p>CPU性能比较参考CPU天梯图：<br><a target="_blank" rel="noopener" href="http://www.xiazaiba.com/jiaocheng/10299.html">CPU 2017年9月天梯图</a></p>
<p>Note:<br><a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E8%B6%85%E9%A2%91%E6%8A%80%E6%9C%AF">超频是一个广义的概念，它是指任何提高计算机某一部件工作频率而使之工作在非标准频率下的行为及相关行动都应该称之为超频，其中包括CPU超频、主板超频、内存超频、显示卡超频和硬盘超频等等很多部分</a><br>外频 &#x3D;&#x3D; 系统总线频率     外频 !&#x3D; 前端总线频率</p>
<h3 id="显卡"><a href="#显卡" class="headerlink" title="显卡"></a>显卡</h3><p>显卡这里就不详细重复讲解了，详情参考本文前面关于GPU的知识学习。<br>这里只写几个结论总结：</p>
<ol>
<li>显存带宽&#x3D;显存频率×显存位宽&#x2F;8</li>
<li><a target="_blank" rel="noopener" href="http://baike.baidu.com/link?url=7ZA_4BfDbr6GrWB63XmAgdxAZ-DqUPT9d0kDK8j9f_-udpQhPYw-ZOtKeSwbB8SOWHqhiQskJH0jb36MYm6VQ6upLVWhC77F8i4S50E_lAX50K2SbzvvnvRpM2oszbaI0fVwW2eimU_ARUXMS1HIT_">一款显卡的性能由“像素填充率”和“显存带宽”两个部分构成。“像素填充率”衡量的是显卡的图形运算能力，“显存带宽”衡量的是显卡的数据传输能力。</a></li>
<li>GDDR5一般比GDDR3提供的频率更高(显卡性能要求高的优先考虑GDR5)</li>
</ol>
<p>所以买显卡主要看中的是“像素填充率”和“显存带宽”。<br>GPU性能比较参考GPU天梯图：<br><a target="_blank" rel="noopener" href="http://www.xiazaiba.com/jiaocheng/10296.html">GPU 2017年9月天梯图</a></p>
<h3 id="内存"><a href="#内存" class="headerlink" title="内存"></a>内存</h3><p><a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E5%86%85%E5%AD%98%E6%9D%A1">内存条是CPU可通过总线寻址，并进行读写操作的电脑部件。所有外存上的内容必须通过内存才能发挥作用。</a></p>
<p>可以看出内存的读写速度和CPU的运行速度是相辅相成的，一旦某一个速度跟不上都会造成性能上的瓶颈。</p>
<p>现在主流的内存采用的是DDR(Double Data Rate)技术，通过在一次系统时钟的上升沿和下降沿都可以进行数据传输实现双倍率传输。</p>
<p>DDR的内存速度计算公式：<br>内存实际频率 &#x3D; 内存频率 * 2(DDR技术，倍增系数)<br>带宽&#x3D;内存时钟频率×内存总线位数(多通道技术会提升理论内存位宽)×2(DDR技术，倍增系数)&#x2F;8</p>
<p>现在主流的内存是DDR3，DDR4还没有普及性价比不高而且需要特定的主板支持。需要注意的一点就是因为内存和CPU是相辅相成的，但内存与CPU之间的桥梁是前端总线，所以为了确保内存得到充分利用同时也不受限于前段总线频率，我们应该尽量选择前端总线频率和内存频率(这里的内存频率是指计算DDR技术和多通道技术之后的一个内存频率)相近的。</p>
<p>那么内存的读写速度由什么决定了？<br>跟显卡，CPU差不多，主要看频率和位宽，前者受DDR技术影响提高一倍，后者会受多通道技术影响。</p>
<p>Note:<br>这里的内存指的是CPU所使用的内存而非GPU的显存。<br>DDR3和DDR4不兼容，不支持混用。</p>
<h3 id="硬盘"><a href="#硬盘" class="headerlink" title="硬盘"></a>硬盘</h3><p>硬盘有机械硬盘(HDD)和固态硬盘(SSD)之分。<br>推荐使用固态硬盘的原因:</p>
<ol>
<li>比机械硬盘读写速度快</li>
<li>虽然擦写次数寿命比机械硬盘少，但理论上足够在几十年内使用</li>
<li>价格比机械硬盘贵，但在容量比较小的情况下还能够接受(推荐C盘系统盘弄个64G或者128G的SSD)</li>
</ol>
<p>这里要注意的是支持SSD的标准现在有很多，现在比较常见和流行的是SATA 3.0 6G。<br>其他还有PCL-E 3.0，mSATA，SATA Express，M.2等。<br><a target="_blank" rel="noopener" href="http://news.mydrivers.com/1/504/504984.htm">SSD接口全解析</a></p>
<h3 id="外设-鼠标，键盘，显示器"><a href="#外设-鼠标，键盘，显示器" class="headerlink" title="外设(鼠标，键盘，显示器)"></a>外设(鼠标，键盘，显示器)</h3><h4 id="键盘"><a href="#键盘" class="headerlink" title="键盘"></a>键盘</h4><p>普通键盘和机械键盘之分<br>看个人需求，机械键盘多用于专业人员(比如程序员)<br>机械键盘比普通键盘贵上很多倍，个人衡量价格。</p>
<h4 id="鼠标"><a href="#鼠标" class="headerlink" title="鼠标"></a>鼠标</h4><p>省略</p>
<h4 id="显示器"><a href="#显示器" class="headerlink" title="显示器"></a>显示器</h4><p>显示质量：<br>屏幕显示技术(IPS，PLS，TN)影响显示器显示效果。<br>详情参考:<br><a target="_blank" rel="noopener" href="https://www.zhihu.com/question/19571221">显示器的 VGA、HDMI、DVI 和DisplayPort接口有什么区别？</a></p>
<p>接口：<br>接口影响传输效率。</p>
<p>Note：<br>注意主板支持的VGA，DVI,HDMI,DP接口与显示器支持的接口一致。</p>
<p>分辨率选择:<br>分辨率除了考虑接口传输速度的支持，还要考虑线的传输速度限制(比如HDMI 1.4和HDMI 2.0所支持的传输速度就有很大区别，2K，4K对线的要求参考下方连接)。<br>详情参考:<br><a target="_blank" rel="noopener" href="http://digi.tech.qq.com/a/20160311/010517.htm">4K、2K超清显示器普及了 可高清线你会选吗？</a></p>
<h3 id="机箱"><a href="#机箱" class="headerlink" title="机箱"></a>机箱</h3><p>注意买与主板大小相匹配的机箱(比如 ATX大板，ATX小板等)。<br>考虑到铺线的问题，提前了解下机箱内部结构是否分布合理。</p>
<h3 id="电源"><a href="#电源" class="headerlink" title="电源"></a>电源</h3><p>保证电源稳定，且瓦数满足主板供电需求。(普通配置500W应该都能满足，高配置参考各配件的功耗来决定最终电源瓦数)</p>
<h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><h4 id="USB接口"><a href="#USB接口" class="headerlink" title="USB接口"></a>USB接口</h4><p>USB 3.0比USB 2.0高的不是一个数量级(理论上传输速度相差10倍以上)，能支持USB 3.0最好。</p>
<p>Note:<br>要想使用USB 3.0除了接口要支持，插入的USB设备也要支持USB 3.0才行。</p>
<h2 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h2><h3 id="装机"><a href="#装机" class="headerlink" title="装机"></a>装机</h3><ol>
<li>主板与CPU以及GPU<br>主板会决定是支持Intel CPU还是AMD CPU，同时主板会决定是支持NVIDA还是AMD显卡。</li>
</ol>
<p>CPU:<br>Intel CPU主要看是支持LGA ***多少，不一样的话会导致无法支持。<br>AMD CPU主要是看支持FX，AM2还是AM3，还是AM4标准等。</p>
<p>GPU:<br>显卡两大生产商NVIDA和AMD，两者一般不会同时支持，所以选主板和GPU的时候要注意。GPU主要是要注意主板支持的显卡插槽是PCLE 2.0还是PCLE 3.0，显卡GPU和主板的插槽要支持同样的PCLE版本，推荐选择最新的PCLE版本。</p>
<ol start="2">
<li>主板与SSD<br>选主板的时候会决定所支持的SSD接口标准，确定了支持的SSD标准，我们才能买到正确可以插上使用的SSD型号。现在流行的性价比高的就是比较普通的SATA 3.0接口。</li>
</ol>
<h3 id="尺寸"><a href="#尺寸" class="headerlink" title="尺寸"></a>尺寸</h3><ol>
<li>机箱和主板尺寸<br>机箱尺寸要和主板大小配合，有ATX，M-ATX等主板大小</li>
</ol>
<h2 id="硬件以及性能检测工具"><a href="#硬件以及性能检测工具" class="headerlink" title="硬件以及性能检测工具"></a>硬件以及性能检测工具</h2><h3 id="CPU-Z"><a href="#CPU-Z" class="headerlink" title="CPU-Z"></a>CPU-Z</h3><p>免费的检测硬件信息的一款软件(但在GPU方面还不是很足，所以下面有GPU-Z互补)<br>下载链接:<br><a target="_blank" rel="noopener" href="https://www.cpuid.com/softwares/cpu-z.html">CPU-Z Download</a></p>
<h3 id="GPU-Z"><a href="#GPU-Z" class="headerlink" title="GPU-Z"></a>GPU-Z</h3><p>免费的检测GPU硬件方面信息的一款软件<br>下载链接:<br><a target="_blank" rel="noopener" href="https://www.techpowerup.com/gpuz/">GPU-Z</a></p>
<h3 id="AS-SSD-Benchmark"><a href="#AS-SSD-Benchmark" class="headerlink" title="AS SSD Benchmark"></a>AS SSD Benchmark</h3><p>一款免费的检测硬盘速度以及SSD 4K对齐的软件。</p>
<h3 id="鲁大师"><a href="#鲁大师" class="headerlink" title="鲁大师"></a>鲁大师</h3><p>这个不用介绍了，检测跑分(CPU, GPU, 硬盘等)。<br><a target="_blank" rel="noopener" href="http://www.ludashi.com/">鲁大师</a></p>
<h1 id="装机相关参考网站"><a href="#装机相关参考网站" class="headerlink" title="装机相关参考网站"></a>装机相关参考网站</h1><h2 id="Conception-Part"><a href="#Conception-Part" class="headerlink" title="Conception Part"></a>Conception Part</h2><p><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E4%B8%BB%E6%9D%BF">主板</a><br><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%8C%97%E6%A1%A5">北桥</a><br><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%8D%97%E6%A1%A5">南桥</a><br><a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E8%B6%85%E9%A2%91%E6%8A%80%E6%9C%AF">超频技术</a><br><a target="_blank" rel="noopener" href="https://baike.baidu.com/item/CPU%E6%80%A7%E8%83%BD%E6%8C%87%E6%A0%87/7779822">cpu性能指标</a><br><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%A4%9A%E9%80%9A%E9%81%93%E8%A8%98%E6%86%B6%E9%AB%94%E6%8A%80%E8%A1%93">多通道内存技术</a></p>
<h2 id="Knowledge-Part"><a href="#Knowledge-Part" class="headerlink" title="Knowledge Part"></a>Knowledge Part</h2><p><a target="_blank" rel="noopener" href="http://www.it892.com/content/hardware/onboard/2014/1001/5581.html">计算机主板的组成部分及芯片介绍</a><br><a target="_blank" rel="noopener" href="https://developer.nvidia-china.com/forum.php?mod=viewthread&tid=7683">PCI-E 总线对GPU性能的影响</a><br><a target="_blank" rel="noopener" href="https://www.zhihu.com/question/57270200">DDR3和DDR4内存的区别</a><br><a target="_blank" rel="noopener" href="http://www.cnblogs.com/spinsoft/archive/2012/08/02/2619982.html">CPU主频，倍频，外频，系统总线频率，前端总线频率</a><br><a target="_blank" rel="noopener" href="http://www.it892.com/content/hardware/onboard/2013/0905/4863.html">电脑主板有哪些插槽详细介绍</a></p>
<h2 id="Performance-Comparision-Part"><a href="#Performance-Comparision-Part" class="headerlink" title="Performance Comparision Part"></a>Performance Comparision Part</h2><p><a target="_blank" rel="noopener" href="https://www.cpubenchmark.net/">CPU，GPU，RAM等Benchmark</a><br><a target="_blank" rel="noopener" href="http://www.xiazaiba.com/jiaocheng/10296.html">2017年9月 GPU天梯图</a><br><a target="_blank" rel="noopener" href="http://www.xiazaiba.com/jiaocheng/10299.html">2017年9月 CPU天梯图</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Other/">Other</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Computer/">Computer</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/08/29/计算机图形学相关知识/" title="计算机图形学相关知识" itemprop="url">计算机图形学相关知识</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Tony Tang" target="_blank" itemprop="author">Tony Tang</a>
		
  <p class="article-time">
    <time datetime="2015-08-29T10:28:18.000Z" itemprop="datePublished"> 发表于 2015-08-29</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>参考书籍：<br>《OpenGL Programming Guide 8th Edition》 – Addison Wesley<br>《Fundamentals of Computer Graphics (3rd Edition)》 – Peter Shirley, Steve Marschnner<br>《Real-Time Rendering, Third Edition》 – Tomas Akenine-Moller, Eric Haines, Naty Hoffman</p>
<h1 id="Rendering-Knowledge"><a href="#Rendering-Knowledge" class="headerlink" title="Rendering Knowledge"></a>Rendering Knowledge</h1><p>在进入书籍内容的学习之前，先了解一些必要的知识</p>
<h2 id="What-is-Rendering"><a href="#What-is-Rendering" class="headerlink" title="What is Rendering?"></a>What is Rendering?</h2><p>“Rendering is a process that takes as its input a set of objects and produces as its output an array of pixels.” – 《Fundamentals of Computer Graphics (3rd Edition)》</p>
<p>既然Rendering是通过处理一系列的对象数据最终输出成一组一组的像素呈现出来，那接下来的问题就是What is the rendering process(Graphic Pipeline)?</p>
<h2 id="What-is-the-rendering-process-Graphic-Pipeline"><a href="#What-is-the-rendering-process-Graphic-Pipeline" class="headerlink" title="What is the rendering process(Graphic Pipeline)?"></a>What is the rendering process(Graphic Pipeline)?</h2><p>首先我们来看看wiki上对pipieline的解释<br><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Graphics_pipeline">the sequence of steps used to create a 2D raster representation of a 3D scene.</a><br>那么结合Rendering的定义，不难看出Rendering pipeline就是一系列的操作（把前一个操作的输出当做输入）使得输入的对象数据最终以像素的形式输出到屏幕上</p>
<p>Note:<br>“A chain is no stronger than its weakest link.”<br>										—Anonymous<br>渲染的速度是由最慢的阶段决定的。</p>
<p>图形渲染和GPU的是密不可分的。<br>渲染管线最大的变化就是从传统的固定渲染管线转变到了可编程的渲染管线。</p>
<p>在了解固定渲染管线和可编程渲染管线之前，先让我们来了解一下什么是Rendering Pipeline。</p>
<h3 id="Rendering-Pipeline-Stages"><a href="#Rendering-Pipeline-Stages" class="headerlink" title="Rendering Pipeline Stages"></a>Rendering Pipeline Stages</h3><p><img src="/img/Graphic/Rendering_Stages.PNG" alt="Rendering_Stages"></p>
<ol>
<li><p>Application<br>e.g collision detection, global acceleration algorithms, animation, physics simulation….. (On CPU)<br>Acceleration algorithms, such as hierarchical view frustum culling, are also implemented in this stage. – 《Real-Time Rendering, Third Edition》<br>可以看出Application阶段主要是做一些非渲染相关的一些计算，但部分计算也可以帮助我们减少渲染数量提高渲染效率(比如:hierachical view frustum culling)</p>
</li>
<li><p>Geometry<br><img src="/img/Graphic/Geometry_Stage.PNG" alt="Geometry_Stage"><br>Deal with transforms, projection. Computes what is to be draw, how it should be drawn, and where it should be drawn (On GPU)<br>e.g. model and view transform, vertex shading, projection, clipping, and screen mapping – 《Real-Time Rendering, Third Edition》<br>可以看出Geometry阶段主要是负责3D到2D Screen的顶点运算和顶点剔除</p>
</li>
<li><p>Rasterizer<br><img src="/img/Graphic/Rasterize_Stage.PNG" alt="Rasterize_Stage"><br>Conversion from two-dimensional vertices in screen space – each with a z-value (depth value), and various shading information associated with each vertex – into pixels on the screen (On GPU) – 《Real-Time Rendering, Third Edition》<br>可以看出Rasterizer阶段主要是负责2D Screen的顶点像素运算(包括Z-Buffer test, Color computation, Alpha test, Stencil buffer等)</p>
</li>
</ol>
<p><strong>Accumulation Buffer</strong> – Images can be accumulated using a set of operators. E,g, motion blur……</p>
<p>让我们结合OpenGL Rendering Pipeline来学习理解：<br><img src="/img/OpenGL/OpenGL_Render_Pipeline.PNG" alt="OpenGL_Rendering_Pipeline"><br>从上图可以看出，OpenGL的第一个阶段Vertex Data相当于Application阶段所收集的数据</p>
<p>不难看出从Vertex Shader到Clipping都属于从3D到2D Screen的顶点运算和顶点剔除，所以这一部分处于Geometry阶段(由于后来统一架构的(US)原因，Vertex Shader, Geometry Shader, Pixel Shader很多)</p>
<p>而从Rasterization到最后的屏幕输出都是对像素的运算，所以是Rasterizer阶段<br><a href="http://tonytang1990.github.io/2015/08/26/OpenGL-Study/">OpenGL更多的学习了解</a></p>
<p>了解了什么是Rendering Pipeline之后，让我们来看看什么是固定管线和可编程管线？他们之间的关系是怎样的？</p>
<h3 id="传统的固定渲染管线"><a href="#传统的固定渲染管线" class="headerlink" title="传统的固定渲染管线"></a>传统的固定渲染管线</h3><p>什么叫做“像素渲染管线”了？<br>“<a target="_blank" rel="noopener" href="http://vga.zol.com.cn/238/2386200_all.html">传统的一条渲染管线是由包括Pixel Shader Unit（像素着色单元）+ TMU(纹理贴图单元) + ROP（光栅化引擎）三部分组成的。用公式表达可以简单写作：PS&#x3D;PSU+TMU+ROP 。从功能上看，PSU完成像素处理，TMU负责纹理渲染，而ROP则负责像素的最终输出。所以，一条完整的像素管线意味着在一个时钟周期完成至少进行1个PS运算，并输出一次纹理。</a>”</p>
<p>那么什么是PSU(像素着色器单元)？什么是TMU(纹理贴图单元)？什么是ROP(光栅化引擎)了？<br>在统一渲染架构（US(Unified Shader)）出现之前有单独的<strong>顶点着色器单元</strong>和<strong>像素着色器单元</strong>，分别负责顶点数据和像素处理。</p>
<p><strong>TMU(纹理贴图单元 – Texture Mapping Unit)</strong><br><a target="_blank" rel="noopener" href="http://vga.zol.com.cn/243/2433760_all.html">归根到底就是对材质的贴图和过滤操作。根据程序的需要，在完成几何处理和光栅化之后，TMU单元会从材质库中找出合适的纹理贴在对应的位置上以实现模型的外形完整化</a>”<br>在可编程渲染管线(Shader)出现后，程序员可以实现对像素级别上的操作，可以实现更加真实的效果(预先烘焙的材质无法真实的实时渲染)。Vertex Texture Fetch(顶点纹理拾取)的出现允许Vertex Shader直接访问材质的一些信息，这也算是TMU进军GPGPU的一个契机。<br><a target="_blank" rel="noopener" href="http://vga.zol.com.cn/243/2433760_all.html">从DirectX 9.0C开始，TMU单元正式分割成了TA和TF两个部分，TA单元专门负责材质的定址操作，在完成定址之后，TF单元根据定址结果对材质进行拾取并完成贴图作业。</a><br>后续改进<a target="_blank" rel="noopener" href="http://vga.zol.com.cn/243/2433760_all.html">纹理阵列(处理材质操作的纹理单元阵列)以及Gather指令(Gather指令的作用，在于允许单元从非连续存储器地址中直接读取数据。)</a><br>Computer Shader的出现也使得纯数学的纹理计算成为了可能。</p>
<p><strong>ROP(光栅化引擎 – Render Output Units)</strong><br><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Render_output_unit">The render output unit, often abbreviated as “ROP”, and sometimes called (perhaps more properly) raster operations pipeline.</a><br>Conversion from two-dimensional vertices in screen space – each with a z-value (depth value), and various shading information associated with each vertex – into pixels on the screen (On GPU) – 《Real-Time Rendering, Third Edition》</p>
<h3 id="可编程渲染管线"><a href="#可编程渲染管线" class="headerlink" title="可编程渲染管线"></a>可编程渲染管线</h3><p>为什么会有可编程渲染管线了？<br>“<a target="_blank" rel="noopener" href="http://vga.zol.com.cn/238/2386200_all.html">由于传统的渲染管线不可编辑性，实现的图像效果受到很大限制，Shader(着色器)的引入就替代了传统的固定渲染管线，实现了可编程的渲染管线，各个Shader(着色器)替代了固定渲染管线中相应的功能。</a>”</p>
<p>那么什么是Shader(着色器)？Shader(着色器)和GPU硬件的关系是怎样的了？<br>“Shaders are programmed using C-like shading languages such as HLSL, Cg and GLSL. These are compiled to a machine-independent assembly language, also called the intermediate language(IL). This assembly language is converted to the actual machine language in a separate step, usually in the drivers. This arrangement allows compatibility across different hardware implementations.” – Real-Time Rendering, Third Edition》<br><a target="_blank" rel="noopener" href="http://vga.zol.com.cn/238/2386200_all.html">GPU的像素着色器单元和顶点着色器单元就对应了Shader里面的Pixel Shader和Vertex Shader。由于像素在计算机都是以RGB三种颜色构成，加上Alpha总共4个通道，所以GPU的像素着色器单元和顶点着色器单元一开始就被设计成为同时具备4次运算能力的算数逻辑运算器(ALU)</a></p>
<p>从上面可以看出Shader是machine-independent的，因为事先被编译成了与机器无关的intermediate language(This intermediate language can be seen as defining a <strong>virtual machine</strong>, which is targeted by the shading language compiler – 《Real-Time Rendering, Third Edition》)， 最后才会被机器转换成机器码来运行.</p>
<p>可编程Shading进化史可参考<br>3.3 The Evolution of Programmable Shading – 《Real-Time Rendering, Third Edition》</p>
<h2 id="计算机架构与Shader的关系"><a href="#计算机架构与Shader的关系" class="headerlink" title="计算机架构与Shader的关系"></a>计算机架构与Shader的关系</h2><h3 id="非同一架构"><a href="#非同一架构" class="headerlink" title="非同一架构"></a>非同一架构</h3><p>那么影响Pixel Shader和Vertex Shader速度的因素又是什么了？<br>数据流处理速度。</p>
<p>我们都知道计算机是通过发送指令来对数据进行处理的，而计算机架构则是对指令流和数据处理的设计，是影响数据流处理速度的关键。</p>
<p>根据Flynn分类法，计算机架构分为：</p>
<ol>
<li>SISD(Single Instruction Signle Data Stream) – 单指令单数据流<br>“<a target="_blank" rel="noopener" href="http://vga.zol.com.cn/238/2386200_all.html">传统的顺序执行的计算机在同一时刻只能执行一条指令（即只有一个控制流）、处理一个数据（即只有一个数据流），因此被称为单指令单数据流计算（Single Instruction Single Data Stream,SISD）</a>”</li>
<li>MIMD(Multiple Instruction Multiple Data Stream) – 多指令多数据流<br><img src="/img/Graphic/MIMD.PNG" alt="MIMD"><br>“<a target="_blank" rel="noopener" href="http://vga.zol.com.cn/238/2386200_all.html">而对于大多数并行计算机而言，多个处理单元都是根据不同的控制流程执行不同的操作，处理不同的数据，因此，它们被称作是多指令流多数据流计算机，即MIMD（Multiple Instruction Stream Multiple Data Stream，简称MIMD）计算机，它使用多个控制器来异步地控制多个处理器，从而实现空间上的并行性。</a>”</li>
<li>SIMD(Single Instruction Multiple Data Stream) – 单指令多数据流<br><img src="/img/Graphic/SIMD.PNG" alt="SIMD"></li>
<li>MISD(Multiple Instruction Single Data Stream) – 多指令多数据流</li>
</ol>
<p>那么各个计算机架构设计之间的优势和劣势分别是什么了？<br>还记得我们之前说的像素着色单元和顶点着色单元已开被设计成具备4次运算能力的算数逻辑运算器(ALU)吗？<br>因为数据的基本单元是Scalar(标量),GPU的ALU一个时钟周期可进行四次这种变量并行运算。<br>那么如果我们传入4D标量进行运算，SIMD可以最大程度满足我们的需求，达到GPU利用率100%。但如果我们传入1D标量进行运算，SIMD的效率就会下降到原来的四分之一（随着API的更新，1D&#x2F;2D&#x2F;3D等混合指令开始大幅出现），固传统的SIMD架构效率开始降低。而3D+1D&#x2F;2D+2D等混合架构设计也并不能最大限度利用ALU运算能力，这也是统一架构出现的契机。</p>
<h3 id="统一架构"><a href="#统一架构" class="headerlink" title="统一架构"></a>统一架构</h3><p>“<a target="_blank" rel="noopener" href="http://vga.zol.com.cn/238/2386200_all.html">为了解决ALU利用率的问题，微软在Direct X 10提出了统一渲染架构的概念。<br>核心思想是：将Vertex Shader(顶点着色器)和Pixel Shader(像素着色器)单元合并成一个具备完整执行能力的US(Unified Shader,统一渲染)单元，指令直接面向底层的ALU而非过去的特定单元，所以在硬件层面US可以同时吞吐一切shader指令，同时并不会对指令进行任何修改，也不会对shader program的编写模式提出任何的强迫性的改变要求。</a>”<br><img src="/img/Graphic/US.PNG" alt="US"></p>
<p>统一架构出来以后，因为有了US(Unified Shader)单元，指令直接面向底层的ALU而非特定单元，所以后来的N卡统一架构把原来的4D着色器单元完全打散，流处理器(SP)统统由矢量设计改为了标量运算单元(由4D矢量运算器改为了1D标量运算器)，采用的是MIMD架构。</p>
<p>MIMD架构相比SIMD架构需要占用更多的晶体管数，因为4个1D标量ALU和一个4D矢量ALU的运算能力是相当的，但前者需要4个指令发射端和4个控制单元，而后者只需要1个</p>
<p>而A卡的流处理器(SPU)依然采用的是SIMD(单指令多数据流)架构，每个SPU内包含了5个ALU。</p>
<p>“<a target="_blank" rel="noopener" href="http://vga.zol.com.cn/238/2386200_all.html">N卡A卡对比总结：英伟达的所采用的MIMD（多指令流多数据流）标量架构的G80核心需要占用不少额外的晶体管，所以在流处理器数量和理论运算能力方面稍显吃亏，但优点是GPU Shader执行效率很高；而AMD所采用的SIMD(单指令多数据流)超标量架构的R600核心则用较少的晶体管数实现了更多的流处理器数量和更高的理论运算能力，不过在执行效率方面则需要视情况而定了</a>”</p>
<p>N卡的第二次革新引入的atomic单元以及SIMT(Single Instruction Multiple Thread)特性对N卡并行化设计起到了先到作用。</p>
<p>“<a target="_blank" rel="noopener" href="http://vga.zol.com.cn/238/2386200_all.html">N卡的第三次革新引入了四大块就是GPC(Graphics Processing Cluster,图形处理器簇)，每个GPC单元包含独立的集合引擎以及光栅化流水线，GPC模块之间透过新加入的L2 cache进行通讯,kernel和Thread的协调以及数据共享。这无疑使得GF100的三角形吞吐量有了将近300%的提升，也实现了并行的分块化渲染动作，更使得DirectX 11所要求的TS单元直接融入到了整个光栅化流水线内部。</a>”<br><img src="/img/Graphic/NThird.PNG" alt="N_Third"><br><img src="/img/Graphic/N_PE_RE.PNG" alt="N_PE_RE"></p>
<p><a target="_blank" rel="noopener" href="http://vga.zol.com.cn/238/2386200_all.html">A卡第二第三次革新</a></p>
<h2 id="Shader-Virtual-Machine-Shader-Model"><a href="#Shader-Virtual-Machine-Shader-Model" class="headerlink" title="Shader Virtual Machine (Shader Model)"></a>Shader Virtual Machine (Shader Model)</h2><p>了解了计算机架构与Shader的关系，让我们来看看Common-shader core virtual machine architecture and register layout吧<br><img src="/img/Graphic/Shader_Core_Virtual_Machine_Architecture.PNG" alt="Shader_Core_Virtual_Machine_Architecture_And_Register_Laout"></p>
<h3 id="Input-Type"><a href="#Input-Type" class="headerlink" title="Input Type"></a>Input Type</h3><ol>
<li><p>Uniform inputs<br>With values that remain constant throughout a draw call(but can be changed between draw calls) – accessed via read-only constant registers or constant buffers</p>
</li>
<li><p>Varying inputs<br>Which are different for each vertex or pixel processed by the shader – accessed via varying input registers</p>
</li>
</ol>
<h3 id="Shader-Knowledge"><a href="#Shader-Knowledge" class="headerlink" title="Shader Knowledge"></a>Shader Knowledge</h3><h4 id="Shader"><a href="#Shader" class="headerlink" title="Shader"></a>Shader</h4><p>Shader programs can be compiled offline before program load or during run time. As with any compiler, there are options for generating different output files and for using different optimization levels. A compiled shader is stored as a string of text, which is passed to the GPU via the driver.</p>
<h4 id="MRT-Multiple-Render-Target"><a href="#MRT-Multiple-Render-Target" class="headerlink" title="MRT(Multiple Render Target)"></a>MRT(Multiple Render Target)</h4><p><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Multiple_Render_Targets">MRT is a feature of modern graphics processing units, that allows the programmable rendering pipeline to render images to multiple render target textures at once. These textures can then be used as inputs to other shaders or as texture maps applied to 3D models.</a><br>？不是非常明白这里。大概是一次渲染可以对象信息存储在多个buffer里，然后以texture的形式交给后续pass的pixel shader做处理<br><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Deferred_shading">wiki上提到MRT的一个使用<strong>deferred shading</strong></a><br>在first pass的时候收集相应信息存储在特定buffer里，在second pass（真正的渲染绘制是在这里）的时候Pixel shader把这些信息用作渲染数据，把整个场景一次性渲染出来而不是针对每个空间物体进行光照，材质等渲染</p>
<h4 id="Effects"><a href="#Effects" class="headerlink" title="Effects"></a>Effects</h4><h5 id="什么是Effects文件了？"><a href="#什么是Effects文件了？" class="headerlink" title="什么是Effects文件了？"></a>什么是Effects文件了？</h5><p><a target="_blank" rel="noopener" href="https://msdn.microsoft.com/en-us/library/windows/desktop/ff476136(v=vs.85).aspx">A DirectX effect is a collection of pipeline state, set by expressions written in HLSL and some syntax that is specific to the effect framework</a></p>
<p>可以看出Effects文件主要是记录一系列的渲染状态和固定信息用于特定渲染流程里。</p>
<h5 id="为什么需要Effects文件了？"><a href="#为什么需要Effects文件了？" class="headerlink" title="为什么需要Effects文件了？"></a>为什么需要Effects文件了？</h5><p>在我们事先特定效果的渲染时，不仅需要一系列的shader文件，我们同时会设定相应的渲染状态和一些固定的渲染信息，这些状态和信息对于特定效果来说是固定不变的，所以通过Effects文件可以有效的帮助我们记录特定效果所需的渲染状态等信息，方便重复使用。</p>
<h5 id="Effects-Languages"><a href="#Effects-Languages" class="headerlink" title="Effects Languages"></a>Effects Languages</h5><p>Such as HLSL FX, CgFX, and COLLADA FX</p>
<h3 id="Shader-Models-Comparision"><a href="#Shader-Models-Comparision" class="headerlink" title="Shader Models Comparision"></a>Shader Models Comparision</h3><p><img src="/img/Graphic/Shader_Model_Comparision.PNG" alt="Shader_Models_Comparision"></p>
<h2 id="渲染总结"><a href="#渲染总结" class="headerlink" title="渲染总结"></a>渲染总结</h2><p>可编程管线的出现主要是由于固定管线能实现的渲染效果有限不够灵活，Shader的出现象征着可编程管线的诞生。</p>
<p>统一渲染架构主要是为了提高ALU(算数逻辑运算器)利用率的问题。US(Unified Shader)单元的出现象征则统一渲染架构的开始，指令直接面向底层的ALU而非特定单元，流处理器的数量成为了性能的关键，流处理器的设计和架构紧密相关。（并行分块花渲染也随之出现）</p>
<p>“<a target="_blank" rel="noopener" href="http://vga.zol.com.cn/238/2386200_all.html">DX9到DX10是一大转折点：结束管线时代，开启GPU统一渲染架构时代。在DX9时代，大家都是通过“(像素)管线”来衡量显卡的性能等级，而到了DX10时代，统一渲染架构的引入使得显卡不再区分“像素”和“顶点”，因此“管线”这种说法逐渐淡出了大家的视野，取而代之的是全新统一渲染架构的“流处理器”，“流处理器”的数量直接影响着显卡的性能。</a>”</p>
<p><a href="http://tonytang1990.github.io/2015/08/26/OpenGL-Study/">OpenGL更多的学习了解</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Rendering/">Rendering</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/OpenGL/">OpenGL</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>







  <nav id="page-nav" class="clearfix">
    <a class="extend prev" rel="prev" href="/page/4/">&lt;span&gt;&lt;&#x2F;span&gt;Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><span class="page-number current">5</span><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/6/">Next&lt;span&gt;&lt;&#x2F;span&gt;</a>
  </nav>

</div>
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  


  
<div class="categorieslist">
	<p class="asidetitle">分类</p>
		<ul>
		
		  
			<li><a href="/categories/AI/" title="AI">AI<sup>3</sup></a></li>
		  
		
		  
			<li><a href="/categories/Algorithm/" title="Algorithm">Algorithm<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/Art/" title="Art">Art<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Automation/" title="Automation">Automation<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Collision/" title="Collision">Collision<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Database/" title="Database">Database<sup>3</sup></a></li>
		  
		
		  
			<li><a href="/categories/Editor/" title="Editor">Editor<sup>5</sup></a></li>
		  
		
		  
			<li><a href="/categories/Excel/" title="Excel">Excel<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Game/" title="Game">Game<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/HotUpdate/" title="HotUpdate">HotUpdate<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Lua/" title="Lua">Lua<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Math/" title="Math">Math<sup>3</sup></a></li>
		  
		
		  
			<li><a href="/categories/Native/" title="Native">Native<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/Network/" title="Network">Network<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Optimization/" title="Optimization">Optimization<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Other/" title="Other">Other<sup>5</sup></a></li>
		  
		
		  
			<li><a href="/categories/Plugin/" title="Plugin">Plugin<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/Programming/" title="Programming">Programming<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/Programming-Language/" title="Programming Language">Programming Language<sup>4</sup></a></li>
		  
		
		  
			<li><a href="/categories/Rendering/" title="Rendering">Rendering<sup>4</sup></a></li>
		  
		
		  
			<li><a href="/categories/Resource/" title="Resource">Resource<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/Unity/" title="Unity">Unity<sup>7</sup></a></li>
		  
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">标签</p>
		<ul class="clearfix">
		
			
				<li><a href="/tags/Unity/" title="Unity">Unity<sup>8</sup></a></li>
			
		
			
				<li><a href="/tags/Editor/" title="Editor">Editor<sup>5</sup></a></li>
			
		
			
				<li><a href="/tags/Other/" title="Other">Other<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/AI/" title="AI">AI<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/Math/" title="Math">Math<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/Resource/" title="Resource">Resource<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/OpenGL/" title="OpenGL">OpenGL<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/Programming/" title="Programming">Programming<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/Art/" title="Art">Art<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Android/" title="Android">Android<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/UI/" title="UI">UI<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/C/" title="C#">C#<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Python/" title="Python">Python<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Database/" title="Database">Database<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Shader/" title="Shader">Shader<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/SubmlineText3/" title="SubmlineText3">SubmlineText3<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Rendering/" title="Rendering">Rendering<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Native/" title="Native">Native<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Prefab/" title="Prefab">Prefab<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Plugin/" title="Plugin">Plugin<sup>1</sup></a></li>
			
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">友情链接</p>
    <ul>
        
          <li>
            
            	<a href="https://coderq.com" target="_blank" title="一个面向程序员交流分享的新一代社区">码农圈</a>
            
          </li>
        
          <li>
            
            	<a href="http://wuchong.me" target="_blank" title="Jark&#39;s Blog">Jark&#39;s Blog</a>
            
          </li>
        
    </ul>
</div>

  


  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS 订阅</a>
</div>

  <div class="weiboshow">
  <p class="asidetitle">新浪微博</p>
    <iframe width="100%" height="119" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=119&fansRow=2&ptype=1&speed=0&skin=9&isTitle=1&noborder=1&isWeibo=0&isFans=0&uid=&verifier=b3593ceb&dpc=1"></iframe>
</div>


</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> Hello ,I&#39;m Larry Page in Google. <br/>
			This is my blog,believe it or not.</p>
	</section>
	 
	<div class="social-font" class="clearfix">
		
		<a href="http://weibo.com/2176287895" target="_blank" class="icon-weibo" title="微博"></a>
		
		
		
		
		
		
		
		
		
		
	</div>
			
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Jacman">Jacman</a> © 2025 
		
		<a href="/about" target="_blank" title="Tony Tang">Tony Tang</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery.qrcode-0.12.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
        
    }
  });
});
</script>












<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->



<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?e6d1f421bbc9962127a50488f9ed37d1";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>



<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="返回顶部"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
 </html>
