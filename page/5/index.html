
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  
    <title>走停人生路</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="Tony Tang">
    

    
    <meta property="og:type" content="website">
<meta property="og:title" content="走停人生路">
<meta property="og:url" content="http://tonytang1990.github.io/page/5/index.html">
<meta property="og:site_name" content="走停人生路">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Tony Tang">
<meta name="twitter:card" content="summary">

    
    <link rel="alternative" href="/atom.xml" title="走停人生路" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/jacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/jacman.jpg">
    
    
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 7.3.0"></head>

  <body>
    <header>
      
<div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.png" alt="走停人生路" title="走停人生路"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="走停人生路">走停人生路</a></h1>
				<h2 class="blog-motto">做着独立游戏梦，坚持走在游戏开发道路上的人</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">Home</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
						<li><a href="/about">About</a></li>
					
					<li>
 					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="search" id="search" name="q" autocomplete="off" maxlength="20" placeholder="搜索" />
						<input type="hidden" name="q" value="site:tonytang1990.github.io">
					</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main">

   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/10/13/Unity资源/" title="Unity资源管理" itemprop="url">Unity资源管理</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Tony Tang" target="_blank" itemprop="author">Tony Tang</a>
		
  <p class="article-time">
    <time datetime="2016-10-13T08:21:47.000Z" itemprop="datePublished"> 发表于 2016-10-13</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>在最初学习Unity的时候，对于资源管理没有系统的概念，只知道放到Assets下即可。<br>本章节主要是对于Unity在资源管理方面的进一步学习了解。</p>
<p>这里简单提及正确的利用Unity资源管理的好处：</p>
<ol>
<li>高效的管理资源</li>
<li>合理的分配内存(避免不必要的内存开销 – 比如同一个Asset被打包到多个AssetBundle里，然后分别被游戏加载)</li>
<li>做到增量更新(无需下载更新整个游戏程序，通过Patch的形式动态更新部分游戏内容)</li>
<li>以最少及最合理的方式减少程序大小(避免所有资源一次性打到游戏程序里)</li>
<li>帮助快速开发(动态和静态的资源方式合理利用，高效开发)</li>
</ol>
<h1 id="资源管理"><a href="#资源管理" class="headerlink" title="资源管理"></a>资源管理</h1><h2 id="资源形式"><a href="#资源形式" class="headerlink" title="资源形式"></a>资源形式</h2><h3 id="Asset"><a href="#Asset" class="headerlink" title="Asset"></a>Asset</h3><p>在Unity里所有我们使用的资源都是以Asset的形式存在的。<br>我们要想在Unity里使用特定的资源文件(比如.ogg .png .fbx等(Unity支持的资源格式))，我们需要放到Assets目录下。<br>见下图：<br><img src="/img/Unity/AssetsDirectory.PNG" alt="AssetsDirectory"></p>
<p>在进一步了解我们导入Assets的时候，会发生些什么之前，先让我们来学习了解一些相关的概念。<br>首先，什么是Asset？<br>Asset – “An Asset is a file on disk, stored in the Assets folder of a Unity Project. e.g. texture files, material files and FBX files……”(Asset代表的所有存储在Assets目录下的文件资源)</p>
<p>Unity如何区分每一个Asset？<br>Unity通过赋予每一个Asset一个Unique ID来区分每一个Asset。<br>每一个放在Asset目录下的资源都会对应生成一个同样名字的.meta文件，前面提到的Unique ID就被存储在这里。<br>下面我已导入一张Projectile.png并设置导入设置为Sprite等相关信息为例。<br><img src="/img/Unity/ImportProjectilePNG.PNG" alt="ImportProjectilePNG"><br><img src="/img/Unity/ProjectilePNGImportSetting.PNG" alt="ProjectilePNGImportSetting"><br>Projectile.png.meta</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">fileFormatVersion: <span class="number">2</span></span><br><span class="line">guid: <span class="number">8764571b</span>0416f90488390d0114c49afd</span><br><span class="line">timeCreated: <span class="number">1476349445</span></span><br><span class="line">licenseType: Free</span><br><span class="line">TextureImporter:</span><br><span class="line">  fileIDToRecycleName: &#123;&#125;</span><br><span class="line">  ......</span><br></pre></td></tr></table></figure>
<p>可以看到对应生成了一个叫Projectile.png.meta的文件，里面存储了guid(前面提到的那个Unique ID)和资源导入配置的数据。<br>这样一来无论我们如何移动Asset(在Assets目录下)，我们都不会影响其他资源对该Asset的引用(因为Unity通过Unique ID去标识该Asset)<br>Note：<br>所以我们一旦在Unity外部移动或改名Asset文件，一定要把对应的Asset.meta文件名也对应移动和改名。(在Unity窗口修改可以不必管这些，因为Unity会对应生成新的.meta文件)<br>如果script脚本的.meta文件丢失，那么所有挂载了该script的GameObject都会显示unassaigned script(因为找不到该Script Asset的ID标识)</p>
<p>知道了Asset在Unity是如何区分的，那么接下来的问题是，Unity是直接使用这些Asset资源文件作为游戏资源吗？<br>答案是否定的，所有导入的Asset都会被Unity转化成特定的格式在游戏中使用，被存储在Library目录下，而原有资源保持不变，依然放在原始位置。(这样一来，我们可以通过修改原始文件，快速的在Unity中看到变化。比如.png作为UI，我们在Photoshop里修改源文件，直接就能在Unity看到变化)<br><img src="/img/Unity/UnityAssetInternalFormatInLibraryFolder.PNG" alt="UnityAssetInternalFormatInLibraryFolder"><br>Note:<br>因为Library目录是通过动态转换Asset资源成Unity识别的数据，所以我们不会去主动修改该目录文件，同时也不会对该目录做版本控制，我们放心的删除该目录(但会导致所有Asset重新导入声称一次Unity识别的数据)</p>
<p>知道了Unity如何利用原始文件生成最终的可利用的资源数据，那么是不是所有的Asset都是通过直接放置在Assets目录下得到的了？<br>答案是否定的，Unity支持从一些资源文件里细分出多个Assets。(比如.png文件可以作为Multiple Sprite导入到Unity里，然后通过Sprite Editor细分出多个Sprite，然后每一个Sprite都作为Asset存在于Unity里)</p>
<p>知道了Asset在Unity里的概念以及存储方式，那么Unity支持哪些常见的Asset格式了？</p>
<ol>
<li>Image File(e.g. .bmp, .tif, .tga, .jpg, .psd……)</li>
<li>3D Model Files(.fbx)</li>
<li>Meshes &amp; Animations</li>
<li>Audio files</li>
<li>Other Asset Types</li>
</ol>
<p>遇到Unity不支持的格式，Unity需要通过import process导入资源文件(e.g. PNG, JPG)<br>“The import process converts source Assets into formats suitable for the target platform selected in the Unity Editor.”(Import process主要是为了将不支持的资源格式转换到Unity对应平台设置的对应格式)</p>
<p>Unity不可能每一次都去重新Import这些资源，那么Unity是如何将import结果存储在哪里了？<br>为了避免重复的import导入，” the results of Asset importing are cached in the Library folder.”(Asset导入的结果被缓存在了library folder – 我想这也就是为什么每次删掉Library文件会导致一些asset重新导入的原因)</p>
<p>“the results of the import process are stored in a folder named for the first two digits of the Asset’s File GUID. This folder is stored inside the Library&#x2F;metadata&#x2F; folder. The individual Objects are serialized into a single binary file that has a name identical to the Asset’s File GUID.”(可以看出import的结果存储在Library&#x2F;metadata&#x2F;文件夹下，并且把File GUID的前两位bit作为文件夹名，以File GUID作为文件名字)<br>以前面Projectile.png导入为例：<br>因为Projectile.png.meta的File ID为8764571b0416f90488390d0114c49afd<br>所以导入的结果就存储在Library\metadata\87\文件夹下，文件名为8764571b0416f90488390d0114c49afd(由于是二进制文件，无法查看具体内容)<br><img src="/img/Unity/AssetImportResult.PNG" alt="AssetImportResult"><br>Note:<br>Non-Native asset type需要通过asset importer去导入Unity。(自动调用，也可以通过AssetImporter API去调用)</p>
<p>明白了Asset在Unity里的概念和存储方式，那么我们如何去访问，使用，创建Asset了？<br>在了解如何访问Asset之前，我们需要明确的是，我们访问的目的是什么。<br>如果只是在编辑器里单纯访问Asset去创建和删除一些Asset，那么通过AssetDatabase就可以实现。</p>
<p>先来看看什么是AssetDatabase：<br>“AssetDatabase is an API which allows you to access the assets contained in your project. Among other things, it provides methods to find and load assets and also to create, delete and modify them. The Unity Editor uses the AssetDatabase internally to keep track of asset files and maintain the linkage between assets and objects that reference them.”(可以看出，AssetDatabase在Unity对于Asset管理上起了关键性作用，AssetDatabase里存储了Asset相关的很多信息(e.g. Asset Depedency, Asset Path…..))</p>
<p>所以如果我们想通过代码去实现一些关于Assset的操作，我们应该使用AssetDatabase而非Filesystem(Filesystem只是单纯的删除或移动文件，但对于Asset在Unity里的导入设置，Asset访问等还是得通过AssetDatabase的接口来操作)</p>
<p>这里我以之前导入的Projectile.png为纹理图片，通过程序创建3个颜色分别是Red，Blue，Green的Material和分别使用其作为材质的3个Cude Prefab为例：<br>先看一下效果图：<br><img src="/img/Unity/CreateCubePrefabs.PNG" alt="CreateCubePrefabs"><br><img src="/img/Unity/CreateCubeMaterials.PNG" alt="CreateCubeMaterials"></p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> UNITY_EDITOR</span></span><br><span class="line"><span class="keyword">using</span> UnityEditor;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CreateCubeAssetMenu</span> &#123;</span><br><span class="line">    <span class="comment">//Only works under editor</span></span><br><span class="line">    <span class="meta">#<span class="keyword">if</span> UNITY_EDITOR</span></span><br><span class="line">    [<span class="meta">MenuItem(<span class="string">&quot;AssetDatabase/CreateCubeAsset&quot;</span>)</span>]</span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">CreateCudeAsset</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//load Projectile.png as texture</span></span><br><span class="line">        Texture2D texture = (Texture2D)AssetDatabase.LoadAssetAtPath(<span class="string">&quot;Assets/Sprites/Projectile.png&quot;</span>, <span class="keyword">typeof</span>(Texture2D));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//create material and cube assets</span></span><br><span class="line">        <span class="built_in">string</span> matassetname;</span><br><span class="line">        <span class="built_in">string</span> cubename;</span><br><span class="line">        <span class="built_in">string</span> materialfoldername = <span class="string">&quot;Materials&quot;</span>;</span><br><span class="line">        <span class="built_in">string</span> cubefoldername = <span class="string">&quot;Prefabs&quot;</span>;</span><br><span class="line"></span><br><span class="line">        Color[] colors = &#123; Color.red, Color.blue, Color.green &#125;;</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; colors.Length; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//Create material first</span></span><br><span class="line">            Material mat = <span class="keyword">new</span> Material(Shader.Find(<span class="string">&quot;Transparent/Diffuse&quot;</span>));</span><br><span class="line">            mat.mainTexture = texture;</span><br><span class="line">            mat.color = colors[i];</span><br><span class="line"></span><br><span class="line">            <span class="comment">//create a new cube and set material for it</span></span><br><span class="line">            GameObject obj = GameObject.CreatePrimitive(PrimitiveType.Cube);</span><br><span class="line">            MeshRenderer meshrender = obj.GetComponent&lt;MeshRenderer&gt;();</span><br><span class="line">            <span class="keyword">if</span> (meshrender != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                meshrender.material = mat;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                Debug.Log(<span class="string">&quot;meshrender == null!&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            matassetname = mat.color.ToString() + <span class="string">&quot;Material.mat&quot;</span>;</span><br><span class="line">            cubename = mat.color.ToString() + <span class="string">&quot;Cube.prefab&quot;</span>;</span><br><span class="line">            <span class="comment">//create material folder</span></span><br><span class="line">            <span class="comment">//check whether material folder exist</span></span><br><span class="line">            <span class="keyword">if</span> (AssetDatabase.Contains(mat))</span><br><span class="line">            &#123;</span><br><span class="line">                Debug.Log(<span class="string">&quot;Material asset has been created before!&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (!AssetDatabase.IsValidFolder(<span class="string">&quot;Assets/&quot;</span> + materialfoldername))</span><br><span class="line">                &#123;</span><br><span class="line">                    AssetDatabase.CreateFolder(<span class="string">&quot;Assets&quot;</span>, materialfoldername);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (!AssetDatabase.IsValidFolder(<span class="string">&quot;Assets/&quot;</span> + cubefoldername))</span><br><span class="line">                &#123;</span><br><span class="line">                    AssetDatabase.CreateFolder(<span class="string">&quot;Assets&quot;</span>, cubefoldername);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                AssetDatabase.CreateAsset(mat, <span class="string">&quot;Assets/&quot;</span> + materialfoldername + <span class="string">&quot;/&quot;</span> + matassetname);</span><br><span class="line"></span><br><span class="line">                <span class="comment">//Create prefab</span></span><br><span class="line">                PrefabUtility.CreatePrefab(<span class="string">&quot;Assets/&quot;</span> + cubefoldername + <span class="string">&quot;/&quot;</span> + cubename, obj);</span><br><span class="line"></span><br><span class="line">                <span class="comment">//inform  the change</span></span><br><span class="line">                AssetDatabase.Refresh();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Note:<br>AssetDatabase只适用于Editor，所以上述代码都用#if UNITY_EDITOR #endif判断了平台</p>
<p>那么是不是只需存储Asset的.meta文件(Unique ID和导入配置信息)就足够了了？<br>答案是否定的，要知道在Unity里很多Asset不只是单纯的通过原始资源导入构成的(比如一个Bullet Prefab，上面会挂载Component，我们不仅要去标识Asset，我们还需要对Asset上的各个Component进行标识和相关信息存储，这样Unity才能正确的找到特定Asset上的特定Component的)。</p>
<h3 id="Object"><a href="#Object" class="headerlink" title="Object"></a>Object</h3><p>在进一步了解还应该存储哪些信息之前，这里需要理解一个概念UnityEngine.Object<br>那么Object在Unity里是什么概念了？<br>UnityEngine.Object – “Object with a capitalized ‘O’, is a set of serialized data collectively describing a specific instance of a resource. This can be any type of resource which the Unity Engine uses, such as a mesh, a sprite, and AudioClip …..”(Object是指描述了Asset上使用的所有resources的序列化数据。比如制作一个2D Bullet Prefab，上面会挂载Transform，Sprite Renderer，Box Collider 2D,Rigidbody 2D, Bullet Script，Animator等Object，这里我们需要分别标识和记录这些Object的信息)</p>
<p>前面我们提到了Asset是通过Unique ID(File GUID)来标识，那么这里的Object用什么来标识了？并且又存储在哪里了？<br>答案是使用Local ID来标识并存储在Asset文件里(需要设置Asset Serialization到Force Text才能查看(默认是Mixed(Text和Binary)))<br>Local ID – identifies each Object within an Asset file because an Asset file may contain multiple Objects.</p>
<p>那么Asset和Object之间是什么样的关系了？<br>“There is a one-to-many relationship between Assets and Objects: that is, any given Asset file contains one or more Objects.”(Asset file可以包含一个或多个Objects)</p>
<p>那么如何查看Object的具体信息了？<br>通过设置Edit -&gt; Project Setting -&gt; Editor -&gt; Asset Serialization -&gt; Force Text<br>我们可以去查看所有Object索引的相关信息。<br>这里我们以一个创建一个Bullet Prefab的Asest file为例(Bullet Prefab包含很多Component)：<br>当创建一个Bullet Prefab的时候，我在上面挂载了Transform，Sprite Renderer，Box Collider 2D,Rigidbody 2D, Bullet Script，Animator等Object。<br><img src="/img/Unity/BulletInspector.PNG" alt="BulletInspector"><br>这里的Bullet.prefab文件就是我们说的Asset File。<br>而上述挂载的所有Components就是之前说的Object。(这就印证了Asset File和Object一对多的关系)<br>下面让我们看看在包含多个Obejct的Prefab里是如何通过File GUID和Local ID来定位各个Object的。<br>Bullet.prefab</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">%YAML <span class="number">1.1</span></span><br><span class="line">%TAG !u! tag:unity3d.com,<span class="number">2011</span>:</span><br><span class="line">--- !u!<span class="number">1001</span> &amp;<span class="number">100100000</span></span><br><span class="line">Prefab:</span><br><span class="line">  ......</span><br><span class="line">--- !u!<span class="number">1</span> &amp;<span class="number">1000012041017010</span></span><br><span class="line">GameObject:</span><br><span class="line">  ......</span><br><span class="line">--- !u!<span class="number">4</span> &amp;<span class="number">4000011268538122</span></span><br><span class="line">Transform:</span><br><span class="line">  ......</span><br><span class="line">--- !u!<span class="number">50</span> &amp;<span class="number">50000011296845006</span></span><br><span class="line">Rigidbody2D:</span><br><span class="line">  ......</span><br><span class="line">--- !u!<span class="number">61</span> &amp;<span class="number">61000010120606286</span></span><br><span class="line">BoxCollider2D:</span><br><span class="line">  ......</span><br><span class="line">--- !u!<span class="number">95</span> &amp;<span class="number">95000013277359834</span></span><br><span class="line">Animator:</span><br><span class="line">  ......</span><br><span class="line">--- !u!<span class="number">114</span> &amp;<span class="number">114000011185120874</span></span><br><span class="line">MonoBehaviour:</span><br><span class="line">  ......</span><br><span class="line">--- !u!<span class="number">212</span> &amp;<span class="number">212000011673545760</span></span><br><span class="line">SpriteRenderer:</span><br><span class="line">  ......</span><br></pre></td></tr></table></figure>
<p>Bullet.prefab.meta</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">fileFormatVersion: <span class="number">2</span></span><br><span class="line">guid: <span class="number">9</span>c4834a7b611ce848b2d182d5057bcbb</span><br><span class="line">timeCreated: <span class="number">1476367984</span></span><br><span class="line">licenseType: Free</span><br><span class="line">NativeFormatImporter:</span><br><span class="line">  userData: </span><br><span class="line">  assetBundleName: </span><br><span class="line">  assetBundleVariant: </span><br></pre></td></tr></table></figure>
<p>从Bullet.prefab里可以看出每一个Object都有定义对应的Local ID<br>而在Bullet.prefab.meta里定义了Bullet Prefab这个Asset File的File GUID<br>结合File GUID和Local ID我们就能定位到Bullet Prefab Asset File里的某某Object</p>
<p>那么为什么要采用File GUID和Local ID了？<br>“The File GUID provides an abstraction of a file’s specific location. As long as a specific File GUID can be associated with a specific file, that file’s location on disk becomes irrelevant. The file can be freely moved without having to update all Objects referring to the file.”(通过指定唯一个File GUID和Local ID，使文件的位置变的无关紧要，我们可以随意的移动文件位置而无需更新所有的Object reference信息)</p>
<p>所以一旦File GUID丢失，那么所有引用该文件里的Object的引用都会丢失，因为无法定位位于哪一个Asset File里。(所以不要随意乱改.meta文件)</p>
<p>File GUID和Local ID虽然好，但是一味的比较File GUID和Local ID会导致slow performance，所以Unity为了快速访问标识的各个Asset，内部维护了一个Instance ID的映射缓存(通过File GUID和Local ID计算得出的唯一的integer)来标识各个Asset。<br>通过Instance ID Unity可以快速的访问到被加载了的对应的Object。(如果target object还没被加载，那么通过File GUID和Local ID，Unity会去把Object加载进来)</p>
<p>那么Instance ID是如何运作的了？<br>“At startup, the Instance ID cache is initialized with data for all Objects that are built-in to the project (i.e. referenced in Scenes), as well as all Objects contained in the Resources folder. Additional entries are added to the cache when new assets are imported at runtime(3) and when Objects are loaded from AssetBundles. Instance ID entries are only removed from the cache when they become stale. This happens when an AssetBundle providing access to a specific File GUID and Local ID is unloaded.”(当游戏启动的时候，Instance ID的cache开始初始化所有在项目场景里引用到的Object。额外的Instance ID Cache只有在通过运行时导入或则AssetBundle动态加载Object的时候添加。Instance ID只有在Instance ID标识的Object被Unloaded的时候才会被removed from cache)</p>
<p>那么什么时候Object才会被Unloaded了？Object的Instance ID与AssetBundle之间又是如何关联起来的了？<br>“When the unloading of an AssetBundle causes an Instance ID to become stale, the mapping between the Instance ID and its File GUID and Local ID is deleted to conserve memory. If the AssetBundle is re-loaded, a new Instance ID will be created for each Object loaded from the re-loaded AssetBundle.”(当AssetBundle(后面会详细讲到)被unload后，通过AssetBundle加载的Object的Instance ID会被删除以节约内存。当AssetBundle再次加载进来后，当AssetBundel里的Obejct被再次加载时，会为该Object生成新的Instance ID到cache里)</p>
<p>上面算是提到了Resource(Asset里的Object)的lifecycle。关于Resource Lifecycle和Instance ID相关的学习在了解了Unity里与资源加载相关的Resource和AssetBundle后会再次讨论，见后面。</p>
<p>Note:<br><a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/topics/best-practices/assets-objects-and-serialization">Implementation note: At runtime, the above control flow is not literally accurate. Comparing File GUIDs and Local IDs at runtime would not be sufficiently performant during heavy loading operations. When building a Unity project, the File GUIDs and Local IDs are deterministically mapped into a simpler format. However, the concept remains identical, and thinking in terms of File GUIDs and Local IDs remains a useful analogy during runtime.</a></p>
<p>接下来看看两种特殊的Object类型:</p>
<ol>
<li>ScriptableObject<br>“Provides a convenient system for developers to define their own data types.”(用于定义自定义类型数据)</li>
<li>MonoBehaviour<br>“Provides a wrapper that lins to a MonoScript. A MonoScript is an internal data type that Unity uses to hold a reference to a specific scripting class within a specific assembly and namespace. The MonoScript does not contain any actual executable code.”</li>
</ol>
<p>Monoscripts:<br>“a MonoBehaviour has a reference to a MonoScript, and MonoScripts simply contain the information needed to locate a specific script class. Neither type of Object contains the executable code of script class.”<br>“A MonoScript contains three strings: an assembly name, a class name, and a namespace.”(正如前面MonoBehavior提到的，MonoScript包含了定位script class需要的信息。 e.g. assembly name, class name, namspace……)</p>
<p>我们编写的scripts最终会被Unity编译到Assembly-CSharp.dll里。<br>在Plugins目录下的插件会被编译到Assembly-CSharp-firstpass.dll里。<br><img src="/img/Unity/UnityAssembly.PNG" alt="UnityAssembly"></p>
<p>那么我们的Asset资源被打包到哪里去了了？<br>接下来我们设置场景如下：</p>
<ol>
<li>放置一个Bullet.prefab实例(上面挂载了Bullet script和一系列Component，使用Assets&#x2F;Sprites&#x2F;Projectile.png作为sprite(设置了打包到图集1里))</li>
<li>创建一个Cude的3D GameObject(Unity Primitive Cube)</li>
<li>创建UI Image使用Background.png作为Sprie(&#x2F;Assets&#x2F;Resources&#x2F;Textures&#x2F;UI&#x2F;Background.png)</li>
<li>放置一张未使用的AddImage.png在Assets&#x2F;Sprites下，并设置打包到图集2里。</li>
<li>放置一张未使用的Coin.png在Assets&#x2F;Resources&#x2F;Textures&#x2F;UI下，并设置打包到图集3里。</li>
</ol>
<p>然后通过Unity提取查看IOS打包后的各个资源分别存储在哪里。<br>首先看看我们在场景里创建的GameObject情况：<br><img src="/img/Unity/ResourceManagerStudyScene.PNG" alt="ResourceManagerStudyScene"><br>接下来查看下打包的IOS的资源文件夹下的.asset文件：<br><img src="/img/Unity/ResourceManagerStudyIOSResource.PNG" alt="ResourceManagerStudyIOSResource"><br>可以看到Data下有三个.assets文件(globalgamemanager.assets和sharedassets0.assets和resources.assets)<br>然后通过UnityStudio我们分别打开这三个文件进行查看：<br>globalgamemanager.assets<br><img src="/img/Unity/globalgamemanagerassets.PNG" alt="globalgamemanagerassets"><br><img src="/img/Unity/sharedassets0assets.PNG" alt="sharedassets0assets"><br><img src="/img/Unity/resourcesassets.PNG" alt="resourcesassets"><br>通过查看里面的资源可以发现，我们放在Assets&#x2F;Sprites下的Projectile.png被打包到了SpriteAtlasTexture-1-32x32-fmt33(Texture2D)图集里，而作为UI背景放置在Assets&#x2F;Resoures&#x2F;Textures&#x2F;UI下的backgroudn.png被单独打包在了名为backgroudn(Texture2D)里<br>而没有在游戏里使用且放置在Assets&#x2F;Resources&#x2F;Textures&#x2F;UI下的Coin.png被单独打包到了名为resources.assets的资源文件里。</p>
<p>从上面可以看出Resources下的资源文件并没有被打包到图集里，而是作为单独的Texture2D资源存在。同时没有放置在Resources目录下的资源，如果没有被游戏使用，最终是不会被打包到游戏里(反之放在Resources目录下即使未被使用也会被打包到游戏里)。</p>
<p>如果我们使用UnityStudio加载整个Data文件夹，我们还能查看到场景Level里的树状结构：<br><img src="/img/Unity/SeneHierarchy.PNG" alt="SeneHierarchy"></p>
<p>说了这么多Asset和Object相关的知识和概念，下面提一个与之相关却又常常遇到的问题。<br>Unity Store可以下载很多Asset Package资源，那么这里的问题就是，Asset Package是个什么概念？为什么通过导入Asset Package我们就能导入别人做好的Asset资源？如何制作自己的Asset Package？<br>Asset Package概念：<br>“Packages are collections of files and data from Unity projects, or elements of projects, which are compressed and stored in one file, similar to Zip files.”(可以看出Asset Package只是相当于Unity对于一系列Assets的打包，单记录了Assets原始的目录结构和Asset信息，好比压缩包)</p>
<p>正如我们前面学习理解的，要想使Asset能够使用，我们需要把Asset源文件和Asset.meta文件一起保存下来(为了确保原始的Asset和Object引用正确)。那么Asset Package是否保存了Asset源文件和Asset.meta文件了？接下来通过自制Asset Package我们来验证这个问题。</p>
<p>如何制作自己的Asset Package：<br>这里以导出前面制作的Bullet.prefab(Bullet.prefab以Projectile.png作为Sprite，同时挂载了Rigidbox 2D，Boxcollider 2D，Bullet script……)为例：<br>Asset -&gt; Export Package -&gt; 只勾选Bullet.prefab -&gt; Export<br>不勾选Include Dependencies：<br><img src="/img/Unity/ExportPackageWithoutDepedency.PNG" alt="ExportPackageWithoutDependency"><br>勾选Include Dependencies：<br><img src="/img/Unity/ExportPackage.PNG" alt="ExportPackageWithDependency"><br>这里不知道为什么CreateCubeAssetMenu.cs会作为Bullet.prefab的dependencies！<br>接下来在新的项目里导入该Asset Package：<br>Assets -&gt; Import Package -&gt; custom package<br>这样一来就得到了我们所导出的Assets Package<br><img src="/img/Unity/AssetPackageCompare.PNG" alt="AssetPackageCompare"><br>可以看出Bullet.prefab和Bullet.meta原封不动的以原始的形式保留了下来。<br>Note:<br>当导出Asset Package的时候，勾选Include dependencies，那么所有Asset依赖的Asset都会被导出到最终的Package</p>
<h2 id="资源来源"><a href="#资源来源" class="headerlink" title="资源来源"></a>资源来源</h2><h3 id="Unity自动打包"><a href="#Unity自动打包" class="headerlink" title="Unity自动打包"></a>Unity自动打包</h3><p><a target="_blank" rel="noopener" href="http://blog.csdn.net/ring0hx/article/details/46376709">Unity自动打包资源是指在Unity场景中直接使用到的资源会随着场景被自动打包到游戏中，这些资源会在场景加载的时候由unity自动加载。这些资源只要放置在Unity工程目录的Assets文件夹下即可，程序不需要关心他们的打包和加载，这也意味着这些资源都是静态加载的。但在实际的游戏开发中我们一般都是会动态创建GameObject，资源是动态加载的，因此这种资源其实不多</a></p>
<h3 id="Resources"><a href="#Resources" class="headerlink" title="Resources"></a>Resources</h3><p>所有放在Assets&#x2F;Resources目录下的资源都当做Resources。无论游戏是否使用，都会被打包到最终的程序里。(这也就说明为什么前面的例子在Resources下没有被使用的Coin.png最终被打包到了resources.assets里)<br>那么如何判断Resources下的资源是被打包到resources.assets里还是其他的assets里了？<br>答案取决于我们是否在Unity对Resources目录下的资源进行了索引引用。<br>正如前面我们测试的结果一样，同样是放在Resources目录下的backgroudn.png和Coin.png，前者因为在游戏里有引用，所以被打包到了sharedassets0.assets里，后者因为无人使用，而打包到了resources.assets里。(Resources下被引用的资源是存储在.sharedAsseets file里，而没被引用的是存储在resources.assets里)</p>
<p>那么为什么我们需要把资源放置在Resources下了？放在Assets下单独去引用使用不就可以了吗？<br>Resources主要是为了帮助我们去动态加载一些资源去创建Asset。(通过Resource API可以动态加载Resource里的资源)</p>
<p>但Unity官网讲解提到的我们应该尽量去避免使用Resources。<br>原因如下：</p>
<ol>
<li>Use of the Resources folder makes fine-grained memory management more difficult.(使用Resources folder会使内存管理更困难)</li>
<li>Improper use of Resources folders will increase application startup time and the length of builds.(不合理的使用Resources folders会使程序启动和编译时间变长)<br> As the number of Resources folders increases, management of the Assets within those folders becomes very difficult.(随着Resources folders数量的增加，Assets管理越来越困难)</li>
<li>The Resources system degrades a project’s ability to deliver custom content to specific platforms and eliminates the possibility of incremental content upgrades.(Resources System降低了项目对于各平台和资源的动态更新能力，因为Resources目录下的资源无论如何都会被打包到游戏程序里)<br> AssetBundle Variants are Unity’s primary tool for adjusting content on a per-device basis.(AssetBundle是Unity针对设备动态更新的主要工具)</li>
</ol>
<p>正确的使用Resources system就显得尤为重要：<br>以下两种情况比较适合使用Resource System：</p>
<ol>
<li>Resources is an excellent system for during rapid prototyping and experimentation because it is simple and easy to use. However, when a project moves into full production, it is strongly recommended to eliminate uses of the Resources folder.(快速开发，但到了真正发布还是应该减少Resources Folder的使用)</li>
<li>The Resources folder is also useful in trivial cases, when all of the following conditions are met(当下列情况都满足的时候，Resource folder比较有用):<ol>
<li>The content stored in the Resources folder is not memory-intense</li>
<li>The content is generally required throughout a project’s lifetime(该资源在项目生命周期里都需要)</li>
<li>The content rarely requires patching(很少需要改动patch)</li>
<li>The content does not vary across platforms or devices.(在各个平台设备都一致)<br>比如一些第三方配置文件等asset。</li>
</ol>
</li>
</ol>
<p>那么接下来让我们了解下Resources是如何被保存到Unity里的：<br>Serialization of resources:<br>“The Assets and Objects in all folders named “Resources” are combined into a single serialized file when a project is built.”(当项目编译的时候，所有放到Resources目录下的Assets和Object最终会被序列化到一个单独的文件，根据前面的测试应该是resources.assets)</p>
<p>“This file also contains metadata and indexing information, similar to an AssetBundle. This indexing information includes a serialized lookup tree that is used to resolve a given Object’s name into its appropriate File GUID and Local ID. It is also used to locate the Object at a specific byte offset in the serialized file’s body.”(Resource会去维护一个映射表，用于查询特定Object</p>
<p>“As the lookup data structure is (on most platforms) a balanced search tree(1), its construction time grows at an O(N log(N)) rate.”(Lookup是通过平衡二叉树来查找，所以时间复杂度为N x Log(N))</p>
<p>“This operation is unskippable and occurs at application startup time while the initial non-interactive splash screen is displayed.”(在程序启动的时候会去初始化index info(Lookup data)的时候，Resources里assets数量过多的话会导致花费大量时间)</p>
<h3 id="AssetBundle"><a href="#AssetBundle" class="headerlink" title="AssetBundle"></a>AssetBundle</h3><p>接下来让我们前面一直提到的一个很重要的点AssetBundle。<br>什么是AssetBundle？<br><a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/topics/best-practices/assetbundle-fundamentals?playlist=30089">The AssetBundle system provides a method for storing one or more files in an archival format that Unity can index. The purpose of the system is to provide a data delivery method compatible with Unity’s serialization system. AssetBundles are Unity’s primary tool for the delivery and updating of non-code content after installation.</a>(AssetBundle system提供了一个被Unity支持索引的格式文件(被Unity serialization system支持)。主要用于非代码资源的动态更新。)</p>
<p>为什么需要AssetBundle？<br><a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/topics/best-practices/assetbundle-fundamentals?playlist=30089">This permits developers to reduce shipped asset size, minimize runtime memory pressure, and selectively load content that is optimized for the end-user’s device.</a>(AssetBundle的好处是减少了发布的Asset大小，降低了运行时内存压力，动态更新非代码资源)</p>
<p>AssetBundle包含些什么信息？<br>主要包含两部分信息：</p>
<ol>
<li>A header<br>The header is generated by Unity when the AssetBundle is built.(header是在Unity编译AssetBundle的时候生成)主要包含下列内容：<ol>
<li>The AssetBundle’s identifier</li>
<li>Whether the AssetBundle is compressed or uncompressed</li>
<li>A manifest(“The manifest is a lookup table keyed by an Object’s name. Each entry provides a byte index that indicates where a given Object can be found within the AssetBundle’s data segment.”(manifest把Object的名字作为key，用于查询特定object是否存在于AssetBundle的数据字段里))<br> (manifest里通过std::multimap实现，不同平台multimap的实现有些许差别，Windows和OSX采用red-black tree，所以在构造manifest的时候，时间复杂度是N x Log(N))</li>
</ol>
</li>
<li>A data segment.<br>“Contains the raw data generated by serializing the Assets in the AssetBundle.”(data segment包含了序列化Assets的原始数据)<br>data segment最后还会通过LZMA algorithm压缩。<br>“Prior to Unity 5.3, Objects could not be compressed individually inside an AssetBundle. “(Unity 5.3之前Object不支持被单独压缩到AssetBundle里，所以在去访问一个被包含在压缩了的AssetBundle里的Object时，Unity需要去解压整个AssetBundle)<br>“Unity 5.3 added a LZ4 compression option. AssetBundles built with the LZ4 compression option will compress individual Objects within the AssetBundle, allowing Unity to store compressed AssetBundles on disk.”(Unity 5.3加入了LZ4压缩选项，支持单独的Object压缩到AssetBundle里，这样一来就可以通过单独解压特定的Object来实现访问该Object)</li>
</ol>
<p>AssetBundle能包含哪些Assets？<br>Models,Materials,textures and secenes.AssetBundle can not contain scripts.</p>
<p>如何去加载AssetBundles？<br>下列四种方式主要是根据AssetBundle的压缩算法和平台支持来划分。<br>API加载AssetBundles:</p>
<ol>
<li>AssetBundle.LoadFromMemoryAsync(Unity’s recommendation is not use this API)<br><a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/topics/best-practices/assetbundle-fundamentals?playlist=30089">AssetBundle.LoadFromMemoryAsync详情</a></li>
<li>AssetBundle.LoadFromFile<br>“A highly-efficient API intended for loading uncompressed AssetBundle from local storage, such as a hard disk or an SD card.”(可以高效的加载本地未压缩的AssetBundle，也支持加载LZ4压缩的AssetBundle，但不支持LZMA压缩的AssetBundle)<br><a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/topics/best-practices/assetbundle-fundamentals?playlist=30089">Mobile和Editor表现不一样，详情参见</a></li>
<li><a href="WWW.LoadFromCacheOrDownload">WWW.LoadFromCacheOrDownload</a><br>“A useful API for loading Objects both from remote servers and from local storage.”(主要用于加载远程服务器端和本地的Object)<br>使用建议：<br>“Due to the memory overhead of caching an AssetBundle’s bytes in the WWW object, it is recommended that all developers using WWW.LoadFromCacheOrDownload ensure that their AssetBundles remain small”(尽量保证AssetBundle很小，避免内存消耗过大)<br>“Each call to this API will spawn a new worker thread. Be careful of creating an excessive number of threads when calling this API multiple times.”(避免同时调用多次，导致大量的Thread执行，确保同一时间很少的thread执行)</li>
<li>UnityWebRequest’s DonwloadHandleAssetBundle(on Unity 5.3 or newer)<br>“UnityWebRequest allows developers to specify exactly how Unity should handle downloaded data and allows developers to eliminate unnecessary memory usage.”(UnityWebRequest支持更细致的AssetBundle加载的内存使用，可以通过配置UnityWebRequest达到使用最少内存的目的得到我们想要加载的Obejct)<br>“Note: Unlike WWW, the UnityWebRequest system has an internal pool of worker threads and an internal job system to ensure that developers cannot start an excessive number of simultaneous downloads. The size of the thread pool is not currently configurable.”(UnituWebRequest system内部有自身的线程管理，避免同一时间大量的线程同时加载)</li>
</ol>
<p>使用建议：<br>尽可能的使用AssetBundle.LoadFromFile(使用异步版本LoadFromFileAsync)<br>当项目需要下载和patch AssetBundle时，尽量使用UnityWebRequest(Unity 5.3),老版本的话使用WWW.LoadFromCacheOrDownload.<br>可能的话最好在项目安装的时候，预先缓存AssetBundle</p>
<p>Loading Assets from AssetBundles:<br>Synchronous API:</p>
<ol>
<li>LoadAsset</li>
<li>LoadAllAssets</li>
<li>LoadAssetWithSubAsset</li>
</ol>
<p>Asynchronous API:</p>
<ol>
<li>LoadAssetAsync</li>
<li>LoadAllAssetsAsync</li>
<li>LoadAssetWithSubAssetAsync</li>
</ol>
<p>使用建议：<br>“LoadAllAssets should be used when loading multiple independent UnityEngine.Objects.”(当需要加载大量独立的Objects的时候，使用LoadAllAssets。当需要加载的Object数量很多，又少于AssetBundle里的2&#x2F;3的时候，我们可以采用制作多个小的AssetBundle，然后再通过LoadAllAssets加载)<br>“LoadAssetWithSubAssets should be used when loading a composite Asset which contains multiple embedded Objects. If the Objects that need to be loaded all come from the same Asset, but are stored in an AssetBundle with many other unrelated Objects.”(当加载由多个obejct构成的Object的时候，建议使用LoadAssetWithSubAssets。当加载的Objects都来之同一个Asset，但存储的AssetBundle里包含很多其他无关的Obejcts时，采用LoadAssetWithSubAssets)<br>“For any other case, use LoadAsset or LoadAssetAsync.”(其他情况都是用LoadAsset和LoadAssetAsync)</p>
<p>Low-Level Loading details:<br>“UnityEngine.Object loading is performed off the main thread: an Object’s data is read from storage on a worker thread. Anything which does not touch thread-sensitive parts of the Unity system (scripting, graphics) will be converted on the worker thread.”(Object的加载是在main thread上，而object data的数据读取是在worker thread。所有线程不敏感的数据都是在worker thread进行。)</p>
<p>加载AssetBundle里的Object需要注意些什么？<br>“An Object is assigned a valid Instance ID when its AssetBundle is loaded, the order in which AssetBundles are loaded is not important. Instead, it is important to load all AssetBundles that contain dependencies of an Object before loading the Object itself. Unity will not attempt to automatically load any child AssetBundles when a parent AssetBundle is loaded.”(当AssetBundle被加载的时候，Object会被assigned一个valide instance ID，因为这个instance ID是唯一的，所以AssetBundle的加载顺序并不重要，重要的是我们要确保所有Object依赖的Objects都被加载(Unity不会自动加载所有Child AssetBundles当Parent AssetBundle被加载的时候))<br>下面以Material A引用Texture B为例。Material A被Packaged到了AssetBundle1，而Texture B被packaged到了AssetBundle2。<br><img src="/img/Unity/AssetBundleDependencies.PNG" alt="AssetBundleDependencies"><br>所以我们要使用Material A，我们不仅要加载AssetBundle1，还得确保在此之前我们加载了AssetBundle2里的Texture B</p>
<p>AssetBundle的dependencies信息存储在哪里？<br>AssetBundleManifest存储了AssetBundle’s dependency information(AssetBundle里的依赖关系信息)</p>
<p>AssetBundleManifest存放在哪里？<br><a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/topics/best-practices/assetbundle-fundamentals?playlist=30089">This Asset will be stored in an AssetBundle with the same name as the parent directory where the AssetBundles are being built.</a>(AssetBundleManifest存放在AssetBundle同级目录，并且包含一样的名字)</p>
<p>Note:<br><a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/topics/best-practices/assetbundle-fundamentals?playlist=30089">The AssetBundle containing the manifest can be loaded, cached and unloaded just like any other AssetBundle.</a>(AssetBundleManifest可以像AssetBundle一样被加载，缓存，释放)</p>
<p>如何查询AssetBundle里的Dependecy信息？<br>Depending on the runtime environmen:</p>
<ol>
<li>Editor<br>AssetDatabase API(Query AssetBundle dependencies)<br>AssetImporter API(Access and change AssetBundle assignments and dependencies)</li>
<li>Runtime<br>AssetBundleManifest API(load the dependency information of AssetBundle)<br> AssetBundleManifest.GetAllDependencies<br> AssetBundleManifest.GetDirectDependencies<br>Note:<br>“Both of these APIs allocate arrays of strings. Use them sparingly, and preferably not during performance-sensitive portions of an application’s lifetime.”(因为上述API会分配大量的string字符串，所以要尽量少用并且避开性能敏感的时期)</li>
</ol>
<p>接下来通过制作2个UI prefab：<br>一个包含全屏显示的Background image(打到uitextures AssetBundle里)<br>一个包含Backgroundimage但大小只有背景的一半(打到backgroundimage AssetBundle里)<br>同时设置background图片都打包到uitextures AssetBundle里<br>通过AssetBundleManifest API查询两个AssetBundle里的Dependencies信息。<br>首先如何制作AssetBundle？</p>
<ol>
<li>选择需要制作成AssetBundle的资源(Texture,Prefab)，设置相应的AssetBundle名字<br><img src="/img/Unity/AssetBundleUIBackgrnd1.PNG" alt="AssetBundleUIBackground1"><br><img src="/img/Unity/BackgroundImagePrefabAssetBundle.PNG" alt="BackgroundImagePrefabAssetBundle"><br><img src="/img/Unity/UIBackgroundPrefabAssetBundle.PNG" alt="UIBackgroundPrefabAssetBundle"></li>
<li>调用BuildPipeline.BuildAssetBundles()打包AssetBundle<br> Unity5.4官网给出了两个方法：</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> AssetBundleManifest <span class="title">BuildAssetBundles</span>(<span class="params"><span class="built_in">string</span> outputPath, BuildAssetBundleOptions assetBundleOptions, BuildTarget targetPlatform</span>)</span>; </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> AssetBundleManifest <span class="title">BuildAssetBundles</span>(<span class="params"><span class="built_in">string</span> outputPath, AssetBundleBuild[] builds, BuildAssetBundleOptions assetBundleOptions, BuildTarget targetPlatform</span>)</span>; </span><br></pre></td></tr></table></figure>
<pre><code>前者是以UnityEditor设置的AssetBundle name为准进行所有AssetBundle打包，后者是根据自定义的打包规则打包特定AssetBundle。
这里我尝试使用前者针对PC进行测试。
</code></pre>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> UnityEditor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">AssetBundleMenu</span> &#123;</span><br><span class="line">    [<span class="meta">MenuItem(<span class="string">&quot;Assets/Build AssetsBundle&quot;</span>)</span>]</span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">BuildAllAssetBundles</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (!AssetDatabase.IsValidFolder(<span class="string">&quot;Assets/StreamingAssets&quot;</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            AssetDatabase.CreateFolder(<span class="string">&quot;Assets&quot;</span>, <span class="string">&quot;StreamingAssets&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Caching.CleanCache();</span><br><span class="line">        BuildPipeline.BuildAssetBundles(<span class="string">&quot;Assets/StreamingAssets&quot;</span>, BuildAssetBundleOptions.None, BuildTarget.StandaloneWindows);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre><code>第一个参数是输出目录
第二参数控制AssetBundle打包设定，比如是否压缩等
第三个参数可设置打包平台
打包AssetBundle之后的目录结构：
![AssetBundleFolder](/img/Unity/AssetBundleFolder.PNG)
.manifest文件里存储了dependencies信息和AssetBundle里所打包的Assets相关信息
StreamingAssets.manifest
</code></pre>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ManifestFileVersion: <span class="number">0</span></span><br><span class="line">CRC: <span class="number">931964529</span></span><br><span class="line">AssetBundleManifest:</span><br><span class="line">  AssetBundleInfos:</span><br><span class="line">    Info_0:</span><br><span class="line">      Name: uitextures</span><br><span class="line">      Dependencies: &#123;&#125;</span><br><span class="line">    Info_1:</span><br><span class="line">      Name: backgroundimage</span><br><span class="line">      Dependencies:</span><br><span class="line">        Dependency_0: uitextures</span><br></pre></td></tr></table></figure>
<pre><code>uibackground.manifest
</code></pre>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">ManifestFileVersion: <span class="number">0</span></span><br><span class="line">CRC: <span class="number">1667709317</span></span><br><span class="line">Hashes:</span><br><span class="line">  AssetFileHash:</span><br><span class="line">    serializedVersion: <span class="number">2</span></span><br><span class="line">    Hash: <span class="number">452</span>c307ebc11a6155a4bdc61d8a0e39f</span><br><span class="line">  TypeTreeHash:</span><br><span class="line">    serializedVersion: <span class="number">2</span></span><br><span class="line">    Hash: a13e216067ae14bd74f1f5dcc7c211d7</span><br><span class="line">HashAppended: <span class="number">0</span></span><br><span class="line">ClassTypes:</span><br><span class="line">- Class: <span class="number">1</span></span><br><span class="line">  Script: &#123;instanceID: <span class="number">0</span>&#125;</span><br><span class="line">......</span><br><span class="line">Assets:</span><br><span class="line">- Assets/Resources/Textures/UI/backgroudn.png</span><br><span class="line">- Assets/Prefabs/UIBackground.prefab</span><br><span class="line">Dependencies: []</span><br></pre></td></tr></table></figure>
<pre><code>backgroundimage.manifest
</code></pre>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">ManifestFileVersion: <span class="number">0</span></span><br><span class="line">CRC: <span class="number">4279971007</span></span><br><span class="line">Hashes:</span><br><span class="line">  AssetFileHash:</span><br><span class="line">    serializedVersion: <span class="number">2</span></span><br><span class="line">    Hash: c15d1d4fd0fc89ad672fd6a94e16d981</span><br><span class="line">  TypeTreeHash:</span><br><span class="line">    serializedVersion: <span class="number">2</span></span><br><span class="line">    Hash: <span class="number">4583000</span>a582d4aadcaf8400b20641bd6</span><br><span class="line">HashAppended: <span class="number">0</span></span><br><span class="line">ClassTypes:</span><br><span class="line">- Class: <span class="number">1</span></span><br><span class="line">  Script: &#123;instanceID: <span class="number">0</span>&#125;</span><br><span class="line">......</span><br><span class="line">Assets:</span><br><span class="line">- Assets/Prefabs/BackgroundImage.prefab</span><br><span class="line">Dependencies:</span><br><span class="line">- Assets/ABs/uitextures</span><br></pre></td></tr></table></figure>
<pre><code>从StreamingAssets.manifest可以看出，我们总共制作了两个AssetBundle，名字分别为uitextures和backgroundimage，并且backgroundimage AssetBundle依赖于uitextures。
从uibackground.manifest和backgroundimage.manifest中可以看出，uibackground AssetBundle里包含了UIBackground.prefab和backgroudn.png，而backgroundimage AsssetBundle只包含BackgroundImage.prefab。
由于BackgroundImage.prefab使用background.png作为背景，但backgroundimage被打包到了uitextures AssetBundle里，所以backgroundimage AssetBundle是依赖于uitextures AssetBundle的。
</code></pre>
<ol start="3">
<li>通过AssetBundle API下载并加载主AssetBundle，然后通过AssetBundleManifest API查看所有AssetBundle的依赖信息并加载依赖的AssetBundle，最后通过AssetBundle API加载AssetBundle里的特定资源并实例化</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> UNITY_EDITOR</span></span><br><span class="line"><span class="keyword">using</span> UnityEditor;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">AssetBundleLoad</span> : <span class="title">MonoBehaviour</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Use this for initialization</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Start</span> ()</span> &#123;</span><br><span class="line">	    StartCoroutine(LoadAssetBundles());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">IEnumerator <span class="title">LoadAssetBundles</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="meta">#<span class="keyword">if</span> UNITY_EDITOR</span></span><br><span class="line">        <span class="keyword">var</span> names = AssetDatabase.GetAllAssetBundleNames();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="built_in">string</span> name <span class="keyword">in</span> names)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.Log(<span class="string">&quot;Current Alive Asset Bundle name: &quot;</span> + name);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        </span><br><span class="line">        <span class="built_in">string</span> bundlename = <span class="string">&quot;StreamingAssets&quot;</span>;</span><br><span class="line">        <span class="keyword">var</span> assetbundlerequest = AssetBundle.LoadFromFileAsync(Path.Combine(Application.streamingAssetsPath, bundlename));</span><br><span class="line">        <span class="keyword">yield</span> <span class="keyword">return</span> assetbundlerequest;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> assetbundle = assetbundlerequest.assetBundle;</span><br><span class="line">        <span class="keyword">if</span> (assetbundle == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.Log(<span class="string">&quot;Failed to load &quot;</span> + bundlename);</span><br><span class="line">            <span class="keyword">yield</span> <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        AssetBundleManifest manifest = assetbundle.LoadAsset&lt;AssetBundleManifest&gt;(<span class="string">&quot;AssetBundleManifest&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (manifest == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.Log(<span class="built_in">string</span>.Format(<span class="string">&quot;Failed to load &#123;0&#125;.manifest!&quot;</span>, bundlename));</span><br><span class="line">            <span class="keyword">yield</span> <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//try to instantiate backgroundimage assetbundle</span></span><br><span class="line">        <span class="comment">//but need to load dependencies assetbundle first</span></span><br><span class="line">        Debug.Log(<span class="string">&quot;Instantiate BackgroundImage.prefab&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> backgroundbundlename = <span class="string">&quot;backgroundimage&quot;</span>;</span><br><span class="line">        <span class="keyword">var</span> backgroundimagerequest = AssetBundle.LoadFromFileAsync(Path.Combine(Application.streamingAssetsPath, backgroundbundlename));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">yield</span> <span class="keyword">return</span> backgroundimagerequest;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (backgroundimagerequest == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.Log(<span class="built_in">string</span>.Format(<span class="string">&quot;Load &#123;0&#125; falied!&quot;</span>, <span class="string">&quot;backgroundimagerequest&quot;</span>));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> backgroundimageassetbundle = backgroundimagerequest.assetBundle;</span><br><span class="line">        <span class="keyword">if</span>(backgroundimageassetbundle == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.Log(<span class="built_in">string</span>.Format(<span class="string">&quot;Load &#123;0&#125; falied!&quot;</span>, backgroundimageassetbundle));</span><br><span class="line">            <span class="keyword">yield</span> <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> backgrounddependencies = manifest.GetAllDependencies(backgroundbundlename);</span><br><span class="line">        <span class="keyword">if</span> (backgrounddependencies.Length == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.Log(<span class="string">&quot;dependencies.length == 0&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Load dependencies assetbundle first</span></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="built_in">string</span> dependency <span class="keyword">in</span> backgrounddependencies)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.Log(<span class="string">&quot;Dependency : &quot;</span> + dependency);</span><br><span class="line">            <span class="keyword">var</span> dependencyabrequest = AssetBundle.LoadFromFileAsync(Path.Combine(Application.streamingAssetsPath, dependency));</span><br><span class="line">            <span class="keyword">yield</span> <span class="keyword">return</span> dependencyabrequest;</span><br><span class="line">            AssetBundle dependencyab = dependencyabrequest.assetBundle;</span><br><span class="line">            <span class="keyword">if</span> (dependencyab == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                Debug.Log(<span class="built_in">string</span>.Format(<span class="string">&quot;Load &#123;0&#125; failed!&quot;</span>, dependency));</span><br><span class="line">                <span class="keyword">yield</span> <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Once load all dependencies assetbundle, we can instantiate the gameobject in assetbundle</span></span><br><span class="line">        <span class="keyword">var</span> backgroundprefabrequest = backgroundimageassetbundle.LoadAssetAsync(<span class="string">&quot;BackgroundImage.prefab&quot;</span>);</span><br><span class="line">        <span class="keyword">yield</span> <span class="keyword">return</span> backgroundprefabrequest;</span><br><span class="line">        <span class="keyword">if</span>(backgroundprefabrequest == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.Log(<span class="built_in">string</span>.Format(<span class="string">&quot;Load &#123;0&#125; faled!&quot;</span>, <span class="string">&quot;BackgroundImage.prefab&quot;</span>));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        GameObject backgroundimage = backgroundprefabrequest.asset <span class="keyword">as</span> GameObject;</span><br><span class="line">        <span class="keyword">if</span>(backgroundimage == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.Log(<span class="string">&quot;backgroundimage == null&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            GameObject bggo = Instantiate(backgroundimage);</span><br><span class="line">            bggo.transform.SetParent(gameObject.transform, <span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//After complete using AssetBundle, always remember unload it, </span></span><br><span class="line">        <span class="comment">//otherwise you can not load it again due to it has exists in memory</span></span><br><span class="line">        assetbundle.Unload(<span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从上面可以看出，通过主的StreamingAssets，我们获取到了里面所包含的所有AssetBundle信息。然后通过加载指定AssetBundle以及dependencies AssetBundle后，我们就能成功初始化出AsestBundle里的资源。<br>上述代码实例化了Background.prefab(使用的backgroudn.png存储在uitextures AssetBundle里)<br>效果图：<br><img src="/img/Unity/BackgroundImageAssetBundleLoad.PNG" alt="BackgroundImageAssetBundleLoad"></p>
<p>上面使用的CreateFromFile后续Unity更新成了LoadFromFile，这个方法只支持uncompressed asset bundles，这里主要是因为利用了streaming assets，所以直接用这个方法可以加载本地的AssetBundle。<br>官方的建议在正式的时候是使用UnityWebRequest。<br>Note:<br><a target="_blank" rel="noopener" href="https://docs.unity3d.com/ScriptReference/BuildPipeline.BuildAssetBundles.html">Note that bundles built for standalone platforms are not compatible with those built for mobiles and so you may need to produce different versions of a given bundle. </a>(针对不同平台打包的AssetBundle不通用，需要各自打包对应平台的版本)</p>
<p>上面仅仅是以本地读取作为事例，了解了如何去访问AssetBundle以及manifest里的信息以及如何实例化AssetBundle里的资源。<br>那么如何判断AssetBundle是否需要更新了？<br>这里我们可以利用Built-in caching去实现版本更新判断。<br>“AssetBundle caching system that can be used to cache AssetBundles downloaded via the WWW.LoadFromCacheOrDownload or UnityWebRequest APIs.”(AssetBundle caching system可以帮助我们缓存加载了的AssetBundle而无需每次都重新加载)<br>而AssetBundle caching system是根据AssetBundle的version number来决定时是否下载新的AssetBundle。(AssetBundleManifest API支持通过MD5算法去计算出AssetBundle的version<br>number，这样一来每次AssetBundle有变化都会得到一个新的Hash version number)</p>
<p>“AssetBundles in the caching system are identified only by their file names, and not by the full URL from which they are downloaded.”(AssetBundles在Caching system里是通过文件名来标识的跟URL无关，所以无论AssetBundle放在服务器哪里都没有关系)</p>
<p>Cach相关的API控制:</p>
<ol>
<li>Caching.expirationDelay<br>“The minimum number of seconds that must elapse before an AssetBundle is automatically deleted. If an AssetBundle is not accessed during this time, it will be deleted automatically.”(AssetBundle可允许被删除的未使用时间，只有未被使用的时间达到了才能才被删除)</li>
<li>Caching.maximumAvailableDiskSpace<br>“The amount of space on local storage that the cache may use before it begins deleting AssetBundles that have been used less recently than the expirationDelay. It is counted in bytes.”(Caching内存使用上限)</li>
</ol>
<p>Note:<br>“As of Unity 5.3, control over the built-in Unity cache is very rough. It is not possible to remove specific AssetBundles from the cache. They will only be removed due to expiration, excess disk space usage, or a call to Caching.CleanCache. (Caching.CleanCache will delete all AssetBundles currently in the cache.) “(Caching System还不完善，所以还不允许删除特定AssetBundle，而只能通过Caching.CleanCache去删除所有的AssetBundle)</p>
<p>Cache Priming:<br>Steps:</p>
<ol>
<li>Store the initial or base version of each AssetBundle in &#x2F;Assets&#x2F;StreamingAssets&#x2F;</li>
<li>Loading AssetBundles from Application.streamingAssetsPath the first time the application is run</li>
<li>Call WWW.LoadFromCacheOrDownload or UnityWebRequest normally.</li>
</ol>
<p>Custom downloaders:<br><a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/topics/best-practices/assetbundle-usage-patterns?playlist=30089">Custom downloaders More</a><br>……</p>
<p>一般AssetBundle都是通过WWW.LoadFromCacheOrDownload(老版本)或者UnityWebRequest指定url和版本号信息去决定是否下载更新到本地。<br>然后我们利用AssetBundle.CreateFromFile()去读取AssetBundle，从而实现动态更新AssetBundle。</p>
<p>那么在使用AssetBundle的过程中，我们应该遵循后续讲到的内容(大部分翻译至官网，翻译不太对的地方欢迎指出)：<br>Managing Loaded Assets：<br>“If an AssetBundle is unloaded improperly, it can cause Object duplication in memory. Improperly unloading AssetBundles can also result in undesirable behavior in certain circumstances.”(不合理的释放Object会导致在内存中重复创建Object。同时也可能导致非预期的问题(比如texture丢失))</p>
<p>对于AssetBundle里Assets管理，这里需要强调的一个API是AssetBundle.Unload(bool);<br>Unloads all assets in the bundle.<br>Unload frees all the memory associated with the objects inside the bundle.<br>当传递true的时候所有从AssetBundle里实例化的Object都会被unload。传递false则只释放AssetBundle资源。</p>
<p>那么这里释放的AssetBundle资源是哪些了？<br>还记得之前提到的AssetBundle的组成吗(header &amp; data segment)</p>
<p>下面通过AssetBundleAB里的Material Object M实例化的M为例：<br><img src="/img/Unity/AssetBundleUnload.PNG" alt="AssetBundleUnload"><br><img src="/img/Unity/AssetBundleAfterUnloadFalse.PNG" alt="AssetBundleAfterUnloadFalse"><br><img src="/img/Unity/AssetBundleReload.PNG" alt="AssetBundleReload"><br><img src="/img/Unity/AssetBundleLoadObjectAgain.PNG" alt="AssetBundleLoadObjectAgain"><br>如果AB.Unload(true)，那么实例化的M会被destroyed。<br>如果AB.Unload(false)，那么AB里的信息会被unloaded，但M还存在于Scene里，但M和AB之间关联就断开了。<br>当我们重新加载AB后，我们只是再次加载了AB里的信息，但M和AB还是没有关联。<br>当我们通过重新加载的AB再去实例化Material Object M的时候，我们是创建了一个关联到当前AB的新的M而非把就的关联到AB(Scene里当前存在两个M)</p>
<p>当我们想unloaded旧的M的时候，只能通过下列方式：</p>
<ol>
<li>Eliminate all references to an unwanted Object, both in the scene and in code. After this is done, call Resources.UnloadUnusedAssets.(取消所有引用，并调用Resources.UnloadUnusedAssets)</li>
<li>Load a scene non-additively. This will destroy all Objects in the current scene and invoke Resources.UnloadUnusedAssets automatically.(切换Scene，触发Resources.UnloadUnusedAssets)</li>
</ol>
<p>“Another problem can arise if Unity must reload an Object from its AssetBundle after the AssetBundle has been unloaded. In this case, the reload will fail and the Object will appear in the Unity Editor’s hierarchy as a (Missing) Object.”(当AssetBundle被释放后，如果再从该AssetBundle里加载Object会加载失败，出现missing object)</p>
<p>Distribution:<br>Two basic ways to distribute a project’s AssetBundles to clients:</p>
<ol>
<li>Installing them simultaneously with the project </li>
<li>Downloading them after installation.<br>使用哪一种方式，主要取决于平台需求。<br>“Mobile projects usually opt for post-install downloads to reduce initial install size and remain below over-the-air download size limits. Console and PC projects generally ship AssetBundles with their initial install.”(手机上为了减少安装程序大小，通常选择post-installation。而PC不担心硬盘不够，所以通常选择initial install)</li>
</ol>
<p>Shipped with Project：<br>“To reduce project build times and permit simpler iterative development. If these AssetBundles do not need to be updated separately from the application itself, then the AssetBundles can be included with the application by storing the AssetBundles in Streaming Assets.”(和程序一起更新的AssetBundle可以放在streaming assets伴随程序一起打包发布)</p>
<p>Streaming Assets:<br>“The easiest way to include any type of content within a Unity application at install time is to build the content into the &#x2F;Assets&#x2F;StreamingAssets&#x2F; folder, prior to building the project. Anything contained in the StreamingAssets folder at build time will be copied into the final application. This folder can be used to store any type of content within the final application, not just AssetBundles.”(可以看出Streaming Assets被存放在&#x2F;Assets&#x2F;StreamingAssets&#x2F;目录下，最终会被打包到应用程序里)</p>
<p>Note:<br>“Android Developers: On Android, Application.streamingAssetsPath will point to a compressed .jar file, even if the AssetBundles are compressed. In this case, WWW.LoadFromCacheOrDownload must be used to load each AssetBundle.”(在Android上，streamingAssetsPath指向的是压缩后的.jar文件，所以我们需要采用LoadFromCacheOrDonwload去解压读取(5.3及以后可以采用UnityWebRequest’s DonwloadHandleAssetBundle))</p>
<p>“Streaming Assets is not a writable location on some platforms. If a project’s AssetBundles need to be updated after installation, either use WWW.LoadFromCacheOrDownload or write a custom downloader. “(因为Streaming Assets在一些平台上是一个不可写的位置，所以我们如果还需要更新该AssetBundle，我们而已通过WWW.LoadFromCacheOrDonwload或则自己编写custom downloader)</p>
<p>Donwloaded post-install:<br>手机上出于程序安装大小考虑多采用这个方案。<br>同时AssetBundle通过WWW.LoadFromCacheOrDownload or UnityWebRequest的更新可以快速方便的更新一些经常变化的资源。<br><a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/topics/best-practices/assetbundle-usage-patterns?playlist=30089">更多内容参见</a></p>
<p>Asset Assignment Strategies:<br>The key decision is how to group Objects into AssetBundles. The primary strategies are:</p>
<ol>
<li>Logical entities</li>
<li>Object Types</li>
<li>Concurrent content<br><a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/topics/best-practices/assetbundle-usage-patterns?playlist=30089">详情参见</a></li>
</ol>
<p>Guidelines to follow:</p>
<ol>
<li>Split frequently-updated Objects into different AssetBundles than Objects that usually remain unchanged</li>
<li>Group together Objects that are likely to be loaded simultaneously</li>
</ol>
<p>Patching with AssetBundles:<br>“Patching AssetBundles is as simple as downloading a new AssetBundle and replacing the existing one.”(Patching AssetBundles用于实现动态替换一些资源很方便)</p>
<p>AssetBundle Variants：<br>什么是AssetBundle Variants？<br>AssetBundle Variants可以指定AssetBundle里Asset的别名。(两个不同的名字可以指代同一个Asset)</p>
<p>AssetBundle Variants可以用来做什么？<br>[<a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/topics/best-practices/assetbundle-usage-patterns?playlist=30089">The purpose of Variants is to allow an application to adjust its content to better suit its runtime environment. Variants permit different UnityEngine.Objects in different AssetBundle files to appear as being the “same” Object when loading Objects and resolving Instance ID references.It permits two UnityEngine.Objects to appear to share the same File GUID &amp; Local ID, and identifies the actual UnityEngine.Object to load by a string Variant ID.</a>(AssetBundle Variants的主要目的是用于动态适应一些运行时的设置。AssetBundle Variants允许两个Asset Object拥有同样的File GUID …&amp; Local ID，但可以通过string Variant ID加载特定的Asest Object)</p>
<p>什么情况下适合使用AssetBundle Variants？</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/topics/best-practices/assetbundle-usage-patterns?playlist=30089">Variants simplify the loading of AssetBundles appropriate for a given platform</a>(用于加载特定平台的对应AssetBundle)</li>
<li><a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/topics/best-practices/assetbundle-usage-patterns?playlist=30089">Variants allow an application to load different content on the same platform, but with different hardware.</a>(针对不同硬件相同平台加载对应的content资源)</li>
</ol>
<p>那么AssetBundle Variants有哪些限制？<br><a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/topics/best-practices/assetbundle-usage-patterns?playlist=30089">A key limitation of the AssetBundle Variant system is that it requires Variants to be built from distinct Assets.</a>(最大的限制就是AssetBundle Variant要求不同的Variants必须编译到不同的Asset。这样一来会导致重复的资源打包(e.g比如两个不同的Texture Variant只是import设置不一样也必须编译两份))</p>
<p>另一个AssetBundle需要关注的点就是Compressed or Uncompressed？<br>那么如何在Compressed和Uncompressed之间抉择了？主要关注以下几点：</p>
<ol>
<li>加载速度。<br>压缩与否影响AssetBundle的资源大小，同时也影响加载的时候的加载速度。</li>
<li>AssetBundle编译时间。<br>同时压缩的话也会导致Build AssetBundle的时间变长。</li>
<li>程序大小<br>一些AssetBundle是伴随Application打包发布，会影响程序初始大小</li>
<li>内存使用<br>不同的压缩算法对加载时对内存的影响也不一样，LZ4压缩算法和未压缩的方式允许AssetBundle无需解压缩就能访问使用(节约内存)。</li>
<li>AssetBundle下载时间<br>AssetBundle资源的大小也同时影响AssetBundle的下载时间。</li>
</ol>
<p>更多学习<a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/topics/best-practices/assetbundle-usage-patterns?playlist=30089">参考</a><br><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/BuildingAssetBundles.html">AssetBundles</a></p>
<p>具体现有的完美AssetBundle使用方案，<a target="_blank" rel="noopener" href="https://bitbucket.org/Unity-Technologies/assetbundledemo">AssetBundle Manager on Bitbucket</a><br>接下来以学习使用AssetBundle Manager来理解AssetBundle里的一些相关知识和概念。<br>首先来看看什么是AssetBundle Manager？<br><a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/topics/scripting/assetbundles-and-assetbundle-manager">The AssetBundle Manager is a downloadable package that can be installed in any current Unity project and will provide a High-level API and improved workflow for managing AssetBundles.</a>(可以看出AssetBundle Manager为我们提供了更高层的AssetBundle管理的抽象，更方便使用和管理AssetBundle，作为免费的第三方插件在Unity Asset Store可以下载使用)<br><a target="_blank" rel="noopener" href="https://www.assetstore.unity3d.com/#!/content/45836">AssetBundle Manager Download</a></p>
<p>那么AssetBundle Manager能做到什么？<br><a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/topics/scripting/assetbundles-and-assetbundle-manager">The AssetBundle Manager helps manage the key steps in building and testing AssetBundles. The key features provided by the AssetBundle Manager are a Simulation Mode, a Local AssetBundle Server and a quick menu item to Build AssetBundles to work seamlessly with the Local AssetBundle Server.</a>(在AssetBundle里，最令人头疼的是编译和测试(需要不断编译然后上传然后测试)。AsestBundle Manager为我们提供了本地AssetBundle Server模拟的方案，还有快速编译打包AssetBundle的菜单，让我们可以快速的编译测试AssetBundle)<br><img src="/img/Unity/AssetBundleManagerQuickMenu.PNG" alt="AssetBundleManagerQuickMenu"><br>Simulation Mode:<br><a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/topics/scripting/assetbundles-and-assetbundle-manager">When enabled, allows the editor to simulate AssetBundles without having to actually build them. The editor looks to see which Assets are assigned to AssetBundles and uses these Assets directly from the Project’s hierarchy as if they were in an AssetBundl.</a>(当模拟模式开启的时候，editor可以通过不编译AssetBundle就能模拟AssetBundles的使用(直接使用指定了AssetBundle name的Assets)，这样一来在Editor下就能快速的修改测试，无需每次编译AssetBundle)</p>
<p>Local Asset Server:<br>作为AssetBundle里重要的功能之一： AsssetBundle Variant<br>AssetBundle Manager也支持了快速方便的AssetBundle Variant测试。<br>通过Local Asset Server的本地模拟方式测试。(同时Local Asset Server还支持真机测试)<br>Note:<br><a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/topics/scripting/assetbundles-and-assetbundle-manager">When Local Asset Server is enabled, AssetBundles must be built and placed in a folder explicitly called “AssetBundles” in the root of the Project, which is on the same level as the “Assets” folder.</a>(当Local Asest Server开启的时候，AssetBundles必须编译放置在Assets&#x2F;AssetBundles目录下)</p>
<p>Build AssetBundles:<br>快速编译打包AssetBundles。</p>
<p>实战学习使用AssetBundle Manager：<br>首先粗略的了解下AssetBundle Manager提供的一些API：<br>Initialize() – Initializes the AssetBundle manifest object.(初始化AssetBundle Manifest Object)<br>LoadAssetAsync() – Loads a given asset from a given AssetBundle and handles all the dependencies.(加载特定Asset，并负责处理器所有的dependencies)<br>LoadLevelAsync() – Loads a given scene from a given AssetBundle and handles all the dependencies.(加载特定scene，并负责处理所有的dependencies)<br>LoadDependencies() – Loads all the dependent AssetBundles for a given AssetBundle.(加载AssetBundle所依赖的所有dependencies)<br>BaseDownloadingURL – Sets the base downloading url which is used for automatic downloading dependencies.(设置dependencies下载url)<br>SimulateAssetBundleInEditor – Sets Simulation Mode in the Editor.(设置editor的模拟模式)<br>Variants – Sets the active variant.(设置激活的variants)<br>RemapVariantName() – Resolves the correct AssetBundle according to the active variant.</p>
<p>Loading Assets(AssetLoader.unity)：<br>待续……</p>
<h2 id="Resource-LifeCycle"><a href="#Resource-LifeCycle" class="headerlink" title="Resource LifeCycle"></a>Resource LifeCycle</h2><p>在得出如何利用Resources和AsetBundle高效管理资源方案之前，我们需要了解Resource的Lifecycle。<br>还记得前面提到的Asset和Obejct是如何被Unity记录下来的吗？<br>通过File GUID进行Asset标识(存储在.meta文件里，还存储了导入配置信息)，通过Local ID对Object标识(存储在Asset文件自身，还存储了Object具体的配置信息)。<br>然后Unity通过Instance ID cache system管理着Instance ID到File GUID和Local ID(用于标识Asset的Obejct)的映射去查询访问每一个Object。</p>
<p>那么Resources Lifecycle(UnityEngine.Object)具体是怎样的了？<br>程序启动时会去加载所有场景里引用的Object的Instance ID，后续程序动态加载或则通过AssetBundle加载资源的时候会去更新新的Instance ID。</p>
<p>Two ways to load UnityEngine.Objects(加载Object): </p>
<ol>
<li>Automatically – An Object is loaded automatically whenever the instance ID mapped to that Object is dereferenced(间接引用)</li>
<li>Explicitly – Resource-loading API(e.g. AssetBundle.LoadAsset)</li>
</ol>
<p>那么Object什么情况下才会被加载到游戏里了？<br>An Object will be loaded on-demand the first time its Instance ID is dereferenced if two criteria are true:(当Instance ID被间接引用同时满足以下两个条件的时候，Object会被加载)</p>
<ol>
<li>The Instance ID references an Object that is not currently loaded(Instance ID引用的Object还没加载)</li>
<li>The Instance ID has a valid File GUID and Local ID registered in the cache(Instance ID拥有的File GUID和Local ID已经存在于cache里)</li>
</ol>
<p>什么情况下，Object会被unloaded了？<br>Objects are unloaded in three specific scenarios(Object被Unloaded的三种情况):</p>
<ol>
<li>Objects are automatically unloaded when unused Asset cleanup occurs.(比如Application.LoadLevel() Rersources.UnloadUnusedAssets()调用的时候，Object会被自动unloaded)</li>
<li>Objects sourced from the Resources folder can be explicitly unloaded by invoking the Resource.UnloadAsset API.(主动调用Resource API去unload resoures下的object)</li>
<li>Objects source from Asset Bundles are automatically and immediately unloaded when invoking the AssetBundle.Unload(true) API.(这样会导致AssetBundle里的Objects InstanceID的引用无效)<br>具体Resource API如何影响Object的的生命周期，还需进一步学习，参考文档<a target="_blank" rel="noopener" href="https://docs.unity3d.com/ScriptReference/AssetBundle.html">AssetBundle</a></li>
</ol>
<p>知道了Resources的生命周期和如何被映射缓存的，那么如何才能以高效的方式存储resources了？<br>Loading Large Hierarchies(当我们制作一个复杂的Resources时):<br>“When serializing hierarchies of Unity GameObjects (such as when serializing prefabs), it is important to remember that the entire hierarchy will be fully serialized.”(当序列化Unity GameObject的时候，所有存在于hierarchy下的GameObject都会被一一序列化。)</p>
<p>When creating any GameObject hierarchy, CPU time is spent in several different ways:</p>
<ol>
<li>Time to read the source data (from storage, from another GameObject, etc.)</li>
<li>Time to set up the parent-child relationships between the new Transforms</li>
<li>Time to instantiate the new GameObjects and Components</li>
<li>Time to awaken the new GameObjects and Components<br>我们的关注点放到第一点上，数据的读写方式对后面三点影响不大，第一点跟数据的读写方式和数据的大小紧密相关。<br>“On all current platforms, it is considerably faster to read data from elsewhere in memory rather than loading it from a storage device. “(所有平台上，从内存中读取都比从存储设备去读取快，当然不同的平台的读取速度会有一些差别)</li>
</ol>
<p>我们前面提到当由复杂结构的GameObject的时候，所有对象都会被单独序列化(无论是否重复)，这样一来会导致数据量很大，在加载的时候很慢。为了提高速度，我们可以通过把复杂的GameObject划分为多个单独的小的Prefab，然后通过实例化多个Prefab来构建我们的GameObject而非完全依赖于Unity的Serialization和prefab system。(减少了数据量。同时一旦Prefab被加载后，从内存中读取就比从硬件设备读取快多了)</p>
<h1 id="内置资源"><a href="#内置资源" class="headerlink" title="内置资源"></a>内置资源</h1><p><strong>内置资源</strong>是指Unity默认自带的一些资源(e.g. 默认的图标资源，默认的材质资源，默认的天空盒资源，默认的Shader资源等)</p>
<p>为什么要了解内置资源了？</p>
<p>因为内置资源我们没法显示指定AB名字，容易造成打包冗余。所以在了解特定资源打包之前，我们来学习了解下如何避免内置资源造成的打包冗余。</p>
<p>详情参考:</p>
<p><a target="_blank" rel="noopener" href="https://blog.uwa4d.com/archives/1577.html">Unity 5.x AssetBundle零冗余解决方案</a></p>
<p>要想避免内置资源的打包冗余，我们需要把内置资源提取出来使用。结合上面的文章的学习，可以理解成如下几步：</p>
<ol>
<li>提取内置资源</li>
<li>修改内置资源引用(手动)</li>
<li>检查内置资源引用</li>
</ol>
<p>本人尝试了前面文章提到的 AssetDataBase.LoadAllAssetsAtPath(“Resources&#x2F;unity_builtin_extra”)的方式，发现并不能得到内置资源(<strong>AssetDataBase.LoadAllAssetsAtPath(“Resources&#x2F;unity_builtin_extra”)此路不通后，暂时只想到从使用内置资源的对象上复制内置资源进行提取了。</strong>)</p>
<p>修改内置资源的引用比较麻烦，需要修改相关文件里对内置资源引用的guid和fieldID等来实现串改内置资源引用的目的。这样做实现起来比较困难，所以这里并不打算使用此方案。</p>
<p>新方案：</p>
<p><strong>直接收集所有使用了内置资源的资源然后结合内置资源引用统计分析来进行时侯东替换来实现内质资源的引用替换</strong></p>
<p>实现上述功能我们需要做到如下两点：</p>
<ol>
<li>提取内置资源</li>
<li>结合内置资源引用分析替换对应内置资源成提取出来的资源</li>
</ol>
<p>资源辅助工具三件套：</p>
<ul>
<li><p>资源依赖查看工具</p>
<p><img src="/img/Unity/AssetBundle-Framework/AssetDependenciesBrowser.png" alt="AssetDependenciesBrowser"></p>
</li>
<li><p>内置资源依赖统计工具(只统计了*.mat和*.prefab，场景建议做成Prefab来统计)</p>
<p><img src="/img/Unity/AssetBundle-Framework/BuildInResourceReferenceAnalyze.png" alt="BuildInResourceReferenceAnalyze"></p>
</li>
<li><p>内置资源提取工具</p>
<p><img src="/img/Unity/AssetBundle-Framework/BuildInResourceExtraction.png" alt="BuildInResourceExtraction"></p>
</li>
</ul>
<p>至此，我们完成了依赖Asset统计，内置资源引用分析，内置资源提取和内置资源引用替换(手动)。</p>
<p>详细代码：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/TonyTang1990/AssetBundleLoadManager">AssetBundleLoadManager</a></p>
<p>解决了内置Shader的引用打包问题，后面在专门讲Shader的小节会提到如何使用ShaderVariantsCollection解决变体预加载问题。</p>
<p>Note:</p>
<ol>
<li>内置Shader可直接官网下载</li>
<li><strong>复制提取资源引用的Shader需要重新指定一次才能正确引用本地下载的Shader</strong></li>
<li><strong>一开始导入下载好的内置Shader后，经过代码统计原来引用内置Shader的还是引用的内置的，但我将一个导入的内置Shader改名(这里指的改Shader “Mobile&#x2F;Diffuse” 后再改回来发现引用内置Shader的资源变成了引用最新导入的内置Shader了。</strong></li>
</ol>
<h1 id="Unity-AB实战"><a href="#Unity-AB实战" class="headerlink" title="Unity AB实战"></a>Unity AB实战</h1><p>以Unity5.0以后的版本作为学习对象。<br>打包以及加载管理这一套实战，单独提了一篇文章来写，详情查看:<br><a href="http://tonytang1990.github.io/2018/10/24/AssetBundle-Framework">AssetBundle-Framework</a></p>
<h1 id="特定资源打包"><a href="#特定资源打包" class="headerlink" title="特定资源打包"></a>特定资源打包</h1><p>这里针对不同的资源类型进行深度学习了解，理解项目中为什么不同的资源格式不同的平台为什么要设置特定的格式或者导入设定等信息，从而优化资源的内存占用以及相关不必要的开销。</p>
<h2 id="纹理贴图"><a href="#纹理贴图" class="headerlink" title="纹理贴图"></a>纹理贴图</h2><p>纹理贴图是游戏内存占用中的一个很大板块(含纹理，图集等)。</p>
<p>首先让我们理解一下，纹理贴图里一些重要的概念:</p>
<ol>
<li>GPU与纹理</li>
<li>文件格式</li>
<li>纹理格式</li>
<li>压缩算法</li>
</ol>
<h3 id="移动GPU"><a href="#移动GPU" class="headerlink" title="移动GPU"></a>移动GPU</h3><ol>
<li><p>Imagination Techniologies(PowerVR)<br>代表作： Apple Iphone，Ipad系列</p>
</li>
<li><p>Qualcomm(高通 Adreno系列)<br>代表作：小米部分手机</p>
</li>
<li><p>ARM(Mali系列)<br>代表作：三星部分手机</p>
</li>
<li><p>NVIDIA(英伟达 Tegre系列)<br>代表作：Google Nexus部分手机</p>
</li>
</ol>
<h3 id="文件格式"><a href="#文件格式" class="headerlink" title="文件格式"></a>文件格式</h3><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/luming1979/archive/2013/02/04/2891421.html">文件格式是图像为了存储信息而使用的对信息的特殊编码方式，它存储在磁盘中，或者内存中，但是并不能被GPU所识别，因为以向量计算见长的GPU对于这些复杂的计算无能为力。这些文件格式当被游戏读入后，还是需要经过CPU解压成R5G6B5，A4R4G4B4，A1R5G5B5，R8G8B8, A8R8G8B8等像素格式，再传送到GPU端进行使用。</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/luming1979/archive/2013/02/04/2891421.html">常用的图像文件格式有BMP，TGA，JPG，GIF，PNG等；</a></p>
<p>文件格式主要决定了原数据是有损还是无损的以及数据存储方式。<br>这里主要提两个常见的文件格式：</p>
<ol>
<li>PNG<br><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/PNG">便携式网络图形（Portable Network Graphics，PNG）是一种<strong>无损压缩</strong>的位图图形格式，支持索引、灰度、RGB三种颜色方案以及Alpha通道等特性。</a></li>
<li>JPG<br><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/JPEG">JPEG是一种针对照片视频而广泛使用的<strong>有损压缩</strong>标准方法。</a><a target="_blank" rel="noopener" href="https://www.zhihu.com/question/20028452">JPEG不适合用来存储企业Logo、线框类的图。因为有损压缩会导致图片模糊</a></li>
</ol>
<p>详情参考:<a target="_blank" rel="noopener" href="https://www.zhihu.com/question/20028452">图片格式 jpg、png、gif各有什么优缺点？什么情况下用什么格式的图片呢？</a></p>
<p>Note：<br><strong>考虑到Unity最终进游戏是源文件经过Unity压缩后的形式，所以个人觉得采用不压缩的PNG作为源文件相比JPG更好(1. 无损压缩 2. 支持Alpha通道)。</strong></p>
<h3 id="纹理格式"><a href="#纹理格式" class="headerlink" title="纹理格式"></a>纹理格式</h3><p>在了解纹理格式之前，我先了解下纹理格式能带来什么好处？<br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/luming1979/archive/2013/02/04/2891421.html"><strong>纹理格式是能被GPU所识别的像素格式，能被快速寻址并采样。</strong></a><br>简而言之<a target="_blank" rel="noopener" href="http://imgtec.eetrend.com/blog/6912"><strong>无需CPU解压即可被GPU读取，节省CPU时间和带宽。</strong></a></p>
<p>了解了纹理格式的好处，让我们看看不同的纹理格式的内存占用情况。<br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/luming1979/archive/2013/02/04/2891421.html">OpenGL ES 2.0支持以上提到的R5G6B5，A4R4G4B4，A1R5G5B5，R8G8B8，A8R8G8B8等纹理格式，其中 R5G6B5，A4R4G4B4，A1R5G5B5每个像素占用2个字节(BYTE)，R8G8B8每个像素占用3个字节，A8R8G8B8每个像素占用 4个字节。</a><br><img src="/img/Unity/OpenGLES2TextureFormatDisplay.png" alt="OpenGLES2TextureFormatDisplay"></p>
<p>查了半天OpenGL ES 2.0的纹理格式支持，官方找到的，见下图:<br><img src="/img/Unity/OpenGLES2TextureFormatSupported.png" alt="OpenGLES2TextureFormat"></p>
<p><a target="_blank" rel="noopener" href="https://www.khronos.org/registry/OpenGL/specs/es/2.0/es_cm_spec_2.0.pdf">es_cm_spec_2.0.pdf</a></p>
<p>如何查询Android GPU是否支持OpenGL ES3.0我也没找到单个比较全面的网站，所以只找到各自GPU的官网或者wiki上有描述。<br>参考:<br><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Adreno">Adreno</a><br><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Mali_(GPU)">Mali (GPU)</a><br><a target="_blank" rel="noopener" href="https://www.qualcomm.cn/snapdragon/gpu-specifications">Qualcomm GPU规格</a></p>
<p>比如我们要查小米3是否支持OpenGL ES3.0，我们可以现在小米官网查到小米3使用的是Adreno 800 GPU，系统是&gt;4.3的。<br>那么我们去查adreno 800支不支持OpenGL ES3.0即可，然后发现在Qualcomm官网查到adreno 800系列全部都支持OpenGL ES3.0。</p>
<p>如何查询IOS GPU是否支持OpenGL ES3.0:<br>参考:<br><a target="_blank" rel="noopener" href="https://developer.apple.com/library/archive/documentation/DeviceInformation/Reference/iOSDeviceCompatibility/HardwareGPUInformation/HardwareGPUInformation.html">IOS device Graphics Processors</a></p>
<p>至于代码层面如何判定是否支持OpenGL 3.0：<br>参考UWA的一个问答:<br><a target="_blank" rel="noopener" href="https://answer.uwa4d.com/question/5ae714b00956834900752685">如何判断硬件支持GpuInstance</a></p>
<p>Note:</p>
<ol>
<li>ETC1不支持Alpha，ETC2支持Alpha，但ETC2需要OpenGL ES 3.0支持。</li>
<li>ETC2不仅需要Android 4.3以上，还要硬件GPU支持OpenGL ES3.0才行。</li>
<li>IOS5s(含5s)以后使用A7 GPU(含A7)以后的GPU才支持OpenGL ES3.0。</li>
</ol>
<h3 id="压缩压缩格式"><a href="#压缩压缩格式" class="headerlink" title="压缩压缩格式"></a>压缩压缩格式</h3><p>通过纹理格式，我们已经使得GPU能够直接读取纹理，为什么还需要纹理压缩了？<br><strong>纹理压缩的主要作用是为了压缩数据，减少内存开销。</strong></p>
<p>常见的纹理压缩格式：</p>
<ol>
<li><p>ETC(Erricsson texture compression)<br>这里的ETC主要分为ETC1和ETC2.</p>
<ul>
<li>ETC1主要是用于RGB的24-bit数据压缩(Note:不包含Alpha通道，在OpenGL ES 2.0就要求支持，所以基本是所有Android机型通用。参考：<a target="_blank" rel="noopener" href="https://www.khronos.org/registry/OpenGL/extensions/OES/OES_compressed_ETC1_RGB8_texture.txt">GL_OES_compressed_ETC1_RGB8_texture</a>。ETC1想要配合使用Alpha信息需要拆成两张图，一张RGB，一张A。)</li>
<li>ETC2在兼容ETC1的基础上支持了Alpha通道的压缩(Note:ECT2至少要OpenGL ES 3.0 参考：<a target="_blank" rel="noopener" href="https://www.khronos.org/assets/uploads/developers/library/2012-siggraph-opengl-es-bof/Ericsson-ETC2-SIGGRAPH_Aug12.pdf">ETC2 Compression</a>)</li>
</ul>
</li>
<li><p>PVRTC(PowerVR texture compression)<br>PowerVR主要用于苹果的压缩格式</p>
</li>
<li><p>ATITC(ATI texture compression)<br>Qualcomm Adreno系列。</p>
</li>
<li><p>S3TC(也叫作DXT)<br>PC的NVIDIA Tegra系列。</p>
</li>
<li><p>ASTC(Adaptive Scalable Texture Compression)<br><a target="_blank" rel="noopener" href="https://www.khronos.org/opengl/wiki/ASTC_Texture_Compression">ASTC Texture Compression</a><br>从wiki来看，ASTC是一个更高效，希望能统一移动端压缩格式的一个新兴压缩格式，要求至少OpenGL ES 3.0，且大部分手机现在并不支持ASTC(2018&#x2F;05&#x2F;28，当前只有少部分Mali的机器支持)。</p>
</li>
</ol>
<p>移动平台各种压缩格式像素数据信息(以下信息来源:<a target="_blank" rel="noopener" href="http://imgtec.eetrend.com/blog/6912">移动设备的纹理压缩方案</a>):<br><img src="/img/Unity/CompresssionFormatSizeComparision.png" alt="CompresssionFormatSizeComparision"></p>
<p>移动端平台压缩格式选择：<br>Android:</p>
<ol>
<li>ECT1是被OpenGL ES 2.0支持，适合大部分Android机器。</li>
<li>同时ASTC看起来离普及还有段时间。</li>
<li>随着OpenGL ES 3.0机器的普及，ETC2被大部分手机支持。</li>
</ol>
<p>综上看来ECT2将会成为近期不错的选择(2018&#x2F;05&#x2F;28)</p>
<p>下图为Google给出的OpenGL ES版本占比图：<br><img src="/img/Unity/OpenGLESOccupation.png" alt="OpenGLESOccupation"></p>
<p>IOS:<br>IOS支持的纹理压缩格式不多，通常采用PVRTC。PVRTC 2bit显示效果并不好，所以一般采用PCRTC 4bit。</p>
<p>Note：</p>
<ol>
<li>Google给出的是全球收集的数据信息，并不一定完全适合国内情况。</li>
<li><a target="_blank" rel="noopener" href="http://imgtec.eetrend.com/blog/6912">PVRTC 4bit里A占比较少，半透明效果不是很好</a></li>
<li>不同的压缩算法对原始图形的宽高像素有要求<br>详情参考,下图来源<a target="_blank" rel="noopener" href="http://gad.qq.com/article/detail/25347">干货：Unity游戏开发图片纹理压缩方案</a>:<br><img src="/img/Unity/TextureFormatComparision2.png" alt="TextureFormatComparision2"></li>
</ol>
<h3 id="纹理内存大小占用"><a href="#纹理内存大小占用" class="headerlink" title="纹理内存大小占用"></a>纹理内存大小占用</h3><p>通过前面我们学习了解了什么是纹理格式以及什么是纹理压缩。</p>
<p>说了那么多，我们最终的目标其实是为了在内存和显示效果之间选择一个比较合适的折中点。</p>
<p>内存占用和显示效果主要取决于纹理压缩算法。<br>首先让我们来看看，纹理的内存大小是如何计算的？<br>Texture Size(纹理大小) &#x3D; Texture Pixel Width(宽像素数量) * Texture Pixel Height(高像素数量) * Bytes Per Pixel(每个像素数据大小)</p>
<p>假设一张1024 * 1024的R8G8B8A8纹理格式的贴图在不压缩的情况下：<br>1024 * 1024 * 4byte &#x3D; 4.0M</p>
<p>假设一张1024 * 1024的R8G8B8A8纹理格式的贴图采用ETC2 4bit压缩:<br>1024 * 1024 * 4bit &#x3D; 0.5M</p>
<p>相同的纹理贴图压缩后的内存占用明显降低，具体显示效果跟压缩算法有关，这里暂时不深入学习讨论。<br>进阶学习理解：<br><a target="_blank" rel="noopener" href="https://blog.csdn.net/bugrunner/article/details/50538770">几种主流贴图压缩算法的实现原理</a></p>
<p>这里我们结合Unity实战学习一番：<br>首先这里我准备了三张不同大小的UI图，然后复制了多份，分别设置不同的压缩格式(为了方便的比较显示不同贴图大小对于不同压缩格式时的纹理内存占用大小):<br><img src="/img/Unity/TextureCompressionSprites.png" alt="TextureCompressionSprites"></p>
<p>可以看到我准备的三张分别是128 * 256， 200 * 200和256 * 256，大小都是特地准备的，为了说明后面针对不同大小的原图设置不同压缩格式会导致最终内存纹理贴图大小占用不一样。</p>
<p>这里也贴一下UI图的导入设置:<br><img src="/img/Unity/UITextureImporterSetting.png" alt="UITextureImporterSetting"></p>
<p>通过挂在测试脚本(TextureDetailInfoDisplay.cs)，得到我们想要查看的数据：<br>TextureDetailInfoDisplay.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             TextureDetailInfoDisplay.cs</span></span><br><span class="line"><span class="comment"> * Author:                  TONYTANG</span></span><br><span class="line"><span class="comment"> * Create Date:             2018//08/02</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> UnityEngine.UI;</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> TextureDetailInfoDisplay.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 用于计算显示当前Image使用的纹理贴图格式以及所占用的内存大小等信息</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TextureDetailInfoDisplay</span> : <span class="title">MonoBehaviour</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 图片显示组件</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> Image mImgSpriteDisplay;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 显示纹理信息的文本节点</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> Text mTxtTexturueInfoDisplay;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Start</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mImgSpriteDisplay = transform.GetComponent&lt;Image&gt;();</span><br><span class="line">        mTxtTexturueInfoDisplay = transform.GetChild(<span class="number">0</span>).GetComponent&lt;Text&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mImgSpriteDisplay != <span class="literal">null</span> &amp;&amp; mImgSpriteDisplay.sprite != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> texture = mImgSpriteDisplay.sprite.texture;</span><br><span class="line">            sb.Append(<span class="string">&quot;Name: &quot;</span>);</span><br><span class="line">            sb.Append(texture.name);</span><br><span class="line">            sb.Append(Environment.NewLine);</span><br><span class="line">            sb.Append(<span class="string">&quot;Texture Size: &quot;</span>);</span><br><span class="line">            sb.Append(texture.width);</span><br><span class="line">            sb.Append(<span class="string">&quot; * &quot;</span>);</span><br><span class="line">            sb.Append(texture.height);</span><br><span class="line">            sb.Append(Environment.NewLine);</span><br><span class="line">            sb.Append(<span class="string">&quot;Format: &quot;</span>);</span><br><span class="line">            sb.Append(texture.format.ToString());</span><br><span class="line">            sb.Append(Environment.NewLine);</span><br><span class="line">            sb.Append(<span class="string">&quot;Bits Per Pixel: &quot;</span>);</span><br><span class="line">            sb.Append(TextureUtilities.GetTextureFormatBitsPerPixel(texture.format));</span><br><span class="line">            sb.Append(<span class="string">&quot; bits&quot;</span>);</span><br><span class="line">            sb.Append(Environment.NewLine);</span><br><span class="line">            sb.Append(<span class="string">&quot;Memory Size: &quot;</span>);</span><br><span class="line">            sb.Append(TextureUtilities.GetTextureMemorySize(texture));</span><br><span class="line">            sb.Append(<span class="string">&quot; KBs&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            sb.Append(<span class="string">&quot;No Image or Sprite!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mTxtTexturueInfoDisplay != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            mTxtTexturueInfoDisplay.text = sb.ToString();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>TextureUtilities.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             TextureUtilities.cs</span></span><br><span class="line"><span class="comment"> * Author:                  TONYTANG</span></span><br><span class="line"><span class="comment"> * Create Date:             2018//08/05</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> TextureUtilities.cs</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 纹理相关辅助工具</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">TextureUtilities</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 获取指定纹理图片内存占用大小</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Note:</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 这里是没有考虑mipmap的计算方法</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Texture Size = width * height * Bits Per Pixels / 8 /1024 = * KB</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;texture&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">int</span> <span class="title">GetTextureMemorySize</span>(<span class="params">Texture2D texture</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (texture != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> texture.width * texture.height * GetTextureFormatBitsPerPixel(texture.format) / <span class="number">8</span> / <span class="number">1024</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 获取指定纹理压缩格式的Bits Per Pixel(多少bit每像素)</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;textureformat&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/return&gt;</span>s</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">int</span> <span class="title">GetTextureFormatBitsPerPixel</span>(<span class="params">TextureFormat textureformat</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">switch</span>(textureformat)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">case</span> TextureFormat.ETC_RGB4:</span><br><span class="line">                <span class="keyword">return</span> <span class="number">4</span>;</span><br><span class="line">            <span class="keyword">case</span> TextureFormat.ETC2_RGB:</span><br><span class="line">            <span class="keyword">case</span> TextureFormat.ETC2_RGBA8:</span><br><span class="line">                <span class="keyword">return</span> <span class="number">8</span>;</span><br><span class="line">            <span class="keyword">case</span> TextureFormat.PVRTC_RGB4:</span><br><span class="line">            <span class="keyword">case</span> TextureFormat.PVRTC_RGBA4:</span><br><span class="line">                <span class="keyword">return</span> <span class="number">4</span>;</span><br><span class="line">            <span class="keyword">case</span> TextureFormat.ARGB4444:</span><br><span class="line">            <span class="keyword">case</span> TextureFormat.RGBA4444:</span><br><span class="line">            <span class="keyword">case</span> TextureFormat.RGB565:</span><br><span class="line">                <span class="keyword">return</span> <span class="number">16</span>;</span><br><span class="line">            <span class="keyword">case</span> TextureFormat.RGB24:</span><br><span class="line">                <span class="keyword">return</span> <span class="number">24</span>;</span><br><span class="line">            <span class="keyword">case</span> TextureFormat.RGBA32:</span><br><span class="line">            <span class="keyword">case</span> TextureFormat.ARGB32:</span><br><span class="line">                <span class="keyword">return</span> <span class="number">32</span>;</span><br><span class="line">            <span class="literal">default</span>:</span><br><span class="line">                Debug.LogErrorFormat(<span class="string">&quot;没有被包含的纹理压缩格式：&#123;0&#125;，无法返回对应BitsPerPixel信息，请自己添加。&quot;</span>, textureformat);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出结果:<br><img src="/img/Unity/TextureComppresionSizeInfoDisplay.png" alt="TextureComppresionSizeInfoDisplay"></p>
<p>从上面我们可以看出以下几个结论：</p>
<ol>
<li><p>纹理的大小主要取决于纹理压缩格式和自身宽高，纹理压缩格式所占的Bits Per Pixel越大，纹理内存占用越大。<br><img src="/img/Unity/TextureMemorySizeIncreasing.png" alt="TextureMemorySizeIncreasing"></p>
</li>
<li><p>当不满足纹理压缩格式要求时，纹理会被Unity压缩成其他纹理格式导致内存增大。<br><img src="/img/Unity/NPOT_PVRTC.png" alt="NPOT_PVRTC"><br><img src="/img/Unity/NPOT_ETC1.png" alt="NPOT_ETC1"></p>
</li>
<li><p>ETC1本来是不支持Alpha的，但Unity 5.3以后，Unity支持通过设置Compress using ETC1(split alpha channel)并设置Packing Tag来支持ETC1自动分离Alpha的实现(否则需要我们自己分离以后在代码里融合ETC1和Alpha图)。ETC1 + Alpha Split直接在预览那里看不到真实大小，所以下面我是在Profile里查看的确认的。<br><a href="/img/Unity/ETC1AlphaSplit.png">ETC1AlphaSplit</a><br>手动分离Alpha + ETC1，参考:<br><a target="_blank" rel="noopener" href="https://support.unity3d.com/hc/zh-cn/articles/207051116-%E5%A6%82%E4%BD%95%E5%9C%A8ETC1%E5%8E%8B%E7%BC%A9%E6%96%B9%E5%BC%8F%E4%B8%AD%E6%B7%BB%E5%8A%A0Alpha%E9%80%9A%E9%81%93-">如何在ETC1压缩方式中添加Alpha通道?</a></p>
</li>
<li><p>清晰度一般来说是伴随着Bit Per Pixel的增加而增加(所以一般需要在内存和清晰度之间抉择)<br>详细参考:<br><a target="_blank" rel="noopener" href="http://gad.qq.com/article/detail/10057">移动设备的纹理压缩方案</a></p>
</li>
</ol>
<p>未来更多学习：<br>待续……</p>
<p>注意要点：</p>
<ol>
<li>ETC1要求长宽都POT(Power Of Two)，且ETC1不支持Alpha。</li>
<li>PVRTC要求长宽都POT且宽高要一致。</li>
<li>ETC2支持Alpha，但需要Android 4.3以上，还要硬件GPU支持OpenGL ES3.0才行。</li>
<li>根据前面的学习，我们知道ASTC格式支持要求高(OpenGL ES3.0)且还不普及，所以这里暂时只讨论ECT1，ETC2，PVRTC，RGB，RGBA这几种格式选择。(2018&#x2F;08&#x2F;03)。</li>
<li>ASTC从IOS9(A8架构)开始支持，压缩效果相比PVRTC更好且不需要设置正方形。</li>
<li>上面主要是针对移动设备来分析，所以没有考虑PC Windows平台比如DXT等压缩格式。</li>
</ol>
<p>疑问：<br>ETC2不要求宽高Power Of Two吗？(希望知道的朋友告知一下)<br>首先我确认ETC1是要求宽高必须POT的，不然会被强制转成其他格式：<br><img src="/img/Unity/NPOT_ETC1.png" alt="NPOT_ETC1"><br>但上述测试过程中我发现ETC2即使是NPOT也没有被转成其他格式：<br><img src="/img/Unity/NPOT_ETC2.png" alt="NPOT_ETC2"><br>后来测试加上查询资料(但是是从一篇博客上看到的)得知，ETC2要求宽高是4的倍数即可，所以200*200也没有转换成其他格式：<br><img src="/img/Unity/ETC2SizeRequirement.png" alt="ETC2SizeRequirement"><br>参考:<br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/zsb517/p/6297739.html">移动端纹理压缩格式</a></p>
<h3 id="纹理总结"><a href="#纹理总结" class="headerlink" title="纹理总结"></a>纹理总结</h3><p>简单理一下Unity处理纹理，在游戏里使用的流程:<br>原图(PNG,JPG…..) –&gt; Texture2D(压缩后的纹理图片，无需CPU解压，能被GPU识别的像素格式) –&gt; 游戏内Texture2D(看硬件是否支持，不支持会被硬件转换成其他格式,比如RGBA32)</p>
<p>纹理压缩格式的选择：<br>Android:<br>ETC1(需要POT,不支持Alpha) &gt; ETC1 + Alpha Split(需要配合大于Unity 5.3的Sprite Packer使用) &gt; ETC2(需要Android 4.3且OpenGL ES3.0) &gt; RGB16 &gt; RGBA16 &gt; RGB24 &gt; RGBA32</p>
<p>IOS:<br>PVRTC(需要POT且宽高一样) &gt; RGB16 &gt; RGBA16 &gt; RGB24 &gt; RGBA32</p>
<p>未来ETC2普及了，可能普遍是设置ETC2格式。至于ASTC也是未来的一个趋势，ASTC从IOS9(A8架构)开始支持(Android也还不普及)，但压缩效果相比PVRTC更好且不需要设置正方形。。(2018&#x2F;08&#x2F;05)</p>
<p>Note：<br><a target="_blank" rel="noopener" href="http://gad.qq.com/article/detail/25347">Unity3D引擎对纹理的处理是智能的：不论你放入的是PNG，PSD还是TGA，它们都会被自动转换成Unity自己的Texture2D格式。</a></p>
<h2 id="网格"><a href="#网格" class="headerlink" title="网格"></a>网格</h2><h2 id="动画"><a href="#动画" class="headerlink" title="动画"></a>动画</h2><h2 id="材质"><a href="#材质" class="headerlink" title="材质"></a>材质</h2><h2 id="特效"><a href="#特效" class="headerlink" title="特效"></a>特效</h2><h2 id="Shader"><a href="#Shader" class="headerlink" title="Shader"></a>Shader</h2><p>这一小节主要是针对Shader的变体打包相关知识进行学习，之前打包Shader的AB都是简单的全部标打包到一个AB里，所以没有关注Shader细节方面的优化问题。</p>
<p>这一小节通过学习Shader变体相关知识，来优化Shader打包和加载方面的问题。</p>
<p>还是先从What，Why，How三个方面来循序渐进</p>
<ol>
<li><p>什么是Shader？</p>
<p>结合以前学习OpenGL和Unity Shader，Shader在我的理解里就是GPU(从以前的固定管线到现在的可编程管线)处理图形图像相关数据(定点，像素，纹理等)的程序。</p>
</li>
<li><p>为什么需要Shader？</p>
<p>结合模型和纹理数据等，我们可以通过Shader程序去实现更多更酷炫的效果，而不是简单的模型纹理展示。而图形图像的处理上，正式GPU的特长，也就是为什么引入Shader程序的原因。</p>
</li>
<li><p>Shader是如何被程序加载使用的？</p>
<p>真正被真机使用的Shader还需要通过加载，解析，编译三个过程。以Shader被我们打包成AB为例。加载是指我们把Shader AB加载进内存。解析是指我们读取分析我们的Shader代码。编译是指将Shader代码编译成GPU特定的格式(而这一步是最耗时的，也是后面我们优化的关键部分)。加载解析编译完成后Shader才被真正的作用于我们的游戏里。</p>
</li>
<li><p>如何优化Shader打包加载？</p>
<p>这个问题是本小节的重点，得出这个问题答案之前，我们需要了解其他相关知识</p>
</li>
</ol>
<h3 id="Shader预加载"><a href="#Shader预加载" class="headerlink" title="Shader预加载"></a>Shader预加载</h3><p>老版本的时候我们通过加载所有Shader后调用Shader.WarmupAllShaders()来触发所有Shader变体的预加载编译，从而避免运行时Shader的解析卡顿开销。</p>
<p>但随着项目越来越大，使用的Shader越来越多，变体数也越来越多，粗暴的全部预加载编译变得不合适了，这也正是我们需要搜集需要用到的变体按需预编译加载变体的原因。</p>
<h4 id="变体"><a href="#变体" class="headerlink" title="变体"></a>变体</h4><p>什么是Shader变体(Shader Variants)？</p>
<p><a target="_blank" rel="noopener" href="https://blog.uwa4d.com/archives/USparkle_Shadervariant.html">In Unity,  many shaders internally have multiple “variants”, to account for different light modes, lightmaps, shadows and so on. These variants are indentified by a shader pass type, and a set of shader keywords. </a></p>
<p>从上面的介绍可以看出Shader变体是因为Shader宏，渲染状态等原因造成需要编译出多种不同的Shader代码，不同效果要想起作用都必须被打包进游戏里，不然就会出现Shader失效(实际为变体丢失)。</p>
<p>Shader里面的宏主要是通过multi_compile和shader_feature来定义。</p>
<p>PassType主要是跟光照渲染管线相关，详情参考:</p>
<p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/ScriptReference/Rendering.PassType.html">PassType</a></p>
<p>详细的区别参考:</p>
<p><a target="_blank" rel="noopener" href="https://blog.uwa4d.com/archives/USparkle_Shadervariant.html">一种Shader变体收集和打包编译优化的思路</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/68888831">Shader变体收集与打包</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/SL-MultipleProgramVariants.html">Making multiple shader program variants</a></p>
<p>对于预编译宏来说，这里我们主要要知道multi_compile会默认生成所有的变体(导致变体数激增)，而shader_feature要如何生成变体需要我们自定义(这里就引出了官方的ShaderVaraintCollection，用于控制自定义的Shader变体打包以及预加载编译等问题)</p>
<p>查看单个Shader的变体数量?</p>
<p><img src="/img/Unity/AssetBundle-Framework/ShaderVaraintNumber.png" alt="ShaderVaraintNumber"></p>
<p>查看材质用到哪些变体？</p>
<p>我们可以在编辑器模式下把材质设置成Debug模式查看使用的变体</p>
<p><img src="/img/Unity/AssetBundle-Framework/MaterialDebugInspector.png" alt="MaterialDebugInspector"></p>
<h4 id="变体搜集"><a href="#变体搜集" class="headerlink" title="变体搜集"></a>变体搜集</h4><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/OptimizingShaderLoadTime.html">ShaderVariantCollection is an asset that is basically a list of Shaders<br>, and for each of them, a list of Pass types and shader keyword combinations to load. </a></p>
<p>通过介绍，可以看出ShaderVariantCollection是一种Asset资源，这个资源记录了我们需要包含的Shader变体相关数据。</p>
<p>Edit -&gt; Project Settings -&gt; Graphics</p>
<p><img src="/img/Unity/AssetBundle-Framework/ShaderVariantAssetInspector.png" alt="ShaderVariantAssetInspector"></p>
<p>从ShaderVariantsCollection资源Asset里可以看到，里面列举了我们自定义包含的Shader变体信息。</p>
<p>通过ShaderVariantsCollection我们可以手动打开指定Shader的变体添加操作面板:</p>
<p><img src="/img/Unity/AssetBundle-Framework/ShaderVariantsChoiceDetail.png" alt="ShaderVariantsChoiceDetail"></p>
<p>从上面可以看到默认创建的ShaderVariantsCollection里的Rim Lit Bumped Specular只包含了两个变体:</p>
<p><img src="/img/Unity/AssetBundle-Framework/ShaderCustomVaraints.png" alt="ShaderCustomVaraints"></p>
<p>这里就引出了一个疑问，为什么不是前面单个Shader下显示的52个变体了？</p>
<p>这里猜测是因为Unity默认创建的ShaderVariantsCollection是经过裁剪优化的。</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://gameinstitute.qq.com/community/detail/118869">个别着色器特性，比如使用 #pragma shader_feature的着色器，如果没有材质使用到了这个特性，那么就不会把它打包进去；</a></li>
<li><a target="_blank" rel="noopener" href="https://gameinstitute.qq.com/community/detail/118869">没有被任何场景使用到的雾效(Fog)或光照贴图模式(Lightmap)的着色器变体，也不会打包进去</a></li>
</ul>
<p><strong>既然Unity会自动分析哪些变体用到了才打进ShaderVariantsCollection里，那为什么我们还是会出现打包后变体丢失了？</strong></p>
<p>前面提到了shader_feature定义的变体需要自定义是否参与打包，如果没有显示的使用，Unity自带的ShaderVariantsCollection也不会把它打包进去。</p>
<p>同时参考这篇文章:<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/68888831">Shader变体收集与打包</a></p>
<p>可以得知Shader的宏是支持控制的(e.g. Material.EnableKeyword() Shader.EnableKeyword()……)，这样一来Unity的静态分析就没有办法正确得出结论了，我想这就是为什么我们需要自行分析需要打包的变体的原因(shader_feature+宏动态控制)。</p>
<h4 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h4><p>参考这篇文章:<a target="_blank" rel="noopener" href="https://blog.csdn.net/RandomXM/article/details/88642534">对Shader Variant的研究(概念介绍、生成方式、打包策略) </a></p>
<p>Shader的搜集策略有点复杂，本人并没有完全看明白，只是结合自定义Shader和材质理解了一下Shader宏和PassType对Shader变体的影响。测试了<a target="_blank" rel="noopener" href="https://github.com/yimengfan/BDFramework.Core">BDFramework</a>里现成的Shader变体收集方案，发现跟Unity自带搜集的变体差异比较大。</p>
<p>这里只放几张简单的测试图来对比自定义Shader宏+PassType在Unity Shader变体搜集功能下和自定义的Shader变体搜集的结果。</p>
<p>自定义Shader和材质:</p>
<p><img src="/img/Unity/AssetBundle-Framework/DIYShaderList.png" alt="DIYShaderList"></p>
<p><img src="/img/Unity/AssetBundle-Framework/DIYMaterialList.png" alt="DIYMaterialList"></p>
<p>Unity自带变体搜集:</p>
<p><img src="/img/Unity/AssetBundle-Framework/UnityShaderVariantsCollection.png" alt="UnityShaderVariantsCollection"></p>
<p>自定义变体搜集:</p>
<p><img src="/img/Unity/AssetBundle-Framework/CustomShaderVariantsCollection.png" alt="CustomShaderVariantsCollection"></p>
<p>最后还是打算采用UWA上的一个方案：<a target="_blank" rel="noopener" href="https://blog.uwa4d.com/archives/USparkle_Shadervariant.html">一种Shader变体收集和打包编译优化的思路</a></p>
<p><strong>针对UWA方案还有一个疑问就是，单纯的把所有用到的材质渲染一次，能保证那些动态切换(e.g. Material.EnableKeyword() Shader.EnableKeyword())的变体被搜集到吗？毕竟Unity的ShaderVariantsCollection有裁剪策略，忘知道的朋友告知</strong></p>
<p>接下来主要是结合Profiler来查看ShaderVariantsCollection对于预编译带来的实际用处：</p>
<p>先看一下自定义搜集到的ShaderVariantsCollection变体文件信息:</p>
<p><img src="/img/Unity/AssetBundle-Framework/ShaderVariantsCollectionAsset.png" alt="ShaderVariantsCollectionAsset"></p>
<p>只加载Shader不预编译(指LoadAllAsset<Shader>)然后加载实体对象：</p>
<p><img src="/img/Unity/AssetBundle-Framework/PreloadAllShaderNoWarmUp.png" alt="PreloadAllShaderNoWarmUp"></p>
<p><img src="/img/Unity/AssetBundle-Framework/LoadActorWithoughtWarmUp.png" alt="LoadActorWithoughtWarmUp"></p>
<p><strong>从上面可以看到加载Shader但不WarmUp，等到加载实体对象时还是会触发Shader编译（CreateGPUProgram）</strong></p>
<p>不加载Shader直接预编译之后加载实体对象:</p>
<p><img src="/img/Unity/AssetBundle-Framework/WarmUpShaderWithoughtLoadShader.png" alt="WarmUpShaderWithoughtLoadShader"></p>
<p><img src="/img/Unity/AssetBundle-Framework/LoadActorAfterWarmUpShader.png" alt="LoadActorAfterWarmUpShader"></p>
<p><strong>从上面可以看出WarmUp会直接触发所有ShaderVariantsCollection里相关的Shader的预编译，等到加载实体对象时不会再有Shader编译开销(CreateGPUProgram)</strong></p>
<p>Shader变体搜集工具:</p>
<p><img src="/img/Unity/AssetBundle-Framework/ShaderVariantsCollection.png" alt="ShaderVariantsCollection"> </p>
<p>详细代码:</p>
<p><a target="_blank" rel="noopener" href="https://github.com/TonyTang1990/AssetBundleLoadManager">AssetBundleLoadManager</a></p>
<p>Tools-&gt;Assets-&gt;Asset相关处理工具</p>
<p>TODO:</p>
<p>现阶段只实现自动收集那一步，UsePass问题看起来比较复杂，暂时不考虑。具体请参考:<a target="_blank" rel="noopener" href="https://blog.uwa4d.com/archives/USparkle_Shadervariant.html">一种Shader变体收集和打包编译优化的思路</a></p>
<h3 id="Shader总结"><a href="#Shader总结" class="headerlink" title="Shader总结"></a>Shader总结</h3><ol>
<li>为了避免内置Shader带来的一些不必要问题(打包加载等问题)，建议直接把内置Shader导入到项目工程使用。</li>
<li>移动端尽量避免使用Standard Shader使用Mobile Shader替代，Standard Shader过于笨重以及变体数量庞大。</li>
<li>ShaderVariantsCollection和Shader打包到一起，一开始就加载并调用ShaderVariantsCollect:WarmUp()触发变体预编译，减少使用到Shader时实时编译的卡顿问题，触发预编译之后再加载剩余Shader Asset确保Shader都加载进来即可。</li>
<li>Shader的变体数量主要和Shader宏(multi_compile和shader_feature以及PassType有关)，multi_compile会默认生成所有相关变体，尽量使用shader_feature来实现自定义宏功能。</li>
<li>ShaderVariantsCollection主要解决的是shader_feature的变体搜集预加载问题。</li>
</ol>
<h1 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h1><h2 id="Unity-Conception-Part"><a href="#Unity-Conception-Part" class="headerlink" title="Unity Conception Part"></a>Unity Conception Part</h2><p><a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/temas/best-practices/assets-objects-and-serialization#InterObject_References">Assets, Objects and serialization</a><br><a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/topics/best-practices/guide-assetbundles-and-resources?playlist=30089">A guide to AssetBundles and Resources</a><br><a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/temas/best-practices/resources-folder">The Resources folder</a><br><a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/topics/best-practices/assetbundle-fundamentals?playlist=30089">AssetBundle fundamentals</a><br><a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/temas/best-practices/assetbundle-usage-patterns#Managing_Loaded_Assets">AssetBundle usage patterns</a></p>
<h2 id="AssetBundle-Part"><a href="#AssetBundle-Part" class="headerlink" title="AssetBundle Part"></a>AssetBundle Part</h2><p><a target="_blank" rel="noopener" href="http://liweizhaolili.blog.163.com/blog/static/162307442015282017852/">Unity5的AssetBundle的一点使用心得</a><br><a target="_blank" rel="noopener" href="http://gad.qq.com/article/detail/16006">Unity3D中Assetbundle技术使用心得</a><br><a target="_blank" rel="noopener" href="https://blog.uwa4d.com/archives/QA_ResourceManagement.html">关于Unity中的资源管理，你可能遇到这些问题</a><br><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/AssetWorkflow.html">Asset Workflow</a><br><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/BehindtheScenes.html">Behind the Scenes</a><br><a target="_blank" rel="noopener" href="http://blog.csdn.net/ring0hx/article/details/46376709">Unity5 如何做资源管理和增量更新</a><br><a target="_blank" rel="noopener" href="http://www.xuanyusong.com/archives/3618">Unity3D研究院之提取游戏资源的三个工具支持Unity5</a><br><a target="_blank" rel="noopener" href="http://www.xuanyusong.com/archives/2373">Unity3D研究院之Assetbundle的原理（六十一）</a><br><a target="_blank" rel="noopener" href="http://www.xuanyusong.com/archives/2405">Unity3D研究院之Assetbundle的实战（六十三）</a></p>
<h2 id="Texture-Compression-Part"><a href="#Texture-Compression-Part" class="headerlink" title="Texture Compression Part"></a>Texture Compression Part</h2><p><a target="_blank" rel="noopener" href="http://gad.qq.com/article/detail/25347">干货：Unity游戏开发图片纹理压缩方案</a><br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/luming1979/archive/2013/02/04/2891421.html">各种移动GPU压缩纹理的使用方法</a><br><a target="_blank" rel="noopener" href="http://imgtec.eetrend.com/blog/6912">移动设备的纹理压缩方案</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/bugrunner/article/details/50538770">几种主流贴图压缩算法的实现原理</a><br><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Adreno">Adreno</a><br><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Mali_(GPU)">Mali (GPU)</a><br><a target="_blank" rel="noopener" href="https://www.qualcomm.cn/snapdragon/gpu-specifications">Qualcomm GPU规格</a><br><a target="_blank" rel="noopener" href="https://developer.apple.com/library/archive/documentation/DeviceInformation/Reference/iOSDeviceCompatibility/HardwareGPUInformation/HardwareGPUInformation.html">IOS device Graphics Processors</a><br><a target="_blank" rel="noopener" href="https://answer.uwa4d.com/question/5ae714b00956834900752685">如何判断硬件支持GpuInstance</a><br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/zsb517/p/6297739.html">移动端纹理压缩格式</a><br><a target="_blank" rel="noopener" href="https://support.unity3d.com/hc/zh-cn/articles/207051116-%E5%A6%82%E4%BD%95%E5%9C%A8ETC1%E5%8E%8B%E7%BC%A9%E6%96%B9%E5%BC%8F%E4%B8%AD%E6%B7%BB%E5%8A%A0Alpha%E9%80%9A%E9%81%93-">如何在ETC1压缩方式中添加Alpha通道?</a></p>
<h2 id="Shadere-Part"><a href="#Shadere-Part" class="headerlink" title="Shadere Part"></a>Shadere Part</h2><p><a target="_blank" rel="noopener" href="https://www.duanyiliang.com/2018/11/21/unity/shader_load_performace/">Unity Shader加载性能消耗问题</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/e295166319/article/details/60141478">Unity3D Shader加载时机和预编译</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/68888831">Shader变体收集与打包</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/OptimizingShaderLoadTime.html">Optimizing Shader Load Time</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/SL-MultipleProgramVariants.html">Making multiple shader program variants</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.uwa4d.com/archives/USparkle_Shadervariant.html">一种Shader变体收集和打包编译优化的思路</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/RandomXM/article/details/88642534">对Shader Variant的研究(概念介绍、生成方式、打包策略) </a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/yimengfan/BDFramework.Core">BDFramework</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Resource/">Resource</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Resource/">Resource</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/08/21/经典2D小游戏/" title="经典2D小游戏" itemprop="url">经典2D小游戏</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Tony Tang" target="_blank" itemprop="author">Tony Tang</a>
		
  <p class="article-time">
    <time datetime="2016-08-21T06:50:28.000Z" itemprop="datePublished"> 发表于 2016-08-21</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>这一章节主要是为了实战学习Unity和NGUI的使用而写的。</p>
<h2 id="Game-Introduction"><a href="#Game-Introduction" class="headerlink" title="Game Introduction"></a>Game Introduction</h2><p>开发环境：<br>游戏引擎：Unity<br>UI插件：NGUI 2.7</p>
<p>游戏内容：<br>容纳多个经典2D红白机和手机游戏：</p>
<ol>
<li>2D赛车躲避(原始名字想不起来了)</li>
<li>贪吃蛇</li>
<li>坦克大战<br>待添加</li>
</ol>
<p>平台：<br>支持Android，IOS多设备。</p>
<h2 id="Preparation"><a href="#Preparation" class="headerlink" title="Preparation"></a>Preparation</h2><p>关于IOS打包准备工作参见:<br><a href="http://tonytang1990.github.io/2017/04/29/Unity%E8%87%AA%E5%8A%A8%E5%8C%96&IOS%E8%87%AA%E5%8A%A8%E5%8C%96%E7%AD%BE%E5%8C%85/#IOS%E6%89%93%E5%8C%85%E5%87%86%E5%A4%87">IOS打包准备</a></p>
<h3 id="Unity-IOS-build-process"><a href="#Unity-IOS-build-process" class="headerlink" title="Unity IOS build process"></a>Unity IOS build process</h3><ol>
<li>XCode project is generated by Unity with all the required libraries, precompiled .NET code and serialized assets.(打包所有需要的库和资源生成XCode项目)<br>第一步是通过Unity的Building Settings设定IOS平台点击Build生成</li>
<li>XCode project is built by XCode and deployed and run on the actual device.(编译Xcode项目安装到设备上)<br>第二部必须在Mac上执行(或者黑苹果)，因为需要用到IOS SDK和XCode编译器</li>
</ol>
<h3 id="Cloud-Build"><a href="#Cloud-Build" class="headerlink" title="Cloud Build"></a>Cloud Build</h3><p>关于Cloud Build让我们直接看看官网的介绍吧：<br>What is Unity Cloud Build?<br>A service that automates the build pipeline for Unity games.(自动化编译打包服务 – Build Machine)</p>
<p>Why Should I Use Cloud Build?<br>By using Cloud Build automation services, you will - Save Time. Builds are compiled and distributed automatically, minimizing manual work and intervention. Games with multiple platforms can be consolidated into a single build process.</p>
<ul>
<li>Improve Quality. Games are built continuously as changes are detected (“Continuous Integration”), enabling detection of issues as they are introduced to the project. - Distribute Faster. Cloud-based infrastructure compiles builds; in parallel if for multi platform projects. Completed builds are available to download by anyone on the team through Cloud Build’s website.(快捷方便，自动化检测变化进行编译打包。每个人都可以自己去下载安装对应的版本)</li>
</ul>
<p>How does Unity Cloud Build work?<br>Unity Cloud Build monitors your source control repository (e.g. Git, Subversion, Mercurial, Perforce). When a change is detected, a build is automatically generated by Cloud Build. When the build is completed, you and your team are notified via email. Your build is hosted by Unity for you and your team mates. If the build is not successful, you’re also notified and provided with logs to begin troubleshooting.(通过检测Git等工具上传变化，自动触发编译打包流程，完成或出错的时候有邮件提醒和log)</p>
<p>What do I need to use Unity Cloud Build?<br>使用Unity Cloud Build我们必须先选择一个版本管理器<br>Git, Subversion, Mercurial, Perforce<br>这里我使用Git。</p>
<ol>
<li>github上创建Repository</li>
<li>Clone到本地目录(git clone repo)</li>
<li>上传XCode项目<br>创建Cloud Build Project:<br><a target="_blank" rel="noopener" href="https://build.cloud.unity3d.com/">Unity Cloud Build</a></li>
<li>Create New Project</li>
<li>添加Git repository地址</li>
<li>选择platform(这里我选的IOS)</li>
<li>最后设置项目打包发布相关的Certificate，bundle ID， Xcode版本设置等(注意Provision Profile里的Certificate和我们导出上传的Certificate要一致)，后续还有一堆关于Build的控制(比如定义宏，编译Development版本)<br>这样一来就可以通过访问<a target="_blank" rel="noopener" href="https://build.cloud.unity3d.com/">Unity Cloud Build</a>去查看自动化打包编译的详细情况了。<br><img src="/img/Unity/UnityCloudBuild.PNG" alt="UnityCloudBuild"><br>这样一来每一次提交Git后只需在Cloud Build点击build就会触发更新编译打包了。<br>如果打包没有错误的话，我们只需去Cloud Buid上取打包好的包安装即可。</li>
</ol>
<h3 id="UI库选择"><a href="#UI库选择" class="headerlink" title="UI库选择"></a>UI库选择</h3><p>在Unity 4.6以后UI主要是有两种选择：</p>
<ol>
<li>UGUI(Unity 自带UI)</li>
<li>NGUI(成熟的第三方UI插件)<br>这里处于学习NGUI目的，我选择采用NGUI 2.7版本作为UI库。</li>
</ol>
<h2 id="游戏实战开发"><a href="#游戏实战开发" class="headerlink" title="游戏实战开发"></a>游戏实战开发</h2><h3 id="赛车躲避"><a href="#赛车躲避" class="headerlink" title="赛车躲避"></a>赛车躲避</h3><h4 id="游戏说明"><a href="#游戏说明" class="headerlink" title="游戏说明"></a>游戏说明</h4><p>这是一款在2D竖版的赛车躲避类游戏，场景里有三条道可供行驶，玩家操控当前赛车(上下左右移动以及跳跃来躲避迎面而来的赛车)来回在三条道之间切换以躲避随机从三条道上出现的赛车，每躲过一个赛车就会增加得分，赛车移动游戏速度会随着游戏的进行越来越快已达到更快速度，最终躲避最多赛车得分最高者创造新纪录。</p>
<p>操控：<br>上下左右移动，圆形按钮跳跃(通过单独制作的控制面板，通过点击对应按钮响应)</p>
<h4 id="相关概念学习"><a href="#相关概念学习" class="headerlink" title="相关概念学习"></a>相关概念学习</h4><p>首先作为2D游戏，这里要讲一下Project 2D Mode和Editor 2D Mode这两个概念。<br>Project 2D Mode：<br>Project 2D Mode会去决定Unity Editor的一些设置。<br><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/2DAnd3DModeSettings.html">Unity Editor Settings influence by mode settings</a><br>下列以官网将的2D Mode为例，看看分别会影响些什么？</p>
<ol>
<li>Any images you import are assumed to be 2D images (Sprites) and set to Sprite mode.(2D模式下默认导入的图片都是2D Sprite而不是Texture)</li>
<li>The Sprite Packer is enabled.(Sprite Packer默认开启，Sprite Packager是为了高效的渲染并节约内存，用于打包图集(Atlas)的工具)</li>
<li>The Scene View is set to 2D.(默认设置Scene view为2D mode，当然也可以切到Scene 3D mode)</li>
<li>The default game objects do not have real time, directional light.(默认不创建方向光)</li>
<li>The camera’s default position is at 0,0,–10. (It is 0,1,–10 in 3D Mode.)(Camera默认位置0,0,-10)</li>
<li>The camera is set to be Orthographic. (In 3D Mode it is Perspective.)(Camera默认是Orthographic(正交)投影)</li>
<li>Skybox is disabled for new scenes.(天空盒默认disable)</li>
<li>Ambient Source is set to Color. (With the color set as a dark grey: RGB: 54, 58, 66.)(环境光默认设置为54,58,66)</li>
<li>Precomputed Realtime GI is set to off.(预计算的全局光默认关闭)</li>
<li>Baked GI is set to off.(烘焙全局观默认关闭)</li>
<li>Lighting Auto-Building set to off.(光照的自动编译默认关闭)<br>Editor 2D Mode：<br>Editor 2D Mode只是决定了Scene窗口是以2D还是3D的形式显示。<br>从上面可以看出Project的2D Mode会帮助我们设置一些对于2D游戏不需要或重要的设定，帮助我们快速开发2D游戏。</li>
</ol>
<p>在2D游戏里，有个很重要的概念就是Sprite：<br>Sprite – Sprites are 2D Graphic objects.<br>提到Sprite就不得不提Sprite制作，优化相关的工具和一些相关的重要概念：</p>
<ol>
<li>Sprite Editor<br>主要用于指明Sprite的一些重要属性，比如：<br>Texture Type – 指明纹理类型(Sprite 2D)<br>Sprite Mode – 指明这个Sprite是单独显示还是和其他Sprite一起显示(有利于Texture Packer去做图集的切割)<br>Packing Tag – 指明Sprite所在图集<br>…….</li>
<li>Sprite Creator<br>Unity提供的创建临时的sprite placeholder.(后期替换成我们想要的Sprite)<br>也可以帮助我们去切割包含多个Sprite的图片到多个单独的Sprite(前提是包含多个Sprite的图片Sprite Mode要设置成Multiple。通过设置Slice或者Grid方式，可以快速帮助我们切割包含多个图片的Sprite)<br><img src="/img/Unity/SpriteEditor.PNG" alt="SpriteEditor"></li>
<li>Sprite Packer<br>Unity提供的自动制作图集(Atlas)的工具，为了节约内存高效渲染，把多个Sprite打包到一个大的纹理图片里，然后通过记录对应的UV信息去访问，这样只需加载一张纹理图片就能去渲染多个Sprite。<br>Edit -&gt; Project Settings -&gt; Editor -&gt; Sprite Packer Mode</li>
<li>Sprite Renderer<br>这里需要区别一下Sprite Renderer和Mesh Renderer。<br>Sprite Renderer是以2D Sprite作为输入通过Color，Material等属性去渲染出最终颜色。(默认的Sprite-Default Material是不计算光照的，因为2D游戏一般不考虑光照，当然我们也可用其他的Material去计算光照的影响)<br>Mesh Renderer是以geometry from the Mesh Filter(模型数据)作为输入通过Material和光照方面的设置渲染出最终颜色。<br>Sprite Renderer里值得一提的是Layer，因为2D游戏里没有深度的概念，所以通过Layer和Layer Order去决定Sprite的渲染顺序，同时Layer属性也被Camera和Ray Cast用作过滤的条件之一。(我们可以自定义Layer且设定Layer所处顺序(Edit -&gt; Project Setting -&gt; Tags and Layers)，然后通过设定Sprite在Layer里的Layer Order去决定在同一Layer里的顺序)<br><img src="/img/Unity/TagsAndLayers.PNG" alt="TagsAndLayers"></li>
</ol>
<h4 id="游戏制作过程"><a href="#游戏制作过程" class="headerlink" title="游戏制作过程"></a>游戏制作过程</h4><h5 id="Project-Mode选择"><a href="#Project-Mode选择" class="headerlink" title="Project Mode选择"></a>Project Mode选择</h5><p>通过上面概念学习，我们知道了设置Project Mode 2D会帮助我们快速开发2D游戏，所以这里我们选择2D Mode。<br>Edit-&gt;Project Settings-&gt;Editor-&gt;Default Behavior Mode -&gt; 2D<br>然后再创建我们的CarDodge Scene:<br>File -&gt; New Scene</p>
<h5 id="美术图片分辨率选择"><a href="#美术图片分辨率选择" class="headerlink" title="美术图片分辨率选择"></a>美术图片分辨率选择</h5><p>每个游戏制作都需要指定美术图片大小标准。<br>考虑到不同屏幕分辨率适应的问题，结合<a href="http://tonytang1990.github.io/2015/07/15/Unity-Study/#IL2CPP">Unity Study里NGUI 2.7屏幕自适应的学习</a>，我选择了1024*768也就是4:3的比例作为标准，这样一来在高分辨率的机器上(大部分主流机器都高于4:3)，只是两边会多显示一部分而不至于背景或游戏场景被裁减，多出来的一部分我们可以把背景放大来覆盖。(作为2D竖版游戏这样是完全可以接受的)<br>为了使我们的Sprite的像素完美显示在屏幕上(1个Sprite像素对应屏幕的一个pixel)，要做到这一点我们只需保证Screen.height&#x2F;2&#x2F;Size &#x3D; PPU(Pixel Per Unit)即可，所以因为我们设定Sprite的100 Pixel对应一个Unit，Size &#x3D; 768&#x2F;2&#x2F;100 &#x3D; 3.84，所以我们把Orthographic Camera的Size设置为3.84，这样一来Sprite的像素就和屏幕意义对应了。</p>
<h5 id="游戏背景循环移动实现方式选择"><a href="#游戏背景循环移动实现方式选择" class="headerlink" title="游戏背景循环移动实现方式选择"></a>游戏背景循环移动实现方式选择</h5><p>通过官网<a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/topics/2d-game-creation/2d-scrolling-backgrounds?playlist=17093">2D Scrolling Backgrounds</a>的学习，了解到有下列两种方式可以实现背景循环移动。</p>
<ol>
<li>用一张Sprite作为背景，通过动态计算(循环)transform.position的值去实现背景移动。<br>这种方式的缺点是多分辨率适应问题，且当我们循环的时候，Sprite明显衔接不对，出现画面跳动。</li>
<li>设置3D Quad，添加Material去控制显示，通过动态控制(循环texture offset)Texture的显示实现背景移动。<br>这种方式的好处是可以通过Tile Texture和设置Offset实现不拉伸背景实现铺满屏幕的效果。<br>第一种方式游戏体验明显不行，所以这里我们采取第二种方式实现背景循环滚动。(这里使用的是Texture而非Sprite)<br>OffsetScroller.cs</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">OffsetScroller</span> : <span class="title">MonoBehaviour</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">float</span> mScrollSpeed = <span class="number">0.2f</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Vector2 mStartOffset;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> MeshRenderer mBackgroundMeshRender;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Awake</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mBackgroundMeshRender = gameObject.GetComponent&lt;MeshRenderer&gt;();</span><br><span class="line">        <span class="keyword">if</span>(mBackgroundMeshRender != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            mStartOffset = mBackgroundMeshRender.material.mainTextureOffset;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Update is called once per frame</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Update</span> ()</span> &#123;</span><br><span class="line">        <span class="built_in">float</span> y = Mathf.Repeat(Time.time * mScrollSpeed, <span class="number">1</span>);</span><br><span class="line">        Vector2 offset = <span class="keyword">new</span> Vector2(<span class="number">0.0f</span>, y);</span><br><span class="line">        <span class="keyword">if</span>(mBackgroundMeshRender != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            mBackgroundMeshRender.material.mainTextureOffset = offset;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            Debug.Log(<span class="string">&quot;This script only works with Gameobject that contains MeshRenderer and Material.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">OnDisable</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(mBackgroundMeshRender != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            mBackgroundMeshRender.material.mainTextureOffset = mStartOffset;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/img/Unity/OffsetScrollBackground.PNG" alt="OffsetScrollBackground"><br>上述代码实现了通过根据时间和设定的速度来调整Background Material的Offset值实现背景循环滚动效果。</p>
<h5 id="游戏控制方式选择"><a href="#游戏控制方式选择" class="headerlink" title="游戏控制方式选择"></a>游戏控制方式选择</h5><p>Assets Store有一些付费的成熟控制插件，但考虑到控制上没太大的需求(上下左右和个别按钮即可)，这里选择自己制作。(提供上下左右和一个单独的按钮交互界面)<br><img src="/img/Unity/InputPanelHierachy.PNG" alt="InputPanelHierachy"><br><img src="/img/Unity/InputPanelUI.PNG" alt="InputPanelUI"><br>我在Panel上挂载了UIAnchor和InputControlerManager脚本，前者用于在场景里设置位置，后者是我自己写来用于通过单一接口去传递相应回调。<br>InputControllerManager.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">InputControllerManager</span> : <span class="title">MonoBehaviour</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> InputControllerManager mInputControllerManager = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> GameObject mControlButton;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> GameObject mLeftButton;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> GameObject mRightButton;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> GameObject mUpButton;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> GameObject mDownButton;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> UIEventListener mControlButtonUIEL;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> UIEventListener mLeftButtonUIEL;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> UIEventListener mRightButtonUIEL;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> UIEventListener mUpButtonUIEL;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> UIEventListener mDownButtonUIEL;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">InputControllerManager</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Awake</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(mInputControllerManager == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            mInputControllerManager = <span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (mInputControllerManager != <span class="keyword">this</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Destroy(mInputControllerManager);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Start</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (mControlButton != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            mControlButtonUIEL = mControlButton.GetComponent&lt;UIEventListener&gt;();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mLeftButton != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            mLeftButtonUIEL = mLeftButton.GetComponent&lt;UIEventListener&gt;();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mRightButton != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            mRightButtonUIEL = mRightButton.GetComponent&lt;UIEventListener&gt;();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mUpButton != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            mUpButtonUIEL = mUpButton.GetComponent&lt;UIEventListener&gt;();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mDownButton != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            mDownButtonUIEL = mDownButton.GetComponent&lt;UIEventListener&gt;();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ControlButtonClickDelegate</span>(<span class="params">UIEventListener.VoidDelegate oncontrolbuttonclick</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (mControlButtonUIEL != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            mControlButtonUIEL.onClick = oncontrolbuttonclick;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ControlButtonOnPressDelegat</span>(<span class="params">UIEventListener.BoolDelegate oncontrolbuttononpress</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (mControlButtonUIEL != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            mControlButtonUIEL.onPress = oncontrolbuttononpress;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">LeftButtonClickDelegate</span>(<span class="params">UIEventListener.VoidDelegate onleftbuttonclick</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (mLeftButtonUIEL != <span class="literal">null</span>)</span><br><span class="line">        &#123; </span><br><span class="line">            mLeftButtonUIEL.onClick = onleftbuttonclick;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">LeftButtonOnPressDelegat</span>(<span class="params">UIEventListener.BoolDelegate onleftbuttononpress</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(mLeftButtonUIEL != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            mLeftButtonUIEL.onPress = onleftbuttononpress;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">RightButtonClickDelegate</span>(<span class="params">UIEventListener.VoidDelegate onrightbuttonclick</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(mRightButtonUIEL != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            mRightButtonUIEL.onClick = onrightbuttonclick;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">RightButtonOnPressDelegat</span>(<span class="params">UIEventListener.BoolDelegate onrightbuttononpress</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (mRightButtonUIEL != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            mRightButtonUIEL.onPress = onrightbuttononpress;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">UpButtonClickDelegate</span>(<span class="params">UIEventListener.VoidDelegate onupbuttonclick</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(mUpButtonUIEL != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            mUpButtonUIEL.onClick = onupbuttonclick;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">UpButtonOnPressDelegat</span>(<span class="params">UIEventListener.BoolDelegate onupbuttononpress</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (mUpButtonUIEL != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            mUpButtonUIEL.onPress = onupbuttononpress;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">DownButtonClickDelegate</span>(<span class="params">UIEventListener.VoidDelegate ondownbuttonclick</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(mDownButtonUIEL != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            mDownButtonUIEL.onClick = ondownbuttonclick;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">DownButtonOnPressDelegat</span>(<span class="params">UIEventListener.BoolDelegate ondownbuttononpress</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (mDownButtonUIEL != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            mDownButtonUIEL.onPress = ondownbuttononpress;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后把做好的InputPanel作为Prefab存起来。上述代码只提供了按钮的OnClick和OnPress回调设置。<br>当前游戏界面如下：<br><img src="/img/Unity/InputControlWithScrollBackground.PNG" alt="InputControlWithScrollBackground"><br>游戏完成时只会有三条道会显示，但玩家需要移动8次来实现从最左边移动到最右边，这里显示九条是为了方便确认位置。</p>
<h5 id="可视化重要信息"><a href="#可视化重要信息" class="headerlink" title="可视化重要信息"></a>可视化重要信息</h5><p>这里主要是为了可视化的看出我们在制作游戏的过程中是否用了一些导致性能或内存消耗很高的方法。<br>关于性能消耗：<br>我们采用在<a href="http://tonytang1990.github.io/2016/03/13/Unity-COC-Study/#Optimization">Unity_COC_Study</a>里打印FPS的方式来可视化。<br>关于内存消耗：<br>之前使用过Memroy Profiler，很直观的显示了各方面的内存消耗和运行时间，性能消耗也能在这里看的一清二楚。<br>这里为了不每次都链接电脑开Memory Profiler，我采用打印FPS的方式查看性能上的消耗。<br>FPSDisplay.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> UnityEngine.UI;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">FPSDisplay</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> UILabel mFPSText;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="built_in">float</span> mDeltaTime = <span class="number">0.0f</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="built_in">float</span> mFPS = <span class="number">0.0f</span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Update</span>()</span></span><br><span class="line">	&#123;</span><br><span class="line">		mDeltaTime += (Time.deltaTime - mDeltaTime) * <span class="number">0.1f</span>;</span><br><span class="line">		<span class="built_in">float</span> msec = mDeltaTime * <span class="number">1000.0f</span>;</span><br><span class="line">		mFPS = <span class="number">1.0f</span> / mDeltaTime;</span><br><span class="line">		mFPSText.text = <span class="built_in">string</span>.Format(<span class="string">&quot;&#123;0:0.0&#125; ms (&#123;1:0.&#125; fps)&quot;</span>, msec, mFPS);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/img/Unity/FPSDisplay.PNG" alt="FPSDisplay"></p>
<h5 id="2D动画抉择"><a href="#2D动画抉择" class="headerlink" title="2D动画抉择"></a>2D动画抉择</h5><p>一个游戏如果都是静态的图片移动，那么看起来肯定很无聊。<br>所以这里我们必须知道如何去制作动画。<br>首先我们确定的是我们使用的是2D Sprite，那么这里就确定了我们需要制作Sprite Animation。<br>在执着2D Sprite Animation之前，我们需要了解一些重要的概念：</p>
<ol>
<li>Animation – 基于关键帧的动画</li>
<li>Animation Controller — 动画管理，通过给物体添加Animator并设定动画状态机之间的切换规则来实现动画状态切换管理(通过给UI添加Animator我们也可以在Anmation面板设置简单动画)<br>接下来看看制作2D Animation步骤：<br>这里由于我下载的资源都只有一整张赛车的Sprite，见下图:<br><img src="/img/Unity/PlayerCarSprite.PNG" alt="PlayerCarSprite"><br>因为原始图片是463*1010的，对于我们来说像素太大了，需要缩小，所以我首先通过PS把图片缩小。<br>如果要想做更细致的动画，比如控车里的人做动画，轮子转弯的时候做动画，那么我就需要制作多张关键帧的Sprite。<br>关键帧图片制作(下面只列举最后一帧，就不多放图片了这里)：<br><img src="/img/Unity/PlayerCarTurnLeft4.png" alt="PlayerCarTurnLeft4"><br><img src="/img/Unity/PlayerCarTurnRight4.png" alt="PlayerCarTurnRight4"><br>接下来我们把制作好的关键帧图片导入Unity作为2D Sprite。<br>然后在Animation面板创建并制作Turn Right，Turn Left，Normal和Crash四种动画。<br><img src="/img/Unity/NormalAnimation.PNG" alt="NormalAnimation"><br><img src="/img/Unity/TurnLeftAnimation.PNG" alt="TurnLeftAnimation"><br><img src="/img/Unity/TurnRightAnimation.PNG" alt="TurnRightAnimation"><br><img src="/img/Unity/CrashAnimator.PNG" alt="CrashAnimator"><br>动画制作完成后，我们需要通过Animation Controller去控制四个动画之间的状态转换规则(Unity里可视化的状态机)。(除了默认的Sprite创建的动画，我们还可以在Aniamtor里通过修改scale，position等属性制作帧动画)<br>首先在Animation Controller里我的赛车有四中状态，Normal，TurnRight，TurnLeft，Crash：<br><img src="/img/Unity/AnimationController.PNG" alt="AnimationController"><br>设置了四种状态之间的转换后，我们需要添加转换条件，添加转换条件，需要通过Animator-&gt;Parameters面板添加，这里我添加了四个trigger类型的条件变量(Trigger的设置只会触发一次状态)：<br><img src="/img/Unity/AnimatorParameters.PNG" alt="AnimatorParameters"><br>创建了状态切换条件后我们需要在状态切换的条件那里设置触发条件：<br>首先选中特定状态切换的带三尖角的线，然后在Inspector设置触发条件和一些状态转换之间的设置，见下图：<br><img src="/img/Unity/StateTranslationConditionSetting.PNG" alt="StateTranslationConditionSetting"><br>这样一来我们在代码里只需获取特定对象身上的Animator，然后调用Animator.SetTrigger(“IsTurningNormal”)就能触发到Normal的状态切换了，同时触发动画效果。</li>
</ol>
<p>除了Unity自带的帧动画，我们还可以通过Animation插件去实现一些动画效果。<br>让我们来看看下面DOTween官网对于各个Tween插件的比较<a target="_blank" rel="noopener" href="http://dotween.demigiant.com/#enginesComparison">Comparison with other engines</a>。<br>因为我一个都没有用过，就直接按上面的理论使用方便快速的DOTween作为这一次学习使用的对象。<br>具体的DOTween学习参见<a href="http://tonytang1990.github.io/2015/07/15/Unity-Study/#2D-ROGUELIKE-TUTORIAL">Unity_Study_Plugins_DOTween</a></p>
<p>这样一来车子的左右平滑移动和Jump动画效果就通过DOTween实现了。<br>而车子的上下移动结合Coroutine来实现(使用Coroutine的好处是可以实现避免每帧都判断是否需要向上或向下移动)。<br>具体代码如下：<br>PlayerCarController.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> DG.Tweening;</span><br><span class="line"><span class="keyword">using</span> UnityEngine.SceneManagement;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PlayerCarController</span> : <span class="title">MonoBehaviour</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">float</span> mMoveTweenTime = <span class="number">0.3f</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">float</span> mIntervalTimeToKeepMovingUPOrDown = <span class="number">0.025f</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Vector3 mHorizontalOffset = <span class="keyword">new</span> Vector3(<span class="number">0.9f</span>, <span class="number">0.0f</span>, <span class="number">0.0f</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Vector3 mVerticalOffset = <span class="keyword">new</span> Vector3(<span class="number">0.0f</span>, <span class="number">0.08f</span>, <span class="number">0.0f</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> LayerMask mBolockingLayer;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">const</span> <span class="built_in">int</span> mLimitTopDownMoving = <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Vector3 mTargetPosition;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">bool</span> mIsTweenComplete = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">bool</span> mIsJumpComplete = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">bool</span> mIsKeepMovingUp = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">bool</span> mIsKeepMovingDown = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">bool</span> mUpdateJumpAnimationLater = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Animator mPlayerCarAnimator;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">bool</span> mIsCrash = <span class="literal">false</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//Jump tween</span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">float</span> mJumpDuration = <span class="number">0.4f</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">float</span> mOriginalJumpDuration;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Vector3 mJumpEndScale = <span class="keyword">new</span> Vector3(<span class="number">0.6f</span>, <span class="number">0.6f</span>, <span class="number">1.0f</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Vector3 mOriginalScale;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Sequence mJumpSequence;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Box2D</span></span><br><span class="line">    <span class="keyword">private</span> BoxCollider2D mPlayerCarBox2D;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Awake</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mTargetPosition = gameObject.transform.position;</span><br><span class="line"></span><br><span class="line">        mPlayerCarAnimator = gameObject.GetComponent&lt;Animator&gt;();</span><br><span class="line"></span><br><span class="line">        mOriginalScale = transform.localScale;</span><br><span class="line"></span><br><span class="line">        mPlayerCarBox2D = gameObject.GetComponent&lt;BoxCollider2D&gt;();</span><br><span class="line"></span><br><span class="line">        mOriginalJumpDuration = mJumpDuration;</span><br><span class="line"></span><br><span class="line">        mJumpSequence =  DOTween.Sequence();</span><br><span class="line"></span><br><span class="line">        mJumpSequence.Append(transform.DOScale(mJumpEndScale, mJumpDuration));</span><br><span class="line">        mJumpSequence.Append(transform.DOScale(mOriginalScale, mJumpDuration));</span><br><span class="line">        mJumpSequence.SetAutoKill(<span class="literal">false</span>);</span><br><span class="line">        mJumpSequence.OnComplete(OnJumpComplete);</span><br><span class="line">        mJumpSequence.Pause();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Use this for initialization</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Start</span> ()</span> &#123;</span><br><span class="line">        InputControllerManager.mInputControllerManager.RightButtonClickDelegate(MoveRight);</span><br><span class="line">        InputControllerManager.mInputControllerManager.LeftButtonClickDelegate(MoveLeft);</span><br><span class="line">        InputControllerManager.mInputControllerManager.UpButtonClickDelegate(MoveUp);</span><br><span class="line">        InputControllerManager.mInputControllerManager.UpButtonOnPressDelegat(KeepMoveUp);</span><br><span class="line">        InputControllerManager.mInputControllerManager.DownButtonClickDelegate(MoveDown);</span><br><span class="line">        InputControllerManager.mInputControllerManager.DownButtonOnPressDelegat(KeepMoveDown);</span><br><span class="line">        InputControllerManager.mInputControllerManager.ControlButtonClickDelegate(Jump);</span><br><span class="line"></span><br><span class="line">        StartCoroutine(MoveUpCoroutine());</span><br><span class="line">        StartCoroutine(MoveDownCoroutine());</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// Update is called once per frame</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Update</span> ()</span> &#123;</span><br><span class="line">	</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">MoveRight</span>(<span class="params">GameObject go</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (mIsTweenComplete == <span class="literal">true</span> &amp;&amp; mIsCrash == <span class="literal">false</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Vector2 start = <span class="keyword">new</span> Vector2(transform.position.x, transform.position.y);</span><br><span class="line">            mTargetPosition = transform.position + mHorizontalOffset;</span><br><span class="line">            Vector2 end = <span class="keyword">new</span> Vector2(mTargetPosition.x, mTargetPosition.y);</span><br><span class="line">            RaycastHit2D hit = Physics2D.Linecast(start, end, mBolockingLayer);</span><br><span class="line">            <span class="keyword">if</span>(hit.transform == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (mPlayerCarAnimator != <span class="literal">null</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    mPlayerCarAnimator.SetTrigger(<span class="string">&quot;IsTurningRight&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                mIsTweenComplete = <span class="literal">false</span>;</span><br><span class="line">                transform.DOMove(mTargetPosition, mMoveTweenTime).OnComplete(OnTweenComplete);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">MoveLeft</span>(<span class="params">GameObject go</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (mIsTweenComplete == <span class="literal">true</span> &amp;&amp; mIsCrash == <span class="literal">false</span>) </span><br><span class="line">        &#123;</span><br><span class="line">            Vector2 start = <span class="keyword">new</span> Vector2(transform.position.x, transform.position.y);</span><br><span class="line">            mTargetPosition = transform.position - mHorizontalOffset;</span><br><span class="line">            Vector2 end = <span class="keyword">new</span> Vector2(mTargetPosition.x, mTargetPosition.y);</span><br><span class="line">            RaycastHit2D hit = Physics2D.Linecast(start, end, mBolockingLayer);</span><br><span class="line">            <span class="keyword">if</span> (hit.transform == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (mPlayerCarAnimator != <span class="literal">null</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    mPlayerCarAnimator.SetTrigger(<span class="string">&quot;IsTurningLeft&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                mIsTweenComplete = <span class="literal">false</span>;</span><br><span class="line">                mTargetPosition = transform.position - mHorizontalOffset;</span><br><span class="line">                transform.DOMove(mTargetPosition, mMoveTweenTime).OnComplete(OnTweenComplete);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">MoveUp</span>(<span class="params">GameObject go</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">    </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">KeepMoveUp</span>(<span class="params">GameObject go, <span class="built_in">bool</span> state</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(state)</span><br><span class="line">        &#123;</span><br><span class="line">            mIsKeepMovingUp = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            mIsKeepMovingUp = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">IEnumerator <span class="title">MoveUpCoroutine</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (mIsKeepMovingUp &amp;&amp; mIsCrash == <span class="literal">false</span> &amp;&amp; mIsJumpComplete == <span class="literal">true</span>)</span><br><span class="line">            &#123;  </span><br><span class="line">                Vector2 start = <span class="keyword">new</span> Vector2(transform.position.x, transform.position.y);</span><br><span class="line">                mTargetPosition = transform.position + mVerticalOffset * mLimitTopDownMoving;</span><br><span class="line">                Vector2 end = <span class="keyword">new</span> Vector2(mTargetPosition.x, mTargetPosition.y);</span><br><span class="line">                RaycastHit2D hit = Physics2D.Linecast(start, end, mBolockingLayer);</span><br><span class="line">                <span class="keyword">if</span> (hit.transform == <span class="literal">null</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    mTargetPosition = transform.position + mVerticalOffset;</span><br><span class="line">                    transform.position = mTargetPosition;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="function"><span class="keyword">yield</span> <span class="keyword">return</span> <span class="keyword">new</span> <span class="title">WaitForSeconds</span>(<span class="params">mIntervalTimeToKeepMovingUPOrDown</span>)</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">MoveDown</span>(<span class="params">GameObject go</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">    </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">KeepMoveDown</span>(<span class="params">GameObject go, <span class="built_in">bool</span> state</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (state)</span><br><span class="line">        &#123;</span><br><span class="line">            mIsKeepMovingDown = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            mIsKeepMovingDown = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">IEnumerator <span class="title">MoveDownCoroutine</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (mIsKeepMovingDown &amp;&amp; mIsCrash == <span class="literal">false</span> &amp;&amp; mIsJumpComplete == <span class="literal">true</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                Vector2 start = <span class="keyword">new</span> Vector2(transform.position.x, transform.position.y);</span><br><span class="line">                mTargetPosition = transform.position - mVerticalOffset * mLimitTopDownMoving;</span><br><span class="line">                Vector2 end = <span class="keyword">new</span> Vector2(mTargetPosition.x, mTargetPosition.y);</span><br><span class="line">                RaycastHit2D hit = Physics2D.Linecast(start, end, mBolockingLayer);</span><br><span class="line">                <span class="keyword">if</span> (hit.transform == <span class="literal">null</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    mTargetPosition = transform.position - mVerticalOffset;</span><br><span class="line">                    transform.position = mTargetPosition;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="function"><span class="keyword">yield</span> <span class="keyword">return</span> <span class="keyword">new</span> <span class="title">WaitForSeconds</span>(<span class="params">mIntervalTimeToKeepMovingUPOrDown</span>)</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Jump</span>(<span class="params">GameObject go</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (mIsJumpComplete == <span class="literal">true</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            mIsJumpComplete = <span class="literal">false</span>;</span><br><span class="line">            mPlayerCarBox2D.enabled = <span class="literal">false</span>;</span><br><span class="line">            mJumpSequence.Restart();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">CrashCallBack</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        SceneManager.LoadScene(<span class="string">&quot;Game&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">OnTriggerEnter2D</span>(<span class="params">Collider2D collision</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(collision.tag == <span class="string">&quot;EnemyCar&quot;</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.Log(<span class="built_in">string</span>.Format(<span class="string">&quot;Collision with EnemyCar.name &#123;0&#125;&quot;</span>,collision.name));</span><br><span class="line">            mIsCrash = <span class="literal">true</span>;</span><br><span class="line">            mPlayerCarAnimator.SetTrigger(<span class="string">&quot;IsCrash&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">OnTriggerExit2D</span>(<span class="params">Collider2D collision</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (collision.tag == <span class="string">&quot;EnemyCar&quot;</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.Log(<span class="built_in">string</span>.Format(<span class="string">&quot;Collision with EnemyCar.name &#123;0&#125;&quot;</span>, collision.name));</span><br><span class="line">            mIsCrash = <span class="literal">true</span>;</span><br><span class="line">            mPlayerCarAnimator.SetTrigger(<span class="string">&quot;IsCrash&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnTweenComplete</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mIsTweenComplete = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">if</span>(mIsCrash == <span class="literal">false</span>)</span><br><span class="line">        &#123; </span><br><span class="line">            mPlayerCarAnimator.SetTrigger(<span class="string">&quot;IsTurningNormal&quot;</span>);</span><br><span class="line">        &#125; </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnJumpComplete</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mIsJumpComplete = <span class="literal">true</span>;</span><br><span class="line">        mPlayerCarBox2D.enabled = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">if</span>(mUpdateJumpAnimationLater)</span><br><span class="line">        &#123;</span><br><span class="line">            mUpdateJumpAnimationLater = <span class="literal">false</span>;</span><br><span class="line">            UpdateJumpAnimation();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">UpdateJumpAnimation</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (mIsJumpComplete == <span class="literal">false</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            mUpdateJumpAnimationLater = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">        	<span class="comment">//Reset Sequence to adjust tween&#x27;s duration</span></span><br><span class="line">            mJumpSequence.Kill(<span class="literal">true</span>);</span><br><span class="line">            mJumpSequence = DOTween.Sequence();</span><br><span class="line">            mJumpDuration = mOriginalJumpDuration - CarDodgeGame.mCarDodgeGameInstance.GameLevel / <span class="number">15.0f</span>;</span><br><span class="line">            Debug.Log(<span class="string">&quot;mJumpDuration = &quot;</span> + mJumpDuration);</span><br><span class="line">            mJumpSequence.Append(transform.DOScale(mJumpEndScale, mJumpDuration));</span><br><span class="line">            mJumpSequence.Append(transform.DOScale(mOriginalScale, mJumpDuration));</span><br><span class="line">            mJumpSequence.SetAutoKill(<span class="literal">false</span>);</span><br><span class="line">            mJumpSequence.OnComplete(OnJumpComplete);</span><br><span class="line">            mJumpSequence.Pause();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过调节给出的public变量，可控制movetween的duration时间和coroutine的执行时间间隔，还有垂直和水平方向的移动位移等。</p>
<h5 id="游戏内GameObject数量的思考"><a href="#游戏内GameObject数量的思考" class="headerlink" title="游戏内GameObject数量的思考"></a>游戏内GameObject数量的思考</h5><p>因为2D赛车躲避小游戏同一时间不会有太多的GameObject处于场景里，通过<a href="http://tonytang1990.github.io/2016/03/13/Unity-COC-Study/#Optimization">Unity_COC_Study</a>的学习，我知道了我们可以通过Object Pool的方式来预创建一定数量的GameObject，然后在适当的时机active or deactive他们来减少Instantiate的调用，即节约内存又性能损耗低。<br>ObjectPoolManager .cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ObjectPoolManager</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ObjectPoolManager mObjectPoolManagerInstance = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> GameObject[] mEnemyCar;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> mAmountForEachEnemyCar = <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;List&lt;GameObject&gt;&gt; mEnemyCarTwoDimensionList;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">bool</span> mWillGrow = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Awake</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (mObjectPoolManagerInstance == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            mObjectPoolManagerInstance = <span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (mObjectPoolManagerInstance != <span class="keyword">this</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Destroy(gameObject);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Start</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mEnemyCarTwoDimensionList = <span class="keyword">new</span> List&lt;List&lt;GameObject&gt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; mEnemyCar.Length; i++)</span><br><span class="line">        &#123; </span><br><span class="line">            List&lt;GameObject&gt; enemycarlist = <span class="keyword">new</span> List&lt;GameObject&gt;(mAmountForEachEnemyCar);</span><br><span class="line">            <span class="keyword">for</span>(<span class="built_in">int</span> j = <span class="number">0</span>; j &lt; mAmountForEachEnemyCar; j++)</span><br><span class="line">            &#123;</span><br><span class="line">                GameObject enemycarobj = Instantiate(mEnemyCar[i]) <span class="keyword">as</span> GameObject;</span><br><span class="line">                enemycarobj.SetActive(<span class="literal">false</span>);</span><br><span class="line">                enemycarlist.Add(enemycarobj);</span><br><span class="line">            &#125;</span><br><span class="line">            mEnemyCarTwoDimensionList.Add(enemycarlist);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> GameObject <span class="title">GetEnemyCarObject</span>(<span class="params"><span class="built_in">int</span> carindex</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; mEnemyCarTwoDimensionList[carindex].Count; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (!mEnemyCarTwoDimensionList[carindex][i].activeInHierarchy)</span><br><span class="line">            &#123;</span><br><span class="line">                mEnemyCarTwoDimensionList[carindex][i].SetActive(<span class="literal">true</span>);</span><br><span class="line">                <span class="keyword">return</span> mEnemyCarTwoDimensionList[carindex][i];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mWillGrow)</span><br><span class="line">        &#123;</span><br><span class="line">            GameObject enemycar = Instantiate(mEnemyCar[carindex]) <span class="keyword">as</span> GameObject;</span><br><span class="line">            mEnemyCarTwoDimensionList[carindex].Add(enemycar);</span><br><span class="line">            <span class="keyword">return</span> enemycar;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上述代码写的比较死，是针对CarDodge这个游戏而言，因为有多种车子，所以用到了List&lt;List<GameObject>&gt;这样的双重List来存储对应车子所与生成的GameObject。</p>
<p>最终游戏截图(大部分游戏UI素材选至COC)：<br><img src="/img/Unity/LoginUI.PNG" alt="LoginUI"><br>出于是学习使用旧版的NGUI，所以上述UI并没有实际的账号注册检查，只实现了简单的输入文字要求和账号对错(账号暂时是硬代码写的，PC上是通过读取Excel(使用的是ExcelReader，参考<a target="_blank" rel="noopener" href="http://exceldatareader.codeplex.com/">ExcelRead website</a>)，真机对应功能还没做)检查。<br><img src="/img/Unity/LoadingUI.PNG" alt="LoadingUI"><br>这一个主要是尝试Scroll Bar<br><img src="/img/Unity/GameSetting1.PNG" alt="GameSetting1"><br><img src="/img/Unity/GameSetting2.PNG" alt="GameSetting2"><br><img src="/img/Unity/GameSetting3.PNG" alt="GameSetting3"><br>这三个主要是尝试UIBUtton，UIPopupList，UIISlider，UIDraggable Panel的使用和TweenPosition制作简单UI动画(包含了对背景音乐和音量的设置功能，存储采取PlayerPrefs写入程序文件)。<br><img src="/img/Unity/IpadScreenShot.jpg" alt="IpadScreenShot"><br>最后这一个是本章2D赛车躲避的最终真机(Ipad mini 1)游戏截图，主要实现了赛车跳跃，前后左右移动，随着赛车数量躲避增加游戏速度增加，限制了移动范围。</p>
<h3 id="贪吃蛇"><a href="#贪吃蛇" class="headerlink" title="贪吃蛇"></a>贪吃蛇</h3><h4 id="游戏说明-1"><a href="#游戏说明-1" class="headerlink" title="游戏说明"></a>游戏说明</h4><p>这个游戏我想没什么好说的了，直接移步<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E8%B4%AA%E9%A3%9F%E8%9B%87">贪吃蛇维基百科</a></p>
<h4 id="游戏要点思考"><a href="#游戏要点思考" class="headerlink" title="游戏要点思考"></a>游戏要点思考</h4><ol>
<li>2D or 3D？<br>标准的传统2D游戏，所以这里可以用纯2D来做(这里采用纯NGUI来做，看看NGUI的自适应效果)。</li>
<li>游戏素材大小<br>依然以1024<em>768(4:3)为标准，因为之前在<a href="http://tonytang1990.github.io/2015/07/15/Unity-Study/#NGUI_2-7%E5%B1%8F%E5%B9%95%E8%87%AA%E9%80%82%E5%BA%94">NGUI 2.7屏幕自适应</a>已经提到了，把UIRoot的Scaling Style设置为Fixed Size，然后通过动态修改ManuaHeight已经实现了基于高度的自适应，所以我们在创建地图的时候只需考虑把Grid创建在基于1024</em>768的分辨率对应位置即可(当然这样会出现在不同分辨率机器上自适应后铺不满屏幕，但这样做我们可以无需考虑机器分辨率)。准备设计宽40<em>30(4:3)个单元格，单元格以20乘以20像素为基准，这样一来游戏地图占据800</em>600像素，高度腾出来的像素768-600&#x3D;168用于控制UI面板显示。<br>这个游戏实现没什么特别的，这里主要看看不同分辨率的显示情况。<br>1024-768：<br><img src="/img/Unity/SnakeGame1024768.PNG" alt="SnakeGame1024768"><br>960-640：<br><img src="/img/Unity/Snake960640.PNG" alt="Snake960640"><br>800-800：<br><img src="/img/Unity/Snake800800.PNG" alt="Snake800800"></li>
</ol>
<h3 id="坦克大战"><a href="#坦克大战" class="headerlink" title="坦克大战"></a>坦克大战</h3><h4 id="游戏说明-2"><a href="#游戏说明-2" class="headerlink" title="游戏说明"></a>游戏说明</h4><p><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%9D%A6%E5%85%8B%E5%A4%A7%E6%88%98">坦克大战（英语：Battle City）是一款平面射击游戏</a></p>
<h4 id="游戏要点思考-1"><a href="#游戏要点思考-1" class="headerlink" title="游戏要点思考"></a>游戏要点思考</h4><ol>
<li><p>2D or 3D?<br>以纯2D的形式来制作坦克大战游戏。</p>
</li>
<li><p>UI选择<br>这里为了熟悉UGUI，进而和NGUI相比较，这里采用UGUI来学习。<br><a href="http://tonytang1990.github.io/2015/07/15/Unity-Study/#UGUI">UGUI相关知识学习</a></p>
</li>
<li><p>UI自适应<br>UI Render Space – Screen Space(Camera)(设置Main Camera作为渲染Camera)<br>UI Scale Mode – Scale With Screen Size(设置MatchWidthOrHeight &#x3D; 0.5确保按宽度和高度变化同时变化去适应)<br>Background UI Scale Mode – Scale with Screen Size(设置MatchWidthOrHeight &#x3D; 1确保游戏背景是高度铺满，Anchor设置在中心保持1:1比例)</p>
</li>
<li><p>Pixel Perfect 2D?素材选择？地图大小？地图在不同分辨率上的显示？<br>为了实现Pixel Perfect 2D，我们需要确保1 Unit所代表的像素 &#x3D; PPU。<br>我以1024 X 768为基准，Orthographic Size设置为6，PPU为64。(这样一来屏幕高度被分为12 Unit，每个Unit代表768 &#x2F; 2 &#x2F; 6 &#x3D; 64 pixel)<br>2D素材采用64 X 64的Tile(每一个Tile占一个Unit)<br>游戏区域为704 X 704大小(占11 X 11个Unit，四周多出来的用于UI显示)<br>UI Sprite采用64 X 64。<br>因为地图是基于Tile的，所以在不同分辨率上，地图的大小(Tile数量)应该是一致的，这里地图大小默认设定为11 X 11个Tile(704 X 704)(基于1024 X 768，高度顶部留1个Unit)。<br>要想Tile在不同分辨率机器上都Pixel Perfect显示，动态修改Orthographic Size会导致Size Change(屏幕高度的Unit数量也会改变)，以PPU &#x3D; 64且Tile像素为64 * 64去显示12个Tile是没法恰好铺满屏幕高度的。所以这里采用保持Orthographic Size不变保持6，制作多套PPU去适应屏幕分辨率的方案(通过Assetbundle动态替换)。(出于学习目的这里只针对1024 X 768(PPU &#x3D; 64)和1920 X 1080(PPU &#x3D; 1080 &#x2F; 2 &#x2F; 6 &#x3D; 90)来做两套PPU实验)<br>Note:<br>这方案会导致做很多套不同PPU的资源去适应不同屏幕分辨率。</p>
</li>
<li><p>Sprite Setting?<br>Sprite Type – Sprite(2D and UI) 因为用于纯2D游戏<br>Sprite Mode – Single or Multiple 根据我们的图片是否需要切割成单独的Sprite而定<br>Packing Tag – 用于Unity Sprite Packer打包Spite图集<br>Pixels Per Unit – 64(Pixel Perfect显示，PPU &#x3D; Screen.height &#x2F; Orthographic Size(6) &#x2F; 2)。<br>Generate Mip Maps – No(因为是纯2D游戏，摄像机与Sprite距离保持不变(当然其实Camera设置成Screen Space(Camera)而言是可以变的，但这里我们设置Orthographic投影，所以距离对于显示大小没有意义，并且我们还保证了Pixel Perfet显示，所以就游戏里的Sprite而言Mipmap是没有必要的。(前面的前提是使用多套Asset资源并保证Pixel Perfect显示))<br>后面三个参数学习参考<a target="_blank" rel="noopener" href="http://blog.csdn.net/candycat1992/article/details/22794773">调整画质（贴图）质量</a><br>Filter Mode – Bilinear(Filter Mode用于纹理图片这里的Sprite拉伸后如何插值计算(抗锯齿计算)，Bilinear会进行双线性插值，效果和运算开销在Point，Biinear，Trilinear里最能够接受。)<br>Max Size – 2048(导入纹理的最大尺寸，默认2048，设置过小会导致大图片被压缩，质量变得很差(当然也要考虑内存的使用降低了))<br>Format – Compressed(纹理压缩格式，大小和质量的权衡。采用默认的Compressed即可。)</p>
</li>
<li><p>物理？<br>不使用物理控制(Transform移动)，使用Trigger做触发，纯2D游戏，使用Physical2D和Rigibody2D。<br>平滑移动思考：<br> 需求：<br> 保持匀速移动，固定时间内完成<br> 方案一：<br> DoTwen<br> 使用DoTween会导致需要初始化大量的Tween(假设地图是11 X 11，每次移动的offset是0.5，那么我们会需要创建(11 &#x2F; 0.5 ) X (11 &#x2F; 0.5) &#x3D;  484个Tween)<br> 方案二：<br> Vector3.Lerp(Vector3 a, Vector3 b, float t);<br> <a target="_blank" rel="noopener" href="https://docs.unity3d.com/ScriptReference/Vector3.Lerp.html">Interpolates between the vectors a and b by the interpolant t. The parameter t is clamped to the range [0, 1].</a><br> <a target="_blank" rel="noopener" href="http://www.blueraja.com/blog/404/how-to-use-unity-3ds-linear-interpolation-vector3-lerp-correctly">Using Vector3.Lerp() correctly in Unity</a><br> 参考上述博文，我们会发现，平时大部分的用法是如下：</p>
</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">transform.position = Vector3.Lerp(transform.position, _endPosition, speed*Time.deltaTime);</span><br></pre></td></tr></table></figure>
<pre><code>这样的用法其实会导致非线性的移动速度，因为每一次transform.position的位置在变(离终点越来越近)，假设Time.deltaTime是固定时间间隔，那么就会出现前半段移动的快，后半段移动的慢的效果。
为了保证正真的平滑移动(匀速移动)，我们需要保证初始位置和结束位置不变，然后调整t参数，所以这里把t参数设定为timepassed(从开始Lerp计时) / timetocomplete(总共完成Lerp的用时。通过在Update或FixedUpdate里每隔一段时间更新Lerp的t参数，我们可以实现跟帧率挂钩的匀速移动效果(帧率高，移动的平滑。帧率低，移动的跳跃。但都能在固定时间内达到终点)。
</code></pre>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">IEnumerator <span class="title">MovingCoroutine</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (mIsMoving == <span class="literal">true</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">float</span> timesincestarted = Time.time - mTimeStartMoving;</span><br><span class="line">            <span class="built_in">float</span> percentagecomplete = timesincestarted / mTimeToCompleteMove;</span><br><span class="line">            transform.position = Vector3.Lerp(mStartPosition, mDestinationPosition, percentagecomplete);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (percentagecomplete &gt;= <span class="number">1.0f</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                mIsMoving = <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">yield</span> <span class="keyword">return</span> <span class="keyword">new</span> <span class="title">WaitForSeconds</span>(<span class="params">mKeepMoveIntervalTime / <span class="number">10</span></span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="7">
<li><p>控制方式<br>因为之前的控制面板是基于NGUI制作的，所以这里就混合UGUI和NGUI来作为控制面板。</p>
</li>
<li><p>游戏特性<br> 坦克特性：<br> 1. 占据一个Tile，1 Unit(1 Tile被细分成16 * 16的网格)<br> 2. Tank以0.5个Unit的单位的移动，只要前方0.5 Unit单位内有不可通行物，就不能前进<br> 3. 多个Tank不能占据同一位置<br> 4. Tank只能上下左右移动<br> 5. 坦克只能发射出有限数量的子弹，在子弹数量达到上限时需要等待子弹消失。<br> 6. 不同的坦克的移动速度和子弹数量上限和子弹速度不一样<br> 子弹特性：<br> 1. 子弹拥有不同等级的威力，根据威力不同可消灭的小块数量和小块类型不同<br> 2. 子弹不能击中友方队员(友方队员子弹也不行)<br> 3. 子弹只有上下左右四个固定的方向，一旦射出子弹，方向不会改变<br> Tile特性：<br> 1. Tile可以被攻击切割成多个小块(Normal Tile这里假设可切割成16)，<br> 每个小块具备完整的特性(占据单元格阻碍前进，能被攻击)。<br> 2. 小块Tile被子弹击中会根据子弹伤害和周围Tile小块情况来决定是消灭单独一个小块还是2个或多个。<br> 3. 不同类型的Tile有不同的特性(能否通过，能否破坏等)</p>
</li>
<li><p>敌人AI<br> 敌军坦克特性：<br> 1. 移动方向只有上下左右<br> 2. 单次移动单位0.5 Unit<br> 3. 撞到障碍物(不可通行的地方(不包括友军坦克))后重新选择方向<br> 4. 方向选择(避开之前行进方向随机选取一个方向，为了保证坦克不至于一直一左一右，这里需要采用[Shuffle Bag]而非完全随机的方式选取新移动方向，Shuffle Bag可以保证特定事件发生的概率从而保证各个方向的选择都能平摊，比如4次里面肯定会有上下左右而非左右左右)<br> 5. 多个坦克相遇的时候不立刻重新选择方向而是开始累计坦克无法移动的时间<br> (直到坦克达到坦克停止时间限制时重新选择，这里不同速度的坦克所忍耐的停止时间不一样，这样一来就可以实现，速度快的追着速度慢的跑)<br> 6. 子弹随机隔一段时间发射，但不会发射超过子弹数量上限。<br> <a target="_blank" rel="noopener" href="https://web.archive.org/web/20150324141028/http://kaioa.com/node/53">Shuffle Bag</a><br> Shuffle Bag代码：</p>
</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ShuffleBag</span>&lt;<span class="title">T</span>&gt; : <span class="title">ICollection</span>&lt;<span class="title">T</span>&gt;, <span class="title">IList</span>&lt;<span class="title">T</span>&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> List&lt;T&gt; mData = <span class="keyword">new</span> List&lt;T&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span> mCursor = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> T last;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> T <span class="title">Next</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (mData.Count == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">default</span>(T);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mCursor &lt; <span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            mCursor = mData.Count - <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">if</span> (mData.Count &lt; <span class="number">1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">default</span>(T);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> mData[<span class="number">0</span>];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">int</span> grab = Mathf.FloorToInt(Random.<span class="keyword">value</span> * (mCursor + <span class="number">1</span>));</span><br><span class="line">        T temp = mData[grab];</span><br><span class="line">        mData[grab] = mData[mCursor];</span><br><span class="line">        mData[mCursor] = temp;</span><br><span class="line">        mCursor--;</span><br><span class="line">        <span class="keyword">return</span> temp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//IList[T] implementation</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">int</span> <span class="title">IndexOf</span>(<span class="params">T item</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> mData.IndexOf(item);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Insert</span>(<span class="params"><span class="built_in">int</span> index, T item</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        mData.Insert(index, item);</span><br><span class="line">        mCursor = mData.Count - <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">RemoveAt</span>(<span class="params"><span class="built_in">int</span> index</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        mData.RemoveAt(index);</span><br><span class="line">        mCursor = mData.Count - <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> T <span class="keyword">this</span>[<span class="built_in">int</span> index]</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> mData[index];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">set</span></span><br><span class="line">        &#123;</span><br><span class="line">            mData[index] = <span class="keyword">value</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//IEnumerable[T] implementation</span></span><br><span class="line">    IEnumerator&lt;T&gt; IEnumerable&lt;T&gt;.GetEnumerator()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> mData.GetEnumerator();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ICollection[T] implementation</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Add</span>(<span class="params">T item</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        mData.Add(item);</span><br><span class="line">        mCursor = mData.Count - <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> Count</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> mData.Count;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Clear</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//mCursor = 0;</span></span><br><span class="line">        mData.Clear();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">Contains</span>(<span class="params">T item</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> mData.Contains(item);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">CopyTo</span>(<span class="params">T[] array, <span class="built_in">int</span> arrayindex</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">foreach</span> (T item <span class="keyword">in</span> mData)</span><br><span class="line">        &#123;</span><br><span class="line">            array.SetValue(item, arrayindex);</span><br><span class="line">            arrayindex++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">Remove</span>(<span class="params">T item</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">bool</span> removesuccess = mData.Remove(item);</span><br><span class="line">        mCursor = mData.Count - <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">return</span> removesuccess;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">bool</span> IsReadOnly</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//IEnumerable implementation</span></span><br><span class="line">    IEnumerator IEnumerable.GetEnumerator()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> mData.GetEnumerator();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="10">
<li><p>地图编辑器制作<br>做一个地图编辑模式，提供多种Tile模型选择，通过序列化存储起来。(可用于制作关卡)</p>
</li>
<li><p>多人网络游戏(学习多人网络游戏开发)<br>暂不支持多人联网进行(通过Unity High Level API去开发  – 待深入学习)</p>
</li>
<li><p>地图存储方式<br>地图信息很简单，主要存储地图里每一个Tile的类型信息(同时存储地图名称，坦克出生地点信息)，这里采用序列化的方式。(因为我们保持了Orthographic Size为6，通过动态切换不同PPU的Assets去保证Pixel Perfect显示，所以Screen高度一直都是12个Unit，同时设置了PPU &#x3D; Screen.height &#x2F; 2 &#x2F; 6，Tile素材PPU * PPU，所以1个Tile对应1个Unit。地图存储的信息是11 * 11(704 * 704)个Tile相关的信息(高度顶部留3个Unit用作UI显示)。</p>
</li>
<li><p>地图数据加密<br>待思考</p>
</li>
<li><p>游戏地图数据结构？如何实现Tile可以被多个方向打击切割成小块效果？<br>地图存储数据信息(MapInfo)：<br>1. 地图被细分成多个Tile(MapSize.Row * MapSize.Column大小)，存储所有Tile相关信息(用于构建地图)<br>2. 记录玩家Tank出生点和敌军坦克出生点信息。(用于获取Spawn玩家坦克和敌军坦克的位置信息)<br>3. 记录是否包含基地和基地位置信息。(用于确保只有一个基地)<br>4. 存储地图名字(用于地图存储)<br>游戏地图数据(TankMap)：<br>1. 记录所有细分后是否被占用信息(用于Tank移动判断)<br>同时记录是否被Tank占用(用于Tank移动的时候判断前方是Tank还是Tile)<br>同时记录细分后占用的类型信息(Tile Type,用于子弹撞击后检测周边Tile类型信息)<br>地图应该被细分成所有 Tile数量 * Tile最小切割数的网格<br>(这里假设Tile最多被切割成16，那么地图应该被细分到MapSize.Row * MapSize.Column * 16的BitArray)<br>2. 每个细分的Tile记录自身包含细分后的索引信息<br>(e.g. 最大细分16，Iron Tile细分为2 * 2 &#x3D; 4，那么每个细分的Iro Tile所记录的细分后的索引信息数量为16 &#x2F; 4 &#x3D; 4个)<br>这样一来每个小的Tile被破坏后支持快速改写该小块占有地图网格的占用信息)。<br>3. 坦克存储自身所占用的所有indexs作为移动索引信息<br>3. 包含前面地图存储的信息(用于构建游戏地图数据)</p>
</li>
</ol>
<p>Note：<br>不同类型的Tile的细分程度不同(16 * 16 or 4 * 4 or 2 * 2 or 1 * 1)，但游戏地图数据细分以细分程度最大的为准。(细分程度不同会影响Tile在子弹撞击时的效果判定)</p>
<p>实现功能：</p>
<ol>
<li>地图编辑存储和读取(支持原始的那些Tile选择)</li>
<li>敌军坦克简单AI(基本无AI，主要是随机的方向选择，但通过Shuffle Bag来避免了过于随机的选择方式)</li>
<li>我方坦克控制和子弹射击</li>
<li>子弹打击效果</li>
</ol>
<p>暂时效果：<br><img src="/img/Unity/TankScreenShot.PNG" alt="TankScreenShot"><br><a target="_blank" rel="noopener" href="http://blog.sina.com.cn/s/blog_8c7d49f20102xrwk.html">具体视频效果参见</a></p>
<p>因为只上传了IOS打包后的XCode项目等文件作为Unity Icloud Build的地址，所以这里没有源代码地址。</p>
<p>待续……</p>
<h2 id="问题记录"><a href="#问题记录" class="headerlink" title="问题记录"></a>问题记录</h2><ol>
<li>编译打包XCode项目出问题<br>Failed to Copy File &#x2F; Directory from ‘**\Unity\Editor\Data\Tools&#x2F;MapFileParser&#x2F;MapFileParser’ to ‘Temp&#x2F;StagingArea\Trampoline\MapFileParser’.<br>这是Unity 5.1版本的一个bug。<br><a target="_blank" rel="noopener" href="http://answers.unity3d.com/questions/990499/error-building-player-ioexception-failed-to-copy.html">解决方案</a><br>修改.\Unity\Editor\Data\Tools\MapFileParser\MapFileParser.exe到MapFileParser然后打包XCode项目，然后在XCode项目里把MapFileParser改回MapFileParser.exe<br>或者使用新版本Unity</li>
<li>编译打包XCode项目时库找不到的问题<br>ArgumentException: The Assembly System.Configuration is referenced by System.Data. But the dll is not allowed to be included or could not be found.<br><a target="_blank" rel="noopener" href="http://answers.unity3d.com/questions/485085/dll-is-not-allowed-to-be-included-or-could-not-be.html">解决方案</a><br>Change it from .NET sub 2.0 to .NET</li>
<li>Git不支持超过100M文件上传<br><a target="_blank" rel="noopener" href="https://git-lfs.github.com/">解决方案Git Large File Storage (LFS)</a></li>
<li>Cloud Build显示Bitcode错误<br>又是Unity5.1.1的一个bug<br>解决方案：<br>可以打开XCode项目，项目属性设置bitcode enale<br>由于遇到太多Unity bug，个人建议采用新版本Unity为佳。我个人最后去下载了最新版本的Unity5.4.0版本。</li>
<li>MapParser.sh acess Permission denied<br>貌似又是Unity bug，Unity 5.4.0<br>解决方案:<br>需要在Mac电脑上修改MapParser.sh的执行权限(chmod +x MapParser.sh)，然后提交到Git后再触发编译。然后用修改后的MapParser.sh覆盖引擎目录下的Editor\Data\PlaybackEngines\iOSSupport\Trampoline\MapParser.sh以确保每次生成的XCode Project里的MapParser.sh有可执行权限。</li>
<li>指定Android NDK的时候报错”Unable to detect NDK version, please pick a different folder”<br>解决方案：<br>需要下载特定版本的NDK 10r<br>Edit -&gt; Preference -&gt; External Tool -&gt; NDK download<br>或者<br>自己去下载后指定目录</li>
<li>XCode编译项目报错：MapParser.sh: bin&#x2F;sh^M: bad interpreter: no such file or directory<br><a target="_blank" rel="noopener" href="http://www.cnblogs.com/pipelone/archive/2009/04/17/1437879.html">解决方案</a><br>这是不同系统编码格式引起的：在windows系统中编辑的.sh文件可能有不可见字符，所以在Linux系统下执行会报以上异常信息。<br>使用dos2unix工具转换字符编码后放到Xcode项目里。(为了避免XCode生成每次都出这个问题，我们替换字符编码为Unix位于Unity引擎里的Editor-&gt;Data-&gt;PlaybackEngines-&gt;iOSSupport-&gt;Trampoline-&gt;MapFileParser.sh)</li>
<li>Unity Cloud Build error:”2015-12-10 17:21:27.407 xcodebuild[7363:75765] Failed to locate a valid instance of CoreSimulatorService in the bootstrap.  Adding it now.<br>Could not find service “com.apple.CoreSimulator.CoreSimulatorService” in domain for uid: 502<br>2015-12-10 17:21:27.431 xcodebuild[7363:75765] launchctl print returned an error code: 28928”<br><a target="_blank" rel="noopener" href="https://trac.macports.org/wiki/ProblemHotlist#xcode7.2">解决方案</a><br>从上面链接发现这是Xcode 7.2的一个bug，我们需要用Xcode 7.3，所以我们只需要把Unity Cloud Build设置到Xcode 7.3即可。</li>
<li>Unity Icloud Build打包出来的.ipa文件很大<br>一. 关闭Bitcode<br><a target="_blank" rel="noopener" href="https://developer.apple.com/library/content/documentation/IDEs/Conceptual/AppDistributionGuide/AppThinning/AppThinning.html">关闭Bitcode</a><br>Bitcode好像是Apple提交App后用于帮助优化的数据，IOS上是optional的，但watchOS and tvOS apps是必须的。</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> UnityEditor;</span><br><span class="line"><span class="keyword">using</span> UnityEditor.Callbacks;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> UnityEditor.iOS.Xcode;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BuildSetting</span> &#123;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">PostProcessBuild</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">OnPostprocessBuild</span>(<span class="params">BuildTarget buildTarget, <span class="built_in">string</span> path</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Debug.Log(<span class="built_in">string</span>.Format(<span class="string">&quot;OnPostprocessBuild(&#123;0&#125;,&#123;1&#125;) called!&quot;</span>, buildTarget.ToString(), path));</span><br><span class="line">        <span class="keyword">if</span> (buildTarget == BuildTarget.iOS)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">string</span> projPath = path + <span class="string">&quot;/Unity-iPhone.xcodeproj/project.pbxproj&quot;</span>;</span><br><span class="line">            PBXProject proj = <span class="keyword">new</span> PBXProject();</span><br><span class="line">            proj.ReadFromString(File.ReadAllText(projPath));</span><br><span class="line"></span><br><span class="line">            <span class="built_in">string</span> nativeTarget = proj.TargetGuidByName(PBXProject.GetUnityTargetName());</span><br><span class="line">            <span class="built_in">string</span> testTarget = proj.TargetGuidByName(PBXProject.GetUnityTestTargetName());</span><br><span class="line">            <span class="built_in">string</span>[] buildTargets = <span class="keyword">new</span> <span class="built_in">string</span>[] &#123; nativeTarget, testTarget &#125;;</span><br><span class="line"></span><br><span class="line">            proj.SetBuildProperty(buildTargets, <span class="string">&quot;ENABLE_BITCODE&quot;</span>, <span class="string">&quot;NO&quot;</span>);</span><br><span class="line">            File.WriteAllText(projPath, proj.WriteToString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>二. 不使用的资源不要放在Resources目录下，避免被打包到resources.assets里<br>三. 打包编译Release版本而非Debug版</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Other/">Other</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Other/">Other</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/07/25/Shader-Toy/" title="Shader Toy" itemprop="url">Shader Toy</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Tony Tang" target="_blank" itemprop="author">Tony Tang</a>
		
  <p class="article-time">
    <time datetime="2016-07-25T07:36:19.000Z" itemprop="datePublished"> 发表于 2016-07-25</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="Shader-Toy-Introduction"><a href="#Shader-Toy-Introduction" class="headerlink" title="Shader Toy Introduction"></a>Shader Toy Introduction</h1><p>之前就听别人提起过这个网站，上面有各式各样只通过Pixel Shader编写绚丽的效果(里面包含了很多数学和算法)。<br>而且作者编写的代码在网站上一目了然，让你知道这个效果是如何计算得出的。<br>看一下下面这一张效果：<br><img src="/img/OpenGL/ShaderToyExmaple.PNG" alt="ShaderToyExmaple"><br>第一眼看到的时候，我很难相信这是通过简单纹理贴图输入加上数学运算得出的图案。</p>
<p>那么我们首先要知道什么是Pixel Shader？<br>Pixel Shader在OpenGL里也叫做Fragment Shader,可以简单的理解成针对每一个pixel做处理的Shader。</p>
<p>在这个网站上编写Pixel Shader还有一个好处就是快速方便的看到效果，当你要去测试一些数学算式算法的时候，很容易可视化的在上面编写并测试。</p>
<h1 id="Shader-Toy-Study"><a href="#Shader-Toy-Study" class="headerlink" title="Shader Toy Study"></a>Shader Toy Study</h1><p>接下来是基于ShaderToy上”GLSL 2D Tutorials”教程学习的一些事例。</p>
<h2 id="fragColor"><a href="#fragColor" class="headerlink" title="fragColor"></a>fragColor</h2><p>fragColor就是我们在GLSL的fragment shader里最后代表像素颜色的最后输出变量，他控制着我每一个像素最终的颜色值</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">mainImage</span><span class="params">( out vec4 fragColor, in vec2 fragCoord )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    fragColor = <span class="built_in">vec4</span>(<span class="number">0.0</span>,<span class="number">1.0</span>,<span class="number">1.0</span>,<span class="number">1.0</span>);    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>mainImage(…)是我们的Pixel Shader的函数路口，每一帧都会对每一像素进行调用。<br>Final Effect：<br><img src="/img/OpenGL/ShaderToyfragColor.PNG" alt="ShaderToyfragColor"></p>
<h2 id="fragCoord"><a href="#fragCoord" class="headerlink" title="fragCoord"></a>fragCoord</h2><p>fragCoord是针对像素坐标而言的，因为mainImage会针对每一个像素执行一次，而fragCoord就给出了像素的坐标位置(左下角为原点)。<br>iResolution是ShaderToy里给出的关于frame的宽高像素信息（主要用于适应屏幕的大小变化，做到按比例而非特定像素值）</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">mainImage</span><span class="params">( out vec4 fragColor, in vec2 fragCoord )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// fragcoord通过使用像素的fragCoord位置除以iResolution的宽高像素信息，</span></span><br><span class="line">	<span class="comment">// 成功将像素位置的width和heigth都映射到了[0.0,1.0]</span></span><br><span class="line">    vec2 fragcoord = <span class="built_in">vec2</span>(fragCoord.xy / iResolution.xy);</span><br><span class="line">    vec3 backgroundcolor = <span class="built_in">vec3</span>(<span class="number">1.0</span>,<span class="number">1.0</span>,<span class="number">1.0</span>);</span><br><span class="line">    vec3 pixelcolor = backgroundcolor;</span><br><span class="line">    vec3 gridcolor = <span class="built_in">vec3</span>(<span class="number">0.5</span>,<span class="number">0.5</span>,<span class="number">0.5</span>);</span><br><span class="line">    vec3 axescolor = <span class="built_in">vec3</span>(<span class="number">0.0</span>,<span class="number">0.0</span>,<span class="number">1.0</span>);</span><br><span class="line">    <span class="type">const</span> <span class="type">float</span> thickwidth = <span class="number">0.1</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">float</span> i = <span class="number">0.0</span>; i &lt; <span class="number">1.0</span>; i+=thickwidth)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">mod</span>(fragcoord.x, thickwidth) &lt; <span class="number">0.008</span> || <span class="built_in">mod</span>(fragcoord.y, thickwidth) &lt; <span class="number">0.008</span>)</span><br><span class="line">        &#123;</span><br><span class="line">           pixelcolor = gridcolor;  </span><br><span class="line">        &#125;       </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">abs</span>(fragcoord.x ) &lt; <span class="number">0.006</span> || <span class="built_in">abs</span>(fragcoord.y) &lt; <span class="number">0.006</span>)</span><br><span class="line">    &#123;</span><br><span class="line">       pixelcolor = axescolor;   </span><br><span class="line">    &#125;</span><br><span class="line">    fragColor = <span class="built_in">vec4</span>(pixelcolor,<span class="number">1.0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Final Effect:<br><img src="/img/OpenGL/ShaderToyfragCoord.PNG" alt="ShaderToyfragCoord"></p>
<h2 id="Own-Coordinate-System"><a href="#Own-Coordinate-System" class="headerlink" title="Own Coordinate System"></a>Own Coordinate System</h2><p>前一节讲到的把像素坐标映射到了[0.0,1.0]，那么如果我们想把坐标信息映射到[-1.0,1.0]并且把屏幕中点作为(0.0,0.0)改如何映射了<br>而且前一节有一个问题需要注意，我们绘制出的grid是长方形而不是正方形（这主要是由于我们屏幕宽高是不一样，但我们都把x，y映射到了[0.0,1.0]并且用相同的interval即thickwidth去做等分导致的）</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">mainImage</span><span class="params">( out vec4 fragColor, in vec2 fragCoord )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// 这里值得注意一下，因为一般情况都是屏幕宽大于高，</span></span><br><span class="line">	<span class="comment">// 所以我们在映射宽高的时候，只需把高映射到[-1.0,1.0]，</span></span><br><span class="line">	<span class="comment">// 宽保持和高的比例差即可，即映射到[-width/height, width/height]</span></span><br><span class="line">	<span class="comment">// 这样一来，同一个interval对于宽和高来说就一样了</span></span><br><span class="line">    vec2 r = <span class="built_in">vec2</span>( fragCoord.xy - <span class="number">0.5</span>*iResolution.xy );</span><br><span class="line">	r = <span class="number">2.0</span> * r.xy / iResolution.y;</span><br><span class="line">    vec3 backgroundcolor = <span class="built_in">vec3</span>(<span class="number">1.0</span>,<span class="number">1.0</span>,<span class="number">1.0</span>);</span><br><span class="line">    vec3 pixelcolor = backgroundcolor;</span><br><span class="line">    vec3 gridcolor = <span class="built_in">vec3</span>(<span class="number">0.5</span>,<span class="number">0.5</span>,<span class="number">0.5</span>);</span><br><span class="line">    vec3 axescolor = <span class="built_in">vec3</span>(<span class="number">0.0</span>,<span class="number">0.0</span>,<span class="number">1.0</span>);</span><br><span class="line">    <span class="type">const</span> <span class="type">float</span> thickwidth = <span class="number">0.1</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">float</span> i = <span class="number">0.0</span>; i &lt; <span class="number">1.0</span>; i+=thickwidth)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">mod</span>(r.x, thickwidth) &lt; <span class="number">0.008</span> || <span class="built_in">mod</span>(r.y, thickwidth) &lt; <span class="number">0.008</span>)</span><br><span class="line">        &#123;</span><br><span class="line">           pixelcolor = gridcolor;  </span><br><span class="line">        &#125;       </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">abs</span>(r.x ) &lt; <span class="number">0.006</span> || <span class="built_in">abs</span>(r.y) &lt; <span class="number">0.006</span>)</span><br><span class="line">    &#123;</span><br><span class="line">       pixelcolor = axescolor;   </span><br><span class="line">    &#125;</span><br><span class="line">    fragColor = <span class="built_in">vec4</span>(pixelcolor,<span class="number">1.0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Final Effect:<br><img src="/img/OpenGL/ShaderToyOwnCoordinateSystem.PNG" alt="ShaderToyOwnCoordinateSystem"></p>
<h2 id="Cicle-Demo"><a href="#Cicle-Demo" class="headerlink" title="Cicle Demo"></a>Cicle Demo</h2><p>接下来我们即将看实现以下功能：</p>
<ol>
<li>绘制圆<br>针对绘制圆，我们主要是通过判断像素到圆心的位置的距离来决定是否处于圆内。</li>
<li>让圆之间的颜色实现叠加计算<br>针对叠加运算的判断，我们主要是通过一个smoothstep的函数去得出像素在圆内和圆外所参与颜色计算的比例(这里是院内1.0,圆外0.0)<br>这里要介绍一下<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Smoothstep">smoothstep</a>函数。<br>函数原型：<br>float smoothstep(float edge0, float edge1, float x)<br>如果我们传递x&lt;edge0则返回0.0，x&gt;edge1则返回1.0，如果在中间则返回edge0-edge1的interpolation值(这里我们主要用来实现判断像素是在圆内还是圆外来决定是否参与叠加运算)</li>
<li>使圆做周期性运动。<br>圆做周期性运动主要是通过iGlobalTime(Pixel Shader运行后的一个动态时间)来计算得出圆心的位置来实现的。</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> PI 3.14159265359</span></span><br><span class="line"><span class="comment">// 绘制圆并返回是否改圆的该像素是否应该参与像素叠加计算</span></span><br><span class="line"><span class="function"><span class="type">float</span> <span class="title">disk</span><span class="params">(vec2 r, vec2 center, <span class="type">float</span> radius, vec3 color, inout vec3 pixel)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   <span class="type">float</span> rtoclength = <span class="built_in">length</span>(r - center);</span><br><span class="line">   <span class="type">float</span> inside = <span class="number">0.0</span>; </span><br><span class="line">   <span class="keyword">if</span>(rtoclength &lt; radius)</span><br><span class="line">   &#123;</span><br><span class="line">      <span class="comment">//pixel = vec3(clamp(rtoclength, radius / 4.0,radius / 2.0));   </span></span><br><span class="line">      inside = <span class="number">1.0</span> - <span class="built_in">smoothstep</span>(radius - <span class="number">0.005</span>,radius + <span class="number">0.005</span>, rtoclength);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> inside;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">mainImage</span><span class="params">( out vec4 fragColor, in vec2 fragCoord )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    vec2 p = <span class="built_in">vec2</span>(fragCoord.xy / iResolution.xy);</span><br><span class="line">  	vec2 r = <span class="built_in">vec2</span>( fragCoord.xy - <span class="number">0.5</span>*iResolution.xy );</span><br><span class="line">	r = <span class="number">2.0</span> * r.xy / iResolution.y;</span><br><span class="line">    vec3 backgroundcolor = <span class="built_in">vec3</span>(<span class="number">0.0</span>, <span class="number">0.0</span>, <span class="number">0.0</span>);</span><br><span class="line">    vec3 color1 = <span class="built_in">vec3</span>(<span class="number">1.0</span>, <span class="number">0.0</span>,<span class="number">0.0</span>);</span><br><span class="line">    vec3 color2 = <span class="built_in">vec3</span>(<span class="number">0.0</span>, <span class="number">1.0</span>, <span class="number">0.0</span>);</span><br><span class="line">    vec3 color3 = <span class="built_in">vec3</span>(<span class="number">0.0</span>, <span class="number">0.0</span>, <span class="number">1.0</span>);</span><br><span class="line">    vec2 circle1center1 = <span class="built_in">vec2</span>(<span class="built_in">sin</span>(iGlobalTime / <span class="number">1.0</span>), <span class="built_in">cos</span>(iGlobalTime / <span class="number">1.0</span>));</span><br><span class="line">    vec2 circle1center2 = <span class="built_in">vec2</span>(<span class="built_in">cos</span>(iGlobalTime / <span class="number">2.0</span>), <span class="built_in">sin</span>(iGlobalTime / <span class="number">2.0</span>));</span><br><span class="line">    vec2 circle1center3 = <span class="built_in">vec2</span>(-<span class="built_in">sin</span>(iGlobalTime / <span class="number">3.0</span>), -<span class="built_in">cos</span>(iGlobalTime / <span class="number">3.0</span>));  </span><br><span class="line">    </span><br><span class="line">    vec3 resultcolor = <span class="built_in">vec3</span>(<span class="number">0.0</span>,<span class="number">0.0</span>,<span class="number">0.0</span>);</span><br><span class="line">    </span><br><span class="line">    vec3 pixel = backgroundcolor;</span><br><span class="line">    </span><br><span class="line">    resultcolor += <span class="built_in">disk</span>(r, circle1center1, <span class="number">0.6</span>, color1, pixel) * color1;</span><br><span class="line">    </span><br><span class="line">    resultcolor += <span class="built_in">disk</span>(r, circle1center2, <span class="number">0.6</span>, color2, pixel) * color2;</span><br><span class="line">    </span><br><span class="line">    resultcolor += <span class="built_in">disk</span>(r, circle1center3, <span class="number">0.6</span>, color3, pixel) * color3;  </span><br><span class="line">    </span><br><span class="line">    fragColor = <span class="built_in">vec4</span>(resultcolor, <span class="number">1.0</span>);</span><br><span class="line">&#125;    </span><br></pre></td></tr></table></figure>
<p>Final Effect:<br><img src="/img/OpenGL/ShaderToyCircleDemo.PNG" alt="ShaderToyCircleDemo"></p>
<h2 id="Plasma-Effect"><a href="#Plasma-Effect" class="headerlink" title="Plasma Effect"></a>Plasma Effect</h2><p><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Plasma_effect">Plasma Effect</a><br>关于这一节还有很多相关知识需要学习理解，暂时只贴代码和效果，后续会进一步深入了解。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">mainImage</span><span class="params">( out vec4 fragColor, in vec2 fragCoord )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    vec2 p = <span class="built_in">vec2</span>(fragCoord.xy / iResolution.xy);</span><br><span class="line">  	vec2 r = <span class="built_in">vec2</span>( fragCoord.xy - <span class="number">0.5</span>*iResolution.xy );</span><br><span class="line">	r = <span class="number">2.0</span> * r.xy / iResolution.y;</span><br><span class="line">    vec3 ret = <span class="built_in">vec3</span>(<span class="number">1.0</span>, <span class="number">1.0</span>, <span class="number">1.0</span>);</span><br><span class="line">    <span class="type">float</span> t = iGlobalTime;</span><br><span class="line">    r = r * <span class="number">8.0</span>;</span><br><span class="line">    <span class="type">float</span> v1 = <span class="built_in">sin</span>(r.x + t);</span><br><span class="line">    <span class="type">float</span> v2 = <span class="built_in">sin</span>(r.y + t);</span><br><span class="line">    <span class="type">float</span> v3 = <span class="built_in">sin</span>(r.x + r.y + t);</span><br><span class="line">    <span class="type">float</span> v4 = <span class="built_in">sin</span>(<span class="built_in">sqrt</span>(r.x * r.x + r.y * r.y) + t);</span><br><span class="line">    <span class="type">float</span> v5 = v1 + v2 + v3 + v4;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>( p.x &lt; <span class="number">1.0</span> / <span class="number">10.0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">       ret = <span class="built_in">vec3</span>(v1);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>( p.x &lt; <span class="number">2.0</span> / <span class="number">10.0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">       ret = <span class="built_in">vec3</span>(v2);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>( p.x &lt; <span class="number">3.0</span> / <span class="number">10.0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">       ret = <span class="built_in">vec3</span>(v3); </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>( p.x &lt; <span class="number">4.0</span> / <span class="number">10.0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">       ret = <span class="built_in">vec3</span>(v4); </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>( p.x &lt; <span class="number">5.0</span> / <span class="number">10.0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">       ret = <span class="built_in">vec3</span>(v5);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>( p.x &lt; <span class="number">6.0</span> / <span class="number">10.0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        ret = <span class="built_in">vec3</span>(<span class="built_in">sin</span>(v5));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">       ret *= <span class="built_in">vec3</span>(<span class="built_in">sin</span>(v5), <span class="built_in">cos</span>(v5), <span class="built_in">tan</span>(v5));         </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    fragColor = <span class="built_in">vec4</span>(ret, <span class="number">1.0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Final Effect:<br><img src="/img/OpenGL/ShaderToyPlasmaEffect.PNG" alt="ShaderToyPlasmaEffect"></p>
<h2 id="Texture-Video-as-Input"><a href="#Texture-Video-as-Input" class="headerlink" title="Texture &amp; Video as Input"></a>Texture &amp; Video as Input</h2><p>下面这个效果比较有趣，是通过把两个视频作为输入，通过把其中一个视频作为背景，把另一个含绿色背景的颜色出掉后合二为一实现的效果。<br>在Shader Toy里，我们可以设置几个Texture到iChannel<em>上，然后通过texture2D(iChannel</em>,*)去访问纹理值。<br>参考至<a target="_blank" rel="noopener" href="http://gamedevelopment.tutsplus.com/tutorials/a-beginners-guide-to-coding-graphics-shaders--cms-23313">A Beginner’s Guide to Coding Graphics Shaders</a></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">mainImage</span><span class="params">( out vec4 fragColor, in vec2 fragCoord )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    vec4 backgroundtexture = <span class="built_in">texture2D</span>(iChannel0, p);</span><br><span class="line">    vec4 fronttexture = <span class="built_in">texture2D</span>(iChannel2, p);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(fronttexture.r + fronttexture.b &gt; fronttexture.g)</span><br><span class="line">    &#123;</span><br><span class="line">       fragColor = fronttexture;   </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">       fragColor = backgroundtexture;  </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Final Effect:<br><img src="/img/OpenGL/ShaderToyTextureAndVideoInput.PNG" alt="ShaderToyTextureAndVideoInput"><br><img src="/img/OpenGL/ShaderToyTextureAndVideoInput2.PNG" alt="ShaderToyTextureAndVideoInput2"></p>
<h2 id="Mouse-Input"><a href="#Mouse-Input" class="headerlink" title="Mouse Input"></a>Mouse Input</h2><p>这一节讲到ShaderToy里关于如何响应Mouse Input。<br>ShaderToy里给了一个iMouse变量，用于得到Mouse输入的信息，我们可以通过iMouse变量的值去做出对应的响应效果。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">float</span> <span class="title">disk</span><span class="params">(vec2 r, vec2 center, <span class="type">float</span> radius, vec3 color, inout vec3 pixel)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   <span class="type">float</span> rtoclength = <span class="built_in">length</span>(r - center);</span><br><span class="line">   <span class="type">float</span> inside = <span class="number">0.0</span>; </span><br><span class="line">   <span class="keyword">if</span>(rtoclength &lt; radius)</span><br><span class="line">   &#123;</span><br><span class="line">      <span class="comment">//pixel = vec3(clamp(rtoclength, radius / 4.0,radius / 2.0));   </span></span><br><span class="line">      inside = <span class="number">1.0</span> - <span class="built_in">smoothstep</span>(radius - <span class="number">0.005</span>,radius + <span class="number">0.005</span>, rtoclength);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> inside;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">mainImage</span><span class="params">( out vec4 fragColor, in vec2 fragCoord )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  	vec2 r = <span class="built_in">vec2</span>( fragCoord.xy - <span class="number">0.5</span>*iResolution.xy );</span><br><span class="line">	r = <span class="number">2.0</span> * r.xy / iResolution.y;</span><br><span class="line">	vec3 backgroundcolor = <span class="built_in">vec3</span>(iMouse.x / iResolution.x);</span><br><span class="line">    vec3 resultcolor = backgroundcolor;</span><br><span class="line">    <span class="comment">// 这里值得注意的一点是，因为我们把高映射到[-1.0,1.0]，但宽是[-aspect, aspect]</span></span><br><span class="line">    <span class="comment">// 我们必须把mouse的x也映射到一样的比例才能正确显示在以r为坐标系的位置</span></span><br><span class="line">    vec2 center = <span class="number">2.0</span> * <span class="built_in">vec2</span>(iMouse.xy - <span class="number">0.5</span> * iResolution.xy) / iResolution.y;</span><br><span class="line">    resultcolor += <span class="built_in">disk</span>(r, center, <span class="number">0.3</span>, <span class="built_in">vec3</span>(<span class="number">1.0</span>,<span class="number">0.0</span>,<span class="number">0.0</span>), resultcolor) * <span class="built_in">vec3</span>(<span class="number">1.0</span>,<span class="number">0.0</span>,<span class="number">0.0</span>);</span><br><span class="line">    fragColor = <span class="built_in">vec4</span>(resultcolor, <span class="number">1.0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Final Effect:<br><img src="/img/OpenGL/ShaderToyMouseInput1.PNG" alt="ShaderToyMouseInput1"><br><img src="/img/OpenGL/ShaderToyMouseInput2.PNG" alt="ShaderToyMouseInput2"></p>
<h2 id="Random-Noise"><a href="#Random-Noise" class="headerlink" title="Random Noise"></a>Random Noise</h2><p>这一章讲关于OpenGL Shader里随机数的生成，这里还了解的不清晰，暂时只贴出代码和效果，后续会进一步学习修改。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">float</span> <span class="title">disk</span><span class="params">(vec2 r, vec2 center, <span class="type">float</span> radius, vec3 color, inout vec3 pixel)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   <span class="type">float</span> rtoclength = <span class="built_in">length</span>(r - center);</span><br><span class="line">   <span class="type">float</span> inside = <span class="number">0.0</span>; </span><br><span class="line">   <span class="keyword">if</span>(rtoclength &lt; radius)</span><br><span class="line">   &#123;</span><br><span class="line">      <span class="comment">//pixel = vec3(clamp(rtoclength, radius / 4.0,radius / 2.0));   </span></span><br><span class="line">      inside = <span class="number">1.0</span> - <span class="built_in">smoothstep</span>(radius - <span class="number">0.005</span>,radius + <span class="number">0.005</span>, rtoclength);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> inside;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">mainImage</span><span class="params">( out vec4 fragColor, in vec2 fragCoord )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    vec2 p = <span class="built_in">vec2</span>(fragCoord.xy / iResolution.xy);</span><br><span class="line">  	vec2 r = <span class="built_in">vec2</span>( fragCoord.xy - <span class="number">0.5</span>*iResolution.xy );</span><br><span class="line">	r = <span class="number">2.0</span> * r.xy / iResolution.y;</span><br><span class="line">    vec3 backgroundcolor = <span class="built_in">vec3</span>(<span class="number">0.0</span>,<span class="number">0.0</span>,<span class="number">0.0</span>);</span><br><span class="line">    vec3 resultcolor = backgroundcolor;</span><br><span class="line">    <span class="type">float</span> widthratio = iResolution.x / iResolution.y;</span><br><span class="line">    vec2 center;</span><br><span class="line">    vec2 pos;</span><br><span class="line">	<span class="keyword">for</span>(<span class="type">float</span> i = <span class="number">0.0</span>; i &lt; <span class="number">6.0</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 这里有一点要注意，</span></span><br><span class="line">        <span class="comment">// 我们需要将随机数映射到正确的宽高映射值才能正确随机显示在整个屏幕上</span></span><br><span class="line">        pos = <span class="built_in">vec2</span>(<span class="number">2.0</span> * widthratio * <span class="built_in">hash</span>(i) - widthratio, <span class="number">2.0</span> * <span class="built_in">hash</span>(i + <span class="number">0.5</span>) - <span class="number">1.0</span>);</span><br><span class="line">    	center = pos;</span><br><span class="line">    	resultcolor += <span class="built_in">disk</span>(r, center, <span class="built_in">hash</span>(i * <span class="number">5.0</span> + <span class="number">10.0</span>) / <span class="number">5.0</span>, <span class="built_in">vec3</span>(<span class="number">1.0</span>, <span class="number">0.0</span>, <span class="number">0.0</span>), resultcolor) * <span class="built_in">vec3</span>(<span class="number">1.0</span>, <span class="number">0.0</span>, <span class="number">0.0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    fragColor = <span class="built_in">vec4</span>(resultcolor, <span class="number">1.0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Final Effect:<br><img src="/img/OpenGL/ShaderToyRandomNumber.PNG" alt="ShaderToyRandomNumber"></p>
<h2 id="更多学习待更新"><a href="#更多学习待更新" class="headerlink" title="更多学习待更新"></a>更多学习待更新</h2><p>……</p>
<h1 id="Shader-Toy-Relative-Knowledge"><a href="#Shader-Toy-Relative-Knowledge" class="headerlink" title="Shader Toy Relative Knowledge"></a>Shader Toy Relative Knowledge</h1><h2 id="Shader-Toy-Inputs"><a href="#Shader-Toy-Inputs" class="headerlink" title="Shader Toy Inputs"></a>Shader Toy Inputs</h2><p><img src="/img/OpenGL/ShaderToyInputs.PNG" alt="ShaderToyInputs"></p>
<p>总的来说ShaderToy是一个很好的Shader学习网站，让我们可以在上面方便可视化的测试一些数学算式和算法效果。</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Rendering/">Rendering</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Shader/">Shader</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/03/13/Unity仿COC/" title="Unity仿COC" itemprop="url">Unity仿COC</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Tony Tang" target="_blank" itemprop="author">Tony Tang</a>
		
  <p class="article-time">
    <time datetime="2016-03-13T11:14:35.000Z" itemprop="datePublished"> 发表于 2016-03-13</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="Preface-序言"><a href="#Preface-序言" class="headerlink" title="Preface(序言)"></a>Preface(序言)</h1><h2 id="What-is-COC"><a href="#What-is-COC" class="headerlink" title="What is COC?"></a>What is COC?</h2><p>COC(Clash of Clans) is a freemium mobile MMO strategy video game developed and published by Supercell.The game was released for iOS platforms on 2 August, 2012,[1] and on Google Play for Android on 7 October, 2013<br>(<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Clash_of_Clans">from wiki</a>)</p>
<h2 id="My-COC-Experience"><a href="#My-COC-Experience" class="headerlink" title="My COC Experience"></a>My COC Experience</h2><p>我第一次接触COC大概是在2014年2月份，当时被朋友拉着一起玩这个游戏，三个人建立了自己的小部落，后来陆陆续续拉了不少朋友加入，口口相传，部落成长到40人的部落，从此以后就一发不可收拾。<br>这款游戏最吸引我的地方有以下几点：</p>
<ol>
<li>游戏时间碎片化（采用真实时间计时），不需要玩家长时间在线。</li>
<li>线上进攻布局，线下防守的玩法。</li>
<li>不同兵种和法术的不同特性使得玩家的手法和路线规划显得尤为重要（后来出的部落战尤其体现了这一点）。</li>
<li>部落的概念，增强了集体的概念和玩家间的互动（分享进攻防守记录，打部落战，聊天，捐兵等）</li>
<li>资深COC玩家来说，游戏的种树文化也不得不说是一种游戏乐趣。</li>
</ol>
<p>贴一张我的COC图已做留念<br><img src="/img/Unity/MyCOC.PNG" alt="My COC"></p>
<p>为了这个游戏还买过COC模型<br><img src="/img/Unity/COCModel.JPG" alt="COC Model"></p>
<p>经历了两年多的COC洗礼，经历了部落解散，部落合并，到现在最后一起坚持到最后的7,8个小伙伴（基本都满防满王了），感慨万千（此处省略一万字）。</p>
<p>出于自己是做游戏开发的缘故，刚开始学习Unity（同时学习C#），所以决定以COC为模板来制作学习Unity。就这样我的Unity COC计划就这样开始了，虽然最后只实现了很小一部分东西（而且很不完美，但学到很多东西），所以写下这个篇文章来总结自己学到的一些东西。</p>
<h1 id="COC-Project-Unity"><a href="#COC-Project-Unity" class="headerlink" title="COC Project(Unity)"></a>COC Project(Unity)</h1><h2 id="Preparation"><a href="#Preparation" class="headerlink" title="Preparation"></a>Preparation</h2><h3 id="Unity"><a href="#Unity" class="headerlink" title="Unity"></a>Unity</h3><p>(<a href="http://tonytang1990.github.io/2015/07/15/Unity-Study/">Unity Study</a>)</p>
<h3 id="Programming-Language-C"><a href="#Programming-Language-C" class="headerlink" title="Programming Language(C#)"></a>Programming Language(C#)</h3><p>(<a href="http://tonytang1990.github.io/2015/08/15/CSharp-Study/">C# Study</a>)</p>
<p>参考书籍：<br><a target="_blank" rel="noopener" href="http://download.csdn.net/download/baiyu9821179/4282298">C#入门经典第五版</a><br>CLR Via C# Fourth Edition - Jeffrey Richter</p>
<h3 id="AI"><a href="#AI" class="headerlink" title="AI"></a>AI</h3><p>(<a href="http://tonytang1990.github.io/2015/10/14/Artificial-Inteligence-Study/">Artificial-Inteligence-Study</a>)</p>
<h3 id="Knowledge"><a href="#Knowledge" class="headerlink" title="Knowledge"></a>Knowledge</h3><h4 id="Is-COC-a-2D-game-or-3D-game"><a href="#Is-COC-a-2D-game-or-3D-game" class="headerlink" title="Is COC a 2D game or 3D game?"></a>Is COC a 2D game or 3D game?</h4><p>The answer is 2D game，actually we should call 2.5D.<br>第一眼看到COC里面的所有动画人物给人的感觉都是3D的，但后来知道了Isometric Tileset Engine的概念。</p>
<h4 id="Isometric-Tileset-Engine"><a href="#Isometric-Tileset-Engine" class="headerlink" title="Isometric Tileset Engine"></a>Isometric Tileset Engine</h4><h5 id="What-is-Isometric-Tileset-Engine"><a href="#What-is-Isometric-Tileset-Engine" class="headerlink" title="What is Isometric Tileset Engine?"></a>What is Isometric Tileset Engine?</h5><p>(<a target="_blank" rel="noopener" href="http://blog.codingnow.com/2014/01/isometric_tileset_engine.html">斜视角游戏的地图渲染</a>)<br>(<a target="_blank" rel="noopener" href="http://flarerpg.org/tutorials/isometric_intro/">Isometric Tiles Introduction</a>)<br>结合上述文章，我们可以知道，Isometric Tileset Engine主要是通过美术制作出Isometric Projection（we angle our camera along two axes (swing the camera 45 degrees to one side, then 30 degrees down)）的2D图片来实现游戏的3D效果（2.5D）。</p>
<h5 id="What-does-game-with-isometric-projection-look-like"><a href="#What-does-game-with-isometric-projection-look-like" class="headerlink" title="What does game with isometric projection look like?"></a>What does game with isometric projection look like?</h5><p>典型的Isometric Projection游戏有：<br>Age of Empires<br><img src="/img/Unity/AgeOfEmpires.PNG" alt="Age of Empires"><br>Diablo 2<br><img src="/img/Unity/Diablo2.PNG" alt="Diablo2"></p>
<h5 id="How-to-make-game-work-under-isometric-projection"><a href="#How-to-make-game-work-under-isometric-projection" class="headerlink" title="How to make game work under isometric projection?"></a>How to make game work under isometric projection?</h5><p>(<a target="_blank" rel="noopener" href="http://gamedevelopment.tutsplus.com/tutorials/creating-isometric-worlds-a-primer-for-game-developers--gamedev-6511">参考:Creating Isometric Worlds: A Primer for Game Developers</a>)<br>从标准的2D游戏到isometric projection的2.5D注意事项</p>
<ol>
<li>Coordinates Transformation – From Cartesian to isometric coordiates</li>
<li>Creating the Art – isometric projection art</li>
<li>Collision Detection – based on rectangle that is caculated from isometric projection</li>
</ol>
<h3 id="Searching"><a href="#Searching" class="headerlink" title="Searching"></a>Searching</h3><h4 id="How-to-develope-COC-like-game"><a href="#How-to-develope-COC-like-game" class="headerlink" title="How to develope COC like game?"></a>How to develope COC like game?</h4><p>云风参与开发的陌陌争霸<br>(<a target="_blank" rel="noopener" href="http://blog.codingnow.com/2014/01/routemap.html">参考:COC Like 游戏中的寻路算法</a>)<br>从上面我们可以看出通过对不同建筑队不同兵种的路径的预算，我们可以在在城墙未被破坏的前提下实现O(1)的速度查询建筑距离信息。（但这里我没明白云风大哥所说的”如果下一个行军路线是城墙就攻打城墙” – 这个前提下怎么实现远距离攻打城墙的效果，所以最终并未采取这种方式实现）。</p>
<h2 id="Project"><a href="#Project" class="headerlink" title="Project"></a>Project</h2><h3 id="Game-Engine"><a href="#Game-Engine" class="headerlink" title="Game Engine"></a>Game Engine</h3><p>Unity</p>
<h3 id="Programming-Language"><a href="#Programming-Language" class="headerlink" title="Programming Language"></a>Programming Language</h3><p>C#</p>
<h3 id="Developer-Tool"><a href="#Developer-Tool" class="headerlink" title="Developer Tool"></a>Developer Tool</h3><p>Unity<br>VS2013 &#x2F; VS2010 (IDE)<br>ILDissembler – 反编译工具<br>Blender – 建模工具（本来打算学习并使用这个，但由于游戏最终并未做出来，都只是使用Unity官网的一些现有模型）<br>Git – 版本控制<br><a target="_blank" rel="noopener" href="https://github.com/TonyTang1990/PathFinding/commits/master">项目地址</a></p>
<h3 id="Basic-Setting-with-Scene"><a href="#Basic-Setting-with-Scene" class="headerlink" title="Basic Setting with Scene"></a>Basic Setting with Scene</h3><p>Scene – 3D Scene(考虑2.5D素材的缘故，直接采用3D场景来学习制作2.5D游戏)<br>Camera – Orthographic Projection(通过采用正交投影并旋转摄像机X轴35度，Y轴45度来模拟Isometric Projection)</p>
<h3 id="Camera-Control-Input"><a href="#Camera-Control-Input" class="headerlink" title="Camera Control &amp; Input"></a>Camera Control &amp; Input</h3><h4 id="PC"><a href="#PC" class="headerlink" title="PC"></a>PC</h4><p>PC主要通过GetAxis()来针对用户的上下左右控制</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">float</span> moveHorizontal = Input.GetAxis (<span class="string">&quot;Horizontal&quot;</span>) * mMoveSpeed * Time.deltaTime;</span><br><span class="line"><span class="built_in">float</span> moveVertical = Input.GetAxis (<span class="string">&quot;Vertical&quot;</span>) * mMoveSpeed * Time.deltaTime;</span><br></pre></td></tr></table></figure>

<h4 id="Mobile"><a href="#Mobile" class="headerlink" title="Mobile"></a>Mobile</h4><p>Mobile主要通过Input.touch来获取屏幕点击事件信息<br>遇到得问题：<br><strong>点击到UI上的时候touch事件并未被吞噬</strong><br>Solved – 通过UnityEngine.EventSystems.EventSystem.current.IsPointerOverGameObject(Input.touches[0].fingerId)来判断是否点击到UI上<br>e.g.</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">f (!UnityEngine.EventSystems.EventSystem.current.IsPointerOverGameObject (Input.touches[<span class="number">0</span>].fingerId));</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>单指和多指的处理<br>通过Input.touchCount分别作处理，多指的处理主要通过遍历Input.touches来判断多指的具体行为<br>遇到的问题：<br><strong>单指相应速度过快</strong><br>Solved – 通过定义一个有效的单指响应时间，只有当每帧DeltaTime时间叠加超过有效响应时间的时候才响应输入<br>e.g.</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Update</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">	mInputTimer += Time.deltaTime;</span><br><span class="line">	<span class="keyword">if</span> (Input.touchCount == <span class="number">1</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span>(Input.touches[<span class="number">0</span>].phase == TouchPhase.Ended &amp;&amp; (mInputTimer &gt; mValidInputDeltaTime))</span><br><span class="line">		&#123;</span><br><span class="line">			......</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>两根手指如何判断是拉远还是缩近地图</strong><br>Solved – 主要通过判断两根手指每一帧的距离是变大还是变小来判断<br>e.g.</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; i++)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (Input.touches[i].phase == TouchPhase.Began)</span><br><span class="line">    &#123;</span><br><span class="line">        mCurrentTouchFingerPos[i] = Input.touches[<span class="number">0</span>].position;</span><br><span class="line">        mPreTouchFingerPos[i] = Input.touches[<span class="number">0</span>].position;</span><br><span class="line">        mTouchFingerDeltaPos[i] = Vector2.zero;</span><br><span class="line">        <span class="keyword">if</span> (i == <span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            mPreTwoFingersDistance = mCurrentTwoFingersDistance;</span><br><span class="line">            mCurrentTwoFingersDistance = Vector2.Distance(mCurrentTouchFingerPos[<span class="number">0</span>], mCurrentTouchFingerPos[<span class="number">1</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (Input.touches[i].phase == TouchPhase.Moved)</span><br><span class="line">    &#123;</span><br><span class="line">        mPreTouchFingerPos[i] = mCurrentTouchFingerPos[i];</span><br><span class="line">        mCurrentTouchFingerPos[i] = Input.touches[i].position;</span><br><span class="line">        mTouchFingerDeltaPos[i] = Input.touches[i].deltaPosition;</span><br><span class="line">        <span class="keyword">if</span> (i == <span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            mPreTwoFingersDistance = mCurrentTwoFingersDistance;</span><br><span class="line">            mCurrentTwoFingersDistance = Vector2.Distance(mCurrentTouchFingerPos[<span class="number">0</span>], mCurrentTouchFingerPos[<span class="number">1</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (Input.touches[i].phase == TouchPhase.Ended)</span><br><span class="line">    &#123;</span><br><span class="line">        mCurrentTouchFingerPos[i] = Vector2.zero;</span><br><span class="line">        mPreTouchFingerPos[i] = Vector2.zero;</span><br><span class="line">        mTouchFingerDeltaPos[i] = Vector2.zero;</span><br><span class="line">        mCurrentTwoFingersDistance = <span class="number">0.0f</span>;</span><br><span class="line">        mPreTwoFingersDistance = <span class="number">0.0f</span>;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="UI"><a href="#UI" class="headerlink" title="UI"></a>UI</h3><p>UI主要使用Unity自带的UI，主要以一个按钮一个方法响应的基本方式。</p>
<p>UI有几个重要的概念：</p>
<ol>
<li>Unity里所有的UI elements都是包含在Canvas里。</li>
<li>UI的Render Mode主要分为三种<br> 2.1 Screen Space – Overlay(Rendered on top of the secene)<br> 2.2 Screen Space – Camera(有距离感的UI，受摄像机设置影响)<br> 2.3 World Space(3D UI,有深度概念，会被3D物体遮挡)</li>
</ol>
<p>UI自适应里的重要概念：</p>
<ol>
<li>UI Scale Mode<br> 1.1 Constant Pixel Size<br> 1.2 Scale With Screen Size(自适应里比较重的一种，会根据设定分辨率比例自动扩大或缩小UI)<br> 1.3 Constant Physical Size</li>
<li>Anchors – 这个我的理解是根据锚点的四个点相对父节点位置的设置，会决定子节点UI如何针对父节点的变化而变化<br>比如锚点的四个点分别位于父节点的四个角落，那就表示子节点UI会根据父节点的放大缩小做出一致的变化。<br>比如锚点的四个点都在父节点的四个角落中的一个角落，就表示，无论父节点如何变化，子节点UI都不会变化并且相对于父节点锚点的那个点的相对位置是不变的。</li>
</ol>
<p><a target="_blank" rel="noopener" href="http://docs.unity3d.com/Manual/UISystem.html">更多的UI概念参考官网学习</a></p>
<h3 id="Map"><a href="#Map" class="headerlink" title="Map"></a>Map</h3><h4 id="Map-Type"><a href="#Map-Type" class="headerlink" title="Map Type"></a>Map Type</h4><p>Tile Map<br>地图是基于一块一块的Tile构成，默认40 * 40</p>
<h4 id="Map-Save"><a href="#Map-Save" class="headerlink" title="Map Save"></a>Map Save</h4><p>C# System.Runtime.Serialization – 序列化来存储Map数据<br>Unity [System.Serializable] – 支持在编辑器可视化</p>
<p>遇到的问题：</p>
<ol>
<li>Unity一些自带的基础类型不支持Serializable<br>e.g. UnityEngine.Vector3(is not marked as Serializable)<br>Solved – 需要自定义Seralizable的Struct来封装Vector3数据</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">Serializable</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">struct</span> BuildingPosition</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">float</span> mX;</span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">float</span> mY;</span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">float</span> mZ;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>Unity挂载和类继承问题<br>Unity要挂载到GameObject上必须继承至MonoBehaviour,但C#不支持多重继承<br>Solved – 定义interface，通过extends interface来实现C#中的多重继承（这一点和Java很像）</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">GameObjectType</span> &#123;</span><br><span class="line">	ObjectType GameType</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">get</span>;</span><br><span class="line">		<span class="keyword">set</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[<span class="meta">Serializable</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Building</span> : <span class="title">MonoBehaviour</span>, <span class="title">GameObjectType</span> &#123;</span><br><span class="line">	.......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Event-Manager"><a href="#Event-Manager" class="headerlink" title="Event Manager"></a>Event Manager</h3><p>主要用于事件监听。（UnityAction是无参并返回void类型的的Delegate）<br>遇到的问题：</p>
<ol>
<li>对于带参数的事件监听<br>Solved – 通过继承UnityEvent<T>实现带特定参数的Delegate监听</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine.Events;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MyIntEvent</span> : <span class="title">UnityEvent</span>&lt;<span class="title">int</span>&gt;</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">EventManager</span> : <span class="title">MonoBehaviour</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Dictionary&lt;<span class="built_in">string</span>, UnityEvent&gt; mEventDictionary;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Dictionary&lt;<span class="built_in">string</span>, MyIntEvent&gt; mIntEventDictionary;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> EventManager mEMInstance = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Awake</span>()</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (mEMInstance == <span class="literal">null</span>) &#123;</span><br><span class="line">			mEMInstance = <span class="keyword">this</span>;</span><br><span class="line">			mEMInstance.Init();</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (mEMInstance != <span class="keyword">this</span>) &#123;</span><br><span class="line">			Destroy(gameObject);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Init</span>()</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (mEventDictionary == <span class="literal">null</span>) &#123;</span><br><span class="line">			mEventDictionary = <span class="keyword">new</span> Dictionary&lt;<span class="built_in">string</span>, UnityEvent&gt;();</span><br><span class="line">		&#125;</span><br><span class="line">        <span class="keyword">if</span> (mIntEventDictionary == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            mIntEventDictionary = <span class="keyword">new</span> Dictionary&lt;<span class="built_in">string</span>, MyIntEvent&gt;();</span><br><span class="line">        &#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">StartListening</span>(<span class="params"><span class="built_in">string</span> eventname, UnityAction listener</span>)</span></span><br><span class="line">	&#123;</span><br><span class="line">		UnityEvent evt = <span class="literal">null</span>;</span><br><span class="line">		<span class="keyword">if</span> (mEMInstance.mEventDictionary.TryGetValue (eventname, <span class="keyword">out</span> evt)) &#123;</span><br><span class="line">			evt.AddListener (listener);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			evt = <span class="keyword">new</span> UnityEvent();</span><br><span class="line">			evt.AddListener(listener);</span><br><span class="line">			mEMInstance.mEventDictionary.Add(eventname, evt);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">StopListening</span>(<span class="params"><span class="built_in">string</span> eventname, UnityAction listener</span>)</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (mEMInstance == <span class="literal">null</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span> ;</span><br><span class="line">		&#125;</span><br><span class="line">		UnityEvent thisevent = <span class="literal">null</span>;</span><br><span class="line">		<span class="keyword">if</span> (mEMInstance.mEventDictionary.TryGetValue (eventname, <span class="keyword">out</span> thisevent)) &#123;</span><br><span class="line">			thisevent.RemoveListener(listener);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">StartListening</span>(<span class="params"><span class="built_in">string</span> eventname, UnityAction&lt;<span class="built_in">int</span>&gt; listener</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        MyIntEvent evt = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (mEMInstance.mIntEventDictionary.TryGetValue(eventname, <span class="keyword">out</span> evt))</span><br><span class="line">        &#123;</span><br><span class="line">            evt.AddListener(listener);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            evt = <span class="keyword">new</span> MyIntEvent();</span><br><span class="line">            evt.AddListener(listener);</span><br><span class="line">            mEMInstance.mIntEventDictionary.Add(eventname, evt);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">StopListening</span>(<span class="params"><span class="built_in">string</span> eventname, UnityAction&lt;<span class="built_in">int</span>&gt; listener</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (mEMInstance == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        MyIntEvent thisevent = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (mEMInstance.mIntEventDictionary.TryGetValue(eventname, <span class="keyword">out</span> thisevent))</span><br><span class="line">        &#123;</span><br><span class="line">            thisevent.RemoveListener(listener);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">HasListening</span>(<span class="params"><span class="built_in">string</span> eventname</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (mEMInstance == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        UnityEvent thisevent = <span class="literal">null</span>;</span><br><span class="line">        MyIntEvent intevent = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (mEMInstance.mEventDictionary.TryGetValue(eventname, <span class="keyword">out</span> thisevent))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(thisevent != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mEMInstance.mIntEventDictionary.TryGetValue(eventname, <span class="keyword">out</span> intevent))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (intevent != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">TriggerEvent</span>(<span class="params"><span class="built_in">string</span> eventname, <span class="built_in">int</span> p = <span class="number">0</span></span>)</span></span><br><span class="line">	&#123;</span><br><span class="line">		UnityEvent thisevent = <span class="literal">null</span>;</span><br><span class="line">		<span class="keyword">if</span> (mEMInstance.mEventDictionary.TryGetValue (eventname, <span class="keyword">out</span> thisevent)) &#123;</span><br><span class="line">			<span class="keyword">if</span>(thisevent != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                thisevent.Invoke();</span><br><span class="line">            &#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">        MyIntEvent intevent = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (mEMInstance.mIntEventDictionary.TryGetValue(eventname, <span class="keyword">out</span> intevent))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (intevent != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                intevent.Invoke(p);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Object-Pool"><a href="#Object-Pool" class="headerlink" title="Object Pool"></a>Object Pool</h3><p>主要为了重用GameObject，减少Instantiate的调用。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ObjectPoolManager</span> : <span class="title">MonoBehaviour</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ObjectPoolManager mObjectPoolManagerInstance = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> GameObject mBuildingBullet;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> mBBulletPoolAmount = <span class="number">20</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;GameObject&gt; mBBulletsList;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> GameObject mSoldierBullet;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> mSBulletPoolAmount = <span class="number">50</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;GameObject&gt; mSBulletsList;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">bool</span> mWillGrow = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Awake</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (mObjectPoolManagerInstance == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            mObjectPoolManagerInstance = <span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (mObjectPoolManagerInstance != <span class="keyword">this</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Destroy(gameObject);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Start</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mBBulletsList = <span class="keyword">new</span> List&lt;GameObject&gt;();</span><br><span class="line">        mSBulletsList = <span class="keyword">new</span> List&lt;GameObject&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; mBBulletPoolAmount; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            GameObject bbulletobj = Instantiate(mBuildingBullet) <span class="keyword">as</span> GameObject;</span><br><span class="line">            bbulletobj.SetActive(<span class="literal">false</span>);</span><br><span class="line">            mBBulletsList.Add(bbulletobj);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> j = <span class="number">0</span>; j &lt; mSBulletPoolAmount; j++)</span><br><span class="line">        &#123;</span><br><span class="line">            GameObject sbulletobj = Instantiate(mSoldierBullet) <span class="keyword">as</span> GameObject;</span><br><span class="line">            sbulletobj.SetActive(<span class="literal">false</span>);</span><br><span class="line">            mSBulletsList.Add(sbulletobj);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> GameObject <span class="title">GetBuildingBulletObject</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; mBBulletsList.Count; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (!mBBulletsList[i].activeInHierarchy)</span><br><span class="line">            &#123;</span><br><span class="line">                mBBulletsList[i].SetActive(<span class="literal">true</span>);</span><br><span class="line">                <span class="keyword">return</span> mBBulletsList[i];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mWillGrow)</span><br><span class="line">        &#123;</span><br><span class="line">            GameObject bbulletobj = Instantiate(mBuildingBullet) <span class="keyword">as</span> GameObject;</span><br><span class="line">            mBBulletsList.Add(bbulletobj);</span><br><span class="line">            <span class="keyword">return</span> bbulletobj;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> GameObject <span class="title">GetSoldierBulletObject</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; mSBulletsList.Count; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (!mSBulletsList[i].activeInHierarchy)</span><br><span class="line">            &#123;</span><br><span class="line">                mSBulletsList[i].SetActive(<span class="literal">true</span>);</span><br><span class="line">                <span class="keyword">return</span> mSBulletsList[i];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mWillGrow)</span><br><span class="line">        &#123;</span><br><span class="line">            GameObject sbulletobj = Instantiate(mSoldierBullet) <span class="keyword">as</span> GameObject;</span><br><span class="line">            mSBulletsList.Add(sbulletobj);</span><br><span class="line">            <span class="keyword">return</span> sbulletobj;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Utilities"><a href="#Utilities" class="headerlink" title="Utilities"></a>Utilities</h3><ol>
<li>FPS Display(用于显示FPS)</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> UnityEngine.UI;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">FPSDisplay</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">public</span> Text mFPSText;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="built_in">float</span> mDeltaTime = <span class="number">0.0f</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="built_in">float</span> mFPS = <span class="number">0.0f</span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Update</span>()</span></span><br><span class="line">	&#123;</span><br><span class="line">		mDeltaTime += (Time.deltaTime - mDeltaTime) * <span class="number">0.1f</span>;</span><br><span class="line">		<span class="built_in">float</span> msec = mDeltaTime * <span class="number">1000.0f</span>;</span><br><span class="line">		mFPS = <span class="number">1.0f</span> / mDeltaTime;</span><br><span class="line">		mFPSText.text = <span class="built_in">string</span>.Format(<span class="string">&quot;&#123;0:0.0&#125; ms (&#123;1:0.&#125; fps)&quot;</span>, msec, mFPS);</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>Time Counter(用于计算时间消耗 – 比如A Star运算时间)</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Diagnostics;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TimerCounter</span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> TimerCounter TCInstance = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Stopwatch mTimer;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="built_in">string</span> mName;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">float</span> TimeSpend</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">get</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">return</span> mTimer.ElapsedMilliseconds;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">private</span> <span class="built_in">float</span> mTimeSpend;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> TimerCounter <span class="title">CreateInstance</span>()</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (TCInstance == <span class="literal">null</span>) &#123;</span><br><span class="line">			TCInstance = <span class="keyword">new</span> TimerCounter();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> TCInstance;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">DestroyInstance</span>()</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (TCInstance != <span class="literal">null</span>) &#123;</span><br><span class="line">			TCInstance = <span class="literal">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="title">TimerCounter</span>()</span></span><br><span class="line">	&#123;</span><br><span class="line">		mTimer = <span class="keyword">new</span> Stopwatch ();</span><br><span class="line">		mName = <span class="string">&quot;Default&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Start</span>(<span class="params"><span class="built_in">string</span> name</span>)</span></span><br><span class="line">	&#123;</span><br><span class="line">		mName = name;</span><br><span class="line">		mTimer.Start ();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Restart</span>(<span class="params"><span class="built_in">string</span> name</span>)</span></span><br><span class="line">	&#123;</span><br><span class="line">		mTimer.Reset ();</span><br><span class="line">		mTimer.Start ();</span><br><span class="line">		mName = name;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">End</span>()</span></span><br><span class="line">	&#123;</span><br><span class="line">		mTimer.Stop ();</span><br><span class="line"></span><br><span class="line">		mTimeSpend = mTimer.ElapsedMilliseconds;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="AI-1"><a href="#AI-1" class="headerlink" title="AI"></a>AI</h3><ol>
<li>FSM(Finite State Machine – 有限状态机)<br>通过把行为体的行为细分到几种状态来抽象行为体行为，不同状态的AI逻辑在对应的状态去编写。<br>下图来源：《Artificial Intelligence for Game》 – Ian Millington<br><img src="/img/Unity/FSM.PNG" alt="FSM"><br>游戏里把士兵的状态分为三种，MoveState, AttackState, IdleState。</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">SoldierAttackState</span> : <span class="title">SoldierState</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Soldier mSoldier; </span><br><span class="line"></span><br><span class="line">	......</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">SoldierAttackState</span> : <span class="title">SoldierState</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Soldier mSoldier; </span><br><span class="line"></span><br><span class="line">	......</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">SoldierAttackState</span> : <span class="title">SoldierState</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Soldier mSoldier; </span><br><span class="line"></span><br><span class="line">	......</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[<span class="meta">Serializable</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Soldier</span> : <span class="title">MonoBehaviour</span>, <span class="title">GameObjectType</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> SoldierState SCurrentState</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">set</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (mSCurrentState != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                mSCurrentState.ExitState();</span><br><span class="line">            &#125;</span><br><span class="line">            mSCurrentState = <span class="keyword">value</span>;</span><br><span class="line">            mSCurrentState.EnterState();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    [<span class="meta">HideInInspector</span>]</span><br><span class="line">    <span class="keyword">private</span> SoldierState mSCurrentState;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">HideInInspector</span>]</span><br><span class="line">    <span class="keyword">public</span> SoldierAttackState mSAttackState;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">HideInInspector</span>]</span><br><span class="line">    <span class="keyword">public</span> SoldierDeadState mSDeadState;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">HideInInspector</span>]</span><br><span class="line">    <span class="keyword">public</span> SoldierMoveState mSMoveState;</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Awake</span>()</span></span><br><span class="line">	&#123;</span><br><span class="line">	    mSAttackState = <span class="keyword">new</span> SoldierAttackState(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">	    mSMoveState = <span class="keyword">new</span> SoldierMoveState(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">	    mSDeadState = <span class="keyword">new</span> SoldierDeadState(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">	    ......</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Update</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (gameObject)</span><br><span class="line">        &#123;</span><br><span class="line">            mSCurrentState.UpdateState();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>Decision Trees(决策树 – 用于简单的AI(Decision making))<br>Decision Trees主要用于AI体做决策，通过对已知数据的分析判断，根据Decision Tree抉择出最终的决定（即AI行为）。（项目里我主要使用FSM而非Decision Trees）<br>下图来源：《Artificial Intelligence for Game》 – Ian Millington<br><img src="/img/Unity/AI_DecisionTree.PNG" alt="Decision Tree"></li>
<li>A Star(A Star是 <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Dijkstra's_algorithm">Dijkstra</a>（著名的最短路径算法）基础上通过一个启发因子来预估给定节点到目标节点的距离来使得路径节点搜索是向目标节点方向逼近不至于出现搜索大量无效节点的情况)<br>(<a href="http://tonytang1990.github.io/2015/10/14/Artificial-Inteligence-Study/">AI相关学习</a>)</li>
</ol>
<h4 id="A-Star"><a href="#A-Star" class="headerlink" title="A Star"></a>A Star</h4><h5 id="Searching-1"><a href="#Searching-1" class="headerlink" title="Searching"></a>Searching</h5><p>通过搜索，我发现网络上有现成的很完善的A Star的版本<br><a target="_blank" rel="noopener" href="http://arongranberg.com/astar/">A Star Pathfinding Project(Asset)</a><br>但通过使用后发现，里面所支持的Four,Six and Eight connections都不符合我的需求（每个点都和周围的八个点连通），所以最终放弃了A Star Pathfinding Project而决定自己实现自己的A Star Pathfinding</p>
<h5 id="Create-Myself-A-Star"><a href="#Create-Myself-A-Star" class="headerlink" title="Create Myself A Star"></a>Create Myself A Star</h5><h6 id="A-Star-Preperation"><a href="#A-Star-Preperation" class="headerlink" title="A Star Preperation"></a>A Star Preperation</h6><p>结合<a href="http://tonytang1990.github.io/2015/10/14/Artificial-Inteligence-Study/">Artificial-Inteligence-Study</a>的学习，让我们了解下A Star里的一些基本概念和核心思想：<br>A Star属于什么图？<br>A Star里的图属于导航图（Navigation Graph），是基于开销的图搜索(cost-based graph searches)</p>
<p>导航图信息的数据存储？<br>邻接矩阵：<br>![Adjacency _Matrix](&#x2F;img&#x2F;AI&#x2F;Adjacency _Matrix.PNG)<br>邻接表：<br><img src="/img/AI/Adjacency_List.PNG" alt="Adjacency_List"><br>邻接表用于存储稀疏图非常有效，不会浪费空间来存储空链接。(邻接矩阵会存储大量无效数据(没有连接的边))<br>这里我们只需要每个点和周边的8个点相连接，所以可以定位成稀疏图。<br>当我们初始化地图数据的时候，会把所有的点和边以及点和周边相连接边等信息存储起来。<br>大部分操作都是插入和查询(一般不涉及删除，一旦地图创建好，一般只是修改节点信息而非删除节点(如果真要删除可以通过设定节点信息为INVALID_INDEX来实现而非真正删除))。<br>为了快速查询我们采用C#里的List &lt; Node &gt; 和List &lt; List &lt; Edge &gt; &gt;来存储节点信息和边连接信息。因为我们会用一个唯一的index去标识节点，所以当我们用节点index去访问节点数据的时候是O(1)的时间复杂度，添加节点到List里也是O(1)。同理，当我们用List &lt; List &lt; Edge &gt; &gt;来存储边连接信息(邻接表)的时候，我们可以通过List[index]去访问特定节点的边连接信息(O(1)，对于边连接信息的添加和删除(这里不是O(1)主要是因为添加的时候我们需要确保不会重复添加同一个边连接信息，删除的时候要去查询找到该边连接信息)<br>这样一来所有的节点和边链接信息就都存储起来了。</p>
<p>图搜索(寻路)是怎样基于图实现的了？<br>首先我们要明确我们的搜索目的，为什么这样说了，只有明确了搜索目的我们才能制定合理的搜索策略。<br>在之前的学习<a href="http://tonytang1990.github.io/2015/10/14/Artificial-Inteligence-Study/">Artificial-Inteligence-Study</a>中提到了盲目搜索(基于广度(Stack来模拟FILO)或者深度的搜索策略(Queue来模拟FIFO))和基于开销的搜索(最短路径开销的策略)。<br>因为这里我是为了找到最短路径，所以肯定采用的是基于开销的搜索策略。<br>基于开销的搜索策略的一个重要思想是边放松，边放松的核心思想是通过存储源节点到其他节点的最短路径信息，一边探索新边一边更新该最短路径信息(如果新的边加入导致A节点到B节点有更优的最短路径，那么就更新该A节点到B节点的最短路径信息。直到找到从源节点到目标节点的最短路径信息为止。)</p>
<p>SPT(Shortest Path Tree – 最短路径树)存储的就是源节点到其他节点的最短路径信息(只存储了搜索过的)。(List<Edge>的方式存储起来，比如源节点是0，目标节点是8，那么最短路径存储即为List[0] &#x3D; Edge(0,x) List[x] &#x3D; Edge(x,y) …. List[8] &#x3D; Edge(y,8))<br>Edge的抽象Edge(From,To)，From表示初始点，To表示结束点。</p>
<p>知道了最短路径的存储，那么更重要的问题来了，这个最短路径是怎么推导出来的？<br>这里不得不提Dijstra算法和A Star算法。<br>Dijstra步骤 ：</p>
<ol>
<li>从源节点开始搜索，利用优先队列对在搜索的节点的GCost(源节点到搜索节点的距离)进行排序</li>
<li>Pop出到当前所有搜索过的节点里GCost最小的节点</li>
<li>添加到该节点的行进边作为抵达该节点的最短路径边(包含在SPT里)</li>
<li>基于该节点进行扩展搜索</li>
<li>如果在扩展搜索时有到该节点更短(GCost)的路线边出现就更新该点的GCost以及行进边信息</li>
<li>继续弹出搜索节点里GCost最小的节点</li>
<li>直到搜索到目标节点为止</li>
<li>最后通过最短路径树(SPT)从目标节点反推得出源节点到目标节点的最短路径行进路线</li>
</ol>
<p>Dijstra算法的缺点：<br>Dijkstra算法检查了太多的边。</p>
<p>Dijstra算法改进：<br>A Star – 和Dijkstra算法的唯一区别是对搜索边界上的点的开销(GCost)的计算。因为Dijstra的搜索扩展方向是由GCost决定的，所以A Star算法通过给GCost添加一个启发因子(H)来确保搜索行进方向。<br>F的计算：<br>F &#x3D; G + H<br>G是到达一个节点的累计开销， H是一个启发因子，它给出的是节点到目标节点的估计距离。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//伪代码如下</span></span><br><span class="line"><span class="comment">//添加源节点开始Dijstra算法搜索</span></span><br><span class="line">mPQ.Clear();</span><br><span class="line">mPQ.Push(mFCosts[mISource]);</span><br><span class="line"><span class="comment">//Pop出所有搜索过的节点到目标节点FCost最小的节点</span></span><br><span class="line"><span class="keyword">while</span> (!mPQ.Empty())</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">int</span> nextclosestnode = mPQ.Pop().Key;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//添加当前搜索节点里FCost最小的行进边作为最短路径的边之一</span></span><br><span class="line">    <span class="keyword">if</span> (mSearchFrontier[nextclosestnode] != <span class="literal">null</span> &amp;&amp; mSearchFrontier[nextclosestnode].IsValidEdge())</span><br><span class="line">    &#123;</span><br><span class="line">        mShortestPathTree[nextclosestnode] = mSearchFrontier[nextclosestnode];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//直到找到目标节点为止</span></span><br><span class="line">    <span class="keyword">if</span> (nextclosestnode == mITarget)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//以当前搜索节点里到目标节点最近的点为基准进行边扩展搜索</span></span><br><span class="line">    List&lt;GraphEdge&gt; edgelist = mGraph.EdgesList[nextclosestnode];</span><br><span class="line">    GraphEdge edge;</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; edgelist.Count; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        edge = edgelist[i];</span><br><span class="line">        <span class="comment">//计算该节点到目标节点的H值，用于控制搜索行进方向(A*对Dijstra算法的改进)</span></span><br><span class="line">        <span class="built_in">float</span> hcost = Heuristic_Euclid.Calculate(mGraph, mITarget, edge.To) * mHCostPercentage;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//算出到该节点的路径GCost</span></span><br><span class="line">        <span class="comment">//GCost是源节点到特定节点的实际距离(用于判断是否是源节点到特定节点更近的路线)</span></span><br><span class="line">        <span class="comment">//G+H是源节点通过特定节点到目标节点的预估距离(用于控制行进方向)</span></span><br><span class="line">        <span class="built_in">float</span> gcost = mGCosts[nextclosestnode] + edge.Cost;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//判断搜索行进的节点是否已经有任何搜索边抵达过</span></span><br><span class="line">        <span class="comment">//如果没有抵达过，添加该边到搜索列表里(mSearchFrontier)，并添加更新到该新节点的最短距离GCost和预估距离FCost(GCost+H)</span></span><br><span class="line">        <span class="comment">//同时把该FCost作为该节点通过特定节点到目标节点的估算距离添加到队列里进行排序，</span></span><br><span class="line">        <span class="comment">//用于得出搜索节点里下一个离目标节点最近的节点index</span></span><br><span class="line">        <span class="keyword">if</span> (mSearchFrontier[edge.To] != <span class="literal">null</span> &amp;&amp; !mSearchFrontier[edge.To].IsValidEdge())</span><br><span class="line">        &#123;</span><br><span class="line">            mFCosts[edge.To].Value = gcost + hcost;</span><br><span class="line">            mGCosts[edge.To] = gcost;</span><br><span class="line">            <span class="comment">//添加的是特定节点到目标节点的估算距离G+H来作为排序的依据</span></span><br><span class="line">            mPQ.Push(mFCosts[edge.To]);</span><br><span class="line"></span><br><span class="line">            mSearchFrontier[edge.To] = edge;</span><br><span class="line"></span><br><span class="line">            mAStarPathInfo.EdgesSearched++;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (mBDrawExplorePath)</span><br><span class="line">            &#123;</span><br><span class="line">                Debug.DrawLine(mGraph.Nodes[edge.From].Position, mGraph.Nodes[edge.To].Position, Color.yellow, mExplorePathRemainTime);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//如果抵达过，那么就去判断当前路线(通过当前边到该节点的路线)的GCost是否比之前记录在GCost里到达该节点的GCost更小</span></span><br><span class="line">        <span class="comment">//如果更小就说明有新的更短的路径可以抵达该节点</span></span><br><span class="line">        <span class="comment">//更新到该节点的GCost，FCost用于下一次Pop当前搜索节点里里目标节点最近(FCost)的节点</span></span><br><span class="line">        <span class="comment">//同时更新到该节点的最短路径边</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (gcost &lt; mGCosts[edge.To])</span><br><span class="line">        &#123;</span><br><span class="line">            mFCosts[edge.To].Value = gcost + hcost;</span><br><span class="line">            mGCosts[edge.To] = gcost;</span><br><span class="line"></span><br><span class="line">            mPQ.ChangePriority(edge.To);</span><br><span class="line"></span><br><span class="line">            mSearchFrontier[edge.To] = edge;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面有一个关键的点(PriorityQueue)，用于得到所有搜索节点到目标节点的FCost最小的节点。<br>这里对于节点的操作主要是插入和修改。<br>为了快速得到当前搜索节点里里目标节点的估算距离最近的节点，我们需要对当前所有的搜索节点进行排序。<br>而这里每一次排序的时间复杂度很大程度就决定了A Star的时间消耗。<br>参考<a href="http://tonytang1990.github.io/2015/07/11/Sort-Algorithm/">排序算法概念</a>的学习<br>可以知道借助堆的特性，我们可以很容易的得到最大最小值。<br>原本堆排序要经历下列步骤:</p>
<ol>
<li>Init heap(创建最大堆（Build_Max_Heap）：初始化堆数据)</li>
<li>Adjust heap(最大堆调整（Max_Heapify）：将堆的末端子节点作调整，使得子节点永远小于父节点) – O(Log(n))</li>
<li>Sort heap(堆排序（HeapSort）：移除位在第一个数据的根节点，并做最大堆调整的递归运算) – O(n)<br>但这里我们并不需要对堆进行完整的排序，我们只需每次插入或删除或修改的时候能得到最大或最小值即可(即只需要Adjust Heap即可)<br>这样一来每一次插入，删除或修改都只需O(Log(n))的时间复杂度。</li>
</ol>
<p>了解了理论，接下来一步一步看一下如何实现A Star算法的：<br>首先我们需要抽象出导航图里的节点和边<br>NavGraphNode里的mIsWall和mIsJumpable后续会讲到为什么会有这两个成员变量<br>e.g.</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">GraphEdge</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">GraphEdge</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mFrom = (<span class="built_in">int</span>)E_NODE_INDEX.INVALID_NODE;</span><br><span class="line">        mTo = (<span class="built_in">int</span>)E_NODE_INDEX.INVALID_NODE;</span><br><span class="line">        mCost = <span class="number">0.0f</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> From</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> mFrom;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">set</span></span><br><span class="line">        &#123;</span><br><span class="line">            Debug.Assert(<span class="keyword">value</span> &gt;= <span class="number">0</span>, <span class="string">&quot;mFrom must great or equal to 0&quot;</span>);</span><br><span class="line">            mFrom = <span class="keyword">value</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span> mFrom;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> To</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> mTo;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">set</span></span><br><span class="line">        &#123;</span><br><span class="line">            Debug.Assert(<span class="keyword">value</span> &gt;= <span class="number">0</span>, <span class="string">&quot;mTo must great or equal to 0&quot;</span>);</span><br><span class="line">            mTo = <span class="keyword">value</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span> mTo;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">float</span> Cost</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> mCost;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">set</span></span><br><span class="line">        &#123;</span><br><span class="line">            Debug.Assert(<span class="keyword">value</span> &gt;= <span class="number">0</span>, <span class="string">&quot;mCost must great or equal to 0&quot;</span>);</span><br><span class="line">            mCost = <span class="keyword">value</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">float</span> mCost;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">NavGraphNode</span> : <span class="title">GraphNode</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="title">NavGraphNode</span>()</span></span><br><span class="line">	&#123;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">NavGraphNode</span>(<span class="params"><span class="built_in">int</span> index,Vector3 pos, <span class="built_in">float</span> weight, <span class="built_in">bool</span> iswall</span>)</span></span><br><span class="line">	&#123;</span><br><span class="line">		Index = index;</span><br><span class="line">		mPosition = pos;</span><br><span class="line">		mWeight = weight;</span><br><span class="line">		mIsWall = iswall;</span><br><span class="line">		mIsJumpable = <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">int</span> Index</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">get</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">return</span> mIndex;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">set</span></span><br><span class="line">		&#123;</span><br><span class="line">			mIndex = <span class="keyword">value</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">private</span> <span class="built_in">int</span> mIndex;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> Vector3 Position</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">get</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">return</span> mPosition;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">set</span></span><br><span class="line">		&#123;</span><br><span class="line">			mPosition = <span class="keyword">value</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">private</span> Vector3 mPosition;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">float</span> Weight</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">get</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">return</span> mWeight;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">set</span></span><br><span class="line">		&#123;</span><br><span class="line">			mWeight = <span class="keyword">value</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">private</span> <span class="built_in">float</span> mWeight;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">bool</span> IsWall</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">get</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">return</span> mIsWall;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">set</span></span><br><span class="line">		&#123;</span><br><span class="line">			mIsWall = <span class="keyword">value</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">private</span> <span class="built_in">bool</span> mIsWall;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">bool</span> IsJumpable</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">get</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">return</span> mIsJumpable;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">set</span></span><br><span class="line">		&#123;</span><br><span class="line">			mIsJumpable = <span class="keyword">value</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">private</span> <span class="built_in">bool</span> mIsJumpable;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>抽象了节点和边后，我们就可以初始化我们的地图数据了</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">CreateGraph</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">	mNavGraph = <span class="keyword">new</span> SparseGraph&lt;NavGraphNode, GraphEdge&gt; (mRow * mColumn);</span><br><span class="line">	</span><br><span class="line">	mNavGraph.BDrawMap = mBDrawMap;</span><br><span class="line"></span><br><span class="line">	Vector3 nodeposition = <span class="keyword">new</span> Vector3 ();</span><br><span class="line">	<span class="built_in">int</span> nextindex = <span class="number">0</span>;</span><br><span class="line">	<span class="comment">//SparseGraph nodes data</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="built_in">int</span> rw = <span class="number">0</span>; rw &lt; mRow; rw++) &#123;</span><br><span class="line">		<span class="keyword">for</span> (<span class="built_in">int</span> col = <span class="number">0</span>; col &lt; mColumn; col++) &#123;</span><br><span class="line">			nodeposition = <span class="keyword">new</span> Vector3 (rw, <span class="number">0.0f</span>, col);</span><br><span class="line">			nextindex = mNavGraph.NextFreeNodeIndex;</span><br><span class="line">			mNavGraph.AddNode (<span class="keyword">new</span> NavGraphNode (nextindex, nodeposition, <span class="number">0.0f</span>, <span class="literal">false</span>));</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//SparseGraph edges data</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="built_in">int</span> rw = <span class="number">0</span>; rw &lt; mRow; rw++) </span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">for</span> (<span class="built_in">int</span> col = <span class="number">0</span>; col &lt; mColumn; col++) </span><br><span class="line">		&#123;</span><br><span class="line">			CreateAllNeighboursToGridNode(rw, col, mRow, mColumn);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	mTotalNodes = mNavGraph.NumNodes();</span><br><span class="line">	mTotalEdges = mNavGraph.NumEdges ();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样一来我们的地图基本数据就都创建完成了。<br>在实现A Star之前，我们需要一个优先队列来排序我们所搜索的所有边的优先级。</p>
<h6 id="PriorityQueue"><a href="#PriorityQueue" class="headerlink" title="PriorityQueue"></a>PriorityQueue</h6><p>通过Search我发现C#没有自带的优先队列，所以需要自己实现<br>这里的优先队列主要要实现排第一位的永远是cost最低的（其他并不需要有序，因为A Star里面是通过pop出cost最低的边来进行搜索行进的）<br>这里我用到了<a href="http://tonytang1990.github.io/2015/07/11/Sort-Algorithm/">堆排序(Heap Sort)</a>：<br>平均时间复杂度：O(n log(n))<br>最坏时间复杂度：O(n log(n))<br>最优时间复杂度：O(n log(n)) (时间复杂度都跟堆的深度和数据长度相关，无可避免的需要去做堆调整和堆排序<br>所以最坏时间复杂度和最优时间复杂度都是O(nlog(n)<br>因为我们只需要确保第一个是cost最低的，所以我们并不需要每一次都完整的排序整个堆（完整排序的时间复杂度是n * Log(n)），我们只需要在每一次insert和pop的时候重新掉整一下堆即可（这样一来就可以在Log(n)的时间内保证第一个是cost最低的）</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine.Assertions;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PriorityQueue</span>&lt;<span class="title">T1</span>, <span class="title">T2</span>&gt;</span><br><span class="line">&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">PriorityQueue</span>()</span></span><br><span class="line">	&#123;</span><br><span class="line">		mHeap = <span class="keyword">new</span> Heap&lt;T1, T2&gt;();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">PriorityQueue</span>(<span class="params"><span class="built_in">int</span> size</span>)</span></span><br><span class="line">	&#123;</span><br><span class="line">		mHeap = <span class="keyword">new</span> Heap&lt;T1, T2&gt; (size);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">PriorityQueue</span>(<span class="params">Heap&lt;T1, T2&gt; heap</span>)</span></span><br><span class="line">	&#123;</span><br><span class="line">		mHeap = heap;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">PriorityQueue</span>(<span class="params">List&lt;Pair&lt;T1,T2&gt;&gt; key</span>)</span></span><br><span class="line">	&#123;</span><br><span class="line">		mHeap = <span class="keyword">new</span> Heap&lt;T1, T2&gt; (key);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">Empty</span>()</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> (mHeap.Size() == <span class="number">0</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Clear</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mHeap.Clear();</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Push</span>(<span class="params">Pair&lt;T1, T2&gt; kvp</span>)</span></span><br><span class="line">	&#123;</span><br><span class="line">		mHeap.Insert(kvp);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> Pair&lt;T1, T2&gt; <span class="title">Pop</span>()</span></span><br><span class="line">	&#123;</span><br><span class="line">		Pair&lt;T1,T2&gt; result = mHeap.Top();</span><br><span class="line">		mHeap.RemoveTop();</span><br><span class="line">		<span class="keyword">return</span> result;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="built_in">int</span> <span class="title">Size</span>()</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> mHeap.Size();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> Pair&lt;T1, T2&gt; <span class="title">Top</span>()</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> mHeap.Top(); ;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ChangePriority</span>(<span class="params">T1 index</span>)</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">//Assert.IsTrue (index &gt;= 0 &amp;&amp; index &lt; mHeap.Size ());</span></span><br><span class="line">		<span class="built_in">int</span> i = <span class="number">0</span>;</span><br><span class="line">		i  = mHeap.FindSpecificKeyIndex(index);</span><br><span class="line">		mHeap.HeapifyFromEndToBeginning (i);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">PrintOutAllMember</span>()</span></span><br><span class="line">	&#123;</span><br><span class="line">		mHeap.PrintOutAllMember();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> Heap&lt;T1, T2&gt; mHeap;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Heap</span>&lt;<span class="title">T1</span>, <span class="title">T2</span>&gt;</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">private</span> List&lt;Pair&lt;T1, T2&gt;&gt; mList;</span><br><span class="line">	<span class="keyword">private</span> IComparer&lt;T2&gt; mComparer;</span><br><span class="line">	<span class="keyword">private</span> IComparer&lt;T1&gt; mCompareKey;</span><br><span class="line">	<span class="keyword">private</span> <span class="built_in">int</span> mCount;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Heap</span>()</span></span><br><span class="line">	&#123;</span><br><span class="line">		mList = <span class="keyword">new</span> List&lt;Pair&lt;T1, T2&gt;&gt;();</span><br><span class="line">		mComparer = Comparer&lt;T2&gt;.Default;</span><br><span class="line">		mCompareKey = Comparer&lt;T1&gt;.Default;</span><br><span class="line">		mCount = <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Heap</span>(<span class="params"><span class="built_in">int</span> size</span>)</span></span><br><span class="line">	&#123;</span><br><span class="line">		mList = <span class="keyword">new</span> List&lt;Pair&lt;T1, T2&gt;&gt;(size);</span><br><span class="line">		mComparer = Comparer&lt;T2&gt;.Default;</span><br><span class="line">		mCompareKey = Comparer&lt;T1&gt;.Default;</span><br><span class="line">		mCount = <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Heap</span>(<span class="params">List&lt;Pair&lt;T1, T2&gt;&gt; list</span>)</span></span><br><span class="line">	&#123;</span><br><span class="line">		mList = list;</span><br><span class="line">		mCount = list.Count;</span><br><span class="line">		mComparer = Comparer&lt;T2&gt;.Default;</span><br><span class="line">		mCompareKey = Comparer&lt;T1&gt;.Default;</span><br><span class="line">		BuildingHeap();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Clear</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mList.Clear();</span><br><span class="line">        mCount = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="built_in">int</span> <span class="title">Size</span>()</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (mList != <span class="literal">null</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">return</span> mCount;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//O(Log(N))</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">RemoveTop</span>()</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (mList != <span class="literal">null</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			mList[<span class="number">0</span>] = mList[mCount - <span class="number">1</span>];</span><br><span class="line">			mList.RemoveAt(mCount<span class="number">-1</span>);</span><br><span class="line">			mCount--;</span><br><span class="line">			HeapifyFromBeginningToEnd(<span class="number">0</span>,mCount - <span class="number">1</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> Pair&lt;T1, T2&gt; <span class="title">Top</span>()</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (mList != <span class="literal">null</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">return</span> mList[<span class="number">0</span>];</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">//No more member</span></span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> InvalidOperationException(<span class="string">&quot;Empty heap.&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="built_in">int</span> <span class="title">FindSpecificKeyIndex</span>(<span class="params">T1 key</span>)</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> mList.FindIndex (x =&gt; mCompareKey.Compare (x.Key, key) == <span class="number">0</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">PrintOutAllMember</span>()</span></span><br><span class="line">	&#123;</span><br><span class="line">        Pair&lt;T1, T2&gt; valuepair;</span><br><span class="line">		<span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; mList.Count; i++)</span><br><span class="line">		&#123;</span><br><span class="line">            valuepair = mList[i];</span><br><span class="line">			Debug.Log(valuepair.ToString());</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//O(Log(N))</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Insert</span>(<span class="params">Pair&lt;T1, T2&gt; valuepair</span>)</span></span><br><span class="line">	&#123;</span><br><span class="line">		mList.Add(valuepair);</span><br><span class="line">		mCount++;</span><br><span class="line">		HeapifyFromEndToBeginning(mCount - <span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//调整堆确保堆是最大堆，这里花O(log(n))，跟堆的深度有关</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">HeapifyFromBeginningToEnd</span>(<span class="params"><span class="built_in">int</span> parentindex, <span class="built_in">int</span> length</span>)</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">int</span> max_index = parentindex;</span><br><span class="line">		<span class="built_in">int</span> left_child_index = parentindex * <span class="number">2</span> + <span class="number">1</span>;</span><br><span class="line">		<span class="built_in">int</span> right_child_index = parentindex * <span class="number">2</span> + <span class="number">2</span>;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//Chose biggest one between parent and left&amp;right child</span></span><br><span class="line">		<span class="keyword">if</span> (left_child_index &lt; length &amp;&amp; mComparer.Compare(mList[left_child_index].Value, mList[max_index].Value) &lt; <span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			max_index = left_child_index;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">if</span> (right_child_index &lt; length &amp;&amp; mComparer.Compare(mList[right_child_index].Value, mList[max_index].Value) &lt; <span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			max_index = right_child_index;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//If any child is bigger than parent, </span></span><br><span class="line">		<span class="comment">//then we swap it and do adjust for child again to make sure meet max heap definition</span></span><br><span class="line">		<span class="keyword">if</span> (max_index != parentindex)</span><br><span class="line">		&#123;</span><br><span class="line">			Swap(max_index, parentindex);</span><br><span class="line">			HeapifyFromBeginningToEnd(max_index, length);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//O(log(N))</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">HeapifyFromEndToBeginning</span>(<span class="params"><span class="built_in">int</span> index</span>)</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span>(index &gt;= mCount)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">while</span> (index &gt; <span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">int</span> parentindex = (index - <span class="number">1</span>) / <span class="number">2</span>;</span><br><span class="line">			<span class="keyword">if</span>(mComparer.Compare(mList[parentindex].Value,mList[index].Value) &gt; <span class="number">0</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				Swap(parentindex, index);</span><br><span class="line">				index = parentindex;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//通过初试数据构建最大堆</span></span><br><span class="line">	<span class="comment"><span class="doctag">///</span>/O(N*Log(N))</span></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">BuildingHeap</span>()</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (mList != <span class="literal">null</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">for</span> (<span class="built_in">int</span> i = mList.Count / <span class="number">2</span> - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="comment">//1.2 Adjust heap</span></span><br><span class="line">				<span class="comment">//Make sure meet max heap definition</span></span><br><span class="line">				<span class="comment">//Max Heap definition:</span></span><br><span class="line">				<span class="comment">// (k(i) &gt;= k(2i) &amp;&amp; k(i) &gt;= k(2i+1))   (1 &lt;= i &lt;= n/2)</span></span><br><span class="line">				HeapifyFromBeginningToEnd(i, mList.Count);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment"><span class="doctag">///</span>/O(N*log(N))</span></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">HeapSort</span>()</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (mList != <span class="literal">null</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">//Steps:</span></span><br><span class="line">			<span class="comment">// 1. Build heap</span></span><br><span class="line">			<span class="comment">// 1.1 Init heap</span></span><br><span class="line">			<span class="comment">// 1.2 Adjust heap</span></span><br><span class="line">			<span class="comment">// 2. Sort heap</span></span><br><span class="line">			</span><br><span class="line">			<span class="comment">//1. Build max heap</span></span><br><span class="line">			<span class="comment">// 1.1 Init heap</span></span><br><span class="line">			<span class="comment">//Assume we construct max heap</span></span><br><span class="line">			BuildingHeap();</span><br><span class="line">			<span class="comment">//2. Sort heap</span></span><br><span class="line">			<span class="comment">//这里花O(n)，跟数据数量有关</span></span><br><span class="line">			<span class="keyword">for</span> (<span class="built_in">int</span> i = mList.Count - <span class="number">1</span>; i &gt; <span class="number">0</span>; i--)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="comment">//swap first element and last element</span></span><br><span class="line">				<span class="comment">//do adjust heap process again to make sure the new array are still max heap</span></span><br><span class="line">				Swap(i, <span class="number">0</span>);</span><br><span class="line">				<span class="comment">//Due to we already building max heap before,</span></span><br><span class="line">				<span class="comment">//so  we just need to adjust for index 0 after we swap first and last element</span></span><br><span class="line">				HeapifyFromBeginningToEnd(<span class="number">0</span>, i);</span><br><span class="line">			&#125;            </span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			Debug.Log(<span class="string">&quot;mList == null&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Swap</span>(<span class="params"><span class="built_in">int</span> id1, <span class="built_in">int</span> id2</span>)</span></span><br><span class="line">	&#123;</span><br><span class="line">		Pair&lt;T1, T2&gt; temp;</span><br><span class="line">		temp = mList[id1];</span><br><span class="line">		mList[id1] = mList[id2];</span><br><span class="line">		mList[id2] = temp;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Pair</span>&lt;<span class="title">T1</span>, <span class="title">T2</span>&gt;</span><br><span class="line">&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Pair</span>()</span></span><br><span class="line">	&#123;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Pair</span>(<span class="params">T1 k, T2 v</span>)</span></span><br><span class="line">	&#123;</span><br><span class="line">		Key = k;</span><br><span class="line">		Value = v;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="built_in">string</span> <span class="title">ToString</span>()</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> String.Format(<span class="string">&quot;[&#123;0&#125;,&#123;1&#125;]&quot;</span>,Key,Value);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> T1 Key</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">get</span>;</span><br><span class="line">		<span class="keyword">set</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> T2 Value</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">get</span>;</span><br><span class="line">		<span class="keyword">set</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样一来我们所需要的优先队列就完成了。</p>
<h6 id="A-Star-1"><a href="#A-Star-1" class="headerlink" title="A Star"></a>A Star</h6><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> UnityEngine.Assertions;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">SearchAStar</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">struct</span> PathInfo</span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> List&lt;<span class="built_in">int</span>&gt; PathToTarget</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> mPathToTarget;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">set</span></span><br><span class="line">            &#123;</span><br><span class="line">                mPathToTarget = <span class="keyword">value</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">private</span> List&lt;<span class="built_in">int</span>&gt; mPathToTarget;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> List&lt;Vector3&gt; MovementPathToTarget</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> mMovementPathToTarget;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">set</span></span><br><span class="line">            &#123;</span><br><span class="line">                mMovementPathToTarget = <span class="keyword">value</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">private</span> List&lt;Vector3&gt; mMovementPathToTarget;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">bool</span> IsWallInPathToTarget</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> mIsWallInPathToTarget;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">set</span></span><br><span class="line">            &#123;</span><br><span class="line">                mIsWallInPathToTarget = <span class="keyword">value</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">private</span> <span class="built_in">bool</span> mIsWallInPathToTarget;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">int</span> WallInPathToTargetIndex</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> mWallInPathToTargetIndex;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">set</span></span><br><span class="line">            &#123;</span><br><span class="line">                mWallInPathToTargetIndex = <span class="keyword">value</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">private</span> <span class="built_in">int</span> mWallInPathToTargetIndex;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">float</span> CostToTarget</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> mCostToTarget;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">set</span></span><br><span class="line">            &#123;</span><br><span class="line">                mCostToTarget = <span class="keyword">value</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">private</span> <span class="built_in">float</span> mCostToTarget;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">int</span> ITarget</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">set</span></span><br><span class="line">            &#123;</span><br><span class="line">                mITarget = <span class="keyword">value</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">get</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> mITarget;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">private</span> <span class="built_in">int</span> mITarget;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">int</span> OriginalTarget</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> mOriginalTarget;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">set</span></span><br><span class="line">            &#123;</span><br><span class="line">                mOriginalTarget = <span class="keyword">value</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">private</span> <span class="built_in">int</span> mOriginalTarget;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">int</span> NodesSearched</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> mNodesSearched;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">set</span></span><br><span class="line">            &#123;</span><br><span class="line">                mNodesSearched = <span class="keyword">value</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">private</span> <span class="built_in">int</span> mNodesSearched;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">int</span> EdgesSearched</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> mEdgesSearched;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">set</span></span><br><span class="line">            &#123;</span><br><span class="line">                mEdgesSearched = <span class="keyword">value</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">private</span> <span class="built_in">int</span> mEdgesSearched;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//this list of edges is used to store any subtree returned from any of the graph algorithms</span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        public List&lt;GraphEdge&gt; SubTree</span></span><br><span class="line"><span class="comment">        &#123;</span></span><br><span class="line"><span class="comment">            get</span></span><br><span class="line"><span class="comment">            &#123;</span></span><br><span class="line"><span class="comment">                return mSubTree;</span></span><br><span class="line"><span class="comment">            &#125;</span></span><br><span class="line"><span class="comment">            set</span></span><br><span class="line"><span class="comment">            &#123;</span></span><br><span class="line"><span class="comment">                mSubTree = value;</span></span><br><span class="line"><span class="comment">            &#125;</span></span><br><span class="line"><span class="comment">        &#125;</span></span><br><span class="line"><span class="comment">        private List&lt;GraphEdge&gt; mSubTree;</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        public PathInfo()</span></span><br><span class="line"><span class="comment">        &#123;</span></span><br><span class="line"><span class="comment">            ResetPathInfo();</span></span><br><span class="line"><span class="comment">        &#125;</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> PathInfo <span class="title">DeepCopy</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            PathInfo pi = (PathInfo)<span class="keyword">this</span>.MemberwiseClone();</span><br><span class="line">            pi.PathToTarget = <span class="keyword">new</span> List&lt;<span class="built_in">int</span>&gt;(mPathToTarget);</span><br><span class="line">            pi.MovementPathToTarget = <span class="keyword">new</span> List&lt;Vector3&gt;(mMovementPathToTarget);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> pi;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ResetPathInfo</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            mIsWallInPathToTarget = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">            mWallInPathToTargetIndex = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (mPathToTarget != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                mPathToTarget.Clear();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                mPathToTarget = <span class="keyword">new</span> List&lt;<span class="built_in">int</span>&gt;();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (mMovementPathToTarget != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                mMovementPathToTarget.Clear();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                mMovementPathToTarget = <span class="keyword">new</span> List&lt;Vector3&gt;();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            mNodesSearched = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">            mEdgesSearched = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">            mCostToTarget = <span class="number">0.0f</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">SearchAStar</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SearchAStar</span>(<span class="params">SparseGraph&lt;NavGraphNode, GraphEdge&gt; graph</span></span></span><br><span class="line"><span class="params"><span class="function">                       , <span class="built_in">int</span> source</span></span></span><br><span class="line"><span class="params"><span class="function">                       , <span class="built_in">int</span> target</span></span></span><br><span class="line"><span class="params"><span class="function">                       , <span class="built_in">bool</span> isignorewall</span></span></span><br><span class="line"><span class="params"><span class="function">                       , <span class="built_in">float</span> strickdistance</span></span></span><br><span class="line"><span class="params"><span class="function">                       , <span class="built_in">float</span> hcostpercentage</span></span></span><br><span class="line"><span class="params"><span class="function">                       , <span class="built_in">bool</span> drawexplorepath</span></span></span><br><span class="line"><span class="params"><span class="function">                       , <span class="built_in">float</span> explorepathremaintime</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        mGraph = graph;</span><br><span class="line">        mPQ = <span class="keyword">new</span> PriorityQueue&lt;<span class="built_in">int</span>, <span class="built_in">float</span>&gt;((<span class="built_in">int</span>)Mathf.Sqrt(mGraph.NumNodes()));</span><br><span class="line">        mGCosts = <span class="keyword">new</span> List&lt;<span class="built_in">float</span>&gt;(graph.NumNodes());</span><br><span class="line">        mFCosts = <span class="keyword">new</span> List&lt;Pair&lt;<span class="built_in">int</span>, <span class="built_in">float</span>&gt;&gt;(graph.NumNodes());</span><br><span class="line">        mShortestPathTree = <span class="keyword">new</span> List&lt;GraphEdge&gt;(graph.NumNodes());</span><br><span class="line">        mSearchFrontier = <span class="keyword">new</span> List&lt;GraphEdge&gt;(graph.NumNodes());</span><br><span class="line">        <span class="comment">//Init G cost and F cost and Cost value</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; graph.NumNodes(); i++)</span><br><span class="line">        &#123;</span><br><span class="line">            mGCosts.Add(<span class="number">0.0f</span>);</span><br><span class="line">            mFCosts.Add(<span class="keyword">new</span> Pair&lt;<span class="built_in">int</span>, <span class="built_in">float</span>&gt;(i, <span class="number">0.0f</span>));</span><br><span class="line">            mShortestPathTree.Add(<span class="keyword">new</span> GraphEdge());</span><br><span class="line">            mSearchFrontier.Add(<span class="keyword">new</span> GraphEdge());</span><br><span class="line">        &#125;</span><br><span class="line">        mISource = source;</span><br><span class="line">        mITarget = target;</span><br><span class="line">        mOriginalTarget = target;</span><br><span class="line"></span><br><span class="line">        Assert.IsTrue(hcostpercentage &gt;= <span class="number">0</span>);</span><br><span class="line">        mHCostPercentage = hcostpercentage;</span><br><span class="line"></span><br><span class="line">        mBDrawExplorePath = drawexplorepath;</span><br><span class="line"></span><br><span class="line">        mExplorePathRemainTime = explorepathremaintime;</span><br><span class="line"></span><br><span class="line">        mAStarPathInfo = <span class="keyword">new</span> PathInfo();</span><br><span class="line"></span><br><span class="line">        mIsIgnoreWall = isignorewall;</span><br><span class="line"></span><br><span class="line">        mStrickDistance = strickdistance;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Search(mStrickDistance, mIsIgnoreWall);</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//GeneratePathToTargetInfo();</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">UpdateSearch</span>(<span class="params"><span class="built_in">int</span> sourceindex, <span class="built_in">int</span> targetindex, <span class="built_in">float</span> strickdistance</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Assert.IsTrue(mISource &gt;= <span class="number">0</span> &amp;&amp; mISource &lt; mGraph.NumNodes());</span><br><span class="line">        Assert.IsTrue(mITarget &gt;= <span class="number">0</span> &amp;&amp; mITarget &lt; mGraph.NumNodes());</span><br><span class="line"></span><br><span class="line">        AstarReset(sourceindex, targetindex, strickdistance);</span><br><span class="line"></span><br><span class="line">        Search(mStrickDistance, mIsIgnoreWall);</span><br><span class="line"></span><br><span class="line">        GeneratePathToTargetInfo();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">AstarReset</span>(<span class="params"><span class="built_in">int</span> sourceindex, <span class="built_in">int</span> targetindex, <span class="built_in">float</span> strickdistance</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        mISource = sourceindex;</span><br><span class="line"></span><br><span class="line">        mITarget = targetindex;</span><br><span class="line"></span><br><span class="line">        mOriginalTarget = targetindex;</span><br><span class="line"></span><br><span class="line">        mStrickDistance = strickdistance;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; mGraph.NumNodes(); i++)</span><br><span class="line">        &#123;</span><br><span class="line">            mGCosts[i] = <span class="number">0.0f</span>;</span><br><span class="line">            mFCosts[i].Value = <span class="number">0.0f</span>;</span><br><span class="line">            mShortestPathTree[i].Reset();</span><br><span class="line">            mSearchFrontier[i].Reset();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mAStarPathInfo.ResetPathInfo();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">bool</span> mIsIgnoreWall;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">float</span> StrickDistance</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">set</span></span><br><span class="line">        &#123;</span><br><span class="line">            mStrickDistance = <span class="keyword">value</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">float</span> mStrickDistance;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> PathInfo AStarPathInfo</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> mAStarPathInfo;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">set</span></span><br><span class="line">        &#123;</span><br><span class="line">            mAStarPathInfo = <span class="keyword">value</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> PathInfo mAStarPathInfo;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">GeneratePathToTargetInfo</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mAStarPathInfo.PathToTarget.Clear();</span><br><span class="line">        mAStarPathInfo.MovementPathToTarget.Clear();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mITarget &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">int</span> nd = mITarget;</span><br><span class="line"></span><br><span class="line">        mAStarPathInfo.PathToTarget.Add(nd);</span><br><span class="line"></span><br><span class="line">        mAStarPathInfo.MovementPathToTarget.Add(mGraph.Nodes[nd].Position);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> ((nd != mISource) &amp;&amp; (mShortestPathTree[nd] != <span class="literal">null</span>) &amp;&amp; mShortestPathTree[nd].IsValidEdge())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//Debug.DrawLine(mGraph.Nodes[mShortestPathTree[nd].From].Position,mGraph.Nodes[nd].Position,Color.green, Mathf.Infinity);</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!mIsIgnoreWall)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//No matter the wall in path is jumpable or not, we should record it as useful information</span></span><br><span class="line">                <span class="keyword">if</span> (mGraph.Nodes[nd].IsWall <span class="comment">/*&amp;&amp; !mGraph.Nodes[nd].IsJumpable*/</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    mAStarPathInfo.IsWallInPathToTarget = <span class="literal">true</span>;</span><br><span class="line">                    mAStarPathInfo.WallInPathToTargetIndex = nd;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            nd = mShortestPathTree[nd].From;</span><br><span class="line"></span><br><span class="line">            mAStarPathInfo.PathToTarget.Add(nd);</span><br><span class="line"></span><br><span class="line">            mAStarPathInfo.MovementPathToTarget.Add(mGraph.Nodes[nd].Position);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mAStarPathInfo.CostToTarget = GetCostToTarget();</span><br><span class="line"></span><br><span class="line">        mAStarPathInfo.ITarget = mITarget;</span><br><span class="line"></span><br><span class="line">        mAStarPathInfo.OriginalTarget = mOriginalTarget;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;GraphEdge&gt; <span class="title">GetSPT</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> mShortestPathTree;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="built_in">float</span> <span class="title">GetCostToTarget</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> mGCosts[mITarget];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> SparseGraph&lt;NavGraphNode, GraphEdge&gt; mGraph;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> PriorityQueue&lt;<span class="built_in">int</span>, <span class="built_in">float</span>&gt; mPQ;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;<span class="built_in">float</span>&gt; mGCosts;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;Pair&lt;<span class="built_in">int</span>, <span class="built_in">float</span>&gt;&gt; mFCosts;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> List&lt;GraphEdge&gt; SPT</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> mShortestPathTree;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> List&lt;GraphEdge&gt; mShortestPathTree;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">	public List&lt;float&gt; CostToTargetNode </span></span><br><span class="line"><span class="comment">	&#123;</span></span><br><span class="line"><span class="comment">		get &#123;</span></span><br><span class="line"><span class="comment">			return mCostToTargetNode;</span></span><br><span class="line"><span class="comment">		&#125;</span></span><br><span class="line"><span class="comment">		set</span></span><br><span class="line"><span class="comment">		&#123;</span></span><br><span class="line"><span class="comment">			mCostToTargetNode = value;</span></span><br><span class="line"><span class="comment">		&#125;</span></span><br><span class="line"><span class="comment">	&#125;</span></span><br><span class="line"><span class="comment">	private List&lt;float&gt; mCostToTargetNode;</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;GraphEdge&gt; mSearchFrontier;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> ISource</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">set</span></span><br><span class="line">        &#123;</span><br><span class="line">            mISource = <span class="keyword">value</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span> mISource;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> ITarget</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">set</span></span><br><span class="line">        &#123;</span><br><span class="line">            mITarget = <span class="keyword">value</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> mITarget;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span> mITarget;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> OriginalTarget</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> mOriginalTarget;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">set</span></span><br><span class="line">        &#123;</span><br><span class="line">            mOriginalTarget = <span class="keyword">value</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span> mOriginalTarget;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">float</span> mHCostPercentage;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">bool</span> mBDrawExplorePath;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">float</span> mExplorePathRemainTime;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//The A* search algorithm</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Search</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mPQ.Clear();</span><br><span class="line"></span><br><span class="line">        mPQ.Push(mFCosts[mISource]);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//mSearchFrontier [mISource] = new GraphEdge (mISource, mISource, 0.0f);</span></span><br><span class="line">        mSearchFrontier[mISource].From = mISource;</span><br><span class="line">        mSearchFrontier[mISource].To = mISource;</span><br><span class="line">        mSearchFrontier[mISource].Cost = <span class="number">0.0f</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (!mPQ.Empty())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//Get lowest cost node from the queue</span></span><br><span class="line">            <span class="built_in">int</span> nextclosestnode = mPQ.Pop().Key;</span><br><span class="line"></span><br><span class="line">            mAStarPathInfo.NodesSearched++;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//move this node from the frontier to the spanning tree</span></span><br><span class="line">            <span class="keyword">if</span> (mSearchFrontier[nextclosestnode] != <span class="literal">null</span> &amp;&amp; mSearchFrontier[nextclosestnode].IsValidEdge())</span><br><span class="line">            &#123;</span><br><span class="line">                mShortestPathTree[nextclosestnode] = mSearchFrontier[nextclosestnode];</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//If the target has been found exit</span></span><br><span class="line">            <span class="keyword">if</span> (nextclosestnode == mITarget)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//Now to test all the edges attached to this node</span></span><br><span class="line">            List&lt;GraphEdge&gt; edgelist = mGraph.EdgesList[nextclosestnode];</span><br><span class="line">            GraphEdge edge;</span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; edgelist.Count; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                edge = edgelist[i];</span><br><span class="line">                <span class="comment">//calculate the heuristic cost from this node to the target (H)</span></span><br><span class="line">                <span class="built_in">float</span> hcost = Heuristic_Euclid.Calculate(mGraph, mITarget, edge.To) * mHCostPercentage;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//calculate the &#x27;real&#x27; cost to this node from the source (G)</span></span><br><span class="line">                <span class="built_in">float</span> gcost = mGCosts[nextclosestnode] + edge.Cost;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//if the node has not been added to the frontier, add it and update the G and F costs</span></span><br><span class="line">                <span class="keyword">if</span> (mSearchFrontier[edge.To] != <span class="literal">null</span> &amp;&amp; !mSearchFrontier[edge.To].IsValidEdge())</span><br><span class="line">                &#123;</span><br><span class="line">                    mFCosts[edge.To].Value = gcost + hcost;</span><br><span class="line">                    mGCosts[edge.To] = gcost;</span><br><span class="line"></span><br><span class="line">                    mPQ.Push(mFCosts[edge.To]);</span><br><span class="line"></span><br><span class="line">                    mSearchFrontier[edge.To] = edge;</span><br><span class="line"></span><br><span class="line">                    mAStarPathInfo.EdgesSearched++;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (mBDrawExplorePath)</span><br><span class="line">                    &#123;</span><br><span class="line">                        Debug.DrawLine(mGraph.Nodes[edge.From].Position, mGraph.Nodes[edge.To].Position, Color.yellow, mExplorePathRemainTime);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//if this node is already on the frontier but the cost to get here</span></span><br><span class="line">                <span class="comment">//is cheaper than has been found previously, update the node</span></span><br><span class="line">                <span class="comment">//cost and frontier accordingly</span></span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (gcost &lt; mGCosts[edge.To])</span><br><span class="line">                &#123;</span><br><span class="line">                    mFCosts[edge.To].Value = gcost + hcost;</span><br><span class="line">                    mGCosts[edge.To] = gcost;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//Due to some node&#x27;s f cost has been changed</span></span><br><span class="line">                    <span class="comment">//we should reoder the priority queue to make sure we pop up the lowest fcost node first</span></span><br><span class="line">                    <span class="comment">//compare the fcost will make sure we search the path in the right direction</span></span><br><span class="line">                    <span class="comment">//h cost is the key to search in the right direction</span></span><br><span class="line">                    mPQ.ChangePriority(edge.To);</span><br><span class="line"></span><br><span class="line">                    mSearchFrontier[edge.To] = edge;</span><br><span class="line"></span><br><span class="line">                    mAStarPathInfo.EdgesSearched++;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//The A* search algorithm with strickdistance</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Search</span>(<span class="params"><span class="built_in">float</span> strickdistance</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">float</span> currentnodetotargetdistance = Mathf.Infinity;</span><br><span class="line"></span><br><span class="line">        mPQ.Clear();</span><br><span class="line"></span><br><span class="line">        mPQ.Push(mFCosts[mISource]);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//mSearchFrontier [mISource] = new GraphEdge (mISource, mISource, 0.0f);</span></span><br><span class="line">        mSearchFrontier[mISource].From = mISource;</span><br><span class="line">        mSearchFrontier[mISource].To = mISource;</span><br><span class="line">        mSearchFrontier[mISource].Cost = <span class="number">0.0f</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (!mPQ.Empty())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//Get lowest cost node from the queue</span></span><br><span class="line">            <span class="built_in">int</span> nextclosestnode = mPQ.Pop().Key;</span><br><span class="line"></span><br><span class="line">            mAStarPathInfo.NodesSearched++;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//move this node from the frontier to the spanning tree</span></span><br><span class="line">            <span class="keyword">if</span> (mSearchFrontier[nextclosestnode] != <span class="literal">null</span> &amp;&amp; mSearchFrontier[nextclosestnode].IsValidEdge())</span><br><span class="line">            &#123;</span><br><span class="line">                mShortestPathTree[nextclosestnode] = mSearchFrontier[nextclosestnode];</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            currentnodetotargetdistance = Heuristic_Euclid.Calculate(mGraph, mITarget, nextclosestnode);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (nextclosestnode == mITarget || currentnodetotargetdistance &lt;= strickdistance)</span><br><span class="line">            &#123;</span><br><span class="line">                mITarget = nextclosestnode;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//Now to test all the edges attached to this node</span></span><br><span class="line">            List&lt;GraphEdge&gt; edgelist = mGraph.EdgesList[nextclosestnode];</span><br><span class="line">            GraphEdge edge;</span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; edgelist.Count; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                edge = edgelist[i];</span><br><span class="line">                <span class="comment">//calculate the heuristic cost from this node to the target (H)</span></span><br><span class="line">                <span class="built_in">float</span> hcost = Heuristic_Euclid.Calculate(mGraph, mITarget, edge.To) * mHCostPercentage;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//calculate the &#x27;real&#x27; cost to this node from the source (G)</span></span><br><span class="line">                <span class="built_in">float</span> gcost = mGCosts[nextclosestnode] + edge.Cost;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//if the node has not been added to the frontier, add it and update the G and F costs</span></span><br><span class="line">                <span class="keyword">if</span> (mSearchFrontier[edge.To] != <span class="literal">null</span> &amp;&amp; !mSearchFrontier[edge.To].IsValidEdge())</span><br><span class="line">                &#123;</span><br><span class="line">                    mFCosts[edge.To].Value = gcost + hcost;</span><br><span class="line">                    mGCosts[edge.To] = gcost;</span><br><span class="line"></span><br><span class="line">                    mPQ.Push(mFCosts[edge.To]);</span><br><span class="line"></span><br><span class="line">                    mSearchFrontier[edge.To] = edge;</span><br><span class="line"></span><br><span class="line">                    mAStarPathInfo.EdgesSearched++;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (mBDrawExplorePath)</span><br><span class="line">                    &#123;</span><br><span class="line">                        Debug.DrawLine(mGraph.Nodes[edge.From].Position, mGraph.Nodes[edge.To].Position, Color.yellow, mExplorePathRemainTime);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//if this node is already on the frontier but the cost to get here</span></span><br><span class="line">                <span class="comment">//is cheaper than has been found previously, update the node</span></span><br><span class="line">                <span class="comment">//cost and frontier accordingly</span></span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (gcost &lt; mGCosts[edge.To])</span><br><span class="line">                &#123;</span><br><span class="line">                    mFCosts[edge.To].Value = gcost + hcost;</span><br><span class="line">                    mGCosts[edge.To] = gcost;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//Due to some node&#x27;s f cost has been changed</span></span><br><span class="line">                    <span class="comment">//we should reoder the priority queue to make sure we pop up the lowest fcost node first</span></span><br><span class="line">                    <span class="comment">//compare the fcost will make sure we search the path in the right direction</span></span><br><span class="line">                    <span class="comment">//h cost is the key to search in the right direction</span></span><br><span class="line">                    mPQ.ChangePriority(edge.To);</span><br><span class="line"></span><br><span class="line">                    mSearchFrontier[edge.To] = edge;</span><br><span class="line"></span><br><span class="line">                    mAStarPathInfo.EdgesSearched++;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//The A* search algorithm with strickdistance with wall consideration</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Search</span>(<span class="params"><span class="built_in">float</span> strickdistance, <span class="built_in">bool</span> isignorewall</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">float</span> currentnodetotargetdistance = Mathf.Infinity;</span><br><span class="line"></span><br><span class="line">        mPQ.Clear();</span><br><span class="line"></span><br><span class="line">        mPQ.Push(mFCosts[mISource]);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//mSearchFrontier [mISource] = new GraphEdge (mISource, mISource, 0.0f);</span></span><br><span class="line">        mSearchFrontier[mISource].From = mISource;</span><br><span class="line">        mSearchFrontier[mISource].To = mISource;</span><br><span class="line">        mSearchFrontier[mISource].Cost = <span class="number">0.0f</span>;</span><br><span class="line">        GraphEdge edge = <span class="keyword">new</span> GraphEdge();</span><br><span class="line">        <span class="built_in">int</span> nextclosestnode = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (!mPQ.Empty())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//Get lowest cost node from the queue</span></span><br><span class="line">            nextclosestnode = mPQ.Pop().Key;</span><br><span class="line"></span><br><span class="line">            mAStarPathInfo.NodesSearched++;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//move this node from the frontier to the spanning tree</span></span><br><span class="line">            <span class="keyword">if</span> (mSearchFrontier[nextclosestnode] != <span class="literal">null</span> &amp;&amp; mSearchFrontier[nextclosestnode].IsValidEdge())</span><br><span class="line">            &#123;</span><br><span class="line">                mShortestPathTree[nextclosestnode] = mSearchFrontier[nextclosestnode];</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            currentnodetotargetdistance = Heuristic_Euclid.Calculate(mGraph, mITarget, nextclosestnode);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (nextclosestnode == mITarget || (currentnodetotargetdistance &lt;= strickdistance &amp;&amp; !mGraph.Nodes[nextclosestnode].IsWall))</span><br><span class="line">            &#123;</span><br><span class="line">                mITarget = nextclosestnode;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//Now to test all the edges attached to this node</span></span><br><span class="line">            List&lt;GraphEdge&gt; edgelist = mGraph.EdgesList[nextclosestnode];</span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; edgelist.Count; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//Avoid pass refrence</span></span><br><span class="line">                edge.Reset();</span><br><span class="line">                edge.From = edgelist[i].From;</span><br><span class="line">                edge.To = edgelist[i].To;</span><br><span class="line">                edge.Cost = edgelist[i].Cost;</span><br><span class="line">                <span class="comment">//calculate the heuristic cost from this node to the target (H)</span></span><br><span class="line">                <span class="built_in">float</span> hcost = Heuristic_Euclid.Calculate(mGraph, mITarget, edge.To) * mHCostPercentage;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//calculate the &#x27;real&#x27; cost to this node from the source (G)</span></span><br><span class="line">                <span class="built_in">float</span> gcost = <span class="number">0.0f</span>;</span><br><span class="line">                <span class="keyword">if</span> (isignorewall)</span><br><span class="line">                &#123;</span><br><span class="line">                    gcost = mGCosts[nextclosestnode] + edge.Cost;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (mGraph.Nodes[edge.From].IsWall)</span><br><span class="line">                    &#123;</span><br><span class="line">                        gcost -= mGraph.Nodes[edge.From].Weight;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (mGraph.Nodes[edge.To].IsWall)</span><br><span class="line">                    &#123;</span><br><span class="line">                        gcost -= mGraph.Nodes[edge.To].Weight;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    gcost = mGCosts[nextclosestnode] + edge.Cost;</span><br><span class="line">                    <span class="keyword">if</span> (mGraph.Nodes[edge.From].IsJumpable)</span><br><span class="line">                    &#123;</span><br><span class="line">                        gcost -= mGraph.Nodes[edge.From].Weight;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (mGraph.Nodes[edge.To].IsJumpable)</span><br><span class="line">                    &#123;</span><br><span class="line">                        gcost -= mGraph.Nodes[edge.To].Weight;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//if the node has not been added to the frontier, add it and update the G and F costs</span></span><br><span class="line">                <span class="keyword">if</span> (mSearchFrontier[edge.To] != <span class="literal">null</span> &amp;&amp; !mSearchFrontier[edge.To].IsValidEdge())</span><br><span class="line">                &#123;</span><br><span class="line">                    mFCosts[edge.To].Value = gcost + hcost;</span><br><span class="line">                    mGCosts[edge.To] = gcost;</span><br><span class="line"></span><br><span class="line">                    mPQ.Push(mFCosts[edge.To]);</span><br><span class="line"></span><br><span class="line">                    mSearchFrontier[edge.To].ValueCopy(edge);</span><br><span class="line"></span><br><span class="line">                    mAStarPathInfo.EdgesSearched++;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (mBDrawExplorePath)</span><br><span class="line">                    &#123;</span><br><span class="line">                        Debug.DrawLine(mGraph.Nodes[edge.From].Position, mGraph.Nodes[edge.To].Position, Color.yellow, mExplorePathRemainTime);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//if this node is already on the frontier but the cost to get here</span></span><br><span class="line">                <span class="comment">//is cheaper than has been found previously, update the node</span></span><br><span class="line">                <span class="comment">//cost and frontier accordingly</span></span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (gcost &lt; mGCosts[edge.To])</span><br><span class="line">                &#123;</span><br><span class="line">                    mFCosts[edge.To].Value = gcost + hcost;</span><br><span class="line">                    mGCosts[edge.To] = gcost;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//Due to some node&#x27;s f cost has been changed</span></span><br><span class="line">                    <span class="comment">//we should reoder the priority queue to make sure we pop up the lowest fcost node first</span></span><br><span class="line">                    <span class="comment">//compare the fcost will make sure we search the path in the right direction</span></span><br><span class="line">                    <span class="comment">//h cost is the key to search in the right direction</span></span><br><span class="line">                    mPQ.ChangePriority(edge.To);</span><br><span class="line"></span><br><span class="line">                    mSearchFrontier[edge.To].ValueCopy(edge);</span><br><span class="line"></span><br><span class="line">                    mAStarPathInfo.EdgesSearched++;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title">Heuristic_Euclid</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">float</span> <span class="title">Calculate</span>(<span class="params">SparseGraph&lt;NavGraphNode, GraphEdge&gt; g, <span class="built_in">int</span> nd1, <span class="built_in">int</span> nd2</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//Manhattan distance heuritic</span></span><br><span class="line">        <span class="comment">//Vector2 v1 = Utility.ConvertIndexToRC (nd1);</span></span><br><span class="line">        <span class="comment">//Vector2 v2 = Utility.ConvertIndexToRC (nd2);</span></span><br><span class="line">        <span class="comment">//float dis = v1.x - v2.x + v1.y - v2.y;</span></span><br><span class="line">        <span class="comment">//Debug.Log(&quot;dis = &quot; + dis);</span></span><br><span class="line">        <span class="comment">//return dis;</span></span><br><span class="line">        <span class="comment">//Caculation distance takes much time</span></span><br><span class="line">        <span class="keyword">return</span> Vector3.Distance(g.Nodes[nd1].Position, g.Nodes[nd2].Position);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从上面可以看出我写了三个Search的版本：<br>第一个没有参数是最初的A Star Search，用于普通的寻路。<br>第二个带有float strickdistance的参数，是由于后来为了实现兵种间不同攻击距离下的寻路，只要达到攻击范围就算寻路完成。<br>第三个参数带了float strickdistance和bool isignorewall两个参数，还记得之前在GraphNode里写到的由于游戏里有城墙的概念，所以我在NavGraphNode里加入的mIsWall和mIsJumpable变量，用于判断节点是否是城墙并且是否可以直接越过。而这里的第二个参数isignorewall主要是用于判断当前兵种是否支持跳跃城墙（比如COC里的野猪），如果可以忽略城墙，那么寻路的时候就不会加入城墙的考虑。<br>后续我都会一一展示。</p>
<p>注意： A算法和Dijkstra算法的唯一区别是对搜索边界上的点的开销的计算。被修正的到节点的开销F用来决定节点在优先队列中的位置。<br>F的计算：<br>F &#x3D; G + H<br>G是到达一个节点的累计开销， H是一个启发因子，它给出的是节点到目标节点的估计距离。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">float</span> hcost = Heuristic_Euclid.Calculate(mGraph, mITarget, edge.To) * mHCostPercentage;</span><br></pre></td></tr></table></figure>
<p>这里算的是两点之间的实际距离，通过设定一个mHCostPercentage来实现对启发因子数值的控制。</p>
<p>让我们看看mHCostPercentage不同值时的效果：<br>黄色为寻路过程中探测的路线，绿色是最终路线。<br>mHCostPercentage &#x3D; 1，即以两点之间的实际距离为H值的寻路的效果：<br><img src="/img/Unity/mHCostPercentage1.PNG" alt="mHCostPercentage1"></p>
<p>mHCostPercentage &#x3D; 1.5,即以两点之前的实际距离的1.5倍为H值得寻路效果：<br><img src="/img/Unity/mHCostPercentage1point5.PNG" alt="mHCostPercentage1point5"></p>
<p>从上图可以看出H的值会使得A Star的搜索方向尽可能的往正确的方向搜索，从而避免不必要的边搜索。<br>上图由于绘制了搜索路径，所以实际上的Search Time没有那么高，如果mHCostPercentage设置成1.5一般都在2ms以内。</p>
<p>让我们看看加入城墙以后的效果：<br>注意，这里城墙的权值是设的4，即经过城墙相当于多走4的距离<br>mHCostPercentage &#x3D; 1<br><img src="/img/Unity/mHCostPercentage1withWall.PNG" alt="mHCostPercentage1withWall"></p>
<p>mHCostPercentage &#x3D; 1.5<br><img src="/img/Unity/mHCostPercentage1point5withWall.PNG" alt="mHCostPercentage1point5withWall"></p>
<p>从上图可以看出通过探索，士兵选择了最近的路线是绕过城墙，同时mHCostPercentage越大使得搜索的边减少了。</p>
<p>接下来看看当建筑被城墙大量包围时的寻路效果：<br>mHCostPercentage &#x3D; 1<br><img src="/img/Unity/mHCostPercentage1withMoreWall.PNG" alt="mHCostPercentage1withMoreWall"></p>
<p>mHCostPercentage &#x3D; 1.5<br><img src="/img/Unity/mHCostPercentage1point5withMoreWall.PNG" alt="mHCostPercentage1point5withMoreWall"></p>
<p>通过上面可以看出，由于建筑被城墙幅度包围，士兵的最终路线选择是经过城墙。<br>让我们来看一张有城墙的和无城墙的权值图：<br>有城墙：<br><img src="/img/Unity/WithWallWeightValue.PNG" alt="WithWallWeightValue"></p>
<p>无城墙：<br><img src="/img/Unity/WithoutWallWeightValue.PNG" alt="WithoutWallWeightValue"></p>
<p>NavGraphNode里加入的mIsJumpable变量将用于对城墙是否可跳跃的状态进行了抽象（实现COC里的弹跳法术）。</p>
<p>最终这个游戏实现了如下功能：</p>
<ol>
<li>地图的存储</li>
<li>地图的编辑（建造和删除）</li>
<li>游戏进攻AI（包括对特有类型建筑有限攻击（好比COC里胖子优先攻击防御建筑））</li>
<li>存档清除</li>
<li>PC和Mobile控制</li>
<li>A Star调试信息面板</li>
<li>调整兵种信息调整（对优先攻击进行设定，行进速度设定，攻击距离设定，攻击伤害，血量是否可跳墙等属性设定等）</li>
<li>对建筑物信息调整（所占格子2<em>2 or 3</em>3等设定（暂时只支持1<em>1,2</em>2,3*3），攻击距离，攻击伤害，血量等信息）</li>
<li>法术信息调整（法术范围，法术持续时间等信息）</li>
</ol>
<p>兵种支持：</p>
<ol>
<li>近战型优先攻击防御建筑 – 好比COC的胖子</li>
<li>远程，无特定攻击对象 – 好比COC的弓箭手</li>
</ol>
<p>建筑支持：</p>
<ol>
<li>攻击建筑 – 好比COC里的箭塔</li>
<li>不可攻击建筑 – 好比COC里的兵营</li>
<li>城墙 – 好比COC里的城墙</li>
</ol>
<p>法术支持：<br>弹跳法术</p>
<p>所有功能都会在最后的视频一一展示。</p>
<h3 id="Optimization"><a href="#Optimization" class="headerlink" title="Optimization"></a>Optimization</h3><ol>
<li><p>Rendering<br>最初是绘制了40*40，1600个带Sprite图案的Tile，后来改为用一张整的Ground和只带Collider的1600个Tile。</p>
</li>
<li><p>GC<br>A Star最初写的时候是每一次运算都申请新的内存(每一次都New上百k的内存)，后来改为通用数据保留下来，每次只重新申请需要返回的A Star Path的数据(大概几K)</p>
</li>
<li><p>Physics<br>最初是打开了所有Layer之间的碰撞检测，后来改为只打开需要碰撞检测的Layer之间的碰撞检测(Edit -&gt; Project Settings -&gt; Physics)</p>
</li>
<li><p>Memory<br>避免不必要的内存开销(比如box会在堆上申请额外的内存)<br>项目里用Dictionary而不要用Hashtable，因为Dictionary是基于模板的，在针对ValueType的时候不会触发box和unbox。<br>Unity里foreach会触发box，所以在Unity里尽量避免使用foreach，用while or for代替。</p>
</li>
</ol>
<h2 id="Sumary"><a href="#Sumary" class="headerlink" title="Sumary"></a>Sumary</h2><p>在这次尝试制作和学习的过程中，学习了解了Unity和C#的一些基本概念。<br>巩固学习了AI寻路方面的知识。<br>对于炸弹人的AI，虽然云风大哥说大概是“寻找附近封闭空间中最近目标”，对于如何实现这一点没有头绪。(未来AI学习书籍 – 《Artificial Intelligence for Game》 — Ian Millington)<br>通过这一次的实践学习，我明白了，好的数据结构设计才是性能的关键所在。我的实现依赖于A Star的实时运算，即使每次运算时1ms级别，但数量一旦达到成百上千，A Star是无法保证帧率的。尽量做到预算和O(1)时间的查找或者运用更好的数据结构解决问题才是提升性能的关键。<br>最后再贴一个没有解决的真机bug（相对严重的，PC上没有），暂时未能解决的。<br><a target="_blank" rel="noopener" href="http://answers.unity3d.com/questions/1158635/transformlookat-got-different-behaviour-on-pc-and.html">Unity 的提问</a></p>
<h2 id="Final-Effect"><a href="#Final-Effect" class="headerlink" title="Final Effect"></a>Final Effect</h2><p><a target="_blank" rel="noopener" href="http://blog.sina.com.cn/s/blog_8c7d49f20102xfck.html">视频</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Unity/">Unity</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Unity/">Unity</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/10/14/Artificial-Inteligence-Study/" title="Artificial-Inteligence-Study" itemprop="url">Artificial-Inteligence-Study</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Tony Tang" target="_blank" itemprop="author">Tony Tang</a>
		
  <p class="article-time">
    <time datetime="2015-10-14T14:25:28.000Z" itemprop="datePublished"> 发表于 2015-10-14</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="Programming-Game-AI-by-Example"><a href="#Programming-Game-AI-by-Example" class="headerlink" title="Programming Game AI by Example"></a>Programming Game AI by Example</h1><h2 id="图的秘密"><a href="#图的秘密" class="headerlink" title="图的秘密"></a>图的秘密</h2><h3 id="图的术语"><a href="#图的术语" class="headerlink" title="图的术语"></a>图的术语</h3><p>路径节点叫做节点(node)<br>连接节点的路线被叫做边(edge)<br>权包含了从一个节点移动到另一个节点所需要的开销信息</p>
<h3 id="图的分类："><a href="#图的分类：" class="headerlink" title="图的分类："></a>图的分类：</h3><ol>
<li>连通图 （途中任何一个节点都可以找到一条路径到达所有其他的节点）</li>
<li>不连通图</li>
</ol>
<h3 id="图的定义："><a href="#图的定义：" class="headerlink" title="图的定义："></a>图的定义：</h3><p>图G的规范化的定义：通过边的集合E，节点的集合N来定义<br>G &#x3D; {N , E}</p>
<p>注意：树是图的一个子集，树包含了所有的无环图</p>
<p>图密度：<br>边与节点的比率决定了一个图是稀疏还是致密的</p>
<p>有向图：<br>一个有向图的边是有方向的。</p>
<p>游戏AI中的图：</p>
<ol>
<li><p>导航图(Navigation Graph) （包含了在一个游戏环境中智能体可能访问的所有的位置和这些位置之间的所有连接）</p>
</li>
<li><p>依赖图(Dependency Graph) （被用来秒速玩家可以利用的不同的建筑物，材料，单元以及技术之间的依赖关系）</p>
</li>
<li><p>状态图(State Graph) （用来表示一个系统的每一个可能的状态以及状态之间的转换关系）</p>
</li>
</ol>
<p>两种数据结构被用来表示图：</p>
<ol>
<li><p>邻接矩阵 （用一个二维的矩阵来表示图的链接关系，矩阵的每一个元素可以使布尔类型的，也可以是浮点类型的）<br>优缺点：<br>直观<br>但对于大的稀疏图来说，这种表示方法不经济，大部分矩阵元素被用来存储0</p>
</li>
<li><p>邻接表<br>优缺点：<br>对于存储稀疏图是非常有效的，不会浪费空间来存储空连接<br>例子：<br>有向图：<br><img src="/img/AI/Digraph.PNG" alt="Digraph"></p>
</li>
</ol>
<p>邻接矩阵：<br>![Adjacency _Matrix](&#x2F;img&#x2F;AI&#x2F;Adjacency _Matrix.PNG)</p>
<p>邻接表：<br><img src="/img/AI/Adjacency_List.PNG" alt="Adjacency_List"></p>
<p>图的搜索算法：</p>
<ol>
<li><p>盲目搜索(Uniformed Graph Searches) （在搜索一个图时不考虑相关的边的开销）<br> a. 深度优先搜索(DFS: Depth First Search) （搜索时尽可能地深入一个图。在搜索时，当它走入死胡同时，才会回溯，以回到上一个较浅的节点，在那里继续深度搜索）<br>注意： 使用Stack来模拟，先进后出（FILO）的原则<br> DFS优化：<br> 一些图可能非常深，深度优先便可能非常容易地就在错误的路径上陷得很深，因而延误了搜索。<br> 限制深度的搜索(Limited Search)： 限制深度优先搜索算法在开始回溯之前可以进行多少步的深度搜索<br>缺点： 如何设置最大搜索深度<br>  迭代加深深度优先搜索(Iterative Deepending Depth First Search)<br> b. 广度优先搜索(BFS：Breadth First Search) （从源节点展开以检查从它出发的边指向的每一个节点，然后再从那些刚检查过的节点继续展开）<br>注意： 使用Queue来模拟，先进先出（FIFO）的原则<br> BFS缺点：<br> 如果搜索的图非常大而且分支数很高，那么BFS就会浪费大量的内存并且表现出很低的效率。</p>
</li>
<li><p>基于开销的图搜索(cost-based graph searchs)<br> a. 边放松(Edge Relaxation) （从源节点到抵达目标节点的路径上的所有其他节点中搜集当前最优路径（BPFSF: Best Path Found So Far）信息。这个信息在检查新的边时得到更新。如果刚检查的边表明，如果用通过此边到达一个节点的路径取代现有的最优路径会使路程更短，那么，这条边就 被加入，而路径也相应地更新）<br> b. 最短路径树(SPT: Short Path Tree) （从任何节点到达源节点的最短路径）<br><img src="/img/AI/SPT_Short_Path_Tree.PNG" alt="SPT_Short_Path_Tree"><br>c. Dijkstra算法(Dijkstra Algorithm) （教授Edsger Wybe Dijkstra著名的寻找带全图的最短路径算法）<br>注意： 使用一个索引的优先队列(Indexed Priority Queue)来实现。<br> 缺点：<br> Dijkstra算法检查了太多的边。<br> d. Dijkstra算法的一个改进：A<em>算法 （Dijkstra算法通过最小化开销进行搜索。在处理搜索边界上的点时，如果估计一下他们距离目标节点的开销，并将这个信息考虑进去，那么算法的效率就可以大大提高。这个估计值被称为启发因子。）<br>注意： A</em>算法和Dijkstra算法的唯一区别是对搜索边界上的点的开销的计算。被修正的到节点的开销F用来决定节点在优先队列中的位置。<br>F的计算：<br> F &#x3D; G + H<br>G是到达一个节点的累计开销， H是一个启发因子，它给出的是节点到目标节点的估计距离。<br>   通过用这种方法使用一个启发因子，被修正的开销会指引搜索逼近目标节点，而不是在各个可能的方向发散的搜索。这也使需要检查的边更少。因此搜索的加速是Disjkstra算法和A<em>算法的最主要区别。<br>   A</em>算法的实现需要维护两个用来存储开销的std::vector，一个用来保存每一个节点的F开销，作为优先队列的索引，另一个是每一个节点的G开销。</p>
</li>
</ol>
<p>《Artificial Intelligence for Game》 – Ian Millington<br>1.	Introduction<br>	1.1	What is AI?<br>Artificial intelligence is about making computers able to perform the thinking tasks that humans and animals are capable of</p>
<p>1.1.2  Game AI<br>Pacman [Midway Games West, Inc, 1979] – state machine<br>Warcraft –[Blizzard Entertainment, 1994] – Path finding</p>
<p>AI three basic needs:<br>1.	Move<br>Movement refers to algorithms that turn decisions into some kind of motion<br>2.	Decision making<br>Decision making involves a characterworking out what to do next<br>3.	Strategy<br>Strategy refers to an overall approach used by a group of characters – e.g. Harf-Life<br>Note:<br>Not all game applications require all levels of AI</p>
<p>1.2.5 Agent-Based AI<br>Agent-based AI is about producing autonomous characters that take in information from the game data, determine what actions to take based on the information, and carry out those actions</p>
<p>1.3	Algorithms, Data Structures, and Representations<br>1.3.1	Algorithms</p>
<ol start="6">
<li>Tactical and Strategic AI<br>6.1 Waypoint Tactics<br>6.1.1 Tactical Locations</li>
</ol>
<p>12.4 Real-Time Strategy<br>待续……</p>
<h1 id="AI"><a href="#AI" class="headerlink" title="AI"></a>AI</h1><p>前面提到的图主要是用于寻路方面(e.g. A*)的知识储备。</p>
<p>接下来要提到的AI主要是涉及到角色AI行为决策的实现，本章主要以学习状态机，分层状态机以及行为树来理解AI中行为决策的几个常用实现方式加深AI行为决策学习理解，更多更深入的学习可参考《Artificial.Intelligence.for.Games》书籍。</p>
<h2 id="状态机"><a href="#状态机" class="headerlink" title="状态机"></a>状态机</h2><p>游戏中，一般人物或者游戏的状态都是有限的，这里我们可以使用状态机把这些有限的状态抽象出来，然后把各自的逻辑写在对应的状态中。一来逻辑清晰，二来各状态之间的关系也清晰。</p>
<p>打个比方：</p>
<p>游戏状态划分:</p>
<ul>
<li>游戏初始状态(刚进游戏的第一个状态，负责初始化所有模块引导进入游戏)</li>
<li>游戏更新状态(热更新的一个状态，负责处理热更新相关)</li>
<li>游戏UI状态(游戏玩法外的一个状态，比如游戏主城时候)</li>
<li>游戏Loading状态(切换场景加载显示Loading图的过渡状态)</li>
<li>游戏GamePlay状态(具体的某个玩法状态，比如选择关卡后进去的具体玩游戏状态)</li>
<li>游戏暂停状态(顾名思义暂停游戏的一个状态)</li>
<li>游戏退出状态(关闭退出游戏时的一个状态，可以做一些游戏清除保存工作)</li>
</ul>
<p><img src="/img/AI/GameStateMachine.png" alt="GameStateMachine"></p>
<p>这里就只放几个核心代码：</p>
<p>StateMachine.cs(状态机管理类)</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">StateMachine</span>&lt;<span class="title">T</span>&gt; <span class="keyword">where</span> <span class="title">T</span> : <span class="keyword">class</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 状态机拥有者</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">protected</span> T mOwner;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 当前游戏状态</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> StateTemplate&lt;T&gt; mCurrentState;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 当前游戏状态的int值(为了状态机通用这里没有写成特定Enum)</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> CurrentStateValue</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> mCurrentStateValue;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span> mCurrentStateValue;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 游戏状态机Map</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">private</span> Dictionary&lt;<span class="built_in">int</span>, StateTemplate&lt;T&gt;&gt; mStatesMap;    </span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">StateMachine</span>(<span class="params">T owner</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        mOwner = owner;</span><br><span class="line">        mCurrentState = <span class="literal">null</span>;</span><br><span class="line">        mCurrentStateValue = <span class="number">-1</span>;</span><br><span class="line">        mStatesMap = <span class="keyword">new</span> Dictionary&lt;<span class="built_in">int</span>, StateTemplate&lt;T&gt;&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 设置拥有者</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;owner&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setOwner</span>(<span class="params">T owner</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        mOwner = owner;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 消息响应处理</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;message&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span>(<span class="params">MessageData message</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(mCurrentState != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            mCurrentState.onMessage(message);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 游戏更新</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">update</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (mCurrentState != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            mCurrentState.executeState();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 注册游戏状态</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;state&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">registerState</span>(<span class="params"><span class="built_in">int</span> stateenum, StateTemplate&lt;T&gt; state</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (mStatesMap.ContainsKey(stateenum))</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="built_in">string</span>.Format(<span class="string">&quot;已经注册过状态:&#123;0&#125;&quot;</span>, stateenum));</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            mStatesMap.Add(stateenum, state);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 是否已经注册过特定状态</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;stateenum&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">hasRegisterSpecificState</span>(<span class="params"><span class="built_in">int</span> stateenum</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> mStatesMap.ContainsKey(stateenum);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 移除状态</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;stateenum&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">removeState</span>(<span class="params"><span class="built_in">int</span> stateenum</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (mStatesMap.ContainsKey(stateenum))</span><br><span class="line">        &#123;</span><br><span class="line">            mStatesMap.Remove(stateenum);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="built_in">string</span>.Format(<span class="string">&quot;状态:&#123;0&#125;未注册，无法移除！&quot;</span>, stateenum));</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 清除所有注册的游戏状态</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">clearAllStates</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mStatesMap.Clear();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 切换游戏状态</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;stateenum&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;param&quot;&gt;</span>状态切换参数<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">changeToState</span>(<span class="params"><span class="built_in">int</span> stateenum, <span class="keyword">params</span> <span class="built_in">object</span>[] param</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (mStatesMap.ContainsKey(stateenum))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (mCurrentState != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                mCurrentState.exitState();</span><br><span class="line">            &#125;</span><br><span class="line">            mCurrentState = mStatesMap[stateenum];</span><br><span class="line">            mCurrentStateValue = stateenum;</span><br><span class="line">            mCurrentState.setOwner(mOwner);</span><br><span class="line">            mCurrentState.enterState(param);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="built_in">string</span>.Format(<span class="string">&quot;未注册游戏状态:&#123;0&#125;&quot;</span>, stateenum));</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 清除所有数据状态</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">clearAll</span>()</span></span><br><span class="line">    &#123;        </span><br><span class="line">        mCurrentState = <span class="literal">null</span>;</span><br><span class="line">        mStatesMap.Clear();</span><br><span class="line">        mOwner = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>StateTemplate.cs(状态模板类)</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 游戏物体状态抽象基类</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">StateTemplate</span>&lt;<span class="title">T</span>&gt; <span class="keyword">where</span> <span class="title">T</span> : <span class="keyword">class</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 状态拥有者</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">protected</span> T mOwner;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 设置状态拥有者</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;owner&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setOwner</span>(<span class="params">T owner</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        mOwner = owner;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 获取状态拥有者</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> T <span class="title">getOwner</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> mOwner;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 进入当前状态</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;param&quot;&gt;</span>状态运行参数<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">enterState</span>(<span class="params"><span class="keyword">params</span> <span class="built_in">object</span>[] param</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 执行当前状态</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">executeState</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 退出当前状态</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">exitState</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>GameBaseState.cs(游戏状态基类)</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Description:             GameBaseState.cs</span></span><br><span class="line"><span class="comment"> * Author:                  TONYTANG</span></span><br><span class="line"><span class="comment"> * Create Date:             2018/12/09</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 游戏状态基类</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">GameBaseState</span> : <span class="title">StateTemplate</span>&lt;<span class="title">GameManager</span>&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 进入当前状态</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;param&quot;&gt;</span>状态运行参数<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">enterState</span>(<span class="params"><span class="keyword">params</span> <span class="built_in">object</span>[] param</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        loadRes(param);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 执行当前状态</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">executeState</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 退出当前状态</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">exitState</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        unloadRes();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 加载相关资源</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">loadRes</span>(<span class="params"><span class="keyword">params</span> <span class="built_in">object</span>[] param</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 释放所有资源</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">unloadRes</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>代码就不详细说明了，看一眼大概就能明白了。</p>
<p>优点：</p>
<ol>
<li>对于状态不多不复杂的来说，可以把状态逻辑划分很清晰，易于维护</li>
</ol>
<p>缺点:</p>
<ol>
<li>对于复杂拥有过多状态的情况来说，维护成本高不方便管理(横向扩展不利于维护)</li>
</ol>
<p>针对缺点1的方案可以考虑HFSM(分层状态机)，通过细分大小状态机来进行更加细致的状态机分类。</p>
<p>结论：</p>
<p>FSM(有限状态机)更适合于状态数量不多不复杂的情况(e.g. 游戏状态分类)</p>
<h2 id="分层状态机"><a href="#分层状态机" class="headerlink" title="分层状态机"></a>分层状态机</h2><p><a target="_blank" rel="noopener" href="https://www.twblogs.net/a/5b7fb24f2b717767c6b1124d/zh-cn">详细HFSM参考</a></p>
<h2 id="行为树"><a href="#行为树" class="headerlink" title="行为树"></a>行为树</h2><p>行为树是本章AI决策的重点，考虑到篇幅过长，所以另起一篇博客来详解行为树在Unity里的实战学习。</p>
<p>详情参考:</p>
<p><a href="%5Bhttp://tonytang1990.github.io/2020/09/12/%E8%A1%8C%E4%B8%BA%E6%A0%91-Unity/%5D(http://tonytang1990.github.io/2020/09/12/%E8%A1%8C%E4%B8%BA%E6%A0%91-Unity/)">行为树-Unity</a></p>
<h3 id="行为树实战"><a href="#行为树实战" class="headerlink" title="行为树实战"></a>行为树实战</h3><p>目标：</p>
<ol>
<li>实现一个简易的行为树，深入理解行为树的原理和实现</li>
<li>配套一个简易的节点编辑器(支持可视化编辑和调试)</li>
</ol>
<p>实现：</p>
<ol>
<li>目标1通过自行实现一个简易版</li>
<li>目标2基于Unity原生GUI API来实现可视化节点编辑器</li>
</ol>
<h4 id="数据管理"><a href="#数据管理" class="headerlink" title="数据管理"></a>数据管理</h4><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/KillerAery/p/10054558.html">黑板模式</a></p>
<p>可以简单的理解成一个共享数据的地方。</p>
<h4 id="抽象行为树"><a href="#抽象行为树" class="headerlink" title="抽象行为树"></a>抽象行为树</h4><p>待添加……</p>
<h4 id="行为中断"><a href="#行为中断" class="headerlink" title="行为中断"></a>行为中断</h4><p>待添加……</p>
<h4 id="节点编辑器"><a href="#节点编辑器" class="headerlink" title="节点编辑器"></a>节点编辑器</h4><p>待添加……</p>
<h1 id="参考书籍"><a href="#参考书籍" class="headerlink" title="参考书籍"></a>参考书籍</h1><p>《Programming Game AI by Example》 – Mat Buckland<br>《Artificial Intelligence for Game》 – Ian Millington</p>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a target="_blank" rel="noopener" href="https://www.twblogs.net/a/5b7fb24f2b717767c6b1124d/zh-cn">FSM（状态机）、HFSM（分层状态机）、BT（行为树）的区别</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/AI/">AI</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/AI/">AI</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/08/29/装机相关知识/" title="装机相关知识" itemprop="url">装机相关知识</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Tony Tang" target="_blank" itemprop="author">Tony Tang</a>
		
  <p class="article-time">
    <time datetime="2015-08-29T10:28:18.000Z" itemprop="datePublished"> 发表于 2015-08-29</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="装机相关知识"><a href="#装机相关知识" class="headerlink" title="装机相关知识"></a>装机相关知识</h1><p>组装电脑组要的配件：<br>主板，CPU，显卡，内存，硬盘，外设，机箱，电源组成。</p>
<p>接下来就各个模块的相关概念参数进行学习了解，最后结合网上的经验之谈和自己的理论知识用于实践组机参考。</p>
<h2 id="装机模块"><a href="#装机模块" class="headerlink" title="装机模块"></a>装机模块</h2><h3 id="主板"><a href="#主板" class="headerlink" title="主板"></a>主板</h3><p>首先了解下主板在电脑中的作用：<br><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E4%B8%BB%E6%9D%BF">典型的主板能提供一系列接合点，供处理器、显卡、声卡、硬盘驱动器、内存、对外设备等设备接合。它们通常直接插入有关插槽，或用线路连接。</a></p>
<p><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E4%B8%BB%E6%9D%BF">主板上最重要的构成组件是芯片组（Chipset）。而芯片组通常由北桥和南桥组成，也有些以单片机设计，增强其性能。</a></p>
<p>可以看出主板是让所有电脑组件组合运行起来的关键，起到了模块连接，数据传递，提供硬件接口等重要作用。</p>
<p>主板购买装机需要考虑的点：</p>
<ol>
<li>兼容</li>
<li>稳定性</li>
<li>扩展</li>
</ol>
<p>以下主要是针对主板上的各个接口进行学习了解，了解他们每一个模块是负责做什么，所有模块是怎么整合运行起来的。后面会针对主要组件进行深入学习了解用于判断怎样的组件才是高性能更优的，帮助我们组装时购买各个组件提供理论知识。</p>
<p>首先让我们先看看主板的构成和架构图:<br><img src="/img/Graphic/MainBoard.PNG" alt="MainBoard"><br><img src="/img/Graphic/MainboardDiagram.PNG" alt="MainboardDiagram"></p>
<p>以下只列出了几个重要的模块进行了解：</p>
<ol>
<li>CPU插槽 – CPU插槽接口(CPU主要分为Intel和AMD，注意接口标准兼容问题)</li>
<li>芯片组 – CPU与其他组件沟通的桥梁，分为北桥(Normal Bridge)和南桥(South Bridge)<br>图二可以看出，北桥(NB)主要是负责CPU与RAM(内存)，AGP,PCI Express还有南桥的通信。<br>南桥主要是负责和外设，多媒体，通信接口等通信。<br>Note:<br>北桥随着发展被整合到CPU里了。 </li>
<li>AGP插槽(根据Wiki的说法被PCI Express取代了) – 显卡插槽专用接口<br><img src="/img/Graphic/PCIExpressPerformance.PNG" alt="PCI Express性能参考表"><br>当然最好的是PCI Express 3.0 x16。区分是x1,x4,x8,x16看针脚数量。<br>PCI Express总线对显卡传输的瓶颈暂时不考虑，情况比较复杂。尽量买支持PCI Express 3.0 x16插槽的主板就好。<br><img src="/img/Graphic/PCIExpressInfo.PNG" alt="PCI Express信息查看"><br>GPU-Z里的Bus Interface显示的就是PCI Express的版本和带宽数。</li>
<li>内存插槽 – 内存条插槽接口(多个内存插槽方便以后内存扩展)</li>
<li>PCI扩展插槽 – 外设(e.g. 网卡，声卡，调制解调器……)扩展插槽接口(被PCI Express慢慢取代)</li>
<li>mSATA(结合下面的图查看) – 安装我们平时说的SSD(固态硬盘)的插槽接口(推荐使用固态硬盘)<br><img src="/img/Graphic/mSATALocation.PNG" alt="mSATA插槽位置"></li>
<li>BIOS – <a target="_blank" rel="noopener" href="http://www.it892.com/content/hardware/onboard/2014/1001/5581.html">基本输入、输出系统)是一块装入了启动和自检程序的EPROM 或EEPROM 集成电路。</a></li>
</ol>
<p>主板决定了我们其他组件的选择范围(比如CPU必须和主板CPU插槽一致)，不然出现不兼容或者不允许安装就尴尬了。<br>Intel和AMD的CPU插槽详解参见下面链接：<br><a target="_blank" rel="noopener" href="http://www.it892.com/content/hardware/onboard/2013/0905/4863.html">电脑主板有哪些插槽详细介绍</a></p>
<h3 id="CPU"><a href="#CPU" class="headerlink" title="CPU"></a>CPU</h3><p><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E4%B8%AD%E5%A4%AE%E5%A4%84%E7%90%86%E5%99%A8">中央处理器(Central Processing Unit)，是计算机的主要设备之一，功能主要是解释计算机指令以及处理计算机软件中的数据。</a></p>
<p>CPU的好坏决定了运算速度。那么是什么决定了CPU性能好坏的了？<br>在了解决定因素之前，我们需要了解学习几个概念：</p>
<ol>
<li><p>主频 – CPU正常运行时的工作频率(一个时钟周期能完成的指令数是固定的，所以工作频率越高性能越高)</p>
</li>
<li><p>外频 – 系统总线的工作频率</p>
</li>
<li><p>倍频 – CPU外频与主频相差的倍数</p>
</li>
<li><p>超频 – <a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E8%B6%85%E9%A2%91%E6%8A%80%E6%9C%AF">过人为的方式将CPU、显卡等硬件的工作频率提高，让它们在高于其额定的频率状态下稳定工作</a>(通过改变CPU的倍频或者外频来实现)</p>
</li>
<li><p>前端总线 – <a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%89%8D%E7%AB%AF%E6%80%BB%E7%BA%BF">CPU和北桥芯片间总线的速度。</a><a target="_blank" rel="noopener" href="http://www.cnblogs.com/spinsoft/archive/2012/08/02/2619982.html">数据传输的速度，即每秒钟CPU可接受的数据传输量。</a></p>
</li>
<li><p>系统总线 – <a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%89%8D%E7%AB%AF%E6%80%BB%E7%BA%BF">创建在数字脉冲信号震荡速度基础之上的，也就是说，100MHz系统总线（BusSpeed）特指数字脉冲信号在每秒钟震荡一亿次，它更多的影响了PCI及其他总线的频率</a><br>[CPU与主板之间同步运行的速度，是指数字脉冲信号在每秒钟震荡的次数；</p>
<p>](<a target="_blank" rel="noopener" href="http://www.cnblogs.com/spinsoft/archive/2012/08/02/2619982.html">http://www.cnblogs.com/spinsoft/archive/2012/08/02/2619982.html</a>)</p>
</li>
</ol>
<p>公式：<br>CPU主频&#x3D;CPU外频(系统总线)×CPU倍频系数</p>
<p>不同的CPU(Intel or AMD)，CPU外频(系统总线)和前端总线频率关系不一样：<br>Intel CPU来说，前端总线&#x3D;系统总线*4</p>
<p>超频会带来影响CPU的稳定性，更发热，需要更大供电等问题。</p>
<p>了解了上述概念，不难看出，CPU的性能好坏主要是由主频和超频能力决定的。<br>通过CPU-Z工具，我们可以看到CPU相关的详细信息:<br><img src="/img/Graphic/CPUProcessorFrequency.PNG" alt="CPU-Z信息查看"><br>结合我在Intel官网查到的CPU信息:<br><img src="/img/Graphic/MyCPUInfo.PNG" alt="我的CPU信息"><br>从上面可以看出，我的电脑CPU基本频率2.3GHz，超频最高达到3.3GHz，倍频是在12-33之间变化。</p>
<p>组装购买CPU时，不仅要考虑CPU的性能好坏，还要考虑前端总线的传输能力，如果前端总线远远小于CPU的频率那么性能就受限于前端总线，反之亦然。</p>
<p>其次CPU还要考虑一个很重要的点：<br><strong>多核</strong>，多核能提升多线程并行处理运算的能力，特别是很多大型游戏都会利用CPU的多核运算能力去利用加开运算速度。后端服务器尤其看重多核，个人认为也是为了提高并行运算能力。。所以除了看CPU主频多核也是一个很重要的参考点。</p>
<p>CPU性能比较参考CPU天梯图：<br><a target="_blank" rel="noopener" href="http://www.xiazaiba.com/jiaocheng/10299.html">CPU 2017年9月天梯图</a></p>
<p>Note:<br><a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E8%B6%85%E9%A2%91%E6%8A%80%E6%9C%AF">超频是一个广义的概念，它是指任何提高计算机某一部件工作频率而使之工作在非标准频率下的行为及相关行动都应该称之为超频，其中包括CPU超频、主板超频、内存超频、显示卡超频和硬盘超频等等很多部分</a><br>外频 &#x3D;&#x3D; 系统总线频率     外频 !&#x3D; 前端总线频率</p>
<h3 id="显卡"><a href="#显卡" class="headerlink" title="显卡"></a>显卡</h3><p>显卡这里就不详细重复讲解了，详情参考本文前面关于GPU的知识学习。<br>这里只写几个结论总结：</p>
<ol>
<li>显存带宽&#x3D;显存频率×显存位宽&#x2F;8</li>
<li><a target="_blank" rel="noopener" href="http://baike.baidu.com/link?url=7ZA_4BfDbr6GrWB63XmAgdxAZ-DqUPT9d0kDK8j9f_-udpQhPYw-ZOtKeSwbB8SOWHqhiQskJH0jb36MYm6VQ6upLVWhC77F8i4S50E_lAX50K2SbzvvnvRpM2oszbaI0fVwW2eimU_ARUXMS1HIT_">一款显卡的性能由“像素填充率”和“显存带宽”两个部分构成。“像素填充率”衡量的是显卡的图形运算能力，“显存带宽”衡量的是显卡的数据传输能力。</a></li>
<li>GDDR5一般比GDDR3提供的频率更高(显卡性能要求高的优先考虑GDR5)</li>
</ol>
<p>所以买显卡主要看中的是“像素填充率”和“显存带宽”。<br>GPU性能比较参考GPU天梯图：<br><a target="_blank" rel="noopener" href="http://www.xiazaiba.com/jiaocheng/10296.html">GPU 2017年9月天梯图</a></p>
<h3 id="内存"><a href="#内存" class="headerlink" title="内存"></a>内存</h3><p><a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E5%86%85%E5%AD%98%E6%9D%A1">内存条是CPU可通过总线寻址，并进行读写操作的电脑部件。所有外存上的内容必须通过内存才能发挥作用。</a></p>
<p>可以看出内存的读写速度和CPU的运行速度是相辅相成的，一旦某一个速度跟不上都会造成性能上的瓶颈。</p>
<p>现在主流的内存采用的是DDR(Double Data Rate)技术，通过在一次系统时钟的上升沿和下降沿都可以进行数据传输实现双倍率传输。</p>
<p>DDR的内存速度计算公式：<br>内存实际频率 &#x3D; 内存频率 * 2(DDR技术，倍增系数)<br>带宽&#x3D;内存时钟频率×内存总线位数(多通道技术会提升理论内存位宽)×2(DDR技术，倍增系数)&#x2F;8</p>
<p>现在主流的内存是DDR3，DDR4还没有普及性价比不高而且需要特定的主板支持。需要注意的一点就是因为内存和CPU是相辅相成的，但内存与CPU之间的桥梁是前端总线，所以为了确保内存得到充分利用同时也不受限于前段总线频率，我们应该尽量选择前端总线频率和内存频率(这里的内存频率是指计算DDR技术和多通道技术之后的一个内存频率)相近的。</p>
<p>那么内存的读写速度由什么决定了？<br>跟显卡，CPU差不多，主要看频率和位宽，前者受DDR技术影响提高一倍，后者会受多通道技术影响。</p>
<p>Note:<br>这里的内存指的是CPU所使用的内存而非GPU的显存。<br>DDR3和DDR4不兼容，不支持混用。</p>
<h3 id="硬盘"><a href="#硬盘" class="headerlink" title="硬盘"></a>硬盘</h3><p>硬盘有机械硬盘(HDD)和固态硬盘(SSD)之分。<br>推荐使用固态硬盘的原因:</p>
<ol>
<li>比机械硬盘读写速度快</li>
<li>虽然擦写次数寿命比机械硬盘少，但理论上足够在几十年内使用</li>
<li>价格比机械硬盘贵，但在容量比较小的情况下还能够接受(推荐C盘系统盘弄个64G或者128G的SSD)</li>
</ol>
<p>这里要注意的是支持SSD的标准现在有很多，现在比较常见和流行的是SATA 3.0 6G。<br>其他还有PCL-E 3.0，mSATA，SATA Express，M.2等。<br><a target="_blank" rel="noopener" href="http://news.mydrivers.com/1/504/504984.htm">SSD接口全解析</a></p>
<h3 id="外设-鼠标，键盘，显示器"><a href="#外设-鼠标，键盘，显示器" class="headerlink" title="外设(鼠标，键盘，显示器)"></a>外设(鼠标，键盘，显示器)</h3><h4 id="键盘"><a href="#键盘" class="headerlink" title="键盘"></a>键盘</h4><p>普通键盘和机械键盘之分<br>看个人需求，机械键盘多用于专业人员(比如程序员)<br>机械键盘比普通键盘贵上很多倍，个人衡量价格。</p>
<h4 id="鼠标"><a href="#鼠标" class="headerlink" title="鼠标"></a>鼠标</h4><p>省略</p>
<h4 id="显示器"><a href="#显示器" class="headerlink" title="显示器"></a>显示器</h4><p>显示质量：<br>屏幕显示技术(IPS，PLS，TN)影响显示器显示效果。<br>详情参考:<br><a target="_blank" rel="noopener" href="https://www.zhihu.com/question/19571221">显示器的 VGA、HDMI、DVI 和DisplayPort接口有什么区别？</a></p>
<p>接口：<br>接口影响传输效率。</p>
<p>Note：<br>注意主板支持的VGA，DVI,HDMI,DP接口与显示器支持的接口一致。</p>
<p>分辨率选择:<br>分辨率除了考虑接口传输速度的支持，还要考虑线的传输速度限制(比如HDMI 1.4和HDMI 2.0所支持的传输速度就有很大区别，2K，4K对线的要求参考下方连接)。<br>详情参考:<br><a target="_blank" rel="noopener" href="http://digi.tech.qq.com/a/20160311/010517.htm">4K、2K超清显示器普及了 可高清线你会选吗？</a></p>
<h3 id="机箱"><a href="#机箱" class="headerlink" title="机箱"></a>机箱</h3><p>注意买与主板大小相匹配的机箱(比如 ATX大板，ATX小板等)。<br>考虑到铺线的问题，提前了解下机箱内部结构是否分布合理。</p>
<h3 id="电源"><a href="#电源" class="headerlink" title="电源"></a>电源</h3><p>保证电源稳定，且瓦数满足主板供电需求。(普通配置500W应该都能满足，高配置参考各配件的功耗来决定最终电源瓦数)</p>
<h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><h4 id="USB接口"><a href="#USB接口" class="headerlink" title="USB接口"></a>USB接口</h4><p>USB 3.0比USB 2.0高的不是一个数量级(理论上传输速度相差10倍以上)，能支持USB 3.0最好。</p>
<p>Note:<br>要想使用USB 3.0除了接口要支持，插入的USB设备也要支持USB 3.0才行。</p>
<h2 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h2><h3 id="装机"><a href="#装机" class="headerlink" title="装机"></a>装机</h3><ol>
<li>主板与CPU以及GPU<br>主板会决定是支持Intel CPU还是AMD CPU，同时主板会决定是支持NVIDA还是AMD显卡。</li>
</ol>
<p>CPU:<br>Intel CPU主要看是支持LGA ***多少，不一样的话会导致无法支持。<br>AMD CPU主要是看支持FX，AM2还是AM3，还是AM4标准等。</p>
<p>GPU:<br>显卡两大生产商NVIDA和AMD，两者一般不会同时支持，所以选主板和GPU的时候要注意。GPU主要是要注意主板支持的显卡插槽是PCLE 2.0还是PCLE 3.0，显卡GPU和主板的插槽要支持同样的PCLE版本，推荐选择最新的PCLE版本。</p>
<ol start="2">
<li>主板与SSD<br>选主板的时候会决定所支持的SSD接口标准，确定了支持的SSD标准，我们才能买到正确可以插上使用的SSD型号。现在流行的性价比高的就是比较普通的SATA 3.0接口。</li>
</ol>
<h3 id="尺寸"><a href="#尺寸" class="headerlink" title="尺寸"></a>尺寸</h3><ol>
<li>机箱和主板尺寸<br>机箱尺寸要和主板大小配合，有ATX，M-ATX等主板大小</li>
</ol>
<h2 id="硬件以及性能检测工具"><a href="#硬件以及性能检测工具" class="headerlink" title="硬件以及性能检测工具"></a>硬件以及性能检测工具</h2><h3 id="CPU-Z"><a href="#CPU-Z" class="headerlink" title="CPU-Z"></a>CPU-Z</h3><p>免费的检测硬件信息的一款软件(但在GPU方面还不是很足，所以下面有GPU-Z互补)<br>下载链接:<br><a target="_blank" rel="noopener" href="https://www.cpuid.com/softwares/cpu-z.html">CPU-Z Download</a></p>
<h3 id="GPU-Z"><a href="#GPU-Z" class="headerlink" title="GPU-Z"></a>GPU-Z</h3><p>免费的检测GPU硬件方面信息的一款软件<br>下载链接:<br><a target="_blank" rel="noopener" href="https://www.techpowerup.com/gpuz/">GPU-Z</a></p>
<h3 id="AS-SSD-Benchmark"><a href="#AS-SSD-Benchmark" class="headerlink" title="AS SSD Benchmark"></a>AS SSD Benchmark</h3><p>一款免费的检测硬盘速度以及SSD 4K对齐的软件。</p>
<h3 id="鲁大师"><a href="#鲁大师" class="headerlink" title="鲁大师"></a>鲁大师</h3><p>这个不用介绍了，检测跑分(CPU, GPU, 硬盘等)。<br><a target="_blank" rel="noopener" href="http://www.ludashi.com/">鲁大师</a></p>
<h1 id="装机相关参考网站"><a href="#装机相关参考网站" class="headerlink" title="装机相关参考网站"></a>装机相关参考网站</h1><h2 id="Conception-Part"><a href="#Conception-Part" class="headerlink" title="Conception Part"></a>Conception Part</h2><p><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E4%B8%BB%E6%9D%BF">主板</a><br><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%8C%97%E6%A1%A5">北桥</a><br><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%8D%97%E6%A1%A5">南桥</a><br><a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E8%B6%85%E9%A2%91%E6%8A%80%E6%9C%AF">超频技术</a><br><a target="_blank" rel="noopener" href="https://baike.baidu.com/item/CPU%E6%80%A7%E8%83%BD%E6%8C%87%E6%A0%87/7779822">cpu性能指标</a><br><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%A4%9A%E9%80%9A%E9%81%93%E8%A8%98%E6%86%B6%E9%AB%94%E6%8A%80%E8%A1%93">多通道内存技术</a></p>
<h2 id="Knowledge-Part"><a href="#Knowledge-Part" class="headerlink" title="Knowledge Part"></a>Knowledge Part</h2><p><a target="_blank" rel="noopener" href="http://www.it892.com/content/hardware/onboard/2014/1001/5581.html">计算机主板的组成部分及芯片介绍</a><br><a target="_blank" rel="noopener" href="https://developer.nvidia-china.com/forum.php?mod=viewthread&tid=7683">PCI-E 总线对GPU性能的影响</a><br><a target="_blank" rel="noopener" href="https://www.zhihu.com/question/57270200">DDR3和DDR4内存的区别</a><br><a target="_blank" rel="noopener" href="http://www.cnblogs.com/spinsoft/archive/2012/08/02/2619982.html">CPU主频，倍频，外频，系统总线频率，前端总线频率</a><br><a target="_blank" rel="noopener" href="http://www.it892.com/content/hardware/onboard/2013/0905/4863.html">电脑主板有哪些插槽详细介绍</a></p>
<h2 id="Performance-Comparision-Part"><a href="#Performance-Comparision-Part" class="headerlink" title="Performance Comparision Part"></a>Performance Comparision Part</h2><p><a target="_blank" rel="noopener" href="https://www.cpubenchmark.net/">CPU，GPU，RAM等Benchmark</a><br><a target="_blank" rel="noopener" href="http://www.xiazaiba.com/jiaocheng/10296.html">2017年9月 GPU天梯图</a><br><a target="_blank" rel="noopener" href="http://www.xiazaiba.com/jiaocheng/10299.html">2017年9月 CPU天梯图</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Other/">Other</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Computer/">Computer</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/08/29/计算机图形学相关知识/" title="计算机图形学相关知识" itemprop="url">计算机图形学相关知识</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Tony Tang" target="_blank" itemprop="author">Tony Tang</a>
		
  <p class="article-time">
    <time datetime="2015-08-29T10:28:18.000Z" itemprop="datePublished"> 发表于 2015-08-29</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>参考书籍：<br>《OpenGL Programming Guide 8th Edition》 – Addison Wesley<br>《Fundamentals of Computer Graphics (3rd Edition)》 – Peter Shirley, Steve Marschnner<br>《Real-Time Rendering, Third Edition》 – Tomas Akenine-Moller, Eric Haines, Naty Hoffman</p>
<h1 id="Rendering-Knowledge"><a href="#Rendering-Knowledge" class="headerlink" title="Rendering Knowledge"></a>Rendering Knowledge</h1><p>在进入书籍内容的学习之前，先了解一些必要的知识</p>
<h2 id="What-is-Rendering"><a href="#What-is-Rendering" class="headerlink" title="What is Rendering?"></a>What is Rendering?</h2><p>“Rendering is a process that takes as its input a set of objects and produces as its output an array of pixels.” – 《Fundamentals of Computer Graphics (3rd Edition)》</p>
<p>既然Rendering是通过处理一系列的对象数据最终输出成一组一组的像素呈现出来，那接下来的问题就是What is the rendering process(Graphic Pipeline)?</p>
<h2 id="What-is-the-rendering-process-Graphic-Pipeline"><a href="#What-is-the-rendering-process-Graphic-Pipeline" class="headerlink" title="What is the rendering process(Graphic Pipeline)?"></a>What is the rendering process(Graphic Pipeline)?</h2><p>首先我们来看看wiki上对pipieline的解释<br><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Graphics_pipeline">the sequence of steps used to create a 2D raster representation of a 3D scene.</a><br>那么结合Rendering的定义，不难看出Rendering pipeline就是一系列的操作（把前一个操作的输出当做输入）使得输入的对象数据最终以像素的形式输出到屏幕上</p>
<p>Note:<br>“A chain is no stronger than its weakest link.”<br>										—Anonymous<br>渲染的速度是由最慢的阶段决定的。</p>
<p>图形渲染和GPU的是密不可分的。<br>渲染管线最大的变化就是从传统的固定渲染管线转变到了可编程的渲染管线。</p>
<p>在了解固定渲染管线和可编程渲染管线之前，先让我们来了解一下什么是Rendering Pipeline。</p>
<h3 id="Rendering-Pipeline-Stages"><a href="#Rendering-Pipeline-Stages" class="headerlink" title="Rendering Pipeline Stages"></a>Rendering Pipeline Stages</h3><p><img src="/img/Graphic/Rendering_Stages.PNG" alt="Rendering_Stages"></p>
<ol>
<li><p>Application<br>e.g collision detection, global acceleration algorithms, animation, physics simulation….. (On CPU)<br>Acceleration algorithms, such as hierarchical view frustum culling, are also implemented in this stage. – 《Real-Time Rendering, Third Edition》<br>可以看出Application阶段主要是做一些非渲染相关的一些计算，但部分计算也可以帮助我们减少渲染数量提高渲染效率(比如:hierachical view frustum culling)</p>
</li>
<li><p>Geometry<br><img src="/img/Graphic/Geometry_Stage.PNG" alt="Geometry_Stage"><br>Deal with transforms, projection. Computes what is to be draw, how it should be drawn, and where it should be drawn (On GPU)<br>e.g. model and view transform, vertex shading, projection, clipping, and screen mapping – 《Real-Time Rendering, Third Edition》<br>可以看出Geometry阶段主要是负责3D到2D Screen的顶点运算和顶点剔除</p>
</li>
<li><p>Rasterizer<br><img src="/img/Graphic/Rasterize_Stage.PNG" alt="Rasterize_Stage"><br>Conversion from two-dimensional vertices in screen space – each with a z-value (depth value), and various shading information associated with each vertex – into pixels on the screen (On GPU) – 《Real-Time Rendering, Third Edition》<br>可以看出Rasterizer阶段主要是负责2D Screen的顶点像素运算(包括Z-Buffer test, Color computation, Alpha test, Stencil buffer等)</p>
</li>
</ol>
<p><strong>Accumulation Buffer</strong> – Images can be accumulated using a set of operators. E,g, motion blur……</p>
<p>让我们结合OpenGL Rendering Pipeline来学习理解：<br><img src="/img/OpenGL/OpenGL_Render_Pipeline.PNG" alt="OpenGL_Rendering_Pipeline"><br>从上图可以看出，OpenGL的第一个阶段Vertex Data相当于Application阶段所收集的数据</p>
<p>不难看出从Vertex Shader到Clipping都属于从3D到2D Screen的顶点运算和顶点剔除，所以这一部分处于Geometry阶段(由于后来统一架构的(US)原因，Vertex Shader, Geometry Shader, Pixel Shader很多)</p>
<p>而从Rasterization到最后的屏幕输出都是对像素的运算，所以是Rasterizer阶段<br><a href="http://tonytang1990.github.io/2015/08/26/OpenGL-Study/">OpenGL更多的学习了解</a></p>
<p>了解了什么是Rendering Pipeline之后，让我们来看看什么是固定管线和可编程管线？他们之间的关系是怎样的？</p>
<h3 id="传统的固定渲染管线"><a href="#传统的固定渲染管线" class="headerlink" title="传统的固定渲染管线"></a>传统的固定渲染管线</h3><p>什么叫做“像素渲染管线”了？<br>“<a target="_blank" rel="noopener" href="http://vga.zol.com.cn/238/2386200_all.html">传统的一条渲染管线是由包括Pixel Shader Unit（像素着色单元）+ TMU(纹理贴图单元) + ROP（光栅化引擎）三部分组成的。用公式表达可以简单写作：PS&#x3D;PSU+TMU+ROP 。从功能上看，PSU完成像素处理，TMU负责纹理渲染，而ROP则负责像素的最终输出。所以，一条完整的像素管线意味着在一个时钟周期完成至少进行1个PS运算，并输出一次纹理。</a>”</p>
<p>那么什么是PSU(像素着色器单元)？什么是TMU(纹理贴图单元)？什么是ROP(光栅化引擎)了？<br>在统一渲染架构（US(Unified Shader)）出现之前有单独的<strong>顶点着色器单元</strong>和<strong>像素着色器单元</strong>，分别负责顶点数据和像素处理。</p>
<p><strong>TMU(纹理贴图单元 – Texture Mapping Unit)</strong><br><a target="_blank" rel="noopener" href="http://vga.zol.com.cn/243/2433760_all.html">归根到底就是对材质的贴图和过滤操作。根据程序的需要，在完成几何处理和光栅化之后，TMU单元会从材质库中找出合适的纹理贴在对应的位置上以实现模型的外形完整化</a>”<br>在可编程渲染管线(Shader)出现后，程序员可以实现对像素级别上的操作，可以实现更加真实的效果(预先烘焙的材质无法真实的实时渲染)。Vertex Texture Fetch(顶点纹理拾取)的出现允许Vertex Shader直接访问材质的一些信息，这也算是TMU进军GPGPU的一个契机。<br><a target="_blank" rel="noopener" href="http://vga.zol.com.cn/243/2433760_all.html">从DirectX 9.0C开始，TMU单元正式分割成了TA和TF两个部分，TA单元专门负责材质的定址操作，在完成定址之后，TF单元根据定址结果对材质进行拾取并完成贴图作业。</a><br>后续改进<a target="_blank" rel="noopener" href="http://vga.zol.com.cn/243/2433760_all.html">纹理阵列(处理材质操作的纹理单元阵列)以及Gather指令(Gather指令的作用，在于允许单元从非连续存储器地址中直接读取数据。)</a><br>Computer Shader的出现也使得纯数学的纹理计算成为了可能。</p>
<p><strong>ROP(光栅化引擎 – Render Output Units)</strong><br><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Render_output_unit">The render output unit, often abbreviated as “ROP”, and sometimes called (perhaps more properly) raster operations pipeline.</a><br>Conversion from two-dimensional vertices in screen space – each with a z-value (depth value), and various shading information associated with each vertex – into pixels on the screen (On GPU) – 《Real-Time Rendering, Third Edition》</p>
<h3 id="可编程渲染管线"><a href="#可编程渲染管线" class="headerlink" title="可编程渲染管线"></a>可编程渲染管线</h3><p>为什么会有可编程渲染管线了？<br>“<a target="_blank" rel="noopener" href="http://vga.zol.com.cn/238/2386200_all.html">由于传统的渲染管线不可编辑性，实现的图像效果受到很大限制，Shader(着色器)的引入就替代了传统的固定渲染管线，实现了可编程的渲染管线，各个Shader(着色器)替代了固定渲染管线中相应的功能。</a>”</p>
<p>那么什么是Shader(着色器)？Shader(着色器)和GPU硬件的关系是怎样的了？<br>“Shaders are programmed using C-like shading languages such as HLSL, Cg and GLSL. These are compiled to a machine-independent assembly language, also called the intermediate language(IL). This assembly language is converted to the actual machine language in a separate step, usually in the drivers. This arrangement allows compatibility across different hardware implementations.” – Real-Time Rendering, Third Edition》<br><a target="_blank" rel="noopener" href="http://vga.zol.com.cn/238/2386200_all.html">GPU的像素着色器单元和顶点着色器单元就对应了Shader里面的Pixel Shader和Vertex Shader。由于像素在计算机都是以RGB三种颜色构成，加上Alpha总共4个通道，所以GPU的像素着色器单元和顶点着色器单元一开始就被设计成为同时具备4次运算能力的算数逻辑运算器(ALU)</a></p>
<p>从上面可以看出Shader是machine-independent的，因为事先被编译成了与机器无关的intermediate language(This intermediate language can be seen as defining a <strong>virtual machine</strong>, which is targeted by the shading language compiler – 《Real-Time Rendering, Third Edition》)， 最后才会被机器转换成机器码来运行.</p>
<p>可编程Shading进化史可参考<br>3.3 The Evolution of Programmable Shading – 《Real-Time Rendering, Third Edition》</p>
<h2 id="计算机架构与Shader的关系"><a href="#计算机架构与Shader的关系" class="headerlink" title="计算机架构与Shader的关系"></a>计算机架构与Shader的关系</h2><h3 id="非同一架构"><a href="#非同一架构" class="headerlink" title="非同一架构"></a>非同一架构</h3><p>那么影响Pixel Shader和Vertex Shader速度的因素又是什么了？<br>数据流处理速度。</p>
<p>我们都知道计算机是通过发送指令来对数据进行处理的，而计算机架构则是对指令流和数据处理的设计，是影响数据流处理速度的关键。</p>
<p>根据Flynn分类法，计算机架构分为：</p>
<ol>
<li>SISD(Single Instruction Signle Data Stream) – 单指令单数据流<br>“<a target="_blank" rel="noopener" href="http://vga.zol.com.cn/238/2386200_all.html">传统的顺序执行的计算机在同一时刻只能执行一条指令（即只有一个控制流）、处理一个数据（即只有一个数据流），因此被称为单指令单数据流计算（Single Instruction Single Data Stream,SISD）</a>”</li>
<li>MIMD(Multiple Instruction Multiple Data Stream) – 多指令多数据流<br><img src="/img/Graphic/MIMD.PNG" alt="MIMD"><br>“<a target="_blank" rel="noopener" href="http://vga.zol.com.cn/238/2386200_all.html">而对于大多数并行计算机而言，多个处理单元都是根据不同的控制流程执行不同的操作，处理不同的数据，因此，它们被称作是多指令流多数据流计算机，即MIMD（Multiple Instruction Stream Multiple Data Stream，简称MIMD）计算机，它使用多个控制器来异步地控制多个处理器，从而实现空间上的并行性。</a>”</li>
<li>SIMD(Single Instruction Multiple Data Stream) – 单指令多数据流<br><img src="/img/Graphic/SIMD.PNG" alt="SIMD"></li>
<li>MISD(Multiple Instruction Single Data Stream) – 多指令多数据流</li>
</ol>
<p>那么各个计算机架构设计之间的优势和劣势分别是什么了？<br>还记得我们之前说的像素着色单元和顶点着色单元已开被设计成具备4次运算能力的算数逻辑运算器(ALU)吗？<br>因为数据的基本单元是Scalar(标量),GPU的ALU一个时钟周期可进行四次这种变量并行运算。<br>那么如果我们传入4D标量进行运算，SIMD可以最大程度满足我们的需求，达到GPU利用率100%。但如果我们传入1D标量进行运算，SIMD的效率就会下降到原来的四分之一（随着API的更新，1D&#x2F;2D&#x2F;3D等混合指令开始大幅出现），固传统的SIMD架构效率开始降低。而3D+1D&#x2F;2D+2D等混合架构设计也并不能最大限度利用ALU运算能力，这也是统一架构出现的契机。</p>
<h3 id="统一架构"><a href="#统一架构" class="headerlink" title="统一架构"></a>统一架构</h3><p>“<a target="_blank" rel="noopener" href="http://vga.zol.com.cn/238/2386200_all.html">为了解决ALU利用率的问题，微软在Direct X 10提出了统一渲染架构的概念。<br>核心思想是：将Vertex Shader(顶点着色器)和Pixel Shader(像素着色器)单元合并成一个具备完整执行能力的US(Unified Shader,统一渲染)单元，指令直接面向底层的ALU而非过去的特定单元，所以在硬件层面US可以同时吞吐一切shader指令，同时并不会对指令进行任何修改，也不会对shader program的编写模式提出任何的强迫性的改变要求。</a>”<br><img src="/img/Graphic/US.PNG" alt="US"></p>
<p>统一架构出来以后，因为有了US(Unified Shader)单元，指令直接面向底层的ALU而非特定单元，所以后来的N卡统一架构把原来的4D着色器单元完全打散，流处理器(SP)统统由矢量设计改为了标量运算单元(由4D矢量运算器改为了1D标量运算器)，采用的是MIMD架构。</p>
<p>MIMD架构相比SIMD架构需要占用更多的晶体管数，因为4个1D标量ALU和一个4D矢量ALU的运算能力是相当的，但前者需要4个指令发射端和4个控制单元，而后者只需要1个</p>
<p>而A卡的流处理器(SPU)依然采用的是SIMD(单指令多数据流)架构，每个SPU内包含了5个ALU。</p>
<p>“<a target="_blank" rel="noopener" href="http://vga.zol.com.cn/238/2386200_all.html">N卡A卡对比总结：英伟达的所采用的MIMD（多指令流多数据流）标量架构的G80核心需要占用不少额外的晶体管，所以在流处理器数量和理论运算能力方面稍显吃亏，但优点是GPU Shader执行效率很高；而AMD所采用的SIMD(单指令多数据流)超标量架构的R600核心则用较少的晶体管数实现了更多的流处理器数量和更高的理论运算能力，不过在执行效率方面则需要视情况而定了</a>”</p>
<p>N卡的第二次革新引入的atomic单元以及SIMT(Single Instruction Multiple Thread)特性对N卡并行化设计起到了先到作用。</p>
<p>“<a target="_blank" rel="noopener" href="http://vga.zol.com.cn/238/2386200_all.html">N卡的第三次革新引入了四大块就是GPC(Graphics Processing Cluster,图形处理器簇)，每个GPC单元包含独立的集合引擎以及光栅化流水线，GPC模块之间透过新加入的L2 cache进行通讯,kernel和Thread的协调以及数据共享。这无疑使得GF100的三角形吞吐量有了将近300%的提升，也实现了并行的分块化渲染动作，更使得DirectX 11所要求的TS单元直接融入到了整个光栅化流水线内部。</a>”<br><img src="/img/Graphic/NThird.PNG" alt="N_Third"><br><img src="/img/Graphic/N_PE_RE.PNG" alt="N_PE_RE"></p>
<p><a target="_blank" rel="noopener" href="http://vga.zol.com.cn/238/2386200_all.html">A卡第二第三次革新</a></p>
<h2 id="Shader-Virtual-Machine-Shader-Model"><a href="#Shader-Virtual-Machine-Shader-Model" class="headerlink" title="Shader Virtual Machine (Shader Model)"></a>Shader Virtual Machine (Shader Model)</h2><p>了解了计算机架构与Shader的关系，让我们来看看Common-shader core virtual machine architecture and register layout吧<br><img src="/img/Graphic/Shader_Core_Virtual_Machine_Architecture.PNG" alt="Shader_Core_Virtual_Machine_Architecture_And_Register_Laout"></p>
<h3 id="Input-Type"><a href="#Input-Type" class="headerlink" title="Input Type"></a>Input Type</h3><ol>
<li><p>Uniform inputs<br>With values that remain constant throughout a draw call(but can be changed between draw calls) – accessed via read-only constant registers or constant buffers</p>
</li>
<li><p>Varying inputs<br>Which are different for each vertex or pixel processed by the shader – accessed via varying input registers</p>
</li>
</ol>
<h3 id="Shader-Knowledge"><a href="#Shader-Knowledge" class="headerlink" title="Shader Knowledge"></a>Shader Knowledge</h3><h4 id="Shader"><a href="#Shader" class="headerlink" title="Shader"></a>Shader</h4><p>Shader programs can be compiled offline before program load or during run time. As with any compiler, there are options for generating different output files and for using different optimization levels. A compiled shader is stored as a string of text, which is passed to the GPU via the driver.</p>
<h4 id="MRT-Multiple-Render-Target"><a href="#MRT-Multiple-Render-Target" class="headerlink" title="MRT(Multiple Render Target)"></a>MRT(Multiple Render Target)</h4><p><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Multiple_Render_Targets">MRT is a feature of modern graphics processing units, that allows the programmable rendering pipeline to render images to multiple render target textures at once. These textures can then be used as inputs to other shaders or as texture maps applied to 3D models.</a><br>？不是非常明白这里。大概是一次渲染可以对象信息存储在多个buffer里，然后以texture的形式交给后续pass的pixel shader做处理<br><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Deferred_shading">wiki上提到MRT的一个使用<strong>deferred shading</strong></a><br>在first pass的时候收集相应信息存储在特定buffer里，在second pass（真正的渲染绘制是在这里）的时候Pixel shader把这些信息用作渲染数据，把整个场景一次性渲染出来而不是针对每个空间物体进行光照，材质等渲染</p>
<h4 id="Effects"><a href="#Effects" class="headerlink" title="Effects"></a>Effects</h4><h5 id="什么是Effects文件了？"><a href="#什么是Effects文件了？" class="headerlink" title="什么是Effects文件了？"></a>什么是Effects文件了？</h5><p><a target="_blank" rel="noopener" href="https://msdn.microsoft.com/en-us/library/windows/desktop/ff476136(v=vs.85).aspx">A DirectX effect is a collection of pipeline state, set by expressions written in HLSL and some syntax that is specific to the effect framework</a></p>
<p>可以看出Effects文件主要是记录一系列的渲染状态和固定信息用于特定渲染流程里。</p>
<h5 id="为什么需要Effects文件了？"><a href="#为什么需要Effects文件了？" class="headerlink" title="为什么需要Effects文件了？"></a>为什么需要Effects文件了？</h5><p>在我们事先特定效果的渲染时，不仅需要一系列的shader文件，我们同时会设定相应的渲染状态和一些固定的渲染信息，这些状态和信息对于特定效果来说是固定不变的，所以通过Effects文件可以有效的帮助我们记录特定效果所需的渲染状态等信息，方便重复使用。</p>
<h5 id="Effects-Languages"><a href="#Effects-Languages" class="headerlink" title="Effects Languages"></a>Effects Languages</h5><p>Such as HLSL FX, CgFX, and COLLADA FX</p>
<h3 id="Shader-Models-Comparision"><a href="#Shader-Models-Comparision" class="headerlink" title="Shader Models Comparision"></a>Shader Models Comparision</h3><p><img src="/img/Graphic/Shader_Model_Comparision.PNG" alt="Shader_Models_Comparision"></p>
<h2 id="渲染总结"><a href="#渲染总结" class="headerlink" title="渲染总结"></a>渲染总结</h2><p>可编程管线的出现主要是由于固定管线能实现的渲染效果有限不够灵活，Shader的出现象征着可编程管线的诞生。</p>
<p>统一渲染架构主要是为了提高ALU(算数逻辑运算器)利用率的问题。US(Unified Shader)单元的出现象征则统一渲染架构的开始，指令直接面向底层的ALU而非特定单元，流处理器的数量成为了性能的关键，流处理器的设计和架构紧密相关。（并行分块花渲染也随之出现）</p>
<p>“<a target="_blank" rel="noopener" href="http://vga.zol.com.cn/238/2386200_all.html">DX9到DX10是一大转折点：结束管线时代，开启GPU统一渲染架构时代。在DX9时代，大家都是通过“(像素)管线”来衡量显卡的性能等级，而到了DX10时代，统一渲染架构的引入使得显卡不再区分“像素”和“顶点”，因此“管线”这种说法逐渐淡出了大家的视野，取而代之的是全新统一渲染架构的“流处理器”，“流处理器”的数量直接影响着显卡的性能。</a>”</p>
<p><a href="http://tonytang1990.github.io/2015/08/26/OpenGL-Study/">OpenGL更多的学习了解</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Rendering/">Rendering</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/OpenGL/">OpenGL</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/08/26/OpenGL学习/" title="OpenGL学习" itemprop="url">OpenGL学习</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Tony Tang" target="_blank" itemprop="author">Tony Tang</a>
		
  <p class="article-time">
    <time datetime="2015-08-26T15:57:05.000Z" itemprop="datePublished"> 发表于 2015-08-26</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p><strong>时隔将近一年了，再次拾起了还未学完的OpenGL，这一年工作生活学习状态都不好，希望这一次能重新好好的把OpenGL学好，把图形渲染的基础知识掌握好</strong>  – 游戏梦</p>
<p>参考书籍：<br>《OpenGL Programming Guide 8th Edition》 – Addison Wesley<br>《Fundamentals of Computer Graphics (3rd Edition)》 – Peter Shirley, Steve Marschnner<br>《Real-Time Rendering, Third Edition》 – Tomas Akenine-Moller, Eric Haines, Naty Hoffman</p>
<p><a target="_blank" rel="noopener" href="http://blog.sina.com.cn/tonytang1990">旧博客地址</a></p>
<p><a href="http://tonytang1990.github.io/2015/08/29/Computer-Graphic-Study/">渲染相关概念学习</a></p>
<h1 id="OpenGL"><a href="#OpenGL" class="headerlink" title="OpenGL"></a>OpenGL</h1><h2 id="Introdction-to-OpenGL"><a href="#Introdction-to-OpenGL" class="headerlink" title="Introdction to OpenGL"></a>Introdction to OpenGL</h2><h3 id="What-is-OpenGL"><a href="#What-is-OpenGL" class="headerlink" title="What is OpenGL?"></a>What is OpenGL?</h3><ol>
<li>OpenGL is an application programming interface – “API” for short – which is merely a software library for accessing features in graphics hardware.(访问图形硬件设备功能的API)</li>
<li>OpenGL is a “C” language library(OpenGL是一个C语言库)</li>
</ol>
<h3 id="History"><a href="#History" class="headerlink" title="History"></a>History</h3><p>It was first developed at Silicon Graphics Computer Systems with Version 1,0 released in July of 1994(<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/zh/OpenGL">wiki</a>)</p>
<h3 id="Next-Generation-OpenGL"><a href="#Next-Generation-OpenGL" class="headerlink" title="Next Generation OpenGL"></a>Next Generation OpenGL</h3><p><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Vulkan_%28API%29">Vulkan</a></p>
<h2 id="OpenGL-relative-knowledge"><a href="#OpenGL-relative-knowledge" class="headerlink" title="OpenGL relative knowledge"></a>OpenGL relative knowledge</h2><h3 id="OpenGL-render-pipeline"><a href="#OpenGL-render-pipeline" class="headerlink" title="OpenGL render pipeline"></a>OpenGL render pipeline</h3><p><img src="/img/OpenGL/OpenGL_Render_Pipeline.PNG" alt="OpenGL Render Pipeline"></p>
<ol>
<li><p>Vertex Data<br> Sending Data to OpenGL</p>
</li>
<li><p>Vertex Shader<br> Process the data associated with that vertex</p>
</li>
<li><p>Tessellation Shader<br> Tessellation uses patchs to describe an object’s shape, and allows relatively simple collections of patch geometry to be tessellated to increase the number of geometric primitives providing better-looking models (eg: LOD) </p>
</li>
<li><p>Geometry Shader<br> Allows additional processing of individual geometric primitives, including creating new ones, before rasterization</p>
</li>
<li><p>Primitive Assembly<br>Organizes the vertices into their associated geometric primitives in preparation for clipping and rasterization </p>
</li>
<li><p>Clipping<br> Clip the vertex and pixels are outside of the viewport – this operation is handled automatically by OpenGL</p>
</li>
<li><p>Rasterization<br> Fragment generation. Pixels have a home in the framebuffer, while a fragment still can be rejected and never update its associated pixel location. </p>
</li>
<li><p>Fragment Shading<br> Use a fragment shading to determine the fragment’s final color, and potentially its depth value</p>
</li>
<li><p>Per-Fragment Operations<br> If a fragment successfully makes it through all of the enabled tests (eg: depth testing, stencil testing), it may be written directly to the framebuffer, updating the color of its pixel, or if blending is enabled, the fragment’s color will be combined with the pixel’s current color to generate a new color that is written into the framebuffer</p>
</li>
</ol>
<p>Note:<br>Fragment’s visibility is determined using depth testing and stencil testing<br>Pixel data is usually stored in texture map for use with texture mapping, which allows any texture stage to look up data values from one or more texture maps.</p>
<h3 id="OpenGL-Shader-Language-GLSL"><a href="#OpenGL-Shader-Language-GLSL" class="headerlink" title="OpenGL Shader Language (GLSL)"></a><a target="_blank" rel="noopener" href="http://zh.wikipedia.org/wiki/GLSL">OpenGL Shader Language (GLSL)</a></h3><p>GLSL - OpenGL Shading Language 也称作 GLslang，是一个以C语言为基础的高阶着色语言。它是由 OpenGL ARB 所建立，提供开发者对绘图管线更多的直接控制，而无需使用汇编语言或硬件规格语言。</p>
<p>编译和执行<br>GLSL 着色器不是独立的应用程式；其需要使用 OpenGL API 的应用程式。C、C++、C#、Delphi 和 Java 皆支援 OpenGL API，且支援 OpenGL 着色语言。<br>GLSL 着色器本身只是简单的字串集，这些字串集会传送到硬件厂商的驱动程式，并从程式内部的 OpenGL API 进入点编译。着色器可从程式内部或读入纯文字档来即时建立，但必须以字串形式传送到驱动程式。</p>
<p>工具<br>GLSL 着色器可以事先建立和测试，现有以下 GLSL 开发工具：<br>RenderMonkey - 这个软件是由 ATI 制作的，提供界面用以建立、编译和除错 GLSL 着色器，和 DirectX 着色器一样。仅能在 Windows 平台上执行。<br>GLSLEditorSample - 在 Mac OS X 上，它是目前唯一可用的程式，其提供着色器的建立和编译，但不能除错。它是 cocoa 应用程式，仅能在 Mac OS X 上执行。<br>Lumina - Lumina 是新的 GLSL 开发工具。其使用 QT 界面，可以跨平台。</p>
<h3 id="The-color-space-in-OpenGL"><a href="#The-color-space-in-OpenGL" class="headerlink" title="The color space in OpenGL"></a>The color space in OpenGL</h3><p>In OpenGL, colors are represented in what’s called the RGB color space</p>
<h3 id="obj-and-mtl-file-format"><a href="#obj-and-mtl-file-format" class="headerlink" title=".obj and .mtl file format"></a>.obj and .mtl file format</h3><p>参考文章:<br><a target="_blank" rel="noopener" href="http://www.cnblogs.com/avril/archive/2010/08/06/1794437.html">obj文件基本结构及读取 - 计算机图形学</a><br><a target="_blank" rel="noopener" href="http://blog.csdn.net/sunyong_shj/article/details/15811173"> 3D模型-OBJ材质文件 MTL格式分析 </a><br><a target="_blank" rel="noopener" href="http://www.07net01.com/linux/_mtlwenjiangeshijiexi____jianmo__39917_1355121996.html">.mtl文件格式解析 - [建模]</a></p>
<p>“OBJ文件不包含面的颜色定义信息，不过可以引用材质库，材质库信息储存在一个后缀是”.mtl”的独立文件中。关键字”mtllib”即材质库的意思。 材质库中包含材质的漫射(diffuse)，环境(ambient)，光泽(specular)的RGB(红绿蓝)的定义值，以及反射(specularity)，折射(refraction)，透明度(transparency)等其它特征。  “usemtl”指定了材质之后，以后的面都是使用这一材质，直到遇到下一个”usemtl”来指定新的材质。”</p>
<p>.obj的一些基本内容格式描述：<br>	<br>    ‘#’ 这个就相当于C++代码里面的&#x2F;&#x2F;，如果一行开始时#，那么就可以理解为这一行完全是注释，解析的时候可以无视</p>
<pre><code>g 这个应该是geometry的缩写，代表一个网格，后面的是网格的名字。

v v是Vertex的缩写，很简单，代表一个顶点的局部坐标系中的坐标，可以有三个到四个分量。我之分析了三个分量，因为对于正常的三角形的网格来说，第四个分量是1，可以作为默认情况忽略。如果不是1，那可能这个顶点是自由曲面的参数顶点，这个我们这里就不分析了，因为大部分的程序都是用三角形的。

vn 这个是Vertex Normal，就是代表法线，这些向量都是单位的，我们可以默认为生成这个obj文件的软件帮我们做了单位化。

vt  这个是Vertex Texture Coordinate，就是纹理坐标了，一般是两个，当然也可能是一个或者三个，这里我之分析两个的情况。

mtllib &lt;matFileName&gt; 这个代表后面的名字是一个材质描述文件的名字，可以根据后面的名字去找相应的文件然后解析材质。

usemtl &lt;matName&gt; 这里是说应用名字为matName的材质，后面所有描述的面都是用这个材质，直到下一个usemtl。

f 这里就是face了，真正描述面的关键字。后面会跟一些索引。一般索引的数量是三个，也可能是四个（OpenGL里面可以直接渲染四边形，Dx的话只能分成两个三角形来渲染了）。每个索引数据中可能会有顶点索引，法线索引，纹理坐标索引，以/分隔。
</code></pre>
<p>.mtl文件（Material Library File）是材质库文件，描述的是物体的材质信息，ASCII存储，任何文本编辑器可以将其打开和编辑。一个.mtl文件可以包含一个或多个材质定义，对于每个材质都有其颜色，纹理和反射贴图的描述，应用于物体的表面和顶点。”<br>.mtl的一些基本内容格式描述：</p>
<pre><code>以下是一个材质库文件的基本结构：
newmtl mymtl_1
材质颜色光照定义
纹理贴图定义
反射贴图定义
……

注释：每个材质库可含多个材质定义，每个材质都有一个材质名。用newmtl mtlName来定义一个材质。对于每个材质，可定义它的颜色光照纹理反射等描述特征。主要的定义格式如下文所示：

////////////////////////////////////////////////
材质颜色光照
1。环境反射有以下三种描述格式，三者是互斥的，不能同时使用。
Ka r g b ——用RGB颜色值来表示，g和b两参数是可选的，如果只指定了r的值，则g和b的值都等于r的值。三个参数一般取值范围为0.0~1.0，在此范围外的值则相应的增加或减少反射率;
Ka spectral file.rfl factor ——用一个rfl文件来表示。factor是一个可选参数，表示.rfl文件中值的乘数，默认为1.0;
Ka xyz x y z ——用CIEXYZ值来表示，x，y，z是CIEXYZ颜色空间的各分量值。y和z两参数是可选的，如果只指定了x的值，则y和z的值都等于r的值。三个参数一般取值范围为0~1。

2。漫反射描述的三种格式：
Kd r g b
Kd spectral file.rfl factor
Kd xyz x y z

3。镜反射描述的三种格式:
Ks r g b
Ks spectral file.rfl factor
Ks xyz x y z

4。滤光透射率描述的三种格式：
Tf r g b
Tf spectral file.rfl factor
Tf xyz x y z

5。光照模型描述格式：

illum illum_#
指定材质的光照模型。illum后面可接0~10范围内的数字参数。各个参数代表的光照模
</code></pre>
<p>从上面的内容可以看出，.obj是描述关于顶点，法线，面，纹理坐标和材质引用等相关的数据的集合，而.mtl是用于定义实际材质信息的文件。</p>
<p>了解了.obj和.mtl文件里面的内容描述方式，让我们来看看在实际中.obj和.mtl文件内容来学习理解一下，以下内容来源于Modern OpenGL Tutorials – 3D Picking 的spider.obj和spider.mtl&#96;&#96;&#96;CPP<br>spider.obj</p>
<h1 id="Wavefront-OBJ-exported-by-MilkShape-3D"><a href="#Wavefront-OBJ-exported-by-MilkShape-3D" class="headerlink" title="Wavefront OBJ exported by MilkShape 3D"></a>Wavefront OBJ exported by MilkShape 3D</h1><p>mtllib spider.mtl</p>
<p>v 1.160379 4.512684 6.449167<br>…..</p>
<h1 id="762-vertices"><a href="#762-vertices" class="headerlink" title="762 vertices"></a>762 vertices</h1><p>vt 0.186192 0.222718<br>…..</p>
<h1 id="302-texture-coordinates"><a href="#302-texture-coordinates" class="headerlink" title="302 texture coordinates"></a>302 texture coordinates</h1><p>vn -0.537588 -0.071798 0.840146<br>……</p>
<h1 id="747-normals"><a href="#747-normals" class="headerlink" title="747 normals"></a>747 normals</h1><p>g HLeib01<br>usemtl HLeibTex<br>s 1<br>f 1&#x2F;1&#x2F;1 2&#x2F;2&#x2F;2 3&#x2F;3&#x2F;3<br>……</p>
<h1 id="80-triangles-in-group"><a href="#80-triangles-in-group" class="headerlink" title="80 triangles in group"></a>80 triangles in group</h1><p>……</p>
<h1 id="1368-triangles-total"><a href="#1368-triangles-total" class="headerlink" title="1368 triangles total"></a>1368 triangles total</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">从第二行mtllib spider.mtl可以看出spider.obj指定了纹理材质的描述文件是spider.mtl。</span><br><span class="line">后续的v, vn, vt, f, g描述了所有的关于顶点，顶点法线，顶点纹理坐标，face， geometry相关的数据信息。</span><br><span class="line">而紧跟着g后面usemtl Augentex则描述了该geometry所使用的材质名字是Augentex（这里的材质的具体信息在前面指定的spider.mtl文件中）。</span><br><span class="line"></span><br><span class="line">```CPP</span><br><span class="line">#</span><br><span class="line"># spider.mtl</span><br><span class="line">#</span><br><span class="line"></span><br><span class="line">newmtl Skin</span><br><span class="line">Ka 0.200000 0.200000 0.200000</span><br><span class="line">Kd 0.827451 0.792157 0.772549</span><br><span class="line">Ks 0.000000 0.000000 0.000000</span><br><span class="line">Ns 0.000000</span><br><span class="line">map_Kd .\wal67ar_small.jpg</span><br><span class="line"></span><br><span class="line">newmtl Brusttex</span><br><span class="line">Ka 0.200000 0.200000 0.200000</span><br><span class="line">Kd 0.800000 0.800000 0.800000</span><br><span class="line">Ks 0.000000 0.000000 0.000000</span><br><span class="line">Ns 0.000000</span><br><span class="line">map_Kd .\wal69ar_small.jpg</span><br><span class="line"></span><br><span class="line">newmtl HLeibTex</span><br><span class="line">Ka 0.200000 0.200000 0.200000</span><br><span class="line">Kd 0.690196 0.639216 0.615686</span><br><span class="line">Ks 0.000000 0.000000 0.000000</span><br><span class="line">Ns 0.000000</span><br><span class="line">map_Kd .\SpiderTex.jpg</span><br><span class="line"></span><br><span class="line">newmtl BeinTex</span><br><span class="line">Ka 0.200000 0.200000 0.200000</span><br><span class="line">Kd 0.800000 0.800000 0.800000</span><br><span class="line">Ks 0.000000 0.000000 0.000000</span><br><span class="line">Ns 0.000000</span><br><span class="line">map_Kd .\drkwood2.jpg</span><br><span class="line"></span><br><span class="line">newmtl Augentex</span><br><span class="line">Ka 0.200000 0.200000 0.200000</span><br><span class="line">Kd 0.800000 0.800000 0.800000</span><br><span class="line">Ks 0.000000 0.000000 0.000000</span><br><span class="line">Ns 0.000000</span><br><span class="line">map_Kd .\engineflare1.jpg</span><br></pre></td></tr></table></figure>

<p>第五行newmtl Skin定义了一个材质的名字，后面Ka, Kd, Ks, Ns， map_Kd分别是对该材质的环境反射，漫反射，镜面反射，高光系数，纹理图片的配置。</p>
<p>综合上述的理解，可以看出，当我们通过assimp引用加载spider.obj这个文件的时候，我们会去使用spider.mtl作为材质配置文件去作为读取到的材质相关的信息，从而我们知道了我们需要spider.obj,spider.mtl,wal67ar_small.jpg,wal69ar_small.jpg,SpiderTex.jpg,drkwood2.jpg,engineflare1.jpg这些文件提供我们完整的mesh渲染相关的数据。</p>
<h2 id="OpenGL-learning-journal"><a href="#OpenGL-learning-journal" class="headerlink" title="OpenGL learning journal"></a>OpenGL learning journal</h2><h3 id="API"><a href="#API" class="headerlink" title="API"></a>API</h3><ol>
<li><p>查看哪些错误标志位被设置<br>了解：<br>  OpenGL在内部保留了一组错误标志位(共4个),其中每一个标志位代表一种不同类型的错误。当错误一个发生时，与这个错误对应的标志就会被设置。如果被设置的标志不止一个，glGetError仍然只返回一个唯一的值。当glGetError函数被调用时，这个值随后被清除，然后在glGetError再次被调用时将返回一个错误标志或GL_NO_ERROR为止<br>函数：<br>Glenum glGetError(void); </p>
</li>
<li><p>查询OpenGL的渲染引擎（OpenGL驱动程序）的生产商和版本号<br>了解：<br> OpenGL允许提供商通过它的扩展机制进行创新。为了使用特定供应商所提供的一些特定扩展功能，我们希望限制这个特定供应商所提供驱动程序的最低版本号。<br>函数：<br>const Glubyte *glGetString(GLenum name);</p>
</li>
<li><p>设置和查询管线的状态<br>了解：<br>  OpenGL使用状态模型来跟踪所有的OpenGL状态变量来实现对OpenGL渲染状态的控制<br>函数：<br>void glEnable(GLenum capability);<br>void glDisable(GLenum capability);<br>void glGet*(Type)v(GLenum pname, GLboolean *params);</p>
</li>
<li><p>查询program的一些相关信息和一些错误信息<br>了解：<br> OpenGL的pragram链接可能由于GLSL里面的一些错误导致出错，我们需要知道关于program object的一些相关错误信息，同时我们也想知道我们现有的program相关的一些信息<br>函数：<br>void glGetProgramiv(GLuint program, GLenum pname, GLint *params);</p>
</li>
<li><p>得到shader链接出错的log信息<br>了解：<br> OpenGL的shader object可能链接失败，我们需要知道shader里面出错的信息<br>函数：<br>void glGetProgramInfoLog(GLuint program, GLsizei maxLength, GLsizei *length, GLchar *infoLog);</p>
</li>
</ol>
<p>注意:<br>可以通过glGetProgramiv()去得到program的一些log相关信息，比如GL_INFO_LOG_LENGTH</p>
<h3 id="OpenGL-Knowledge"><a href="#OpenGL-Knowledge" class="headerlink" title="OpenGL Knowledge:"></a>OpenGL Knowledge:</h3><ol>
<li><p>“OpenGL Execute Model:<br> The model for interpretation of OpenGL commands is client-server. An application (the client) issues commands, which are interpreted and processed by OpenGL (the server). The server may or may not operate on the same computer as the client. In this sense, OpenGL is network-transparent. “</p>
</li>
<li><p>“client-server 模式:<br> OpenGL 是一种 client-server 模式，当你的应用程序调用 OpenGL 函数时， 它将告诉OpenGL client， 然后 client 将渲染命令传送给 server. 这里client 和 server可能是不同的计算机，或是同一台计算机上的不同进程。一般来说 server 是在 GPU上处理的， 而 client 是在 CPU 上处理的，这样分担了 CPU 的负担， 同时高效利用了GPU.”</p>
</li>
</ol>
<p>但如果Client和Server没在同一个机器上，我们就需要一种一种网络传输协议框架来实现他们之间的交流：<br><a target="_blank" rel="noopener" href="http://blog.chinaunix.net/uid-28959509-id-3762988.html">X Window System</a></p>
<p>但X Window System里的client和server与传统的C&#x2F;S模式相反，client是负责运算的，server是负责显示的。<br>但OpenGL的client和server的交流原理是与X Window System相似的</p>
<h2 id="OpenGL-Practice"><a href="#OpenGL-Practice" class="headerlink" title="OpenGL Practice"></a>OpenGL Practice</h2><h3 id="Check-supported-OpenGL-version"><a href="#Check-supported-OpenGL-version" class="headerlink" title="Check supported OpenGL version"></a>Check supported OpenGL version</h3><ol>
<li>Install the appropriate graphic driver which enables usage of the functionality provided.<br> check the graphic drive update.(更新显卡驱动获得最新的OpenGL版本支持)</li>
<li>Using OpenGL extensions viewer to check which OpenGL version is supported(查看当前硬件所支持的OpenGL版本)<br> <a target="_blank" rel="noopener" href="http://www.realtech-vr.com/glview/download.php">download website</a></li>
</ol>
<p><img src="/img/OpenGL/GLViewer.PNG" alt="OpenGL_Viewer_Info"><br>从上图可以看出我当前的电脑和显卡驱动支持最高4.4，所以在使用学习OpenGL之前一定要确认好自己电脑所能支持的版本，避免后续不必要的问题。</p>
<p>检查完所支持的OpenGL版本后，下面我们需要介绍两个在学习OpenGL时为了帮助快速学习使用OpenGL的两个重要库（Glut &amp; Glew）</p>
<h3 id="Know-what-Glut-and-Glew-are-and-how-to-use-them"><a href="#Know-what-Glut-and-Glew-are-and-how-to-use-them" class="headerlink" title="Know what Glut and Glew are, and how to use them"></a>Know what Glut and Glew are, and how to use them</h3><ol>
<li><p><a target="_blank" rel="noopener" href="http://zh.wikipedia.org/wiki/GLUT">Glut (OpenGL Utility Toolkit)</a><br> GLUT（英文全写：OpenGL Utility Toolkit）是一个处理OpenGL程式的工具库，负责处理和底层操作系统的呼叫以及I&#x2F;O，并包括了以下常见的功能：</p>
<ol>
<li>定义以及控制视窗</li>
<li>侦测并处理键盘及鼠标的事件</li>
<li>以一个函数呼叫绘制某些常用的立体图形，例如长方体、球、以及犹他茶壶（实心或只有骨架，如glutWireTeapot()）</li>
<li>提供了简单选单列的实现</li>
</ol>
<p> GLUT是由Mark J. Kilgard在Silicon Graphics工作时所写，此人同时也是OpenGL Programming for the X Window System以及The Cg Tutorial: The Definitive Guide to Programmable Real-Time Graphics两书的作者。</p>
<p> GLUT的两个主要目的是建立一个跨平台的函式库（事实上GLUT就是跨平台的），以及简化学习OpenGL的条件。透过GLUT编写OpenGL通常只需要增加几行额外GLUT的程式码，而且不需要知道每个不同操作系统处理视窗的API。</p>
<p> 所有的GLUT函数都以glut作为开头，例如glutPostRedisplay()。</p>
</li>
<li><p><a target="_blank" rel="noopener" href="http://en.wikipedia.org/wiki/OpenGL_Extension_Wrangler_Library">Glew ( OpenGL Extension Wrangler Library)</a><br> The OpenGL Extension Wrangler Library (GLEW) is a cross-platform C&#x2F;C++ library that helps in querying and loading OpenGL extensions. GLEW provides efficient run-time mechanisms for determining which OpenGL extensions are supported on the target platform. All OpenGL extensions are exposed in a single header file, which is machine-generated from the official extension list.(Glew是一个支持跨平台的C&#x2F;C++库，用于运行时鉴别OpenGL扩展所支持的版本)<br> <a target="_blank" rel="noopener" href="http://www.opengl.org/sdk/tools/">more info for extention tools</a></p>
<p> How to use Glu &amp; Glew?</p>
<ol>
<li>add glu.lib &amp; glew.lib into additional dependencies</li>
<li>add the directory that includes glu.h &amp; glew.h into include dirctory</li>
<li>Include GL&#x2F;freeglut.h &amp; GL&#x2F;glew.h in source file<br> Note:<br> if you use static link, #define FREEGLUT_STATIC before you include GL&#x2F;freeglut.h, otherwise it will look for freeglut.lib. #define GLEW_STATIC for Glew.</li>
</ol>
<p> include GL&#x2F;glew.h before GL&#x2F;freeglut.h, otherwise, it will through “fatal error C1189: #error :  gl.h included before glew.h”</p>
</li>
</ol>
<p>Note:<br>后续的学习都是基于<a target="_blank" rel="noopener" href="http://ogldev.atspace.co.uk/index.html">Modern OpenGL Tutorials</a>,后续提到的一些库的源码从该网站下载</p>
<h3 id="Open-a-Window"><a href="#Open-a-Window" class="headerlink" title="Open a Window"></a>Open a Window</h3><p>IncludeFiles.h</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FREEGLUT_STATIC</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Glut part</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;GL/freeglut.h&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>OpenGLWindow.h</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;IncludeFiles.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">RenderCallback</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">glClear</span>(GL_COLOR_BUFFER_BIT);</span><br><span class="line">	<span class="comment">//Swap buffer</span></span><br><span class="line">	<span class="built_in">glutSwapBuffers</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">InitializeGlutCallback</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//sets the display callback for the current window</span></span><br><span class="line">	<span class="built_in">glutDisplayFunc</span>(&amp;RenderCallback);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>** argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//Initializes GLUT</span></span><br><span class="line">	<span class="built_in">glutInit</span>(&amp;argc, argv);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//GLUT_DOUBLE -- double buffer rendering</span></span><br><span class="line">	<span class="built_in">glutInitDisplayMode</span>(GLUT_DOUBLE | GLUT_RGBA);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//Initializa Windows info</span></span><br><span class="line">	<span class="built_in">glutInitWindowSize</span>(<span class="number">1024</span>, <span class="number">768</span>);</span><br><span class="line">	<span class="built_in">glutInitWindowPosition</span>(<span class="number">100</span>,<span class="number">100</span>);</span><br><span class="line">	<span class="built_in">glutCreateWindow</span>(<span class="string">&quot;OpenGLWindow&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">InitializeGlutCallback</span>();</span><br><span class="line"></span><br><span class="line">	<span class="comment">//Clear framebuffer before new draw call</span></span><br><span class="line">	<span class="built_in">glClearColor</span>(<span class="number">0.0f</span>,<span class="number">0.0f</span>,<span class="number">0.0f</span>,<span class="number">0.0f</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//enable program to enter the window event loop</span></span><br><span class="line">	<span class="built_in">glutMainLoop</span>();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>final result:<br><img src="/img/OpenGL/OpenGLWindow.PNG" alt="OpenGL_Window"></p>
<p>从上面可以看出我们主要是通过调用glut来初始化创建windows窗口<br>通过glut里的API我们可以去设置回调，去实现我们在渲染时期需要设置的OpenGL状态<br>上述主要有四个重要的glut API：</p>
<ol>
<li>glutInitDisplayMode(GLUT_DOUBLE | GLUT_RGBA) – GLUT_DOULBE开启了双buffer渲染，这样效率更高，一个buffer用于渲染，一个buffer用于填充下一帧数据</li>
<li>glutDisplayFunc – 设置glut里的渲染回调</li>
<li>glutMainLoop – 开启glut里的window event监听</li>
<li>glutCreateWindow – 设定完相关参数后，通过此方法我们能够创建出我们想要的Windows窗口，同时OpenGL Context也在这时候被创建出来</li>
</ol>
<p>Glut还提供了更多的关于Window的功能，后续会学习使用到</p>
<h3 id="Using-OpenGL"><a href="#Using-OpenGL" class="headerlink" title="Using OpenGL"></a>Using OpenGL</h3><p>上一章节只是用到了glut去初始化我们最基本的Window窗口，还没真正大量用到OpenGL里API，在使用OpenGL API之前我们需要通过Glew这个工具去检查当前所支持的OpenGL版本，然后才能正确的调用对应的API。</p>
<p>使用Glew的准备工作在How to use Glu &amp; Glew?时已经提到，这里不重述了</p>
<p>因为Glew需要通过context去查找对应所支持的OpenGL版本调用，所以初始化Glew必须在创建OpenGL Context之后。</p>
<p>Note:<br>Call glewInit after glutCreateWindow call successfully</p>
<p>那这里就不得不先了解一下什么是OpenGL Context了？<br>“”OpenGL Context””<br><a target="_blank" rel="noopener" href="https://open.gl/context">OpenGL context, which is essentially a state machine that stores all data related to the rendering of your application. When your application closes, the OpenGL context is destroyed and everything is cleaned up.</a></p>
<p>结合wiki<a target="_blank" rel="noopener" href="https://www.opengl.org/wiki/Creating_an_OpenGL_Context_%28WGL%29">Creating an OpenGL Context (WGL)</a>的介绍，这里我理解的不是很清晰，大概是OpenGL的Context相当于Device Context(DC)相对于Windows的概念一样。Context会设定很多跟渲染相关的状态(比如是否使用双buffer，depthbuffer占多少字节，颜色模式，窗口大小等渲染需要的信息)</p>
<p>这里我们只需要知道初始化Glut和调用glutCreateWindow创建窗口后，我们的OpenGL Context就生成了.</p>
<p>这也就是为什么在初始化glew之前必须先初始化Glut和创建Windows窗口的原因。</p>
<p>进一步了解参考：<br><a target="_blank" rel="noopener" href="https://www.opengl.org/wiki/Creating_an_OpenGL_Context_%28WGL%29">Creating an OpenGL Context (WGL)</a></p>
<p>Using Glew<br>接下来回到Glew的使用去绘制我们的第一个OpenGL圆点<br>IncludeFiles.h</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Glew part</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GLEW_STATIC</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;GL/glew.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Glut part</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FREEGLUT_STATIC</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;GL/freeglut.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;ogldev_math_3d.h&quot;</span></span></span><br></pre></td></tr></table></figure>

<p>UsingOpenGL.h</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;IncludeFiles.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">GLuint VBO;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">RenderCallback</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">glClear</span>(GL_COLOR_BUFFER_BIT);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">glEnableVertexAttribArray</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">glBindBuffer</span>(GL_ARRAY_BUFFER, VBO);</span><br><span class="line">	<span class="comment">//Tells the how to interpret the data inside the buffer</span></span><br><span class="line">	<span class="built_in">glVertexAttribPointer</span>(<span class="number">0</span>, <span class="number">3</span>, GL_FLOAT, GL_FALSE, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//Draw call</span></span><br><span class="line">	<span class="built_in">glDrawArrays</span>(GL_POINTS, <span class="number">0</span>,<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//Disable the vertex that is not used anymore after draw call</span></span><br><span class="line">	<span class="built_in">glDisableVertexAttribArray</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//Swap buffer</span></span><br><span class="line">	<span class="built_in">glutSwapBuffers</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">InitializeGlutCallback</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//sets the display callback for the current window</span></span><br><span class="line">	<span class="built_in">glutDisplayFunc</span>(&amp;RenderCallback);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">CreateVertexBuffer</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	Vector3f vertices[<span class="number">1</span>];</span><br><span class="line">	vertices[<span class="number">0</span>] = <span class="built_in">Vector3f</span>(<span class="number">0.0f</span>,<span class="number">0.0f</span>,<span class="number">0.0f</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 / Apply a buffer handles</span></span><br><span class="line"><span class="comment">	 / Bind buffer handle to specific buffer target</span></span><br><span class="line"><span class="comment">	 / Filling the data for buffer target</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	<span class="built_in">glGenBuffers</span>(<span class="number">1</span>, &amp;VBO);</span><br><span class="line">	<span class="built_in">glBindBuffer</span>(GL_ARRAY_BUFFER, VBO);</span><br><span class="line">	<span class="built_in">glBufferData</span>(GL_ARRAY_BUFFER, <span class="built_in">sizeof</span>(vertices), vertices, GL_STATIC_DRAW);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">InitializeGlutAndWindow</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>** argv, <span class="type">const</span> <span class="type">char</span>* windowsname)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//Initializes GLUT</span></span><br><span class="line">	<span class="built_in">glutInit</span>(&amp;argc, argv);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//GLUT_DOUBLE -- double buffer rendering</span></span><br><span class="line">	<span class="built_in">glutInitDisplayMode</span>(GLUT_DOUBLE | GLUT_RGBA);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//Initializa Windows info</span></span><br><span class="line">	<span class="built_in">glutInitWindowSize</span>(<span class="number">1024</span>, <span class="number">768</span>);</span><br><span class="line">	<span class="built_in">glutInitWindowPosition</span>(<span class="number">100</span>,<span class="number">100</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">glutCreateWindow</span>(windowsname);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">InitializeGlutCallback</span>();</span><br><span class="line"></span><br><span class="line">	<span class="comment">//Initialize glew</span></span><br><span class="line">	GLenum res = <span class="built_in">glewInit</span>();</span><br><span class="line">	<span class="keyword">if</span>(res != GLEW_OK)</span><br><span class="line">	&#123;</span><br><span class="line">		cout&lt;&lt;<span class="string">&quot;Error: &quot;</span>&lt;&lt;<span class="built_in">glewGetErrorString</span>(res)&lt;&lt;endl;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//Clear framebuffer before new draw call</span></span><br><span class="line">	<span class="built_in">glClearColor</span>(<span class="number">0.0f</span>,<span class="number">0.0f</span>,<span class="number">0.0f</span>,<span class="number">0.0f</span>);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">CreateVertexBuffer</span>();</span><br><span class="line"></span><br><span class="line">	<span class="comment">//enable program to enter the window event loop</span></span><br><span class="line">	<span class="built_in">glutMainLoop</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>** argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">InitializeGlutAndWindow</span>(argc, argv, <span class="string">&quot;UsingOpenGL&quot;</span>);	</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从上面可以看出，我们初始化glew只是调用了glewInit()方法，但主要一定要在OpenGL context创建完成后调用(即glutCreateWindow窗口创建之后)</p>
<p>我们创建并使用vertext buffer主要由5个步骤：</p>
<ol>
<li>glGenBuffers() – 创建一个可用的buffer obejct</li>
<li>glBindBuffer() – 绑定buffer object到指定的target类型，target类型代表我们的buffer object包含什么样的数据用于什么样的用途</li>
<li>glBufferData() – 填充buffer数据</li>
<li>glVertexAttribPointer() – 指明如何去解析buffer里的数据，同时这里也指明了如何在shader里面访问这些数据(至于如何编写，编译，链接和使用Shader，后续会讲到。)</li>
<li>glDrawArrays() – 调用draw指明如何使用并绘制buffer里面的数据</li>
</ol>
<p>Note：<br>这里需要注意的一点，要想在Shader里访问buffer里面的attribute数据，我们需要在调用draw之前调用glEnableVertexAttribArray()来激活特定的attribute</p>
<p>final result:<br><img src="/img/OpenGL/UsingOpenGL.PNG" alt="OpenGL_Window"></p>
<h3 id="Using-Shader"><a href="#Using-Shader" class="headerlink" title="Using Shader"></a>Using Shader</h3><p><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Shader">In the field of computer graphics, a shader is a computer program that is used to do shading: the production of appropriate levels of color within an image, or, in the modern era, also to produce special effects or do video post-processing.</a></p>
<p>上述是Wiki上Shader的定义。Shader是在可编程管线出现后，以程序的形式对渲染的各个阶段进行图形图像上的处理，使渲染变得更加灵活，主要作用于GPU上。</p>
<p>Shader作用于渲染的各个阶段：<br>之前在“Understand OpenGL render pipeline”有讲到各个渲染管线，这里就不再重述。可见Shader作用于大部分管线，比如：Vertex Shader（负责vertex数据处理），Tessellation Shader（负责以图形patch为单位的处理，用于描述物体形状数据，LOD就是在这个阶段实现的），Geometry Shader（以整个图形原件数据作为输入做处理，好比batch rendering可在这个阶段实现），Fragment Shading（以fragment(片元)数据作为输入做处理）</p>
<p>Shader Language在前面的“Understand OpenGL Shader Language”有讲到，这里就不重述了。</p>
<p>从上可见Shader在可编程管线的今天有着多么重要的作用。<br>接下来让我们看看在OpenGL中如何使用Shader吧。</p>
<p>使用Shader主要有下列几个步骤：</p>
<ol>
<li>Create a shader object – glCreateShader(GLenum type)（创建shader对象）</li>
<li>Compile your shader source into the object – glShaderSource(******)  glCompileShader(***)（编译shader文件，存储到shader对象中）</li>
<li>Verify that your shader compiled successfully – glGetShaderInfoLog(***)（检查shader编译是否成功并获取错误信息）</li>
<li>Create a shader program – glCreateProgram(void)（创建shader程序）</li>
<li>Attach the appropriate shader objects to the shader program – glAttachShader(GLuint program, Gluint shader)（附加多个shader对象到shader程序中）</li>
<li>Link the shader program – glLinkProgram(GLuint program)（链接shader程序）</li>
<li>Verify that the shader link phase completed successfully – glGetProgramiv() &amp; glGetProgramInfoLog(****)（检查shader程序链接是否成功并获取错误信息）</li>
<li>Use the shader for vertex or fragment processing – glUseProgram(GLuint program)（使用shader程序做顶点处理或片元处理）</li>
</ol>
<p>Shader出错后因为我们快速退出了程序，所以很难看到console的错误信息，所以最好的方式是把错误信息写入文本文件以供后续查看。Utils.h是关于编译和使用Shader并打印错误信息到文本的实现。<br>IncludeFiles.h</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fstream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Glew part</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GLEW_STATIC</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;GL/glew.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Glut part</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FREEGLUT_STATIC</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;GL/freeglut.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;ogldev_util.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;ogldev_math_3d.h&quot;</span></span></span><br></pre></td></tr></table></figure>

<p>Utils.h</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;IncludeFiles.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">serializationShaderCompileLog</span><span class="params">(GLuint prog, GLuint shader, GLenum type, <span class="type">char</span> *log)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="type">char</span> *stage_name = <span class="keyword">new</span> <span class="type">char</span>[<span class="number">50</span>];</span><br><span class="line">	<span class="type">char</span> temp[<span class="number">50</span>];</span><br><span class="line">	<span class="keyword">switch</span>(type)</span><br><span class="line">	&#123;</span><br><span class="line">	<span class="keyword">case</span> <span class="number">0x8B31</span>:</span><br><span class="line">		<span class="built_in">sprintf</span>(temp, <span class="string">&quot;program%d-shader%d-%s&quot;</span>, prog, shader, <span class="string">&quot;GL_VERTEX_SHADER&quot;</span>);</span><br><span class="line">		<span class="built_in">strcpy</span>(stage_name,temp);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="number">0x8DD9</span>:</span><br><span class="line">		<span class="built_in">sprintf</span>(temp, <span class="string">&quot;program%d-shader%d-%s&quot;</span>, prog, shader, <span class="string">&quot;GL_GEOMETRY_SHADER&quot;</span>);</span><br><span class="line">		<span class="built_in">strcpy</span>(stage_name,temp);</span><br><span class="line"></span><br><span class="line">		<span class="comment">//strcpy(stage_name,&quot;program:&quot; + prog + &quot;shader:&quot; + shader + &quot;stage:&quot; + &quot;GL_GEOMETRY_SHADER&quot;);</span></span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="number">0x8B30</span>:</span><br><span class="line">		<span class="built_in">sprintf</span>(temp, <span class="string">&quot;program%d-shader%d-%s&quot;</span>, prog, shader, <span class="string">&quot;GL_FRAGMENT_SHADER&quot;</span>);</span><br><span class="line">		<span class="built_in">strcpy</span>(stage_name,temp);</span><br><span class="line"></span><br><span class="line">		<span class="comment">//strcpy(stage_name,&quot;program:&quot; + prog + &quot;shader:&quot; + shader + &quot;stage:&quot; + &quot;GL_FRAGMENT_SHADER&quot;);</span></span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	cout&lt;&lt;<span class="string">&quot;program:&quot;</span>&lt;&lt;prog&lt;&lt;<span class="string">&quot;-shader:&quot;</span>&lt;&lt;shader&lt;&lt;<span class="string">&quot;-stage:&quot;</span>&lt;&lt;stage_name&lt;&lt;<span class="string">&quot; compile log:&quot;</span>&lt;&lt;endl;</span><br><span class="line">	cout&lt;&lt;log&lt;&lt;endl;</span><br><span class="line"></span><br><span class="line">	<span class="type">char</span> *file_name = <span class="keyword">new</span> <span class="type">char</span>[<span class="number">50</span>];</span><br><span class="line"></span><br><span class="line">	<span class="built_in">strcpy</span>(file_name,stage_name);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">strcat</span>(file_name,<span class="string">&quot;.txt&quot;</span>);</span><br><span class="line"></span><br><span class="line">	ofstream write_to_file;</span><br><span class="line">	write_to_file.<span class="built_in">open</span>(file_name,ios::out);</span><br><span class="line"></span><br><span class="line">	write_to_file&lt;&lt;stage_name;</span><br><span class="line">	write_to_file&lt;&lt;<span class="string">&quot; compiled log info;\n&quot;</span>;</span><br><span class="line">	write_to_file&lt;&lt;log;</span><br><span class="line">	write_to_file.<span class="built_in">close</span>();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">delete</span> []stage_name;</span><br><span class="line">	<span class="keyword">delete</span> []file_name;</span><br><span class="line"></span><br><span class="line">	stage_name = <span class="literal">nullptr</span>;</span><br><span class="line">	file_name = <span class="literal">nullptr</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">program_log_serialization</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> program,<span class="type">char</span> <span class="type">const</span> *program_name,<span class="type">bool</span> is_console_print)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	GLchar *program_linked_log = <span class="literal">NULL</span>;</span><br><span class="line">	GLint log_length = <span class="number">0</span>;</span><br><span class="line">	<span class="built_in">glGetProgramiv</span>(program, GL_INFO_LOG_LENGTH, &amp;log_length);</span><br><span class="line">	program_linked_log = <span class="keyword">new</span> <span class="type">char</span>[log_length];</span><br><span class="line"></span><br><span class="line">	GLsizei program_linked_log_real_length;</span><br><span class="line">	<span class="built_in">glGetProgramInfoLog</span>(program, log_length, &amp;program_linked_log_real_length, program_linked_log);</span><br><span class="line">	<span class="keyword">if</span>(is_console_print)</span><br><span class="line">	&#123;</span><br><span class="line">		cout&lt;&lt;program_name&lt;&lt;<span class="string">&quot; linked log info:&quot;</span>&lt;&lt;endl;</span><br><span class="line">		cout&lt;&lt;program_linked_log&lt;&lt;endl;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="type">const</span> <span class="type">int</span> file_name_length = <span class="built_in">strlen</span>(program_name);</span><br><span class="line"></span><br><span class="line">	<span class="type">char</span> *log_file_whole_name = <span class="keyword">new</span> <span class="type">char</span>[file_name_length + <span class="number">10</span>];</span><br><span class="line"></span><br><span class="line">	<span class="built_in">strcpy</span>(log_file_whole_name,<span class="built_in">const_cast</span>&lt;<span class="type">char</span>*&gt;(program_name));</span><br><span class="line"></span><br><span class="line">	<span class="built_in">strcat</span>(log_file_whole_name,<span class="string">&quot;.txt&quot;</span>);</span><br><span class="line"></span><br><span class="line">	ofstream write_to_file;</span><br><span class="line">	write_to_file.<span class="built_in">open</span>(log_file_whole_name,ios::out);</span><br><span class="line"></span><br><span class="line">	write_to_file&lt;&lt;*program_name + <span class="string">&quot; linked log info;\n&quot;</span>;</span><br><span class="line">	write_to_file&lt;&lt;program_linked_log;</span><br><span class="line">	write_to_file.<span class="built_in">close</span>();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">delete</span> []program_linked_log;</span><br><span class="line">	<span class="keyword">delete</span> []log_file_whole_name;</span><br><span class="line"></span><br><span class="line">	program_linked_log = <span class="literal">nullptr</span>;</span><br><span class="line">	log_file_whole_name = <span class="literal">nullptr</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">AddShader</span><span class="params">(GLuint shaderprogram, <span class="type">const</span> <span class="type">char</span>* pshadertext, GLenum shadertype)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	GLuint shaderobj = <span class="built_in">glCreateShader</span>(shadertype);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(shaderobj == <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		cout&lt;&lt;<span class="string">&quot;Error create shader type &quot;</span>&lt;&lt;shadertype&lt;&lt;endl;</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="type">const</span> GLchar *p[<span class="number">1</span>];</span><br><span class="line">	p[<span class="number">0</span>] = pshadertext;</span><br><span class="line">	GLint lengths[<span class="number">1</span>];</span><br><span class="line">	lengths[<span class="number">0</span>] = <span class="built_in">strlen</span>(pshadertext);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">glShaderSource</span>(shaderobj, <span class="number">1</span>, p, lengths);</span><br><span class="line">	<span class="built_in">glCompileShader</span>(shaderobj);</span><br><span class="line"></span><br><span class="line">	GLint success;</span><br><span class="line">	<span class="built_in">glGetShaderiv</span>(shaderobj, GL_COMPILE_STATUS, &amp;success);</span><br><span class="line">	<span class="keyword">if</span>(!success)</span><br><span class="line">	&#123;</span><br><span class="line">		GLchar infolog[<span class="number">1024</span>];</span><br><span class="line">		<span class="built_in">glGetShaderInfoLog</span>(shaderobj, <span class="number">1024</span>, <span class="literal">NULL</span>, infolog);</span><br><span class="line">		cout&lt;&lt;<span class="string">&quot;Error compiling shader type &quot;</span>&lt;&lt;shadertype&lt;&lt;endl;</span><br><span class="line"></span><br><span class="line">		<span class="built_in">serializationShaderCompileLog</span>(shaderprogram, shaderobj, shadertype, infolog);</span><br><span class="line"></span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">glAttachShader</span>(shaderprogram, shaderobj);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">CompileShader</span><span class="params">(GLuint shaderprogram, <span class="type">const</span> <span class="type">char</span>* psfilename, GLenum shadertype)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(shaderprogram == <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		cout&lt;&lt;<span class="string">&quot;Error creating shader program&quot;</span>&lt;&lt;endl;</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	string s;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(!<span class="built_in">ReadFile</span>(psfilename, s))</span><br><span class="line">	&#123;</span><br><span class="line">		cout&lt;&lt;psfilename&lt;&lt;<span class="string">&quot; is not exit&quot;</span>&lt;&lt;endl;</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">switch</span>(shadertype)</span><br><span class="line">	&#123;</span><br><span class="line">	<span class="keyword">case</span> <span class="number">0x8B31</span>:</span><br><span class="line">		<span class="built_in">AddShader</span>(shaderprogram, s.<span class="built_in">c_str</span>(), GL_VERTEX_SHADER);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="number">0x8DD9</span>:</span><br><span class="line">		<span class="built_in">AddShader</span>(shaderprogram, s.<span class="built_in">c_str</span>(), GL_GEOMETRY_SHADER);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="number">0x8B30</span>:</span><br><span class="line">		<span class="built_in">AddShader</span>(shaderprogram, s.<span class="built_in">c_str</span>(), GL_FRAGMENT_SHADER);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">LinkAndUseShaderProgram</span><span class="params">(GLuint shaderprogram)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	GLint success = <span class="number">0</span>;</span><br><span class="line">	GLchar errorlog[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">glLinkProgram</span>(shaderprogram);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">glGetProgramiv</span>(shaderprogram, GL_LINK_STATUS, &amp;success);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(success == <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">glGetProgramInfoLog</span>(shaderprogram, <span class="built_in">sizeof</span>(errorlog), <span class="literal">NULL</span>, errorlog);</span><br><span class="line">		cout&lt;&lt;<span class="string">&quot;Error linking shader program &quot;</span>&lt;&lt;errorlog&lt;&lt;endl;</span><br><span class="line">		<span class="built_in">program_log_serialization</span>(shaderprogram, <span class="string">&quot;LinkStatus&quot;</span>, <span class="literal">true</span>);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">glValidateProgram</span>(shaderprogram);</span><br><span class="line">	<span class="built_in">glGetProgramiv</span>(shaderprogram, GL_VALIDATE_STATUS, &amp;success);</span><br><span class="line">	<span class="keyword">if</span>(!success)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">glGetProgramInfoLog</span>(shaderprogram, <span class="built_in">sizeof</span>(errorlog), <span class="literal">NULL</span>, errorlog);</span><br><span class="line">		cout&lt;&lt;<span class="string">&quot;Invalid shader program &quot;</span>&lt;&lt;errorlog&lt;&lt;endl;</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">glUseProgram</span>(shaderprogram);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>UsingShader.cpp</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;IncludeFiles.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Utils.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">GLuint VBO;</span><br><span class="line"></span><br><span class="line">GLuint ShaderProgram;</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* pVSFileName = <span class="string">&quot;vsshader.vs&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* pFSFileName = <span class="string">&quot;fsshader.fs&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">RenderCallback</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">glClear</span>(GL_COLOR_BUFFER_BIT);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">glEnableVertexAttribArray</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">glBindBuffer</span>(GL_ARRAY_BUFFER, VBO);</span><br><span class="line">	<span class="comment">//Tells the how to interpret the data inside the buffer</span></span><br><span class="line">	<span class="built_in">glVertexAttribPointer</span>(<span class="number">0</span>, <span class="number">3</span>, GL_FLOAT, GL_FALSE, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//Draw call</span></span><br><span class="line">	<span class="built_in">glDrawArrays</span>(GL_TRIANGLES, <span class="number">0</span>,<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//Disable the vertex that is not used anymore after draw call</span></span><br><span class="line">	<span class="built_in">glDisableVertexAttribArray</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//Swap buffer</span></span><br><span class="line">	<span class="built_in">glutSwapBuffers</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">InitializeGlutCallback</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//sets the display callback for the current window</span></span><br><span class="line">	<span class="built_in">glutDisplayFunc</span>(&amp;RenderCallback);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">CreateVertexBuffer</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	Vector3f vertices[<span class="number">3</span>];</span><br><span class="line">	vertices[<span class="number">0</span>] = <span class="built_in">Vector3f</span>(<span class="number">-1.0f</span>,<span class="number">-1.0f</span>,<span class="number">0.0f</span>);</span><br><span class="line">	vertices[<span class="number">1</span>] = <span class="built_in">Vector3f</span>(<span class="number">1.0f</span>, <span class="number">-1.0f</span>, <span class="number">0.0f</span>);</span><br><span class="line">	vertices[<span class="number">2</span>] = <span class="built_in">Vector3f</span>(<span class="number">0.0f</span>, <span class="number">1.0f</span>, <span class="number">0.0f</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 / Apply a buffer handles</span></span><br><span class="line"><span class="comment">	 / Bind buffer handle to specific buffer target</span></span><br><span class="line"><span class="comment">	 / Filling the data for buffer target</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	<span class="built_in">glGenBuffers</span>(<span class="number">1</span>, &amp;VBO);</span><br><span class="line">	<span class="built_in">glBindBuffer</span>(GL_ARRAY_BUFFER, VBO);</span><br><span class="line">	<span class="built_in">glBufferData</span>(GL_ARRAY_BUFFER, <span class="built_in">sizeof</span>(vertices), vertices, GL_STATIC_DRAW);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">InitializeGlutAndWindow</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>** argv, <span class="type">const</span> <span class="type">char</span>* windowsname)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//Initializes GLUT</span></span><br><span class="line">	<span class="built_in">glutInit</span>(&amp;argc, argv);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//GLUT_DOUBLE -- double buffer rendering</span></span><br><span class="line">	<span class="built_in">glutInitDisplayMode</span>(GLUT_DOUBLE | GLUT_RGBA);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//Initializa Windows info</span></span><br><span class="line">	<span class="built_in">glutInitWindowSize</span>(<span class="number">1024</span>, <span class="number">768</span>);</span><br><span class="line">	<span class="built_in">glutInitWindowPosition</span>(<span class="number">100</span>,<span class="number">100</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">glutCreateWindow</span>(windowsname);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">InitializeGlutCallback</span>();</span><br><span class="line"></span><br><span class="line">	<span class="comment">//Initialize glew</span></span><br><span class="line">	GLenum res = <span class="built_in">glewInit</span>();</span><br><span class="line">	<span class="keyword">if</span>(res != GLEW_OK)</span><br><span class="line">	&#123;</span><br><span class="line">		cout&lt;&lt;<span class="string">&quot;Error: &quot;</span>&lt;&lt;<span class="built_in">glewGetErrorString</span>(res)&lt;&lt;endl;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//Clear framebuffer before new draw call</span></span><br><span class="line">	<span class="built_in">glClearColor</span>(<span class="number">0.0f</span>,<span class="number">0.0f</span>,<span class="number">0.0f</span>,<span class="number">0.0f</span>);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">CreateVertexBuffer</span>();</span><br><span class="line"></span><br><span class="line">	ShaderProgram = <span class="built_in">glCreateProgram</span>();</span><br><span class="line"></span><br><span class="line">	<span class="built_in">CompileShader</span>(ShaderProgram, pVSFileName, GL_VERTEX_SHADER);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">CompileShader</span>(ShaderProgram, pFSFileName, GL_FRAGMENT_SHADER);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">LinkAndUseShaderProgram</span>(ShaderProgram);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//enable program to enter the window event loop</span></span><br><span class="line">	<span class="built_in">glutMainLoop</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>** argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">InitializeGlutAndWindow</span>(argc, argv, <span class="string">&quot;UsingOpenGL&quot;</span>);	</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>vsshader.vs</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#version 330</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">layout</span> (location = <span class="number">0</span>) in vec3 Position;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    gl_Position = <span class="built_in">vec4</span>(Position.x,Position.y,Position.z, <span class="number">1.0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>fsshader.fs</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#version 330</span></span><br><span class="line"></span><br><span class="line">out vec4 FragColor;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    FragColor = <span class="built_in">vec4</span>(<span class="number">1.0</span>, <span class="number">0.0</span>, <span class="number">0.0</span>, <span class="number">1.0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>final effect:<br><img src="/img/OpenGL/UsingShader.PNG" alt="UsingShader"></p>
<p>上述只使用到了Vertex Shader和Framgment Shader, 后续还会讲到其他Shader的使用。</p>
<h3 id="Uniform-Variables"><a href="#Uniform-Variables" class="headerlink" title="Uniform Variables"></a>Uniform Variables</h3><p><a target="_blank" rel="noopener" href="https://www.opengl.org/sdk/docs/tutorials/ClockworkCoders/uniform.php">Uniform variables are used to communicate with your vertex or fragment shader from “outside”.</a></p>
<p><a target="_blank" rel="noopener" href="https://www.opengl.org/sdk/docs/tutorials/ClockworkCoders/uniform.php">Uniform variables are read-only and have the same value among all processed vertices. You can only change them within your C++ program.</a></p>
<p>从上面可以看出Uniform变量主要用于Vertex和Fragment Shader,并且对于所有传入的顶点值都不变，只能通过C++一侧去改变Uniform Variable的值。</p>
<p>接下来我们看看Uniform Variable是如何应用在Shader中的：<br>使用Uniform Variable主要有以下几个步骤：</p>
<ol>
<li>Obtain uniform variable location after Link Shader Program</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gScaleLocation = <span class="built_in">glGetUniformLocation</span>(ShaderProgram, <span class="string">&quot;gScale&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">assert</span>(gScaleLocation != <span class="number">0xFFFFFFFF</span>);</span><br></pre></td></tr></table></figure>
<ol start="2">
<li><pre><code>Set uniform variable value
</code></pre>
</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gScale += <span class="number">0.01f</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">glUniform1f</span>(gScaleLocation, <span class="built_in">sinf</span>(gScale));</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>Define uniform variable in Shader</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#version 330</span></span><br><span class="line"></span><br><span class="line">uniform <span class="type">float</span> gScale;</span><br><span class="line"></span><br><span class="line"><span class="built_in">layout</span> (location = <span class="number">0</span>) in vec3 Position;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    gl_Position = <span class="built_in">vec4</span>(gScale * Position.x,gScale * Position.y,Position.z, <span class="number">1.0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>final result:<br><img src="/img/OpenGL/UniformVariable.PNG" alt="UniformVariable"></p>
<h3 id="Interpolation"><a href="#Interpolation" class="headerlink" title="Interpolation"></a>Interpolation</h3><p><a target="_blank" rel="noopener" href="http://ogldev.atspace.co.uk/www/tutorial09/tutorial09.html">the interpolation that the rasterizer performs on variables that come out of the vertex shader. </a></p>
<p>在OpenGL的渲染管线里，在Fragment Shader执行之前会进行rasterizer，rasterizer会计算出各个三角形顶点之间的像素颜色数据，然后我们可以通过Fragment Shader对于光栅化的后颜色数据做进一步的处理。</p>
<p>这一章节主要看看我们是如何在Vertex Shader和Fragment Shader中如何对顶点数据和各像素信息做处理和数据传递的。(这里我们直接在VS中算出颜色信息直接传递到FS中去做处理)<br>要想从VS传递数据到FS，我们需要在Vertex Shader中定义关键词out的变量，并在Fragment Shader定义对应的关键词in的变量。</p>
<p>vsshader.vs</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#version 330</span></span><br><span class="line"></span><br><span class="line">uniform <span class="type">float</span> gScale;</span><br><span class="line"></span><br><span class="line"><span class="built_in">layout</span> (location = <span class="number">0</span>) in vec3 Position;</span><br><span class="line"></span><br><span class="line">out vec4 Color;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    gl_Position = <span class="built_in">vec4</span>(gScale * Position.x,gScale * Position.y,Position.z, <span class="number">1.0</span>);</span><br><span class="line">	</span><br><span class="line">	Color = <span class="built_in">abs</span>(gl_Position);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>fsshader.fs</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#version 330</span></span><br><span class="line"></span><br><span class="line">out vec4 FragColor;</span><br><span class="line"></span><br><span class="line">in vec4 Color;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    FragColor = Color;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>final result:<br><img src="/img/OpenGL/Interpolation.PNG" alt="Interpolation"></p>
<p>从上面可以看出在VS中算出颜色信息后，经过光栅化，三角形顶点之间的颜色信息被计算出来，最终传到FS中并作为最终颜色信息输出到屏幕上。</p>
<h3 id="Coordinate-Transformations-Perspective-Projection"><a href="#Coordinate-Transformations-Perspective-Projection" class="headerlink" title="Coordinate Transformations &amp; Perspective Projection"></a>Coordinate Transformations &amp; Perspective Projection</h3><p>这一章主要是学习矩阵在3D图形中的使用和了解物体时怎样被显示到正确的屏幕位置的。<br>Note:<br>下列推导是基于OpenGL的列向量而非DX的行向量</p>
<p>在解释如何使用矩阵去进行向量变换之前，我们先来看看为什么矩阵可以实现向量变换？<br>下列学习参考《3D 数学基础：图形与游戏开发》<br>一个3维向量可以解释成3个基向量上平移后的组合(p,q,r为三个基向量)：<br>V &#x3D; x × p + y × q + z × r;</p>
<p>当一个向量乘以矩阵的时候：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">    [ p ]   [px  py  pz]</span><br><span class="line">M = [ q ] = [qx  qy  qz]</span><br><span class="line">    [ r ]   [rx  ry  rz]</span><br><span class="line"></span><br><span class="line">V = [x y z]</span><br><span class="line"></span><br><span class="line">                [px  py  pz]</span><br><span class="line">V * M = [x y z] [qx  qy  qz] = [x*px + y*qx + z*rx   x*py + y*qy + z*ry  x*pz + y*qz + z*rz] = x*p + y*q + z*r</span><br><span class="line">                [rx  ry  rz]</span><br></pre></td></tr></table></figure>

<p>“如果把矩阵的行解释为坐标系的基向量，那么乘以该矩阵就相当于执行了一次坐标系转换。若有a*M &#x3D; b，我们就可以说，M将a转换到b。”</p>
<p>从上面我们可以看出矩阵是如何做到对于向量的坐标系转换的。</p>
<p>那么为什么我们后面用到的矩阵都是4×4而不是3×3的了？<br>4<em>4的矩阵我们叫做齐次矩阵。齐次矩阵出现的原因主要是除了记法方便，更重要的是因为3</em>3的变换矩阵只能表示线性变换，而4*4齐次矩阵能够表示线性变换和非线性变换。</p>
<p>那么这里我们来了解下什么是线性变换？<br>线性变换的满足下列公式：<br>F(a+b) &#x3D; F(a) + F(b)<br>F(ka) &#x3D; k × F(a)</p>
<p>因为线性变换不包含平移，所以这也是4×4齐次矩阵的出现的原因。</p>
<p>了解了使用矩阵的原因和为什么使用4×4齐次矩阵的原因后，让我们来看看，我们是如何通过矩阵来实现3D图形里的实现物体的坐标系变换的。<br>M(m-w) – 物体坐标系到世界坐标系<br>M(w-v) – 世界坐标系到观察坐标系<br>M(v-p) – 投影变换</p>
<p>V’ &#x3D; V × M(m-w) × M(w-v) × M(v-p)</p>
<p>因为矩阵乘法满足结合律<br>N &#x3D; M(m-w) × M(w-v) × M(v-p)<br>V’ &#x3D; V × (M(m-w) × M(w-v) × M(v-p)) &#x3D; V * N<br>所以我们只需要求出所有坐标系变换矩阵的乘积后再对V进行操作即可。</p>
<p>因为单个矩阵存储着一系列的变换，而这些变换可以通过多个单个变换组合而成，所以下列式子是成立的<br>M &#x3D; S(scale) × R(rotation) × T(translation)</p>
<p>但这里有个比较关键的点，S,R,T直接的乘法顺序，矩阵是不满足交换律的，我们必须按S * R * T的顺序，原因参考下面：<br><a target="_blank" rel="noopener" href="https://msdn.microsoft.com/en-us/library/eews39w7%28v=vs.110%29.aspx">One reason order is significant is that transformations like rotation and scaling are done with respect to the origin of the coordinate system. Scaling an object that is centered at the origin produces a different result than scaling an object that has been moved away from the origin. Similarly, rotating an object that is centered at the origin produces a different result than rotating an object that has been moved away from the origin.</a></p>
<p>从上面可以看出，之所必须按S * R * T的顺序是因为S和R都是针对坐标系原点进行的，一旦先执行T，那么相对于坐标系原点的位置就会有所变化，这之后再做S和R就会出现不一样的表现。</p>
<p>因为OpenGL是列向量是左乘，所以在OpenGL中顺序如下：<br>V’ &#x3D; T × R × S × V</p>
<p>DX中顺序如下：<br>V’ &#x3D; V × S × R × T</p>
<p>获取最终的M(m-w)的代码实现如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">const</span> Matrix4f&amp; <span class="title">Pipeline::GetWorldTrans</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Matrix4f ScaleTrans, RotateTrans, TranslationTrans;</span><br><span class="line"></span><br><span class="line">    ScaleTrans.<span class="built_in">InitScaleTransform</span>(m_scale.x, m_scale.y, m_scale.z);</span><br><span class="line">    RotateTrans.<span class="built_in">InitRotateTransform</span>(m_rotateInfo.x, m_rotateInfo.y, m_rotateInfo.z);</span><br><span class="line">    TranslationTrans.<span class="built_in">InitTranslationTransform</span>(m_worldPos.x, m_worldPos.y, m_worldPos.z);</span><br><span class="line"></span><br><span class="line">    m_Wtransformation = TranslationTrans * RotateTrans * ScaleTrans;</span><br><span class="line">    <span class="keyword">return</span> m_Wtransformation;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>V’ &#x3D; V × M(m-w) × M(w-v) × M(v-p)<br>我们知道了M(m-w)是如何计算出来的了，接下来我们要了解M(w-v) – 世界坐标系到观察坐标系<br>在了解如何从世界坐标系转换到观察坐标系之前我们先来看看摄像机的定义：<br>位置 – (x,y,z)<br>N – The vector from the camera to its target.（look at 朝向）<br>V – When standing upright this is the vector from your head to the sky.(垂直于N向上的向量)<br>U – This vector points from the camera to its “right” side”.(在N和V定了之后可以算出Camera的向右的向量)</p>
<p>摄像机坐标系和世界坐标系：<br><img src="/img/OpenGL/CameraCoordinateTranslation.PNG" alt="CameraCoordinateTranslation"></p>
<p>要想得到物体从世界坐标系转换到摄像机坐标系，其实就是个坐标系转换的问题。<br>我们首先把摄像机移动到世界坐标原点(移动摄像机位置即可)：<br>[ 1 0 0 -x ]<br>[ 0 1 0 -y ]<br>[ 0 0 1 -z ]<br>[ 0 0 0  1 ]</p>
<p>这样一来考虑如何变化坐标系即可：<br><img src="/img/OpenGL/CameraCoordinate2.PNG" alt="CameraCoordinate2"><br>通过N,V,U，我们已经能够得出X(camera),Y(camera),Z(camera)3个基向量了。<br>还记得我们之前说的 – “如果把矩阵的行解释为坐标系的基向量，那么乘以该矩阵就相当于执行了一次坐标系转换。若有a*M &#x3D; b，我们就可以说，M将a转换到b。”<br>所以：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[ Ux Uy Uz <span class="number">0</span> ]    [<span class="built_in">X</span>(world)]    [<span class="built_in">X</span>(camera)]</span><br><span class="line">[ Vx Vy Vz <span class="number">0</span> ]    [<span class="built_in">Y</span>(world)]    [<span class="built_in">Y</span>(camera)]</span><br><span class="line">[ Nx Ny Nz <span class="number">0</span> ] *  [<span class="built_in">Z</span>(world)] =  [<span class="built_in">Z</span>(camera)]</span><br><span class="line">[ <span class="number">0</span>  <span class="number">0</span>  <span class="number">0</span>  <span class="number">1</span> ]    [    <span class="number">1</span>   ]    [     <span class="number">1</span>   ]</span><br></pre></td></tr></table></figure>

<p>结合前面提到的先把摄像机移动到世界原点，得出：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">         [ Ux Uy Uz <span class="number">0</span> ]   [ <span class="number">1</span> <span class="number">0</span> <span class="number">0</span> -x ]</span><br><span class="line"><span class="built_in">M</span>(w-v) = [ Vx Vy Vz <span class="number">0</span> ] * [ <span class="number">0</span> <span class="number">1</span> <span class="number">0</span> -y ]</span><br><span class="line">         [ Nx Ny Nz <span class="number">0</span> ]   [ <span class="number">0</span> <span class="number">0</span> <span class="number">1</span> -z ]</span><br><span class="line">         [ <span class="number">0</span>  <span class="number">0</span>  <span class="number">0</span>  <span class="number">1</span> ]   [ <span class="number">0</span> <span class="number">0</span> <span class="number">0</span>  <span class="number">1</span> ]</span><br></pre></td></tr></table></figure>

<p>M(w-v)的代码实现如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">Matrix4f::InitTranslationTransform</span><span class="params">(<span class="type">float</span> x, <span class="type">float</span> y, <span class="type">float</span> z)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    m[<span class="number">0</span>][<span class="number">0</span>] = <span class="number">1.0f</span>; m[<span class="number">0</span>][<span class="number">1</span>] = <span class="number">0.0f</span>; m[<span class="number">0</span>][<span class="number">2</span>] = <span class="number">0.0f</span>; m[<span class="number">0</span>][<span class="number">3</span>] = x;</span><br><span class="line">    m[<span class="number">1</span>][<span class="number">0</span>] = <span class="number">0.0f</span>; m[<span class="number">1</span>][<span class="number">1</span>] = <span class="number">1.0f</span>; m[<span class="number">1</span>][<span class="number">2</span>] = <span class="number">0.0f</span>; m[<span class="number">1</span>][<span class="number">3</span>] = y;</span><br><span class="line">    m[<span class="number">2</span>][<span class="number">0</span>] = <span class="number">0.0f</span>; m[<span class="number">2</span>][<span class="number">1</span>] = <span class="number">0.0f</span>; m[<span class="number">2</span>][<span class="number">2</span>] = <span class="number">1.0f</span>; m[<span class="number">2</span>][<span class="number">3</span>] = z;</span><br><span class="line">    m[<span class="number">3</span>][<span class="number">0</span>] = <span class="number">0.0f</span>; m[<span class="number">3</span>][<span class="number">1</span>] = <span class="number">0.0f</span>; m[<span class="number">3</span>][<span class="number">2</span>] = <span class="number">0.0f</span>; m[<span class="number">3</span>][<span class="number">3</span>] = <span class="number">1.0f</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Matrix4f::InitCameraTransform</span><span class="params">(<span class="type">const</span> Vector3f&amp; Target, <span class="type">const</span> Vector3f&amp; Up)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Vector3f N = Target;</span><br><span class="line">    N.<span class="built_in">Normalize</span>();</span><br><span class="line">    Vector3f U = Up;</span><br><span class="line">    U.<span class="built_in">Normalize</span>();</span><br><span class="line">    U = U.<span class="built_in">Cross</span>(N);</span><br><span class="line">    Vector3f V = N.<span class="built_in">Cross</span>(U);</span><br><span class="line"></span><br><span class="line">    m[<span class="number">0</span>][<span class="number">0</span>] = U.x;   m[<span class="number">0</span>][<span class="number">1</span>] = U.y;   m[<span class="number">0</span>][<span class="number">2</span>] = U.z;   m[<span class="number">0</span>][<span class="number">3</span>] = <span class="number">0.0f</span>;</span><br><span class="line">    m[<span class="number">1</span>][<span class="number">0</span>] = V.x;   m[<span class="number">1</span>][<span class="number">1</span>] = V.y;   m[<span class="number">1</span>][<span class="number">2</span>] = V.z;   m[<span class="number">1</span>][<span class="number">3</span>] = <span class="number">0.0f</span>;</span><br><span class="line">    m[<span class="number">2</span>][<span class="number">0</span>] = N.x;   m[<span class="number">2</span>][<span class="number">1</span>] = N.y;   m[<span class="number">2</span>][<span class="number">2</span>] = N.z;   m[<span class="number">2</span>][<span class="number">3</span>] = <span class="number">0.0f</span>;</span><br><span class="line">    m[<span class="number">3</span>][<span class="number">0</span>] = <span class="number">0.0f</span>;  m[<span class="number">3</span>][<span class="number">1</span>] = <span class="number">0.0f</span>;  m[<span class="number">3</span>][<span class="number">2</span>] = <span class="number">0.0f</span>;  m[<span class="number">3</span>][<span class="number">3</span>] = <span class="number">1.0f</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">const</span> Matrix4f&amp; <span class="title">Pipeline::GetViewTrans</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Matrix4f CameraTranslationTrans, CameraRotateTrans;</span><br><span class="line"></span><br><span class="line">    CameraTranslationTrans.<span class="built_in">InitTranslationTransform</span>(-m_camera.Pos.x, -m_camera.Pos.y, -m_camera.Pos.z);</span><br><span class="line">    CameraRotateTrans.<span class="built_in">InitCameraTransform</span>(m_camera.Target, m_camera.Up);</span><br><span class="line">    </span><br><span class="line">    m_Vtransformation = CameraRotateTrans * CameraTranslationTrans;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> m_Vtransformation;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样一来M(w-v)也就实现了，接下来让我们看看M(v-p)是如何计算出来的吧。<br>M(v-p)这的p有多种投影方式，这里我只以Perspective Projection为例。<br>在转换到Camera坐标系后，我们还需要通过透视投影才能将3D物体映射到2D平面上。<br>Perspective Projection主要由下列四部分决定：</p>
<ol>
<li>The aspect ratio - the ratio between the width and the height of the rectangular area which will be the target of projection.</li>
<li>The vertical field of view.</li>
<li>The location of the near Z plane.</li>
<li>The location of the far Z plane.</li>
</ol>
<p>这一章的推导可以参考<a target="_blank" rel="noopener" href="http://www.cnblogs.com/graphics/archive/2012/07/25/2582119.html">透视投影详解</a><br>一开始推导过程中不明白的一点是：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">           <span class="number">1</span></span><br><span class="line">Z<span class="string">&#x27;&#x27; = a * --- + b</span></span><br><span class="line"><span class="string">           Pz</span></span><br></pre></td></tr></table></figure>

<p>后来看了《Mathematics for 3D Game Programming and Computer Grahpics 3rd section》的5.4.1 Depth Interpolation后明白了，光栅化的时候对于深度的运算证明了是对Z的倒数进行插值来得到Z的值的。<br>所以上述公式是成立的。</p>
<p>经过一系列推导后，我们得出了：<br><img src="/img/OpenGL/PerspectiveProject1.PNG" alt="PerspectiveProject1"><br><img src="/img/OpenGL/PerspectiveProject2.PNG" alt="PerspectiveProject2"><br><img src="/img/OpenGL/PerspectiveProject3.PNG" alt="PerspectiveProject3"><br><img src="/img/OpenGL/PerspectiveProject4.PNG" alt="PerspectiveProject4"></p>
<p>Note:<br><strong>上述推导是针对DX而言的，DX和OpenGL在透视投影矩阵推导上面有一个很重要的不同，那就是DX变换后z坐标范围是[0,1]，而OpenGL的z坐标范围是[-1,1]</strong></p>
<p>所以如果我们把z坐标[-1,1]带入下式推导：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">           <span class="number">1</span></span><br><span class="line">Z<span class="string">&#x27;&#x27; = a * --- + b</span></span><br><span class="line"><span class="string">           Pz</span></span><br></pre></td></tr></table></figure>
<p>我们将得出OpenGL的透视投影矩阵如下(下面的θ &#x3D; FOV&#x2F;2)：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">    [cotθ/Aspect        <span class="number">0</span>               <span class="number">0</span>                  <span class="number">0</span>     ]</span><br><span class="line">    [    <span class="number">0</span>            cotθ              <span class="number">0</span>                  <span class="number">0</span>     ]</span><br><span class="line">M = [    <span class="number">0</span>              <span class="number">0</span>          (-n-f)/(n-f)       <span class="number">2</span>*f*n/(n-f)]</span><br><span class="line">    [    <span class="number">0</span>              <span class="number">0</span>               <span class="number">1</span>                  <span class="number">0</span>     ]</span><br></pre></td></tr></table></figure>

<p>所以OpenGL里M(v-p)的代码实现如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">Matrix4f::InitPersProjTransform</span><span class="params">(<span class="type">const</span> PersProjInfo&amp; p)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">const</span> <span class="type">float</span> ar         = p.Width / p.Height;</span><br><span class="line">    <span class="type">const</span> <span class="type">float</span> zRange     = p.zNear - p.zFar;</span><br><span class="line">    <span class="type">const</span> <span class="type">float</span> tanHalfFOV = <span class="built_in">tanf</span>(<span class="built_in">ToRadian</span>(p.FOV / <span class="number">2.0f</span>));</span><br><span class="line"></span><br><span class="line">    m[<span class="number">0</span>][<span class="number">0</span>] = <span class="number">1.0f</span>/(tanHalfFOV * ar); m[<span class="number">0</span>][<span class="number">1</span>] = <span class="number">0.0f</span>;            m[<span class="number">0</span>][<span class="number">2</span>] = <span class="number">0.0f</span>;            m[<span class="number">0</span>][<span class="number">3</span>] = <span class="number">0.0</span>;</span><br><span class="line">    m[<span class="number">1</span>][<span class="number">0</span>] = <span class="number">0.0f</span>;                   m[<span class="number">1</span>][<span class="number">1</span>] = <span class="number">1.0f</span>/tanHalfFOV; m[<span class="number">1</span>][<span class="number">2</span>] = <span class="number">0.0f</span>;            m[<span class="number">1</span>][<span class="number">3</span>] = <span class="number">0.0</span>;</span><br><span class="line">    m[<span class="number">2</span>][<span class="number">0</span>] = <span class="number">0.0f</span>;                   m[<span class="number">2</span>][<span class="number">1</span>] = <span class="number">0.0f</span>;            m[<span class="number">2</span>][<span class="number">2</span>] = (-p.zNear - p.zFar)/zRange ; m[<span class="number">2</span>][<span class="number">3</span>] = <span class="number">2.0f</span>*p.zFar*p.zNear/zRange;</span><br><span class="line">    m[<span class="number">3</span>][<span class="number">0</span>] = <span class="number">0.0f</span>;                   m[<span class="number">3</span>][<span class="number">1</span>] = <span class="number">0.0f</span>;            m[<span class="number">3</span>][<span class="number">2</span>] = <span class="number">1.0f</span>;            m[<span class="number">3</span>][<span class="number">3</span>] = <span class="number">0.0</span>;    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Keyboard-Mouse-Control"><a href="#Keyboard-Mouse-Control" class="headerlink" title="Keyboard &amp;&amp; Mouse Control"></a>Keyboard &amp;&amp; Mouse Control</h3><p>这一章节主要是讲通过Glut提供的API如何去响应键盘和鼠标的控制。<br>本章节里面主要用到了两个类：</p>
<ol>
<li>Pipeline</li>
<li>Camera</li>
</ol>
<p>Pipeline主要是针对上一章节我们对于如何通过矩阵变化把物体显示到2D平面上的抽象：<br>M(m-w) – 物体坐标系到世界坐标系<br>M(w-v) – 世界坐标系到观察坐标系<br>M(v-p) – 投影变换</p>
<p>N &#x3D; M(m-w) × M(w-v) × M(v-p)<br>V’ &#x3D; V × M(m-w) × M(w-v) × M(v-p) &#x3D; V × N</p>
<p>Pipeline只要知道了物体S,R,T信息就可以得出M(m-w)，知道了Camera信息就可以得出M(w-v),知道了透视投影信息就可以得出M(v-p)。</p>
<p>我们通过修改摄像机的相关信息得出在移动摄像机后的N,并作用于物体，这样一来就能使物体显示在正确位置了。</p>
<p>而Camera类是对摄像机的抽象。</p>
<p>Pipeline和Camera的源代码可在<a target="_blank" rel="noopener" href="http://ogldev.atspace.co.uk/">Modern OpenGL Tutorials</a>下载</p>
<p>这里我只关心针对键盘和鼠标的响应的相关代码：<br>Glut里针对键盘和鼠标的API主要是下列几个：</p>
<ol>
<li>glutSpecialFunc() – 主要是针对特殊按键比如F1</li>
<li>glutKeyboardFunc() – 主要是针对普通按键比如A,B,C……</li>
<li>glutPassiveMotionFunc() – 主要是针对在没有鼠标按键被按下的情况下，鼠标在窗口内移动的情况</li>
<li>glutMotionFunc() – 主要是针对在鼠标按键被按下的情况下，鼠标在窗口内移动的情况</li>
</ol>
<p>相关代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">SpecialKeyboardCB</span><span class="params">(<span class="type">int</span> Key, <span class="type">int</span> x, <span class="type">int</span> y)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    OGLDEV_KEY OgldevKey = <span class="built_in">GLUTKeyToOGLDEVKey</span>(Key);</span><br><span class="line">    pGameCamera-&gt;<span class="built_in">OnKeyboard</span>(OgldevKey);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">KeyboardCB</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> Key, <span class="type">int</span> x, <span class="type">int</span> y)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (Key) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;q&#x27;</span>:</span><br><span class="line">            <span class="built_in">glutLeaveMainLoop</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">PassiveMouseCB</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> y)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    pGameCamera-&gt;<span class="built_in">OnMouse</span>(x, y);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">InitializeGlutCallbacks</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	......</span><br><span class="line">    <span class="built_in">glutSpecialFunc</span>(SpecialKeyboardCB);</span><br><span class="line">    <span class="built_in">glutPassiveMotionFunc</span>(PassiveMouseCB);</span><br><span class="line">    <span class="built_in">glutKeyboardFunc</span>(KeyboardCB);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>final result:<br><img src="/img/OpenGL/MouseAndKeyboardStudy.PNG" alt="MouseAndKeyboardStudy"></p>
<h3 id="Texture-Mapping"><a href="#Texture-Mapping" class="headerlink" title="Texture Mapping"></a>Texture Mapping</h3><p>“Textures are composed of texels, which often contain color values.”</p>
<p>“Textures are bound to the OpenGL context via texture units, which are represented as binding points named GL_TEXTURE0 through GL_TEXTUREi where i is one less than the number of texture units supported by the implementation.”</p>
<p>The textures are accessed via sampler variables which were declared with dimensionality that matches the texture in shader</p>
<p>在真正接触Texutre之前，让我们理解下下列几个重要的概念：</p>
<ol>
<li><p>Texture object – contains the data of the texture image itself, i.e. the texels（可以看出Texture object才是含有原始数据信息的对象）</p>
</li>
<li><p>Texture unit – texture object bind to a ‘texture unit’ whose index is passed to the shader. So the shader reaches the texture object by going through the texture unit.（我们访问texture数据信息并不是通过texture object，而是在shader里通过访问特定索引的texture unit去访问texture object里的数据）</p>
</li>
<li><p>Sampler Object – configure it with a sampling state and bind it to the texture unit. When you do that the sampler object will override any sampling state defined in the texture object.（Sampler Object一些sampling的配置信息，当用于texture object时会覆盖texture object里的原始sampler设定）</p>
</li>
<li><p>Sampler uniform – corresponding to handle of texture unit(用于在Shader里访问texture unit，texture unit和texture object绑定，也就间接的访问了texture的原始数据)</p>
</li>
</ol>
<p>Relationship between texture object, texture unit, sampler object and sampler uniform<br><img src="/img/OpenGL/TextureConcepts.png" alt="RelationshipBetweenThem"></p>
<p>因为OpenGL没有提供从图片加载texture的API，所以这里我们需要使用第三方库来完成这项工作，这里教程上使用的是ImageMagick。<br>ImageMagick主要是为了从多种格式的资源文件中读取原始数据，在我们指定glTexImage2D()的原始数据的时候提供所在内存地址。</p>
<p>Steps to use texture mapping:</p>
<ol>
<li><p>Create a texture object and load texel data into it<br>glGenTextures() – gen texture object<br>glBindTexture() – Tells OpenGL the texture object we refer to in all the following texture related calls, until a new texture object is bound.<br>glTexImage2D() – load texel data into texture object</p>
</li>
<li><p>Include texture coordinates with your vertices</p>
</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Vertex Vertices[<span class="number">4</span>] = &#123; <span class="built_in">Vertex</span>(<span class="built_in">Vector3f</span>(<span class="number">-1.0f</span>, <span class="number">-1.0f</span>, <span class="number">0.5773f</span>), <span class="built_in">Vector2f</span>(<span class="number">0.0f</span>, <span class="number">0.0f</span>)),</span><br><span class="line">                       <span class="built_in">Vertex</span>(<span class="built_in">Vector3f</span>(<span class="number">0.0f</span>, <span class="number">-1.0f</span>, <span class="number">-1.15475f</span>), <span class="built_in">Vector2f</span>(<span class="number">0.0f</span>, <span class="number">0.0f</span>)),</span><br><span class="line">                       <span class="built_in">Vertex</span>(<span class="built_in">Vector3f</span>(<span class="number">1.0f</span>, <span class="number">-1.0f</span>, <span class="number">0.5773f</span>),  <span class="built_in">Vector2f</span>(<span class="number">0.0f</span>, <span class="number">0.0f</span>)),</span><br><span class="line">                       <span class="built_in">Vertex</span>(<span class="built_in">Vector3f</span>(<span class="number">0.0f</span>, <span class="number">1.0f</span>, <span class="number">0.0f</span>),      <span class="built_in">Vector2f</span>(<span class="number">0.5f</span>, <span class="number">1.0f</span>)) &#125;;</span><br><span class="line"><span class="built_in">glGenBuffers</span>(<span class="number">1</span>, &amp;VBO);</span><br><span class="line"><span class="built_in">glBindBuffer</span>(GL_ARRAY_BUFFER, VBO);</span><br><span class="line"><span class="built_in">glBufferData</span>(GL_ARRAY_BUFFER, <span class="built_in">sizeof</span>(Vertices), Vertices, GL_STATIC_DRAW);</span><br><span class="line"></span><br><span class="line"><span class="comment">//我们把顶点对应的纹理坐标信息写到vertex数据里</span></span><br><span class="line"><span class="comment">//说道纹理坐标就不得不提一下Texture UV纹理坐标了，Texture的图片被映射到0-1的二维坐标，图见后面：</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">glEnableVertexAttribArray</span>(<span class="number">0</span>);</span><br><span class="line"><span class="built_in">glEnableVertexAttribArray</span>(<span class="number">1</span>);</span><br><span class="line"><span class="built_in">glVertexAttribPointer</span>(<span class="number">0</span>, <span class="number">3</span>, GL_FLOAT, GL_FALSE, <span class="built_in">sizeof</span>(Vertex), <span class="number">0</span>);</span><br><span class="line"><span class="built_in">glVertexAttribPointer</span>(<span class="number">1</span>, <span class="number">2</span>, GL_FLOAT, GL_FALSE, <span class="built_in">sizeof</span>(Vertex), (<span class="type">const</span> GLvoid*)<span class="number">12</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//然后通过指定如何解析顶点数据里面的的数据在Shader里访问vertex的texture纹理坐标信息去sample出texture数据信息</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li><p>Associate a texture sampler with each texture map you intend to use in your shader<br>glTexParameterf() – Texture采样方式的配置<br>还记得我们之前讲到的Sampler object吗？这里的配置就好比我们在sampler object里配置后再作用于特定的texture object<br>这里我就不说关于采样方式配置相关的内容了（采样方式会决定最终像素的计算方式），这里值得一提的是mipmap的概念。<br>mipmap主要是由于物体在场景中因为距离的缘故会在屏幕显示的大小有变化，如果我们在物体很远，只需要显示很小一块的时候还依然采用很大的纹理贴图，最终显示在屏幕上的纹理会很不清晰（失真）。为了解决这个问题，mipmap应运而生，通过事先生成或指定多个级别的同一纹理贴图，然后在程序运作的过程中通过计算算出应该使用哪一个等级的纹理贴图来避免大纹理小色块失真的问题。<br>我们可以手动通过：<br>glTexStorage2D() &amp;&amp; glTexSubImage2D() 去手动指定各级纹理贴图<br>也可以通过：<br>glGenerateMipmap() – 自动去生成对应的mipmap纹理贴图<br>而程序在实际运作过程中如何去计算Mipmap Level这里就不做介绍了，详细参考《OpenGL Programming Guide 8th Edition》的Calculating the Mipmap章节<br>相关函数：<br>textureLod()<br>textureGrad()</p>
</li>
<li><p>Active texture unit and bind texture object to it<br>glActiveTexture() – 激活特定的texture unit然后绑定特定texture object到特定texture unit上<br>glBindTexture() – 绑定特定的texture object到texture unit上</p>
</li>
<li><p>Retrieve the texel values through the texture sampler from your shader<br>首先我们在程序中指定了我们即将访问的Texture unit</p>
</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">gSampler = <span class="built_in">glGetUniformLocation</span>(ShaderProgram, <span class="string">&quot;gSampler&quot;</span>);</span><br><span class="line"><span class="built_in">assert</span>(gSampler != <span class="number">0xFFFFFFFF</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">glUniform1i</span>(gSampler, <span class="number">0</span>);</span><br></pre></td></tr></table></figure>
<p>Note:<br>“The important thing to note here is that the actual index of the texture unit is used here, and not the OpenGL enum GL_TEXTURE0 (which has a different value).”</p>
<p>vsshader.vs</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#version 330</span></span><br><span class="line"></span><br><span class="line">uniform mat4 gWVP;</span><br><span class="line"></span><br><span class="line"><span class="built_in">layout</span> (location = <span class="number">0</span>) in vec3 Position;</span><br><span class="line"><span class="built_in">layout</span> (location = <span class="number">1</span>) in vec2 TexCoord;</span><br><span class="line"></span><br><span class="line">out vec2 TexCoord0;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    gl_Position = gWVP * <span class="built_in">vec4</span>(Position, <span class="number">1.0</span>);</span><br><span class="line">	</span><br><span class="line">	TexCoord0 = TexCoord;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>fsshader.fs</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#version 330</span></span><br><span class="line"></span><br><span class="line">in vec2 TexCoord0;</span><br><span class="line"></span><br><span class="line">out vec4 FragColor;</span><br><span class="line"></span><br><span class="line">uniform sampler2D gSampler;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    FragColor = <span class="built_in">texture2D</span>(gSampler, TexCoord<span class="number">0.</span>xy);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从上面可以看出我们在fragment shader里，通过传入的gSampler确认了使用哪一个texture unit，通过传入的TexCoord0确认了对应的纹理坐标信息去获取对应的texture信息，然后最终通过texture2D从texture里取得了特定的颜色信息作为输出，就这样纹理图片的信息就作用在了三角形上并显示出来。</p>
<p><img src="/img/OpenGL/TextureCoordinate.PNG" alt="TextureCoordinate"></p>
<p>final result:<br><img src="/img/OpenGL/BasicTexture.PNG" alt="BasicTexture"></p>
<p>下面我简单测试了下两个Texture计算出最终纹理信息：<br>TextureStudy.cpp</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">InitializeTextureInfo</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	gSampler = <span class="built_in">glGetUniformLocation</span>(ShaderProgram, <span class="string">&quot;gSampler&quot;</span>);</span><br><span class="line">	<span class="built_in">assert</span>(gSampler != <span class="number">0xFFFFFFFF</span>);</span><br><span class="line"></span><br><span class="line">	gSampler2 = <span class="built_in">glGetUniformLocation</span>(ShaderProgram, <span class="string">&quot;gSampler2&quot;</span>);</span><br><span class="line">	<span class="built_in">assert</span>(gSampler2 != <span class="number">0xFFFFFFFF</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//Specify the inder of texture unit we will use in shader</span></span><br><span class="line">	<span class="built_in">glUniform1i</span>(gSampler, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">glUniform1i</span>(gSampler2, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">	pTexture = <span class="keyword">new</span> <span class="built_in">Texture</span>(GL_TEXTURE_2D, <span class="string">&quot;../Content/texture1.png&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(!pTexture-&gt;<span class="built_in">Load</span>())</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> ;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	pTexture2 = <span class="keyword">new</span> <span class="built_in">Texture</span>(GL_TEXTURE_2D, <span class="string">&quot;../Content/texture2.jpg&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(!pTexture2-&gt;<span class="built_in">Load</span>())</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> ;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">RenderCallbackCB</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	......</span><br><span class="line"></span><br><span class="line">	pTexture-&gt;<span class="built_in">Bind</span>(GL_TEXTURE0);</span><br><span class="line"></span><br><span class="line">	pTexture2-&gt;<span class="built_in">Bind</span>(GL_TEXTURE1);</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>fsshader.fs</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#version 330</span></span><br><span class="line"></span><br><span class="line">in vec2 TexCoord0;</span><br><span class="line"></span><br><span class="line">out vec4 FragColor;</span><br><span class="line"></span><br><span class="line">uniform sampler2D gSampler;</span><br><span class="line"></span><br><span class="line">uniform sampler2D gSampler2;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    FragColor = <span class="number">0.5</span> * <span class="built_in">texture2D</span>(gSampler, TexCoord<span class="number">0.</span>xy) + <span class="number">0.5</span> * <span class="built_in">texture2D</span>(gSampler2, TexCoord<span class="number">0.</span>xy);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>原始图片分别为：<br><img src="/img/OpenGL/texture1.png" alt="Texture1"><br><img src="/img/OpenGL/texture2.jpg" alt="Texture2"></p>
<p>final result:<br><img src="/img/OpenGL/MultipleTexture.PNG" alt="MultipleTexture"></p>
<p>Point Sprites:<br>待理解学习……</p>
<p>Rendering to Texture Maps:<br>待理解学习……</p>
<p>Sumary：</p>
<ol>
<li><p>Use immutable texture storage for textures wherever possible – When a texture is marked as immutable, the OpenGL implementation can make certain assumptions about the validity of a texture object （尽量使用不可变的texture storage， 这样OpenGL可以确保texture的有效性）</p>
</li>
<li><p>Create and initialize the mipmap chain for textures unless you have a good reason not to – improve the image quality of your program’s rendering, but also will make more efficient use of the caches in the graphics processor （为了渲染效率，减轻GPU负担，尽可能为texture创建mipmap）</p>
</li>
<li><p>Use an integer sampler in your shader when your texture data is an unnormalized integer and you intend to use the integer values it contains directly in the shader （尽量在shader里使用integer类型的sampler）</p>
</li>
</ol>
<p>Note:<br>“The maximum number of texture units supported by OpenGL<br>can be determined by retrieving the value of the GL_MAX_COMBINED_<br>TEXTURE_IMAGE_UNITS constant, which is guaranteed to be at least 80 as<br>of OpenGL 4.0.”</p>
<p>Proxy texture – used to test the capabilities of the OpenGL implementation when certain limits are used in combination with each other.</p>
<h3 id="Light-and-Shadow"><a href="#Light-and-Shadow" class="headerlink" title="Light and Shadow"></a>Light and Shadow</h3><p>光源类型：</p>
<ol>
<li>Ambient Light (环境光) – 环境光只影响ambient</li>
<li>Directional Light (方向光) – 方向光会影响diffuse &amp; specular</li>
<li>Point Light (点光源) – 与方向光的区别是有attenuation(衰弱)而且点光源照射物体的表面的方向不一样，同样会影响diffuse &amp; specular</li>
</ol>
<p>传统的光照组成：<br>Ambient (环境光) – 与光照的方向无关</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">FragColor = <span class="built_in">texture2D</span>(gSampler, TexCoord<span class="number">0.</span>xy) *</span><br><span class="line">        <span class="built_in">vec4</span>(gDirectionalLight.Color, <span class="number">1.0f</span>) *</span><br><span class="line">        gDirectionalLight.AmbientIntensity;</span><br></pre></td></tr></table></figure>
<p>因为环境光与光照方向无关，只需考虑方向光的颜色和方向光所占比重，所以基本上主要计算归结于上述运算。</p>
<p>final effect:<br><img src="/img/OpenGL/Ambient.PNG" alt="Ambient"></p>
<p>Note:<br>这里源代码里有个错误，在子类重写虚函数的KeyboardCB的时候，由于参数写的不对，没能正确重写该虚函数而没有被调到。<br>错误：<br>virtual void KeyboardCB(OGLDEV_KEY OgldevKey);<br>正确：<br>virtual void KeyboardCB(OGLDEV_KEY OgldevKey, OGLDEV_KEY_STATE OgldevKeyState &#x3D; OGLDEV_KEY_STATE_PRESS)</p>
<p>Diffuse (漫反射光) – 与光照的方向和顶点normal有关<br>因为漫反射光要考虑光照的方向和物体的顶点法线，所以我们需要在shader里进行计算之前要把顶点的法线算出来然后传入Shader进行计算。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">CalcNormals</span><span class="params">(<span class="type">const</span> <span class="type">unsigned</span> <span class="type">int</span>* pIndices, <span class="type">unsigned</span> <span class="type">int</span> IndexCount, Vertex* pVertices, <span class="type">unsigned</span> <span class="type">int</span> VertexCount)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">unsigned</span> <span class="type">int</span> i = <span class="number">0</span> ; i &lt; IndexCount ; i += <span class="number">3</span>) &#123;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">int</span> Index0 = pIndices[i];</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">int</span> Index1 = pIndices[i + <span class="number">1</span>];</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">int</span> Index2 = pIndices[i + <span class="number">2</span>];</span><br><span class="line">        Vector3f v1 = pVertices[Index1].m_pos - pVertices[Index0].m_pos;</span><br><span class="line">        Vector3f v2 = pVertices[Index2].m_pos - pVertices[Index0].m_pos;</span><br><span class="line">        Vector3f Normal = v<span class="number">1.</span><span class="built_in">Cross</span>(v2);</span><br><span class="line">        Normal.<span class="built_in">Normalize</span>();</span><br><span class="line"></span><br><span class="line">        pVertices[Index0].m_normal += Normal;</span><br><span class="line">        pVertices[Index1].m_normal += Normal;</span><br><span class="line">        pVertices[Index2].m_normal += Normal;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">unsigned</span> <span class="type">int</span> i = <span class="number">0</span> ; i &lt; VertexCount ; i++) &#123;</span><br><span class="line">        pVertices[i].m_normal.<span class="built_in">Normalize</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<p>vsshader.vs</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#version 330</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">layout</span> (location = <span class="number">0</span>) in vec3 Position;</span><br><span class="line"><span class="built_in">layout</span> (location = <span class="number">1</span>) in vec2 TexCoord;</span><br><span class="line"><span class="built_in">layout</span> (location = <span class="number">2</span>) in vec3 Normal;</span><br><span class="line"></span><br><span class="line">uniform mat4 gWVP;</span><br><span class="line">uniform mat4 gWorld;</span><br><span class="line"></span><br><span class="line">out vec2 TexCoord0;</span><br><span class="line">out vec3 Normal0;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    gl_Position = gWVP * <span class="built_in">vec4</span>(Position, <span class="number">1.0</span>);</span><br><span class="line">    TexCoord0 = TexCoord;</span><br><span class="line">    Normal0 = (gWorld * <span class="built_in">vec4</span>(Normal, <span class="number">0.0</span>)).xyz;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意“Normal0 &#x3D; (gWorld * vec4(Normal, 0.0)).xyz;” – 因为我们对于顶点法线的计算是基于物体没有移动变化之前的，所以我们真正计算所用的顶点法线需要通过世界坐标系矩阵的转换。</p>
<p>fsshader.fs</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#version 330</span></span><br><span class="line"></span><br><span class="line">in vec2 TexCoord0;</span><br><span class="line">in vec3 Normal0;                                                                    </span><br><span class="line">                                                                                    </span><br><span class="line">out vec4 FragColor;                                                                 </span><br><span class="line">                                                                                    </span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">DirectionalLight</span>                                                             </span><br><span class="line">&#123;                                                                                   </span><br><span class="line">    vec3 Color;                                                                     </span><br><span class="line">    <span class="type">float</span> AmbientIntensity;                                                         </span><br><span class="line">    <span class="type">float</span> DiffuseIntensity;                                                         </span><br><span class="line">    vec3 Direction;                                                                 </span><br><span class="line">&#125;;                                                                                  </span><br><span class="line">                                                                                    </span><br><span class="line">uniform DirectionalLight gDirectionalLight;                                         </span><br><span class="line">uniform sampler2D gSampler;                                                         </span><br><span class="line">                                                                                    </span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span>                                                                         </span></span><br><span class="line"><span class="function"></span>&#123;                                                                                   </span><br><span class="line">    vec4 AmbientColor = <span class="built_in">vec4</span>(gDirectionalLight.Color, <span class="number">1.0f</span>) *                       </span><br><span class="line">                        gDirectionalLight.AmbientIntensity;                         </span><br><span class="line">                                                                                    </span><br><span class="line">    <span class="type">float</span> DiffuseFactor = <span class="built_in">dot</span>(<span class="built_in">normalize</span>(Normal0), -gDirectionalLight.Direction);    </span><br><span class="line">                                                                                    </span><br><span class="line">    vec4 DiffuseColor;                                                              </span><br><span class="line">                                                                                    </span><br><span class="line">    <span class="keyword">if</span> (DiffuseFactor &gt; <span class="number">0</span>) &#123;                                                        </span><br><span class="line">        DiffuseColor = <span class="built_in">vec4</span>(gDirectionalLight.Color, <span class="number">1.0f</span>) *                        </span><br><span class="line">                       gDirectionalLight.DiffuseIntensity *                         </span><br><span class="line">                       DiffuseFactor;                                               </span><br><span class="line">    &#125;                                                                               </span><br><span class="line">    <span class="keyword">else</span> &#123;                                                                          </span><br><span class="line">        DiffuseColor = <span class="built_in">vec4</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);                                            </span><br><span class="line">    &#125;                                                                               </span><br><span class="line">                                                                                    </span><br><span class="line">    FragColor = <span class="built_in">texture2D</span>(gSampler, TexCoord<span class="number">0.</span>xy) *                                 </span><br><span class="line">                (AmbientColor + DiffuseColor);                                      </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从“float DiffuseFactor &#x3D; dot(normalize(Normal0), -gDirectionalLight.Direction);”可以看出，光照的方向和顶点法线之间的角度直接决定了漫反射光所占的比重。<br>参见<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Lambert's_cosine_law">Lambert’s cosine law</a></p>
<p>final effect:<br><img src="/img/OpenGL/Diffuse.PNG" alt="Diffuse"></p>
<p>Note:<br>这里我按照官网和源代码的方式按自己的方式写了，但不知道为何DiffuseFactor得出的值当我去做if else判断等，无论是&gt;0,&lt;0,&#x3D;&#x3D;0都不会进去，都只会进入最终的else。<br>我通过gDEBugger查看了uniform的值没有问题，C++那一侧所有的相关计算的值也都正确，这里弄了半天也没有解决，本来准备用Nsight调试GLSL的，发现我的笔记本好像不被支持。<br>个人最终认为是顶点的法线在传递给Shader的时候出问题了，导致dot之后计算DiffuseFactor出问题，虽然在VS一侧下的断点查看normal是正确的，但不确定为什么shader一侧获得的值会有问题。（这一结论主要是因为同样的shader代码在加载现有模型的时候起作用发现的）</p>
<p>Specular (镜面反射光) – 与光照的方向和eye观察还有顶点normal有关<br>Specular在Diffuse的基础上，还要多考虑一个因素（观察者所在位置，如果观察者正好在反光处，那么该观察点就会比在其他位置的观察点观察同一位置的看起来更亮）。但现实中并不是所有物体都有这一特性，所以Specular更针对物体材质而言而非光线本身。</p>
<p>看一下下图：<br><img src="/img/OpenGL/SpecularModle.PNG" alt="SpecularModle"><br>I是光线入射方向<br>N是平面法线<br>R是完美反射后的光线<br>V是观察者观察方向<br>a是观察者方向与完美反射光线的夹角<br>从上图可以看出当观察者所在观察角度V与R越接近时，我们可以理解为观察者观察该点会达到最大量值</p>
<p>我们计算出R主要是通过I和N和-N之间的计算：<br>详情见下图：<br><img src="/img/OpenGL/SpecularModle2.PNG" alt="SpecularModle2"><br>R &#x3D; I + V<br>V &#x3D; 2 * N * dot(-N,I)<br>这里值得一提的是OpenGL里提供了reflect方法，通过光线和平面法线就能直接算出反射R</p>
<p>让我们直接看一下Specular的计算公式：<br><img src="/img/OpenGL/SpecularCalculation.PNG" alt="SpecularCalculation"><br>M – 是跟物体材质有关的，材质决定了specular的反光系数<br>     p<br>(R.V) – 是指观察者所在位置和完美反射光线之间夹角的P次方，P是shininess factor（発光系数之类的）<br>上述换成代码如下:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">vec3 VertexToEye = <span class="built_in">normalize</span>(gEyeWorldPos - WorldPos0);                     </span><br><span class="line">vec3 LightReflect = <span class="built_in">normalize</span>(<span class="built_in">reflect</span>(gDirectionalLight.Direction, Normal));</span><br><span class="line"><span class="type">float</span> SpecularFactor = <span class="built_in">dot</span>(VertexToEye, LightReflect);                      </span><br><span class="line"><span class="keyword">if</span> (SpecularFactor &gt; <span class="number">0</span>) &#123;                                                   </span><br><span class="line">    SpecularFactor = <span class="built_in">pow</span>(SpecularFactor, gSpecularPower);</span><br><span class="line">    SpecularColor = <span class="built_in">vec4</span>(gDirectionalLight.Color * gMatSpecularIntensity * SpecularFactor, <span class="number">1.0f</span>);</span><br><span class="line">&#125;    </span><br><span class="line"></span><br><span class="line">FragColor = <span class="built_in">texture2D</span>(gSampler, TexCoord<span class="number">0.</span>xy) *                                 </span><br><span class="line">            (AmbientColor + DiffuseColor + SpecularColor);    </span><br></pre></td></tr></table></figure>

<p>Limitations of the Classic Lighting Model: （传统光源的不足之处）<br>Big Missing:</p>
<ol>
<li>Assume no other objects blocking the path of the lights to the surface （假设光不会被物体遮挡）</li>
<li>Accurate ambient lighting （统一固定精确的环境光，现实中是由削弱的（attenuation））</li>
</ol>
<p>了解了光源的三个组成，也了解了传统光源的不足，让我们来看看另一种光照Point Light：<br>Point Light是有伴随距离而削弱（attenuation）的光源<br>公式如下：<br><img src="/img/OpenGL/PointLightFormulation.PNG" alt="PointLightFormulation"></p>
<p>在实现Point Light的计算的时候，我们只需要把光照的方向根据Point Light位置算一下，并在最后除以根据物体位置与Point Light的光源位置算出的attenuation即可、</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">vec4 <span class="title">CalcPointLight</span><span class="params">(<span class="type">int</span> Index, vec3 Normal)</span>                                                 </span></span><br><span class="line"><span class="function"></span>&#123;                                                                                           </span><br><span class="line">    vec3 LightDirection = WorldPos0 - gPointLights[Index].Position;                         </span><br><span class="line">    <span class="type">float</span> Distance = <span class="built_in">length</span>(LightDirection);                                                </span><br><span class="line">    LightDirection = <span class="built_in">normalize</span>(LightDirection);                                             </span><br><span class="line">                                                                                            </span><br><span class="line">    vec4 Color = <span class="built_in">CalcLightInternal</span>(gPointLights[Index].Base, LightDirection, Normal);       </span><br><span class="line">    <span class="type">float</span> Attenuation =  gPointLights[Index].Atten.Constant +                               </span><br><span class="line">                         gPointLights[Index].Atten.Linear * Distance +                      </span><br><span class="line">                         gPointLights[Index].Atten.Exp * Distance * Distance;               </span><br><span class="line">                                                                                            </span><br><span class="line">    <span class="keyword">return</span> Color / Attenuation;                                                             </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下来我们看一下Spot Light:<br>Spot Light和Point Light的主要区别在于，Spot Light定义了一个可影响的范围Cone和其垂直照射的方向。<br>而这个Cone通过Cutoff来定义：<br>Cutoff – “ The cutoff value represents the maximum angle between the light direction and the light to pixel vector for pixels that are under the influence of the spot light.”<br>见下图：<br><img src="/img/OpenGL/SpotLight.PNG" alt="SpotLight"></p>
<p>通过计算出所在点是否在Spot Light的Cone里去决定是否影响该颜色值。<br>这里需要关注的一点是关于如何映射Cutoff值到[0，1]，因为一般来说Cutoff的值不可能设置到0（即90度），所以我们要想计算边缘化削弱效果，我们需要对Cutoff的值进行线性插值。<br>推导见如下（来源之OpenGL Tutorial 21）：<br><img src="/img/OpenGL/SpotLightCutoffMapping.PNG" alt="SpotLightCutoffMapping"></p>
<p>知道了怎么确认是否影响该点颜色，以及如何插值获取影响值，那么最终归结代码见如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">vec4 <span class="title">CalcSpotLight</span><span class="params">(<span class="keyword">struct</span> SpotLight l, vec3 Normal)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    vec3 LightToPixel = <span class="built_in">normalize</span>(WorldPos0 - l.Base.Position);</span><br><span class="line">    <span class="type">float</span> SpotFactor = <span class="built_in">dot</span>(LightToPixel, l.Direction);</span><br><span class="line">    <span class="comment">//计算所在点是否在Spot Light的Cone里去决定是否影响该颜色值。</span></span><br><span class="line">    <span class="keyword">if</span> (SpotFactor &gt; l.Cutoff) &#123;</span><br><span class="line">        vec4 Color = <span class="built_in">CalcPointLight</span>(l.Base, Normal);</span><br><span class="line">        <span class="comment">//插值计算影响值</span></span><br><span class="line">        <span class="keyword">return</span> Color * (<span class="number">1.0</span> - (<span class="number">1.0</span> - SpotFactor) * <span class="number">1.0</span>/(<span class="number">1.0</span> - l.Cutoff));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">vec4</span>(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>More Advanced Lighting Model:<br>Hemisphere Lighting:<br>The idea behind hemisphere lighting is that we model the illumination as two hemispheres. The upper hemisphere represents the sky and the lower hemisphere represents the ground</p>
<p>Imaged-Based Lighting:<br>“It is often easier and much more efficient to sample the lighting in such environments and store the results in one or more environment maps”</p>
<p>Lighting with Spherical Harmonics:<br>“This method reproduces accurate diffuse reflection, based on the content of a light probe image, without accessing the light probe image at runtime”</p>
<p><a href="www.debevec.org">详情参考</a> </p>
<p>总结:<br>Ambient (环境光) – 与光照的方向无关<br>环境光不会削弱不考虑方向，所以只需考虑光照颜色和平面颜色即可<br>Diffuse (漫反射光) – 与光照的方向和顶点normal有关<br>光照的方向和顶点法线之间的角度直接决定了漫反射光所占的比重。<br>Specular (镜面反射光) – 与光照的方向和eye观察还有顶点normal有关<br>观察者所在位置和光照方向和法线会决定观察者所在位置的Specular反射比例，物体材质会决定Specular反射系数。<br>最终通过计算环境中所有光源对物体的ambient, diffuse, specular影响计算出物体的最终color</p>
<p>接下来我们看一个真实渲染过程中比较重要的技术 – Shadow Mapping<br>Shadow Mapping – Uses a depth texture to determine whether a point is lit or not.</p>
<p>Shadow mapping is a multipass technique that uses depth textures to provide a solution to rendering shadows (核心思想是通过比较通过光源点观察保存的深度信息（depth texture）和从观察点观察的深度信息来判断哪些点是shadowed，哪些是unshadowed – 注意比较的是通过映射到2D depth texture后的信息)<br>A key pass is to view the scene from the shadow-casting light source rather than from the final viewpoint<br>Two passes:</p>
<ul>
<li><em>First Pass</em><br>Shadow map – by rendering the scene’s depth from the point of the light into a depth texture, we can obtain a map of the shadowed and unshadowed points in the scene<br>在第一个pass中，我按照事例代码中写了，但发现最后显示的是纯白色的图像。<br>后来就不断去查问题。<br><img src="/img/OpenGL/ShaowMapFirstPass.PNG" alt="ShaowMapFirstPassFailed"><br>首先，我怀疑depth texture是不是没有生成成功？</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Create the FBO</span></span><br><span class="line"><span class="built_in">glGenFramebuffers</span>(<span class="number">1</span>, &amp;m_fbo);    </span><br><span class="line"></span><br><span class="line"><span class="comment">// Create the depth buffer</span></span><br><span class="line"><span class="built_in">glGenTextures</span>(<span class="number">1</span>, &amp;m_shadowMap);</span><br><span class="line"><span class="built_in">glBindTexture</span>(GL_TEXTURE_2D, m_shadowMap);</span><br><span class="line"><span class="built_in">glTexImage2D</span>(GL_TEXTURE_2D, <span class="number">0</span>, GL_DEPTH_COMPONENT, WindowWidth, WindowHeight, <span class="number">0</span>, GL_DEPTH_COMPONENT, GL_FLOAT, <span class="literal">NULL</span>);</span><br><span class="line"><span class="built_in">glTexParameterf</span>(GL_TEXTURE_2D, GL_TEXTURE_MIN_FILTER, GL_LINEAR);</span><br><span class="line"><span class="built_in">glTexParameterf</span>(GL_TEXTURE_2D, GL_TEXTURE_MAG_FILTER, GL_LINEAR);</span><br><span class="line"><span class="built_in">glTexParameterf</span>(GL_TEXTURE_2D, GL_TEXTURE_WRAP_S, GL_CLAMP_TO_EDGE);</span><br><span class="line"><span class="built_in">glTexParameterf</span>(GL_TEXTURE_2D, GL_TEXTURE_WRAP_T, GL_CLAMP_TO_EDGE);</span><br><span class="line"></span><br><span class="line"><span class="built_in">glBindFramebuffer</span>(GL_FRAMEBUFFER, m_fbo);</span><br><span class="line"><span class="built_in">glFramebufferTexture2D</span>(GL_DRAW_FRAMEBUFFER, GL_DEPTH_ATTACHMENT, GL_TEXTURE_2D, m_shadowMap, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Disable writes to the color buffer</span></span><br><span class="line"><span class="built_in">glDrawBuffer</span>(GL_NONE);</span><br><span class="line"><span class="built_in">glReadBuffer</span>(GL_NONE);</span><br><span class="line"></span><br><span class="line">GLenum Status = <span class="built_in">glCheckFramebufferStatus</span>(GL_FRAMEBUFFER);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (Status != GL_FRAMEBUFFER_COMPLETE) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;FB error, status: 0x%x\n&quot;</span>, Status);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但上述代码没有报任何错误，通过gDebugger查看Texture的时候发现depth texture是生成成功了的。<br><img src="/img/OpenGL/ShaowMapFirstPassCreate.PNG" alt="ShaowMapFirstPassCreate"><br>从上图仔细看，模型的深度信息时被生成到了FBO 1所绑定的Depth Texture中了的。</p>
<p>那么接下来，我就怀疑是不是我激活的Texture unit有错误？<br>以下是将Depth Texture渲染到一个平面上的代码。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">ShadowMapFBO::BindForReading</span><span class="params">(GLenum TextureUnit)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">glActiveTexture</span>(TextureUnit);</span><br><span class="line">    <span class="built_in">glBindTexture</span>(GL_TEXTURE_2D, m_shadowMap);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">RenderPass</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">glClear</span>(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">glUniform1i</span>(gTextureLocation, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">	gShadowMapFBO.<span class="built_in">BindForReading</span>(GL_TEXTURE0);</span><br><span class="line"></span><br><span class="line">	Pipeline p;</span><br><span class="line">	p.<span class="built_in">Scale</span>(<span class="number">5.0f</span>, <span class="number">5.0f</span>, <span class="number">5.0f</span>);</span><br><span class="line">	p.<span class="built_in">WorldPos</span>(<span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">10.0f</span>);</span><br><span class="line">	p.<span class="built_in">SetCamera</span>(pGameCamera-&gt;<span class="built_in">GetPos</span>(), pGameCamera-&gt;<span class="built_in">GetTarget</span>(), pGameCamera-&gt;<span class="built_in">GetUp</span>());</span><br><span class="line">	p.<span class="built_in">SetPerspectiveProj</span>(gPersProjInfo);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">glUniformMatrix4fv</span>(gWVPLocation, <span class="number">1</span>, GL_TRUE, (<span class="type">const</span> GLfloat*)p.<span class="built_in">GetWVPTrans</span>());</span><br><span class="line"></span><br><span class="line">	gPQuade-&gt;<span class="built_in">Render</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/img/OpenGL/MyTextureList.PNG" alt="MyTextureList"><br><img src="/img/OpenGL/DemoTextureList.PNG" alt="DemoTextureList"><br>通过上图，我发现我自己的代码有三个Texture被生成，但Demo只有两个，并且我自己写的代码Enable的并非FBO 1绑定生成的Texture而是第三个Texture，所以这是我怀疑我在加载Mesh的时候加载了第三个Texture并将其绑定在了Texture unit 0，而我碰巧激活了这一个Texture unit。</p>
<p>由于我的mesh.cpp是沿用上一个tutorial的代码，所以我没有更新到最新教程的mesh代码。<br>下面是我所用的mesh.cpp的一个加载Texture的方法和Texture源代码加载的时候的方法</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Mesh::InitMaterials</span><span class="params">(<span class="type">const</span> aiScene* pScene, <span class="type">const</span> std::string&amp; Filename)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Load a white texture in case the model does not include its own texture</span></span><br><span class="line">    <span class="keyword">if</span> (!m_Textures[i]) &#123;</span><br><span class="line">        m_Textures[i] = <span class="keyword">new</span> <span class="built_in">Texture</span>(GL_TEXTURE_2D, <span class="string">&quot;../Content/white.png&quot;</span>);</span><br><span class="line"></span><br><span class="line">        Ret = m_Textures[i]-&gt;<span class="built_in">Load</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Mesh::Render</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	.....</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (MaterialIndex &lt; m_Textures.<span class="built_in">size</span>() &amp;&amp; m_Textures[MaterialIndex]) &#123;</span><br><span class="line">        m_Textures[MaterialIndex]-&gt;<span class="built_in">Bind</span>(GL_TEXTURE0);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    .......</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Texture::Load</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        m_image.<span class="built_in">read</span>(m_fileName);</span><br><span class="line">        m_image.<span class="built_in">write</span>(&amp;m_blob, <span class="string">&quot;RGBA&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">catch</span> (Magick::Error&amp; Error) &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Error loading texture &#x27;&quot;</span> &lt;&lt; m_fileName &lt;&lt; <span class="string">&quot;&#x27;: &quot;</span> &lt;&lt; Error.<span class="built_in">what</span>() &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">glGenTextures</span>(<span class="number">1</span>, &amp;m_textureObj);</span><br><span class="line">    <span class="built_in">glBindTexture</span>(m_textureTarget, m_textureObj);</span><br><span class="line">    <span class="built_in">glTexImage2D</span>(m_textureTarget, <span class="number">0</span>, GL_RGBA, m_image.<span class="built_in">columns</span>(), m_image.<span class="built_in">rows</span>(), <span class="number">0</span>, GL_RGBA, GL_UNSIGNED_BYTE, m_blob.<span class="built_in">data</span>());</span><br><span class="line">    <span class="built_in">glTexParameterf</span>(m_textureTarget, GL_TEXTURE_MIN_FILTER, GL_LINEAR);</span><br><span class="line">    <span class="built_in">glTexParameterf</span>(m_textureTarget, GL_TEXTURE_MAG_FILTER, GL_LINEAR);    </span><br><span class="line">    <span class="built_in">glBindTexture</span>(m_textureTarget, <span class="number">0</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Texture::Bind</span><span class="params">(GLenum TextureUnit)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">glActiveTexture</span>(TextureUnit);</span><br><span class="line">    <span class="built_in">glBindTexture</span>(m_textureTarget, m_textureObj);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>从上面可以看出如果我加载的mesh没有含有贴图的话，我会指定他去默认加载white.png作为贴图，并且渲染的时候激活Texture unit 0并将该纹理绑定到Texture unit 0</p>
<p>这也就是为什么我后来调用下列代码出现了Active错误的texture的原因。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">glUniform1i</span>(gTextureLocation, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">gShadowMapFBO.<span class="built_in">BindForReading</span>(GL_TEXTURE0);</span><br></pre></td></tr></table></figure>

<p>所以在不改Texture和Mesh源代码的情况下，我只需要将生成的Texture unit绑定到GL_TEXTURE2并指定Shader去访问Texture unit 2即可。<br>将上述代码改为如下即可：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">glUniform1i</span>(gTextureLocation, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">gShadowMapFBO.<span class="built_in">BindForReading</span>(GL_TEXTURE2);</span><br></pre></td></tr></table></figure>

<p><img src="/img/OpenGL/ShadowMapFirstPassSuccessful.PNG" alt="ShadowMapFirstPassSuccessful"></p>
<p>在渲染到Depth Texture的时候，主要是通过以下步骤：</p>
<ol>
<li>创建新的FBO和Texture object</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Create the FBO</span></span><br><span class="line"><span class="built_in">glGenFramebuffers</span>(<span class="number">1</span>, &amp;m_fbo);    </span><br><span class="line"></span><br><span class="line"><span class="comment">// Create the depth texture</span></span><br><span class="line"><span class="built_in">glGenTextures</span>(<span class="number">1</span>, &amp;m_shadowMap);</span><br><span class="line"><span class="built_in">glBindTexture</span>(GL_TEXTURE_2D, m_shadowMap);</span><br><span class="line"><span class="built_in">glTexImage2D</span>(GL_TEXTURE_2D, <span class="number">0</span>, GL_DEPTH_COMPONENT, WindowWidth, WindowHeight, <span class="number">0</span>, GL_DEPTH_COMPONENT, GL_FLOAT, <span class="literal">NULL</span>);</span><br><span class="line"><span class="built_in">glTexParameterf</span>(GL_TEXTURE_2D, GL_TEXTURE_MIN_FILTER, GL_LINEAR);</span><br><span class="line"><span class="built_in">glTexParameterf</span>(GL_TEXTURE_2D, GL_TEXTURE_MAG_FILTER, GL_LINEAR);</span><br><span class="line"><span class="built_in">glTexParameterf</span>(GL_TEXTURE_2D, GL_TEXTURE_WRAP_S, GL_CLAMP_TO_EDGE);</span><br><span class="line"><span class="built_in">glTexParameterf</span>(GL_TEXTURE_2D, GL_TEXTURE_WRAP_T, GL_CLAMP_TO_EDGE);</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>激活新的FBO并绑定Texture object到FBO的Depth buffer上</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">glBindFramebuffer</span>(GL_FRAMEBUFFER, m_fbo);</span><br><span class="line"><span class="built_in">glFramebufferTexture2D</span>(GL_DRAW_FRAMEBUFFER, GL_DEPTH_ATTACHMENT, GL_TEXTURE_2D, m_shadowMap, <span class="number">0</span>);</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>关闭颜色写入到新的FBO。因为我们只需要Depth信息，所以我们不需要写入颜色信息到新的FBO里。</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">glDrawBuffer</span>(GL_NONE);</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>检查新的FBO的状态是否完整</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">GLenum Status = <span class="built_in">glCheckFramebufferStatus</span>(GL_FRAMEBUFFER);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (Status != GL_FRAMEBUFFER_COMPLETE) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;FB error, status: 0x%x\n&quot;</span>, Status);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>激活新的FBO并清除Depth信息后以光线来源的角度draw call写入depth信息到新的FBO和绑定的depth texture里</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">ShadowMapPass</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	gShadowMapFBO.<span class="built_in">BindForWriting</span>();</span><br><span class="line"></span><br><span class="line">	<span class="built_in">glClear</span>(GL_DEPTH_BUFFER_BIT);</span><br><span class="line"></span><br><span class="line">	Pipeline p;</span><br><span class="line">	p.<span class="built_in">Scale</span>(<span class="number">0.1f</span>, <span class="number">0.1f</span>, <span class="number">0.1f</span>);</span><br><span class="line">	p.<span class="built_in">Rotate</span>(<span class="number">0.0f</span>, gScale, <span class="number">0.0f</span>);</span><br><span class="line">	p.<span class="built_in">WorldPos</span>(<span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">5.0f</span>);</span><br><span class="line">	p.<span class="built_in">SetCamera</span>(gSpotLight.Position, gSpotLight.Direction, <span class="built_in">Vector3f</span>(<span class="number">0.0f</span>, <span class="number">1.0f</span>, <span class="number">0.0f</span>));</span><br><span class="line">	p.<span class="built_in">SetPerspectiveProj</span>(gPersProjInfo);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//Set uniform variable value</span></span><br><span class="line">	<span class="built_in">glUniformMatrix4fv</span>(gWVPLocation, <span class="number">1</span>, GL_TRUE, (<span class="type">const</span> GLfloat*)p.<span class="built_in">GetWVPTrans</span>());</span><br><span class="line"></span><br><span class="line">	gPTank-&gt;<span class="built_in">Render</span>();</span><br><span class="line"></span><br><span class="line">	<span class="built_in">glBindFramebuffer</span>(GL_FRAMEBUFFER, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><em>Second Pass</em><br> Rendering the scene from the point of view of the viewer. Project the surface coordinates into the light’s reference frame and compare their depths to the depth recorded into the light’s depth texture. Fragments that are further from the light than the recorded depth value were not visible to the light, and hence in shadow</li>
</ul>
<p>第二个pass的关键有下列几个点：</p>
<ol>
<li>正常方式渲染时，通过传递Light的MVP去计算每一个顶点在光源角度观察时的投影位置信息。</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">RenderPass</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">glClear</span>(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT);</span><br><span class="line"></span><br><span class="line">    m_pLightingEffect-&gt;<span class="built_in">Enable</span>();</span><br><span class="line"></span><br><span class="line">    m_pLightingEffect-&gt;<span class="built_in">SetEyeWorldPos</span>(m_pGameCamera-&gt;<span class="built_in">GetPos</span>());</span><br><span class="line">   </span><br><span class="line">    m_shadowMapFBO.<span class="built_in">BindForReading</span>(GL_TEXTURE1);</span><br><span class="line"></span><br><span class="line">    Pipeline p;</span><br><span class="line">    p.<span class="built_in">SetPerspectiveProj</span>(m_persProjInfo);</span><br><span class="line"></span><br><span class="line">    p.<span class="built_in">Scale</span>(<span class="number">10.0f</span>, <span class="number">10.0f</span>, <span class="number">10.0f</span>);</span><br><span class="line">    p.<span class="built_in">WorldPos</span>(<span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">1.0f</span>);</span><br><span class="line">    p.<span class="built_in">Rotate</span>(<span class="number">90.0f</span>, <span class="number">0.0f</span>, <span class="number">0.0f</span>);</span><br><span class="line">    p.<span class="built_in">SetCamera</span>(m_pGameCamera-&gt;<span class="built_in">GetPos</span>(), m_pGameCamera-&gt;<span class="built_in">GetTarget</span>(), m_pGameCamera-&gt;<span class="built_in">GetUp</span>());</span><br><span class="line">    m_pLightingEffect-&gt;<span class="built_in">SetWVP</span>(p.<span class="built_in">GetWVPTrans</span>());</span><br><span class="line">    m_pLightingEffect-&gt;<span class="built_in">SetWorldMatrix</span>(p.<span class="built_in">GetWorldTrans</span>());        </span><br><span class="line">    p.<span class="built_in">SetCamera</span>(m_spotLight.Position, m_spotLight.Direction, <span class="built_in">Vector3f</span>(<span class="number">0.0f</span>, <span class="number">1.0f</span>, <span class="number">0.0f</span>));</span><br><span class="line">    m_pLightingEffect-&gt;<span class="built_in">SetLightWVP</span>(p.<span class="built_in">GetWVPTrans</span>());</span><br><span class="line">    m_pGroundTex-&gt;<span class="built_in">Bind</span>(GL_TEXTURE0);</span><br><span class="line">    m_pQuad-&gt;<span class="built_in">Render</span>();</span><br><span class="line"></span><br><span class="line">    p.<span class="built_in">Scale</span>(<span class="number">0.1f</span>, <span class="number">0.1f</span>, <span class="number">0.1f</span>);</span><br><span class="line">    p.<span class="built_in">Rotate</span>(<span class="number">0.0f</span>, m_scale, <span class="number">0.0f</span>);</span><br><span class="line">    p.<span class="built_in">WorldPos</span>(<span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">3.0f</span>);</span><br><span class="line">    p.<span class="built_in">SetCamera</span>(m_pGameCamera-&gt;<span class="built_in">GetPos</span>(), m_pGameCamera-&gt;<span class="built_in">GetTarget</span>(), m_pGameCamera-&gt;<span class="built_in">GetUp</span>());</span><br><span class="line">    m_pLightingEffect-&gt;<span class="built_in">SetWVP</span>(p.<span class="built_in">GetWVPTrans</span>());</span><br><span class="line">    m_pLightingEffect-&gt;<span class="built_in">SetWorldMatrix</span>(p.<span class="built_in">GetWorldTrans</span>());</span><br><span class="line">    p.<span class="built_in">SetCamera</span>(m_spotLight.Position, m_spotLight.Direction, <span class="built_in">Vector3f</span>(<span class="number">0.0f</span>, <span class="number">1.0f</span>, <span class="number">0.0f</span>));</span><br><span class="line">    m_pLightingEffect-&gt;<span class="built_in">SetLightWVP</span>(p.<span class="built_in">GetWVPTrans</span>());</span><br><span class="line">    m_pMesh-&gt;<span class="built_in">Render</span>();        </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">lighting.vs</span><br><span class="line"><span class="meta">#version 330                                                                        </span></span><br><span class="line">                                                                                    </span><br><span class="line"><span class="built_in">layout</span> (location = <span class="number">0</span>) in vec3 Position;                                             </span><br><span class="line"><span class="built_in">layout</span> (location = <span class="number">1</span>) in vec2 TexCoord;                                             </span><br><span class="line"><span class="built_in">layout</span> (location = <span class="number">2</span>) in vec3 Normal;                                               </span><br><span class="line">                                                                                    </span><br><span class="line">uniform mat4 gWVP;                                                                  </span><br><span class="line">uniform mat4 gLightWVP;                                                             </span><br><span class="line">uniform mat4 gWorld;                                                                </span><br><span class="line">                                                                                    </span><br><span class="line">out vec4 LightSpacePos;                                                             </span><br><span class="line">out vec2 TexCoord0;                                                                 </span><br><span class="line">out vec3 Normal0;                                                                   </span><br><span class="line">out vec3 WorldPos0;                                                                 </span><br><span class="line">                                                                                    </span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span>                                                                         </span></span><br><span class="line"><span class="function"></span>&#123;                                                                                   </span><br><span class="line">    ......</span><br><span class="line">    <span class="comment">//这里就是转换到以光源为摄像机角度的透视投影后的坐标信息</span></span><br><span class="line">    LightSpacePos = gLightWVP * <span class="built_in">vec4</span>(Position, <span class="number">1.0</span>);                                 </span><br><span class="line">	......                     </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>然后通过把光源角度下投影的位置信息转换到NDC space(设备坐标系，光栅化后xyz都映射到[-1,1])，这时就得到了顶点在光源角度下NDC的坐标信息。</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//lighting.fs                                                 </span></span><br><span class="line"><span class="function"><span class="type">float</span> <span class="title">CalcShadowFactor</span><span class="params">(vec4 LightSpacePos)</span>                                                 </span></span><br><span class="line"><span class="function"></span>&#123;      </span><br><span class="line">	<span class="comment">//通过除以w我们可以得到NDC space的信息</span></span><br><span class="line">    vec3 ProjCoords = LightSpacePos.xyz / LightSpacePos.w;                    </span><br><span class="line">	......                                                              </span><br><span class="line">&#125;            </span><br></pre></td></tr></table></figure>

<ol start="3">
<li>最后通过转换纹理坐标映射到[0,1]去查询Depth texture中的深度信息和自身的z深度信息作比较，如果depth texture中值更小说明改点处于被遮挡区域应该是阴影部分。</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">float</span> <span class="title">CalcShadowFactor</span><span class="params">(vec4 LightSpacePos)</span>                                                 </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">    ......</span><br><span class="line">    vec2 UVCoords;                                                                         </span><br><span class="line">    UVCoords.x = <span class="number">0.5</span> * ProjCoords.x + <span class="number">0.5</span>;                                                 </span><br><span class="line">    UVCoords.y = <span class="number">0.5</span> * ProjCoords.y + <span class="number">0.5</span>;                                                 </span><br><span class="line">    <span class="type">float</span> z = <span class="number">0.5</span> * ProjCoords.z + <span class="number">0.5</span>;                                                    </span><br><span class="line">    <span class="type">float</span> Depth = <span class="built_in">texture</span>(gShadowMap, UVCoords).x;                                         </span><br><span class="line">    <span class="keyword">if</span> (Depth &lt; z + <span class="number">0.00001</span>)                                                               </span><br><span class="line">        <span class="keyword">return</span> <span class="number">0.5</span>;                                                                        </span><br><span class="line">    <span class="keyword">else</span>                                                                                   </span><br><span class="line">        <span class="keyword">return</span> <span class="number">1.0</span>           </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因为原本x，y，z在NDC space下是[-1,1]，为了映射到[0,1]，我们只需要按上述方法即可。<br>这样一来就得到NDC space下的纹理坐标信息和深度z信息，然后通过查询depth texture获取光源角度的深度信息和现有顶点在光源角度的深度信息做比较得出是否处于阴影的结论。</p>
<p>这里实现相当复杂就没有自己再去写一遍，具体参考Tutorial 24的源代码。<br>最终效果：<br><img src="/img/OpenGL/ShadowMapFinal.PNG" alt="ShadowMap"></p>
<h3 id="Skybox"><a href="#Skybox" class="headerlink" title="Skybox"></a>Skybox</h3><p>A skybox is a method of creating backgrounds to make a computer and video games level look bigger than it really is. When a skybox is used, the level is enclosed in a cuboid. (From wiki)<br><img src="/img/OpenGL/SkyboxTexture.PNG" alt="SkyboxTexture"></p>
<p>在OpenGL中实现Skybox是通过Cubemap。</p>
<p>In order to sample from the cubemap we will use a 3D texture coordinate instead of the 2D coordinate</p>
<p>Skydome –  A skybox which uses a sphere is sometimes called a skydome.</p>
<p>实现skybox主要有下列几点需要注意：</p>
<ol>
<li>生成Cubemap texture,分别指定6个对应skybox的六个面类型的纹理数据</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">const</span> GLenum types[<span class="number">6</span>] = &#123;  GL_TEXTURE_CUBE_MAP_POSITIVE_X,</span><br><span class="line">                                  GL_TEXTURE_CUBE_MAP_NEGATIVE_X,</span><br><span class="line">                                  GL_TEXTURE_CUBE_MAP_POSITIVE_Y,</span><br><span class="line">                                  GL_TEXTURE_CUBE_MAP_NEGATIVE_Y,</span><br><span class="line">                                  GL_TEXTURE_CUBE_MAP_POSITIVE_Z,</span><br><span class="line">                                  GL_TEXTURE_CUBE_MAP_NEGATIVE_Z &#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">CubemapTexture::Load</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//生成cubemap texture</span></span><br><span class="line">    <span class="built_in">glGenTextures</span>(<span class="number">1</span>, &amp;m_textureObj);</span><br><span class="line">    <span class="built_in">glBindTexture</span>(GL_TEXTURE_CUBE_MAP, m_textureObj);</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="comment">//指定对应skybox六个面类型的纹理数据</span></span><br><span class="line">    <span class="built_in">glTexImage2D</span>(types[i], <span class="number">0</span>, GL_RGB, pImage-&gt;<span class="built_in">columns</span>(), pImage-&gt;<span class="built_in">rows</span>(), <span class="number">0</span>, GL_RGBA, GL_UNSIGNED_BYTE, blob.<span class="built_in">data</span>());</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<ol start="2">
<li>渲染skybox的时候，需要把glCullFace和glDepthFunc设置成GL_FRONT和GL_LEQUAL（因为camera是放在skybox sphere内部的，而sphere的triangle是front face, 所以针对skybox sphere我们需要cull的是front而非back。为了使得skybox永远不会被clip掉，我们需要修改默认的glDepthFunc到GL_LEQUAL来确保在Z &#x3D; 1的far平面也不会被clip。）</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">SkyBox::Render</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    m_pSkyboxTechnique-&gt;<span class="built_in">Enable</span>();</span><br><span class="line"></span><br><span class="line">    GLint OldCullFaceMode;</span><br><span class="line">    <span class="built_in">glGetIntegerv</span>(GL_CULL_FACE_MODE, &amp;OldCullFaceMode);</span><br><span class="line">    GLint OldDepthFuncMode;</span><br><span class="line">    <span class="built_in">glGetIntegerv</span>(GL_DEPTH_FUNC, &amp;OldDepthFuncMode);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//确保skybox sphere不被clip掉并且显示出正确的一面</span></span><br><span class="line">    <span class="built_in">glCullFace</span>(GL_FRONT);</span><br><span class="line">    <span class="built_in">glDepthFunc</span>(GL_LEQUAL);</span><br><span class="line"></span><br><span class="line">    .......</span><br><span class="line"></span><br><span class="line">    m_pMesh-&gt;<span class="built_in">Render</span>();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">glCullFace</span>(OldCullFaceMode);</span><br><span class="line">    <span class="built_in">glDepthFunc</span>(OldDepthFuncMode);</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<ol start="3">
<li>确保skybox深度检测时值永远在Z &#x3D; 1的far平面（这样一来确保skybox深度检测永远失败，因为我们吧glDepthFunc设置成了GL_LEQUAL）</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">skybox.vs</span><br><span class="line"><span class="meta">#version 330</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">layout</span> (location = <span class="number">0</span>) in vec3 Position;</span><br><span class="line"></span><br><span class="line">uniform mat4 gWVP;</span><br><span class="line"></span><br><span class="line">out vec3 TexCoord0;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    vec4 WVP_Pos = gWVP * <span class="built_in">vec4</span>(Position, <span class="number">1.0</span>);</span><br><span class="line">    <span class="comment">//通过把gl_Position的z设置成w，在光栅化进入fragment shader之前，skybox的z值会永远映射到1(即远平面)，确保skybox深度检测永远fail但永远不被clip（因为我们吧glDepthFunc设置成了GL_LEQUAL）</span></span><br><span class="line">    gl_Position = WVP_Pos.xyww;</span><br><span class="line">    TexCoord0 = Position;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<ol start="4">
<li>把object space的3D坐标当做3D texture坐标的索引值去查询纹理信息</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">skybox.vs</span><br><span class="line"><span class="meta">#version 330</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">layout</span> (location = <span class="number">0</span>) in vec3 Position;</span><br><span class="line"></span><br><span class="line">uniform mat4 gWVP;</span><br><span class="line"></span><br><span class="line">out vec3 TexCoord0;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	......</span><br><span class="line">	<span class="comment">//因为cubemap这里默认cube和sphere都是以自身中心作为基准（个人认为这里的基准是可变的（建模工具可设定）），这样一来把object space的坐标信息通过光栅化后传递到fs中就可以作为texture coordinate来查询纹理信息</span></span><br><span class="line">    TexCoord0 = Position;</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line">skybox.fs</span><br><span class="line"><span class="meta">#version 330</span></span><br><span class="line"></span><br><span class="line">in vec3 TexCoord0;</span><br><span class="line"></span><br><span class="line">out vec4 FragColor;</span><br><span class="line"></span><br><span class="line">uniform samplerCube gCubemapTexture;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//这里的TexCoord0是经过光栅化后映射到了[-1,1]</span></span><br><span class="line">    FragColor = <span class="built_in">texture</span>(gCubemapTexture, TexCoord0);</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<p><img src="/img/OpenGL/Skybox.PNG" alt="Skybox"></p>
<p>Note:<br>“An interesting performance tip is to always render the skybox last (after all the other models). The reason is that we know that it will always be behind the other objects in the scene.”</p>
<h3 id="Normal-Mapping"><a href="#Normal-Mapping" class="headerlink" title="Normal Mapping"></a>Normal Mapping</h3><p>在了解Normal Mapping之前不得不提Bump Mapping<br>下列关于Bump Mapping大部分内容来源:<br><a target="_blank" rel="noopener" href="http://blog.csdn.net/pizi0475/article/details/48547329">OpenGL 法线贴图 切线空间 整理</a><br><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Bump_mapping">Bump mapping</a><br><a target="_blank" rel="noopener" href="http://demo.netfoucs.com/zangle260/article/details/44156795">关于法线贴图, 法线, 副法线, 切线 的东东,看了很容易理解</a></p>
<p>What is Bump Mapping?<br><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Bump_mapping">Bump mapping[1] is a technique in computer graphics for simulating bumps and wrinkles on the surface of an object. This is achieved by perturbing the surface normals of the object and using the perturbed normal during lighting calculations.</a></p>
<p>可以看出Bump Mapping是通过改变物体顶点法线来影响光照的效果，最终看起来有凹凸的效果（而非顶点之间真实的深度差），是一种欺骗眼睛的技术。</p>
<p>“Jim Blinn在1978发表了一篇名为：“Simulation of Wrinkled Surfaces”，提出了Bump Mapping这个东东。Bump Mapping通过一张Height Map记录各象素点的高度信息，有了高度信息，就可以计算HeightMap中当前象素与周围象素的高度差，这个高度差就代表了各象素的坡度，用这个坡度信息去绕动法向量，得到最终法向量，用于光照计算。坡度越陡，绕动就越大。”</p>
<p>Why Bump Mapping?<br>“如果要在几何体表面表现出凹凸不平的细节，那么在建模的时候就会需要很多的三角面，如果用这样的模型去实时渲染，出来的效果是非常好，只是性能上很有可能无法忍受。Bump Mapping不需要增加额外的几何信息,就可以达到增强被渲染物体的表面细节的效果，可以大大地提高渲染速度，因此得到了广泛的应用。”</p>
<p>What is Normal Mapping?<br>“Normal Mapping也叫做Dot3 Bump Mapping,它也是Bump Mapping的一种，区别在于Normal Mapping技术直接把Normal存到一张NormalMap里面，从NormalMap里面采回来的值就是Normal，不需要像HeightMap那样再经过额外的计算。”</p>
<p>“值得注意的是，NormalMap存的Normal是基于切线空间的，因此要进行光照计算时，需要把Normal,Light Direction,View direction统一到同一坐标空间中。”</p>
<p>这里不得不提的一个点就是切线空间(tangent space)<br>What is tangent space?<br>“ Tangent Space与World Space，View Space其实是同样的概念，均代表三维坐标系。在这个坐标系中，X轴对应纹理坐标的U方向，沿着该轴纹理坐标U线性增大。Y轴对应纹理坐标的V方向，沿着该轴纹理坐标V线性增大。Z轴则是UXV，垂直于纹理平面。”</p>
<p>Why do we need tangent space?<br>“为什么normal map里面存的法线信息是基于tangent sapce而不是基于local space呢?基于local space理论上也是可以的，但是这样的normal map只能用于一个模型，不同把这个normal map用于其他模型。比如说建模了一个人，并且生成了该模型基于local space的normal map， 如果我们建模同一个人，但是放的位置和角度和之前的不一样，那么之前的normal map就不能用了，因为local Space并不一样，但如果我们normal map里存的是tangent space的normal的话，就不存在这个问题，因为只要模型一样，模型上每个点的tangent space就是一样的，所谓以不变应万变。”</p>
<p>可以看出tangent space是针对顶点而言的。</p>
<p>How to get tangent space?<br>让我们看一下下图：<br><img src="/img/OpenGL/TangentSpaceCaculation.PNG" alt="TangentSpaceCaculation"><br>以下推导来源于:<br><a target="_blank" rel="noopener" href="http://ogldev.atspace.co.uk/www/tutorial26/tutorial26.html">Tutorial 26:Normal Mapping</a><br><img src="/img/OpenGL/TangentSpaceDeduce.PNG" alt="TangentSpaceDeduce"><br><img src="/img/OpenGL/TangentSpaceDeduce2.PNG" alt="TangentSpaceDeduce2"><br>从上面而已看出通过三角形的顶点和纹理信息可以算出T和B</p>
<p>Note:<br>在实际开发中我们并非一定要手动写代码运算，比如”Open Asset Import Library就支持flag called ‘aiProcess_CalcTangentSpace’ which does exactly that and calculates the tangent vectors for us”</p>
<p>Normal Map也通过工具可以生成，比如3D Max， Maya， 教程里用的GNU Image Manipulation Program (GIMP)…….</p>
<p>当我们通过Normap Map获取得到normal值时，因为该normal值时位于tangent space下，所以我们必须对其进行坐标系转换，必须转换到world space后才参与光照计算。</p>
<p>而这个变换到世界坐标系的矩阵，可以通过tangent这个向量和顶点法线信息推导出来。</p>
<ol>
<li>加载mesh时生成tangent数据，渲染时指定tangent数据位置</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Mesh::LoadMesh</span><span class="params">(<span class="type">const</span> std::string&amp; Filename)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    Assimp::Importer Importer;</span><br><span class="line">    <span class="comment">//aiProcess_CalcTangentSpace指定生成tangent数据</span></span><br><span class="line">    <span class="type">const</span> aiScene* pScene = Importer.<span class="built_in">ReadFile</span>(Filename.<span class="built_in">c_str</span>(), aiProcess_Triangulate |</span><br><span class="line">                                                                aiProcess_GenSmoothNormals |</span><br><span class="line">                                                                aiProcess_FlipUVs |</span><br><span class="line">                                                                aiProcess_CalcTangentSpace);    </span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">Mesh::Render</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	......</span><br><span class="line">    <span class="comment">//指定tangent数据读取方式</span></span><br><span class="line">    <span class="built_in">glVertexAttribPointer</span>(<span class="number">3</span>, <span class="number">3</span>, GL_FLOAT, GL_FALSE, <span class="built_in">sizeof</span>(Vertex), (<span class="type">const</span> GLvoid*)<span class="number">32</span>); <span class="comment">// tangent</span></span><br><span class="line">     </span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>将tangent和顶点法线转换到世界坐标系</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">layout</span> (location = <span class="number">0</span>) in vec3 Position;</span><br><span class="line"><span class="built_in">layout</span> (location = <span class="number">1</span>) in vec2 TexCoord;</span><br><span class="line"><span class="built_in">layout</span> (location = <span class="number">2</span>) in vec3 Normal;</span><br><span class="line"><span class="built_in">layout</span> (location = <span class="number">3</span>) in vec3 Tangent;</span><br><span class="line"></span><br><span class="line">uniform mat4 gWVP;</span><br><span class="line">uniform mat4 gLightWVP;</span><br><span class="line">uniform mat4 gWorld;</span><br><span class="line"></span><br><span class="line">out vec4 LightSpacePos;</span><br><span class="line">out vec2 TexCoord0;</span><br><span class="line">out vec3 Normal0;</span><br><span class="line">out vec3 WorldPos0;</span><br><span class="line">out vec3 Tangent0;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	......</span><br><span class="line">	<span class="comment">//将tangent和顶点法线转换到世界坐标系</span></span><br><span class="line">    Normal0 = (gWorld * <span class="built_in">vec4</span>(Normal, <span class="number">0.0</span>)).xyz;</span><br><span class="line">    Tangent0 = (gWorld * <span class="built_in">vec4</span>(Tangent, <span class="number">0.0</span>)).xyz;</span><br><span class="line">    ......</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<ol start="3">
<li><p>通过转换到世界坐标系的tangent和normal计算出bitangent（转换到世界坐标系后的B）（下面T代表tangent， N代表normal， B代表bitangent）</p>
</li>
<li><p>逆算出tangent space下normal map里的顶点法线值</p>
</li>
<li><p>通过算出的位于世界坐标系的TBN去转换tangent space下逆算后的normal map的顶点法线值，最终得到位于世界坐标的顶点法线</p>
</li>
<li><p>算出位于世界坐标系的顶点法线后，最后正常参与diffuse光照计算即可</p>
</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">(lighting.fs:<span class="number">132</span>)</span><br><span class="line"><span class="function">vec3 <span class="title">CalcBumpedNormal</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    vec3 Normal = <span class="built_in">normalize</span>(Normal0);</span><br><span class="line">    vec3 Tangent = <span class="built_in">normalize</span>(Tangent0);</span><br><span class="line">    <span class="comment">//得到位于TN平面且垂直于N的向量</span></span><br><span class="line">    Tangent = <span class="built_in">normalize</span>(Tangent - <span class="built_in">dot</span>(Tangent, Normal) * Normal);</span><br><span class="line">    <span class="comment">//通过叉乘得出垂直于T和N的B</span></span><br><span class="line">    vec3 Bitangent = <span class="built_in">cross</span>(Tangent, Normal);</span><br><span class="line">    vec3 BumpMapNormal = <span class="built_in">texture</span>(gNormalMap, TexCoord0).xyz;</span><br><span class="line">    <span class="comment">//这里需要注意一点：</span></span><br><span class="line">    <span class="comment">//&quot;我们在描述色彩的时候，RGB三个通道的取值范围都是从零开始的。可是当我们尝试把一个任意的法线保存在一张纹理中的时候，会面临取负值的问题。因此我们要把法线做压缩。方法很简单，把XYZ每个轴上的法线投影长度进行N＋1/2的运算。这样就把所有的法线压缩到了0和1的范围里。&quot;</span></span><br><span class="line">    <span class="comment">//所以这里通过列方法算回原有的顶点法线值</span></span><br><span class="line">    BumpMapNormal = <span class="number">2.0</span> * BumpMapNormal - <span class="built_in">vec3</span>(<span class="number">1.0</span>, <span class="number">1.0</span>, <span class="number">1.0</span>);</span><br><span class="line">    vec3 NewNormal;</span><br><span class="line">    <span class="comment">//由于位于世界坐标系的T,N,B都算出来了，所以可以构建一个TBN的矩阵去把normal map里的法线值转换到世界坐标系</span></span><br><span class="line">    mat3 TBN = <span class="built_in">mat3</span>(Tangent, Bitangent, Normal);</span><br><span class="line">    NewNormal = TBN * BumpMapNormal;</span><br><span class="line">    <span class="comment">//最后归一化算出来的顶点法线既得到了我们需要的位于世界坐标系的顶点法线，最后正常参与diffuse光照计算即可</span></span><br><span class="line">    NewNormal = <span class="built_in">normalize</span>(NewNormal);</span><br><span class="line">    <span class="keyword">return</span> NewNormal;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>让我们看看Normal Map Texture<br><img src="/img/OpenGL/NormalMapTexture.PNG" alt="NormalMapTexture"></p>
<p>See Normal Mapping(left) and Regular Mapping(right)<br><img src="/img/OpenGL/NormalMappingAndRegularMapping.PNG" alt="NormalMappingAndRegularMapping"></p>
<p>Note:<br><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Normal_mapping">A common use of this(normal mapping) technique is to greatly enhance the appearance and details of a low polygon model by generating a normal map from a high polygon model or height map.</a></p>
<p>高模normal map用于低模模型上，即不增加渲染负担又能增加渲染细节。</p>
<p>More：<br><a target="_blank" rel="noopener" href="http://blog.csdn.net/pizi0475/article/details/48547329">下面内容来源</a><br>Parallax Mapping<br>当使用Normal Mapping技术时，并没有把视线方向考滤进去。在真实世界中，如果物体表面高低不平，当视线方向不同时，看到的效果也不相同。Parallax Mapping就是为了解决此问题而提出的。</p>
<p>Parallax Mapping首先在一篇名为“Detailed Shape Representation with Parallax Mapping”的文章中提出。它的基本思想如下图示（本图来自Parallax Mapping with Offset Limiting: A PerPixel Approximation of Uneven Surfaces）。在图示的视线方向，如果表面是真正的凹凸不平的，如real surfacer所示，那么能看到的是B点，因此用于采样法线的正确纹理坐是TB而不是TA。<br><img src="/img/OpenGL/ParallaxMappinge.PNG" alt="ParallaxMappinge"><br>因此，我们需要对纹理坐标作偏移，为了满足实时渲染的要求，采用了取近似偏移的方法（如下图示），这种近似的算法已经可以达到比较好的效果。具体的offset计算可以参考：“Parallax Mapping with Offset Limiting: A PerPixel Approximation of Uneven Surface”，里面有详细的讲解。<br><img src="/img/OpenGL/ParallaxMappinge2.PNG" alt="ParallaxMappinge2"></p>
<p>Parallax Occlusion Mapping<br>Parallax Occlusion Mapping是对Parallax Mapping的改进，DirectX SDK中有个Sample专门讲这个，相关细节可以参看此Sample. Parallax Occlusion Mapping中实现了Self Shadow，还计算了比较精确的offset，复杂度比Parallax Mapping大，但是实现效果更好。</p>
<h3 id="BillBoard-And-Geometry-Shader"><a href="#BillBoard-And-Geometry-Shader" class="headerlink" title="BillBoard And Geometry Shader"></a>BillBoard And Geometry Shader</h3><p>Geometry shader(Optional)<br>“The geometry shader sits logically right before primitive assembly and fragment shading.”</p>
<p>Receives as its input complete primitives as a collection of vertices, and these inputs are represented as array (Geometry shader接收完整图形的顶点集合，这些顶点集合在geometry shader中通过gl_in[]数组的方式访问)</p>
<p>gl_in的声明：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">in gl_PerVertex &#123;</span><br><span class="line">vec4 gl_Position;</span><br><span class="line"><span class="type">float</span> gl_PointSize;</span><br><span class="line"><span class="type">float</span> gl_ClipDistance[];</span><br><span class="line">&#125;gl_in[];</span><br></pre></td></tr></table></figure>

<p>Geometry Features:</p>
<ol>
<li><p>Producing Primitives<br>They can have a different primitive type for their output than they do for their input. (EG: wireframe rendering, billboards and even interesting instancing effects)(Billboard效果见后面)</p>
</li>
<li><p>Culling Geometry<br>Selective culling （geometry shader通过对特定的gl_PrimitiveIDIn进行生成特定的primitive实现selective culling）<br>“gl_PrimitiveIDIn is a geometry language input variable that holds the number of primitives processed by the shader since the current set of rendering primitives was started.”</p>
</li>
<li><p>Geometry Amplification<br>Produces more primitives on its output than it accepts on its input<br>(can be used to implement fur shells or moderate tessellation – 因为可以对传入的primitive数据进行处理并生成多个primitive，所以能通过复制并改变primitive的信息数据来实现毛发等效果)<br>Gl_MaxGeometryOutputVertices &amp; glGetIntegerv(GL_MAX_GEOMETRY_OUTPUT_VERTICES)<br>毛发效果(来源OpenGL红宝书第八版)：<br><img src="/img/OpenGL/Geometry_Shader_Fur.PNG" alt="Geometry_Shader_Fur"></p>
</li>
<li><p>Geometry Shader Instance<br>Only runs the geometry shader and subsequent stages (rasterization) multiple times, rather than the whole pipeline (Geometry shader instancing draw call是通过运行多次geometry和rasterization和fragment来实现的)<br>Geometry shader instancing is enabled in the shader by specifying the invocations layout qualifier</p>
</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//gl_InvocationID identifies the invocation number assigned to the geometry shader invocation.</span></span><br><span class="line"><span class="built_in">layout</span> (triangles, invocations = <span class="number">4</span>) in;  <span class="comment">//invocations = 4 indicates that the geometry shader will be called 4 times for each input primitives</span></span><br></pre></td></tr></table></figure>

<ol start="5">
<li><p>Multiple Viewport Rendering<br>gl_ViewportIndex (output variables available in the geometry shader that can redirect rendering into different regions of the framebuffer)<br>gl_ViewportIndex is used to specify which set of viewport parameters will be used to perform the viewport transformation by OpenGL<br>“ (Multiple viewport concept （多个视图窗口） – 这里主要是通过gl_ViewportIndex访问多个viewport，然后在geometry shader中通过指定primitive输出到特定的viewport来实现多个视图窗口)<br>glViewportIndexedf() or glViewportIndexedfv() – specify how window x and y coordinates are generated from clip coordinates<br>glDepthRangeIndexed() – specify how the window z coordinate is generated<br>效果展示(这里展示的OpenGL红宝书第八版的例子)：<br><img src="/img/OpenGL/Multiple_Viewports.PNG" alt="Multiple_Viewports"></p>
</li>
<li><p>Layer Rendering<br>It is also possible to use a 2D array texture as a color attachment and render into the slices of the array using a geometry shader (传入2D的纹理数组数据当做color attachment，通过geometry shader把传入的2D纹理数组信息去渲染多个slices)<br>A restriction exits when using layered attachments to framebuffer: (使用layered attachment到framebuffer的规则):<br>All the attachments of that framebuffer must be layered (framebuffer的所有attachment都必须是layered)<br>Also, all attachments of a layered framebuffer must be of the same type (所有attach到layered framebuffer的attachment必须是同样类型)<br>gl_Layer – built in variable in geometry shader – that is used to specify the zero-based index of the layer into which rendering will be directed<br>可实现的效果好比:<br>Cube-Map<br>添加cube_map texture为color attachment到framebuffer中<br>cube-map texture(2D texture)这里会被划分成六个layer的array texture<br>通过instanced geometry shader生成六个faces（对应六个layer），通过gl_InvocationID和gl_Layer访问六个faces并做相应的projection matrices运算实现Cube_Map Face的效果</p>
</li>
<li><p>Advanced Transform Feedback<br>这里首先要了解下什么是Transform Feeback？<br>Transform feedback can be considered a stage of the OpenGL pipeline that sits after all of the vertex-processing stages and directly before primitive assembly and rasterization. Transform feedback captures vertices as they are assembled into primitives and allow some or all of their attributes to be recorded into buffer objects. (Transform feedback发生在所有顶点运算阶段之后（所以如果geometry shader打开了，transform feedback就发生在geometry shader之后，相反是在vertex shader之后），在primitive assembly和光栅化之前。Transform feedback可以保存顶点的一些属性信息用于下一次的运算。)</p>
</li>
</ol>
<p>Why do we need transform feedback?<br>“DirectX10 introduced a new feature known as Stream Output that is very useful for implementing particle systems. OpenGL followed in version 3.0 with the same feature and named it Transform Feedback. The idea behind this feature is that we can connect a special type of buffer (called Transform Feedback Buffer right after the GS (or the VS if the GS is absent) and send our transformed primitives to it. In addition, we can decide whether the primitives will also continue on their regular route to the rasterizer. The same buffer can be connected as a vertex buffer in the next draw and provide the vertices that were output in the previous draw as input into the next draw. This loop enables the two steps above to take place entirely on the GPU with no application involvement (other than connecting the proper buffers for each draw and setting up some state).”</p>
<p>从上面可以看出，transform feedback可以帮助我们在构建primitive之前保存顶点相关的一些信息参与到下一次draw的运算且不用参与到Clipping，rasterizer和FS。最重要的是所有这一切都发生在GPU上，不需要从GPU上copy数据到CPU上做运算。</p>
<p>大致情况如下图：<br><img src="/img/OpenGL/TransformFeedbackFlowchart.PNG" alt="TransformFeedbackFlowchart"></p>
<p>了解一些相关概念：<br>Transform Feedback Objects:<br>“The state required to represent transform feedback is encapsulated into a<br>transform feedback object.”(transform feedback objects主要是存储跟transform feedback相关的一些状态。比如：哪一个buffer绑定到了transform feedback buffer的binding point)</p>
<p>Transform Feedback Buffer:<br>vertex shader或geometry shader中获取来的信息，这里的TFB是指通过glBindBufferBase之类方法后被绑定到Tansform Feedback Objects上的buffer</p>
<p>glBindBufferBase调用的时候需要指定index作为binding point，如果我们想要把Transform Feedback Buffer的数据存储在多个buffer的时候我们可以把多个buffer绑定到不同的binding point上，然后通过glTransformFeedbackVaryings传入的参数格式决定我们生成的数据是如何写入到各个buffer里的。</p>
<p>具体的glTransformFeedbackVaryings如何配置决定数据是如何写入到各个buffer的参见OpenGL红宝书Configuring Transform Feedback Varyings</p>
<p>因为粒子效果用到了Billboard来展示，所以在了解Particle System之前，我们先来看看Billboard是如何通过GS实现的：<br>Billboard - “A billboard is a quad which always faces the camera. “</p>
<ol>
<li>Before a geometry shader may be linked, the input primitive type, output primitive type, and the maximum number of vertices that is might produce must be specified (在链接geometry shader之前，我们必须先定义geometry shader的输入输出类型)</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">version <span class="number">330</span>                                                                        </span><br><span class="line"><span class="comment">//指明GS中传入的数据是以点为单位                                                           layout(points) in;                                                                  </span></span><br><span class="line"><span class="comment">//指明GS将输出的primitive是triangle_strip</span></span><br><span class="line"><span class="built_in">layout</span>(triangle_strip) out;              </span><br><span class="line"><span class="comment">//指明GS生成的最大顶点数量是4，因为这里我们只需4个顶点组成一个quad即可</span></span><br><span class="line"><span class="built_in">layout</span>(max_vertices = <span class="number">4</span>) out;                                                       </span><br><span class="line">          </span><br><span class="line">......</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span>                                                                         </span></span><br><span class="line"><span class="function"></span>&#123;                                    </span><br><span class="line">	......</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//e.g:</span></span><br><span class="line"><span class="comment">//layout (input primitive type) in;</span></span><br><span class="line"><span class="comment">//layout (output primitive type, max_vertices = number) out; (这里的max_//vertices会遇到一个硬件限制所支持的max_vertices的最大值--超出最大值后program //link会出错，通过在program link后调用glGetProgramiv() with GL_INFO_LOG_LENGTH //parameter可以得program link的出错信息，shader compile的log同理)</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>利用传递进来的顶点primitive数据生成新的面向camera的primitive数据</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#version 330                                                                        </span></span><br><span class="line">                                                                                    </span><br><span class="line"><span class="built_in">layout</span>(points) in;                                                                  </span><br><span class="line"><span class="built_in">layout</span>(triangle_strip) out;                                                         </span><br><span class="line"><span class="built_in">layout</span>(max_vertices = <span class="number">4</span>) out;                                                       </span><br><span class="line">                                                                                    </span><br><span class="line">uniform mat4 gVP;                                                                   </span><br><span class="line">uniform vec3 gCameraPos;                                                            </span><br><span class="line">                                                                                    </span><br><span class="line">out vec2 TexCoord;                                                                  </span><br><span class="line">                                                                                    </span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span>                                                                         </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">    <span class="comment">//通过gl_in我们可以在GS中访问传入的primitive的顶点数据，这里因为我们指定了传入的layout(points) in，所以这里只需访问gl_in[0]即可                                        </span></span><br><span class="line">    <span class="comment">//通过计算出面向camera时quad所在的物体坐标系信息，我们在这基础上对顶点数据做偏移，这样算出来的顶点数据生成的primitive始终面向Camera                              </span></span><br><span class="line">    vec3 Pos = gl_in[<span class="number">0</span>].gl_Position.xyz;                                            </span><br><span class="line">    vec3 toCamera = <span class="built_in">normalize</span>(gCameraPos - Pos);                                    </span><br><span class="line">    vec3 up = <span class="built_in">vec3</span>(<span class="number">0.0</span>, <span class="number">1.0</span>, <span class="number">0.0</span>);                                                  </span><br><span class="line">    vec3 right = <span class="built_in">cross</span>(toCamera, up);                                               </span><br><span class="line">                                                                                    </span><br><span class="line">    Pos -= (right * <span class="number">0.5</span>);</span><br><span class="line">    <span class="comment">//这里之所以只传gVP而非gMVP是因为我们在创建顶点数据的时候就是传递的世界坐标信息</span></span><br><span class="line">    gl_Position = gVP * <span class="built_in">vec4</span>(Pos, <span class="number">1.0</span>);                                             </span><br><span class="line">    TexCoord = <span class="built_in">vec2</span>(<span class="number">0.0</span>, <span class="number">0.0</span>);                                                      </span><br><span class="line">    <span class="built_in">EmitVertex</span>();                                                                   </span><br><span class="line">                                                                                    </span><br><span class="line">    Pos.y += <span class="number">1.0</span>;                                                                   </span><br><span class="line">    gl_Position = gVP * <span class="built_in">vec4</span>(Pos, <span class="number">1.0</span>);                                             </span><br><span class="line">    TexCoord = <span class="built_in">vec2</span>(<span class="number">0.0</span>, <span class="number">1.0</span>);                                                      </span><br><span class="line">    <span class="comment">//通过调用EmitVertex指定利用上面的数据生成新的vertex加入到最终的primitive构造中</span></span><br><span class="line">    <span class="built_in">EmitVertex</span>();                                                                   </span><br><span class="line">                                                                                    </span><br><span class="line">    Pos.y -= <span class="number">1.0</span>;                                                                   </span><br><span class="line">    Pos += right;                                                                   </span><br><span class="line">    gl_Position = gVP * <span class="built_in">vec4</span>(Pos, <span class="number">1.0</span>);                                             </span><br><span class="line">    TexCoord = <span class="built_in">vec2</span>(<span class="number">1.0</span>, <span class="number">0.0</span>);                                                      </span><br><span class="line">    <span class="built_in">EmitVertex</span>();                                                                   </span><br><span class="line">                                                                                    </span><br><span class="line">    Pos.y += <span class="number">1.0</span>;                                                                   </span><br><span class="line">    gl_Position = gVP * <span class="built_in">vec4</span>(Pos, <span class="number">1.0</span>);                                             </span><br><span class="line">    TexCoord = <span class="built_in">vec2</span>(<span class="number">1.0</span>, <span class="number">1.0</span>);                                                      </span><br><span class="line">    <span class="built_in">EmitVertex</span>();                                                                   </span><br><span class="line">    <span class="comment">//通过调用EndPrimitive指定前面生成的顶点数据作为一个新的primitive  </span></span><br><span class="line">    <span class="built_in">EndPrimitive</span>();                                                                 </span><br><span class="line">&#125;           </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">BillboardList::CreatePositionBuffer</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;    </span><br><span class="line">    Vector3f Positions[NUM_ROWS * NUM_COLUMNS];</span><br><span class="line">    <span class="comment">//创建顶点数据的时候即传递的世界坐标</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">unsigned</span> <span class="type">int</span> j = <span class="number">0</span> ; j &lt; NUM_ROWS ; j++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">unsigned</span> <span class="type">int</span> i = <span class="number">0</span> ; i &lt; NUM_COLUMNS ; i++) &#123;</span><br><span class="line">            <span class="function">Vector3f <span class="title">Pos</span><span class="params">((<span class="type">float</span>)i, <span class="number">0.0f</span>, (<span class="type">float</span>)j)</span></span>;            </span><br><span class="line">            Positions[j * NUM_COLUMNS + i] = Pos;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<pre><code>EmitVertex() - produces a new vertex at the output of the geometry shader. Each time it is called, a vertex is appended to the end of the current strip (将新的vertex加入到primitive的队列)
EndPrimitive() - breaks the current strip and signals OpenGL that a new strip should be started the next time EmitVertex() is called (将之前所加入的vertex算作一个primitive的信息，通知OpenGL开始下一个primitive的构造)
Note:
When the geometry shader exits, the current primitive is ended implicitly (如果geometry shader结束了，那么当前还没有调用EndPrimitive()的primitive将视作结束)
When EndPrimitive() is called, any incomplete primitives will simply be discarded (当EndPrimitive()被调用的时候，数据不完全的primitive将被抛弃 -- 不调用这个方法的primitive相当于culling掉)
</code></pre>
<ol start="3">
<li>在FS中利用GS中生成的纹理坐标映射纹理信息并Cull掉纹理图片中黑色的部分</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#version 330                                                                        </span></span><br><span class="line">                                                                                    </span><br><span class="line">uniform sampler2D gColorMap;                                                        </span><br><span class="line">                                                                                    </span><br><span class="line">in vec2 TexCoord;                                                                   </span><br><span class="line">out vec4 FragColor;                                                                 </span><br><span class="line">                                                                                    </span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span>                                                                         </span></span><br><span class="line"><span class="function"></span>&#123;                                                                                   </span><br><span class="line">    FragColor = <span class="built_in">texture2D</span>(gColorMap, TexCoord);                                     </span><br><span class="line">    <span class="comment">//Cull掉纹理图片中黑色的部分</span></span><br><span class="line">    <span class="keyword">if</span> (FragColor.r == <span class="number">0</span> &amp;&amp; FragColor.g == <span class="number">0</span> &amp;&amp; FragColor.b == <span class="number">0</span>) &#123;</span><br><span class="line">        discard;                                                                    </span><br><span class="line">    &#125;                                                                               </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Final Effect:<br><img src="/img/OpenGL/GSBillboard.PNG" alt="GSBillboard"></p>
<p>接下来我们看看通过Transform Feedback实现Particle System的步骤：</p>
<ol>
<li>生成Transform Feedback Objets和用于存储数据的buffer,并将buffer绑定到特定Transform Feedback Objects上</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">ParticleSystem::InitParticleSystem</span><span class="params">(<span class="type">const</span> Vector3f&amp; pos)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Particle Particles[MAX_PARTICLES];</span><br><span class="line">	<span class="built_in">ZERO_MEM</span>(Particles);</span><br><span class="line">    <span class="comment">//Particle System最初的那个发射点信息</span></span><br><span class="line">	Particles[<span class="number">0</span>].Type = PARTICLE_TYPE_LAUCHER;</span><br><span class="line">	Particles[<span class="number">0</span>].Pos = pos;</span><br><span class="line">	Particles[<span class="number">0</span>].Vel = <span class="built_in">Vector3f</span>(<span class="number">0.0f</span>, <span class="number">0.0001f</span>, <span class="number">0.0f</span>);</span><br><span class="line">	Particles[<span class="number">0</span>].LifetimeMillis = <span class="number">0.0f</span>;</span><br><span class="line">    <span class="comment">//生成2个transform feedback object和两个buffer</span></span><br><span class="line">    <span class="comment">//&quot;OpenGL enforces a general limitation that the same resource cannot be bound for both input and output in the same draw call. //This means that if we want to update the particles in a vertex buffer we actually need two transform feedback buffers and toggle between them. //On frame 0 we will update the particles in buffer A and render the particles from buffer B and on frame 1 we will update the particles in buffer B and render the particles from buffer &quot;</span></span><br><span class="line">    <span class="comment">//从上面可以看出我们之所以生成两个Transform Feedback Object和两个buffer是因为OpenGL要求我们不能在一次draw call里把同一个resource(这里指TFB和buffer)即作为输入也作为输出</span></span><br><span class="line">    <span class="comment">//所以我们想要通过fist pass去记录一些数据信息，然后再将其渲染到屏幕上，我们必须通过切换两个TFO和buffer来实现</span></span><br><span class="line">    <span class="comment">//记录到A的时候用B数据渲染，记录到B的时候通过A数据来渲染</span></span><br><span class="line">	<span class="built_in">glGenTransformFeedbacks</span>(<span class="number">2</span>, m_TransformFeedback);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">glGenBuffers</span>(<span class="number">2</span>, m_ParticleBuffer);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span>(<span class="type">unsigned</span> <span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">//绑定TFO，使得接下来在TFB上的操作是跟特定TFO(transform feedback object)挂钩的</span></span><br><span class="line">		<span class="built_in">glBindTransformFeedback</span>(GL_TRANSFORM_FEEDBACK, m_TransformFeedback[i]);</span><br><span class="line">		<span class="built_in">glBindBuffer</span>(GL_ARRAY_BUFFER, m_ParticleBuffer[i]);</span><br><span class="line">		<span class="built_in">glBufferData</span>(GL_ARRAY_BUFFER, <span class="built_in">sizeof</span>(Particles), Particles, GL_DYNAMIC_DRAW);</span><br><span class="line">		<span class="comment">//绑定对应buffer的对应的TFO上</span></span><br><span class="line">		<span class="built_in">glBindBufferBase</span>(GL_TRANSFORM_FEEDBACK_BUFFER, <span class="number">0</span>, m_ParticleBuffer[i]);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    .......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>配置Transform Feedback Varyings(指定我们会如何在GS中去如何记录和存储哪些信息)</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">PSUpdateTechnique::Init</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	......</span><br><span class="line"></span><br><span class="line">    <span class="type">const</span> GLchar* Varyings[<span class="number">4</span>];    </span><br><span class="line">    Varyings[<span class="number">0</span>] = <span class="string">&quot;Type1&quot;</span>;</span><br><span class="line">    Varyings[<span class="number">1</span>] = <span class="string">&quot;Position1&quot;</span>;</span><br><span class="line">    Varyings[<span class="number">2</span>] = <span class="string">&quot;Velocity1&quot;</span>;    </span><br><span class="line">    Varyings[<span class="number">3</span>] = <span class="string">&quot;Age1&quot;</span>;</span><br><span class="line">    <span class="comment">//在链接Update Shader之前，我们需要指明TFB会如何去记录和存储数据信息</span></span><br><span class="line">    <span class="comment">//这里指明了我们会在GS中去记录Varyings中四个变量的数据信息到TFB中</span></span><br><span class="line">    <span class="comment">//GL_INTERLEAVED_ATTRIBS表示我们会把所有的attribute数据都记录到一个buffer里   </span></span><br><span class="line">    <span class="built_in">glTransformFeedbackVaryings</span>(m_shaderProg, <span class="number">4</span>, Varyings, GL_INTERLEAVED_ATTRIBS);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">Finalize</span>()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>配置设定一些Update Shader和Billboard Shader的一些数据信息</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">ParticleSystem::InitParticleSystem</span><span class="params">(<span class="type">const</span> Vector3f&amp; pos)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(!m_UpdateTechnique.<span class="built_in">Init</span>())</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">assert</span>(<span class="literal">false</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	m_UpdateTechnique.<span class="built_in">Enable</span>();</span><br><span class="line"></span><br><span class="line">	m_UpdateTechnique.<span class="built_in">SetRandomTextureUnit</span>(RANDOM_TEXTURE_UNIT_INDEX);</span><br><span class="line">	m_UpdateTechnique.<span class="built_in">SetLauncherLifetime</span>(<span class="number">100.0f</span>);</span><br><span class="line">	m_UpdateTechnique.<span class="built_in">SetShellLifetime</span>(<span class="number">10000.0f</span>);</span><br><span class="line">	m_UpdateTechnique.<span class="built_in">SetSecondaryShellLifetime</span>(<span class="number">2500.0f</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(!m_RandomTexture.<span class="built_in">InitRandomTexture</span>(<span class="number">1000</span>))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">assert</span>(<span class="literal">false</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	m_RandomTexture.<span class="built_in">Bind</span>(RANDOM_TEXTURE_UNIT);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(!m_BillboardTechnique.<span class="built_in">Init</span>())</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">assert</span>(<span class="literal">false</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	m_BillboardTechnique.<span class="built_in">Enable</span>();</span><br><span class="line"></span><br><span class="line">	m_BillboardTechnique.<span class="built_in">SetColorTextureUnit</span>(COLOR_TEXTURE_UNIT_INDEX);</span><br><span class="line"></span><br><span class="line">	m_BillboardTechnique.<span class="built_in">SetBillboardSize</span>(<span class="number">0.01f</span>);</span><br><span class="line"></span><br><span class="line">	m_PTexture = <span class="keyword">new</span> <span class="built_in">Texture</span>(GL_TEXTURE_2D, <span class="string">&quot;../Content/fireworks_red.jpg&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(!m_PTexture-&gt;<span class="built_in">Load</span>())</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">assert</span>(<span class="literal">false</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">GLCheckError</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>一次Draw Call，两个Pass，一个Pass去更新TFB里的数据，一个Pass去渲染TFB里的数据</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">RenderPass</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	......</span><br><span class="line">	gParticleSystem.<span class="built_in">Render</span>(deltatimemillis, p.<span class="built_in">GetVPTrans</span>(), pGameCamera-&gt;<span class="built_in">GetPos</span>());</span><br><span class="line">	......</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ParticleSystem::Render</span><span class="params">(<span class="type">int</span> deltatimemillis, <span class="type">const</span> Matrix4f&amp; vp, <span class="type">const</span> Vector3f&amp; camerapos)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	m_Time += deltatimemillis;</span><br><span class="line">	<span class="comment">//因为Shader里会去模拟真实重力和粒子移动效果，所以Update的时候需要delta time</span></span><br><span class="line">	<span class="built_in">UpdateParticles</span>(deltatimemillis);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">RenderParticles</span>(vp, camerapos);</span><br><span class="line">	<span class="comment">//这里就是我们之前说的通过切换两个TFO和buffer来实现一边更新TFB一边渲染TFB的效果</span></span><br><span class="line">	m_CurrVB = m_CurrTFB;</span><br><span class="line">	m_CurrTFB = (m_CurrTFB + <span class="number">1</span>) &amp; <span class="number">0x1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ParticleSystem::UpdateParticles</span><span class="params">(<span class="type">int</span> deltamillis)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	m_UpdateTechnique.<span class="built_in">Enable</span>();</span><br><span class="line">	m_UpdateTechnique.<span class="built_in">SetTime</span>(m_Time);</span><br><span class="line">	m_UpdateTechnique.<span class="built_in">SetDeltaTimeMillis</span>(deltamillis);</span><br><span class="line"></span><br><span class="line">	m_RandomTexture.<span class="built_in">Bind</span>(RANDOM_TEXTURE_UNIT);</span><br><span class="line">    <span class="comment">//这里之所以调用glEnable(GL_RASTERIZER_DISCARD)是因为在Update Pass时，我们不需要进入RS阶段，所以这里关闭了Rasterizer</span></span><br><span class="line">	<span class="built_in">glEnable</span>(GL_RASTERIZER_DISCARD);</span><br><span class="line">    <span class="comment">//Update Pass的时候，我们把m_ParticleBuffer[m_CurrVB]作为数据输入</span></span><br><span class="line">	<span class="built_in">glBindBuffer</span>(GL_ARRAY_BUFFER, m_ParticleBuffer[m_CurrVB]);</span><br><span class="line">	<span class="comment">//通过绑定m_TransformFeedback[m_CurrTFB]到GL_TRANSFORM_FEEDBACK，我们把GS里生成的数据存储到绑定了m_TransformFeedback[m_CurrTFB]的m_ParticleBuffer[m_CurrTFB] buffer里</span></span><br><span class="line">	<span class="comment">//这里就是我们说的A作为输入，B作为输出</span></span><br><span class="line">	<span class="built_in">glBindTransformFeedback</span>(GL_TRANSFORM_FEEDBACK, m_TransformFeedback[m_CurrTFB]);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">glEnableVertexAttribArray</span>(<span class="number">0</span>);</span><br><span class="line">	<span class="built_in">glEnableVertexAttribArray</span>(<span class="number">1</span>);</span><br><span class="line">	<span class="built_in">glEnableVertexAttribArray</span>(<span class="number">2</span>);</span><br><span class="line">	<span class="built_in">glEnableVertexAttribArray</span>(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">glVertexAttribPointer</span>(<span class="number">0</span>, <span class="number">1</span>, GL_FLOAT, GL_FALSE, <span class="built_in">sizeof</span>(Particle), <span class="number">0</span>);                          <span class="comment">// type</span></span><br><span class="line">	<span class="built_in">glVertexAttribPointer</span>(<span class="number">1</span>, <span class="number">3</span>, GL_FLOAT, GL_FALSE, <span class="built_in">sizeof</span>(Particle), (<span class="type">const</span> GLvoid*)<span class="number">4</span>);         <span class="comment">// position</span></span><br><span class="line">	<span class="built_in">glVertexAttribPointer</span>(<span class="number">2</span>, <span class="number">3</span>, GL_FLOAT, GL_FALSE, <span class="built_in">sizeof</span>(Particle), (<span class="type">const</span> GLvoid*)<span class="number">16</span>);        <span class="comment">// velocity</span></span><br><span class="line">	<span class="built_in">glVertexAttribPointer</span>(<span class="number">3</span>, <span class="number">1</span>, GL_FLOAT, GL_FALSE, <span class="built_in">sizeof</span>(Particle), (<span class="type">const</span> GLvoid*)<span class="number">28</span>);          <span class="comment">// lifetime</span></span><br><span class="line">    <span class="comment">//激活Transform Feedback，指明GS输出的primitive type</span></span><br><span class="line">	<span class="built_in">glBeginTransformFeedback</span>(GL_POINTS);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(m_IsFirst)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">//只有第一次我们是知道我们会draw的Point数量（因为particle发射器只有一个）</span></span><br><span class="line">		<span class="built_in">glDrawArrays</span>(GL_POINTS, <span class="number">0</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">		m_IsFirst = <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">//第二次以后，顶点数量是未知的，因为GS是可以生成多个顶点数据的。</span></span><br><span class="line">		<span class="comment">//&quot;The system automatically tracks the number of vertices for us for each buffer and later uses that number internally when the buffer is used for input. &quot;</span></span><br><span class="line">		<span class="comment">//从上面可知，transfor feedback buffer里的顶点数量系统会自己去track</span></span><br><span class="line">		<span class="comment">//我们只需通知用哪一个TFB绑定的buffer作为数据输入即可</span></span><br><span class="line">		<span class="built_in">glDrawTransformFeedback</span>(GL_POINTS, m_TransformFeedback[m_CurrVB]);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">glEndTransformFeedback</span>();</span><br><span class="line"></span><br><span class="line">	<span class="built_in">glDisableVertexAttribArray</span>(<span class="number">0</span>);</span><br><span class="line">	<span class="built_in">glDisableVertexAttribArray</span>(<span class="number">1</span>);</span><br><span class="line">	<span class="built_in">glDisableVertexAttribArray</span>(<span class="number">2</span>);</span><br><span class="line">	<span class="built_in">glDisableVertexAttribArray</span>(<span class="number">3</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ParticleSystem::RenderParticles</span><span class="params">(<span class="type">const</span> Matrix4f&amp; vp, <span class="type">const</span> Vector3f&amp; camerapos)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	m_BillboardTechnique.<span class="built_in">Enable</span>();</span><br><span class="line">	m_BillboardTechnique.<span class="built_in">SetCameraPosition</span>(camerapos);</span><br><span class="line">	m_BillboardTechnique.<span class="built_in">SetVP</span>(vp);</span><br><span class="line">	m_PTexture-&gt;<span class="built_in">Bind</span>(COLOR_TEXTURE_UNIT);</span><br><span class="line">    <span class="comment">//第二Pass的时候，我们需要渲染出图像，所以需要开启Rasterizer</span></span><br><span class="line">	<span class="built_in">glDisable</span>(GL_RASTERIZER_DISCARD);</span><br><span class="line">    <span class="comment">//这里通过使用之前记录到m_ParticleBuffer[m_CurrTFB]的数据作为输入进行渲染</span></span><br><span class="line">	<span class="built_in">glBindBuffer</span>(GL_ARRAY_BUFFER, m_ParticleBuffer[m_CurrTFB]);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">glEnableVertexAttribArray</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">glVertexAttribPointer</span>(<span class="number">0</span>, <span class="number">3</span>, GL_FLOAT, GL_FALSE, <span class="built_in">sizeof</span>(Particle), (<span class="type">const</span> GLvoid*)<span class="number">4</span>);  <span class="comment">// position</span></span><br><span class="line">    <span class="comment">//绘制并渲染m_TransformFeedback[m_CurrTFB]所绑定的m_ParticleBuffer[m_CurrTFB]里的数据</span></span><br><span class="line">	<span class="built_in">glDrawTransformFeedback</span>(GL_POINTS, m_TransformFeedback[m_CurrTFB]);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">glDisableVertexAttribArray</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>接下来就是看Update Shader是如何去更新模拟粒子的生成和重力效果的,billboard Shader是如何将生成的顶点粒子数据渲染到屏幕上的</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br></pre></td><td class="code"><pre><span class="line">ps_update.vs</span><br><span class="line"><span class="meta">#version 330                                                                        </span></span><br><span class="line">                                                                                    </span><br><span class="line"><span class="built_in">layout</span> (location = <span class="number">0</span>) in <span class="type">float</span> Type;                                                </span><br><span class="line"><span class="built_in">layout</span> (location = <span class="number">1</span>) in vec3 Position;                                             </span><br><span class="line"><span class="built_in">layout</span> (location = <span class="number">2</span>) in vec3 Velocity;                                             </span><br><span class="line"><span class="built_in">layout</span> (location = <span class="number">3</span>) in <span class="type">float</span> Age;                                                 </span><br><span class="line">                                                                                    </span><br><span class="line">out <span class="type">float</span> Type0;                                                                    </span><br><span class="line">out vec3 Position0;                                                                 </span><br><span class="line">out vec3 Velocity0;                                                                 </span><br><span class="line">out <span class="type">float</span> Age0;                                                                     </span><br><span class="line"></span><br><span class="line"><span class="comment">//VS里我们只是正常获取传入的顶点相关信息</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span>                                                                         </span></span><br><span class="line"><span class="function"></span>&#123;                                                                                   </span><br><span class="line">    Type0 = Type;                                                                   </span><br><span class="line">    Position0 = Position;                                                           </span><br><span class="line">    Velocity0 = Velocity;                                                           </span><br><span class="line">    Age0 = Age;                                                                     </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ps_update.gs</span><br><span class="line"><span class="meta">#version 330                                                                        </span></span><br><span class="line">                                                                                    </span><br><span class="line"><span class="built_in">layout</span>(points) in;                                                                  </span><br><span class="line"><span class="built_in">layout</span>(points) out;                                                                 </span><br><span class="line"><span class="built_in">layout</span>(max_vertices = <span class="number">30</span>) out;                                                      </span><br><span class="line">                                                                                    </span><br><span class="line">in <span class="type">float</span> Type0[];                                                                   </span><br><span class="line">in vec3 Position0[];                                                                </span><br><span class="line">in vec3 Velocity0[];                                                                </span><br><span class="line">in <span class="type">float</span> Age0[];                                                                    </span><br><span class="line">                                                                                    </span><br><span class="line">out <span class="type">float</span> Type1;                                                                    </span><br><span class="line">out vec3 Position1;                                                                 </span><br><span class="line">out vec3 Velocity1;                                                                 </span><br><span class="line">out <span class="type">float</span> Age1;                                                                     </span><br><span class="line">                                                                                    </span><br><span class="line">uniform <span class="type">float</span> gDeltaTimeMillis;                                                     </span><br><span class="line">uniform <span class="type">float</span> gTime;                                                                </span><br><span class="line">uniform sampler1D gRandomTexture;                                                   </span><br><span class="line">uniform <span class="type">float</span> gLauncherLifetime;                                                    </span><br><span class="line">uniform <span class="type">float</span> gShellLifetime;                                                       </span><br><span class="line">uniform <span class="type">float</span> gSecondaryShellLifetime;                                              </span><br><span class="line">                                                                                    </span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PARTICLE_TYPE_LAUNCHER 0.0f                                                 </span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PARTICLE_TYPE_SHELL 1.0f                                                    </span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PARTICLE_TYPE_SECONDARY_SHELL 2.0f                                          </span></span><br><span class="line">       </span><br><span class="line"><span class="comment">//获取随机方向的方法，我们在gRandomTexture里随机写入了1D的数据信息</span></span><br><span class="line"><span class="function">vec3 <span class="title">GetRandomDir</span><span class="params">(<span class="type">float</span> TexCoord)</span>                                                   </span></span><br><span class="line"><span class="function"></span>&#123;                                                                                   </span><br><span class="line">     vec3 Dir = <span class="built_in">texture</span>(gRandomTexture, TexCoord).xyz;                              </span><br><span class="line">     Dir -= <span class="built_in">vec3</span>(<span class="number">0.5</span>, <span class="number">0.5</span>, <span class="number">0.5</span>);                                                    </span><br><span class="line">     <span class="keyword">return</span> Dir;                                                                    </span><br><span class="line">&#125;                                                                                   </span><br><span class="line">                                                                                    </span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span>                                                                         </span></span><br><span class="line"><span class="function"></span>&#123;                                                                                   </span><br><span class="line">    <span class="type">float</span> Age = Age0[<span class="number">0</span>] + gDeltaTimeMillis;                                         </span><br><span class="line">                                                                                    </span><br><span class="line">    <span class="keyword">if</span> (Type0[<span class="number">0</span>] == PARTICLE_TYPE_LAUNCHER) &#123;</span><br><span class="line">        <span class="comment">//如果粒子发射器life time达到，我们在粒子发射器的位置生成新的粒子（随机方向）                                       </span></span><br><span class="line">        <span class="keyword">if</span> (Age &gt;= gLauncherLifetime) &#123;                                             </span><br><span class="line">            Type1 = PARTICLE_TYPE_SHELL;                                            </span><br><span class="line">            Position1 = Position0[<span class="number">0</span>];                                               </span><br><span class="line">            vec3 Dir = <span class="built_in">GetRandomDir</span>(gTime/<span class="number">1000.0</span>);                                  </span><br><span class="line">            Dir.y = <span class="built_in">max</span>(Dir.y, <span class="number">0.5</span>);                                                </span><br><span class="line">            Velocity1 = <span class="built_in">normalize</span>(Dir) / <span class="number">20.0</span>;                                      </span><br><span class="line">            Age1 = <span class="number">0.0</span>;                                                             </span><br><span class="line">            <span class="built_in">EmitVertex</span>();                                                           </span><br><span class="line">            <span class="built_in">EndPrimitive</span>();                                                         </span><br><span class="line">            Age = <span class="number">0.0</span>;                                                              </span><br><span class="line">        &#125;                                                                           </span><br><span class="line">        <span class="comment">//重置并生成新的粒子发射器使其持续生成粒子</span></span><br><span class="line">        Type1 = PARTICLE_TYPE_LAUNCHER;                                             </span><br><span class="line">        Position1 = Position0[<span class="number">0</span>];                                                   </span><br><span class="line">        Velocity1 = Velocity0[<span class="number">0</span>];                                                   </span><br><span class="line">        Age1 = Age;                                                                 </span><br><span class="line">        <span class="built_in">EmitVertex</span>();                                                               </span><br><span class="line">        <span class="built_in">EndPrimitive</span>();                                                             </span><br><span class="line">    &#125;                                                                               </span><br><span class="line">    <span class="keyword">else</span> &#123;               </span><br><span class="line">        <span class="comment">//当当前粒子不是粒子发射器的时候，我们通过传入的delta time去更新粒子的位置持续时间等相关信息</span></span><br><span class="line">        <span class="type">float</span> DeltaTimeSecs = gDeltaTimeMillis / <span class="number">1000.0f</span>;                           </span><br><span class="line">        <span class="type">float</span> t1 = Age0[<span class="number">0</span>] / <span class="number">1000.0</span>;                                                </span><br><span class="line">        <span class="type">float</span> t2 = Age / <span class="number">1000.0</span>;                                                    </span><br><span class="line">        vec3 DeltaP = DeltaTimeSecs * Velocity0[<span class="number">0</span>];                                 </span><br><span class="line">        vec3 DeltaV = <span class="built_in">vec3</span>(DeltaTimeSecs) * (<span class="number">0.0</span>, <span class="number">-9.81</span>, <span class="number">0.0</span>);                      </span><br><span class="line">        <span class="keyword">if</span> (Type0[<span class="number">0</span>] == PARTICLE_TYPE_SHELL)  &#123;                                     </span><br><span class="line">            <span class="comment">//若当前粒子是第一次粒子发射器发散出的粒子</span></span><br><span class="line">            <span class="comment">//我们通过粒子的持续时间决定是否进入第二次粒子炸裂阶段</span></span><br><span class="line">	        <span class="keyword">if</span> (Age &lt; gShellLifetime) &#123;</span><br><span class="line">	            <span class="comment">//还没达到炸裂时间点，我们仅仅更新该粒子的位置持续时间等相关信息</span></span><br><span class="line">	            Type1 = PARTICLE_TYPE_SHELL;                                        </span><br><span class="line">	            Position1 = Position0[<span class="number">0</span>] + DeltaP;                                  </span><br><span class="line">	            Velocity1 = Velocity0[<span class="number">0</span>] + DeltaV;                                  </span><br><span class="line">	            Age1 = Age;                                                         </span><br><span class="line">	            <span class="built_in">EmitVertex</span>();                                                       </span><br><span class="line">	            <span class="built_in">EndPrimitive</span>();                                                     </span><br><span class="line">	        &#125;                                                                       </span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//当由粒子发射器发散出的粒子达到炸裂时间点的时候，我们通过该粒子所在位置随机生成10个随机方向的粒子</span></span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span> ; i &lt; <span class="number">10</span> ; i++) &#123;                                    </span><br><span class="line">                     Type1 = PARTICLE_TYPE_SECONDARY_SHELL;                         </span><br><span class="line">                     Position1 = Position0[<span class="number">0</span>];                                      </span><br><span class="line">                     vec3 Dir = <span class="built_in">GetRandomDir</span>((gTime + i)/<span class="number">1000.0</span>);                   </span><br><span class="line">                     Velocity1 = <span class="built_in">normalize</span>(Dir) / <span class="number">20.0</span>;                             </span><br><span class="line">                     Age1 = <span class="number">0.0f</span>;                                                   </span><br><span class="line">                     <span class="built_in">EmitVertex</span>();                                                  </span><br><span class="line">                     <span class="built_in">EndPrimitive</span>();                                                </span><br><span class="line">                &#125;                                                                   </span><br><span class="line">            &#125;                                                                       </span><br><span class="line">        &#125;                                                                           </span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//进入到第二次发散阶段的粒子，如果还在生命时间内，我们就更新起位置持续时间等相关信息，否则直接略过该粒子(即粒子消亡)                                </span></span><br><span class="line">            <span class="keyword">if</span> (Age &lt; gSecondaryShellLifetime) &#123;                                    </span><br><span class="line">                Type1 = PARTICLE_TYPE_SECONDARY_SHELL;                              </span><br><span class="line">                Position1 = Position0[<span class="number">0</span>] + DeltaP;                                  </span><br><span class="line">                Velocity1 = Velocity0[<span class="number">0</span>] + DeltaV;                                  </span><br><span class="line">                Age1 = Age;                                                         </span><br><span class="line">                <span class="built_in">EmitVertex</span>();                                                       </span><br><span class="line">                <span class="built_in">EndPrimitive</span>();                                                     </span><br><span class="line">            &#125;                                                                       </span><br><span class="line">        &#125;                                                                           </span><br><span class="line">    &#125;                                                                               </span><br><span class="line">&#125;                                                                                   </span><br><span class="line"></span><br><span class="line">ps_update.fs</span><br><span class="line"><span class="meta">#version 330</span></span><br><span class="line"><span class="comment">//因为Update Shader只负责update粒子信息，不许要渲染，所以这里ps_update.fs为空</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//最终的通过transform feedback生成的粒子信息会通过billboard一一渲染出来</span></span><br><span class="line">billboard.vs</span><br><span class="line"><span class="meta">#version 330                                                                        </span></span><br><span class="line"><span class="comment">//这里只需要粒子的位置信息即可                                                         </span></span><br><span class="line"><span class="built_in">layout</span> (location = <span class="number">0</span>) in vec3 Position;                                             </span><br><span class="line">                                                                                    </span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span>                                                                         </span></span><br><span class="line"><span class="function"></span>&#123;                                                                                   </span><br><span class="line">    gl_Position = <span class="built_in">vec4</span>(Position, <span class="number">1.0</span>);                                              </span><br><span class="line">&#125;       </span><br><span class="line"></span><br><span class="line">billboard.gs</span><br><span class="line"><span class="meta">#version 330                                                                        </span></span><br><span class="line">                                                                                    </span><br><span class="line"><span class="built_in">layout</span>(points) in;                                                                  </span><br><span class="line"><span class="built_in">layout</span>(triangle_strip) out;                                                         </span><br><span class="line"><span class="built_in">layout</span>(max_vertices = <span class="number">4</span>) out;                                                       </span><br><span class="line">                                                                                    </span><br><span class="line">uniform mat4 gVP;                                                                   </span><br><span class="line">uniform vec3 gCameraPos;                                                            </span><br><span class="line">uniform <span class="type">float</span> gBillboardSize;                                                       </span><br><span class="line">                                                                                    </span><br><span class="line">out vec2 TexCoord;                                                                  </span><br><span class="line">                                                                                    </span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span>                                                                         </span></span><br><span class="line"><span class="function"></span>&#123;                                                                                   </span><br><span class="line">    vec3 Pos = gl_in[<span class="number">0</span>].gl_Position.xyz;                                            </span><br><span class="line">    vec3 toCamera = <span class="built_in">normalize</span>(gCameraPos - Pos);                                    </span><br><span class="line">    vec3 up = <span class="built_in">vec3</span>(<span class="number">0.0</span>, <span class="number">1.0</span>, <span class="number">0.0</span>);                                                  </span><br><span class="line">    vec3 right = <span class="built_in">cross</span>(toCamera, up) * gBillboardSize;                              </span><br><span class="line">                                                                                    </span><br><span class="line">    Pos -= right;                                                                   </span><br><span class="line">    gl_Position = gVP * <span class="built_in">vec4</span>(Pos, <span class="number">1.0</span>);                                             </span><br><span class="line">    TexCoord = <span class="built_in">vec2</span>(<span class="number">0.0</span>, <span class="number">0.0</span>);                                                      </span><br><span class="line">    <span class="built_in">EmitVertex</span>();                                                                   </span><br><span class="line">                                                                                    </span><br><span class="line">    Pos.y += gBillboardSize;                                                        </span><br><span class="line">    gl_Position = gVP * <span class="built_in">vec4</span>(Pos, <span class="number">1.0</span>);                                             </span><br><span class="line">    TexCoord = <span class="built_in">vec2</span>(<span class="number">0.0</span>, <span class="number">1.0</span>);                                                      </span><br><span class="line">    <span class="built_in">EmitVertex</span>();                                                                   </span><br><span class="line">                                                                                    </span><br><span class="line">    Pos.y -= gBillboardSize;                                                        </span><br><span class="line">    Pos += right;                                                                   </span><br><span class="line">    gl_Position = gVP * <span class="built_in">vec4</span>(Pos, <span class="number">1.0</span>);                                             </span><br><span class="line">    TexCoord = <span class="built_in">vec2</span>(<span class="number">1.0</span>, <span class="number">0.0</span>);                                                      </span><br><span class="line">    <span class="built_in">EmitVertex</span>();                                                                   </span><br><span class="line">                                                                                    </span><br><span class="line">    Pos.y += gBillboardSize;                                                        </span><br><span class="line">    gl_Position = gVP * <span class="built_in">vec4</span>(Pos, <span class="number">1.0</span>);                                             </span><br><span class="line">    TexCoord = <span class="built_in">vec2</span>(<span class="number">1.0</span>, <span class="number">1.0</span>);                                                      </span><br><span class="line">    <span class="built_in">EmitVertex</span>();                                                                   </span><br><span class="line">                                                                                    </span><br><span class="line">    <span class="built_in">EndPrimitive</span>();                                                                 </span><br><span class="line">&#125;                                                                                   </span><br><span class="line"></span><br><span class="line">billboard.fs</span><br><span class="line"><span class="meta">#version 330                                                                        </span></span><br><span class="line">                                                                                    </span><br><span class="line">uniform sampler2D gColorMap;                                                        </span><br><span class="line">                                                                                    </span><br><span class="line">in vec2 TexCoord;                                                                   </span><br><span class="line">out vec4 FragColor;                                                                 </span><br><span class="line">                                                                                    </span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span>                                                                         </span></span><br><span class="line"><span class="function"></span>&#123;                                                                                   </span><br><span class="line">    FragColor = <span class="built_in">texture2D</span>(gColorMap, TexCoord);                                     </span><br><span class="line">    <span class="comment">//过滤掉粒子纹理图片里较白的部分                                                </span></span><br><span class="line">    <span class="keyword">if</span> (FragColor.r &gt;= <span class="number">0.9</span> &amp;&amp; FragColor.g &gt;= <span class="number">0.9</span> &amp;&amp; FragColor.b &gt;= <span class="number">0.9</span>) &#123;           </span><br><span class="line">        discard;                                                                    </span><br><span class="line">    &#125;                                                                               </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过glDEBugger我们可以查看到Transform Feedback生成的数据信息：<br><img src="/img/OpenGL/TransformFeedbackBufferData.PNG" alt="TransformFeedbackBufferData"></p>
<p>Final Effect:<br><img src="/img/OpenGL/ParticleSystem.PNG" alt="ParticleSystem"></p>
<p>接下来让我们来看看Transform Feedback的更多高级使用：<br><strong>Multiple Output Steams</strong><br>Multiple streams of vertices can be declared as outputs in the geometry shader （通过stream我们可以把一些额外需要保存的信息保存到特定的stream里便于transform feedback buffer去访问并进行进一步的处理）</p>
<p>Using the stream layout qualifier – this layout qualifier may be applied globally, to an interface block, or to a single output declaration</p>
<p>Each stream is numbered, starting from zero, max number of streams – GL_MAX_VERTEX_STREAMS</p>
<p>When the stream number is given at global scope, all subsequently declared geometry shader outputs become members of that stream until another output stream layout qualifier is specified<br>See how to declaration stream:<br><img src="/img/OpenGL/StreamDeclaration.PNG" alt="StreamDeclaration"></p>
<p>Multiple output stream’s built in GLSL functions:<br>EmitStreamVertex(int stream)<br>EndStreamVertex(int stream)</p>
<p>glTransformFeedbackVaryings() – tell OpenGL how those streams are mapped into transform feedback buffer （告诉OpenGL各个stream是怎么映射到transform feedback buffer的）</p>
<p>When multiple streams are active, it is required that variables associated with a single stream are not written into the same buffer binding point as those associated with any other stream(当多个stream声明激活的时候，我们必须将每一个stream写到不同的buffer binding point里)</p>
<p>gl_NextBuffer is used to signal that the following output variables are to be recorded into the buffer object bound to the next transform feedback binding point （gl_NexBuffer告诉OpenGL后面的数据将绑定到下一个transform feedback buffer）</p>
<p>if rasterization  &amp; fragment shader are enabled, the output variables belonging to stream 0 will be used to form primitives for rasterization and will be passed into the fragment shader. Output variables belonging to other streams will not be visible in the fragment shader and if transform feedback is not active, they will be discarded （这里需要注意，一旦rasterization 和 fragment shader被开启或者transform feedback没有被开启，那么geometry shader里面指定的out变量只有属于stream 0的才会被进行处理，其他都会被抛弃）</p>
<p>Note:<br>When multiple output streams are used in a geometry shader, they must all have points as the primitive type （注意，当multiple output streams被开启时，geometry shader必须指定输出类型为point，当first pass的时候geometry shader指定输出类型为point，second pass的时候geometry shader可以针对第一次transform feedback记录的point数据进行处理输出triangle等）</p>
<p><strong>Primitive Queries</strong><br>Reason:<br>Geometry shader can emit a variable number of vertices per invocation （因为geometry shader会扩展出很多primitive和vertices，我们在访问一些跟transform feedback buffer相关的数据的时候就不那么直接 – 这里要提一下没有geometry shader，vertex shader结合transform feeback buffer的使用是一对一的输出，而geometry shader不一样，会有一堆多的primitive，vertices的输出）</p>
<p>Problem:<br>The number of vertices recorded into transform feedback buffers when a geometry shader is present may not be easy to infer</p>
<p>Solution:<br>Two types of queries are available to count both the number of primitives the geometry shader generates, and the number of primitives actually written into the transform feedback buffers（通过Primitive Queries我们可以得知geometry shader的primitives，vertices生成数量和实际被写入transform feedback buffer的primitive，vertices数量）</p>
<p>GL_PRIMITIVES_GENERATED  – query counts the number of vertices output by the geometry shader – valid at any time<br>&amp;<br>GL_TRANSFORM_FEEDBACK_PRIMITIVES_WRITTEN – query counts the number of vertices actually written into a transform feedback buffer – only valid when transform feedback is active</p>
<p>Due to geometry shader supports multiple transform feedback streams, primitive queries are indexed （因为geometry shader支持multiple transform feedback streams，所以primitive queries也是indexed的）</p>
<h3 id="3D-Picking"><a href="#3D-Picking" class="headerlink" title="3D Picking"></a>3D Picking</h3><p>“The ability to match a mouse click on a window showing a 3D scene to the primitive (let’s assume a triangle) who was fortunate enough to be projected to the exact same pixel where the mouse hit is called 3D Picking.”</p>
<p>3D Picking实现的关键在于通过类似Shadow map的方式，把所有的primitive信息写入到一张picking texture里，当mouse点击的时候我们去查询所点击的primitive信息然后把该primitive渲染成我们想要的颜色即可。</p>
<p>实现步骤：<br><strong>First pass(picking pass)</strong> – 利用gDrawIndex, gObjectIndex, Primitive Index生成picking texture</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">PickingTexture::Init</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> WindowWidth, <span class="type">unsigned</span> <span class="type">int</span> WindowHeight)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// Create the FBO</span></span><br><span class="line">    <span class="built_in">glGenFramebuffers</span>(<span class="number">1</span>, &amp;m_fbo);</span><br><span class="line">    <span class="built_in">glBindFramebuffer</span>(GL_FRAMEBUFFER, m_fbo);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Create the texture object for the primitive information buffer</span></span><br><span class="line">    <span class="built_in">glGenTextures</span>(<span class="number">1</span>, &amp;m_pickingTexture);</span><br><span class="line">    <span class="built_in">glBindTexture</span>(GL_TEXTURE_2D, m_pickingTexture);</span><br><span class="line">    <span class="built_in">glTexImage2D</span>(GL_TEXTURE_2D, <span class="number">0</span>, GL_RGB32F, WindowWidth, WindowHeight,</span><br><span class="line">                <span class="number">0</span>, GL_RGB, GL_FLOAT, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="built_in">glFramebufferTexture2D</span>(GL_FRAMEBUFFER, GL_COLOR_ATTACHMENT0, GL_TEXTURE_2D,</span><br><span class="line">                m_pickingTexture, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Create the texture object for the depth buffer</span></span><br><span class="line">    <span class="built_in">glGenTextures</span>(<span class="number">1</span>, &amp;m_depthTexture);</span><br><span class="line">    <span class="built_in">glBindTexture</span>(GL_TEXTURE_2D, m_depthTexture);</span><br><span class="line">    <span class="built_in">glTexImage2D</span>(GL_TEXTURE_2D, <span class="number">0</span>, GL_DEPTH_COMPONENT, WindowWidth, WindowHeight,</span><br><span class="line">                <span class="number">0</span>, GL_DEPTH_COMPONENT, GL_FLOAT, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="built_in">glFramebufferTexture2D</span>(GL_FRAMEBUFFER, GL_DEPTH_ATTACHMENT, GL_TEXTURE_2D,</span><br><span class="line">                m_depthTexture, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Disable reading to avoid problems with older GPUs</span></span><br><span class="line">    <span class="built_in">glReadBuffer</span>(GL_NONE);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">glDrawBuffer</span>(GL_COLOR_ATTACHMENT0);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Verify that the FBO is correct</span></span><br><span class="line">    GLenum Status = <span class="built_in">glCheckFramebufferStatus</span>(GL_FRAMEBUFFER);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (Status != GL_FRAMEBUFFER_COMPLETE) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;FB error, status: 0x%x\n&quot;</span>, Status);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Restore the default framebuffer</span></span><br><span class="line">    <span class="built_in">glBindTexture</span>(GL_TEXTURE_2D, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">glBindFramebuffer</span>(GL_FRAMEBUFFER, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">GLCheckError</span>();</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">PickingTexture::EnableWriting</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">glBindFramebuffer</span>(GL_DRAW_FRAMEBUFFER, m_FBO);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过类似生成Shaow map的方式，我们生成一个FRAMEBUFFER m_fbo，然后通过分别attach m_depthTexture和m_pickingTexture到GL_COLOR_ATTACHMENT0和GL_DEPTH_COMPONENT上，紧接着我们通过指定绘制到m_fbo的GL_COLOR_ATTACHMENT0(即我们attach的那个)上，这样一来当我们渲染到m_fbo的时候，attach到GL_COLOR_ATTACHMENT0的那个color texture就会得到渲染的picking texture，最后在我们我们在渲染之前需要指定m_fbo作为渲染到的FRAMEBUFFER。这样一来我们通过Picking Technique就能得到Picking texture。<br>这里也会生成depth texture，但我们并不会用到，指定生成depth texture的原因如下：<br>“By combining a depth buffer in the process we guarantee that when several primitives are overlapping the same pixel we get the index of the top-most primitive (closest to the camera). “（注意我们需要结合depth buffer来保证我们生成的picking texture保存的primitive信息是离摄像机最近的）</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">picking_technique.cpp</span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;picking_technique.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;ogldev_util.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">......</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">PickingTechnique::SetWVP</span><span class="params">(<span class="type">const</span> Matrix4f&amp; WVP)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">glUniformMatrix4fv</span>(m_WVPLocation, <span class="number">1</span>, GL_TRUE, (<span class="type">const</span> GLfloat*)WVP.m);    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">PickingTechnique::DrawStartCB</span><span class="params">(uint DrawIndex)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">glUniform1ui</span>(m_drawIndexLocation, DrawIndex);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">PickingTechnique::SetObjectIndex</span><span class="params">(uint ObjectIndex)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    GLExitIfError;</span><br><span class="line">    <span class="built_in">glUniform1ui</span>(m_objectIndexLocation, ObjectIndex);</span><br><span class="line"><span class="comment">//    GLExitIfError;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">picking.vs</span><br><span class="line"><span class="meta">#version 330                                                                        </span></span><br><span class="line">                                                                                    </span><br><span class="line"><span class="built_in">layout</span> (location = <span class="number">0</span>) in vec3 Position;                                             </span><br><span class="line">                                                                                    </span><br><span class="line">uniform mat4 gWVP;                                                                  </span><br><span class="line">                                                                                    </span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span>                                                                         </span></span><br><span class="line"><span class="function"></span>&#123;                                                                                   </span><br><span class="line">    gl_Position = gWVP * <span class="built_in">vec4</span>(Position, <span class="number">1.0</span>);                                       </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">picking.fs</span><br><span class="line"><span class="meta">#version 330                                                                        </span></span><br><span class="line">                                                                                                                                                                                                                                                        </span><br><span class="line">uniform uint gDrawIndex;                                                            </span><br><span class="line">uniform uint gObjectIndex;                                                          </span><br><span class="line">                                                                                    </span><br><span class="line">out vec3 FragColor;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span>                                                                         </span></span><br><span class="line"><span class="function"></span>&#123;                                                                                   </span><br><span class="line">   FragColor = <span class="built_in">vec3</span>(<span class="built_in">float</span>(gObjectIndex), <span class="built_in">float</span>(gDrawIndex),<span class="built_in">float</span>(gl_PrimitiveID + <span class="number">1</span>));                 </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>理解上述代码，我们首先需要看看我们存储在picking texture里的信息组成。<br>从picking.fs中可以看出我们存储在piking texture里的颜色信息主要是由gObjectIndex，gDrawIndex，gl_PrimitiveID组成。<br>当我们去渲染spider mesh的时候，我们通过调用void Mesh::Render(IRenderCallbacks* pRenderCallbacks)传入了实现了DrawStartCB回调方法的类传入了shader里gObjectIndex的值。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">Mesh::Render</span><span class="params">(IRenderCallbacks* pRenderCallbacks)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="type">unsigned</span> <span class="type">int</span> i = <span class="number">0</span> ; i &lt; m_Entries.<span class="built_in">size</span>() ; i++) &#123;</span><br><span class="line">        <span class="built_in">glBindBuffer</span>(GL_ARRAY_BUFFER, m_Entries[i].VB);</span><br><span class="line">        .......</span><br><span class="line">        <span class="built_in">glBindBuffer</span>(GL_ELEMENT_ARRAY_BUFFER, m_Entries[i].IB);</span><br><span class="line"></span><br><span class="line">        .......</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (pRenderCallbacks) &#123;</span><br><span class="line">            pRenderCallbacks-&gt;<span class="built_in">DrawStartCB</span>(i);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        GLExitIfError;        </span><br><span class="line">        <span class="built_in">glDrawElements</span>(GL_TRIANGLES, m_Entries[i].NumIndices, GL_UNSIGNED_INT, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里传入的是spider mesh count的索引，即gObjectIndex代表mesh count的索引(这里的spider由19个mesh组成，通过open3mod可以查看到)。<br><img src="/img/OpenGL/SpiderMeshTree.PNG" alt="SpiderMeshTree"><br>接下来当我们渲染两个spider的时候，我们把Object index(即这里spider的数量)作为了gDrawIndex传入了shader。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">PickingPhase</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    .......</span><br><span class="line"></span><br><span class="line">	gPickingTexture.<span class="built_in">EnableWriting</span>();</span><br><span class="line"></span><br><span class="line">	<span class="built_in">glClear</span>(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT);</span><br><span class="line"></span><br><span class="line">	gPickingEffect.<span class="built_in">Enable</span>();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (uint i = <span class="number">0</span> ; i &lt; (<span class="type">int</span>)<span class="built_in">ARRAY_SIZE_IN_ELEMENTS</span>(gWorldPos) ; i++) &#123;</span><br><span class="line">		p.<span class="built_in">WorldPos</span>(gWorldPos[i]);</span><br><span class="line">		gPickingEffect.<span class="built_in">SetObjectIndex</span>(i);</span><br><span class="line">		gPickingEffect.<span class="built_in">SetWVP</span>(p.<span class="built_in">GetWVPTrans</span>());    </span><br><span class="line">		gPSpider-&gt;<span class="built_in">Render</span>(&amp;gPickingEffect);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	gPickingTexture.<span class="built_in">DisableWriting</span>();        </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后gl_PrimitiveID是OpenGL build-in的变量，”This is a running index of the primitives which is automatically maintained by the system.”(代表我们绘制的primitive索引值，每一次draw都会从0开始。)<br>这里就引出了一个问题。我们如何得知我们渲染到picking texture里的primitive值0是指background还是被object遮挡的primitive了。<br>这也就是为什么我们在写入picking texture的时候，gl_PrimitiveID + 1的原因了。这样一来凡是primitive为0的都是background。<br><img src="/img/OpenGL/PickingTexture.PNG" alt="PickingTexture"></p>
<p><strong>Render pass</strong> – 通过映射mouse click的pixel到picking texture，会得到鼠标点击到的gObjectIndex，gDrawIndex，gl_PrimitiveID信息，然后通过这些信息，我们把该点击的primitive通过simple color shader渲染成红色，然后再正常渲染两个spider即可。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">Mesh::Render</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> DrawIndex, <span class="type">unsigned</span> <span class="type">int</span> PrimID)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">assert</span>(DrawIndex &lt; m_Entries.<span class="built_in">size</span>());</span><br><span class="line">    </span><br><span class="line">	......</span><br><span class="line"></span><br><span class="line">    <span class="built_in">glBindBuffer</span>(GL_ARRAY_BUFFER, m_Entries[DrawIndex].VB);</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="built_in">glBindBuffer</span>(GL_ELEMENT_ARRAY_BUFFER, m_Entries[DrawIndex].IB);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">glDrawElements</span>(GL_TRIANGLES, <span class="number">3</span>, GL_UNSIGNED_INT, (<span class="type">const</span> GLvoid*)(PrimID * <span class="number">3</span> * <span class="built_in">sizeof</span>(GLuint)));</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">PickingTexture::PixelInfo <span class="title">PickingTexture::ReadPixel</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> x, <span class="type">unsigned</span> <span class="type">int</span> y)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">glBindFramebuffer</span>(GL_READ_FRAMEBUFFER, m_FBO);</span><br><span class="line">	<span class="built_in">glReadBuffer</span>(GL_COLOR_ATTACHMENT0);</span><br><span class="line">	PixelInfo pixel;</span><br><span class="line">	<span class="built_in">glReadPixels</span>(x, y, <span class="number">1</span>, <span class="number">1</span>, GL_RGB, GL_FLOAT, &amp;pixel);</span><br><span class="line">	<span class="built_in">glReadBuffer</span>(GL_NONE);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">glBindFramebuffer</span>(GL_READ_FRAMEBUFFER, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> pixel;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">RenderPhase</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">glClear</span>(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT);</span><br><span class="line"></span><br><span class="line">    Pipeline p;</span><br><span class="line">    p.<span class="built_in">Scale</span>(<span class="number">0.1f</span>, <span class="number">0.1f</span>, <span class="number">0.1f</span>);</span><br><span class="line">    p.<span class="built_in">SetCamera</span>(m_pGameCamera-&gt;<span class="built_in">GetPos</span>(), m_pGameCamera-&gt;<span class="built_in">GetTarget</span>(), m_pGameCamera-&gt;<span class="built_in">GetUp</span>());</span><br><span class="line">    p.<span class="built_in">SetPerspectiveProj</span>(m_persProjInfo);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If the left mouse button is clicked check if it hit a triangle</span></span><br><span class="line">    <span class="comment">// and color it red</span></span><br><span class="line">    <span class="keyword">if</span> (m_leftMouseButton.IsPressed) &#123;</span><br><span class="line">        PickingTexture::PixelInfo Pixel = m_pickingTexture.<span class="built_in">ReadPixel</span>(m_leftMouseButton.x,</span><br><span class="line">                                                WINDOW_HEIGHT - m_leftMouseButton.y - <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (Pixel.PrimID != <span class="number">0</span>) &#123;</span><br><span class="line">            m_simpleColorEffect.<span class="built_in">Enable</span>();</span><br><span class="line">            p.<span class="built_in">WorldPos</span>(m_worldPos[(uint)Pixel.ObjectID]);</span><br><span class="line">            m_simpleColorEffect.<span class="built_in">SetWVP</span>(p.<span class="built_in">GetWVPTrans</span>());</span><br><span class="line">            <span class="comment">// Must compensate for the decrement in the FS!</span></span><br><span class="line">            m_pMesh-&gt;<span class="built_in">Render</span>((uint)Pixel.DrawID, (uint)Pixel.PrimID - <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// render the objects as usual</span></span><br><span class="line">    m_lightingEffect.<span class="built_in">Enable</span>();</span><br><span class="line">    m_lightingEffect.<span class="built_in">SetEyeWorldPos</span>(m_pGameCamera-&gt;<span class="built_in">GetPos</span>());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">unsigned</span> <span class="type">int</span> i = <span class="number">0</span> ; i &lt; <span class="built_in">ARRAY_SIZE_IN_ELEMENTS</span>(m_worldPos) ; i++) &#123;</span><br><span class="line">        p.<span class="built_in">WorldPos</span>(m_worldPos[i]);</span><br><span class="line">        m_lightingEffect.<span class="built_in">SetWVP</span>(p.<span class="built_in">GetWVPTrans</span>());</span><br><span class="line">        m_lightingEffect.<span class="built_in">SetWorldMatrix</span>(p.<span class="built_in">GetWorldTrans</span>());</span><br><span class="line">        m_pMesh-&gt;<span class="built_in">Render</span>(<span class="literal">NULL</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line">simple_color.vs</span><br><span class="line"><span class="meta">#version 330                                                                        </span></span><br><span class="line">                                                                                    </span><br><span class="line"><span class="built_in">layout</span> (location = <span class="number">0</span>) in vec3 Position;                                             </span><br><span class="line">                                                                                    </span><br><span class="line">uniform mat4 gWVP;                                                                  </span><br><span class="line">                                                                                    </span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span>                                                                         </span></span><br><span class="line"><span class="function"></span>&#123;                                                                                   </span><br><span class="line">    gl_Position = gWVP * <span class="built_in">vec4</span>(Position, <span class="number">1.0</span>);                                       </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">simple_color.fs</span><br><span class="line"><span class="meta">#version 330                                                                        </span></span><br><span class="line">                                                                                    </span><br><span class="line"><span class="built_in">layout</span>(location = <span class="number">0</span>) out vec4 FragColor;                                            </span><br><span class="line">                                                                                    </span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span>                                                                         </span></span><br><span class="line"><span class="function"></span>&#123;                                                                                   </span><br><span class="line">    FragColor = <span class="built_in">vec4</span>(<span class="number">1.0</span>, <span class="number">0.0</span>, <span class="number">0.0</span>, <span class="number">1.0</span>);                                           </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里去读取picking texture里的信息的时候，要注意的一点是，鼠标获取得到的坐标信息和我们去查询texture的坐标系是不一致的，这里需要转换。<br>一下来源于<a target="_blank" rel="noopener" href="https://www.opengl.org/discussion_boards/showthread.php/165951-Glut-Mouse-Coordinates">Glut Mouse Coordinates </a><br>“In “window” coordinate, the origin (0,0) is top left of the viewport.In OpenGL the origin is bottom left of the viewport. When you click glut give you the window coordinate. All you have to do is calculate this: y &#x3D; height_of_viewport - y - 1.</p>
<p>Edit: Notice that you compare a screen coordinate (mouse click) with an object coordinate (your rectangle). This is fine if you use a perspective projection like this glOrtho(0,0,viewport_width,viewport_height). If not you need to call gluProject to map each corner of your rectangle in screen coordinate. “<br>从上面可以看出，glut获取的mouse坐标系是以左上角为(0,0)点。而OpenGL viewport的(0,0)点时左下角，所以我们需要通过下列方式去转换映射点：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PickingTexture::PixelInfo Pixel = m_pickingTexture.<span class="built_in">ReadPixel</span>(m_leftMouseButton.x, WINDOW_HEIGHT - m_leftMouseButton.y - <span class="number">1</span>);</span><br></pre></td></tr></table></figure>
<p>在得到正确的映射值后，我们将查询到的gObjectIndex，gDrawIndex，gl_PrimitiveID当做信息传入void Mesh::Render(unsigned int DrawIndex, unsigned int PrimID)去指定渲染特定mesh的特定primitive成红色。这里要注意的一点是因为mesh里的primitive索引是从0开始的，但我们之前存储的primitive index是+1的，所以这里我们需要恢复原有正确的值去指定渲染正确的primitive。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Must compensate for the decrement in the FS!</span></span><br><span class="line">m_pMesh-&gt;<span class="built_in">Render</span>((uint)Pixel.DrawID, (uint)Pixel.PrimID - <span class="number">1</span>);</span><br></pre></td></tr></table></figure>
<p>这里有一个疑问没有想通，写在这里，如果有人知道答案，希望不腻赐教。第一次把特定primitive渲染成红色后再通过正常渲染渲染两个spider，那么按理，那个特定的primitve会被再次绘制渲染（正常渲染的时候），那么深度信息应该是和前一次一致的，为什么最终却显示的红色而不是模型纹理的颜色了？<br><img src="/img/OpenGL/3DPicking.PNG" alt="3DPicking"></p>
<h3 id="Basic-Tessellation"><a href="#Basic-Tessellation" class="headerlink" title="Basic Tessellation"></a>Basic Tessellation</h3><p>The tessellation process doesn’t operate on OpenGL’s classic geometric primitives: points, lines, and triangles, but uses a new primitive called a patch （Tessellation shader就是针对patch来进行处理的而并非点，线，三角形）</p>
<p>Patch is just an ordered list of vertices (在tessellation shader里面比较重要的概念就是这个patch，patch是一系列的顶点，OpenGL规定patch的vertex数量必须至少大于等于3)。这里的Patch我们可以理解为一个包含了几何图形的所有Control Points(CP)的集合。Control Points会决定这个几何图形最终的形态。</p>
<p>让我们来看看Tessellation Shader在OpenGL Pipeline里的执行顺序（<a target="_blank" rel="noopener" href="http://ogldev.atspace.co.uk/www/tutorial30/tutorial30.html">下图来源</a>）<br><img src="/img/OpenGL/TessellationShaderProcess.PNG" alt="TessellationShaderProcess"></p>
<p>Two Shader Stage, One fixed function:</p>
<ol>
<li><p>Tessellation Control Shader(TCS)<br> “The control shader calculates a set of numbers called Tessellation Levels (TL). The TLs determine the Tessellation level of detail - how many triangles to generate for the patch.”<br>可以看出TCS并不是负责顶点的细分而是负责指定细分的规则(如何细分，细分程度)。</p>
<p> 上述Tessellation Levels(TL)的计算就比较灵活，可以根据摄像机距离也可以根据屏幕最终所在像素多少来决定细分方式。</p>
<p> Note:<br> “It is executed once per CP in the output patch”</p>
</li>
<li><p>Primitive Generator (Fixed function)<br> “OpenGL passes the output of the tessellation control shader to the primitive generator, which generates the mesh of geometric primitives and tessellation coordinates that the tessellation evaluation shader stage uses.”(PG之后会输出domain细分后的顶点和顶点纹理坐标信息，通过顶点纹理信息TES会算出对应的顶点位置信息)</p>
<p> 通过TCS指定的规则去细分。<br> 这里需要理解一个概念 - Domain<br> 细分的规则跟Domain的类型有关<br> 下面我们来看看Quad Domain和Triangle Domain：<br> <img src="/img/OpenGL/Domains.PNG" alt="Domains"></p>
<p> 不同类型的domain – 会决定我们inner和outer的具体含义：<br> Quad Tessellation:<br> ……</p>
<p> Isoline  Tessellation:<br> Use only two of the outer-tessellation levels to determine the amount of subdivision</p>
<p> Triangle Tessellation:<br> Triangular domains use barycentric coordinates to specify their Tessellation coordinates</p>
<p> 从上面可以看出三中不同的Domain有不同的细分规则。<br> 三角形是通过质心去做细分的。<br> 下面来看看三角形细分后的结果：<br> <img src="/img/OpenGL/TriangleDomainSubdivision.PNG" alt="TriangleDomainSubdivision"></p>
</li>
<li><p>Tessellation Evaluation Shader(TES)<br> The TES is executed on all generated domain locations.Positions each of the vertices in the final mesh （TES是针对从tessellation control shader和Primitive Generator通过细分后所有patch相关的顶点来进行运算，通过各顶点的gl_TessCoord(顶点在patch里的相对坐标信息)按不同Domain的纹理坐标计算方式计算出相应的纹理坐标，位置信息和法线信息，从而实现细分多边形和修改顶点信息效果）</p>
<p> 接下来让我们结合事例学习理解：<br> <a target="_blank" rel="noopener" href="http://ogldev.atspace.co.uk/www/tutorial30/tutorial30.html">Basic Tessellation Tutorial</a><br> 该Tutorial实现下列几个功能：</p>
<ol>
<li><p>根据quad.obj模型三角形边与camera的距离去决定LOD的细分程度</p>
</li>
<li><p>通过读取高度图去作为对应顶点的高度信息，且实现通过+-控制高度图的所占比例</p>
</li>
<li><p>可以通过z键开启wireframe模式查看细分情况</p>
<p> 接下来看看主要的实现步骤：</p>
<ol>
<li>加载并设置height map和color map作为高度图和纹理图</li>
</ol>
</li>
</ol>
</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="type">bool</span> <span class="title">InitializeTesselationInfo</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	......</span><br><span class="line">	<span class="comment">//加载height map和color map</span></span><br><span class="line">	gPDisplacementMap = <span class="keyword">new</span> <span class="built_in">Texture</span>(GL_TEXTURE_2D, <span class="string">&quot;../Content/heightmap.jpg&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(!gPDisplacementMap-&gt;<span class="built_in">Load</span>())</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">assert</span>(<span class="literal">false</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	gPDisplacementMap-&gt;<span class="built_in">Bind</span>(DISPLACEMENT_TEXTURE_UNIT);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">glActiveTexture</span>(GL_TEXTURE0);</span><br><span class="line"></span><br><span class="line">	gPColorMap = <span class="keyword">new</span> <span class="built_in">Texture</span>(GL_TEXTURE_2D, <span class="string">&quot;../Content/diffuse.jpg&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(!gPColorMap-&gt;<span class="built_in">Load</span>())</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">assert</span>(<span class="literal">false</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	gPColorMap-&gt;<span class="built_in">Bind</span>(COLOR_TEXTURE_UNIT);</span><br><span class="line"></span><br><span class="line">	......</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">bool</span> <span class="title">InitializeLight</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	......</span><br><span class="line"></span><br><span class="line">	<span class="comment">//设置之前加载的height map和color map作为高度图和纹理图</span></span><br><span class="line">	gLightingTechnique.<span class="built_in">Enable</span>();</span><br><span class="line">	gLightingTechnique.<span class="built_in">SetDirectionalLight</span>(gDirLight);</span><br><span class="line">	gLightingTechnique.<span class="built_in">SetColorTextureUnit</span>(COLOR_TEXTURE_UNIT_INDEX);</span><br><span class="line">	gLightingTechnique.<span class="built_in">SetDisplacementMapTextureUnit</span>(DISPLACEMENT_TEXTURE_UNIT_INDEX);</span><br><span class="line">	gLightingTechnique.<span class="built_in">SetDispFactor</span>(gDisFactor);</span><br><span class="line">	......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<pre><code>	2. 编译连接含TCS和TES的Shader
</code></pre>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">LightingTechnique::Init</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!Technique::<span class="built_in">Init</span>()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">AddShader</span>(GL_VERTEX_SHADER, <span class="string">&quot;lighting.vs&quot;</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">AddShader</span>(GL_TESS_CONTROL_SHADER, <span class="string">&quot;lighting.cs&quot;</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">AddShader</span>(GL_TESS_EVALUATION_SHADER, <span class="string">&quot;lighting.es&quot;</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">AddShader</span>(GL_FRAGMENT_SHADER, <span class="string">&quot;lighting.fs&quot;</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">Finalize</span>()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<pre><code>	3. 以GL_PATCHES方式绘制quad，触发Tessellation Shader
</code></pre>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">Mesh::Render</span><span class="params">(IRenderCallbacks* pRenderCallbacks)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    <span class="comment">//通过设置绘制类型是GL_PATCHES触发Tessellation Shader</span></span><br><span class="line">    <span class="built_in">glDrawElements</span>(GL_PATCHES, m_Entries[i].NumIndices, GL_UNSIGNED_INT, <span class="number">0</span>);</span><br><span class="line">    </span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<pre><code>	4. 延迟VP坐标转换(因为Tessellation Shader会细分出更多的顶点，所以这一步从VS延迟到了TES)
</code></pre>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">lighting.vs</span><br><span class="line"><span class="meta">#version 410 core                                                                                            </span></span><br><span class="line"><span class="built_in">layout</span> (location = <span class="number">0</span>) in vec3 Position_VS_in;                                                   </span><br><span class="line"><span class="built_in">layout</span> (location = <span class="number">1</span>) in vec2 TexCoord_VS_in;                                                   </span><br><span class="line"><span class="built_in">layout</span> (location = <span class="number">2</span>) in vec3 Normal_VS_in;                                                                                                                                      </span><br><span class="line">uniform mat4 gWorld                                                                        </span><br><span class="line">                                                                                                </span><br><span class="line">out vec3 WorldPos_CS_in;                                                                        </span><br><span class="line">out vec2 TexCoord_CS_in;                                                                        </span><br><span class="line">out vec3 Normal_CS_in;                                              </span><br><span class="line">                                                                                                </span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//注意这里我们没有像平时一样对世界坐标系下的顶点信息进行观察坐标系和投影转换</span></span><br><span class="line">	<span class="comment">//因为Tessellation Shader会细分出更多的顶点，所以这一步从VS延迟到了TES</span></span><br><span class="line">    WorldPos_CS_in = (gWorld * <span class="built_in">vec4</span>(Position_VS_in, <span class="number">1.0</span>)).xyz;                                  </span><br><span class="line">    TexCoord_CS_in = TexCoord_VS_in;                                                            </span><br><span class="line">    Normal_CS_in   = (gWorld * <span class="built_in">vec4</span>(Normal_VS_in, <span class="number">0.0</span>)).xyz;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<pre><code>	5. TCS，指定patch顶点数量和细分方式(这里实现了细分程度跟patch各顶点到camera的距离有关)
</code></pre>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">lighting.cs</span><br><span class="line"><span class="meta">#version 410 core                                                </span></span><br><span class="line"><span class="comment">// 指定patch的顶点组成数</span></span><br><span class="line"><span class="comment">// 我们也可以通过在程序里调用glPatchParameteri() -- 告诉程序我们定义多少个顶点为一个patch</span></span><br><span class="line"><span class="built_in">layout</span> (vertices = <span class="number">3</span>) out;                                                                                         </span><br><span class="line">uniform vec3 gEyeWorldPos;  </span><br><span class="line"></span><br><span class="line"><span class="comment">// attributes of the input CPs                                         </span></span><br><span class="line">in vec3 WorldPos_CS_in[];                                                                       </span><br><span class="line">in vec2 TexCoord_CS_in[];                                                                       </span><br><span class="line">in vec3 Normal_CS_in[];                                          </span><br><span class="line">                                                                                                </span><br><span class="line"><span class="comment">// attributes of the output CPs         </span></span><br><span class="line">out vec3 WorldPos_ES_in[];                                                                      </span><br><span class="line">out vec2 TexCoord_ES_in[];                                                                      </span><br><span class="line">out vec3 Normal_ES_in[];                                                                              </span><br><span class="line"><span class="comment">// 根据patch各顶点到camera的距离决定patch的细分程度                                      </span></span><br><span class="line"><span class="function"><span class="type">float</span> <span class="title">GetTessLevel</span><span class="params">(<span class="type">float</span> Distance0, <span class="type">float</span> Distance1)</span></span></span><br><span class="line"><span class="function"></span>&#123;                                                      </span><br><span class="line">    <span class="type">float</span> AvgDistance = (Distance0 + Distance1) / <span class="number">2.0</span>;                                                                                            </span><br><span class="line">    <span class="keyword">if</span> (AvgDistance &lt;= <span class="number">2.0</span>) &#123;                                                                   </span><br><span class="line">        <span class="keyword">return</span> <span class="number">10.0</span>;                                                                            </span><br><span class="line">    &#125;    </span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (AvgDistance &lt;= <span class="number">5.0</span>) &#123;                                                              </span><br><span class="line">        <span class="keyword">return</span> <span class="number">7.0</span>;                                                                             </span><br><span class="line">    &#125;    </span><br><span class="line">    <span class="keyword">else</span> &#123;                                                                                      </span><br><span class="line">        <span class="keyword">return</span> <span class="number">3.0</span>;                                                                             </span><br><span class="line">    &#125;    </span><br><span class="line">&#125;                                                                                               </span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;      </span><br><span class="line">    <span class="comment">// Set the control points of the output patch</span></span><br><span class="line">    <span class="comment">// 记录下patch的control point的原始顶点信息，在TES中会参与就算，算出细分的顶点的位置信息</span></span><br><span class="line">    <span class="comment">// **gl_InvocationID** is used to access the specific vertex of a patch (gl_InvocationID 用于访问传入patch里的特定顶点)</span></span><br><span class="line">    <span class="comment">// 之前我们指定patch的顶点数量是3，TCS是针对patch的顶点来执行的，所以每一个patch会执行3次TCS</span></span><br><span class="line">    TexCoord_ES_in[gl_InvocationID] = TexCoord_CS_in[gl_InvocationID];                          </span><br><span class="line">    Normal_ES_in[gl_InvocationID]   = Normal_CS_in[gl_InvocationID];                            </span><br><span class="line">    WorldPos_ES_in[gl_InvocationID] = WorldPos_CS_in[gl_InvocationID];                          </span><br><span class="line">                                                                                                </span><br><span class="line">    <span class="comment">// Calculate the distance from the camera to the three control points</span></span><br><span class="line">    <span class="comment">// 算出patch各顶点到camera的距离</span></span><br><span class="line">    <span class="type">float</span> EyeToVertexDistance0 = <span class="built_in">distance</span>(gEyeWorldPos, WorldPos_ES_in[<span class="number">0</span>]);                     </span><br><span class="line">    <span class="type">float</span> EyeToVertexDistance1 = <span class="built_in">distance</span>(gEyeWorldPos, WorldPos_ES_in[<span class="number">1</span>]);                     </span><br><span class="line">    <span class="type">float</span> EyeToVertexDistance2 = <span class="built_in">distance</span>(gEyeWorldPos, WorldPos_ES_in[<span class="number">2</span>]);                     </span><br><span class="line">                                                                                                </span><br><span class="line">    <span class="comment">// Calculate the tessellation levels</span></span><br><span class="line">    <span class="comment">// 根据patch各顶点到camera的距离设置细分方式和细分程度</span></span><br><span class="line">    <span class="comment">// **gl_TessLevelInner**</span></span><br><span class="line">    <span class="comment">// Specify how the interior of the domain is subdivided and stored in a two element array named gl_TessLevelInner（指定多边形内部如何细分）</span></span><br><span class="line">    <span class="comment">// **gl_TessLevelOuter**</span></span><br><span class="line">    <span class="comment">// Control how the perimeter of the domain is subdivided, and is stored in an implicitly declared four-element array named gl_TessLevelOuter（指定多边形边界上的边被如何细分）</span></span><br><span class="line">    <span class="comment">// gl_TessLevelInner &amp; gl_TessLevelOuter 根据Domain的类型不同会有不同的含义，参见前面提到的Domain</span></span><br><span class="line">    <span class="comment">// 我们也可以在程序里通过调用glPatchParameterfv()指定inner和outer的数值</span></span><br><span class="line">    gl_TessLevelOuter[<span class="number">0</span>] = <span class="built_in">GetTessLevel</span>(EyeToVertexDistance1, EyeToVertexDistance2);            </span><br><span class="line">    gl_TessLevelOuter[<span class="number">1</span>] = <span class="built_in">GetTessLevel</span>(EyeToVertexDistance2, EyeToVertexDistance0);            </span><br><span class="line">    gl_TessLevelOuter[<span class="number">2</span>] = <span class="built_in">GetTessLevel</span>(EyeToVertexDistance0, EyeToVertexDistance1);            </span><br><span class="line">    gl_TessLevelInner[<span class="number">0</span>] = gl_TessLevelOuter[<span class="number">2</span>];                                                </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<pre><code>	6. TES，利用细分出的所有相关patch顶点的gl_TessCoord(顶点在patch里的相对位置信息)，算出各顶点的纹理坐标信息，位置信息，法线信息(这里通过读取高度图的值参与顶点的高度计算实现动态控制高度值运算)，然后转换所有patch相关的顶点位置信息到投影坐标系
</code></pre>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">lighting.es</span><br><span class="line"><span class="meta">#version 410 core                                                                               </span></span><br><span class="line"><span class="comment">// layout (quads, equal_spacing, ccw) in; （指定新生成的多边形类型等相关信息）</span></span><br><span class="line"><span class="built_in">layout</span>(triangles, equal_spacing, ccw) in;                                                       </span><br><span class="line">                                                                                                </span><br><span class="line">uniform mat4 gVP;                                                                               </span><br><span class="line">uniform sampler2D gDisplacementMap;                                                             </span><br><span class="line">uniform <span class="type">float</span> gDispFactor;                                                                      </span><br><span class="line">                                                                                                </span><br><span class="line">in vec3 WorldPos_ES_in[];                                                                       </span><br><span class="line">in vec2 TexCoord_ES_in[];                                                                       </span><br><span class="line">in vec3 Normal_ES_in[];                                                                         </span><br><span class="line">                                                                                                </span><br><span class="line">out vec3 WorldPos_FS_in;                                                                        </span><br><span class="line">out vec2 TexCoord_FS_in;                                                                        </span><br><span class="line">out vec3 Normal_FS_in;                                                                          </span><br><span class="line">                                                                                                </span><br><span class="line"><span class="function">vec2 <span class="title">interpolate2D</span><span class="params">(vec2 v0, vec2 v1, vec2 v2)</span>                                                   </span></span><br><span class="line"><span class="function"></span>&#123;                                                                                               </span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">vec2</span>(gl_TessCoord.x) * v0 + <span class="built_in">vec2</span>(gl_TessCoord.y) * v1 + <span class="built_in">vec2</span>(gl_TessCoord.z) * v2;   </span><br><span class="line">&#125;                                                                                               </span><br><span class="line">                                                                                                </span><br><span class="line"><span class="function">vec3 <span class="title">interpolate3D</span><span class="params">(vec3 v0, vec3 v1, vec3 v2)</span>                                                   </span></span><br><span class="line"><span class="function"></span>&#123;   </span><br><span class="line">    <span class="comment">// 因为前面我们指定了生成的多边形类型是triangle，所以这里按照triangle domian的计算方式去计算位置信息</span></span><br><span class="line">    <span class="comment">// **gl_TessCoord**包含了当前顶点的在patch里的坐标信息</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">vec3</span>(gl_TessCoord.x) * v0 + <span class="built_in">vec3</span>(gl_TessCoord.y) * v1 + <span class="built_in">vec3</span>(gl_TessCoord.z) * v2;   </span><br><span class="line">&#125;                                                                                               </span><br><span class="line">                                                                                                </span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span>                                                                                     </span></span><br><span class="line"><span class="function"></span>&#123;                                                                                               </span><br><span class="line">    <span class="comment">// Interpolate the attributes of the output vertex using the barycentric coordinates</span></span><br><span class="line">    <span class="comment">// 通过细分后得到的各patch顶点的相对坐标信息gl_TessCoord，用对应Domain的计算方式算出各顶点的位置，法线，纹理信息        </span></span><br><span class="line">    TexCoord_FS_in = <span class="built_in">interpolate2D</span>(TexCoord_ES_in[<span class="number">0</span>], TexCoord_ES_in[<span class="number">1</span>], TexCoord_ES_in[<span class="number">2</span>]);    </span><br><span class="line">    Normal_FS_in = <span class="built_in">interpolate3D</span>(Normal_ES_in[<span class="number">0</span>], Normal_ES_in[<span class="number">1</span>], Normal_ES_in[<span class="number">2</span>]);            </span><br><span class="line">    Normal_FS_in = <span class="built_in">normalize</span>(Normal_FS_in);                                                     </span><br><span class="line">    WorldPos_FS_in = <span class="built_in">interpolate3D</span>(WorldPos_ES_in[<span class="number">0</span>], WorldPos_ES_in[<span class="number">1</span>], WorldPos_ES_in[<span class="number">2</span>]);    </span><br><span class="line">                                                                                                </span><br><span class="line">    <span class="comment">// Displace the vertex along the normal</span></span><br><span class="line">    <span class="comment">// 这里主要是读取之前加载的高度图信息，通过顶点法线方向运算作用于顶点位置信息，实现动态控制顶点高度信息                                  </span></span><br><span class="line">    <span class="type">float</span> Displacement = <span class="built_in">texture</span>(gDisplacementMap, TexCoord_FS_in.xy).x;                        </span><br><span class="line">    WorldPos_FS_in += Normal_FS_in * Displacement * gDispFactor;                                </span><br><span class="line">    <span class="comment">// 最后针对所有的顶点做观察坐标系投影和透视投影，使其正确映射到屏幕位置</span></span><br><span class="line">    gl_Position = gVP * <span class="built_in">vec4</span>(WorldPos_FS_in, <span class="number">1.0</span>);                                              </span><br><span class="line">&#125;                                                                                               </span><br></pre></td></tr></table></figure>

<pre><code>	7. 存储所有细分的顶点位置信息(世界坐标系),顶点法线信息(世界坐标系)和顶点纹理坐标信息参与正常的光照计算得出最后的纹理颜色
</code></pre>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#version 410 core                                                                           </span></span><br><span class="line">                                                                                            </span><br><span class="line"><span class="type">const</span> <span class="type">int</span> MAX_POINT_LIGHTS = <span class="number">2</span>;                                                             </span><br><span class="line"><span class="type">const</span> <span class="type">int</span> MAX_SPOT_LIGHTS = <span class="number">2</span>;                                                              </span><br><span class="line"></span><br><span class="line"><span class="comment">// 这是在TES中存储下来的位于世界坐标系的顶点位置信息和顶点法线信息                          </span></span><br><span class="line">in vec2 TexCoord_FS_in;                                                                     </span><br><span class="line">in vec3 Normal_FS_in;                                                                       </span><br><span class="line">in vec3 WorldPos_FS_in;                                                                     </span><br><span class="line">                                                                                            </span><br><span class="line">out vec4 FragColor;</span><br><span class="line">......                                                                                  </span><br><span class="line">                                                                                            </span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span>                                                                                 </span></span><br><span class="line"><span class="function"></span>&#123;   </span><br><span class="line">    <span class="comment">// 用位于世界坐标系的顶点位置信息和法线信息参与光照运算，得出最后的纹理颜色信息             </span></span><br><span class="line">    vec3 Normal = <span class="built_in">normalize</span>(Normal_FS_in);                                                  </span><br><span class="line">    vec4 TotalLight = <span class="built_in">CalcDirectionalLight</span>(Normal);                                         </span><br><span class="line">                                                                                            </span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span> ; i &lt; gNumPointLights ; i++) &#123;                                           </span><br><span class="line">        TotalLight += <span class="built_in">CalcPointLight</span>(gPointLights[i], Normal);                              </span><br><span class="line">    &#125;                                                                                       </span><br><span class="line">                                                                                            </span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span> ; i &lt; gNumSpotLights ; i++) &#123;                                            </span><br><span class="line">        TotalLight += <span class="built_in">CalcSpotLight</span>(gSpotLights[i], Normal);                                </span><br><span class="line">    &#125;                                                                                       </span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 这里读取的是我们之前加载的color map</span></span><br><span class="line">    FragColor = <span class="built_in">texture</span>(gColorMap, TexCoord_FS_in.xy) * TotalLight;                         </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<pre><code>	8. 相关控制(高度图对顶点位置生成的控制，wireframe控制)
</code></pre>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">KeyboardCB</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> key, <span class="type">int</span> x, <span class="type">int</span> y)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">switch</span>(key)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">case</span> <span class="string">&#x27;q&#x27;</span>:</span><br><span class="line">			<span class="built_in">glutLeaveMainLoop</span>();</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> OGLDEV_KEY_PLUS:</span><br><span class="line">			gDisFactor += <span class="number">0.01f</span>;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">case</span> OGLDEV_KEY_MINUS:</span><br><span class="line">			<span class="keyword">if</span> (gDisFactor &gt;= <span class="number">0.01f</span>) &#123;</span><br><span class="line">				gDisFactor -= <span class="number">0.01f</span>;                    </span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">case</span> <span class="string">&#x27;z&#x27;</span>:</span><br><span class="line">			gIsWireFrame = !gIsWireFrame;</span><br><span class="line">            <span class="comment">// 这里是wireframe的开关控制</span></span><br><span class="line">			<span class="keyword">if</span> (gIsWireFrame) &#123;</span><br><span class="line">				<span class="built_in">glPolygonMode</span>(GL_FRONT, GL_LINE);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="built_in">glPolygonMode</span>(GL_FRONT, GL_FILL);</span><br><span class="line">			&#125;  </span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">RenderPass</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    <span class="comment">// 这里就是我们动态控制高度图对生成顶点的位置信息的影响参数的传递</span></span><br><span class="line">    <span class="comment">// 具体运算参见lighting.es</span></span><br><span class="line">    <span class="comment">// WorldPos_FS_in += Normal_FS_in * Displacement * gDispFactor;   </span></span><br><span class="line">	gLightingTechnique.<span class="built_in">SetDispFactor</span>(gDisFactor);</span><br><span class="line"></span><br><span class="line">	gQuad-&gt;<span class="built_in">Render</span>(<span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Final Effect:<br><img src="/img/OpenGL/TessellationFill.PNG" alt="TessellationFill"><br><img src="/img/OpenGL/TessellationClose.PNG" alt="TessellationClose"><br><img src="/img/OpenGL/TessellationFar.PNG" alt="TessellationFar"><br><img src="/img/OpenGL/TessellationHeightMap.PNG" alt="TessellationHeightMap"></p>
<p>总结：<br>tessellation shader是可选的shader，不是必须的</p>
<p>tessellation shader与vertex shader不一样，tessellation shader是针对patch（一系列顶点）来处理而不是一个顶点 （因为tessellation shader需要通过传入的patch（一系列顶点）来生成新顶点的位置信息）</p>
<p>tessellation control shader负责对patch的细分设定(通过指定细分的计算方式可以实现LOD（level of detail – 根据与camera的距离不同而细分程度不同）等效果)</p>
<p>primitive generator负责对domian的细分</p>
<p>tessellation evaluation shader负责通过PG细分出来的顶点在patch里的坐标信息去计算顶点位置，纹理，法线信息</p>
<p>Bezier曲线在这里是一种细分后位置的计算方法来实现曲面的平滑效果</p>
<p>还有一个应用叫displacement mapping，在tessellation evaluation shader里面通过tessellation coordinate的值来映射纹理（sample a texture）</p>
<p>关于Bezier曲线学习，参考<a target="_blank" rel="noopener" href="http://ogldev.atspace.co.uk/www/tutorial31/tutorial31.html">PN Triangles Tessellation </a></p>
<h3 id="Vertex-Array-Objects"><a href="#Vertex-Array-Objects" class="headerlink" title="Vertex Array Objects"></a>Vertex Array Objects</h3><p>“The Vertex Array Object (a.k.a VAO) is a special type of object that encapsulates all the data that is associated with the vertex processor. Instead of containing the actual data, it holds references to the vertex buffers, the index buffer and the layout specification of the vertex itself.”</p>
<p>“VAOs store all of the links between the attributes and your VBOs with raw vertex data.”</p>
<p>从上面的定义来看，可以看出，Vertex Array Object(VAO) 主要是用于存储关联的顶点buffer索引，顶点buffer定义的数据访问格式等信息而非真正的顶点数据。当我们需要去绘制某个特定的顶点buffer的时候，我们只需要指定好该顶点buffer的数据访问格式和数据内容，然后绑定到特定的VAO，最后激活该VAO并进行会绘制即可。</p>
<p>让我们来看看两种存储数据的格式AOS(Array Of Structure)，SOA(Structure Of Arrays)：<br><img src="/img/OpenGL/AOSAndSOA.PNG" alt="AOSAndSOA"></p>
<p>事例是采取了SOA的形式存储数据。</p>
<ol>
<li>在定义VBO之前，我们需要生成VAO，并绑定到该VAO上（这样一来后续的VBO操作都会绑定到该VAO上被记录下来(比如顶点buffer索引，buffer数据的访问方式等)）</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> INDEX_BUFFER 0</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> POS_VB 1</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NORMAL_VB 2</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TEXCOORD_VB 3 </span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">BasicMesh::LoadMesh</span><span class="params">(<span class="type">const</span> string&amp; Filename)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// Release the previously loaded mesh (if it exists)</span></span><br><span class="line">    <span class="built_in">Clear</span>();</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// Create the VAO</span></span><br><span class="line">    <span class="built_in">glGenVertexArrays</span>(<span class="number">1</span>, &amp;m_VAO);   </span><br><span class="line">    <span class="built_in">glBindVertexArray</span>(m_VAO);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Create the buffers for the vertices attributes</span></span><br><span class="line">    <span class="built_in">glGenBuffers</span>(<span class="built_in">ARRAY_SIZE_IN_ELEMENTS</span>(m_Buffers), m_Buffers);</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Make sure the VAO is not changed from the outside</span></span><br><span class="line">    <span class="built_in">glBindVertexArray</span>(<span class="number">0</span>);	</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<ol start="2">
<li>采取SOA的方式存储顶点相关数据(下面定义了4个vector用于存储Positions,Normals,TexCoords,Indices)，并绑定到Array Buffer，指明访问方式</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">BasicMesh::InitFromScene</span><span class="params">(<span class="type">const</span> aiScene* pScene, <span class="type">const</span> string&amp; Filename)</span></span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">    m_Entries.<span class="built_in">resize</span>(pScene-&gt;mNumMeshes);</span><br><span class="line">    m_Textures.<span class="built_in">resize</span>(pScene-&gt;mNumMaterials);</span><br><span class="line"></span><br><span class="line">    vector&lt;Vector3f&gt; Positions;</span><br><span class="line">    vector&lt;Vector3f&gt; Normals;</span><br><span class="line">    vector&lt;Vector2f&gt; TexCoords;</span><br><span class="line">    vector&lt;<span class="type">unsigned</span> <span class="type">int</span>&gt; Indices;</span><br><span class="line"></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> NumVertices = <span class="number">0</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> NumIndices = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Count the number of vertices and indices</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">unsigned</span> <span class="type">int</span> i = <span class="number">0</span> ; i &lt; m_Entries.<span class="built_in">size</span>() ; i++) &#123;</span><br><span class="line">        m_Entries[i].MaterialIndex = pScene-&gt;mMeshes[i]-&gt;mMaterialIndex;        </span><br><span class="line">        m_Entries[i].NumIndices = pScene-&gt;mMeshes[i]-&gt;mNumFaces * <span class="number">3</span>;</span><br><span class="line">        m_Entries[i].BaseVertex = NumVertices;</span><br><span class="line">        m_Entries[i].BaseIndex = NumIndices;</span><br><span class="line">        </span><br><span class="line">        NumVertices += pScene-&gt;mMeshes[i]-&gt;mNumVertices;</span><br><span class="line">        NumIndices  += m_Entries[i].NumIndices;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Reserve space in the vectors for the vertex attributes and indices</span></span><br><span class="line">    Positions.<span class="built_in">reserve</span>(NumVertices);</span><br><span class="line">    Normals.<span class="built_in">reserve</span>(NumVertices);</span><br><span class="line">    TexCoords.<span class="built_in">reserve</span>(NumVertices);</span><br><span class="line">    Indices.<span class="built_in">reserve</span>(NumIndices);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Initialize the meshes in the scene one by one</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">unsigned</span> <span class="type">int</span> i = <span class="number">0</span> ; i &lt; m_Entries.<span class="built_in">size</span>() ; i++) &#123;</span><br><span class="line">        <span class="type">const</span> aiMesh* paiMesh = pScene-&gt;mMeshes[i];</span><br><span class="line">        <span class="built_in">InitMesh</span>(paiMesh, Positions, Normals, TexCoords, Indices);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">InitMaterials</span>(pScene, Filename)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Generate and populate the buffers with vertex attributes and the indices</span></span><br><span class="line">    <span class="comment">// 下面就是存储成SOA的格式</span></span><br><span class="line">    <span class="built_in">glBindBuffer</span>(GL_ARRAY_BUFFER, m_Buffers[POS_VB]);</span><br><span class="line">    <span class="built_in">glBufferData</span>(GL_ARRAY_BUFFER, <span class="built_in">sizeof</span>(Positions[<span class="number">0</span>]) * Positions.<span class="built_in">size</span>(), &amp;Positions[<span class="number">0</span>], GL_STATIC_DRAW);</span><br><span class="line">    <span class="built_in">glEnableVertexAttribArray</span>(POSITION_LOCATION);</span><br><span class="line">    <span class="built_in">glVertexAttribPointer</span>(POSITION_LOCATION, <span class="number">3</span>, GL_FLOAT, GL_FALSE, <span class="number">0</span>, <span class="number">0</span>);    </span><br><span class="line"></span><br><span class="line">    <span class="built_in">glBindBuffer</span>(GL_ARRAY_BUFFER, m_Buffers[TEXCOORD_VB]);</span><br><span class="line">    <span class="built_in">glBufferData</span>(GL_ARRAY_BUFFER, <span class="built_in">sizeof</span>(TexCoords[<span class="number">0</span>]) * TexCoords.<span class="built_in">size</span>(), &amp;TexCoords[<span class="number">0</span>], GL_STATIC_DRAW);</span><br><span class="line">    <span class="built_in">glEnableVertexAttribArray</span>(TEX_COORD_LOCATION);</span><br><span class="line">    <span class="built_in">glVertexAttribPointer</span>(TEX_COORD_LOCATION, <span class="number">2</span>, GL_FLOAT, GL_FALSE, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">glBindBuffer</span>(GL_ARRAY_BUFFER, m_Buffers[NORMAL_VB]);</span><br><span class="line">    <span class="built_in">glBufferData</span>(GL_ARRAY_BUFFER, <span class="built_in">sizeof</span>(Normals[<span class="number">0</span>]) * Normals.<span class="built_in">size</span>(), &amp;Normals[<span class="number">0</span>], GL_STATIC_DRAW);</span><br><span class="line">    <span class="built_in">glEnableVertexAttribArray</span>(NORMAL_LOCATION);</span><br><span class="line">    <span class="built_in">glVertexAttribPointer</span>(NORMAL_LOCATION, <span class="number">3</span>, GL_FLOAT, GL_FALSE, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">glBindBuffer</span>(GL_ELEMENT_ARRAY_BUFFER, m_Buffers[INDEX_BUFFER]);</span><br><span class="line">    <span class="built_in">glBufferData</span>(GL_ELEMENT_ARRAY_BUFFER, <span class="built_in">sizeof</span>(Indices[<span class="number">0</span>]) * Indices.<span class="built_in">size</span>(), &amp;Indices[<span class="number">0</span>], GL_STATIC_DRAW);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">GLCheckError</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">BasicMesh::InitMesh</span><span class="params">(<span class="type">const</span> aiMesh* paiMesh,</span></span></span><br><span class="line"><span class="params"><span class="function">                    vector&lt;Vector3f&gt;&amp; Positions,</span></span></span><br><span class="line"><span class="params"><span class="function">                    vector&lt;Vector3f&gt;&amp; Normals,</span></span></span><br><span class="line"><span class="params"><span class="function">                    vector&lt;Vector2f&gt;&amp; TexCoords,</span></span></span><br><span class="line"><span class="params"><span class="function">                    vector&lt;<span class="type">unsigned</span> <span class="type">int</span>&gt;&amp; Indices)</span></span></span><br><span class="line"><span class="function"></span>&#123;    </span><br><span class="line">    <span class="function"><span class="type">const</span> aiVector3D <span class="title">Zero3D</span><span class="params">(<span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">0.0f</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Populate the vertex attribute vectors</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">unsigned</span> <span class="type">int</span> i = <span class="number">0</span> ; i &lt; paiMesh-&gt;mNumVertices ; i++) &#123;</span><br><span class="line">        <span class="type">const</span> aiVector3D* pPos      = &amp;(paiMesh-&gt;mVertices[i]);</span><br><span class="line">        <span class="type">const</span> aiVector3D* pNormal   = &amp;(paiMesh-&gt;mNormals[i]);</span><br><span class="line">        <span class="type">const</span> aiVector3D* pTexCoord = paiMesh-&gt;<span class="built_in">HasTextureCoords</span>(<span class="number">0</span>) ? &amp;(paiMesh-&gt;mTextureCoords[<span class="number">0</span>][i]) : &amp;Zero3D;</span><br><span class="line"></span><br><span class="line">        Positions.<span class="built_in">push_back</span>(<span class="built_in">Vector3f</span>(pPos-&gt;x, pPos-&gt;y, pPos-&gt;z));</span><br><span class="line">        Normals.<span class="built_in">push_back</span>(<span class="built_in">Vector3f</span>(pNormal-&gt;x, pNormal-&gt;y, pNormal-&gt;z));</span><br><span class="line">        TexCoords.<span class="built_in">push_back</span>(<span class="built_in">Vector2f</span>(pTexCoord-&gt;x, pTexCoord-&gt;y));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Populate the index buffer</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">unsigned</span> <span class="type">int</span> i = <span class="number">0</span> ; i &lt; paiMesh-&gt;mNumFaces ; i++) &#123;</span><br><span class="line">        <span class="type">const</span> aiFace&amp; Face = paiMesh-&gt;mFaces[i];</span><br><span class="line">        <span class="built_in">assert</span>(Face.mNumIndices == <span class="number">3</span>);</span><br><span class="line">        Indices.<span class="built_in">push_back</span>(Face.mIndices[<span class="number">0</span>]);</span><br><span class="line">        Indices.<span class="built_in">push_back</span>(Face.mIndices[<span class="number">1</span>]);</span><br><span class="line">        Indices.<span class="built_in">push_back</span>(Face.mIndices[<span class="number">2</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>最后绘制的时候，调用glBindVertexArray绑定到特定VAO上，然后调用glDrawElementsBaseVertex指明如何利用VAO绑定的buffer去绘制即可</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">BasicMesh::Render</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">glBindVertexArray</span>(m_VAO);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="type">unsigned</span> <span class="type">int</span> i = <span class="number">0</span> ; i &lt; m_Entries.<span class="built_in">size</span>() ; i++) &#123;</span><br><span class="line">        <span class="type">const</span> <span class="type">unsigned</span> <span class="type">int</span> MaterialIndex = m_Entries[i].MaterialIndex;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">assert</span>(MaterialIndex &lt; m_Textures.<span class="built_in">size</span>());</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (m_Textures[MaterialIndex]) &#123;</span><br><span class="line">            m_Textures[MaterialIndex]-&gt;<span class="built_in">Bind</span>(COLOR_TEXTURE_UNIT);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//这里绘制的参数需要理解一下</span></span><br><span class="line">        <span class="comment">/* </span></span><br><span class="line"><span class="comment">           // Count the number of vertices and indices</span></span><br><span class="line"><span class="comment">           for (unsigned int i = 0 ; i &lt; m_Entries.size() ; i++) &#123;</span></span><br><span class="line"><span class="comment">               m_Entries[i].MaterialIndex = pScene-&gt;mMeshes[i]-&gt;mMaterialIndex;        </span></span><br><span class="line"><span class="comment">               m_Entries[i].NumIndices = pScene-&gt;mMeshes[i]-&gt;mNumFaces * 3;</span></span><br><span class="line"><span class="comment">               m_Entries[i].BaseVertex = NumVertices;</span></span><br><span class="line"><span class="comment">               m_Entries[i].BaseIndex = NumIndices;</span></span><br><span class="line"><span class="comment">        </span></span><br><span class="line"><span class="comment">               NumVertices += pScene-&gt;mMeshes[i]-&gt;mNumVertices;</span></span><br><span class="line"><span class="comment">               NumIndices  += m_Entries[i].NumIndices;</span></span><br><span class="line"><span class="comment">           &#125;</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        <span class="comment">// 因为我们在array buffer里存储数据是采用了SOA的格式，所以在调用glDrawElementsBaseVertex的时候，我们需要指明正确的indices和basevertex索引才能正确绘制</span></span><br><span class="line">        <span class="comment">// 在前面的代码我们m_Entries[i].BaseIndex记录下了到该Entries时所有Indices累加数量，</span></span><br><span class="line">        <span class="comment">// 这里因为Assimp提供的indice索引是从0开始的，但我们存储了所有Entries的indices到index buffer里，</span></span><br><span class="line">        <span class="comment">// 所以我们需要存储的是绘制该Entries时所累加的indices值作为正确索引</span></span><br><span class="line">        <span class="comment">// m_Entries[i].BaseVertex记录下了到该Entries时所有已绘制的顶点累加的数量，</span></span><br><span class="line">        <span class="comment">// 这里同理，为了找到正确的base index，我们需要指明累加后的顶点数量作为offset</span></span><br><span class="line">        <span class="comment">// 调用glDrawElementsBaseVertex绘制每一个Entries时，我们需要指明正确的indices索引才能正确绘制</span></span><br><span class="line">        <span class="built_in">glDrawElementsBaseVertex</span>(GL_TRIANGLES, </span><br><span class="line">                         m_Entries[i].NumIndices, </span><br><span class="line">                         GL_UNSIGNED_INT, </span><br><span class="line">                         (<span class="type">void</span>*)(<span class="built_in">sizeof</span>(<span class="type">unsigned</span> <span class="type">int</span>) * m_Entries[i].BaseIndex), </span><br><span class="line">                         m_Entries[i].BaseVertex);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Make sure the VAO is not changed from the outside    </span></span><br><span class="line">    <span class="built_in">glBindVertexArray</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Final Effect(由于第三个模型数据加载出了问题，这里只加载显示了两个):<br><img src="/img/OpenGL/VAOFinalEffect.PNG" alt="VAOFinalEffect"></p>
<p>更多学习参考<a target="_blank" rel="noopener" href="https://open.gl/drawing">Drawing polygons</a> &amp; <a target="_blank" rel="noopener" href="http://blog.sina.com.cn/s/blog_8c7d49f20102uytr.html">OpenGL-Draw-Call-Code-Study-Analysis</a></p>
<h3 id="Instanced-Rendering"><a href="#Instanced-Rendering" class="headerlink" title="Instanced Rendering"></a>Instanced Rendering</h3><p>“Instanced rendering means that we can render multiple instances in a single draw call and provide each instance with some unique attributes.”(在一次draw call里绘制多个同一个instance)</p>
<p>Using the Instance Counter in Shaders:<br>The index of the current instance is available to the vertex shader in the built-in variable gl_InstanceID. This variable is implicitly declared as an integer. It starts counting from zero and counts up one each time an instance is rendered.</p>
<p>Instancing Redux:<br>Steps:</p>
<ol>
<li>Create some vertex shader inputs that you intend to be instanced</li>
<li>Set the vertex attribute divisors with glVertexAttribDivisor()</li>
<li>Use the gl_InstanceID built-in variable in the vertex shader</li>
<li>Use the instanced versions of the rendering functions such as glDrawArraysInstanced() ……</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> WVP_LOCATION 3</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> WORLD_LOCATION 7</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Mesh::InitFromScene</span><span class="params">(<span class="type">const</span> aiScene* pScene, <span class="type">const</span> string&amp; Filename)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="built_in">glBindBuffer</span>(GL_ARRAY_BUFFER, m_Buffers[WVP_MAT_VB]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">unsigned</span> <span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span> ; i++) &#123;</span><br><span class="line">        <span class="built_in">glEnableVertexAttribArray</span>(WVP_LOCATION + i);</span><br><span class="line">        <span class="comment">// Note: &quot;A vertex attribute can contain no more than 4 floating points or integers.&quot;</span></span><br><span class="line">        <span class="comment">// 因为vertex attribute不能超过4个float或integers，所以我们需要针对mat4每一行进行指定访问方式</span></span><br><span class="line">        <span class="built_in">glVertexAttribPointer</span>(WVP_LOCATION + i, <span class="number">4</span>, GL_FLOAT, GL_FALSE, <span class="built_in">sizeof</span>(Matrix4f),</span><br><span class="line">                                (<span class="type">const</span> GLvoid*)(<span class="built_in">sizeof</span>(GLfloat) * i * <span class="number">4</span>));</span><br><span class="line">        <span class="comment">// 这里是&quot;makes this an instance data rather than vertex data.&quot;</span></span><br><span class="line">        <span class="comment">// 第一个参数指明特定attribute是instance data而非vertex data,</span></span><br><span class="line">        <span class="comment">// 第二个参数指明instance data的使用频率，比如1表示每一个instance渲染后就访问下一个atrribute值，2表示每两个</span></span><br><span class="line">        <span class="built_in">glVertexAttribDivisor</span>(WVP_LOCATION + i, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">glBindBuffer</span>(GL_ARRAY_BUFFER, m_Buffers[WORLD_MAT_VB]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">unsigned</span> <span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span> ; i++) &#123;</span><br><span class="line">        <span class="built_in">glEnableVertexAttribArray</span>(WORLD_LOCATION + i);</span><br><span class="line">        <span class="built_in">glVertexAttribPointer</span>(WORLD_LOCATION + i, <span class="number">4</span>, GL_FLOAT, GL_FALSE, <span class="built_in">sizeof</span>(Matrix4f),</span><br><span class="line">                                (<span class="type">const</span> GLvoid*)(<span class="built_in">sizeof</span>(GLfloat) * i * <span class="number">4</span>));</span><br><span class="line">        <span class="built_in">glVertexAttribDivisor</span>(WORLD_LOCATION + i, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">GLCheckError</span>();</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Mesh::Render</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> NumInstances, <span class="type">const</span> Matrix4f* WVPMats, <span class="type">const</span> Matrix4f* WorldMats)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// 传递instance data的动态数据</span></span><br><span class="line">    <span class="built_in">glBindBuffer</span>(GL_ARRAY_BUFFER, m_Buffers[WVP_MAT_VB]);</span><br><span class="line">    <span class="built_in">glBufferData</span>(GL_ARRAY_BUFFER, <span class="built_in">sizeof</span>(Matrix4f) * NumInstances, WVPMats, GL_DYNAMIC_DRAW);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">glBindBuffer</span>(GL_ARRAY_BUFFER, m_Buffers[WORLD_MAT_VB]);</span><br><span class="line">    <span class="built_in">glBufferData</span>(GL_ARRAY_BUFFER, <span class="built_in">sizeof</span>(Matrix4f) * NumInstances, WorldMats, GL_DYNAMIC_DRAW);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">glBindVertexArray</span>(m_VAO);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">unsigned</span> <span class="type">int</span> i = <span class="number">0</span> ; i &lt; m_Entries.<span class="built_in">size</span>() ; i++) &#123;</span><br><span class="line">        <span class="type">const</span> <span class="type">unsigned</span> <span class="type">int</span> MaterialIndex = m_Entries[i].MaterialIndex;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">assert</span>(MaterialIndex &lt; m_Textures.<span class="built_in">size</span>());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (m_Textures[MaterialIndex]) &#123;</span><br><span class="line">            m_Textures[MaterialIndex]-&gt;<span class="built_in">Bind</span>(GL_TEXTURE0);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 调用glDrawElementsInstanceBaseVertex来渲染多个instance</span></span><br><span class="line">        <span class="built_in">glDrawElementsInstancedBaseVertex</span>(GL_TRIANGLES,</span><br><span class="line">                                         m_Entries[i].NumIndices,</span><br><span class="line">                                         GL_UNSIGNED_INT,</span><br><span class="line">                                         (<span class="type">void</span>*)(<span class="built_in">sizeof</span>(<span class="type">unsigned</span> <span class="type">int</span>) * m_Entries[i].BaseIndex),</span><br><span class="line">                                         NumInstances,</span><br><span class="line">                                         m_Entries[i].BaseVertex);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Make sure the VAO is not changed from the outside</span></span><br><span class="line">    <span class="built_in">glBindVertexArray</span>(<span class="number">0</span>);</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">RenderSceneCB</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;   </span><br><span class="line">        .......    </span><br><span class="line"></span><br><span class="line">        Matrix4f WVPMatrics[NUM_INSTANCES];</span><br><span class="line">        Matrix4f WorldMatrices[NUM_INSTANCES];</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (<span class="type">unsigned</span> <span class="type">int</span> i = <span class="number">0</span> ; i &lt; NUM_INSTANCES ; i++) &#123;</span><br><span class="line">            <span class="function">Vector3f <span class="title">Pos</span><span class="params">(m_positions[i])</span></span>;</span><br><span class="line">            Pos.y += <span class="built_in">sinf</span>(m_scale) * m_velocity[i];</span><br><span class="line">            p.<span class="built_in">WorldPos</span>(Pos);</span><br><span class="line">            <span class="comment">// 这里需要注意，这里之所以要转置之后再传递的原因如下：</span></span><br><span class="line">            <span class="comment">// 在Shader里定义mat4时，OpenGL传递mat4时会以去构造列向量为主的mat4</span></span><br><span class="line">            <span class="comment">// 即把传递的mat4的行作为列去构造mat4</span></span><br><span class="line">            <span class="comment">// 因为我们这里定义的mat4本来就是基于OpenGL的列向量构造的，</span></span><br><span class="line">            <span class="comment">// 所以在传递过去的时候为了保证正确，我们需要先进行转置      </span></span><br><span class="line">            <span class="comment">// 如果我们的mat4本来就是基于DX的列向量，那么就不需要转置</span></span><br><span class="line">            WVPMatrics[i] = p.<span class="built_in">GetWVPTrans</span>().<span class="built_in">Transpose</span>();</span><br><span class="line">            WorldMatrices[i] = p.<span class="built_in">GetWorldTrans</span>().<span class="built_in">Transpose</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        m_pMesh-&gt;<span class="built_in">Render</span>(NUM_INSTANCES, WVPMatrics, WorldMatrices);</span><br><span class="line">        </span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">lighting.vs</span><br><span class="line"><span class="meta">#version 330                                                                        </span></span><br><span class="line">                                                                                    </span><br><span class="line"><span class="built_in">layout</span> (location = <span class="number">0</span>) in vec3 Position;                                             </span><br><span class="line"><span class="built_in">layout</span> (location = <span class="number">1</span>) in vec2 TexCoord;                                             </span><br><span class="line"><span class="built_in">layout</span> (location = <span class="number">2</span>) in vec3 Normal;</span><br><span class="line"><span class="comment">// 这里注意因为vertex attribute不能超过4个float或integers，我们前面指定了每一个mat4四次vertex attribute</span></span><br><span class="line"><span class="comment">// 所以这里WVP location = 3 而 World location = 7</span></span><br><span class="line"><span class="built_in">layout</span> (location = <span class="number">3</span>) in mat4 WVP;                                                  </span><br><span class="line"><span class="built_in">layout</span> (location = <span class="number">7</span>) in mat4 World;                                                </span><br><span class="line">                                                                                    </span><br><span class="line">out vec2 TexCoord0;                                                                 </span><br><span class="line">out vec3 Normal0;                                                                   </span><br><span class="line">out vec3 WorldPos0;</span><br><span class="line"><span class="comment">// &quot;Since integers cannot be interpolated by the rasterizer we have to mark the output variable as &#x27;flat&#x27; (forgetting to do that will trigger a compiler error).&quot;</span></span><br><span class="line"><span class="comment">// 因为integers不能被rasterizer interpolated，所以我们需要使用&#x27;flat&#x27;关键词避免编译错误</span></span><br><span class="line">flat out <span class="type">int</span> InstanceID;                                                            </span><br><span class="line">                                                                                    </span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span>                                                                         </span></span><br><span class="line"><span class="function"></span>&#123;                                                                                   </span><br><span class="line">    gl_Position = WVP * <span class="built_in">vec4</span>(Position, <span class="number">1.0</span>);                                        </span><br><span class="line">    TexCoord0   = TexCoord;                                                         </span><br><span class="line">    Normal0     = (World * <span class="built_in">vec4</span>(Normal, <span class="number">0.0</span>)).xyz;                                  </span><br><span class="line">    WorldPos0   = (World * <span class="built_in">vec4</span>(Position, <span class="number">1.0</span>)).xyz;                                </span><br><span class="line">    InstanceID = gl_InstanceID;                                                     </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Final Effect:<br><img src="/img/OpenGL/InstancedRendering.PNG" alt="InstancedRendering"></p>
<p>Note:<br>gl_InstanceID is always present in the vertex shader, even when the current drawing command is not one of the instanced ones.</p>
<h3 id="GLFX-An-OpenGL-Effect-Library"><a href="#GLFX-An-OpenGL-Effect-Library" class="headerlink" title="GLFX - An OpenGL Effect Library"></a>GLFX - An OpenGL Effect Library</h3><p>首先让我们了解一下，什么是Effect file？<br>“An effect is a text file that can potentially contain multiple shaders and functions and makes it easy to combine them together into programs. This overcomes the limitation of the glShaderSource() function that requires you to specify the text of a single shader stage.”<br>可以看出，通过effect file，我们可以把所有shader写到一个文件里，不用再创建针对各个stage的shader的文件。这样一来我们在shader里定义的结构体就能在多个shader共用。</p>
<p>那什么是GLFX了？<br>“Effects system for OpenGL and OpenGL ES”<br>GLFX提供了方便的接口去转换effect file到GLSL program.</p>
<p><a target="_blank" rel="noopener" href="https://github.com/maizensh/glfx">GLFX源码下载地址</a></p>
<p>接下来让我们看看，如何使用GLFX支持effect file。</p>
<ol>
<li>编译生成并添加glfx.lib到引用</li>
<li>包含glfx.h头文件</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;glfx.h&gt;</span></span></span><br></pre></td></tr></table></figure>
<ol start="3">
<li>解析effect file</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!<span class="built_in">glfxParseEffectFromFile</span>(effect, <span class="string">&quot;effect.glsl&quot;</span>)) &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __cplusplus <span class="comment">// C++ error handling</span></span></span><br><span class="line">    std::string log = <span class="built_in">glfxGetEffectLog</span>(effect);</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Error parsing effect: &quot;</span> &lt;&lt; log &lt;&lt; std::endl;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span> <span class="comment">// C error handling</span></span></span><br><span class="line">    <span class="type">char</span> log[<span class="number">10000</span>];</span><br><span class="line">    <span class="built_in">glfxGetEffectLog</span>(effect, log, <span class="built_in">sizeof</span>(log));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Error parsing effect: %s:\n&quot;</span>, log);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<ol start="4">
<li>编译并启用Effect program</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> shaderProg = <span class="built_in">glfxCompileProgram</span>(effect, <span class="string">&quot;ProgramName&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (shaderProg &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// same error handling as above</span></span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="built_in">glUseProgram</span>(shaderProg); </span><br></pre></td></tr></table></figure>
<ol start="5">
<li>Release effect file after we no longer use it</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">glfxDeleteEffect</span>(effect); </span><br></pre></td></tr></table></figure>

<p>接下来看看编写Effect file有哪些不同于GLSL Shader的地方</p>
<ol>
<li>使用’program’ key word去定义一个program，并在其中包含各Shader的调用路口</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">program Lighting</span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">//VSmain() 和 FSmain()分别定义了vs和fs的人口函数</span></span><br><span class="line">    <span class="built_in">vs</span>(<span class="number">410</span>)=<span class="built_in">VSmain</span>();</span><br><span class="line">    <span class="built_in">fs</span>(<span class="number">410</span>)=<span class="built_in">FSmain</span>();</span><br><span class="line">&#125;; </span><br></pre></td></tr></table></figure>
<ol start="2">
<li>使用’shader’ key word去定义各shader stage的函数入口而非void</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">shader <span class="title">VSmain</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">calculate_something</span>();</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<ol start="3">
<li>可以定义多个program在Effect file中，只需通过glfxCompileProgram()去指定编译特定program即可</li>
<li>因为所有shader内容都写在一个文件里了，所以支持共用struct定义，不用再定义一个个in or out variables</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">VSoutput</span></span><br><span class="line">&#123;</span><br><span class="line">    vec2 TexCoord;</span><br><span class="line">    vec3 Normal;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function">shader <span class="title">VSmain</span><span class="params">(in vec3 Pos, in vec2 TexCoord, in vec3 Normal, out VSOutput VSout)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// do some transformations and update &#x27;VSout&#x27;</span></span><br><span class="line">    VSout.TexCoord = TexCoord;</span><br><span class="line">    VSout.Normal = Normal;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">shader <span class="title">FSmain</span><span class="params">(in VSOutput FSin, out vec4 FragColor)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// &#x27;FSin&#x27; matches &#x27;VSout&#x27; from the VS. Use it</span></span><br><span class="line">    <span class="comment">// to do lighting calculations and write the final output to &#x27;FragColor&#x27;</span></span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<ol start="5">
<li>可以在Effect file里直接包含其他Effect file(但新包含的文件并不参与GLFX Parse，并且该文件是以直接插入的形式，所以该文件只能包含pure GLSL不能包含GLFX里的一些定义方式)</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;another_effect.glsl&quot;</span> </span></span><br></pre></td></tr></table></figure>
<ol start="6">
<li>通过:后缀，快速定义attribute的位置而不是通过一个个layout(location&#x3D;……)</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">VSInput2</span></span><br><span class="line">&#123;</span><br><span class="line">    vec3 Normal;</span><br><span class="line">    vec3 Tangent;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function">shader <span class="title">VSmain</span><span class="params">(in vec3 Pos : <span class="number">5</span>, in vec2 TexCoord : <span class="number">6</span>, in <span class="type">float</span> colorScale : <span class="number">10</span>)</span></span></span><br></pre></td></tr></table></figure>
<ol start="7">
<li>一些关键词如’flat’，‘noperspective’修饰的变量不能放在Effect file定义的struct里，只能通过interface去定义，而interface又必须通过再次拷贝内容到struct才能在Effect里使用</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">be passed between shader stages. If you need to pass it as a whole to another function you will need to copy the contents to a <span class="keyword">struct</span>. For example:</span><br><span class="line">interface foo</span><br><span class="line">&#123;</span><br><span class="line">    flat <span class="type">int</span> a;</span><br><span class="line">    noperspective <span class="type">float</span> b;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">bar</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> a;</span><br><span class="line">    <span class="type">float</span> b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">shader <span class="title">VSmain</span><span class="params">(out foo f)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Calc</span><span class="params">(bar c)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">shader <span class="title">FSmain</span><span class="params">(in foo f)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">bar</span> c;</span><br><span class="line">    c.a = f.a;</span><br><span class="line">    c.b = f.b;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">Calc</span>(c);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="8">
<li>glfxc工具，可以用于外部单独解析编译Effect file，提前查看是否有问题(这个本人没有试，因为我没有编译出glfxc。)<br>glfxc <effect file name> <program name></li>
</ol>
<p>Final Effect:<br><img src="/img/OpenGL/GLFX.PNG" alt="GLFX"></p>
<p>Note:<br>“GLFX is dependant on GLEW(注意GLFX是依赖于GLEW的，编译GLFX的时候会需要指定GLEW的路径)”</p>
<h3 id="Deferred-Shading"><a href="#Deferred-Shading" class="headerlink" title="Deferred Shading"></a>Deferred Shading</h3><p>在了解什么是Deferred Shading之前，我们需要了解与之对应的Forward Rendering。<br>What is forward rendering?<br>Forward Rendering就是我们之前一直采用的，给GPU传入geometry，texture数据，然后每一个vertex通过pipeline(VS,GS,FS……)得出最后的render target显示在screen上。<br><a target="_blank" rel="noopener" href="http://gamedevelopment.tutsplus.com/articles/forward-rendering-vs-deferred-rendering--gamedev-12342">下图来源</a><br><img src="/img/OpenGL/ForwardRendering.PNG" alt="ForwardRendering"></p>
<p>既然有了Forward Rendering，为什么我们还需要Deferred Shading了？</p>
<ol>
<li><p><a target="_blank" rel="noopener" href="http://ogldev.atspace.co.uk/www/tutorial35/tutorial35.html">Since each pixel of every object gets only a single FS invocation we have to provide the FS with information on all light sources and take all of them into account when calculating the light effect per pixel. This is a simple approach but it has its downsides. If the scene is highly complex (as is the case in most modern games) with many objects and a large depth complexity (same screen pixel covered by several objects) we get a lot of wasted GPU cycles. </a>(第一个问题大量无用的光照计算。简单的说就是传统的Forward Rendering是针对每一个传入的顶点都会经历一套完整的Pipeline(包含参与光照计算)。但在大型游戏里，会有很多物体(顶点数据)，但最终只有离camera最近或者透明的一部分物体会显示在屏幕上，这样一来，针对每一个顶点都计算光照就会做很多无用功。)</p>
</li>
<li><p><a target="_blank" rel="noopener" href="http://ogldev.atspace.co.uk/www/tutorial35/tutorial35.html">When there are many light sources, forward rendering simply doesn’t scale well with many light sources.</a>(因为Forward Redenring每一个pixel都会参与光照计算，当场景里光照很多的时候，无论光源对物体的影响有多微弱或多强，Forward Rendering都会一一计算这些光照对物体的影响，这样会导致大量的光照计算。)</p>
</li>
</ol>
<p>而Deferred Shading却没有上述问题。<br>那么让我们来了解一下什么是Deferred Shading<br><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Deferred_shading">deferred shading is a screen-space shading technique. It is called deferred because no shading is actually performed in the first pass of the vertex and pixel shaders: instead shading is “deferred” until a second pass.</a><br><a target="_blank" rel="noopener" href="http://gamedevelopment.tutsplus.com/articles/forward-rendering-vs-deferred-rendering--gamedev-12342">下图来源</a><br><img src="/img/OpenGL/DeferredShading.PNG" alt="DeferredShading"></p>
<p>从上面我们只能看出，Deferred Shading是针对scree-space而非每一个物体的vertex。并且deferred shading是由两个pass构成，第二个pass才是真正的shading。<br>接下来让我们看看这两个pass：</p>
<ol>
<li>Geometry Pass. <a target="_blank" rel="noopener" href="http://ogldev.atspace.co.uk/www/tutorial35/tutorial35.html">Data that is required for shading computation is gathered. Positions, normals, and materials for each surface are rendered into the geometry buffer (G-buffer) using “render to texture.(Multiple Render Targets (MRT)</a>(在第一个pass我们并不像Forward Rendering把所有光照计算相关的数据传入FS而是存入geometry buffer(G-buffer)用于第二个pass进行真正的Shading。因为我们存储在G-buffer里的数据都是经过rasterizer的，所以在G-buffer里我们只存储了通过depth test的pixel，这样一来我们在第二次用G-buffer数据计算光照的时候就避免了无谓的光照计算(这里指没通过depth test的pixel))<br>让我们来看看G-buffer都存储些什么数据，<a target="_blank" rel="noopener" href="http://ogldev.atspace.co.uk/www/tutorial35/tutorial35.html">下图来源</a><br><img src="/img/OpenGL/G-Buffer.PNG" alt="G-Buffer"><br>可以看出，我们存储了所有参与光照计算所需要的数据。<br>Geometry Pass的主要目的是生成4个关于Position，Diffuse，Normal，TexCoord的纹理贴图和一个关于Depth的纹理贴图。<br>Geometry Pass主要由以下几个步骤：<ol>
<li>创建m_FBO</li>
</ol>
</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">GBuffer::Init</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> windowwidth, <span class="type">unsigned</span> <span class="type">int</span> windowheight)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//Create the FBO</span></span><br><span class="line">	<span class="built_in">glGenFramebuffers</span>(<span class="number">1</span>, &amp;m_FBO);</span><br><span class="line">	<span class="built_in">glBindFramebuffer</span>(GL_FRAMEBUFFER, m_FBO);</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre><code>2. 创建4个纹理贴图分别Attach到m_FBO的GL_COLOR_ATTACHMENT*上。单独创建1个纹理贴图Attach到m_FBO的GL_DEPTH_ATTACHMENT上
</code></pre>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">GBuffer::Init</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> windowwidth, <span class="type">unsigned</span> <span class="type">int</span> windowheight)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//Create the FBO</span></span><br><span class="line">    ......</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//Create the gbuffer textures</span></span><br><span class="line">	<span class="built_in">glGenTextures</span>(<span class="built_in">ARRAY_SIZE_IN_ELEMENTS</span>(m_Textures), m_Textures);</span><br><span class="line">	<span class="built_in">glGenTextures</span>(<span class="number">1</span>, &amp;m_DepthTexture);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span>(<span class="type">unsigned</span> <span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="built_in">ARRAY_SIZE_IN_ELEMENTS</span>(m_Textures); i++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">glBindTexture</span>(GL_TEXTURE_2D, m_Textures[i]);</span><br><span class="line">		<span class="built_in">glTexImage2D</span>(GL_TEXTURE_2D, <span class="number">0</span>, GL_RGB32F, windowwidth, windowheight, <span class="number">0</span>, GL_RGB, GL_FLOAT, <span class="number">0</span>);</span><br><span class="line">		<span class="built_in">glFramebufferTexture2D</span>(GL_DRAW_FRAMEBUFFER, GL_COLOR_ATTACHMENT0 + i, GL_TEXTURE_2D, m_Textures[i], <span class="number">0</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//depth texture</span></span><br><span class="line">	<span class="built_in">glBindTexture</span>(GL_TEXTURE_2D, m_DepthTexture);</span><br><span class="line">	<span class="built_in">glTexImage2D</span>(GL_TEXTURE_2D, <span class="number">0</span>, GL_DEPTH_COMPONENT32, windowwidth, windowheight, <span class="number">0</span>, GL_DEPTH_COMPONENT, GL_FLOAT, <span class="literal">NULL</span>);</span><br><span class="line">	<span class="built_in">glFramebufferTexture2D</span>(GL_DRAW_FRAMEBUFFER, GL_DEPTH_ATTACHMENT, GL_TEXTURE_2D, m_DepthTexture, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">	GLenum drawbuffers[] = &#123; GL_COLOR_ATTACHMENT0,</span><br><span class="line">							 GL_COLOR_ATTACHMENT1,</span><br><span class="line">							 GL_COLOR_ATTACHMENT2,</span><br><span class="line">							 GL_COLOR_ATTACHMENT3&#125;;</span><br><span class="line"></span><br><span class="line">    .......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre><code>3. 指定需要从FS中输出的Position，Diffuse，Normal，TexCoord绘制的color buffer
</code></pre>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">GBuffer::Init</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> windowwidth, <span class="type">unsigned</span> <span class="type">int</span> windowheight)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	......</span><br><span class="line"></span><br><span class="line">	<span class="comment">// specify the color buffer to be drawn into, we will output buffer data for each color buffer in FS with out key word variable</span></span><br><span class="line">	<span class="comment">// 这里应对的是FS里指定的out输出</span></span><br><span class="line">	<span class="built_in">glDrawBuffers</span>(<span class="built_in">ARRAY_SIZE_IN_ELEMENTS</span>(drawbuffers), drawbuffers);</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">geometry_pass.vs</span><br><span class="line"><span class="comment">// VS没什么变化，只是把我们需要保存的Position，TexCoord，Normal分别转换透视投影坐标系和世界坐标系里</span></span><br><span class="line"><span class="meta">#version 330                                                                        </span></span><br><span class="line">                                                                                    </span><br><span class="line"><span class="built_in">layout</span> (location = <span class="number">0</span>) in vec3 Position;                                             </span><br><span class="line"><span class="built_in">layout</span> (location = <span class="number">1</span>) in vec2 TexCoord;                                             </span><br><span class="line"><span class="built_in">layout</span> (location = <span class="number">2</span>) in vec3 Normal;                                               </span><br><span class="line"></span><br><span class="line">uniform mat4 gWVP;</span><br><span class="line">uniform mat4 gWorld;</span><br><span class="line">                                        </span><br><span class="line">out vec2 TexCoord0;                                                                 </span><br><span class="line">out vec3 Normal0;                                                                   </span><br><span class="line">out vec3 WorldPos0;                                                                 </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;       </span><br><span class="line">    gl_Position    = gWVP * <span class="built_in">vec4</span>(Position, <span class="number">1.0</span>);</span><br><span class="line">    TexCoord0      = TexCoord;                  </span><br><span class="line">    Normal0        = (gWorld * <span class="built_in">vec4</span>(Normal, <span class="number">0.0</span>)).xyz;   </span><br><span class="line">    WorldPos0      = (gWorld * <span class="built_in">vec4</span>(Position, <span class="number">1.0</span>)).xyz;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">geometry_pass.fs</span><br><span class="line"><span class="comment">// FS负责把转换后的Position，Diffuse，Normal，TexCoordOut输出到我们之前绑定的GL_COLOR_ATTACHMENT*上</span></span><br><span class="line"><span class="meta">#version 330</span></span><br><span class="line">                                                                        </span><br><span class="line">in vec2 TexCoord0;                                                                  </span><br><span class="line">in vec3 Normal0;                                                                    </span><br><span class="line">in vec3 WorldPos0;                                                                  </span><br><span class="line"></span><br><span class="line"><span class="built_in">layout</span> (location = <span class="number">0</span>) out vec3 WorldPosOut;   </span><br><span class="line"><span class="built_in">layout</span> (location = <span class="number">1</span>) out vec3 DiffuseOut;     </span><br><span class="line"><span class="built_in">layout</span> (location = <span class="number">2</span>) out vec3 NormalOut;     </span><br><span class="line"><span class="built_in">layout</span> (location = <span class="number">3</span>) out vec3 TexCoordOut;    </span><br><span class="line">										</span><br><span class="line">uniform sampler2D gColorMap;                </span><br><span class="line">											</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span>									</span></span><br><span class="line"><span class="function"></span>&#123;											</span><br><span class="line">	WorldPosOut     = WorldPos0;					</span><br><span class="line">	DiffuseOut      = <span class="built_in">texture</span>(gColorMap, TexCoord0).xyz;	</span><br><span class="line">	NormalOut       = <span class="built_in">normalize</span>(Normal0);					</span><br><span class="line">	TexCoordOut     = <span class="built_in">vec3</span>(TexCoord0, <span class="number">0.0</span>);				</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre><code>4. 调用Geometry Pass生成对应的纹理贴图信息
</code></pre>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">DSGeometryPass</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	gDSGeomPassTech.<span class="built_in">Enable</span>();</span><br><span class="line">    <span class="comment">// 输出到Color Texture里之前，</span></span><br><span class="line">    <span class="comment">// 我们需要指定我们需要绘制到的FrameBuffer是我们Color Texture所绑定的m_FBO</span></span><br><span class="line">	gGbuffer.<span class="built_in">BindForWriting</span>();</span><br><span class="line"></span><br><span class="line">	<span class="built_in">glClear</span>(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT);</span><br><span class="line"></span><br><span class="line">	Pipeline p;</span><br><span class="line">	p.<span class="built_in">Scale</span>(<span class="number">0.1f</span>, <span class="number">0.1f</span>, <span class="number">0.1f</span>);</span><br><span class="line">	p.<span class="built_in">Rotate</span>(<span class="number">0.0f</span>, gScale, <span class="number">0.0f</span>);</span><br><span class="line">	p.<span class="built_in">WorldPos</span>(<span class="number">-0.8f</span>, <span class="number">-1.0f</span>, <span class="number">12.0f</span>);</span><br><span class="line">	p.<span class="built_in">SetCamera</span>(pGameCamera-&gt;<span class="built_in">GetPos</span>(), pGameCamera-&gt;<span class="built_in">GetTarget</span>(), pGameCamera-&gt;<span class="built_in">GetUp</span>());</span><br><span class="line">	p.<span class="built_in">SetPerspectiveProj</span>(gPersProjInfo);</span><br><span class="line"></span><br><span class="line">	gDSGeomPassTech.<span class="built_in">SetWVP</span>(p.<span class="built_in">GetWVPTrans</span>());</span><br><span class="line">	gDSGeomPassTech.<span class="built_in">SetWorldMatrix</span>(p.<span class="built_in">GetWorldTrans</span>());</span><br><span class="line"></span><br><span class="line">	gMesh.<span class="built_in">Render</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre><code>5. 将生成的4个Color Texture复制到FrameBuffer 0里，然后渲染到屏幕上
</code></pre>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">DSLightPass</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// Bound frame buffer target 0 to draw state, we will copy four color buffer to this buffer later</span></span><br><span class="line">	<span class="comment">// 因为glBlitFramebuffer()函数是把GL_READ_FRAMEBUFFER的target copy到GL_DRAW_FRAMEBUFFER的target上，</span></span><br><span class="line">	<span class="comment">// 所以我们要声明Frame buffer 0作为我们最终的目的地</span></span><br><span class="line">	<span class="built_in">glBindFramebuffer</span>(GL_DRAW_FRAMEBUFFER, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">glClear</span>(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Bound frame buffer m_FBO to reading state,</span></span><br><span class="line">	<span class="comment">// we will copy four color buffer that attach to m_FBO to frame buffer target 0 later</span></span><br><span class="line">	<span class="comment">// BindForReading()就是设置m_FBO作为glBlitFramebuffer()里的copy来源，</span></span><br><span class="line">	<span class="comment">// 所以需要设置成GL_READ_FRAMEBUFFER</span></span><br><span class="line">	gGbuffer.<span class="built_in">BindForReading</span>();</span><br><span class="line"></span><br><span class="line">	GLint halfwidth = (GLint)(WINDOW_WIDTH / <span class="number">2.0f</span>);</span><br><span class="line">	GLint halfheight = (GLint)(WINDOW_HEIGHT / <span class="number">2.0f</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Color buffer for position</span></span><br><span class="line">	<span class="comment">// Set color buffer source for copying</span></span><br><span class="line">	<span class="comment">// 因为一次只能从一个texture里copy，所以我们需要指定是copy哪一个</span></span><br><span class="line">	gGbuffer.<span class="built_in">SetReadBuffer</span>(GBuffer::GBUFFER_TEXTURE_TYPE_POSITION);</span><br><span class="line">	<span class="comment">// Set buffer copy info</span></span><br><span class="line">	<span class="built_in">glBlitFramebuffer</span>(<span class="number">0</span>, <span class="number">0</span>, WINDOW_WIDTH, WINDOW_HEIGHT, <span class="number">0</span>, <span class="number">0</span>, halfwidth, halfheight, GL_COLOR_BUFFER_BIT, GL_LINEAR);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Color buffer for diffuses</span></span><br><span class="line">	gGbuffer.<span class="built_in">SetReadBuffer</span>(GBuffer::GBUFFER_TEXTURE_TYPE_DIFFUSE);</span><br><span class="line">	<span class="built_in">glBlitFramebuffer</span>(<span class="number">0</span>, <span class="number">0</span>, WINDOW_WIDTH, WINDOW_HEIGHT, <span class="number">0</span>,halfheight, halfwidth, WINDOW_HEIGHT, GL_COLOR_BUFFER_BIT, GL_LINEAR);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Color buffer for normal</span></span><br><span class="line">	gGbuffer.<span class="built_in">SetReadBuffer</span>(GBuffer::GBUFFER_TEXTURE_TYPE_NORMAL);</span><br><span class="line">	<span class="built_in">glBlitFramebuffer</span>(<span class="number">0</span>, <span class="number">0</span>, WINDOW_WIDTH, WINDOW_HEIGHT, halfwidth,halfheight, WINDOW_WIDTH, WINDOW_HEIGHT, GL_COLOR_BUFFER_BIT, GL_LINEAR);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Color buffer for TexCoor</span></span><br><span class="line">	gGbuffer.<span class="built_in">SetReadBuffer</span>(GBuffer::GBUFFER_TEXTURE_TYPE_TEXCOORD);</span><br><span class="line">	<span class="built_in">glBlitFramebuffer</span>(<span class="number">0</span>, <span class="number">0</span>, WINDOW_WIDTH, WINDOW_HEIGHT, halfwidth,<span class="number">0</span>, WINDOW_WIDTH, halfheight, GL_COLOR_BUFFER_BIT, GL_LINEAR);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre><code>	Final Effect:
</code></pre>
<p><img src="/img/OpenGL/DeferredShading_GeometryPass.PNG" alt="DeferredShading_GeometryPass"><br>		在真正的Deferred Shading中，有几个需要注意的点。<br>		第一个点，我们不需要讲生成的四个Color Texture显示在屏幕上，所以最后一步是可以省去的。<br>		第二个点因为Geometry Pass只需要存储closest pixel，所以我们需要开启GL_DEPTH_TEST，并且设置glDepthMask(GL_TRUE)来防止其他pass写入我们的fbo的depth buffer。<br>		最终geometry pass代码如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">DSGeometryPass</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    m_DSGeomPassTech.<span class="built_in">Enable</span>();</span><br><span class="line"></span><br><span class="line">    m_gbuffer.<span class="built_in">BindForWriting</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Only the geometry pass updates the depth buffer</span></span><br><span class="line">    <span class="built_in">glDepthMask</span>(GL_TRUE);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">glClear</span>(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">glEnable</span>(GL_DEPTH_TEST);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">glDisable</span>(GL_BLEND);</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="comment">// When we get here the depth buffer is already populated and the stencil pass</span></span><br><span class="line">    <span class="comment">// depends on it, but it does not write to it.</span></span><br><span class="line">    <span class="built_in">glDepthMask</span>(GL_FALSE);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">glDisable</span>(GL_DEPTH_TEST);</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<pre><code>	第三个点，因为Lighting Pass里参与计算的的TexCoordnate信息可以通过下列算式计算出来，所以出于节约内存，我们可以不必生成TexCoordnate的Texture(即只需要Position，Diffuse，Normal和Depth（这个后续会用到）四个贴图)。
</code></pre>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">vec2 <span class="title">CalcTexCoord</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   <span class="keyword">return</span> gl_FragCoord.xy / gScreenSize;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<pre><code>	第四个点，因为我们生成的Texture最终会用于Screen的1对1映射计算，所以我们需要把我们生成的Texture指定filter。
</code></pre>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">GBuffer::Init</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> WindowWidth, <span class="type">unsigned</span> <span class="type">int</span> WindowHeight)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">unsigned</span> <span class="type">int</span> i = <span class="number">0</span> ; i &lt; <span class="built_in">ARRAY_SIZE_IN_ELEMENTS</span>(m_textures) ; i++) &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="built_in">glTexParameterf</span>(GL_TEXTURE_2D, GL_TEXTURE_MIN_FILTER, GL_NEAREST);</span><br><span class="line">        <span class="built_in">glTexParameterf</span>(GL_TEXTURE_2D, GL_TEXTURE_MAG_FILTER, GL_NEAREST);</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<ol start="2">
<li>Lighting Pass. <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Deferred_shading">A pixel shader computes the direct and indirect lighting at each pixel using the information of the texture buffers in screen space.</a><br>在第二个Lighting Pass里我们只需要用我们在Geometry Pass存储的数据来进行pixel by pixel的光照计算即可，因为我们存储的texture是针对screen space的，所有存储的pixel都是通过了depth test的，所以在Deferred Shading里，我们只针对通过了depth test的pixel进行了光照计算。<br>下面我们来看看如何通过已经存储的Position，Diffuse，Normal，Depth信息来得出最终的光照颜色。首先让我们看看整体的轮廓。</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">RenderCallbackCB</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	pGameCamera-&gt;<span class="built_in">OnRender</span>();</span><br><span class="line"></span><br><span class="line">	gScale += <span class="number">0.05f</span>;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">DSGeometryPass</span>();</span><br><span class="line"></span><br><span class="line">	<span class="built_in">BeginLightPasses</span>();</span><br><span class="line"></span><br><span class="line">	<span class="built_in">DSPointLightPass</span>();</span><br><span class="line"></span><br><span class="line">	<span class="built_in">DSDirectionalLightPass</span>();</span><br><span class="line"></span><br><span class="line">	<span class="comment">//Swap buffer</span></span><br><span class="line">	<span class="built_in">glutSwapBuffers</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre><code>1. 开启混合模式，因为Deferred Shading现在是每一个pixel都会针对所有相关的光照进行计算，最终的结果将有所有光照计算叠加而成。(因为我们不需要再从我们生成的fbo读取数据了(直接从生成的texture里去读)，所以不需要再绑定到生成的fbo上，而是绑定到默认的fbo上，这样一来我们只需设置并绑定我们对应的Texture即可)
</code></pre>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">GBuffer::BindForReading</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">glBindFramebuffer</span>(GL_DRAW_FRAMEBUFFER, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (<span class="type">unsigned</span> <span class="type">int</span> i = <span class="number">0</span> ; i &lt; <span class="built_in">ARRAY_SIZE_IN_ELEMENTS</span>(m_textures); i++) &#123;</span><br><span class="line">		<span class="built_in">glActiveTexture</span>(GL_TEXTURE0 + i);		</span><br><span class="line">		<span class="built_in">glBindTexture</span>(GL_TEXTURE_2D, m_textures[GBUFFER_TEXTURE_TYPE_POSITION + i]);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">BeginLightPasses</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">glEnable</span>(GL_BLEND);</span><br><span class="line">    <span class="built_in">glBlendEquation</span>(GL_FUNC_ADD);</span><br><span class="line">    <span class="built_in">glBlendFunc</span>(GL_ONE, GL_ONE);</span><br><span class="line"></span><br><span class="line">    m_gbuffer.<span class="built_in">BindForReading</span>();</span><br><span class="line">    <span class="built_in">glClear</span>(GL_COLOR_BUFFER_BIT);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre><code>2. 每一个Pixel针对场景里的Point， Direction， Spot Light进行计算得出最终颜色。这里要针对每一种光照进行说明，如何触发正确的计算。
</code></pre>
<p>Direction Light因为是全局光，所以我们需要针对每一个Pixel进行计算，这里我们通过一个铺满屏幕的Quad Mesh来触发计算。<br>Direction Light:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">light_pass.vs</span><br><span class="line"><span class="meta">#version 330                                                                        </span></span><br><span class="line"></span><br><span class="line"><span class="built_in">layout</span> (location = <span class="number">0</span>) in vec3 Position; </span><br><span class="line"></span><br><span class="line">uniform mat4 gWVP;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;          </span><br><span class="line">    gl_Position = gWVP * <span class="built_in">vec4</span>(Position, <span class="number">1.0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">dir_light_pass.fs</span><br><span class="line"><span class="comment">// 这个和之前大部分一样，唯一的区别就是从对应的Texture读取需要参与计算的信息</span></span><br><span class="line">......</span><br><span class="line"></span><br><span class="line"><span class="function">vec2 <span class="title">CalcTexCoord</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> gl_FragCoord.xy / gScreenSize;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">out vec4 FragColor;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    vec2 TexCoord = <span class="built_in">CalcTexCoord</span>();</span><br><span class="line">	vec3 WorldPos = <span class="built_in">texture</span>(gPositionMap, TexCoord).xyz;</span><br><span class="line">	vec3 Color = <span class="built_in">texture</span>(gColorMap, TexCoord).xyz;</span><br><span class="line">	vec3 Normal = <span class="built_in">texture</span>(gNormalMap, TexCoord).xyz;</span><br><span class="line">	Normal = <span class="built_in">normalize</span>(Normal);</span><br><span class="line"></span><br><span class="line">	FragColor = <span class="built_in">vec4</span>(Color, <span class="number">1.0</span>) * <span class="built_in">CalcDirectionalLight</span>(WorldPos, Normal);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DSDirectionalLightPass</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    m_DSDirLightPassTech.<span class="built_in">Enable</span>();</span><br><span class="line">    m_DSDirLightPassTech.<span class="built_in">SetEyeWorldPos</span>(m_pGameCamera-&gt;<span class="built_in">GetPos</span>());</span><br><span class="line">    Matrix4f WVP;</span><br><span class="line">    <span class="comment">// 这里我们使用的quad是(-1,1)to(1,1)，通过设置WVP为单位矩阵，这样一来经过rasterizer后，</span></span><br><span class="line">    <span class="comment">// (-1,-1)to(1,1)就会被映射到(0,0)to(SCREEN_WIDTH,SCREEN_HEIGHT)即铺满全屏</span></span><br><span class="line">    <span class="comment">// 其他都和之前Dir Light计算一样，只是这里有多少个Dir Light就要针对每个Pixel计算多少次</span></span><br><span class="line">    WVP.<span class="built_in">InitIdentity</span>();</span><br><span class="line">    m_DSDirLightPassTech.<span class="built_in">SetWVP</span>(WVP);</span><br><span class="line">    m_quad.<span class="built_in">Render</span>();</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<p>Point Light因为是范围光，所以我们需要知道Point Light所影响的范围去触发对应Pixel的光照计算。这里涉及到一个Point Light的<a target="_blank" rel="noopener" href="http://ogldev.atspace.co.uk/www/tutorial36/tutorial36.html">Point Light光照削弱方程</a>。这里我也没详细看了，想了解的可以去看一下。通过方程我们得出了Point Light的有效范围，这样一来我们只需要以Point Light所在位置为圆心绘制一个Sphere就能触发正确的Point Light光照计算了。<br>Point Light:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Shader没什么变化，只是通过Texture去读取相关数据，这里就不重复了。</span></span><br><span class="line">......</span><br><span class="line"></span><br><span class="line"><span class="comment">// 光照削弱计算</span></span><br><span class="line"><span class="function"><span class="type">float</span> <span class="title">CalcPointLightBSphere</span><span class="params">(<span class="type">const</span> PointLight&amp; Light)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">float</span> MaxChannel = <span class="built_in">fmax</span>(<span class="built_in">fmax</span>(Light.Color.x, Light.Color.y), Light.Color.z);</span><br><span class="line"></span><br><span class="line">    <span class="type">float</span> ret = (-Light.Attenuation.Linear + <span class="built_in">sqrtf</span>(Light.Attenuation.Linear * Light.Attenuation.Linear -</span><br><span class="line">        <span class="number">4</span> * Light.Attenuation.Exp * (Light.Attenuation.Exp - <span class="number">256</span> * MaxChannel * Light.DiffuseIntensity)))</span><br><span class="line">            /</span><br><span class="line">        (<span class="number">2</span> * Light.Attenuation.Exp);</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DSPointLightsPass</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    m_DSPointLightPassTech.<span class="built_in">Enable</span>();</span><br><span class="line">    m_DSPointLightPassTech.<span class="built_in">SetEyeWorldPos</span>(m_pGameCamera-&gt;<span class="built_in">GetPos</span>());</span><br><span class="line"></span><br><span class="line">    Pipeline p;</span><br><span class="line">    p.<span class="built_in">SetCamera</span>(m_pGameCamera-&gt;<span class="built_in">GetPos</span>(), m_pGameCamera-&gt;<span class="built_in">GetTarget</span>(), m_pGameCamera-&gt;<span class="built_in">GetUp</span>());</span><br><span class="line">    p.<span class="built_in">SetPerspectiveProj</span>(m_persProjInfo);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 这里也一样，有多少个Point Light就要触发多少次光照运算</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">unsigned</span> <span class="type">int</span> i = <span class="number">0</span> ; i &lt; <span class="built_in">ARRAY_SIZE_IN_ELEMENTS</span>(m_pointLight); i++) &#123;</span><br><span class="line">        m_DSPointLightPassTech.<span class="built_in">SetPointLight</span>(m_pointLight[i]);</span><br><span class="line">        p.<span class="built_in">WorldPos</span>(m_pointLight[i].Position);</span><br><span class="line">        <span class="comment">// 绘制指定半径大小的Sphere触发光照计算</span></span><br><span class="line">        <span class="type">float</span> BSphereScale = <span class="built_in">CalcPointLightBSphere</span>(m_pointLight[i]);</span><br><span class="line">        p.<span class="built_in">Scale</span>(BSphereScale, BSphereScale, BSphereScale);</span><br><span class="line">        m_DSPointLightPassTech.<span class="built_in">SetWVP</span>(p.<span class="built_in">GetWVPTrans</span>());</span><br><span class="line">        m_bsphere.<span class="built_in">Render</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<p>实现的过程中我遇到点问题，所以也没有去实现Spot Light，个人认为应该是通过cone(圆锥体)去模拟Spot Light的范围，通过光照削弱方程去计算有效范围。</p>
<p>这里说一下我遇到的问题(没有解决)，如果大家有什么头绪，欢迎提出来。<br>描述上来说，我通过官网的教程根据source code编写后，发现我的只有当camera离的很近的时候才会显示一个box(最初怀疑是PersProjInfo设置的zFar导致的，后来查看是一模一样的。但通过修改源代码的zFar&#x3D;2.0我得到了相同的结果，但这里无论我如何修改zFar，我的示例始终只有靠近box的时候才显示一部分。)<br><img src="/img/OpenGL/DSStart.PNG" alt="DS一开始截图"><br><img src="/img/OpenGL/DSClose.PNG" alt="DS靠近后"></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Source Code</span></span><br><span class="line">	m_persProjInfo.FOV = <span class="number">60.0f</span>;</span><br><span class="line">	m_persProjInfo.Height = WINDOW_HEIGHT;</span><br><span class="line">	m_persProjInfo.Width = WINDOW_WIDTH;</span><br><span class="line">	m_persProjInfo.zNear = <span class="number">1.0f</span>;</span><br><span class="line">	m_persProjInfo.zFar = <span class="number">100.0f</span>;  </span><br><span class="line"></span><br><span class="line"><span class="comment">// My Code</span></span><br><span class="line">	gPersProjInfo.FOV = <span class="number">60.0f</span>;</span><br><span class="line">	gPersProjInfo.Height = WINDOW_HEIGHT;</span><br><span class="line">	gPersProjInfo.Width = WINDOW_WIDTH;</span><br><span class="line">	gPersProjInfo.zNear = <span class="number">1.0f</span>;</span><br><span class="line">	gPersProjInfo.zFar = <span class="number">100.0f</span>;</span><br></pre></td></tr></table></figure>

<p>通过上述方法计算后，我们得出了我们Deferred Shading后的效果<br><img src="/img/OpenGL/DSSourceCode.PNG" alt="DS源代码效果"></p>
<p>但上述方法还有一些问题：</p>
<ol>
<li><p>当我们靠近Point Light的时候，Point Light光照消失了(这是因为我们之渲染front face，当Camera进入Light Sphere的时候Sphere被cull away了，所以也就不会触发Point Light的计算了。)</p>
</li>
<li><p>因为Sphere是针对我们生成的Screen Space的Texture而言的，所以有时候有些object其实不在sphere内但在sphere所在的screen space上就参与了计算，这样就错误的给某些object计算了point light。<br>解决第二个问题，需要用到Stencil Buffer。<br>在此之前让我们先来了解下什么是Stencil Buffer？<br><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Stencil_buffer">A stencil buffer is an extra buffer, in addition to the color buffer and depth buffer (z-buffering) found on modern graphics hardware. The buffer is per pixel, and works on integer values, usually with a depth of one byte per pixel. </a><br>简单的想，可以把Stencil Buffer理解成PS里面的模板，只有Stencil Buffer里面的数据(数据可以修改)不为0的时候特定像素才能通过。真是因为这个特性我们可以控制哪些pixel参与Point Light光照计算。</p>
</li>
</ol>
<p>Stencil Buffer用于Stencil Test,Stencil Test是针对每一个像素调用，就像我之前说的类似PS的模板。</p>
<p>来我们来看个简单的Stencil Buffer效果，<a target="_blank" rel="noopener" href="http://www.learnopengl.com/#!Advanced-OpenGL/Stencil-testing">下图来源</a>:<br><img src="/img/OpenGL/StencilBufferEffect.PNG" alt="StencilBufferEffect"></p>
<p>我们可以指定Stencil Buffer里的值如何修改，什么时候修改。</p>
<p>接下来让我们来看看如何通过Stencil Buffer来解决第二个问题：<br><a target="_blank" rel="noopener" href="http://ogldev.atspace.co.uk/www/tutorial37/tutorial37.html">以下引用至</a></p>
<ol>
<li>Render the objects as usual into the G buffer so that the depth buffer will be properly populated.</li>
<li>Disable writing into the depth buffer. From now on we want it to be read-only</li>
<li>Disable back face culling. We want the rasterizer to process all polygons of the sphere.</li>
<li>Set the stencil test to always succeed. What we really care about is the stencil operation.</li>
<li>Configure the stencil operation for the back facing polygons to increment the value in the stencil buffer when the depth test fails but to keep it unchanged when either depth test or stencil test succeed.</li>
<li>Configure the stencil operation for the front facing polygons to decrement the value in the stencil buffer when the depth test fails but to keep it unchanged when either depth test or stencil test succeed.</li>
<li>Render the light sphere.(only when the stencil value of the pixel is different from zero)</li>
</ol>
<p>关键思想是通过判断object的front和back face是否在sphere的front和back的前面或后面来修改stencil buffer的值，然后通过该值得出我们所需绘制的pixel。<br>请看下图：<br><img src="/img/OpenGL/DeferredShadingStencilBufferUsing.PNG" alt="DeferredShadingStencilBufferUsing"><br>sphere的front和back face都在物体A的后面，物体C的前面，就物体B而言，front face在物体B之前，back face在物体B之后。</p>
<p>所以通过5,6步骤设定的规则，只有物体B所在的所在的pixel的stencil buffer值大于0</p>
<p>上面的2-6算作Stencil Pass，用于得到哪些物体参与Point Light Sphere的计算。</p>
<p>第7步才是真正光照计算。</p>
<p>接下来让我们看看代码实现：</p>
<ol>
<li>针对每一个Point Light开启stencil test并在进行关照计算之前调用stencil pass得出需要参与计算的pixel</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line">null_technique.vs</span><br><span class="line"><span class="meta">#version 330</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">layout</span> (location = <span class="number">0</span>) in vec3 Position; </span><br><span class="line"></span><br><span class="line">uniform mat4 gWVP;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;          </span><br><span class="line">    gl_Position = gWVP * <span class="built_in">vec4</span>(Position, <span class="number">1.0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">null_technique.fs</span><br><span class="line"><span class="comment">// 这个为空，因为在stencil pass我们不需要填充color buffer，我们只需要触发rasterizer即可</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 因为最终pixel会被绘制到G buffer的GL_COLOR_ATTACHMENT4上，</span></span><br><span class="line"><span class="comment">// 所以我们要在每次渲染之前清除GL_COLOR_ATTACHMENT4</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">GBuffer::StartFrame</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">glBindFramebuffer</span>(GL_DRAW_FRAMEBUFFER, m_fbo);</span><br><span class="line">    <span class="built_in">glDrawBuffer</span>(GL_COLOR_ATTACHMENT4);</span><br><span class="line">    <span class="built_in">glClear</span>(GL_COLOR_BUFFER_BIT);</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 在初始化G buffer的时候需要注意，因为我们需要存储stencil值</span></span><br><span class="line"><span class="comment">// 这里depth texture格式变为GL_DEPTH32F_STENCIL8，并且attach到GL_DEPTH_STENCIL_ATTACHMENT上</span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">GBuffer::Init</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> WindowWidth, <span class="type">unsigned</span> <span class="type">int</span> WindowHeight)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">// depth</span></span><br><span class="line">    <span class="built_in">glBindTexture</span>(GL_TEXTURE_2D, m_depthTexture);</span><br><span class="line">    <span class="built_in">glTexImage2D</span>(GL_TEXTURE_2D, <span class="number">0</span>, GL_DEPTH32F_STENCIL8, WindowWidth, WindowHeight, <span class="number">0</span>, GL_DEPTH_STENCIL,</span><br><span class="line">                  GL_FLOAT_32_UNSIGNED_INT_24_8_REV, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="built_in">glFramebufferTexture2D</span>(GL_FRAMEBUFFER, GL_DEPTH_STENCIL_ATTACHMENT, GL_TEXTURE_2D, m_depthTexture, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">GBuffer::BindForStencilPass</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// must disable the draw buffers </span></span><br><span class="line">	<span class="built_in">glDrawBuffer</span>(GL_NONE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DSStencilPass</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> PointLightIndex)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	m_nullTech.<span class="built_in">Enable</span>();</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Disable color/depth write and enable stencil</span></span><br><span class="line">	<span class="comment">// 这里使用我们之前创建的fbo(存储了之前object渲染后depth buffer的fbo)</span></span><br><span class="line">	m_gbuffer.<span class="built_in">BindForStencilPass</span>();</span><br><span class="line">	<span class="comment">// 因为stencil buffer的值更新跟depth test有关，所以需要开启GL_DEPTH_TEST</span></span><br><span class="line">	<span class="built_in">glEnable</span>(GL_DEPTH_TEST);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 为了得到正确的stencil buffer值，我们需要针对sphere进行front和back face渲染</span></span><br><span class="line">    <span class="built_in">glDisable</span>(GL_CULL_FACE);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 归零stencil buffer，用于下一个point light</span></span><br><span class="line">	<span class="built_in">glClear</span>(GL_STENCIL_BUFFER_BIT);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// We need the stencil test to be enabled but we want it</span></span><br><span class="line">	<span class="comment">// to succeed always. Only the depth test matters.</span></span><br><span class="line">	<span class="comment">// 指定stencil text always success，</span></span><br><span class="line">	<span class="comment">// 因为这里我只需要通过设定stencil buffer修改规则就能得到我们要的值了</span></span><br><span class="line">	<span class="built_in">glStencilFunc</span>(GL_ALWAYS, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 为stencil buffer指定修改方式，即我们之前提到的6和7步骤</span></span><br><span class="line">	<span class="built_in">glStencilOpSeparate</span>(GL_BACK, GL_KEEP, GL_INCR_WRAP, GL_KEEP);</span><br><span class="line">	<span class="built_in">glStencilOpSeparate</span>(GL_FRONT, GL_KEEP, GL_DECR_WRAP, GL_KEEP);</span><br><span class="line"></span><br><span class="line">	Pipeline p;</span><br><span class="line">	p.<span class="built_in">WorldPos</span>(m_pointLight[PointLightIndex].Position);</span><br><span class="line">    <span class="type">float</span> BBoxScale = <span class="built_in">CalcPointLightBSphere</span>(m_pointLight[PointLightIndex]);</span><br><span class="line">	p.<span class="built_in">Scale</span>(BBoxScale, BBoxScale, BBoxScale);		</span><br><span class="line">    p.<span class="built_in">SetCamera</span>(m_pGameCamera-&gt;<span class="built_in">GetPos</span>(), m_pGameCamera-&gt;<span class="built_in">GetTarget</span>(), m_pGameCamera-&gt;<span class="built_in">GetUp</span>());</span><br><span class="line">    p.<span class="built_in">SetPerspectiveProj</span>(m_persProjInfo);</span><br><span class="line"></span><br><span class="line">	m_nullTech.<span class="built_in">SetWVP</span>(p.<span class="built_in">GetWVPTrans</span>());</span><br><span class="line">	<span class="comment">// 这样一来我们就得到了针对特定光照sphere的stencil buffer值了</span></span><br><span class="line">	m_bsphere.<span class="built_in">Render</span>();  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">RenderSceneCB</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 清除G buffer的GL_COLOR_ATTACHMENT4</span></span><br><span class="line">    m_gbuffer.<span class="built_in">StartFrame</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// We need stencil to be enabled in the stencil pass to get the stencil buffer</span></span><br><span class="line">    <span class="comment">// updated and we also need it in the light pass because we render the light</span></span><br><span class="line">    <span class="comment">// only if the stencil passes.</span></span><br><span class="line">    <span class="built_in">glEnable</span>(GL_STENCIL_TEST);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">unsigned</span> <span class="type">int</span> i = <span class="number">0</span> ; i &lt; <span class="built_in">ARRAY_SIZE_IN_ELEMENTS</span>(m_pointLight); i++) &#123;</span><br><span class="line">        <span class="built_in">DSStencilPass</span>(i);</span><br><span class="line">        <span class="built_in">DSPointLightPass</span>(i);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The directional light does not need a stencil test because its volume</span></span><br><span class="line">    <span class="comment">// is unlimited and the final pass simply copies the texture.</span></span><br><span class="line">    <span class="built_in">glDisable</span>(GL_STENCIL_TEST);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">DSDirectionalLightPass</span>();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">DSFinalPass</span>();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">RenderFPS</span>();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">glutSwapBuffers</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>调用Point Light Pass通过stencil buffer对特定pixel进行光照计算</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">GBuffer::BindForLightPass</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">glDrawBuffer</span>(GL_COLOR_ATTACHMENT4);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">unsigned</span> <span class="type">int</span> i = <span class="number">0</span> ; i &lt; <span class="built_in">ARRAY_SIZE_IN_ELEMENTS</span>(m_textures); i++) &#123;</span><br><span class="line">        <span class="built_in">glActiveTexture</span>(GL_TEXTURE0 + i);</span><br><span class="line">        <span class="built_in">glBindTexture</span>(GL_TEXTURE_2D, m_textures[GBUFFER_TEXTURE_TYPE_POSITION + i]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DSPointLightPass</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> PointLightIndex)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// 指定参与光照计算的texture</span></span><br><span class="line">	m_gbuffer.<span class="built_in">BindForLightPass</span>();</span><br><span class="line"></span><br><span class="line">    m_DSPointLightPassTech.<span class="built_in">Enable</span>();</span><br><span class="line">    m_DSPointLightPassTech.<span class="built_in">SetEyeWorldPos</span>(m_pGameCamera-&gt;<span class="built_in">GetPos</span>());        </span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置当stencil buffer value不等于0的时候才通过，</span></span><br><span class="line">    <span class="comment">// 这样一来就只有通过stencil pass即在光照sphere内的物体才参与计算</span></span><br><span class="line">	<span class="built_in">glStencilFunc</span>(GL_NOTEQUAL, <span class="number">0</span>, <span class="number">0xFF</span>);</span><br><span class="line">  		</span><br><span class="line">  	<span class="comment">// 计算光照不需要Delpth test，只需要叠加计算光照效果即可</span></span><br><span class="line">	<span class="built_in">glDisable</span>(GL_DEPTH_TEST);</span><br><span class="line">	<span class="built_in">glEnable</span>(GL_BLEND);</span><br><span class="line">	<span class="built_in">glBlendEquation</span>(GL_FUNC_ADD);</span><br><span class="line">	<span class="built_in">glBlendFunc</span>(GL_ONE, GL_ONE);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 这里很重要，当我们去计算光照的时候，我们需要开启GL_FRONT Cull，</span></span><br><span class="line">    <span class="comment">// 这样一来可以避免camera位于sphere内的时候无法计算光照</span></span><br><span class="line">    <span class="comment">// (确保了sphere back face的片面渲染，但如果是GL_BACK，这一部分是会被CULL掉)</span></span><br><span class="line">    <span class="comment">// 这样一来就解决了之前说的当camera位于sphere内，无法计算光照的问题</span></span><br><span class="line">    <span class="built_in">glEnable</span>(GL_CULL_FACE);</span><br><span class="line">    <span class="built_in">glCullFace</span>(GL_FRONT);</span><br><span class="line"></span><br><span class="line">    Pipeline p;</span><br><span class="line">    p.<span class="built_in">WorldPos</span>(m_pointLight[PointLightIndex].Position);</span><br><span class="line">    <span class="type">float</span> BBoxScale = <span class="built_in">CalcPointLightBSphere</span>(m_pointLight[PointLightIndex]);        </span><br><span class="line">	p.<span class="built_in">Scale</span>(BBoxScale, BBoxScale, BBoxScale);		</span><br><span class="line">    p.<span class="built_in">SetCamera</span>(m_pGameCamera-&gt;<span class="built_in">GetPos</span>(), m_pGameCamera-&gt;<span class="built_in">GetTarget</span>(), m_pGameCamera-&gt;<span class="built_in">GetUp</span>());</span><br><span class="line">    p.<span class="built_in">SetPerspectiveProj</span>(m_persProjInfo);               </span><br><span class="line">    m_DSPointLightPassTech.<span class="built_in">SetWVP</span>(p.<span class="built_in">GetWVPTrans</span>());</span><br><span class="line">    m_DSPointLightPassTech.<span class="built_in">SetPointLight</span>(m_pointLight[PointLightIndex]);</span><br><span class="line">    m_bsphere.<span class="built_in">Render</span>(); </span><br><span class="line">    <span class="built_in">glCullFace</span>(GL_BACK);</span><br><span class="line">   </span><br><span class="line">	<span class="built_in">glDisable</span>(GL_BLEND);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>最后渲染G buffer里计算得出的图像(之前我们绘制到了G buffer的GL_COLOR_ATTACHMENT4里)</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">GBuffer::BindForFinalPass</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">glBindFramebuffer</span>(GL_DRAW_FRAMEBUFFER, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">glBindFramebuffer</span>(GL_READ_FRAMEBUFFER, m_fbo);</span><br><span class="line">    <span class="built_in">glReadBuffer</span>(GL_COLOR_ATTACHMENT4);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DSFinalPass</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// 这里我之所以不直接渲染到default FBO的原因是因为，</span></span><br><span class="line">	<span class="comment">// 在Point Light Pass的时候我们需要知道depth buffer里的值来决定那些pixel应该参与光照计算</span></span><br><span class="line">    m_gbuffer.<span class="built_in">BindForFinalPass</span>();</span><br><span class="line">    <span class="built_in">glBlitFramebuffer</span>(<span class="number">0</span>, <span class="number">0</span>, WINDOW_WIDTH, WINDOW_HEIGHT,</span><br><span class="line">                      <span class="number">0</span>, <span class="number">0</span>, WINDOW_WIDTH, WINDOW_HEIGHT, GL_COLOR_BUFFER_BIT, GL_LINEAR);</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<p>Final Effect:<br><img src="/img/OpenGL/DeferredShadingFinalEffect.PNG" alt="DeferredShadingFinalEffect"></p>
<p>Note:<br><a target="_blank" rel="noopener" href="http://ogldev.atspace.co.uk/www/tutorial35/tutorial35.html">The key point behind deferred shading is the decoupling of the geometry calculations (position and normal transformations) and the lighting calculations. </a></p>
<h2 id="OpenGL-Utility"><a href="#OpenGL-Utility" class="headerlink" title="OpenGL Utility"></a>OpenGL Utility</h2><h3 id="Open-Asset-Import-Library"><a href="#Open-Asset-Import-Library" class="headerlink" title="Open Asset Import Library"></a>Open Asset Import Library</h3><p>“Open Asset Import Library is a portable Open Source library to import various well-known 3D model formats in a uniform manne”</p>
<p><a target="_blank" rel="noopener" href="http://www.assimp.org/">官方网站</a></p>
<h4 id="assimp"><a href="#assimp" class="headerlink" title="assimp"></a>assimp</h4><p>“assimp is a library to load and process geometric scenes from various data formats. It is tailored at typical game scenarios by supporting a node hierarchy, static or skinned meshes, materials, bone animations and potential texture data. The library is not designed for speed, it is primarily useful for importing assets from various sources once and storing it in a engine-specific format for easy and fast every-day-loading. “</p>
<p><a target="_blank" rel="noopener" href="http://www.assimp.org/lib_html/index.html">官方文档</a></p>
<p>Note:<br>个人理解，assimp主要是提供了对多种格式模型的数据解析，并抽象了所有数据到aiScene这个类里。<br>通过aiScene我们可以去访问模型数据里的顶点数据，纹理数据，材质数据等。<br>我们通过这些数据最终去作为我们的顶点数据创建顶点buffer，作为纹理数据创建纹理贴图，最终绘制出我们的模型。</p>
<p>源代码参考OpenGL Tutorial 22</p>
<h4 id="open3mod"><a href="#open3mod" class="headerlink" title="open3mod"></a>open3mod</h4><p>“open3mod is a Windows-based model viewer. It loads all file formats that Assimp supports and is perfectly suited to quickly inspect 3d assets.”</p>
<p>主要用于快速查看各种资源格式的模型。<br><img src="/img/OpenGL/Open3mod.PNG" alt="Open3modUsing"></p>
<h3 id="GIMP"><a href="#GIMP" class="headerlink" title="GIMP"></a>GIMP</h3><p>GNU Image Manipulation Program (GIMP) is a cross-platform image editor available for GNU&#x2F;Linux, OS X, Windows and more operating systems.<br><a target="_blank" rel="noopener" href="http://www.gimp.org/">GIMPDownloadLink</a></p>
<p>gimp-normalmap plugin that supports to export normal map from texture<br><a target="_blank" rel="noopener" href="https://code.google.com/archive/p/gimp-normalmap/">gimp-normalmapDownloadLink</a></p>
<p>通过GIMP和gimp-normalmap插件，我们可以从texture中导出normal map使用。</p>
<h3 id="GLSL-Debuger"><a href="#GLSL-Debuger" class="headerlink" title="GLSL Debuger"></a>GLSL Debuger</h3><h4 id="Nsight"><a href="#Nsight" class="headerlink" title="Nsight"></a>Nsight</h4><p><a target="_blank" rel="noopener" href="http://www.nvidia.com/object/nsight.html">NVIDIA® Nsight™ is the ultimate development platform for heterogeneous computing. Work with powerful debugging and profiling tools that enable you to fully optimize the performance of the CPU and GPU. - See more at: http://www.nvidia.com/object/nsight.html#sthash.Hc8TfPMs.dpuf</a><br>Nsight是NVIDIA开发的一套协助GPU开发的工具。<br>优点：</p>
<ol>
<li>支持直接调试GLSL和HLSL等着色器语言</li>
<li>和VS完美集成</li>
</ol>
<p>缺点：</p>
<ol>
<li>硬件限制比较多（比如主要针对NVIDIA公司的显卡）<br><a target="_blank" rel="noopener" href="https://developer.nvidia.com/nsight-visual-studio-edition-requirements">Nsight Visual Studio Edition Requirements</a></li>
</ol>
<h3 id="OpenGL-proiler-debugger"><a href="#OpenGL-proiler-debugger" class="headerlink" title="OpenGL proiler, debugger"></a>OpenGL proiler, debugger</h3><h4 id="gDEBugger"><a href="#gDEBugger" class="headerlink" title="gDEBugger"></a>gDEBugger</h4><p>gDEBugger是一个针对OpenGL和OpenCL开发的一套调试器，分析器和内存分析器等协助工具。<br>通过gDEBugger我们可以查看在某一贞关于OpenGL相关的大量信息（比如Uniform值，OpenGL的各个状态，Draw call次数等）<br>可以查看到OpenGL的一些状态，比如GL_CULL_FACE:<br><img src="/img/OpenGL/gDEBuggerCapture.PNG" alt="gDEBuggerCapture"></p>
<p>可以查看Shader的一些信息，并且可以编译Shader等：<br><img src="/img/OpenGL/gDEBuggerShaderInfo.PNG" alt="gDEBuggerShaderInfo"></p>
<h1 id="Reference-Website"><a href="#Reference-Website" class="headerlink" title="Reference Website:"></a>Reference Website:</h1><p><a target="_blank" rel="noopener" href="http://www.opengl.org/sdk/docs/man4/">OpenGL 4 reference page</a><br><a target="_blank" rel="noopener" href="http://blog.csdn.net/guolihui112/article/details/5702915">client-server 模式</a><br><a target="_blank" rel="noopener" href="http://www.glprogramming.com/blue/ch01.html">OpenGL Execute Model</a><br><a target="_blank" rel="noopener" href="http://blog.chinaunix.net/uid-28959509-id-3762988.html">X Window System</a><br><a target="_blank" rel="noopener" href="http://ogldev.atspace.co.uk/index.html">OpenGL Tutorial</a><br><a target="_blank" rel="noopener" href="http://openglbook.com/chapter-1-getting-started.html">OpenGL Windows &amp; Context</a><br><a target="_blank" rel="noopener" href="https://www.opengl.org/wiki/Creating_an_OpenGL_Context_%28WGL%29">Creating an OpenGL Context (WGL)</a><br><a target="_blank" rel="noopener" href="https://www.opengl.org/wiki/OpenGL_Context">OpenGL Context</a><br><a target="_blank" rel="noopener" href="https://open.gl/context">Window and OpenGL context</a><br><a target="_blank" rel="noopener" href="http://openglbook.com/chapter-1-getting-started.html">OpenGLBook.com Getting Started</a></p>
<p>Note:<br><strong>OpenGL uses right-handed coordinate system (OpenGL使用右手坐标系)</strong></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Rendering/">Rendering</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/OpenGL/">OpenGL</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/08/15/CS学习/" title="CS学习" itemprop="url">CS学习</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Tony Tang" target="_blank" itemprop="author">Tony Tang</a>
		
  <p class="article-time">
    <time datetime="2015-08-15T06:30:53.000Z" itemprop="datePublished"> 发表于 2015-08-15</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="Net-Framework"><a href="#Net-Framework" class="headerlink" title=".Net Framework"></a>.Net Framework</h1><h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>.Net Framework是Microsoft为开发应用程序而创建创的一个具有革命意义的平台。</p>
<h2 id="Content"><a href="#Content" class="headerlink" title="Content"></a>Content</h2><p>.Net Framework主要包含一个非常大的代码库，可以在客户语言中通过面向对象编程技术来使用这些代码。这个库分为多个不同的模块。</p>
<p>.Net Framework还包含.NET公共语言运行库(Common Language Runtime, CLR)，它负责管理用.NET库开发的所有应用程序的执行</p>
<h2 id="Using-NET-Framework"><a href="#Using-NET-Framework" class="headerlink" title="Using .NET Framework"></a>Using .NET Framework</h2><h3 id="Tools"><a href="#Tools" class="headerlink" title="Tools"></a>Tools</h3><ol>
<li>Visual Studio</li>
<li>VCE(for C#)</li>
</ol>
<h3 id="相关概念"><a href="#相关概念" class="headerlink" title="相关概念"></a>相关概念</h3><h4 id="FCL-Framework-Class-Library"><a href="#FCL-Framework-Class-Library" class="headerlink" title="FCL(Framework Class Library)"></a>FCL(Framework Class Library)</h4><p>“The FCL is a set of DLL assemblies that contain several thousand type definitions in which each type exposes some functionality.”(提供了大量功能的现有DLL库)</p>
<h4 id="Metadata"><a href="#Metadata" class="headerlink" title="Metadata"></a>Metadata</h4><p>“There are two main types of tables: tables that describe the types and members defined in your source code and tables that describe the types and members referenced by your source code.”(包含了源代码里类型的定义，对象的索引等信息)</p>
<h4 id="IL-Intermediate-Language"><a href="#IL-Intermediate-Language" class="headerlink" title="IL(Intermediate Language)"></a>IL(Intermediate Language)</h4><p>“IL is a CPU-independent machine language created by Microsoft after consultation with several external commercial and academic language&#x2F;compiler writers.”(CPU无关的中间语言，用来抽象编译后的高阶语言，在JIT中会被编译成特定OS和目标机器架构的机器代码)</p>
<h4 id="CLI-Common-Language-Infrastructure"><a href="#CLI-Common-Language-Infrastructure" class="headerlink" title="CLI(Common Language Infrastructure)"></a>CLI(Common Language Infrastructure)</h4><p><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Common_Language_Infrastructure">The Common Language Infrastructure (CLI) is an open specification developed by Microsoft and standardized by ISO[1] and ECMA[2] that describes executable code and a runtime environment that allow multiple high-level languages to be used on different computer platforms without being rewritten for specific architectures.</a>(通用语言基础架构定义了可执行码以及代码的运行时环境的规范，使得高级语言编写的软件无需重新编写就可以运行在不同的计算机体系结构上)</p>
<p>Note:<br><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Common_Language_Infrastructure">The .NET Framework and the free and open source Mono and Portable.NET are implementations of the CLI.</a></p>
<h4 id="CLR-Common-Language-Runtime"><a href="#CLR-Common-Language-Runtime" class="headerlink" title="CLR(Common Language Runtime)"></a>CLR(Common Language Runtime)</h4><p>“The common language runtime (CLR) is just what its name says it is: a runtime that is usable by different and varied programming languages. The core features of the CLR (such as memory management, assembly loading, security, exception handling, and thread synchronization) are available to any and all programming languages that target it” – 《CLR Via C# Fourth Edition - Jeffrey Richter》(公共语言运行库提供了内存管理，异常处理，线程同步等功能)</p>
<h4 id="CTS-Common-Type-System"><a href="#CTS-Common-Type-System" class="headerlink" title="CTS(Common Type System)"></a>CTS(Common Type System)</h4><p>“Describes how types are defined and how they behave. Defines the rules governing type inheritance, virtual methods, object lifetime, and so on.”</p>
<h4 id="CLS-Common-Language-Specification"><a href="#CLS-Common-Language-Specification" class="headerlink" title="CLS(Common Language Specification)"></a>CLS(Common Language Specification)</h4><p>“Details for compiler vendors the minimum set of features their compilers must support if these compilers are to generate types compatible with other components written by other CLS-compliant languages on top of the CLR.”(通用语言规范定义了通用语言之间类型交互的基本规范)<br><img src="/img/CSharp/CTSAndCLS.png" alt="CTSAndCLS"></p>
<h3 id="Compile-process"><a href="#Compile-process" class="headerlink" title="Compile process"></a>Compile process</h3><ol>
<li>CIL(Common Intermediate Language)<br>首先把代码编译成通用中间语言(Common Intermediate Language, CIL)代码<br><img src="/img/CSharp/CSharp_Compile_Process1.PNG" alt="编译到程序集"></li>
</ol>
<p><img src="/img/CSharp/CompileSourceIntoManagedModules.png" alt="Compile Source Into Managed Modules"><br>从上面可以看出CLR支持的语言都被编译成Managed module(IL and metadata)</p>
<h4 id="Managed-Module"><a href="#Managed-Module" class="headerlink" title="Managed Module"></a>Managed Module</h4><p>Managed Module由两部分组成：</p>
<ol>
<li>Metadata</li>
<li>IL(Intermediate Language)<br><img src="/img/CSharp/ManagedModulesComponents.png" alt="ManagedModulesComponents"><br>可以看出Metadata是负责记录类型信息。<br>IL是通过CLR编译后的CPU-independent的中间语言。<br>CLR支持的语言都会编译成IL和Metadata存储在Managed Module里。<br>但我们最终在程序里加载的不是Module而是Assebmlies。下面来看看Module和Assebmly之间的关系。<br><img src="/img/CSharp/RelationshipBetweenModulesAndAssemblies.png" alt="RelationshipBetweenModulesAndAssemblies"><br>可以看出Assembly是由多个Module组成。<br>而CLR是负责管理Assebmlies里的代码执行。<br>所以才有了多种CLR支持的语言在CLR内可以互相调用。</li>
</ol>
<h3 id="Executing-Assembly-Code"><a href="#Executing-Assembly-Code" class="headerlink" title="Executing Assembly Code"></a>Executing Assembly Code</h3><ol start="2">
<li>JIT(Just-In-Time)<br>把CIL编译为专用于OS和目标机器结构的机器代码<br><img src="/img/CSharp/CSharp_Compile_Process2.PNG" alt="编译为本机代码"><br>e.g.<br><img src="/img/CSharp/CodeExecution.png" alt="CodeExecutionExample1"><br><img src="/img/CSharp/CodeExecution2.png" alt="CodeExecutionExample2"><br>从上面可以看出，之前生成的IL会被JIT在运行时编译成对应的本地机器代码。当同样的方法再次调用时，就不需要JIT进行IL到本地机器代码的编译，直接调用之前编译好的机器代码即可。</li>
</ol>
<p>这里有个Unsafe code的概念值得注意。<br>Unsafe code is allowed to work directly with memory addresses and can manipulate bytes at these addresses.<br>&#x2F;unsafe compiler switch to control whether allow to executing unsafe code(只有编译器开启了&#x2F;unsafe标志才允许执行unsafe code(e.g. 直接操作内存地址进行修改))<br>PEVerify.exe可用不查看Assembly里是否有unsafe code。</p>
<h3 id="程序集"><a href="#程序集" class="headerlink" title="程序集"></a>程序集</h3><p>编译程序时所创建的CIL代码存储在一个程序集中（e.g. .exe .dll）<br>程序集包含程序用到的相关数据信息(Assemblies contains all module’s Metadata and IL)</p>
<p>Note:<br>PDB(program Database) file helps the debugger find local variables and map the IL instructions to the source code.<br>NGen.exe tool can compiles all of an assembly’s IL code into native code and saves the resulting native code to a file on disk.(avoid compilation at run time)</p>
<h3 id="托管代码"><a href="#托管代码" class="headerlink" title="托管代码"></a>托管代码</h3><p>CLR管理着应用程序，其方式是管理内存，处理安全性以及允许进行跨语言调试等。相反，不受CLR控制运行着的应用程序属于非托管类型。<br><img src="/img/CSharp/CSharp_Compile_Process3.PNG" alt="托管到CLR运行"></p>
<p>Note:<br>“C++ is unique in that it is the only compiler that allows the developer to write both managed and unmanaged code and have it emitted into a single module.”</p>
<h3 id="垃圾回收"><a href="#垃圾回收" class="headerlink" title="垃圾回收"></a>垃圾回收</h3><p>托管代码中的一个功能GC(garbage collection)</p>
<h3 id="链接"><a href="#链接" class="headerlink" title="链接"></a>链接</h3><p>模块化</p>
<h1 id="CSharp-CLR-Via-C"><a href="#CSharp-CLR-Via-C" class="headerlink" title="CSharp(CLR Via C#)"></a>CSharp(CLR Via C#)</h1><h2 id="Introduction-1"><a href="#Introduction-1" class="headerlink" title="Introduction"></a>Introduction</h2><p>C#是可用于创建要运行在.NET CLR上的应用程序的语言之一，它从C和C++语言演化而来，是Microsoft专门为使用.NET平台而创建的。</p>
<h2 id="Features"><a href="#Features" class="headerlink" title="Features"></a>Features</h2><ol>
<li>语法简单</li>
<li>类型安全</li>
<li>为.NET Framework设计的语言</li>
</ol>
<h2 id="Development"><a href="#Development" class="headerlink" title="Development"></a>Development</h2><p>Application Type</p>
<ol>
<li>Windows Appliaction Program</li>
<li>Web Application Program</li>
<li>Web Service</li>
</ol>
<h2 id="Language-Study"><a href="#Language-Study" class="headerlink" title="Language Study"></a>Language Study</h2><p>Only record some difference between C# and C++&#x2F;Java</p>
<h3 id="delegate"><a href="#delegate" class="headerlink" title="delegate"></a>delegate</h3><p>delegates – type-safe<br>Unmanaged C&#x2F;C++ callback functions are not type-safe<br>首先要知道的是delegate在C#里类型安全的(即有有编译时的类型检查)<br>C++里是不是类型安全的</p>
<p>在调用delegate的时候，CLR提供了当reference type绑定方法到delegate的时covariance和contra-variance的支持。<br>Covariance means that a method can return a type that is derived from the delegate’s return type.(reference type的方法的返回类型可以是delegate指定返回类型的子类)<br>Contra-variance means that a method can take a parameter that is a base of the delegate’s parameter type.(reference type的方法的参数可以是delegate指定参数类型的父类)<br>The reason why value types and void cannot be used for covariance and contra-variance is because the memory structure for these things varies, whereas the memory structure for reference type is always a pointer.(value type和void不支持上述功能)</p>
<p>接下来让我们看看Delegate背后的故事：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">CSharpDeepStudy</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">#<span class="keyword">region</span> Delegate Study</span></span><br><span class="line">    <span class="function"><span class="keyword">internal</span> <span class="built_in">delegate</span> <span class="keyword">void</span> <span class="title">DelegateStudy</span>(<span class="params"><span class="built_in">int</span> <span class="keyword">value</span></span>)</span>;</span><br><span class="line">    <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="meta">#<span class="keyword">region</span> Delegate Study</span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">StaticDelegateDemo</span>(<span class="params"><span class="built_in">int</span> <span class="keyword">value</span></span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;StaticDelegateDemo(&#123;0&#125;)&quot;</span>, <span class="keyword">value</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">InstanceDelegateDemo</span>(<span class="params"><span class="built_in">int</span> <span class="keyword">value</span></span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;InstanceDelegateDemo(&#123;0&#125;)&quot;</span>,<span class="keyword">value</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ChainDelegateDemo</span>(<span class="params">Program p</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            DelegateStudy cdd = <span class="literal">null</span>;</span><br><span class="line">            cdd += Program.StaticDelegateDemo;</span><br><span class="line">            cdd += p.InstanceDelegateDemo;</span><br><span class="line">            cdd.Invoke(<span class="number">3</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] <span class="keyword">args</span></span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="meta">#<span class="keyword">region</span> Delegate Study</span></span><br><span class="line">            Program p = <span class="keyword">new</span> Program();</span><br><span class="line">            DelegateStudy sdd = Program.StaticDelegateDemo;</span><br><span class="line">            DelegateStudy idd = p.InstanceDelegateDemo;</span><br><span class="line">            sdd.Invoke(<span class="number">1</span>);</span><br><span class="line">            idd.Invoke(<span class="number">2</span>);</span><br><span class="line">            Program.ChainDelegateDemo(p);</span><br><span class="line">            <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line">                        </span><br><span class="line">            <span class="meta">#<span class="keyword">region</span> Dynamic Study</span></span><br><span class="line">            <span class="comment">//Dynamic delegate part</span></span><br><span class="line">            MethodInfo mi = <span class="keyword">typeof</span>(Program).GetMethod(<span class="string">&quot;InstanceDelegateDemo&quot;</span>);</span><br><span class="line">            Delegate d = Delegate.CreateDelegate(<span class="keyword">typeof</span>(DelegateStudy), p, mi);</span><br><span class="line">            d.DynamicInvoke(<span class="number">4</span>);</span><br><span class="line">            <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">            Console.ReadKey();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>反编译后：<br><img src="/img/CSharp/DelegateStudy.png" alt="DelegateStudy"><br>从上面可以看到，当我们定义一个delegate的时候CLR会给我们生成一个继承至System.MulticastDelegate的类，上面是DelegateStudy Class。<br>而MulticastDelegate是我们去累加delegate的关键。<br><img src="/img/CSharp/MulticastDelegate.png" alt="MulticastDelegate"><br>从上面可以看出，MulticastDelegate包含了三个关键成员：</p>
<ol>
<li>_target<br>用于保存delegate的实例对象，如果是全局static的回调则为null</li>
<li>_methodPtr<br>用于识别回调方法</li>
<li>_invocationList<br>这个是用于delegate chain的关键，用于保存array of delegate objects<br>下面我们看看_invocationList是如何完成delegate chain的：<br><img src="/img/CSharp/MultipleDelegatePart1.png" alt="MultipleDelegatePart1"><br><img src="/img/CSharp/MultipleDelegatePart2.png" alt="MultipleDelegatePart2"><br><img src="/img/CSharp/MultipleDelegatePart3.png" alt="MultipleDelegatePart3"><br><img src="/img/CSharp/MultipleDelegatePart4.png" alt="MultipleDelegatePart4"><br>可以看出当我们chain delegate的时候_invocationList存储了delegate的指针到_invocationList里，从而实现了multiple delegate chain的效果。<br>最后要讲的一点是关于反射动态创建delegate：<br>通过System.Reflection.MethodInfo.CreateDelegate()方法我们可以实现动态创建delegate。<br>最终上面的代码会输出如下：<br><img src="/img/CSharp/DelegateStudyOutput.PNG" alt="DelegateStudyOutput"></li>
</ol>
<p>(C++里用函数指针实现,Java里通过内部类的闭包和interface去实现)<br>最后我们还可以通过lambda表达式和匿名方法去定义delegate</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">CSharpStudy</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="built_in">delegate</span> <span class="keyword">void</span> <span class="title">testDelegate</span>(<span class="params"><span class="built_in">string</span> para</span>)</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">doSomething</span>(<span class="params"><span class="built_in">string</span> para</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;doSomething:&quot;</span> + para);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] <span class="keyword">args</span></span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="meta">#<span class="keyword">region</span> method 1 to use delegate</span></span><br><span class="line">	        testDelegate delegate1;</span><br><span class="line">            delegate1 = <span class="keyword">new</span> testDelegate(doSomething);</span><br><span class="line">            <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line">            delegate1(<span class="string">&quot;delegate1&quot;</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="meta">#<span class="keyword">region</span> method 2 to use delegate(lambda expression)</span></span><br><span class="line">            testDelegate delegate2 = s =&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine(<span class="string">&quot;doSomething:&quot;</span> + s);</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line">            delegate2(<span class="string">&quot;delegate2&quot;</span>);</span><br><span class="line">              </span><br><span class="line">           <span class="meta">#<span class="keyword">region</span> method 3 to use delegate(anonymous method)</span></span><br><span class="line">            testDelegate delegate3 = <span class="built_in">delegate</span>(<span class="built_in">string</span> para)</span><br><span class="line">           &#123;</span><br><span class="line">               Console.WriteLine(<span class="string">&quot;delegate3&#x27;s para = &quot;</span> + para);</span><br><span class="line">           &#125;;</span><br><span class="line">           <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line">           delegate3(<span class="string">&quot;delegate3&quot;</span>);</span><br><span class="line">           Console.ReadKey();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Output:<br><img src="/img/CSharp/CSharp_Delegate.PNG" alt="CSharp_Delegate"></p>
<p>详细比较Delegate和函数指针，参见<a target="_blank" rel="noopener" href="http://blog.sina.com.cn/s/blog_8c7d49f20101djju.html">C# VS C++之一： 委托 vs 函数指针</a></p>
<p>这里只写最后的总结：<br>1.C#委托对象是真正的对象，C&#x2F;C++函数指针只是函数入口地址<br>2.C++的委托对象：functor<br>3.C++的静多态：模版</p>
<h3 id="Class-interface"><a href="#Class-interface" class="headerlink" title="Class &amp; interface"></a>Class &amp; interface</h3><ol>
<li>Class qualifier<br>internal class – only code in current project can access (default)<br>public class – other project code can access</li>
</ol>
<p>abstract class – abstract class<br>sealed class – cant not be inheritated</p>
<p>Note:<br>Compiler is not allowed derived class’s access privileges higher than parent class</p>
<p>e.g.</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">internal</span> <span class="keyword">class</span> <span class="title">MyBase</span></span><br><span class="line">&#123;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="title">MyBase</span>()</span></span><br><span class="line">   &#123;</span><br><span class="line">       </span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//Cant do like this due to Child class access previlage is higher than parent class</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MyChild</span> <span class="comment">/*: MyBase*/</span></span><br><span class="line">&#123;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="title">MyChild</span>()</span></span><br><span class="line">   &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>support extends multiple interface<br>Note:<br>base class must be write down first when we inherites from one class and extends several interface<br>abstract &amp; sealed can not be used by interface due to no implementation in interface (abstract &amp; sealed qualifier are meaningless)</p>
<ol start="2">
<li>Static constructor &amp; Static class<br>静态构造函数只会被调用一次且属于整个类<br>静态类不能拥有实例构造函数且只能有static成员</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">CSharpStudy</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">class</span> <span class="title">StaticConstructor</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="function"><span class="keyword">static</span> <span class="title">StaticConstructor</span>()</span></span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine(<span class="string">&quot;Static StaticConstructor()&quot;</span>);</span><br><span class="line">                m_ID = <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="title">StaticConstructor</span>()</span></span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine(<span class="string">&quot;Normal StaticConstructor()&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">int</span> m_ID;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">StaticClass</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">            //Cant have instance constructor (do not know why static constructor neither)</span></span><br><span class="line"><span class="comment">            static StaticClass()</span></span><br><span class="line"><span class="comment">            &#123;</span></span><br><span class="line"><span class="comment">                Console.WriteLine(&quot;StaticClass()&quot;);</span></span><br><span class="line"><span class="comment">                m_ID = 2;</span></span><br><span class="line"><span class="comment">                m_Type = &quot;Static&quot;;</span></span><br><span class="line"><span class="comment">            &#125;</span></span><br><span class="line"><span class="comment">            */</span></span><br><span class="line">            <span class="comment">//Can not non static member</span></span><br><span class="line">            <span class="comment">//public int m_Test = 3; </span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">int</span> m_ID = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">string</span> m_Type = <span class="string">&quot;Static&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] <span class="keyword">args</span></span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">           StaticConstructor sc = <span class="keyword">new</span> StaticConstructor();</span><br><span class="line">           Console.WriteLine(<span class="string">&quot;StaticConstructor::m_ID = &quot;</span> + StaticConstructor.m_ID);</span><br><span class="line"></span><br><span class="line">           Console.WriteLine(<span class="string">&quot;StaticClass::m_ID = &quot;</span> + StaticClass.m_ID);</span><br><span class="line">           Console.WriteLine(<span class="string">&quot;StaticClass::m_Type = &quot;</span> + StaticClass.m_Type);</span><br><span class="line"></span><br><span class="line">           Console.ReadKey();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Output:<br><img src="/img/CSharp/Static_Constructor_And_Static_Class.PNG" alt="Static_Constructor_And_Static_Class"></p>
<h3 id="Not-supported-multiple-inherit"><a href="#Not-supported-multiple-inherit" class="headerlink" title="Not supported multiple inherit"></a>Not supported multiple inherit</h3><p>C++支持多重继承，Java和C#通过extend多个Interface来实现多重继承</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title">Base1</span></span><br><span class="line">&#123;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="title">Base1</span>()</span></span><br><span class="line">   &#123;</span><br><span class="line">       Console.WriteLine(<span class="string">&quot;Base1()&quot;</span>);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title">Base2</span></span><br><span class="line">&#123;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="title">Base2</span>()</span></span><br><span class="line">   &#123;</span><br><span class="line">       Console.WriteLine(<span class="string">&quot;Base1()&quot;</span>);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title">Child</span> : <span class="title">Base1</span><span class="comment">/*, Base2*/</span><span class="comment">//Not support multiple inherit</span></span><br><span class="line">&#123;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="title">Child</span>()</span></span><br><span class="line">   &#123;</span><br><span class="line">       Console.WriteLine(<span class="string">&quot;Child()&quot;</span>);</span><br><span class="line">   &#125;</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line">   Child c = <span class="keyword">new</span> Child();</span><br></pre></td></tr></table></figure>

<h3 id="Class-member"><a href="#Class-member" class="headerlink" title="Class member"></a>Class member</h3><p>access qualifier<br>public, private, internal, protected</p>
<p>readonly – only can be initilized in constructor or declaration</p>
<p>property &amp; field<br>property gives more control to field access</p>
<p>accessor privilege – can not be higher than the access privilege that it is belonged to</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title">Accessor</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Accessor</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        m_A = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span> IntA</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> m_A;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//Can not be public due to IntA&#x27;s access privilege is lower than public</span></span><br><span class="line">        <span class="comment">//public set</span></span><br><span class="line">        <span class="keyword">set</span></span><br><span class="line">        &#123;</span><br><span class="line">            m_A = <span class="keyword">value</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span> m_A;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li><p>member function<br> override key word can hide base function(works with polymorphism)<br> Access base function that has been hiden uses base key word in child class</p>
</li>
<li><p>Interface member<br> all interface member must be public<br> can not use static, virtual, abstract, sealed</p>
</li>
<li><p>Interface implementation<br>explicit implementation – only can be accessed through interface (return type interface.functionanme(para))<br>implicit implementation – can be accessd through both interface and class</p>
</li>
<li><p>partial class definition &amp; partial property<br> can put class member, property, method, field into several files(partial key word)<br> Partial property is always static and withought return value</p>
</li>
</ol>
<h3 id="Struct-Class"><a href="#Struct-Class" class="headerlink" title="Struct &amp; Class"></a>Struct &amp; Class</h3><p>Struct is value type<br>在栈上分配内存<br>栈回收快速<br>传递的是值<br>转换为reference type会触发boxing引发堆上的额外内存分配<br>Class is reference type<br>在堆上分配内存<br>GC管理<br>传递的是索引<br>那么什么时候定义struct，什么时候定义class了？<br>一下来至MSDN<a target="_blank" rel="noopener" href="https://msdn.microsoft.com/en-us/library/ms229017(v=vs.110).aspx">Choosing Between Class and Struct</a><br>✓ CONSIDER defining a struct instead of a class if instances of the type are small and commonly short-lived or are commonly embedded in other objects.<br>如果生命周期短，并被包含在其他类里而已考虑使用struct</p>
<p>X AVOID defining a struct unless the type has all of the following characteristics:<br>    It logically represents a single value, similar to primitive types (int, double, etc.).<br>    It has an instance size under 16 bytes.<br>    It is immutable.<br>    It will not have to be boxed frequently.<br>In all other cases, you should define your types as classes.<br>可以看出只有在数据简单，不可变，不需要频繁boxing的时候才会选择定义struct。</p>
<p>Shallow copy &amp; Deep copy<br>Shallow copy will only copy value type member, reference type member will use original one(System.Object.MemberwiseClone())</p>
<p>Deep copy  will copy all member value instead of reference(implememnt ICloneable::Clone())</p>
<h3 id="Collection-class-System-Collection"><a href="#Collection-class-System-Collection" class="headerlink" title="Collection class (System.Collection)"></a>Collection class (System.Collection)</h3><p>好比C++里的STL里的container<br>Our own collection (extends CollectionBase Class || DictionaryBase)</p>
<p>因为C#没有自带PriorityQueue而是通过基本的List等数据结构来实现，下面是自己实现PriorityQueue，主要是通过堆排序用List来模拟优先队列。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PriorityQueue</span>&lt;<span class="title">T1</span>, <span class="title">T2</span>&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PriorityQueue</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mHeap = <span class="keyword">new</span> Heap&lt;T1, T2&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PriorityQueue</span>(<span class="params">Heap&lt;T1, T2&gt; heap</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        mHeap = heap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">Empty</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> (mHeap.Size() == <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Push</span>(<span class="params">KeyValuePair&lt;T1, T2&gt; kvp</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        mHeap.Insert(kvp);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> KeyValuePair&lt;T1, T2&gt; <span class="title">Pop</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        KeyValuePair&lt;T1, T2&gt; result = mHeap.Top();</span><br><span class="line">        mHeap.RemoveTop();</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">int</span> <span class="title">Size</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> mHeap.Size();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> KeyValuePair&lt;T1, T2&gt; <span class="title">Top</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> mHeap.Top(); ;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">PrintOutAllMember</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mHeap.PrintOutAllMember();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Heap&lt;T1, T2&gt; mHeap;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Heap</span>&lt;<span class="title">T1</span>, <span class="title">T2</span>&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> List&lt;KeyValuePair&lt;T1, T2&gt;&gt; mList;</span><br><span class="line">    <span class="keyword">private</span> IComparer&lt;T2&gt; mComparer;</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span> mCount;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Heap</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mList = <span class="keyword">new</span> List&lt;KeyValuePair&lt;T1, T2&gt;&gt;();</span><br><span class="line">        mComparer = Comparer&lt;T2&gt;.Default;</span><br><span class="line">        mCount = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Heap</span>(<span class="params">List&lt;KeyValuePair&lt;T1, T2&gt;&gt; list</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        mList = list;</span><br><span class="line">        mCount = list.Count;</span><br><span class="line">        mComparer = Comparer&lt;T2&gt;.Default;</span><br><span class="line">        BuildingHeap();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">int</span> <span class="title">Size</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (mList != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> mCount;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//O(Log(N))</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">RemoveTop</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (mList != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            mList[<span class="number">0</span>] = mList[mCount - <span class="number">1</span>];</span><br><span class="line">            mList.RemoveAt(mCount - <span class="number">1</span>);</span><br><span class="line">            mCount--;</span><br><span class="line">            HeapifyFromBeginningToEnd(<span class="number">0</span>, mCount - <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> KeyValuePair&lt;T1, T2&gt; <span class="title">Top</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (mList != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> mList[<span class="number">0</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//No more member</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> InvalidOperationException(<span class="string">&quot;Empty heap.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">PrintOutAllMember</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">foreach</span> (KeyValuePair&lt;T1, T2&gt; valuepair <span class="keyword">in</span> mList)</span><br><span class="line">        &#123;</span><br><span class="line">            Console.WriteLine(valuepair.ToString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//O(Log(N))</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Insert</span>(<span class="params">KeyValuePair&lt;T1, T2&gt; valuepair</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        mList.Add(valuepair);</span><br><span class="line">        mCount++;</span><br><span class="line">        HeapifyFromEndToBeginning(mCount - <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//调整堆确保堆是最大堆，这里花O(log(n))，跟堆的深度有关</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">HeapifyFromBeginningToEnd</span>(<span class="params"><span class="built_in">int</span> parentindex, <span class="built_in">int</span> length</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">int</span> max_index = parentindex;</span><br><span class="line">        <span class="built_in">int</span> left_child_index = parentindex * <span class="number">2</span> + <span class="number">1</span>;</span><br><span class="line">        <span class="built_in">int</span> right_child_index = parentindex * <span class="number">2</span> + <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Chose biggest one between parent and left&amp;right child</span></span><br><span class="line">        <span class="keyword">if</span> (left_child_index &lt; length &amp;&amp; mComparer.Compare(mList[left_child_index].Value, mList[max_index].Value) &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            max_index = left_child_index;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (right_child_index &lt; length &amp;&amp; mComparer.Compare(mList[right_child_index].Value, mList[max_index].Value) &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            max_index = right_child_index;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//If any child is bigger than parent, </span></span><br><span class="line">        <span class="comment">//then we swap it and do adjust for child again to make sure meet max heap definition</span></span><br><span class="line">        <span class="keyword">if</span> (max_index != parentindex)</span><br><span class="line">        &#123;</span><br><span class="line">            Swap(max_index, parentindex);</span><br><span class="line">            HeapifyFromBeginningToEnd(max_index, length);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//O(log(N))</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">HeapifyFromEndToBeginning</span>(<span class="params"><span class="built_in">int</span> index</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (index &gt;= mCount)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> (index &gt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">int</span> parentindex = (index - <span class="number">1</span>) / <span class="number">2</span>;</span><br><span class="line">            <span class="keyword">if</span> (mComparer.Compare(mList[parentindex].Value, mList[index].Value) &gt; <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                Swap(parentindex, index);</span><br><span class="line">                index = parentindex;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//通过初试数据构建最大堆</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span>/O(N*Log(N))</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">BuildingHeap</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (mList != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">int</span> i = mList.Count / <span class="number">2</span> - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//1.2 Adjust heap</span></span><br><span class="line">                <span class="comment">//Make sure meet max heap definition</span></span><br><span class="line">                <span class="comment">//Max Heap definition:</span></span><br><span class="line">                <span class="comment">// (k(i) &gt;= k(2i) &amp;&amp; k(i) &gt;= k(2i+1))   (1 &lt;= i &lt;= n/2)</span></span><br><span class="line">                HeapifyFromBeginningToEnd(i, mList.Count);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span>/O(N*log(N))</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">HeapSort</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (mList != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//Steps:</span></span><br><span class="line">            <span class="comment">// 1. Build heap</span></span><br><span class="line">            <span class="comment">// 1.1 Init heap</span></span><br><span class="line">            <span class="comment">// 1.2 Adjust heap</span></span><br><span class="line">            <span class="comment">// 2. Sort heap</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">//1. Build max heap</span></span><br><span class="line">            <span class="comment">// 1.1 Init heap</span></span><br><span class="line">            <span class="comment">//Assume we construct max heap</span></span><br><span class="line">            BuildingHeap();</span><br><span class="line">            <span class="comment">//2. Sort heap</span></span><br><span class="line">            <span class="comment">//这里花O(n)，跟数据数量有关</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">int</span> i = mList.Count - <span class="number">1</span>; i &gt; <span class="number">0</span>; i--)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//swap first element and last element</span></span><br><span class="line">                <span class="comment">//do adjust heap process again to make sure the new array are still max heap</span></span><br><span class="line">                Swap(i, <span class="number">0</span>);</span><br><span class="line">                <span class="comment">//Due to we already building max heap before,</span></span><br><span class="line">                <span class="comment">//so  we just need to adjust for index 0 after we swap first and last element</span></span><br><span class="line">                HeapifyFromBeginningToEnd(<span class="number">0</span>, i);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            Console.Write(<span class="string">&quot;mList == null&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Swap</span>(<span class="params"><span class="built_in">int</span> id1, <span class="built_in">int</span> id2</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        KeyValuePair&lt;T1, T2&gt; temp;</span><br><span class="line">        temp = mList[id1];</span><br><span class="line">        mList[id1] = mList[id2];</span><br><span class="line">        mList[id2] = temp;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] <span class="keyword">args</span></span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    List&lt;KeyValuePair&lt;<span class="built_in">int</span>, <span class="built_in">float</span>&gt;&gt; list = <span class="keyword">new</span> List&lt;KeyValuePair&lt;<span class="built_in">int</span>, <span class="built_in">float</span>&gt;&gt;();</span><br><span class="line">    list.Add(<span class="keyword">new</span> KeyValuePair&lt;<span class="built_in">int</span>, <span class="built_in">float</span>&gt;(<span class="number">3</span>, <span class="number">1.0f</span>));</span><br><span class="line">    list.Add(<span class="keyword">new</span> KeyValuePair&lt;<span class="built_in">int</span>, <span class="built_in">float</span>&gt;(<span class="number">2</span>, <span class="number">5.0f</span>));</span><br><span class="line">    list.Add(<span class="keyword">new</span> KeyValuePair&lt;<span class="built_in">int</span>, <span class="built_in">float</span>&gt;(<span class="number">1</span>, <span class="number">3.0f</span>));</span><br><span class="line">    list.Add(<span class="keyword">new</span> KeyValuePair&lt;<span class="built_in">int</span>, <span class="built_in">float</span>&gt;(<span class="number">6</span>, <span class="number">4.0f</span>));</span><br><span class="line">    list.Add(<span class="keyword">new</span> KeyValuePair&lt;<span class="built_in">int</span>, <span class="built_in">float</span>&gt;(<span class="number">5</span>, <span class="number">2.0f</span>));</span><br><span class="line">    list.Add(<span class="keyword">new</span> KeyValuePair&lt;<span class="built_in">int</span>, <span class="built_in">float</span>&gt;(<span class="number">4</span>, <span class="number">6.0f</span>));</span><br><span class="line"></span><br><span class="line">    Heap&lt;<span class="built_in">int</span>,<span class="built_in">float</span>&gt; heap = <span class="keyword">new</span> Heap&lt;<span class="built_in">int</span>,<span class="built_in">float</span>&gt;(list);</span><br><span class="line"></span><br><span class="line">    PriorityQueue&lt;<span class="built_in">int</span>,<span class="built_in">float</span>&gt; pq = <span class="keyword">new</span> PriorityQueue&lt;<span class="built_in">int</span>,<span class="built_in">float</span>&gt;(heap);</span><br><span class="line"></span><br><span class="line">    pq.PrintOutAllMember();</span><br><span class="line"></span><br><span class="line">    Console.WriteLine(<span class="string">&quot;------------------------pq.Push(new KeyValuePair&lt;int, float&gt;(0, 0.0f));&quot;</span>);</span><br><span class="line"></span><br><span class="line">    pq.Push(<span class="keyword">new</span> KeyValuePair&lt;<span class="built_in">int</span>, <span class="built_in">float</span>&gt;(<span class="number">0</span>, <span class="number">0.0f</span>));</span><br><span class="line"></span><br><span class="line">    pq.PrintOutAllMember();</span><br><span class="line"></span><br><span class="line">    Console.WriteLine(<span class="string">&quot;------------------------pq.Pop();&quot;</span>);</span><br><span class="line"></span><br><span class="line">    pq.Pop();</span><br><span class="line"></span><br><span class="line">    pq.PrintOutAllMember();</span><br><span class="line"></span><br><span class="line">    Console.WriteLine(<span class="string">&quot;------------------------pq.Top();&quot;</span>);</span><br><span class="line"></span><br><span class="line">    Console.WriteLine(pq.Top().ToString());</span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">    Console.ReadKey();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Output:<br><img src="/img/CSharp/PriorityQueue_Study.PNG" alt="PriorityQueue_Study"></p>
<p>堆排序构造有序堆的时间复杂度是O(N * Log(N))<br>但插入和移除操作都是O(Log(N))</p>
<p><a href="http://tonytang1990.github.io/2015/07/11/Sort-Algorithm/">排序算法参考</a></p>
<h3 id="Method"><a href="#Method" class="headerlink" title="Method"></a>Method</h3><p>关于Method这里主要讲两点：</p>
<ol>
<li>Extension Methods<br>“It allows you to define a static method that you can invoke using instance method syntax.”(Extension Methods最主要的好处就在于当你无法给特定类或结构定义方法的时候，你可以通过定义extension method来为该类或结构添加方法，使用的时候就跟在类里定义方法一样，通过实例就能调用。)<br>定义Extension Method首先必须定义在一个静态类里，且方法为静态方法，并且第一个参数类型前要加this关键词，this后面跟的就是我们要extension的类。</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">StringBuilderExtensions</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Int32 <span class="title">Indexof</span>(<span class="params"><span class="keyword">this</span> StringBuilder sb, Char <span class="keyword">value</span></span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (Int32 index = <span class="number">0</span>; index &lt; sb.Length; index++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (sb[index] == <span class="keyword">value</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> index;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] <span class="keyword">args</span></span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    StringBuilder sb = <span class="keyword">new</span> StringBuilder(<span class="string">&quot;Hello. My name is Tony.&quot;</span>);</span><br><span class="line">    Int32 index = sb.Indexof(<span class="string">&#x27;T&#x27;</span>);</span><br><span class="line">    Console.WriteLine(<span class="string">&quot;sb.Indexof(&#x27;T&#x27;) = &quot;</span> + index);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Output:<br><img src="/img/CSharp/ExtensionMethods.PNG" alt="ExtensionMethods"><br>调用Extension method跟Compiler如何去寻找方法编译有关，具体见《CLR via C#》 – Methods的Extension Methods章节<br>定义Extension Methods需要注意一下几点：<br>    1. 只能定义在非模板静态类里。<br>    2. 定义Extension Methods的类必须位于file scope(不能被其他类包含)<br>    3. 必须包含添加Extension Methods的类的namespace(为了避免检查所有文件去找extension methods)<br>    4. Extension Methods应该少用，会造成versioning problem(未来可能添加相同方法到类里，不同版本的调用会出现不同的表现)。<br>2. Partial Methods<br>首先得知道我们为什么需要Partial Methods？<br>    1. Override去重写virtual方法的时候要求父类不能是Sealed，不能为sealed class或value type重写方法<br>    2. 无需为了重写个别方法而单独定义一个类<br>使用Partial Methods在partial class里定义partial方法前加partial关键字</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">internal</span> <span class="keyword">sealed</span> <span class="keyword">partial</span> <span class="keyword">class</span> <span class="title">Base</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> String Name</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> mName;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">set</span></span><br><span class="line">        &#123;</span><br><span class="line">            OnNameChanging(<span class="keyword">value</span>.ToUpper());</span><br><span class="line">            mName = <span class="keyword">value</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> String mName;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//This defining-partial-method-declaration is called before changing the mName field</span></span><br><span class="line">    <span class="function"><span class="keyword">partial</span> <span class="keyword">void</span> <span class="title">OnNameChanging</span>(<span class="params">String <span class="keyword">value</span></span>)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">internal</span> <span class="keyword">sealed</span> <span class="keyword">partial</span> <span class="keyword">class</span> <span class="title">Base</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">partial</span> <span class="keyword">void</span> <span class="title">OnNameChanging</span>(<span class="params"><span class="built_in">string</span> <span class="keyword">value</span></span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;Base::OnNameChanging(&#123;0&#125;)&quot;</span>, <span class="keyword">value</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] <span class="keyword">args</span></span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    Base bs = <span class="keyword">new</span> Base();</span><br><span class="line">    bs.Name = <span class="string">&quot;Tony&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Output:<br><img src="/img/CSharp/PartialMethods.PNG" alt="PartialMethods"><br>使用Partial Methods需要注意以下几点：<br>    1. 只能在Partial class or Struct里定义<br>    2. Partial Method必须返回void，并且不能有parameter有out关键词修饰<br>    3. Partial Method必须和原方法签名一样<br>    4. 如果Partial Method没有实现，Delegate不能指向该partial method<br>    5. Partial Methods永远是private的</p>
<h3 id="Comparasion"><a href="#Comparasion" class="headerlink" title="Comparasion"></a>Comparasion</h3><ol>
<li><p>Type comparasion<br>System.Object.GetType()<br>&amp;&amp;<br>typeof()<br>&amp;&amp;<br>is operator – is specific type or type can be cast</p>
<ol>
<li>boxing – cast value type into System.Object type(shollow copy) or interface type that is implemented by value type</li>
<li>unboxing – boxing reverse process</li>
</ol>
</li>
<li><p>Value comparasion<br>operator overloading – must be static<br>IComparable – compare object’s data with the same type<br>&amp;&amp;<br>IComparer – compare two object with different type or the same type</p>
</li>
</ol>
<h3 id="Conversion"><a href="#Conversion" class="headerlink" title="Conversion"></a>Conversion</h3><p>Conversion operator<br>implici<br>explicit<br>e.g.</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title">A</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">implicit</span> <span class="keyword">operator</span> <span class="title">B</span>(<span class="params">A a</span>)</span></span><br><span class="line">	&#123;</span><br><span class="line">		......</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title">B</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">explicit</span> <span class="keyword">operator</span> <span class="title">A</span>(<span class="params">B b</span>)</span></span><br><span class="line">	&#123;</span><br><span class="line">		......</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>as operator<br><operand> as <type><br>Suit case</p>
<ol>
<li>operand type is type</li>
<li>operand type can be casted into type implicitly</li>
<li>operand can be boxing into type</li>
</ol>
<h3 id="Generics"><a href="#Generics" class="headerlink" title="Generics"></a>Generics</h3><p>C++里是template实现<br>System.Collections.Generic<br>value type can not be initilized with null<br>Problem</p>
<ol>
<li>null (value type or reference type)<ol>
<li>default key word – if it is reference type, initilized with null. otherwise use default value</li>
</ol>
</li>
<li>type<ol>
<li>constraining<br> where key words<br> e.g.<br> class A<T>: where T:B 9( T must inherite from B)</li>
</ol>
</li>
</ol>
<p>Code e.g.</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">CSharpStudy</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//Can not instantiation with int when where T1 : class </span></span><br><span class="line">        <span class="comment">//public class GenericClass&lt;T1&gt; where T1 : class</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">GenericClass</span>&lt;<span class="title">T1</span>&gt; : <span class="title">IEnumerable</span>&lt;<span class="title">T1</span>&gt; <span class="keyword">where</span> <span class="title">T1</span> : <span class="title">struct</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">private</span> List&lt;T1&gt; m_Member = <span class="keyword">new</span> List&lt;T1&gt;();</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="title">GenericClass</span>()</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//use T1&#x27;s default value</span></span><br><span class="line">                <span class="comment">//m_Member.Add(default(T1));</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="title">List</span>&lt;<span class="title">T1</span>&gt; GetMember</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">get</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">return</span> m_Member;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="title">IEnumerator</span>&lt;<span class="title">T1</span>&gt; <span class="title">GetEnumerator</span>()</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> m_Member.GetEnumerator();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            IEnumerator IEnumerable.GetEnumerator()</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> m_Member.GetEnumerator();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">implicit</span> <span class="keyword">operator</span> <span class="title">List</span>&lt;<span class="title">T1</span>&gt;(<span class="params">GenericClass&lt;T1&gt; gc</span>)</span></span><br><span class="line">            &#123;</span><br><span class="line">                List&lt;T1&gt; result = <span class="keyword">new</span> List&lt;T1&gt;();</span><br><span class="line">                <span class="keyword">foreach</span> (T1 i <span class="keyword">in</span> gc)</span><br><span class="line">                &#123;</span><br><span class="line">                    result.Add(i);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> result;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">static</span> GenericClass&lt;T1&gt; <span class="keyword">operator</span> +(GenericClass&lt;T1&gt; gc, List&lt;T1&gt; l)</span><br><span class="line">            &#123;</span><br><span class="line">                GenericClass&lt;T1&gt; result = <span class="keyword">new</span> GenericClass&lt;T1&gt;();</span><br><span class="line">                <span class="keyword">foreach</span> (T1 m <span class="keyword">in</span> gc)</span><br><span class="line">                &#123;</span><br><span class="line">                    result.GetMember.Add(m);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">foreach</span> (T1 m <span class="keyword">in</span> l)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">if</span> (!result.GetMember.Contains(m))</span><br><span class="line">                    &#123;</span><br><span class="line">                        result.GetMember.Add(m);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> result;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] <span class="keyword">args</span></span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">           <span class="comment">//Nullable problem, </span></span><br><span class="line">           <span class="comment">//value type can not be initiated with null</span></span><br><span class="line">           <span class="comment">//int normalint = null;</span></span><br><span class="line">           System.Nullable&lt;<span class="built_in">int</span>&gt; nullableint = <span class="literal">null</span>;</span><br><span class="line">           <span class="comment">//nullable</span></span><br><span class="line">           <span class="built_in">int</span>? nullalbleint = <span class="literal">null</span>;</span><br><span class="line">           <span class="built_in">int</span>? result = nullalbleint ?? <span class="number">5</span>;</span><br><span class="line">           Console.WriteLine(<span class="string">&quot;result = &quot;</span> + result);</span><br><span class="line">           List&lt;<span class="built_in">int</span>&gt; list = <span class="keyword">new</span> List&lt;<span class="built_in">int</span>&gt;(<span class="number">2</span>);</span><br><span class="line">           list.Add(<span class="number">1</span>);</span><br><span class="line">           list.Add(<span class="number">2</span>);</span><br><span class="line">           <span class="keyword">foreach</span> (<span class="built_in">int</span> i <span class="keyword">in</span> list)</span><br><span class="line">           &#123;</span><br><span class="line">               Console.WriteLine(<span class="string">&quot;list value = &quot;</span> + i);</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           GenericClass&lt;<span class="built_in">int</span>&gt; gc = <span class="keyword">new</span> GenericClass&lt;<span class="built_in">int</span>&gt;();</span><br><span class="line">           Console.WriteLine(<span class="string">&quot;gc.m_Member = &quot;</span> + gc.GetMember);</span><br><span class="line"></span><br><span class="line">           GenericClass&lt;<span class="built_in">int</span>&gt; gc2 = <span class="keyword">new</span> GenericClass&lt;<span class="built_in">int</span>&gt;();</span><br><span class="line">           gc2.GetMember.Add(<span class="number">11</span>);</span><br><span class="line">           gc2.GetMember.Add(<span class="number">111</span>);</span><br><span class="line">           GenericClass&lt;<span class="built_in">int</span>&gt; gc3 = <span class="keyword">new</span> GenericClass&lt;<span class="built_in">int</span>&gt;();</span><br><span class="line">           gc3.GetMember.Add(<span class="number">11</span>);</span><br><span class="line">           gc3.GetMember.Add(<span class="number">22</span>);</span><br><span class="line">           gc3.GetMember.Add(<span class="number">222</span>);</span><br><span class="line"></span><br><span class="line">           gc = gc2 + gc3;</span><br><span class="line">           <span class="keyword">foreach</span> (<span class="built_in">int</span> i <span class="keyword">in</span> gc)</span><br><span class="line">           &#123;</span><br><span class="line">               Console.WriteLine(<span class="string">&quot;gc member = &quot;</span> + i);</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           Console.ReadKey();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Output:<br><img src="/img/CSharp/Generic.PNG" alt="Generic"></p>
<p>Variance (变体)</p>
<ol>
<li>Convariance – 协变 out key word<br>主要用于Interface和delegate的返回类型或者参数类型的隐士转换（子类到父类）</li>
<li>Contravariance – 抗变 int key word<br>与协变相反（父类到子类）<br>Code e.g.</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Covariance</span></span><br><span class="line">   <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ListAnimals</span>(<span class="params">IEnumerable&lt;Animal&gt; animals</span>)</span></span><br><span class="line">   &#123;</span><br><span class="line">       <span class="keyword">foreach</span> (Animal animal <span class="keyword">in</span> animals)</span><br><span class="line">       &#123;</span><br><span class="line">          Console.WriteLine(animal.ToString());</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">FeeAnimal</span>(<span class="params">Func&lt;Animal&gt; animalCreator</span>)</span></span><br><span class="line">   &#123;</span><br><span class="line">       <span class="keyword">var</span> animal = animalCreator();</span><br><span class="line">       Console.WriteLine(<span class="string">&quot;animal.name = &quot;</span> + animal.Name);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">FeeAnimal</span>(<span class="params">Func&lt;Cow&gt; animalCreator</span>)</span></span><br><span class="line">   &#123;</span><br><span class="line">       <span class="keyword">var</span> animal = animalCreator();</span><br><span class="line">       Console.WriteLine(<span class="string">&quot;animal.name = &quot;</span> + animal.Name);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">static</span> Cow <span class="title">CreateCow</span>()</span></span><br><span class="line">   &#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">new</span> Cow(<span class="string">&quot;DelegateCow&quot;</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">//Contravariance</span></span><br><span class="line">   <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">FeeAnimal</span>(<span class="params">Animal animal</span>)</span></span><br><span class="line">   &#123;</span><br><span class="line">       Console.WriteLine(<span class="string">&quot;FeeAnimal:&quot;</span> + animal.Name);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Execute</span>(<span class="params">Action&lt;Cow&gt; cact</span>)</span></span><br><span class="line">   &#123;</span><br><span class="line">       cact(<span class="keyword">new</span> Cow(<span class="string">&quot;ExecuteCow&quot;</span>));</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">//Covariance</span></span><br><span class="line">   List&lt;Cow&gt; cows = <span class="keyword">new</span> List&lt;Cow&gt;();</span><br><span class="line">   cows.Add(<span class="keyword">new</span> Cow(<span class="string">&quot;Cow1&quot;</span>));</span><br><span class="line">   ListAnimals(cows);</span><br><span class="line"></span><br><span class="line">   FeeAnimal(CreateCow);</span><br><span class="line">   Func&lt;Cow&gt; cFunc = CreateCow;</span><br><span class="line">   Func&lt;Animal&gt; aFunc = cFunc;</span><br><span class="line"></span><br><span class="line">   <span class="comment">//Contravariance</span></span><br><span class="line">   Action&lt;Animal&gt; aAct = FeeAnimal;</span><br><span class="line">   Action&lt;Cow&gt; cAct = aAct;</span><br><span class="line"></span><br><span class="line">   Execute(aAct);</span><br></pre></td></tr></table></figure>
<p>Output:<br><img src="/img/CSharp/Variance_Contravariance.PNG" alt="Variance_Contravariance"></p>
<p>Note:<br>C++是通过编译器检测出模板使用的特定类型<br>C#是运行时进行</p>
<h3 id="Hosting-AppDomain-Assembly-Reflection"><a href="#Hosting-AppDomain-Assembly-Reflection" class="headerlink" title="Hosting, AppDomain, Assembly, Reflection"></a>Hosting, AppDomain, Assembly, Reflection</h3><p>这一章节主要是学习关于Assembly Loading和Reflection技术。<br>在学习Assembly Loading和Reflection之前，我们需要了解Hosting，AppDomain的概念。</p>
<h4 id="Hosting"><a href="#Hosting" class="headerlink" title="Hosting"></a>Hosting</h4><p>以下英文内容来至《CLR via C#》<br>Hosting allows any application to use the features of the common language runtime(CLR). Furthermore, hosting allows applications the ability to offer customization and extensibility via programming.<br>Extensibility means that third-party code will be running inside your process.</p>
<p>The hosting application can call methods defined by ICLRMetaHost interface to:</p>
<ol>
<li>Set Host managers. Tell the CLR that the host wants to be involved in making decisions related to memory allocations, thread scheduling&#x2F;synchronization, assembly loading, and more. The host can also state that it wants notifications of garbage collection starts and stops and when certain operations time out.</li>
<li>Get CLR managers. Tell the CLR to prevent the use of some classes&#x2F;members. In addition, the host can tell which code can and can’t be debugged and which methods in the host should be called when a special event—such as an AppDomain unload, CLR stop, or stack overflow exception—occurs.</li>
<li>Initialize and start the CLR.</li>
<li>Load an assembly and execute code in it.</li>
<li>Stop the CLR, thus preventing any more managed code from running in the Windows process.</li>
</ol>
<p>Hosting(allows any application to offer CLR features) Benifits:</p>
<ol>
<li>Programming can be done in any programming language.</li>
<li>Code is just-in-time (JIT)–compiled for speed (versus being interpreted).</li>
<li>Code uses garbage collection to avoid memory leaks and corruption.</li>
<li>Code runs in a secure sandbox.</li>
<li>The host doesn’t need to worry about providing a rich development environment. The<br>host makes use of existing technologies: languages, compilers, editors, debuggers, profilers, and more.<br>从上面所有内容可以看出Hosting可以让我们去利用CLR的特性，我们而已通过Host去设定很多CLR相关的设定(比如GC,Memory Manager……)，初始化CLR，创建出默认的AppDomain，通过CLR去加载Assemly到AppDomain然后执行。</li>
</ol>
<h4 id="AppDomain"><a href="#AppDomain" class="headerlink" title="AppDomain"></a>AppDomain</h4><p>AppDomain allows third-party untrusted code to run in an existing proceess, and the CLR guarantees that the data structures, code, and security context will not be exploited or compromised.(AppDomain允许不可信的代码在当前进程执行，CLR会去确保数据结构，代码等安全问题)<br>AppDomain和CLR的关系：<br>“AppDomains are a CLR feature.”</p>
<p>“When the CLR COM server initializes, it creates an AppDomain. An AppDomain is a logical container for a set of assemblies. The first AppDomain created when the CLR is initialized is called the default AppDomain; this AppDomain is destroyed only when the Windows process terminates.”(AppDomain是一个assemblies集合的容器，当CLR初始化的时候会创建默认的AppDOmain,这个AppDomain只能在程序结束的时候被终止)</p>
<p>The whole purpose of an AppDomain is to provide isolation. Here are the specific features offered by an AppDomain(AppDomain的主要目的是为了实现程序隔离):</p>
<ol>
<li>Objects created by code in one AppDomain cannot be accessed directly by code in another AppDomain When(确保不同AppDomain里的Object不会被其他AppDomain访问)</li>
<li>AppDomains can be unloaded(AppDomain可以被unload)</li>
<li>AppDomains can be individually secured(通过设定AppDomain的permission用于确保assembly的一些权限)</li>
<li>AppDomains can be individually configured(设置AppDomian的配置，影响如何去加载Assemlies等)</li>
</ol>
<p>这里提到AppDomain的程序隔离功能，那就不得不说一下Process了。<br>“Process isolation prevents security holes, data corruption, and other<br>unpredictable behaviors from occurring, making Windows and the applications running<br>on it robust.”<br>这里Process可以理解为进程面上的程序隔离，而AppDomain可以理解为进程内的程序隔离(一个进程可以创建多个AppDomain)<br>让我们看一下程序是如何在Process,AppDomain还有CLR下工作的:<br><img src="/img/CSharp/CLRAppDomainProcessRelationship.PNG" alt="CLRAppDomainProcessRelationship"><br>可以看出一个Process下创建了多个AppDomain，每一个AppDomain加载了特定的Assembly，每一个AppDomain有自己的LoaderHeap，每一个LoaderHeap记录了该AppDomain所访问过的type，当调用type的method的时候，IL code会被JIT运行时编译到对应的机器代码执行。<br>普通的AppDomain之间的Assembly是完全隔离的，所以就算多个AppDomain引用了同一个Assembly，他们也不会共享数据和内存。<br>但上图有一个比较特殊的AppDomain，叫做Domain-Neutrl Assemblies。<br>这个Domain的主要目的是共享一些通用的Assemblys，加载在这个AppDomian下的Assemblys可以被所有的AppDomains访问。<br>虽然Assembly在AppDomain之间是完全隔离的，但不同AppDomain创建的objects还是可以相互访问的。<br>让我们看看不同AppDomain创建的objeccts如何相互访问的：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Reflection;</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System.Runtime.InteropServices;</span><br><span class="line"><span class="keyword">using</span> System.Threading;</span><br><span class="line"><span class="keyword">using</span> System.Runtime;</span><br><span class="line"><span class="keyword">using</span> System.Runtime.Remoting;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">CSharpDeepStudy</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">    &#123;</span><br><span class="line">         <span class="meta">#<span class="keyword">region</span> Hosting and AppDomain Study</span></span><br><span class="line">        <span class="comment">// Instances can be marshaled-by-reference across AppDomain boundaries</span></span><br><span class="line">        [<span class="meta">Serializable</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">sealed</span> <span class="keyword">class</span> <span class="title">MarshalByRefType</span> : <span class="title">MarshalByRefObject</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="title">MarshalByRefType</span>()</span></span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine(<span class="string">&quot;&#123;0&#125; ctor running in &#123;1&#125;&quot;</span>, <span class="keyword">this</span>.GetType().ToString(), Thread.GetDomain().FriendlyName);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SomeMethod</span>()</span></span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine(<span class="string">&quot;Executing in &quot;</span> + Thread.GetDomain().FriendlyName);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="keyword">public</span> MarshalByValType <span class="title">MethodWithReturn</span>()</span></span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine(<span class="string">&quot;Executing in &quot;</span> + Thread.GetDomain().FriendlyName);</span><br><span class="line">                MarshalByValType t = <span class="keyword">new</span> MarshalByValType();</span><br><span class="line">                <span class="keyword">return</span> t;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="keyword">public</span> NonMarshalableType <span class="title">MethodArgAndReturn</span>(<span class="params">String callingdomainname</span>)</span></span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine(<span class="string">&quot;Calling from &#123;0&#125; to &#123;1&#125;&quot;</span>, callingdomainname, Thread.GetDomain().FriendlyName);</span><br><span class="line">                NonMarshalableType t = <span class="keyword">new</span> NonMarshalableType();</span><br><span class="line">                <span class="keyword">return</span> t;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Instances can be marshaled-by-value across AppDomain boundaries</span></span><br><span class="line">        [<span class="meta">Serializable</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">sealed</span> <span class="keyword">class</span> <span class="title">MarshalByValType</span> : <span class="title">Object</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">private</span> DateTime m_CreationTime = DateTime.Now;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="title">MarshalByValType</span>()</span></span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine(<span class="string">&quot;&#123;0&#125; ctor running in &#123;1&#125;, Created on &#123;2:D&#125;&quot;</span>, <span class="keyword">this</span>.GetType().ToString(), Thread.GetDomain().FriendlyName, m_CreationTime);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> String <span class="title">ToString</span>()</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> m_CreationTime.ToLongDateString();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Instances cannot be marshaled across AppDomain boundaries</span></span><br><span class="line">        <span class="comment">// [Serializable]</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">sealed</span> <span class="keyword">class</span> <span class="title">NonMarshalableType</span> : <span class="title">Object</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="title">NonMarshalableType</span>()</span></span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine(<span class="string">&quot;Excuting in &quot;</span> + Thread.GetDomain().FriendlyName);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Marshalling</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//Obtain current thread AppDomain</span></span><br><span class="line">            AppDomain currentthreadappdomian = Thread.GetDomain();</span><br><span class="line">            String callingdomainname = currentthreadappdomian.FriendlyName;</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;currentthreadappdomian.name = &quot;</span> + callingdomainname);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//Get the assembly that contains the main method</span></span><br><span class="line">            Assembly mainassembly = Assembly.GetEntryAssembly();</span><br><span class="line">            String exeassembly = mainassembly.FullName;</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;Assembly&#x27;s that contains main method name is &quot;</span> + exeassembly);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//Accessing Objects Across AppDomain Boundaries</span></span><br><span class="line">            <span class="comment">//Cross-AppDomain Communication using marshal-by-reference</span></span><br><span class="line">            AppDomain ad2 = <span class="literal">null</span>;</span><br><span class="line">            ad2 = AppDomain.CreateDomain(<span class="string">&quot;AD2&quot;</span>, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">            MarshalByRefType mbrt = <span class="literal">null</span>;</span><br><span class="line">            mbrt = (MarshalByRefType)ad2.CreateInstanceAndUnwrap(exeassembly, <span class="keyword">typeof</span>(MarshalByRefType).FullName);</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;Type = &#123;0&#125;&quot;</span>, mbrt.GetType());</span><br><span class="line">            <span class="comment">//Prove that we got a reference to a proxy object</span></span><br><span class="line">            Console.WriteLine(<span class="string">&quot;Is proxy = &#123;0&#125;&quot;</span>, RemotingServices.IsTransparentProxy(mbrt));</span><br><span class="line">            <span class="comment">//Call method in the AppDomain owning the objects</span></span><br><span class="line">            mbrt.SomeMethod();</span><br><span class="line">            <span class="comment">//Unload the new AppDomian</span></span><br><span class="line">            AppDomain.Unload(ad2);</span><br><span class="line">            <span class="comment">//try access mbrt after we unload AppDomain it owned</span></span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                mbrt.SomeMethod();</span><br><span class="line">                Console.WriteLine(<span class="string">&quot;Successful call SomeMehtod()&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (AppDomainUnloadedException)</span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine(<span class="string">&quot;Failed call SomeMethod()&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//Cross-AppDomain Communication using Marshal-by-value</span></span><br><span class="line">            <span class="comment">//Create new AppDomain</span></span><br><span class="line">            ad2 = AppDomain.CreateDomain(<span class="string">&quot;AD3&quot;</span>, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">            mbrt = (MarshalByRefType)ad2.CreateInstanceAndUnwrap(exeassembly, <span class="keyword">typeof</span>(MarshalByRefType).FullName);</span><br><span class="line"></span><br><span class="line">            MarshalByValType mbvt = mbrt.MethodWithReturn();</span><br><span class="line">            <span class="comment">//Prove that we did NOT get a reference to a proxy object</span></span><br><span class="line">            Console.WriteLine(<span class="string">&quot;Is Proxy=&#123;0&#125;&quot;</span>, RemotingServices.IsTransparentProxy(mbvt));</span><br><span class="line">            <span class="comment">//Try call method on real object</span></span><br><span class="line">            Console.WriteLine(<span class="string">&quot;Returned object created &quot;</span> + mbvt.ToString());</span><br><span class="line">            <span class="comment">//Unload AppDomain again</span></span><br><span class="line">            AppDomain.Unload(ad2);</span><br><span class="line">            <span class="comment">//try access method on real object again</span></span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine(<span class="string">&quot;Returned object created &quot;</span> + mbvt.ToString());</span><br><span class="line">                Console.WriteLine(<span class="string">&quot;Successful call.&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (AppDomainUnloadedException)</span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine(<span class="string">&quot;Failed call.&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//Cross-AppDomain Communication Using non-marshalable type</span></span><br><span class="line">            ad2 = AppDomain.CreateDomain(<span class="string">&quot;AD4&quot;</span>, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">            <span class="comment">//Load assembly into the new AppDoamin</span></span><br><span class="line">            mbrt = (MarshalByRefType)ad2.CreateInstanceAndUnwrap(exeassembly, <span class="keyword">typeof</span>(MarshalByRefType).FullName);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//call the object method to get non-marshalable object</span></span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                NonMarshalableType nmt = mbrt.MethodArgAndReturn(callingdomainname);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (System.Exception e)</span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine(e.ToString());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] <span class="keyword">args</span></span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="meta">#<span class="keyword">region</span> Hosting and AppDomain Study</span></span><br><span class="line">            Marshalling();</span><br><span class="line">            <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">            Console.ReadKey();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/img/CSharp/CrossAppDomainCommunicationOutPut.PNG" alt="CrossAppDomainCommunicationOutPut"><br>上面的测试主要是针对下面三种情况：</p>
<ol>
<li>Cross-AppDomain Communication Using Marshal-by-Reference<br>从上面可以看出当我们Marshal-by-Reference between AppDomain的时候，我们需要继承至MarshalByRefObject。(通过RemotingServices.IsTransparentProxy检查是否是Proxy)<br>底层是通过在Destination AppDomain生成的Proxy Type信息，其中还生成了instane fields去记录了哪一个AppDomain真正拥有这个type，如何在该AppDomain下找到这个real object去实现Reference的。<br>这样就说得通当我们关掉创建Prox Type的AppDomain后，再次通过Prox Type调用就无法通过了，因为通过调用AppDomain.Unload(),所有在该AppDomain里的assemblies和通过assemblies里的信息创建的对象都被释放回收了。<br>Note:<br>“although you can access fields of a type derived from MarshalByRefObject, the performance is particularly bad because the CLR really ends up calling methods to perform the field access.”</li>
<li>Cross-AppDomain Communication Using Marshal-by-Value<br>当我们Marshal-by-Value时不需要继承至MarshalByRefObject，但需要确保MarshalByValType是[Serializable]的。<br>因为底层实现是通过序列化和反序列化实现Destination AppDomain加载并生成对应type信息。</li>
<li>Cross-AppDomain Communication Using Non-Marshalable Types<br>最后一个是因为我们采用Marshal-by-Value但却没有把NonMarshalableType设置成[Serializable]导致在Serialize NonMarshalableType到Destination AppDomain的时候抛异常。<br>针对AppDomain问题我没有深入学习，如有不对之处欢迎指出，详情请参考《CLR via C#》<br>Hosting,CLR,AppDomain,Process,Assemly关系作用总结：<br>Hosting使我们可以去利用CLR的特性，通过Host可以设定很多CLR相关的设定(比如GC,Memory Manager……)。<br>当CLR初始化完成后，会创建出默认的AppDomain。<br>通过CLR去加载Assemly到AppDomain然后执行。<br>一个Process可以有多个AppDomian。<br>每个AppDomain有自己的Loader Heap去记录加载到AppDomain里的Type信息。<br>当调用Type的method的时候，IL code会被JIT运行时编译到对应的机器代码执行。<br>普通的AppDomain之间的Assembly是完全隔离的，所以就算多个AppDomain引用了同一个Assembly，他们也不会共享数据和内存。<br>但加载在这个Domain-Neutrl Assemblies AppDomian下的Assemblys可以被所有的AppDomains访问。<br>虽然Assembly在AppDomain之间是完全隔离的，但不同AppDomain创建的objects还是可以通过Marshal-by-Value和Marshal-by-Reference方式相互访问的。<br>关于AppDomain的更多内容参考《CLR via C#》 – CLR Hosting and AppDomains章节(e.g. AppDomain Monitoring, How Hosts Use AppDomians……)<br>Note:<br>在Windows上默认的AppDomain的名字是是***.exe(执行的程序)</li>
</ol>
<p>了解了AppDomain的基本概念，接下来让我们看看关于Assembly Loading:</p>
<h4 id="Assembly-Loading"><a href="#Assembly-Loading" class="headerlink" title="Assembly Loading"></a>Assembly Loading</h4><p>Assembly是一个包含类型信息，方法信息，成员信息，程序名称，版本号，自我描述，文件关联关系和文件位置等信息的一个集合。<br>System.Reflection.Assembly.Load – 加载Assembly到AppDomain。(相比System.AppDomain.Load, Prefer use System.Reflection.Assembly)<br>System.Reflection.Assembly.LoadFrom – 加载指定路径的Assembly到AppDomain，这里也可以指定URL<br>System.Reflection.Assembly.ReflectionOnlyLoad or ReflectionOnlyLoadFrom – 确保只加载Assembly不会去执行里面的任何代码(只用于获取Assembly里的一些相关信息)。用这两个方法需要注册AppDomain’s ReflectionOnlyAssemblyResolve<br>event去手动加载索引的assemblies<br>既然我们知道了如何加载Assembly，也知道了Assembly包含了我们程序去创建实例所需要的所有信息，那么我们如何动态的使用Assembly里的信息去创建实例了，答案是反射。<br>System.Reflection给我们提供了很多方法可以去访问Assembly里的fields，methods，properties等信息。<br>通过这些信息，我们可以制作像ILDasm.exe这样的反编译工具，因为通过有些类我们可以得到方法的IL指令数据。<br>这也就是我们为什么能通过System.Reflection.Emit去动态创建类的原因(使用IL指令反向构建方法，类等)。参见<a href="http://tonytang1990.github.io/2015/07/15/Unity-Study/#AOT_&_JIT">AOT &amp; JIT</a><br>那么接下来让我们看看Reflection：</p>
<h4 id="Reflection"><a href="#Reflection" class="headerlink" title="Reflection"></a>Reflection</h4><p>这里不得不提一个Reflection使用的典型案列，那就是Serialization，序列化反序列是通过reflection去获取类型信息去存储和构建实例的。<br>具体关于Serialization后续后讲到。<br>反射最强大的地方就在于可以在运行时动态创建和使用一些类型，但这些类型我们在编译时期是不可知的。<br>但缺点如下：</p>
<ol>
<li>Reflection prevents type safety at compile time(因为是运行时才动态创建，所以编译时期就无法确保类型安全)</li>
<li>Reflection is slow(反射很慢，因为我们需要在运行时动态去获取类型信息去动态创建)<br>反射慢的主要原因就在于运行时去访问获取类型信息，所以我们应该尽可能的使用在编译时期就能知道类型信息的方式。<br>比如：<br>通过实现一个继承至父类或接口的类，通过多态的方式去调用方法。(编译时期就知道该调用哪个方法)<br>那么接下来让我们看看如何使用反射去访问类型信息并调用里面的方法。<br>首先我们看看如何去获取Assembly里的一些类型信息：<br>首先我们创建一个只包含了几个类信息的dll</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line">......</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">CSharpDLL</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CSharpDLLPublicClass1</span></span><br><span class="line">        &#123;</span><br><span class="line">            ......</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CSharpDLLPublicClass2</span></span><br><span class="line">        &#123;</span><br><span class="line">            ......</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">sealed</span> <span class="keyword">class</span> <span class="title">CSharpDLLSealedClass</span></span><br><span class="line">        &#123;</span><br><span class="line">            ......</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] <span class="keyword">args</span></span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后通过Assembly.Load去加载并查看里面的Type信息</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">LoadAssemAndShowPublicTypes</span>(<span class="params"><span class="built_in">string</span> assemblename</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    Assembly a = Assembly.LoadFrom(assemblename);</span><br><span class="line">    <span class="keyword">foreach</span> (Type t <span class="keyword">in</span> a.GetExportedTypes())</span><br><span class="line">    &#123;</span><br><span class="line">        Console.WriteLine(t.FullName);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] <span class="keyword">args</span></span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    LoadAssemAndShowPublicTypes(<span class="string">&quot;CSharpDLL.dll&quot;</span>);</span><br><span class="line"> </span><br><span class="line">    Console.ReadKey();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/img/CSharp/ExportPublicAssemblyType.PNG" alt="ExportPublicAssemblyType"><br>可以看出除了sealed的CSharpDLLSealedClass都成功打印出来了。<br>那么这里就有个疑问了，Type是个什么类型?<br>“Represents type declarations: class types, interface types, array types……A System. Type object represents a type reference”<br><a target="_blank" rel="noopener" href="https://dotnetcademy.net/Learn/4/Pages/3">A TypeInfo instance contains the definition for a Type, and a Type now contains only reference data. </a><br>可以看出TypeInfo包含类型定义,Type只存储类型定义的索引。<br>我么可以通过以下方法获取Type：</p>
<ol>
<li>System.Type.GetType</li>
<li>System.Type.ReflectionOnlyGetType – 只能通过reflect调用里面的方法</li>
<li>System.Reflection.TypeInfo.GetDeclaredNestedType</li>
<li>System.Reflection.Assemly.GetType or ExportedTypes or DefinedTypes</li>
<li>typeof operator – early-bound<br>TypeInfo包含了类型的大量信息，我们可以通过System.Reflection.TrospectionExtensions的GetTypeInfo去转换Type到TypeInfo(TypeInfo在.NET 4.5才开始支持)，然后通过TypeInfo去获取Type的相关信息。<br>也可以通过调用AsType把TypeInfo转回Type。</li>
</ol>
<p>现在我们得到了Type，我们而已通过一下方法使用Type去构建一个实例对象：</p>
<ol>
<li>System.Activator.CreateInstance</li>
<li>System.Activator.CreateInstanceFrom</li>
<li>System.AppDomain.CreateInstance or ……</li>
<li>System.Reflection.ConstructorInfo.Invoke<br>上述方法不能用于创建array和delegate：<br>创建array使用Array.CreateInstance<br>创建delegate使用MethodInfo.CreateDelegate<br>当创建泛型实例的时候，我们需要先调用Type.MakeGenericType去设置泛型类的T参数，然后返回的Type是泛型类的Type了，然后通过前面讲到的方法就能创建出泛型类实例了。<br>一下是创建一个泛型类实例的过程：</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Type closedtype = opentype.MakeGenericType(<span class="keyword">typeof</span>(<span class="built_in">string</span>), <span class="keyword">typeof</span>(<span class="built_in">int</span>));</span><br><span class="line">Object o = Activator.CreateInstance(closedtype);</span><br><span class="line"></span><br><span class="line">Console.WriteLine(o.GetType());</span><br></pre></td></tr></table></figure>
<p><img src="/img/CSharp/CreateGenericInstance.PNG" alt="CreateGenericInstance"><br>知道了如何通过Type创建实例对象，接下来让我们看看如何通过反射去访问Type里的所有信息：<br>在开始之前让我们先来看看Reflection里的类是如何应对到Type里的各个信息里的(e.g. Method, Field, Property, Event……)<br><img src="/img/CSharp/ClassHierchyOfReflection.PNG" alt="ClassHierchyOfReflection"><br>MemberInfo代表了Type里的所有成员信息，FieldInfo,PropertyInfo,EventInfo,MethodBase等都分别对应了类定义里的成员，属性，事件，方法等信息<br>接下来让我们修改一下之前定义的CSharpDLL.dll里的代码：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">CSharpDLL</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CSharpDLLPublicClass1</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="title">CSharpDLLPublicClass1</span>()</span></span><br><span class="line">            &#123;</span><br><span class="line">                mPublicClass1ID = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">CSharpDLLPublicClass1Method</span>()</span></span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine(<span class="string">&quot;CSharpDLLPublicClass1Method() called&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">public</span> <span class="built_in">int</span> PublicCLass1ID</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">get</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">return</span> mPublicClass1ID;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">set</span></span><br><span class="line">                &#123;</span><br><span class="line">                    mPublicClass1ID = <span class="keyword">value</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">private</span> <span class="built_in">int</span> mPublicClass1ID;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] <span class="keyword">args</span></span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后通过Reflection里的方法，把CSharpDLL.dll里的所有public的类型定义信息打印出来<br>因为Type.GetTypeInfo()在.NET 4.5才开始支持，所以这里我通过Type.GetMembers()去访问public的成员信息并打印而非所有的成员信息</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">PritAllTypeInfoInAssembly</span>(<span class="params"><span class="built_in">string</span> assemblename</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    Assembly a = Assembly.LoadFrom(assemblename);</span><br><span class="line">    Console.WriteLine(<span class="built_in">string</span>.Format(<span class="string">&quot;&#123;0&#125;.Fullname = &#123;1&#125;&quot;</span>,assemblename,a.FullName));</span><br><span class="line">    <span class="keyword">foreach</span> (Type t <span class="keyword">in</span> a.GetExportedTypes())</span><br><span class="line">    &#123;</span><br><span class="line">        Console.WriteLine(<span class="built_in">string</span>.Format(<span class="string">&quot;Type = &#123;0&#125;&quot;</span>, t));</span><br><span class="line">        <span class="keyword">foreach</span> (MemberInfo mi <span class="keyword">in</span> t.GetMembers())</span><br><span class="line">        &#123;</span><br><span class="line">            String typename = String.Empty;</span><br><span class="line">            <span class="keyword">if</span> (mi <span class="keyword">is</span> Type)</span><br><span class="line">            &#123;</span><br><span class="line">                typename = <span class="string">&quot;Type&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (mi <span class="keyword">is</span> FieldInfo)</span><br><span class="line">            &#123;</span><br><span class="line">                typename = <span class="string">&quot;FieldInfo&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (mi <span class="keyword">is</span> MethodInfo)</span><br><span class="line">            &#123;</span><br><span class="line">                typename = <span class="string">&quot;MethodInfo&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (mi <span class="keyword">is</span> ConstructorInfo)</span><br><span class="line">            &#123;</span><br><span class="line">                typename = <span class="string">&quot;ConstructorInfo&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (mi <span class="keyword">is</span> PropertyInfo)</span><br><span class="line">            &#123;</span><br><span class="line">                typename = <span class="string">&quot;PropertyInfo&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (mi <span class="keyword">is</span> EventInfo)</span><br><span class="line">            &#123;</span><br><span class="line">                typename = <span class="string">&quot;EventInfo&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            Console.WriteLine(<span class="built_in">string</span>.Format(<span class="string">&quot;&#123;0&#125; : &#123;1&#125;&quot;</span>, typename, mi.ToString()));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] <span class="keyword">args</span></span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    PritAllTypeInfoInAssembly(<span class="string">&quot;CSharpDLL.dll&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/img/CSharp/PrintOutPublicMemberInfo.PNG" alt="PrintOutPublicMemberInfo"><br>这样一来就打印出了所有public的MemberInfo<br>下面是Reflection访问程序信息的层次结构图：<br><img src="/img/CSharp/ReflectionClassHierarchical.PNG" alt="ReflectionClassHierarchical"><br>既然能够访问特定的类型信息了，那么通过reflection去访问调用就易如反掌了：<br>我们只需通过构造函数构建一个实例，然后通过Invoke方法传递实例对象就能调用对应方法了。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ReflectionInvoke</span>(<span class="params"><span class="built_in">string</span> assemblename, <span class="built_in">string</span> classname, <span class="built_in">string</span> methodname</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    Assembly a = Assembly.LoadFrom(assemblename);</span><br><span class="line">    Console.WriteLine(<span class="built_in">string</span>.Format(<span class="string">&quot;&#123;0&#125;.Fullname = &#123;1&#125;&quot;</span>,assemblename,a.FullName));</span><br><span class="line">    <span class="keyword">foreach</span> (Type t <span class="keyword">in</span> a.GetExportedTypes())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (t <span class="keyword">is</span> Type)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (t.Name == classname)</span><br><span class="line">            &#123;</span><br><span class="line">                ConstructorInfo constructor = t.GetConstructor(Type.EmptyTypes);</span><br><span class="line">                <span class="built_in">object</span> instance = constructor.Invoke(<span class="keyword">new</span> <span class="built_in">object</span>[] &#123; &#125;);</span><br><span class="line">                MethodInfo methods = t.GetMethod(methodname);</span><br><span class="line">                methods.Invoke(instance, <span class="keyword">new</span> <span class="built_in">object</span>[]&#123;&#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] <span class="keyword">args</span></span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    ReflectionInvoke(<span class="string">&quot;CSharpDLL.dll&quot;</span>, <span class="string">&quot;CSharpDLLPublicClass1&quot;</span>,<span class="string">&quot;CSharpDLLPublicClass1Method&quot;</span>);</span><br><span class="line">&#125;           </span><br></pre></td></tr></table></figure>
<p><img src="/img/CSharp/ReflectionMethodInvoke.PNG" alt="ReflectionMethodInvoke"><br>这样一来我们就实现了动态加载Assemble，然后通过反射调用里面特定类的特定方法。<br>关于反射使用Event并动态创建Delegate参考《CLR vir C#》 – Assembly Loading and Reflection章节</p>
<p>注意下面讲到的内容和书上的测试结果不一致，暂时不知道为什么。结论对错暂时不予置评。<br>如果我们要频繁的通过反射去访问特定类里的方法和成员，我们会采用存储Type,MemberInfo-derived Object到collection的方式，然后再通过collection去访问。<br>“Type and MemberInfo-derived objects require a lot of memory.”<br>但Type，MemberInfo及子类存储了大量的类型信息，会耗费大量的内存。<br>如何解决这个问题了？<br>“Developers who are saving&#x2F;caching a lot of Type and MemberInfoderived<br>objects can reduce their working set by using run-time handles instead of objects.”<br>通过存储run-time handles而非Type，MemberInfo object本身可以节约大量内存，然后通过run-time handles转换到对应Type&#x2F;MemberInfo去访问类型信息。</p>
<ol>
<li>RuntimeTypeHandle</li>
<li>RuntimeFieldHandle</li>
<li>RuntimeMethodHandle<br>“All of these types are value types that contain just one field, an IntPtr. The IntPtr field is a handle that refers to a type, field, or method in an AppDomain’s loader heap.”<br>Run-time handles只包含一个成员，那就是IntPtr，这里存储的相当于类型信息的索引或指针。而真正的类型信息是存储在AppDomain的Loader heap上。<br>所以我们只需要通过去构造run-time handles指向AppDomain loader heap上特定type，field，method，然后通过转换handle到对应Type&#x2F;MemberInfo去访问类型信息就能避免存储大量的Type，MemberInfo对象，从而达到节约内存的目的。<br>那么我们来看看如何通过run-time handle到底能节约多少内存？如何通过转换run-time handle去访问类型信息：</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ShowHeapMemoryUsing</span>(<span class="params"><span class="built_in">string</span> postfix</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    Console.WriteLine(<span class="built_in">string</span>.Format(<span class="string">&quot;Heap Memory Size = &#123;0&#125; -- &#123;1&#125;&quot;</span>,GC.GetTotalMemory(<span class="literal">true</span>), postfix));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">RuntimeTypeHandleAccessObjectTypeInfo</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    ShowHeapMemoryUsing(<span class="string">&quot;Before do anything!&quot;</span>);</span><br><span class="line"></span><br><span class="line">    List&lt;MethodBase&gt; methodinfos = <span class="keyword">new</span> List&lt;MethodBase&gt;();</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="function">Type t <span class="keyword">in</span> <span class="title">typeof</span>(<span class="params">Object</span>).Assembly.<span class="title">GetExportedTypes</span>())</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//skip over any generic types</span></span><br><span class="line">        <span class="keyword">if</span>(t.IsGenericTypeDefinition) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">        MethodBase[] mb = t.GetMethods();</span><br><span class="line">        methodinfos.AddRange(mb);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Console.WriteLine(<span class="built_in">string</span>.Format(<span class="string">&quot;Methods Number in Object : &#123;0&#125;&quot;</span>,methodinfos.Count));</span><br><span class="line"></span><br><span class="line">    ShowHeapMemoryUsing(<span class="string">&quot;After building cache of MethodInfo objects!&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Build cache of RuntimeMethodHandles for all MethodInfo objects in class.name = classname</span></span><br><span class="line">    List&lt;RuntimeMethodHandle&gt; methodhandles = methodinfos.ConvertAll&lt;RuntimeMethodHandle&gt;(mb =&gt; mb.MethodHandle);</span><br><span class="line"></span><br><span class="line">    ShowHeapMemoryUsing(<span class="string">&quot;Holding MethodInfo and RuntimeMethodHandle cache!&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Prevent cache from being GC&#x27;d early</span></span><br><span class="line">    GC.KeepAlive(methodinfos);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Allow cache from being GC&#x27;s now</span></span><br><span class="line">    methodinfos = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    ShowHeapMemoryUsing(<span class="string">&quot;After freeing MethodInfo Objects!&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Obtain methodinfos from methodhandle</span></span><br><span class="line">    methodinfos = methodhandles.ConvertAll&lt;MethodBase&gt;(rmh =&gt; MethodBase.GetMethodFromHandle(rmh));</span><br><span class="line"></span><br><span class="line">    ShowHeapMemoryUsing(<span class="string">&quot;Size of heap after re-creating MethodInfo objects!&quot;</span>);</span><br><span class="line"></span><br><span class="line">    GC.KeepAlive(methodhandles);</span><br><span class="line">    GC.KeepAlive(methodinfos);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Alow cache to be GC&#x27;d now</span></span><br><span class="line">    methodhandles = <span class="literal">null</span>;</span><br><span class="line">    methodinfos = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    ShowHeapMemoryUsing(<span class="string">&quot;After freeing MethodInfos and RuntimeMethodHandles!&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/img/CSharp/RuntimeHandlesUsing.PNG" alt="RuntimeHandlesUsing"><br>上述测试结果和《CLR via C#》测试结果完全不一致：<br><img src="/img/CSharp/RuntimeHandlesTestInBook.PNG" alt="RuntimeHandlesTestInBook"><br>对于释放之后methodinfos后，内存没有减少，重新转换run-time handle到<br>当我们得到run-time handles后，我们可以通过转换run-time handle到MethodBase后反倒内存使用减少。(<strong>对于run-time handles是否能够减少内存使用，这里表示疑问</strong>)</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Object objinstance = <span class="keyword">typeof</span>(Object).GetConstructor(<span class="keyword">new</span> Type[] &#123; &#125;).Invoke(<span class="keyword">new</span> Object[]&#123;&#125;);</span><br><span class="line"></span><br><span class="line">MethodBase migethashcode = methodinfos.Find( mi=&gt; mi.Name == <span class="string">&quot;GetHashCode&quot;</span>);</span><br><span class="line"></span><br><span class="line">Console.WriteLine(<span class="built_in">string</span>.Format(<span class="string">&quot;objinstance.GetHashCode = &#123;0&#125;&quot;</span>,migethashcode.Invoke(objinstance, <span class="keyword">new</span> Object[]&#123;&#125;)));</span><br></pre></td></tr></table></figure>
<p>Note:<br>“The CLR doesn’t support the ability to unload individual assemblies.you want to unload an assembly, you must unload the entire AppDomain that contains it.”(CLR不支持unload单独的assembly，如果需要unload assembly只能通过unload加载了该assembly的AppDomian来实现)<br>“avoid using reflection to access a field or invoke a method property.”(<br>尽量避免使用反射去调用方法和访问属性成员，因为很慢)</p>
<p>在学习了Hosting,AppDomain,Assembly,Reflection相关知识后，让我们看看Serialization是如何实现的。</p>
<h3 id="Runtime-Serialization"><a href="#Runtime-Serialization" class="headerlink" title="Runtime Serialization"></a>Runtime Serialization</h3><p>“Serialization is the process of converting an object or a graph of connected objects into a stream of<br>bytes. Deserialization is the process of converting a stream of bytes back into its graph of connected objects.”<br>序列化和反序列化支持我们把对象信息存储到bytes里，然后通过bytes去构建对象。</p>
<p>“When serializing an object, the full name of the type and the name of the type’s defining assembly are written to the stream.When deserializing an object, the formatter first grabs the assembly identity and ensures that the assembly is loaded into the executing AppDomain by calling System.Reflection.Assembly’s Load method.”<br>从上面可以看出来，序列化和反序列化的关键技术是通过写入类型信息和类型数据到byte里，然后通过反射实例化出对象。<br>反序列化的时候一定要确保正确的Assembly被加载，并且类型信息要和序列化时候使用的类型信息对应上。</p>
<p>那么怎么样才是使得类型信息支持序列化了？<br>我们需要在支持序列化的类型的定义前面加上flag:<br>[Serializable]]<br>“the SerializableAttribute attribute is not inherited by derived types.”<br>序列化的flag只对父类有效。<br>既然可以指定可序列化，那么当然也可以指定不支持序列化的flag:<br>[NonSerialized]<br>那么这些不支持反序列化的成员信息，如何确保在反序列化的时候初始化到正确的值了？<br>这里就需要一个flag：<br>[OnDeserialized]<br>OnDeserialized标记的方法会在反序列化该类型的时候被调用，用于初始化那些NonSerialized的成员信息。<br>那么如果我们在将来添加了类型信息里的成员定义，反序列化的时候需要怎样才能保证不出错了？<br>只需要在新添加的成员定义前添加下面这个flag:<br>[OptionalFieldAttribute]<br><a target="_blank" rel="noopener" href="https://msdn.microsoft.com/en-us/library/system.runtime.serialization.optionalfieldattribute(v=vs.110).aspx">Specifies that a field can be missing from a serialization stream so that the BinaryFormatter and the SoapFormatter does not throw an exception.</a><br>标记该成员可以在序列化的时候缺失，不抛出异常。<br>更多的序列化相关控制标记参见如下：<br>[OnSerializing] – called during serialization of an object<br>[OnSerialized] – called after serialization of an object<br>[OnDeserializing] – called during deserialization of an object<br>[OnDeserialized] – called immediately after deserialization of an object<br>Note:<br>定义了以上flag的方法必须带一个StreamingContext的参数</p>
<p>接下来让我们详细看看Serialize的过程：<br>先大概了解下Serialization和Deserialization的使用</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">Serializable</span>]</span><br><span class="line">publci <span class="keyword">class</span> <span class="title">Map</span></span><br><span class="line">&#123;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Serialization</span></span><br><span class="line">BinaryFormatter bf = <span class="keyword">new</span> BinaryFormatter ();</span><br><span class="line">FileStream fs = File.Open (mMapSavePath, FileMode.Open);</span><br><span class="line">bf.Serialize (fs, mMap);</span><br><span class="line">fs.Close ();</span><br><span class="line"></span><br><span class="line"><span class="comment">//Deserialization</span></span><br><span class="line">BinaryFormatter bf = <span class="keyword">new</span> BinaryFormatter ();</span><br><span class="line">FileStream fs = File.Open (mMapSavePath, FileMode.Open);</span><br><span class="line">mMap = (Map)bf.Deserialize (fs);</span><br><span class="line">fs.Close ();</span><br></pre></td></tr></table></figure>
<p>以下内容源于《CLR via C#》<br>Serialize Steps:</p>
<ol>
<li>The formatter calls FormatterServices’s GetSerializableMembers method.<br>public static MemberInfo[] GetSerializableMembers(Type type, StreamingContext context);<br>首先获取所有需要Serialize的成员信息(MemberInfo)，返回MemberInfo[]</li>
<li>The object being serialized and the array of System.Reflection.MemberInfo objects are then passed to FormatterServices’ static GetObjectData method.<br>通过MemberInfo去获取Object里成员信息的值，存储在Object[]里</li>
<li>The formatter writes the assembly’s identity and the type’s full name to the stream.<br>把相关的assembly identity，type名字写入stream</li>
<li>The formatter then enumerates over the elements in the two arrays, writing each member’s name and value to the stream.<br>最后把所有MemberInfo名字(MemberInfo[]里)和实际Object成员值(Objectp[]里)分别对应写入stream。</li>
</ol>
<p>Deserialize Steps：</p>
<ol>
<li>首先通过写入stream的assembly identity和type name去判断对应的Assembly是否已经加载。<br>如果加载了就通过FormatterServices::GetTypeFromAssembly去获取需要deserialize的type信息</li>
<li>然后通过FormatterServices::GetUninitializedObject去预分配内存但不调用构造函数，所有成员数据为null or 0</li>
<li>然后利用FormatterSerices::GetSerializableMembers得到支持序列化的类型成员信息用于构建和初始化</li>
<li>读取之前序列化保存成员数据信息</li>
<li>利用前面得到的支持序列化的成员信息和读取出的成员数据信息去初始化Object。FormatterServices::PopulateObjectMembers方法负责填充数据。</li>
</ol>
<p>因为序列化底层是通过反射来实现的，但反射是很慢的，如何高效的序列化数据了？<br>前面我们提到，序列化和反序列化真正去填充或读取的序列化和反序列数据是在调用FormatterServices::GetObjectData方法里。而默认的GetObjectData的数据填充是通过反射来实现的，所以我们只要使支持序列化的类实现ISerializaable的GetObjectData去自定义数据填充就能避免数据填充式reflection的使用。<br>确保传入GetObjectData的数据安全，在GetObjectData定义前加上：<br>[SecurityPermissionAttribute(SecurityAction.Demand, SerializationFormatter &#x3D; true)]<br>还有就是需要定义一个特殊的构造函数，在Deserialization之前会被调用，这里会传入我们反序列化的SerializationInfo数据，然后我们通过IDeserializationCallback.OnDeserialization(Object sender)去填充数据完成反序列化。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">Serializable</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Map</span> : <span class="title">ISerializable</span>, <span class="title">IDeserializationCallback</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//Special construct(required by ISerializable) to control deserialization</span></span><br><span class="line">    [<span class="meta">SecurityPermissionAttribute(SecurityAction.Demand, SerializationFormatter = true)</span>]</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">Map</span>(<span class="params">SerializationInfo info, StreamingContext context</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;protected Map(SerializationInfo info, StreamingContext context) called!&quot;</span>);</span><br><span class="line">        m_SiInfo = info;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">SecurityPermissionAttribute(SecurityAction.Demand, SerializationFormatter = true)</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">GetObjectData</span>(<span class="params">SerializationInfo info, StreamingContext context</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;Map::GetObjectData() called!&quot;</span>);</span><br><span class="line">        info.AddValue(<span class="string">&quot;mID&quot;</span>, mID);</span><br><span class="line">        info.AddValue(<span class="string">&quot;mMapName&quot;</span>, mMapName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> IDeserializationCallback.OnDeserialization(Object sender)</span><br><span class="line">    &#123;</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;Map::OnDeserialization() called!&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (m_SiInfo == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mID = m_SiInfo.GetInt32(<span class="string">&quot;mID&quot;</span>);</span><br><span class="line">        mMapName = m_SiInfo.GetString(<span class="string">&quot;mMapName&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> SerializationInfo m_SiInfo;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Map</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        mID = <span class="number">0</span>;</span><br><span class="line">        mMapName = <span class="string">&quot;DefaultMap&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> ID</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> mID;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">set</span></span><br><span class="line">        &#123;</span><br><span class="line">            mID = <span class="keyword">value</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span> mID;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> MapName</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> mMapName;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">set</span></span><br><span class="line">        &#123;</span><br><span class="line">            mMapName = <span class="keyword">value</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">string</span> mMapName;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] <span class="keyword">args</span></span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">string</span> mMapSavePath = <span class="string">&quot;./mapInfo.dat&quot;</span>;</span><br><span class="line">    Map mMap = <span class="keyword">new</span> Map();</span><br><span class="line">    mMap.ID = <span class="number">110</span>;</span><br><span class="line">    mMap.MapName = <span class="string">&quot;TonyMap&quot;</span>;</span><br><span class="line">    BinaryFormatter bf = <span class="keyword">new</span> BinaryFormatter ();</span><br><span class="line">    <span class="keyword">if</span> (!File.Exists(mMapSavePath))</span><br><span class="line">    &#123;</span><br><span class="line">        FileStream fsc = File.Create(mMapSavePath);</span><br><span class="line">        fsc.Close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    FileStream fs = File.Open(mMapSavePath, FileMode.Open);</span><br><span class="line">    bf.Serialize(fs, mMap);</span><br><span class="line">    fs.Close();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//Deserialization</span></span><br><span class="line">    Map mDSMap;</span><br><span class="line">    BinaryFormatter dsbf = <span class="keyword">new</span> BinaryFormatter ();</span><br><span class="line">    <span class="keyword">if</span> (File.Exists(mMapSavePath))</span><br><span class="line">    &#123;</span><br><span class="line">        FileStream dsfs = File.Open(mMapSavePath, FileMode.Open);</span><br><span class="line">        mDSMap = (Map)dsbf.Deserialize(dsfs);</span><br><span class="line">        dsfs.Close();</span><br><span class="line">        Console.WriteLine(<span class="built_in">string</span>.Format(<span class="string">&quot;Map.ID = &#123;0&#125;, Map.MapName = &#123;1&#125;&quot;</span>, mDSMap.ID, mDSMap.MapName));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/img/CSharp/Serialization.PNG" alt="Serialization"><br>可以看到我们成功自定义了数据的填充和解析，避免了不必要的reflection调用。(</p>
<p>—————————2018&#x2F;04&#x2F;22————————————-<br>但实际测试发现并没有加快序列化和反序列化的速度，反而增加了内存开销。详情参考:<a href="http://tonytang1990.github.io/2018/03/18/Data-Config-Automation/">Data-Config-Automation</a>)<br>—————————2018&#x2F;04&#x2F;22————————————-</p>
<p>更多关于Serialization学习参考《CLR via C#》 – Runtime Serialization章节</p>
<p>Note:<br>The .NET Framework also offers other serialization technologies that are designed<br>more for interoperating between CLR data types and non-CLR data types. (以下serialization技术支持CLR data type和non-CLR data types之间的交互，支持从XML序列化和反序列化，这里暂时没有深入学习了解)</p>
<ol>
<li>System.Xml.Serialization.XmlSerializer class</li>
<li>System.Runtime.Serialization.DataContractSerializer class<br>还有一种方式序列化是通过SoapFormatter类，.soap格式。<br>还有一种高效的平台无关话的序列化反序列化方式，<a href="http://tonytang1990.github.io/2015/07/15/Unity-Study/#Protocol_Buffers">参见Google Protocol Buffer学习</a><br>待续……</li>
</ol>
<h3 id="Platform-Invoke"><a href="#Platform-Invoke" class="headerlink" title="Platform Invoke"></a>Platform Invoke</h3><p>跨语言的调用，比如managed的C#调用unmanaged的C++代码<br>DllImport – Allow reusing existing unmanaged code in a managed application.</p>
<p>DllImport Attribute在DllImport的时候很重要，确保我们能找到正确的unmanaged function，传入正确的参数类型等。</p>
<p>DllImport Attribute有以下几个重要的参数：<br>EntryPoint – 指明我们将要导入的unmanaged方法名(只有指明正确的方法名，才能找到该方法)<br>CharSet – 指明如何去处理string类型，比如unicode or ansi(宽字符和单个字符是不一样的)<br>CallingConvention – 指明函数的调用约定(一般我们会涉及到__stdcall和__cdecl，前者是C++的标准调用约定，后者是C语言调用约定，只有用同样的调用约定我们才能正确调用方法)<br>Note:<br>不同的调用约定会决定参数的传入顺序，传参方式，堆栈维护，如何生成方法名等。</p>
<p>普通参数类型的调用事例：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">MyMath.h</span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> MATH_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MATH_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;stdafx.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> UTILITYDLL_API _declspec(dllexport)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyMath</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">static</span> UTILITYDLL_API <span class="type">int</span> __stdcall <span class="title">MyAdd</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">static</span> UTILITYDLL_API <span class="type">int</span> __cdecl <span class="title">MySubstract</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">MyMath.cpp</span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;stdafx.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;MyMath.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function">UTILITYDLL_API <span class="type">int</span> __stdcall <span class="title">MyMath::MyAdd</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> a + b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">UTILITYDLL_API <span class="type">int</span> __cdecl <span class="title">MyMath::MySubstract</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> a - b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function">UTILITYDLL_API <span class="type">double</span> <span class="title">MyMultiple</span><span class="params">(<span class="type">double</span> a, <span class="type">double</span> b)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> a *  b;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function">UTILITYDLL_API <span class="type">double</span> __stdcall <span class="title">MyDivision</span><span class="params">(<span class="type">double</span> a, <span class="type">double</span> b)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> a /  b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">MyStruct</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> mID;</span><br><span class="line">    <span class="type">bool</span> mBMan;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function">UTILITYDLL_API <span class="type">int</span> <span class="title">ModifyMyStruct</span><span class="params">(MyStruct* ms)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(ms-&gt;mBMan == <span class="literal">true</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            ms-&gt;mBMan = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">sizeof</span>(MyStruct);</span><br><span class="line">        &#125;<span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            ms-&gt;mID = <span class="number">-1</span>;</span><br><span class="line">            ms-&gt;mAge = <span class="number">-1</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">sizeof</span>(MyStruct);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System.Runtime.InteropServices;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">CSharpStudy</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="meta">#<span class="keyword">region</span> DLL import Study    </span></span><br><span class="line">        [<span class="meta">StructLayout(LayoutKind.Explicit, Pack = 1)</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">struct</span> MyStruct</span><br><span class="line">        &#123;</span><br><span class="line">            [<span class="meta">FieldOffset(0)</span>] <span class="keyword">public</span> <span class="built_in">int</span> mID;</span><br><span class="line">            [<span class="meta">FieldOffset(4)</span>] <span class="keyword">public</span> <span class="built_in">bool</span> mBMan;</span><br><span class="line">            [<span class="meta">FieldOffset(5)</span>] <span class="keyword">public</span> <span class="built_in">int</span> mAge;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        [<span class="meta">StructLayout(LayoutKind.Sequential)</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">struct</span> MyStruct2</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">public</span> <span class="built_in">int</span> mID;</span><br><span class="line">            <span class="keyword">public</span> <span class="built_in">bool</span> mBMan;</span><br><span class="line">            <span class="keyword">public</span> <span class="built_in">int</span> mAge;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        [<span class="meta">StructLayout(LayoutKind.Explicit)</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">struct</span> MyStructExplicit</span><br><span class="line">        &#123;</span><br><span class="line">            [<span class="meta">FieldOffset(0)</span>] <span class="keyword">public</span> Byte mByte;</span><br><span class="line">            [<span class="meta">FieldOffset(4)</span>] <span class="keyword">public</span> <span class="built_in">int</span> mID;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        [<span class="meta">StructLayout(LayoutKind.Explicit, Pack = 1)</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">struct</span> MyStructExplicit2</span><br><span class="line">        &#123;</span><br><span class="line">            [<span class="meta">FieldOffset(0)</span>]</span><br><span class="line">            <span class="keyword">public</span> Byte mByte;</span><br><span class="line">            [<span class="meta">FieldOffset(1)</span>]</span><br><span class="line">            <span class="keyword">public</span> <span class="built_in">int</span> mID;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        [<span class="meta">StructLayout(LayoutKind.Explicit, Pack = 2)</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">struct</span> MyStructExplicit3</span><br><span class="line">        &#123;</span><br><span class="line">            [<span class="meta">FieldOffset(0)</span>] <span class="keyword">public</span> Byte mByte;</span><br><span class="line">            [<span class="meta">FieldOffset(2)</span>] <span class="keyword">public</span> <span class="built_in">int</span> mID;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        [<span class="meta">DllImport(<span class="string">&quot;TESTDLL.dll&quot;</span>, EntryPoint = <span class="string">&quot;?MyAdd@MyMath@@SGHHH@Z&quot;</span>)</span>]</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">extern</span> <span class="built_in">int</span> <span class="title">MyAdd</span>(<span class="params"><span class="built_in">int</span> a, <span class="built_in">int</span> b</span>)</span>;</span><br><span class="line"></span><br><span class="line">        [<span class="meta">DllImport(<span class="string">&quot;TESTDLL.dll&quot;</span>, EntryPoint = <span class="string">&quot;?MySubstract@MyMath@@SAHHH@Z&quot;</span>, CallingConvention = CallingConvention.Cdecl)</span>]</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">extern</span> <span class="built_in">int</span> <span class="title">MySubstract</span>(<span class="params"><span class="built_in">int</span> a, <span class="built_in">int</span> b</span>)</span>;</span><br><span class="line"></span><br><span class="line">        [<span class="meta">DllImport(<span class="string">&quot;TESTDLL.dll&quot;</span>, EntryPoint = <span class="string">&quot;MyMultiple&quot;</span>, CallingConvention = CallingConvention.Cdecl)</span>]</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">extern</span> <span class="built_in">double</span> <span class="title">MyMultiple</span>(<span class="params"><span class="built_in">double</span> a, <span class="built_in">double</span> b</span>)</span>;</span><br><span class="line">        <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] <span class="keyword">args</span></span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="meta">#<span class="keyword">region</span> DLL import Study</span></span><br><span class="line">            <span class="built_in">int</span> a = <span class="number">1</span>;</span><br><span class="line">            <span class="built_in">int</span> b = <span class="number">2</span>;</span><br><span class="line">            <span class="built_in">int</span> sum = <span class="number">0</span>;</span><br><span class="line">            sum = MyAdd(a, b);</span><br><span class="line">            Console.WriteLine(<span class="built_in">string</span>.Format(<span class="string">&quot;&#123;0&#125; + &#123;1&#125; = &#123;2&#125;&quot;</span>, a, b, sum));</span><br><span class="line"></span><br><span class="line">            <span class="built_in">int</span> substractionresult = <span class="number">0</span>;</span><br><span class="line">            substractionresult = MySubstract(a, b);</span><br><span class="line">            Console.WriteLine(<span class="built_in">string</span>.Format(<span class="string">&quot;&#123;0&#125; - &#123;1&#125; = &#123;2&#125;&quot;</span>, a, b, substractionresult));</span><br><span class="line"></span><br><span class="line">            <span class="built_in">double</span> multiplier = <span class="number">1</span>;</span><br><span class="line">            <span class="built_in">double</span> multiplicand = <span class="number">2</span>;</span><br><span class="line">            <span class="built_in">double</span> multipleresult = <span class="number">0</span>;</span><br><span class="line">            multipleresult = MyMultiple(multiplier, multiplicand);</span><br><span class="line">            Console.WriteLine(<span class="built_in">string</span>.Format(<span class="string">&quot;&#123;0&#125; * &#123;1&#125; = &#123;2&#125;&quot;</span>, multiplier, multiplicand, multipleresult));</span><br><span class="line"></span><br><span class="line">            <span class="built_in">double</span> divisor = <span class="number">1</span>;</span><br><span class="line">            <span class="built_in">double</span> dividend = <span class="number">2</span>;</span><br><span class="line">            <span class="built_in">double</span> divisionresult = <span class="number">0</span>;</span><br><span class="line">            divisionresult = MyDivision(divisor, dividend);</span><br><span class="line">            Console.WriteLine(<span class="built_in">string</span>.Format(<span class="string">&quot;&#123;0&#125; / &#123;1&#125; = &#123;2&#125;&quot;</span>, divisor, dividend, divisionresult));</span><br><span class="line"></span><br><span class="line">            MyStruct ms = <span class="keyword">new</span> MyStruct();</span><br><span class="line">            MyStruct2 ms2 = <span class="keyword">new</span> MyStruct2();</span><br><span class="line">            MyStructExplicit mse = <span class="keyword">new</span> MyStructExplicit();</span><br><span class="line">            MyStructExplicit2 mse2 = <span class="keyword">new</span> MyStructExplicit2();</span><br><span class="line">            MyStructExplicit3 mse3 = <span class="keyword">new</span> MyStructExplicit3();</span><br><span class="line">            Int32 sizeofms = <span class="number">0</span>;</span><br><span class="line">            ms.mID = <span class="number">4</span>;</span><br><span class="line">            ms.mBMan = <span class="literal">false</span>;</span><br><span class="line">            ms.mAge = <span class="number">4</span>;</span><br><span class="line">            ms2.mID = <span class="number">5</span>;</span><br><span class="line">            ms2.mBMan = <span class="literal">false</span>;</span><br><span class="line">            ms2.mID = <span class="number">5</span>;</span><br><span class="line">            mse.mID = <span class="number">1</span>;</span><br><span class="line">            mse.mByte = <span class="number">1</span>;</span><br><span class="line">            mse2.mID = <span class="number">2</span>;</span><br><span class="line">            mse2.mByte = <span class="number">2</span>;</span><br><span class="line">            mse3.mID = <span class="number">3</span>;</span><br><span class="line">            mse3.mByte = <span class="number">3</span>;</span><br><span class="line">            Console.WriteLine(<span class="built_in">string</span>.Format(<span class="string">&quot;sizeof(MyStruct) = &#123;0&#125;&quot;</span>, Marshal.SizeOf(ms)));</span><br><span class="line">            Console.WriteLine(<span class="built_in">string</span>.Format(<span class="string">&quot;sizeof(MyStructExplicit) = &#123;0&#125;&quot;</span>, Marshal.SizeOf(mse)));</span><br><span class="line">            Console.WriteLine(<span class="built_in">string</span>.Format(<span class="string">&quot;sizeof(MyStructExplicit2) = &#123;0&#125;&quot;</span>, Marshal.SizeOf(mse2)));</span><br><span class="line">            Console.WriteLine(<span class="built_in">string</span>.Format(<span class="string">&quot;sizeof(MyStructExplicit3) = &#123;0&#125;&quot;</span>, Marshal.SizeOf(mse3)));</span><br><span class="line">            Console.WriteLine(<span class="built_in">string</span>.Format(<span class="string">&quot;ms.mID = &#123;0&#125;, ms.mBMan = &#123;1&#125;, ms.mAge = &#123;2&#125;&quot;</span>, ms.mID, ms.mBMan, ms.mAge));</span><br><span class="line">            sizeofms = ModifyMyStruct(<span class="keyword">ref</span> ms);</span><br><span class="line">            Console.WriteLine(<span class="built_in">string</span>.Format(<span class="string">&quot;ms.mID = &#123;0&#125;, ms.mBMan = &#123;1&#125;,  ms.mAge = &#123;2&#125;, sizeofms = &#123;3&#125;&quot;</span>, ms.mID, ms.mBMan, ms.mAge, sizeofms));</span><br><span class="line">            Console.WriteLine(<span class="built_in">string</span>.Format(<span class="string">&quot;ms2.mID = &#123;0&#125;, ms2.mBMan = &#123;1&#125;, ms2.mAge = &#123;2&#125;&quot;</span>, ms2.mID, ms2.mBMan, ms2.mAge));</span><br><span class="line">            sizeofms = ModifyMyStruct2(<span class="keyword">ref</span> ms2);</span><br><span class="line">            Console.WriteLine(<span class="built_in">string</span>.Format(<span class="string">&quot;ms2.mID = &#123;0&#125;, ms2.mBMan = &#123;1&#125;,  ms2.mAge = &#123;2&#125;, sizeofms = &#123;3&#125;&quot;</span>, ms2.mID, ms2.mBMan, ms2.mAge, sizeofms));</span><br><span class="line">            <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">            Console.ReadKey();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Output:<br><img src="/img/CSharp/PlatformInvokeDemo.PNG" alt="PlatformInvokeDemo"></p>
<p>分析上述事例：<br>针对MyAdd方法我们定义了__Stdcall的C++调用约定方式，而且属于类的静态方法，所以在C#中import的时候我们需要指明具体的方法名(通过VS自带的dumpbin我们可以打出TESTDLL.dll里的符号表信息 – dmpbin.exe &#x2F;all TESTDLL.dll &gt; TestDllDump.txt,我们可以找到MyAdd方法的具体方法名，否者会显示找不到EntryPoint方法MyAdd)，原本还需要指明调用约定为__stdcall，但CallingConvention的默认值就是__stdcall，所以这里就不用指明了。</p>
<p>针对MySubstract方法我们定义了__cdecl的C调用约定方式，而且属于类的静态方法，所以我们在C#中import的时候需要指明具体的方法名和指明调用约定为CallingConvention &#x3D; CallingConvention.Cdecl，否者会显示调用堆栈不对称等问题。</p>
<p>针对MyMultiple方法我们定义了__cdecl的C调用约定方式，同时是全局方法，所以我们只需要指明调用约定为__cdecl，直接指明调用方法为MyMultiple就能找到MyMultiple方法了。</p>
<p>针对MyDivision方法我们定义了__stdcall的C++调用约定方式，同时是全局方法，但由于__stdcall调用约定对方法名生成的方式(包含函数名，参数字节数信息等)，我们不能直接通过MyDivision来调用MyDivision方法而需要在EntryPoint里指定方法全名。</p>
<p>除了找到正确的函数方法和指定正确的函数调用约定等信息外，我们在Manage code调用Unmanaged code的时候需要保证Manage struct和Unmanage struct的内存布局要一致，以确保unmanaged code访问managed数据的时候拿到正确信息。</p>
<p><a target="_blank" rel="noopener" href="https://msdn.microsoft.com/en-us/library/ef4c3t39.aspx">These structures can have any legal name; there is no relationship between the native and managed version of the two structures other than their data layout. Therefore, it is vital that the managed version contains fields that are the same size and in the same order as the native version.</a><br>从官网可以看出，managed code的函数名字并不重要，我们必须确保结构体的内存布局要一致。</p>
<p>那我们为何要进行内存对齐了？<br>一下参考百度百科：<br>“<br>平台原因（移植原因）<br>不是所有的硬件平台都能访问任意地址上的任意数据的；某些硬<br>件平台只能在某些地址处取某些特定类型的数据，否则抛出硬件异常。<br>性能原因<br>数据结构（尤其是栈）应该尽可能地在自然边界上对齐。原因在于，为了访问<br>未对齐的内存，处理器需要作两次内存访问；而对齐的内存访问仅需要一次访问<br>”</p>
<p>从测试例子里可以看出，当我们通过StructLayoutAttribute.Pack指定MyStuct的内存对齐方式是1的时候，MyStruct的大小只有9bytes，而MyStruct2使用默认采用结构体内数据最大的值作为对齐方式，事例中是int即4bytes为对齐方式，MyStruct2的大小是12bytes。反观C++返回的MyStruct的大小是12(可以看出是以4bytes为对齐方式)，所以如果我们传递MyStruct的时候访问数据就出问题了，而MyStruct2访问到了正确的数据。</p>
<p>而后续的MyStructExplicit,MyStructExplicit2,MyStructExplicit3则展示了通过制定Pack的值(即内存对齐大小)是如何影响数据结构的大小的。</p>
<p>更多：<br><a target="_blank" rel="noopener" href="https://msdn.microsoft.com/en-us/library/system.runtime.interopservices.structlayoutattribute.pack%28v=vs.110%29.aspx">StructLayoutAttribute.Pack</a><br><a target="_blank" rel="noopener" href="https://msdn.microsoft.com/zh-cn/library/dn956973.aspx#NotExistJustToMakeTheAElementVisible">在 Visual Studio 2015 之前，可以使用 Microsoft 专用关键字 __alignof 和 declspec(alignas) 来指定大于默认值的对齐方式。从 Visual Studio 2015 开始，应使用 C++11 标准关键字 alignof 和 alignas (C++) 以获得最高代码可移植性。</a></p>
<h3 id="Event"><a href="#Event" class="headerlink" title="Event"></a>Event</h3><p>C#里的Event响应相当于listener and obsever 模式里触发监听回调。Delegate好比C++里的回调 – 当事件发生时调用</p>
<p>“The common language runtime’s (CLR’s) event model is based on delegates.”<br>event key word</p>
<p>定义Event我们需要做一下几件事，下面模拟邮件收发事件提醒为例:</p>
<ol>
<li>定义EventArgs(这个必须继承至EventArgs，里面包含了我们事件发生时所需要传递的信息，如果什么都不需要传递，使用EventArgs即可)</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Define a type that will hold any additional information that should be sent to receivers of the event notification</span></span><br><span class="line"><span class="keyword">internal</span> <span class="keyword">class</span> <span class="title">NewMailEventArgs</span> : <span class="title">EventArgs</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">NewMailEventArgs</span>(<span class="params">String <span class="keyword">from</span>, String to, String subject</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        m_From = <span class="keyword">from</span>;</span><br><span class="line">        m_To = to;</span><br><span class="line">        m_Subject = subject;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String From&#123; <span class="keyword">get</span> &#123; <span class="keyword">return</span> m_From; &#125; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> String m_From;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String To &#123; <span class="keyword">get</span> &#123; <span class="keyword">return</span> m_To; &#125; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> String m_To;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String Subject &#123; <span class="keyword">get</span> &#123; <span class="keyword">return</span> m_Subject; &#125; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> String m_Subject;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>定义Event成员，用于指定监听什么样的Event</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title">EmailManager</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Define the event member</span></span><br><span class="line">    <span class="comment">// 虽然这里只有简短的一句话，</span></span><br><span class="line">    <span class="comment">// 但是编译器会给我们去定义关于此事件的监听添加和删除代码</span></span><br><span class="line">    <span class="comment">// 详情请看下面截图</span></span><br><span class="line">    <span class="comment">// 这样一来我们只要通过NewEmail就能添加和删除监听NewMailEventArgs事件的delegate了</span></span><br><span class="line">    <span class="comment">// EventHandler决定了我们监听事件的Delegate原型如下</span></span><br><span class="line">    <span class="comment">// public delegate void EventHandler(object sender, EventArgs e);</span></span><br><span class="line">    <span class="comment">// 监听的事件是NewMailEventArgs</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">event</span> EventHandler&lt;NewMailEventArgs&gt; NewMail;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre><code>![EventExtraCode](/img/CSharp/EventDefinition.PNG)
</code></pre>
<ol start="3">
<li>定义需要监听事件的类并提供添加和删除监听的方法</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title">Fax</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Fax</span>(<span class="params">EmailManager em</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// Trigger add_NewMail method</span></span><br><span class="line">        em.NewMail += FaxMsg;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Delegate that is used to listen for NewMailEventArgs</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">FaxMsg</span>(<span class="params">Object sender, NewMailEventArgs e</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;Faxing mail message:&quot;</span>);</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;From = &#123;0&#125;, To = &#123;1&#125;, Subject = &#123;2&#125;&quot;</span>, e.From, e.To, e.Subject);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Remove listener for NewMailEventArgs</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Unregester</span>(<span class="params">EmailManager em</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// Trigger remove_NewMail method</span></span><br><span class="line">        em.NewMail -= FaxMsg;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>定义事件触发和事件通知方法</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title">EmailManager</span></span><br><span class="line">&#123;</span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Define a method responsible for raising the event</span></span><br><span class="line">    <span class="comment">// to notify registered objects that the event has occurred</span></span><br><span class="line">    <span class="comment">// If this class is sealed, make this method private and nonvirtual</span></span><br><span class="line">    <span class="comment">// 事件通知</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">OnNewMail</span>(<span class="params">NewMailEventArgs e</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// Copy a reference to the delegate field now into a temporary field for thread safety</span></span><br><span class="line">        <span class="comment">// Be careful race condition</span></span><br><span class="line">        EventHandler&lt;NewMailEventArgs&gt; temp = NewMail;</span><br><span class="line">        <span class="comment">// 这里有thread safe问题，但由于delegate is immutable，</span></span><br><span class="line">        <span class="comment">// 所以我们把NewMail传递给临时变量temp后，无论别人如何改变NewMail都没关系了</span></span><br><span class="line">        <span class="comment">// If any methods registered interest with our event, notify them</span></span><br><span class="line">        <span class="keyword">if</span> (temp != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            temp(<span class="keyword">this</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Define a method that translates the input into the desired event</span></span><br><span class="line">    <span class="comment">// 事件触发</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SimulateNewMail</span>(<span class="params">String <span class="keyword">from</span>, String to, String subject</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// Hold the information we want to pass</span></span><br><span class="line">        NewMailEventArgs e = <span class="keyword">new</span> NewMailEventArgs(<span class="keyword">from</span>, to, subject);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Call OnNewMail to notify registered objects that the event has occured</span></span><br><span class="line">        OnNewMail(e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="5">
<li>测试Event</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] <span class="keyword">args</span></span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    EmailManager emailmanager = <span class="keyword">new</span> EmailManager();</span><br><span class="line"></span><br><span class="line">    Fax fax = <span class="keyword">new</span> Fax(emailmanager);</span><br><span class="line"></span><br><span class="line">    emailmanager.SimulateNewMail(<span class="string">&quot;Tony&quot;</span>, <span class="string">&quot;Tom&quot;</span>, <span class="string">&quot;Hello World!&quot;</span>);</span><br><span class="line"></span><br><span class="line">    fax.Unregester(emailmanager);</span><br><span class="line"></span><br><span class="line">    emailmanager.SimulateNewMail(<span class="string">&quot;Tom&quot;</span>, <span class="string">&quot;Tony&quot;</span>, <span class="string">&quot;Hello World Again!&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Test Result:<br><img src="/img/CSharp/EventTestResult.PNG" alt="EventTestResult"><br>可以看出我们成功的添加了自定义的事件监听也成功的移除了事件监听。</p>
<p>Note:<br>一般来说，设计事件监听都会设计成通过Dictionary来存储EventKey和Delegate，通过判断Dictinary里面是否存在该事件来添加Delegate，如果不存在则添加该事件监听。删除监听同理。</p>
<h3 id="Chars-Strings-and-Working-with-Text"><a href="#Chars-Strings-and-Working-with-Text" class="headerlink" title="Chars, Strings, and Working with Text"></a>Chars, Strings, and Working with Text</h3><p>Chars:<br>“In the .NET Framework, characters are always represented in 16-bit Unicode code values, easing the development of global applications.A character is represented with an instance of the System.Char structure (a value type).”</p>
<p>说到字符和字符串，就不得不提字符编码了，从上面可以看出，.NET的Char都是采用16bit的Unicode编码，主要是为了语言通用话(包含所有的字符编码)。还有一点就是Char是Structure是Value type。</p>
<p>针对字符本身的方法(Char)：<br>Char还提供了很多获取字符具体类型等相关信息的方法，e.g IsDigit, IsLetter,<br>IsWhiteSpace, IsUpper，GetUnicodeCategory(得到字符关于Unicode的分类信息)……</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Char c = <span class="string">&#x27;a&#x27;</span>;</span><br><span class="line">UnicodeCategory uc = Char.GetUnicodeCategory(c);</span><br><span class="line">Console.WriteLine(<span class="string">&quot;UnicodeCategory = &#123;0&#125;&quot;</span>, uc.ToString());</span><br><span class="line">c = <span class="string">&#x27;1&#x27;</span>;</span><br><span class="line">uc = Char.GetUnicodeCategory(c);</span><br><span class="line">Console.WriteLine(<span class="string">&quot;UnicodeCategory = &#123;0&#125;&quot;</span>, uc.ToString());</span><br></pre></td></tr></table></figure>
<p>针对字符全球化(CultureInfo):<br>在Char里面很多方法都有包含CultureInfo参数类型的版本，这个是针对全球化指定特定语言。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CultureInfo ci = CultureInfo.CurrentCulture;</span><br><span class="line">Console.WriteLine(<span class="string">&quot;CurrentCulture = &#123;0&#125;&quot;</span>, ci);</span><br></pre></td></tr></table></figure>
<p><img src="/img/CSharp/CharAndCultureInfoOutput.PNG" alt="CharAndCultureInfoOutput"></p>
<p>Strings:<br>“The String type is derived immediately from Object, making it a reference type.”</p>
<p><em>String的构建：</em></p>
<ol>
<li>通过Literal string构建<br>虽然String是reference type，但我们构建String的时候不是通过new，而直接通过literal string(e.g. String s &#x3D; “Tony”;)</li>
<li>支持像C++里那样特殊符号代表特定含义<br>String s &#x3D; “Hi\r\nthere”;</li>
<li>跨平台考虑<br>特殊符号在不同平台有不同的表示方式，所以出于跨平台考虑，我们最好使用Environment里的变量来表示特定环境的特定符号</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">String s1= <span class="string">&quot;Tony&quot;</span>;</span><br><span class="line">String s2 = <span class="string">&quot;Hi\nTony!&quot;</span>;</span><br><span class="line">String s3 = <span class="string">&quot;Hi&quot;</span> + Environment.NewLine + <span class="string">&quot;Tom!&quot;</span>;</span><br><span class="line">Console.WriteLine(<span class="string">&quot;s1 = &#123;0&#125;&quot;</span>, s1);</span><br><span class="line">Console.WriteLine(<span class="string">&quot;s2 = &#123;0&#125;&quot;</span>, s2);</span><br><span class="line">Console.WriteLine(<span class="string">&quot;s3 = &#123;0&#125;&quot;</span>, s3);</span><br></pre></td></tr></table></figure>
<p><img src="/img/CSharp/StringConstructOutput.PNG" alt="StringConstructOutput"></p>
<p><em>多个String合并：</em><br>多个字符串合并的时候最主要的是避免通过重复的literal string去构建String，因为String是reference type，多个literal string的构建会在heap上分配多个内存。正确的是通过System.Text.StringBuilder去构建。</p>
<p>“StringBuilder’s members allow you to manipulate this character array, effectively shrinking the string or changing the characters in the string.”</p>
<p>Unlike a String, a StringBuilder represents a mutable string. This means that most of StringBuilder’s members change the contents in the array of characters and don’t cause new objects to be allocated on the managed heap.”</p>
<p>可以看出StringBuilder之所以不会构建多个String是因为它内部构建了可变的character array，这样允许我们在StringBuilder里操作的时候不会触发新的String构建。这样以来我们就可以利用里面现有的String去动态构建我们需要的String了。<br>Error:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">String s = <span class="string">&quot;Hi&quot;</span> + <span class="string">&quot;there!&quot;</span>;</span><br></pre></td></tr></table></figure>
<p>Right:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">String sp1 = <span class="string">&quot;Tony&quot;</span>;</span><br><span class="line">String sp2 = <span class="string">&quot; and &quot;</span>;</span><br><span class="line">String sp3 = <span class="string">&quot;Tom&quot;</span>;</span><br><span class="line">StringBuilder sb = <span class="keyword">new</span> StringBuilder(<span class="string">&quot;Hello &quot;</span>, <span class="number">50</span>);</span><br><span class="line">sb.Append(sp1);</span><br><span class="line">sb.Append(sp2);</span><br><span class="line">sb.Append(sp3);</span><br><span class="line">Console.WriteLine(<span class="string">&quot;sb = &#123;0&#125;&quot;</span>, sb.ToString());</span><br></pre></td></tr></table></figure>
<p><img src="/img/CSharp/StringCatenationOutput.PNG" alt="StringCatenationOutput"></p>
<p><em>String比较：</em><br>String.Compare(***)<br>……<br>比较的时候需要注意可能有不同国家的语言，这里需要注意需要传入CultureInfo作为比较的语言环境参数。</p>
<p>同时当我们的代码文件中直接书写了特定国家语言或语言Unicode编码的时候，我们需要把文件存储为Unicode格式，否则到时候编译器无法正常解析。</p>
<p>程序中大量的比较特别是针对特定国家语言的String比较很费时，我们应该尽量避免。</p>
<p>同时String是immuatable的，我们可以重复利用现有的String，无需大量重复构造相同的String去增加memory负担。<br>CLR里有一个叫internal hash table的东西，所有的Strings作为key，所有String的reference作为value。因为String是immutable的且是reference type，我们可以通过访问internal hash table去查看是否存在现有String，这样一来就避免了重构相同的String。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">String ss = <span class="string">&quot;internal string&quot;</span>;</span><br><span class="line">String sintern = String.Intern(ss);</span><br><span class="line">Console.WriteLine(<span class="string">&quot;sintern = &#123;0&#125;&quot;</span>,sintern);</span><br></pre></td></tr></table></figure>
<p><img src="/img/CSharp/StringConstructionWithMemorySave.PNG" alt="StringConstructionWithMemorySave"></p>
<p>“String objects referred to by the internal hash table can’t be freed until the AppDomain is unloaded or the process terminates.”</p>
<p>“System.Runtime.CompilerServices.CompilationRelaxations.NoStringInterning flag will control whether to inern all of the string.”</p>
<p><em>Security String:</em><br>System.Security.SecureString ……</p>
<p>Note:<br><strong>String object is immutable. The String class is sealed, which means that you cannot use it as a base class for your own type.</strong></p>
<h3 id="Enumerated-and-Bit-Flags"><a href="#Enumerated-and-Bit-Flags" class="headerlink" title="Enumerated and Bit Flags"></a>Enumerated and Bit Flags</h3><ol>
<li>Enum<br>“Every enumerated type is derived directly from System.Enum, which is derived from System.ValueType, which in turn is derived from System.Object”<br>首先可以看出Enumerated属于Value Type。<br>这里还是说一下使用Enumerate的好处：<ol>
<li>“Enumerated types make the program much easier to write, read, and maintain.”(可视化，容易看懂，无需hard code)</li>
<li>“Enumerated types are strongly typed.”(类型传递不对，编译器会报错)<br>Enumerate在C#里作为一个最基础的type，且是面向对象的，C#给我们提供了很多可以相互转化的方法(e.g. 比如Enum到String – ToString() String到Enum – Parse())</li>
</ol>
</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">enum</span> Colors</span><br><span class="line">&#123;</span><br><span class="line">    BLACK = <span class="number">0</span>,</span><br><span class="line">    RED = <span class="number">1</span>,</span><br><span class="line">    GREEN = <span class="number">2</span>,</span><br><span class="line">    BLUE = <span class="number">3</span>,</span><br><span class="line">    WHITE = <span class="number">4</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] <span class="keyword">args</span></span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    Colors c = Colors.RED;</span><br><span class="line">    Console.WriteLine(<span class="string">&quot;Decimal format: c = &#123;0&#125;&quot;</span>, c.ToString(<span class="string">&quot;D&quot;</span>));</span><br><span class="line">    Console.WriteLine(<span class="string">&quot;General format: c = &#123;0&#125;&quot;</span>, c.ToString(<span class="string">&quot;G&quot;</span>));</span><br><span class="line">    Colors c2 = (Colors)Enum.Parse(<span class="keyword">typeof</span>(Colors), <span class="string">&quot;GREEN&quot;</span>, <span class="literal">true</span>);</span><br><span class="line">    Console.WriteLine(<span class="string">&quot;Decimal format: c2 = &#123;0&#125;&quot;</span>, c2.ToString(<span class="string">&quot;D&quot;</span>));</span><br><span class="line">    Console.WriteLine(<span class="string">&quot;General format: c2 = &#123;0&#125;&quot;</span>, c2.ToString(<span class="string">&quot;G&quot;</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre><code>Output:
![EnumeratesOuput](/img/CSharp/Enumerates.PNG)
    还有一点值得注意的就是enum无法定义methods,properties,or events。
    针对methods我们可以通过C#里extention methods(详情见Methods那一节)的特性给enum添加methods。
</code></pre>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">Flags</span>]</span><br><span class="line"><span class="built_in">enum</span> Actions</span><br><span class="line">&#123;</span><br><span class="line">    NONE = <span class="number">0</span>,</span><br><span class="line">    READ = <span class="number">0x0001</span>,</span><br><span class="line">    WRITE = <span class="number">0x0002</span>,</span><br><span class="line">    READANDWRITE = READ | WRITE,</span><br><span class="line">    DELETE = <span class="number">0x0004</span>,</span><br><span class="line">    QUERY = <span class="number">0x0008</span>,</span><br><span class="line">    Sync = <span class="number">0x0010</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">internal</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">ActionsExtensionMethods</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Actions <span class="title">Set</span>(<span class="params"><span class="keyword">this</span> Actions flags, Actions setflags</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> flags | setflags;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] <span class="keyword">args</span></span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    Actions actions = Actions.READ;</span><br><span class="line">    Console.WriteLine(<span class="string">&quot;actions = &#123;0&#125;&quot;</span>, actions.ToString());</span><br><span class="line">    actions = actions | Actions.DELETE;</span><br><span class="line">    Console.WriteLine(<span class="string">&quot;actions = &#123;0&#125;&quot;</span>,actions.ToString());</span><br><span class="line">    actions = actions.Set(Actions.WRITE);</span><br><span class="line">    Console.WriteLine(<span class="string">&quot;actions = &#123;0&#125;&quot;</span>, actions.ToString());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre><code>Output:
![EnumWithExtentionMethod](/img/CSharp/EnumWithExtentionMethod.PNG)
    Note:
    &quot;Symbols defined by an enumerated type are constant values.&quot;
</code></pre>
<ol start="2">
<li>Bit<br>如果说Enum是一个成员代表一个含义，那么Bit可以看做是一个Bit代表一组含义。<br>最经常用到的地方就是File的访问控制权限：</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="built_in">enum</span> FileAttributes &#123;</span><br><span class="line">    ReadOnly = <span class="number">0x00001</span>,</span><br><span class="line">    Hidden = <span class="number">0x00002</span>,</span><br><span class="line">    System = <span class="number">0x00004</span>,</span><br><span class="line">    Directory = <span class="number">0x00010</span>,</span><br><span class="line">    Archive = <span class="number">0x00020</span>,</span><br><span class="line">    <span class="number">368</span> PART III Essential Types</span><br><span class="line">    Device = <span class="number">0x00040</span>,</span><br><span class="line">    Normal = <span class="number">0x00080</span>,</span><br><span class="line">    Temporary = <span class="number">0x00100</span>,</span><br><span class="line">    SparseFile = <span class="number">0x00200</span>,</span><br><span class="line">    ReparsePoint = <span class="number">0x00400</span>,</span><br><span class="line">    Compressed = <span class="number">0x00800</span>,</span><br><span class="line">    Offline = <span class="number">0x01000</span>,</span><br><span class="line">    NotContentIndexed = <span class="number">0x02000</span>,</span><br><span class="line">    Encrypted = <span class="number">0x04000</span>,</span><br><span class="line">    IntegrityStream = <span class="number">0x08000</span>,</span><br><span class="line">    NoScrubData</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里有个比较方便的用法，可以把enum看做一组Bits。<br>定义enum的时候加上前缀[Flags],可以使enum的成员被看做一组bits。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">Flags</span>]</span><br><span class="line"><span class="built_in">enum</span> Actions</span><br><span class="line">&#123;</span><br><span class="line">    NONE = <span class="number">0</span>,</span><br><span class="line">    READ = <span class="number">0x0001</span>,</span><br><span class="line">    WRITE = <span class="number">0x0002</span>,</span><br><span class="line">    READANDWRITE = READ | WRITE,</span><br><span class="line">    DELETE = <span class="number">0x0004</span>,</span><br><span class="line">    QUERY = <span class="number">0x0008</span>,</span><br><span class="line">    Sync = <span class="number">0x0010</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] <span class="keyword">args</span></span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    Actions actions = Actions.READ;</span><br><span class="line">    Console.WriteLine(<span class="string">&quot;actions = &#123;0&#125;&quot;</span>, actions.ToString());</span><br><span class="line">    actions = actions | Actions.DELETE;</span><br><span class="line">    Console.WriteLine(<span class="string">&quot;actions = &#123;0&#125;&quot;</span>,actions.ToString());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/img/CSharp/BitWithFlag.PNG" alt="BitWithFlag"><br><img src="/img/CSharp/BitWithoutFlag.PNG" alt="BitWithoutFlag"></p>
<h3 id="Custom-Attributes"><a href="#Custom-Attributes" class="headerlink" title="Custom Attributes"></a>Custom Attributes</h3><p>“they’re just a way to associate additional information with a target.The compiler emits this additional information into the managed module’s metadata.”<br>上面这句话可以理解成，custom attributes是为了关联一些额外的信息到特定的目标上(这里的目标可以是class，event，methods…..)，这些额外的信息是被编译器编译保存到了module的metadata里。</p>
<p>让我们看个Custom Attributes例子：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line">[<span class="meta">assembly: SomeAttr</span>] <span class="comment">// Applied to assembly</span></span><br><span class="line">[<span class="meta">module: SomeAttr</span>] <span class="comment">// Applied to module</span></span><br><span class="line">[<span class="meta">type: SomeAttr</span>] <span class="comment">// Applied to type</span></span><br><span class="line"><span class="keyword">internal</span> <span class="keyword">sealed</span> <span class="keyword">class</span> <span class="title">SomeType</span>&lt;[<span class="title">typevar</span>: <span class="title">SomeAttr</span>] <span class="title">T</span>&gt; &#123; <span class="comment">// Applied to generic type variable</span></span><br><span class="line">    [<span class="meta">field: SomeAttr</span>] <span class="comment">// Applied to field</span></span><br><span class="line">    <span class="keyword">public</span> Int32 SomeField = <span class="number">0</span>;</span><br><span class="line">    [<span class="meta">return: SomeAttr</span>] <span class="comment">// Applied to return value</span></span><br><span class="line">    [<span class="meta">method: SomeAttr</span>] <span class="comment">// Applied to method</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Int32 <span class="title">SomeMethod</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">        [param: SomeAttr] // Applied to parameter</span></span></span><br><span class="line"><span class="params"><span class="function">        Int32 SomeParam</span>)</span> </span><br><span class="line">    &#123; </span><br><span class="line">        <span class="keyword">return</span> SomeParam;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">property: SomeAttr</span>] <span class="comment">// Applied to property</span></span><br><span class="line">    <span class="keyword">public</span> String SomeProp &#123;</span><br><span class="line">        [<span class="meta">method: SomeAttr</span>] <span class="comment">// Applied to get accessor method</span></span><br><span class="line">        <span class="keyword">get</span> &#123; <span class="keyword">return</span> <span class="literal">null</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    [<span class="meta">event: SomeAttr</span>] <span class="comment">// Applied to event</span></span><br><span class="line">    [<span class="meta">field: SomeAttr</span>] <span class="comment">// Applied to compiler-generated field</span></span><br><span class="line">    [<span class="meta">method: SomeAttr</span>] <span class="comment">// Applied to compiler-generated add &amp; remove methods</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">event</span> EventHandler SomeEvent;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从上面可以看出我们可以定义custom attribute的范围很广，包括assembly，module，type，filed，method…….</p>
<p>“A custom attribute is simply an instance of a type.”<br>Custom attribute其实也是一个类，只是我们定义custom attribute的时候触发了这些类的构造，把custom attribute的信息写入到了metadata里。</p>
<p>那么知道了Custom attribute是一个类，那么怎么定义Custom attribute了？<br>“Common Language Specification (CLS) compliance, custom attribute classes must be derived, directly or indirectly, from the public abstract System.Attribute class.”<br>从上面可以看出custom attribute必须直接或间接的继承至System.Attribute class.</p>
<p><strong>接下来我们使用MSDN上的例子来详细了解下Custom Attribute是怎么工作的。</strong></p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Reflection;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">CustomAttrCS</span> &#123;</span><br><span class="line">    <span class="comment">// An enumeration of animals. Start at 1 (0 = uninitialized).</span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">enum</span> Animal &#123;</span><br><span class="line">        <span class="comment">// Pets.</span></span><br><span class="line">        Dog = <span class="number">1</span>,</span><br><span class="line">        Cat,</span><br><span class="line">        Bird,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// A custom attribute to allow a target to have a pet.</span></span><br><span class="line">    <span class="comment">// 定义Custom attribute必须直接或间接继承至Attribute</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">AnimalTypeAttribute</span> : <span class="title">Attribute</span> &#123;</span><br><span class="line">        <span class="comment">// The constructor is called when the attribute is set.</span></span><br><span class="line">        <span class="comment">// 构建的时候我们可以去设置含参和不含参构造函数</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">AnimalTypeAttribute</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">           thePet = Animal.Bird;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">AnimalTypeAttribute</span>(<span class="params">Animal pet</span>)</span> &#123;</span><br><span class="line">            thePet = pet;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Keep a variable internally ...</span></span><br><span class="line">        <span class="keyword">protected</span> Animal thePet;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// .. and show a copy to the outside world.</span></span><br><span class="line">        <span class="keyword">public</span> Animal Pet &#123;</span><br><span class="line">            <span class="keyword">get</span> &#123; <span class="keyword">return</span> thePet; &#125;</span><br><span class="line">            <span class="keyword">set</span> &#123; thePet = Pet; &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// A test class where each method has its own pet.</span></span><br><span class="line">    <span class="keyword">class</span> <span class="title">AnimalTypeTestClass</span> &#123;</span><br><span class="line">        <span class="comment">// 定义custom attribute的时候，我们可以调用对应构造函数</span></span><br><span class="line">        [<span class="meta">AnimalType(Animals.DOG)</span>]</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">DogMethod</span>()</span> &#123; &#125;</span><br><span class="line">        <span class="comment">// 除了调用构造函数外，我们还可以调用Custom Attribute Class的Property设定特定值</span></span><br><span class="line">        [<span class="meta">AnimalType(Pet = Animals.CAT)</span>]</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">CatMethod</span>()</span> &#123; &#125;</span><br><span class="line"></span><br><span class="line">        [<span class="meta">AnimalType()</span>]</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">BirdMethod</span>()</span> &#123; &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title">DemoClass</span> &#123;</span><br><span class="line">        <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] <span class="keyword">args</span></span>)</span> &#123;</span><br><span class="line">            <span class="comment">// 通过反射去检查AnimalTypeTestClass里的方法是否定义了Attribute</span></span><br><span class="line">            AnimalTypeTestClass testClass = <span class="keyword">new</span> AnimalTypeTestClass();</span><br><span class="line">            Type type = testClass.GetType();</span><br><span class="line">            <span class="comment">// Iterate through all the methods of the class.</span></span><br><span class="line">            <span class="keyword">foreach</span>(MethodInfo mInfo <span class="keyword">in</span> type.GetMethods()) &#123;</span><br><span class="line">                <span class="comment">// Iterate through all the Attributes for each method.</span></span><br><span class="line">                <span class="keyword">foreach</span> (Attribute attr <span class="keyword">in</span> </span><br><span class="line">                    Attribute.GetCustomAttributes(mInfo)) &#123;</span><br><span class="line">                    <span class="comment">// Check for the AnimalType attribute.</span></span><br><span class="line">                    <span class="keyword">if</span> (attr.GetType() == <span class="keyword">typeof</span>(AnimalTypeAttribute))</span><br><span class="line">                        Console.WriteLine(</span><br><span class="line">                            <span class="string">&quot;Method &#123;0&#125; has a pet &#123;1&#125; attribute.&quot;</span>, </span><br><span class="line">                            mInfo.Name, ((AnimalTypeAttribute)attr).Pet);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Output:<br><img src="/img/CSharp/CustomAttribute.PNG" alt="CustomAttribute"><br>Note:<br>“all non-abstract attributes must contain at least one public constructor.”(非abstract attributes必须至少有一个public构造函数)</p>
<p><strong>知道了如何自定义Custom Attribute，但Attribute可以用于Assembly,module,type…..，我们如何限制其使用的地方了？</strong><br>AttributeUsageAttribute用于指定Custom Attribute的使用范围。<br>AttributeTargets包含了所有可指定的使用范围。<br>同时AttributeTargets还有连个成员变量，m_allowMultiple,m_inherited,前者决定这个attribute是否允许针对同一个target设定多个，后者决定含该attribute修饰的类的子类是否继承AttributeUsage设定。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">AttributeUsage(AttributeTargets.Method, Inherited = false)</span>]<span class="keyword">public</span> <span class="keyword">class</span> <span class="title">AnimalTypeAttribute</span> : <span class="title">Attribute</span> &#123;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title">AnimaTypeTestClass</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 因为AnimaTypeAttribute定义了只对Method有效，所以这里对构造函数就无效</span></span><br><span class="line">    <span class="comment">//[AnimalType(Animals.CAT)]</span></span><br><span class="line">    <span class="comment">//AnimaTypeTestClass() &#123; &#125;</span></span><br><span class="line"></span><br><span class="line">    [<span class="meta">AnimalType(Animals.DOG)</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">DogMethod</span>()</span> &#123; &#125;</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>知道了Custom Attribute的定义和其限制作用，那么Custom Attribute有什么实际意义了？</strong><br>还记得在Enumerated Types and Bit Flags讲到的[FLAG]标记改变了Enum.ToString(),Format()行为吗？<br>正是因为我们动态检查了绑定在Enum上的Flag属性导致的。<br>而实现动态检查的底层方法是通过reflection(反射 – 参见Hosting,AppDomain,Assembly,Reflection章节)<br>还记得之前MSDN的例子是如何检查类里各方法是否定义了Attribute吗(这里就是使用了反射)？</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 通过反射去检查AnimalTypeTestClass里的方法是否定义了Attribute</span></span><br><span class="line">AnimalTypeTestClass testClass = <span class="keyword">new</span> AnimalTypeTestClass();</span><br><span class="line">Type type = testClass.GetType();</span><br><span class="line"><span class="comment">// Iterate through all the methods of the class.</span></span><br><span class="line"><span class="keyword">foreach</span>(MethodInfo mInfo <span class="keyword">in</span> type.GetMethods()) &#123;</span><br><span class="line">    <span class="comment">// Iterate through all the Attributes for each method.</span></span><br><span class="line">    <span class="keyword">foreach</span> (Attribute attr <span class="keyword">in</span> </span><br><span class="line">        Attribute.GetCustomAttributes(mInfo)) &#123;</span><br><span class="line">        <span class="comment">// Check for the AnimalType attribute.</span></span><br><span class="line">        <span class="keyword">if</span> (attr.GetType() == <span class="keyword">typeof</span>(AnimalTypeAttribute))</span><br><span class="line">            Console.WriteLine(</span><br><span class="line">                <span class="string">&quot;Method &#123;0&#125; has a pet &#123;1&#125; attribute.&quot;</span>, </span><br><span class="line">                mInfo.Name, ((AnimalTypeAttribute)attr).Pet);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样一来我们就可以动态的判断是否定义了Attribute并获取Attribute里定义的信息。<br>.NET里有一个System.Reflection.CustomAttributeExtensions class，这个了定义了真多各个target(module,event,method……)的获取关于自定义信息的三个方法:</p>
<ol>
<li>IsDefined</li>
<li>GetCustomAttributes</li>
<li>GetCustomAttribute<br>第二和第三方法调用的时候会触发Attribute Class的构造函数，那么我们怎么才能在不触发Attribute Class构造函数的情况下获取Attrbute信息了？<br>答案是：System.Reflection.CustomAttributeData的GetCustomAttributes方法(利用反射，但要注意的是CustomAttributeData的GetCustomAttributes只有四个版本分别是Assembly,Module, ParameterInfo and MemberInfo)</li>
</ol>
<p><strong>知道了如何去检查method是否包含Custom Attribute，那么我们怎样去判断两个instances完全一样了(所有Custom Attribute都一样)</strong><br>这里我们可以通过System.Attribute的Equals方法去判断，这里的Equals被重写了，会通过reflection去检查每一个attribute进行比较。<br>除了上述方法我们也可以在自定义的Attribute里重写Equal和Match方法去实现特定比较判断。</p>
<p><strong>使用和定义Custom attribute的时候需要注意的点：</strong></p>
<ol>
<li>“When applying an attribute to a target in source code, the C# compiler allows<br>you to omit the Attribute suffix to reduce programming typing and to improve the<br>readability of the source code.”(注意定义custom attribute的时候，我们可以省略attribute后缀)</li>
<li>“When defining an attribute class’s instance constructor, fields, and properties, you must restrict yourself to a small subset of data types.”(当定义Custom Attribute时，我们只能声明基础类型的fields，properties，constructor(必须符合CLS-compilation))</li>
<li>“Be aware that only Attribute, Type, and MethodInfo classes implement reflection<br>methods that honor the Boolean inherit parameter.”(只有Attribute，Type and MethodInfo实现了反射inherit parameter信息的方法)</li>
</ol>
<h3 id="Exceptions-and-State-Management"><a href="#Exceptions-and-State-Management" class="headerlink" title="Exceptions and State Management"></a>Exceptions and State Management</h3><p>What is Exception?<br>“An expcetion is when a member fails to complete the task it is supposed to perform as indicated by ites name.”</p>
<p>Exception-Handling Mechanics<br>The .NET Framework exception handling mechanism is built using the Structured Exception Handling(SEH) mechanism offered by Windows.</p>
<p>首先看一下捕获异常的最基本写法：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line">    <span class="comment">// Put code requiring graceful recovery and/or cleanup operations here...</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span>(excetion)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Put code that recovers from any kind of exception</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">finally</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Put code that cleans up any operations started within the try block here...</span></span><br><span class="line">    <span class="comment">// The code in here ALWAYS executes, regardless of whether an exception is thrown.</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Try Block:<br>“A try block contains code that requires common cleanup operations, exception recovery operations, or both.”</p>
<p>Note:<br>“Sometimes developers ask how much code they should put inside a single try<br>block. The answer to this depends on state management.”</p>
<p>Catch Block:<br>“A catch block contains code to execute in response to an exception.”</p>
<p>Note:<br>“When debugging through a catch block by using Microsoft Visual Studio, you can<br>see the currently thrown exception object by adding the special $exception variable name to a watch window.”(当调试catch block的时候，可以通过查看$exception变量名查看异常信息)</p>
<p>Finally Block:<br>“A finally block contains code that’s guaranteed to execute. Typically, the code in a finally block performs the cleanup operations required by actions taken in the try block.”</p>
<p>CLS and Non-CLS Exceptions:<br>CLS(Common Language Specification) – throw Exception-derived objects<br>Non-CLS – throw Exception not derived from Exception</p>
<p>After CLR 2.0:<br>“Microsoft introduced a new RuntimeWrappedException class (defined in the System.Runtime.CompilerServices namespace). This class is derived from Exception, so it is a CLS-compliant exception type. The RuntimeWrappedException class contains a private field of type Object (which can be accessed by using RuntimeWrappedException’s WrappedException read-only property). In CLR 2.0, when a non–CLS-compliant exception is thrown, the CLR automatically constructs an instance of the RuntimeWrappedException class and initializes its private field to refer to the object that was actually thrown.”(CLR 2.0之后，通过RuntimeWrapperdException class把所有的Non-CLS Exception都封装成了CLS Exception)</p>
<p>如果想要就支持2.0之前的行为：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Runtime.CompilerServices;</span><br><span class="line">[<span class="meta">assembly:RuntimeCompatibility(WrapNonExceptionThrows = false)</span>]</span><br></pre></td></tr></table></figure>

<p>接下来让我们看看Exception的基类：<br>Systen.Exception<br>以下是一些重要的Properties：<br><img src="/img/CSharp/ExceptionProperties.PNG" alt="ExceptionProperties"><br>必要重要的一些Properties：</p>
<ol>
<li>Message(描述了和异常相关的重要信息)</li>
<li>StackTrace(描述了导致抛出异常的方法相关信息)</li>
</ol>
<p>我们也可以通过System.Diagnostics.StackTrace去获取详细的堆栈信息。</p>
<p>但有些时候我们会发现有些方法没有显示在详细的堆栈信息里：<br>原因有两个：</p>
<ol>
<li>the stack is really a record of where the thread should return to, not where the thread has come from. (Stack只记录返回点不记录当前点)</li>
<li>The just-in-time (JIT) compiler can inline methods to avoid the overhead of calling and returning from a separate method(JIT编译器使得一些方法称为了inlie的(在当前方法被调用的地方直接展开)，从而无法记录到Stack里)</li>
</ol>
<p>禁止JIT inlie需要用到System.Runtime.CompilerServices.MethodImplAttribute里的MethodImplOption.NoInlining:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">MethodImpl(MethodImplOptions.NoInlining)</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SomeMethod</span>()</span> &#123;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>FCL(Framework Class Library)里定义很多现成的Exception。</p>
<p>Throwing an Exception:<br>当我们需要自己抛出异常的时候，我们需要考虑如下：</p>
<ol>
<li>哪一个Exccetion class我们应该继承(是否使用现有的Exception class)</li>
<li>传递什么样的string到exception构造函数里(传递说明为什么方法不能完成要抛出这个异常)</li>
</ol>
<p>Defining Your Own Exception Class:<br>自定义Exception类是比较容易出问题且冗长的。<br>原因如下：<br>“The main reason for this is because all Exception-derived types should be serializable so that they can cross an AppDomain boundary or be written to a log or database”(我们必须保证自定义的Exception类支持序列化，因为我们可能会跨AppDomain去写入Log或则数据库里)</p>
<p>Note：<br>“When you throw an exception, the CLR resets the starting point for the exception;<br>that is, the CLR remembers only the location where the most recent exception object<br>was thrown.”(当我们再次抛出异常的时候，CLR会重置异常，只记录最近异常Object)</p>
<p>Guidelines and Best Practices:</p>
<ol>
<li>Use finally Blocks Liberally(finlly always execute, do cleanup operations)</li>
<li>Do not Catch Everything</li>
<li>Recovering Gracefully from an Exception(catch some exceptions that are known in advanced and try to recover from it)</li>
<li>Backing Out of a Partially Completed Operation When an Unrecoverble Exception Occus – Maintaining State</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SerializeObjectGraph</span>(<span class="params">FileStream fs, IFormatter formatter, Object rootObj</span>)</span> &#123;</span><br><span class="line">    <span class="comment">// Save the current position of the file.</span></span><br><span class="line">    Int64 beforeSerialization = fs.Position;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// Attempt to serialize the object graph to the file.</span></span><br><span class="line">        formatter.Serialize(fs, rootObj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> &#123; <span class="comment">// Catch any and all exceptions.</span></span><br><span class="line">        <span class="comment">// If ANYTHING goes wrong, reset the file back to a good state.</span></span><br><span class="line">        fs.Position = beforeSerialization;</span><br><span class="line">        <span class="comment">// Truncate the file.</span></span><br><span class="line">        fs.SetLength(fs.Position);</span><br><span class="line">        <span class="comment">// <span class="doctag">NOTE:</span> The preceding code isn&#x27;t in a finally block because</span></span><br><span class="line">        <span class="comment">// the stream should be reset only when serialization fails.</span></span><br><span class="line">        <span class="comment">// Let the caller(s) know what happened by re-throwing the SAME exception.</span></span><br><span class="line">        <span class="keyword">throw</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre><code>Note：
&quot;After you’ve caught and handled the exception, don’t swallow it—let the caller know that the exception occurred. You do this by re-throwing the same exception.&quot;(特别是写给别人用的时候，再次抛出异常让使用者可以去捕获并知道发生了什么)
</code></pre>
<ol start="5">
<li>Hiding an Implementation Detail to Maintain a “Contract”<br>“you might find it useful to catch one exception and re-throw a different exception.”(抛出更符合当前API行为的异常。或则增加更多符合当前API的异常的信息。)</li>
</ol>
<p>Unhandled Exceptions：<br>什么时候会出现Unhandled Exceptions？<br>“When an exception is thrown, the CLR climbs up the call stack looking for catch blocks that match the type of the exception object being thrown. If no catch block matches the thrown exception type, an unhandled exception occurs.”(当异常被抛出却没有对应的catch的时候，成为Unhandled Exception)<br>更多内容参考《CLR via C#》 – Unhandled Exceptions</p>
<p>Note:<br>“When the CLR detects that any thread in the process has had an unhandled exception, the CLR terminates the process.”(当CLR检测到任何线程有未处理的异常的时候，CLR会终止进程)</p>
<p>Debugging Exceptions:<br>VS -&gt; Debug -&gt; Exception<br><img src="/img/CSharp/ExceptionWindow.PNG" alt="ExceptionWindow"><br>如果针对特定异常勾选抛出，那么当该异常被抛出的会后，程序会进入断点(帮助我们快速定位特定异常)。不勾选也会进入断点(前提是该异常是unhandled)</p>
<p>也可以通过上述窗口添加自定义的异常。</p>
<p>Exception-Handling Performance Considerations:<br>……</p>
<p>Constrained Excecution Regions(CERs):<br>……</p>
<p>更多内容待学习……</p>
<h3 id="The-Managed-Heap-and-Garbage-Collection"><a href="#The-Managed-Heap-and-Garbage-Collection" class="headerlink" title="The Managed Heap and Garbage Collection"></a>The Managed Heap and Garbage Collection</h3><p>这一小节会讲到CLR里重要的内存管理(GC)。<br>首先要区分栈(Stack)和堆(Heap)。<br>下面堆栈的学习参考<a target="_blank" rel="noopener" href="http://www.c-sharpcorner.com/article/C-Sharp-heaping-vs-stacking-in-net-part-i/">C# Heap(ing) Vs Stack(ing) in .NET: Part I</a><br>栈 – <a target="_blank" rel="noopener" href="http://www.c-sharpcorner.com/article/C-Sharp-heaping-vs-stacking-in-net-part-i/">The Stack is more or less responsible for keeping track of what’s executing in our code (or what’s been “called”).</a><br>这里栈可以理解为用于记录代码执行顺序。<br>Note:<br>栈是LIFO(Last In First Out)原则。<br>堆 – <a target="_blank" rel="noopener" href="http://www.c-sharpcorner.com/article/C-Sharp-heaping-vs-stacking-in-net-part-i/">The Heap is more or less responsible for keeping track of our objects (our data, well… most of it;)</a><br>堆是记录那些动态分配内存的(比如reference type)<br>哪些是分配在栈上，哪些分配在堆上，记住下面两个原则：</p>
<ol>
<li>A Reference Type always goes on the Heap; easy enough, right? (索引类型都是分配在堆上)</li>
<li>Value Types and Pointers always go where they were declared. This is a little more complex and needs a bit more understanding of how the Stack works to figure out where “things” are declared. (值类型和指针是分配在栈上)<br>下面让我们结合实例来看一下是如何分配在栈和堆上的？</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MyInt</span></span><br><span class="line">&#123;         </span><br><span class="line"> <span class="keyword">public</span> <span class="built_in">int</span> MyValue;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> MyInt <span class="title">AddFive</span>(<span class="params"><span class="built_in">int</span> pValue</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    MyInt result = <span class="keyword">new</span> MyInt();</span><br><span class="line">    result.MyValue = pValue + <span class="number">5</span>;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当调用AddFive方法的时候，首先函数参数pValue会入栈<br><img src="/img/CSharp/StackAndHeapPart1.PNG" alt="StackAndHeapPart1"><br>然后因为我们创建了索引类型的MyInt实例，这时候MyInt会在堆上分配内存，同时在栈上会生成一个指针指向MyInt在堆上的索引地址<br><img src="/img/CSharp/StackAndHeapPart2.PNG" alt="StackAndHeapPart2"><br>当我们给result.MyValue赋值时，我们通过result Pointer记录的地址去访问堆上的MyValue成员并修改值。<br>最后我们返回result时，栈被清理，只剩下堆上我们分配的数据。<br><img src="/img/CSharp/StackAndHeapPart3.PNG" alt="StackAndHeapPart3"><br>而剩下堆上的数据，就是由CLR的GC来管理了。<br>NOTE :<br>“The method does not live on the stack and is illustrated just for reference.”<br>接下来看看CLR的GC是如何工作的。<br>在了解GC之前，让我们看看C#里在堆上分配内存是如何分配的？<br>这里就不得不提new这个关键字了。<br>当我们通过new去创建reference type的时候，会经历下列步骤:</p>
<ol>
<li>Calculate the number of bytes required for the type’s fields)(计算type所需分配的内存)</li>
<li>Add the bytes required for an object’s overhead(contain a type object pointer and a sync block index)(为type分配object pointer和sync block index所需内存 – 如果是32-bit Application则分配8 bytes，如果是64-bit Application则分配16 bytes)</li>
<li>Zero out the memory start at NextObjPtr(Indicates where the next object is to be allocated within the heap). Return reference. Move on NextObjPtr to next address that is available to be allocated..(根据NextObjPtr指向的可用堆上的起始位置分配内存并清零，然后传递指向type的内存起始位置的NextObjPtr到构造函数去进行初始化，初始化完成后返回type的索引，最后把NextObjPtr指向下一个heap可分配内存的位置。)<br>知道了我们在堆上是如何分配内存，让我们看看GC是如何工作来管理所有堆上分配的内存的？</li>
</ol>
<p>让我们来了解下GC Algorithm：</p>
<ol>
<li>Reference Counting Algorithm(COM use)<br>就是我们平时说的索引计数，通过判断当前所有指针指向特定对象的数量来决定是否要回收该对象内存。<br>缺点：<br>Circular references会导致内存永远无法回收(e.g. A包含了B的索引，B也包含了A的索引)</li>
<li>Reference Tracking Algorithm(<strong>CLR use. Cares only about reference type variables</strong>)<br> 步骤如下：<ol>
<li>Marking Phase<br> CLR first suspends all threads in the process(prevents threads from accessing objects and changing their state while the CLR examines them)<br> Marking All objects to 0(means all objects should be deleted)<br> Scan active roots to marking object(not mark the same object again to avoid circular references)<br> 标记阶段，首先悬挂所有线程防止访问Objects和相关状态。<br> 然后标记所有在堆上对象的引用为0，然后扫描所有active的roots(即reference type variables – 引用类型的变量)，如果有roots指向任何一个堆上的Object，就标记该Object并对该Object内部的roots进行扫描标记。这里最重要的一点就是对标记过的Object不会再扫描内部root(比如有roots指向了A，我们标记了A，然后检查A内部发现B，因为B还没被标记所以标记B并检查B内部，在B内部又发现了A但因为A已经被标记了，所以不会再次标记A，这样一来如果最初指向A的roots不存在了的话，A和B都会因为没有引用不会被标记而清除。这样一来就避免了Circular references)<br> Note:<br> “Refer to all reference type variables as roots.”</li>
<li>Compacting Phase<br> Shifts the memory consumed by the marked objects down in the heap, compacting all the surviving objects together so that they are contiguous in memory.(reduce application’s working set size &amp;access fast in future &amp; no address space fragmentation issues)<br> CLR resumes all the application’s threads and they continue to access the objects as if the GC never happened at all<br> Note:<br> A static field keeps whatever object it refers to forever or until the AppDomain that the types are loaded into is unloaded<br> 在标记阶段完成后，所有标记为0的堆上对象内存都会被回收。<br> 压缩阶段主要是为了内存的高效利用(防止内存碎片化)。<br> 要注意的是静态变量在内存中的位置不会改变。</li>
</ol>
</li>
</ol>
<p>接下来看看如何提升GC的performance：<br>CLR’s GC assumptions(提升GC性能的最基本假设):<br>The newer an object is, the shorter its lifetime will be(越新的对象lifetime越短)<br>The older an object is, the longer its lifetime will be(越旧的对象lifetime越长)<br>Collecting a portion of the heap is faster than collecting the whole heap(GC一部分heap比GC所有heap快)<br>基于上述理论：<br>Heap被分为了Generation 0,1,2。<br><img src="/img/CSharp/GCGenerations.png" alt="GCGenerations"><br>最初创建的对象会存放在generation 0，GC首先检查Generation 0的对象，objects在通过第一次GC后会提升到generation 1，当generation 1对象数量超过generation 0的时候，GC就会检查generation 0和1，同理当 object从generation 1存活下来后会被存放到generation 2。<br>通过上述方式，我们GC就不必每次都对整个heap的对象进行检查以达到GC优化的目的。<br>Note:<br>The Managed heap supports only three generations: generation 0,1,2<br>The garbage collector fine-tunes itself automatically based on the memory load required by your application.<br>关于更多GC的学习详情参考《CLR vir C#》 – The Managed Heap and Garbage Collection章节<br>Note:<br>Finalize methods are called at the completion of a garbage collection on objects that the GC has determined to be garbage.(Object的Finalize方法是在Object在完成内存被回收之前调用)<br>Finalize is not equal to destructor in C++(Finalize!&#x3D;C++的析构函数)</p>
<h3 id="Threading"><a href="#Threading" class="headerlink" title="Threading"></a>Threading</h3><p>What is Thread?<br>“A thread is a Windows concept whose job is to virtualize the CPU. “</p>
<p>Major parts of Thread:</p>
<ol>
<li>Thread kernel object(“data structes contains a bunch of properties that describe the thread”描述线程信息的数据对象)</li>
<li>Thread environment block(TEB)(“The TEB contains the head of the thread’s exception-handling chain. In addition, the TEB containes the thread’s thread-local storage data and some data structures for use by GDI and OpenGL graphics”)</li>
<li>User-mode stack(“The use-mode stack is used for local variables and arguments passed to methods. It also contains the address indicating what the thread should execute next when the current method returns”)</li>
<li>Kernel-mode stack(“The kernel-mode stack is also used when application code passes arguments to a krenel-mode function in the operating system”)</li>
<li>DLL thread-attach and thread-detach notifications</li>
</ol>
<p>Why do we need Thread?<br>Benfits:</p>
<ol>
<li>Responsiveness(同一时间只能运行一个程序，单核CPU一个程序卡死就会导致整个电脑卡死)</li>
<li>Data safe(程序卡死后重启会导致数据丢失)</li>
<li>Performance(多核CPU可以同时执行多个任务，使得处理任务更高效)</li>
</ol>
<p>Shorcomings:</p>
<ol>
<li>Threads consume a lot of memory and require time to create, destroy…..(创建和销毁费时，并且消耗大量内存)</li>
<li>Context switches(Change to other thread) takes much time(Thread切换费时)</li>
</ol>
<p>How to use Thread correctly?<br>“Have the number of thread that is no more than the number of CPUs on that machine.”</p>
<p>Note:<br>“A CLR thread is identical to a Windows thread”</p>
<h4 id="Thread-Scheduling-and-Priorities"><a href="#Thread-Scheduling-and-Priorities" class="headerlink" title="Thread Scheduling and Priorities"></a>Thread Scheduling and Priorities</h4><p>待续……</p>
<h1 id="C-In-Depth-third-edition"><a href="#C-In-Depth-third-edition" class="headerlink" title="C# In Depth(third edition)"></a>C# In Depth(third edition)</h1><h2 id="C-1"><a href="#C-1" class="headerlink" title="C#1"></a>C#1</h2><h3 id="Non-Generic-Collections"><a href="#Non-Generic-Collections" class="headerlink" title="Non Generic Collections"></a>Non Generic Collections</h3><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ArrayList list = <span class="keyword">new</span> ArrayList();</span><br></pre></td></tr></table></figure>

<h3 id="Sorting-an-ArrayList-using-IComparer"><a href="#Sorting-an-ArrayList-using-IComparer" class="headerlink" title="Sorting an ArrayList using IComparer"></a>Sorting an ArrayList using IComparer</h3><hr>
<h2 id="C-2"><a href="#C-2" class="headerlink" title="C#2"></a>C#2</h2><p>Strongly Typed Collections</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">List&lt;T&gt; list = <span class="keyword">new</span> List&lt;T&gt;();</span><br></pre></td></tr></table></figure>

<h3 id="Sorting-an-List-using-IComparer-or-Comparision"><a href="#Sorting-an-List-using-IComparer-or-Comparision" class="headerlink" title="Sorting an List using IComparer or Comparision"></a>Sorting an List<T> using IComparer<T> or Comparision<T></h3><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title">ProductNameComparer</span> : <span class="title">IComparer</span>&lt;<span class="title">Product</span>&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">int</span> <span class="title">Compare</span>(<span class="params">Product p1, Product p2</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> p1.Name.CompareTo(p2.Name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// IComparer&lt;T&gt;</span></span><br><span class="line">List&lt;Product&gt; products = <span class="keyword">new</span> List&lt;Product&gt;();</span><br><span class="line">products.Sort(<span class="keyword">new</span> ProductNameComparer());</span><br><span class="line"><span class="comment">// Comparison&lt;T&gt;</span></span><br><span class="line">products.Sort(<span class="built_in">delegate</span>(Product x, Product y)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> x.Name.CompareTo(y.Name); </span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="Nullable-Value-Type"><a href="#Nullable-Value-Type" class="headerlink" title="Nullable Value Type"></a>Nullable Value Type</h3><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">decimal</span>? price = <span class="literal">null</span>;</span><br></pre></td></tr></table></figure>

<h2 id="C-3"><a href="#C-3" class="headerlink" title="C#3"></a>C#3</h2><h3 id="Properties"><a href="#Properties" class="headerlink" title="Properties"></a>Properties</h3><p>Automatically Implementaed Properties</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title">ClassName</span></span><br><span class="line">&#123;   </span><br><span class="line">    <span class="keyword">public</span> type PropertyName&#123;<span class="keyword">get</span>;<span class="keyword">set</span>;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Sorting-using-Comparision-from-a-lambda-expression"><a href="#Sorting-using-Comparision-from-a-lambda-expression" class="headerlink" title="Sorting using Comparision from a lambda expression"></a>Sorting using Comparision<T> from a lambda expression</h3><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Product&gt; products = <span class="keyword">new</span> List&lt;Product&gt;();</span><br><span class="line">products.Sort((x, y) =&gt; x.Name.CompareTo(y.Name));</span><br></pre></td></tr></table></figure>

<h3 id="Extension-Method"><a href="#Extension-Method" class="headerlink" title="Extension Method"></a>Extension Method</h3><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> StringExtension</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">int</span> <span class="title">getLength</span>(<span class="params"><span class="keyword">this</span> <span class="built_in">string</span> s</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> s.Length;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="LINQ-Language-Integrated-Query"><a href="#LINQ-Language-Integrated-Query" class="headerlink" title="LINQ(Language-Integrated Query)"></a>LINQ(Language-Integrated Query)</h3><p>“LINQ is at the heart of the changes in C# 3. The aim is to make it easy to write queries against multiple data sources with consistent syntax and features, in a readable and composable fashion.”</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Product&gt; products = <span class="keyword">new</span> List&lt;Product&gt;();</span><br><span class="line"><span class="keyword">var</span> filtered = <span class="keyword">from</span> Product p <span class="keyword">in</span> products</span><br><span class="line">                           <span class="keyword">where</span> p.Price &gt; <span class="number">10</span></span><br><span class="line">                           <span class="keyword">select</span> p;</span><br></pre></td></tr></table></figure>

<h2 id="C-4"><a href="#C-4" class="headerlink" title="C#4"></a>C#4</h2><h3 id="Named-Arguments"><a href="#Named-Arguments" class="headerlink" title="Named Arguments"></a>Named Arguments</h3><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title">Product</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Name</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span> &#123; <span class="keyword">return</span> name; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">readonly</span> <span class="built_in">string</span> name;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Product</span>(<span class="params"><span class="built_in">string</span> name</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Product product =  <span class="keyword">new</span> Product( name : <span class="string">&quot;TonyTang&quot;</span>),</span><br></pre></td></tr></table></figure>

<h3 id="Optional-Parameters"><a href="#Optional-Parameters" class="headerlink" title="Optional Parameters"></a>Optional Parameters</h3><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="built_in">int</span> <span class="title">Sum</span>(<span class="params"><span class="built_in">int</span> a,<span class="built_in">int</span> b = <span class="number">0</span></span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> a + b;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> sum = Sum(<span class="number">1</span>);</span><br></pre></td></tr></table></figure>

<h3 id="DLR-Dynamic-Language-Runtime"><a href="#DLR-Dynamic-Language-Runtime" class="headerlink" title="DLR(Dynamic Language Runtime)"></a>DLR(Dynamic Language Runtime)</h3><h2 id="CSharp-Evolution"><a href="#CSharp-Evolution" class="headerlink" title="CSharp Evolution"></a>CSharp Evolution</h2><p><a href="/img/CSharp/CSharpEvolution1.PNG">CSharpEvolution1</a><br><a href="/img/CSharp/CSharpEvolution2.png">CSharpEvolution2</a><br><a href="/img/CSharp/CSharpEvolution3.PNG">CSharpEvolution3</a></p>
<p>参考书籍下载：<br><a target="_blank" rel="noopener" href="http://download.csdn.net/download/baiyu9821179/4282298">《C#入门经典第五版》</a><br>《CLR Via C# Fourth Edition》 - Jeffrey Richter<br><a target="_blank" rel="noopener" href="http://down.51cto.com/data/982895">《C# in Depth 3rd Edition》</a> - Jon Skeet</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Programming-Language/">Programming Language</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/C/">C#</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/07/15/Unity学习/" title="Unity学习" itemprop="url">Unity学习</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Tony Tang" target="_blank" itemprop="author">Tony Tang</a>
		
  <p class="article-time">
    <time datetime="2015-07-15T15:48:26.000Z" itemprop="datePublished"> 发表于 2015-07-15</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="Unity-Introduction"><a href="#Unity-Introduction" class="headerlink" title="Unity Introduction"></a>Unity Introduction</h1><p>因为后期发现目录越来越长导致前面的一些代码模块不具可读性，所以在这里加很多…过度符<br>……………………………………………..<br>……………………………………………..<br>……………………………………………..<br>……………………………………………..<br>……………………………………………..<br>……………………………………………..<br>……………………………………………..<br>……………………………………………..<br>……………………………………………..<br>……………………………………………..<br>……………………………………………..<br>……………………………………………..<br>……………………………………………..<br>……………………………………………..<br>……………………………………………..<br>……………………………………………..<br>……………………………………………..<br>……………………………………………..<br>……………………………………………..<br>……………………………………………..<br>……………………………………………..<br>……………………………………………..<br>……………………………………………..<br>……………………………………………..<br>……………………………………………..<br>……………………………………………..<br>……………………………………………..<br>……………………………………………..<br>……………………………………………..<br>……………………………………………..<br>……………………………………………..<br>……………………………………………..<br>……………………………………………..<br>……………………………………………..<br>……………………………………………..<br>……………………………………………..<br>……………………………………………..<br>……………………………………………..<br>……………………………………………..<br>……………………………………………..<br>……………………………………………..</p>
<h2 id="What-is-Unity"><a href="#What-is-Unity" class="headerlink" title="What is Unity?"></a>What is Unity?</h2><p>Unity is a cross-platform game engine developed by Unity Technologies and used to develop video games for PC, consoles, mobile devices and websites. First released on June 8, 2005<br>(<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Unity_(game_engine)">from wiki</a>)</p>
<h2 id="Why-should-we-study-Unity"><a href="#Why-should-we-study-Unity" class="headerlink" title="Why should we study Unity?"></a>Why should we study Unity?</h2><ol>
<li>Cross-platform</li>
<li>Free</li>
<li>Complete SDK documentation</li>
<li>Many free assets</li>
</ol>
<h2 id="Which-programming-language-are-we-using"><a href="#Which-programming-language-are-we-using" class="headerlink" title="Which programming language are we using?"></a>Which programming language are we using?</h2><ol>
<li>C# (推荐入门书籍《C#入门经典》，进阶书籍《CLR via C#》)</li>
<li>Javascript</li>
<li>Boo</li>
</ol>
<h1 id="Unity-Tutorial-Study"><a href="#Unity-Tutorial-Study" class="headerlink" title="Unity Tutorial Study"></a>Unity Tutorial Study</h1><p>Website: <a target="_blank" rel="noopener" href="https://unity3d.com/learn/tutorials">Unity Tutorials</a></p>
<h2 id="ROLL-A-BALL"><a href="#ROLL-A-BALL" class="headerlink" title="ROLL-A-BALL"></a>ROLL-A-BALL</h2><p><strong>Game Introduction</strong><br>控制小球移动收集场景里的方块，UI会显示当前收集的方块数量，当所有方块通过碰撞收集后游戏UI提示You Win</p>
<p><strong>Code</strong><br>PlayerController.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> UnityEngine.UI;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PlayerController</span> : <span class="title">MonoBehaviour</span> &#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">float</span> m_Speed;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> Text m_CountText;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> Text m_WinText;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Rigidbody m_RB;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="built_in">int</span> m_Count;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Start</span>()</span></span><br><span class="line">	&#123;</span><br><span class="line">		m_RB = GetComponent&lt;Rigidbody&gt; ();</span><br><span class="line">		m_Count = <span class="number">0</span>;</span><br><span class="line">		SetCountText();</span><br><span class="line">		m_WinText.text = <span class="string">&quot;&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">FixedUpdate</span>()</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">float</span> moveHorizontal = Input.GetAxis (<span class="string">&quot;Horizontal&quot;</span>);</span><br><span class="line">		<span class="built_in">float</span> moveVertical = Input.GetAxis (<span class="string">&quot;Vertical&quot;</span>);</span><br><span class="line"></span><br><span class="line">		Vector3 movement = <span class="keyword">new</span> Vector3(moveHorizontal, <span class="number">0.0f</span>, moveVertical);</span><br><span class="line">		m_RB.AddForce (movement * m_Speed);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">OnTriggerEnter</span>(<span class="params">Collider other</span>)</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (other.gameObject.CompareTag (<span class="string">&quot;Pickup&quot;</span>)) </span><br><span class="line">		&#123;</span><br><span class="line">			other.gameObject.SetActive(<span class="literal">false</span>);</span><br><span class="line">			m_Count++;</span><br><span class="line">			SetCountText();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">SetCountText</span>()</span></span><br><span class="line">	&#123;</span><br><span class="line">		m_CountText.text = <span class="string">&quot;Count: &quot;</span> + m_Count.ToString();</span><br><span class="line">		<span class="keyword">if</span> (m_Count &gt;= <span class="number">12</span>) </span><br><span class="line">		&#123;</span><br><span class="line">			m_WinText.text = <span class="string">&quot;You Win!&quot;</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>CameraController.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CameraController</span> : <span class="title">MonoBehaviour</span> &#123;</span><br><span class="line">	<span class="keyword">public</span> GameObject m_Player;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Vector3 m_Offset;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Use this for initialization</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Start</span> ()</span> &#123;</span><br><span class="line">		m_Offset = transform.position - m_Player.transform.position;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// Update is called once per frame</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">LateUpdate</span> ()</span> &#123;</span><br><span class="line">		transform.position = m_Player.transform.position + m_Offset;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Rotator.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Rotator</span> : <span class="title">MonoBehaviour</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Use this for initialization</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Start</span> ()</span> &#123;</span><br><span class="line">	</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// Update is called once per frame</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Update</span> ()</span> &#123;</span><br><span class="line">		transform.Rotate (<span class="keyword">new</span> Vector3 (<span class="number">15</span>, <span class="number">35</span>, <span class="number">45</span>) * Time.deltaTime);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>Captures</strong><br><em>Game Play</em><br><img src="/img/Unity/Roll_A_Ball_Game_Play.PNG" alt="Roll_A_Ball_Game_Play"><br><em>Win Game</em><br><img src="/img/Unity/Roll_A_Ball_Game_Win.PNG" alt="Roll_A_Ball_Game_Win"></p>
<h2 id="SPACE-SHOOTER"><a href="#SPACE-SHOOTER" class="headerlink" title="SPACE SHOOTER"></a>SPACE SHOOTER</h2><p><strong>Game Introduction</strong><br>Top Down Game<br>好比全民打飞机</p>
<p><strong>Code</strong><br>ShipController.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"></span><br><span class="line">[<span class="meta">System.Serializable</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Boundary</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">float</span> m_MinX,m_MaxX,m_MinZ,m_MaxZ;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ShipController</span> : <span class="title">MonoBehaviour</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">float</span> m_Speed = <span class="number">8</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">float</span> m_Tilt = <span class="number">4</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">float</span> fireRate = <span class="number">0.5F</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="built_in">float</span> nextFire = <span class="number">0.0F</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> Boundary m_Boundary;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> GameObject m_Shot;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> Transform m_ShotSpawn;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> AudioSource m_FireAudio;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> Rigidbody m_ShipRB;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> GameController m_GameController;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Use this for initialization</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Start</span> ()</span> &#123;</span><br><span class="line">		m_ShipRB = GetComponent&lt;Rigidbody&gt; ();</span><br><span class="line">		m_FireAudio = GetComponent&lt;AudioSource&gt; ();</span><br><span class="line">		GameObject gamecontrollerobject = GameObject.FindGameObjectWithTag (<span class="string">&quot;GameController&quot;</span>);</span><br><span class="line">		<span class="keyword">if</span> (gamecontrollerobject != <span class="literal">null</span>) &#123;</span><br><span class="line">			m_GameController = gamecontrollerobject.GetComponent&lt;GameController&gt;();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (m_GameController == <span class="literal">null</span>) &#123;</span><br><span class="line">			Debug.Log(<span class="string">&quot;m_GameController == null in ShipController::Start()&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Update</span>()</span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (Input.GetKey(KeyCode.J) &amp;&amp; Time.time &gt; nextFire) &#123;</span><br><span class="line">			nextFire = Time.time + fireRate;</span><br><span class="line">			GameObject clone = Instantiate (m_Shot, m_ShotSpawn.position, m_ShotSpawn.rotation) <span class="keyword">as</span> GameObject;</span><br><span class="line">			m_FireAudio.Play();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">FixedUpdate</span>()</span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (!m_GameController.IsGameEnd ()) &#123;</span><br><span class="line">			<span class="built_in">float</span> moveHorizontal = Input.GetAxis (<span class="string">&quot;Horizontal&quot;</span>);</span><br><span class="line">			<span class="built_in">float</span> moveVertical = Input.GetAxis (<span class="string">&quot;Vertical&quot;</span>);</span><br><span class="line">			Vector3 movement = <span class="keyword">new</span> Vector3 (moveHorizontal, <span class="number">0.0f</span>, moveVertical);</span><br><span class="line">			m_ShipRB.velocity = movement * m_Speed;</span><br><span class="line"></span><br><span class="line">			m_ShipRB.position = <span class="keyword">new</span> Vector3 (</span><br><span class="line">				Mathf.Clamp (m_ShipRB.position.x, m_Boundary.m_MinX, m_Boundary.m_MaxX),</span><br><span class="line">				<span class="number">0.0f</span>,</span><br><span class="line">				Mathf.Clamp (m_ShipRB.position.z, m_Boundary.m_MinZ, m_Boundary.m_MaxZ)</span><br><span class="line">			);</span><br><span class="line">			m_ShipRB.rotation = Quaternion.Euler (<span class="number">0.0f</span>, <span class="number">0.0f</span>, -m_ShipRB.velocity.x * m_Tilt);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			m_ShipRB.rotation = Quaternion.Euler(<span class="number">0.0f</span>,<span class="number">0.0f</span>,<span class="number">0.0f</span>);</span><br><span class="line">			m_ShipRB.velocity = <span class="keyword">new</span> Vector3(<span class="number">0.0f</span>,<span class="number">0.0f</span>,<span class="number">0.0f</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>GameController.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> UnityEngine.UI;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">GameController</span> : <span class="title">MonoBehaviour</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> GameObject m_Hazard;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> Vector3 m_SpawnValue = <span class="keyword">new</span> Vector3(<span class="number">5.5f</span>,<span class="number">0.0f</span>,<span class="number">8.0f</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">int</span> m_HazardCount = <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">float</span> m_SpawnWait = <span class="number">1.0f</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">float</span> m_StartWait = <span class="number">3.0f</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">float</span> m_WaveWait = <span class="number">4.0f</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> Text m_ScoreText;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> Text m_WinText;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> Button m_RestartButton;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">int</span> m_WinningScore = <span class="number">200</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="built_in">int</span> m_Score = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="built_in">bool</span> m_IsGameEnd = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="built_in">bool</span> m_RestartGame = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> AudioSource m_BackgroundAudio;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Use this for initialization</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Start</span> ()</span> &#123;</span><br><span class="line">		StartCoroutine (SpawnAsteriod());</span><br><span class="line">		UpdateScore ();</span><br><span class="line">		m_WinText.text = <span class="string">&quot;&quot;</span>;</span><br><span class="line">		m_RestartButton.gameObject.SetActive (<span class="literal">false</span>);</span><br><span class="line">		m_RestartButton.onClick.AddListener (RestartGame);</span><br><span class="line">		m_BackgroundAudio = GetComponent&lt;AudioSource&gt; ();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Update</span>()</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (m_RestartGame) &#123;</span><br><span class="line">			Debug.Log(<span class="string">&quot;Restart Game Now&quot;</span>);</span><br><span class="line">			Application.LoadLevel(Application.loadedLevel);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">IsGameEnd</span>()</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> m_IsGameEnd;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">RestartGame</span>()</span></span><br><span class="line">	&#123;</span><br><span class="line">		Debug.Log(<span class="string">&quot;Restart Button clicked&quot;</span>);</span><br><span class="line">		m_RestartGame = <span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function">IEnumerator <span class="title">SpawnAsteriod</span>()</span>&#123;</span><br><span class="line">		<span class="function"><span class="keyword">yield</span> <span class="keyword">return</span> <span class="keyword">new</span> <span class="title">WaitForSeconds</span> (<span class="params">m_StartWait</span>)</span>;</span><br><span class="line">		<span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">			<span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; m_HazardCount; i++) &#123;</span><br><span class="line">				Vector3 spawnposition =  <span class="keyword">new</span> Vector3 (Random.Range (-m_SpawnValue.x, m_SpawnValue.x), <span class="number">0.0f</span>, m_SpawnValue.z);</span><br><span class="line">				Quaternion spawnrotation = Quaternion.identity;</span><br><span class="line">				Instantiate(m_Hazard,spawnposition,spawnrotation);</span><br><span class="line">				<span class="function"><span class="keyword">yield</span> <span class="keyword">return</span> <span class="keyword">new</span> <span class="title">WaitForSeconds</span> (<span class="params">m_SpawnWait</span>)</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="function"><span class="keyword">yield</span> <span class="keyword">return</span> <span class="keyword">new</span> <span class="title">WaitForSeconds</span> (<span class="params">m_WaveWait</span>)</span>;</span><br><span class="line">			<span class="keyword">if</span>(m_IsGameEnd)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">AddScore</span>(<span class="params"><span class="built_in">int</span> score</span>)</span></span><br><span class="line">	&#123;</span><br><span class="line">		m_Score += score;</span><br><span class="line">		UpdateScore ();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">UpdateScore</span>()</span></span><br><span class="line">	&#123;</span><br><span class="line">		m_ScoreText.text = <span class="string">&quot;Score: &quot;</span> + m_Score;</span><br><span class="line">		<span class="keyword">if</span> (m_Score &gt;= m_WinningScore) &#123;</span><br><span class="line">			m_WinText.text = <span class="string">&quot;Congratulation! You Win&quot;</span>;</span><br><span class="line">			m_IsGameEnd = <span class="literal">true</span>;</span><br><span class="line">			m_RestartButton.gameObject.SetActive (<span class="literal">true</span>);</span><br><span class="line">			m_BackgroundAudio.Stop();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>DestroyByContact.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">DestroyByContact</span> : <span class="title">MonoBehaviour</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> GameObject m_ExplosionObject;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> GameObject m_PlayerExplosionObject;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> GameController m_GameController;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">int</span> m_ScoreValue = <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Start</span>()</span></span><br><span class="line">	&#123;</span><br><span class="line">		GameObject gamecontrollerobject = GameObject.FindGameObjectWithTag (<span class="string">&quot;GameController&quot;</span>);</span><br><span class="line">		<span class="keyword">if</span> (gamecontrollerobject != <span class="literal">null</span>) &#123;</span><br><span class="line">			m_GameController = gamecontrollerobject.GetComponent&lt;GameController&gt;();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (m_GameController == <span class="literal">null</span>) &#123;</span><br><span class="line">			Debug.Log(<span class="string">&quot;m_GameController == null&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">OnTriggerEnter</span>(<span class="params">Collider other</span>)</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (other.tag == <span class="string">&quot;Boundary&quot;</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span> ;</span><br><span class="line">		&#125;</span><br><span class="line">		Debug.Log (<span class="string">&quot;other.tag = &quot;</span> + other.tag);</span><br><span class="line"></span><br><span class="line">		Instantiate (m_ExplosionObject, transform.position, transform.rotation);</span><br><span class="line">		<span class="keyword">if</span> (other.tag == <span class="string">&quot;Player&quot;</span>) &#123;</span><br><span class="line">			Instantiate (m_PlayerExplosionObject, other.transform.position, other.transform.rotation);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (other.tag == <span class="string">&quot;Bullet&quot;</span>) &#123;</span><br><span class="line">			Debug.Log(<span class="string">&quot;Asteriod is destroied by Bullet&quot;</span>);</span><br><span class="line">			m_GameController.AddScore(m_ScoreValue);</span><br><span class="line">		&#125;</span><br><span class="line">		Destroy(other.gameObject);</span><br><span class="line">		Destroy (gameObject);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>DestroyByTime.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">DestroyByTime</span> : <span class="title">MonoBehaviour</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">float</span> m_LifeTime = <span class="number">5.0f</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Use this for initialization</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Start</span> ()</span> &#123;</span><br><span class="line">		Destroy (gameObject,m_LifeTime);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>GameBoundary.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">GameBoundary</span> : <span class="title">MonoBehaviour</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">OnTriggerExit</span>(<span class="params">Collider other</span>)</span> &#123;</span><br><span class="line">		Destroy(other.gameObject);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Mover.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Mover</span> : <span class="title">MonoBehaviour</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">float</span> m_Speed = <span class="number">8</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Rigidbody m_RigidBody;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> GameController m_GameController;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Use this for initialization</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Start</span> ()</span> &#123;</span><br><span class="line">		m_RigidBody = GetComponent&lt;Rigidbody&gt; ();</span><br><span class="line">		m_RigidBody.velocity = transform.forward * m_Speed;</span><br><span class="line">		GameObject gamecontrollerobject = GameObject.FindGameObjectWithTag (<span class="string">&quot;GameController&quot;</span>);</span><br><span class="line">		<span class="keyword">if</span> (gamecontrollerobject != <span class="literal">null</span>) &#123;</span><br><span class="line">			m_GameController = gamecontrollerobject.GetComponent&lt;GameController&gt;();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (m_GameController == <span class="literal">null</span>) &#123;</span><br><span class="line">			Debug.Log(<span class="string">&quot;m_GameController == null in ShipController::Start()&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Update</span>()</span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (m_GameController.IsGameEnd ()) </span><br><span class="line">		&#123;</span><br><span class="line">			m_RigidBody.rotation = Quaternion.Euler(<span class="number">0.0f</span>,<span class="number">0.0f</span>,<span class="number">0.0f</span>);</span><br><span class="line">			m_RigidBody.velocity = <span class="keyword">new</span> Vector3(<span class="number">0.0f</span>,<span class="number">0.0f</span>,<span class="number">0.0f</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>RandomRotator.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">RandomRotator</span> : <span class="title">MonoBehaviour</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">float</span> m_Tumble = <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Rigidbody m_Rigidbody;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Use this for initialization</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Start</span> ()</span> &#123;</span><br><span class="line">		m_Rigidbody = GetComponent&lt;Rigidbody&gt; ();</span><br><span class="line">		m_Rigidbody.angularVelocity = Random.insideUnitSphere * m_Tumble;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// Update is called once per frame</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Update</span> ()</span> &#123;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Captures</strong><br><em>Game Play</em><br><img src="/img/Unity/Space_Shooter_Game_Play.PNG" alt="Space_Shooter_Game_Play"><br><em>Win Game</em><br><img src="/img/Unity/Space_Shooter_Game_Win.PNG" alt="Space_Shooter_Game_Win"></p>
<p>Survival Shooter<br><strong>Game Introduction</strong><br>固定(2.5D – isometric projection)第三人称视角游戏</p>
<p><strong>Code</strong><br>CameraFollow.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CameraFollow</span> : <span class="title">MonoBehaviour</span> &#123;</span><br><span class="line">	<span class="keyword">public</span> Transform m_Target;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">float</span> m_Smoothing = <span class="number">5.0f</span>;</span><br><span class="line"></span><br><span class="line">	Vector3 m_Offset;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Use this for initialization</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Start</span> ()</span> &#123;</span><br><span class="line">		m_Offset = transform.position - m_Target.position;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Update is called once per frame</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Update</span> ()</span> &#123;</span><br><span class="line">		Vector3 targetCamPos = m_Target.position + m_Offset;</span><br><span class="line">		transform.position = Vector3.Lerp (transform.position, targetCamPos, m_Smoothing * Time.deltaTime);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>PlayerShooting.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PlayerShooting</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> damagePerShot = <span class="number">20</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">float</span> timeBetweenBullets = <span class="number">0.15f</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">float</span> range = <span class="number">100f</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="built_in">float</span> timer;</span><br><span class="line">    Ray shootRay;</span><br><span class="line">    RaycastHit shootHit;</span><br><span class="line">    <span class="built_in">int</span> shootableMask;</span><br><span class="line">    ParticleSystem gunParticles;</span><br><span class="line">    LineRenderer gunLine;</span><br><span class="line">    AudioSource gunAudio;</span><br><span class="line">    Light gunLight;</span><br><span class="line">    <span class="built_in">float</span> effectsDisplayTime = <span class="number">0.2f</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Awake</span> ()</span></span><br><span class="line">    &#123;</span><br><span class="line">        shootableMask = LayerMask.GetMask (<span class="string">&quot;Shootable&quot;</span>);</span><br><span class="line">        gunParticles = GetComponent&lt;ParticleSystem&gt; ();</span><br><span class="line">        gunLine = GetComponent &lt;LineRenderer&gt; ();</span><br><span class="line">        gunAudio = GetComponent&lt;AudioSource&gt; ();</span><br><span class="line">        gunLight = GetComponent&lt;Light&gt; ();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Update</span> ()</span></span><br><span class="line">    &#123;</span><br><span class="line">        timer += Time.deltaTime;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span>(Input.GetButton (<span class="string">&quot;Fire1&quot;</span>) &amp;&amp; timer &gt;= timeBetweenBullets &amp;&amp; Time.timeScale != <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Shoot ();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(timer &gt;= timeBetweenBullets * effectsDisplayTime)</span><br><span class="line">        &#123;</span><br><span class="line">            DisableEffects ();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">DisableEffects</span> ()</span></span><br><span class="line">    &#123;</span><br><span class="line">        gunLine.enabled = <span class="literal">false</span>;</span><br><span class="line">        gunLight.enabled = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Shoot</span> ()</span></span><br><span class="line">    &#123;</span><br><span class="line">        timer = <span class="number">0f</span>;</span><br><span class="line"></span><br><span class="line">        gunAudio.Play ();</span><br><span class="line"></span><br><span class="line">        gunLight.enabled = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">        gunParticles.Stop ();</span><br><span class="line">        gunParticles.Play ();</span><br><span class="line"></span><br><span class="line">        gunLine.enabled = <span class="literal">true</span>;</span><br><span class="line">        gunLine.SetPosition (<span class="number">0</span>, transform.position);</span><br><span class="line"></span><br><span class="line">        shootRay.origin = transform.position;</span><br><span class="line">        shootRay.direction = transform.forward;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(Physics.Raycast (shootRay, <span class="keyword">out</span> shootHit, range, shootableMask))</span><br><span class="line">        &#123;</span><br><span class="line">            EnemyHealth enemyHealth = shootHit.collider.GetComponent &lt;EnemyHealth&gt; ();</span><br><span class="line">			Debug.Log(<span class="string">&quot;Shootting&quot;</span>);</span><br><span class="line">			Debug.Log(<span class="string">&quot;shootHit.collider.name = &quot;</span> + shootHit.collider.name);</span><br><span class="line">			<span class="keyword">if</span>(enemyHealth != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">				Debug.Log(<span class="string">&quot;enermyHealth != null&quot;</span>);</span><br><span class="line">                enemyHealth.TakeDamage (damagePerShot, shootHit.point);</span><br><span class="line">            &#125;</span><br><span class="line">            gunLine.SetPosition (<span class="number">1</span>, shootHit.point);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">			Debug.Log(<span class="string">&quot;Not shot&quot;</span>);</span><br><span class="line">            gunLine.SetPosition (<span class="number">1</span>, shootRay.origin + shootRay.direction * range);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>PlayerMovement.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PlayerMovement</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">float</span> m_Speed = <span class="number">6.0f</span>;</span><br><span class="line"></span><br><span class="line">	Vector3 m_Movement;</span><br><span class="line"></span><br><span class="line">	Animator m_Anim;</span><br><span class="line"></span><br><span class="line">	Rigidbody m_PlayerRigidbody;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">int</span> m_FloorMask;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">float</span> m_CamRayLength = <span class="number">100.0f</span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Awake</span>()</span></span><br><span class="line">	&#123;</span><br><span class="line">		m_FloorMask = LayerMask.GetMask (<span class="string">&quot;Floor&quot;</span>);</span><br><span class="line"></span><br><span class="line">		m_Anim = GetComponent&lt;Animator&gt; ();</span><br><span class="line"></span><br><span class="line">		m_PlayerRigidbody = GetComponent&lt;Rigidbody&gt; ();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">FixedUpdate</span>()</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">float</span> h = Input.GetAxisRaw (<span class="string">&quot;Horizontal&quot;</span>);</span><br><span class="line">		<span class="built_in">float</span> v = Input.GetAxisRaw (<span class="string">&quot;Vertical&quot;</span>);</span><br><span class="line"></span><br><span class="line">		Move (h, v);</span><br><span class="line">		Turning ();</span><br><span class="line">		Animating(h,v);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Move</span>(<span class="params"><span class="built_in">float</span> h, <span class="built_in">float</span> v</span>)</span></span><br><span class="line">	&#123;</span><br><span class="line">		m_Movement.Set (h, <span class="number">0.0f</span>, v);</span><br><span class="line">		m_Movement = m_Movement.normalized * m_Speed * Time.deltaTime;</span><br><span class="line">		m_PlayerRigidbody.MovePosition (transform.position + m_Movement);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Turning</span>()</span></span><br><span class="line">	&#123;</span><br><span class="line">		Ray camRay = Camera.main.ScreenPointToRay (Input.mousePosition);</span><br><span class="line"></span><br><span class="line">		RaycastHit floorHit;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span>(Physics.Raycast(camRay,<span class="keyword">out</span> floorHit,m_CamRayLength, m_FloorMask))</span><br><span class="line">	   &#123;</span><br><span class="line">		Vector3 playerToMouse = floorHit.point - transform.position;</span><br><span class="line">		playerToMouse.y = <span class="number">0.0f</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		Quaternion newRotation = Quaternion.LookRotation(playerToMouse);</span><br><span class="line">		m_PlayerRigidbody.MoveRotation(newRotation);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Animating</span>(<span class="params"><span class="built_in">float</span> h, <span class="built_in">float</span> v</span>)</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">bool</span> walking = (h != <span class="number">0.0f</span> || v != <span class="number">0.0f</span>);</span><br><span class="line">		m_Anim.SetBool (<span class="string">&quot;IsWalking&quot;</span>, walking);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>PlayerHealth.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> UnityEngine.UI;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PlayerHealth</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> startingHealth = <span class="number">100</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> currentHealth;</span><br><span class="line">    <span class="keyword">public</span> Slider healthSlider;</span><br><span class="line">    <span class="keyword">public</span> Image damageImage;</span><br><span class="line">    <span class="keyword">public</span> AudioClip deathClip;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">float</span> flashSpeed = <span class="number">5f</span>;</span><br><span class="line">    <span class="keyword">public</span> Color flashColour = <span class="keyword">new</span> Color(<span class="number">1f</span>, <span class="number">0f</span>, <span class="number">0f</span>, <span class="number">0.1f</span>);</span><br><span class="line"></span><br><span class="line">    Animator anim;</span><br><span class="line">    AudioSource playerAudio;</span><br><span class="line">    PlayerMovement playerMovement;</span><br><span class="line">    <span class="comment">//PlayerShooting playerShooting;</span></span><br><span class="line">    <span class="built_in">bool</span> isDead;</span><br><span class="line">    <span class="built_in">bool</span> damaged;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Awake</span> ()</span></span><br><span class="line">    &#123;</span><br><span class="line">        anim = GetComponent &lt;Animator&gt; ();</span><br><span class="line">        playerAudio = GetComponent &lt;AudioSource&gt; ();</span><br><span class="line">        playerMovement = GetComponent &lt;PlayerMovement&gt; ();</span><br><span class="line">        <span class="comment">//playerShooting = GetComponentInChildren &lt;PlayerShooting&gt; ();</span></span><br><span class="line">        currentHealth = startingHealth;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Update</span> ()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(damaged)</span><br><span class="line">        &#123;</span><br><span class="line">            damageImage.color = flashColour;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            damageImage.color = Color.Lerp (damageImage.color, Color.clear, flashSpeed * Time.deltaTime);</span><br><span class="line">        &#125;</span><br><span class="line">        damaged = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">TakeDamage</span> (<span class="params"><span class="built_in">int</span> amount</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        damaged = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">        currentHealth -= amount;</span><br><span class="line"></span><br><span class="line">        healthSlider.<span class="keyword">value</span> = currentHealth;</span><br><span class="line"></span><br><span class="line">        playerAudio.Play ();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(currentHealth &lt;= <span class="number">0</span> &amp;&amp; !isDead)</span><br><span class="line">        &#123;</span><br><span class="line">            Death ();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Death</span> ()</span></span><br><span class="line">    &#123;</span><br><span class="line">        isDead = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//playerShooting.DisableEffects ();</span></span><br><span class="line"></span><br><span class="line">        anim.SetTrigger (<span class="string">&quot;Die&quot;</span>);</span><br><span class="line"></span><br><span class="line">        playerAudio.clip = deathClip;</span><br><span class="line">        playerAudio.Play ();</span><br><span class="line"></span><br><span class="line">        playerMovement.enabled = <span class="literal">false</span>;</span><br><span class="line">        <span class="comment">//playerShooting.enabled = false;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">RestartLevel</span> ()</span></span><br><span class="line">    &#123;</span><br><span class="line">        Application.LoadLevel (Application.loadedLevel);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>EnemyMovement.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">EnemyMovement</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    Transform player;</span><br><span class="line">    PlayerHealth playerHealth;</span><br><span class="line">    EnemyHealth enemyHealth;</span><br><span class="line">    NavMeshAgent nav;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Awake</span> ()</span></span><br><span class="line">    &#123;</span><br><span class="line">        player = GameObject.FindGameObjectWithTag (<span class="string">&quot;Player&quot;</span>).transform;</span><br><span class="line">        playerHealth = player.GetComponent &lt;PlayerHealth&gt; ();</span><br><span class="line">        enemyHealth = GetComponent &lt;EnemyHealth&gt; ();</span><br><span class="line">        nav = GetComponent &lt;NavMeshAgent&gt; ();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Update</span> ()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(enemyHealth.currentHealth &gt; <span class="number">0</span> &amp;&amp; playerHealth.currentHealth &gt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            nav.SetDestination (player.position);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            nav.enabled = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>EnemyHealth.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">EnemyHealth</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> startingHealth = <span class="number">100</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> currentHealth;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">float</span> sinkSpeed = <span class="number">2.5f</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> scoreValue = <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">public</span> AudioClip deathClip;</span><br><span class="line"></span><br><span class="line">    Animator anim;</span><br><span class="line">    AudioSource enemyAudio;</span><br><span class="line">    ParticleSystem hitParticles;</span><br><span class="line">    CapsuleCollider capsuleCollider;</span><br><span class="line">    <span class="built_in">bool</span> isDead;</span><br><span class="line">    <span class="built_in">bool</span> isSinking;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Awake</span> ()</span></span><br><span class="line">    &#123;</span><br><span class="line">        anim = GetComponent &lt;Animator&gt; ();</span><br><span class="line">        enemyAudio = GetComponent &lt;AudioSource&gt; ();</span><br><span class="line">        hitParticles = GetComponentInChildren &lt;ParticleSystem&gt; ();</span><br><span class="line">        capsuleCollider = GetComponent &lt;CapsuleCollider&gt; ();</span><br><span class="line"></span><br><span class="line">        currentHealth = startingHealth;</span><br><span class="line">		isDead = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Update</span> ()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(isSinking)</span><br><span class="line">        &#123;</span><br><span class="line">            transform.Translate (-Vector3.up * sinkSpeed * Time.deltaTime);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">TakeDamage</span> (<span class="params"><span class="built_in">int</span> amount, Vector3 hitPoint</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">		Debug.Log (<span class="string">&quot;isDead = &quot;</span> + isDead);</span><br><span class="line">        <span class="keyword">if</span>(isDead)</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        enemyAudio.Play ();</span><br><span class="line"></span><br><span class="line">        currentHealth -= amount;</span><br><span class="line">            </span><br><span class="line">        hitParticles.transform.position = hitPoint;</span><br><span class="line">        hitParticles.Play();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(currentHealth &lt;= <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Death ();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Death</span> ()</span></span><br><span class="line">    &#123;</span><br><span class="line">        isDead = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">        capsuleCollider.isTrigger = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">        anim.SetTrigger (<span class="string">&quot;Dead&quot;</span>);</span><br><span class="line"></span><br><span class="line">        enemyAudio.clip = deathClip;</span><br><span class="line">        enemyAudio.Play ();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">StartSinking</span> ()</span></span><br><span class="line">    &#123;</span><br><span class="line">        GetComponent &lt;NavMeshAgent&gt; ().enabled = <span class="literal">false</span>;</span><br><span class="line">        GetComponent &lt;Rigidbody&gt; ().isKinematic = <span class="literal">true</span>;</span><br><span class="line">        isSinking = <span class="literal">true</span>;</span><br><span class="line">        ScoreManager.score += scoreValue;</span><br><span class="line">        Destroy (gameObject, <span class="number">2f</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>EnemyAttack.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">EnemyAttack</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">float</span> timeBetweenAttacks = <span class="number">0.5f</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> attackDamage = <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">float</span> validAttackDistance = <span class="number">1.0f</span>;</span><br><span class="line"></span><br><span class="line">    Animator anim;</span><br><span class="line">    GameObject player;</span><br><span class="line">    PlayerHealth playerHealth;</span><br><span class="line">    EnemyHealth enemyHealth;</span><br><span class="line">    <span class="built_in">bool</span> playerInRange;</span><br><span class="line">    <span class="built_in">float</span> timer;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Awake</span> ()</span></span><br><span class="line">    &#123;</span><br><span class="line">        player = GameObject.FindGameObjectWithTag (<span class="string">&quot;Player&quot;</span>);</span><br><span class="line">        playerHealth = player.GetComponent &lt;PlayerHealth&gt; ();</span><br><span class="line">        enemyHealth = GetComponent&lt;EnemyHealth&gt;();</span><br><span class="line">        anim = GetComponent &lt;Animator&gt; ();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    void OnTriggerEnter (Collider other)</span></span><br><span class="line"><span class="comment">    &#123;</span></span><br><span class="line"><span class="comment">        if(other.gameObject == player)</span></span><br><span class="line"><span class="comment">        &#123;</span></span><br><span class="line"><span class="comment">            playerInRange = true;</span></span><br><span class="line"><span class="comment">        &#125;</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    void OnTriggerExit (Collider other)</span></span><br><span class="line"><span class="comment">    &#123;</span></span><br><span class="line"><span class="comment">        if(other.gameObject == player)</span></span><br><span class="line"><span class="comment">        &#123;</span></span><br><span class="line"><span class="comment">            playerInRange = false;</span></span><br><span class="line"><span class="comment">        &#125;</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">OnCollisionEnter</span>(<span class="params">Collision collision</span>)</span> &#123;</span><br><span class="line">		<span class="keyword">if</span>(collision.gameObject == player)</span><br><span class="line">		&#123;</span><br><span class="line">			playerInRange = <span class="literal">true</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">OnCollisionExit</span>(<span class="params">Collision collision</span>)</span> &#123;</span><br><span class="line">		<span class="keyword">if</span>(collision.gameObject == player)</span><br><span class="line">		&#123;</span><br><span class="line">			playerInRange = <span class="literal">false</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Update</span> ()</span></span><br><span class="line">    &#123;</span><br><span class="line">        timer += Time.deltaTime;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(timer &gt;= timeBetweenAttacks &amp;&amp; playerInRange &amp;&amp; enemyHealth.currentHealth &gt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Attack ();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(playerHealth.currentHealth &lt;= <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            anim.SetTrigger (<span class="string">&quot;PlayerDead&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Attack</span> ()</span></span><br><span class="line">    &#123;</span><br><span class="line">        timer = <span class="number">0f</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(playerHealth.currentHealth &gt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            playerHealth.TakeDamage (attackDamage);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ScoreManager.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> UnityEngine.UI;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ScoreManager</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">int</span> score;</span><br><span class="line"></span><br><span class="line">    Text text;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Awake</span> ()</span></span><br><span class="line">    &#123;</span><br><span class="line">        text = GetComponent &lt;Text&gt; ();</span><br><span class="line">        score = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Update</span> ()</span></span><br><span class="line">    &#123;</span><br><span class="line">        text.text = <span class="string">&quot;Score: &quot;</span> + score;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>EnemyManager.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">EnemyManager</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> PlayerHealth playerHealth;</span><br><span class="line">    <span class="keyword">public</span> GameObject enemy;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">float</span> spawnTime = <span class="number">3f</span>;</span><br><span class="line">    <span class="keyword">public</span> Transform[] spawnPoints;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Start</span> ()</span></span><br><span class="line">    &#123;</span><br><span class="line">        InvokeRepeating (<span class="string">&quot;Spawn&quot;</span>, spawnTime, spawnTime);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Spawn</span> ()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(playerHealth.currentHealth &lt;= <span class="number">0f</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">int</span> spawnPointIndex = Random.Range (<span class="number">0</span>, spawnPoints.Length);</span><br><span class="line"></span><br><span class="line">        Instantiate (enemy, spawnPoints[spawnPointIndex].position, spawnPoints[spawnPointIndex].rotation);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>GameOverManager.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">GameOverManager</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> PlayerHealth playerHealth;</span><br><span class="line"></span><br><span class="line">    Animator anim;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Awake</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        anim = GetComponent&lt;Animator&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Update</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">		Debug.Log (<span class="string">&quot;playerHealth.currentHealth = &quot;</span> + playerHealth.currentHealth);</span><br><span class="line">        <span class="keyword">if</span> (playerHealth.currentHealth &lt;= <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            anim.SetTrigger(<span class="string">&quot;GameOver&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Captures</strong><br><em>Game(因为一些原因没有截图)</em><br><img src="/img/Unity/Survival_Shooter_Game.PNG" alt="Survival_Shooter_Game"><br><a target="_blank" rel="noopener" href="https://unity3d.com/learn/tutorials/projects/survival-shooter-project">图片来源</a></p>
<h2 id="2D-ROGUELIKE-TUTORIAL"><a href="#2D-ROGUELIKE-TUTORIAL" class="headerlink" title="2D-ROGUELIKE-TUTORIAL"></a>2D-ROGUELIKE-TUTORIAL</h2><p><strong>Game Introduction</strong><br>Over the course of the project will create procedural tile based levels, implement turn based movement, add a hunger system, audio and mobile touch controls. </p>
<p><strong>Code</strong><br>BoardManager.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> Random = UnityEngine.Random;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BoardManager</span> : <span class="title">MonoBehaviour</span> &#123;</span><br><span class="line">	[<span class="meta">Serializable</span>]</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Count</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">public</span> <span class="built_in">int</span> minimum;</span><br><span class="line">		<span class="keyword">public</span> <span class="built_in">int</span> maximum;</span><br><span class="line"></span><br><span class="line">		<span class="function"><span class="keyword">public</span> <span class="title">Count</span>(<span class="params"><span class="built_in">int</span> min, <span class="built_in">int</span> max</span>)</span></span><br><span class="line">		&#123;</span><br><span class="line">			minimum = min;</span><br><span class="line">			maximum = max;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">int</span> columns = <span class="number">8</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">int</span> rows = <span class="number">8</span>;</span><br><span class="line">	<span class="keyword">public</span> Count wallCount = <span class="keyword">new</span> Count(<span class="number">5</span>,<span class="number">9</span>);</span><br><span class="line">	<span class="keyword">public</span> Count foodCount = <span class="keyword">new</span> Count(<span class="number">1</span>,<span class="number">5</span>);</span><br><span class="line">	<span class="keyword">public</span> GameObject exit;</span><br><span class="line">	<span class="keyword">public</span> GameObject[] floorTiles;</span><br><span class="line">	<span class="keyword">public</span> GameObject[] wallTiles;</span><br><span class="line">	<span class="keyword">public</span> GameObject[] foodTiles;</span><br><span class="line">	<span class="keyword">public</span> GameObject[] enemyTiles;</span><br><span class="line">	<span class="keyword">public</span> GameObject[] outerwallTiles;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Transform boardHolder;</span><br><span class="line">	<span class="keyword">private</span> List&lt;Vector3&gt; gridPositions = <span class="keyword">new</span> List&lt;Vector3&gt;();</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">InitialiseList</span>()</span></span><br><span class="line">	&#123;</span><br><span class="line">		gridPositions.Clear ();</span><br><span class="line"></span><br><span class="line">		<span class="keyword">for</span> (<span class="built_in">int</span> x = <span class="number">1</span>; x &lt; columns - <span class="number">1</span>; x++) </span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">for</span>(<span class="built_in">int</span> y = <span class="number">1</span>; y &lt; rows - <span class="number">1</span>; y++)</span><br><span class="line">			&#123;</span><br><span class="line">				gridPositions.Add(<span class="keyword">new</span> Vector3(x,y,<span class="number">0f</span>));</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">BoardSetup</span>()</span></span><br><span class="line">	&#123;</span><br><span class="line">		boardHolder = <span class="keyword">new</span> GameObject (<span class="string">&quot;Board&quot;</span>).transform;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">for</span>(<span class="built_in">int</span> x = <span class="number">-1</span>; x &lt; columns + <span class="number">1</span>; x++)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">for</span>(<span class="built_in">int</span> y = <span class="number">-1</span>; y &lt; rows + <span class="number">1</span>; y++)</span><br><span class="line">			&#123;</span><br><span class="line">				GameObject toInstantiate = floorTiles[Random.Range (<span class="number">0</span>,floorTiles.Length)];</span><br><span class="line">				<span class="keyword">if</span>(x == <span class="number">-1</span> || x == columns || y == <span class="number">-1</span> || y == rows)</span><br><span class="line">				&#123;</span><br><span class="line">					toInstantiate = outerwallTiles[Random.Range(<span class="number">0</span>,outerwallTiles.Length)];</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				GameObject instance = Instantiate (toInstantiate, <span class="keyword">new</span> Vector3(x,y,<span class="number">0f</span>),Quaternion.identity) <span class="keyword">as</span> GameObject;</span><br><span class="line"></span><br><span class="line">				instance.transform.SetParent(boardHolder);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function">Vector3 <span class="title">RandomPosition</span>()</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">int</span> randomIndex = Random.Range (<span class="number">0</span>, gridPositions.Count);</span><br><span class="line">		Vector3 randomPosition = gridPositions [randomIndex];</span><br><span class="line">		gridPositions.RemoveAt(randomIndex);</span><br><span class="line">		<span class="keyword">return</span> randomPosition;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">LayoutObjectAtRandom</span>(<span class="params">GameObject[] tileArray, <span class="built_in">int</span> minimum, <span class="built_in">int</span> maximum</span>)</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">int</span> objectCount = Random.Range (minimum, maximum + <span class="number">1</span>);</span><br><span class="line">		<span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; objectCount; i++) &#123;</span><br><span class="line">			Vector3 randomPosition = RandomPosition();</span><br><span class="line">			GameObject tileChoice = tileArray[Random.Range (<span class="number">0</span>, tileArray.Length)];</span><br><span class="line">			Instantiate(tileChoice, randomPosition, Quaternion.identity);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SetupScene</span>(<span class="params"><span class="built_in">int</span> level</span>)</span></span><br><span class="line">	&#123;</span><br><span class="line">		BoardSetup ();</span><br><span class="line">		InitialiseList ();</span><br><span class="line">		LayoutObjectAtRandom (wallTiles, wallCount.minimum, wallCount.maximum);</span><br><span class="line">		LayoutObjectAtRandom (foodTiles, foodCount.minimum, foodCount.maximum);</span><br><span class="line">		<span class="built_in">int</span> enemyCount = (<span class="built_in">int</span>)Mathf.Log (level, <span class="number">2f</span>);</span><br><span class="line">		LayoutObjectAtRandom (enemyTiles, enemyCount, enemyCount);</span><br><span class="line">		Instantiate (exit, <span class="keyword">new</span> Vector3 (columns - <span class="number">1</span>, rows - <span class="number">1</span>, <span class="number">0f</span>), Quaternion.identity);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>GameManager.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine.UI;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">GameManager</span> : <span class="title">MonoBehaviour</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">float</span> levelStartDelay = <span class="number">2f</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">float</span> turnDelay = <span class="number">0.1f</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> GameManager instance = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> BoardManager boardScript;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">int</span> playerFoodPoints = <span class="number">30</span>;</span><br><span class="line"></span><br><span class="line">	[<span class="meta">HideInInspector</span>]<span class="keyword">public</span> <span class="built_in">bool</span> playerTurn = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Text levelText;</span><br><span class="line">	<span class="keyword">private</span> GameObject levelImage;</span><br><span class="line">	<span class="keyword">private</span> <span class="built_in">int</span> level = <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">private</span> <span class="built_in">bool</span> doingSetup;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> List&lt;Enemy&gt; enemies;</span><br><span class="line">	<span class="keyword">private</span> <span class="built_in">bool</span> enemiesMoving;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Awake</span>()</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (instance == <span class="literal">null</span>) </span><br><span class="line">		&#123;</span><br><span class="line">			instance = <span class="keyword">this</span>;</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (instance != <span class="keyword">this</span>) </span><br><span class="line">		&#123;</span><br><span class="line">			Destroy (gameObject);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		DontDestroyOnLoad(gameObject);</span><br><span class="line"></span><br><span class="line">		enemies = <span class="keyword">new</span> List&lt;Enemy&gt; ();</span><br><span class="line"></span><br><span class="line">		boardScript = GetComponent&lt;BoardManager&gt; ();</span><br><span class="line">		InitGame ();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnLevelWasLoaded</span>(<span class="params"><span class="built_in">int</span> index</span>)</span></span><br><span class="line">	&#123;</span><br><span class="line">		level++;</span><br><span class="line"></span><br><span class="line">		InitGame ();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">InitGame</span>()</span></span><br><span class="line">	&#123;</span><br><span class="line">		doingSetup = <span class="literal">true</span>;</span><br><span class="line">		levelImage = GameObject.Find (<span class="string">&quot;LevelImage&quot;</span>);</span><br><span class="line">		levelText = GameObject.Find (<span class="string">&quot;LevelText&quot;</span>).GetComponent&lt;Text&gt; ();</span><br><span class="line">		levelText.text = <span class="string">&quot;Day &quot;</span> + level;</span><br><span class="line">		levelImage.SetActive (<span class="literal">true</span>);</span><br><span class="line">		Invoke (<span class="string">&quot;HideLevelImage&quot;</span>, levelStartDelay);</span><br><span class="line"></span><br><span class="line">		enemies.Clear ();</span><br><span class="line">		boardScript.SetupScene (level);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">HideLevelImage</span>()</span></span><br><span class="line">	&#123;</span><br><span class="line">		levelImage.SetActive (<span class="literal">false</span>);</span><br><span class="line">		doingSetup = <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">GameOver</span>()</span></span><br><span class="line">	&#123;</span><br><span class="line">		levelText.text = <span class="string">&quot;After &quot;</span> + level + <span class="string">&quot; days, you starved.&quot;</span>;</span><br><span class="line">		levelImage.SetActive (<span class="literal">true</span>);</span><br><span class="line">		enabled = <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Update is called once per frame</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Update</span> ()</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (playerTurn || enemiesMoving || doingSetup ) &#123;</span><br><span class="line">			<span class="keyword">return</span> ;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		StartCoroutine (MoveEnemies ());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">AddEnemyToList</span>(<span class="params">Enemy script</span>)</span></span><br><span class="line">	&#123;</span><br><span class="line">		enemies.Add (script);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function">IEnumerator <span class="title">MoveEnemies</span>()</span></span><br><span class="line">	&#123;</span><br><span class="line">		enemiesMoving = <span class="literal">true</span>;</span><br><span class="line">		<span class="function"><span class="keyword">yield</span> <span class="keyword">return</span> <span class="keyword">new</span> <span class="title">WaitForSeconds</span>(<span class="params">turnDelay</span>)</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (enemies.Count == <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="function"><span class="keyword">yield</span> <span class="keyword">return</span> <span class="keyword">new</span> <span class="title">WaitForSeconds</span>(<span class="params">turnDelay</span>)</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; enemies.Count; i++) &#123;</span><br><span class="line">			enemies[i].MoveEnemy();</span><br><span class="line">			<span class="function"><span class="keyword">yield</span> <span class="keyword">return</span> <span class="keyword">new</span> <span class="title">WaitForSeconds</span>(<span class="params">turnDelay</span>)</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		Debug.Log (<span class="string">&quot;GameManager::MoveEnemies&quot;</span>);</span><br><span class="line">		playerTurn = <span class="literal">true</span>;</span><br><span class="line">		enemiesMoving = <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>MovingObject.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>

<p>BoardManager.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title">MovingObject</span> : <span class="title">MonoBehaviour</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">float</span> moveTime = <span class="number">0.1f</span>;</span><br><span class="line">	<span class="keyword">public</span> LayerMask blockingLayer;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> BoxCollider2D BoxCollider;</span><br><span class="line">	<span class="keyword">private</span> Rigidbody2D rb2D;</span><br><span class="line">	<span class="keyword">private</span> <span class="built_in">float</span> inverseMoveTime;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Use this for initialization</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Start</span> ()</span> &#123;</span><br><span class="line">		BoxCollider = GetComponent&lt;BoxCollider2D&gt; ();</span><br><span class="line">		rb2D = GetComponent&lt;Rigidbody2D&gt; ();</span><br><span class="line">		inverseMoveTime = <span class="number">1f</span> / moveTime;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="built_in">bool</span> <span class="title">Move</span>(<span class="params"><span class="built_in">int</span> xDir, <span class="built_in">int</span> yDir, <span class="keyword">out</span> RaycastHit2D hit</span>)</span></span><br><span class="line">	&#123;</span><br><span class="line">		Vector2 start = transform.position;</span><br><span class="line">		Vector2 end = start + <span class="keyword">new</span> Vector2 (xDir, yDir);</span><br><span class="line"></span><br><span class="line">		BoxCollider.enabled = <span class="literal">false</span>;</span><br><span class="line">		hit = Physics2D.Linecast (start, end, blockingLayer);</span><br><span class="line">		BoxCollider.enabled = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span>( hit.transform == <span class="literal">null</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			StartCoroutine(SmoothMovement(end));</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> IEnumerator <span class="title">SmoothMovement</span>(<span class="params">Vector3 end</span>)</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">float</span> sqrRemainingDistance = (transform.position - end).sqrMagnitude;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">while</span> (sqrRemainingDistance &gt; <span class="built_in">float</span>.Epsilon) &#123;</span><br><span class="line">			Vector3 newPosition = Vector3.MoveTowards(rb2D.position, end, inverseMoveTime * Time.deltaTime);</span><br><span class="line">			rb2D.MovePosition(newPosition);</span><br><span class="line">			sqrRemainingDistance = (transform.position - end).sqrMagnitude;</span><br><span class="line">			<span class="keyword">yield</span> <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">AttemptMove</span>&lt;<span class="title">T</span>&gt;(<span class="params"><span class="built_in">int</span> xDir, <span class="built_in">int</span> yDir</span>) <span class="keyword">where</span> T : Component</span></span><br><span class="line">	&#123;</span><br><span class="line">		RaycastHit2D hit;</span><br><span class="line">		<span class="built_in">bool</span> canMove = Move (xDir, yDir, <span class="keyword">out</span> hit);</span><br><span class="line">		<span class="keyword">if</span> (hit.transform == <span class="literal">null</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span> ;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		T hitComponent = hit.transform.GetComponent&lt;T&gt; ();</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (!canMove &amp;&amp; hitComponent != <span class="literal">null</span>) &#123;</span><br><span class="line">			OnCanMove(hitComponent);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">OnCanMove</span>&lt;<span class="title">T</span>&gt;(<span class="params">T component</span>) <span class="keyword">where</span> T : Component</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Player.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> UnityEngine.UI;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Player</span> : <span class="title">MovingObject</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">int</span> wallDamage = <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">int</span> pointsPerFood = <span class="number">10</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">int</span> pointsPerSoda = <span class="number">20</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">float</span> restartLevelDelay = <span class="number">1f</span>;</span><br><span class="line">	<span class="keyword">public</span> Text foodText;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> AudioClip moveSound1;</span><br><span class="line">	<span class="keyword">public</span> AudioClip moveSound2;</span><br><span class="line">	<span class="keyword">public</span> AudioClip eatSound1;</span><br><span class="line">	<span class="keyword">public</span> AudioClip eatSound2;</span><br><span class="line">	<span class="keyword">public</span> AudioClip drinkSound1;</span><br><span class="line">	<span class="keyword">public</span> AudioClip drinkSound2;</span><br><span class="line">	<span class="keyword">public</span> AudioClip gameOverSound;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Animator animator;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="built_in">int</span> food;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Vector2 touchOrigin = -Vector2.one;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Start</span>()</span></span><br><span class="line">	&#123;</span><br><span class="line">		foodText.text = <span class="string">&quot;Food:&quot;</span> + food;</span><br><span class="line"></span><br><span class="line">		animator = GetComponent&lt;Animator&gt; ();</span><br><span class="line"></span><br><span class="line">		food = GameManager.instance.playerFoodPoints;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">base</span>.Start();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnDisable</span>()</span></span><br><span class="line">	&#123;</span><br><span class="line">		GameManager.instance.playerFoodPoints = food;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Update is called once per frame</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Update</span> ()</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (!GameManager.instance.playerTurn) &#123;</span><br><span class="line">			<span class="keyword">return</span> ;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		Debug.Log (<span class="string">&quot;Player::Update() called&quot;</span>);</span><br><span class="line">		<span class="built_in">int</span> horizontal = <span class="number">0</span>;</span><br><span class="line">		<span class="built_in">int</span> vertical = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">		<span class="meta">#<span class="keyword">if</span> UNITY_EDITOR || UNITY_STANDLONE || UNITY_WEBPLAYER</span></span><br><span class="line">		horizontal = (<span class="built_in">int</span>)Input.GetAxisRaw (<span class="string">&quot;Horizontal&quot;</span>);</span><br><span class="line">		vertical = (<span class="built_in">int</span>)Input.GetAxisRaw (<span class="string">&quot;Vertical&quot;</span>);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (horizontal != <span class="number">0</span>) &#123;</span><br><span class="line">			vertical = <span class="number">0</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span>(Input.touchCount &gt; <span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			Touch myTouch = Input.touches[<span class="number">0</span>];</span><br><span class="line">			<span class="keyword">if</span>(myTouch.phase == TouchPhase.Began)</span><br><span class="line">			&#123;</span><br><span class="line">				touchOrigin = myTouch.position;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span>(myTouch.phase == TouchPhase.Ended &amp;&amp; touchOrigin.x &gt;= <span class="number">0</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				Vector2 touchEnd = myTouch.position;</span><br><span class="line">				<span class="built_in">float</span> x = touchEnd.x - touchOrigin.x;</span><br><span class="line">				<span class="built_in">float</span> y = touchEnd.y - touchOrigin.y;</span><br><span class="line">				touchOrigin.x = <span class="number">-1</span>;</span><br><span class="line">				<span class="keyword">if</span>(Mathf.Abs(x) &gt; Mathf.Abs(y))</span><br><span class="line">				&#123;</span><br><span class="line">					horizontal = x &gt; <span class="number">0</span> ? <span class="number">1</span> : <span class="number">-1</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">else</span></span><br><span class="line">				&#123;</span><br><span class="line">					vertical = y &gt; <span class="number">0</span> ? <span class="number">1</span> : <span class="number">-1</span>;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (horizontal != <span class="number">0</span> || vertical != <span class="number">0</span> ) &#123;</span><br><span class="line">			AttemptMove&lt;Wall&gt;(horizontal, vertical);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">AttemptMove</span>&lt;<span class="title">T</span>&gt;(<span class="params"><span class="built_in">int</span> xDir, <span class="built_in">int</span> yDir</span>)</span></span><br><span class="line">	&#123;</span><br><span class="line">		food--;</span><br><span class="line">		foodText.text = <span class="string">&quot;Food:&quot;</span> + food;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">base</span>.AttemptMove&lt;T&gt; (xDir, yDir);</span><br><span class="line"></span><br><span class="line">		RaycastHit2D hit;</span><br><span class="line">		<span class="keyword">if</span>(Move (xDir, yDir, <span class="keyword">out</span> hit))</span><br><span class="line">		&#123;</span><br><span class="line">			SoundManager.instance.RandomizeSfx(moveSound1,moveSound2);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		CheckIfGameOver ();</span><br><span class="line"></span><br><span class="line">		GameManager.instance.playerTurn = <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnTriggerEnter2D</span>(<span class="params">Collider2D other</span>)</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (other.tag == <span class="string">&quot;Exit&quot;</span>) &#123;</span><br><span class="line">			Invoke (<span class="string">&quot;Restart&quot;</span>, restartLevelDelay);</span><br><span class="line">			enabled = <span class="literal">false</span>;</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (other.tag == <span class="string">&quot;Food&quot;</span>) &#123;</span><br><span class="line">			food += pointsPerFood;</span><br><span class="line">			other.gameObject.SetActive(<span class="literal">false</span>);</span><br><span class="line">			foodText.text = <span class="string">&quot;+:&quot;</span> + pointsPerFood + <span class="string">&quot;Food: &quot;</span> + food;</span><br><span class="line">			SoundManager.instance.RandomizeSfx(drinkSound1,drinkSound2);</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (other.tag == <span class="string">&quot;Soda&quot;</span>) &#123;</span><br><span class="line">			food += pointsPerSoda;</span><br><span class="line">			other.gameObject.SetActive(<span class="literal">false</span>);</span><br><span class="line">			foodText.text = <span class="string">&quot;+:&quot;</span> + pointsPerSoda + <span class="string">&quot;Food: &quot;</span> + food;			</span><br><span class="line">			SoundManager.instance.RandomizeSfx(drinkSound1,drinkSound2);</span><br><span class="line"></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnCanMove</span>&lt;<span class="title">T</span>&gt;(<span class="params">T component</span>)</span></span><br><span class="line">	&#123;</span><br><span class="line">		Wall hitWall = component <span class="keyword">as</span> Wall;</span><br><span class="line">		hitWall.DamageWall (wallDamage);</span><br><span class="line">		animator.SetTrigger (<span class="string">&quot;PlayerChop&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Restart</span>()</span></span><br><span class="line">	&#123;</span><br><span class="line">		Application.LoadLevel (Application.loadedLevel);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">LoseFood</span>(<span class="params"><span class="built_in">int</span> loss</span>)</span></span><br><span class="line">	&#123;</span><br><span class="line">		animator.SetTrigger (<span class="string">&quot;PlayerHit&quot;</span>);</span><br><span class="line">		food -= loss;</span><br><span class="line">		foodText.text = <span class="string">&quot;-:&quot;</span> + loss + <span class="string">&quot;Food: &quot;</span> + food;</span><br><span class="line">		CheckIfGameOver();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">CheckIfGameOver</span>()</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (food &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">			SoundManager.instance.PlaySingle(gameOverSound);</span><br><span class="line">			SoundManager.instance.musicSource.Stop();</span><br><span class="line">			GameManager.instance.GameOver();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Enemy.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Enemy</span> : <span class="title">MovingObject</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">int</span> playerDamager;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Animator animator;</span><br><span class="line">	<span class="keyword">private</span> Transform target;</span><br><span class="line">	<span class="keyword">private</span> <span class="built_in">bool</span> skipMove;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> AudioClip enemyAttack1;</span><br><span class="line">	<span class="keyword">public</span> AudioClip enemyAttack2;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Start</span> ()</span> &#123;</span><br><span class="line">		GameManager.instance.AddEnemyToList (<span class="keyword">this</span>);</span><br><span class="line">		animator = GetComponent&lt;Animator&gt; ();</span><br><span class="line">		target = GameObject.FindGameObjectWithTag (<span class="string">&quot;Player&quot;</span>).transform;</span><br><span class="line">		<span class="keyword">base</span>.Start ();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">AttemptMove</span>&lt;<span class="title">T</span>&gt;(<span class="params"><span class="built_in">int</span> xDir, <span class="built_in">int</span> yDir</span>)</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (skipMove) &#123;</span><br><span class="line">			skipMove = <span class="literal">false</span>;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">base</span>.AttemptMove&lt;T&gt; (xDir, yDir);</span><br><span class="line"></span><br><span class="line">		skipMove = <span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">MoveEnemy</span>()</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">int</span> xDir = <span class="number">0</span>;</span><br><span class="line">		<span class="built_in">int</span> yDir = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (Mathf.Abs (target.position.x - transform.position.x) &lt; <span class="built_in">float</span>.Epsilon) &#123;</span><br><span class="line">			yDir = target.position.y &gt; transform.position.y ? <span class="number">1</span> : <span class="number">-1</span>;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			xDir = target.position.x &gt; transform.position.x ? <span class="number">1</span> : <span class="number">-1</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		AttemptMove&lt;Player&gt; (xDir, yDir);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnCanMove</span>&lt;<span class="title">T</span>&gt;(<span class="params">T component</span>)</span></span><br><span class="line">	&#123;</span><br><span class="line">		Player hitPlayer = component <span class="keyword">as</span> Player;</span><br><span class="line"></span><br><span class="line">		animator.SetTrigger (<span class="string">&quot;enemyAttack&quot;</span>);</span><br><span class="line"></span><br><span class="line">		hitPlayer.LoseFood (playerDamager);</span><br><span class="line"></span><br><span class="line">		SoundManager.instance.RandomizeSfx (enemyAttack1, enemyAttack2);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>SoundManager.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">SoundManager</span> : <span class="title">MonoBehaviour</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> AudioSource efxSource;</span><br><span class="line">	<span class="keyword">public</span> AudioSource musicSource;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> SoundManager instance = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">float</span> lowPitchRange = <span class="number">0.95f</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">float</span> highPitchRange = <span class="number">1.05f</span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Awake</span>()</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (instance == <span class="literal">null</span>) &#123;</span><br><span class="line">			instance = <span class="keyword">this</span>;</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (instance != <span class="keyword">this</span>) &#123;</span><br><span class="line">			Destroy(gameObject);</span><br><span class="line">		&#125;</span><br><span class="line">		DontDestroyOnLoad (gameObject);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">PlaySingle</span>(<span class="params">AudioClip clip</span>)</span></span><br><span class="line">	&#123;</span><br><span class="line">		efxSource.clip = clip;</span><br><span class="line">		efxSource.Play ();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">RandomizeSfx</span>(<span class="params"><span class="keyword">params</span> AudioClip[] clips</span>)</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">int</span> randomIndex = Random.Range (<span class="number">0</span>, clips.Length);</span><br><span class="line">		<span class="built_in">float</span> randomPitch = Random.Range (lowPitchRange, highPitchRange);</span><br><span class="line"></span><br><span class="line">		efxSource.pitch = randomPitch;</span><br><span class="line">		efxSource.clip = clips [randomIndex];</span><br><span class="line">		efxSource.Play ();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Use this for initialization</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Start</span> ()</span> &#123;</span><br><span class="line">	</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// Update is called once per frame</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Update</span> ()</span> &#123;</span><br><span class="line">	</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Wall.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Wall</span> : <span class="title">MonoBehaviour</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> Sprite dmgSprite;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">int</span> hp = <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> SpriteRenderer spriteRenderer;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> AudioClip wallChop1;</span><br><span class="line">	<span class="keyword">public</span> AudioClip wallChop2;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Awake</span>()</span></span><br><span class="line">	&#123;</span><br><span class="line">		spriteRenderer = GetComponent&lt;SpriteRenderer&gt; ();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">DamageWall</span>(<span class="params"><span class="built_in">int</span> loss</span>)</span></span><br><span class="line">	&#123;</span><br><span class="line">		spriteRenderer.sprite = dmgSprite;</span><br><span class="line">		hp -= loss;</span><br><span class="line">		SoundManager.instance.RandomizeSfx (wallChop1, wallChop2);</span><br><span class="line">		<span class="keyword">if</span> (hp &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">			gameObject.SetActive(<span class="literal">false</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Loder.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Loader</span> : <span class="title">MonoBehaviour</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> GameObject gameManager;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Awake</span>()</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (GameManager.instance == <span class="literal">null</span>) </span><br><span class="line">		&#123;</span><br><span class="line">			Instantiate (gameManager);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// Update is called once per frame</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Update</span> ()</span> &#123;</span><br><span class="line">	</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Captures</strong><br><em>Game Start</em><br><img src="/img/Unity/2DRogueLike_Game_Start.PNG" alt="2DRogueLike_Game_Start"><br><em>Game Play</em><br><img src="/img/Unity/2DRogueLike_Game_Play.PNG" alt="2DRogueLike_Game_Play"><br><em>lose Game</em><br><img src="/img/Unity/2DRogueLike_Game_Lose.PNG" alt="2DRogueLike_Game_Lose"></p>
<h2 id="Particle-System"><a href="#Particle-System" class="headerlink" title="Particle System"></a>Particle System</h2><p>依然从What,Why,How这三个点来学习理解Particle System，最后在学习理解的基础上，来理解如何抽象Particle System在AB资源中的加载管理。</p>
<h3 id="What"><a href="#What" class="headerlink" title="What"></a>What</h3><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/PartSysWhatIs.html">Particles are small, simple images or meshes that are displayed and moved in great numbers by a particle system.</a>(粒子系统控制成千上万的粒子(粒子是很小很简单的image或者meshes组成)显示与移动)</p>
<p>上一张图来看下Particle System的组成：<br><img src="/img/Unity/ParticleSystemExample.PNG" alt="ParticleSystemExambple"><br>可以看到Particle System由很多部分控制组成，这里我直接关注最后一个Module，Renderer Module，因为这是影响粒子效果最终显示结果最重要的模块。</p>
<p>Renderer Module组成:<br><img src="/img/Unity/ParticleSystemRendererModule.PNG" alt="ParticleSystemRendererModule"><br>可以看到Renderer Module控制了Particle System底层用到的Material，以及显示模式等。如果我们要使用自己的Material以及Shader去实现特定的粒子效果，那么要修改的地方正是Renderer Module。</p>
<p>Note:<br>大部分粒子效果都是通过Billboard来展示的(e.g. 烟，火，雪，雾等)，因为这些对于玩家视觉效果而言通过billboard展示和纯3D模拟展示区别并不大，但billboard能降低CPU和GPU性能开销。</p>
<h3 id="Why"><a href="#Why" class="headerlink" title="Why"></a>Why</h3><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/ParticleSystems.html">There are other entities in games, however, that are fluid and intangible in nature and consequently difficult to portray using meshes or sprites. For effects like moving liquids, smoke, clouds, flames and magic spells, a different approach to graphics known as particle systems can be used to capture the inherent fluidity and energy. </a>(粒子系统是为了实现那些Sprite以及Mesh不好模拟表现的效果，比如烟雾，云，液体等效果。粒子系统本质还是基于Image或者Mesh。)</p>
<h3 id="How"><a href="#How" class="headerlink" title="How"></a>How</h3><p>在Unity里创建一个Particle System很简单，GameObject &gt; Effects &gt; Particle System或者直接给GameObject添加Particle System组件即可。</p>
<p>待续</p>
<p>Note:<br>粒子系统依然可以添加Animator去做粒子系统的帧动画属性控制。参考:<a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/PartSysUsage.html">Using Particle Systems in Unity – Animation bindings</a></p>
<h3 id="Using-in-AB"><a href="#Using-in-AB" class="headerlink" title="Using in AB"></a>Using in AB</h3><p>待续</p>
<h2 id="Animation-System"><a href="#Animation-System" class="headerlink" title="Animation System"></a>Animation System</h2><h2 id="Multiplayer-Networking"><a href="#Multiplayer-Networking" class="headerlink" title="Multiplayer Networking"></a>Multiplayer Networking</h2><p>这里采用HLAPI(Hight Level API)来制作简单的Multiplayer Networking Game。<br>我们需要通过NetworkkManager去管理网络状态。</p>
<ol>
<li>创建一个Empty Object改名为NetworkManager，然后Add NetworkManager Component到上面。 同时添加一个NetworkManagerHUD Component用于显示对NetworkManager简单控制的UI。<br><img src="/img/Unity/NetworkManagerAndHUD.PNG" alt="NetworkManagerAndHUD"><br><img src="/img/Unity/NetworkManagerHUD.PNG" alt="NetworkManagerHUD"></li>
<li>创建我们的Player Prefab(用于代表我们的Player)<br>这里简单的创建一个Capsule 和Cube GameObject简单制作一个Player Prefab<br>添加NetworkIdentity到Player上用于表示Player，并勾上Local Player Autority。<br>然后创建prefab并保存。<br><img src="/img/Unity/NetworkIdentity.PNG" alt="NetworkIdentity"><br><a target="_blank" rel="noopener" href="https://docs.unity3d.com/ScriptReference/Networking.NetworkIdentity.html">The NetworkIdentity identifies objects across the network, between server and clients. The NetworkIdentity is used to synchronize information in the object with the network.</a><br><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/UNetPlayers.html?_ga=1.67295640.827985704.1454244920">Player Object They represent the player on the server and so have the ability to run commands (which are secure client-to-server remote procedure calls) from the player’s client. In this server authoritative system, other non-player server side objects do not have the capability to receive commands directly from objects on clients.</a><br>可以看出NetworkIdentity用于在Server和Clients之间标识对象，同步信息。这样一来Player就具有了从client在server上远程执行commands的能力，就可以通过Client来控制Player Object了。</li>
<li>Registering The Player Prefab<br>在Client控制Player Object之前，我们需要去注册该Player Prefab到Network Manager，然后Network Manager会去负责在Server和Client端Spawn Object。<br>把Player Prefab设置到Network Manager的Player Prefab参数上。<br><img src="/img/Unity/RegisterPlayerPrefab.PNG" alt="RegisterPlayerPrefab"><br>Note:<br>Only the server should create instances of objects which have NetworkIdentity as otherwise they will not be properly connected to the system.(只有server可以创建含NetworkIdentity的实例对象，否则无法正常连接到server system)</li>
<li>Creating Player Movement(Single Player)<br>在通过server远程执行commands控制Player移动之前，我们先编写简单的控制逻辑用于本地的移动。<br>挂载PlayerController.cs到Player Prefab上。</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PlayerController</span> : <span class="title">MonoBehaviour</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">float</span> mRotateSpeed = <span class="number">150.0f</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">float</span> mMoveSpeed = <span class="number">3.0f</span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Update</span> ()</span> &#123;</span><br><span class="line">        <span class="keyword">var</span> x = Input.GetAxis(<span class="string">&quot;Horizontal&quot;</span>) * Time.deltaTime * mRotateSpeed;</span><br><span class="line">        <span class="keyword">var</span> z = Input.GetAxis(<span class="string">&quot;Vertical&quot;</span>) * Time.deltaTime * mMoveSpeed;</span><br><span class="line"></span><br><span class="line">        transform.Rotate(<span class="number">0</span>, x, <span class="number">0</span>);</span><br><span class="line">        transform.Translate(<span class="number">0</span>, <span class="number">0</span>, z);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="5">
<li>Testing Player Movement Online<br>支持Player Prefab单机控制后，让我们看看如何实现通过Online控制。<br>首先通过NetworkManagerHUD去把本机作为Host，点击LAN Host(H)<br><img src="/img/Unity/StartHost.PNG" alt="StartHost"><br>开启host后NetworkManager会自动根据设定的Player Prefab去创建一个。<br>为了测试我们需要运行两个游戏程序，一个作为Host，一个作为Client。<br>先打包发布PC办。<br>运行PC版作为Host。(点击LAN Hosts(H))<br>然后运行Editor版作为Client进行连接。(点击LAN Client)<br><img src="/img/Unity/TestOnlineMove.PNG" alt="TestOnlineMove"><br>在Server一侧出现了两个Player Prefab创建的对象，但在Server一侧控制的时候会控制两个物体的移动，并且在Client一侧控制并不会影响到Server一侧。<br>这是因为PlayerController脚本还没有network-aware(通过NetworkBehaviour在去获取network相关的一些信息去区分Server和Client等)。<br>所以我们还需要使Client与Host通过NetworkManager进行数据同步。</li>
<li>Networking Player Movement<br>要使PlayerController脚本network-aware，我们需要使PlayerController继承至NetworkBehaviour(所有需要networking features(receive various callback, automatically synchronize state from server-to-client……)的对象都应该继承至NetworkBehaviour)<br><a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/topics/multiplayer-networking/networking-player-movement?playlist=29690">The LocalPlayer is the player GameObject “owned” by the local Client. This ownership is set by the NetworkManager when a Client connects to the Server and new player GameObjects are created from the player prefab. When a Client connects to the Server, the instance created on the local client is marked as the LocalPlayer.</a><br>可以看出当Client连接到Server的时候，NetworkManager会把新生成的Player GameObject标记为Client的LocalPlayer，然后通过isLocalPlayer去判断是否是本地控制的对象，这样一来解决了同时控制了其他Player物体的问题。<br>但是Client和Server之间Player数据的同步还没有解决。<br>在Player Prefab上我们需要挂载NetworkTransform component，NetworkTransform 回去负责GameObject的trasnform同步。</li>
<li>Testing Multiplayer Movement<br>再次发布PC版，运行PC版作为Server，Editor版作为Client测试。<br>这遇到个错误”Spawn scene object not found for 1<br>UnityEngine.Networking.NetworkIdentity:UNetStaticUpdate()”<br><a target="_blank" rel="noopener" href="https://community.unity.com/t5/Multiplayer-Networking/UNET-Spawn-scene-object-not-found/td-p/2387695">根据这里的讨论</a>重新制作Prefab和挂载居然能解决问题，感觉是Unity的bug。<br><img src="/img/Unity/MultiplayerNetworkingMovement.PNG" alt="MultiplayerNetworkingMovement"><br>NetworkTransform的一些设定可以控制Network数据同步设定。</li>
<li>Identifying The Local Player<br> 为了显示区分Client和Server的Player对象，我们通过利用NetworkBehaviour的接口方法去修改Local Player的颜色信息。<br> OnStartLocalPlayer – “Called when the local player object has been set up.” <figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnStartLocalPlayer</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">base</span>.OnStartLocalPlayer();</span><br><span class="line">    GetComponent&lt;MeshRenderer&gt;().material.color = Color.blue;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
 <img src="/img/Unity/ChangeLocalPlayerColor.PNG" alt="ChangeLocalPlayerColor"><br> 可以看到OnStartLocalPlayer是针对于Local Player而言的，所以只有Local Player看到自己控制的对象颜色变了，在另一个Client端因为并没有同步material信息，所以看到的依然是默认Spawn的白色。(NetworkBehaviour里还有很多类似的回调方法会在Server和Client创建GameObject的时候调用)</li>
<li>Shooting(Single Player)<br> 为了增加网络交互，这里我们先测试单机版的shooting功能。<br> 创建并调整Sphere作为Bullet Prefab。同时修改Player添加Cylinder作为Gun，并设置BulletSpawn作为子弹发射点。<br> 制作完如下：<br> <img src="/img/Unity/PlayerWithFunAndBullet.PNG" alt="PlayerWithFunAndBullet"><br> 增加PlayerController.cs的射击功能。 <figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Update</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">	......</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(Input.GetKeyDown(KeyCode.Space))</span><br><span class="line">    &#123;</span><br><span class="line">        Fire();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Fire</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//Create the bullet from the prefab</span></span><br><span class="line">    GameObject bullet = (GameObject)Instantiate(mBulletPrefab, mBulletSpawn.position, mBulletSpawn.rotation);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Add velocity to the bullet</span></span><br><span class="line">    bullet.GetComponent&lt;Rigidbody&gt;().velocity = bullet.transform.forward * mBulletSpeed;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Destroy the bullet after 2 seconds</span></span><br><span class="line">    Destroy(bullet, <span class="number">2.0f</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
 然后发布联机测试：<br> <img src="/img/Unity/MultiplayerNetworkingWithBullet.PNG" alt="MultiplayerNetworkingWithBullet"><br> 从上面可以看到Bullet并没有同步显示到Server端，这是因为我们的Bullet并没有挂载NetworkIdentity脚本用于标识Server和Client对象，不具备在client在server之间信息同步的能力。并且也没有挂载NetworkTransform去同步位置数据。</li>
<li>Adding Multiplayer Shooting<br>那么通过上面的分析，要想Bullet具备网络数据同步功能，我们需要做如下几件事：<ol>
<li>Add NetworkIdentity到Bullet上(用于标识Server和Client对象，使其具备在server上执行commands能力)</li>
<li>Add NetworkTransform到Bullet上(用于同步位置信息)</li>
<li>设置Network Send Rate to 0(因为Bullet不会改变方向和速度，是通过物理驱动，所以不用同步位置信息每个Client也能计算出来)</li>
<li>添加Bullet Prefab作为Network Manager Spawnable的对象<br><img src="/img/Unity/SpawnableBullet.PNG" alt="SpawnableBullet"></li>
<li>修改PlayerController,通过CMD去Spawn Bullet</li>
</ol>
</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> UnityEngine.Networking;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PlayerController</span> : <span class="title">NetworkBehaviour</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">float</span> mRotateSpeed = <span class="number">150.0f</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">float</span> mMoveSpeed = <span class="number">3.0f</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> GameObject mBulletPrefab;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Transform mBulletSpawn;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">float</span> mBulletSpeed = <span class="number">6.0f</span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Update</span> ()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(!isLocalPlayer)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> x = Input.GetAxis(<span class="string">&quot;Horizontal&quot;</span>) * Time.deltaTime * mRotateSpeed;</span><br><span class="line">        <span class="keyword">var</span> z = Input.GetAxis(<span class="string">&quot;Vertical&quot;</span>) * Time.deltaTime * mMoveSpeed;</span><br><span class="line"></span><br><span class="line">        transform.Rotate(<span class="number">0</span>, x, <span class="number">0</span>);</span><br><span class="line">        transform.Translate(<span class="number">0</span>, <span class="number">0</span>, z);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="keyword">if</span>(Input.GetKeyDown(KeyCode.Space))</span><br><span class="line">        &#123;</span><br><span class="line">            CmdFire();</span><br><span class="line">        &#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">Command</span>]</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">CmdFire</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//Create the bullet from the prefab</span></span><br><span class="line">        GameObject bullet = (GameObject)Instantiate(mBulletPrefab, mBulletSpawn.position, mBulletSpawn.rotation);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Add velocity to the bullet</span></span><br><span class="line">        bullet.GetComponent&lt;Rigidbody&gt;().velocity = bullet.transform.forward * mBulletSpeed;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Spawn the bullet on the clients</span></span><br><span class="line">        NetworkServer.Spawn(bullet);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Destroy the bullet after 2 seconds</span></span><br><span class="line">        Destroy(bullet, <span class="number">2.0f</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnStartLocalPlayer</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">base</span>.OnStartLocalPlayer();</span><br><span class="line">        GetComponent&lt;MeshRenderer&gt;().material.color = Color.blue;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre><code>![MultiplayerNetworkingWithBulletSyn](/img/Unity/MultiplayerNetworkingWithBulletSyn.PNG)
</code></pre>
<p>为了使Bullet真正在多个Client之间同步，下面需要理解几个概念：<br>	1. Remote Actions<br>	先来看看Remote Actions的调用框架：<br>	<img src="/img/Unity/RemoteActions.PNG" alt="RemoteActions"><br>	Remote Actions分为：<br>	Commands - which are called from the client and run on the server(client调用，server执行)<br>	ClientRpc calls - which are called on the server and run on clients.(server调用，client执行)<br>	这里我们看一下Commands，前面我们提到过通过isLocalPlayer区分Local Player的控制等操作。<br>	除了通过isLocalPlayer我们还是通过Command attribute来实现。(NetworkManager在Server端创建的包含NetworkIdentity的Player Object可以通过commands的形式从client端调用server端方法)<br>	<a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/topics/multiplayer-networking/adding-multiplayer-shooting?playlist=29690">The [Command] attribute indicates that the following function will be called by the Client, but will be run on the Server.</a><br>	<a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/topics/multiplayer-networking/adding-multiplayer-shooting?playlist=29690">When making a networked command, the function name must begin with “Cmd”.</a><br>	Command方法必须以Cmd开头。<br>	<a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/UNetActions.html?_ga=1.55901730.827985704.1454244920">Commands are sent from player objects on the client to player objects on the server. Commands can only be sent from YOUR player object, so you cannot control the objects of other players.</a><br>	Commands只能从Local Player Object发送到Server端Player对应的Obejct，所以不能控制其他Player Obejct，这也就是为什么不用区分isLocalPlayer也能确保在Client端只影响Local Player Object的原因(但在Server端需要区分，不然Host点击Space会导致所有的Client都发射子弹)<br>	2. Object Spawning<br>	<a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/topics/multiplayer-networking/adding-multiplayer-shooting?playlist=29690">In the Multiplayer Networking HLAPI “Spawn” means more than just “Instantiate”. It means to create a GameObject on the Server and on all of the Clients connected to the Server. The GameObject will then be managed by the spawning system; state updates are sent to Clients when the object changes on the Server.</a><br>	可以看出Multiplayer Networking的Object Spawn是针对Server和所有Clients而言的，需要在Server上创建该GameObject然后同步到所有连接的Clients上，Server管理了所有的需要同步的状态信息。<br>	比如有2个Player，那么创建结构如下：<br>	<img src="/img/Unity/PlayerSpawning.PNG" alt="PlayerSpawning"><br>	Object和Player Objects Creation的完整流程<a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/UNetSpawning.html?_ga=1.100989192.827985704.1454244920">参考官网</a><br>11. Player Health(Single Player)<br>	增加Bullet的碰撞逻辑，编写Bullet Script。(这里遇到了Bullet脚本无效，重新制作Bullet prefab后又可以了)<br>	Bullet.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Bullet</span> : <span class="title">MonoBehaviour</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> mDamage = <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">OnCollisionEnter</span>(<span class="params">Collision collision</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        GameObject hit = collision.gameObject;</span><br><span class="line">        Health health = hit.GetComponent&lt;Health&gt;();</span><br><span class="line">        <span class="keyword">if</span>(health != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            health.TakeDamage(mDamage);</span><br><span class="line">        &#125;</span><br><span class="line">        Destroy(gameObject);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre><code>接下来Health逻辑代码。
Health.cs
</code></pre>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> UnityEngine.UI;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Health</span> : <span class="title">MonoBehaviour</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">const</span> <span class="built_in">int</span> mMaxHealth = <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> mCurrentHealth = mMaxHealth;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> RectTransform mHealthBar;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">TakeDamage</span>(<span class="params"><span class="built_in">int</span> amount</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        mCurrentHealth -= amount;</span><br><span class="line">        <span class="keyword">if</span>(mCurrentHealth &lt;= <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            mCurrentHealth = <span class="number">0</span>;</span><br><span class="line">            Debug.Log(<span class="string">&quot;Dead!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mHealthBar.sizeDelta = <span class="keyword">new</span> Vector2(mCurrentHealth, mHealthBar.sizeDelta.y);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre><code>血条可视化HealthBar制作。
用3D UI的Image来制作血条。
![PlayerWithHealthBarHierachycal](/img/Unity/PlayerWithHealthBarHierachycal.PNG)
动态修改HealthBar的Forground的Rect来显示当前血量。
![PlayerGameObjectWithHealthBar](/img/Unity/PlayerGameObjectWithHealthBar.PNG)
![HealthScriptInEditor](/img/Unity/HealthScriptInEditor.PNG)
添加Billboard脚本(挂载到HealthBarCanva上)，确保血条始终面向Camera。
Billboard.cs
</code></pre>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Billboard</span> : <span class="title">MonoBehaviour</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Update</span> ()</span> &#123;</span><br><span class="line">        transform.LookAt(Camera.main.transform);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre><code>测试效果：
![MultiplayerNetworkingWithHealthBar](/img/Unity/MultiplayerNetworkingWithHealthBar.PNG)
可以看到血条更新了但是，血条在Server和Client端并不一致，这是因为Bullet和Health脚本是工作在Local的并没有通过网络同步数据。
</code></pre>
<ol start="12">
<li>Networking Player Health<br><a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/topics/multiplayer-networking/networking-player-health?playlist=29690">Changes to the player’s current health should only be applied on the Server. These changes are then synchronized on the Clients. This is called Server Authority.</a><br>改变Player血量应该是在Server端修改，然后再同步到Client端。(这叫做Server Authority)<br>先了解一个概念<a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/UNetStateSync.html?_ga=1.102101512.827985704.1454244920">State Synchronization</a><br><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/UNetStateSync.html?_ga=1.102101512.827985704.1454244920">State Synchronization is done from the Server to Remote Clients.</a><br>还记得之前讲到的Remote Action里的ClientRpc calls吗?<br>Which are called on the server and run on clients.(server调用，client执行)<br>ClientRpc calls用于同步Server端控制的数据。(Commands用于同步Client端控制的数据，比如前面我们用Commands同步子弹发射。)<br>[SyncVars]标记的成员变量就是用于把server端控制的数据同步到client端<br><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/UNetStateSync.html?_ga=1.102101512.827985704.1454244920">SyncLists are like SyncVars but they are lists of values instead of individual values.SyncLists do not require the SyncVar attributes.</a>(SyncLists相当于List &lt; SyncVars &gt; ,SyncLists不需要[SyncVar]关键词)<br>我们可以通过重写NetworkBehaviour的OnSerialize和OnDeSerialize函数去自定义序列化行为。<br><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/UNetStateSync.html?_ga=1.102101512.827985704.1454244920">Serialization Flow on server and client详情参考</a><br>这里需要用到SyncVars来标记我们的mCurrentHealth值并且通过isServer来使TakeDamage只在Server上起作用(因为是作为Server端控制的数据)：</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">......</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Health</span> : <span class="title">NetworkBehaviour</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">const</span> <span class="built_in">int</span> mMaxHealth = <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">SyncVar</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> mCurrentHealth = mMaxHealth;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> RectTransform mHealthBar;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">TakeDamage</span>(<span class="params"><span class="built_in">int</span> amount</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(!isServer)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre><code>![SyncHealthBarOnlyOnServer](/img/Unity/SyncHealthBarOnlyOnServer.PNG)
但从上面可以看出只有Server端的血条更新，虽然Client端的值显示变化了但是血条UI却没有变化，这是因为我们指同步了mCurrentHealth数据但没有同步HealthBar Foreground的Rect。
这里需要介绍SyncVar hook. [SyncVar hooks will link a function to the SyncVar. These functions are invoked on the Server and all Clients when the value of the SyncVar changes.](https://unity3d.com/cn/learn/tutorials/topics/multiplayer-networking/networking-player-health?playlist=29690)当SyncVa变化的时候SyncVar Hooks关联的方法会在Server和所有Clients里调用。(用于更新Server和Client的一些相关数据，这里我们是为了更新HealthBar Foreground的Rect)
</code></pre>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">......</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Health</span> : <span class="title">NetworkBehaviour</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">const</span> <span class="built_in">int</span> mMaxHealth = <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">SyncVar(hook = <span class="string">&quot;OnChangeHealth&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> mCurrentHealth = mMaxHealth;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> RectTransform mHealthBar;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">TakeDamage</span>(<span class="params"><span class="built_in">int</span> amount</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">OnChangeHealth</span>(<span class="params"><span class="built_in">int</span> currenthealth</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        mHealthBar.sizeDelta = <span class="keyword">new</span> Vector2(currenthealth, mHealthBar.sizeDelta.y);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre><code>再次测试效果：
![SyncHealthBarAndValue](/img/Unity/SyncHealthBarAndValue.PNG)
终于成功的同步了mCurrentHealth数据和HealthBar Forground的Rect数据。
</code></pre>
<ol start="12">
<li>Death And Respawning<br>ClientRpc在这里正式出场(用于同步Server端控制的数据)。<br><a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/topics/multiplayer-networking/death-and-respawning?playlist=29690">ClientRpc calls can be sent from any spawned object on the Server with a NetworkIdentity. Even though this function is called on the Server, it will be executed on the Clients.</a><br>ClientRpc修饰的方法在Server端调用，但会在Client端执行。([ClientRpc]修饰的方法需要加Rpc前缀)<br>这里我们为了使Player在血量为零后Respawn，我们需要添加[ClientRpc]修饰的Respawn方法到Health脚本中。</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">......</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Health</span> : <span class="title">NetworkBehaviour</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">const</span> <span class="built_in">int</span> mMaxHealth = <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">SyncVar(hook = <span class="string">&quot;OnChangeHealth&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> mCurrentHealth = mMaxHealth;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> RectTransform mHealthBar;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">TakeDamage</span>(<span class="params"><span class="built_in">int</span> amount</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(!isServer)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mCurrentHealth -= amount;</span><br><span class="line">        <span class="keyword">if</span>(mCurrentHealth &lt;= <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            mCurrentHealth = mMaxHealth;</span><br><span class="line"></span><br><span class="line">            RpcRespawn();</span><br><span class="line"></span><br><span class="line">            Debug.Log(<span class="string">&quot;Dead!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">OnChangeHealth</span>(<span class="params"><span class="built_in">int</span> currenthealth</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        mHealthBar.sizeDelta = <span class="keyword">new</span> Vector2(currenthealth, mHealthBar.sizeDelta.y);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">ClientRpc</span>]</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">RpcRespawn</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">    	<span class="comment">//这里不知道为什么要加这个判断，按理只有对应的Client才会调用此方法</span></span><br><span class="line">        <span class="keyword">if</span>(isLocalPlayer)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//move back to zero location</span></span><br><span class="line">            transform.position = Vector3.zero;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre><code>测试效果：
![RespawnPlayer](/img/Unity/RespawnPlayer.PNG)
可以看到我们成功把生命值归零的Client重置到了原点处。
</code></pre>
<ol start="13">
<li>Handling Non-Player Obejcts<br>Enemy属于non-player，属于Server端控制的对象。<br>所以在设置NetworkIdentity的时候，勾选Server Only(<a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/topics/multiplayer-networking/handling-non-player-objects?playlist=29690">By setting Server Only to true, this prevents the Enemy Spawner from being sent to the Clients.</a>)<br><img src="/img/Unity/ServerOnly.PNG" alt="ServerOnly"><br>添加Enemy Spawn的功能。<br>EnemySpawner.cs</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> UnityEngine.Networking;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">EnemySpawner</span> :  <span class="title">NetworkBehaviour</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> GameObject mEnemyPrefab;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> mNumberOfEnemies;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnStartServer</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">base</span>.OnStartServer();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; mNumberOfEnemies; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            Vector3 spawnposition = <span class="keyword">new</span> Vector3(</span><br><span class="line">                                                Random.Range(<span class="number">-8.0f</span>, <span class="number">8.0f</span>),</span><br><span class="line">                                                <span class="number">0.0f</span>,</span><br><span class="line">                                                Random.Range(<span class="number">-8.0f</span>, <span class="number">8.0f</span>));</span><br><span class="line"></span><br><span class="line">            Quaternion spawnrotation =  Quaternion.Euler(</span><br><span class="line">                                                        <span class="number">0.0f</span>,</span><br><span class="line">                                                        Random.Range(<span class="number">0</span>, <span class="number">180</span>),</span><br><span class="line">                                                        <span class="number">0.0f</span>);</span><br><span class="line"></span><br><span class="line">            GameObject enemy = (GameObject)Instantiate(mEnemyPrefab,spawnposition, spawnrotation);</span><br><span class="line">            NetworkServer.Spawn(enemy);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre><code>[OnStartServer is called on the Server when the Server starts listening to the Network](https://unity3d.com/cn/learn/tutorials/topics/multiplayer-networking/handling-non-player-objects?playlist=29690)
OnStartServer在Server端启动的时候调用，这里用来初始化敌人。
在Player Prefab基础上制作EnemyPrefab。
![EnemyPrefab](/img/Unity/EnemyPrefab.PNG)
添加EnemyPrefab到NetworkManager的Spawnable List里。
![EnemySpawnableList](/img/Unity/EnemySpawnableList.PNG)
设置EnemySpawner。
![EnemySpawner](/img/Unity/EnemySpawner.PNG)
测试效果：
![MultiplayerNetworkingWithEnemy](/img/Unity/MultiplayerNetworkingWithEnemy.PNG)
成功创建了Server管理的Enemy。
</code></pre>
<ol start="14">
<li>Destroying Enemies<br>因为Enemy Prefab采用的是Player的Health设定，所以生命值归零时会重置到原点，这并非我们想要的，我们需要Enemy被打死后被摧毁掉。<br>这里需要修改Health脚本去做判断。</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">......</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Health</span> : <span class="title">NetworkBehaviour</span> &#123;</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">TakeDamage</span>(<span class="params"><span class="built_in">int</span> amount</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(!isServer)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mCurrentHealth -= amount;</span><br><span class="line">        <span class="keyword">if</span>(mCurrentHealth &lt;= <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (mDestroyOnDeath)</span><br><span class="line">            &#123;</span><br><span class="line">                Destroy(gameObject);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                mCurrentHealth = mMaxHealth;</span><br><span class="line"></span><br><span class="line">                RpcRespawn();</span><br><span class="line">            &#125;</span><br><span class="line">            Debug.Log(<span class="string">&quot;Dead!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    .......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre><code>在Enemy Prefab上勾选mDestroyOnDeath。
再次测试：
![DestroyEnemyWhenEnemyDead](/img/Unity/DestroyEnemyWhenEnemyDead.PNG)
成功摧毁Enemy。
</code></pre>
<ol start="15">
<li>Spawning And Respawning<br>随机Spawn到不同的位置。<br>The NetworkStartPosition component可以用于spawn object到不同的位置。<br>在场景里创建Gameobject添加NetworkStartPosition并设定位置。<br>NetworkManager会自动去找到这些带有NetworkStartPosition component的Gameobject，把他们的位置作为Start Position的选项。(Round Robin Player Spawn Method on the Network Manager)<br>Spawn和Respawn等内容详情参考<a target="_blank" rel="noopener" href="https://unity3d.com/cn/learn/tutorials/topics/multiplayer-networking/spawning-and-respawning?playlist=29690">Spawning and Respawning</a><br>Multiplayer Networking教程学习终于结束了。但初次接触Unity Networking的学习，还有很多地方理解错误的地方，欢迎纠正。</li>
</ol>
<h1 id="编辑器界面"><a href="#编辑器界面" class="headerlink" title="编辑器界面"></a>编辑器界面</h1><ol>
<li><p><strong>Hierachy</strong><br>游戏组成元素(这个tutorial里，好比小球，方块，地面，摄像机，灯光，墙等)<br>主要用于对物件的归类管理</p>
<ol>
<li>Create Empty可以用于层次管理归类</li>
</ol>
</li>
<li><p><strong>Project</strong><br>游戏原件管理（这个tutorial里，好比材质，C#脚本）<br>主要用于对一次性资源的归类管理</p>
<ol>
<li>可通过创建Folder进行资源整理归类</li>
</ol>
</li>
<li><p><strong>Scene</strong><br>编辑场景</p>
<ol>
<li>右上角可以切换视角</li>
<li>可以切换Local和Global模式进行移动物体</li>
</ol>
</li>
<li><p><strong>Game</strong><br>运行时场景（可动态编辑查看物体属性）</p>
</li>
<li><p><strong>Inspector</strong><br>对象属性查看</p>
<ol>
<li>通过物体名字左边的Active勾选框可以决定物体是否在编辑器可见可选</li>
<li>可以通过点击界面的？来打开相应面板的介绍页面</li>
</ol>
</li>
</ol>
<h1 id="工具"><a href="#工具" class="headerlink" title="工具"></a>工具</h1><h2 id="MonoDevelop"><a href="#MonoDevelop" class="headerlink" title="MonoDevelop"></a>MonoDevelop</h2><p>C#,Js脚本编辑器(也可自己设定编辑器为VS  Edit-&gt;Preference-&gt;External Tools-&gt;External Script Editor)</p>
<h2 id="ILSpy"><a href="#ILSpy" class="headerlink" title="ILSpy"></a>ILSpy</h2><p><a target="_blank" rel="noopener" href="http://ilspy.net/">ILSpy is the open-source .NET assembly browser and decompiler.</a><br>可以用于反编译一些Unity项目学习源代码</p>
<h2 id="ildasm-安装VS自带的工具"><a href="#ildasm-安装VS自带的工具" class="headerlink" title="ildasm(安装VS自带的工具)"></a>ildasm(安装VS自带的工具)</h2><p>IL反编译工具<br>可以通过这个工具查看编译生成的IL中间代码</p>
<h2 id="Blender"><a href="#Blender" class="headerlink" title="Blender"></a>Blender</h2><p><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Blender_software">Blender is a professional free and open-source 3D computer graphics software product used for creating animated films, visual effects, art, 3D printed models, interactive 3D applications and video games.</a><br>主要用于制作一些3D模型和动画然后到处FBX用于Unity</p>
<h2 id="VSTU"><a href="#VSTU" class="headerlink" title="VSTU"></a>VSTU</h2><p>工具原名UnityVS，由于微软收购了SyntaxTree(制作UnityVS的公司)的公司，微软将UnityVS置入了VS开发套件中。<br>VSTU(Visual Studio Tools For Unity)<br>使Visual Studio支持Unity开发。<br>好处：</p>
<ol>
<li>构建多平台游戏</li>
<li>在Visual Studio中调试</li>
<li>在Visual Studio创建Unity脚本</li>
<li>使用Visual Studio提高工作效率(e.g. 智能提示，高亮，快速查询Unity API，快速查询或插入Unity方法等)</li>
<li>免费获取开发Unity所需的全部内容<br>既然能让我们继续使用熟悉的VS作为开发IDE，那么让我们看看怎么集成安装吧。<br><a target="_blank" rel="noopener" href="https://msdn.microsoft.com/en-us/library/dn940025.aspx">Unity version 4.0.0 or higher; Unity version 5.2.0 or higher to take advantage of built-in support for Visual Studio Tools for Unity version 2.1 or higher.</a><br>注意Unity 5.2.0及以上版本已经内置支持VSTU了。<br>这里讲讲老版本需要如何安装继承VSTU:</li>
<li><a target="_blank" rel="noopener" href="https://msdn.microsoft.com/en-us/library/dn940025.aspx">下载对应版本的VSTU</a></li>
<li>导入VSTU到Unity(Assets -&gt; Import Package -&gt; Visual Studio 20** Tools)</li>
<li>设置Unity debug开发环境(File -&gt; Building Setting 下勾选Development Build和Script Debugging)</li>
<li>设定VS 20<strong>作为默认IDE(Edit -&gt; Preference -&gt; External Tools -&gt; External Script Editor设置成VS 20</strong>)</li>
<li><a target="_blank" rel="noopener" href="https://msdn.microsoft.com/en-us/library/dn940020.aspx#debugging-your-project-in-a-unity-player">支持调试managed dll</a></li>
</ol>
<p>这里使用VSTU有几个快捷和帮助快速开发的小技巧：</p>
<ol>
<li>Ctrl+Shift+M(显示可定义的Monobehavior方法，并帮助自动生成方法定义)</li>
<li>Ctrl+Shift+Q(熟悉了Unity API后，这个可以快速检索方法并生成方法定义)</li>
<li>Alt+Shift+E(查看Unity项目目录结构文件)</li>
<li>F5快速调试Unity Code(首先需要设定Unity debug环境(前面提到过)，然后需要通过Debug -&gt; Attach Unity Debugger(Attach到Unity进程上，最后运行Unity即可))</li>
<li>Unity的错误，警告等信息显示在VS的error list里</li>
</ol>
<h1 id="相关概念学习"><a href="#相关概念学习" class="headerlink" title="相关概念学习"></a>相关概念学习</h1><h2 id="Unity-Engine"><a href="#Unity-Engine" class="headerlink" title="Unity Engine"></a>Unity Engine</h2><p><a target="_blank" rel="noopener" href="http://inpla.net/thread-8197-1-1.html">参考文章</a></p>
<h3 id="C-Sharp"><a href="#C-Sharp" class="headerlink" title="C Sharp"></a>C Sharp</h3><p>Unity支持C#的作为编程语言，这里不得不了解下C#的历史。<br><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/C%E2%99%AF">C#是微软推出的一种基于.NET框架的、面向对象的高级编程语言。C#的发音为“C sharp”，模仿音乐上的音名“C♯”（C调升），是C语言的升级的意思。其正确写法应和音名一样为“C♯”[来源请求]，但大多数情况下“♯”符号被井号“#”所混用；两者差别是：“♯”的笔画是上下偏斜的，而“#”的笔画是左右偏斜。C♯由C语言和C++派生而来，继承了其强大的性能，同时又以.NET框架类库作为基础，拥有类似Visual Basic的快速开发能力。C#由安德斯·海尔斯伯格主持开发，微软在2000年发布了这种语言。</a><br><a href="http://tonytang1990.github.io/2015/08/15/CSharp-Study/">相关C#学习</a></p>
<h3 id="Mono"><a href="#Mono" class="headerlink" title="Mono"></a>Mono</h3><p><a target="_blank" rel="noopener" href="http://inpla.net/thread-8197-1-1.html">C#虽好，但是只能在Windows上运行，微软那时候也没有将其开源，所以总是会有人说不能跨平台，光就这点，C#和Java就不能比呀。微软公司已经向ECMA申请将C#作为一种标准。在2001年12月，ECMA发布了ECMA-334 C#语言规范。C#在2003年成为一个ISO标准（ISO&#x2F;IEC 23270）。这意味着只要你遵守CLI（Common Language Infrastructure），第三方可以将任何一种语言实现到.Net平台之上。Mono就是在这种环境下诞生的。Mono是一个由Xamarin公司（先前是Novell,最早为Ximian）所主持的自由开放源代码项目。该项目的目标是创建一系列符合ECMA标准（Ecma-334和Ecma-335）的.NET工具，包括C#编译器和通用语言架构。与微软的.NET Framework（共通语言运行平台）不同，Mono项目不仅可以运行于Windows系统上，还可以运行于Linux，FreeBSD，Unix，OS X和Solaris，甚至一些游戏平台，例如：Playstation 3，Wii或XBox 360之上。Mono使得C#这门语言有了很好的跨平台能力。相对于微软的.Net Framework运行时库Mono使用自己的Mono VM作为运行时库。</a></p>
<p>——————–2018&#x2F;04&#x2F;22————————————-<br>突然找到一篇讲述.Net，Mono以及Unity之间关系的好文，里面详细梳理了.Net,C#,Mono和Unity之前的关系和概念，结合<a href="http://tonytang1990.github.io/2015/08/15/CSharp-Study/#%E7%9B%B8%E5%85%B3%E6%A6%82%E5%BF%B5">.Net Framework相关概念</a>可以加深理解，这里给出这篇好文的链接:<a target="_blank" rel="noopener" href="https://blog.csdn.net/myqtmacc/article/details/70500099">扒一扒.net、.net framework、mono和Unity</a><br>——————–2018&#x2F;04&#x2F;22————————————-</p>
<h3 id="IL2CPP"><a href="#IL2CPP" class="headerlink" title="IL2CPP"></a>IL2CPP</h3><p>既然Mono这么好，那么为什么还需要IL2CPP了？</p>
<h4 id="Why-do-we-need-IL2CPP"><a href="#Why-do-we-need-IL2CPP" class="headerlink" title="Why do we need IL2CPP?"></a>Why do we need IL2CPP?</h4><ol>
<li>C# runtime performance still lags behind C&#x2F;C++(C#运行效率没有C&#x2F;C++好)</li>
<li>Latest and greatest .NET language and runtime features are not supported in Unity’s current version of Mono.(新版本的.Net语言和运行时特性没有被当前的Unity版本支持)</li>
<li>With around 23 platforms and architecture permutations, a large amount of effort is required for porting, maintaining, and offering feature and quality parity.(Mono VM在跨平台的维护上很费时费力)</li>
<li>Garbage collection can cause pauses while running(Mono VM现有的GC很容易使得游戏卡顿)</li>
</ol>
<h4 id="IL2CPP-Components"><a href="#IL2CPP-Components" class="headerlink" title="IL2CPP Components"></a>IL2CPP Components</h4><ol>
<li>AOT(Ahead of Time) compiler<br><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Ahead-of-time_compilation">Ahead-of-time (AOT) compilation is the act of compiling a high-level programming language such as C or C++, or an intermediate language such as Java bytecode or .NET Common Intermediate Language (CIL) code, into a native (system-dependent) machine code with the intention of executing the resulting binary file natively.</a>(预编译IL到系统相关的机器代码。 C# -&gt; IL -&gt; C++ -&gt; Machine code)</li>
<li>IL2CPP Virtual Machine<br>Provide additional services (like a GC, metadata, platform specific resources)(提供运行时的一些功能比如GC,访问平台相关资源等)</li>
</ol>
<h4 id="Mono-and-IL2CPP-compile-and-execution-process"><a href="#Mono-and-IL2CPP-compile-and-execution-process" class="headerlink" title="Mono and IL2CPP compile and execution process"></a>Mono and IL2CPP compile and execution process</h4><p>我们来看看使用Mono和使用IL2CPP时的脚本编译运行过程：<br><a target="_blank" rel="noopener" href="http://inpla.net/thread-8197-1-1.html">下面两张图来源</a><br>Mono:<br><img src="/img/Unity/Mono.png" alt="Mono"></p>
<p>IL2CPP:<br><img src="/img/Unity/IL2CPP.png" alt="IL2CPP"><br>从上图可以看出编译成IL后，会被IL2CPP再次编译成C++，然后通过Native的C++编译器编译C++代码到相关平台的汇编代码，最后运行在IL2CPP VM里。<br>这样做的好处官网提到了下几点：</p>
<ol>
<li><p>Performance(效率上的优化)，原因如下<br> . C++ compilers and linkers provide a vast array of advanced optimisations previously unavailable.<br> . Static analysis is performed on your code for optimisation of both size and speed.<br> . Unity-focused optimisations to the scripting runtime.</p>
</li>
<li><p>All code generation is done to C++ rather than architecture specific machine code. The cost of porting and maintenance of architecture specific code generation is now more amortised. (因为现在是通过利用现有的C++编译器编译C++而没有直接编译成特定架构的机器代码，这样一来跨平台的移植和维护责任就更分散了)</p>
</li>
<li><p>Feature development and bug fixing proceed much faster. For us, days of mucking in architecture specific files are replaced by minutes of changing C++. Features and bug fixes are immediately available for all platforms. (功能开发和bug修改更容易快捷。通过修改IL2CPP的C++生成就能快速的针对多个平台有效)</p>
</li>
<li><p>IL2CPP is not tied to any one specific garbage collector, instead interacting with a pluggable API(GC导致游戏卡顿的现象也可以通过不同的GC方式来改善)</p>
</li>
</ol>
<p>Note:<br>IL2CPP支持了arm64机器架构(Mono不支持, Apple新出的设备大多基于arm64)</p>
<h3 id="AOT-JIT"><a href="#AOT-JIT" class="headerlink" title="AOT &amp; JIT"></a>AOT &amp; JIT</h3><p>之前有讲到过AOT和JIT，那么这里为什么还要再次提他了？<br>主要原因是在IOS平台开发中，Mono .NET只支持AOT(Ahead of Time预编译生成所有对应机器代码)，而不是通过JIT在运行时去编译成对应的机器代码。在IOS上采用full-AOT模式。<br>在这一限制下，我们必须明白什么是AOT什么是JIT，并且要知道哪些特性会使用到JIT导致IOS不支持。</p>
<h4 id="AOT"><a href="#AOT" class="headerlink" title="AOT"></a>AOT</h4><p><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Ahead-of-time_compilation">AOT详细介绍</a><br>AOT大概意思就是预编译所有的IL到系统相关的机器代码。 C# -&gt; IL -&gt; C++ -&gt; Machine code</p>
<h4 id="JIT"><a href="#JIT" class="headerlink" title="JIT"></a>JIT</h4><p>JIT:<br>在<a href="http://tonytang1990.github.io/2015/08/15/CSharp-Study/#Executing_Assembly_Code">C# Study</a>中有讲到JIT是在执行Assembly Code(也就是C#编译的CIL中间程序)运行时编译成本地机器代码。<br>Full-AOT模式可以看出Mono .NET在IOS上不支持动态生成代码。<br>那么具体哪些特性不被IOS支持，哪些用法会触发动态生成代码了？</p>
<h4 id="IOS-AOT-Limitations"><a href="#IOS-AOT-Limitations" class="headerlink" title="IOS AOT Limitations"></a>IOS AOT Limitations</h4><p><a target="_blank" rel="noopener" href="https://developer.xamarin.com/guides/ios/advanced_topics/limitations/#.NET.c2.a0API.c2.a0Limitations">IOS AOT limitations</a></p>
<ol>
<li>Profiler</li>
<li>Reflection.Emit</li>
<li>Reflection.Emit.Save functionality</li>
<li>COM bindings</li>
<li>The JIT engine</li>
<li>Metadata verifier (since there is no JIT)</li>
</ol>
<p>在这里我从官网提取几个典型问题来说明：</p>
<ol>
<li>P&#x2F;Invokes in Generic Types<br>P&#x2F;Invokes in generic classes aren’t supported:</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title">GenericType</span>&lt;<span class="title">T</span>&gt; &#123;</span><br><span class="line">    [<span class="meta">DllImport (<span class="string">&quot;System&quot;</span>)</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">extern</span> <span class="built_in">int</span> <span class="title">getpid</span> ()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre><code>不支持对泛型类的P/Invoke
</code></pre>
<ol start="2">
<li>Value types as Dictionary Keys<br>值类型作为Dictionary的Key时会有问题，实际上实现了IEquatable<T>的类型都会有此问题，因为Dictionary的默认构造函数会使用EqualityComparer<TKey>.Default作为比较器，而对于实现了IEquatable<T>的类型，EqualityComparer<TKey>.Default要通过反射来实例化一个实现了IEqualityComparer<TKey>的类（可以参考EqualityComparer<T>的实现）。 解决方案是自己实现一个IEqualityComparer<TKey>，然后使用Dictionary&lt;TKey, TValue&gt;(IEqualityComparer<TKey>)构造器创建Dictionary实例。<br>讲到如果T实现了IEquatable<T>，那么就会反射实例化一个实现了IEqualityCompareer<TKey>的类，这里通过查看EqaulityCompare<T>源码可以看到确实如此。</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title">EqualityComparer</span>&lt;<span class="title">t</span>&gt; : IEqualityComparer, <span class="title">IEqualityComparer</span>&lt;<span class="title">t</span>&gt;</span> </span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="title">EqualityComparer</span>&lt;<span class="title">t</span>&gt; defaultComparer</span>; </span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="title">EqualityComparer</span>&lt;<span class="title">t</span>&gt; Default</span> &#123;</span><br><span class="line">        [<span class="meta">System.Security.SecuritySafeCritical</span>]  <span class="comment">// auto-generated </span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> !FEATURE_CORECLR</span></span><br><span class="line">        [<span class="meta">TargetedPatchingOptOut(<span class="string">&quot;Performance critical to inline across NGen image boundaries&quot;</span>)</span>]</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        <span class="keyword">get</span> &#123; </span><br><span class="line">            Contract.Ensures(Contract.Result&lt;equalitycomparer&lt;t&gt;&gt;() != <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">            EqualityComparer&lt;t&gt; comparer = defaultComparer; </span><br><span class="line">            <span class="keyword">if</span> (comparer == <span class="literal">null</span>) &#123;</span><br><span class="line">                comparer = CreateComparer(); </span><br><span class="line">                defaultComparer = comparer;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> comparer;</span><br><span class="line">        &#125; </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">System.Security.SecuritySafeCritical</span>]  <span class="comment">// auto-generated </span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="title">EqualityComparer</span>&lt;<span class="title">t</span>&gt; <span class="title">CreateComparer</span>()</span> &#123;</span><br><span class="line">        Contract.Ensures(Contract.Result&lt;equalitycomparer&lt;t&gt;&gt;() != <span class="literal">null</span>); </span><br><span class="line"></span><br><span class="line">        RuntimeType t = (RuntimeType)<span class="keyword">typeof</span>(T);</span><br><span class="line">        <span class="comment">// Specialize type byte for performance reasons</span></span><br><span class="line">        <span class="keyword">if</span> (t == <span class="keyword">typeof</span>(<span class="built_in">byte</span>)) &#123; </span><br><span class="line">            <span class="keyword">return</span> (EqualityComparer&lt;t&gt;)(<span class="built_in">object</span>)(<span class="keyword">new</span> ByteEqualityComparer());</span><br><span class="line">        &#125; </span><br><span class="line">        <span class="comment">// If T implements IEquatable&lt;t&gt; return a GenericEqualityComparer&lt;t&gt; </span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">typeof</span>(IEquatable&lt;t&gt;).IsAssignableFrom(t)) &#123;</span><br><span class="line">            <span class="comment">//return (EqualityComparer&lt;t&gt;)Activator.CreateInstance(typeof(GenericEqualityComparer&lt;&gt;).MakeGenericType(t)); </span></span><br><span class="line">            <span class="keyword">return</span> (EqualityComparer&lt;t&gt;)RuntimeTypeHandle.CreateInstanceForAnotherGenericParameter((RuntimeType)<span class="keyword">typeof</span>(GenericEqualityComparer&lt;<span class="built_in">int</span>&gt;), t);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// If T is a Nullable&lt;u&gt; where U implements IEquatable&lt;u&gt; return a NullableEqualityComparer&lt;u&gt;</span></span><br><span class="line">        <span class="keyword">if</span> (t.IsGenericType &amp;&amp; t.GetGenericTypeDefinition() == <span class="keyword">typeof</span>(Nullable&lt;&gt;)) &#123; </span><br><span class="line">            RuntimeType u = (RuntimeType)t.GetGenericArguments()[<span class="number">0</span>];</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">typeof</span>(IEquatable&lt;&gt;).MakeGenericType(u).IsAssignableFrom(u)) &#123; </span><br><span class="line">                <span class="comment">//return (EqualityComparer&lt;t&gt;)Activator.CreateInstance(typeof(NullableEqualityComparer&lt;&gt;).MakeGenericType(u)); </span></span><br><span class="line">                <span class="keyword">return</span> (EqualityComparer&lt;t&gt;)RuntimeTypeHandle.CreateInstanceForAnotherGenericParameter((RuntimeType)<span class="keyword">typeof</span>(NullableEqualityComparer&lt;<span class="built_in">int</span>&gt;), u);</span><br><span class="line">            &#125; </span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// If T is an int-based Enum, return an EnumEqualityComparer&lt;t&gt;</span></span><br><span class="line">        <span class="comment">// If you update this check, you need to update the METHOD__JIT_HELPERS__UNSAFE_ENUM_CAST case in getILIntrinsicImplementation</span></span><br><span class="line">        <span class="keyword">if</span> (t.IsEnum &amp;&amp; Enum.GetUnderlyingType(t) == <span class="keyword">typeof</span>(<span class="built_in">int</span>)) </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> (EqualityComparer&lt;t&gt;)RuntimeTypeHandle.CreateInstanceForAnotherGenericParameter((RuntimeType)<span class="keyword">typeof</span>(EnumEqualityComparer&lt;<span class="built_in">int</span>&gt;), t); </span><br><span class="line">        &#125; </span><br><span class="line">        <span class="comment">// Otherwise return an ObjectEqualityComparer&lt;t&gt;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ObjectEqualityComparer&lt;t&gt;(); </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre><code>注意下面这个分支
</code></pre>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// If T implements IEquatable&lt;t&gt; return a GenericEqualityComparer&lt;t&gt; </span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">typeof</span>(IEquatable&lt;t&gt;).IsAssignableFrom(t)) &#123;</span><br><span class="line">    <span class="comment">//return (EqualityComparer&lt;t&gt;)Activator.CreateInstance(typeof(GenericEqualityComparer&lt;&gt;).MakeGenericType(t)); </span></span><br><span class="line">    <span class="keyword">return</span> (EqualityComparer&lt;t&gt;)RuntimeTypeHandle.CreateInstanceForAnotherGenericParameter((RuntimeType)<span class="keyword">typeof</span>(GenericEqualityComparer&lt;<span class="built_in">int</span>&gt;), t);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre><code>当我们的的T也就是我们的Dictionary&lt;TKey,TValue&gt;里面的TKey实现了IEquatable&lt;T&gt;接口的话，里面的代码实现看不太懂，大概是动态创建实现了IEqualityComparer&lt;TKey&gt;的类，然后实例化返回了一个作为TKey的EqualityComparer。
&quot;This works for reference types (as the reflection+create a new type step is skipped)&quot;
当我们传递的TKey是reference types的时候不会触发创建实现了IEqualityCompareer&lt;TKey&gt;的类，直接返回ObjectEqualityComparer&lt;t&gt;()。
解决方案：
如果我们一定要在IOS上把value type作为Dictionary的Key的话，我们需要自己实现一个实现了IEqualityCompareer&lt;TKey&gt;的类，然后作为TKey的EqualityComparer传递给Dictionary&lt;TKey,TVlue&gt;的构造函数。
比如我们要给int添加我们自己的比较方法，那么按如下方式写即可。
</code></pre>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ValueTypeComparer</span> : <span class="title">EqualityComparer</span>&lt;<span class="title">int</span>&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="built_in">bool</span> <span class="title">Equals</span>(<span class="params"><span class="built_in">int</span> a, <span class="built_in">int</span> b</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;ValueTypeComparer:Equals() called&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (a == b)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="built_in">int</span> <span class="title">GetHashCode</span>(<span class="params"><span class="built_in">int</span> a</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;ValueTypeComparer:GetHashCode() called&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> a.GetHashCode();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] <span class="keyword">args</span></span>)</span></span><br><span class="line">	&#123;</span><br><span class="line">	    ValueTypeComparer valuetypecomparer = <span class="keyword">new</span> ValueTypeComparer();</span><br><span class="line">	    <span class="built_in">int</span> vt1 = <span class="number">1</span>;</span><br><span class="line">	    Dictionary&lt;<span class="built_in">int</span>, <span class="built_in">bool</span>&gt; mydictionary1 = <span class="keyword">new</span> Dictionary&lt;<span class="built_in">int</span>, <span class="built_in">bool</span>&gt;(valuetypecomparer);</span><br><span class="line">	    mydictionary1.Add(vt1, <span class="literal">true</span>);</span><br><span class="line">	    mydictionary1.ContainsKey(vt1);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre><code>![ValueTypeComparerForDictionary](/img/CSharp/ValueTypeComparerForDictionary.PNG)
</code></pre>
<ol start="3">
<li>System.Reflection.Emit<br><a target="_blank" rel="noopener" href="https://msdn.microsoft.com/en-us/library/system.reflection.emit(v=vs.110).aspx">The System.Reflection.Emit namespace contains classes that allow a compiler or tool to emit metadata and Microsoft intermediate language (MSIL) and optionally generate a PE file on disk.</a><br>可以看出System.Reflection.Emit是用于动态生成代码，这一点明显违背了Full-AOT的原则。<br>在了解Emit是如何动态生成代码之前，可以先了解一下<a href="http://tonytang1990.github.io/2015/08/15/CSharp-Study/#Platform_Invoke">AppDomain的概念</a><br>AppDomain负责Assebmly的加载和隔离，代码是加载在AppDomain里执行的。<br>接下来让我们看看System.Reflection.Emit是如何动态生成代码的：<br>先来看下MSDN官网介绍<br><a target="_blank" rel="noopener" href="https://msdn.microsoft.com/en-us/library/system.reflection.emit(v=vs.110).aspx">The System.Reflection.Emit namespace contains classes that allow a compiler or tool to emit metadata and Microsoft intermediate language (MSIL) and optionally generate a PE file on disk.</a></li>
</ol>
<p>可以看出System.Reflection.Emit包含了很多可以动态创建程序集，类，方法的类。<br>以下学习主要参考<a target="_blank" rel="noopener" href="http://www.cnblogs.com/hui088/p/4571484.html">C#反射发出System.Reflection.Emit学习</a><br>这位博主对Emit研究的很透侧，讲解的也通熟易懂。<br>Emit生成代码的基本流程：</p>
<ol>
<li>构建程序集</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">AssemblyName aname = <span class="keyword">new</span> AssemblyName(<span class="string">&quot;DynamicgAssembly&quot;</span>);</span><br><span class="line">AssemblyBuilder ab = AppDomain.CurrentDomain.DefineDynamicAssembly(aname, AssemblyBuilderAccess.RunAndSave);</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>创建模块</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ModuleBuilder mb = ab.DefineDynamicModule(aname.Name, aname.Name + <span class="string">&quot;.dll&quot;</span>);</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>定义类</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TypeBuilder tb = mb.DefineType(<span class="string">&quot;DynamicType&quot;</span>, TypeAttributes.Public);</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>定义类成员(方法，属性等)</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">   <span class="comment">// 创建方法签名</span></span><br><span class="line">   MethodBuilder methodb = tb.DefineMethod(<span class="string">&quot;Hello&quot;</span>,MethodAttributes.Public);</span><br><span class="line">   <span class="comment">// 定义方法实现</span></span><br><span class="line">   <span class="comment">// 这里比较重要，可以把这里理解成代码反编译之后的函数调用操作的代码化</span></span><br><span class="line">   ILGenerator il = methodb.GetILGenerator();</span><br><span class="line">   <span class="comment">//OpCodes包含所有的Microsoft Intermediate Language (MSIL) instructions </span></span><br><span class="line">	<span class="comment">//OpCodes.Ldstr表示加载一个字符串到evaluation stack。</span></span><br><span class="line">il.Emit(OpCodes.Ldstr, <span class="string">&quot;Hello, World!&quot;</span>);</span><br><span class="line">   <span class="comment">//OpCodes.Call表示调用方法</span></span><br><span class="line">il.Emit(OpCodes.Call, <span class="keyword">typeof</span>(Console).GetMethod(<span class="string">&quot;WriteLine&quot;</span>, <span class="keyword">new</span> Type[] &#123; <span class="keyword">typeof</span>(<span class="built_in">string</span>) &#125;));</span><br><span class="line">   <span class="comment">//OpCodes.Ret表示返回，当evaluation stack有值时会返回栈顶值。</span></span><br><span class="line">il.Emit(OpCodes.Ret);</span><br><span class="line"></span><br><span class="line">tb.CreateType();</span><br></pre></td></tr></table></figure>
<ol start="5">
<li>创建Assembly</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ab.Save(<span class="string">&quot;DynamicAssemble.dll&quot;</span>);</span><br></pre></td></tr></table></figure>
<p><img src="/img/CSharp/EmitStudy.PNG" alt="EmitStudy"><br>结合反编译我们生成的DynamicAssemble.dll可以看出，我们是通过Emit把函数定义用IL指令定义出来了。<br>毫无疑问这是动态生成了程序集，方法等，所以在Full-AOT面前，IOS是不支持的。<br>让我们来看个实际的问题：<br>[The game crashes with the error message “ExecutionEngineException: Attempting to JIT compile method ‘SometType&#96;1<SomeValueType>:.ctor ()’ while running with –aot-only.](<a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/TroubleShootingIPhone.html">https://docs.unity3d.com/Manual/TroubleShootingIPhone.html</a>)<br>这里是由于在序列化的时候使用了泛型方法导致的。<br><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/TroubleShootingIPhone.html">The Mono .NET implementation for iOS is based on AOT. It compiles only those generic type methods (where a value type is used as a generic parameter) which are explicitly used by other code. When such methods are used only via reflection or from native code (ie, the serialization system) then they get skipped during AOT compilation.The AOT compiler can be hinted to include code by adding a dummy method somewhere in the script code. This can refer to the missing methods and so get them compiled ahead of time.</a><br>可以看出在Full-AOT下，如果我们在反射和序列化中使用泛型方法，该方法会被AOT过滤掉，不预编译，要想使该泛型方法参与预编译，我们需要定义一个不使用的方法去显示调用该类去通知AOT去预编译该方法。<br>本人遇到这个问题是：<br>ExecutionEngineException: Attempting to JIT compile method ‘**TypeMetadata:.ctor ()’ while running with –aot-only<br><a target="_blank" rel="noopener" href="http://answers.unity3d.com/questions/30930/why-did-my-binaryserialzer-stop-working.html">Why did my BinarySerialzer stop working?</a><br>根据上面的说法是BinaryFormatter里的ObjectWriter去动态生成了我们自定义的value type类导致的JIT。<br>通过下面代码可以使ObjectWriter采用反射去实现而非JIT生成动态类。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Environment.SetEnvironmentVariable(<span class="string">&quot;MONO_REFLECTION_SERIALIZER&quot;</span>, <span class="string">&quot;yes&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>但是反射很慢，如果频繁进行序列化反序列化的话，在IOS上并不是一种好的解决办法。<br><a target="_blank" rel="noopener" href="http://forum.unity3d.com/threads/protobuf-net-unity-is-it-worth-it.288007/">根据这里的讨论</a>，可以看出Google Protocol Buffers是一个不错的解决方案(当然我们得绕过默认使用JIT)。</p>
<p>Note:<br>IOS只支持static code, Unlike traditional Mono&#x2F;.NET, code on the iPhone is statically compiled ahead of time instead of being compiled on demand by a JIT compiler(IOS只支持full aot，不支持JIT).所以有些动态特性没法被Full AOT支持。<br>But the entire Reflection API, including Type.GetType (“someClass”), listing methods, listing properties, fetching attributes and values works just fine.(反射依然在IOS可用)</p>
<h4 id="Protocol-Buffers"><a href="#Protocol-Buffers" class="headerlink" title="Protocol Buffers"></a>Protocol Buffers</h4><p>详情参考:<a href="http://tonytang1990.github.io/2018/03/18/Data-Config-Automation/">Data-Config-Automation</a></p>
<h2 id="Unity-Using"><a href="#Unity-Using" class="headerlink" title="Unity Using"></a>Unity Using</h2><ol>
<li><strong>Layout</strong> – 排版，可用于存储我们在Unity里面的面板排版设置，通过制定layout使用特定排版</li>
<li><strong>Prefab</strong> – 原件，可在场景里重复利用，而且Prefab的改变可以通过点击Inspector界面的Apply影响到所有从该Prefab里创建出的对象</li>
<li><strong>Tag</strong>  – Scene里面所有物体的唯一标识，用于确保正确识别物体，通过对物体添加tag可以在程序里用于身份判别</li>
<li><strong>Static collider</strong> – will not be affected by collision (not cause collide). Unity keep static collider mesh in cach</li>
<li><strong>Dynamic collider</strong> – will be affected by collision</li>
<li><strong>Is Trigger</strong> – when no collide caused(e.g. static collider), we can use trigger to enter collide event(只有没有物理碰撞的物体才会触发Trigger的)</li>
<li><strong>Rigibody body</strong> – Moved by using physical force, use dynamic collider</li>
<li><strong>Kinematic body</strong> – Moved by using the transform instead of physical force</li>
<li><strong>Mesh Collider</strong> – Use Model mesh as collider mesh (一般只用于简单的三角形数量少的mesh)</li>
<li><strong>AudioSource</strong> – 声音在Unity里也是组件的形式存在</li>
<li><strong>C# Script</strong> – 每个物体可以绑定多个脚本用于不同逻辑，特别是用于原件一些特有的逻辑特性</li>
<li><strong>2.5D</strong> – 在3D的世界里通过平行投影(Orthographic Projection - isometric projection)实现</li>
<li><strong>Raycast</strong> – 射线碰撞检测（Physics.Raycast()在物体是is triiger on的时候不会触发）</li>
<li><strong>LayerMask</strong> – 可以用于选择和射线检测过滤</li>
<li><strong>NavMeshAgent</strong> – Unity的Navigation system可以提供最基本的路径AI寻址(只需要指定agent相关参数，在代码里设定跟踪目标) – 添加后需要Bake Navigation</li>
<li><strong>Animation Controller</strong> – 动画管理，通过给物体添加Animator并设定动画状态机之间的切换规则来实现动画状态切换管理(通过给UI添加Animator我们也可以在Anmation面板设置简单动画)</li>
<li><strong>LineRenderer</strong> – 可以用于在3D世界里绘制线条，实现可视化一些射线检测物体碰撞等</li>
<li><strong>Select icon</strong> – 可以给没有实际物体或透明物体一个颜色标记(容易看到3D世界位置)</li>
<li><strong>Canvas</strong> – 画布是所有UI所应该在的区域(UI的层级关系会影响渲染顺序) – 通过设定Render Mode实现不同的效果(Screen Space - Overlay不会受Camera的投影方式影响，永远在场景上. Screen Space - Camera会受Camera的投影方式影响，比如在透视投影里就会有近大远小的效果. World Space会把UI当做3D空间里的物体来对待，有深度概念会被遮挡 ))</li>
<li><strong>Physics2D.Linecast</strong> – 可用于检测特定layer的射线检测</li>
<li>**<em>Input</em> – 不同平台要使用不同平台的AIP<br>e.g.</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">if</span> UNITY_EDITOR || UNITY_STANDLONE || UNITY_WEBPLAYER</span></span><br><span class="line">	horizontal = (<span class="built_in">int</span>)Input.GetAxisRaw (<span class="string">&quot;Horizontal&quot;</span>);</span><br><span class="line">	vertical = (<span class="built_in">int</span>)Input.GetAxisRaw (<span class="string">&quot;Vertical&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (horizontal != <span class="number">0</span>) &#123;</span><br><span class="line">		vertical = <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">	<span class="keyword">if</span>(Input.touchCount &gt; <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		Touch myTouch = Input.touches[<span class="number">0</span>];</span><br><span class="line">		<span class="keyword">if</span>(myTouch.phase == TouchPhase.Began)</span><br><span class="line">		&#123;</span><br><span class="line">			touchOrigin = myTouch.position;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span>(myTouch.phase == TouchPhase.Ended &amp;&amp; touchOrigin.x &gt;= <span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			Vector2 touchEnd = myTouch.position;</span><br><span class="line">			<span class="built_in">float</span> x = touchEnd.x - touchOrigin.x;</span><br><span class="line">			<span class="built_in">float</span> y = touchEnd.y - touchOrigin.y;</span><br><span class="line">			touchOrigin.x = <span class="number">-1</span>;</span><br><span class="line">			<span class="keyword">if</span>(Mathf.Abs(x) &gt; Mathf.Abs(y))</span><br><span class="line">			&#123;</span><br><span class="line">				horizontal = x &gt; <span class="number">0</span> ? <span class="number">1</span> : <span class="number">-1</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">			&#123;</span><br><span class="line">				vertical = y &gt; <span class="number">0</span> ? <span class="number">1</span> : <span class="number">-1</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;	</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<ol start="22">
<li><strong>DontDestroyOnLoad()</strong> – 加载新的scene的时候保证对象不会被销毁</li>
<li><strong>Invoke()</strong> – 延时调用方法</li>
</ol>
<h1 id="快捷键学习"><a href="#快捷键学习" class="headerlink" title="快捷键学习"></a>快捷键学习</h1><p>F – 在Scene界面选中对象后可以快速聚焦到该物体<br>Ctrl + ‘ – 打开脚本的类Reference page<br>Ctrl + D – Duplicated（复制）物体</p>
<h1 id="项目编译发布"><a href="#项目编译发布" class="headerlink" title="项目编译发布"></a>项目编译发布</h1><h2 id="PC"><a href="#PC" class="headerlink" title="PC"></a>PC</h2><ol>
<li>File -&gt; Build Setting 设置平台PC</li>
<li>Drag Scene file to Scenes to build 选择要编译的场景</li>
<li>点击Build 编译游戏</li>
</ol>
<h2 id="IOS"><a href="#IOS" class="headerlink" title="IOS"></a>IOS</h2><h3 id="Native-Code-Compilation"><a href="#Native-Code-Compilation" class="headerlink" title="Native Code Compilation"></a>Native Code Compilation</h3><p>PC平台使用C++编写的库的时候是通过lib或者dll的静态和动态链接<br>但在IOS移动平台使用的时候，这些代码必须以插件的形式调用，以静态方式链接。<br><a target="_blank" rel="noopener" href="http://docs.unity3d.com/Manual/Plugins.html">Managed plugins and Native Plugins</a></p>
<p>Note:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">if</span> UNITY_IPHONE || UNITY_XBOX360</span></span><br><span class="line"><span class="comment">//On iOS and Xbox 360 plugins are statically linked into</span></span><br><span class="line"><span class="comment">//the executable, so we have to use **Internal as the</span></span><br><span class="line"><span class="comment">//library name.</span></span><br><span class="line">[<span class="meta">DllImport (<span class="string">&quot;**Internal&quot;</span>)</span>]</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="comment">// Other platforms load plugins dynamically, so pass the name</span></span><br><span class="line"><span class="comment">// of the plugin&#x27;s dynamic library.</span></span><br><span class="line">[<span class="meta">DllImport (<span class="string">&quot;PluginName&quot;</span>)</span>]</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p>在真正编译到IOS上使用之前，我们必须通过cross compile把Native code编译成.a的文件，然后静态链接到项目中使用。（需要在Mac电脑上cross compile）</p>
<p>以下以开源工具Zlib为例：<br><a target="_blank" rel="noopener" href="http://www.zlib.net/">Zlib Download</a></p>
<p><a target="_blank" rel="noopener" href="http://blog.karmadust.com/category/ios/">参考文章:Building Universal Binaries for iOS</a></p>
<p>解压打开文件夹后会发现，目录下有MakeFile, .configure, MakeFile.in等文件。<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Makefile">MakeFile</a>是编写了编译规则的文件用于自动编译的工具(在Unix，Linux系统上广泛运用)。而configure和MakeFile.in是通过<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Autoconf">Autoconf</a>和<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Automake">Automake</a>工具生成，用于编写高阶语言来生成makefile而无需手动编写复杂的makefie.。通过调用.configure并传入参数，.configure就会以MakeFile.in为模板产生我们预期的MakeFile。（这里我对MakeFile,autoconf,automake都不熟悉，现阶段的认识是这样的）</p>
<p>我们将会通过.configure生成我们需要的Makefile用于编译程序:</p>
<ol>
<li>.configure –prefix&#x3D;${PWD}&#x2F;installdir(用于生成makefile，–prefix用于指定make install后的文件夹)</li>
<li>unset CC(先重置一次CC编译设定，避免出问题) </li>
<li>export CC&#x3D;”xcrun -sdk iphoneos clang -arch armv7”(这里很重要，在调用makefile之前，我们通过设置环境变量CC的值来指定make的编译设定，比如编译工具，编译架构等，-sdk 指定SDK路径用于搜索相关工具(比如编译工具等) -arch 用于指定编译出的文件架构类型)</li>
<li>make clean(清理make生成的文件)</li>
<li>make(执行makefile进行编译)</li>
<li>make install(安装make生成的相关文件到对应目录)</li>
<li>lipo -info libz.a(通过lipo工具来查看生成的libz.a文件是基于什么架构的)</li>
</ol>
<p>上述有几个概念需要提一下：<br><a target="_blank" rel="noopener" href="https://developer.apple.com/library/mac/documentation/Darwin/Reference/ManPages/man1/xcrun.1.html">xcrum</a>(个人理解是，通过这个工具可以在不改makefile的前提下，通过命令行指定开发工具的一些信息) properties.<br>clang – <a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Clang">clang是 是一个C、C++、Objective-C和Objective-C++编程语言的编译器前端。它采用了底层虚拟机（LLVM）作为其后端。它的目标是提供一个GNU编译器套装（GCC）的替代品。Clang是LLVM编译器工具集的前端（front-end），目的是输出代码对应的抽象语法树（Abstract Syntax Tree, AST），并将代码编译成LLVM Bitcode。接着在后端（back-end）使用LLVM编译成平台相关的机器语言 。Clang支持C、C++、Objective C。</a>(可以理解成Mac上的编译工具，支持多种语言编译生成多种平台相关的机器语言)<br>Universal binary – 可以理解成multiarchitecture binary，支持多种架构的二进制文件（比如我们这里针对IOS生成的armv7架构的libz.a，我们也可以再生成一个针对simulator的i386架构的libz.a，然后通过执行lipo -create -arch i386 libz.a(386) -arch armv7 libz.a(armv7) -output libz_fatbinary.a生成同时支持simulator和IOS的.a文件）<br>lipo – 苹果上用于生成Universal binary的工具(lipo -info libz.a用于查看.a文件支持的架构信息)</p>
<p>Note:<br>Simulator（模拟器）使用的.a文件是基于i386的，而IOS真机使用的.a文件是基于armv7 or armv8的。</p>
<h3 id="Prepare-XCode-Project"><a href="#Prepare-XCode-Project" class="headerlink" title="Prepare XCode Project"></a>Prepare XCode Project</h3><ol>
<li>File -&gt; Build Setting 设置平台IOS</li>
<li>Drag Scene file to Scenes to build 选择要编译的场景</li>
<li>点击Build</li>
</ol>
<p>这样一来XCode项目就生成了。</p>
<h3 id="Compile-XCode-Project"><a href="#Compile-XCode-Project" class="headerlink" title="Compile XCode Project"></a>Compile XCode Project</h3><p>条件：</p>
<ol>
<li>需要苹果开发者账号<br>待续……</li>
</ol>
<p>Note:<br><a target="_blank" rel="noopener" href="https://cmake.org/">跨平台自动化编译工具CMake</a></p>
<h1 id="版块学习"><a href="#版块学习" class="headerlink" title="版块学习"></a>版块学习</h1><h2 id="UGUI"><a href="#UGUI" class="headerlink" title="UGUI"></a>UGUI</h2><p>在Unity 4.6版本后推出的官方的GUI</p>
<h3 id="Coordinates-System"><a href="#Coordinates-System" class="headerlink" title="Coordinates System"></a>Coordinates System</h3><p><a target="_blank" rel="noopener" href="http://stackoverflow.com/questions/21937544/working-with-the-coordinate-system-and-game-screen-in-unity-2d">下面的定义来源</a></p>
<ol>
<li><p>Screen coordinates<br>Is 2D, measured in pixels and start in the lower left corner at (0,0) and go to (Screen.width, Screen.height). Screen coordinates change with the resolution of the device, and even the orientation (if you app allows it) on mobile devices.<br>左下角为(0,0)，右上角为(Screen.width, Screen.height)</p>
</li>
<li><p>GUI coordinates<br>Is used by the GUI system. They are identical to Screen coordinates except that they start at (0,0) in the upper left and go to (Screen.width, Screen.height) in the lower right.<br>左上角为(0,0)，右下角为(Screen.width, Screen.height)</p>
</li>
<li><p>Viewport coordinates<br>Is the same no matter what the resolution. The are 2D, start at (0,0) in the lower left and go to (1,1) in the upper right. For example (0.5, 0.5) in viewport coordinates will be the center of the screen no matter what resolution or orientation.<br>相对于摄像机坐标系而言的，近平面(0,0)，远平面(1,1)，(0.5,0.5)表示在摄像机坐标系的中间。</p>
</li>
<li><p>World coordinates<br>Is a 3D coordinates system and where all of your object live.<br>世界坐标系的(x,y,z)</p>
</li>
</ol>
<h3 id="Unity-Unit-Pixel-Per-Unit"><a href="#Unity-Unit-Pixel-Per-Unit" class="headerlink" title="Unity Unit &amp; Pixel Per Unit"></a>Unity Unit &amp; Pixel Per Unit</h3><ol>
<li><p>Unity Unit<br>Unity Unit代表Unity里的一个Unit单位代表物理大小，默认是1 unit &#x3D; 1 meter<br>所以我们在建模的时候如果想导入到Unity后保持scale(1,1,1)就应该把建模软件也设定成1 unit &#x3D; 1 meter。<br>Unity Unit主要影响的是Physical(比如重力加速度的运算，如果修改Unit为厘米，但不重新计算重力加速度，那么物体会落的很快)</p>
</li>
<li><p>Pixel Per Unit<br>Pixel Per Unit主要影响Sprite在屏幕上的映射显示。表示多少个像素等价于一个Unit，后面会详细讲到。</p>
</li>
</ol>
<h3 id="Canvas"><a href="#Canvas" class="headerlink" title="Canvas"></a>Canvas</h3><p><a target="_blank" rel="noopener" href="http://docs.unity3d.com/Manual/UICanvas.html">The Canvas is the area that all UI elements should be inside.(所有的UI元素都必须处于Canvas里)</a><br>以下学习参考<a target="_blank" rel="noopener" href="http://k79k06k02k.com/blog/24/unity/unity-ugui-%E5%8E%9F%E7%90%86%E7%AF%87%E4%BA%8C%EF%BC%9Acanvas-scaler-%E7%B8%AE%E6%94%BE%E6%A0%B8%E5%BF%83">Unity UGUI 原理篇(二)：Canvas Scaler 縮放核心</a><br>UI Render Space:<br>Screen Space(Overlay) – 不会受Camera的投影方式影响，永远在场景上.(不用设置Camera)<br>Screen Space(Camera) – 需要设置Camera，会受Camera的投影方式影响，比如在透视投影里就会有近大远小的效果，有遮挡的概念. (正交投影会根据摄像机的Orthographic Size和PPU设定去显示UI)。Screen Space下屏幕分辨率变化，Canva会自动缩放UI去适应。<br>World Space – 会把UI当做3D空间里的物体来对待，有深度概念会被遮挡。</p>
<p>Canvas Scaler：<br><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/script-CanvasScaler.html">The Canvas Scaler component is used for controlling the overall scale and pixel density of UI elements in the Canvas. This scaling affects everything under the Canvas, including font sizes and image borders.</a><br>可以看出Canvas Scaler是控制了UI在画布上的具体显示，这个好比NGUI里UIRoot下的Scaling Style设定。<br>UI Scale Mode有如下三种:</p>
<ol>
<li>Constant Pixel Size<br> <a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/script-CanvasScaler.html">Makes UI elements retain the same size in pixels regardless of screen size.</a><br> 保持UI像素大小与屏幕大小无关(相当于NGUI里的UIRoot的PixelPerfect)<br> 参数Scale Factor – <a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/script-CanvasScaler.html">Scales all UI elements in the Canvas by this factor.</a><br> 通过Scale Factor去scale canvas的大小已达到整体scale UI的目的。<br> 我们设置屏幕大小为1024 * 768，Scale Factor为1时：<br> <img src="/img/Unity/ConstantPixelSizeScaleFactor.PNG" alt="ConstantPixelSizeScaleFactor"><br> 可以看到Canva Size为1024 * 768，Scale为(1,1,1)<br> 当我们设置Scale Factor为2时：<br> <img src="/img/Unity/ConstantPixelSizeScaleFactor2.PNG" alt="ConstantPixelSizeScaleFactor2"><br> 可以看到Canva Size为512 * 384，Scale为(2,2,1)<br> 这样一来所有Canva下的UI就相当于放大了两倍。<br> Note:<br> 这里注意区分Screen Size和Canva Size是两个概念。<br> 参数Reference Pixels Per Unit – <a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/script-CanvasScaler.html">If a sprite has this ‘Pixels Per Unit’ setting, then one pixel in the sprite will cover one unit in the UI.</a><br> PPU指定了多少个像素表示一个Unit。如果Sprite有设置PPU，那么会把Sprite里的1 pixel转换成UI中的1 pixel。<br> 这里引用下源码，<a target="_blank" rel="noopener" href="http://k79k06k02k.com/blog/24/unity/unity-ugui-%E5%8E%9F%E7%90%86%E7%AF%87%E4%BA%8C%EF%BC%9Acanvas-scaler-%E7%B8%AE%E6%94%BE%E6%A0%B8%E5%BF%83">下面源码来源</a><br> Image.cs</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="built_in">float</span> pixelsPerUnit</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">get</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">float</span> spritePixelsPerUnit = <span class="number">100</span>;</span><br><span class="line">        <span class="keyword">if</span> (sprite)</span><br><span class="line">            spritePixelsPerUnit = sprite.pixelsPerUnit;</span><br><span class="line"> </span><br><span class="line">        <span class="built_in">float</span> referencePixelsPerUnit = <span class="number">100</span>;</span><br><span class="line">        <span class="keyword">if</span> (canvas)</span><br><span class="line">            referencePixelsPerUnit = canvas.referencePixelsPerUnit;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">return</span> spritePixelsPerUnit / referencePixelsPerUnit;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">	</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">SetNativeSize</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (overrideSprite != <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">float</span> w = overrideSprite.rect.width / pixelsPerUnit;</span><br><span class="line">        <span class="built_in">float</span> h = overrideSprite.rect.height / pixelsPerUnit;</span><br><span class="line">        rectTransform.anchorMax = rectTransform.anchorMin;</span><br><span class="line">        rectTransform.sizeDelta = <span class="keyword">new</span> Vector2(w, h);</span><br><span class="line">        SetAllDirty();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre><code>可以看到当我们设置了Sprite的PPU后，Sprite的可显示区域(Rect)的大小计算如下：
SpriteRectSize =  SpriteSize * SpritePPU / CanvaReferencePPU
所以如果我们设置SpritePPU和CanvaReferencePPU一样，那么SpriteRect的大小就会以Sprite的原始大小为准。
Note:
SetNatieSize需要通过点击Image Component的Set Native Size触发。
</code></pre>
<ol start="2">
<li>Scale With Screen Size<br> 以预设的Resolution为基准来进行自适应计算。(相当于NGUI里的Fixed Size)<br> Screen Match Mode的设定则决定了如何基于高度和宽度变化去适应。<br> 以下是CanvasScaler.cs源码：</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">Vector2 screenSize = <span class="keyword">new</span> Vector2(Screen.width, Screen.height);</span><br><span class="line"> </span><br><span class="line"><span class="built_in">float</span> scaleFactor = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">switch</span> (m_ScreenMatchMode)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">case</span> ScreenMatchMode.MatchWidthOrHeight:</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// We take the log of the relative width and height before taking the average.</span></span><br><span class="line">        <span class="comment">// Then we transform it back in the original space.</span></span><br><span class="line">        <span class="comment">// the reason to transform in and out of logarithmic space is to have better behavior.</span></span><br><span class="line">        <span class="comment">// If one axis has twice resolution and the other has half, it should even out if widthOrHeight value is at 0.5.</span></span><br><span class="line">        <span class="comment">// In normal space the average would be (0.5 + 2) / 2 = 1.25</span></span><br><span class="line">        <span class="comment">// In logarithmic space the average is (-1 + 1) / 2 = 0</span></span><br><span class="line">        <span class="built_in">float</span> logWidth = Mathf.Log(screenSize.x / m_ReferenceResolution.x, kLogBase);</span><br><span class="line">        <span class="built_in">float</span> logHeight = Mathf.Log(screenSize.y / m_ReferenceResolution.y, kLogBase);</span><br><span class="line">        <span class="built_in">float</span> logWeightedAverage = Mathf.Lerp(logWidth, logHeight, m_MatchWidthOrHeight);</span><br><span class="line">        scaleFactor = Mathf.Pow(kLogBase, logWeightedAverage);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> ScreenMatchMode.Expand:</span><br><span class="line">    &#123;</span><br><span class="line">        scaleFactor = Mathf.Min(screenSize.x / m_ReferenceResolution.x, screenSize.y / m_ReferenceResolution.y);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> ScreenMatchMode.Shrink:</span><br><span class="line">    &#123;</span><br><span class="line">        scaleFactor = Mathf.Max(screenSize.x / m_ReferenceResolution.x, screenSize.y / m_ReferenceResolution.y);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre><code>Screen Match Mode有三中：
1. MatchWidthOrHeight(根据Screen Size相对于预设Resolution的宽度和高度变化去计算ScaleFactor(缩放Canva Size))
	举例说明：
	Reference Size为1024 * 768。Screen Size为960 * 640。
    LogWidth = Mathf.Log(screenSize.x / m_ReferenceResolution.x, kLogBase) = Log2( 960 / 1024) = Log2(0.9375);
    LogHeight = Mathf.Log(screenSize.y / m_ReferenceResolution.y, kLogBase) = Log2( 640 / 768) = Log2(0.8333);
    logWeightedAverage = Mathf.Lerp(logWidth, logHeight, m_MatchWidthOrHeight) = Lerp(Log2(0.9375), Log2(0.8333), MatchWidthOrHeight));
    scaleFactor = Mathf.Pow(kLogBase, logWeightedAverage) = Pow(2, Lerp(Log2(0.9375), Log2(0.8333), MatchWidthOrHeight)));
    MatchWidthOrHeight会决定Width和Height Scale所占比例。
    如果MatchWidthOrHeight为0。
    scaleFactor = Mathf.Pow(kLogBase, logWeightedAverage) = Pow(2, Lerp(Log2(0.9375), Log2(0.8333), 0))) = Pow(2, Log2(0.9375)) = 0.9375;
    Canva Size Width = Screen Size Width / scaleFactor = 960 / 0.9375 = 1024
    Canva Size Height = Screen Size Height / scaleFactor = 640 / 0.9375 = 682.667
    为什么需要通过先取对数在进行平均混合了？
	假設Reference Resolution為400*300，Screen Size為200*600 大小關係是
	Reference Resolution Width 是 Screen Size Width的2倍
	Reference Resolution Height 是 Screen Size 的0.5倍
	看起来如下图：
	![ScaleWithScreenSize](/img/Unity/ScaleWithScreenSize.PNG)
	當March為0.5時，ScaleFactor應該要是 1 (拉平) -- ？没太理解这里拉平的概念
	ScaleFactor Width： 200/400=0.5
	ScaleFactor Height：600/300=2
	一般混合：
	ScaleFactor = March * ScaleFactor Width + (1 - March) * ScaleFactorHeight
	ScaleFactor = 0.5 * 0.5 + 0.5 * 2 = 1.25
	對數混合：
	logWidth：log2(0.5) = -1
	logHeight：log2(2) = 1
	logWeightedAverage：0
	ScaleFactor：Pow(2,0) = 1
2. Expand(将Canva Size基于宽度或高度去扩大)
	以Scale Factor Width和Scale Factor Height中小的为准。
3. Shrink(将Canva Size基于宽度或高度去收缩)
	以Scale Factor Width和Scale Factor Height中大的为准。
	scaleFactor一般混合為1.25，對數混合為1，結果很明顯，使用對數混合能更完美的修正大小
	可以看出UGUI的自适应都是基于动态计算Scale Factor(也就是Canva Size即Canva Scale的大小)来实现的。
</code></pre>
<ol start="3">
<li>Constant Physical Size<br><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/script-CanvasScaler.html">Makes UI elements retain the same physical size regardless of screen size and resolution.</a><br>保持UI的Physical Size(DPI - Dots Per Inch 每英寸像素点)<br><img src="/img/Unity/ConstantPhysicalSize.png" alt="ConstantPhysicalSize"><ol>
<li>Physical Unit：使用的單位种类</li>
</ol>
</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">| 单位种类    |     中文       |   与<span class="number">1</span>英寸关系 |</span><br><span class="line">| ----------- | -------------- | ------------- |</span><br><span class="line">| Centimeters |	公分(cm，厘米) |     <span class="number">2.54</span>      |</span><br><span class="line">| Millimeters | 毫米(mm，毫米) |     <span class="number">25.4</span>      |</span><br><span class="line">|  Inches     |	   英寸        |      <span class="number">1</span>        |</span><br><span class="line">|  Points     |     点         |      <span class="number">72</span>       |</span><br><span class="line">|  Picas      |皮卡(十二点活字)|      <span class="number">6</span>        |</span><br></pre></td></tr></table></figure>
<pre><code>2. Fallback Screen DPI：备用Dpi，当找不到设备Dpi時，使用此值
3. Default Sprite DPI：预设的图片Dpi
</code></pre>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">float</span> currentDpi = Screen.dpi;</span><br><span class="line"><span class="built_in">float</span> dpi = (currentDpi == <span class="number">0</span> ? m_FallbackScreenDPI : currentDpi);</span><br><span class="line"><span class="built_in">float</span> targetDPI = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">switch</span> (m_PhysicalUnit)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">case</span> Unit.Centimeters: targetDPI = <span class="number">2.54f</span>; <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> Unit.Millimeters: targetDPI = <span class="number">25.4f</span>; <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> Unit.Inches:      targetDPI =     <span class="number">1</span>; <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> Unit.Points:      targetDPI =    <span class="number">72</span>; <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> Unit.Picas:       targetDPI =     <span class="number">6</span>; <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">SetScaleFactor(dpi / targetDPI);</span><br><span class="line">SetReferencePixelsPerUnit(m_ReferencePixelsPerUnit * targetDPI / m_DefaultSpriteDPI);</span><br></pre></td></tr></table></figure>
<p>结论：<br>ScaleFactor 為 “目前硬體dpi” 佔了 “目標單位” 的比例<br>ReferencePixelsPerUnit 要與目前的Dpi在運算求出新的值，再傳入Canvas中求出大小，公式如下：<br>新的Reference Pixels Per Unit &#x3D; Reference Pixels Per Unit * Physical Unit &#x2F; Default Sprite DPI<br>UI大小 &#x3D; 原圖大小(Pixels)  &#x2F;  (Pixels Per Unit &#x2F; 新的 Reference Pixels Per Unit)<br>(关于基于Constant Physical Size这一点还没看明白，<a target="_blank" rel="noopener" href="http://k79k06k02k.com/blog/24/unity/unity-ugui-%E5%8E%9F%E7%90%86%E7%AF%87%E4%BA%8C%EF%BC%9Acanvas-scaler-%E7%B8%AE%E6%94%BE%E6%A0%B8%E5%BF%83">上面资料来源</a>)</p>
<p>RectTransform:<br><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/UIBasicLayout.html">The Rect Transform is a new transform component that is used for all UI elements instead of the regular Transform component. Rect Transforms have position, rotation, and scale just like regular Transforms, but it also has a width and height, used to specify the dimensions of the rectangle.</a><br>RectTransform是用于指定UI相关的一些信息(Position,Rotation,scale,Anchors,Pivot等)<br><img src="/img/Unity/RectTransform.PNG" alt="RectTransform"></p>
<p>Pivot(枢轴):<br>物体的transform变化，比如scale,position,rotation都会以这个点为基准来变化</p>
<p>Anchors(锚点):<br>主要用于UI的layout排版，根据Anchors的位置设置不同，UI会在父节点RectTransform变化的时候做出适当的变化(这里的Anchors相当于完成了NGUI里UIAnchor和UIStreach的任务)。Anchors能够保证以4个锚点设定的相对位置(可以相对屏幕比例，也可以相对特定像素值)。</p>
<p>Layout System:<br>Layout System是基于RectTransform之上的系统，用自动调整一个或多个元素的大小，位置，间隔等。(用于UI布局很重要)<br>详细学习参考<a target="_blank" rel="noopener" href="http://k79k06k02k.com/blog/542/unity/unity-ugui-%E5%8E%9F%E7%90%86%E7%AF%87%E4%BA%94%EF%BC%9Aauto-layout-%E8%87%AA%E5%8B%95%E4%BD%88%E5%B1%80">Unity UGUI 原理篇(五)：Auto Layout 自動佈局</a></p>
<p>结论：<br>UI Render Mode决定了UI的显示方式。<br>UI Scale Mode决定了UI的大方向(保持像素还是保持比例还是保持物理大小)自适应策略。<br>Pivot决定了自适应的基准点。<br>Anchors决定了自适应变化的参考物(比如我们把锚点都设置在父RectTransform的左上角，那么自适应的时候无论父RectTransform大小如何变化该UI都是相对于父RectTransform的位置都不会变化(但UI大小会变，因为我们可能设置了Scale With Screen Size使得Canvas会自适应屏幕变化(Canvas Scale值会变))，如果我们把锚点设置到父RectTranform的四个角，那么UI就会根据父RectTransform的大小的变化比例去适应(一般用于背景显示，保证背景铺满屏幕，可能会拉伸))</p>
<p>在得出最终结论之前，让我们来看一个像素完美显示问题。<br>如何保证Pixel Perfect 2D？<br>参考文章<a target="_blank" rel="noopener" href="https://blogs.unity3d.com/cn/2015/06/19/pixel-perfect-2d/">Pixel Perfect 2D</a><br><a target="_blank" rel="noopener" href="https://blogs.unity3d.com/cn/2015/06/19/pixel-perfect-2d/">The secret to making your pixelated game look nice is to ensure that your sprite is rendered on a nice pixel boundary. In other words, ensure that each pixel of your sprite is rendered on one screen pixel (or any other round number). The trick to achieving this result is tweaking the camera’s orthographic size (and live with the consequences).</a><br>从上面可以看出要保证Pixel Perfect显示，我们需要保证Sprite的一个像素在屏幕上对应显示像素为整数倍(最好1:1)。要做到这一点通过修改Camera Orthographic Size可以做到。正如<a href="http://tonytang1990.github.io/2016/12/11/Unity-Plugins/#NGUI_2-7%E5%B1%8F%E5%B9%95%E8%87%AA%E9%80%82%E5%BA%94">NGUI 2.7屏幕自适应</a>学习中提到的，我们要保证PPU &#x3D; Screen.height &#x2F; 2 &#x2F; Orthographic Size;<br>因为我们不可能修改物理的Screen.height，所以为了在不同设备上完美显示像素，我们能做的是动态修改Orthographic Size或制作多套PPU Asset去动态使用。<br>详情参考：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Vertical Resolution  |   PPU  |	PPU Scale |	Orthographics Size |	Size Change</span><br><span class="line">---------------------|--------|-----------|--------------------|----------------</span><br><span class="line"><span class="number">768</span>    	             |   <span class="number">32</span>   |	   <span class="number">1</span>x 	  |        <span class="number">12</span> 	       |       <span class="number">100</span>%</span><br><span class="line"><span class="number">1080</span> 	             |   <span class="number">32</span>   |	   <span class="number">1</span>x 	  |      <span class="number">16.875</span>        |       <span class="number">140</span>%</span><br><span class="line"><span class="number">1080</span> 	             |   <span class="number">48</span>   |    <span class="number">1</span>x     | 	  <span class="number">11.25</span>        | 	   <span class="number">93.75</span>%</span><br><span class="line"><span class="number">1080</span>  	             |   <span class="number">32</span>   |    <span class="number">2</span>x 	  |       <span class="number">8.4375</span>       |       <span class="number">70.31</span>%</span><br><span class="line"><span class="number">1440</span> 	             |   <span class="number">32</span>   |    <span class="number">2</span>x 	  |       <span class="number">11.25</span>        |       <span class="number">93.75</span>%</span><br><span class="line"><span class="number">1536</span> 	             |   <span class="number">32</span>   |    <span class="number">2</span>x 	  |         <span class="number">12</span>         |       <span class="number">100</span>%</span><br></pre></td></tr></table></figure>

<p>但是由于修改Orthographic Size会导致Visible World Space变化，所以还需要根据项目实际情况做出修正。</p>
<ol>
<li>Thick Borders<br><img src="/img/Unity/ThickBorder.PNG" alt="ThickBorder"><br>如果是2D游戏有边框限制且Orthographic Size变化不大，我们可以通过只调整边框厚度去弥补</li>
<li>Increase Asset Resolution<br>通过制作多套PPU的Asset，已达到修正Orthographics Size值(从前面表格可以看出，通过使用不同PPU Asset可以在保证Pixel Perfect的前提下尽量减小Orthographics Size的变化)的目的。(Size Change变化不大的话可以采用第一种方案按情况弥补)</li>
<li>Halving Orthographic Size<br>如果Screen.height变化很大，导致计算出的Orthographics Size变化很大，我们可以通过修正(以2倍数为基准)Orthographic Size大小使其Size Change变化不大，然后通过Thick Borders来做最后修正。(比如表格上面从768变到1440的时候，我们Orthographics Size不是22.5而是22.5&#x2F;2&#x3D;11.25来修正。这个方法的好处是不需要做多套PPU的Asset)</li>
</ol>
<p>UGUI自适应的结论就不言而喻了，一般来说都是基于按比例的缩放，所以设置如下(2D为例)：<br>UI Render Mode – Screen Space(Camera)，设置Main Camera为Orthographic，Orthographic Size设置为Screen.height &#x2F; 2 &#x2F; PPU(使用Screen Space(Camera)为了配合Orthographic Camera对Scren Unit进行细分)<br>UI Scale Mode – Scale With Screen Size,设置基准Resolution，同时Screen Match Mode为MatchWidthOrHeight &#x3D; 0-1(适应宽和高的比例，根据实际情况选择e.g. 横版2D或者竖版2D黑边要求不一样)。<br>Pivot – 不出意外都设置在UI的中心点<br>Anchors – 如果是和父RectTransform大小一起适应的话，放到父RectTransform的四个角即可(可能会有拉伸，多用于背景显示)。如果想保持UI相对于父RectTransform的特定比例的位置即设置锚点到特定比例位置即可。如果只想保持相对位置不变，四个锚点都设置到同一个点即可(一般UI都有固定位置，一般都设置成这个)。更多的UI排版使用Layout，Layout Group管理。<br>美术制作的时候以UI Scale Mode里设置的Resolution基准和PPU设定来制作(比如Resolution基准决定了背景图片的大小，PPU设定决定UI大小(PPU &#x3D; Screen.height &#x2F; 2 &#x2F; Orthographic Size)，如果设定Screen.height &#x3D; 768，Orthographic Size &#x3D; 12， 那么PPU &#x3D; 32, 1 unit &#x3D; 32 pixel,屏幕UI高度为24 Unit，如果想设计button占屏幕高度1 unit，那么32 * 32 像素即可)。<br>然后在游戏里通过动态计算Orthographic Size来确保Pixel Perfect显示。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Orthographic Size = Screen.height / <span class="number">2</span> / PPU(<span class="number">32</span>);</span><br></pre></td></tr></table></figure>
<p>当Screen.height(Orthographic Size变化大)变化大的时候，我们通过按2的倍数的比例来修正Orthographic Size。(也可以通过制作多套PPU的Asset来动态替换)</p>
<h3 id="EventSystem"><a href="#EventSystem" class="headerlink" title="EventSystem"></a>EventSystem</h3><p>UI要想响应UI Event，必须在场景里创建EventSystem(创建UI Canvas的时候会自动创建)。<br><img src="/img/Unity/EventSystem.PNG" alt="EventSystem"><br>可以看到现在Event System主要是由2个Component构成：</p>
<ol>
<li>Event System<br><a target="_blank" rel="noopener" href="https://docs.unity3d.com/ScriptReference/EventSystems.EventSystem.html">The EventSystem is responsible for processing and handling events in a Unity scene. A scene should only contain one EventSystem.</a><br>Event System是负责处理场景里的事件，负责更新Input Module<br>点击Play后，选中Event System，然后在场景里交互的时候，EventSystem会显示出当前交互的信息<br><img src="/img/Unity/SystemInfo.PNG" alt="SystemInfo"><br>Send Navigation Events – 用于控制是否开启UI导航功能(通过按下键盘上下左右来选择)<br>通过设置Button的Navigation为Explicit我们可以设置该Button的具体导航情况：<br><img src="/img/Unity/ButtonUINavigation.PNG" alt="ButtonUINavigation"></li>
<li>Standalone Input Module<br><a target="_blank" rel="noopener" href="https://docs.unity3d.com/ScriptReference/EventSystems.StandaloneInputModule.html">Input module for working with, mouse, keyboard, or controller.</a><a target="_blank" rel="noopener" href="https://docs.unity3d.com/ScriptReference/EventSystems.BaseInputModule.html">An Input Module is a component of the EventSystem that is responsible for raising events and sending them to GameObjects for handling. </a><br>负责Input输入的控制，负责触发和发送事件到指定对象<br>Event System 触发流程<ol>
<li>使用者输入(触摸、键盘)</li>
<li>透过Scene中的Raycasters计算哪个元素被点中</li>
<li>使用Input Module，发送Event到指定对象<br>Canvas上的GraphicRaycaster负责设定UI相关的raycast信息响应：<br><img src="/img/Unity/GraphicRaycast.PNG" alt="GraphicRaycast"><br>同理<a target="_blank" rel="noopener" href="http://k79k06k02k.com/blog/440/unity/unity-ugui-%E5%8E%9F%E7%90%86%E7%AF%87%E5%9B%9B%EF%BC%9Aevent-system-manager-%E4%BA%8B%E4%BB%B6%E8%88%87%E8%A7%B8%E7%99%BC">PhycsicsRaycaster</a>会负责物理的raycast相关的信息响应。(比如响应位于一个含Collider3D物体之上)</li>
</ol>
</li>
</ol>
<p>Note:<br><a target="_blank" rel="noopener" href="http://docs.unity3d.com/Manual/UICanvas.html">UI elements in the Canvas are drawn in the same order they appear in the Hierarchy.(UI成员的绘制顺序和UI在Canvas下的顺序一致) </a></p>
<h3 id="UGUI-Atlas"><a href="#UGUI-Atlas" class="headerlink" title="UGUI Atlas"></a>UGUI Atlas</h3><p>以下学习参考<a target="_blank" rel="noopener" href="http://www.xuanyusong.com/archives/3304">UGUI研究院之全面理解图集与使用（三）</a><br>NGUI的Atlas是通过提前制作好，但UGUI里这一概念模糊了，我们通过设定Sprite的信息：<br><img src="/img/Unity/UGUISpriteEditor.PNG" alt="UGUISpriteEditor"><br>通过设置tag来决定图集tag。<br>然后在打包或主动使用Sprite Packer的时候会去打包图集，Sprite Packer设定Edit -&gt; Project Setting -&gt; Editor:<br><img src="/img/Unity/SpritePackerSetting.PNG" alt="SpritePackerSetting"><br>为了方便查看Sprite Packer打包和Draw call情况，我们采用Always Enable。<br>我们也可以通过打开Sprite Packer主动去查看图集的打包情况：<br><img src="/img/Unity/UGUISpritePacker.PNG" alt="UGUISpritePacker"><br>通过Profiler可以查看到当前Draw Call：<br><img src="/img/Unity/ProfilerDrawCall.PNG" alt="ProfilerDrawCall"><br>关于根据图片名字动态创建Sprite的方案(通过把小图片关联到Prefab上，然后通过Resources.load来加载来实现)以及图集在线更新方案(Assetbundle)参考<a target="_blank" rel="noopener" href="http://www.xuanyusong.com/archives/3304">UGUI研究院之全面理解图集与使用（三）</a><br>Note:<br>因为在同一个图集里所以，纹理图片只需加载一张，只需通过UV坐标切换就能实现渲染多个Sprite，所以在同一个图集里的Sprite渲染都放在一个Draw Call里就能完成。(关于Draw Call以后的学习再深入学习)<br>Resources下面的Sprite不会被打包到图集里。<br>图集的存放位置在Assets同级目录的Library&#x2F;AtlasCache下</p>
<p>关于Font Atlas，UGUI采用<a href="http://tonytang1990.github.io/2015/07/15/Unity-Study/#Font_Maker">动态字体</a>，我们直接导入.ttf等文件就能使用了。</p>
<h2 id="Multiplayer-Networking-1"><a href="#Multiplayer-Networking-1" class="headerlink" title="Multiplayer Networking"></a>Multiplayer Networking</h2><h3 id="The-Hight-Level-API"><a href="#The-Hight-Level-API" class="headerlink" title="The Hight Level API"></a>The Hight Level API</h3><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/UNetOverview.html?_ga=1.102545928.827985704.1454244920">Using this means you get access to commands which cover most of the common requirements for multiuser games without needing to worry about the “lower level” implementation details.</a><br>高层面的多人游戏网络传输的抽象，可以方便快速的用于制作简单的多人网络游戏。</p>
<p>多人网络概念:<br>Server and Host:<br><img src="/img/Unity/HLAPIHostAndClientRelationShip.PNG" alt="HLAPIHostAndClientRelationShip"><br><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/UNetConcepts.html?_ga=1.102545928.827985704.1454244920">The host is a server and a client in the same process. The host uses a special kind of client called the LocalClient, while other clients are RemoteClients. The LocalClient communicates with the (local) server through direct function calls and message queues, since it is in the same process. It actually shares the scene with the server. RemoteClients communicate with the server over a regular network connection.</a><br>Host和Client运行在一个Process里。一个Host多个Client，Host相当于本地通信，其他的Clients通过network通信。</p>
<p>支持实现如下功能：</p>
<ol>
<li>Control the networked state of the game using a “Network Manager”.(通过NetworkManager管理网络状态)</li>
<li>Operate “client hosted” games, where the host is also a player client.(运行Client Host游戏)</li>
<li>Serialize data using a general-purpose serializer.(序列化数据)</li>
<li>Send and receive network messages.(网络数据message发送接收)</li>
<li>Send networked commands from clients to servers.(从clients发送networked commands到servers)</li>
<li>Make remote procedure calls (RPCs) from servers to clients.(servers到clients的远程程序调用)</li>
<li>Send networked events from servers to clients.(从servers发送networed events到clients)</li>
</ol>
<p>实例学习参考<a href="http://tonytang1990.github.io/2015/07/15/Unity-Study/#Multiplayer_Networking">Multiplayer Networking</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/UNetUsingHLAPI.html">The HLAPI is a new set of networking commands built into Unity, within a new namespace: UnityEngine.Networking.</a><br>在UnityEngine.Networking下HLAPI提供了大量方便的接口方法用于开发多人游戏。<br>让我们看看Unity里网络编程的大体框架结构：<br><img src="/img/Unity/HLAPILayerStructureOnNetwork.PNG" alt="HLAPILayerStructureOnNetwork"><br>更多内容待学习</p>
<h3 id="Using-The-Transport-Layer-API"><a href="#Using-The-Transport-Layer-API" class="headerlink" title="Using The Transport Layer API"></a>Using The Transport Layer API</h3><p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/UNetUsingTransport.html">The Transport Layer is a thin layer working on top of the operating system’s sockets-based networking. It’s capable of sending and receiving messages represented as arrays of bytes, and offers a number of different “quality of service” options to suit different scenarios. It is focused on flexibility and performance, and exposes an API within the UnityEngine.Networking.NetworkTransport class.</a><br>基于Socket-based networking的底层接口，用于实现自定义的网络传输。</p>
<p>Support two protocols:</p>
<ol>
<li>UDP for generic communications</li>
<li>WebSockets for WebGL<br>更多内容待学习</li>
</ol>
<h2 id="Unity-Shader"><a href="#Unity-Shader" class="headerlink" title="Unity Shader"></a>Unity Shader</h2><p>详情参见<a href="http://tonytang1990.github.io/2016/12/20/Unity-Shader/">Unity_Shader</a></p>
<h2 id="Excel数据读取"><a href="#Excel数据读取" class="headerlink" title="Excel数据读取"></a>Excel数据读取</h2><p>Unity官网给出TextAsset类用于读取下列格式的文件：<br>.txt, .html, .htm, .xml, .bytes, .json, .csv(<a target="_blank" rel="noopener" href="http://baike.baidu.com/link?url=k66qCiCo7dQ2gA3bS09xk_ZhFBldafez_7Ux64tJvvwAx2HcsLW3cFIaKoGua_HnlHV3nnDgHL5NdqwSKHEV_KHhRVEm-B0mYguaAcxSFDm">逗号分隔值（Comma-Separated Values，CSV，有时也称为字符分隔值，因为分隔字符也可以不是逗号），其文件以纯文本形式存储表格数据（数字和文本）</a>), .yaml, .fnt<br>从上面可以看出并不支持直接对excel(.xlsx，.xls等格式)的解析。<br>通过官网可以看出TextAsset是针对文本和二进制类型文件的读取，具体的解析还得自己去写。<br>所以并不是我想找的Excel解析的解决方案。<br>让我们来看看这篇文章<a target="_blank" rel="noopener" href="http://www.mamicode.com/info-detail-494944.html">Unity3D游戏开发之当游戏开发遇上Excel</a>。<br>作者对Excel解析下了不少功夫。<br>从上面可以看出，针对Excel解析作者找到了三中解决方案：</p>
<ol>
<li>Microsoft.Office.Interop.Excel<br><a target="_blank" rel="noopener" href="http://www.mamicode.com/info-detail-494944.html">基于微软提供的Office API,这组API以COM组件的形式给出，我们可以通过调用该API实现对Excel文件的解析。微软的Office API特点是使用起来方便，可以使用C#、Visual Basic等语言进行相关开发。可是这种解决方案的的缺点同样很明显，因为COM组件主要依赖于系统，因此使用COM组件需要在系统中注册，这将对代码的可移植性产生影响，而且受制于COM技术，这种解决方案只能运行在Windows平台上，无法实现跨平台，加之解析速度较慢，因此这种方案通常只适合在解析速度要求不高，运行环境为Windows平台的应用场景。</a><br>关键词：<br>不跨平台</li>
<li>ExcelReader<br>ExcelRead就是跨平台目标下解析Excel文件的首选方案。<br><a target="_blank" rel="noopener" href="http://exceldatareader.codeplex.com/">ExcelRead website</a><br>从描述来看支持Windows和OS X，Linux等(注意不包含移动端IOS和Android)。但就PC端来看已经足够作为解析Excel的方式了。<br>Note：<br>针对移动端的时候可以采用先在PC端把数据读取出来写到单独的数据文件，然后再到移动端去读取解析。</li>
<li>FastExcel<br>FastExcel是一个在开源世界里的一个java编写的工具。<a target="_blank" rel="noopener" href="http://fastexcel.sourceforge.net/">FastExcel Website</a>。官网上有简单demo方便快速集成。</li>
</ol>
<p>接下来我选择以ExcelReader为解决方案，尝试使用ExcelReader来解析Excel。</p>
<ol>
<li>下载Dll，官网的建议是直接下载DLL来用<br><a target="_blank" rel="noopener" href="http://exceldatareader.codeplex.com/">ExcelReader DLL Download</a><br>可以看到主要有两个DLL(Excel.4.5.dll &amp; ICSharpCode.SharpZiplib.dll)<br><img src="/img/Unity/ExcelReaderDLL.PNG" alt="ExcelReaderDLL"></li>
<li>导入DLL到Unity(Unity对Managed Plugins支持很方便，直接在Asset下创建一个目录copy进去即可)<br>Note:<br>这里要注意的一点，需要采用基于.net 2.0的dll而非基于.net 4.5的(我想是由于mono还不支持所有.net的特性导致的)</li>
<li>通过导入命名空间就可以正常使用ExcelReader库了<br>以下是根据代码参考<a target="_blank" rel="noopener" href="http://www.mamicode.com/info-detail-494944.html">Unity3D游戏开发之当游戏开发遇上Excel</a>和<a target="_blank" rel="noopener" href="http://www.xuanyusong.com/archives/2429">Unity3D研究院之MAC&amp;Windows跨平台解析Excel（六十五）</a>和<a target="_blank" rel="noopener" href="http://exceldatareader.codeplex.com/">Excel Data Reader - Read Excel files in .NET</a>：</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> Excel;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> System.Data;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">GameConfigurationManager</span> </span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> GameConfigurationManager mLMInstance = <span class="keyword">new</span> GameConfigurationManager();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> ConfigurationPath</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">set</span></span><br><span class="line">        &#123;</span><br><span class="line">            mConfigurationPath = <span class="keyword">value</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">string</span> mConfigurationPath = <span class="string">&quot;/Configuration/AccountPasswordAndGameSetting.xlsx&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">bool</span> mIsConfigurationComplete = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">GameConfigurationManager</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Init</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(!mIsConfigurationComplete)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">               ReadConfiguration();</span><br><span class="line">                mIsConfigurationComplete = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span>(Exception e)</span><br><span class="line">            &#123;</span><br><span class="line">                mIsConfigurationComplete = <span class="literal">false</span>;</span><br><span class="line">                Debug.Log(<span class="string">&quot;Exception &quot;</span> + e.ToString());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ReadConfiguration</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        Debug.Log(<span class="string">&quot;Application.dataPath = &quot;</span> + Application.dataPath);</span><br><span class="line">        Debug.Log(<span class="string">&quot;mConfigurationPath = &quot;</span> + mConfigurationPath);</span><br><span class="line"></span><br><span class="line">        FileStream stream = File.Open(Application.dataPath + mConfigurationPath, FileMode.Open, FileAccess.Read);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Reading from a excel file</span></span><br><span class="line">        IExcelDataReader excelreader = ExcelReaderFactory.CreateOpenXmlReader(stream);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// DataSet -- the result of each spreadsheet will be created in the result tables</span></span><br><span class="line">        DataSet result = excelreader.AsDataSet();</span><br><span class="line"></span><br><span class="line">        <span class="built_in">int</span> sheetcount = result.Tables.Count;</span><br><span class="line">        Debug.Log(<span class="string">&quot;sheetcount = &quot;</span> + sheetcount);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="built_in">int</span> m = <span class="number">0</span>; m &lt; sheetcount; m++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">int</span> rows = result.Tables[m].Rows.Count;</span><br><span class="line">            <span class="built_in">int</span> columns = result.Tables[m].Columns.Count;</span><br><span class="line">            Debug.Log(<span class="built_in">string</span>.Format(<span class="string">&quot;Table[&#123;0&#125;] with row = &#123;1&#125; columns = &#123;2&#125;&quot;</span>, m, rows, columns));</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span>(<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; rows; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">for</span>(<span class="built_in">int</span> j = <span class="number">0</span>; j &lt; columns; j++)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="built_in">string</span> <span class="keyword">value</span> = result.Tables[m].Rows[i][j].ToString();</span><br><span class="line">                    Debug.Log(<span class="built_in">string</span>.Format(<span class="string">&quot;result.Tables[&#123;0&#125;].Rows[&#123;1&#125;][&#123;2&#125;] = &#123;3&#125;&quot;</span>,m,i,j,<span class="keyword">value</span>));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        excelreader.Close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过上述方法我成功的打印出了AccountPasswordAndGameSetting.xlsx里2个sheet的数据，见下图：<br><img src="/img/Unity/AccountPasswordAndGameSettingSheet1.PNG" alt="AccountPasswordAndGameSettingSheet1"><br><img src="/img/Unity/AccountPasswordAndGameSettingSheet2.PNG" alt="AccountPasswordAndGameSettingSheet2"><br><img src="/img/Unity/ExcelReaderOutput.PNG" alt="ExcelReaderOutput"><br>Note:<br>上面有用到DataSet，DataSet类是属于System.Data.dll里的，所以我们还必须Copy存放在**\Unity\Editor\Data\Mono\lib\mono\2.0下的System.Data.dll到我们的Dlls目录。</p>
<h2 id="资源管理"><a href="#资源管理" class="headerlink" title="资源管理"></a>资源管理</h2><p>详情参见<a href="http://tonytang1990.github.io/2016/10/13/Unity%E8%B5%84%E6%BA%90/">Unity-Resource-Manager</a></p>
<h1 id="Plugins"><a href="#Plugins" class="headerlink" title="Plugins"></a>Plugins</h1><p>详情参见<a href="http://tonytang1990.github.io/2016/12/11/Unity%E5%8E%9F%E7%94%9F&%E7%AC%AC%E4%B8%89%E6%96%B9%E6%8F%92%E4%BB%B6/#Unity_Plugins">Unity-Plugins</a></p>
<h1 id="C-脚本"><a href="#C-脚本" class="headerlink" title="C#脚本"></a>C#脚本</h1><p>public成员 – 编辑器可见可编辑<br>[System.Serializable] – 标志该类可以被序列化到Inspector<br>[HideInInspector] – 标志该成员在编辑器不可见<br>StartCoroutine（Function()） &amp;&amp;  yield &amp;&amp; WaitForSeconds – 联合使用可以实现对游戏逻辑的等待判断（多线程访问控制）<br>GameObject.FindGameObjectWithTag(Name) – 用于寻找特定tag的对象<br>Virtual Method – Virtual Method使该方法可以被重写<br>abstract – 定义该类是抽象类 &amp;&amp; 该方法是抽象方法（需要被子类实现）</p>
<h2 id="Persistence-Saving-and-Loading-Data"><a href="#Persistence-Saving-and-Loading-Data" class="headerlink" title="Persistence - Saving and Loading Data"></a>Persistence - Saving and Loading Data</h2><h3 id="PlayerPrefs"><a href="#PlayerPrefs" class="headerlink" title="PlayerPrefs"></a>PlayerPrefs</h3><p>Stores and accesses player preferences between game sessions. (用于存储一些不重要的用户设定的数据，比如游戏分辨率，游戏难度等)</p>
<p>IOS里面的.plist文件，Andoid里面的Preference(程序数据文件)</p>
<h3 id="Seralization"><a href="#Seralization" class="headerlink" title="Seralization"></a><a target="_blank" rel="noopener" href="http://docs.unity3d.com/Manual/script-Serialization.html">Seralization</a></h3><h4 id="What-is-seralization"><a href="#What-is-seralization" class="headerlink" title="What is seralization?"></a>What is seralization?</h4><p>serialization is the process of converting the state an object to a set of bytes in order to store (or transmit) the object into memory, a database or a file.</p>
<h4 id="C-Serialization"><a href="#C-Serialization" class="headerlink" title="C# Serialization"></a>C# Serialization</h4><p>GameController.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Runtime.Serialization.Formatters.Binary;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> UnityEngine.UI;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">GameController</span> : <span class="title">MonoBehaviour</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> GameController mController;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> PlayerData mPlayerData;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">float</span> mPreferenceHealth = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="built_in">string</span> mPlayerSavePath;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Awake</span>()</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (mController == <span class="literal">null</span>) &#123;</span><br><span class="line">			DontDestroyOnLoad (gameObject);</span><br><span class="line">			mController = <span class="keyword">this</span>;</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (mController != <span class="keyword">this</span>) &#123;</span><br><span class="line">			Destroy(gameObject);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		mPlayerData = <span class="keyword">new</span> PlayerData ();</span><br><span class="line"></span><br><span class="line">		mPlayerSavePath = Application.persistentDataPath + <span class="string">&quot;/playerInfo.dat&quot;</span>;</span><br><span class="line">		Debug.Log (<span class="string">&quot;mPlayerSavePath = &quot;</span> + mPlayerSavePath);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">OnGUI</span>()</span></span><br><span class="line">	&#123;</span><br><span class="line">		GUI.Label (<span class="keyword">new</span> Rect (<span class="number">10</span>, <span class="number">10</span>, <span class="number">200</span>, <span class="number">30</span>), <span class="string">&quot;Preference Health: &quot;</span> + mPreferenceHealth);</span><br><span class="line">		GUI.Label (<span class="keyword">new</span> Rect (<span class="number">10</span>, <span class="number">50</span>, <span class="number">200</span>, <span class="number">30</span>), <span class="string">&quot;mPlayerData.mHealth: &quot;</span> + mPlayerData.mHealth);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (GUI.Button (<span class="keyword">new</span> Rect (<span class="number">10</span>, <span class="number">90</span>, <span class="number">120</span>, <span class="number">30</span>), <span class="string">&quot;Increase Health&quot;</span>)) &#123;</span><br><span class="line">			mPreferenceHealth += <span class="number">10</span>;</span><br><span class="line">			mPlayerData.mHealth += <span class="number">10</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">if</span> (GUI.Button (<span class="keyword">new</span> Rect (<span class="number">10</span>, <span class="number">130</span>, <span class="number">120</span>, <span class="number">30</span>), <span class="string">&quot;Decrease Health&quot;</span>)) &#123;</span><br><span class="line">			mPreferenceHealth -= <span class="number">10</span>;</span><br><span class="line">			mPlayerData.mHealth -= <span class="number">10</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (GUI.Button (<span class="keyword">new</span> Rect (<span class="number">10</span>, <span class="number">170</span>, <span class="number">120</span>, <span class="number">30</span>), <span class="string">&quot;Save File&quot;</span>)) &#123;</span><br><span class="line">			Save ();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (GUI.Button (<span class="keyword">new</span> Rect (<span class="number">10</span>, <span class="number">210</span>, <span class="number">120</span>, <span class="number">30</span>), <span class="string">&quot;Load File&quot;</span>)) &#123;</span><br><span class="line">			Load ();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (GUI.Button (<span class="keyword">new</span> Rect (<span class="number">10</span>, <span class="number">250</span>, <span class="number">120</span>, <span class="number">30</span>), <span class="string">&quot;Save Preference&quot;</span>)) &#123;</span><br><span class="line">			SavePreference ();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (GUI.Button (<span class="keyword">new</span> Rect (<span class="number">10</span>, <span class="number">290</span>, <span class="number">120</span>, <span class="number">30</span>), <span class="string">&quot;Load Preference&quot;</span>)) &#123;</span><br><span class="line">			LoadPreference ();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Save</span>()</span></span><br><span class="line">	&#123;</span><br><span class="line">		Debug.Log (<span class="string">&quot;Application.persistentDataPath = &quot;</span> + Application.persistentDataPath);</span><br><span class="line">		<span class="keyword">if</span> (!File.Exists (mPlayerSavePath)) &#123;</span><br><span class="line">			FileStream fsc = File.Create(mPlayerSavePath);</span><br><span class="line">			fsc.Close();</span><br><span class="line">		&#125;</span><br><span class="line">		BinaryFormatter bf = <span class="keyword">new</span> BinaryFormatter ();</span><br><span class="line">		FileStream fs = File.Open (mPlayerSavePath, FileMode.Open);</span><br><span class="line">		</span><br><span class="line">		bf.Serialize (fs, mPlayerData);</span><br><span class="line">		fs.Close ();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Load</span>()</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span>(File.Exists(mPlayerSavePath))</span><br><span class="line">	    &#123;</span><br><span class="line">			BinaryFormatter bf = <span class="keyword">new</span> BinaryFormatter();</span><br><span class="line">			FileStream fs = File.Open(mPlayerSavePath,FileMode.Open);</span><br><span class="line">			mPlayerData = (PlayerData)bf.Deserialize(fs);</span><br><span class="line">			fs.Close();</span><br><span class="line">			Debug.Log(<span class="string">&quot;Load: mPlayerData.mHealth = &quot;</span> + mPlayerData.mHealth);</span><br><span class="line">			Debug.Log(<span class="string">&quot;Load: mPlayerData.mB.BuildingType = &quot;</span> + mPlayerData.mB.mBT);</span><br><span class="line"></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SavePreference</span>()</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">//Player preference</span></span><br><span class="line">		PlayerPrefs.SetFloat (<span class="string">&quot;Health&quot;</span>, mPreferenceHealth);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">LoadPreference</span>()</span></span><br><span class="line">	&#123;</span><br><span class="line">		Debug.Log(<span class="string">&quot;Pre Health = &quot;</span> + PlayerPrefs.GetFloat(<span class="string">&quot;Health&quot;</span>));</span><br><span class="line">		mPreferenceHealth = PlayerPrefs.GetFloat (<span class="string">&quot;Health&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[<span class="meta">Serializable</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PlayerData</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">float</span> mHealth = <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> Building mB = <span class="keyword">new</span> Building();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[<span class="meta">Serializable</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="built_in">enum</span> BuildingType</span><br><span class="line">&#123;</span><br><span class="line">	E_WALL = <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[<span class="meta">Serializable</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Building</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">public</span> BuildingType mBT = BuildingType.E_WALL;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/img/Unity/Perssistence_PlayerPrefs_Serialization.PNG" alt="Screnn Shot"></p>
<p>Note:<br>Cross Platform except Web</p>
<h3 id="Unity-Editor-Window-Menu-Item-ScriptableObject"><a href="#Unity-Editor-Window-Menu-Item-ScriptableObject" class="headerlink" title="Unity Editor Window, Menu Item &amp; ScriptableObject"></a>Unity Editor Window, Menu Item &amp; ScriptableObject</h3><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEditor;</span><br><span class="line"></span><br><span class="line">[<span class="meta">Serializable</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MyScriptableObject</span> : <span class="title">ScriptableObject</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">string</span> mID = <span class="string">&quot;1&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Use Editor Window to edit ScriptObject data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MyEditorWindow</span> : <span class="title">EditorWindow</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">string</span> mValue = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">	[<span class="meta">MenuItem(<span class="string">&quot;Window/MyEditorWindow&quot;</span>)</span>]</span><br><span class="line">	<span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Init</span>()</span></span><br><span class="line">	&#123;</span><br><span class="line">		MyEditorWindow window = (MyEditorWindow)EditorWindow.GetWindow (<span class="keyword">typeof</span>(MyEditorWindow));</span><br><span class="line">		window.Show ();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">OnGUI</span>()</span></span><br><span class="line">	&#123;</span><br><span class="line">		MyScriptableObject asset = ScriptableObject.CreateInstance&lt;MyScriptableObject&gt; ();</span><br><span class="line">		asset = AssetDatabase.LoadAssetAtPath(<span class="string">&quot;Assets/MyScriptableObject.asset&quot;</span>,<span class="keyword">typeof</span>(MyScriptableObject)) <span class="keyword">as</span> MyScriptableObject;</span><br><span class="line">		mValue = asset.mID;</span><br><span class="line">		Debug.Log (<span class="string">&quot;mValue = &quot;</span> + mValue);</span><br><span class="line"></span><br><span class="line">		Debug.Log(<span class="string">&quot;OnGUI&quot;</span>);</span><br><span class="line">		GUILayout.Label (<span class="string">&quot;mID&quot;</span>, EditorStyles.boldLabel);</span><br><span class="line">		<span class="built_in">string</span> value2 = EditorGUILayout.TextField (<span class="string">&quot;ID&quot;</span>,mValue);</span><br><span class="line">		<span class="keyword">if</span> (GUILayout.Button (<span class="string">&quot;Save&quot;</span>, EditorStyles.miniButton)) &#123;</span><br><span class="line">			Debug.Log(<span class="string">&quot;Save Button Clicked&quot;</span>);</span><br><span class="line">			MyScriptableObject asset2 = ScriptableObject.CreateInstance&lt;MyScriptableObject&gt; ();</span><br><span class="line">			asset2.mID = value2;</span><br><span class="line">			AssetDatabase.CreateAsset (asset2, <span class="string">&quot;Assets/MyScriptableObject.asset&quot;</span>);</span><br><span class="line">			AssetDatabase.SaveAssets ();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Menu Item Study</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MyMenuItems</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">//Normal Menu Item</span></span><br><span class="line">	[<span class="meta">MenuItem(<span class="string">&quot;Tools/CreateScriptableAssets %q&quot;</span>)</span>]</span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Save</span>()</span></span><br><span class="line">	&#123;</span><br><span class="line">		MyScriptableObject asset = ScriptableObject.CreateInstance&lt;MyScriptableObject&gt; ();</span><br><span class="line">		asset.mID = <span class="string">&quot;2&quot;</span>;</span><br><span class="line">		AssetDatabase.CreateAsset (asset, <span class="string">&quot;Assets/MyScriptableObject.asset&quot;</span>);</span><br><span class="line">		AssetDatabase.SaveAssets ();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	[<span class="meta">MenuItem(<span class="string">&quot;Tools/LoadScriptableAssets %w&quot;</span>)</span>]</span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Load</span>()</span></span><br><span class="line">	&#123;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//Context Menu Item</span></span><br><span class="line">	[<span class="meta">MenuItem(<span class="string">&quot;Assets/ContextMenuItem&quot;</span>)</span>]</span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ContextMenuItem</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">		Debug.Log(<span class="string">&quot;ContextMenuItem()&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	[<span class="meta">MenuItem(<span class="string">&quot;CONTEXT/Transform/ContextMenuItem&quot;</span>)</span>]</span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ContextMenuItem2</span>()</span></span><br><span class="line">	&#123;</span><br><span class="line">		Debug.Log (<span class="string">&quot;ContextMenuItem2&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	[<span class="meta">MenuItem(<span class="string">&quot;Assets/Create/ContextMenuItem&quot;</span>)</span>]</span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ContextMenuItem3</span>()</span></span><br><span class="line">	&#123;</span><br><span class="line">		Debug.Log (<span class="string">&quot;ContextMenuItem3&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过自定义Menu Item的功能，我们可以快速创建一些我们所需要的原件</p>
<p>通过自定义Editor Window，我们可以用于制作特定数据的编辑框</p>
<p>ScriptableObject主要用于存储一些不重要的数据，和Monobehaviour的主要区别就是不用attach到游戏对象上，需要通过CreateInstance的方式来创建</p>
<p>结合自定义Editor Window和ScriptableObject的存储，我们可以通过自定义编辑框自定义数据并使用</p>
<p><img src="/img/Unity/EditorWindow_ScriptableObject.PNG" alt="Screnn Shot"></p>
<h2 id="Coroutine"><a href="#Coroutine" class="headerlink" title="Coroutine"></a>Coroutine</h2><p><a target="_blank" rel="noopener" href="https://unitygem.wordpress.com/coroutines/">Reference Website</a></p>
<h3 id="Why-are-we-using-coroutines"><a href="#Why-are-we-using-coroutines" class="headerlink" title="Why are we using coroutines?"></a>Why are we using coroutines?</h3><ol>
<li>Making things happen step by step</li>
<li>Writing routines that need to happen over time</li>
<li>Writing routines that have to wait for another operation to complete</li>
</ol>
<h3 id="What-is-a-coroutine"><a href="#What-is-a-coroutine" class="headerlink" title="What is a coroutine?"></a>What is a coroutine?</h3><p>Coroutines are not threads and coroutines are not asynchronous.</p>
<p>A coroutine is a function that is executed partially and, presuming suitable conditions are met, will be resumed at some point in the future until its work is done.<br>The start of a coroutine corresponds to the creation of an object of type coroutine. That object is tied to the MonoBehaviour component that hosted the call.</p>
<h3 id="How-long-is-the-life-cycle-When-does-coroutine-get-called"><a href="#How-long-is-the-life-cycle-When-does-coroutine-get-called" class="headerlink" title="How long is the life cycle? &amp; When does coroutine get called?"></a>How long is the life cycle? &amp; When does coroutine get called?</h3><p>The lifetime of the Coroutine object is bound to the lifetime of the MonoBehaviour object, so if the latter gets destroyed during process, the coroutine object is also destroyed. <em>Whenever game object that is bound to coroutine is destroyed or inactive(e.g. gameobject.SetActive(false), Destroy(gameobject)), the coroutine will stop to be called. Coroutine is run until a yield is found.</em></p>
<p>GameController.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Runtime.Serialization.Formatters.Binary;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> UnityEngine.UI;</span><br><span class="line"></span><br><span class="line"><span class="comment">//For Menu Item</span></span><br><span class="line"><span class="keyword">using</span> UnityEditor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">GameController</span> : <span class="title">MonoBehaviour</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> GameController mController;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> GameObject mCoroutineObject;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="built_in">float</span> mInputTimer = <span class="number">0.0f</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">float</span> mValidInputDeltaTime = <span class="number">0.5f</span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Awake</span>()</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (mController == <span class="literal">null</span>) &#123;</span><br><span class="line">			DontDestroyOnLoad (gameObject);</span><br><span class="line">			mController = <span class="keyword">this</span>;</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (mController != <span class="keyword">this</span>) &#123;</span><br><span class="line">			Destroy(gameObject);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Update</span>()</span></span><br><span class="line">	&#123;</span><br><span class="line">		mInputTimer += Time.deltaTime;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">if</span> (mInputTimer &gt; mValidInputDeltaTime) &#123;</span><br><span class="line">			<span class="keyword">if</span> (Input.GetKey (KeyCode.C)) &#123;</span><br><span class="line">				mInputTimer = <span class="number">0.0f</span>;</span><br><span class="line">				Debug.Log (<span class="string">&quot;Ative Coroutine Game Object&quot;</span>);</span><br><span class="line">				mCoroutineObject.SetActive (<span class="literal">true</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (mInputTimer &gt; mValidInputDeltaTime) &#123;</span><br><span class="line">			<span class="keyword">if</span> (Input.GetKey (KeyCode.U)) &#123;</span><br><span class="line">				mInputTimer = <span class="number">0.0f</span>;</span><br><span class="line">				Debug.Log (<span class="string">&quot;UnAtive Coroutine Game Object&quot;</span>);</span><br><span class="line">				mCoroutineObject.SetActive (<span class="literal">false</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (mInputTimer &gt; mValidInputDeltaTime) &#123;</span><br><span class="line">			<span class="keyword">if</span> (Input.GetKey (KeyCode.E)) &#123;</span><br><span class="line">				mInputTimer = <span class="number">0.0f</span>;</span><br><span class="line">				Debug.Log (<span class="string">&quot;Enable Coroutine MonoBehaviour&quot;</span>);</span><br><span class="line">				mCoroutineObject.GetComponent&lt;CoroutineStudy&gt;().enabled = <span class="literal">true</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (mInputTimer &gt; mValidInputDeltaTime) &#123;</span><br><span class="line">			<span class="keyword">if</span> (Input.GetKey (KeyCode.D)) &#123;</span><br><span class="line">				mInputTimer = <span class="number">0.0f</span>;</span><br><span class="line">				Debug.Log (<span class="string">&quot;Desable Coroutine MonoBehaviour&quot;</span>);</span><br><span class="line">				mCoroutineObject.GetComponent&lt;CoroutineStudy&gt;().enabled = <span class="literal">false</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (mInputTimer &gt; mValidInputDeltaTime) &#123;</span><br><span class="line">			<span class="keyword">if</span> (Input.GetKey (KeyCode.K)) &#123;</span><br><span class="line">				mInputTimer = <span class="number">0.0f</span>;</span><br><span class="line">				Debug.Log (<span class="string">&quot;Destroy Coroutine Game Object&quot;</span>);</span><br><span class="line">				Destroy(mCoroutineObject);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>CoroutineStudy.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CoroutineStudy</span> : <span class="title">MonoBehaviour</span> &#123;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> <span class="built_in">string</span> mCoroutineText;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="built_in">bool</span> isFixedCall = <span class="literal">false</span>;  <span class="comment">//Makesure Update() and LateUpdate() and FixedUpdate() Log only once  </span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="built_in">bool</span> isUpdateCall = <span class="literal">false</span>;  </span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="built_in">bool</span> isLateUpdateCall = <span class="literal">false</span>;  </span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Awake</span>()</span></span><br><span class="line">	&#123;</span><br><span class="line">		mCoroutineText = <span class="string">&quot;&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Start</span>()</span></span><br><span class="line">	&#123;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">OnGUI</span>()</span></span><br><span class="line">	&#123;</span><br><span class="line">		GUI.Label (<span class="keyword">new</span> Rect (<span class="number">10</span>, <span class="number">10</span>, <span class="number">200</span>, <span class="number">30</span>), <span class="string">&quot;Coroutine Text: &quot;</span> + mCoroutineText);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (GUI.Button (<span class="keyword">new</span> Rect (<span class="number">400</span>, <span class="number">10</span>, <span class="number">120</span>, <span class="number">30</span>), <span class="string">&quot;Start Coroutine&quot;</span>)) &#123;</span><br><span class="line">			mCoroutineText = <span class="string">&quot;&quot;</span>;</span><br><span class="line">			StartCoroutine (CoroutineCall ());</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">FixedUpdate</span>()</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (!isFixedCall)  </span><br><span class="line">		&#123;  </span><br><span class="line">			Debug.Log(<span class="string">&quot;FixedUpdate Call Begin&quot;</span>);  </span><br><span class="line">			StartCoroutine(FixedCoutine());  </span><br><span class="line">			Debug.Log(<span class="string">&quot;FixedUpdate Call End&quot;</span>);  </span><br><span class="line">			isFixedCall = <span class="literal">true</span>;  </span><br><span class="line">		&#125;  </span><br><span class="line">	&#125;  </span><br><span class="line">	</span><br><span class="line">	<span class="function">IEnumerator <span class="title">FixedCoutine</span>()</span>  </span><br><span class="line">	&#123;  </span><br><span class="line">		Debug.Log(<span class="string">&quot;This is Fixed Coroutine Call Before&quot;</span>);  </span><br><span class="line">		<span class="keyword">yield</span> <span class="keyword">return</span> <span class="literal">null</span>;  </span><br><span class="line">		Debug.Log(<span class="string">&quot;This is Fixed Coroutine Call After&quot;</span>);  </span><br><span class="line">	&#125;  </span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Update</span>()</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (!isUpdateCall)  </span><br><span class="line">		&#123;  </span><br><span class="line">			Debug.Log(<span class="string">&quot;Update Call Begin&quot;</span>);  </span><br><span class="line">			StartCoroutine(UpdateCoutine());  </span><br><span class="line">			Debug.Log(<span class="string">&quot;Update Call End&quot;</span>);  </span><br><span class="line">			isUpdateCall = <span class="literal">true</span>;  </span><br><span class="line">		&#125;  </span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function">IEnumerator <span class="title">UpdateCoutine</span>()</span>  </span><br><span class="line">	&#123;  </span><br><span class="line">		Debug.Log(<span class="string">&quot;This is Update Coroutine Call Before&quot;</span>);  </span><br><span class="line">		<span class="keyword">yield</span> <span class="keyword">return</span> <span class="literal">null</span>;  </span><br><span class="line">		Debug.Log(<span class="string">&quot;This is Update Coroutine Call After&quot;</span>);  </span><br><span class="line">	&#125; </span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">LateUpdate</span>()</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (!isLateUpdateCall)  </span><br><span class="line">		&#123;  </span><br><span class="line">			Debug.Log(<span class="string">&quot;LateUpdate Call Begin&quot;</span>);  </span><br><span class="line">			StartCoroutine(LateCoutine());  </span><br><span class="line">			Debug.Log(<span class="string">&quot;LateUpdate Call End&quot;</span>);  </span><br><span class="line">			isLateUpdateCall = <span class="literal">true</span>;  </span><br><span class="line">		&#125;  </span><br><span class="line">	&#125;  </span><br><span class="line"></span><br><span class="line">	<span class="function">IEnumerator <span class="title">LateCoutine</span>()</span>  </span><br><span class="line">	&#123;  </span><br><span class="line">		Debug.Log(<span class="string">&quot;This is Late Coroutine Call Before&quot;</span>);  </span><br><span class="line">		<span class="keyword">yield</span> <span class="keyword">return</span> <span class="literal">null</span>;  </span><br><span class="line">		Debug.Log(<span class="string">&quot;This is Late Coroutine Call After&quot;</span>);  </span><br><span class="line">	&#125;  </span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> IEnumerator <span class="title">CoroutineCall</span>()</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">1</span>; i &lt;= <span class="number">20</span>; i++) &#123;</span><br><span class="line">			mCoroutineText = i.ToString();</span><br><span class="line">			Debug.Log(<span class="string">&quot;Coroutine Text: &quot;</span> + mCoroutineText);</span><br><span class="line">			<span class="function"><span class="keyword">yield</span> <span class="keyword">return</span> <span class="keyword">new</span> <span class="title">WaitForSeconds</span>(<span class="params"><span class="number">1.0f</span></span>)</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		mCoroutineText = <span class="string">&quot;Finished&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ScreenShots<br><img src="/img/Unity/Unity_Coroutine_LifeTime.PNG" alt="The relationship between Coroutine Life Time and Monobehaviour &amp; GameObejct"></p>
<p><img src="/img/Unity/Unity_Coroutine_LifeTime_Monobehaviour.PNG" alt="The relationship between Coroutine Life Time and Monobehaviour"></p>
<p>Note:<br>Diable Monobehaviour(e.g. Monobehaviour.enabled &#x3D; false) will not influence coroutine.</p>
<p>Coroutine with yiled return null will get called after LateUpdate()(仅根据上面的测试结果)<br>通过返回WaitForSeconds() || WaitForEndOfFrame() || WaitForFixedUpdate() 等yield return 支持的返回类型可以实现coroutine在特定时刻继续调用</p>
<p>StartCoroutine()支持嵌套调用用于实现特定等待特定运算后继续执行特定代码</p>
<h3 id="How-to-stop-coroutines"><a href="#How-to-stop-coroutines" class="headerlink" title="How to stop coroutines?"></a>How to stop coroutines?</h3><p>IEnumerator coroutine &#x3D; WaitForSeconds(3.0f);<br>StartCoroutine(coroutine);<br>StopCoroutine(coroutine);</p>
<p>Note:<br>注意如果gameobject处于InActive或则has been destroyed,Coroutine不会再被调用，可以通过Monobehaviour.enabled &#x3D; false来实现使物体不可见但会出发coroutine的效果</p>
<h3 id="Go-depth-in-Coroutine"><a href="#Go-depth-in-Coroutine" class="headerlink" title="Go depth in Coroutine"></a>Go depth in Coroutine</h3><p>参考文章:<a target="_blank" rel="noopener" href="http://blog.csdn.net/tkokof1/article/details/11842673">Coroutine，你究竟干了什么？</a></p>
<p>在更深入了解coroutine之前让我们先了解下什么是IEnumerator和yield？<br><em>IEnumrator</em><br><a target="_blank" rel="noopener" href="https://msdn.microsoft.com/en-us/library/system.collections.ienumerator(v=vs.110).aspx">Supports a simple iteration over a non-generic collection.</a><br>在C#里IEnumerator组要是为了自定义类型支持迭代器访问.</p>
<p><em>yield</em><br>yield是C# 2.0引入的特性,表明调用yield的方法是iterator.每一次的迭代访问该方法，都会调用MoveNext()方法，而调用MoveNext()方法的时候就会执行该方法代码，但如果执行IEnumerator方法到yield的时候，该方法就会返回并且记录下yield的位置，并在下一次调用该方法的时候继续执行。</p>
<p>通过yield break我们可以结束方法迭代。</p>
<p>为什么要提IEnumerator和yield了？<br>因为Coroutine其实就是一个IEnumerator的迭代器。</p>
<p>在我们调用StartCoroutine的时候迭代器就被我们添加到了coroutine列表中<br>而Coroutine管理者会每一帧去迭代访问判断每一个coroutine是否达到条件可以删除并继续执行</p>
<p>CoroutineManager.cs</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CoroutineYieldInstruction</span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="built_in">bool</span> <span class="title">IsDone</span>()</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CoroutineWaitForSeconds</span> : <span class="title">CoroutineYieldInstruction</span>&#123;</span><br><span class="line">	<span class="built_in">float</span> m_WaitTime;</span><br><span class="line">	<span class="built_in">float</span> m_StartTime;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">CoroutineWaitForSeconds</span>(<span class="params"><span class="built_in">float</span> waittime</span>)</span></span><br><span class="line">	&#123;</span><br><span class="line">		m_WaitTime = waittime;</span><br><span class="line">		m_StartTime = <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="built_in">bool</span> <span class="title">IsDone</span>()</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (m_StartTime &lt; <span class="number">0</span>) &#123;</span><br><span class="line">			m_StartTime = Time.time;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">//check elapsed time</span></span><br><span class="line">		<span class="keyword">return</span> (Time.time - m_StartTime) &gt;= m_WaitTime;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CoroutineManager</span> : <span class="title">MonoBehaviour</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> CoroutineManager Instance &#123;</span><br><span class="line">		<span class="keyword">get</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">private</span> <span class="keyword">set</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	List&lt;System.Collections.IEnumerator&gt; m_Enumerators = <span class="keyword">new</span> List&lt;System.Collections.IEnumerator&gt;();</span><br><span class="line"></span><br><span class="line">	List&lt;System.Collections.IEnumerator&gt; m_EnumeratorsBuffer = <span class="keyword">new</span> List&lt;System.Collections.IEnumerator&gt;();</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Awake</span>()</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (Instance == <span class="literal">null</span>) &#123;</span><br><span class="line">			Instance = <span class="keyword">this</span>;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			Debug.Log (<span class="string">&quot;Multi-instances of CouroutineManager&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">LateUpdate</span>()</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; m_Enumerators.Count; i++) &#123;</span><br><span class="line">			<span class="comment">//handle special enumerator</span></span><br><span class="line">			<span class="keyword">if</span>(m_Enumerators[i].Current <span class="keyword">is</span> CoroutineYieldInstruction)</span><br><span class="line">			&#123;</span><br><span class="line">				CoroutineYieldInstruction yiledinstruction = m_Enumerators[i] .Current <span class="keyword">as</span> CoroutineYieldInstruction;</span><br><span class="line">				<span class="keyword">if</span>(!yiledinstruction.IsDone())&#123;</span><br><span class="line">					<span class="keyword">continue</span>;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">//Do normal move next</span></span><br><span class="line">			<span class="keyword">if</span>(!m_Enumerators[i].MoveNext())&#123;</span><br><span class="line">				m_EnumeratorsBuffer.Add(m_Enumerators[i]);</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		</span><br><span class="line">		<span class="comment">//remove end enumerator</span></span><br><span class="line">		<span class="keyword">for</span>(<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; m_EnumeratorsBuffer.Count; i++)</span><br><span class="line">		&#123;</span><br><span class="line">			m_Enumerators.Remove(m_EnumeratorsBuffer[i]);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		m_EnumeratorsBuffer.Clear ();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">StartCoroutineSimple</span>(<span class="params">System.Collections.IEnumerator enumerator</span>)</span></span><br><span class="line">	&#123;</span><br><span class="line">		m_Enumerators.Add (enumerator);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ScreenShots<br><img src="/img/Unity/Coroutine_Study.PNG" alt="My Own Coroutine"></p>
<h1 id="Unity优化注意事项"><a href="#Unity优化注意事项" class="headerlink" title="Unity优化注意事项"></a>Unity优化注意事项</h1><h2 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h2><h3 id="Use-For-or-while-instead-of-foreach"><a href="#Use-For-or-while-instead-of-foreach" class="headerlink" title="Use For or while instead of foreach"></a>Use For or while instead of foreach</h3><p>Foreach在通过Mono编译后会造成额外的内存分配（通过VS编译好像不会 – 这个未测试）<br><a target="_blank" rel="noopener" href="https://www.zhihu.com/question/30334270">参考网站</a></p>
<p>ForEachAndFor.cs</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ForEachAndFor</span> : <span class="title">MonoBehaviour</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;<span class="built_in">int</span>&gt; mTestList;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Use this for initialization</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Start</span> ()</span> &#123;</span><br><span class="line">        mTestList = <span class="keyword">new</span> List&lt;<span class="built_in">int</span>&gt;(<span class="number">1000</span>);</span><br><span class="line">        <span class="keyword">for</span>(<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; mTestList.Count; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            mTestList[i] = i;</span><br><span class="line">        &#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// Update is called once per frame</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Update</span> ()</span> &#123;</span><br><span class="line">	   </span><br><span class="line">        <span class="keyword">foreach</span>(<span class="keyword">var</span> it <span class="keyword">in</span> mTestList)</span><br><span class="line">        &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        for(int i = 0; i &lt; mTestList.Count; i++)</span></span><br><span class="line"><span class="comment">        &#123;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        &#125;</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ScreenShorts:<br><img src="/img/Unity/ForEachCall.PNG" alt="ForeachCall"><br><img src="/img/Unity/ForCall.PNG" alt="ForCall"></p>
<p>从上面的测试结果可以看出foreach确实分配了额外40B的内存开销</p>
<p>让我们看看foreach代码反编译后的样子(我用的ILSpy)：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ForEachAndFor</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">private</span> List&lt;<span class="built_in">int</span>&gt; mTestList;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Start</span>()</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">this</span>.mTestList = <span class="keyword">new</span> List&lt;<span class="built_in">int</span>&gt;(<span class="number">1000</span>);</span><br><span class="line">		<span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.mTestList.get_Count(); i++)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">this</span>.mTestList.set_Item(i, i);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Update</span>()</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">using</span> (List&lt;<span class="built_in">int</span>&gt;.Enumerator enumerator = <span class="keyword">this</span>.mTestList.GetEnumerator())</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">while</span> (enumerator.MoveNext())</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="built_in">int</span> current = enumerator.get_Current();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>从上面看看不出为什么会有内存分配<br>让我们通过IL反编译工具看生成的IL底层内容（通过IL反编译工具，安装VS就自带的）</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">.<span class="function">method <span class="keyword">private</span> hidebysig instance <span class="keyword">void</span>  <span class="title">Update</span>() cil managed</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// 代码大小       55 (0x37)</span></span><br><span class="line">  .maxstack  <span class="number">8</span></span><br><span class="line">  .<span class="function">locals <span class="title">init</span> (<span class="params">int32 V_0,</span></span></span><br><span class="line"><span class="params"><span class="function">           valuetype [mscorlib]System.Collections.Generic.List`<span class="number">1</span>/Enumerator&lt;int32&gt; V_1</span>)</span></span><br><span class="line"><span class="function">  IL_0000:  ldarg.0</span></span><br><span class="line"><span class="function">  IL_0001:  ldfld      <span class="keyword">class</span> [mscorlib]System.Collections.Generic.List`1&lt;int32&gt; ForEachAndFor::mTestList</span></span><br><span class="line"><span class="function">  IL_0006:  callvirt   instance valuetype [mscorlib]System.Collections.Generic.List`1/Enumerator&lt;!0&gt; <span class="keyword">class</span> [mscorlib]System.Collections.Generic.List`1&lt;int32&gt;::<span class="title">GetEnumerator</span>()</span></span><br><span class="line"><span class="function">  IL_000b:  stloc.1</span></span><br><span class="line"><span class="function">  .<span class="keyword">try</span></span></span><br><span class="line">  &#123;</span><br><span class="line">    IL_000c:  br         IL_0019</span><br><span class="line">    IL_0011:  ldloca.s   V_1</span><br><span class="line">    IL_0013:  call       instance !<span class="number">0</span> valuetype [mscorlib]System.Collections.Generic.List`<span class="number">1</span>/Enumerator&lt;int32&gt;::get_Current()</span><br><span class="line">    IL_0018:  stloc<span class="number">.0</span></span><br><span class="line">    IL_0019:  ldloca.s   V_1</span><br><span class="line">    IL_001b:  call       instance <span class="built_in">bool</span> valuetype [mscorlib]System.Collections.Generic.List`<span class="number">1</span>/Enumerator&lt;int32&gt;::MoveNext()</span><br><span class="line">    IL_0020:  brtrue     IL_0011</span><br><span class="line">    IL_0025:  leave      IL_0036</span><br><span class="line">  &#125;  <span class="comment">// end .try</span></span><br><span class="line">  <span class="keyword">finally</span></span><br><span class="line">  &#123;</span><br><span class="line">    IL_002a:  ldloc<span class="number">.1</span></span><br><span class="line">    IL_002b:  box        valuetype [mscorlib]System.Collections.Generic.List`<span class="number">1</span>/Enumerator&lt;int32&gt;</span><br><span class="line">    IL_0030:  callvirt   instance <span class="keyword">void</span> [mscorlib]System.IDisposable::Dispose()</span><br><span class="line">    IL_0035:  endfinally</span><br><span class="line">  &#125;  <span class="comment">// end handler</span></span><br><span class="line">  IL_0036:  ret</span><br><span class="line">&#125; <span class="comment">// end of method ForEachAndFor::Update</span></span><br></pre></td></tr></table></figure>

<p>可以看出Mono编译出来的代码在finally进行了一次将valuetype的Enumerator，boxing的过程（这里并不是非常明白底层代码对应的代码，但看大概意思应该是using那里编译后导致的boxing）</p>
<p><a target="_blank" rel="noopener" href="https://msdn.microsoft.com/en-us/library/yz2be5wk.aspx">关于Box和Unbox参考</a><br>从官网可以看出在Boxing Value type的时候会将信息临时存储在Heap上从而造成的额外内存开销</p>
<h2 id="Rendering"><a href="#Rendering" class="headerlink" title="Rendering"></a>Rendering</h2><p>减少渲染的物体数量和精度</p>
<h2 id="Physic"><a href="#Physic" class="headerlink" title="Physic"></a>Physic</h2><h3 id="Close-Unnecessary-Collision"><a href="#Close-Unnecessary-Collision" class="headerlink" title="Close Unnecessary Collision"></a>Close Unnecessary Collision</h3><p>(Edit -&gt; Project Settings -&gt; Physics)<br>只打开需要碰撞检测的Layer之间的碰撞检测</p>
<h2 id="Memory"><a href="#Memory" class="headerlink" title="Memory"></a>Memory</h2><h3 id="Avoid-Uneccessary-GC"><a href="#Avoid-Uneccessary-GC" class="headerlink" title="Avoid Uneccessary GC"></a>Avoid Uneccessary GC</h3><p>尽量重复使用申请的内存，不要每一次都重新申请</p>
<h1 id="游戏相关"><a href="#游戏相关" class="headerlink" title="游戏相关"></a>游戏相关</h1><h2 id="Shuffle-Bag"><a href="#Shuffle-Bag" class="headerlink" title="Shuffle Bag"></a>Shuffle Bag</h2><p>在Unity和C#中有Random Class，可以为我们提供伪随机数，但伪随机数毕竟不是真正的随机，并且无法保证各个事件发生的几率，这样一来会导致我们的游戏趣味性大大降低。</p>
<p>一下学习参考:<br><a target="_blank" rel="noopener" href="https://gamedevelopment.tutsplus.com/tutorials/shuffle-bags-making-random-feel-more-random--gamedev-1249">Shuffle Bags: Making Random() Feel More Random</a><br><a target="_blank" rel="noopener" href="https://web.archive.org/web/20150324141028/http://kaioa.com/node/53">Never-ending Shuffled Sequences - When Random is too Random</a><br>实现参考:<br><a target="_blank" rel="noopener" href="https://gist.github.com/mstevenson/4050130">Shuffle bag algorithm implemented in C# </a><br>那么什么是Shuffle Bag了？<br>“<br>A Shuffle Bag is a technique for controlling randomness to create the distribution we desire. The idea is:<br>Pick a range of values with the desired distribution.<br>Put all these values into a bag.<br>Shuffle the bag’s contents.<br>Pull the values out one by one until you reach the end.<br>Once you reach the end, you start over, pulling the values out one by one again.<br>“<br>从上面可以看出Shuffle Bag主要是通过把所有可能都放到List里，然后通过随机选择在里面选取一个，而被选择过的不记入下一次选择考虑范围内，直到List里所有可能都被选择完为止。<br>这样一来List里填充的数据就确定了每一个事件发生的概率。<br>并且只通过一次填充数据就能无限随机选择下去。</p>
<p>代码实现：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ShuffleBag</span>&lt;<span class="title">T</span>&gt; : <span class="title">ICollection</span>&lt;<span class="title">T</span>&gt;, <span class="title">IList</span>&lt;<span class="title">T</span>&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> List&lt;T&gt; mData = <span class="keyword">new</span> List&lt;T&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span> mCursor = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> T last;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> T <span class="title">Next</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (mData.Count == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">default</span>(T);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mCursor &lt; <span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            mCursor = mData.Count - <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">if</span> (mData.Count &lt; <span class="number">1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">default</span>(T);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> mData[<span class="number">0</span>];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">int</span> grab = Mathf.FloorToInt(Random.<span class="keyword">value</span> * (mCursor + <span class="number">1</span>));</span><br><span class="line">        T temp = mData[grab];</span><br><span class="line">        mData[grab] = mData[mCursor];</span><br><span class="line">        mData[mCursor] = temp;</span><br><span class="line">        mCursor--;</span><br><span class="line">        <span class="keyword">return</span> temp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//IList[T] implementation</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">int</span> <span class="title">IndexOf</span>(<span class="params">T item</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> mData.IndexOf(item);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Insert</span>(<span class="params"><span class="built_in">int</span> index, T item</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        mData.Insert(index, item);</span><br><span class="line">        mCursor = mData.Count - <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">RemoveAt</span>(<span class="params"><span class="built_in">int</span> index</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        mData.RemoveAt(index);</span><br><span class="line">        mCursor = mData.Count - <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> T <span class="keyword">this</span>[<span class="built_in">int</span> index]</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> mData[index];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">set</span></span><br><span class="line">        &#123;</span><br><span class="line">            mData[index] = <span class="keyword">value</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//IEnumerable[T] implementation</span></span><br><span class="line">    IEnumerator&lt;T&gt; IEnumerable&lt;T&gt;.GetEnumerator()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> mData.GetEnumerator();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ICollection[T] implementation</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Add</span>(<span class="params">T item</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        mData.Add(item);</span><br><span class="line">        mCursor = mData.Count - <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> Count</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> mData.Count;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Clear</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//mCursor = 0;</span></span><br><span class="line">        mData.Clear();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">Contains</span>(<span class="params">T item</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> mData.Contains(item);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">CopyTo</span>(<span class="params">T[] array, <span class="built_in">int</span> arrayindex</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">foreach</span> (T item <span class="keyword">in</span> mData)</span><br><span class="line">        &#123;</span><br><span class="line">            array.SetValue(item, arrayindex);</span><br><span class="line">            arrayindex++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">Remove</span>(<span class="params">T item</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">bool</span> removesuccess = mData.Remove(item);</span><br><span class="line">        mCursor = mData.Count - <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">return</span> removesuccess;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">bool</span> IsReadOnly</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//IEnumerable implementation</span></span><br><span class="line">    IEnumerator IEnumerable.GetEnumerator()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> mData.GetEnumerator();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="C-学习"><a href="#C-学习" class="headerlink" title="C#学习"></a>C#学习</h1><p>Book down load link: <a target="_blank" rel="noopener" href="http://download.csdn.net/detail/baiyu9821179/4282298">c#入门经典第五版</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Unity/">Unity</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Unity/">Unity</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>







  <nav id="page-nav" class="clearfix">
    <a class="extend prev" rel="prev" href="/page/4/">&lt;span&gt;&lt;&#x2F;span&gt;Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><span class="page-number current">5</span><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/6/">Next&lt;span&gt;&lt;&#x2F;span&gt;</a>
  </nav>

</div>
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  


  
<div class="categorieslist">
	<p class="asidetitle">分类</p>
		<ul>
		
		  
			<li><a href="/categories/AI/" title="AI">AI<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/Algorithm/" title="Algorithm">Algorithm<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/Art/" title="Art">Art<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Automation/" title="Automation">Automation<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Collision/" title="Collision">Collision<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Database/" title="Database">Database<sup>3</sup></a></li>
		  
		
		  
			<li><a href="/categories/Editor/" title="Editor">Editor<sup>5</sup></a></li>
		  
		
		  
			<li><a href="/categories/Excel/" title="Excel">Excel<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Game/" title="Game">Game<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/HotUpdate/" title="HotUpdate">HotUpdate<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Lua/" title="Lua">Lua<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Math/" title="Math">Math<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/Native/" title="Native">Native<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/Network/" title="Network">Network<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Optimization/" title="Optimization">Optimization<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Other/" title="Other">Other<sup>5</sup></a></li>
		  
		
		  
			<li><a href="/categories/Plugin/" title="Plugin">Plugin<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/Programming/" title="Programming">Programming<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Programming-Language/" title="Programming Language">Programming Language<sup>4</sup></a></li>
		  
		
		  
			<li><a href="/categories/Rendering/" title="Rendering">Rendering<sup>4</sup></a></li>
		  
		
		  
			<li><a href="/categories/Resource/" title="Resource">Resource<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/Unity/" title="Unity">Unity<sup>7</sup></a></li>
		  
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">标签</p>
		<ul class="clearfix">
		
			
				<li><a href="/tags/Unity/" title="Unity">Unity<sup>8</sup></a></li>
			
		
			
				<li><a href="/tags/Editor/" title="Editor">Editor<sup>5</sup></a></li>
			
		
			
				<li><a href="/tags/Other/" title="Other">Other<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/AI/" title="AI">AI<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/Resource/" title="Resource">Resource<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/OpenGL/" title="OpenGL">OpenGL<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/Math/" title="Math">Math<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/Art/" title="Art">Art<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Android/" title="Android">Android<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/UI/" title="UI">UI<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/C/" title="C#">C#<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Python/" title="Python">Python<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Database/" title="Database">Database<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Shader/" title="Shader">Shader<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/SubmlineText3/" title="SubmlineText3">SubmlineText3<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Rendering/" title="Rendering">Rendering<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Native/" title="Native">Native<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Prefab/" title="Prefab">Prefab<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Plugin/" title="Plugin">Plugin<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Optimization/" title="Optimization">Optimization<sup>1</sup></a></li>
			
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">友情链接</p>
    <ul>
        
          <li>
            
            	<a href="https://coderq.com" target="_blank" title="一个面向程序员交流分享的新一代社区">码农圈</a>
            
          </li>
        
          <li>
            
            	<a href="http://wuchong.me" target="_blank" title="Jark&#39;s Blog">Jark&#39;s Blog</a>
            
          </li>
        
    </ul>
</div>

  


  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS 订阅</a>
</div>

  <div class="weiboshow">
  <p class="asidetitle">新浪微博</p>
    <iframe width="100%" height="119" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=119&fansRow=2&ptype=1&speed=0&skin=9&isTitle=1&noborder=1&isWeibo=0&isFans=0&uid=&verifier=b3593ceb&dpc=1"></iframe>
</div>


</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> Hello ,I&#39;m Larry Page in Google. <br/>
			This is my blog,believe it or not.</p>
	</section>
	 
	<div class="social-font" class="clearfix">
		
		<a href="http://weibo.com/2176287895" target="_blank" class="icon-weibo" title="微博"></a>
		
		
		
		
		
		
		
		
		
		
	</div>
			
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Jacman">Jacman</a> © 2025 
		
		<a href="/about" target="_blank" title="Tony Tang">Tony Tang</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery.qrcode-0.12.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
        
    }
  });
});
</script>












<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->



<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?e6d1f421bbc9962127a50488f9ed37d1";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>



<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="返回顶部"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
 </html>
